cscope 15 $HOME/KVSSD -q 0000015038 0003734666
	@PDK/core/include/kvs_api.h

35 #iâdeà
KVS_TYPES_H


36 
	#KVS_TYPES_H


	)

38 
	~<memÜy.h
>

39 
	~<¡dio.h
>

40 
	~<±h»ad.h
>

41 
	~<¡dšt.h
>

43 
	~"kvs_»suÉ.h
"

44 
	~"kvs_cÚ¡.h
"

45 
	~"kvs_¡ruù.h
"

47 #ifdeà
__ılu¥lus


58 
kvs_»suÉ
 
kvs_š™_’v
(
kvs_š™_İtiÚs
* 
İtiÚs
);

64 
kvs_»suÉ
 
kvs_š™_’v_İts
(
kvs_š™_İtiÚs
* 
İtiÚs
);

72 
kvs_»suÉ
 
kvs_ex™_’v
();

95 
kvs_»suÉ
 
kvs_İ’_deviû
(cÚ¡ *
dev_·th
, 
kvs_deviû_hªdË
 *
dev_hd
);

101 
kvs_»suÉ
 
kvs_şo£_deviû
(
kvs_deviû_hªdË
 
u£r_dev
);

120 
kvs_»suÉ
 
kvs_ü—‹_cÚš”
 (
kvs_deviû_hªdË
 
dev_hd
, cÚ¡ *
Çme
, 
ušt64_t
 
size
, cÚ¡ 
kvs_cÚš”_cÚ‹xt
 *
ùx
);

122 
kvs_»suÉ
 
kvs_d–‘e_cÚš”
 (
kvs_deviû_hªdË
 
dev_hd
, cÚ¡ *
cÚt_Çme
);

124 
kvs_»suÉ
 
kvs_İ’_cÚš”
 (
kvs_deviû_hªdË
 
dev_hd
, cÚ¡ * 
Çme
, 
kvs_cÚš”_hªdË
 *
cÚt_hd
);

126 
kvs_»suÉ
 
kvs_şo£_cÚš”
 (
kvs_cÚš”_hªdË
 
cÚt_hd
);

128 
kvs_»suÉ
 
kvs_g‘_cÚš”_šfo
 (
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_cÚš”
 *
cÚt
);

143 
št32_t
 
kvs_g‘_iÛv’ts
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
maxev’ts
);

145 
kvs_»suÉ
 
kvs_g‘_tu¶e_šfo
 (
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, 
kvs_tu¶e_šfo
 *
šfo
);

164 
kvs_»suÉ
 
kvs_¡Üe_tu¶e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_¡Üe_cÚ‹xt
 *
ùx
);

166 
kvs_»suÉ
 
kvs_¡Üe_tu¶e_async
 (
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_¡Üe_cÚ‹xt
 *
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

185 
kvs_»suÉ
 
kvs_»Œ›ve_tu¶e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 *
ùx
);

187 
kvs_»suÉ
 
kvs_»Œ›ve_tu¶e_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 *
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

201 
kvs_»suÉ
 
kvs_d–‘e_tu¶e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_d–‘e_cÚ‹xt
 *
ùx
);

203 
kvs_»suÉ
 
kvs_d–‘e_tu¶e_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
* 
key
, cÚ¡ 
kvs_d–‘e_cÚ‹xt
* 
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

206 
kvs_»suÉ
 
kvs_exi¡_tu¶es
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, cÚ¡ 
kvs_exi¡_cÚ‹xt
 *
ùx
);

208 
kvs_»suÉ
 
kvs_exi¡_tu¶es_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, cÚ¡ 
kvs_exi¡_cÚ‹xt
 *
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

218 
kvs_»suÉ
 
kvs_İ’_™”©Ü
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
, 
kvs_™”©Ü_hªdË
 *
™”_hd
);

227 
kvs_»suÉ
 
kvs_şo£_™”©Ü
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_hªdË
 
h™”
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
);

234 
kvs_»suÉ
 
kvs_şo£_™”©Ü_®l
(
kvs_cÚš”_hªdË
 
cÚt_hd
);

242 
kvs_»suÉ
 
kvs_li¡_™”©Üs
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
couÁ
);

255 
kvs_»suÉ
 
kvs_™”©Ü_Ãxt
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
);

257 
kvs_»suÉ
 
kvs_™”©Ü_Ãxt_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_hªdË
 
™”_hd
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

264 
kvs_»suÉ
 
kvs_g‘_deviû_waf
(
kvs_deviû_hªdË
 
dev_hd
, *
waf
);

270 
kvs_»suÉ
 
kvs_g‘_deviû_šfo
(
kvs_deviû_hªdË
 
dev_hd
, 
kvs_deviû
 *
dev_šfo
);

277 
kvs_»suÉ
 
kvs_g‘_deviû_utiz©iÚ
(
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
dev_ut
);

283 
kvs_»suÉ
 
kvs_g‘_deviû_ÿ·c™y
(
kvs_deviû_hªdË
 
dev_hd
, 
št64_t
 *
dev_ÿ·
);

285 
kvs_»suÉ
 
kvs_g‘_mš_key_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
mš_key_Ëngth
);

287 
kvs_»suÉ
 
kvs_g‘_max_key_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
max_key_Ëngth
);

289 
kvs_»suÉ
 
kvs_g‘_mš_v®ue_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
mš_v®ue_Ëngth
);

291 
kvs_»suÉ
 
kvs_g‘_max_v®ue_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
max_v®ue_Ëngth
);

293 
kvs_»suÉ
 
kvs_g‘_İtim®_v®ue_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
İt_v®ue_Ëngth
);

302 cÚ¡ *
kvs_”r¡r
(
št32_t
 
”rÜno
);

305 
	#_FUNCTIONIZE
(
a
,
b
è
	`a
(b)

	)

306 
	#_STRINGIZE
(
a
è#a

	)

307 
	#_INT2STRING
(
i
è
	`_FUNCTIONIZE
(
_STRINGIZE
,i)

	)

308 
	#_LOCATION
 
__FILE__
 ":" 
	`_INT2STRING
(
__LINE__
)

	)

310 *
_kvs_z®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
, cÚ¡ *
fe
);

311 *
_kvs_m®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
, cÚ¡ *
fe
);

312 
_kvs_ä“
(* 
buf
, cÚ¡ *
fe
);

322 
	#kvs_m®loc
(
size
, 
®ignm’t
è
	`_kvs_m®loc
(size,‡lignm’t, 
_LOCATION
)

	)

331 
	#kvs_z®loc
(
size
, 
®ignm’t
è
	`_kvs_z®loc
(size,‡lignm’t, 
_LOCATION
)

	)

336 
	#kvs_ä“
(
buf
è
	`_kvs_ä“
(buf, 
_LOCATION
)

	)

337 
	#kvs_mem¡©
(è
	`_kvs_»pÜt_mem¡©
()

	)

339 #ifdeà
__ılu¥lus


	@PDK/core/include/kvs_const.h

35 #iâdeà
KVS_CONST_H


36 
	#KVS_CONST_H


	)

38 #ifdeà
__ılu¥lus


43 
	#KVS_MIN_KEY_LENGTH
 4

	)

44 
	#KVS_MAX_KEY_LENGTH
 255

	)

45 
	#KVS_MIN_VALUE_LENGTH
 0

	)

46 
	#KVS_MAX_VALUE_LENGTH
 (2*1024*1024)

	)

47 
	#KVS_OPTIMAL_VALUE_LENGTH
 4096

	)

48 
	#KVS_ALIGNMENT_UNIT
 4

	)

49 
	#KVS_MAX_ITERATE_HANDLE
 16

	)

52 
	#G_ITER_KEY_SIZE_FIXED
 16;

	)

54 #ifdeà
__ılu¥lus


	@PDK/core/include/kvs_result.h

35 #iâdeà
KVS_RESULT_H


36 
	#KVS_RESULT_H


	)

38 #ifdeà
__ılu¥lus


46 
KVS_SUCCESS
=0 ,

49 
KVS_ERR_BUFFER_SMALL
=0x001 ,

50 
KVS_ERR_COMMAND_INITIALIZED
=0x002 ,

51 
KVS_ERR_COMMAND_SUBMITTED
=0x003 ,

52 
KVS_ERR_DEV_CAPACITY
=0x004 ,

53 
KVS_ERR_DEV_INIT
=0x005 ,

54 
KVS_ERR_DEV_INITIALIZED
=0x006 ,

55 
KVS_ERR_DEV_NOT_EXIST
=0x007 ,

56 
KVS_ERR_DEV_SANITIZE_FAILED
=0x008 ,

57 
KVS_ERR_DEV_SANIZE_IN_PROGRESS
=0x009,

58 
KVS_ERR_ITERATOR_COND_INVALID
=0x00A,

59 
KVS_ERR_ITERATOR_MAX
=0x00B ,

60 
KVS_ERR_ITERATOR_NOT_EXIST
=0x00C ,

61 
KVS_ERR_ITERATOR_OPEN
=0x00D ,

62 
KVS_ERR_KEY_EXIST
=0x00E ,

63 
KVS_ERR_KEY_INVALID
=0x00F ,

64 
KVS_ERR_KEY_LENGTH_INVALID
=0x010 ,

65 
KVS_ERR_KEY_NOT_EXIST
=0x011 ,

66 
KVS_ERR_OPTION_INVALID
=0x012 ,

67 
KVS_ERR_PARAM_INVALID
=0x013 ,

68 
KVS_ERR_PURGE_IN_PROGRESS
=0x014 ,

69 
KVS_ERR_QUEUE_CQID_INVALID
=0x015 ,

70 
KVS_ERR_QUEUE_DELETION_INVALID
=0x016 ,

71 
KVS_ERR_QUEUE_IN_SUTDOWN
=0x017 ,

72 
KVS_ERR_QUEUE_IS_FULL
=0x018 ,

73 
KVS_ERR_QUEUE_MAX_QUEUE
=0x019 ,

74 
KVS_ERR_QUEUE_QID_INVALID
=0x01A ,

75 
KVS_ERR_QUEUE_QSIZE_INVALID
=0x01B,

76 
KVS_ERR_QUEUE_SQID_INVALID
=0x01C ,

77 
KVS_ERR_SYS_BUSY
=0x01D ,

78 
KVS_ERR_SYS_IO
=0x01E ,

79 
KVS_ERR_TIMEOUT
=0x01F ,

80 
KVS_ERR_UNCORRECTIBLE
=0x020 ,

81 
KVS_ERR_VALUE_LENGTH_INVALID
=0x021 ,

82 
KVS_ERR_VALUE_LENGTH_MISALIGNED
=0x022 ,

83 
KVS_ERR_VALUE_OFFSET_INVALID
=0x023 ,

84 
KVS_ERR_VALUE_UPDATE_NOT_ALLOWED
=0x024 ,

85 
KVS_ERR_VENDOR
=0x025 ,

86 
KVS_ERR_PERMISSION
 = 0x26,

89 
KVS_ERR_CACHE_INVALID_PARAM
=0x200 ,

90 
KVS_ERR_CACHE_NO_CACHED_KEY
=0x201 ,

91 
KVS_ERR_DD_INVALID_QUEUE_TYPE
=0x202 ,

92 
KVS_ERR_DD_NO_AVAILABLE_RESOURCE
=0x203 ,

93 
KVS_ERR_DD_NO_DEVICE
=0x204 ,

94 
KVS_ERR_DD_UNSUPPORTED_CMD
=0x205 ,

95 
KVS_ERR_DECOMPRESSION
=0x206 ,

96 
KVS_ERR_HEAP_ALLOC_FAILURE
=0x207 ,

97 
KVS_ERR_ITERATE_HANDLE_ALREADY_OPENED
=0x208 ,

98 
KVS_ERR_ITERATE_REQUEST_FAIL
=0x209 ,

99 
KVS_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
=0x20A ,

100 
KVS_ERR_MISALIGNED_KEY_SIZE
=0x20B ,

101 
KVS_ERR_MISALIGNED_VALUE_OFFSET
=0x20C ,

102 
KVS_ERR_SDK_CLOSE
=0x20D ,

103 
KVS_ERR_SDK_INVALID_PARAM
=0x20E ,

104 
KVS_ERR_SDK_OPEN
=0x20F ,

105 
KVS_ERR_SLAB_ALLOC_FAILURE
=0x210 ,

106 
KVS_ERR_UNRECOVERED_ERROR
=0x211 ,

109 
KVS_ERR_NS_ATTACHED
=0x300 ,

110 
KVS_ERR_NS_CAPACITY
=0x301 ,

111 
KVS_ERR_NS_DEFAULT
=0x302 ,

112 
KVS_ERR_NS_INVALID
=0x303 ,

113 
KVS_ERR_NS_MAX
=0x304 ,

114 
KVS_ERR_NS_NOT_ATTACHED
=0x305 ,

117 
KVS_ERR_CONT_CAPACITY
=0x400 ,

118 
KVS_ERR_CONT_CLOSE
=0x401 ,

119 
KVS_ERR_CONT_EXIST
=0x402 ,

120 
KVS_ERR_CONT_GROUP_BY
=0x403 ,

121 
KVS_ERR_CONT_INDEX
=0x404 ,

122 
KVS_ERR_CONT_NAME
=0x405 ,

123 
KVS_ERR_CONT_NOT_EXIST
=0x406 ,

124 
KVS_ERR_CONT_OPEN
=0x407 ,

125 } 
	tkvs_»suÉ
;

128 #ifdeà
__ılu¥lus


	@PDK/core/include/kvs_struct.h

35 #iâdeà
KVS_STRUCT_H


36 
	#KVS_STRUCT_H


	)

38 #ifdeà
__ılu¥lus


43 
boŞ
 
kvs_d–‘e_”rÜ
;

44 } 
	tkvs_d–‘e_İtiÚ
;

47 
boŞ
 
kvs_»Œ›ve_d–‘e
;

48 
boŞ
 
kvs_»Œ›ve_decom´ess
;

49 } 
	tkvs_»Œ›ve_İtiÚ
;

52 
KVS_STORE_POST
=0,

53 
KVS_STORE_UPDATE_ONLY
,

54 
KVS_STORE_NOOVERWRITE
,

55 
KVS_STORE_APPEND
,

56 } 
	tkvs_¡Üe_ty³
;

59 
kvs_¡Üe_ty³
 
¡_ty³
;

60 
boŞ
 
kvs_¡Üe_com´ess
;

61 } 
	tkvs_¡Üe_İtiÚ
;

65 
KVS_ITERATOR_KEY
 = 0,

66 
KVS_ITERATOR_KEY_VALUE
,

67 
KVS_ITERATOR_WITH_DELETE
,

68 } 
	tkvs_™”©Ü_ty³
;

72 
kvs_™”©Ü_ty³
 
™”_ty³
;

73 } 
	tkvs_™”©Ü_İtiÚ
;

76 
KVS_KEY_ORDER_NONE
 = 0,

77 
KVS_KEY_ORDER_ASCEND
,

78 
KVS_KEY_ORDER_DESCEND
,

79 } 
	tkvs_key_Üd”
;

82 
kvs_key_Üd”
 
Üd”šg
;

83 } 
	tkvs_cÚš”_İtiÚ
;

90 
	ekvs_İ
 {

91 
IOCB_ASYNC_PUT_CMD
=1,

92 
IOCB_ASYNC_GET_CMD
=2,

93 
IOCB_ASYNC_DEL_CMD
=3,

94 
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
=4,

95 
IOCB_ASYNC_ITER_OPEN_CMD
=5,

96 
IOCB_ASYNC_ITER_CLOSE_CMD
=6,

97 
IOCB_ASYNC_ITER_NEXT_CMD
=7

104 
	ekv_driv”_ty³s
 {

105 
KV_UDD
 = 0x00,

106 
KV_KDD
 = 0x01,

107 
KV_EMUL
 = 0x02,

112 
ušt8_t
 
	tkvs_key_t
;

113 
ušt32_t
 
	tkvs_v®ue_t
;

114 
	t__št128
 
	tušt128_t
;

116 
_kvs_deviû_hªdË
;

117 
_kvs_deviû_hªdË
 *
	tkvs_deviû_hªdË
;

123 
_kvs_cÚš”_hªdË
;

124 
_kvs_cÚš”_hªdË
* 
	tkvs_cÚš”_hªdË
;

129 
ušt8_t
 
	tkvs_™”©Ü_hªdË
;

137 
ušt32_t
 
num_’Œ›s
;

138 
ušt32_t
 
size
;

139 
’d
;

140 *
™_li¡
;

141 } 
	tkvs_™”©Ü_li¡
;

149 
kvs_™”©Ü_hªdË
 
™”_hªdË
;

150 
ušt8_t
 
¡©us
;

151 
ušt8_t
 
ty³
;

152 
ušt8_t
 
key¥aû_id
;

153 
ušt32_t
 
b™_·‰”n
;

154 
ušt32_t
 
b™mask
;

155 
ušt8_t
 
is_eof
;

156 
ušt8_t
 
»£rved
[3];

157 } 
	tkvs_™”©Ü_šfo
;

161 
ušt32_t
 
Çme_Ën
;

162 *
Çme
;

163 } 
	tkvs_cÚš”_Çme
;

166 
boŞ
 
İ’ed
;

167 
ušt8_t
 
sÿË
;

168 
ušt64_t
 
ÿ·c™y
;

169 
ušt64_t
 
ä“_size
;

170 
ušt64_t
 
couÁ
;

171 
kvs_cÚš”_Çme
 *
Çme
;

172 } 
	tkvs_cÚš”
;

175 
št64_t
 
ÿ·c™y
;

176 
ušt128_t
 
uÇÎoc_ÿ·c™y
;

177 
ušt32_t
 
max_v®ue_Ën
;

178 
ušt32_t
 
max_key_Ën
;

179 
ušt32_t
 
İtim®_v®ue_Ën
;

180 
ušt32_t
 
İtim®_v®ue_g¿nuÏr™y
;

181 *
ex‹nded_šfo
;

182 } 
	tkvs_deviû
;

188 *
key
;

189 
kvs_key_t
 
Ëngth
;

190 } 
	tkvs_key
;

196 *
v®ue
;

197 
ušt32_t
 
Ëngth
;

198 
ušt32_t
 
aùu®_v®ue_size
;

199 
ušt32_t
 
off£t
;

200 } 
	tkvs_v®ue
;

203 
ušt32_t
 
key_Ëngth
 : 16;

204 
ušt32_t
 
»£rved
 : 16;

205 
ušt32_t
 
v®ue_Ëngth
;

206 
ušt8_t
 
key
[
KVS_MAX_KEY_LENGTH
];

207 } 
	tkvs_tu¶e_šfo
;

209 
±h»ad_t
 
	tkvs_th»ad_t
;

214 
kvs_d–‘e_İtiÚ
 
İtiÚ
;

215 *
´iv©e1
;

216 *
´iv©e2
;

217 } 
	tkvs_d–‘e_cÚ‹xt
;

222 
kvs_¡Üe_İtiÚ
 
İtiÚ
;

223 *
´iv©e1
;

224 *
´iv©e2
;

225 } 
	tkvs_¡Üe_cÚ‹xt
;

230 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
;

231 *
´iv©e1
;

232 *
´iv©e2
;

233 } 
	tkvs_»Œ›ve_cÚ‹xt
;

238 
kvs_™”©Ü_İtiÚ
 
İtiÚ
;

239 
ušt32_t
 
b™mask
;

240 
ušt32_t
 
b™_·‰”n
;

241 *
´iv©e1
;

242 *
´iv©e2
;

243 } 
	tkvs_™”©Ü_cÚ‹xt
;

246 *
´iv©e1
;

247 *
´iv©e2
;

248 } 
	tkvs_exi¡_cÚ‹xt
;

251 
kvs_cÚš”_İtiÚ
 
İtiÚ
;

252 } 
	tkvs_cÚš”_cÚ‹xt
;

255 
ušt8_t
 
İcode
;

256 
kvs_cÚš”_hªdË
 *
cÚt_hd
;

257 
kvs_key
 *
key
;

258 
kvs_v®ue
 *
v®ue
;

259 
ušt32_t
 
key_út
;

260 
ušt8_t
 *
»suÉ_bufãr
;

262 *
´iv©e1
;

263 *
´iv©e2
;

264 
kvs_»suÉ
 
»suÉ
;

265 
kvs_™”©Ü_hªdË
 *
™”_hd
;

266 } 
	tkvs_ÿÎback_cÚ‹xt
;

272 (*
_Ú_iÙh»adš™
)(
	tkvs_th»ad_t
 
	tid
);

273 (*
kvs_ÿÎback_funùiÚ
)(
	tkvs_ÿÎback_cÚ‹xt
* 
	tioùx
);

286 
u£_dpdk
;

287 
dpdk_ma¡”cÜeid
;

288 
Ä_hug•ages_³r_sock‘
;

289 
ušt16_t
 
sock‘mask
;

290 
ušt64_t
 
max_memÜysize_mb
;

291 
ušt64_t
 
max_ÿchesize_mb
;

292 } 
memÜy
;

295 
ušt64_t
 
iocÜemask
;

296 
ušt32_t
 
queued•th
;

297 } 
aio
;

301 
cÜe_mask_¡r
[256];

302 
cq_th»ad_mask
[256];

303 
ušt32_t
 
mem_size_mb
;

304 
syncio
;

305 } 
udd
;

306 cÚ¡ *
emul_cÚfig_fe
;

307 } 
	tkvs_š™_İtiÚs
;

314 
node
[1024];

315 
¥dk·th
[1024];

316 
nsid
;

317 
pci_¦Ù_Çme
[1024];

318 
numªode
;

319 
v’dÜid
;

320 
deviûid
;

321 
v’_dev_id
[128];

322 } 
	tkv_deviû_šfo
;

324 #ifdeà
__ılu¥lus


	@PDK/core/sample_code/test_async.cpp

34 
	~<¡dio.h
>

35 
	~<¡dšt.h
>

36 
	~<uni¡d.h
>

37 
	~<mu‹x
>

38 
	~<©omic
>

39 
	~<queue
>

40 
	~<kvs_­i.h
>

42 
	g¡d
::
©omic
<> 
subm™‹d
(0);

43 
	g¡d
::
©omic
<> 
com¶‘ed
(0);

44 
	g¡d
::
©omic
<> 
cur_qd•th
(0);

45 
±h»ad_mu‹x_t
 
	glock
;

47 
	s™”©Ü_šfo
{

48 
kvs_™”©Ü_hªdË
 
	m™”_hªdË
;

49 
kvs_™”©Ü_li¡
 
	m™”_li¡
;

50 
kvs_™”©Ü_İtiÚ
 
	mg_™”_mode
;

52 
	#™”_buff
 (32*1024)

	)

54 
	$u§ge
(*
´og¿m
)

56 
	`´štf
("==============\n");

57 
	`´štf
("u§ge: % -d deviû_·th [-Ànum_ios] [-q queue_d•th] [-Øİ_ty³] [-k kËn] [-v vËn]\n", 
´og¿m
);

58 
	`´štf
("-d device_path : kvssd device…ath.ƒ.g.ƒmul: /dev/kvemul; kdd: /dev/nvme0n1; udd: 0000:06:00.0\n");

59 
	`´štf
("-n‚um_ios :otal‚umber of ios (ignorehis for iterator)\n");

60 
	`´štf
("-q queue_depth : queue depth (ignorehis for iterator)\n");

61 
	`´štf
("-o op_type : 1: write; 2:„ead; 3: delete; 4: iterator; 5: check keyƒxist\n");

62 
	`´štf
("-k klen : key†ength (ignorehis for iterator)\n");

63 
	`´štf
("-v vlen : value†ength (ignorehis for iterator)\n");

64 
	`´štf
("==============\n");

65 
	}
}

68 
	$´št_™”©Ü_keyv®s
(
kvs_™”©Ü_li¡
 *
™”_li¡
, 
kvs_™”©Ü_İtiÚ
 
g_™”_mode
){

69 
ušt8_t
 *
™_bufãr
 = (ušt8_ˆ*è
™”_li¡
->
™_li¡
;

70 
ušt32_t
 
i
;

72 if(
g_™”_mode
.
™”_ty³
) {

74 
ušt32_t
 
vËn
 = (
kvs_v®ue_t
);

75 
ušt32_t
 
vËn_v®ue
 = 0;

77 
i
 = 0;˜< 
™”_li¡
->
num_’Œ›s
; i++) {

78 
	`årštf
(
¡dout
, "I‹¿tÜ g‘ %dth key: %s\n", 
i
, 
™_bufãr
);

79 
™_bufãr
 += 16;

81 
ušt8_t
 *
addr
 = (ušt8_ˆ*)&
vËn_v®ue
;

82 
i
 = 0; i < 
vËn
; i++) {

83 *(
addr
 + 
i
èğ*(
™_bufãr
 + i);

86 
™_bufãr
 +ğ
vËn
;

87 
™_bufãr
 +ğ
vËn_v®ue
;

103 
ušt32_t
 
key_size
 = 0;

104 
key
[256];

107 
i
 = 0;˜< 
™”_li¡
->
num_’Œ›s
; i++) {

109 
key_size
 = *((*)
™_bufãr
);

110 
™_bufãr
 += ();

113 
	`memıy
(
key
, 
™_bufãr
, 
key_size
);

114 
key
[
key_size
] = 0;

115 
	`årštf
(
¡dout
, "%dth key --> %s, sizğ%d\n", 
i
, 
key
, 
key_size
);

117 
™_bufãr
 +ğ
key_size
;

120 
	}
}

123 
	$com¶‘e
(
kvs_ÿÎback_cÚ‹xt
* 
ioùx
) {

124 ià(
ioùx
->
»suÉ
 !ğ0 && ioùx->»suÉ !ğ
KVS_ERR_KEY_NOT_EXIST
) {

125 
	`årštf
(
¡d”r
, "iØ”rÜ: o°ğ%d, key = %s,„esuÉ = 0x%x,ƒ¼ = %s\n", 
ioùx
->
İcode
, ioùx->
key
 ? (*)ioùx->key->key:0, ioùx->
»suÉ
, 
	`kvs_”r¡r
(ioctx->result));

126 
	`ex™
(1);

131 
ušt8_t
 *
exi¡
;

132 
ioùx
->
İcode
) {

133 
IOCB_ASYNC_ITER_NEXT_CMD
:

134 
com¶‘ed
++;

136 
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
:

137 
exi¡
 = (
ušt8_t
*)
ioùx
->
»suÉ_bufãr
;

138 
	`årštf
(
¡dout
, "key % exi¡? %s\n", (*)
ioùx
->
key
->key, *
exi¡
 == 0? "FALSE":"TRUE");

139 if(
ioùx
->
»suÉ_bufãr
)

140 
	`ä“
(
ioùx
->
»suÉ_bufãr
);

143 
¡d
::
queue
<*> * 
keypoŞ
 = (¡d::queue<*> *)
ioùx
->
´iv©e1
;

144 
¡d
::
queue
<*> * 
v®u•oŞ
 = (¡d::queue<*> *)
ioùx
->
´iv©e2
;

145 
	`±h»ad_mu‹x_lock
(&
lock
);

146 if(
ioùx
->
key
) {

147 if(
ioùx
->
key
->key)

148 
keypoŞ
->
	`push
((*)
ioùx
->
key
->key);

149 
	`ä“
(
ioùx
->
key
);

151 if(
ioùx
->
v®ue
) {

152 if(
ioùx
->
v®ue
->value)

153 
v®u•oŞ
->
	`push
((*)
ioùx
->
v®ue
->value);

154 
	`ä“
(
ioùx
->
v®ue
);

156 
	`±h»ad_mu‹x_uÆock
(&
lock
);

158 
com¶‘ed
++;

159 
cur_qd•th
--;

162 
	}
}

164 
	#WRITE_OP
 1

	)

165 
	#READ_OP
 2

	)

166 
	#DELETE_OP
 3

	)

167 
	#ITERATOR_OP
 4

	)

168 
	#KEY_EXIST_OP
 5

	)

170 
	$³rfÜm_™”©Ü
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
™”_kv
)

173 
couÁ
 = 
KVS_MAX_ITERATE_HANDLE
;

174 
kvs_™”©Ü_šfo
 
kvs_™”s
[
couÁ
];

176 
™”©Ü_šfo
 *
™”_šfo
 = (™”©Ü_šfØ*)
	`m®loc
((iterator_info));

178 if(
™”_kv
 == 0) {

179 
™”_šfo
->
g_™”_mode
.
™”_ty³
 = 
KVS_ITERATOR_KEY
;

181 
™”_šfo
->
g_™”_mode
.
™”_ty³
 = 
KVS_ITERATOR_KEY_VALUE
;

184 
»t
;

185 
tÙ®_’Œ›s
 = 0;

187 
	`årštf
(
¡dout
, "\n===========\n");

188 
	`årštf
(
¡dout
, " Do Iterate Operation\n");

189 
	`årštf
(
¡dout
, "===========\n");

193 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx_İ’
;

195 
™”_ùx_İ’
.
b™mask
 = 0xffff0000;

196 
´efix_¡r
[5] = "0000";

197 
PREFIX_KV
 = 0;

198 
i
 = 0; i < 4; i++){

199 
PREFIX_KV
 |ğ(
´efix_¡r
[
i
] << i*8);

202 
™”_ùx_İ’
.
b™_·‰”n
 = 
PREFIX_KV
;

203 
™”_ùx_İ’
.
´iv©e1
 = 
NULL
;

204 
™”_ùx_İ’
.
´iv©e2
 = 
NULL
;

205 
	`mem£t
(&
™”_ùx_İ’
.
İtiÚ
, 0, (
kvs_™”©Ü_İtiÚ
));

206 if(
™”_kv
 == 0)

207 
™”_ùx_İ’
.
İtiÚ
.
™”_ty³
 = 
KVS_ITERATOR_KEY
;

209 
™”_ùx_İ’
.
İtiÚ
.
™”_ty³
 = 
KVS_ITERATOR_KEY_VALUE
;

211 
subm™‹d
 = 
com¶‘ed
 = 0;

214 
»t
 = 
	`kvs_İ’_™”©Ü
(
cÚt_hd
, &
™”_ùx_İ’
, &
™”_šfo
->
™”_hªdË
);

215 if(
»t
) {

216 
	`årštf
(
¡dout
, "İ’ i‹¸çed w™hƒ¼ %s\n", 
	`kvs_”r¡r
(
»t
));

217 
	`ex™
(1);

220 
	`mem£t
(
kvs_™”s
, 0, (kvs_iters));

221 
»s
 = 
	`kvs_li¡_™”©Üs
(
cÚt_hd
, 
kvs_™”s
, 
couÁ
);

222 if(
»s
) {

223 
	`´štf
("kv_li¡_™”©Ü w™hƒ¼Ü: 0x%X\n", 
»s
);

224 
	`ex™
(1);

226 
j
 = 0; j < 
couÁ
; j++){

227 if(
kvs_™”s
[
j
].
¡©us
 =ğ1è
	`årštf
(
¡dout
, "found handler %d 0x%x 0x%x\n",

228 
kvs_™”s
[
j
].
™”_hªdË
,

229 
kvs_™”s
[
j
].
b™_·‰”n
,

230 
kvs_™”s
[
j
].
b™mask
);

236 
subm™‹d
 = 
com¶‘ed
 = 0;

237 
™”_šfo
->
™”_li¡
.
size
 = 
™”_buff
;

238 
ušt8_t
 *
bufãr
;

239 
bufãr
 =(
ušt8_t
*è
	`kvs_m®loc
(
™”_buff
, 4096);

240 
	`mem£t
(
bufãr
, 0, 
™”_buff
);

241 
™”_šfo
->
™”_li¡
.
™_li¡
 = (
ušt8_t
*è
bufãr
;

243 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx_Ãxt
;

244 
™”_ùx_Ãxt
.
´iv©e1
 = 
™”_šfo
;

245 
™”_ùx_Ãxt
.
´iv©e2
 = 
NULL
;

247 
™”_šfo
->
™”_li¡
.
’d
 = 0;

248 
™”_šfo
->
™”_li¡
.
num_’Œ›s
 = 0;

250 
time¥ec
 
t1
, 
t2
;

251 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

254 
™”_šfo
->
™”_li¡
.
size
 = 
™”_buff
;

255 
	`mem£t
(
™”_šfo
->
™”_li¡
.
™_li¡
, 0, 
™”_buff
);

256 
»t
 = 
	`kvs_™”©Ü_Ãxt_async
(
cÚt_hd
, 
™”_šfo
->
™”_hªdË
, &™”_šfo->
™”_li¡
, &
™”_ùx_Ãxt
, 
com¶‘e
);

257 if(
»t
 !ğ
KVS_SUCCESS
) {

258 
	`årštf
(
¡d”r
, "™”©Ü‚exˆç w™hƒ¼Ü 0x%x - %s\n", 
»t
, 
	`kvs_”r¡r
(ret));

259 
	`ä“
(
bufãr
);

260 
	`ä“
(
™”_šfo
);

261 
	`ex™
(1);

264 
subm™‹d
++;

266 
com¶‘ed
 < 
subm™‹d
)

267 
	`u¦“p
(1);

269 
tÙ®_’Œ›s
 +ğ
™”_šfo
->
™”_li¡
.
num_’Œ›s
;

272 if(
™”_šfo
->
™”_li¡
.
’d
) {

273 
	`årštf
(
¡dout
, "DÚw™h‡Î keys. TÙ®: %d\n", 
tÙ®_’Œ›s
);

276 
	`årštf
(
¡dout
, "More keys‡vailable, do‡nother iteration\n");

277 
	`mem£t
(
™”_šfo
->
™”_li¡
.
™_li¡
, 0, 
™”_buff
);

281 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

282 
¡¬t
, 
’d
;

283 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

284 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

285 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

286 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àkeys/£c\n", 
£c
, ()
tÙ®_’Œ›s
 /sec );

289 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx_şo£
;

290 
™”_ùx_şo£
.
´iv©e1
 = 
NULL
;

291 
™”_ùx_şo£
.
´iv©e2
 = 
NULL
;

293 
»t
 = 
	`kvs_şo£_™”©Ü
(
cÚt_hd
, 
™”_šfo
->
™”_hªdË
, &
™”_ùx_şo£
);

294 if(
»t
 !ğ
KVS_SUCCESS
) {

295 
	`årštf
(
¡d”r
, "Failedo close iterator\n");

296 
	`ex™
(1);

299 if(
bufãr
è
	`kvs_ä“
(buffer);

300 if(
™”_šfo
è
	`ä“
(iter_info);

303 
	}
}

305 
	$³rfÜm_»ad
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
maxd•th
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

306 
num_subm™‹d
 = 0;

307 
¡d
::
queue
<*> 
keypoŞ
;

308 
¡d
::
queue
<*> 
v®u•oŞ
;

309 
com¶‘ed
 = 0;

311 
i
 =0 ; i < 
maxd•th
; i++) {

312 *
keymem
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

313 *
v®uemem
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

314 if(
keymem
 =ğ
NULL
 || 
v®uemem
 == NULL) {

315 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

316 
	`ex™
(1);

318 
keypoŞ
.
	`push
(
keymem
);

319 
v®u•oŞ
.
	`push
(
v®uemem
);

322 
	`årštf
(
¡dout
, "\n===========\n");

323 
	`årštf
(
¡dout
, " Do Read Operation\n");

324 
	`årštf
(
¡dout
, "===========\n");

326 
time¥ec
 
t1
, 
t2
;

327 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

329 
£q
 = 0;

331 
num_subm™‹d
 < 
couÁ
) {

333 
cur_qd•th
 < 
maxd•th
) {

334 ià(
num_subm™‹d
 >ğ
couÁ
) ;

335 
	`±h»ad_mu‹x_lock
(&
lock
);

336 *
key
 = 
keypoŞ
.
	`äÚt
(); keypoŞ.
	`pİ
();

337 *
v®ue
 = 
v®u•oŞ
.
	`äÚt
(); v®u•oŞ.
	`pİ
();

338 
	`±h»ad_mu‹x_uÆock
(&
lock
);

339 
	`mem£t
(
v®ue
, 0, 
vËn
);

340 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
;

341 
	`mem£t
(&
İtiÚ
, 0, (
kvs_»Œ›ve_İtiÚ
));

342 
İtiÚ
.
kvs_»Œ›ve_decom´ess
 = 
çl£
;

343 
İtiÚ
.
kvs_»Œ›ve_d–‘e
 = 
çl£
;

344 cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 
»t_ùx
 = {
İtiÚ
, &
keypoŞ
, &
v®u•oŞ
};

345 
kvs_key
 *
kvskey
 = (kvs_key*)
	`m®loc
((kvs_key));

346 
kvskey
->
key
 = key;

347 
kvskey
->
Ëngth
 = 
kËn
;

348 
kvs_v®ue
 *
kvsv®ue
 = (kvs_v®ue*)
	`m®loc
((kvs_value));

349 
kvsv®ue
->
v®ue
 = value;

350 
kvsv®ue
->
Ëngth
 = 
vËn
;

351 
kvsv®ue
->
aùu®_v®ue_size
 = kvsv®ue->
off£t
 = 0;

353 
	`¥rštf
(
key
, "%0*ld", 
kËn
 - 1, 
£q
++);

354 
»t
 = 
	`kvs_»Œ›ve_tu¶e_async
(
cÚt_hd
, 
kvskey
, 
kvsv®ue
, &
»t_ùx
, 
com¶‘e
);

355 ià(
»t
 !ğ
KVS_SUCCESS
) {

356 
	`årštf
(
¡d”r
, "»Œ›vtu¶çed w™hƒ¼ % %x\n", 
	`kvs_”r¡r
(
»t
),„et);

357 
	`ex™
(1);

360 
cur_qd•th
++;

361 
num_subm™‹d
++;

365 ià(
cur_qd•th
 =ğ
maxd•th
è
	`u¦“p
(1);

369 
com¶‘ed
 < 
num_subm™‹d
) {

370 
	`u¦“p
(1);

373 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

374 
¡¬t
, 
’d
;

375 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

376 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

377 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

378 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àİs/£c\n", 
£c
, ()
couÁ
 /sec );

380 !
keypoŞ
.
	`em±y
()) {

381 autØ
p
 = 
keypoŞ
.
	`äÚt
();

382 
keypoŞ
.
	`pİ
();

383 
	`kvs_ä“
(
p
);

386 !
v®u•oŞ
.
	`em±y
()) {

387 autØ
p
 =
v®u•oŞ
.
	`äÚt
();

388 
v®u•oŞ
.
	`pİ
();

389 
	`kvs_ä“
(
p
);

393 
	}
}

396 
	$³rfÜm_š£¹iÚ
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
maxd•th
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

397 
num_subm™‹d
 = 0;

398 
¡d
::
queue
<*> 
keypoŞ
;

399 
¡d
::
queue
<*> 
v®u•oŞ
;

400 
com¶‘ed
 = 0;

401 
i
 =0 ; i < 
maxd•th
; i++) {

402 *
keymem
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

403 *
v®uemem
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

404 if(
keymem
 =ğ
NULL
 || 
v®uemem
 == NULL) {

405 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

406 
	`ex™
(1);

408 
keypoŞ
.
	`push
(
keymem
);

409 
v®u•oŞ
.
	`push
(
v®uemem
);

412 
£q
 = 0;

413 
	`årštf
(
¡dout
, "\n===========\n");

414 
	`årštf
(
¡dout
, " Do Write Operation\n");

415 
	`årštf
(
¡dout
, "===========\n");

417 
time¥ec
 
t1
, 
t2
;

418 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

420 
num_subm™‹d
 < 
couÁ
) {

421 
cur_qd•th
 < 
maxd•th
) {

422 ià(
num_subm™‹d
 >ğ
couÁ
) ;

424 
	`±h»ad_mu‹x_lock
(&
lock
);

425 *
key
 = 
keypoŞ
.
	`äÚt
(); keypoŞ.
	`pİ
();

426 *
v®ue
 = 
v®u•oŞ
.
	`äÚt
(); v®u•oŞ.
	`pİ
();

427 
	`±h»ad_mu‹x_uÆock
(&
lock
);

428 if(!
key
 || !
v®ue
) {

429 
	`årštf
(
¡d”r
, "no mem is‡llocated\n");

430 
	`ex™
(1);

433 
	`¥rštf
(
key
, "%0*ld", 
kËn
 - 1, 
£q
++);

434 
	`¥rštf
(
v®ue
, "v®ue%ld", 
£q
);

435 
kvs_¡Üe_İtiÚ
 
İtiÚ
;

436 
	`mem£t
(&
İtiÚ
, 0, (
kvs_¡Üe_İtiÚ
));

437 
İtiÚ
.
¡_ty³
 = 
KVS_STORE_POST
;

438 
İtiÚ
.
kvs_¡Üe_com´ess
 = 
çl£
;

440 cÚ¡ 
kvs_¡Üe_cÚ‹xt
 
put_ùx
 = {
İtiÚ
, &
keypoŞ
, &
v®u•oŞ
 };

441 
kvs_key
 *
kvskey
 = (kvs_key*)
	`m®loc
((kvs_key));

442 
kvskey
->
key
 = key;

443 
kvskey
->
Ëngth
 = 
kËn
;

444 
kvs_v®ue
 *
kvsv®ue
 = (kvs_v®ue*)
	`m®loc
((kvs_value));

445 
kvsv®ue
->
v®ue
 = value;

446 
kvsv®ue
->
Ëngth
 = 
vËn
;

447 
kvsv®ue
->
aùu®_v®ue_size
 = kvsv®ue->
off£t
 = 0;

448 
»t
 = 
	`kvs_¡Üe_tu¶e_async
(
cÚt_hd
, 
kvskey
, 
kvsv®ue
, &
put_ùx
, 
com¶‘e
);

450 ià(
»t
 !ğ
KVS_SUCCESS
) {

451 
	`årštf
(
¡d”r
, "¡Ütu¶çed w™hƒ¼ %s\n", 
	`kvs_”r¡r
(
»t
));

453 
	`ex™
(1);

456 
cur_qd•th
++;

457 
num_subm™‹d
++;

460 ià(
cur_qd•th
 =ğ
maxd•th
è
	`u¦“p
(1);

465 
com¶‘ed
 < 
num_subm™‹d
) {

466 
	`u¦“p
(1);

469 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

470 
¡¬t
, 
’d
;

471 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

472 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

473 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

474 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àİs/£c\n", 
£c
, ()
couÁ
 /sec );

476 !
keypoŞ
.
	`em±y
()) {

477 autØ
p
 = 
keypoŞ
.
	`äÚt
();

478 
keypoŞ
.
	`pİ
();

479 
	`kvs_ä“
(
p
);

482 !
v®u•oŞ
.
	`em±y
()) {

483 autØ
p
 =
v®u•oŞ
.
	`äÚt
();

484 
v®u•oŞ
.
	`pİ
();

485 
	`kvs_ä“
(
p
);

489 
	}
}

491 
	$³rfÜm_d–‘e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
maxd•th
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

492 
num_subm™‹d
 = 0;

493 
¡d
::
queue
<*> 
keypoŞ
;

494 
¡d
::
queue
<*> 
v®u•oŞ
;

495 
com¶‘ed
 = 0;

497 
i
 =0 ; i < 
maxd•th
; i++) {

498 *
keymem
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

499 *
v®uemem
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

500 if(
keymem
 =ğ
NULL
 || 
v®uemem
 == NULL) {

501 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

502 
	`ex™
(1);

504 
keypoŞ
.
	`push
(
keymem
);

505 
v®u•oŞ
.
	`push
(
v®uemem
);

508 
£q
 = 0;

510 
	`årštf
(
¡dout
, "\n===========\n");

511 
	`årštf
(
¡dout
, " Do Delete Operation\n");

512 
	`årštf
(
¡dout
, "===========\n");

514 
time¥ec
 
t1
, 
t2
;

515 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

517 
num_subm™‹d
 < 
couÁ
) {

518 
cur_qd•th
 < 
maxd•th
) {

519 ià(
num_subm™‹d
 >ğ
couÁ
) ;

520 
	`±h»ad_mu‹x_lock
(&
lock
);

521 *
key
 = 
keypoŞ
.
	`äÚt
(); keypoŞ.
	`pİ
();

522 
	`±h»ad_mu‹x_uÆock
(&
lock
);

523 
	`¥rštf
(
key
, "%0*ld", 
kËn
 - 1, 
£q
++);

524 
kvs_key
 *
kvskey
 = (kvs_key*)
	`m®loc
((kvs_key));

525 
kvskey
->
key
 = key;

526 
kvskey
->
Ëngth
 = 
kËn
;

527 
kvs_d–‘e_İtiÚ
 
İtiÚ
;

528 
İtiÚ
.
kvs_d–‘e_”rÜ
 = 
çl£
;

529 cÚ¡ 
kvs_d–‘e_cÚ‹xt
 
d–_ùx
 = { 
İtiÚ
, &
keypoŞ
, &
v®u•oŞ
};

530 
»t
 = 
	`kvs_d–‘e_tu¶e_async
(
cÚt_hd
, 
kvskey
, &
d–_ùx
, 
com¶‘e
);

531 ià(
»t
 !ğ
KVS_SUCCESS
) {

532 
	`årštf
(
¡d”r
, "d–‘tu¶çed w™hƒ¼ %s\n", 
	`kvs_”r¡r
(
»t
));

533 
	`ex™
(1);

536 
cur_qd•th
++;

537 
num_subm™‹d
++;

540 ià(
cur_qd•th
 =ğ
maxd•th
è
	`u¦“p
(1);

544 
com¶‘ed
 < 
num_subm™‹d
) {

545 
	`u¦“p
(1);

549 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

550 
¡¬t
, 
’d
;

551 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

552 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

553 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

554 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àİs/£c\n", 
£c
, ()
couÁ
 /sec );

556 !
keypoŞ
.
	`em±y
()) {

557 autØ
p
 = 
keypoŞ
.
	`äÚt
();

558 
keypoŞ
.
	`pİ
();

559 
	`kvs_ä“
(
p
);

562 !
v®u•oŞ
.
	`em±y
()) {

563 autØ
p
 =
v®u•oŞ
.
	`äÚt
();

564 
v®u•oŞ
.
	`pİ
();

565 
	`kvs_ä“
(
p
);

569 
	}
}

571 
	$³rfÜm_key_exi¡
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
maxd•th
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
 ) {

573 
num_subm™‹d
 = 0;

574 
¡d
::
queue
<*> 
keypoŞ
;

575 
¡d
::
queue
<*> 
v®u•oŞ
;

576 
com¶‘ed
 = 0;

578 
i
 =0 ; i < 
maxd•th
; i++) {

579 *
keymem
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

580 *
v®uemem
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

581 if(
keymem
 =ğ
NULL
 || 
v®uemem
 == NULL) {

582 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

583 
	`ex™
(1);

586 
keypoŞ
.
	`push
(
keymem
);

587 
v®u•oŞ
.
	`push
(
v®uemem
);

590 
£q
 = 0;

591 
	`årštf
(
¡dout
, "\n===========\n");

592 
	`årštf
(
¡dout
, " Do keyƒxist check Operation\n");

593 
	`årštf
(
¡dout
, "===========\n");

595 
time¥ec
 
t1
, 
t2
;

596 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

597 
num_subm™‹d
 < 
couÁ
) {

598 
cur_qd•th
 < 
maxd•th
) {

599 ià(
num_subm™‹d
 >ğ
couÁ
) ;

600 
	`±h»ad_mu‹x_lock
(&
lock
);

601 *
key
 = 
keypoŞ
.
	`äÚt
(); keypoŞ.
	`pİ
();

602 
	`±h»ad_mu‹x_uÆock
(&
lock
);

603 
	`¥rštf
(
key
, "%0*ld", 
kËn
 - 1, 
£q
++);

604 
kvs_key
 *
kvskey
 = (kvs_key*)
	`m®loc
((kvs_key));

605 
kvskey
->
key
 = key;

606 
kvskey
->
Ëngth
 = 
kËn
;

607 cÚ¡ 
kvs_exi¡_cÚ‹xt
 
exi¡_ùx
 = {&
keypoŞ
, &
v®u•oŞ
};

609 
ušt8_t
 *
¡©us
 = (ušt8_t*)
	`m®loc
((uint8_t));

610 
»t
 = 
	`kvs_exi¡_tu¶es_async
(
cÚt_hd
, 1, 
kvskey
, 1, 
¡©us
, &
exi¡_ùx
, 
com¶‘e
);

611 ià(
»t
 !ğ
KVS_SUCCESS
) {

612 
	`årštf
(
¡d”r
, "ex™u¶çed w™hƒ¼ %s\n", 
	`kvs_”r¡r
(
»t
));

613 
	`ex™
(1);

616 
cur_qd•th
++;

617 
num_subm™‹d
++;

620 ià(
cur_qd•th
 =ğ
maxd•th
è
	`u¦“p
(1);

623 
com¶‘ed
 < 
num_subm™‹d
) {

624 
	`u¦“p
(1);

627 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

628 
¡¬t
, 
’d
;

629 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

630 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

631 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

632 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àİs/£c\n", 
£c
, ()
couÁ
 /sec );

634 !
keypoŞ
.
	`em±y
()) {

635 autØ
p
 = 
keypoŞ
.
	`äÚt
();

636 
keypoŞ
.
	`pİ
();

637 
	`kvs_ä“
(
p
);

640 !
v®u•oŞ
.
	`em±y
()) {

641 autØ
p
 =
v®u•oŞ
.
	`äÚt
();

642 
v®u•oŞ
.
	`pİ
();

643 
	`kvs_ä“
(
p
);

647 
	}
}

649 
	$maš
(
¬gc
, *
¬gv
[]) {

650 * 
dev_·th
 = 
NULL
;

651 
num_ios
 = 10;

652 
qd•th
 = 64;

653 
İ_ty³
 = 1;

654 
kvs_key_t
 
kËn
 = 16;

655 
ušt32_t
 
vËn
 = 4096;

657 
c
;

658 
»t
;

660 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "d:n:q:o:k:v:h")) != -1) {

661 
c
) {

663 
dev_·th
 = 
İrg
;

666 
num_ios
 = 
	`©oi
(
İrg
);

669 
qd•th
 = 
	`©oi
(
İrg
);

672 
İ_ty³
 = 
	`©oi
(
İrg
);

675 
kËn
 = 
	`©oi
(
İrg
);

678 
vËn
 = 
	`©oi
(
İrg
);

681 
	`u§ge
(
¬gv
[0]);

682 
	`ex™
(1);

685 
	`u§ge
(
¬gv
[0]);

686 
	`ex™
(0);

691 if(
dev_·th
 =ğ
NULL
) {

692 
	`årštf
(
¡d”r
, "Please specify KV SSD device…ath\n");

693 
	`u§ge
(
¬gv
[0]);

694 
	`ex™
(0);

697 
kvs_š™_İtiÚs
 
İtiÚs
;

698 
	`kvs_š™_’v_İts
(&
İtiÚs
);

700 
qŞÚ
 = ':';

701 *
found
;

702 
found
 = 
	`¡rchr
(
dev_·th
, 
qŞÚ
);

704 
İtiÚs
.
aio
.
iocÜemask
 = 0;

705 
İtiÚs
.
memÜy
.
u£_dpdk
 = 0;

706 
İtiÚs
.
aio
.
queued•th
 = 
qd•th
;

707 cÚ¡ *
cÚfigfe
 = "../kvssd_emul.conf";

708 
İtiÚs
.
emul_cÚfig_fe
 = 
cÚfigfe
;

710 if(
found
) {

711 
İtiÚs
.
memÜy
.
u£_dpdk
 = 1;

712 *
cÜe
;

713 
cÜe
 = 
İtiÚs
.
udd
.
cÜe_mask_¡r
;

714 *
cÜe
 = '0';

715 
cÜe
 = 
İtiÚs
.
udd
.
cq_th»ad_mask
;

716 *
cÜe
 = '0';

717 
İtiÚs
.
udd
.
mem_size_mb
 = 1024;

718 
İtiÚs
.
udd
.
syncio
 = 0;

719 
ıu_£t_t
 
ıu£t
;

720 
	`CPU_ZERO
(&
ıu£t
);

721 
	`CPU_SET
(0, &
ıu£t
);

722 
	`sched_£ffš™y
(0, (
ıu_£t_t
), &
ıu£t
);

725 
İtiÚs
.
memÜy
.
u£_dpdk
 = 0;

729 
	`kvs_š™_’v
(&
İtiÚs
);

731 
kvs_deviû_hªdË
 
dev
;

732 
»t
 = 
	`kvs_İ’_deviû
(
dev_·th
, &
dev
);

733 if(
»t
 !ğ
KVS_SUCCESS
) {

734 
	`årštf
(
¡d”r
, "Deviû o³Àçed %s\n", 
	`kvs_”r¡r
(
»t
));

735 
	`ex™
(1);

738 
kvs_cÚš”_cÚ‹xt
 
ùx
;

739 
	`kvs_ü—‹_cÚš”
(
dev
, "‹¡", 4, &
ùx
);

741 
kvs_cÚš”_hªdË
 
cÚt_hªdË
;

742 
	`kvs_İ’_cÚš”
(
dev
, "‹¡", &
cÚt_hªdË
);

744 
št32_t
 
dev_ut
 = 0;

745 
št64_t
 
dev_ÿ·
 = 0;

746 
kvs_deviû
 *
dev_šfo
 = (kvs_deviû*)
	`m®loc
((kvs_device));

748 
	`kvs_g‘_deviû_utiz©iÚ
(
dev
, &
dev_ut
);

750 
waf
 = 0.0;

752 
	`kvs_g‘_deviû_waf
(
dev
, &
waf
);

753 
	`kvs_g‘_deviû_ÿ·c™y
(
dev
, &
dev_ÿ·
);

754 
	`årštf
(
¡dout
, "BefÜe: TÙ® sizi %ld by‹s, u£d i %d, waài %.2f\n", 
dev_ÿ·
, 
dev_ut
, 
waf
);

756 
	`kvs_g‘_deviû_šfo
(
dev
, 
dev_šfo
);

757 
	`årštf
(
¡dout
, "Total size: %.2f GB\nMax value size: %d\nMax key size: %d\nOptimal value size: %d\n",

758 ()
dev_šfo
->
ÿ·c™y
/1024/1024/1024, dev_šfo->
max_v®ue_Ën
,

759 
dev_šfo
->
max_key_Ën
, dev_šfo->
İtim®_v®ue_Ën
);

761 if(
dev_šfo
)

762 
	`ä“
(
dev_šfo
);

764 
İ_ty³
) {

765 
WRITE_OP
:

766 
	`³rfÜm_š£¹iÚ
(
cÚt_hªdË
, 
num_ios
, 
qd•th
, 
kËn
, 
vËn
);

768 
READ_OP
:

770 
	`³rfÜm_»ad
(
cÚt_hªdË
, 
num_ios
, 
qd•th
, 
kËn
, 
vËn
);

772 
DELETE_OP
:

774 
	`³rfÜm_d–‘e
(
cÚt_hªdË
, 
num_ios
, 
qd•th
, 
kËn
, 
vËn
);

776 
ITERATOR_OP
:

778 
	`³rfÜm_™”©Ü
(
cÚt_hªdË
, 0);

780 
KEY_EXIST_OP
:

782 
	`³rfÜm_key_exi¡
(
cÚt_hªdË
, 
num_ios
, 
qd•th
, 
kËn
, 
vËn
);

785 
	`årštf
(
¡d”r
, "Please specify‡ correct op_type foresting\n");

786 
	`ex™
(1);

790 
	`kvs_g‘_deviû_utiz©iÚ
(
dev
, &
dev_ut
);

791 
	`årštf
(
¡dout
, "Aá”: TÙ® sizi %ld by‹s, u£d i %d\n", 
dev_ÿ·
, 
dev_ut
);

793 
	`kvs_şo£_cÚš”
(
cÚt_hªdË
);

794 
	`kvs_d–‘e_cÚš”
(
dev
, "test");

795 
	`kvs_ex™_’v
();

798 
	}
}

	@PDK/core/sample_code/test_sync.cpp

34 
	~<¡dio.h
>

35 
	~<¡dšt.h
>

36 
	~<mu‹x
>

37 
	~<©omic
>

38 
	~<uni¡d.h
>

39 
	~<queue
>

40 
	~<kvs_­i.h
>

42 
	gu£_udd
 = 0;

44 
	s™”©Ü_šfo
{

45 
kvs_™”©Ü_hªdË
 
	m™”_hªdË
;

46 
kvs_™”©Ü_li¡
 
	m™”_li¡
;

47 
	mhas_™”_fšish
;

48 
kvs_™”©Ü_İtiÚ
 
	mg_™”_mode
;

50 
	#™”_buff
 (32*1024)

	)

53 
	sth»ad_¬gs
{

54 
	mid
;

55 
kvs_key_t
 
	mkËn
;

56 
ušt32_t
 
	mvËn
;

57 
	mcouÁ
;

58 
	mİ_ty³
;

59 
kvs_cÚš”_hªdË
 
	mcÚt_hd
;

64 
	$u§ge
(*
´og¿m
)

66 
	`´štf
("==============\n");

67 
	`´štf
("u§ge: % -d deviû_·th [-Ànum_ios] [-Øİ_ty³] [-k kËn] [-v vËn] [-ˆth»ads]\n", 
´og¿m
);

68 
	`´štf
("-d device_path : kvssd device…ath.ƒ.g.ƒmul: /dev/kvemul; kdd: /dev/nvme0n1; udd: 0000:06:00.0\n");

69 
	`´štf
("-n‚um_ios :otal‚umber of ios (ignorehis for iterator)\n");

70 
	`´štf
("-o op_type : 1: write; 2:„ead; 3: delete; 4: iterator; 5: keyƒxist check\n");

71 
	`´štf
("-k klen : key†ength (ignorehis for iterator)\n");

72 
	`´štf
("-v vlen : value†ength (ignorehis for iterator)\n");

73 
	`´štf
("-threads :‚umber ofhreads\n");

74 
	`´štf
("==============\n");

75 
	}
}

78 
	$´št_™”©Ü_keyv®s
(
kvs_™”©Ü_li¡
 *
™”_li¡
, 
kvs_™”©Ü_İtiÚ
 
g_™”_mode
){

79 
ušt8_t
 *
™_bufãr
 = (ušt8_ˆ*è
™”_li¡
->
™_li¡
;

80 
ušt32_t
 
i
;

82 if(
g_™”_mode
.
™”_ty³
) {

84 
ušt32_t
 
vËn
 = (
kvs_v®ue_t
);

85 
ušt32_t
 
vËn_v®ue
 = 0;

87 
i
 = 0;˜< 
™”_li¡
->
num_’Œ›s
; i++) {

88 
	`årštf
(
¡dout
, "I‹¿tÜ g‘ %dth key: %s\n", 
i
, 
™_bufãr
);

89 
™_bufãr
 += 16;

91 
ušt8_t
 *
addr
 = (ušt8_ˆ*)&
vËn_v®ue
;

92 
i
 = 0; i < 
vËn
; i++) {

93 *(
addr
 + 
i
èğ*(
™_bufãr
 + i);

96 
™_bufãr
 +ğ
vËn
;

97 
™_bufãr
 +ğ
vËn_v®ue
;

112 
ušt32_t
 
key_size
 = 0;

113 
key
[256];

115 
i
 = 0;˜< 
™”_li¡
->
num_’Œ›s
; i++) {

117 
key_size
 = *((*)
™_bufãr
);

118 
™_bufãr
 += ();

121 
	`memıy
(
key
, 
™_bufãr
, 
key_size
);

122 
key
[
key_size
] = 0;

123 
	`årštf
(
¡dout
, "%dth key --> %s\n", 
i
, 
key
);

125 
™_bufãr
 +ğ
key_size
;

129 
	}
}

131 
	#WRITE_OP
 1

	)

132 
	#READ_OP
 2

	)

133 
	#DELETE_OP
 3

	)

134 
	#ITERATOR_OP
 4

	)

135 
	#KEY_EXIST_OP
 5

	)

137 
	$³rfÜm_™”©Ü
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
™”_kv
)

139 
™”©Ü_šfo
 *
™”_šfo
 = (™”©Ü_šfØ*)
	`m®loc
((iterator_info));

141 if(
™”_kv
 == 0)

142 
™”_šfo
->
g_™”_mode
.
™”_ty³
 = 
KVS_ITERATOR_KEY
;

144 
™”_šfo
->
g_™”_mode
.
™”_ty³
 = 
KVS_ITERATOR_KEY_VALUE
;

146 
»t
;

147 
tÙ®_’Œ›s
 = 0;

151 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx_İ’
;

153 
™”_ùx_İ’
.
b™mask
 = 0xffff0000;

154 
´efix_¡r
[5] = "0000";

155 
PREFIX_KV
 = 0;

156 
i
 = 0; i < 4; i++){

157 
PREFIX_KV
 |ğ(
´efix_¡r
[
i
] << i*8);

160 
™”_ùx_İ’
.
b™_·‰”n
 = 
PREFIX_KV
;

161 
™”_ùx_İ’
.
´iv©e1
 = 
NULL
;

162 
™”_ùx_İ’
.
´iv©e2
 = 
NULL
;

164 if(
™”_kv
 == 0)

165 
™”_ùx_İ’
.
İtiÚ
.
™”_ty³
 = 
KVS_ITERATOR_KEY
;

167 
™”_ùx_İ’
.
İtiÚ
.
™”_ty³
 = 
KVS_ITERATOR_KEY_VALUE
;

169 
»t
 = 
	`kvs_İ’_™”©Ü
(
cÚt_hd
, &
™”_ùx_İ’
, &
™”_šfo
->
™”_hªdË
);

170 if(
»t
 !ğ
KVS_SUCCESS
) {

171 
	`årštf
(
¡d”r
, "™”©Ü o³Àç w™hƒ¼Ü 0x%x - %s\n", 
»t
, 
	`kvs_”r¡r
(ret));

172 
	`ä“
(
™”_šfo
);

173 
	`ex™
(1);

177 
™”_šfo
->
™”_li¡
.
size
 = 
™”_buff
;

178 
ušt8_t
 *
bufãr
;

179 
bufãr
 =(
ušt8_t
*è
	`kvs_m®loc
(
™”_buff
, 4096);

180 
™”_šfo
->
™”_li¡
.
™_li¡
 = (
ušt8_t
*è
bufãr
;

182 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx_Ãxt
;

183 
™”_ùx_Ãxt
.
´iv©e1
 = 
™”_šfo
;

184 
™”_ùx_Ãxt
.
´iv©e2
 = 
NULL
;

186 
™”_šfo
->
™”_li¡
.
’d
 = 0;

187 
™”_šfo
->
™”_li¡
.
num_’Œ›s
 = 0;

189 
time¥ec
 
t1
, 
t2
;

190 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

193 
™”_šfo
->
™”_li¡
.
size
 = 
™”_buff
;

194 
	`mem£t
(
™”_šfo
->
™”_li¡
.
™_li¡
, 0, 
™”_buff
);

195 
»t
 = 
	`kvs_™”©Ü_Ãxt
(
cÚt_hd
, 
™”_šfo
->
™”_hªdË
, &™”_šfo->
™”_li¡
, &
™”_ùx_Ãxt
);

196 if(
»t
 !ğ
KVS_SUCCESS
) {

197 
	`årštf
(
¡d”r
, "™”©Ü‚exˆç w™hƒ¼Ü 0x%x - %s\n", 
»t
, 
	`kvs_”r¡r
(ret));

198 
	`ä“
(
™”_šfo
);

199 
	`ex™
(1);

202 
tÙ®_’Œ›s
 +ğ
™”_šfo
->
™”_li¡
.
num_’Œ›s
;

205 if(
™”_šfo
->
™”_li¡
.
’d
) {

206 
	`årštf
(
¡dout
, "DÚw™h‡Î keys. TÙ®: %d\n", 
tÙ®_’Œ›s
);

209 
	`årštf
(
¡dout
, "More keys‡vailable, do‡nother iteration\n");

210 
	`mem£t
(
™”_šfo
->
™”_li¡
.
™_li¡
, 0, 
™”_buff
);

214 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

215 
¡¬t
, 
’d
;

216 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

217 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

218 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

219 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àkeys/£c\n", 
£c
, ()
tÙ®_’Œ›s
 /sec );

222 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx_şo£
;

223 
™”_ùx_şo£
.
´iv©e1
 = 
NULL
;

224 
™”_ùx_şo£
.
´iv©e2
 = 
NULL
;

226 
»t
 = 
	`kvs_şo£_™”©Ü
(
cÚt_hd
, 
™”_šfo
->
™”_hªdË
, &
™”_ùx_şo£
);

227 if(
»t
 !ğ
KVS_SUCCESS
) {

228 
	`årštf
(
¡d”r
, "Failedo close iterator\n");

229 
	`ex™
(1);

232 if(
bufãr
è
	`kvs_ä“
(buffer);

233 if(
™”_šfo
è
	`ä“
(iter_info);

236 
	}
}

238 
	$³rfÜm_»ad
(
id
, 
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

239 
»t
;

240 *
key
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

241 *
v®ue
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

242 if(
key
 =ğ
NULL
 || 
v®ue
 == NULL) {

243 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

244 
	`ex™
(1);

247 
¡¬t_key
 = 
id
 * 
couÁ
;

248 
i
 = 
¡¬t_key
; i < s¹_key + 
couÁ
; i++) {

249 
	`mem£t
(
v®ue
, 0, 
vËn
);

250 
	`¥rštf
(
key
, "%0*d", 
kËn
 - 1, 
i
);

251 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
;

252 
	`mem£t
(&
İtiÚ
, 0, (
kvs_»Œ›ve_İtiÚ
));

253 
İtiÚ
.
kvs_»Œ›ve_decom´ess
 = 
çl£
;

254 
İtiÚ
.
kvs_»Œ›ve_d–‘e
 = 
çl£
;

256 cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 
»t_ùx
 = {
İtiÚ
, 0, 0};

257 cÚ¡ 
kvs_key
 
kvskey
 = {
key
, 
kËn
 };

258 
kvs_v®ue
 
kvsv®ue
 = { 
v®ue
, 
vËn
 , 0, 0 };

260 
»t
 = 
	`kvs_»Œ›ve_tu¶e
(
cÚt_hd
, &
kvskey
, &
kvsv®ue
, &
»t_ùx
);

261 if(
»t
 !ğ
KVS_SUCCESS
) {

262 
	`årštf
(
¡d”r
, "»Œ›vtu¶% çed w™hƒ¼Ü 0x%x - %s\n", 
key
, 
»t
, 
	`kvs_”r¡r
(ret));

269 if(
key
è
	`kvs_ä“
(key);

270 if(
v®ue
è
	`kvs_ä“
(value);

273 
	}
}

276 
	$³rfÜm_š£¹iÚ
(
id
, 
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

278 *
key
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

279 *
v®ue
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

280 if(
key
 =ğ
NULL
 || 
v®ue
 == NULL) {

281 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

282 
	`ex™
(1);

285 
¡¬t_key
 = 
id
 * 
couÁ
;

287 
i
 = 
¡¬t_key
; i < s¹_key + 
couÁ
; i++) {

289 
	`¥rštf
(
key
, "%0*d", 
kËn
 - 1, 
i
);

291 
kvs_¡Üe_İtiÚ
 
İtiÚ
;

292 
İtiÚ
.
¡_ty³
 = 
KVS_STORE_POST
;

293 
İtiÚ
.
kvs_¡Üe_com´ess
 = 
çl£
;

295 cÚ¡ 
kvs_¡Üe_cÚ‹xt
 
put_ùx
 = {
İtiÚ
, 0, 0};

296 cÚ¡ 
kvs_key
 
kvskey
 = { 
key
, 
kËn
};

297 cÚ¡ 
kvs_v®ue
 
kvsv®ue
 = { 
v®ue
, 
vËn
, 0, 0};

299 
»t
 = 
	`kvs_¡Üe_tu¶e
(
cÚt_hd
, &
kvskey
, &
kvsv®ue
, &
put_ùx
);

300 if(
»t
 !ğ
KVS_SUCCESS
 ) {

301 
	`årštf
(
¡d”r
, "¡Ütu¶çed w™hƒ¼Ü 0x%x - %s\n", 
»t
, 
	`kvs_”r¡r
(ret));

302 
	`ex™
(1);

307 if(
i
 % 100 == 0)

308 
	`årštf
(
¡dout
, "%d\r", 
i
);

311 if(
key
è
	`kvs_ä“
(key);

312 if(
v®ue
è
	`kvs_ä“
(value);

315 
	}
}

317 
	$³rfÜm_d–‘e
(
id
, 
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

319 *
key
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

321 if(
key
 =ğ
NULL
) {

322 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

323 
	`ex™
(1);

326 
¡¬t_key
 = 
id
 * 
couÁ
;

327 
i
 = 
¡¬t_key
; i < s¹_key + 
couÁ
; i++) {

328 
	`¥rštf
(
key
, "%0*d", 
kËn
 - 1, 
i
);

329 cÚ¡ 
kvs_key
 
kvskey
 = { 
key
, 
kËn
};

331 cÚ¡ 
kvs_d–‘e_cÚ‹xt
 
d–_ùx
 = { {
çl£
}, 0, 0};

332 
»t
 = 
	`kvs_d–‘e_tu¶e
(
cÚt_hd
, &
kvskey
, &
d–_ùx
);

333 if(
»t
 !ğ
KVS_SUCCESS
) {

334 
	`årštf
(
¡d”r
, "d–‘tu¶çed w™hƒ¼Ü 0x%x - %s\n", 
»t
, 
	`kvs_”r¡r
(ret));

335 
	`ex™
(1);

337 
	`årštf
(
¡d”r
, "d–‘key % dÚ\n", 
key
);

341 if(
key
è
	`kvs_ä“
(key);

343 
	}
}

345 
	$³rfÜm_key_exi¡
(
id
, 
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
) {

347 *
key
 = (*)
	`kvs_m®loc
(
kËn
, 4096);

348 if(
key
 =ğ
NULL
) {

349 
	`årštf
(
¡d”r
, "failedo‡llocate\n");

350 
	`ex™
(1);

352 
ušt8_t
 
¡©us
 = 0;

353 
¡¬t_key
 = 
id
 * 
couÁ
;

354 
i
 = 
¡¬t_key
; i < s¹_key + 
couÁ
; i++) {

355 
¡©us
 = 0;

356 
	`¥rštf
(
key
, "%0*d", 
kËn
 - 1, 
i
);

357 cÚ¡ 
kvs_key
 
kvskey
 = { 
key
, 
kËn
};

358 cÚ¡ 
kvs_exi¡_cÚ‹xt
 
exi¡_ùx
 = {0, 0};

360 
»t
 = 
	`kvs_exi¡_tu¶es
(
cÚt_hd
, 1, &
kvskey
, 1, &
¡©us
, &
exi¡_ùx
);

361 if(
»t
 !ğ
KVS_SUCCESS
 &&„‘ !ğ
KVS_ERR_KEY_NOT_EXIST
) {

362 
	`årštf
(
¡d”r
, "exi¡u¶çed w™hƒ¼Ü 0x%x - %s\n", 
»t
, 
	`kvs_”r¡r
(ret));

363 
	`ex™
(1);

365 
	`årštf
(
¡d”r
, "check key % exi¡? %s\n", 
key
, 
¡©us
 == 0? "FALSE":"TRUE");

369 if(
key
è
	`kvs_ä“
(key);

371 
	}
}

374 
	$do_io
(
id
, 
kvs_cÚš”_hªdË
 
cÚt_hd
, 
couÁ
, 
kvs_key_t
 
kËn
, 
ušt32_t
 
vËn
, 
İ_ty³
) {

376 
İ_ty³
) {

377 
WRITE_OP
:

378 
	`³rfÜm_š£¹iÚ
(
id
, 
cÚt_hd
, 
couÁ
, 
kËn
, 
vËn
);

380 
READ_OP
:

382 
	`³rfÜm_»ad
(
id
, 
cÚt_hd
, 
couÁ
, 
kËn
, 
vËn
);

384 
DELETE_OP
:

386 
	`³rfÜm_d–‘e
(
id
, 
cÚt_hd
, 
couÁ
, 
kËn
, 
vËn
);

388 
ITERATOR_OP
:

390 
	`³rfÜm_™”©Ü
(
cÚt_hd
, 0);

394 
KEY_EXIST_OP
:

396 
	`³rfÜm_key_exi¡
(
id
, 
cÚt_hd
, 
couÁ
, 
kËn
, 
vËn
);

399 
	`årštf
(
¡d”r
, "Please specify‡ correct op_type foresting\n");

400 
	`ex™
(1);

403 
	}
}

405 *
	$iÙh»ad
(*
¬gs
)

407 
th»ad_¬gs
 *
rgs
 = (th»ad_¬g *)
¬gs
;

408 
	`do_io
(
rgs
->
id
,¬gs->
cÚt_hd
,¬gs->
couÁ
,¬gs->
kËn
,¬gs->
vËn
,¬gs->
İ_ty³
);

410 
	}
}

413 
	$maš
(
¬gc
, *
¬gv
[]) {

414 * 
dev_·th
 = 
NULL
;

415 
num_ios
 = 10;

416 
İ_ty³
 = 1;

417 
kvs_key_t
 
kËn
 = 16;

418 
ušt32_t
 
vËn
 = 4096;

419 
»t
, 
c
, 
t
 = 1;

421 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "d:n:o:k:v:t:h")) != -1) {

422 
c
) {

424 
dev_·th
 = 
İrg
;

427 
num_ios
 = 
	`©oi
(
İrg
);

430 
İ_ty³
 = 
	`©oi
(
İrg
);

433 
kËn
 = 
	`©oi
(
İrg
);

436 
vËn
 = 
	`©oi
(
İrg
);

439 
t
 = 
	`©oi
(
İrg
);

442 
	`u§ge
(
¬gv
[0]);

443 
	`ex™
(0);

446 
	`u§ge
(
¬gv
[0]);

447 
	`ex™
(0);

451 if(
dev_·th
 =ğ
NULL
) {

452 
	`årštf
(
¡d”r
, "Please specify KV SSD device…ath\n");

453 
	`u§ge
(
¬gv
[0]);

454 
	`ex™
(0);

457 if(
İ_ty³
 =ğ
ITERATOR_OP
 && 
t
 > 1) {

458 
	`årštf
(
¡dout
, "Iterator only supports singlehread \n");

459 
	`ex™
(1);

462 
kvs_š™_İtiÚs
 
İtiÚs
;

463 
	`kvs_š™_’v_İts
(&
İtiÚs
);

465 
qŞÚ
 = ':';

466 *
found
;

467 
found
 = 
	`¡rchr
(
dev_·th
, 
qŞÚ
);

469 
İtiÚs
.
memÜy
.
u£_dpdk
 = 0;

471 cÚ¡ *
cÚfigfe
 = "../kvssd_emul.conf";

472 
İtiÚs
.
emul_cÚfig_fe
 = 
cÚfigfe
;

474 if(
found
) {

475 
u£_udd
 = 1;

476 
İtiÚs
.
memÜy
.
u£_dpdk
 = 1;

477 *
cÜe
;

478 
cÜe
 = 
İtiÚs
.
udd
.
cÜe_mask_¡r
;

479 *
cÜe
 = '0';

480 
cÜe
 = 
İtiÚs
.
udd
.
cq_th»ad_mask
;

481 *
cÜe
 = '0';

482 
İtiÚs
.
udd
.
mem_size_mb
 = 1024;

483 
İtiÚs
.
udd
.
syncio
 = 1;

484 
ıu_£t_t
 
ıu£t
;

485 
	`CPU_ZERO
(&
ıu£t
);

486 
	`CPU_SET
(0, &
ıu£t
);

487 
	`sched_£ffš™y
(0, (
ıu_£t_t
), &
ıu£t
);

490 
u£_udd
 = 0;

491 
İtiÚs
.
memÜy
.
u£_dpdk
 = 0;

495 
	`kvs_š™_’v
(&
İtiÚs
);

497 
kvs_deviû_hªdË
 
dev
;

498 
»t
 = 
	`kvs_İ’_deviû
(
dev_·th
, &
dev
);

499 if(
»t
 !ğ
KVS_SUCCESS
) {

500 
	`årštf
(
¡d”r
, "Device open failed\n");

501 
	`ex™
(1);

504 
kvs_cÚš”_cÚ‹xt
 
ùx
;

505 
	`kvs_ü—‹_cÚš”
(
dev
, "‹¡", 4, &
ùx
);

507 
kvs_cÚš”_hªdË
 
cÚt_hªdË
;

508 
	`kvs_İ’_cÚš”
(
dev
, "‹¡", &
cÚt_hªdË
);

510 
th»ad_¬gs
 
¬gs
[
t
];

511 
±h»ad_t
 
tid
[
t
];

513 
time¥ec
 
t1
, 
t2
;

514 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

516 
i
 = 0; i < 
t
; i++){

517 
¬gs
[
i
].
id
 = i;

518 
¬gs
[
i
].
kËn
 = klen;

519 
¬gs
[
i
].
vËn
 = vlen;

520 
¬gs
[
i
].
couÁ
 = 
num_ios
;

521 
¬gs
[
i
].
cÚt_hd
 = 
cÚt_hªdË
;

522 
¬gs
[
i
].
İ_ty³
 = op_type;

523 
±h»ad_©Œ_t
 *
©Œ
 = (±h»ad_©Œ_ˆ*)
	`m®loc
((pthread_attr_t));

524 
ıu_£t_t
 
ıus
;

525 
	`±h»ad_©Œ_š™
(
©Œ
);

526 
	`CPU_ZERO
(&
ıus
);

527 
	`CPU_SET
(0, &
ıus
);

528 
	`±h»ad_©Œ_£ffš™y_Å
(
©Œ
, (
ıu_£t_t
), &
ıus
);

530 
»t
 = 
	`±h»ad_ü—‹
(&
tid
[
i
], 
©Œ
, 
iÙh»ad
, &
¬gs
[i]);

531 ià(
»t
 !ğ0è{ 
	`årštf
(
¡d”r
, "th»adƒx™\n"); 
	`ex™
(1); }

532 
	`±h»ad_©Œ_de¡roy
(
©Œ
);

533 
	`ä“
(
©Œ
);

536 
i
 = 0; i < 
t
; i++) {

537 
	`±h»ad_još
(
tid
[
i
], 0);

540 if(
İ_ty³
 !ğ
ITERATOR_OP
) {

541 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

542 
¡¬t
, 
’d
;

543 
¡¬t
 = 
t1
.
tv_£c
 * 1000000000L +1.
tv_n£c
;

544 
’d
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
;

545 
£c
 = ()(
’d
 - 
¡¬t
) / 1000000000L;

546 
	`årštf
(
¡dout
, "TÙ®im%.2à£c; Throughpuˆ%.2àİs/£c\n", 
£c
, (è
num_ios
 * 
t
 /sec );

548 
	`kvs_şo£_cÚš”
(
cÚt_hªdË
);

549 
	`kvs_d–‘e_cÚš”
(
dev
, "test");

550 
	`kvs_ex™_’v
();

553 
	}
}

	@PDK/core/src/api/include/private/kvemul.hpp

35 #iâdeà
KVS_EMUL_HPP_


36 
	#KVS_EMUL_HPP_


	)

38 
	~"´iv©e_ty³s.h
"

39 
	~<s¡»am
>

40 
	~<li¡
>

41 
	~<m­
>

42 
	~<mu‹x
>

43 
	~<®gÜ™hm
>

44 
	~<queue
>

45 
	~<©omic
>

46 
	~<kvs_adi.h
>

48 şas 
	cKvEmuÏtÜ
: 
public
 
KvsDriv”


51 
kv_deviû_hªdË
 
devH
;

52 
kv_Çme¥aû_hªdË
 
	mnsH
 ;

53 
kv_queue_hªdË
 
	msqH
 ;

54 
kv_queue_hªdË
 
	mcqH
 ;

55 
	mqueued•th
;

57 
	mpublic
:

60 
kvs_ÿÎback_cÚ‹xt
 
iocb
;

61 
kvs_ÿÎback_funùiÚ
 
	mÚ_com¶‘e
;

62 
kv_key
 *
	mkey
;

63 
kv_v®ue
 *
	mv®ue
;

64 
KvEmuÏtÜ
* 
	mowÃr
;

65 
	m¡d
::
mu‹x
 
lock_sync
;

66 
	m¡d
::
©omic
<> 
dÚe_sync
;

67 
	m¡d
::
cÚd™iÚ_v¬ŸbË
 
dÚe_cÚd_sync
;

68 
boŞ
 
	msyncio
;

69 } 
	tkv_emul_cÚ‹xt
;

71 
kv_š‹¼u±_hªdËr
 
	gšt_hªdËr
;

72 
	g¡d
::
mu‹x
 
lock
;

73 
	g¡d
::
queue
<
kv_key
*> 
kv_key_poŞ
;

74 
	g¡d
::
queue
<
kv_v®ue
*> 
kv_v®ue_poŞ
;

75 
	g¡d
::
queue
<
kv_emul_cÚ‹xt
*> 
kv_ùx_poŞ
;

77 
	gpublic
:

78 
KvEmuÏtÜ
(
kv_deviû_´iv
 *
dev
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
);

79 
	gvœtu®
 ~
KvEmuÏtÜ
();

80 
vœtu®
 
št32_t
 
	$š™
(cÚ¡ *
dev·th
, cÚ¡ * 
cÚfigfe
, 
queued•th
, 
is_pŞlšg
è
ov”ride
;

81 
vœtu®
 
št32_t
 
	$´oûss_com¶‘iÚs
(
max
è
ov”ride
;

82 
vœtu®
 
št32_t
 
	$¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

83 
vœtu®
 
št32_t
 
	$»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

84 
vœtu®
 
št32_t
 
	$d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

85 
vœtu®
 
št32_t
 
	$exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

86 
vœtu®
 
št32_t
 
	$İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
, 
ušt32_t
 
b™mask
, ušt32_ˆ
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
è
ov”ride
;

87 
vœtu®
 
št32_t
 
	$™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

88 
vœtu®
 
št32_t
 
	$şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
è
ov”ride
;

89 
vœtu®
 
št32_t
 
	$şo£_™”©Ü_®l
(
cÚtid
è
ov”ride
;

90 
vœtu®
 
št32_t
 
	$li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
è
ov”ride
;

91 
vœtu®
 
	$g‘_waf
(è
ov”ride
;

92 
vœtu®
 
št32_t
 
	$g‘_u£d_size
(
št32_t
 *
dev_ut
)
ov”ride
;

93 
vœtu®
 
št32_t
 
	$g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
è
ov”ride
;

94 
vœtu®
 
št32_t
 
	$g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
è
ov”ride
;

96 
´iv©e
:

97 
	`ü—‹_queue
(
qd•th
, 
ušt16_t
 
qty³
, 
kv_queue_hªdË
 *
hªdË
, 
cqid
, 
is_pŞlšg
);

98 
kv_emul_cÚ‹xt
* 
	`´•_io_cÚ‹xt
(
İcode
, 
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

99 
boŞ
 
i¥”si¡
;

100 
¡d
::
¡ršg
 
d©­©h
;

101 
	}
};

	@PDK/core/src/api/include/private/kvkdd.hpp

35 #iâdeà
KVS_KDD_HPP_


36 
	#KVS_KDD_HPP_


	)

38 
	~"´iv©e_ty³s.h
"

39 
	~<s¡»am
>

40 
	~<li¡
>

41 
	~<m­
>

42 
	~<mu‹x
>

43 
	~<©omic
>

44 
	~<®gÜ™hm
>

45 
	~<queue
>

46 
	~<kvs_adi.h
>

47 
	~<kadi.h
>

49 
şass
 
	gKDDriv”
;

52 şas 
	cKDDriv”
: 
public
 
KvsDriv”


55 
kv_deviû_hªdË
 
devH
;

56 
kv_Çme¥aû_hªdË
 
	mnsH
 ;

57 
kv_queue_hªdË
 
	msqH
 ;

58 
kv_queue_hªdË
 
	mcqH
 ;

59 
	mqueued•th
;

62 
	mpublic
:

65 
KDDriv”
* 
owÃr
;

67 
kvs_ÿÎback_cÚ‹xt
 
	miocb
;

68 
kvs_ÿÎback_funùiÚ
 
	mÚ_com¶‘e
;

70 
	m¡d
::
mu‹x
 
lock_sync
;

71 
	m¡d
::
cÚd™iÚ_v¬ŸbË
 
dÚe_cÚd_sync
;

73 
boŞ
 
	mdÚe
;

74 
boŞ
 
	msyncio
;

75 } 
	tkv_kdd_cÚ‹xt
;

77 
kv_š‹¼u±_hªdËr
 
	gšt_hªdËr
;

78 
	g¡d
::
mu‹x
 
lock
;

80 
	gpublic
:

81 
KDDriv”
(
kv_deviû_´iv
 *
dev
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
);

82 
	gvœtu®
 ~
KDDriv”
();

83 
vœtu®
 
št32_t
 
	$š™
(cÚ¡ *
dev·th
, cÚ¡ * 
cÚfigfe
, 
queued•th
, 
is_pŞlšg
è
ov”ride
;

84 
vœtu®
 
št32_t
 
	$´oûss_com¶‘iÚs
(
max
è
ov”ride
;

85 
vœtu®
 
št32_t
 
	$¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

86 
vœtu®
 
št32_t
 
	$»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

87 
vœtu®
 
št32_t
 
	$d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

88 
vœtu®
 
št32_t
 
	$exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

89 
vœtu®
 
št32_t
 
	$İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
, 
ušt32_t
 
b™mask
, ušt32_ˆ
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
è
ov”ride
;

90 
vœtu®
 
št32_t
 
	`şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
);

91 
vœtu®
 
št32_t
 
	`şo£_™”©Ü_®l
(
cÚtid
);

92 
vœtu®
 
št32_t
 
	`li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
);

93 
vœtu®
 
št32_t
 
	`™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULL);

94 
vœtu®
 
	$g‘_waf
(è
ov”ride
;

95 
vœtu®
 
št32_t
 
	$g‘_u£d_size
(
št32_t
 *
dev_ut
è
ov”ride
;

96 
vœtu®
 
št32_t
 
	$g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
è
ov”ride
;

97 
vœtu®
 
št32_t
 
	$g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
è
ov”ride
;

98 
	`_kv_ÿÎback_th»ad
();

99 
´iv©e
:

101 
	`wa™_fÜ_io
(
kv_kdd_cÚ‹xt
 *
ùx
);

102 
	`ü—‹_queue
(
qd•th
, 
ušt16_t
 
qty³
, 
kv_queue_hªdË
 *
hªdË
, 
cqid
, 
is_pŞlšg
);

103 
kv_kdd_cÚ‹xt
* 
	`´•_io_cÚ‹xt
(
İcode
, 
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

104 
	`check_İ’ed_™”©Üs
(
ušt32_t
 
b™mask
,ušt32_ˆ
b™_·‰”n
);

105 
boŞ
 
i¥”si¡
;

106 
¡d
::
¡ršg
 
d©­©h
;

107 
	}
};

	@PDK/core/src/api/include/private/kvs_utils.h

35 #iâdeà
INCLUDE_KVS_UTILS_H_


36 
	#INCLUDE_KVS_UTILS_H_


	)

38 
	~<®gÜ™hm
>

39 
	~<¡dio.h
>

40 
	~<kvs_­i.h
>

41 
	~<¡d¬g.h
>

42 
	~<¡dlib.h
>

43 
	~<io¡»am
>

44 
	~<s¡»am
>

45 
	~<f¡»am
>

46 
	~<mu‹x
>

47 
	~<dœ’t.h
>

48 
	~<uni¡d.h
>

49 
	~<numa.h
>

51 
šlše
 
	$y´štf
(
¡d
::
o¡»am
 &
¡»am
, cÚ¡ * 
fmt
, ...)

53 
bufãr
[1024] = "";

55 
va_li¡
 
¬g±r
;

56 
wr™‹n
 = 0;

57 
	`va_¡¬t
(
¬g±r
,
fmt
);

60 
wr™‹n
 = 
	`v¥rštf
(
bufãr
, 
fmt
, 
¬g±r
);

63 
	`va_’d
(
¬g±r
);

64 
bufãr
[
wr™‹n
] = '\0';

65 
¡»am
 << 
bufãr
;

66 
	}
}

68 
šlše
 
	$log´štf
(cÚ¡ * 
fmt
, ...)

70 
¡d
::
mu‹x
 mutex;

71 
¡d
::
of¡»am
 
	`out
("/tmp/libsœius.log", std::
ios
::
out
 | std::ios::
­p
);

73 ià(
out
.
	`is_İ’
()) {

74 
bufãr
[1024] = "";

76 
va_li¡
 
¬g±r
;

77 
wr™‹n
 = 0;

78 
	`va_¡¬t
(
¬g±r
,
fmt
);

80 
wr™‹n
 = 
	`v¥rštf
(
bufãr
, 
fmt
, 
¬g±r
);

82 
	`va_’d
(
¬g±r
);

83 
bufãr
[
wr™‹n
] = '\0';

85 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lck
(mutex);

86 
out
<< "[INFO] ";

87 
out
<< 
bufãr
;

88 
out
.
	`æush
();

91 
	`y´štf
(
¡d
::
cout
, "can't open /tmp/libsirius.log\n");

93 
	}
}

95 
šlše
 
	$wr™e_”r
(cÚ¡ * 
fÜm©
, ... ) {

96 
va_li¡
 
¬gs
;

97 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

98 
	`årštf
(
¡d”r
, "[ERROR] ");

99 
	`vårštf
(
¡d”r
, 
fÜm©
, 
¬gs
);

100 
	`va_’d
(
¬gs
);

101 
	}
}

103 
šlše
 
	$wr™e_w¬n
(
FILE
 * 
out
, cÚ¡ * 
fÜm©
, ... ) {

104 
va_li¡
 
¬gs
;

105 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

106 
	`årštf
(
¡d”r
, "[WARN] ");

107 
	`vårštf
(
¡d”r
, 
fÜm©
, 
¬gs
);

108 
	`va_’d
(
¬gs
);

109 
	}
}

111 
šlše
 
	$wr™e_šfo
(
FILE
 * 
out
, cÚ¡ * 
fÜm©
, ... ) {

112 
va_li¡
 
¬gs
;

113 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

114 
	`årštf
(
¡d”r
, "[INFO] ");

115 
	`vårštf
(
¡d”r
, 
fÜm©
, 
¬gs
);

116 
	`va_’d
(
¬gs
);

117 
	}
}

120 #ifdeà
ENABLE_LOGGING


121 
	#WRITE_ERR
(...èdØ{ 
	`wr™e_”r
(
__VA_ARGS__
); 
	`ex™
(1); } 0)

	)

122 
	#WRITE_WARNING
(...è
	`wr™e_w¬n
(
¡d”r
, 
__VA_ARGS__
)

	)

123 
	#WRITE_INFO
(...è
	`wr™e_šfo
(
¡dout
, 
__VA_ARGS__
)

	)

124 
	#WRITE_LOG
(...è
	`log´štf
(
__VA_ARGS__
)

	)

126 
	#WRITE_ERR
(...èdØ{ 
	`wr™e_”r
(
__VA_ARGS__
); 
	`ex™
(1); } 0)

	)

127 
	#WRITE_WARNING
(...è
	`wr™e_w¬n
(
¡d”r
, 
__VA_ARGS__
)

	)

128 
	#WRITE_INFO
(...è
	`wr™e_šfo
(
¡dout
, 
__VA_ARGS__
)

	)

129 
	#WRITE_LOG
(...)

	)

134 
šlše
 
	$g‘_curıu
(*
ch
, *
cÜe
)

136 
a
,
d
,
c
;

137 
__asm__
 vŞ©e("rdtsı" : "÷" (
a
), "=d" (
d
), "=c" (
c
));

138 *
ch
 = (
c
 & 0xFFF000)>>12;

139 *
cÜe
 = 
c
 & 0xFFF;

140  (()
a
è| ((()
d
) << 32);;

141 
	}
}

163 
šlše
 
	$run_sh–lcmd
(cÚ¡ *
buf
)

165 
¡©us
 = 
	`sy¡em
(
buf
);

166  
	`WEXITSTATUS
(
¡©us
);

167 
	}
}

169 
šlše
 
	g¡d
::
¡ršg
 
	$run_sh–lcmd_w™h_ouut
(cÚ¡ *
cmd
) {

170 
FILE
 *
š
;

171 
¡d
::
¡ršg¡»am
 
ss
;

172 
buff
[512];

173 ià(!(
š
 = 
	`pİ’
(
cmd
, "r"))) {

177 
	`fg‘s
(
buff
, (buff), 
š
è!ğ
NULL
) {

178 
ss
 << 
buff
;

181 
	`pşo£
(
š
);

182  
ss
.
	`¡r
();

183 
	}
}

186 
šlše
 
	g¡d
::
¡ršg
 
	$do_»adlšk
(
¡d
::
¡ršg
 cÚ¡& 
·th
) {

187 
buff
[
PATH_MAX
];

188 
ssize_t
 
Ën
 = ::
	`»adlšk
(
·th
.
	`c_¡r
(), 
buff
, (buff) - 1);

189 ià(
Ën
 != -1) {

190 
buff
[
Ën
] = '\0';

191  
¡d
::
	`¡ršg
(
buff
);

195 
	}
}

201 
šlše
 
boŞ
 
	$is_dœeùÜy_em±y_Ü_nÙexi¡
(cÚ¡ *
·th
) {

202 
DIR
 *
dp
;

203 
i
 = 0;

204 
dœ’t
 *
•
;

205 
dp
 = 
	`İ’dœ
(
·th
);

207 ià(
dp
 !ğ
NULL
) {

208 (
•
 = 
	`»addœ
(
dp
)è!ğ
NULL
) {

209 
i
++;

210 ià(
i
 > 2)

211  
çl£
;

213 (è
	`şo£dœ
(
dp
);

216  
Œue
;

217 
	}
}

220 
šlše
 *
	$numa_®igÃd_®loc
(cÚ¡ 
sock‘id
, 
®ignm’t
, 
ušt64_t
 
size
) {

221 *
ba£
;

222 **
®igÃd
;

223 
ušt64_t
 
tÙ®
 = 
size
 + 
®ignm’t
 - 1 + (*) + (uint64_t);

224 ià(
sock‘id
 != -1)

225 
ba£
 = 
	`numa_®loc_Únode
(
tÙ®
, 
sock‘id
);

227 
ba£
ğ
	`numa_®loc_loÿl
(
tÙ®
);

229 
®igÃd
 = (**)((((
ušt64_t
)
ba£
è+ 
tÙ®
è& ~(
®ignm’t
 - 1));

230 
®igÃd
[-1] = 
ba£
;

231 
®igÃd
[-2] = (*)
tÙ®
;

232  
®igÃd
;

233 
	}
}

235 
šlše
 
	$numa_®igÃd_ä“
(*
p
) {

236 *
±r
 = (((**)
p
)[-1]);

237 
ušt64_t
 
size
 = (ušt64_t)(((**)
p
)[-2]);

238 
	`numa_ä“
(
±r
, 
size
);

239 
	}
}

242 
šlše
 
	$Érim
(
¡d
::
¡ršg
 &
s
) {

243 
s
.
	`”a£
(s.
	`begš
(), 
¡d
::
	`fšd_if
(s.begš(), s.
	`’d
(), [](
ch
) {

244  !
¡d
::
	`is¥aû
(
ch
);

246 
	}
}

249 
šlše
 
	$¹rim
(
¡d
::
¡ršg
 &
s
) {

250 
s
.
	`”a£
(
¡d
::
	`fšd_if
(s.
	`rbegš
(), s.
	`»nd
(), [](
ch
) {

251  !
¡d
::
	`is¥aû
(
ch
);

252 }).
	`ba£
(), 
s
.
	`’d
());

253 
	}
}

256 
šlše
 
	$Œim
(
¡d
::
¡ršg
 &
s
) {

257 
	`Érim
(
s
);

258 
	`¹rim
(
s
);

259 
	}
}

261 
šlše
 
št32_t
 
	$v®id©e_»que¡
(cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
) {

262 ià(
key
) {

263 if(
key
->
Ëngth
 < 
KVS_MIN_KEY_LENGTH
 || key->Ëngth > 
KVS_MAX_KEY_LENGTH
) {

264 
	`WRITE_WARNING
("key sizi ouˆoà¿nge, key sizğ%d\n", 
key
->
Ëngth
);

265  
KVS_ERR_KEY_LENGTH_INVALID
;

268 if(
v®ue
) {

269 if(
v®ue
->
Ëngth
 < 
KVS_MIN_VALUE_LENGTH
 || v®ue->Ëngth > 
KVS_MAX_VALUE_LENGTH
) {

270 
	`WRITE_WARNING
("v®usizi ouˆoà¿nge, v®usizğ%d\n", 
v®ue
->
Ëngth
);

271  
KVS_ERR_VALUE_LENGTH_INVALID
;

275 
	}
}

	@PDK/core/src/api/include/private/private_types.h

36 #iâdeà
INCLUDE_PRIVATE_PRIVATE_TYPES_H_


37 
	#INCLUDE_PRIVATE_PRIVATE_TYPES_H_


	)

39 
	~<c¡ddef
>

40 
	~<c¡dšt
>

41 
	~<¡ršg
>

42 
	~<mu‹x
>

43 
	~<li¡
>

44 
	~<cÚd™iÚ_v¬ŸbË
>

45 
	~"kvs_­i.h
"

47 #iâdeà
WITH_SPDK


48 
	~"kvs_adi.h
"

51 #ifdeà
__ılu¥lus


56 şas 
	ckv_deviû_´iv
 {

57 
public
:

58 
kv_deviû_´iv
() {

59 
nsid
 = 0;

60 
numªode
 = 0;

61 
iskv
 = 0;

62 
v’dÜid
 = 0;

63 
deviûid
 = 0;

64 
isİ’ed
 = 
çl£
;

65 
i§‰ached
 = 
çl£
;

66 
is¥dkdev
 = 
çl£
;

67 
i£mul
 = 
çl£
;

68 
num_İ’ed_q·œs
 = 0;

71 ~
kv_deviû_´iv
();

72 
node
[1024];

73 
¥dk·th
[1024];

74 
nsid
;

75 
Œid
[1024];

76 
pci_¦Ù_Çme
[1024];

77 
numªode
;

78 
iskv
;

79 
v’dÜid
;

80 
deviûid
;

81 
v’_dev_id
[128];

82 
boŞ
 
isİ’ed
;

83 
boŞ
 
i§‰ached
;

84 
boŞ
 
is¥dkdev
;

85 
boŞ
 
i£mul
;

86 
boŞ
 
isk”Ãldev
;

87 
num_İ’ed_q·œs
;

94 şas 
	cKvsDriv”
 {

95 
public
:

96 
kv_deviû_´iv
 *
dev
;

97 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e
;

98 
¡d
::
li¡
<
kvs_cÚš”
*> 
li¡_cÚš”s
;

99 
¡d
::
li¡
<
kvs_cÚš”_hªdË
> 
İ’_cÚš”s
;

101 
public
:

102 
KvsDriv”
(
kv_deviû_´iv
 *
dev_
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
):

103 
dev
(
dev_
), 
u£r_io_com¶‘e
(
u£r_io_com¶‘e_
) {}

105 
vœtu®
 ~
KvsDriv”
() {}

107 
boŞ
 
lßd_d©a
(cÚ¡ *
·th
);

108 
boŞ
 
£t_dumµ©h
(cÚ¡ *
·th
);

115 
št32_t
 
İ’
(cÚ¡ *
dev_·th
 = 0, 
¡d
::
¡ršg
 
dumµ©h
 = "auto", 
dumpšdex
 = 0);

116 
št32_t
 
şo£
();

118 
št32_t
 
ex™_’v
();

120 * 
İ”©Ü
 
Ãw
(
¡d
::
size_t
 
sz
);

121 
İ”©Ü
 
d–‘e
(* 
p
);

122 
public
:

123 
vœtu®
 
št32_t
 
š™
();

124 
vœtu®
 
št32_t
 
š™
(
sock‘
) {  0; }

125 
vœtu®
 
št32_t
 
š™
(cÚ¡ * 
dev·th
, cÚ¡ * 
cÚfigfe
, 
queued•th
, 
is_pŞlšg
) { 0;}

126 
vœtu®
 
št32_t
 
š™
(cÚ¡ * 
dev·th
, 
boŞ
 
syncio
, 
ušt64_t
 
sq_cÜe
, ušt64_ˆ
cq_cÜe
, 
ušt32_t
 
mem_size_mb
, 
queue_d•th
) { 0;}

127 
vœtu®
 
št32_t
 
š™
(cÚ¡ * 
dev·th
, 
boŞ
 
syncio
) { 0;}

128 
vœtu®
 
št32_t
 
´oûss_com¶‘iÚs
(
max
) =0;

129 
vœtu®
 
št32_t
 
¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULL) = 0;

130 
vœtu®
 
št32_t
 
»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULL) = 0;

131 
vœtu®
 
št32_t
 
d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULL) = 0;

132 
vœtu®
 
št32_t
 
exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULL) = 0;

133 
vœtu®
 
št32_t
 
İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
, 
ušt32_t
 
b™mask
, ušt32_ˆ
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
) = 0;

134 
vœtu®
 
št32_t
 
şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
) = 0;

135 
vœtu®
 
št32_t
 
şo£_™”©Ü_®l
(
cÚtid
) = 0;

136 
vœtu®
 
št32_t
 
li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
) = 0;

137 
vœtu®
 
št32_t
 
™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULL) = 0;

138 
vœtu®
 
g‘_waf
() { 0.0;}

139 
vœtu®
 
št32_t
 
g‘_u£d_size
(št32_ˆ*
dev_ut
) { 0;}

140 
vœtu®
 
št32_t
 
g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
) { 0;}

141 
vœtu®
 
št32_t
 
g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
) { 0;}

142 
¡d
::
¡ršg
 
·th
;

145 
	s_kvs_deviû_hªdË
 {

146 
kv_deviû_´iv
 * 
dev
;

147 
KvsDriv”
* 
driv”
;

150 
	s_kvs_cÚš”_hªdË
 {

151 
ušt8_t
 
cÚš”_id
;

152 
kvs_deviû_hªdË
 
dev
;

153 
Çme
[256];

156 
	s_kvs_™”©Ü_hªdË
{

162 
ušt32_t
 
™”©Ü
;

166 şas 
	cCÚšHªdË
 {

167 
public
:

168 
kvs_deviû_hªdË
 
dev
;

169 
cÚš”_Çme
[256];

171 
public
:

172 
CÚšHªdË
(
kvs_deviû_hªdË
 
_dev
):

173 
dev
(
_dev
)

176 ~
CÚšHªdË
();

180 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/private/udd.hpp

36 #iâdeà
KVS_UDD_HPP_


37 
	#KVS_UDD_HPP_


	)

39 #ià
defšed
 
WITH_SPDK


41 
	~"´iv©e_ty³s.h
"

42 
	~<s¡»am
>

43 
	~<li¡
>

44 
	~<m­
>

45 
	~<mu‹x
>

46 
	~<®gÜ™hm
>

47 
	~<queue
>

48 
	~<kv_ty³s.h
>

50 şas 
	cKUDDriv”
: 
public
 
KvsDriv”


52 
ušt64_t
 
hªdË
;

53 
ušt32_t
 
	mqueue_d•th
;

54 
ušt64_t
 
	mcÜe_mask
;

55 
ušt64_t
 
	mnum_cq_th»ads
;

56 
ušt64_t
 
	mcq_th»ad_mask
;

57 
ušt32_t
 
	mmem_size_mb
;

59 
	mŒid
[1024];

61 
	mpublic
:

64 
kvs_ÿÎback_cÚ‹xt
 
iocb
;

65 
KUDDriv”
 *
	mowÃr
;

66 
kvs_ÿÎback_funùiÚ
 
	mÚ_com¶‘e
;

67 
kvs_™”©Ü_li¡
 *
	m™”_li¡
;

68 } 
	tkv_udd_cÚ‹xt
;

70 
	g¡d
::
mu‹x
 
lock
;

71 
	g¡d
::
queue
<
kv_·œ
*> 
kv_·œ_poŞ
;

74 
	gpublic
:

75 
KUDDriv”
(
kv_deviû_´iv
 *
dev
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
);

76 
	gvœtu®
 ~
KUDDriv”
();

77 
vœtu®
 
št32_t
 
	$š™
(cÚ¡ *
dev·th
, 
boŞ
 
syncio
, 
ušt64_t
 
sq_cÜe
, ušt64_ˆ
cq_cÜe
, 
ušt32_t
 
mem_size_mb
, 
queue_d•th
è
ov”ride
;

78 
vœtu®
 
št32_t
 
	$´oûss_com¶‘iÚs
(
max
è
ov”ride
;

79 
vœtu®
 
št32_t
 
	$¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

80 
vœtu®
 
št32_t
 
	$»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

81 
vœtu®
 
št32_t
 
	$d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
 , *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

82 
vœtu®
 
št32_t
 
	$exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

83 
vœtu®
 
št32_t
 
	$İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
, 
ušt32_t
 
b™mask
, ušt32_ˆ
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
è
ov”ride
;

84 
vœtu®
 
št32_t
 
	$şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
è
ov”ride
;

85 
vœtu®
 
št32_t
 
	$şo£_™”©Ü_®l
(
cÚtid
è
ov”ride
;

86 
vœtu®
 
št32_t
 
	$li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
è
ov”ride
;

87 
vœtu®
 
št32_t
 
	$™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
=
NULL
, *
´iv©e2
=NULL, 
boŞ
 
sync
 = 
çl£
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 = NULLè
ov”ride
;

88 
vœtu®
 
	$g‘_waf
(è
ov”ride
;

89 
vœtu®
 
št32_t
 
	$g‘_u£d_size
(
št32_t
 *
dev_ut
è
ov”ride
;

90 
vœtu®
 
št32_t
 
	$g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
è
ov”ride
;

91 
vœtu®
 
št32_t
 
	$g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
è
ov”ride
;

93 
´iv©e
:

95 
boŞ
 
i¥”si¡
;

96 
¡d
::
¡ršg
 
d©­©h
;

98 
kv_udd_cÚ‹xt
* 
	`´•_io_cÚ‹xt
(
İcode
, 
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
);

100 
	}
};

	@PDK/core/src/api/include/private/uddenv.h

36 #iâdeà
INCLUDE_SPDKENV_H_


37 
	#INCLUDE_SPDKENV_H_


	)

39 
	~<m­
>

40 
	~"´iv©e_ty³s.h
"

42 
š™_udd
(
kvs_š™_İtiÚs
 *
İtiÚs
);

43 
_udd_ä“
(* 
buf
);

44 *
_udd_m®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
);

45 *
_udd_z®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
);

	@PDK/core/src/api/include/udd/kv_trace.h

41 #iâdeà
__KVNVME_TRACE_H__


42 
	#__KVNVME_TRACE_H__


	)

44 
	~<sys/time.h
>

46 
	#KVNVME_LOG_ERR
 0x01

	)

47 
	#KVNVME_LOG_WARN
 0x02

	)

48 
	#KVNVME_LOG_INFO
 0x03

	)

49 
	#KVNVME_LOG_DEBUG
 0x04

	)

51 
	#KVNVME_TIMESTART
(
time
) \

53 
timezÚe
 
tz
; \

54 
	`g‘timeofday
(&
time
, &
tz
); \

55 } 0)

	)

57 
	#KVNVME_TIMESTOP
(
time
) \

59 
timezÚe
 
tz
; \

60 
timev®
 
tv
; \

61 
	`g‘timeofday
(&
tv
, &
tz
); \

62 
time
.
tv_£c
 = 
tv
.tv_sec -ime.tv_sec; \

63 
time
.
tv_u£c
 = 
tv
.tv_usec-ime.tv_usec; \

64 ià(
time
.
tv_u£c
 < 0è{ime.
tv_£c
--;ime.tv_usec+=1000000; } \

65 
	`´štf
("[%ld ms]\n", 
time
.
tv_£c
*1000+time.
tv_u£c
/1000); \

66 } 0)

	)

68 
	#KVNVME_TRACE
(
log_Ëv–
, 
fmt
, 
¬gs
...) \

69 ()((
log_Ëv–
 <ğ
KVNVME_LOG_LEVEL
) ? \

70 
	`´štf
("%s:: %d:: %s:: "
fmt
 "\n", 
__FILE__
, 
__LINE__
, 
__FUNCTION__
, ## 
¬gs
) : \

71 0)

	)

74 
	#KVNVME_ERR
(
fmt
, 
¬gs
...) \

76 
	`KVNVME_TRACE
(
KVNVME_LOG_ERR
, 
fmt
, ## 
¬gs
); \

77 } 0)

	)

80 
	#KVNVME_WARN
(
fmt
, 
¬gs
...) \

82 
	`KVNVME_TRACE
(
KVNVME_LOG_WARN
, 
fmt
, ## 
¬gs
); \

83 } 0)

	)

86 
	#KVNVME_INFO
(
fmt
, 
¬gs
...) \

88 
	`KVNVME_TRACE
(
KVNVME_LOG_INFO
, 
fmt
, ## 
¬gs
); \

89 } 0)

	)

92 
	#KVNVME_DEBUG
(
fmt
, 
¬gs
...) \

94 
	`KVNVME_TRACE
(
KVNVME_LOG_DEBUG
, 
fmt
, ## 
¬gs
); \

95 } 0)

	)

97 
	#ENTER
() \

99 
	`KVNVME_DEBUG
("Enter"); \

100 } 0)

	)

102 
	#LEAVE
() \

104 
	`KVNVME_DEBUG
("Leave"); \

105 } 0)

	)

	@PDK/core/src/api/include/udd/kv_types.h

48 #iâdeà
KV_TYPES_C_H


49 
	#KV_TYPES_C_H


	)

51 
	~<¡dšt.h
>

52 
	~<¡dboŞ.h
>

53 
	~<±h»ad.h
>

56 
	#KV_ALIGNMENT_UNIT
 64

	)

57 
	#KV_MIN_VALUE_LEN
 0

	)

58 
	#KV_MAX_IO_VALUE_LEN
 (2048*1024)

59 
	#LBA_MAX_IO_VALUE_LEN
 (2048*1024)

60 
	#KV_MAX_TOTAL_VALUE_LEN
 (2ull*1024*1024*1024)

61 
	#KV_MIN_KEY_LEN
 4

	)

62 
	#KV_MAX_KEY_LEN
 255

	)

63 
	#KV_IT_READ_BUFFER_META_LEN
 4

	)

65 
	#KV_SDK_MAX_ITERATE_READ_LEN
 (32*1024)

66 
	#KV_SDK_MIN_ITERATE_READ_LEN
 (32*1024)

67 

	)

68 
	#KV_SSD_MAX_ITERATE_READ_LEN
 (32*1024)

69 
	#KV_SSD_MIN_ITERATE_READ_LEN
 (32*1024)

70 
	#KV_MAX_ITERATE_HANDLE
 16

71 

	)

72 
	#DEV_ID_LEN
 32

	)

73 
	#NR_MAX_SSD
 64

	)

74 
	#MAX_CPU_CORES
 64

	)

80 
	ekv_sdk_š™_ty³s
 {

81 
	mKV_SDK_INIT_FROM_JSON
 = 0x00,

82 
	mKV_SDK_INIT_FROM_STR
 = 0x01,

88 
	ekv_sdk_ssd_ty³s
 {

89 
	mKV_TYPE_SSD
 = 0x00,

90 
	mLBA_TYPE_SSD
 = 0x01,

96 
	ekv_ÿche_®gÜ™hm
 {

97 
	mCACHE_ALGORITHM_RADIX
 = 0x00,

103 
	ekv_ÿche_»şaim
 {

104 
	mCACHE_RECLAIM_LRU
 = 0x00,

110 
	ekv_¦ab_mm_®loc_pŞicy
 {

111 
	mSLAB_MM_ALLOC_POSIX
 = 0x10,

112 
	mSLAB_MM_ALLOC_HUGE
 =0x20,

118 
	ekv_¡Üe_İtiÚ
 {

119 
	mKV_STORE_DEFAULT
 = 0x00,

120 
	mKV_STORE_COMPRESSION
 = 0x01,

121 
	mKV_STORE_IDEMPOTENT
 = 0x02,

127 
	ekv_»Œ›ve_İtiÚ
 {

128 
	mKV_RETRIEVE_DEFAULT
 = 0x00,

129 
	mKV_RETRIEVE_DECOMPRESSION
 = 0x01,

136 
	ekv_d–‘e_İtiÚ
 {

137 
	mKV_DELETE_DEFAULT
 = 0x00,

138 
	mKV_DELETE_CHECK_IDEMPOTENT
 = 0x01,

144 
	ekv_exi¡_İtiÚ
 {

145 
	mKV_EXIST_DEFAULT
 = 0x00,

151 
	ekv_fÜm©_İtiÚ
 {

152 
	mKV_FORMAT_MAPDATA
 = 0x00,

153 
	mKV_FORMAT_USERDATA
 = 0x01,

159 
	ekv_™”©e_»que¡_İtiÚ
 {

160 
	mKV_ITERATE_REQUEST_DEFAULT
 = 0x00,

161 
	mKV_ITERATE_REQUEST_OPEN
 = 0x01,

162 
	mKV_ITERATE_REQUEST_CLOSE
 = 0x02,

169 
	ekv_™”©e_hªdË_ty³
 {

170 
	mKV_KEY_ITERATE
 = 0x01,

171 
	mKV_KEY_ITERATE_WITH_RETRIEVE
 = 0x02,

172 
	mKV_KEY_ITERATE_WITH_DELETE
 = 0x03,

179 
	ekv_key¥aû_id
 {

180 
	mKV_KEYSPACE_IODATA
 = 0x00,

181 
	mKV_KEYSPACE_METADATA
 = 0x01,

187 
	ekv_™”©e_»ad_İtiÚ
 {

188 
	mKV_ITERATE_READ_DEFAULT
 = 0x00,

194 
	ekv_»suÉ
 {

195 
	mKV_SUCCESS
 = 0,

198 
	mKV_ERR_INVALID_VALUE_SIZE
 = 0x01,

199 
	mKV_ERR_INVALID_VALUE_OFFSET
 = 0x02,

200 
	mKV_ERR_INVALID_KEY_SIZE
 = 0x03,

201 
	mKV_ERR_INVALID_OPTION
 = 0x04,

202 
	mKV_ERR_INVALID_KEYSPACE_ID
 = 0x05,

204 
	mKV_ERR_MISALIGNED_VALUE_SIZE
 = 0x08,

205 
	mKV_ERR_MISALIGNED_VALUE_OFFSET
 = 0x09,

206 
	mKV_ERR_MISALIGNED_KEY_SIZE
 = 0x0A,

208 
	mKV_ERR_NOT_EXIST_KEY
 = 0x10,

209 
	mKV_ERR_UNRECOVERED_ERROR
 = 0x11,

210 
	mKV_ERR_CAPACITY_EXCEEDED
 = 0x12,

212 
	mKV_ERR_IDEMPOTENT_STORE_FAIL
 = 0x80,

213 
	mKV_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
 = 0x81,

215 
	mKV_ERR_ITERATE_FAIL_TO_PROCESS_REQUEST
 = 0x90,

216 
	mKV_ERR_ITERATE_NO_AVAILABLE_HANDLE
 = 0x91,

217 
	mKV_ERR_ITERATE_HANDLE_ALREADY_OPENED
 = 0x92,

218 
	mKV_ERR_ITERATE_READ_EOF
 = 0x93,

219 
	mKV_ERR_ITERATE_REQUEST_FAIL
 = 0x94,

220 
	mKV_ERR_ITERATE_TCG_LOCKED
 = 0x95,

221 
	mKV_ERR_ITERATE_ERROR
 = 0x96,

224 
	mKV_ERR_DD_NO_DEVICE
 = 0x100,

225 
	mKV_ERR_DD_INVALID_PARAM
 = 0x101,

226 
	mKV_ERR_DD_INVALID_QUEUE_TYPE
 = 0x102,

227 
	mKV_ERR_DD_NO_AVAILABLE_RESOURCE
 = 0x103,

228 
	mKV_ERR_DD_NO_AVAILABLE_QUEUE
 = 0x104,

229 
	mKV_ERR_DD_UNSUPPORTED_CMD
 = 0x105,

232 
	mKV_ERR_SDK_OPEN
 = 0x200,

233 
	mKV_ERR_SDK_CLOSE
 = 0x201,

234 
	mKV_ERR_CACHE_NO_CACHED_KEY
 = 0x202,

235 
	mKV_ERR_CACHE_INVALID_PARAM
 = 0x203,

236 
	mKV_ERR_HEAP_ALLOC_FAILURE
 = 0x204,

237 
	mKV_ERR_SLAB_ALLOC_FAILURE
 = 0x205,

238 
	mKV_ERR_SDK_INVALID_PARAM
 = 0x206,

241 
	mKV_WRN_MORE
 = 0x300,

242 
	mKV_ERR_BUFFER
 = 0x301,

243 
	mKV_ERR_DECOMPRESSION
 = 0x302,

244 
	mKV_ERR_IO
 = 0x303,

246 
	#KV_ERR_INVALID_VALUE
 (
UINT64_MAX
è

	)

247 
	#KV_INVALID_ITERATE_HANDLE
 (0è

	)

256 
ušt64_t
 
	mcÜe_mask
;

258 
ušt64_t
 
	msync_mask
;

260 
ušt64_t
 
	mnum_cq_th»ads
;

262 
ušt64_t
 
	mcq_th»ad_mask
;

264 
ušt32_t
 
	mqueue_d•th
;

266 
ušt32_t
 
	mmem_size_mb
;

267 } 
	tkv_nvme_io_İtiÚs
;

273 
boŞ
 
	mu£_ÿche
;

274 
	mÿche_®gÜ™hm
;

275 
	mÿche_»şaim_pŞicy
;

276 
ušt64_t
 
	m¦ab_size
;

277 
	m¦ab_®loc_pŞicy
;

278 
	mssd_ty³
;

279 
	msubm™_»Œy_š‹rv®
;

283 
	mÄ_ssd
;

284 
	mdev_id
[
NR_MAX_SSD
][
DEV_ID_LEN
];

285 
kv_nvme_io_İtiÚs
 
	mdd_İtiÚs
[
NR_MAX_SSD
];

286 
ušt64_t
 
	mdev_hªdË
[
NR_MAX_SSD
];

288 
	mlog_Ëv–
;

289 
	mlog_fe
[1024];

290 
±h»ad_mu‹x_t
 
	mcb_út_mu‹x
;

292 
ušt64_t
 
	m­p_hugemem_size
;

293 }
	tkv_sdk
;

299 *
	mkey
;

300 
ušt16_t
 
	mËngth
;

301 } 
	tkv_key
;

307 *
	mv®ue
;

308 
ušt32_t
 
	mËngth
;

309 
ušt32_t
 
	maùu®_v®ue_size
;

310 
ušt32_t
 
	moff£t
;

311 } 
	tkv_v®ue
;

317 (*
	masync_cb
)();

318 * 
	m´iv©e_d©a
;

320 
	m¡Üe_İtiÚ
;

321 
	m»Œ›ve_İtiÚ
;

322 
	md–‘e_İtiÚ
;

323 
	m™”©e_»que¡_İtiÚ
;

324 
	m™”©e_»ad_İtiÚ
;

325 
	mexi¡_İtiÚ
;

326 }
	mio_İtiÚ
;

327 } 
	tkv_·¿m
;

334 
ušt8_t
 
	mkey¥aû_id
;

335 
kv_key
 
	mkey
;

336 
kv_v®ue
 
	mv®ue
;

337 
kv_·¿m
 
	m·¿m
;

338 } 
	tkv_·œ
;

345 
ušt32_t
 
	m™”©Ü
;

346 
kv_·œ
 
	mkv
;

347 } 
	tkv_™”©e
;

349 
	ekv_sdk_™”©e_¡©us
 {

350 
	mITERATE_HANDLE_OPENED
 = 0x01,

351 
	mITERATE_HANDLE_CLOSED
 = 0x00,

355 
ušt8_t
 
	mhªdË_id
;

356 
ušt8_t
 
	m¡©us
;

357 
ušt8_t
 
	mty³
;

358 
ušt8_t
 
	mkey¥aû_id
;

359 
ušt32_t
 
	m´efix
;

360 
ušt32_t
 
	mb™mask
;

361 
ušt8_t
 
	mis_eof
;

362 
ušt8_t
 
	m»£rved
[3];

363 } 
	tkv_™”©e_hªdË_šfo
;

	@PDK/core/src/api/include/udd/kvnvme.h

34 #iâdeà
_KVNVME_H_


35 
	#_KVNVME_H_


	)

37 
	~<”ºo.h
>

38 
	~<¡ršg.h
>

39 
	~<¡dšt.h
>

40 
	~<¡dlib.h
>

41 
	~<g‘İt.h
>

42 
	~<uni¡d.h
>

43 
	~<±h»ad.h
>

44 
	~<sched.h
>

45 
	~<sys/mmª.h
>

46 
	~<sys/¡©.h
>

47 
	~<sys/queue.h
>

48 
	~<fú.h
>

49 
	~"kv_ty³s.h
"

50 
	~"¥dk/’v.h
"

52 
	#SYNC_IO_QUEUE
 1

	)

53 
	#ASYNC_IO_QUEUE
 2

	)

55 
	#KV_SHM_ID
 0x1234

	)

56 
	#KV_MEM_SIZE
 8192

	)

58 
	#DEFAULT_IO_QUEUE_DEPTH
 256

	)

59 
	#DEFAULT_IO_QUEUE_ID
 (-1)

	)

61 #ifdeà
__ılu¥lus


65 (*
kv_cb_â_t
)(cÚ¡ 
	tkv_·œ
 *
	tkv
, 
	t»suÉ
, 
	t¡©us
);

66 (*
kv_«r_cb_â_t
)(*
	t«r_cb_¬g
, 
	t»suÉ
, 
	t¡©us
);

68 
	e¿w_cmd_ty³
 {

69 
ADMIN_CMD_TYPE
,

71 
IO_CMD_TYPE
,

72 } 
	t¿w_cmd_ty³_t
;

74 
	skv_nvme_cmd
 {

76 
ušt16_t
 
İc
 : 8;

77 
ušt16_t
 
fu£
 : 2;

78 
ušt16_t
 
rsvd1
 : 4;

79 
ušt16_t
 
psdt
 : 2;

80 
ušt16_t
 
cid
;

83 
ušt32_t
 
nsid
;

86 
ušt32_t
 
rsvd2
;

87 
ušt32_t
 
rsvd3
;

90 
ušt64_t
 
m±r
;

93 
ušt64_t
 
´p1
;

94 
ušt64_t
 
´p2
;

97 
ušt32_t
 
cdw10
;

98 
ušt32_t
 
cdw11
;

99 
ušt32_t
 
cdw12
;

100 
ušt32_t
 
cdw13
;

101 
ušt32_t
 
cdw14
;

102 
ušt32_t
 
cdw15
;

103 } 
	tkv_nvme_cmd_t
;

105 
	skv_nvme_ıl
 {

107 
ušt32_t
 
»suÉ
;

109 
ušt32_t
 
¡©us
;

110 } 
	tkv_nvme_ıl_t
;

115 
kv_’v_š™
(
ušt32_t
 
´oûss_mem_size_mb
);

116 
kv_’v_š™_w™h_¥dk_İts
(
¥dk_’v_İts
* 
İts
);

126 
kv_nvme_š™
(cÚ¡ *
bdf
, 
kv_nvme_io_İtiÚs
 *
İtiÚs
, 
ssd_ty³
);

135 
kv_nvme_is_dd_š™Ÿlized
();

143 
ušt64_t
 
kv_nvme_İ’
(cÚ¡ *
bdf
);

149 
ušt64_t
 
kv_nvme_g‘_waf
(ušt64_ˆ
hªdË
);

158 
kv_nvme_g‘_log_·ge
(
ušt64_t
 
hªdË
, 
ušt8_t
 
log_id
, * 
bufãr
, 
ušt32_t
 
bufãr_size
);

168 
kv_nvme_io_queue_ty³
(
ušt64_t
 
hªdË
, 
cÜe_id
);

174 
ušt16_t
 
kv_nvme_g‘_io_queue_size
(
ušt64_t
 
hªdË
);

180 
ušt32_t
 
kv_nvme_g‘_£ùÜ_size
(
ušt64_t
 
hªdË
);

186 
ušt64_t
 
kv_nvme_g‘_num_£ùÜs
(ušt64_ˆ
hªdË
);

192 
ušt16_t
 
kv_nvme_g‘_cu¼’t_qd
(
ušt64_t
 
hªdË
, 
cÜe_id
);

198 
ušt16_t
 
kv_nvme_šü—£_cu¼’t_qd
(
ušt64_t
 
hªdË
, 
cÜe_id
);

204 
ušt16_t
 
kv_nvme_deü—£_cu¼’t_qd
(
ušt64_t
 
hªdË
, 
cÜe_id
);

214 
kv_nvme_»gi¡”_«r_ÿÎback
(
ušt64_t
 
hªdË
, 
kv_«r_cb_â_t
 
«r_cb_â
, *
«r_cb_¬g
);

225 
kv_nvme_ıl_t
 *
kv_nvme_subm™_¿w_cmd
(
ušt64_t
 
hªdË
, 
kv_nvme_cmd_t
 
cmd
, *
buf
, 
ušt32_t
 
buf_Ën
, 
¿w_cmd_ty³_t
 
ty³
);

235 
kv_nvme_wr™e
(
ušt64_t
 
hªdË
, 
qid
, 
kv_·œ
* 
kv
);

245 
kv_nvme_­³nd
(
ušt64_t
 
hªdË
, 
qid
, 
kv_·œ
* 
kv
);

255 
kv_nvme_wr™e_async
(
ušt64_t
 
hªdË
, 
qid
, 
kv_·œ
* 
kv
);

265 
kv_nvme_»ad
(
ušt64_t
 
hªdË
, 
qid
, 
kv_·œ
* 
·œ
);

275 
kv_nvme_»ad_async
(
ušt64_t
 
hªdË
, 
qid
, 
kv_·œ
* 
·œ
);

285 
kv_nvme_d–‘e
(
ušt64_t
 
hªdË
, 
qid
, cÚ¡ 
kv_·œ
 *
key
);

295 
kv_nvme_d–‘e_async
(
ušt64_t
 
hªdË
, 
qid
, cÚ¡ 
kv_·œ
 *
key
);

306 
kv_nvme_exi¡
(
ušt64_t
 
hªdË
, 
qid
, cÚ¡ 
kv_·œ
 *kv_pair);

317 
kv_nvme_exi¡_async
(
ušt64_t
 
hªdË
, 
qid
, cÚ¡ 
kv_·œ
 *kv_pair);

330 
ušt32_t
 
kv_nvme_™”©e_İ’
(
ušt64_t
 
hªdË
, cÚ¡ 
ušt8_t
 
key¥aû_id
, cÚ¡ ušt32_ˆ
b™mask
, cÚ¡ ušt32_ˆ
´efix
, cÚ¡ ušt8_ˆ
™”©e_ty³
);

340 
kv_nvme_™”©e_şo£
(
ušt64_t
 
hªdË
, cÚ¡ 
ušt8_t
 
™”©Ü
);

350 
kv_nvme_™”©e_»ad
(
ušt64_t
 
hªdË
, 
qid
, 
kv_™”©e
* 
™
);

360 
kv_nvme_™”©e_»ad_async
(
ušt64_t
 
hªdË
, 
qid
, 
kv_™”©e
* 
™
);

370 
kv_nvme_™”©e_šfo
(
ušt64_t
 
hªdË
, 
kv_™”©e_hªdË_šfo
* 
šfo
, 
Ä_hªdË
);

380 
kv_nvme_fÜm©
(
ušt64_t
 
hªdË
, 
”a£_u£r_d©a
);

388 
ušt64_t
 
kv_nvme_g‘_tÙ®_size
(ušt64_ˆ
hªdË
);

396 
ušt64_t
 
kv_nvme_g‘_u£d_size
(ušt64_ˆ
hªdË
);

404 
kv_nvme_şo£
(
ušt64_t
 
hªdË
);

412 
kv_nvme_fš®ize
(*
bdf
);

419 *
kv_®loc
(
size
);

426 *
kv_z®loc
(
size
);

434 *
kv_z®loc_sock‘
(
size
, 
sock‘_id
);

440 
kv_ä“
(*
±r
);

445 
kv_nvme_sdk_šfo
();

450 
kv_nvme_´oûss_com¶‘iÚ
(
ušt64_t
 
hªdË
);

455 
kv_nvme_´oûss_com¶‘iÚ_queue
(
ušt64_t
 
hªdË
, 
ušt32_t
 
queue_id
);

457 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/assert.h

38 #iâdeà
SPDK_ASSERT_H


39 
	#SPDK_ASSERT_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 #ifdeà
¡©ic_as£¹


48 
	#SPDK_STATIC_ASSERT
(
cÚd
, 
msg
è
	`¡©ic_as£¹
(cÚd, msg)

	)

58 
	#SPDK_STATIC_ASSERT
(
cÚd
, 
msg
)

	)

61 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/barrier.h

38 #iâdeà
SPDK_BARRIER_H


39 
	#SPDK_BARRIER_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


48 
	#¥dk_comp”_b¬r›r
(è
__asm
 vŞ©e("" ::: "memÜy")

	)

51 
	#¥dk_wmb
(è
__asm
 vŞ©e("sãnû" ::: "memÜy")

	)

54 
	#¥dk_mb
(è
__asm
 vŞ©e("mãnû" ::: "memÜy")

	)

56 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/bdev.h

39 #iâdeà
SPDK_BDEV_H_


40 
	#SPDK_BDEV_H_


	)

42 
	~"¥dk/¡dšc.h
"

44 
	~"¥dk/ev’t.h
"

45 
	~"¥dk/scsi_¥ec.h
"

47 
	#SPDK_BDEV_SMALL_BUF_MAX_SIZE
 8192

	)

48 
	#SPDK_BDEV_LARGE_BUF_MAX_SIZE
 (64 * 1024)

	)

50 (*
	t¥dk_bdev_»move_cb_t
)(*
	t»move_ùx
);

57 
¥dk_bdev_io
;

59 
¥dk_bdev_â_bË
;

60 
¥dk_io_chªÃl
;

61 
¥dk_jsÚ_wr™e_ùx
;

64 
	e¥dk_bdev_¡©us
 {

65 
SPDK_BDEV_STATUS_INVALID
,

66 
SPDK_BDEV_STATUS_UNCLAIMED
,

67 
SPDK_BDEV_STATUS_CLAIMED
,

68 
SPDK_BDEV_STATUS_REMOVING
,

76 
¥dk_bdev
;

79 
	e¥dk_bdev_io_ty³
 {

80 
SPDK_BDEV_IO_TYPE_READ
 = 1,

81 
SPDK_BDEV_IO_TYPE_WRITE
,

82 
SPDK_BDEV_IO_TYPE_UNMAP
,

83 
SPDK_BDEV_IO_TYPE_FLUSH
,

84 
SPDK_BDEV_IO_TYPE_RESET
,

88 
	e¥dk_bdev_io_¡©us
 {

89 
SPDK_BDEV_IO_STATUS_SCSI_ERROR
 = -3,

90 
SPDK_BDEV_IO_STATUS_NVME_ERROR
 = -2,

91 
SPDK_BDEV_IO_STATUS_FAILED
 = -1,

92 
SPDK_BDEV_IO_STATUS_PENDING
 = 0,

93 
SPDK_BDEV_IO_STATUS_SUCCESS
 = 1,

97 
	e¥dk_bdev_»£t_ty³
 {

103 
SPDK_BDEV_RESET_HARD
,

110 
SPDK_BDEV_RESET_SOFT
,

113 (*
	t¥dk_bdev_io_com¶‘iÚ_cb
)(
	t¥dk_bdev_io
 *
	tbdev_io
,

114 
	t¥dk_bdev_io_¡©us
 
	t¡©us
,

115 *
	tcb_¬g
);

117 
¥dk_bdev
 *
	`¥dk_bdev_g‘_by_Çme
(cÚ¡ *
bdev_Çme
);

118 
	`¥dk_bdev_uÄegi¡”
(
¥dk_bdev
 *
bdev
);

120 
¥dk_bdev
 *
	`¥dk_bdev_fœ¡
();

121 
¥dk_bdev
 *
	`¥dk_bdev_Ãxt
(¥dk_bdev *
´ev
);

135 
boŞ
 
	`¥dk_bdev_şaim
(
¥dk_bdev
 *
bdev
, 
¥dk_bdev_»move_cb_t
 
»move_cb
, *
»move_ùx
);

145 
	`¥dk_bdev_unşaim
(
¥dk_bdev
 *
bdev
);

147 
boŞ
 
	`¥dk_bdev_io_ty³_suµÜ‹d
(
¥dk_bdev
 *
bdev
, 
¥dk_bdev_io_ty³
 
io_ty³
);

149 
	`¥dk_bdev_dump_cÚfig_jsÚ
(
¥dk_bdev
 *
bdev
, 
¥dk_jsÚ_wr™e_ùx
 *
w
);

157 cÚ¡ *
	`¥dk_bdev_g‘_Çme
(cÚ¡ 
¥dk_bdev
 *
bdev
);

165 cÚ¡ *
	`¥dk_bdev_g‘_´oduù_Çme
(cÚ¡ 
¥dk_bdev
 *
bdev
);

173 
ušt32_t
 
	`¥dk_bdev_g‘_block_size
(cÚ¡ 
¥dk_bdev
 *
bdev
);

183 
ušt64_t
 
	`¥dk_bdev_g‘_num_blocks
(cÚ¡ 
¥dk_bdev
 *
bdev
);

191 
ušt32_t
 
	`¥dk_bdev_g‘_max_unm­_desütÜs
(cÚ¡ 
¥dk_bdev
 *
bdev
);

199 
size_t
 
	`¥dk_bdev_g‘_buf_®ign
(cÚ¡ 
¥dk_bdev
 *
bdev
);

210 
boŞ
 
	`¥dk_bdev_has_wr™e_ÿche
(cÚ¡ 
¥dk_bdev
 *
bdev
);

212 
¥dk_bdev_io
 *
	`¥dk_bdev_»ad
(
¥dk_bdev
 *
bdev
, 
¥dk_io_chªÃl
 *
ch
,

213 *
buf
, 
ušt64_t
 
off£t
, ušt64_ˆ
nby‹s
,

214 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

215 
¥dk_bdev_io
 *

216 
	`¥dk_bdev_»adv
(
¥dk_bdev
 *
bdev
, 
¥dk_io_chªÃl
 *
ch
,

217 
iovec
 *
iov
, 
iovút
,

218 
ušt64_t
 
off£t
, ušt64_ˆ
nby‹s
,

219 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

220 
¥dk_bdev_io
 *
	`¥dk_bdev_wr™e
(
¥dk_bdev
 *
bdev
, 
¥dk_io_chªÃl
 *
ch
,

221 *
buf
, 
ušt64_t
 
off£t
, ušt64_ˆ
nby‹s
,

222 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

223 
¥dk_bdev_io
 *
	`¥dk_bdev_wr™ev
(
¥dk_bdev
 *
bdev
, 
¥dk_io_chªÃl
 *
ch
,

224 
iovec
 *
iov
, 
iovút
,

225 
ušt64_t
 
off£t
, ušt64_ˆ
Ën
,

226 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

227 
¥dk_bdev_io
 *
	`¥dk_bdev_unm­
(
¥dk_bdev
 *
bdev
, 
¥dk_io_chªÃl
 *
ch
,

228 
¥dk_scsi_unm­_bdesc
 *
unm­_d
,

229 
ušt16_t
 
bdesc_couÁ
,

230 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

231 
¥dk_bdev_io
 *
	`¥dk_bdev_æush
(
¥dk_bdev
 *
bdev
, 
¥dk_io_chªÃl
 *
ch
,

232 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
,

233 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

234 
	`¥dk_bdev_ä“_io
(
¥dk_bdev_io
 *
bdev_io
);

235 
	`¥dk_bdev_»£t
(
¥dk_bdev
 *
bdev
, 
¥dk_bdev_»£t_ty³
,

236 
¥dk_bdev_io_com¶‘iÚ_cb
 
cb
, *
cb_¬g
);

237 
¥dk_io_chªÃl
 *
	`¥dk_bdev_g‘_io_chªÃl
(
¥dk_bdev
 *
bdev
, 
ušt32_t
 
´iÜ™y
);

246 
	`¥dk_bdev_io_g‘_nvme_¡©us
(cÚ¡ 
¥dk_bdev_io
 *
bdev_io
, *
sù
, *
sc
);

257 
	`¥dk_bdev_io_g‘_scsi_¡©us
(cÚ¡ 
¥dk_bdev_io
 *
bdev_io
,

258 *
sc
, *
sk
, *
asc
, *
ascq
);

267 
	`¥dk_bdev_io_g‘_iovec
(
¥dk_bdev_io
 *
bdev_io
, 
iovec
 **
iovp
, *
iovú
);

	@PDK/core/src/api/include/udd/spdk/bit_array.h

38 #iâdeà
SPDK_BIT_ARRAY_H


39 
	#SPDK_BIT_ARRAY_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


50 
¥dk_b™_¬¿y
;

55 
ušt32_t
 
¥dk_b™_¬¿y_ÿ·c™y
(cÚ¡ 
¥dk_b™_¬¿y
 *
ba
);

60 
¥dk_b™_¬¿y
 *
¥dk_b™_¬¿y_ü—‹
(
ušt32_t
 
num_b™s
);

65 
¥dk_b™_¬¿y_ä“
(
¥dk_b™_¬¿y
 **
b­
);

80 
¥dk_b™_¬¿y_»size
(
¥dk_b™_¬¿y
 **
b­
, 
ušt32_t
 
num_b™s
);

88 
boŞ
 
¥dk_b™_¬¿y_g‘
(cÚ¡ 
¥dk_b™_¬¿y
 *
ba
, 
ušt32_t
 
b™_šdex
);

96 
¥dk_b™_¬¿y_£t
(
¥dk_b™_¬¿y
 *
ba
, 
ušt32_t
 
b™_šdex
);

104 
¥dk_b™_¬¿y_ş—r
(
¥dk_b™_¬¿y
 *
ba
, 
ušt32_t
 
b™_šdex
);

115 
ušt32_t
 
¥dk_b™_¬¿y_fšd_fœ¡_£t
(cÚ¡ 
¥dk_b™_¬¿y
 *
ba
, ušt32_ˆ
¡¬t_b™_šdex
);

128 
ušt32_t
 
¥dk_b™_¬¿y_fšd_fœ¡_ş—r
(cÚ¡ 
¥dk_b™_¬¿y
 *
ba
, ušt32_ˆ
¡¬t_b™_šdex
);

130 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/blob.h

66 #iâdeà
SPDK_BLOB_H


67 
	#SPDK_BLOB_H


	)

69 
	~"¥dk/¡dšc.h
"

71 
ušt64_t
 
	t¥dk_blob_id
;

72 
	#SPDK_BLOBID_INVALID
 (
ušt64_t
)-1

	)

74 
	g¥dk_blob_¡Üe
;

75 
	g¥dk_io_chªÃl
;

76 
	g¥dk_blob
;

77 
	g¥dk_x©Œ_Çmes
;

79 (*
	t¥dk_bs_İ_com¶‘e
)(*
	tcb_¬g
, 
	tb£¼no
);

80 (*
	t¥dk_bs_İ_w™h_hªdË_com¶‘e
)(*
	tcb_¬g
, 
	t¥dk_blob_¡Üe
 *
	tbs
,

81 
	tb£¼no
);

82 (*
	t¥dk_blob_İ_com¶‘e
)(*
	tcb_¬g
, 
	tb£¼no
);

83 (*
	t¥dk_blob_İ_w™h_id_com¶‘e
)(*
	tcb_¬g
, 
	t¥dk_blob_id
 
	tblobid
, 
	tb£¼no
);

84 (*
	t¥dk_blob_İ_w™h_hªdË_com¶‘e
)(*
	tcb_¬g
, 
	t¥dk_blob
 *
	tblb
, 
	tb£¼no
);

90 (*
	t¥dk_bs_dev_ıl
)(
	t¥dk_io_chªÃl
 *
	tchªÃl
,

91 *
	tcb_¬g
, 
	tb£¼no
);

93 
	s¥dk_bs_dev_cb_¬gs
 {

94 
¥dk_bs_dev_ıl
 
cb_â
;

95 
¥dk_io_chªÃl
 *
chªÃl
;

96 *
cb_¬g
;

102 
ušt8_t
 
sü©ch
[32];

105 
	s¥dk_bs_dev
 {

108 
¥dk_io_chªÃl
 *(*
ü—‹_chªÃl
)(
¥dk_bs_dev
 *
dev
);

111 (*
de¡roy_chªÃl
)(
¥dk_bs_dev
 *
dev
, 
¥dk_io_chªÃl
 *
chªÃl
);

117 (*
de¡roy
)(
¥dk_bs_dev
 *
dev
);

119 (*
»ad
)(
¥dk_bs_dev
 *
dev
, 
¥dk_io_chªÃl
 *
chªÃl
, *
·ylßd
,

120 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
,

121 
¥dk_bs_dev_cb_¬gs
 *
cb_¬gs
);

123 (*
wr™e
)(
¥dk_bs_dev
 *
dev
, 
¥dk_io_chªÃl
 *
chªÃl
, *
·ylßd
,

124 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
,

125 
¥dk_bs_dev_cb_¬gs
 *
cb_¬gs
);

127 (*
æush
)(
¥dk_bs_dev
 *
dev
, 
¥dk_io_chªÃl
 *
chªÃl
,

128 
¥dk_bs_dev_cb_¬gs
 *
cb_¬gs
);

130 (*
unm­
)(
¥dk_bs_dev
 *
dev
, 
¥dk_io_chªÃl
 *
chªÃl
,

131 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
,

132 
¥dk_bs_dev_cb_¬gs
 *
cb_¬gs
);

134 
ušt64_t
 
blockút
;

135 
ušt32_t
 
blockËn
;

138 
	s¥dk_bs_İts
 {

139 
ušt32_t
 
şu¡”_sz
;

140 
ušt32_t
 
num_md_·ges
;

141 
ušt32_t
 
max_md_İs
;

145 
	`¥dk_bs_İts_š™
(
¥dk_bs_İts
 *
İts
);

148 
	`¥dk_bs_lßd
(
¥dk_bs_dev
 *
dev
,

149 
¥dk_bs_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

152 
	`¥dk_bs_š™
(
¥dk_bs_dev
 *
dev
, 
¥dk_bs_İts
 *
İts
,

153 
¥dk_bs_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

156 
	`¥dk_bs_uÆßd
(
¥dk_blob_¡Üe
 *
bs
, 
¥dk_bs_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

161 
	`¥dk_bs_£t_su³r
(
¥dk_blob_¡Üe
 *
bs
, 
¥dk_blob_id
 
blobid
,

162 
¥dk_bs_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

165 
	`¥dk_bs_g‘_su³r
(
¥dk_blob_¡Üe
 *
bs
,

166 
¥dk_blob_İ_w™h_id_com¶‘e
 
cb_â
, *
cb_¬g
);

169 
ušt64_t
 
	`¥dk_bs_g‘_şu¡”_size
(
¥dk_blob_¡Üe
 *
bs
);

172 
ušt64_t
 
	`¥dk_bs_g‘_·ge_size
(
¥dk_blob_¡Üe
 *
bs
);

175 
ušt64_t
 
	`¥dk_bs_ä“_şu¡”_couÁ
(
¥dk_blob_¡Üe
 *
bs
);

180 
	`¥dk_bs_»gi¡”_md_th»ad
(
¥dk_blob_¡Üe
 *
bs
);

185 
	`¥dk_bs_uÄegi¡”_md_th»ad
(
¥dk_blob_¡Üe
 *
bs
);

188 
¥dk_blob_id
 
	`¥dk_blob_g‘_id
(
¥dk_blob
 *
blob
);

191 
ušt64_t
 
	`¥dk_blob_g‘_num_·ges
(
¥dk_blob
 *
blob
);

194 
ušt64_t
 
	`¥dk_blob_g‘_num_şu¡”s
(
¥dk_blob
 *
blob
);

197 
	`¥dk_bs_md_ü—‹_blob
(
¥dk_blob_¡Üe
 *
bs
,

198 
¥dk_blob_İ_w™h_id_com¶‘e
 
cb_â
, *
cb_¬g
);

201 
	`¥dk_bs_md_d–‘e_blob
(
¥dk_blob_¡Üe
 *
bs
, 
¥dk_blob_id
 
blobid
,

202 
¥dk_blob_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

205 
	`¥dk_bs_md_İ’_blob
(
¥dk_blob_¡Üe
 *
bs
, 
¥dk_blob_id
 
blobid
,

206 
¥dk_blob_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

212 
	`¥dk_bs_md_»size_blob
(
¥dk_blob
 *
blob
, 
size_t
 
sz
);

222 
	`¥dk_bs_md_sync_blob
(
¥dk_blob
 *
blob
,

223 
¥dk_blob_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

226 
	`¥dk_bs_md_şo£_blob
(
¥dk_blob
 **
blob
, 
¥dk_blob_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

228 
¥dk_io_chªÃl
 *
	`¥dk_bs_®loc_io_chªÃl
(
¥dk_blob_¡Üe
 *
bs
,

229 
ušt32_t
 
´iÜ™y
, ušt32_ˆ
max_İs
);

231 
	`¥dk_bs_ä“_io_chªÃl
(
¥dk_io_chªÃl
 *
chªÃl
);

234 
	`¥dk_bs_io_æush_chªÃl
(
¥dk_io_chªÃl
 *
chªÃl
,

235 
¥dk_blob_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

238 
	`¥dk_bs_io_wr™e_blob
(
¥dk_blob
 *
blob
, 
¥dk_io_chªÃl
 *
chªÃl
,

239 *
·ylßd
, 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
,

240 
¥dk_blob_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

244 
	`¥dk_bs_io_»ad_blob
(
¥dk_blob
 *
blob
, 
¥dk_io_chªÃl
 *
chªÃl
,

245 *
·ylßd
, 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
,

246 
¥dk_blob_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

249 
	`¥dk_bs_md_™”_fœ¡
(
¥dk_blob_¡Üe
 *
bs
,

250 
¥dk_blob_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

251 
	`¥dk_bs_md_™”_Ãxt
(
¥dk_blob_¡Üe
 *
bs
, 
¥dk_blob
 **
blob
,

252 
¥dk_blob_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

254 
	`¥dk_blob_md_£t_x©Œ
(
¥dk_blob
 *
blob
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

255 
ušt16_t
 
v®ue_Ën
);

256 
	`¥dk_blob_md_»move_x©Œ
(
¥dk_blob
 *
blob
, cÚ¡ *
Çme
);

257 
	`¥dk_bs_md_g‘_x©Œ_v®ue
(
¥dk_blob
 *
blob
, cÚ¡ *
Çme
,

258 cÚ¡ **
v®ue
, 
size_t
 *
v®ue_Ën
);

259 
	`¥dk_bs_md_g‘_x©Œ_Çmes
(
¥dk_blob
 *
blob
,

260 
¥dk_x©Œ_Çmes
 **
Çmes
);

262 
ušt32_t
 
	`¥dk_x©Œ_Çmes_g‘_couÁ
(
¥dk_x©Œ_Çmes
 *
Çmes
);

263 cÚ¡ *
	`¥dk_x©Œ_Çmes_g‘_Çme
(
¥dk_x©Œ_Çmes
 *
Çmes
, 
ušt32_t
 
šdex
);

264 
	`¥dk_x©Œ_Çmes_ä“
(
¥dk_x©Œ_Çmes
 *
Çmes
);

	@PDK/core/src/api/include/udd/spdk/blob_bdev.h

38 #iâdeà
SPDK_BLOB_BDEV_H


39 
	#SPDK_BLOB_BDEV_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
¥dk_bs_dev
;

48 
¥dk_bdev
;

50 
¥dk_bs_dev
 *
¥dk_bdev_ü—‹_bs_dev
(
¥dk_bdev
 *);

52 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/blobfs.h

38 #iâdeà
SPDK_FS_H


39 
	#SPDK_FS_H


	)

41 
	~"¥dk/¡dšc.h
"

43 
	~"¥dk/blob.h
"

45 
	#SPDK_FILE_NAME_MAX
 255

	)

47 
	g¥dk_fe
;

48 
	g¥dk_fesy¡em
;

50 
¥dk_fe
 *
	t¥dk_fs_™”
;

52 
	s¥dk_fe_¡©
 {

53 
¥dk_blob_id
 
	mblobid
;

54 
ušt64_t
 
	msize
;

57 (*
	t¥dk_fs_İ_w™h_hªdË_com¶‘e
)(*
	tùx
, 
	t¥dk_fesy¡em
 *
	tfs
,

58 
	tf£¼no
);

59 (*
	t¥dk_fe_İ_w™h_hªdË_com¶‘e
)(*
	tùx
, 
	t¥dk_fe
 *
	tf
, 
	tf£¼no
);

60 
¥dk_bs_İ_com¶‘e
 
	t¥dk_fs_İ_com¶‘e
;

62 (*
	t¥dk_fe_İ_com¶‘e
)(*
	tùx
, 
	tf£¼no
);

63 (*
	t¥dk_fe_¡©_İ_com¶‘e
)(*
	tùx
, 
	t¥dk_fe_¡©
 *
	t¡©
, 
	tf£¼no
);

65 (*
	tfs_»que¡_â
)(*);

66 (*
	tfs_£nd_»que¡_â
)(
	tfs_»que¡_â
, *);

68 
	`¥dk_fs_š™
(
¥dk_bs_dev
 *
dev
, 
fs_£nd_»que¡_â
 
£nd_»que¡_â
,

69 
¥dk_fs_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

70 
	`¥dk_fs_lßd
(
¥dk_bs_dev
 *
dev
, 
fs_£nd_»que¡_â
 
£nd_»que¡_â
,

71 
¥dk_fs_İ_w™h_hªdË_com¶‘e
 
cb_â
, *
cb_¬g
);

72 
	`¥dk_fs_uÆßd
(
¥dk_fesy¡em
 *
fs
, 
¥dk_fs_İ_com¶‘e
 
cb_â
, *
cb_¬g
);

74 
¥dk_io_chªÃl
 *
	`¥dk_fs_®loc_io_chªÃl
(
¥dk_fesy¡em
 *
fs
, 
ušt32_t
 
´iÜ™y
);

82 
¥dk_io_chªÃl
 *
	`¥dk_fs_®loc_io_chªÃl_sync
(
¥dk_fesy¡em
 *
fs
,

83 
ušt32_t
 
´iÜ™y
);

85 
	`¥dk_fs_ä“_io_chªÃl
(
¥dk_io_chªÃl
 *
chªÃl
);

87 
	`¥dk_fs_fe_¡©
(
¥dk_fesy¡em
 *
fs
, 
¥dk_io_chªÃl
 *
chªÃl
,

88 cÚ¡ *
Çme
, 
¥dk_fe_¡©
 *
¡©
);

90 
	#SPDK_BLOBFS_OPEN_CREATE
 (1ULL << 0)

	)

92 
	`¥dk_fs_ü—‹_fe
(
¥dk_fesy¡em
 *
fs
, 
¥dk_io_chªÃl
 *
chªÃl
,

93 cÚ¡ *
Çme
);

95 
	`¥dk_fs_İ’_fe
(
¥dk_fesy¡em
 *
fs
, 
¥dk_io_chªÃl
 *
chªÃl
,

96 cÚ¡ *
Çme
, 
ušt32_t
 
æags
, 
¥dk_fe
 **
fe
);

98 
	`¥dk_fe_şo£
(
¥dk_fe
 *
fe
, 
¥dk_io_chªÃl
 *
chªÃl
);

100 
	`¥dk_fs_»Çme_fe
(
¥dk_fesy¡em
 *
fs
, 
¥dk_io_chªÃl
 *
chªÃl
,

101 cÚ¡ *
Şd_Çme
, cÚ¡ *
Ãw_Çme
);

103 
	`¥dk_fs_d–‘e_fe
(
¥dk_fesy¡em
 *
fs
, 
¥dk_io_chªÃl
 *
chªÃl
,

104 cÚ¡ *
Çme
);

106 
¥dk_fs_™”
 
	`¥dk_fs_™”_fœ¡
(
¥dk_fesy¡em
 *
fs
);

107 
¥dk_fs_™”
 
	`¥dk_fs_™”_Ãxt
(¥dk_fs_™” 
™”
);

108 
	#¥dk_fs_™”_g‘_fe
(
™”
è((
¥dk_fe
 *)(™”))

	)

110 
	`¥dk_fe_Œunÿ‹
(
¥dk_fe
 *
fe
, 
¥dk_io_chªÃl
 *
chªÃl
,

111 
ušt64_t
 
Ëngth
);

113 cÚ¡ *
	`¥dk_fe_g‘_Çme
(
¥dk_fe
 *
fe
);

115 
ušt64_t
 
	`¥dk_fe_g‘_Ëngth
(
¥dk_fe
 *
fe
);

117 
	`¥dk_fe_wr™e
(
¥dk_fe
 *
fe
, 
¥dk_io_chªÃl
 *
chªÃl
,

118 *
·ylßd
, 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
);

120 
št64_t
 
	`¥dk_fe_»ad
(
¥dk_fe
 *
fe
, 
¥dk_io_chªÃl
 *
chªÃl
,

121 *
·ylßd
, 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
);

123 
	`¥dk_fs_£t_ÿche_size
(
ušt64_t
 
size_š_mb
);

124 
ušt64_t
 
	`¥dk_fs_g‘_ÿche_size
();

126 
	#SPDK_FILE_PRIORITY_LOW
 0

	)

127 
	#SPDK_FILE_PRIORITY_HIGH
 1

	)

129 
	`¥dk_fe_£t_´iÜ™y
(
¥dk_fe
 *
fe
, 
ušt32_t
 
´iÜ™y
);

131 
	`¥dk_fe_sync
(
¥dk_fe
 *
fe
, 
¥dk_io_chªÃl
 *
chªÃl
);

	@PDK/core/src/api/include/udd/spdk/conf.h

39 #iâdeà
SPDK_CONF_H


40 
	#SPDK_CONF_H


	)

42 
	~"¥dk/¡dšc.h
"

44 
	g¥dk_cÚf_v®ue
;

45 
	g¥dk_cÚf_™em
;

46 
	g¥dk_cÚf_£ùiÚ
;

47 
	g¥dk_cÚf
;

49 
¥dk_cÚf
 *
¥dk_cÚf_®loÿ‹
();

50 
¥dk_cÚf_ä“
(
¥dk_cÚf
 *
ı
);

51 
¥dk_cÚf_»ad
(
¥dk_cÚf
 *
ı
, cÚ¡ *
fe
);

52 
¥dk_cÚf_£ùiÚ
 *
¥dk_cÚf_fšd_£ùiÚ
(
¥dk_cÚf
 *
ı
, cÚ¡ *
Çme
);

55 
¥dk_cÚf_£ùiÚ
 *
¥dk_cÚf_fœ¡_£ùiÚ
(
¥dk_cÚf
 *
ı
);

56 
¥dk_cÚf_£ùiÚ
 *
¥dk_cÚf_Ãxt_£ùiÚ
(¥dk_cÚf_£ùiÚ *
¥
);

58 
boŞ
 
¥dk_cÚf_£ùiÚ_m©ch_´efix
(cÚ¡ 
¥dk_cÚf_£ùiÚ
 *
¥
, cÚ¡ *
Çme_´efix
);

59 cÚ¡ *
¥dk_cÚf_£ùiÚ_g‘_Çme
(cÚ¡ 
¥dk_cÚf_£ùiÚ
 *
¥
);

60 
¥dk_cÚf_£ùiÚ_g‘_num
(cÚ¡ 
¥dk_cÚf_£ùiÚ
 *
¥
);

61 *
¥dk_cÚf_£ùiÚ_g‘_nmv®
(
¥dk_cÚf_£ùiÚ
 *
¥
, cÚ¡ *
key
,

62 
idx1
, 
idx2
);

63 *
¥dk_cÚf_£ùiÚ_g‘_nv®
(
¥dk_cÚf_£ùiÚ
 *
¥
, cÚ¡ *
key
, 
idx
);

64 *
¥dk_cÚf_£ùiÚ_g‘_v®
(
¥dk_cÚf_£ùiÚ
 *
¥
, cÚ¡ *
key
);

65 
¥dk_cÚf_£ùiÚ_g‘_štv®
(
¥dk_cÚf_£ùiÚ
 *
¥
, cÚ¡ *
key
);

66 
boŞ
 
¥dk_cÚf_£ùiÚ_g‘_boŞv®
(
¥dk_cÚf_£ùiÚ
 *
¥
, cÚ¡ *
key
, boŞ 
deçuÉ_v®
);

68 
¥dk_cÚf_£t_as_deçuÉ
(
¥dk_cÚf
 *
ı
);

	@PDK/core/src/api/include/udd/spdk/copy_engine.h

38 #iâdeà
SPDK_COPY_ENGINE_H


39 
	#SPDK_COPY_ENGINE_H


	)

41 
	~"¥dk/¡dšc.h
"

43 (*
	t¥dk_cİy_com¶‘iÚ_cb
)(*
	t»f
, 
	t¡©us
);

45 
¥dk_io_chªÃl
;

47 
¥dk_cİy_sk
;

49 
¥dk_io_chªÃl
 *
	`¥dk_cİy_’gše_g‘_io_chªÃl
(
ušt32_t
 
´iÜ™y
);

50 
št64_t
 
	`¥dk_cİy_subm™
(
¥dk_cİy_sk
 *
cİy_»q
, 
¥dk_io_chªÃl
 *
ch
, *
d¡
,

51 *
¤c
, 
ušt64_t
 
nby‹s
, 
¥dk_cİy_com¶‘iÚ_cb
 
cb
);

52 
št64_t
 
	`¥dk_cİy_subm™_fl
(
¥dk_cİy_sk
 *
cİy_»q
, 
¥dk_io_chªÃl
 *
ch
,

53 *
d¡
, 
ušt8_t
 
fl
, 
ušt64_t
 
nby‹s
, 
¥dk_cİy_com¶‘iÚ_cb
 
cb
);

54 
size_t
 
	`¥dk_cİy_sk_size
();

	@PDK/core/src/api/include/udd/spdk/endian.h

39 #iâdeà
SPDK_ENDIAN_H


40 
	#SPDK_ENDIAN_H


	)

42 
	~"¥dk/¡dšc.h
"

44 #ifdeà
__ılu¥lus


48 
šlše
 
ušt16_t


49 
äom_be16
(cÚ¡ *
±r
)

51 cÚ¡ 
ušt8_t
 *
tmp
 = (cÚ¡ ušt8_ˆ*)
±r
;

52  (((
ušt16_t
)
tmp
[0] << 8) |mp[1]);

55 
šlše
 

56 
to_be16
(*
out
, 
ušt16_t
 
š
)

58 
ušt8_t
 *
tmp
 = (ušt8_ˆ*)
out
;

59 
tmp
[0] = (
š
 >> 8) & 0xFF;

60 
tmp
[1] = 
š
 & 0xFF;

63 
šlše
 
ušt32_t


64 
äom_be32
(cÚ¡ *
±r
)

66 cÚ¡ 
ušt8_t
 *
tmp
 = (cÚ¡ ušt8_ˆ*)
±r
;

67  (((
ušt32_t
)
tmp
[0] << 24) |

68 ((
ušt32_t
)
tmp
[1] << 16) |

69 ((
ušt32_t
)
tmp
[2] << 8) |

70 ((
ušt32_t
)
tmp
[3]));

73 
šlše
 

74 
to_be32
(*
out
, 
ušt32_t
 
š
)

76 
ušt8_t
 *
tmp
 = (ušt8_ˆ*)
out
;

77 
tmp
[0] = (
š
 >> 24) & 0xFF;

78 
tmp
[1] = (
š
 >> 16) & 0xFF;

79 
tmp
[2] = (
š
 >> 8) & 0xFF;

80 
tmp
[3] = 
š
 & 0xFF;

83 
šlše
 
ušt64_t


84 
äom_be64
(cÚ¡ *
±r
)

86 cÚ¡ 
ušt8_t
 *
tmp
 = (cÚ¡ ušt8_ˆ*)
±r
;

87  (((
ušt64_t
)
tmp
[0] << 56) |

88 ((
ušt64_t
)
tmp
[1] << 48) |

89 ((
ušt64_t
)
tmp
[2] << 40) |

90 ((
ušt64_t
)
tmp
[3] << 32) |

91 ((
ušt64_t
)
tmp
[4] << 24) |

92 ((
ušt64_t
)
tmp
[5] << 16) |

93 ((
ušt64_t
)
tmp
[6] << 8) |

94 ((
ušt64_t
)
tmp
[7]));

97 
šlše
 

98 
to_be64
(*
out
, 
ušt64_t
 
š
)

100 
ušt8_t
 *
tmp
 = (ušt8_ˆ*)
out
;

101 
tmp
[0] = (
š
 >> 56) & 0xFF;

102 
tmp
[1] = (
š
 >> 48) & 0xFF;

103 
tmp
[2] = (
š
 >> 40) & 0xFF;

104 
tmp
[3] = (
š
 >> 32) & 0xFF;

105 
tmp
[4] = (
š
 >> 24) & 0xFF;

106 
tmp
[5] = (
š
 >> 16) & 0xFF;

107 
tmp
[6] = (
š
 >> 8) & 0xFF;

108 
tmp
[7] = 
š
 & 0xFF;

111 
šlše
 
ušt16_t


112 
äom_Ë16
(cÚ¡ *
±r
)

114 cÚ¡ 
ušt8_t
 *
tmp
 = (cÚ¡ ušt8_ˆ*)
±r
;

115  (((
ušt16_t
)
tmp
[1] << 8) |mp[0]);

118 
šlše
 

119 
to_Ë16
(*
out
, 
ušt16_t
 
š
)

121 
ušt8_t
 *
tmp
 = (ušt8_ˆ*)
out
;

122 
tmp
[1] = (
š
 >> 8) & 0xFF;

123 
tmp
[0] = 
š
 & 0xFF;

126 
šlše
 
ušt32_t


127 
äom_Ë32
(cÚ¡ *
±r
)

129 cÚ¡ 
ušt8_t
 *
tmp
 = (cÚ¡ ušt8_ˆ*)
±r
;

130  (((
ušt32_t
)
tmp
[3] << 24) |

131 ((
ušt32_t
)
tmp
[2] << 16) |

132 ((
ušt32_t
)
tmp
[1] << 8) |

133 ((
ušt32_t
)
tmp
[0]));

136 
šlše
 

137 
to_Ë32
(*
out
, 
ušt32_t
 
š
)

139 
ušt8_t
 *
tmp
 = (ušt8_ˆ*)
out
;

140 
tmp
[3] = (
š
 >> 24) & 0xFF;

141 
tmp
[2] = (
š
 >> 16) & 0xFF;

142 
tmp
[1] = (
š
 >> 8) & 0xFF;

143 
tmp
[0] = 
š
 & 0xFF;

146 
šlše
 
ušt64_t


147 
äom_Ë64
(cÚ¡ *
±r
)

149 cÚ¡ 
ušt8_t
 *
tmp
 = (cÚ¡ ušt8_ˆ*)
±r
;

150  (((
ušt64_t
)
tmp
[7] << 56) |

151 ((
ušt64_t
)
tmp
[6] << 48) |

152 ((
ušt64_t
)
tmp
[5] << 40) |

153 ((
ušt64_t
)
tmp
[4] << 32) |

154 ((
ušt64_t
)
tmp
[3] << 24) |

155 ((
ušt64_t
)
tmp
[2] << 16) |

156 ((
ušt64_t
)
tmp
[1] << 8) |

157 ((
ušt64_t
)
tmp
[0]));

160 
šlše
 

161 
to_Ë64
(*
out
, 
ušt64_t
 
š
)

163 
ušt8_t
 *
tmp
 = (ušt8_ˆ*)
out
;

164 
tmp
[7] = (
š
 >> 56) & 0xFF;

165 
tmp
[6] = (
š
 >> 48) & 0xFF;

166 
tmp
[5] = (
š
 >> 40) & 0xFF;

167 
tmp
[4] = (
š
 >> 32) & 0xFF;

168 
tmp
[3] = (
š
 >> 24) & 0xFF;

169 
tmp
[2] = (
š
 >> 16) & 0xFF;

170 
tmp
[1] = (
š
 >> 8) & 0xFF;

171 
tmp
[0] = 
š
 & 0xFF;

174 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/env.h

39 #iâdeà
SPDK_ENV_H


40 
	#SPDK_ENV_H


	)

42 
	~"¥dk/¡dšc.h
"

44 #ifdeà
__ılu¥lus


48 
	#SPDK_ENV_SOCKET_ID_ANY
 (-1)

	)

50 
¥dk_pci_deviû
;

55 
	s¥dk_’v_İts
 {

56 cÚ¡ *
Çme
;

57 cÚ¡ *
cÜe_mask
;

58 
shm_id
;

59 
dpdk_mem_chªÃl
;

60 
dpdk_ma¡”_cÜe
;

61 
dpdk_mem_size
;

67 
¥dk_’v_İts_š™
(
¥dk_’v_İts
 *
İts
);

73 
¥dk_’v_š™
(cÚ¡ 
¥dk_’v_İts
 *
İts
);

79 *
¥dk_m®loc
(
size_t
 
size
, size_ˆ
®ign
, 
ušt64_t
 *
phys_addr
);

85 *
¥dk_m®loc_sock‘
(
size_t
 
size
, size_ˆ
®ign
, 
ušt64_t
 *
phys_addr
, 
sock‘_id
);

91 *
¥dk_zm®loc
(
size_t
 
size
, size_ˆ
®ign
, 
ušt64_t
 *
phys_addr
);

97 *
¥dk_zm®loc_sock‘
(
size_t
 
size
, size_ˆ
®ign
, 
ušt64_t
 *
phys_addr
, 
sock‘_id
);

103 *
¥dk_»®loc
(*
buf
, 
size_t
 
size
, size_ˆ
®ign
, 
ušt64_t
 *
phys_addr
);

109 
¥dk_ä“
(*
buf
);

118 *
¥dk_memzÚe_»£rve
(cÚ¡ *
Çme
, 
size_t
 
Ën
, 
sock‘_id
, 
æags
);

125 *
¥dk_memzÚe_lookup
(cÚ¡ *
Çme
);

130 
¥dk_memzÚe_ä“
(cÚ¡ *
Çme
);

135 
¥dk_memzÚe_dump
(
FILE
 *
f
);

137 
¥dk_mempoŞ
;

146 
¥dk_mempoŞ
 *
¥dk_mempoŞ_ü—‹
(cÚ¡ *
Çme
, 
size_t
 
couÁ
,

147 
size_t
 
–e_size
, size_ˆ
ÿche_size
, 
sock‘_id
);

152 
¥dk_mempoŞ_ä“
(
¥dk_mempoŞ
 *
mp
);

157 *
¥dk_mempoŞ_g‘
(
¥dk_mempoŞ
 *
mp
);

162 
¥dk_mempoŞ_put
(
¥dk_mempoŞ
 *
mp
, *
–e
);

167 
¥dk_mempoŞ_put_bulk
(
¥dk_mempoŞ
 *
mp
, *cÚ¡ *
–e_¬r
, 
size_t
 
couÁ
);

172 
size_t
 
¥dk_mempoŞ_couÁ
(cÚ¡ 
¥dk_mempoŞ
 *
poŞ
);

178 
ušt32_t
 
¥dk_’v_g‘_cÜe_couÁ
();

185 
ušt32_t
 
¥dk_’v_g‘_cu¼’t_cÜe
();

191 
ušt32_t
 
¥dk_’v_g‘_fœ¡_cÜe
();

198 
ušt32_t
 
¥dk_’v_g‘_Ãxt_cÜe
(ušt32_ˆ
´ev_cÜe
);

200 
	#SPDK_ENV_FOREACH_CORE
(
i
) \

201 
i
 = 
	`¥dk_’v_g‘_fœ¡_cÜe
(); \

202 
i
 < 
UINT32_MAX
; \

203 
i
 = 
	`¥dk_’v_g‘_Ãxt_cÜe
(i))

	)

208 
ušt32_t
 
¥dk_’v_g‘_sock‘_id
(ušt32_ˆ
cÜe
);

213 
boŞ
 
¥dk_´oûss_is_´im¬y
();

218 
ušt64_t
 
¥dk_g‘_ticks
();

223 
ušt64_t
 
¥dk_g‘_ticks_hz
();

228 
¥dk_d–ay_us
(
us
);

230 
¥dk_ršg
;

232 
	e¥dk_ršg_ty³
 {

233 
SPDK_RING_TYPE_MP_SC
,

239 
¥dk_ršg
 *
¥dk_ršg_ü—‹
(
¥dk_ršg_ty³
 
ty³
, 
size_t
 
couÁ
,

240 
size_t
 
–e_size
, 
sock‘_id
);

245 
¥dk_ršg_ä“
(
¥dk_ršg
 *
ršg
);

252 
size_t
 
¥dk_ršg_’queue
(
¥dk_ršg
 *
ršg
, **
objs
, size_ˆ
couÁ
);

259 
size_t
 
¥dk_ršg_dequeue
(
¥dk_ršg
 *
ršg
, **
objs
, size_ˆ
couÁ
);

261 
	#SPDK_VTOPHYS_ERROR
 (0xFFFFFFFFFFFFFFFFULL)

	)

263 
ušt64_t
 
¥dk_vtİhys
(*
buf
);

265 
	s¥dk_pci_addr
 {

266 
ušt16_t
 
domaš
;

267 
ušt8_t
 
bus
;

268 
ušt8_t
 
dev
;

269 
ušt8_t
 
func
;

272 
	s¥dk_pci_id
 {

273 
ušt16_t
 
v’dÜ_id
;

274 
ušt16_t
 
deviû_id
;

275 
ušt16_t
 
subv’dÜ_id
;

276 
ušt16_t
 
subdeviû_id
;

279 (*
¥dk_pci_’um_cb
)(*
	t’um_ùx
, 
	t¥dk_pci_deviû
 *
	tpci_dev
);

281 
¥dk_pci_nvme_’um”©e
(
¥dk_pci_’um_cb
 
’um_cb
, *
’um_ùx
);

282 
¥dk_pci_ißt_’um”©e
(
¥dk_pci_’um_cb
 
’um_cb
, *
’um_ùx
);

284 
¥dk_pci_deviû
 *
¥dk_pci_g‘_deviû
(
¥dk_pci_addr
 *
pci_addr
);

286 
¥dk_pci_deviû_m­_b¬
(
¥dk_pci_deviû
 *
dev
, 
ušt32_t
 
b¬
,

287 **
m­³d_addr
, 
ušt64_t
 *
phys_addr
, ušt64_ˆ*
size
);

288 
¥dk_pci_deviû_unm­_b¬
(
¥dk_pci_deviû
 *
dev
, 
ušt32_t
 
b¬
, *
addr
);

290 
ušt16_t
 
¥dk_pci_deviû_g‘_domaš
(
¥dk_pci_deviû
 *
dev
);

291 
ušt8_t
 
¥dk_pci_deviû_g‘_bus
(
¥dk_pci_deviû
 *
dev
);

292 
ušt8_t
 
¥dk_pci_deviû_g‘_dev
(
¥dk_pci_deviû
 *
dev
);

293 
ušt8_t
 
¥dk_pci_deviû_g‘_func
(
¥dk_pci_deviû
 *
dev
);

295 
¥dk_pci_addr
 
¥dk_pci_deviû_g‘_addr
(
¥dk_pci_deviû
 *
dev
);

297 
ušt16_t
 
¥dk_pci_deviû_g‘_v’dÜ_id
(
¥dk_pci_deviû
 *
dev
);

298 
ušt16_t
 
¥dk_pci_deviû_g‘_deviû_id
(
¥dk_pci_deviû
 *
dev
);

299 
ušt16_t
 
¥dk_pci_deviû_g‘_subv’dÜ_id
(
¥dk_pci_deviû
 *
dev
);

300 
ušt16_t
 
¥dk_pci_deviû_g‘_subdeviû_id
(
¥dk_pci_deviû
 *
dev
);

302 
¥dk_pci_id
 
¥dk_pci_deviû_g‘_id
(
¥dk_pci_deviû
 *
dev
);

311 
¥dk_pci_deviû_g‘_sock‘_id
(
¥dk_pci_deviû
 *
dev
);

313 
¥dk_pci_deviû_g‘_£rŸl_numb”
(
¥dk_pci_deviû
 *
dev
, *
¢
, 
size_t
 
Ën
);

314 
¥dk_pci_deviû_şaim
(cÚ¡ 
¥dk_pci_addr
 *
pci_addr
);

315 
¥dk_pci_deviû_d‘ach
(
¥dk_pci_deviû
 *
deviû
);

317 
¥dk_pci_nvme_deviû_©ch
(
¥dk_pci_’um_cb
 
’um_cb
, *
’um_ùx
,

318 
¥dk_pci_addr
 *
pci_add»ss
);

319 
¥dk_pci_ißt_deviû_©ch
(
¥dk_pci_’um_cb
 
’um_cb
, *
’um_ùx
,

320 
¥dk_pci_addr
 *
pci_add»ss
);

322 
¥dk_pci_deviû_cfg_»ad8
(
¥dk_pci_deviû
 *
dev
, 
ušt8_t
 *
v®ue
, 
ušt32_t
 
off£t
);

323 
¥dk_pci_deviû_cfg_wr™e8
(
¥dk_pci_deviû
 *
dev
, 
ušt8_t
 
v®ue
, 
ušt32_t
 
off£t
);

324 
¥dk_pci_deviû_cfg_»ad16
(
¥dk_pci_deviû
 *
dev
, 
ušt16_t
 *
v®ue
, 
ušt32_t
 
off£t
);

325 
¥dk_pci_deviû_cfg_wr™e16
(
¥dk_pci_deviû
 *
dev
, 
ušt16_t
 
v®ue
, 
ušt32_t
 
off£t
);

326 
¥dk_pci_deviû_cfg_»ad32
(
¥dk_pci_deviû
 *
dev
, 
ušt32_t
 *
v®ue
, ušt32_ˆ
off£t
);

327 
¥dk_pci_deviû_cfg_wr™e32
(
¥dk_pci_deviû
 *
dev
, 
ušt32_t
 
v®ue
, ušt32_ˆ
off£t
);

334 
¥dk_pci_addr_com·»
(cÚ¡ 
¥dk_pci_addr
 *
a1
, cÚ¡ ¥dk_pci_add¸*
a2
);

345 
¥dk_pci_addr_·r£
(
¥dk_pci_addr
 *
addr
, cÚ¡ *
bdf
);

358 
¥dk_pci_addr_fmt
(*
bdf
, 
size_t
 
sz
, cÚ¡ 
¥dk_pci_addr
 *
addr
);

371 *
¥dk_ÿÎ_uÇffš™ized
(*
cb
(*
¬g
), *arg);

376 
¥dk_mem_m­
;

378 
	e¥dk_mem_m­_nÙify_aùiÚ
 {

379 
SPDK_MEM_MAP_NOTIFY_REGISTER
,

380 
SPDK_MEM_MAP_NOTIFY_UNREGISTER
,

383 (*
¥dk_mem_m­_nÙify_cb
)(*
	tcb_ùx
, 
	t¥dk_mem_m­
 *
	tm­
,

384 
	t¥dk_mem_m­_nÙify_aùiÚ
 
	taùiÚ
,

385 *
	tvaddr
, 
	tsize_t
 
	tsize
);

390 
¥dk_mem_m­
 *
¥dk_mem_m­_®loc
(
ušt64_t
 
deçuÉ_Œª¦©iÚ
,

391 
¥dk_mem_m­_nÙify_cb
 
nÙify_cb
, *
cb_ùx
);

396 
¥dk_mem_m­_ä“
(
¥dk_mem_m­
 **
pm­
);

408 
¥dk_mem_m­_£t_Œª¦©iÚ
(
¥dk_mem_m­
 *
m­
, 
ušt64_t
 
vaddr
, ušt64_ˆ
size
,

409 
ušt64_t
 
Œª¦©iÚ
);

416 
¥dk_mem_m­_ş—r_Œª¦©iÚ
(
¥dk_mem_m­
 *
m­
, 
ušt64_t
 
vaddr
, ušt64_ˆ
size
);

421 
ušt64_t
 
¥dk_mem_m­_Œª¦©e
(cÚ¡ 
¥dk_mem_m­
 *
m­
, ušt64_ˆ
vaddr
);

427 
¥dk_mem_»gi¡”
(*
vaddr
, 
size_t
 
Ën
);

434 
¥dk_mem_uÄegi¡”
(*
vaddr
, 
size_t
 
Ën
);

436 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/event.h

41 #iâdeà
SPDK_EVENT_H


42 
	#SPDK_EVENT_H


	)

44 
	~"¥dk/¡dšc.h
"

46 
	~"¥dk/queue.h
"

48 (*
	t¥dk_ev’t_â
)(*
	t¬g1
, *
	t¬g2
);

53 
¥dk_ev’t
;

55 (*
	t¥dk_pŞËr_â
)(*
	t¬g
);

60 
¥dk_pŞËr
;

62 (*
	t¥dk_­p_shutdown_cb
)();

63 (*
	t¥dk_sighªdËr_t
)();

68 
	s¥dk_­p_İts
 {

69 cÚ¡ *
Çme
;

70 cÚ¡ *
cÚfig_fe
;

71 cÚ¡ *
»aùÜ_mask
;

72 cÚ¡ *
log_çc™y
;

73 cÚ¡ *
ošt_group_mask
;

75 
shm_id
;

77 
¥dk_­p_shutdown_cb
 
shutdown_cb
;

78 
¥dk_sighªdËr_t
 
u¤1_hªdËr
;

80 
boŞ
 
’abË_cÜedump
;

81 
dpdk_mem_chªÃl
;

82 
dpdk_ma¡”_cÜe
;

83 
dpdk_mem_size
;

90 
ušt64_t
 
max_d–ay_us
;

91 
š™_äom
;

92 *
İtiÚs
;

98 
	`¥dk_­p_İts_š™
(
¥dk_­p_İts
 *
İts
);

104 
	`¥dk_­p_š™
(
¥dk_­p_İts
 *
İts
);

109 
	`¥dk_­p_fši
();

115 
	`¥dk_­p_¡¬t
(
¥dk_ev’t_â
 
¡¬t_â
, *
¬g1
, *
¬g2
);

122 
	`¥dk_­p_¡¬t_shutdown
();

128 
	`¥dk_­p_¡İ
(
rc
);

133 
	`¥dk_­p_g‘_ruÂšg_cÚfig
(**
cÚfig_¡r
, *
Çme
);

138 
	`¥dk_­p_g‘_shm_id
();

143 
	`¥dk_­p_·r£_cÜe_mask
(cÚ¡ *
mask
, 
ušt64_t
 *
ıumask
);

148 
ušt64_t
 
	`¥dk_­p_g‘_cÜe_mask
();

153 
	$¥dk_­p_g‘_cÜe_couÁ
(è
	`__©Œibu‹__
((
d•»ÿ‹d
));

158 
ušt32_t
 
	$¥dk_­p_g‘_cu¼’t_cÜe
(è
	`__©Œibu‹__
((
d•»ÿ‹d
));

163 
¥dk_ev’t
 *
	`¥dk_ev’t_®loÿ‹
(
ušt32_t
 
lcÜe
, 
¥dk_ev’t_â
 
â
,

164 *
¬g1
, *
¬g2
);

169 
	`¥dk_ev’t_ÿÎ
(
¥dk_ev’t
 *
ev’t
);

174 
	`¥dk_pŞËr_»gi¡”
(
¥dk_pŞËr
 **
µŞËr
,

175 
¥dk_pŞËr_â
 
â
,

176 *
¬g
,

177 
ušt32_t
 
lcÜe
,

178 
ušt64_t
 
³riod_miüo£cÚds
);

183 
	`¥dk_pŞËr_uÄegi¡”
(
¥dk_pŞËr
 **
µŞËr
,

184 
¥dk_ev’t
 *
com¶‘e
);

	@PDK/core/src/api/include/udd/spdk/fd.h

38 #iâdeà
SPDK_FD_H


39 
	#SPDK_FD_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
ušt64_t
 
¥dk_fd_g‘_size
(
fd
);

48 
ušt32_t
 
¥dk_fd_g‘_blockËn
(
fd
);

50 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/gpt_spec.h

39 #iâdeà
SPDK_GPT_SPEC_H


40 
	#SPDK_GPT_SPEC_H


	)

42 
	~"¥dk/¡dšc.h
"

44 
	~"¥dk/as£¹.h
"

46 #´agm¨
·ck
(
push
, 1)

48 
	#SPDK_MBR_SIGNATURE
 0xAA55

	)

50 
	#SPDK_MBR_OS_TYPE_GPT_PROTECTIVE
 0xEE

	)

51 
	#SPDK_MBR_OS_TYPE_EFI_SYSTEM_PARTITION
 0xEF

	)

53 
	s¥dk_mbr_chs
 {

54 
ušt8_t
 
	mh—d
;

55 
ušt16_t
 
	m£ùÜ
 : 6;

56 
ušt16_t
 
	mcylšd”
 : 10;

58 
SPDK_STATIC_ASSERT
((
¥dk_mbr_chs
) == 3, "size incorrect");

60 
	s¥dk_mbr_·¹™iÚ_’Œy
 {

61 
ušt8_t
 
	m»£rved
 : 7;

62 
ušt8_t
 
	mboÙabË
 : 1;

64 
¥dk_mbr_chs
 
	m¡¬t_chs
;

66 
ušt8_t
 
	mos_ty³
;

68 
¥dk_mbr_chs
 
	m’d_chs
;

70 
ušt32_t
 
	m¡¬t_lba
;

71 
ušt32_t
 
	msize_lba
;

73 
SPDK_STATIC_ASSERT
((
¥dk_mbr_·¹™iÚ_’Œy
) == 16, "size incorrect");

75 
	s¥dk_mbr
 {

76 
ušt8_t
 
	mboÙ_code
[440];

77 
ušt32_t
 
	mdisk_sigÇtu»
;

78 
ušt16_t
 
	m»£rved_444
;

79 
¥dk_mbr_·¹™iÚ_’Œy
 
	m·¹™iÚs
[4];

80 
ušt16_t
 
	mmbr_sigÇtu»
;

82 
SPDK_STATIC_ASSERT
((
¥dk_mbr
) == 512, "size incorrect");

84 
	#SPDK_GPT_SIGNATURE
 "EFI PART"

	)

86 
	#SPDK_GPT_REVISION_1_0
 0x00010000u

	)

88 
	s¥dk_g±_guid
 {

89 
ušt8_t
 
	m¿w
[16];

91 
SPDK_STATIC_ASSERT
((
¥dk_g±_guid
) == 16, "size incorrect");

93 
	#SPDK_GPT_GUID
(
a
, 
b
, 
c
, 
d
, 
e
) \

94 (
¥dk_g±_guid
){{ \

95 (
ušt8_t
)(
a
), (ušt8_t)(((
ušt32_t
)a) >> 8), \

96 (
ušt8_t
)(((
ušt32_t
)
a
) >> 16), (uint8_t)(((uint32_t)a >> 24)), \

97 (
ušt8_t
)(
b
), (ušt8_t)(((
ušt16_t
)b) >> 8), \

98 (
ušt8_t
)(
c
), (ušt8_t)(((
ušt16_t
)c) >> 8), \

99 (
ušt8_t
)(((
ušt16_t
)
d
) >> 8), (uint8_t)(d), \

100 (
ušt8_t
)(((
ušt64_t
)
e
) >> 40), (uint8_t)(((uint64_t)e) >> 32), (uint8_t)(((uint64_t)e) >> 24), \

101 (
ušt8_t
)(((
ušt64_t
)
e
) >> 16), (uint8_t)(((uint64_t)e) >> 8), (uint8_t)(e) \

102 }}

	)

104 
	#SPDK_GPT_PART_TYPE_UNUSED
 
	`SPDK_GPT_GUID
(0x00000000, 0x0000, 0x0000, 0x0000, 0x000000000000)

	)

105 
	#SPDK_GPT_PART_TYPE_EFI_SYSTEM_PARTITION
 
	`SPDK_GPT_GUID
(0xC12A7328, 0xF81F, 0x11D2, 0xBA4B, 0x00A0C93EC93B)

	)

106 
	#SPDK_GPT_PART_TYPE_LEGACY_MBR
 
	`SPDK_GPT_GUID
(0x024DEE41, 0x33E7, 0x11D3, 0x9D69, 0x0008C781F39F)

	)

108 
	s¥dk_g±_h—d”
 {

109 
	mg±_sigÇtu»
[8];

110 
ušt32_t
 
	m»visiÚ
;

111 
ušt32_t
 
	mh—d”_size
;

112 
ušt32_t
 
	mh—d”_üc32
;

113 
ušt32_t
 
	m»£rved
;

114 
ušt64_t
 
	mmy_lba
;

115 
ušt64_t
 
	m®‹º©e_lba
;

116 
ušt64_t
 
	mfœ¡_u§bË_lba
;

117 
ušt64_t
 
	mÏ¡_u§bË_lba
;

118 
¥dk_g±_guid
 
	mdisk_guid
;

119 
ušt64_t
 
	m·¹™iÚ_’Œy_lba
;

120 
ušt32_t
 
	mnum_·¹™iÚ_’Œ›s
;

121 
ušt32_t
 
	msize_of_·¹™iÚ_’Œy
;

122 
ušt32_t
 
	m·¹™iÚ_’Œy_¬¿y_üc32
;

124 
SPDK_STATIC_ASSERT
((
¥dk_g±_h—d”
) == 92, "size incorrect");

126 
	s¥dk_g±_·¹™iÚ_’Œy
 {

127 
¥dk_g±_guid
 
	m·¹_ty³_guid
;

128 
¥dk_g±_guid
 
	munique_·¹™iÚ_guid
;

129 
ušt64_t
 
	m¡¬tšg_lba
;

130 
ušt64_t
 
	m’dšg_lba
;

132 
ušt64_t
 
	m»quœed
 : 1;

133 
ušt64_t
 
	mno_block_io_´Ùo
 : 1;

134 
ušt64_t
 
	mËgacy_bios_boÙabË
 : 1;

135 
ušt64_t
 
	m»£rved_uefi
 : 45;

136 
ušt64_t
 
	mguid_¥ecific
 : 16;

137 } 
	m©Œ
;

138 
ušt8_t
 
	m·¹™iÚ_Çme
[72];

140 
SPDK_STATIC_ASSERT
((
¥dk_g±_·¹™iÚ_’Œy
) == 128, "size incorrect");

142 #´agm¨
·ck
(
pİ
)

	@PDK/core/src/api/include/udd/spdk/io_channel.h

38 #iâdeà
SPDK_IO_CHANNEL_H_


39 
	#SPDK_IO_CHANNEL_H_


	)

41 
	~"¥dk/¡dšc.h
"

43 
	~"¥dk/queue.h
"

45 
	#SPDK_IO_PRIORITY_DEFAULT
 100

	)

47 
	g¥dk_io_chªÃl
;

49 (*
	tio_chªÃl_ü—‹_cb_t
)(*
	tio_deviû
, 
	tušt32_t
 
	t´iÜ™y
, *
	tùx_buf
,

50 *
	tunique_ùx
);

51 (*
	tio_chªÃl_de¡roy_cb_t
)(*
	tio_deviû
, *
	tùx_buf
);

56 
	`¥dk_®loÿ‹_th»ad
();

64 
	`¥dk_ä“_th»ad
();

76 
	`¥dk_io_deviû_»gi¡”
(*
io_deviû
, 
io_chªÃl_ü—‹_cb_t
 
ü—‹_cb
,

77 
io_chªÃl_de¡roy_cb_t
 
de¡roy_cb
, 
ušt32_t
 
ùx_size
);

85 
	`¥dk_io_deviû_uÄegi¡”
(*
io_deviû
);

107 
¥dk_io_chªÃl
 *
	`¥dk_g‘_io_chªÃl
(*
io_deviû
, 
ušt32_t
 
´iÜ™y
, 
boŞ
 
unique
,

108 *
unique_ùx
);

118 
	`¥dk_put_io_chªÃl
(
¥dk_io_chªÃl
 *
ch
);

123 *
	`¥dk_io_chªÃl_g‘_ùx
(
¥dk_io_chªÃl
 *
ch
);

	@PDK/core/src/api/include/udd/spdk/ioat.h

38 #iâdeà
SPDK_IOAT_H


39 
	#SPDK_IOAT_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
	~"¥dk/’v.h
"

52 
¥dk_ißt_chª
;

59 (*
¥dk_ißt_»q_cb
)(*
	t¬g
);

69 
boŞ
 (*
	t¥dk_ißt_´obe_cb
)(*
	tcb_ùx
, 
	t¥dk_pci_deviû
 *
	tpci_dev
);

78 (*
¥dk_ißt_©ch_cb
)(*
	tcb_ùx
, 
	t¥dk_pci_deviû
 *
	tpci_dev
,

79 
	t¥dk_ißt_chª
 *
	tißt
);

96 
¥dk_ißt_´obe
(*
cb_ùx
, 
¥dk_ißt_´obe_cb
 
´obe_cb
, 
¥dk_ißt_©ch_cb
 
©ch_cb
);

103 
¥dk_ißt_d‘ach
(
¥dk_ißt_chª
 *
ißt
);

115 
št64_t
 
¥dk_ißt_subm™_cİy
(
¥dk_ißt_chª
 *
chª
,

116 *
cb_¬g
, 
¥dk_ißt_»q_cb
 
cb_â
,

117 *
d¡
, cÚ¡ *
¤c
, 
ušt64_t
 
nby‹s
);

129 
št64_t
 
¥dk_ißt_subm™_fl
(
¥dk_ißt_chª
 *
chª
,

130 *
cb_¬g
, 
¥dk_ißt_»q_cb
 
cb_â
,

131 *
d¡
, 
ušt64_t
 
fl_·‰”n
, ušt64_ˆ
nby‹s
);

140 
¥dk_ißt_´oûss_ev’ts
(
¥dk_ißt_chª
 *
chª
);

145 
	e¥dk_ißt_dma_ÿ·b™y_æags
 {

146 
SPDK_IOAT_ENGINE_COPY_SUPPORTED
 = 0x1,

147 
SPDK_IOAT_ENGINE_FILL_SUPPORTED
 = 0x2,

157 
ušt32_t
 
¥dk_ißt_g‘_dma_ÿ·b™›s
(
¥dk_ißt_chª
 *
chª
);

159 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/ioat_spec.h

39 #iâdeà
SPDK_IOAT_SPEC_H


40 
	#SPDK_IOAT_SPEC_H


	)

42 
	~"¥dk/¡dšc.h
"

44 #ifdeà
__ılu¥lus


48 
	~"¥dk/as£¹.h
"

50 
	#SPDK_IOAT_INTRCTRL_MASTER_INT_EN
 0x01

	)

52 
	#SPDK_IOAT_VER_3_0
 0x30

	)

53 
	#SPDK_IOAT_VER_3_3
 0x33

	)

56 
	#SPDK_IOAT_CHANCTRL_CHANNEL_PRIORITY_MASK
 0xF000

	)

57 
	#SPDK_IOAT_CHANCTRL_COMPL_DCA_EN
 0x0200

	)

58 
	#SPDK_IOAT_CHANCTRL_CHANNEL_IN_USE
 0x0100

	)

59 
	#SPDK_IOAT_CHANCTRL_DESCRIPTOR_ADDR_SNOOP_CONTROL
 0x0020

	)

60 
	#SPDK_IOAT_CHANCTRL_ERR_INT_EN
 0x0010

	)

61 
	#SPDK_IOAT_CHANCTRL_ANY_ERR_ABORT_EN
 0x0008

	)

62 
	#SPDK_IOAT_CHANCTRL_ERR_COMPLETION_EN
 0x0004

	)

63 
	#SPDK_IOAT_CHANCTRL_INT_REARM
 0x0001

	)

66 
	#SPDK_IOAT_DMACAP_PB
 (1 << 0)

	)

67 
	#SPDK_IOAT_DMACAP_DCA
 (1 << 4)

	)

68 
	#SPDK_IOAT_DMACAP_BFILL
 (1 << 6)

	)

69 
	#SPDK_IOAT_DMACAP_XOR
 (1 << 8)

	)

70 
	#SPDK_IOAT_DMACAP_PQ
 (1 << 9)

	)

71 
	#SPDK_IOAT_DMACAP_DMA_DIF
 (1 << 10)

	)

73 
	s¥dk_ißt_»gi¡”s
 {

74 
ušt8_t
 
chªút
;

75 
ušt8_t
 
xãrÿp
;

76 
ušt8_t
 
g’ù¾
;

77 
ušt8_t
 
šŒù¾
;

78 
ušt32_t
 
©Š¡©us
;

79 
ušt8_t
 
cbv”
;

80 
ušt8_t
 
»£rved4
[0x3];

81 
ušt16_t
 
šŒd–ay
;

82 
ušt16_t
 
cs_¡©us
;

83 
ušt32_t
 
dmaÿ·b™y
;

84 
ušt8_t
 
»£rved5
[0x6C];

85 
ušt16_t
 
chªù¾
;

86 
ušt8_t
 
»£rved6
[0x2];

87 
ušt8_t
 
chªcmd
;

88 
ušt8_t
 
»£rved3
[1];

89 
ušt16_t
 
dmacouÁ
;

90 
ušt64_t
 
chª¡s
;

91 
ušt64_t
 
chašaddr
;

92 
ušt64_t
 
chªcmp
;

93 
ušt8_t
 
»£rved2
[0x8];

94 
ušt32_t
 
chª”r
;

95 
ušt32_t
 
chª”rmask
;

96 } 
__©Œibu‹__
((
·cked
));

98 
	#SPDK_IOAT_CHANCMD_RESET
 0x20

	)

99 
	#SPDK_IOAT_CHANCMD_SUSPEND
 0x04

	)

101 
	#SPDK_IOAT_CHANSTS_STATUS
 0x7ULL

	)

102 
	#SPDK_IOAT_CHANSTS_ACTIVE
 0x0

	)

103 
	#SPDK_IOAT_CHANSTS_IDLE
 0x1

	)

104 
	#SPDK_IOAT_CHANSTS_SUSPENDED
 0x2

	)

105 
	#SPDK_IOAT_CHANSTS_HALTED
 0x3

	)

106 
	#SPDK_IOAT_CHANSTS_ARMED
 0x4

	)

108 
	#SPDK_IOAT_CHANSTS_UNAFFILIATED_ERROR
 0x8ULL

	)

109 
	#SPDK_IOAT_CHANSTS_SOFT_ERROR
 0x10ULL

	)

111 
	#SPDK_IOAT_CHANSTS_COMPLETED_DESCRIPTOR_MASK
 (~0x3FULL)

	)

113 
	#SPDK_IOAT_CHANCMP_ALIGN
 8

	)

115 
	s¥dk_ißt_g’”ic_hw_desc
 {

116 
ušt32_t
 
size
;

118 
ušt32_t
 
cÚŒŞ_¿w
;

120 
ušt32_t
 
št_’abË
: 1;

121 
ušt32_t
 
¤c_¢oİ_di§bË
: 1;

122 
ušt32_t
 
de¡_¢oİ_di§bË
: 1;

123 
ušt32_t
 
com¶‘iÚ_upd©e
: 1;

124 
ušt32_t
 
ãnû
: 1;

125 
ušt32_t
 
»£rved2
: 1;

126 
ušt32_t
 
¤c_·ge_b»ak
: 1;

127 
ušt32_t
 
de¡_·ge_b»ak
: 1;

128 
ušt32_t
 
bundË
: 1;

129 
ušt32_t
 
de¡_dÿ
: 1;

130 
ušt32_t
 
hšt
: 1;

131 
ušt32_t
 
»£rved
: 13;

132 
ušt32_t
 
İ
: 8;

133 } 
cÚŒŞ
;

134 } 
u
;

135 
ušt64_t
 
¤c_addr
;

136 
ušt64_t
 
de¡_addr
;

137 
ušt64_t
 
Ãxt
;

138 
ušt64_t
 
İ_¥ecific
[4];

141 
	s¥dk_ißt_dma_hw_desc
 {

142 
ušt32_t
 
size
;

144 
ušt32_t
 
cÚŒŞ_¿w
;

146 
ušt32_t
 
št_’abË
: 1;

147 
ušt32_t
 
¤c_¢oİ_di§bË
: 1;

148 
ušt32_t
 
de¡_¢oİ_di§bË
: 1;

149 
ušt32_t
 
com¶‘iÚ_upd©e
: 1;

150 
ušt32_t
 
ãnû
: 1;

151 
ušt32_t
 
nuÎ
: 1;

152 
ušt32_t
 
¤c_·ge_b»ak
: 1;

153 
ušt32_t
 
de¡_·ge_b»ak
: 1;

154 
ušt32_t
 
bundË
: 1;

155 
ušt32_t
 
de¡_dÿ
: 1;

156 
ušt32_t
 
hšt
: 1;

157 
ušt32_t
 
»£rved
: 13;

158 
	#SPDK_IOAT_OP_COPY
 0x00

	)

159 
ušt32_t
 
İ
: 8;

160 } 
cÚŒŞ
;

161 } 
u
;

162 
ušt64_t
 
¤c_addr
;

163 
ušt64_t
 
de¡_addr
;

164 
ušt64_t
 
Ãxt
;

165 
ušt64_t
 
»£rved
;

166 
ušt64_t
 
»£rved2
;

167 
ušt64_t
 
u£r1
;

168 
ušt64_t
 
u£r2
;

171 
	s¥dk_ißt_fl_hw_desc
 {

172 
ušt32_t
 
size
;

174 
ušt32_t
 
cÚŒŞ_¿w
;

176 
ušt32_t
 
št_’abË
: 1;

177 
ušt32_t
 
»£rved
: 1;

178 
ušt32_t
 
de¡_¢oİ_di§bË
: 1;

179 
ušt32_t
 
com¶‘iÚ_upd©e
: 1;

180 
ušt32_t
 
ãnû
: 1;

181 
ušt32_t
 
»£rved2
: 2;

182 
ušt32_t
 
de¡_·ge_b»ak
: 1;

183 
ušt32_t
 
bundË
: 1;

184 
ušt32_t
 
»£rved3
: 15;

185 
	#SPDK_IOAT_OP_FILL
 0x01

	)

186 
ušt32_t
 
İ
: 8;

187 } 
cÚŒŞ
;

188 } 
u
;

189 
ušt64_t
 
¤c_d©a
;

190 
ušt64_t
 
de¡_addr
;

191 
ušt64_t
 
Ãxt
;

192 
ušt64_t
 
»£rved
;

193 
ušt64_t
 
Ãxt_de¡_addr
;

194 
ušt64_t
 
u£r1
;

195 
ušt64_t
 
u£r2
;

198 
	s¥dk_ißt_xÜ_hw_desc
 {

199 
ušt32_t
 
size
;

201 
ušt32_t
 
cÚŒŞ_¿w
;

203 
ušt32_t
 
št_’abË
: 1;

204 
ušt32_t
 
¤c_¢oİ_di§bË
: 1;

205 
ušt32_t
 
de¡_¢oİ_di§bË
: 1;

206 
ušt32_t
 
com¶‘iÚ_upd©e
: 1;

207 
ušt32_t
 
ãnû
: 1;

208 
ušt32_t
 
¤c_couÁ
: 3;

209 
ušt32_t
 
bundË
: 1;

210 
ušt32_t
 
de¡_dÿ
: 1;

211 
ušt32_t
 
hšt
: 1;

212 
ušt32_t
 
»£rved
: 13;

213 
	#SPDK_IOAT_OP_XOR
 0x87

	)

214 
	#SPDK_IOAT_OP_XOR_VAL
 0x88

	)

215 
ušt32_t
 
İ
: 8;

216 } 
cÚŒŞ
;

217 } 
u
;

218 
ušt64_t
 
¤c_addr
;

219 
ušt64_t
 
de¡_addr
;

220 
ušt64_t
 
Ãxt
;

221 
ušt64_t
 
¤c_addr2
;

222 
ušt64_t
 
¤c_addr3
;

223 
ušt64_t
 
¤c_addr4
;

224 
ušt64_t
 
¤c_addr5
;

227 
	s¥dk_ißt_xÜ_ext_hw_desc
 {

228 
ušt64_t
 
¤c_addr6
;

229 
ušt64_t
 
¤c_addr7
;

230 
ušt64_t
 
¤c_addr8
;

231 
ušt64_t
 
Ãxt
;

232 
ušt64_t
 
»£rved
[4];

235 
	s¥dk_ißt_pq_hw_desc
 {

236 
ušt32_t
 
size
;

238 
ušt32_t
 
cÚŒŞ_¿w
;

240 
ušt32_t
 
št_’abË
: 1;

241 
ušt32_t
 
¤c_¢oİ_di§bË
: 1;

242 
ušt32_t
 
de¡_¢oİ_di§bË
: 1;

243 
ušt32_t
 
com¶‘iÚ_upd©e
: 1;

244 
ušt32_t
 
ãnû
: 1;

245 
ušt32_t
 
¤c_couÁ
: 3;

246 
ušt32_t
 
bundË
: 1;

247 
ušt32_t
 
de¡_dÿ
: 1;

248 
ušt32_t
 
hšt
: 1;

249 
ušt32_t
 
p_di§bË
: 1;

250 
ušt32_t
 
q_di§bË
: 1;

251 
ušt32_t
 
»£rved
: 11;

252 
	#SPDK_IOAT_OP_PQ
 0x89

	)

253 
	#SPDK_IOAT_OP_PQ_VAL
 0x8a

	)

254 
ušt32_t
 
İ
: 8;

255 } 
cÚŒŞ
;

256 } 
u
;

257 
ušt64_t
 
¤c_addr
;

258 
ušt64_t
 
p_addr
;

259 
ušt64_t
 
Ãxt
;

260 
ušt64_t
 
¤c_addr2
;

261 
ušt64_t
 
¤c_addr3
;

262 
ušt8_t
 
cÛf
[8];

263 
ušt64_t
 
q_addr
;

266 
	s¥dk_ißt_pq_ext_hw_desc
 {

267 
ušt64_t
 
¤c_addr4
;

268 
ušt64_t
 
¤c_addr5
;

269 
ušt64_t
 
¤c_addr6
;

270 
ušt64_t
 
Ãxt
;

271 
ušt64_t
 
¤c_addr7
;

272 
ušt64_t
 
¤c_addr8
;

273 
ušt64_t
 
»£rved
[2];

276 
	s¥dk_ißt_pq_upd©e_hw_desc
 {

277 
ušt32_t
 
size
;

279 
ušt32_t
 
cÚŒŞ_¿w
;

281 
ušt32_t
 
št_’abË
: 1;

282 
ušt32_t
 
¤c_¢oİ_di§bË
: 1;

283 
ušt32_t
 
de¡_¢oİ_di§bË
: 1;

284 
ušt32_t
 
com¶‘iÚ_upd©e
: 1;

285 
ušt32_t
 
ãnû
: 1;

286 
ušt32_t
 
¤c_út
: 3;

287 
ušt32_t
 
bundË
: 1;

288 
ušt32_t
 
de¡_dÿ
: 1;

289 
ušt32_t
 
hšt
: 1;

290 
ušt32_t
 
p_di§bË
: 1;

291 
ušt32_t
 
q_di§bË
: 1;

292 
ušt32_t
 
»£rved
: 3;

293 
ušt32_t
 
cÛf
: 8;

294 
	#SPDK_IOAT_OP_PQ_UP
 0x8b

	)

295 
ušt32_t
 
İ
: 8;

296 } 
cÚŒŞ
;

297 } 
u
;

298 
ušt64_t
 
¤c_addr
;

299 
ušt64_t
 
p_addr
;

300 
ušt64_t
 
Ãxt
;

301 
ušt64_t
 
¤c_addr2
;

302 
ušt64_t
 
p_¤c
;

303 
ušt64_t
 
q_¤c
;

304 
ušt64_t
 
q_addr
;

307 
	s¥dk_ißt_¿w_hw_desc
 {

308 
ušt64_t
 
f›ld
[8];

311 
	u¥dk_ißt_hw_desc
 {

312 
¥dk_ißt_¿w_hw_desc
 
¿w
;

313 
¥dk_ißt_g’”ic_hw_desc
 
g’”ic
;

314 
¥dk_ißt_dma_hw_desc
 
dma
;

315 
¥dk_ißt_fl_hw_desc
 
fl
;

316 
¥dk_ißt_xÜ_hw_desc
 
xÜ_desc
;

317 
¥dk_ißt_xÜ_ext_hw_desc
 
xÜ_ext
;

318 
¥dk_ißt_pq_hw_desc
 
pq
;

319 
¥dk_ißt_pq_ext_hw_desc
 
pq_ext
;

320 
¥dk_ißt_pq_upd©e_hw_desc
 
pq_upd©e
;

322 
SPDK_STATIC_ASSERT
((
¥dk_ißt_hw_desc
) == 64, "incorrect spdk_ioat_hw_desc†ayout");

324 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/iscsi_spec.h

40 #iâdeà
SPDK_ISCSI_SPEC_H


41 
	#SPDK_ISCSI_SPEC_H


	)

43 
	~"¥dk/¡dšc.h
"

45 
	~"¥dk/as£¹.h
"

47 
	#ISCSI_BHS_LEN
 48

	)

48 
	#ISCSI_DIGEST_LEN
 4

	)

49 
	#ISCSI_ALIGNMENT
 4

	)

52 
	#ISCSI_VERSION
 0x00

	)

54 
	#ISCSI_ALIGN
(
SIZE
) \

55 (((
SIZE
è+ (
ISCSI_ALIGNMENT
 - 1)è& ~(ISCSI_ALIGNMENT - 1))

	)

58 
	#ISCSI_TEXT_MAX_VAL_LEN
 8192

	)

66 
	#ISCSI_TEXT_MAX_SIMPLE_VAL_LEN
 255

	)

68 
	#ISCSI_TEXT_MAX_KEY_LEN
 63

	)

70 
	eiscsi_İ
 {

72 
	mISCSI_OP_NOPOUT
 = 0x00,

73 
	mISCSI_OP_SCSI
 = 0x01,

74 
	mISCSI_OP_TASK
 = 0x02,

75 
	mISCSI_OP_LOGIN
 = 0x03,

76 
	mISCSI_OP_TEXT
 = 0x04,

77 
	mISCSI_OP_SCSI_DATAOUT
 = 0x05,

78 
	mISCSI_OP_LOGOUT
 = 0x06,

79 
	mISCSI_OP_SNACK
 = 0x10,

80 
	mISCSI_OP_VENDOR_1C
 = 0x1c,

81 
	mISCSI_OP_VENDOR_1D
 = 0x1d,

82 
	mISCSI_OP_VENDOR_1E
 = 0x1e,

85 
	mISCSI_OP_NOPIN
 = 0x20,

86 
	mISCSI_OP_SCSI_RSP
 = 0x21,

87 
	mISCSI_OP_TASK_RSP
 = 0x22,

88 
	mISCSI_OP_LOGIN_RSP
 = 0x23,

89 
	mISCSI_OP_TEXT_RSP
 = 0x24,

90 
	mISCSI_OP_SCSI_DATAIN
 = 0x25,

91 
	mISCSI_OP_LOGOUT_RSP
 = 0x26,

92 
	mISCSI_OP_R2T
 = 0x31,

93 
	mISCSI_OP_ASYNC
 = 0x32,

94 
	mISCSI_OP_VENDOR_3C
 = 0x3c,

95 
	mISCSI_OP_VENDOR_3D
 = 0x3d,

96 
	mISCSI_OP_VENDOR_3E
 = 0x3e,

97 
	mISCSI_OP_REJECT
 = 0x3f,

100 
	eiscsi_sk_func
 {

101 
	mISCSI_TASK_FUNC_ABORT_TASK
 = 1,

102 
	mISCSI_TASK_FUNC_ABORT_TASK_SET
 = 2,

103 
	mISCSI_TASK_FUNC_CLEAR_ACA
 = 3,

104 
	mISCSI_TASK_FUNC_CLEAR_TASK_SET
 = 4,

105 
	mISCSI_TASK_FUNC_LOGICAL_UNIT_RESET
 = 5,

106 
	mISCSI_TASK_FUNC_TARGET_WARM_RESET
 = 6,

107 
	mISCSI_TASK_FUNC_TARGET_COLD_RESET
 = 7,

108 
	mISCSI_TASK_FUNC_TASK_REASSIGN
 = 8,

111 
	eiscsi_sk_func_»¥
 {

112 
	mISCSI_TASK_FUNC_RESP_COMPLETE
 = 0,

113 
	mISCSI_TASK_FUNC_RESP_TASK_NOT_EXIST
 = 1,

114 
	mISCSI_TASK_FUNC_RESP_LUN_NOT_EXIST
 = 2,

115 
	mISCSI_TASK_FUNC_RESP_TASK_STILL_ALLEGIANT
 = 3,

116 
	mISCSI_TASK_FUNC_RESP_REASSIGNMENT_NOT_SUPPORTED
 = 4,

117 
	mISCSI_TASK_FUNC_RESP_FUNC_NOT_SUPPORTED
 = 5,

118 
	mISCSI_TASK_FUNC_RESP_AUTHORIZATION_FAILED
 = 6,

119 
	mISCSI_TASK_FUNC_REJECTED
 = 255

122 
	siscsi_bhs
 {

123 
ušt8_t
 
	mİcode
 : 6;

124 
ušt8_t
 
	mimmedŸ‹
 : 1;

125 
ušt8_t
 
	m»£rved
 : 1;

126 
ušt8_t
 
	mæags
;

127 
ušt8_t
 
	mrsv
[2];

128 
ušt8_t
 
	mtÙ®_ahs_Ën
;

129 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

130 
ušt64_t
 
	mlun
;

131 
ušt32_t
 
	m™t
;

132 
ušt32_t
 
	m‰t
;

133 
ušt32_t
 
	m¡©_¢
;

134 
ušt32_t
 
	mexp_¡©_¢
;

135 
ušt32_t
 
	mmax_¡©_¢
;

136 
ušt8_t
 
	m»s3
[12];

138 
SPDK_STATIC_ASSERT
((
iscsi_bhs
è=ğ
ISCSI_BHS_LEN
, "ISCSI_BHS_LEN mismatch");

140 
	siscsi_bhs_async
 {

141 
ušt8_t
 
	mİcode
 : 6;

142 
ušt8_t
 
	m»£rved
 : 2;

143 
ušt8_t
 
	mæags
;

144 
ušt8_t
 
	m»s
[2];

146 
ušt8_t
 
	mtÙ®_ahs_Ën
;

147 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

149 
ušt64_t
 
	mlun
;

150 
ušt32_t
 
	mffffffff
;

151 
ušt32_t
 
	m»s3
;

152 
ušt32_t
 
	m¡©_¢
;

153 
ušt32_t
 
	mexp_cmd_¢
;

154 
ušt32_t
 
	mmax_cmd_¢
;

155 
ušt8_t
 
	masync_ev’t
;

156 
ušt8_t
 
	masync_vcode
;

157 
ušt16_t
 
	m·¿m1
;

158 
ušt16_t
 
	m·¿m2
;

159 
ušt16_t
 
	m·¿m3
;

160 
ušt8_t
 
	m»s4
[4];

163 
	siscsi_bhs_logš_»q
 {

164 
ušt8_t
 
	mİcode
 : 6;

165 
ušt8_t
 
	mimmedŸ‹
 : 1;

166 
ušt8_t
 
	m»£rved
 : 1;

167 
ušt8_t
 
	mæags
;

168 
ušt8_t
 
	mv”siÚ_max
;

169 
ušt8_t
 
	mv”siÚ_mš
;

170 
ušt8_t
 
	mtÙ®_ahs_Ën
;

171 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

172 
ušt8_t
 
	misid
[6];

173 
ušt16_t
 
	mtsih
;

174 
ušt32_t
 
	m™t
;

175 
ušt16_t
 
	mcid
;

176 
ušt16_t
 
	m»s2
;

177 
ušt32_t
 
	mcmd_¢
;

178 
ušt32_t
 
	mexp_¡©_¢
;

179 
ušt8_t
 
	m»s3
[16];

182 
	siscsi_bhs_logš_r¥
 {

183 
ušt8_t
 
	mİcode
 : 6;

184 
ušt8_t
 
	m»£rved
 : 2;

185 
ušt8_t
 
	mæags
;

186 
ušt8_t
 
	mv”siÚ_max
;

187 
ušt8_t
 
	mv”siÚ_aù
;

188 
ušt8_t
 
	mtÙ®_ahs_Ën
;

189 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

190 
ušt8_t
 
	misid
[6];

191 
ušt16_t
 
	mtsih
;

192 
ušt32_t
 
	m™t
;

193 
ušt32_t
 
	m»s2
;

194 
ušt32_t
 
	m¡©_¢
;

195 
ušt32_t
 
	mexp_cmd_¢
;

196 
ušt32_t
 
	mmax_cmd_¢
;

197 
ušt8_t
 
	m¡©us_şass
;

198 
ušt8_t
 
	m¡©us_d‘a
;

199 
ušt8_t
 
	m»s3
[10];

202 
	siscsi_bhs_logout_»q
 {

203 
ušt8_t
 
	mİcode
 : 6;

204 
ušt8_t
 
	mimmedŸ‹
 : 1;

205 
ušt8_t
 
	m»£rved
 : 1;

206 
ušt8_t
 
	m»asÚ
;

207 
ušt8_t
 
	m»s
[2];

208 
ušt8_t
 
	mtÙ®_ahs_Ën
;

209 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

210 
ušt8_t
 
	m»s2
[8];

211 
ušt32_t
 
	m™t
;

212 
ušt16_t
 
	mcid
;

213 
ušt16_t
 
	m»s3
;

214 
ušt32_t
 
	mcmd_¢
;

215 
ušt32_t
 
	mexp_¡©_¢
;

216 
ušt8_t
 
	m»s4
[16];

219 
	siscsi_bhs_logout_»¥
 {

220 
ušt8_t
 
	mİcode
 : 6;

221 
ušt8_t
 
	m»£rved
 : 2;

222 
ušt8_t
 
	mæags
;

223 
ušt8_t
 
	m»¥Ú£
;

224 
ušt8_t
 
	m»s
;

225 
ušt8_t
 
	mtÙ®_ahs_Ën
;

226 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

227 
ušt8_t
 
	m»s2
[8];

228 
ušt32_t
 
	m™t
;

229 
ušt32_t
 
	m»s3
;

230 
ušt32_t
 
	m¡©_¢
;

231 
ušt32_t
 
	mexp_cmd_¢
;

232 
ušt32_t
 
	mmax_cmd_¢
;

233 
ušt32_t
 
	m»s4
;

234 
ušt16_t
 
	mtime_2_wa™
;

235 
ušt16_t
 
	mtime_2_»š
;

236 
ušt32_t
 
	m»s5
;

239 
	siscsi_bhs_nİ_š
 {

240 
ušt8_t
 
	mİcode
 : 6;

241 
ušt8_t
 
	m»£rved
 : 2;

242 
ušt8_t
 
	mæags
;

243 
ušt8_t
 
	m»s
[2];

244 
ušt8_t
 
	mtÙ®_ahs_Ën
;

245 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

246 
ušt64_t
 
	mlun
;

247 
ušt32_t
 
	m™t
;

248 
ušt32_t
 
	m‰t
;

249 
ušt32_t
 
	m¡©_¢
;

250 
ušt32_t
 
	mexp_cmd_¢
;

251 
ušt32_t
 
	mmax_cmd_¢
;

252 
ušt8_t
 
	m»s3
[12];

255 
	siscsi_bhs_nİ_out
 {

256 
ušt8_t
 
	mİcode
 : 6;

257 
ušt8_t
 
	mimmedŸ‹
 : 1;

258 
ušt8_t
 
	m»£rved
 : 1;

259 
ušt8_t
 
	mæags
;

260 
ušt8_t
 
	m»s
[2];

261 
ušt8_t
 
	mtÙ®_ahs_Ën
;

262 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

263 
ušt64_t
 
	mlun
;

264 
ušt32_t
 
	m™t
;

265 
ušt32_t
 
	m‰t
;

266 
ušt32_t
 
	mcmd_¢
;

267 
ušt32_t
 
	mexp_¡©_¢
;

268 
ušt8_t
 
	m»s4
[16];

271 
	siscsi_bhs_r2t
 {

272 
ušt8_t
 
	mİcode
 : 6;

273 
ušt8_t
 
	m»£rved
 : 2;

274 
ušt8_t
 
	mæags
;

275 
ušt8_t
 
	mrsv
[2];

276 
ušt8_t
 
	mtÙ®_ahs_Ën
;

277 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

278 
ušt64_t
 
	mlun
;

279 
ušt32_t
 
	m™t
;

280 
ušt32_t
 
	m‰t
;

281 
ušt32_t
 
	m¡©_¢
;

282 
ušt32_t
 
	mexp_cmd_¢
;

283 
ušt32_t
 
	mmax_cmd_¢
;

284 
ušt32_t
 
	mr2t_¢
;

285 
ušt32_t
 
	mbufãr_off£t
;

286 
ušt32_t
 
	mdesœed_xãr_Ën
;

289 
	siscsi_bhs_»jeù
 {

290 
ušt8_t
 
	mİcode
 : 6;

291 
ušt8_t
 
	m»£rved
 : 2;

292 
ušt8_t
 
	mæags
;

293 
ušt8_t
 
	m»asÚ
;

294 
ušt8_t
 
	m»s
;

295 
ušt8_t
 
	mtÙ®_ahs_Ën
;

296 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

297 
ušt8_t
 
	m»s2
[8];

298 
ušt32_t
 
	mffffffff
;

299 
ušt32_t
 
	m»s3
;

300 
ušt32_t
 
	m¡©_¢
;

301 
ušt32_t
 
	mexp_cmd_¢
;

302 
ušt32_t
 
	mmax_cmd_¢
;

303 
ušt32_t
 
	md©a_¢
;

304 
ušt8_t
 
	m»s4
[8];

307 
	siscsi_bhs_scsi_»q
 {

308 
ušt8_t
 
	mİcode
 : 6;

309 
ušt8_t
 
	mimmedŸ‹
 : 1;

310 
ušt8_t
 
	m»£rved
 : 1;

311 
ušt8_t
 
	m©Œibu‹
 : 3;

312 
ušt8_t
 
	m»£rved2
 : 2;

313 
ušt8_t
 
	mwr™e
 : 1;

314 
ušt8_t
 
	m»ad
 : 1;

315 
ušt8_t
 
	mfš®
 : 1;

316 
ušt8_t
 
	m»s
[2];

317 
ušt8_t
 
	mtÙ®_ahs_Ën
;

318 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

319 
ušt64_t
 
	mlun
;

320 
ušt32_t
 
	m™t
;

321 
ušt32_t
 
	mex³ùed_d©a_xãr_Ën
;

322 
ušt32_t
 
	mcmd_¢
;

323 
ušt32_t
 
	mexp_¡©_¢
;

324 
ušt8_t
 
	mcdb
[16];

327 
	siscsi_bhs_scsi_»¥
 {

328 
ušt8_t
 
	mİcode
 : 6;

329 
ušt8_t
 
	m»£rved
 : 2;

330 
ušt8_t
 
	mæags
;

331 
ušt8_t
 
	m»¥Ú£
;

332 
ušt8_t
 
	m¡©us
;

333 
ušt8_t
 
	mtÙ®_ahs_Ën
;

334 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

335 
ušt8_t
 
	m»s4
[8];

336 
ušt32_t
 
	m™t
;

337 
ušt32_t
 
	m¢ackg
;

338 
ušt32_t
 
	m¡©_¢
;

339 
ušt32_t
 
	mexp_cmd_¢
;

340 
ušt32_t
 
	mmax_cmd_¢
;

341 
ušt32_t
 
	mexp_d©a_¢
;

342 
ušt32_t
 
	mbi_»ad_»s_út
;

343 
ušt32_t
 
	m»s_út
;

346 
	siscsi_bhs_d©a_š
 {

347 
ušt8_t
 
	mİcode
 : 6;

348 
ušt8_t
 
	m»£rved
 : 2;

349 
ušt8_t
 
	mæags
;

350 
ušt8_t
 
	m»s
;

351 
ušt8_t
 
	m¡©us
;

352 
ušt8_t
 
	mtÙ®_ahs_Ën
;

353 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

354 
ušt64_t
 
	mlun
;

355 
ušt32_t
 
	m™t
;

356 
ušt32_t
 
	m‰t
;

357 
ušt32_t
 
	m¡©_¢
;

358 
ušt32_t
 
	mexp_cmd_¢
;

359 
ušt32_t
 
	mmax_cmd_¢
;

360 
ušt32_t
 
	md©a_¢
;

361 
ušt32_t
 
	mbufãr_off£t
;

362 
ušt32_t
 
	m»s_út
;

365 
	siscsi_bhs_d©a_out
 {

366 
ušt8_t
 
	mİcode
 : 6;

367 
ušt8_t
 
	m»£rved
 : 2;

368 
ušt8_t
 
	mæags
;

369 
ušt8_t
 
	m»s
[2];

370 
ušt8_t
 
	mtÙ®_ahs_Ën
;

371 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

372 
ušt64_t
 
	mlun
;

373 
ušt32_t
 
	m™t
;

374 
ušt32_t
 
	m‰t
;

375 
ušt32_t
 
	m»s3
;

376 
ušt32_t
 
	mexp_¡©_¢
;

377 
ušt32_t
 
	m»s4
;

378 
ušt32_t
 
	md©a_¢
;

379 
ušt32_t
 
	mbufãr_off£t
;

380 
ušt32_t
 
	m»s5
;

383 
	siscsi_bhs_¢ack_»q
 {

384 
ušt8_t
 
	mİcode
 : 6;

385 
ušt8_t
 
	m»£rved
 : 2;

386 
ušt8_t
 
	mæags
;

387 
ušt8_t
 
	m»s
[2];

388 
ušt8_t
 
	mtÙ®_ahs_Ën
;

389 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

390 
ušt64_t
 
	mlun
;

391 
ušt32_t
 
	m™t
;

392 
ušt32_t
 
	m‰t
;

393 
ušt32_t
 
	m»s5
;

394 
ušt32_t
 
	mexp_¡©_¢
;

395 
ušt8_t
 
	m»s6
[8];

396 
ušt32_t
 
	mbeg_run
;

397 
ušt32_t
 
	mrun_Ën
;

400 
	siscsi_bhs_sk_»q
 {

401 
ušt8_t
 
	mİcode
 : 6;

402 
ušt8_t
 
	mimmedŸ‹
 : 1;

403 
ušt8_t
 
	m»£rved
 : 1;

404 
ušt8_t
 
	mæags
;

405 
ušt8_t
 
	m»s
[2];

406 
ušt8_t
 
	mtÙ®_ahs_Ën
;

407 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

408 
ušt64_t
 
	mlun
;

409 
ušt32_t
 
	m™t
;

410 
ušt32_t
 
	m»f_sk_g
;

411 
ušt32_t
 
	mcmd_¢
;

412 
ušt32_t
 
	mexp_¡©_¢
;

413 
ušt32_t
 
	m»f_cmd_¢
;

414 
ušt32_t
 
	mexp_d©a_¢
;

415 
ušt8_t
 
	m»s5
[8];

418 
	siscsi_bhs_sk_»¥
 {

419 
ušt8_t
 
	mİcode
 : 6;

420 
ušt8_t
 
	m»£rved
 : 2;

421 
ušt8_t
 
	mæags
;

422 
ušt8_t
 
	m»¥Ú£
;

423 
ušt8_t
 
	m»s
;

424 
ušt8_t
 
	mtÙ®_ahs_Ën
;

425 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

426 
ušt8_t
 
	m»s2
[8];

427 
ušt32_t
 
	m™t
;

428 
ušt32_t
 
	m»s3
;

429 
ušt32_t
 
	m¡©_¢
;

430 
ušt32_t
 
	mexp_cmd_¢
;

431 
ušt32_t
 
	mmax_cmd_¢
;

432 
ušt8_t
 
	m»s4
[12];

435 
	siscsi_bhs_‹xt_»q
 {

436 
ušt8_t
 
	mİcode
 : 6;

437 
ušt8_t
 
	mimmedŸ‹
 : 1;

438 
ušt8_t
 
	m»£rved
 : 1;

439 
ušt8_t
 
	mæags
;

440 
ušt8_t
 
	m»s
[2];

441 
ušt8_t
 
	mtÙ®_ahs_Ën
;

442 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

443 
ušt64_t
 
	mlun
;

444 
ušt32_t
 
	m™t
;

445 
ušt32_t
 
	m‰t
;

446 
ušt32_t
 
	mcmd_¢
;

447 
ušt32_t
 
	mexp_¡©_¢
;

448 
ušt8_t
 
	m»s3
[16];

451 
	siscsi_bhs_‹xt_»¥
 {

452 
ušt8_t
 
	mİcode
 : 6;

453 
ušt8_t
 
	m»£rved
 : 2;

454 
ušt8_t
 
	mæags
;

455 
ušt8_t
 
	m»s
[2];

456 
ušt8_t
 
	mtÙ®_ahs_Ën
;

457 
ušt8_t
 
	md©a_£gm’t_Ën
[3];

458 
ušt64_t
 
	mlun
;

459 
ušt32_t
 
	m™t
;

460 
ušt32_t
 
	m‰t
;

461 
ušt32_t
 
	m¡©_¢
;

462 
ušt32_t
 
	mexp_cmd_¢
;

463 
ušt32_t
 
	mmax_cmd_¢
;

464 
ušt8_t
 
	m»s4
[12];

468 
	#ISCSI_FLAG_FINAL
 0x80

	)

471 
	#ISCSI_LOGIN_TRANSIT
 0x80

	)

472 
	#ISCSI_LOGIN_CONTINUE
 0x40

	)

473 
	#ISCSI_LOGIN_CURRENT_STAGE_MASK
 0x0c

	)

474 
	#ISCSI_LOGIN_CURRENT_STAGE_0
 0x04

	)

475 
	#ISCSI_LOGIN_CURRENT_STAGE_1
 0x08

	)

476 
	#ISCSI_LOGIN_CURRENT_STAGE_3
 0x0c

	)

477 
	#ISCSI_LOGIN_NEXT_STAGE_MASK
 0x03

	)

478 
	#ISCSI_LOGIN_NEXT_STAGE_0
 0x01

	)

479 
	#ISCSI_LOGIN_NEXT_STAGE_1
 0x02

	)

480 
	#ISCSI_LOGIN_NEXT_STAGE_3
 0x03

	)

483 
	#ISCSI_TEXT_CONTINUE
 0x40

	)

486 
	#ISCSI_LOGOUT_REASON_MASK
 0x7f

	)

489 
	#ISCSI_DATAIN_ACKNOLWEDGE
 0x40

	)

490 
	#ISCSI_DATAIN_OVERFLOW
 0x04

	)

491 
	#ISCSI_DATAIN_UNDERFLOW
 0x02

	)

492 
	#ISCSI_DATAIN_STATUS
 0x01

	)

495 
	#ISCSI_SCSI_BIDI_OVERFLOW
 0x10

	)

496 
	#ISCSI_SCSI_BIDI_UNDERFLOW
 0x08

	)

497 
	#ISCSI_SCSI_OVERFLOW
 0x04

	)

498 
	#ISCSI_SCSI_UNDERFLOW
 0x02

	)

501 
	#ISCSI_TASK_FUNCTION_MASK
 0x7f

	)

504 
	#ISCSI_REASON_RESERVED
 0x1

	)

505 
	#ISCSI_REASON_DATA_DIGEST_ERROR
 0x2

	)

506 
	#ISCSI_REASON_DATA_SNACK_REJECT
 0x3

	)

507 
	#ISCSI_REASON_PROTOCOL_ERROR
 0x4

	)

508 
	#ISCSI_REASON_CMD_NOT_SUPPORTED
 0x5

	)

509 
	#ISCSI_REASON_IMM_CMD_REJECT
 0x6

	)

510 
	#ISCSI_REASON_TASK_IN_PROGRESS
 0x7

	)

511 
	#ISCSI_REASON_INVALID_SNACK
 0x8

	)

512 
	#ISCSI_REASON_INVALID_PDU_FIELD
 0x9

	)

513 
	#ISCSI_REASON_LONG_OPERATION_REJECT
 0xa

	)

514 
	#ISCSI_REASON_NEGOTIATION_RESET
 0xb

	)

515 
	#ISCSI_REASON_WAIT_FOR_RESET
 0xc

	)

517 
	#ISCSI_FLAG_SNACK_TYPE_DATA
 0

	)

518 
	#ISCSI_FLAG_SNACK_TYPE_R2T
 0

	)

519 
	#ISCSI_FLAG_SNACK_TYPE_STATUS
 1

	)

520 
	#ISCSI_FLAG_SNACK_TYPE_DATA_ACK
 2

	)

521 
	#ISCSI_FLAG_SNACK_TYPE_RDATA
 3

	)

522 
	#ISCSI_FLAG_SNACK_TYPE_MASK
 0x0F

	)

524 
	siscsi_ahs
 {

526 
ušt8_t
 
	mahs_Ën
[2];

527 
ušt8_t
 
	mahs_ty³
;

528 
ušt8_t
 
	mahs_¥ecific1
;

530 
ušt8_t
 
	mahs_¥ecific2
[];

533 
	#ISCSI_BHS_LOGIN_GET_TBIT
(
X
è(!!(X & 
ISCSI_LOGIN_TRANSIT
))

	)

534 
	#ISCSI_BHS_LOGIN_GET_CBIT
(
X
è(!!(X & 
ISCSI_LOGIN_CONTINUE
))

	)

535 
	#ISCSI_BHS_LOGIN_GET_CSG
(
X
è((X & 
ISCSI_LOGIN_CURRENT_STAGE_MASK
è>> 2)

	)

536 
	#ISCSI_BHS_LOGIN_GET_NSG
(
X
è(X & 
ISCSI_LOGIN_NEXT_STAGE_MASK
)

	)

538 
	#ISCSI_CLASS_SUCCESS
 0x00

	)

539 
	#ISCSI_CLASS_REDIRECT
 0x01

	)

540 
	#ISCSI_CLASS_INITIATOR_ERROR
 0x02

	)

541 
	#ISCSI_CLASS_TARGET_ERROR
 0x03

	)

544 
	#ISCSI_LOGIN_ACCEPT
 0x00

	)

547 
	#ISCSI_LOGIN_TARGET_TEMPORARILY_MOVED
 0x01

	)

548 
	#ISCSI_LOGIN_TARGET_PERMANENTLY_MOVED
 0x02

	)

551 
	#ISCSI_LOGIN_INITIATOR_ERROR
 0x00

	)

552 
	#ISCSI_LOGIN_AUTHENT_FAIL
 0x01

	)

553 
	#ISCSI_LOGIN_AUTHORIZATION_FAIL
 0x02

	)

554 
	#ISCSI_LOGIN_TARGET_NOT_FOUND
 0x03

	)

555 
	#ISCSI_LOGIN_TARGET_REMOVED
 0x04

	)

556 
	#ISCSI_LOGIN_UNSUPPORTED_VERSION
 0x05

	)

557 
	#ISCSI_LOGIN_TOO_MANY_CONNECTIONS
 0x06

	)

558 
	#ISCSI_LOGIN_MISSING_PARMS
 0x07

	)

559 
	#ISCSI_LOGIN_CONN_ADD_FAIL
 0x08

	)

560 
	#ISCSI_LOGIN_NOT_SUPPORTED_SESSION_TYPE
 0x09

	)

561 
	#ISCSI_LOGIN_NO_SESSION
 0x0a

	)

562 
	#ISCSI_LOGIN_INVALID_LOGIN_REQUEST
 0x0b

	)

565 
	#ISCSI_LOGIN_STATUS_TARGET_ERROR
 0x00

	)

566 
	#ISCSI_LOGIN_STATUS_SERVICE_UNAVAILABLE
 0x01

	)

567 
	#ISCSI_LOGIN_STATUS_NO_RESOURCES
 0x02

	)

	@PDK/core/src/api/include/udd/spdk/json.h

39 #iâdeà
SPDK_JSON_H_


40 
	#SPDK_JSON_H_


	)

42 
	~"¥dk/¡dšc.h
"

44 
	e¥dk_jsÚ_v®_ty³
 {

45 
	mSPDK_JSON_VAL_INVALID
,

46 
	mSPDK_JSON_VAL_NULL
,

47 
	mSPDK_JSON_VAL_TRUE
,

48 
	mSPDK_JSON_VAL_FALSE
,

49 
	mSPDK_JSON_VAL_NUMBER
,

50 
	mSPDK_JSON_VAL_STRING
,

51 
	mSPDK_JSON_VAL_ARRAY_BEGIN
,

52 
	mSPDK_JSON_VAL_ARRAY_END
,

53 
	mSPDK_JSON_VAL_OBJECT_BEGIN
,

54 
	mSPDK_JSON_VAL_OBJECT_END
,

55 
	mSPDK_JSON_VAL_NAME
,

58 
	s¥dk_jsÚ_v®
 {

68 *
	m¡¬t
;

81 
ušt32_t
 
	mËn
;

86 
¥dk_jsÚ_v®_ty³
 
	mty³
;

92 
	#SPDK_JSON_PARSE_INVALID
 -1

	)

97 
	#SPDK_JSON_PARSE_INCOMPLETE
 -2

	)

99 
	#SPDK_JSON_PARSE_MAX_DEPTH_EXCEEDED
 -3

	)

104 
	#SPDK_JSON_PARSE_FLAG_DECODE_IN_PLACE
 0x000000001

	)

111 
	#SPDK_JSON_PARSE_FLAG_ALLOW_COMMENTS
 0x000000002

	)

128 
ssize_t
 
¥dk_jsÚ_·r£
(*
jsÚ
, 
size_t
 
size
, 
¥dk_jsÚ_v®
 *
v®ues
, size_ˆ
num_v®ues
,

129 **
’d
, 
ušt32_t
 
æags
);

131 (*
	t¥dk_jsÚ_decode_â
)(cÚ¡ 
	t¥dk_jsÚ_v®
 *
	tv®
, *
	tout
);

133 
	s¥dk_jsÚ_objeù_decod”
 {

134 cÚ¡ *
Çme
;

135 
size_t
 
off£t
;

136 
¥dk_jsÚ_decode_â
 
decode_func
;

137 
boŞ
 
İtiÚ®
;

140 
	`¥dk_jsÚ_decode_objeù
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®ues
,

141 cÚ¡ 
¥dk_jsÚ_objeù_decod”
 *
decod”s
, 
size_t
 
num_decod”s
, *
out
);

142 
	`¥dk_jsÚ_decode_¬¿y
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®ues
, 
¥dk_jsÚ_decode_â
 
decode_func
,

143 *
out
, 
size_t
 
max_size
, size_ˆ*
out_size
, size_ˆ
¡ride
);

145 
	`¥dk_jsÚ_decode_boŞ
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, *
out
);

146 
	`¥dk_jsÚ_decode_št32
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, *
out
);

147 
	`¥dk_jsÚ_decode_ušt32
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, *
out
);

148 
	`¥dk_jsÚ_decode_¡ršg
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, *
out
);

160 
size_t
 
	`¥dk_jsÚ_v®_Ën
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
);

167 
boŞ
 
	`¥dk_jsÚ_¡»qu®
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, cÚ¡ *
¡r
);

177 *
	`¥dk_jsÚ_¡rdup
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
);

179 
	`¥dk_jsÚ_numb”_to_doubË
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, *
num
);

180 
	`¥dk_jsÚ_numb”_to_št32
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, 
št32_t
 *
num
);

181 
	`¥dk_jsÚ_numb”_to_ušt32
(cÚ¡ 
¥dk_jsÚ_v®
 *
v®
, 
ušt32_t
 *
num
);

183 
¥dk_jsÚ_wr™e_ùx
;

185 
	#SPDK_JSON_WRITE_FLAG_FORMATTED
 0x00000001

	)

187 (*
	t¥dk_jsÚ_wr™e_cb
)(*
	tcb_ùx
, cÚ¡ *
	td©a
, 
	tsize_t
 
	tsize
);

189 
¥dk_jsÚ_wr™e_ùx
 *
	`¥dk_jsÚ_wr™e_begš
(
¥dk_jsÚ_wr™e_cb
 
wr™e_cb
, *
cb_ùx
,

190 
ušt32_t
 
æags
);

191 
	`¥dk_jsÚ_wr™e_’d
(
¥dk_jsÚ_wr™e_ùx
 *
w
);

192 
	`¥dk_jsÚ_wr™e_nuÎ
(
¥dk_jsÚ_wr™e_ùx
 *
w
);

193 
	`¥dk_jsÚ_wr™e_boŞ
(
¥dk_jsÚ_wr™e_ùx
 *
w
, 
boŞ
 
v®
);

194 
	`¥dk_jsÚ_wr™e_št32
(
¥dk_jsÚ_wr™e_ùx
 *
w
, 
št32_t
 
v®
);

195 
	`¥dk_jsÚ_wr™e_ušt32
(
¥dk_jsÚ_wr™e_ùx
 *
w
, 
ušt32_t
 
v®
);

196 
	`¥dk_jsÚ_wr™e_št64
(
¥dk_jsÚ_wr™e_ùx
 *
w
, 
št64_t
 
v®
);

197 
	`¥dk_jsÚ_wr™e_ušt64
(
¥dk_jsÚ_wr™e_ùx
 *
w
, 
ušt64_t
 
v®
);

198 
	`¥dk_jsÚ_wr™e_¡ršg
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ *
v®
);

199 
	`¥dk_jsÚ_wr™e_¡ršg_¿w
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ *
v®
, 
size_t
 
Ën
);

200 
	$¥dk_jsÚ_wr™e_¡ršg_fmt
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ *
fmt
,

201 ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 2, 3)));

202 
	`¥dk_jsÚ_wr™e_¬¿y_begš
(
¥dk_jsÚ_wr™e_ùx
 *
w
);

203 
	`¥dk_jsÚ_wr™e_¬¿y_’d
(
¥dk_jsÚ_wr™e_ùx
 *
w
);

204 
	`¥dk_jsÚ_wr™e_objeù_begš
(
¥dk_jsÚ_wr™e_ùx
 *
w
);

205 
	`¥dk_jsÚ_wr™e_objeù_’d
(
¥dk_jsÚ_wr™e_ùx
 *
w
);

206 
	`¥dk_jsÚ_wr™e_Çme
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ *
Çme
);

207 
	`¥dk_jsÚ_wr™e_Çme_¿w
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ *
Çme
, 
size_t
 
Ën
);

209 
	`¥dk_jsÚ_wr™e_v®
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ 
¥dk_jsÚ_v®
 *
v®
);

216 
	`¥dk_jsÚ_wr™e_v®_¿w
(
¥dk_jsÚ_wr™e_ùx
 *
w
, cÚ¡ *
d©a
, 
size_t
 
Ën
);

	@PDK/core/src/api/include/udd/spdk/jsonrpc.h

39 #iâdeà
SPDK_JSONRPC_H_


40 
	#SPDK_JSONRPC_H_


	)

42 
	~"¥dk/¡dšc.h
"

44 
	~"¥dk/jsÚ.h
"

46 
	#SPDK_JSONRPC_ERROR_PARSE_ERROR
 -32700

	)

47 
	#SPDK_JSONRPC_ERROR_INVALID_REQUEST
 -32600

	)

48 
	#SPDK_JSONRPC_ERROR_METHOD_NOT_FOUND
 -32601

	)

49 
	#SPDK_JSONRPC_ERROR_INVALID_PARAMS
 -32602

	)

50 
	#SPDK_JSONRPC_ERROR_INTERNAL_ERROR
 -32603

	)

52 
	g¥dk_jsÚ½c_£rv”
;

53 
	g¥dk_jsÚ½c_£rv”_cÚn
;

61 (*
	t¥dk_jsÚ½c_hªdË_»que¡_â
)(

62 
	t¥dk_jsÚ½c_£rv”_cÚn
 *
	tcÚn
,

63 cÚ¡ 
	t¥dk_jsÚ_v®
 *
	tm‘hod
,

64 cÚ¡ 
	t¥dk_jsÚ_v®
 *
	t·¿ms
,

65 cÚ¡ 
	t¥dk_jsÚ_v®
 *
	tid
);

67 
¥dk_jsÚ½c_£rv”
 *
	`¥dk_jsÚ½c_£rv”_li¡’
(
domaš
, 
´ÙocŞ
,

68 
sockaddr
 *
li¡’_addr
, 
sockËn_t
 
add¾’
, 
¥dk_jsÚ½c_hªdË_»que¡_â
 
hªdË_»que¡
);

70 
	`¥dk_jsÚ½c_£rv”_pŞl
(
¥dk_jsÚ½c_£rv”
 *
£rv”
);

72 
	`¥dk_jsÚ½c_£rv”_shutdown
(
¥dk_jsÚ½c_£rv”
 *
£rv”
);

74 
¥dk_jsÚ_wr™e_ùx
 *
	`¥dk_jsÚ½c_begš_»suÉ
(
¥dk_jsÚ½c_£rv”_cÚn
 *
cÚn
,

75 cÚ¡ 
¥dk_jsÚ_v®
 *
id
);

76 
	`¥dk_jsÚ½c_’d_»suÉ
(
¥dk_jsÚ½c_£rv”_cÚn
 *
cÚn
, 
¥dk_jsÚ_wr™e_ùx
 *
w
);

78 
	`¥dk_jsÚ½c_£nd_”rÜ_»¥Ú£
(
¥dk_jsÚ½c_£rv”_cÚn
 *
cÚn
,

79 cÚ¡ 
¥dk_jsÚ_v®
 *
id
, 
”rÜ_code
, cÚ¡ *
msg
);

	@PDK/core/src/api/include/udd/spdk/kvnvme_spdk.h

34 #iâdeà
_KVNVME_SPDK_H_


35 
	#_KVNVME_SPDK_H_


	)

37 
	~"¥dk/nvme.h
"

39 #ifdeà
__ılu¥lus


43 
	#KV_MAX_KEY_SIZE
 (4096)

	)

44 
	#KV_MAX_EMBED_KEY_SIZE
 (16)

	)

45 
	#KV_MAX_VALUE_SIZE
 (4<<20)

	)

47 
	e¥dk_nvme_§msung_nvm_İcode
 {

49 
SPDK_NVME_OPC_KV_STORE
 = 0x81,

50 
SPDK_NVME_OPC_KV_RETRIEVE
 = 0x90,

51 
SPDK_NVME_OPC_KV_DELETE
 = 0xA1,

52 
SPDK_NVME_OPC_KV_ITERATE_REQUEST
 = 0xB1,

53 
SPDK_NVME_OPC_KV_ITERATE_READ
 = 0xB2,

54 
SPDK_NVME_OPC_KV_APPEND
 = 0x83,

55 
SPDK_NVME_OPC_KV_EXIST
 = 0xB3,

60 (*
¥dk_nvme_cmd_cb
)(*, cÚ¡ 
	t¥dk_nvme_ıl
 *);

88 
¥dk_nvme_kv_cmd_¡Üe
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

89 
ušt32_t
 
ns_id
, *
key
, ušt32_ˆ
key_Ëngth
,

90 *
bufãr
, 
ušt32_t
 
bufãr_Ëngth
,

91 
ušt32_t
 
off£t
,

92 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

93 
ušt32_t
 
io_æags
,

94 
ušt8_t
 
İtiÚ
, ušt8_ˆ
is_¡Üe
);

122 
¥dk_nvme_kv_cmd_»Œ›ve
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

123 
ušt32_t
 
ns_id
, *
key
, ušt32_ˆ
key_Ëngth
,

124 *
bufãr
, 
ušt32_t
 
bufãr_Ëngth
,

125 
ušt32_t
 
off£t
,

126 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

127 
ušt32_t
 
io_æags
, ušt32_ˆ
İtiÚ
);

154 
¥dk_nvme_kv_cmd_d–‘e
 (
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

155 
ušt32_t
 
ns_id
, *
key
, ušt32_ˆ
key_Ëngth
, ušt32_ˆ
bufãr_Ëngth
, ušt32_ˆ
off£t
,

156 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

157 
ušt32_t
 
io_æags
, 
ušt8_t
 
İtiÚ
);

182 
¥dk_nvme_kv_cmd_exi¡
 (
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

183 
ušt32_t
 
ns_id
, *
key
, ušt32_ˆ
key_Ëngth
,

184 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

185 
ušt32_t
 
io_æags
, 
ušt8_t
 
İtiÚ
);

210 
¥dk_nvme_kv_cmd_™”©e_İ’
 (
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

211 
ušt8_t
 
key¥aû_id
, 
ušt32_t
 
b™mask
, ušt32_ˆ
´efix
,

212 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

213 
ušt32_t
 
io_æags
, 
ušt8_t
 
İtiÚ
);

239 
¥dk_nvme_kv_cmd_™”©e_»ad
 (
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

240 
ušt8_t
 
™”©Ü
, * 
bufãr
, 
ušt32_t
 
bufãr_Ëngth
, ušt32_ˆ
bufãr_off£t
,

241 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

242 
ušt32_t
 
io_æags
, 
ušt8_t
 
İtiÚ
);

265 
¥dk_nvme_kv_cmd_™”©e_şo£
 (
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

266 
ušt8_t
 
™”©Ü
,

267 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

268 
ušt32_t
 
io_æags
, 
ušt8_t
 
İtiÚ
);

277 
ušt16_t
 
¥dk_nvme_ns_g‘_max_io_queue_size
(
¥dk_nvme_ns
 *
ns
);

279 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/likely.h

38 #iâdeà
SPDK_LIKELY_H


39 
	#SPDK_LIKELY_H


	)

41 
	~"¥dk/¡dšc.h
"

43 
	#¥dk_uÆik–y
(
cÚd
è
	`__butš_ex³ù
((cÚd), 0)

	)

44 
	#¥dk_lik–y
(
cÚd
è
	`__butš_ex³ù
(!!(cÚd), 1)

	)

	@PDK/core/src/api/include/udd/spdk/log.h

39 #iâdeà
SPDK_LOG_H


40 
	#SPDK_LOG_H


	)

42 
	~"¥dk/¡dšc.h
"

48 
¥dk_g_nÙiû_¡d”r_æag
;

50 
	#SPDK_NOTICELOG
(...) \

51 
	`¥dk_nÙiûlog
(
NULL
, 0, NULL, 
__VA_ARGS__
)

	)

52 
	#SPDK_WARNLOG
(...) \

53 
	`¥dk_w¬Æog
(
NULL
, 0, NULL, 
__VA_ARGS__
)

	)

54 
	#SPDK_ERRLOG
(...) \

55 
	`¥dk_”¾og
(
__FILE__
, 
__LINE__
, 
__func__
, 
__VA_ARGS__
)

	)

57 
¥dk_£t_log_çc™y
(cÚ¡ *
çc™y
);

58 cÚ¡ *
¥dk_g‘_log_çc™y
();

59 
¥dk_£t_log_´iÜ™y
(cÚ¡ *
´iÜ™y
);

60 
	$¥dk_nÙiûlog
(cÚ¡ *
fe
, cÚ¡ 
lše
, cÚ¡ *
func
,

61 cÚ¡ *
fÜm©
, ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 4, 5)));

62 
	$¥dk_w¬Æog
(cÚ¡ *
fe
, cÚ¡ 
lše
, cÚ¡ *
func
,

63 cÚ¡ *
fÜm©
, ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 4, 5)));

64 
	$¥dk_Œaûlog
(cÚ¡ *
æag
, cÚ¡ *
fe
, cÚ¡ 
lše
,

65 cÚ¡ *
func
, cÚ¡ *
fÜm©
, ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 5, 6)));

66 
	$¥dk_”¾og
(cÚ¡ *
fe
, cÚ¡ 
lše
, cÚ¡ *
func
,

67 cÚ¡ *
fÜm©
, ...è
	`__©Œibu‹__
((
	`__fÜm©__
(
__´štf__
, 4, 5)));

68 
	`¥dk_Œaû_dump
(cÚ¡ *
Ïb–
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
);

70 
boŞ
 
	`¥dk_log_g‘_Œaû_æag
(cÚ¡ *
æag
);

71 
	`¥dk_log_£t_Œaû_æag
(cÚ¡ *
æag
);

72 
	`¥dk_log_ş—r_Œaû_æag
(cÚ¡ *
æag
);

74 
	`¥dk_İ’_log
();

75 
	`¥dk_şo£_log
();

77 
	`¥dk_Œaûlog_u§ge
(
FILE
 *
f
, cÚ¡ *
Œaû_¬g
);

	@PDK/core/src/api/include/udd/spdk/mmio.h

38 #iâdeà
SPDK_MMIO_H


39 
	#SPDK_MMIO_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
	~"¥dk/b¬r›r.h
"

49 #ifdeà
__x86_64__


50 
	#SPDK_MMIO_64BIT
 1

	)

52 
	#SPDK_MMIO_64BIT
 0

	)

55 
šlše
 
ušt32_t


56 
¥dk_mmio_»ad_4
(cÚ¡ vŞ©
ušt32_t
 *
addr
)

58 
¥dk_comp”_b¬r›r
();

59  *
addr
;

62 
šlše
 

63 
¥dk_mmio_wr™e_4
(vŞ©
ušt32_t
 *
addr
, ušt32_ˆ
v®
)

65 
¥dk_comp”_b¬r›r
();

66 *
addr
 = 
v®
;

69 
šlše
 
ušt64_t


70 
¥dk_mmio_»ad_8
(vŞ©
ušt64_t
 *
addr
)

72 
ušt64_t
 
v®
;

73 vŞ©
ušt32_t
 *
addr32
 = (vŞ©ušt32_ˆ*)
addr
;

75 
¥dk_comp”_b¬r›r
();

77 ià(
SPDK_MMIO_64BIT
) {

78 
v®
 = *
addr
;

85 
v®
 = 
addr32
[0];

86 
v®
 |ğ(
ušt64_t
)
addr32
[1] << 32;

89  
v®
;

92 
šlše
 

93 
¥dk_mmio_wr™e_8
(vŞ©
ušt64_t
 *
addr
, ušt64_ˆ
v®
)

95 vŞ©
ušt32_t
 *
addr32
 = (vŞ©ušt32_ˆ*)
addr
;

97 
¥dk_comp”_b¬r›r
();

99 ià(
SPDK_MMIO_64BIT
) {

100 *
addr
 = 
v®
;

102 
addr32
[0] = (
ušt32_t
)
v®
;

103 
addr32
[1] = (
ušt32_t
)(
v®
 >> 32);

107 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/net.h

38 #iâdeà
SPDK_NET_H


39 
	#SPDK_NET_H


	)

41 
	~"¥dk/¡dšc.h
"

43 
	~"¥dk/queue.h
"

45 
	#IDLE_INTERVAL_TIME_IN_US
 5000

	)

47 cÚ¡ *
¥dk_Ãt_äamewÜk_g‘_Çme
();

48 
¥dk_Ãt_äamewÜk_¡¬t
();

49 
¥dk_Ãt_äamewÜk_ş—r_sock‘_assocŸtiÚ
(
sock
);

50 
¥dk_Ãt_äamewÜk_fši
();

51 
¥dk_Ãt_äamewÜk_idË_time
();

53 
	#SPDK_IFNAMSIZE
 32

	)

54 
	#SPDK_MAX_IP_PER_IFC
 32

	)

56 
	s¥dk_š‹rçû
 {

57 
	mÇme
[
SPDK_IFNAMSIZE
];

58 
ušt32_t
 
	mšdex
;

59 
ušt32_t
 
	mnum__add»s£s
;

60 
ušt32_t
 
	m_add»ss
[
SPDK_MAX_IP_PER_IFC
];

61 
TAILQ_ENTRY
(
¥dk_š‹rçû
è
	mq
;

64 
¥dk_š‹rçû_add__add»ss
(
ifc_šdex
, *
_addr
);

65 
¥dk_š‹rçû_d–‘e__add»ss
(
ifc_šdex
, *
_addr
);

66 *
¥dk_š‹rçû_g‘_li¡
();

68 
¥dk_sock_g‘addr
(
sock
, *
§ddr
, 
¦’
, *
ÿddr
, 
ş’
);

69 
¥dk_sock_cÚÃù
(cÚ¡ *

, 
pÜt
);

70 
¥dk_sock_li¡’
(cÚ¡ *

, 
pÜt
);

71 
¥dk_sock_acû±
(
sock
);

72 
¥dk_sock_şo£
(
sock
);

73 
ssize_t
 
¥dk_sock_»cv
(
sock
, *
buf
, 
size_t
 
Ën
);

74 
ssize_t
 
¥dk_sock_wr™ev
(
sock
, 
iovec
 *
iov
, 
iovút
);

76 
¥dk_sock_£t_»cvlow©
(
sock
, 
nby‹s
);

77 
¥dk_sock_£t_»cvbuf
(
sock
, 
sz
);

78 
¥dk_sock_£t_£ndbuf
(
sock
, 
sz
);

80 
boŞ
 
¥dk_sock_is_v6
(
sock
);

81 
boŞ
 
¥dk_sock_is_v4
(
sock
);

	@PDK/core/src/api/include/udd/spdk/nvme.h

38 #iâdeà
SPDK_NVME_H


39 
	#SPDK_NVME_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
	~"¥dk/’v.h
"

48 
	~"¥dk/nvme_¥ec.h
"

49 
	~"¥dk/nvmf_¥ec.h
"

51 
	#SPDK_NVME_DEFAULT_RETRY_COUNT
 (4)

	)

52 
št32_t
 
¥dk_nvme_»Œy_couÁ
;

57 
	g¥dk_nvme_ù¾r
;

66 
	s¥dk_nvme_ù¾r_İts
 {

70 
ušt32_t
 
	gnum_io_queues
;

75 
boŞ
 
	gu£_cmb_sqs
;

80 
¥dk_nvme_cc_ams
 
	g¬b_mechªism
;

90 
ušt32_t
 
	gk“p_®ive_timeout_ms
;

95 
	gŒª¥Üt_»Œy_couÁ
;

100 
ušt32_t
 
	gio_queue_size
;

107 
	gho¡nqn
[
SPDK_NVMF_NQN_MAX_LEN
 + 1];

118 
ušt32_t
 
	gio_queue_»que¡s
;

130 
	e¥dk_nvme_Œª¥Üt_ty³
 {

134 
	gSPDK_NVME_TRANSPORT_PCIE
 = 256,

139 
	gSPDK_NVME_TRANSPORT_RDMA
 = 
SPDK_NVMF_TRTYPE_RDMA
,

150 
	s¥dk_nvme_Œª¥Üt_id
 {

154 
¥dk_nvme_Œª¥Üt_ty³
 
	gŒty³
;

161 
¥dk_nvmf_adrçm
 
	gadrçm
;

169 
	gŒaddr
[
SPDK_NVMF_TRADDR_MAX_LEN
 + 1];

176 
	gŒsvcid
[
SPDK_NVMF_TRSVCID_MAX_LEN
 + 1];

181 
	gsubnqn
[
SPDK_NVMF_NQN_MAX_LEN
 + 1];

205 
¥dk_nvme_Œª¥Üt_id_·r£
(
¥dk_nvme_Œª¥Üt_id
 *
Œid
, cÚ¡ *
¡r
);

214 
¥dk_nvme_Œª¥Üt_id_·r£_Œty³
(
¥dk_nvme_Œª¥Üt_ty³
 *
Œty³
, cÚ¡ *
¡r
);

223 
¥dk_nvme_Œª¥Üt_id_·r£_adrçm
(
¥dk_nvmf_adrçm
 *
adrçm
, cÚ¡ *
¡r
);

240 
¥dk_nvme_Œª¥Üt_id_com·»
(cÚ¡ 
¥dk_nvme_Œª¥Üt_id
 *
Œid1
,

241 cÚ¡ 
¥dk_nvme_Œª¥Üt_id
 *
Œid2
);

250 
boŞ
 
¥dk_nvme_Œª¥Üt_avaabË
(
¥dk_nvme_Œª¥Üt_ty³
 
Œty³
);

261 
boŞ
 (*
	t¥dk_nvme_´obe_cb
)(*
	tcb_ùx
, cÚ¡ 
	t¥dk_nvme_Œª¥Üt_id
 *
	tŒid
,

262 
	t¥dk_nvme_ù¾r_İts
 *
	tİts
);

270 (*
	g¥dk_nvme_©ch_cb
)(*
	tcb_ùx
, cÚ¡ 
	t¥dk_nvme_Œª¥Üt_id
 *
	tŒid
,

271 
	t¥dk_nvme_ù¾r
 *
	tù¾r
,

272 cÚ¡ 
	t¥dk_nvme_ù¾r_İts
 *
	tİts
);

286 (*
	g¥dk_nvme_»move_cb
)(*
	tcb_ùx
, 
	t¥dk_nvme_ù¾r
 *
	tù¾r
);

315 
¥dk_nvme_´obe
(cÚ¡ 
¥dk_nvme_Œª¥Üt_id
 *
Œid
,

316 *
cb_ùx
,

317 
¥dk_nvme_´obe_cb
 
´obe_cb
,

318 
¥dk_nvme_©ch_cb
 
©ch_cb
,

319 
¥dk_nvme_»move_cb
 
»move_cb
);

330 
¥dk_nvme_d‘ach
(
¥dk_nvme_ù¾r
 *
ù¾r
);

342 
¥dk_nvme_ù¾r_»£t
(
¥dk_nvme_ù¾r
 *
ù¾r
);

351 cÚ¡ 
¥dk_nvme_ù¾r_d©a
 *
¥dk_nvme_ù¾r_g‘_d©a
(
¥dk_nvme_ù¾r
 *
ù¾r
);

356 
¥dk_nvme_c¡s_»gi¡”
 
¥dk_nvme_ù¾r_g‘_»gs_c¡s
(
¥dk_nvme_ù¾r
 *
ù¾r
);

361 
¥dk_nvme_ÿp_»gi¡”
 
¥dk_nvme_ù¾r_g‘_»gs_ÿp
(
¥dk_nvme_ù¾r
 *
ù¾r
);

366 
¥dk_nvme_vs_»gi¡”
 
¥dk_nvme_ù¾r_g‘_»gs_vs
(
¥dk_nvme_ù¾r
 *
ù¾r
);

378 
ušt32_t
 
¥dk_nvme_ù¾r_g‘_num_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
);

388 
boŞ
 
¥dk_nvme_ù¾r_is_log_·ge_suµÜ‹d
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt8_t
 
log_·ge
);

398 
boŞ
 
¥dk_nvme_ù¾r_is_ã©u»_suµÜ‹d
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt8_t
 
ã©u»_code
);

405 (*
	g¥dk_nvme_cmd_cb
)(*, cÚ¡ 
	t¥dk_nvme_ıl
 *);

416 (*
	g¥dk_nvme_«r_cb
)(*
	t«r_cb_¬g
,

417 cÚ¡ 
	t¥dk_nvme_ıl
 *);

419 
¥dk_nvme_ù¾r_»gi¡”_«r_ÿÎback
(
¥dk_nvme_ù¾r
 *
ù¾r
,

420 
¥dk_nvme_«r_cb
 
«r_cb_â
,

421 *
«r_cb_¬g
);

428 
	g¥dk_nvme_q·œ
;

436 (*
	g¥dk_nvme_timeout_cb
)(*
	tcb_¬g
,

437 
	t¥dk_nvme_ù¾r
 *
	tù¾r
,

438 
	t¥dk_nvme_q·œ
 *
	tq·œ
,

439 
	tušt16_t
 
	tcid
);

452 
¥dk_nvme_ù¾r_»gi¡”_timeout_ÿÎback
(
¥dk_nvme_ù¾r
 *
ù¾r
,

453 
ušt32_t
 
timeout_£c
, 
¥dk_nvme_timeout_cb
 
cb_â
, *
cb_¬g
);

465 
¥dk_nvme_q·œ
 *
¥dk_nvme_ù¾r_®loc_io_q·œ
(
¥dk_nvme_ù¾r
 *
ù¾r
,

466 
¥dk_nvme_q´io
 
q´io
);

471 
¥dk_nvme_ù¾r_ä“_io_q·œ
(
¥dk_nvme_q·œ
 *
q·œ
);

486 
¥dk_nvme_ù¾r_cmd_io_¿w
(
¥dk_nvme_ù¾r
 *
ù¾r
,

487 
¥dk_nvme_q·œ
 *
q·œ
,

488 
¥dk_nvme_cmd
 *
cmd
,

489 *
buf
, 
ušt32_t
 
Ën
,

490 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

515 
št32_t
 
¥dk_nvme_q·œ_´oûss_com¶‘iÚs
(
¥dk_nvme_q·œ
 *
q·œ
,

516 
ušt32_t
 
max_com¶‘iÚs
);

534 
¥dk_nvme_ù¾r_cmd_admš_¿w
(
¥dk_nvme_ù¾r
 *
ù¾r
,

535 
¥dk_nvme_cmd
 *
cmd
,

536 *
buf
, 
ušt32_t
 
Ën
,

537 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

553 
št32_t
 
¥dk_nvme_ù¾r_´oûss_admš_com¶‘iÚs
(
¥dk_nvme_ù¾r
 *
ù¾r
);

557 
	g¥dk_nvme_ns
;

569 
¥dk_nvme_ns
 *
¥dk_nvme_ù¾r_g‘_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
ns_id
);

595 
¥dk_nvme_ù¾r_cmd_g‘_log_·ge
(
¥dk_nvme_ù¾r
 *
ù¾r
,

596 
ušt8_t
 
log_·ge
, 
ušt32_t
 
nsid
,

597 *
·ylßd
, 
ušt32_t
 
·ylßd_size
,

598 
ušt64_t
 
off£t
,

599 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

615 
¥dk_nvme_ù¾r_cmd_abÜt
(
¥dk_nvme_ù¾r
 *
ù¾r
,

616 
¥dk_nvme_q·œ
 *
q·œ
,

617 
ušt16_t
 
cid
,

618 
¥dk_nvme_cmd_cb
 
cb_â
,

619 *
cb_¬g
);

643 
¥dk_nvme_ù¾r_cmd_£t_ã©u»
(
¥dk_nvme_ù¾r
 *
ù¾r
,

644 
ušt8_t
 
ã©u»
, 
ušt32_t
 
cdw11
, ušt32_ˆ
cdw12
,

645 *
·ylßd
, 
ušt32_t
 
·ylßd_size
,

646 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

669 
¥dk_nvme_ù¾r_cmd_g‘_ã©u»
(
¥dk_nvme_ù¾r
 *
ù¾r
,

670 
ušt8_t
 
ã©u»
, 
ušt32_t
 
cdw11
,

671 *
·ylßd
, 
ušt32_t
 
·ylßd_size
,

672 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

688 
¥dk_nvme_ù¾r_©ch_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
,

689 
¥dk_nvme_ù¾r_li¡
 *
·ylßd
);

705 
¥dk_nvme_ù¾r_d‘ach_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
,

706 
¥dk_nvme_ù¾r_li¡
 *
·ylßd
);

718 
ušt32_t
 
¥dk_nvme_ù¾r_ü—‹_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
,

719 
¥dk_nvme_ns_d©a
 *
·ylßd
);

734 
¥dk_nvme_ù¾r_d–‘e_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
);

749 
¥dk_nvme_ù¾r_fÜm©
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
,

750 
¥dk_nvme_fÜm©
 *
fÜm©
);

764 
¥dk_nvme_ù¾r_upd©e_fœmw¬e
(
¥dk_nvme_ù¾r
 *
ù¾r
, *
·ylßd
, 
ušt32_t
 
size
,

765 
¦Ù
);

773 cÚ¡ 
¥dk_nvme_ns_d©a
 *
¥dk_nvme_ns_g‘_d©a
(
¥dk_nvme_ns
 *
ns
);

781 
ušt32_t
 
¥dk_nvme_ns_g‘_id
(
¥dk_nvme_ns
 *
ns
);

788 
boŞ
 
¥dk_nvme_ns_is_aùive
(
¥dk_nvme_ns
 *
ns
);

796 
ušt32_t
 
¥dk_nvme_ns_g‘_max_io_xãr_size
(
¥dk_nvme_ns
 *
ns
);

804 
ušt32_t
 
¥dk_nvme_ns_g‘_£ùÜ_size
(
¥dk_nvme_ns
 *
ns
);

812 
ušt64_t
 
¥dk_nvme_ns_g‘_num_£ùÜs
(
¥dk_nvme_ns
 *
ns
);

820 
ušt64_t
 
¥dk_nvme_ns_g‘_size
(
¥dk_nvme_ns
 *
ns
);

828 
¥dk_nvme_pi_ty³
 
¥dk_nvme_ns_g‘_pi_ty³
(
¥dk_nvme_ns
 *
ns
);

836 
ušt32_t
 
¥dk_nvme_ns_g‘_md_size
(
¥dk_nvme_ns
 *
ns
);

844 
boŞ
 
¥dk_nvme_ns_suµÜts_ex‹nded_lba
(
¥dk_nvme_ns
 *
ns
);

849 
	e¥dk_nvme_ns_æags
 {

850 
	gSPDK_NVME_NS_DEALLOCATE_SUPPORTED
 = 0x1,

851 
	gSPDK_NVME_NS_FLUSH_SUPPORTED
 = 0x2,

852 
	gSPDK_NVME_NS_RESERVATION_SUPPORTED
 = 0x4,

853 
	gSPDK_NVME_NS_WRITE_ZEROES_SUPPORTED
 = 0x8,

854 
	gSPDK_NVME_NS_DPS_PI_SUPPORTED
 = 0x10,

855 
	gSPDK_NVME_NS_EXTENDED_LBA_SUPPORTED
 = 0x20,

868 
ušt32_t
 
¥dk_nvme_ns_g‘_æags
(
¥dk_nvme_ns
 *
ns
);

875 (*
	g¥dk_nvme_»q_»£t_sgl_cb
)(*
	tcb_¬g
, 
	tušt32_t
 
	toff£t
);

885 (*
	g¥dk_nvme_»q_Ãxt_sge_cb
)(*
	tcb_¬g
, **
	tadd»ss
, 
	tušt32_t
 *
	tËngth
);

906 
¥dk_nvme_ns_cmd_wr™e
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
, *
·ylßd
,

907 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
, 
¥dk_nvme_cmd_cb
 
cb_â
,

908 *
cb_¬g
, 
ušt32_t
 
io_æags
);

930 
¥dk_nvme_ns_cmd_wr™ev
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

931 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
,

932 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
, 
ušt32_t
 
io_æags
,

933 
¥dk_nvme_»q_»£t_sgl_cb
 
»£t_sgl_â
,

934 
¥dk_nvme_»q_Ãxt_sge_cb
 
Ãxt_sge_â
);

959 
¥dk_nvme_ns_cmd_wr™e_w™h_md
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

960 *
·ylßd
, *
m‘ad©a
,

961 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
, 
¥dk_nvme_cmd_cb
 
cb_â
,

962 *
cb_¬g
, 
ušt32_t
 
io_æags
,

963 
ušt16_t
 
­±ag_mask
, ušt16_ˆ
­±ag
);

983 
¥dk_nvme_ns_cmd_wr™e_z”Ûs
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

984 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
,

985 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
,

986 
ušt32_t
 
io_æags
);

1006 
¥dk_nvme_ns_cmd_»ad
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
, *
·ylßd
,

1007 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
, 
¥dk_nvme_cmd_cb
 
cb_â
,

1008 *
cb_¬g
, 
ušt32_t
 
io_æags
);

1030 
¥dk_nvme_ns_cmd_»adv
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

1031 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
,

1032 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
, 
ušt32_t
 
io_æags
,

1033 
¥dk_nvme_»q_»£t_sgl_cb
 
»£t_sgl_â
,

1034 
¥dk_nvme_»q_Ãxt_sge_cb
 
Ãxt_sge_â
);

1058 
¥dk_nvme_ns_cmd_»ad_w™h_md
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

1059 *
·ylßd
, *
m‘ad©a
,

1060 
ušt64_t
 
lba
, 
ušt32_t
 
lba_couÁ
, 
¥dk_nvme_cmd_cb
 
cb_â
,

1061 *
cb_¬g
, 
ušt32_t
 
io_æags
,

1062 
ušt16_t
 
­±ag_mask
, ušt16_ˆ
­±ag
);

1089 
¥dk_nvme_ns_cmd_d©a£t_mªagem’t
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

1090 
ušt32_t
 
ty³
,

1091 cÚ¡ 
¥dk_nvme_dsm_¿nge
 *
¿nges
,

1092 
ušt16_t
 
num_¿nges
,

1093 
¥dk_nvme_cmd_cb
 
cb_â
,

1094 *
cb_¬g
);

1110 
¥dk_nvme_ns_cmd_æush
(
¥dk_nvme_ns
 *
ns
, 
¥dk_nvme_q·œ
 *
q·œ
,

1111 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

1131 
¥dk_nvme_ns_cmd_»£rv©iÚ_»gi¡”
(
¥dk_nvme_ns
 *
ns
,

1132 
¥dk_nvme_q·œ
 *
q·œ
,

1133 
¥dk_nvme_»£rv©iÚ_»gi¡”_d©a
 *
·ylßd
,

1134 
boŞ
 
ignÜe_key
,

1135 
¥dk_nvme_»£rv©iÚ_»gi¡”_aùiÚ
 
aùiÚ
,

1136 
¥dk_nvme_»£rv©iÚ_»gi¡”_ıl
 
ıl
,

1137 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

1157 
¥dk_nvme_ns_cmd_»£rv©iÚ_»Ëa£
(
¥dk_nvme_ns
 *
ns
,

1158 
¥dk_nvme_q·œ
 *
q·œ
,

1159 
¥dk_nvme_»£rv©iÚ_key_d©a
 *
·ylßd
,

1160 
boŞ
 
ignÜe_key
,

1161 
¥dk_nvme_»£rv©iÚ_»Ëa£_aùiÚ
 
aùiÚ
,

1162 
¥dk_nvme_»£rv©iÚ_ty³
 
ty³
,

1163 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

1183 
¥dk_nvme_ns_cmd_»£rv©iÚ_acquœe
(
¥dk_nvme_ns
 *
ns
,

1184 
¥dk_nvme_q·œ
 *
q·œ
,

1185 
¥dk_nvme_»£rv©iÚ_acquœe_d©a
 *
·ylßd
,

1186 
boŞ
 
ignÜe_key
,

1187 
¥dk_nvme_»£rv©iÚ_acquœe_aùiÚ
 
aùiÚ
,

1188 
¥dk_nvme_»£rv©iÚ_ty³
 
ty³
,

1189 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

1207 
¥dk_nvme_ns_cmd_»£rv©iÚ_»pÜt
(
¥dk_nvme_ns
 *
ns
,

1208 
¥dk_nvme_q·œ
 *
q·œ
,

1209 *
·ylßd
, 
ušt32_t
 
Ën
,

1210 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

1212 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/nvme_intel.h

42 #iâdeà
SPDK_NVME_INTEL_H


43 
	#SPDK_NVME_INTEL_H


	)

45 
	~"¥dk/¡dšc.h
"

47 #ifdeà
__ılu¥lus


51 
	~"¥dk/as£¹.h
"

53 
	e¥dk_nvme_š‹l_ã©
 {

54 
SPDK_NVME_INTEL_FEAT_MAX_LBA
 = 0xC1,

55 
SPDK_NVME_INTEL_FEAT_NATIVE_MAX_LBA
 = 0xC2,

56 
SPDK_NVME_INTEL_FEAT_POWER_GOVERNOR_SETTING
 = 0xC6,

57 
SPDK_NVME_INTEL_FEAT_SMBUS_ADDRESS
 = 0xC8,

58 
SPDK_NVME_INTEL_FEAT_LED_PATTERN
 = 0xC9,

59 
SPDK_NVME_INTEL_FEAT_RESET_TIMED_WORKLOAD_COUNTERS
 = 0xD5,

60 
SPDK_NVME_INTEL_FEAT_LATENCY_TRACKING
 = 0xE2,

63 
	e¥dk_nvme_š‹l_£t_max_lba_commªd_¡©us_code
 {

64 
SPDK_NVME_INTEL_EXCEEDS_AVAILABLE_CAPACITY
 = 0xC0,

65 
SPDK_NVME_INTEL_SMALLER_THAN_MIN_LIMIT
 = 0xC1,

66 
SPDK_NVME_INTEL_SMALLER_THAN_NS_REQUIREMENTS
 = 0xC2,

69 
	e¥dk_nvme_š‹l_log_·ge
 {

70 
SPDK_NVME_INTEL_LOG_PAGE_DIRECTORY
 = 0xC0,

71 
SPDK_NVME_INTEL_LOG_READ_CMD_LATENCY
 = 0xC1,

72 
SPDK_NVME_INTEL_LOG_WRITE_CMD_LATENCY
 = 0xC2,

73 
SPDK_NVME_INTEL_LOG_TEMPERATURE
 = 0xC5,

74 
SPDK_NVME_INTEL_LOG_SMART
 = 0xCA,

75 
SPDK_NVME_INTEL_MARKETING_DESCRIPTION
 = 0xDD,

78 
	e¥dk_nvme_š‹l_sm¬t_©Œibu‹_code
 {

79 
SPDK_NVME_INTEL_SMART_PROGRAM_FAIL_COUNT
 = 0xAB,

80 
SPDK_NVME_INTEL_SMART_ERASE_FAIL_COUNT
 = 0xAC,

81 
SPDK_NVME_INTEL_SMART_WEAR_LEVELING_COUNT
 = 0xAD,

82 
SPDK_NVME_INTEL_SMART_E2E_ERROR_COUNT
 = 0xB8,

83 
SPDK_NVME_INTEL_SMART_CRC_ERROR_COUNT
 = 0xC7,

84 
SPDK_NVME_INTEL_SMART_MEDIA_WEAR
 = 0xE2,

85 
SPDK_NVME_INTEL_SMART_HOST_READ_PERCENTAGE
 = 0xE3,

86 
SPDK_NVME_INTEL_SMART_TIMER
 = 0xE4,

87 
SPDK_NVME_INTEL_SMART_THERMAL_THROTTLE_STATUS
 = 0xEA,

88 
SPDK_NVME_INTEL_SMART_RETRY_BUFFER_OVERFLOW_COUNTER
 = 0xF0,

89 
SPDK_NVME_INTEL_SMART_PLL_LOCK_LOSS_COUNT
 = 0xF3,

90 
SPDK_NVME_INTEL_SMART_NAND_BYTES_WRITTEN
 = 0xF4,

91 
SPDK_NVME_INTEL_SMART_HOST_BYTES_WRITTEN
 = 0xF5,

94 
	s¥dk_nvme_š‹l_log_·ge_dœeùÜy
 {

95 
ušt8_t
 
v”siÚ
[2];

96 
ušt8_t
 
»£rved
[384];

97 
ušt8_t
 
»ad_Ï‹ncy_log_Ën
;

98 
ušt8_t
 
»£rved2
;

99 
ušt8_t
 
wr™e_Ï‹ncy_log_Ën
;

100 
ušt8_t
 
»£rved3
[5];

101 
ušt8_t
 
‹m³¿tu»_¡©i¡ics_log_Ën
;

102 
ušt8_t
 
»£rved4
[9];

103 
ušt8_t
 
sm¬t_log_Ën
;

104 
ušt8_t
 
»£rved5
[37];

105 
ušt8_t
 
m¬k‘šg_desütiÚ_log_Ën
;

106 
ušt8_t
 
»£rved6
[69];

108 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_log_·ge_dœeùÜy
) == 512, "Incorrect size");

110 
	s¥dk_nvme_š‹l_rw_Ï‹ncy_·ge
 {

111 
ušt16_t
 
majÜ_»visÚ
;

112 
ušt16_t
 
mšÜ_»visÚ
;

113 
ušt32_t
 
buck‘s_32us
[32];

114 
ušt32_t
 
buck‘s_1ms
[31];

115 
ušt32_t
 
buck‘s_32ms
[31];

117 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_rw_Ï‹ncy_·ge
) == 380, "Incorrect size");

119 
	s¥dk_nvme_š‹l_‹m³¿tu»_·ge
 {

120 
ušt64_t
 
cu¼’t_‹m³¿tu»
;

121 
ušt64_t
 
shutdown_æag_Ï¡
;

122 
ušt64_t
 
shutdown_æag_liã
;

123 
ušt64_t
 
highe¡_‹m³¿tu»
;

124 
ušt64_t
 
lowe¡_‹m³¿tu»
;

125 
ušt64_t
 
»£rved
[5];

126 
ušt64_t
 
¥ecif›d_max_İ_‹m³¿tu»
;

127 
ušt64_t
 
»£rved2
;

128 
ušt64_t
 
¥ecif›d_mš_İ_‹m³¿tu»
;

129 
ušt64_t
 
e¡im©ed_off£t
;

131 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_‹m³¿tu»_·ge
) == 112, "Incorrect size");

133 
	s¥dk_nvme_š‹l_sm¬t_©Œibu‹
 {

134 
ušt8_t
 
code
;

135 
ušt8_t
 
»£rved
[2];

136 
ušt8_t
 
nÜm®ized_v®ue
;

137 
ušt8_t
 
»£rved2
;

138 
ušt8_t
 
¿w_v®ue
[6];

139 
ušt8_t
 
»£rved3
;

142 
__©Œibu‹__
((
·cked
)è
¥dk_nvme_š‹l_sm¬t_šfÜm©iÚ_·ge
 {

143 
¥dk_nvme_š‹l_sm¬t_©Œibu‹
 
©Œibu‹s
[13];

145 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_sm¬t_šfÜm©iÚ_·ge
) == 156, "Incorrect size");

147 
	u¥dk_nvme_š‹l_ã©_pow”_gov”nÜ
 {

148 
ušt32_t
 
¿w
;

151 
ušt32_t
 
pow”_gov”nÜ_£‰šg
 : 8;

152 
ušt32_t
 
»£rved
 : 24;

153 } 
b™s
;

155 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_ã©_pow”_gov”nÜ
) == 4, "Incorrect size");

157 
	u¥dk_nvme_š‹l_ã©_smbus_add»ss
 {

158 
ušt32_t
 
¿w
;

160 
ušt32_t
 
»£rved
 : 1;

161 
ušt32_t
 
smbus_cÚŒŞËr_add»ss
 : 8;

162 
ušt32_t
 
»£rved2
 : 23;

163 } 
b™s
;

165 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_ã©_smbus_add»ss
) == 4, "Incorrect size");

167 
	u¥dk_nvme_š‹l_ã©_Ëd_·‰”n
 {

168 
ušt32_t
 
¿w
;

170 
ušt32_t
 
ã©u»_İtiÚs
 : 24;

171 
ušt32_t
 
v®ue
 : 8;

172 } 
b™s
;

174 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_ã©_Ëd_·‰”n
) == 4, "Incorrect size");

176 
	u¥dk_nvme_š‹l_ã©_»£t_timed_wÜklßd_couÁ”s
 {

177 
ušt32_t
 
¿w
;

183 
ušt32_t
 
»£t
 : 1;

184 
ušt32_t
 
»£rved
 : 31;

185 } 
b™s
;

187 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_ã©_»£t_timed_wÜklßd_couÁ”s
) == 4,

190 
	u¥dk_nvme_š‹l_ã©_Ï‹ncy_Œackšg
 {

191 
ušt32_t
 
¿w
;

198 
ušt32_t
 
’abË
 : 32;

199 } 
b™s
;

201 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_ã©_Ï‹ncy_Œackšg
) == 4, "Incorrect size");

203 
	s¥dk_nvme_š‹l_m¬k‘šg_desütiÚ_·ge
 {

204 
ušt8_t
 
m¬k‘šg_´oduù
[512];

206 
SPDK_STATIC_ASSERT
((
¥dk_nvme_š‹l_m¬k‘šg_desütiÚ_·ge
) == 512,

208 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/nvme_internal.h

34 #iâdeà
__NVME_INTERNAL_H__


35 
	#__NVME_INTERNAL_H__


	)

37 
	~"¥dk/¡dšc.h
"

39 
	~"¥dk/nvme.h
"

41 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
)

42 
	~<x86šŒš.h
>

45 
	~"¥dk/queue.h
"

46 
	~"¥dk/b¬r›r.h
"

47 
	~"¥dk/b™_¬¿y.h
"

48 
	~"¥dk/mmio.h
"

49 
	~"¥dk/pci_ids.h
"

50 
	~"¥dk/ut.h
"

51 
	~"¥dk/nvme_š‹l.h
"

52 
	~"¥dk/nvmf_¥ec.h
"

54 
	~"¥dk_š‹º®/as£¹.h
"

55 
	~"¥dk_š‹º®/log.h
"

57 
	~"¥dk/kvnvme_¥dk.h
"

63 
	#NVME_INTEL_QUIRK_READ_LATENCY
 0x1

	)

69 
	#NVME_INTEL_QUIRK_WRITE_LATENCY
 0x2

	)

75 
	#NVME_QUIRK_DELAY_BEFORE_CHK_RDY
 0x4

	)

81 
	#NVME_INTEL_QUIRK_STRIPING
 0x8

	)

87 
	#NVME_QUIRK_DELAY_AFTER_QUEUE_ALLOC
 0x10

	)

89 
	#NVME_MAX_ASYNC_EVENTS
 (8)

	)

91 
	#NVME_MIN_TIMEOUT_PERIOD
 (5)

	)

92 
	#NVME_MAX_TIMEOUT_PERIOD
 (120)

	)

95 
	#NVME_MAX_AER_LOG_SIZE
 (4096)

	)

102 
	#DEFAULT_MAX_IO_QUEUES
 (1024)

	)

103 
	#DEFAULT_IO_QUEUE_SIZE
 (256)

	)

105 
	#DEFAULT_ADMIN_QUEUE_REQUESTS
 (32)

	)

106 
	#DEFAULT_IO_QUEUE_REQUESTS
 (512)

	)

108 
	#DEFAULT_HOSTNQN
 "nqn.2016-06.io.¥dk:ho¡"

	)

110 
	envme_·ylßd_ty³
 {

111 
	mNVME_PAYLOAD_TYPE_INVALID
 = 0,

114 
	mNVME_PAYLOAD_TYPE_CONTIG
,

117 
	mNVME_PAYLOAD_TYPE_SGL
,

123 
	e¥dk_nvme_ù¾r_æags
 {

124 
	mSPDK_NVME_CTRLR_SGL_SUPPORTED
 = 0x1,

132 
__©Œibu‹__
((
·cked
)è
	gnvme_·ylßd
 {

135 *
	gcÚtig
;

140 
	snvme_sgl_¬gs
 {

141 
¥dk_nvme_»q_»£t_sgl_cb
 
	g»£t_sgl_â
;

142 
¥dk_nvme_»q_Ãxt_sge_cb
 
	gÃxt_sge_â
;

143 *
	gcb_¬g
;

144 } 
	gsgl
;

145 } 
	gu
;

148 *
	gmd
;

151 
ušt8_t
 
	gty³
;

154 
	snvme_»que¡
 {

155 
¥dk_nvme_cmd
 
	mcmd
;

160 
nvme_·ylßd
 
	m·ylßd
;

162 
ušt8_t
 
	m»Œ›s
;

168 
ušt8_t
 
	mnum_chd»n
;

169 
ušt32_t
 
	m·ylßd_size
;

175 
ušt32_t
 
	m·ylßd_off£t
;

176 
ušt32_t
 
	mmd_off£t
;

178 
¥dk_nvme_cmd_cb
 
	mcb_â
;

179 *
	mcb_¬g
;

180 
STAILQ_ENTRY
(
nvme_»que¡
è
	m¡aq
;

182 
¥dk_nvme_q·œ
 *
	mq·œ
;

191 
pid_t
 
	mpid
;

192 
¥dk_nvme_ıl
 
	mıl
;

207 
TAILQ_HEAD
(, 
nvme_»que¡
è
	mchd»n
;

212 
TAILQ_ENTRY
(
nvme_»que¡
è
	mchd_q
;

218 
nvme_»que¡
 *
	m·»Á
;

227 
¥dk_nvme_ıl
 
	m·»Á_¡©us
;

233 
¥dk_nvme_cmd_cb
 
	mu£r_cb_â
;

234 *
	mu£r_cb_¬g
;

235 *
	mu£r_bufãr
;

238 
	snvme_com¶‘iÚ_pŞl_¡©us
 {

239 
¥dk_nvme_ıl
 
	mıl
;

240 
boŞ
 
	mdÚe
;

243 
	snvme_async_ev’t_»que¡
 {

244 
¥dk_nvme_ù¾r
 *
	mù¾r
;

245 
nvme_»que¡
 *
	m»q
;

246 
¥dk_nvme_ıl
 
	mıl
;

249 
	s¥dk_nvme_q·œ
 {

250 
±h»ad_¥šlock_t
 
	m»q_lock
;

251 
STAILQ_HEAD
(, 
nvme_»que¡
è
	mä“_»q
;

252 
STAILQ_HEAD
(, 
nvme_»que¡
è
	mqueued_»q
;

254 
¥dk_nvme_Œª¥Üt_ty³
 
	mŒty³
;

256 
ušt16_t
 
	mid
;

258 
ušt8_t
 
	mq´io
;

265 
ušt8_t
 
	mš_com¶‘iÚ_cÚ‹xt
 : 1;

266 
ušt8_t
 
	md–‘e_aá”_com¶‘iÚ_cÚ‹xt
: 1;

268 
¥dk_nvme_ù¾r
 *
	mù¾r
;

271 
TAILQ_ENTRY
(
¥dk_nvme_q·œ
è
	mq
;

274 
TAILQ_ENTRY
(
¥dk_nvme_q·œ
è
	m³r_´oûss_q
;

276 *
	m»q_buf
;

277 
±h»ad_¥šlock_t
 
	msq_lock
;

278 
±h»ad_¥šlock_t
 
	mcq_lock
;

279 
ušt16_t
 
	mcu¼’t_qd
;

282 
	s¥dk_nvme_ns
 {

283 
¥dk_nvme_ù¾r
 *
	mù¾r
;

284 
ušt32_t
 
	m¡re_size
;

285 
ušt32_t
 
	m£ùÜ_size
;

292 
ušt32_t
 
	mex‹nded_lba_size
;

294 
ušt32_t
 
	mmd_size
;

295 
ušt32_t
 
	mpi_ty³
;

296 
ušt32_t
 
	m£ùÜs_³r_max_io
;

297 
ušt32_t
 
	m£ùÜs_³r_¡re
;

298 
ušt16_t
 
	mid
;

299 
ušt16_t
 
	mæags
;

305 
	envme_ù¾r_¡©e
 {

309 
	mNVME_CTRLR_STATE_INIT
,

314 
	mNVME_CTRLR_STATE_DISABLE_WAIT_FOR_READY_1
,

319 
	mNVME_CTRLR_STATE_DISABLE_WAIT_FOR_READY_0
,

324 
	mNVME_CTRLR_STATE_ENABLE
,

329 
	mNVME_CTRLR_STATE_ENABLE_WAIT_FOR_READY_1
,

334 
	mNVME_CTRLR_STATE_READY


337 
	#NVME_TIMEOUT_INFINITE
 
UINT64_MAX


	)

342 
	s¥dk_nvme_ù¾r_´oûss
 {

344 
boŞ
 
	mis_´im¬y
;

347 
pid_t
 
	mpid
;

350 
STAILQ_HEAD
(, 
nvme_»que¡
è
	maùive_»qs
;

352 
TAILQ_ENTRY
(
¥dk_nvme_ù¾r_´oûss
è
	mq
;

355 
¥dk_pci_deviû
 *
	mdevhªdË
;

358 
	m»f
;

361 
TAILQ_HEAD
(, 
¥dk_nvme_q·œ
è
	m®loÿ‹d_io_q·œs
;

367 
	s¥dk_nvme_ù¾r
 {

371 
¥dk_nvme_ns
 *
	mns
;

373 
¥dk_nvme_Œª¥Üt_id
 
	mŒid
;

375 
ušt32_t
 
	mnum_ns
;

377 
boŞ
 
	mis_»moved
;

379 
boŞ
 
	mis_»£‰šg
;

381 
boŞ
 
	mis_çed
;

384 
ušt64_t
 
	mæags
;

388 
¥dk_nvme_ÿp_»gi¡”
 
	mÿp
;

390 
nvme_ù¾r_¡©e
 
	m¡©e
;

391 
ušt64_t
 
	m¡©e_timeout_tsc
;

393 
ušt64_t
 
	mÃxt_k“p_®ive_tick
;

394 
ušt64_t
 
	mk“p_®ive_š‹rv®_ticks
;

396 
TAILQ_ENTRY
(
¥dk_nvme_ù¾r
è
	mq
;

399 
boŞ
 
	mlog_·ge_suµÜ‹d
[256];

402 
boŞ
 
	mã©u»_suµÜ‹d
[256];

405 
ušt32_t
 
	mmax_xãr_size
;

408 
ušt32_t
 
	mmš_·ge_size
;

410 
ušt32_t
 
	mnum_«rs
;

411 
nvme_async_ev’t_»que¡
 
	m«r
[
NVME_MAX_ASYNC_EVENTS
];

412 
¥dk_nvme_«r_cb
 
	m«r_cb_â
;

413 *
	m«r_cb_¬g
;

416 
±h»ad_mu‹x_t
 
	mù¾r_lock
;

419 
¥dk_nvme_q·œ
 *
	madmšq
;

424 
¥dk_nvme_ù¾r_d©a
 
	mcd©a
;

431 
¥dk_nvme_ns_d©a
 *
	mnsd©a
;

433 
¥dk_b™_¬¿y
 *
	mä“_io_qids
;

434 
TAILQ_HEAD
(, 
¥dk_nvme_q·œ
è
	maùive_io_q·œs
;

436 
¥dk_nvme_ù¾r_İts
 
	mİts
;

438 
ušt64_t
 
	mquœks
;

441 
ušt64_t
 
	m¦“p_timeout_tsc
;

444 
TAILQ_HEAD
(, 
¥dk_nvme_ù¾r_´oûss
è
	maùive_´ocs
;

449 
¥dk_nvme_timeout_cb
 
	mtimeout_cb_â
;

450 *
	mtimeout_cb_¬g
;

451 
ušt64_t
 
	mtimeout_ticks
;

453 
STAILQ_HEAD
(, 
nvme_»que¡
è
	mqueued_abÜts
;

454 
ušt32_t
 
	mout¡ªdšg_abÜts
;

457 
	snvme_driv”
 {

458 
±h»ad_mu‹x_t
 
	mlock
;

459 
TAILQ_HEAD
(, 
¥dk_nvme_ù¾r
è
	mš™_ù¾rs
;

460 
TAILQ_HEAD
(, 
¥dk_nvme_ù¾r
è
	m©ched_ù¾rs
;

461 
boŞ
 
	mš™Ÿlized
;

464 
nvme_driv”
 *
g_¥dk_nvme_driv”
;

466 
	#nvme_d–ay
 
u¦“p


	)

468 
šlše
 
boŞ


469 
	$nvme_q·œ_is_admš_queue
(
¥dk_nvme_q·œ
 *
q·œ
)

471  
q·œ
->
id
 == 0;

472 
	}
}

474 
šlše
 
boŞ


475 
	$nvme_q·œ_is_io_queue
(
¥dk_nvme_q·œ
 *
q·œ
)

477  
q·œ
->
id
 != 0;

478 
	}
}

480 
šlše
 

481 
	$nvme_robu¡_mu‹x_lock
(
±h»ad_mu‹x_t
 *
mtx
)

483 
rc
 = 
	`±h»ad_mu‹x_lock
(
mtx
);

485 #iâdeà
__F»eBSD__


486 ià(
rc
 =ğ
EOWNERDEAD
) {

487 
rc
 = 
	`±h»ad_mu‹x_cÚsi¡’t
(
mtx
);

491  
rc
;

492 
	}
}

494 
šlše
 

495 
	$nvme_robu¡_mu‹x_uÆock
(
±h»ad_mu‹x_t
 *
mtx
)

497  
	`±h»ad_mu‹x_uÆock
(
mtx
);

498 
	}
}

501 
nvme_ù¾r_cmd_id’tify_cÚŒŞËr
(
¥dk_nvme_ù¾r
 *
ù¾r
,

502 *
·ylßd
,

503 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

504 
nvme_ù¾r_cmd_id’tify_Çme¥aû
(
¥dk_nvme_ù¾r
 *
ù¾r
,

505 
ušt16_t
 
nsid
, *
·ylßd
,

506 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

507 
nvme_ù¾r_cmd_£t_num_queues
(
¥dk_nvme_ù¾r
 *
ù¾r
,

508 
ušt32_t
 
num_queues
, 
¥dk_nvme_cmd_cb
 
cb_â
,

509 *
cb_¬g
);

510 
nvme_ù¾r_cmd_£t_async_ev’t_cÚfig
(
¥dk_nvme_ù¾r
 *
ù¾r
,

511 
¥dk_nvme_ü™iÿl_w¬nšg_¡©e
 
¡©e
,

512 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

513 
nvme_ù¾r_cmd_©ch_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
,

514 
¥dk_nvme_ù¾r_li¡
 *
·ylßd
, 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

515 
nvme_ù¾r_cmd_d‘ach_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
,

516 
¥dk_nvme_ù¾r_li¡
 *
·ylßd
, 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

517 
nvme_ù¾r_cmd_ü—‹_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
¥dk_nvme_ns_d©a
 *
·ylßd
,

518 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

519 
nvme_ù¾r_cmd_d–‘e_ns
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
, 
¥dk_nvme_cmd_cb
 
cb_â
,

520 *
cb_¬g
);

521 
nvme_ù¾r_cmd_fÜm©
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
nsid
,

522 
¥dk_nvme_fÜm©
 *
fÜm©
, 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

523 
nvme_ù¾r_cmd_fw_comm™
(
¥dk_nvme_ù¾r
 *
ù¾r
,

524 cÚ¡ 
¥dk_nvme_fw_comm™
 *
fw_comm™
,

525 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

526 
nvme_ù¾r_cmd_fw_image_dowÆßd
(
¥dk_nvme_ù¾r
 *
ù¾r
,

527 
ušt32_t
 
size
, ušt32_ˆ
off£t
, *
·ylßd
,

528 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

529 
nvme_com¶‘iÚ_pŞl_cb
(*
¬g
, cÚ¡ 
¥dk_nvme_ıl
 *
ıl
);

531 
nvme_ù¾r_add_´oûss
(
¥dk_nvme_ù¾r
 *
ù¾r
, *
devhªdË
);

532 
nvme_ù¾r_ä“_´oûs£s
(
¥dk_nvme_ù¾r
 *
ù¾r
);

533 
¥dk_pci_deviû
 *
nvme_ù¾r_´oc_g‘_devhªdË
(
¥dk_nvme_ù¾r
 *
ù¾r
);

535 
nvme_ù¾r_´obe
(cÚ¡ 
¥dk_nvme_Œª¥Üt_id
 *
Œid
, *
devhªdË
,

536 
¥dk_nvme_´obe_cb
 
´obe_cb
, *
cb_ùx
);

538 
nvme_ù¾r_cÚ¡ruù
(
¥dk_nvme_ù¾r
 *
ù¾r
);

539 
nvme_ù¾r_de¡ruù
(
¥dk_nvme_ù¾r
 *
ù¾r
);

540 
nvme_ù¾r_ç
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
boŞ
 
hÙ_»move
);

541 
nvme_ù¾r_´oûss_š™
(
¥dk_nvme_ù¾r
 *
ù¾r
);

542 
nvme_ù¾r_¡¬t
(
¥dk_nvme_ù¾r
 *
ù¾r
);

544 
nvme_ù¾r_subm™_admš_»que¡
(
¥dk_nvme_ù¾r
 *
ù¾r
,

545 
nvme_»que¡
 *
»q
);

546 
nvme_ù¾r_g‘_ÿp
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
¥dk_nvme_ÿp_»gi¡”
 *
ÿp
);

547 
nvme_ù¾r_š™_ÿp
(
¥dk_nvme_ù¾r
 *
ù¾r
, cÚ¡ 
¥dk_nvme_ÿp_»gi¡”
 *
ÿp
);

548 
nvme_q·œ_š™
(
¥dk_nvme_q·œ
 *
q·œ
, 
ušt16_t
 
id
,

549 
¥dk_nvme_ù¾r
 *
ù¾r
,

550 
¥dk_nvme_q´io
 
q´io
,

551 
ušt32_t
 
num_»que¡s
);

552 
nvme_q·œ_’abË
(
¥dk_nvme_q·œ
 *
q·œ
);

553 
nvme_q·œ_di§bË
(
¥dk_nvme_q·œ
 *
q·œ
);

554 
nvme_q·œ_subm™_»que¡
(
¥dk_nvme_q·œ
 *
q·œ
,

555 
nvme_»que¡
 *
»q
);

557 
nvme_ns_cÚ¡ruù
(
¥dk_nvme_ns
 *
ns
, 
ušt16_t
 
id
,

558 
¥dk_nvme_ù¾r
 *
ù¾r
);

559 
nvme_ns_de¡ruù
(
¥dk_nvme_ns
 *
ns
);

561 
nvme_»que¡
 *
nvme_®loÿ‹_»que¡
(
¥dk_nvme_q·œ
 *
q·œ
,

562 cÚ¡ 
nvme_·ylßd
 *
·ylßd
,

563 
ušt32_t
 
·ylßd_size
, 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

564 
nvme_»que¡
 *
nvme_®loÿ‹_»que¡_nuÎ
(
¥dk_nvme_q·œ
 *
q·œ
,

565 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

566 
nvme_»que¡
 *
nvme_®loÿ‹_»que¡_cÚtig
(
¥dk_nvme_q·œ
 *
q·œ
,

567 *
bufãr
, 
ušt32_t
 
·ylßd_size
,

568 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
);

569 
nvme_»que¡
 *
nvme_®loÿ‹_»que¡_u£r_cİy
(
¥dk_nvme_q·œ
 *
q·œ
,

570 *
bufãr
, 
ušt32_t
 
·ylßd_size
,

571 
¥dk_nvme_cmd_cb
 
cb_â
, *
cb_¬g
, 
boŞ
 
ho¡_to_cÚŒŞËr
);

572 
nvme_ä“_»que¡
(
nvme_»que¡
 *
»q
);

573 
nvme_»que¡_»move_chd
(
nvme_»que¡
 *
·»Á
, nvme_»que¡ *
chd
);

574 
ušt64_t
 
nvme_g‘_quœks
(cÚ¡ 
¥dk_pci_id
 *
id
);

576 
¥dk_nvme_ù¾r_İts_£t_deçuÉs
(
¥dk_nvme_ù¾r_İts
 *
İts
);

578 
nvme_robu¡_mu‹x_š™_sh¬ed
(
±h»ad_mu‹x_t
 *
mtx
);

579 
nvme_robu¡_mu‹x_š™_»cursive_sh¬ed
(
±h»ad_mu‹x_t
 *
mtx
);

581 
boŞ
 
nvme_com¶‘iÚ_is_»Œy
(cÚ¡ 
¥dk_nvme_ıl
 *
ıl
);

582 
nvme_q·œ_´št_commªd
(
¥dk_nvme_q·œ
 *
q·œ
, 
¥dk_nvme_cmd
 *
cmd
);

583 
nvme_q·œ_´št_com¶‘iÚ
(
¥dk_nvme_q·œ
 *
q·œ
, 
¥dk_nvme_ıl
 *
ıl
);

586 
	#DECLARE_TRANSPORT
(
Çme
) \

587 
¥dk_nvme_ù¾r
 *
nvme_
 ## 
Çme
 ## 
	`_ù¾r_cÚ¡ruù
(cÚ¡ 
¥dk_nvme_Œª¥Üt_id
 *
Œid
, cÚ¡ 
¥dk_nvme_ù¾r_İts
 *
İts
, \

588 *
devhªdË
); \

589 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_de¡ruù
(
¥dk_nvme_ù¾r
 *
ù¾r
); \

590 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_sÿn
(cÚ¡ 
¥dk_nvme_Œª¥Üt_id
 *
Œid
, *
cb_ùx
, 
¥dk_nvme_´obe_cb
 
´obe_cb
, 
¥dk_nvme_»move_cb
 
»move_cb
); \

591 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_’abË
(
¥dk_nvme_ù¾r
 *
ù¾r
); \

592 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_£t_»g_4
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
off£t
, ušt32_ˆ
v®ue
); \

593 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_£t_»g_8
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
off£t
, 
ušt64_t
 
v®ue
); \

594 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_g‘_»g_4
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
off£t
, ušt32_ˆ*
v®ue
); \

595 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_g‘_»g_8
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt32_t
 
off£t
, 
ušt64_t
 *
v®ue
); \

596 
ušt32_t
 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_g‘_max_xãr_size
(
¥dk_nvme_ù¾r
 *
ù¾r
); \

597 
ušt32_t
 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_g‘_max_io_queue_size
(
¥dk_nvme_ù¾r
 *
ù¾r
); \

598 
¥dk_nvme_q·œ
 *
nvme_
 ## 
Çme
 ## 
	`_ù¾r_ü—‹_io_q·œ
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
ušt16_t
 
qid
, 
¥dk_nvme_q´io
 
q´io
); \

599 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_d–‘e_io_q·œ
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
¥dk_nvme_q·œ
 *
q·œ
); \

600 
nvme_
 ## 
Çme
 ## 
	`_ù¾r_»š™_io_q·œ
(
¥dk_nvme_ù¾r
 *
ù¾r
, 
¥dk_nvme_q·œ
 *
q·œ
); \

601 
nvme_
 ## 
Çme
 ## 
	`_q·œ_’abË
(
¥dk_nvme_q·œ
 *
q·œ
); \

602 
nvme_
 ## 
Çme
 ## 
	`_q·œ_di§bË
(
¥dk_nvme_q·œ
 *
q·œ
); \

603 
nvme_
 ## 
Çme
 ## 
	`_q·œ_»£t
(
¥dk_nvme_q·œ
 *
q·œ
); \

604 
nvme_
 ## 
Çme
 ## 
	`_q·œ_ç
(
¥dk_nvme_q·œ
 *
q·œ
); \

605 
nvme_
 ## 
Çme
 ## 
	`_q·œ_subm™_»que¡
(
¥dk_nvme_q·œ
 *
q·œ
, 
nvme_»que¡
 *
»q
); \

606 
št32_t
 
nvme_
 ## 
Çme
 ## 
	`_q·œ_´oûss_com¶‘iÚs
(
¥dk_nvme_q·œ
 *
q·œ
, 
ušt32_t
 
max_com¶‘iÚs
);

	)

608 
	$DECLARE_TRANSPORT
(
Œª¥Üt
)

609 
	$DECLARE_TRANSPORT
(
pc›
)

610 #ifdeà 
SPDK_CONFIG_RDMA


611 
	$DECLARE_TRANSPORT
(
rdma
)

614 #undeà
DECLARE_TRANSPORT


622 
	`nvme_ù¾r_´oc_g‘_»f
(
¥dk_nvme_ù¾r
 *
ù¾r
);

623 
	`nvme_ù¾r_´oc_put_»f
(
¥dk_nvme_ù¾r
 *
ù¾r
);

624 
	`nvme_ù¾r_g‘_»f_couÁ
(
¥dk_nvme_ù¾r
 *
ù¾r
);

626 
šlše
 
boŞ


627 
	$_is_·ge_®igÃd
(
ušt64_t
 
add»ss
)

629  (
add»ss
 & (
PAGE_SIZE
 - 1)) == 0;

630 
	}
}

	@PDK/core/src/api/include/udd/spdk/nvme_spec.h

39 #iâdeà
SPDK_NVME_SPEC_H


40 
	#SPDK_NVME_SPEC_H


	)

42 
	~"¥dk/¡dšc.h
"

44 #ifdeà
__ılu¥lus


48 
	~"¥dk/as£¹.h
"

54 
	#SPDK_NVME_GLOBAL_NS_TAG
 ((
ušt32_t
)0xFFFFFFFF)

	)

56 
	#SPDK_NVME_MAX_IO_QUEUES
 (65535)

	)

58 
	#SPDK_NVME_ADMIN_QUEUE_MIN_ENTRIES
 2

	)

59 
	#SPDK_NVME_ADMIN_QUEUE_MAX_ENTRIES
 4096

	)

61 
	#SPDK_NVME_IO_QUEUE_MIN_ENTRIES
 2

	)

62 
	#SPDK_NVME_IO_QUEUE_MAX_ENTRIES
 65536

	)

68 
	#SPDK_NVME_DATASET_MANAGEMENT_MAX_RANGES
 256

	)

70 
	u¥dk_nvme_ÿp_»gi¡”
 {

71 
ušt64_t
 
¿w
;

74 
ušt32_t
 
mqes
 : 16;

77 
ušt32_t
 
cqr
 : 1;

80 
ušt32_t
 
ams
 : 2;

82 
ušt32_t
 
»£rved1
 : 5;

85 
ušt32_t
 
to
 : 8;

88 
ušt32_t
 
d¡rd
 : 4;

91 
ušt32_t
 
ns¤s
 : 1;

94 
ušt32_t
 
css_nvm
 : 1;

96 
ušt32_t
 
css_»£rved
 : 3;

97 
ušt32_t
 
»£rved2
 : 7;

100 
ušt32_t
 
mpsmš
 : 4;

103 
ušt32_t
 
mpsmax
 : 4;

105 
ušt32_t
 
»£rved3
 : 8;

106 } 
b™s
;

108 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ÿp_»gi¡”
) == 8, "Incorrect size");

110 
	u¥dk_nvme_cc_»gi¡”
 {

111 
ušt32_t
 
¿w
;

114 
ušt32_t
 
’
 : 1;

116 
ušt32_t
 
»£rved1
 : 3;

119 
ušt32_t
 
css
 : 3;

122 
ušt32_t
 
mps
 : 4;

125 
ušt32_t
 
ams
 : 3;

128 
ušt32_t
 
shn
 : 2;

131 
ušt32_t
 
iosqes
 : 4;

134 
ušt32_t
 
iocqes
 : 4;

136 
ušt32_t
 
»£rved2
 : 8;

137 } 
b™s
;

139 
SPDK_STATIC_ASSERT
((
¥dk_nvme_cc_»gi¡”
) == 4, "Incorrect size");

141 
	e¥dk_nvme_shn_v®ue
 {

142 
SPDK_NVME_SHN_NORMAL
 = 0x1,

143 
SPDK_NVME_SHN_ABRUPT
 = 0x2,

146 
	u¥dk_nvme_c¡s_»gi¡”
 {

147 
ušt32_t
 
¿w
;

150 
ušt32_t
 
rdy
 : 1;

153 
ušt32_t
 
cfs
 : 1;

156 
ušt32_t
 
sh¡
 : 2;

158 
ušt32_t
 
»£rved1
 : 28;

159 } 
b™s
;

161 
SPDK_STATIC_ASSERT
((
¥dk_nvme_c¡s_»gi¡”
) == 4, "Incorrect size");

163 
	e¥dk_nvme_sh¡_v®ue
 {

164 
SPDK_NVME_SHST_NORMAL
 = 0x0,

165 
SPDK_NVME_SHST_OCCURRING
 = 0x1,

166 
SPDK_NVME_SHST_COMPLETE
 = 0x2,

169 
	u¥dk_nvme_aqa_»gi¡”
 {

170 
ušt32_t
 
¿w
;

173 
ušt32_t
 
asqs
 : 12;

175 
ušt32_t
 
»£rved1
 : 4;

178 
ušt32_t
 
acqs
 : 12;

180 
ušt32_t
 
»£rved2
 : 4;

181 } 
b™s
;

183 
SPDK_STATIC_ASSERT
((
¥dk_nvme_aqa_»gi¡”
) == 4, "Incorrect size");

185 
	u¥dk_nvme_vs_»gi¡”
 {

186 
ušt32_t
 
¿w
;

189 
ušt32_t
 
‹r
 : 8;

191 
ušt32_t
 
mÄ
 : 8;

193 
ušt32_t
 
mjr
 : 16;

194 } 
b™s
;

196 
SPDK_STATIC_ASSERT
((
¥dk_nvme_vs_»gi¡”
) == 4, "Incorrect size");

199 
	#SPDK_NVME_VERSION
(
mjr
, 
mÄ
, 
‹r
) \

200 (((
ušt32_t
)(
mjr
) << 16) | \

201 ((
ušt32_t
)(
mÄ
) << 8) | \

202 (
ušt32_t
)(
‹r
))

	)

205 
SPDK_STATIC_ASSERT
(
SPDK_NVME_VERSION
(1, 0, 0) == 0x00010000, "version macroƒrror");

206 
SPDK_STATIC_ASSERT
(
SPDK_NVME_VERSION
(1, 2, 1) == 0x00010201, "version macroƒrror");

208 
	u¥dk_nvme_cmbloc_»gi¡”
 {

209 
ušt32_t
 
¿w
;

212 
ušt32_t
 
bœ
 : 3;

213 
ušt32_t
 
»£rved1
 : 9;

215 
ušt32_t
 
of¡
 : 20;

216 } 
b™s
;

218 
SPDK_STATIC_ASSERT
((
¥dk_nvme_cmbloc_»gi¡”
) == 4, "Incorrect size");

220 
	u¥dk_nvme_cmbsz_»gi¡”
 {

221 
ušt32_t
 
¿w
;

224 
ušt32_t
 
sqs
 : 1;

226 
ušt32_t
 
cqs
 : 1;

228 
ušt32_t
 
li¡s
 : 1;

230 
ušt32_t
 
rds
 : 1;

232 
ušt32_t
 
wds
 : 1;

233 
ušt32_t
 
»£rved1
 : 3;

235 
ušt32_t
 
szu
 : 4;

237 
ušt32_t
 
sz
 : 20;

238 } 
b™s
;

240 
SPDK_STATIC_ASSERT
((
¥dk_nvme_cmbsz_»gi¡”
) == 4, "Incorrect size");

242 
	s¥dk_nvme_»gi¡”s
 {

244 
¥dk_nvme_ÿp_»gi¡”
 
ÿp
;

247 
¥dk_nvme_vs_»gi¡”
 
vs
;

248 
ušt32_t
 
štms
;

249 
ušt32_t
 
štmc
;

252 
¥dk_nvme_cc_»gi¡”
 
cc
;

254 
ušt32_t
 
»£rved1
;

255 
¥dk_nvme_c¡s_»gi¡”
 
c¡s
;

256 
ušt32_t
 
ns¤
;

259 
¥dk_nvme_aqa_»gi¡”
 
aqa
;

261 
ušt64_t
 
asq
;

262 
ušt64_t
 
acq
;

264 
¥dk_nvme_cmbloc_»gi¡”
 
cmbloc
;

266 
¥dk_nvme_cmbsz_»gi¡”
 
cmbsz
;

267 
ušt32_t
 
»£rved3
[0x3f0];

270 
ušt32_t
 
sq_tdbl
;

271 
ušt32_t
 
cq_hdbl
;

272 } 
doÜb–l
[1];

276 
SPDK_STATIC_ASSERT
(0x00 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
ÿp
),

278 
SPDK_STATIC_ASSERT
(0x08 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
vs
), "Incorrect„egister offset");

279 
SPDK_STATIC_ASSERT
(0x0C =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
štms
),

281 
SPDK_STATIC_ASSERT
(0x10 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
štmc
),

283 
SPDK_STATIC_ASSERT
(0x14 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
cc
), "Incorrect„egister offset");

284 
SPDK_STATIC_ASSERT
(0x1C =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
c¡s
), "Incorrect„egister offset");

285 
SPDK_STATIC_ASSERT
(0x20 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
ns¤
), "Incorrect„egister offset");

286 
SPDK_STATIC_ASSERT
(0x24 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
aqa
), "Incorrect„egister offset");

287 
SPDK_STATIC_ASSERT
(0x28 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
asq
), "Incorrect„egister offset");

288 
SPDK_STATIC_ASSERT
(0x30 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
acq
), "Incorrect„egister offset");

289 
SPDK_STATIC_ASSERT
(0x38 =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
cmbloc
),

291 
SPDK_STATIC_ASSERT
(0x3C =ğ
off£tof
(
¥dk_nvme_»gi¡”s
, 
cmbsz
),

294 
	e¥dk_nvme_sgl_desütÜ_ty³
 {

295 
SPDK_NVME_SGL_TYPE_DATA_BLOCK
 = 0x0,

296 
SPDK_NVME_SGL_TYPE_BIT_BUCKET
 = 0x1,

297 
SPDK_NVME_SGL_TYPE_SEGMENT
 = 0x2,

298 
SPDK_NVME_SGL_TYPE_LAST_SEGMENT
 = 0x3,

299 
SPDK_NVME_SGL_TYPE_KEYED_DATA_BLOCK
 = 0x4,

301 
SPDK_NVME_SGL_TYPE_VENDOR_SPECIFIC
 = 0xF

304 
	e¥dk_nvme_sgl_desütÜ_subty³
 {

305 
SPDK_NVME_SGL_SUBTYPE_ADDRESS
 = 0x0,

306 
SPDK_NVME_SGL_SUBTYPE_OFFSET
 = 0x1,

309 
__©Œibu‹__
((
·cked
)è
¥dk_nvme_sgl_desütÜ
 {

310 
ušt64_t
 
add»ss
;

313 
ušt8_t
 
»£rved
[7];

314 
ušt8_t
 
subty³
 : 4;

315 
ušt8_t
 
ty³
 : 4;

316 } 
g’”ic
;

319 
ušt32_t
 
Ëngth
;

320 
ušt8_t
 
»£rved
[3];

321 
ušt8_t
 
subty³
 : 4;

322 
ušt8_t
 
ty³
 : 4;

323 } 
unkeyed
;

326 
ušt64_t
 
Ëngth
 : 24;

327 
ušt64_t
 
key
 : 32;

328 
ušt64_t
 
subty³
 : 4;

329 
ušt64_t
 
ty³
 : 4;

330 } 
keyed
;

333 
SPDK_STATIC_ASSERT
((
¥dk_nvme_sgl_desütÜ
) == 16, "Incorrect size");

335 
	e¥dk_nvme_psdt_v®ue
 {

336 
SPDK_NVME_PSDT_PRP
 = 0x0,

337 
SPDK_NVME_PSDT_SGL_MPTR_CONTIG
 = 0x1,

338 
SPDK_NVME_PSDT_SGL_MPTR_SGL
 = 0x2,

339 
SPDK_NVME_PSDT_RESERVED
 = 0x3

347 
	e¥dk_nvme_q´io
 {

348 
SPDK_NVME_QPRIO_URGENT
 = 0x0,

349 
SPDK_NVME_QPRIO_HIGH
 = 0x1,

350 
SPDK_NVME_QPRIO_MEDIUM
 = 0x2,

351 
SPDK_NVME_QPRIO_LOW
 = 0x3

360 
	e¥dk_nvme_ÿp_ams
 {

361 
SPDK_NVME_CAP_AMS_WRR
 = 0x1,

362 
SPDK_NVME_CAP_AMS_VS
 = 0x2,

370 
	e¥dk_nvme_cc_ams
 {

371 
SPDK_NVME_CC_AMS_RR
 = 0x0,

372 
SPDK_NVME_CC_AMS_WRR
 = 0x1,

373 
SPDK_NVME_CC_AMS_VS
 = 0x7,

376 
	s¥dk_nvme_cmd
 {

378 
ušt16_t
 
İc
 : 8;

379 
ušt16_t
 
fu£
 : 2;

380 
ušt16_t
 
rsvd1
 : 4;

381 
ušt16_t
 
psdt
 : 2;

382 
ušt16_t
 
cid
;

385 
ušt32_t
 
nsid
;

388 
ušt32_t
 
rsvd2
;

389 
ušt32_t
 
rsvd3
;

392 
ušt64_t
 
m±r
;

397 
ušt64_t
 
´p1
;

398 
ušt64_t
 
´p2
;

399 } 
´p
;

401 
¥dk_nvme_sgl_desütÜ
 
sgl1
;

402 } 
d±r
;

405 
ušt32_t
 
cdw10
;

406 
ušt32_t
 
cdw11
;

407 
ušt32_t
 
cdw12
;

408 
ušt32_t
 
cdw13
;

409 
ušt32_t
 
cdw14
;

410 
ušt32_t
 
cdw15
;

412 
SPDK_STATIC_ASSERT
((
¥dk_nvme_cmd
) == 64, "Incorrect size");

414 
	s¥dk_nvme_¡©us
 {

415 
ušt16_t
 
p
 : 1;

416 
ušt16_t
 
sc
 : 8;

417 
ušt16_t
 
sù
 : 3;

418 
ušt16_t
 
rsvd2
 : 2;

419 
ušt16_t
 
m
 : 1;

420 
ušt16_t
 
dÄ
 : 1;

422 
SPDK_STATIC_ASSERT
((
¥dk_nvme_¡©us
) == 2, "Incorrect size");

427 
	s¥dk_nvme_ıl
 {

429 
ušt32_t
 
cdw0
;

432 
ušt32_t
 
rsvd1
;

435 
ušt16_t
 
sqhd
;

436 
ušt16_t
 
sqid
;

439 
ušt16_t
 
cid
;

440 
¥dk_nvme_¡©us
 
¡©us
;

442 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ıl
) == 16, "Incorrect size");

447 
	s¥dk_nvme_dsm_¿nge
 {

450 
ušt32_t
 
af
 : 4;

451 
ušt32_t
 
®
 : 2;

452 
ušt32_t
 
»£rved0
 : 2;

454 
ušt32_t
 
¤
 : 1;

455 
ušt32_t
 
sw
 : 1;

456 
ušt32_t
 
wp
 : 1;

457 
ušt32_t
 
»£rved1
 : 13;

459 
ušt32_t
 
acûss_size
 : 8;

460 } 
b™s
;

462 
ušt32_t
 
¿w
;

463 } 
©Œibu‹s
;

465 
ušt32_t
 
Ëngth
;

466 
ušt64_t
 
¡¬tšg_lba
;

468 
SPDK_STATIC_ASSERT
((
¥dk_nvme_dsm_¿nge
) == 16, "Incorrect size");

473 
	e¥dk_nvme_¡©us_code_ty³
 {

474 
SPDK_NVME_SCT_GENERIC
 = 0x0,

475 
SPDK_NVME_SCT_COMMAND_SPECIFIC
 = 0x1,

476 
SPDK_NVME_SCT_MEDIA_ERROR
 = 0x2,

477 
KV_NVME_SCT_ERROR
 = 0x3,

479 
SPDK_NVME_SCT_VENDOR_SPECIFIC
 = 0x7,

482 
	e§msung_kv_nvme_commªd_¡©us_code
 {

484 
KV_NVME_SC_INVALID_VALUE_SIZE
 = 0x01,

485 
KV_NVME_SC_INVALID_VALUE_OFFSET
 = 0x02,

486 
KV_NVME_SC_INVALID_KEY_SIZE
 = 0x03,

487 
KV_NVME_SC_INVALID_OPTION
 = 0x04,

490 
KV_NVME_SC_MISALIGNED_VALUE_SIZE
 = 0x08,

491 
KV_NVME_SC_MISALIGNED_VALUE_OFFSET
 = 0x09,

492 
KV_NVME_SC_MISALIGNED_KEY_SIZE
 = 0x0A,

495 
KV_NVME_SC_NOT_EXIST_KEY
 = 0x10,

496 
KV_NVME_SC_UNRECOVERED_ERROR
 = 0x11,

497 
KV_NVME_SC_CAPACITY_EXCEEDED
 = 0x12,

500 
KV_NVME_SC_IDEMPOTENT_STORE_FAIL
 = 0x80,

501 
KV_NVME_SC_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
 = 0x81,

504 
KV_NVME_SC_INVALID_ITERATE_HANDLE
 = 0x90,

505 
KV_NVME_SC_NO_AVAILABLE_ITERATE_HANDLE
 = 0x91,

506 
KV_NVME_SC_ITERATE_HANDLE_ALREADY_OPENED
 = 0x92,

507 
KV_NVME_SC_ITERATE_READ_EOF
 = 0x93,

508 
KV_NVME_SC_ITERATE_REQUEST_FAIL
 = 0x94,

514 
	e¥dk_nvme_g’”ic_commªd_¡©us_code
 {

515 
SPDK_NVME_SC_SUCCESS
 = 0x00,

516 
SPDK_NVME_SC_INVALID_OPCODE
 = 0x01,

517 
SPDK_NVME_SC_INVALID_FIELD
 = 0x02,

518 
SPDK_NVME_SC_COMMAND_ID_CONFLICT
 = 0x03,

519 
SPDK_NVME_SC_DATA_TRANSFER_ERROR
 = 0x04,

520 
SPDK_NVME_SC_ABORTED_POWER_LOSS
 = 0x05,

521 
SPDK_NVME_SC_INTERNAL_DEVICE_ERROR
 = 0x06,

522 
SPDK_NVME_SC_ABORTED_BY_REQUEST
 = 0x07,

523 
SPDK_NVME_SC_ABORTED_SQ_DELETION
 = 0x08,

524 
SPDK_NVME_SC_ABORTED_FAILED_FUSED
 = 0x09,

525 
SPDK_NVME_SC_ABORTED_MISSING_FUSED
 = 0x0a,

526 
SPDK_NVME_SC_INVALID_NAMESPACE_OR_FORMAT
 = 0x0b,

527 
SPDK_NVME_SC_COMMAND_SEQUENCE_ERROR
 = 0x0c,

528 
SPDK_NVME_SC_INVALID_SGL_SEG_DESCRIPTOR
 = 0x0d,

529 
SPDK_NVME_SC_INVALID_NUM_SGL_DESCIRPTORS
 = 0x0e,

530 
SPDK_NVME_SC_DATA_SGL_LENGTH_INVALID
 = 0x0f,

531 
SPDK_NVME_SC_METADATA_SGL_LENGTH_INVALID
 = 0x10,

532 
SPDK_NVME_SC_SGL_DESCRIPTOR_TYPE_INVALID
 = 0x11,

533 
SPDK_NVME_SC_INVALID_CONTROLLER_MEM_BUF
 = 0x12,

534 
SPDK_NVME_SC_INVALID_PRP_OFFSET
 = 0x13,

535 
SPDK_NVME_SC_ATOMIC_WRITE_UNIT_EXCEEDED
 = 0x14,

536 
SPDK_NVME_SC_INVALID_SGL_OFFSET
 = 0x16,

537 
SPDK_NVME_SC_INVALID_SGL_SUBTYPE
 = 0x17,

538 
SPDK_NVME_SC_HOSTID_INCONSISTENT_FORMAT
 = 0x18,

539 
SPDK_NVME_SC_KEEP_ALIVE_EXPIRED
 = 0x19,

540 
SPDK_NVME_SC_KEEP_ALIVE_INVALID
 = 0x1a,

542 
SPDK_NVME_SC_LBA_OUT_OF_RANGE
 = 0x80,

543 
SPDK_NVME_SC_CAPACITY_EXCEEDED
 = 0x81,

544 
SPDK_NVME_SC_NAMESPACE_NOT_READY
 = 0x82,

545 
SPDK_NVME_SC_RESERVATION_CONFLICT
 = 0x83,

546 
SPDK_NVME_SC_FORMAT_IN_PROGRESS
 = 0x84,

552 
	e¥dk_nvme_commªd_¥ecific_¡©us_code
 {

553 
SPDK_NVME_SC_COMPLETION_QUEUE_INVALID
 = 0x00,

554 
SPDK_NVME_SC_INVALID_QUEUE_IDENTIFIER
 = 0x01,

555 
SPDK_NVME_SC_MAXIMUM_QUEUE_SIZE_EXCEEDED
 = 0x02,

556 
SPDK_NVME_SC_ABORT_COMMAND_LIMIT_EXCEEDED
 = 0x03,

558 
SPDK_NVME_SC_ASYNC_EVENT_REQUEST_LIMIT_EXCEEDED
 = 0x05,

559 
SPDK_NVME_SC_INVALID_FIRMWARE_SLOT
 = 0x06,

560 
SPDK_NVME_SC_INVALID_FIRMWARE_IMAGE
 = 0x07,

561 
SPDK_NVME_SC_INVALID_INTERRUPT_VECTOR
 = 0x08,

562 
SPDK_NVME_SC_INVALID_LOG_PAGE
 = 0x09,

563 
SPDK_NVME_SC_INVALID_FORMAT
 = 0x0a,

564 
SPDK_NVME_SC_FIRMWARE_REQ_CONVENTIONAL_RESET
 = 0x0b,

565 
SPDK_NVME_SC_INVALID_QUEUE_DELETION
 = 0x0c,

566 
SPDK_NVME_SC_FEATURE_ID_NOT_SAVEABLE
 = 0x0d,

567 
SPDK_NVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x0e,

568 
SPDK_NVME_SC_FEATURE_NOT_NAMESPACE_SPECIFIC
 = 0x0f,

569 
SPDK_NVME_SC_FIRMWARE_REQ_NVM_RESET
 = 0x10,

570 
SPDK_NVME_SC_FIRMWARE_REQ_RESET
 = 0x11,

571 
SPDK_NVME_SC_FIRMWARE_REQ_MAX_TIME_VIOLATION
 = 0x12,

572 
SPDK_NVME_SC_FIRMWARE_ACTIVATION_PROHIBITED
 = 0x13,

573 
SPDK_NVME_SC_OVERLAPPING_RANGE
 = 0x14,

574 
SPDK_NVME_SC_NAMESPACE_INSUFFICIENT_CAPACITY
 = 0x15,

575 
SPDK_NVME_SC_NAMESPACE_ID_UNAVAILABLE
 = 0x16,

577 
SPDK_NVME_SC_NAMESPACE_ALREADY_ATTACHED
 = 0x18,

578 
SPDK_NVME_SC_NAMESPACE_IS_PRIVATE
 = 0x19,

579 
SPDK_NVME_SC_NAMESPACE_NOT_ATTACHED
 = 0x1a,

580 
SPDK_NVME_SC_THINPROVISIONING_NOT_SUPPORTED
 = 0x1b,

581 
SPDK_NVME_SC_CONTROLLER_LIST_INVALID
 = 0x1c,

583 
SPDK_NVME_SC_CONFLICTING_ATTRIBUTES
 = 0x80,

584 
SPDK_NVME_SC_INVALID_PROTECTION_INFO
 = 0x81,

585 
SPDK_NVME_SC_ATTEMPTED_WRITE_TO_RO_PAGE
 = 0x82,

591 
	e¥dk_nvme_medŸ_”rÜ_¡©us_code
 {

592 
SPDK_NVME_SC_WRITE_FAULTS
 = 0x80,

593 
SPDK_NVME_SC_UNRECOVERED_READ_ERROR
 = 0x81,

594 
SPDK_NVME_SC_GUARD_CHECK_ERROR
 = 0x82,

595 
SPDK_NVME_SC_APPLICATION_TAG_CHECK_ERROR
 = 0x83,

596 
SPDK_NVME_SC_REFERENCE_TAG_CHECK_ERROR
 = 0x84,

597 
SPDK_NVME_SC_COMPARE_FAILURE
 = 0x85,

598 
SPDK_NVME_SC_ACCESS_DENIED
 = 0x86,

599 
SPDK_NVME_SC_DEALLOCATED_OR_UNWRITTEN_BLOCK
 = 0x87,

605 
	e¥dk_nvme_admš_İcode
 {

606 
SPDK_NVME_OPC_DELETE_IO_SQ
 = 0x00,

607 
SPDK_NVME_OPC_CREATE_IO_SQ
 = 0x01,

608 
SPDK_NVME_OPC_GET_LOG_PAGE
 = 0x02,

610 
SPDK_NVME_OPC_DELETE_IO_CQ
 = 0x04,

611 
SPDK_NVME_OPC_CREATE_IO_CQ
 = 0x05,

612 
SPDK_NVME_OPC_IDENTIFY
 = 0x06,

614 
SPDK_NVME_OPC_ABORT
 = 0x08,

615 
SPDK_NVME_OPC_SET_FEATURES
 = 0x09,

616 
SPDK_NVME_OPC_GET_FEATURES
 = 0x0a,

618 
SPDK_NVME_OPC_ASYNC_EVENT_REQUEST
 = 0x0c,

619 
SPDK_NVME_OPC_NS_MANAGEMENT
 = 0x0d,

621 
SPDK_NVME_OPC_FIRMWARE_COMMIT
 = 0x10,

622 
SPDK_NVME_OPC_FIRMWARE_IMAGE_DOWNLOAD
 = 0x11,

624 
SPDK_NVME_OPC_NS_ATTACHMENT
 = 0x15,

626 
SPDK_NVME_OPC_KEEP_ALIVE
 = 0x18,

628 
SPDK_NVME_OPC_FORMAT_NVM
 = 0x80,

629 
SPDK_NVME_OPC_SECURITY_SEND
 = 0x81,

630 
SPDK_NVME_OPC_SECURITY_RECEIVE
 = 0x82,

636 
	e¥dk_nvme_nvm_İcode
 {

637 
SPDK_NVME_OPC_FLUSH
 = 0x00,

638 
SPDK_NVME_OPC_WRITE
 = 0x01,

639 
SPDK_NVME_OPC_READ
 = 0x02,

641 
SPDK_NVME_OPC_WRITE_UNCORRECTABLE
 = 0x04,

642 
SPDK_NVME_OPC_COMPARE
 = 0x05,

644 
SPDK_NVME_OPC_WRITE_ZEROES
 = 0x08,

645 
SPDK_NVME_OPC_DATASET_MANAGEMENT
 = 0x09,

647 
SPDK_NVME_OPC_RESERVATION_REGISTER
 = 0x0d,

648 
SPDK_NVME_OPC_RESERVATION_REPORT
 = 0x0e,

650 
SPDK_NVME_OPC_RESERVATION_ACQUIRE
 = 0x11,

651 
SPDK_NVME_OPC_RESERVATION_RELEASE
 = 0x15,

659 
	e¥dk_nvme_d©a_Œªsãr
 {

661 
SPDK_NVME_DATA_NONE
 = 0,

663 
SPDK_NVME_DATA_HOST_TO_CONTROLLER
 = 1,

665 
SPDK_NVME_DATA_CONTROLLER_TO_HOST
 = 2,

667 
SPDK_NVME_DATA_BIDIRECTIONAL
 = 3

677 
šlše
 
¥dk_nvme_d©a_Œªsãr
 
¥dk_nvme_İc_g‘_d©a_Œªsãr
(
ušt8_t
 
İc
)

679  (
¥dk_nvme_d©a_Œªsãr
)(
İc
 & 3);

682 
	e¥dk_nvme_ã©
 {

684 
SPDK_NVME_FEAT_ARBITRATION
 = 0x01,

685 
SPDK_NVME_FEAT_POWER_MANAGEMENT
 = 0x02,

686 
SPDK_NVME_FEAT_LBA_RANGE_TYPE
 = 0x03,

687 
SPDK_NVME_FEAT_TEMPERATURE_THRESHOLD
 = 0x04,

688 
SPDK_NVME_FEAT_ERROR_RECOVERY
 = 0x05,

689 
SPDK_NVME_FEAT_VOLATILE_WRITE_CACHE
 = 0x06,

690 
SPDK_NVME_FEAT_NUMBER_OF_QUEUES
 = 0x07,

691 
SPDK_NVME_FEAT_INTERRUPT_COALESCING
 = 0x08,

692 
SPDK_NVME_FEAT_INTERRUPT_VECTOR_CONFIGURATION
 = 0x09,

693 
SPDK_NVME_FEAT_WRITE_ATOMICITY
 = 0x0A,

694 
SPDK_NVME_FEAT_ASYNC_EVENT_CONFIGURATION
 = 0x0B,

695 
SPDK_NVME_FEAT_AUTONOMOUS_POWER_STATE_TRANSITION
 = 0x0C,

696 
SPDK_NVME_FEAT_HOST_MEM_BUFFER
 = 0x0D,

697 
SPDK_NVME_FEAT_KEEP_ALIVE_TIMER
 = 0x0F,

699 
SPDK_NVME_FEAT_SOFTWARE_PROGRESS_MARKER
 = 0x80,

701 
SPDK_NVME_FEAT_HOST_IDENTIFIER
 = 0x81,

702 
SPDK_NVME_FEAT_HOST_RESERVE_MASK
 = 0x82,

703 
SPDK_NVME_FEAT_HOST_RESERVE_PERSIST
 = 0x83,

707 
	e¥dk_nvme_dsm_©Œibu‹
 {

708 
SPDK_NVME_DSM_ATTR_INTEGRAL_READ
 = 0x1,

709 
SPDK_NVME_DSM_ATTR_INTEGRAL_WRITE
 = 0x2,

710 
SPDK_NVME_DSM_ATTR_DEALLOCATE
 = 0x4,

713 
	s¥dk_nvme_pow”_¡©e
 {

714 
ušt16_t
 
mp
;

716 
ušt8_t
 
»£rved1
;

718 
ušt8_t
 
mps
 : 1;

719 
ušt8_t
 
nİs
 : 1;

720 
ušt8_t
 
»£rved2
 : 6;

722 
ušt32_t
 
’Ït
;

723 
ušt32_t
 
exÏt
;

725 
ušt8_t
 
¼t
 : 5;

726 
ušt8_t
 
»£rved3
 : 3;

728 
ušt8_t
 
¼l
 : 5;

729 
ušt8_t
 
»£rved4
 : 3;

731 
ušt8_t
 
rwt
 : 5;

732 
ušt8_t
 
»£rved5
 : 3;

734 
ušt8_t
 
rwl
 : 5;

735 
ušt8_t
 
»£rved6
 : 3;

737 
ušt8_t
 
»£rved7
[16];

739 
SPDK_STATIC_ASSERT
((
¥dk_nvme_pow”_¡©e
) == 32, "Incorrect size");

742 
	e¥dk_nvme_id’tify_ús
 {

744 
SPDK_NVME_IDENTIFY_NS
 = 0x00,

747 
SPDK_NVME_IDENTIFY_CTRLR
 = 0x01,

750 
SPDK_NVME_IDENTIFY_ACTIVE_NS_LIST
 = 0x02,

753 
SPDK_NVME_IDENTIFY_ALLOCATED_NS_LIST
 = 0x10,

756 
SPDK_NVME_IDENTIFY_NS_ALLOCATED
 = 0x11,

759 
SPDK_NVME_IDENTIFY_NS_ATTACHED_CTRLR_LIST
 = 0x12,

762 
SPDK_NVME_IDENTIFY_CTRLR_LIST
 = 0x13,

766 
	e¥dk_nvmf_ù¾r_mod–
 {

768 
SPDK_NVMF_CTRLR_MODEL_DYNAMIC
 = 0,

771 
SPDK_NVMF_CTRLR_MODEL_STATIC
 = 1,

774 
__©Œibu‹__
((
·cked
)è
¥dk_nvme_ù¾r_d©a
 {

778 
ušt16_t
 
vid
;

781 
ušt16_t
 
ssvid
;

784 
št8_t
 
¢
[20];

787 
št8_t
 
mn
[40];

790 
ušt8_t
 
ä
[8];

793 
ušt8_t
 
¿b
;

796 
ušt8_t
 
›“
[3];

800 
ušt8_t
 
muÉi_pÜt
 : 1;

801 
ušt8_t
 
muÉi_ho¡
 : 1;

802 
ušt8_t
 
¤_iov
 : 1;

803 
ušt8_t
 
»£rved
 : 5;

804 } 
cmic
;

807 
ušt8_t
 
mdts
;

810 
ušt16_t
 
úid
;

813 
¥dk_nvme_vs_»gi¡”
 
v”
;

816 
ušt32_t
 
¹d3r
;

819 
ušt32_t
 
¹d3e
;

823 
ušt32_t
 
»£rved1
 : 8;

826 
ušt32_t
 
ns_©Œibu‹_nÙiûs
 : 1;

829 
ušt32_t
 
fw_aùiv©iÚ_nÙiûs
 : 1;

831 
ušt32_t
 
»£rved2
 : 22;

832 } 
ßes
;

836 
ušt32_t
 
ho¡_id_exhid_suµÜ‹d
: 1;

837 
ušt32_t
 
»£rved
: 31;

838 } 
ù¿‰
;

840 
ušt8_t
 
»£rved1
[156];

847 
ušt16_t
 
£cur™y
 : 1;

850 
ušt16_t
 
fÜm©
 : 1;

853 
ušt16_t
 
fœmw¬e
 : 1;

856 
ušt16_t
 
ns_mªage
 : 1;

858 
ušt16_t
 
ßcs_rsvd
 : 12;

859 } 
ßcs
;

862 
ušt8_t
 
aş
;

865 
ušt8_t
 
«¾
;

870 
ušt8_t
 
¦Ù1_ro
 : 1;

873 
ušt8_t
 
num_¦Ùs
 : 3;

876 
ušt8_t
 
aùiv©iÚ_w™hout_»£t
 : 1;

878 
ušt8_t
 
ämw_rsvd
 : 3;

879 } 
ämw
;

884 
ušt8_t
 
ns_sm¬t
 : 1;

886 
ušt8_t
 
ûÍ
 : 1;

888 
ušt8_t
 
edÍ
: 1;

889 
ušt8_t
 
Ía_rsvd
 : 5;

890 } 
Ía
;

893 
ušt8_t
 
–³
;

896 
ušt8_t
 
Åss
;

901 
ušt8_t
 
¥ec_fÜm©
 : 1;

903 
ušt8_t
 
avscc_rsvd
 : 7;

904 } 
avscc
;

909 
ušt8_t
 
suµÜ‹d
 : 1;

911 
ušt8_t
 
­¡a_rsvd
 : 7;

912 } 
­¡a
;

915 
ušt16_t
 
wùemp
;

918 
ušt16_t
 
cùemp
;

921 
ušt16_t
 
mtç
;

924 
ušt32_t
 
hm´e
;

927 
ušt32_t
 
hmmš
;

930 
ušt64_t
 
Švmÿp
[2];

933 
ušt64_t
 
unvmÿp
[2];

937 
ušt8_t
 
num_½mb_un™s
 : 3;

938 
ušt8_t
 
auth_m‘hod
 : 3;

939 
ušt8_t
 
»£rved1
 : 2;

941 
ušt8_t
 
»£rved2
;

943 
ušt8_t
 
tÙ®_size
;

944 
ušt8_t
 
acûss_size
;

945 } 
½mbs
;

947 
ušt8_t
 
»£rved2
[4];

949 
ušt16_t
 
kas
;

951 
ušt8_t
 
»£rved3
[190];

957 
ušt8_t
 
mš
 : 4;

958 
ušt8_t
 
max
 : 4;

959 } 
sqes
;

963 
ušt8_t
 
mš
 : 4;

964 
ušt8_t
 
max
 : 4;

965 } 
cqes
;

967 
ušt16_t
 
maxcmd
;

970 
ušt32_t
 
Â
;

974 
ušt16_t
 
com·»
 : 1;

975 
ušt16_t
 
wr™e_unc
 : 1;

976 
ušt16_t
 
dsm
: 1;

977 
ušt16_t
 
wr™e_z”Ûs
: 1;

978 
ušt16_t
 
£t_ã©u»s_§ve
: 1;

979 
ušt16_t
 
»£rv©iÚs
: 1;

980 
ušt16_t
 
»£rved
: 10;

981 } 
Úcs
;

984 
ušt16_t
 
fu£s
;

988 
ušt8_t
 
fÜm©_®l_ns
: 1;

989 
ušt8_t
 
”a£_®l_ns
: 1;

990 
ušt8_t
 
üy±o_”a£_suµÜ‹d
: 1;

991 
ušt8_t
 
»£rved
: 5;

992 } 
âa
;

996 
ušt8_t
 
´e£Á
 : 1;

997 
ušt8_t
 
»£rved
 : 7;

998 } 
vwc
;

1001 
ušt16_t
 
awun
;

1004 
ušt16_t
 
awupf
;

1007 
ušt8_t
 
nvscc
;

1009 
ušt8_t
 
»£rved531
;

1012 
ušt16_t
 
acwu
;

1014 
ušt16_t
 
»£rved534
;

1018 
ušt32_t
 
suµÜ‹d
 : 1;

1019 
ušt32_t
 
»£rved0
 : 1;

1020 
ušt32_t
 
keyed_sgl
 : 1;

1021 
ušt32_t
 
»£rved1
 : 13;

1022 
ušt32_t
 
b™_buck‘_desütÜ
 : 1;

1023 
ušt32_t
 
m‘ad©a_poš‹r
 : 1;

1024 
ušt32_t
 
ov”sized_sgl
 : 1;

1025 
ušt32_t
 
m‘ad©a_add»ss
 : 1;

1026 
ušt32_t
 
sgl_off£t
 : 1;

1027 
ušt32_t
 
»£rved2
: 11;

1028 } 
sgls
;

1030 
ušt8_t
 
»£rved4
[228];

1032 
ušt8_t
 
subnqn
[256];

1034 
ušt8_t
 
»£rved5
[768];

1039 
ušt32_t
 
ioccsz
;

1042 
ušt32_t
 
iÜcsz
;

1045 
ušt16_t
 
icdoff
;

1050 
ušt8_t
 
ù¾r_mod–
 : 1;

1051 
ušt8_t
 
»£rved
 : 7;

1052 } 
ù¿‰r
;

1055 
ušt8_t
 
msdbd
;

1057 
ušt8_t
 
»£rved
[244];

1058 } 
nvmf_¥ecific
;

1061 
¥dk_nvme_pow”_¡©e
 
psd
[32];

1064 
ušt8_t
 
vs
[1024];

1066 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ù¾r_d©a
) == 4096, "Incorrect size");

1068 
	s¥dk_nvme_ns_d©a
 {

1070 
ušt64_t
 
nsze
;

1073 
ušt64_t
 
nÿp
;

1076 
ušt64_t
 
nu£
;

1081 
ušt8_t
 
thš_´ov
 : 1;

1082 
ušt8_t
 
»£rved1
 : 7;

1083 } 
nsã©
;

1086 
ušt8_t
 
Æbaf
;

1090 
ušt8_t
 
fÜm©
 : 4;

1091 
ušt8_t
 
ex‹nded
 : 1;

1092 
ušt8_t
 
»£rved2
 : 3;

1093 } 
æbas
;

1098 
ušt8_t
 
ex‹nded
 : 1;

1101 
ušt8_t
 
poš‹r
 : 1;

1104 
ušt8_t
 
»£rved3
 : 6;

1105 } 
mc
;

1110 
ušt8_t
 
p™1
 : 1;

1113 
ušt8_t
 
p™2
 : 1;

1116 
ušt8_t
 
p™3
 : 1;

1119 
ušt8_t
 
md_¡¬t
 : 1;

1122 
ušt8_t
 
md_’d
 : 1;

1123 } 
dpc
;

1128 
ušt8_t
 
p™
 : 3;

1132 
ušt8_t
 
md_¡¬t
 : 1;

1134 
ušt8_t
 
»£rved4
 : 4;

1135 } 
dps
;

1139 
ušt8_t
 
ÿn_sh¬e
 : 1;

1140 
ušt8_t
 
»£rved
 : 7;

1141 } 
nmic
;

1147 
ušt8_t
 
³rsi¡
 : 1;

1150 
ušt8_t
 
wr™e_exşusive
 : 1;

1153 
ušt8_t
 
exşusive_acûss
 : 1;

1156 
ušt8_t
 
wr™e_exşusive_»g_Úly
 : 1;

1159 
ušt8_t
 
exşusive_acûss_»g_Úly
 : 1;

1162 
ušt8_t
 
wr™e_exşusive_®l_»g
 : 1;

1165 
ušt8_t
 
exşusive_acûss_®l_»g
 : 1;

1167 
ušt8_t
 
»£rved
 : 1;

1168 } 
»sÿp
;

1169 
ušt8_t
 
¿w
;

1170 } 
n¤esÿp
;

1173 
ušt8_t
 
³rûÁage_»maššg
 : 7;

1174 
ušt8_t
 
åi_suµÜ‹d
 : 1;

1175 } 
åi
;

1177 
ušt8_t
 
»£rved33
;

1180 
ušt16_t
 
Çwun
;

1183 
ušt16_t
 
Çwupf
;

1186 
ušt16_t
 
Çcwu
;

1189 
ušt16_t
 
Çb¢
;

1192 
ušt16_t
 
Çbo
;

1195 
ušt16_t
 
Çb¥f
;

1197 
ušt16_t
 
»£rved46
;

1200 
ušt64_t
 
nvmÿp
[2];

1202 
ušt8_t
 
»£rved64
[40];

1205 
ušt8_t
 
nguid
[16];

1208 
ušt64_t
 
eui64
;

1213 
ušt32_t
 
ms
 : 16;

1216 
ušt32_t
 
lbads
 : 8;

1219 
ušt32_t
 
½
 : 2;

1221 
ušt32_t
 
»£rved6
 : 6;

1222 } 
lbaf
[16];

1224 
ušt8_t
 
»£rved6
[192];

1226 
ušt8_t
 
v’dÜ_¥ecific
[3712];

1228 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ns_d©a
) == 4096, "Incorrect size");

1233 
	e¥dk_nvme_»£rv©iÚ_ty³
 {

1237 
SPDK_NVME_RESERVE_WRITE_EXCLUSIVE
 = 0x1,

1240 
SPDK_NVME_RESERVE_EXCLUSIVE_ACCESS
 = 0x2,

1243 
SPDK_NVME_RESERVE_WRITE_EXCLUSIVE_REG_ONLY
 = 0x3,

1246 
SPDK_NVME_RESERVE_EXCLUSIVE_ACCESS_REG_ONLY
 = 0x4,

1249 
SPDK_NVME_RESERVE_WRITE_EXCLUSIVE_ALL_REGS
 = 0x5,

1252 
SPDK_NVME_RESERVE_EXCLUSIVE_ACCESS_ALL_REGS
 = 0x6,

1257 
	s¥dk_nvme_»£rv©iÚ_acquœe_d©a
 {

1259 
ušt64_t
 
ükey
;

1261 
ušt64_t
 
´key
;

1263 
SPDK_STATIC_ASSERT
((
¥dk_nvme_»£rv©iÚ_acquœe_d©a
) == 16, "Incorrect size");

1268 
	e¥dk_nvme_»£rv©iÚ_acquœe_aùiÚ
 {

1269 
SPDK_NVME_RESERVE_ACQUIRE
 = 0x0,

1270 
SPDK_NVME_RESERVE_PREEMPT
 = 0x1,

1271 
SPDK_NVME_RESERVE_PREEMPT_ABORT
 = 0x2,

1274 
__©Œibu‹__
((
·cked
)è
¥dk_nvme_»£rv©iÚ_¡©us_d©a
 {

1276 
ušt32_t
 
g’”©iÚ
;

1278 
ušt8_t
 
ty³
;

1280 
ušt16_t
 
Ä_»gùl
;

1281 
ušt16_t
 
»£rved1
;

1283 
ušt8_t
 
±¶_¡©e
;

1284 
ušt8_t
 
»£rved
[14];

1286 
SPDK_STATIC_ASSERT
((
¥dk_nvme_»£rv©iÚ_¡©us_d©a
) == 24, "Incorrect size");

1288 
__©Œibu‹__
((
·cked
)è
¥dk_nvme_»£rv©iÚ_ù¾r_d©a
 {

1289 
ušt16_t
 
ù¾r_id
;

1292 
ušt8_t
 
¡©us
 : 1;

1293 
ušt8_t
 
»£rved1
 : 7;

1294 } 
rc¡s
;

1295 
ušt8_t
 
»£rved2
[5];

1297 
ušt64_t
 
ho¡_id
;

1299 
ušt64_t
 
key
;

1301 
SPDK_STATIC_ASSERT
((
¥dk_nvme_»£rv©iÚ_ù¾r_d©a
) == 24, "Incorrect size");

1307 
	e¥dk_nvme_»£rv©iÚ_»gi¡”_ıl
 {

1308 
SPDK_NVME_RESERVE_PTPL_NO_CHANGES
 = 0x0,

1309 
SPDK_NVME_RESERVE_PTPL_CLEAR_POWER_ON
 = 0x2,

1310 
SPDK_NVME_RESERVE_PTPL_PERSIST_POWER_LOSS
 = 0x3,

1316 
	e¥dk_nvme_»£rv©iÚ_»gi¡”_aùiÚ
 {

1317 
SPDK_NVME_RESERVE_REGISTER_KEY
 = 0x0,

1318 
SPDK_NVME_RESERVE_UNREGISTER_KEY
 = 0x1,

1319 
SPDK_NVME_RESERVE_REPLACE_KEY
 = 0x2,

1322 
	s¥dk_nvme_»£rv©iÚ_»gi¡”_d©a
 {

1324 
ušt64_t
 
ükey
;

1326 
ušt64_t
 
Äkey
;

1328 
SPDK_STATIC_ASSERT
((
¥dk_nvme_»£rv©iÚ_»gi¡”_d©a
) == 16, "Incorrect size");

1330 
	s¥dk_nvme_»£rv©iÚ_key_d©a
 {

1332 
ušt64_t
 
ükey
;

1334 
SPDK_STATIC_ASSERT
((
¥dk_nvme_»£rv©iÚ_key_d©a
) == 8, "Incorrect size");

1339 
	e¥dk_nvme_»£rv©iÚ_»Ëa£_aùiÚ
 {

1340 
SPDK_NVME_RESERVE_RELEASE
 = 0x0,

1341 
SPDK_NVME_RESERVE_CLEAR
 = 0x1,

1347 
	e¥dk_nvme_log_·ge
 {

1351 
SPDK_NVME_LOG_ERROR
 = 0x01,

1354 
SPDK_NVME_LOG_HEALTH_INFORMATION
 = 0x02,

1357 
SPDK_NVME_LOG_FIRMWARE_SLOT
 = 0x03,

1360 
SPDK_NVME_LOG_CHANGED_NS_LIST
 = 0x04,

1363 
SPDK_NVME_LOG_COMMAND_EFFECTS_LOG
 = 0x05,

1368 
SPDK_NVME_LOG_DISCOVERY
 = 0x70,

1373 
SPDK_NVME_LOG_RESERVATION_NOTIFICATION
 = 0x80,

1383 
	s¥dk_nvme_”rÜ_šfÜm©iÚ_’Œy
 {

1384 
ušt64_t
 
”rÜ_couÁ
;

1385 
ušt16_t
 
sqid
;

1386 
ušt16_t
 
cid
;

1387 
¥dk_nvme_¡©us
 
¡©us
;

1388 
ušt16_t
 
”rÜ_loÿtiÚ
;

1389 
ušt64_t
 
lba
;

1390 
ušt32_t
 
nsid
;

1391 
ušt8_t
 
v’dÜ_¥ecific
;

1392 
ušt8_t
 
»£rved
[35];

1394 
SPDK_STATIC_ASSERT
((
¥dk_nvme_”rÜ_šfÜm©iÚ_’Œy
) == 64, "Incorrect size");

1396 
	u¥dk_nvme_ü™iÿl_w¬nšg_¡©e
 {

1397 
ušt8_t
 
¿w
;

1400 
ušt8_t
 
avaabË_¥¬e
 : 1;

1401 
ušt8_t
 
‹m³¿tu»
 : 1;

1402 
ušt8_t
 
deviû_»lŸb™y
 : 1;

1403 
ušt8_t
 
»ad_Úly
 : 1;

1404 
ušt8_t
 
vŞ©e_memÜy_backup
 : 1;

1405 
ušt8_t
 
»£rved
 : 3;

1406 } 
b™s
;

1408 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ü™iÿl_w¬nšg_¡©e
) == 1, "Incorrect size");

1413 
__©Œibu‹__
((
·cked
)è
¥dk_nvme_h—Éh_šfÜm©iÚ_·ge
 {

1414 
¥dk_nvme_ü™iÿl_w¬nšg_¡©e
 
ü™iÿl_w¬nšg
;

1416 
ušt16_t
 
‹m³¿tu»
;

1417 
ušt8_t
 
avaabË_¥¬e
;

1418 
ušt8_t
 
avaabË_¥¬e_th»shŞd
;

1419 
ušt8_t
 
³rûÁage_u£d
;

1421 
ušt8_t
 
»£rved
[26];

1428 
ušt64_t
 
d©a_un™s_»ad
[2];

1430 
ušt64_t
 
d©a_un™s_wr™‹n
[2];

1432 
ušt64_t
 
ho¡_»ad_commªds
[2];

1433 
ušt64_t
 
ho¡_wr™e_commªds
[2];

1435 
ušt64_t
 
cÚŒŞËr_busy_time
[2];

1436 
ušt64_t
 
pow”_cyşes
[2];

1437 
ušt64_t
 
pow”_Ú_hours
[2];

1438 
ušt64_t
 
un§ã_shutdowns
[2];

1439 
ušt64_t
 
medŸ_”rÜs
[2];

1440 
ušt64_t
 
num_”rÜ_šfo_log_’Œ›s
[2];

1442 
ušt32_t
 
w¬nšg_‹mp_time
;

1443 
ušt32_t
 
ü™iÿl_‹mp_time
;

1444 
ušt16_t
 
‹mp_£nsÜ
[8];

1446 
ušt8_t
 
»£rved2
[296];

1448 
SPDK_STATIC_ASSERT
((
¥dk_nvme_h—Éh_šfÜm©iÚ_·ge
) == 512, "Incorrect size");

1453 
	s¥dk_nvme_fœmw¬e_·ge
 {

1455 
ušt8_t
 
¦Ù
 : 3;

1456 
ušt8_t
 
»£rved
 : 5;

1457 } 
afi
;

1459 
ušt8_t
 
»£rved
[7];

1460 
ušt64_t
 
»visiÚ
[7];

1461 
ušt8_t
 
»£rved2
[448];

1463 
SPDK_STATIC_ASSERT
((
¥dk_nvme_fœmw¬e_·ge
) == 512, "Incorrect size");

1468 
	e¥dk_nvme_ns_©ch_ty³
 {

1470 
SPDK_NVME_NS_CTRLR_ATTACH
 = 0x0,

1473 
SPDK_NVME_NS_CTRLR_DETACH
 = 0x1,

1481 
	e¥dk_nvme_ns_mªagem’t_ty³
 {

1483 
SPDK_NVME_NS_MANAGEMENT_CREATE
 = 0x0,

1486 
SPDK_NVME_NS_MANAGEMENT_DELETE
 = 0x1,

1491 
	s¥dk_nvme_ns_li¡
 {

1492 
ušt32_t
 
ns_li¡
[1024];

1494 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ns_li¡
) == 4096, "Incorrect size");

1496 
	s¥dk_nvme_ù¾r_li¡
 {

1497 
ušt16_t
 
ù¾r_couÁ
;

1498 
ušt16_t
 
ù¾r_li¡
[2047];

1500 
SPDK_STATIC_ASSERT
((
¥dk_nvme_ù¾r_li¡
) == 4096, "Incorrect size");

1502 
	e¥dk_nvme_£cu»_”a£_£‰šg
 {

1503 
SPDK_NVME_FMT_NVM_SES_NO_SECURE_ERASE
 = 0x0,

1504 
SPDK_NVME_FMT_NVM_SES_USER_DATA_ERASE
 = 0x1,

1505 
SPDK_NVME_FMT_NVM_SES_CRYPTO_ERASE
 = 0x2,

1508 
	e¥dk_nvme_pi_loÿtiÚ
 {

1509 
SPDK_NVME_FMT_NVM_PROTECTION_AT_TAIL
 = 0x0,

1510 
SPDK_NVME_FMT_NVM_PROTECTION_AT_HEAD
 = 0x1,

1513 
	e¥dk_nvme_pi_ty³
 {

1514 
SPDK_NVME_FMT_NVM_PROTECTION_DISABLE
 = 0x0,

1515 
SPDK_NVME_FMT_NVM_PROTECTION_TYPE1
 = 0x1,

1516 
SPDK_NVME_FMT_NVM_PROTECTION_TYPE2
 = 0x2,

1517 
SPDK_NVME_FMT_NVM_PROTECTION_TYPE3
 = 0x3,

1520 
	e¥dk_nvme_m‘ad©a_£‰šg
 {

1521 
SPDK_NVME_FMT_NVM_METADATA_TRANSFER_AS_BUFFER
 = 0x0,

1522 
SPDK_NVME_FMT_NVM_METADATA_TRANSFER_AS_LBA
 = 0x1,

1525 
	s¥dk_nvme_fÜm©
 {

1526 
ušt32_t
 
lbaf
 : 4;

1527 
ušt32_t
 
ms
 : 1;

1528 
ušt32_t
 
pi
 : 3;

1529 
ušt32_t
 
p
 : 1;

1530 
ušt32_t
 
£s
 : 3;

1531 
ušt32_t
 
»£rved
 : 20;

1533 
SPDK_STATIC_ASSERT
((
¥dk_nvme_fÜm©
) == 4, "Incorrect size");

1535 
	s¥dk_nvme_´ÙeùiÚ_šfo
 {

1536 
ušt16_t
 
gu¬d
;

1537 
ušt16_t
 
­p_g
;

1538 
ušt32_t
 
»f_g
;

1540 
SPDK_STATIC_ASSERT
((
¥dk_nvme_´ÙeùiÚ_šfo
) == 8, "Incorrect size");

1543 
	e¥dk_nvme_fw_comm™_aùiÚ
 {

1548 
SPDK_NVME_FW_COMMIT_REPLACE_IMG
 = 0x0,

1553 
SPDK_NVME_FW_COMMIT_REPLACE_AND_ENABLE_IMG
 = 0x1,

1558 
SPDK_NVME_FW_COMMIT_ENABLE_IMG
 = 0x2,

1563 
SPDK_NVME_FW_COMMIT_RUN_IMG
 = 0x3,

1567 
	s¥dk_nvme_fw_comm™
 {

1573 
ušt32_t
 
fs
 : 3;

1579 
ušt32_t
 
ÿ
 : 3;

1580 
ušt32_t
 
»£rved
 : 26;

1582 
SPDK_STATIC_ASSERT
((
¥dk_nvme_fw_comm™
) == 4, "Incorrect size");

1584 
	#¥dk_nvme_ıl_is_”rÜ
(
ıl
) \

1585 ((
ıl
)->
¡©us
.
sc
 !ğ0 || (ıl)->¡©us.
sù
 !ğ0)

	)

1588 
	#SPDK_NVME_IO_FLAGS_PRCHK_REFTAG
 (1U << 26)

	)

1590 
	#SPDK_NVME_IO_FLAGS_PRCHK_APPTAG
 (1U << 27)

	)

1592 
	#SPDK_NVME_IO_FLAGS_PRCHK_GUARD
 (1U << 28)

	)

1594 
	#SPDK_NVME_IO_FLAGS_PRACT
 (1U << 29)

	)

1595 
	#SPDK_NVME_IO_FLAGS_FORCE_UNIT_ACCESS
 (1U << 30)

	)

1596 
	#SPDK_NVME_IO_FLAGS_LIMITED_RETRY
 (1U << 31)

	)

1598 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/nvmf.h

38 #iâdeà
SPDK_NVMF_H


39 
	#SPDK_NVMF_H


	)

41 
	~"¥dk/¡dšc.h
"

43 
	~"¥dk/’v.h
"

44 
	~"¥dk/nvmf_¥ec.h
"

45 
	~"¥dk/queue.h
"

47 
	#MAX_VIRTUAL_NAMESPACE
 16

	)

48 
	#MAX_SN_LEN
 20

	)

50 
¥dk_nvmf_tgt_š™
(
ušt16_t
 
max_queue_d•th
, ušt16_ˆ
max_cÚn_³r_£ss
,

51 
ušt32_t
 
š_ÿpsuË_d©a_size
, ušt32_ˆ
max_io_size
);

53 
¥dk_nvmf_tgt_fši
();

55 
¥dk_nvmf_check_poŞs
();

57 
	g¥dk_nvmf_subsy¡em
;

58 
	g¥dk_nvmf_£ssiÚ
;

59 
	g¥dk_nvmf_cÚn
;

60 
	g¥dk_nvmf_»que¡
;

61 
	g¥dk_bdev
;

62 
	g¥dk_nvme_ù¾r
;

63 
	g¥dk_nvmf_»que¡
;

64 
	g¥dk_nvmf_cÚn
;

66 (*
	t¥dk_nvmf_subsy¡em_cÚÃù_â
)(*
	tcb_ùx
, 
	t¥dk_nvmf_»que¡
 *
	t»q
);

67 (*
	t¥dk_nvmf_subsy¡em_discÚÃù_â
)(*
	tcb_ùx
, 
	t¥dk_nvmf_cÚn
 *
	tcÚn
);

69 
	e¥dk_nvmf_subsy¡em_mode
 {

70 
NVMF_SUBSYSTEM_MODE_DIRECT
 = 0,

71 
NVMF_SUBSYSTEM_MODE_VIRTUAL
 = 1,

74 
	s¥dk_nvmf_li¡’_addr
 {

75 *
Œaddr
;

76 *
Œsvcid
;

77 *
ŒÇme
;

78 
	`TAILQ_ENTRY
(
¥dk_nvmf_li¡’_addr
è
lšk
;

81 
	s¥dk_nvmf_ho¡
 {

82 *
nqn
;

83 
	`TAILQ_ENTRY
(
¥dk_nvmf_ho¡
è
lšk
;

86 
	s¥dk_nvmf_ù¾r_İs
 {

90 (*
©ch
)(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

95 (*
ù¾r_g‘_d©a
)(
¥dk_nvmf_£ssiÚ
 *
£ssiÚ
);

100 (*
´oûss_admš_cmd
)(
¥dk_nvmf_»que¡
 *
»q
);

105 (*
´oûss_io_cmd
)(
¥dk_nvmf_»que¡
 *
»q
);

110 (*
pŞl_fÜ_com¶‘iÚs
)(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

115 (*
d‘ach
)(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

118 
	s¥dk_nvmf_subsy¡em_®lowed_li¡’”
 {

119 
¥dk_nvmf_li¡’_addr
 *
li¡’_addr
;

120 
	`TAILQ_ENTRY
(
¥dk_nvmf_subsy¡em_®lowed_li¡’”
è
lšk
;

128 
	s¥dk_nvmf_subsy¡em
 {

129 
ušt32_t
 
id
;

130 
ušt32_t
 
lcÜe
;

131 
subnqn
[
SPDK_NVMF_NQN_MAX_LEN
];

132 
¥dk_nvmf_subsy¡em_mode
 
mode
;

133 
¥dk_nvmf_subty³
 
subty³
;

134 
boŞ
 
is_»moved
;

137 
¥dk_nvme_ù¾r
 *
ù¾r
;

138 
¥dk_nvme_q·œ
 *
io_q·œ
;

139 
¥dk_pci_addr
 
pci_addr
;

140 
¥dk_pŞËr
 *
admš_pŞËr
;

141 
št32_t
 
out¡ªdšg_admš_cmd_couÁ
;

142 } 
dœeù
;

145 
¢
[
MAX_SN_LEN
 + 1];

146 
¥dk_bdev
 *
ns_li¡
[
MAX_VIRTUAL_NAMESPACE
];

147 
¥dk_io_chªÃl
 *
ch
[
MAX_VIRTUAL_NAMESPACE
];

148 
ušt16_t
 
ns_couÁ
;

149 } 
vœt
;

150 } 
dev
;

152 cÚ¡ 
¥dk_nvmf_ù¾r_İs
 *
İs
;

154 *
cb_ùx
;

155 
¥dk_nvmf_subsy¡em_cÚÃù_â
 
cÚÃù_cb
;

156 
¥dk_nvmf_subsy¡em_discÚÃù_â
 
discÚÃù_cb
;

158 
	`TAILQ_HEAD
(, 
¥dk_nvmf_£ssiÚ
è
£ssiÚs
;

160 
	`TAILQ_HEAD
(, 
¥dk_nvmf_ho¡
è
ho¡s
;

161 
ušt32_t
 
num_ho¡s
;

163 
	`TAILQ_HEAD
(, 
¥dk_nvmf_subsy¡em_®lowed_li¡’”
è
®lowed_li¡’”s
;

165 
	`TAILQ_ENTRY
(
¥dk_nvmf_subsy¡em
è
’Œ›s
;

168 
¥dk_nvmf_subsy¡em
 *
	`¥dk_nvmf_ü—‹_subsy¡em
(cÚ¡ *
nqn
,

169 
¥dk_nvmf_subty³
 
ty³
,

170 
¥dk_nvmf_subsy¡em_mode
 
mode
,

171 *
cb_ùx
,

172 
¥dk_nvmf_subsy¡em_cÚÃù_â
 
cÚÃù_cb
,

173 
¥dk_nvmf_subsy¡em_discÚÃù_â
 
discÚÃù_cb
);

180 
	`¥dk_nvmf_subsy¡em_¡¬t
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

182 
	`¥dk_nvmf_d–‘e_subsy¡em
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

184 
¥dk_nvmf_subsy¡em
 *

185 
	`nvmf_fšd_subsy¡em
(cÚ¡ *
subnqn
);

187 
boŞ
 
	`¥dk_nvmf_subsy¡em_exi¡s
(cÚ¡ *
subnqn
);

189 
boŞ
 
	`¥dk_nvmf_subsy¡em_ho¡_®lowed
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
, cÚ¡ *
ho¡nqn
);

191 
¥dk_nvmf_li¡’_addr
 *

192 
	`¥dk_nvmf_tgt_li¡’
(cÚ¡ *
ŒÇme
, cÚ¡ *
Œaddr
, cÚ¡ *
Œsvcid
);

195 
	`¥dk_nvmf_subsy¡em_add_li¡’”
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
,

196 
¥dk_nvmf_li¡’_addr
 *
li¡’_addr
);

198 
boŞ


199 
	`¥dk_nvmf_subsy¡em_li¡’”_®lowed
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
,

200 
¥dk_nvmf_li¡’_addr
 *
li¡’_addr
);

203 
	`¥dk_nvmf_subsy¡em_add_ho¡
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
,

204 cÚ¡ *
ho¡_nqn
);

207 
	`nvmf_subsy¡em_add_ù¾r
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
,

208 
¥dk_nvme_ù¾r
 *
ù¾r
, cÚ¡ 
¥dk_pci_addr
 *
pci_addr
);

210 
	`¥dk_nvmf_subsy¡em_pŞl
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

213 
	`¥dk_nvmf_subsy¡em_add_ns
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
, 
¥dk_bdev
 *
bdev
);

215 
	`¥dk_nvmf_subsy¡em_£t_¢
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
, cÚ¡ *
¢
);

217 cÚ¡ *
	`¥dk_nvmf_subsy¡em_g‘_nqn
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

218 
¥dk_nvmf_subty³
 
	`¥dk_nvmf_subsy¡em_g‘_ty³
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

219 
¥dk_nvmf_subsy¡em_mode
 
	`¥dk_nvmf_subsy¡em_g‘_mode
(
¥dk_nvmf_subsy¡em
 *
subsy¡em
);

221 
	`¥dk_nvmf_acû±Ü_pŞl
();

223 
	`¥dk_nvmf_hªdË_cÚÃù
(
¥dk_nvmf_»que¡
 *
»q
);

226 
	`¥dk_nvmf_£ssiÚ_discÚÃù
(
¥dk_nvmf_cÚn
 *
cÚn
);

	@PDK/core/src/api/include/udd/spdk/nvmf_spec.h

34 #iâdeà
SPDK_NVMF_SPEC_H


35 
	#SPDK_NVMF_SPEC_H


	)

37 
	~"¥dk/¡dšc.h
"

39 
	~"¥dk/as£¹.h
"

40 
	~"¥dk/nvme_¥ec.h
"

47 #´agm¨
·ck
(
push
, 1)

50 
	#SPDK_NVMF_MIN_ADMIN_QUEUE_ENTRIES
 32

	)

52 
	s¥dk_nvmf_ÿpsuË_cmd
 {

53 
ušt8_t
 
	mİcode
;

54 
ušt8_t
 
	m»£rved1
;

55 
ušt16_t
 
	mcid
;

56 
ušt8_t
 
	mfùy³
;

57 
ušt8_t
 
	m»£rved2
[35];

58 
ušt8_t
 
	mçbric_¥ecific
[24];

60 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_ÿpsuË_cmd
) == 64, "Incorrect size");

63 
	#SPDK_NVME_OPC_FABRIC
 0x7f

	)

65 
	e¥dk_nvmf_çbric_cmd_ty³s
 {

66 
	mSPDK_NVMF_FABRIC_COMMAND_PROPERTY_SET
 = 0x00,

67 
	mSPDK_NVMF_FABRIC_COMMAND_CONNECT
 = 0x01,

68 
	mSPDK_NVMF_FABRIC_COMMAND_PROPERTY_GET
 = 0x04,

69 
	mSPDK_NVMF_FABRIC_COMMAND_AUTHENTICATION_SEND
 = 0x05,

70 
	mSPDK_NVMF_FABRIC_COMMAND_AUTHENTICATION_RECV
 = 0x06,

71 
	mSPDK_NVMF_FABRIC_COMMAND_START_VENDOR_SPECIFIC
 = 0xC0,

74 
	e¥dk_nvmf_çbric_cmd_¡©us_code
 {

75 
	mSPDK_NVMF_FABRIC_SC_INCOMPATIBLE_FORMAT
 = 0x80,

76 
	mSPDK_NVMF_FABRIC_SC_CONTROLLER_BUSY
 = 0x81,

77 
	mSPDK_NVMF_FABRIC_SC_INVALID_PARAM
 = 0x82,

78 
	mSPDK_NVMF_FABRIC_SC_RESTART_DISCOVERY
 = 0x83,

79 
	mSPDK_NVMF_FABRIC_SC_INVALID_HOST
 = 0x84,

80 
	mSPDK_NVMF_FABRIC_SC_LOG_RESTART_DISCOVERY
 = 0x90,

81 
	mSPDK_NVMF_FABRIC_SC_AUTH_REQUIRED
 = 0x91,

87 
	e¥dk_nvmf_rdma_q±y³
 {

89 
	mSPDK_NVMF_RDMA_QPTYPE_RELIABLE_CONNECTED
 = 0x1,

92 
	mSPDK_NVMF_RDMA_QPTYPE_RELIABLE_DATAGRAM
 = 0x2,

98 
	e¥dk_nvmf_rdma_´ty³
 {

100 
	mSPDK_NVMF_RDMA_PRTYPE_NONE
 = 0x1,

103 
	mSPDK_NVMF_RDMA_PRTYPE_IB
 = 0x2,

106 
	mSPDK_NVMF_RDMA_PRTYPE_ROCE
 = 0x3,

109 
	mSPDK_NVMF_RDMA_PRTYPE_ROCE2
 = 0x4,

112 
	mSPDK_NVMF_RDMA_PRTYPE_IWARP
 = 0x5,

118 
	e¥dk_nvmf_rdma_cms
 {

120 
	mSPDK_NVMF_RDMA_CMS_RDMA_CM
 = 0x1,

126 
	e¥dk_nvmf_Œty³
 {

128 
	mSPDK_NVMF_TRTYPE_RDMA
 = 0x1,

131 
	mSPDK_NVMF_TRTYPE_FC
 = 0x2,

134 
	mSPDK_NVMF_TRTYPE_INTRA_HOST
 = 0xfe,

140 
	e¥dk_nvmf_adrçm
 {

142 
	mSPDK_NVMF_ADRFAM_IPV4
 = 0x1,

145 
	mSPDK_NVMF_ADRFAM_IPV6
 = 0x2,

148 
	mSPDK_NVMF_ADRFAM_IB
 = 0x3,

151 
	mSPDK_NVMF_ADRFAM_FC
 = 0x4,

154 
	mSPDK_NVMF_ADRFAM_INTRA_HOST
 = 0xfe,

160 
	e¥dk_nvmf_subty³
 {

162 
	mSPDK_NVMF_SUBTYPE_DISCOVERY
 = 0x1,

165 
	mSPDK_NVMF_SUBTYPE_NVME
 = 0x2,

171 
	e¥dk_nvmf_Œeq_£cu»_chªÃl
 {

173 
	mSPDK_NVMF_TREQ_SECURE_CHANNEL_NOT_SPECIFIED
 = 0x0,

176 
	mSPDK_NVMF_TREQ_SECURE_CHANNEL_REQUIRED
 = 0x1,

179 
	mSPDK_NVMF_TREQ_SECURE_CHANNEL_NOT_REQUIRED
 = 0x2,

182 
	s¥dk_nvmf_çbric_auth_»cv_cmd
 {

183 
ušt8_t
 
	mİcode
;

184 
ušt8_t
 
	m»£rved1
;

185 
ušt16_t
 
	mcid
;

186 
ušt8_t
 
	mfùy³
;

187 
ušt8_t
 
	m»£rved2
[19];

188 
¥dk_nvme_sgl_desütÜ
 
	msgl1
;

189 
ušt8_t
 
	m»£rved3
;

190 
ušt8_t
 
	m¥¥0
;

191 
ušt8_t
 
	m¥¥1
;

192 
ušt8_t
 
	m£ı
;

193 
ušt32_t
 
	m®
;

194 
ušt8_t
 
	m»£rved4
[16];

196 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_auth_»cv_cmd
) == 64, "Incorrect size");

198 
	s¥dk_nvmf_çbric_auth_£nd_cmd
 {

199 
ušt8_t
 
	mİcode
;

200 
ušt8_t
 
	m»£rved1
;

201 
ušt16_t
 
	mcid
;

202 
ušt8_t
 
	mfùy³
;

203 
ušt8_t
 
	m»£rved2
[19];

204 
¥dk_nvme_sgl_desütÜ
 
	msgl1
;

205 
ušt8_t
 
	m»£rved3
;

206 
ušt8_t
 
	m¥¥0
;

207 
ušt8_t
 
	m¥¥1
;

208 
ušt8_t
 
	m£ı
;

209 
ušt32_t
 
	m
;

210 
ušt8_t
 
	m»£rved4
[16];

212 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_auth_£nd_cmd
) == 64, "Incorrect size");

214 
	s¥dk_nvmf_çbric_cÚÃù_d©a
 {

215 
ušt8_t
 
	mho¡id
[16];

216 
ušt16_t
 
	múid
;

217 
ušt8_t
 
	m»£rved5
[238];

218 
ušt8_t
 
	msubnqn
[256];

219 
ušt8_t
 
	mho¡nqn
[256];

220 
ušt8_t
 
	m»£rved6
[256];

222 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_cÚÃù_d©a
) == 1024, "Incorrect size");

224 
	s¥dk_nvmf_çbric_cÚÃù_cmd
 {

225 
ušt8_t
 
	mİcode
;

226 
ušt8_t
 
	m»£rved1
;

227 
ušt16_t
 
	mcid
;

228 
ušt8_t
 
	mfùy³
;

229 
ušt8_t
 
	m»£rved2
[19];

230 
¥dk_nvme_sgl_desütÜ
 
	msgl1
;

231 
ušt16_t
 
	m»cfmt
;

232 
ušt16_t
 
	mqid
;

233 
ušt16_t
 
	msqsize
;

234 
ušt8_t
 
	mÿ‰r
;

235 
ušt8_t
 
	m»£rved3
;

236 
ušt32_t
 
	mk©o
;

237 
ušt8_t
 
	m»£rved4
[12];

239 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_cÚÃù_cmd
) == 64, "Incorrect size");

241 
	s¥dk_nvmf_çbric_cÚÃù_r¥
 {

244 
ušt16_t
 
	múid
;

245 
ušt16_t
 
	mauth»q
;

246 } 
	msucûss
;

249 
ušt16_t
 
	mo
;

250 
ušt8_t
 
	mŸ‰r
;

251 
ušt8_t
 
	m»£rved
;

252 } 
	mšv®id
;

254 
ušt32_t
 
	m¿w
;

255 } 
	m¡©us_code_¥ecific
;

257 
ušt32_t
 
	m»£rved0
;

258 
ušt16_t
 
	msqhd
;

259 
ušt16_t
 
	m»£rved1
;

260 
ušt16_t
 
	mcid
;

261 
¥dk_nvme_¡©us
 
	m¡©us
;

263 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_cÚÃù_r¥
) == 16, "Incorrect size");

265 
	#SPDK_NVMF_PROP_SIZE_4
 0

	)

266 
	#SPDK_NVMF_PROP_SIZE_8
 1

	)

268 
	s¥dk_nvmf_çbric_´İ_g‘_cmd
 {

269 
ušt8_t
 
	mİcode
;

270 
ušt8_t
 
	m»£rved1
;

271 
ušt16_t
 
	mcid
;

272 
ušt8_t
 
	mfùy³
;

273 
ušt8_t
 
	m»£rved2
[35];

275 
ušt8_t
 
	msize
 : 2;

276 
ušt8_t
 
	m»£rved
 : 6;

277 } 
	m©Œib
;

278 
ušt8_t
 
	m»£rved3
[3];

279 
ušt32_t
 
	mof¡
;

280 
ušt8_t
 
	m»£rved4
[16];

282 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_´İ_g‘_cmd
) == 64, "Incorrect size");

284 
	s¥dk_nvmf_çbric_´İ_g‘_r¥
 {

286 
ušt64_t
 
	mu64
;

288 
ušt32_t
 
	mlow
;

289 
ušt32_t
 
	mhigh
;

290 } 
	mu32
;

291 } 
	mv®ue
;

293 
ušt16_t
 
	msqhd
;

294 
ušt16_t
 
	m»£rved0
;

295 
ušt16_t
 
	mcid
;

296 
¥dk_nvme_¡©us
 
	m¡©us
;

298 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_´İ_g‘_r¥
) == 16, "Incorrect size");

300 
	s¥dk_nvmf_çbric_´İ_£t_cmd
 {

301 
ušt8_t
 
	mİcode
;

302 
ušt8_t
 
	m»£rved0
;

303 
ušt16_t
 
	mcid
;

304 
ušt8_t
 
	mfùy³
;

305 
ušt8_t
 
	m»£rved1
[35];

307 
ušt8_t
 
	msize
 : 2;

308 
ušt8_t
 
	m»£rved
 : 6;

309 } 
	m©Œib
;

310 
ušt8_t
 
	m»£rved2
[3];

311 
ušt32_t
 
	mof¡
;

314 
ušt64_t
 
	mu64
;

316 
ušt32_t
 
	mlow
;

317 
ušt32_t
 
	mhigh
;

318 } 
	mu32
;

319 } 
	mv®ue
;

321 
ušt8_t
 
	m»£rved4
[8];

323 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_çbric_´İ_£t_cmd
) == 64, "Incorrect size");

325 
	#SPDK_NVMF_NQN_MAX_LEN
 223

	)

326 
	#SPDK_NVMF_DISCOVERY_NQN
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

328 
	#SPDK_NVMF_TRADDR_MAX_LEN
 256

	)

329 
	#SPDK_NVMF_TRSVCID_MAX_LEN
 32

	)

332 
	s¥dk_nvmf_rdma_Œª¥Üt_¥ecific_add»ss_subty³
 {

334 
ušt8_t
 
	mrdma_q±y³
;

337 
ušt8_t
 
	mrdma_´ty³
;

340 
ušt8_t
 
	mrdma_cms
;

342 
ušt8_t
 
	m»£rved0
[5];

345 
ušt16_t
 
	mrdma_pkey
;

347 
ušt8_t
 
	m»£rved2
[246];

349 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_rdma_Œª¥Üt_¥ecific_add»ss_subty³
) == 256,

353 
	u¥dk_nvmf_Œª¥Üt_¥ecific_add»ss_subty³
 {

354 
ušt8_t
 
	m¿w
[256];

357 
¥dk_nvmf_rdma_Œª¥Üt_¥ecific_add»ss_subty³
 
	mrdma
;

359 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_Œª¥Üt_¥ecific_add»ss_subty³
) == 256,

365 
	s¥dk_nvmf_discov”y_log_·ge_’Œy
 {

367 
ušt8_t
 
	mŒty³
;

370 
ušt8_t
 
	madrçm
;

373 
ušt8_t
 
	msubty³
;

378 
ušt8_t
 
	m£cu»_chªÃl
 : 2;

380 
ušt8_t
 
	m»£rved
 : 6;

381 } 
	mŒeq
;

384 
ušt16_t
 
	mpÜtid
;

387 
ušt16_t
 
	múid
;

390 
ušt16_t
 
	masqsz
;

392 
ušt8_t
 
	m»£rved0
[22];

395 
ušt8_t
 
	mŒsvcid
[
SPDK_NVMF_TRSVCID_MAX_LEN
];

397 
ušt8_t
 
	m»£rved1
[192];

400 
ušt8_t
 
	msubnqn
[256];

403 
ušt8_t
 
	mŒaddr
[
SPDK_NVMF_TRADDR_MAX_LEN
];

406 
¥dk_nvmf_Œª¥Üt_¥ecific_add»ss_subty³
 
	mt§s
;

408 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_discov”y_log_·ge_’Œy
) == 1024, "Incorrect size");

410 
	s¥dk_nvmf_discov”y_log_·ge
 {

411 
ušt64_t
 
	mg’ùr
;

412 
ušt64_t
 
	mnum»c
;

413 
ušt16_t
 
	m»cfmt
;

414 
ušt8_t
 
	m»£rved0
[1006];

415 
¥dk_nvmf_discov”y_log_·ge_’Œy
 
	m’Œ›s
[0];

417 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_discov”y_log_·ge
) == 1024, "Incorrect size");

421 
	#SPDK_NVME_SGL_SUBTYPE_INVALIDATE_KEY
 0xF

	)

423 
	s¥dk_nvmf_rdma_»que¡_´iv©e_d©a
 {

424 
ušt16_t
 
	m»cfmt
;

425 
ušt16_t
 
	mqid
;

426 
ušt16_t
 
	mhrqsize
;

427 
ušt16_t
 
	mhsqsize
;

428 
ušt16_t
 
	múid
;

429 
ušt8_t
 
	m»£rved
[22];

431 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_rdma_»que¡_´iv©e_d©a
) == 32, "Incorrect size");

433 
	s¥dk_nvmf_rdma_acû±_´iv©e_d©a
 {

434 
ušt16_t
 
	m»cfmt
;

435 
ušt16_t
 
	müqsize
;

436 
ušt8_t
 
	m»£rved
[28];

438 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_rdma_acû±_´iv©e_d©a
) == 32, "Incorrect size");

440 
	s¥dk_nvmf_rdma_»jeù_´iv©e_d©a
 {

441 
ušt16_t
 
	m»cfmt
;

442 
¥dk_nvme_¡©us
 
	m¡©us
;

444 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_rdma_»jeù_´iv©e_d©a
) == 4, "Incorrect size");

446 
	u¥dk_nvmf_rdma_´iv©e_d©a
 {

447 
¥dk_nvmf_rdma_»que¡_´iv©e_d©a
 
	mpd_»que¡
;

448 
¥dk_nvmf_rdma_acû±_´iv©e_d©a
 
	mpd_acû±
;

449 
¥dk_nvmf_rdma_»jeù_´iv©e_d©a
 
	mpd_»jeù
;

451 
SPDK_STATIC_ASSERT
((
¥dk_nvmf_rdma_´iv©e_d©a
) == 32, "Incorrect size");

453 
	e¥dk_nvmf_rdma_Œª¥Üt_”rÜs
 {

454 
	mSPDK_NVMF_RDMA_ERROR_INVALID_PRIVATE_DATA_LENGTH
 = 0x1,

455 
	mSPDK_NVMF_RDMA_ERROR_INVALID_RECFMT
 = 0x2,

456 
	mSPDK_NVMF_RDMA_ERROR_INVALID_QID
 = 0x3,

457 
	mSPDK_NVMF_RDMA_ERROR_INVALID_HSQSIZE
 = 0x4,

458 
	mSPDK_NVMF_RDMA_ERROR_INVALID_HRQSIZE
 = 0x5,

459 
	mSPDK_NVMF_RDMA_ERROR_NO_RESOURCES
 = 0x6,

460 
	mSPDK_NVMF_RDMA_ERROR_INVALID_IRD
 = 0x7,

461 
	mSPDK_NVMF_RDMA_ERROR_INVALID_ORD
 = 0x8,

462 
	mSPDK_NVMF_RDMA_ERROR_INVALID_CNTLID
 = 0x9,

465 #´agm¨
·ck
(
pİ
)

	@PDK/core/src/api/include/udd/spdk/pci_ids.h

38 #iâdeà
SPDK_PCI_IDS


39 
	#SPDK_PCI_IDS


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
	#SPDK_PCI_ANY_ID
 0xffff

	)

48 
	#SPDK_PCI_VID_INTEL
 0x8086

	)

49 
	#SPDK_PCI_VID_MEMBLAZE
 0x1c5f

	)

50 
	#SPDK_PCI_VID_VIRTUALBOX
 0x80“

	)

59 
	#SPDK_PCI_CLASS_NVME
 0x010802

	)

61 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB0
 0x3c20

	)

62 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB1
 0x3c21

	)

63 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB2
 0x3c22

	)

64 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB3
 0x3c23

	)

65 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB4
 0x3c24

	)

66 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB5
 0x3c25

	)

67 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB6
 0x3c26

	)

68 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB7
 0x3c27

	)

69 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB8
 0x3c2e

	)

70 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB9
 0x3c2f

	)

72 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB0
 0x0e20

	)

73 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB1
 0x0e21

	)

74 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB2
 0x0e22

	)

75 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB3
 0x0e23

	)

76 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB4
 0x0e24

	)

77 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB5
 0x0e25

	)

78 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB6
 0x0e26

	)

79 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB7
 0x0e27

	)

80 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB8
 0x0e2e

	)

81 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB9
 0x0e2f

	)

83 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW0
 0x2f20

	)

84 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW1
 0x2f21

	)

85 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW2
 0x2f22

	)

86 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW3
 0x2f23

	)

87 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW4
 0x2f24

	)

88 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW5
 0x2f25

	)

89 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW6
 0x2f26

	)

90 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW7
 0x2f27

	)

91 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW8
 0x2f2e

	)

92 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW9
 0x2f2f

	)

94 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD0
 0x0C50

	)

95 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD1
 0x0C51

	)

96 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD2
 0x0C52

	)

97 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD3
 0x0C53

	)

99 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE0
 0x6f50

	)

100 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE1
 0x6f51

	)

101 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE2
 0x6f52

	)

102 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE3
 0x6f53

	)

104 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX0
 0x6f20

	)

105 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX1
 0x6f21

	)

106 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX2
 0x6f22

	)

107 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX3
 0x6f23

	)

108 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX4
 0x6f24

	)

109 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX5
 0x6f25

	)

110 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX6
 0x6f26

	)

111 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX7
 0x6f27

	)

112 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX8
 0x6f2e

	)

113 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX9
 0x6f2f

	)

115 
	#PCI_DEVICE_ID_INTEL_IOAT_SKX
 0x2021

	)

117 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/queue.h

34 #iâdeà
SPDK_QUEUE_H


35 
	#SPDK_QUEUE_H


	)

37 #ifdeà
__ılu¥lus


41 
	~<sys/cdefs.h
>

42 
	~<sys/queue.h
>

49 #iâdeà
__F»eBSD__


50 
	~<¥dk/queue_exŒas.h
>

53 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/queue_extras.h

33 #iâdeà
SPDK_QUEUE_EXTRAS_H


34 
	#SPDK_QUEUE_EXTRAS_H


	)

111 
	#STAILQ_HEAD
(
Çme
, 
ty³
) \

112 
	sÇme
 { \

113 
ty³
 *
¡qh_fœ¡
; \

114 
ty³
 **
¡qh_Ï¡
; \

115 }

	)

117 
	#STAILQ_HEAD_INITIALIZER
(
h—d
) \

118 { 
NULL
, &(
h—d
).
¡qh_fœ¡
 }

	)

123 
	#STAILQ_EMPTY
(
h—d
è((h—d)->
¡qh_fœ¡
 =ğ
NULL
)

	)

125 
	#STAILQ_FIRST
(
h—d
è((h—d)->
¡qh_fœ¡
)

	)

127 
	#STAILQ_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

128 (
v¬
èğ((v¬è? (v¬è: 
	`STAILQ_FIRST
((
h—d
))); \

129 (
v¬
); \

130 (
v¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
))

	)

132 
	#STAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

133 (
v¬
èğ
	`STAILQ_FIRST
((
h—d
)); \

134 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

135 (
v¬
èğ(
tv¬
))

	)

137 
	#STAILQ_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

138 (
v¬
èğ((v¬è? (v¬è: 
	`STAILQ_FIRST
((
h—d
))); \

139 (
v¬
è&& ((
tv¬
èğ
	`STAILQ_NEXT
((v¬), 
f›ld
), 1); \

140 (
v¬
èğ(
tv¬
))

	)

142 
	#STAILQ_LAST
(
h—d
, 
ty³
, 
f›ld
) \

143 (
	`STAILQ_EMPTY
((
h—d
)è? 
NULL
 : \

144 
	`__cÚš”of
((
h—d
)->
¡qh_Ï¡
, 
ty³
, 
f›ld
.
¡qe_Ãxt
))

	)

146 
	#STAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
¡qe_Ãxt
)

	)

148 
	#STAILQ_REMOVE_AFTER
(
h—d
, 
–m
, 
f›ld
) do { \

149 ià((
	`STAILQ_NEXT
(
–m
, 
f›ld
) = \

150 
	`STAILQ_NEXT
(STAILQ_NEXT(
–m
, 
f›ld
), f›ld)è=ğ
NULL
) \

151 (
h—d
)->
¡qh_Ï¡
 = &
	`STAILQ_NEXT
((
–m
), 
f›ld
); \

152 } 0)

	)

154 
	#STAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

155 
ty³
 *
sw­_fœ¡
 = 
	`STAILQ_FIRST
(
h—d1
); \

156 
ty³
 **
sw­_Ï¡
 = (
h—d1
)->
¡qh_Ï¡
; \

157 
	`STAILQ_FIRST
(
h—d1
èğSTAILQ_FIRST(
h—d2
); \

158 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

159 
	`STAILQ_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

160 (
h—d2
)->
¡qh_Ï¡
 = 
sw­_Ï¡
; \

161 ià(
	`STAILQ_EMPTY
(
h—d1
)) \

162 (
h—d1
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head1); \

163 ià(
	`STAILQ_EMPTY
(
h—d2
)) \

164 (
h—d2
)->
¡qh_Ï¡
 = &
	`STAILQ_FIRST
(head2); \

165 } 0)

	)

170 
	#LIST_HEAD
(
Çme
, 
ty³
) \

171 
	sÇme
 { \

172 
ty³
 *
lh_fœ¡
; \

173 }

	)

175 
	#LIST_HEAD_INITIALIZER
(
h—d
) \

176 { 
NULL
 }

	)

178 
	#LIST_ENTRY
(
ty³
) \

180 
ty³
 *
Ë_Ãxt
; \

181 
ty³
 **
Ë_´ev
; \

182 }

	)

188 #ià(
defšed
(
_KERNEL
è&& defšed(
INVARIANTS
))

189 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

190 ià(
	`LIST_FIRST
((
h—d
)è!ğ
NULL
 && \

191 
	`LIST_FIRST
((
h—d
))->
f›ld
.
Ë_´ev
 != \

192 &
	`LIST_FIRST
((
h—d
))) \

193 
	`·nic
("Bad†i¡ h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

194 } 0)

	)

196 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
) do { \

197 ià(
	`LIST_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

198 
	`LIST_NEXT
((
–m
), 
f›ld
)->f›ld.
Ë_´ev
 != \

199 &((
–m
)->
f›ld
.
Ë_Ãxt
)) \

200 
	`·nic
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

201 } 0)

	)

203 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
) do { \

204 ià(*(
–m
)->
f›ld
.
Ë_´ev
 != (elm)) \

205 
	`·nic
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

206 } 0)

	)

208 
	#QMD_LIST_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

209 
	#QMD_LIST_CHECK_NEXT
(
–m
, 
f›ld
)

	)

210 
	#QMD_LIST_CHECK_PREV
(
–m
, 
f›ld
)

	)

213 
	#LIST_EMPTY
(
h—d
è((h—d)->
lh_fœ¡
 =ğ
NULL
)

	)

215 
	#LIST_FIRST
(
h—d
è((h—d)->
lh_fœ¡
)

	)

217 
	#LIST_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

218 (
v¬
èğ((v¬è? (v¬è: 
	`LIST_FIRST
((
h—d
))); \

219 (
v¬
); \

220 (
v¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
))

	)

222 
	#LIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

223 (
v¬
èğ
	`LIST_FIRST
((
h—d
)); \

224 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

225 (
v¬
èğ(
tv¬
))

	)

227 
	#LIST_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

228 (
v¬
èğ((v¬è? (v¬è: 
	`LIST_FIRST
((
h—d
))); \

229 (
v¬
è&& ((
tv¬
èğ
	`LIST_NEXT
((v¬), 
f›ld
), 1); \

230 (
v¬
èğ(
tv¬
))

	)

232 
	#LIST_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
Ë_Ãxt
)

	)

234 
	#LIST_PREV
(
–m
, 
h—d
, 
ty³
, 
f›ld
) \

235 ((
–m
)->
f›ld
.
Ë_´ev
 =ğ&
	`LIST_FIRST
((
h—d
)è? 
NULL
 : \

236 
	`__cÚš”of
((
–m
)->
f›ld
.
Ë_´ev
, 
ty³
, f›ld.
Ë_Ãxt
))

	)

238 
	#LIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

239 
ty³
 *
sw­_tmp
 = 
	`LIST_FIRST
((
h—d1
)); \

240 
	`LIST_FIRST
((
h—d1
)èğLIST_FIRST((
h—d2
)); \

241 
	`LIST_FIRST
((
h—d2
)èğ
sw­_tmp
; \

242 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d1
))è!ğ
NULL
) \

243 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d1
)); \

244 ià((
sw­_tmp
 = 
	`LIST_FIRST
((
h—d2
))è!ğ
NULL
) \

245 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &
	`LIST_FIRST
((
h—d2
)); \

246 } 0)

	)

251 #ià(
defšed
(
_KERNEL
è&& defšed(
INVARIANTS
))

252 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
) do { \

253 ià(!
	`TAILQ_EMPTY
(
h—d
) && \

254 
	`TAILQ_FIRST
((
h—d
))->
f›ld
.
tqe_´ev
 != \

255 &
	`TAILQ_FIRST
((
h—d
))) \

256 
	`·nic
("Badaq h—d %°fœ¡->´ev !ğh—d", (
h—d
)); \

257 } 0)

	)

259 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
f›ld
) do { \

260 ià(*(
h—d
)->
tqh_Ï¡
 !ğ
NULL
) \

261 
	`·nic
("Badaq NEXT(%p->tqh_Ï¡è!ğNULL", (
h—d
)); \

262 } 0)

	)

264 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
) do { \

265 ià(
	`TAILQ_NEXT
((
–m
), 
f›ld
è!ğ
NULL
 && \

266 
	`TAILQ_NEXT
((
–m
), 
f›ld
)->f›ld.
tqe_´ev
 != \

267 &((
–m
)->
f›ld
.
tqe_Ãxt
)) \

268 
	`·nic
("Bad†škƒlm %°Ãxt->´ev !ğ–m", (
–m
)); \

269 } 0)

	)

271 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
) do { \

272 ià(*(
–m
)->
f›ld
.
tqe_´ev
 != (elm)) \

273 
	`·nic
("Bad†škƒlm %°´ev->Ãxˆ!ğ–m", (
–m
)); \

274 } 0)

	)

276 
	#QMD_TAILQ_CHECK_HEAD
(
h—d
, 
f›ld
)

	)

277 
	#QMD_TAILQ_CHECK_TAIL
(
h—d
, 
h—dÇme
)

	)

278 
	#QMD_TAILQ_CHECK_NEXT
(
–m
, 
f›ld
)

	)

279 
	#QMD_TAILQ_CHECK_PREV
(
–m
, 
f›ld
)

	)

282 
	#TAILQ_EMPTY
(
h—d
è((h—d)->
tqh_fœ¡
 =ğ
NULL
)

	)

284 
	#TAILQ_FIRST
(
h—d
è((h—d)->
tqh_fœ¡
)

	)

286 
	#TAILQ_FOREACH_FROM
(
v¬
, 
h—d
, 
f›ld
) \

287 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_FIRST
((
h—d
))); \

288 (
v¬
); \

289 (
v¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
))

	)

291 
	#TAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

292 (
v¬
èğ
	`TAILQ_FIRST
((
h—d
)); \

293 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

294 (
v¬
èğ(
tv¬
))

	)

296 
	#TAILQ_FOREACH_FROM_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

297 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_FIRST
((
h—d
))); \

298 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_NEXT
((v¬), 
f›ld
), 1); \

299 (
v¬
èğ(
tv¬
))

	)

301 
	#TAILQ_FOREACH_REVERSE_FROM
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
) \

302 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_LAST
((
h—d
), 
h—dÇme
)); \

303 (
v¬
); \

304 (
v¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
))

	)

306 
	#TAILQ_FOREACH_REVERSE_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

307 (
v¬
èğ
	`TAILQ_LAST
((
h—d
), 
h—dÇme
); \

308 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

309 (
v¬
èğ(
tv¬
))

	)

311 
	#TAILQ_FOREACH_REVERSE_FROM_SAFE
(
v¬
, 
h—d
, 
h—dÇme
, 
f›ld
, 
tv¬
) \

312 (
v¬
èğ((v¬è? (v¬è: 
	`TAILQ_LAST
((
h—d
), 
h—dÇme
)); \

313 (
v¬
è&& ((
tv¬
èğ
	`TAILQ_PREV
((v¬), 
h—dÇme
, 
f›ld
), 1); \

314 (
v¬
èğ(
tv¬
))

	)

316 
	#TAILQ_LAST
(
h—d
, 
h—dÇme
) \

317 (*(((
h—dÇme
 *)((
h—d
)->
tqh_Ï¡
))->tqh_Ï¡))

	)

319 
	#TAILQ_NEXT
(
–m
, 
f›ld
è(Ólm)->f›ld.
tqe_Ãxt
)

	)

321 
	#TAILQ_PREV
(
–m
, 
h—dÇme
, 
f›ld
) \

322 (*(((
h—dÇme
 *)((
–m
)->
f›ld
.
tqe_´ev
))->
tqh_Ï¡
))

	)

324 
	#TAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

325 
ty³
 *
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
; \

326 
ty³
 **
sw­_Ï¡
 = (
h—d1
)->
tqh_Ï¡
; \

327 (
h—d1
)->
tqh_fœ¡
 = (
h—d2
)->tqh_first; \

328 (
h—d1
)->
tqh_Ï¡
 = (
h—d2
)->tqh_last; \

329 (
h—d2
)->
tqh_fœ¡
 = 
sw­_fœ¡
; \

330 (
h—d2
)->
tqh_Ï¡
 = 
sw­_Ï¡
; \

331 ià((
sw­_fœ¡
 = (
h—d1
)->
tqh_fœ¡
è!ğ
NULL
) \

332 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d1
)->
tqh_fœ¡
; \

334 (
h—d1
)->
tqh_Ï¡
 = &(h—d1)->
tqh_fœ¡
; \

335 ià((
sw­_fœ¡
 = (
h—d2
)->
tqh_fœ¡
è!ğ
NULL
) \

336 
sw­_fœ¡
->
f›ld
.
tqe_´ev
 = &(
h—d2
)->
tqh_fœ¡
; \

338 (
h—d2
)->
tqh_Ï¡
 = &(h—d2)->
tqh_fœ¡
; \

339 } 0)

	)

	@PDK/core/src/api/include/udd/spdk/rpc.h

34 #iâdeà
SPDK_RPC_CONFIG_H_


35 
	#SPDK_RPC_CONFIG_H_


	)

37 
	~"¥dk/¡dšc.h
"

39 
	~"¥dk/jsÚ½c.h
"

41 (*
	t¥dk_½c_m‘hod_hªdËr
)(
	t¥dk_jsÚ½c_£rv”_cÚn
 *
	tcÚn
,

42 cÚ¡ 
	t¥dk_jsÚ_v®
 *
	t·¿ms
,

43 cÚ¡ 
	t¥dk_jsÚ_v®
 *
	tid
);

45 
	`¥dk_½c_»gi¡”_m‘hod
(cÚ¡ *
m‘hod
, 
¥dk_½c_m‘hod_hªdËr
 
func
);

47 
	#SPDK_RPC_REGISTER
(
m‘hod
, 
func
) \

48 
	`__©Œibu‹__
((
cÚ¡ruùÜ
)è
½c_»gi¡”_
##
	`func
() \

50 
	`¥dk_½c_»gi¡”_m‘hod
(
m‘hod
, 
func
); \

51 
	}

	)
}

	@PDK/core/src/api/include/udd/spdk/scsi.h

39 #iâdeà
SPDK_SCSI_H


40 
	#SPDK_SCSI_H


	)

42 
	~"¥dk/¡dšc.h
"

44 
	~"¥dk/queue.h
"

45 
	~"¥dk/ev’t.h
"

48 
	#OWNER_SCSI_DEV
 0x10

	)

49 
	#OBJECT_SCSI_TASK
 0x10

	)

50 
	#TRACE_GROUP_SCSI
 0x2

	)

51 
	#TRACE_SCSI_TASK_DONE
 
	`SPDK_TPOINT_ID
(
TRACE_GROUP_SCSI
, 0x0)

	)

52 
	#TRACE_SCSI_TASK_START
 
	`SPDK_TPOINT_ID
(
TRACE_GROUP_SCSI
, 0x1)

	)

54 
	#SPDK_SCSI_MAX_DEVS
 1024

	)

55 
	#SPDK_SCSI_DEV_MAX_LUN
 64

	)

56 
	#SPDK_SCSI_DEV_MAX_PORTS
 4

	)

57 
	#SPDK_SCSI_DEV_MAX_NAME
 255

	)

59 
	#SPDK_SCSI_PORT_MAX_NAME_LENGTH
 255

	)

61 
	#SPDK_SCSI_LUN_MAX_NAME_LENGTH
 16

	)

63 
	e¥dk_scsi_d©a_dœ
 {

64 
	mSPDK_SCSI_DIR_NONE
 = 0,

65 
	mSPDK_SCSI_DIR_TO_DEV
 = 1,

66 
	mSPDK_SCSI_DIR_FROM_DEV
 = 2,

69 
	e¥dk_scsi_sk_func
 {

70 
	mSPDK_SCSI_TASK_FUNC_ABORT_TASK
 = 0,

71 
	mSPDK_SCSI_TASK_FUNC_ABORT_TASK_SET
,

72 
	mSPDK_SCSI_TASK_FUNC_CLEAR_TASK_SET
,

73 
	mSPDK_SCSI_TASK_FUNC_LUN_RESET
,

76 
	e¥dk_scsi_sk_ty³
 {

77 
	mSPDK_SCSI_TASK_TYPE_CMD
 = 0,

78 
	mSPDK_SCSI_TASK_TYPE_MANAGE
,

86 
	e¥dk_scsi_sk_mgmt_»¥
 {

87 
	mSPDK_SCSI_TASK_MGMT_RESP_COMPLETE
,

88 
	mSPDK_SCSI_TASK_MGMT_RESP_SUCCESS
,

89 
	mSPDK_SCSI_TASK_MGMT_RESP_REJECT
,

90 
	mSPDK_SCSI_TASK_MGMT_RESP_INVALID_LUN
,

91 
	mSPDK_SCSI_TASK_MGMT_RESP_TARGET_FAILURE
,

92 
	mSPDK_SCSI_TASK_MGMT_RESP_REJECT_FUNC_NOT_SUPPORTED


95 
	s¥dk_scsi_sk
 {

96 
ušt8_t
 
	mty³
;

97 
ušt8_t
 
	m¡©us
;

98 
ušt8_t
 
	mfunùiÚ
;

99 
ušt8_t
 
	m»¥Ú£
;

100 
¥dk_scsi_lun
 *
	mlun
;

101 
¥dk_io_chªÃl
 *
	mch
;

102 
¥dk_scsi_pÜt
 *
	mrg‘_pÜt
;

103 
¥dk_scsi_pÜt
 *
	mš™ŸtÜ_pÜt
;

104 
¥dk_ev’t
 *
	mcb_ev’t
;

106 
ušt32_t
 
	m»f
;

107 
ušt32_t
 
	mŒªsãr_Ën
;

108 
ušt32_t
 
	mdxãr_dœ
;

109 
ušt32_t
 
	mËngth
;

115 
ušt32_t
 
	md©a_Œªsã¼ed
;

117 
ušt64_t
 
	moff£t
;

118 
¥dk_scsi_sk
 *
	m·»Á
;

120 (*
	mä“_â
)(
	m¥dk_scsi_sk
 *);

122 
ušt8_t
 *
	mcdb
;

128 
ušt32_t
 
	m®loc_Ën
;

133 
iovec
 
	miov
;

134 
iovec
 *
	miovs
;

135 
ušt16_t
 
	miovút
;

137 
ušt8_t
 
	m£n£_d©a
[32];

138 
size_t
 
	m£n£_d©a_Ën
;

140 *
	mblockdev_io
;

142 
TAILQ_ENTRY
(
¥dk_scsi_sk
è
	mscsi_lšk
;

144 
ušt32_t
 
	mabÜt_id
;

147 
	g¥dk_scsi_pÜt
;

149 
	g¥dk_scsi_dev
;

160 
	g¥dk_scsi_lun
;

162 
¥dk_scsi_lun_g‘_id
(cÚ¡ 
¥dk_scsi_lun
 *
lun
);

163 cÚ¡ *
¥dk_scsi_lun_g‘_Çme
(cÚ¡ 
¥dk_scsi_lun
 *
lun
);

165 cÚ¡ *
¥dk_scsi_dev_g‘_Çme
(cÚ¡ 
¥dk_scsi_dev
 *
dev
);

166 
¥dk_scsi_dev_g‘_id
(cÚ¡ 
¥dk_scsi_dev
 *
dev
);

167 
¥dk_scsi_dev_g‘_max_lun
(cÚ¡ 
¥dk_scsi_dev
 *
dev
);

168 
¥dk_scsi_lun
 *
¥dk_scsi_dev_g‘_lun
(
¥dk_scsi_dev
 *
dev
, 
lun_id
);

169 
¥dk_scsi_dev_de¡ruù
(
¥dk_scsi_dev
 *
dev
);

170 
¥dk_scsi_dev_queue_mgmt_sk
(
¥dk_scsi_dev
 *
dev
, 
¥dk_scsi_sk
 *
sk
);

171 
¥dk_scsi_dev_queue_sk
(
¥dk_scsi_dev
 *
dev
, 
¥dk_scsi_sk
 *
sk
);

172 
¥dk_scsi_dev_add_pÜt
(
¥dk_scsi_dev
 *
dev
, 
ušt64_t
 
id
, cÚ¡ *
Çme
);

173 
¥dk_scsi_pÜt
 *
¥dk_scsi_dev_fšd_pÜt_by_id
(
¥dk_scsi_dev
 *
dev
, 
ušt64_t
 
id
);

174 
¥dk_scsi_dev_´št
(
¥dk_scsi_dev
 *
dev
);

175 
¥dk_scsi_dev_®loÿ‹_io_chªÃls
(
¥dk_scsi_dev
 *
dev
);

176 
¥dk_scsi_dev_ä“_io_chªÃls
(
¥dk_scsi_dev
 *
dev
);

192 
¥dk_scsi_dev
 *
¥dk_scsi_dev_cÚ¡ruù
(cÚ¡ *
Çme
,

193 *
lun_Çme_li¡
[],

194 *
lun_id_li¡
,

195 
num_luns
);

197 
¥dk_scsi_dev_d–‘e_lun
(
¥dk_scsi_dev
 *
dev
, 
¥dk_scsi_lun
 *
lun
);

200 
¥dk_scsi_pÜt
 *
¥dk_scsi_pÜt_ü—‹
(
ušt64_t
 
id
, 
ušt16_t
 
šdex
, cÚ¡ *
Çme
);

201 
¥dk_scsi_pÜt_ä“
(
¥dk_scsi_pÜt
 **
µÜt
);

202 cÚ¡ *
¥dk_scsi_pÜt_g‘_Çme
(cÚ¡ 
¥dk_scsi_pÜt
 *
pÜt
);

205 
¥dk_scsi_sk_cÚ¡ruù
(
¥dk_scsi_sk
 *
sk
,

206 (*
ä“_â
)(
¥dk_scsi_sk
 *
sk
),

207 
¥dk_scsi_sk
 *
·»Á
);

208 
	`¥dk_scsi_sk_put
(
¥dk_scsi_sk
 *
sk
);

210 
	`¥dk_scsi_sk_ä“_d©a
(
¥dk_scsi_sk
 *
sk
);

218 
	`¥dk_scsi_sk_£t_d©a
(
¥dk_scsi_sk
 *
sk
, *
d©a
, 
ušt32_t
 
Ën
);

232 *
	`¥dk_scsi_sk_®loc_d©a
(
¥dk_scsi_sk
 *
sk
, 
ušt32_t
 
®loc_Ën
);

234 
	`¥dk_scsi_sk_sÿ‰”_d©a
(
¥dk_scsi_sk
 *
sk
, cÚ¡ *
¤c
, 
size_t
 
Ën
);

235 *
	`¥dk_scsi_sk_g©h”_d©a
(
¥dk_scsi_sk
 *
sk
, *
Ën
);

236 
	`¥dk_scsi_sk_bud_£n£_d©a
(
¥dk_scsi_sk
 *
sk
, 
sk
, 
asc
,

237 
ascq
);

238 
	`¥dk_scsi_sk_£t_¡©us
(
¥dk_scsi_sk
 *
sk
, 
sc
, 
sk
, 
asc
,

239 
ascq
);

240 
	`¥dk_scsi_sk_´oûss_nuÎ_lun
(
¥dk_scsi_sk
 *
sk
);

242 
šlše
 
¥dk_scsi_sk
 *

243 
	$¥dk_scsi_sk_g‘_´im¬y
(
¥dk_scsi_sk
 *
sk
)

245 ià(
sk
->
·»Á
) {

246  
sk
->
·»Á
;

248  
sk
;

250 
	}
}

	@PDK/core/src/api/include/udd/spdk/scsi_spec.h

39 #iâdeà
SPDK_SCSI_SPEC_H


40 
	#SPDK_SCSI_SPEC_H


	)

42 
	~"¥dk/¡dšc.h
"

44 
	~"¥dk/as£¹.h
"

46 
	e¥dk_scsi_group_code
 {

47 
	mSPDK_SCSI_6BYTE_CMD
 = 0x00,

48 
	mSPDK_SCSI_10BYTE_CMD
 = 0x20,

49 
	mSPDK_SCSI_10BYTE_CMD2
 = 0x40,

50 
	mSPDK_SCSI_16BYTE_CMD
 = 0x80,

51 
	mSPDK_SCSI_12BYTE_CMD
 = 0xa0,

54 
	#SPDK_SCSI_GROUP_MASK
 0xe0

	)

55 
	#SPDK_SCSI_OPCODE_MASK
 0x1f

	)

57 
	e¥dk_scsi_¡©us
 {

58 
	mSPDK_SCSI_STATUS_GOOD
 = 0x00,

59 
	mSPDK_SCSI_STATUS_CHECK_CONDITION
 = 0x02,

60 
	mSPDK_SCSI_STATUS_CONDITION_MET
 = 0x04,

61 
	mSPDK_SCSI_STATUS_BUSY
 = 0x08,

62 
	mSPDK_SCSI_STATUS_INTERMEDIATE
 = 0x10,

63 
	mSPDK_SCSI_STATUS_INTERMEDIATE_CONDITION_MET
 = 0x14,

64 
	mSPDK_SCSI_STATUS_RESERVATION_CONFLICT
 = 0x18,

65 
	mSPDK_SCSI_STATUS_ObsŞ‘e
 = 0x22,

66 
	mSPDK_SCSI_STATUS_TASK_SET_FULL
 = 0x28,

67 
	mSPDK_SCSI_STATUS_ACA_ACTIVE
 = 0x30,

68 
	mSPDK_SCSI_STATUS_TASK_ABORTED
 = 0x40,

71 
	e¥dk_scsi_£n£
 {

72 
	mSPDK_SCSI_SENSE_NO_SENSE
 = 0x00,

73 
	mSPDK_SCSI_SENSE_RECOVERED_ERROR
 = 0x01,

74 
	mSPDK_SCSI_SENSE_NOT_READY
 = 0x02,

75 
	mSPDK_SCSI_SENSE_MEDIUM_ERROR
 = 0x03,

76 
	mSPDK_SCSI_SENSE_HARDWARE_ERROR
 = 0x04,

77 
	mSPDK_SCSI_SENSE_ILLEGAL_REQUEST
 = 0x05,

78 
	mSPDK_SCSI_SENSE_UNIT_ATTENTION
 = 0x06,

79 
	mSPDK_SCSI_SENSE_DATA_PROTECT
 = 0x07,

80 
	mSPDK_SCSI_SENSE_BLANK_CHECK
 = 0x08,

81 
	mSPDK_SCSI_SENSE_VENDOR_SPECIFIC
 = 0x09,

82 
	mSPDK_SCSI_SENSE_COPY_ABORTED
 = 0x0a,

83 
	mSPDK_SCSI_SENSE_ABORTED_COMMAND
 = 0x0b,

84 
	mSPDK_SCSI_SENSE_VOLUME_OVERFLOW
 = 0x0d,

85 
	mSPDK_SCSI_SENSE_MISCOMPARE
 = 0x0e,

88 
	e¥dk_scsi_asc
 {

89 
	mSPDK_SCSI_ASC_NO_ADDITIONAL_SENSE
 = 0x00,

90 
	mSPDK_SCSI_ASC_PERIPHERAL_DEVICE_WRITE_FAULT
 = 0x03,

91 
	mSPDK_SCSI_ASC_LOGICAL_UNIT_NOT_READY
 = 0x04,

92 
	mSPDK_SCSI_ASC_WARNING
 = 0x0b,

93 
	mSPDK_SCSI_ASC_LOGICAL_BLOCK_GUARD_CHECK_FAILED
 = 0x10,

94 
	mSPDK_SCSI_ASC_LOGICAL_BLOCK_APP_TAG_CHECK_FAILED
 = 0x10,

95 
	mSPDK_SCSI_ASC_LOGICAL_BLOCK_REF_TAG_CHECK_FAILED
 = 0x10,

96 
	mSPDK_SCSI_ASC_UNRECOVERED_READ_ERROR
 = 0x11,

97 
	mSPDK_SCSI_ASC_MISCOMPARE_DURING_VERIFY_OPERATION
 = 0x1d,

98 
	mSPDK_SCSI_ASC_INVALID_COMMAND_OPERATION_CODE
 = 0x20,

99 
	mSPDK_SCSI_ASC_ACCESS_DENIED
 = 0x20,

100 
	mSPDK_SCSI_ASC_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
 = 0x21,

101 
	mSPDK_SCSI_ASC_INVALID_FIELD_IN_CDB
 = 0x24,

102 
	mSPDK_SCSI_ASC_LOGICAL_UNIT_NOT_SUPPORTED
 = 0x25,

103 
	mSPDK_SCSI_ASC_WRITE_PROTECTED
 = 0x27,

104 
	mSPDK_SCSI_ASC_FORMAT_COMMAND_FAILED
 = 0x31,

105 
	mSPDK_SCSI_ASC_SAVING_PARAMETERS_NOT_SUPPORTED
 = 0x39,

106 
	mSPDK_SCSI_ASC_INTERNAL_TARGET_FAILURE
 = 0x44,

109 
	e¥dk_scsi_ascq
 {

110 
	mSPDK_SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 = 0x00,

111 
	mSPDK_SCSI_ASCQ_BECOMING_READY
 = 0x01,

112 
	mSPDK_SCSI_ASCQ_FORMAT_COMMAND_FAILED
 = 0x01,

113 
	mSPDK_SCSI_ASCQ_LOGICAL_BLOCK_GUARD_CHECK_FAILED
 = 0x01,

114 
	mSPDK_SCSI_ASCQ_LOGICAL_BLOCK_APP_TAG_CHECK_FAILED
 = 0x02,

115 
	mSPDK_SCSI_ASCQ_NO_ACCESS_RIGHTS
 = 0x02,

116 
	mSPDK_SCSI_ASCQ_LOGICAL_BLOCK_REF_TAG_CHECK_FAILED
 = 0x03,

117 
	mSPDK_SCSI_ASCQ_POWER_LOSS_EXPECTED
 = 0x08,

118 
	mSPDK_SCSI_ASCQ_INVALID_LU_IDENTIFIER
 = 0x09,

121 
	e¥dk_¥c_İcode
 {

123 
	mSPDK_SPC_ACCESS_CONTROL_IN
 = 0x86,

124 
	mSPDK_SPC_ACCESS_CONTROL_OUT
 = 0x87,

125 
	mSPDK_SPC_EXTENDED_COPY
 = 0x83,

126 
	mSPDK_SPC_INQUIRY
 = 0x12,

127 
	mSPDK_SPC_LOG_SELECT
 = 0x4c,

128 
	mSPDK_SPC_LOG_SENSE
 = 0x4d,

129 
	mSPDK_SPC_MODE_SELECT_6
 = 0x15,

130 
	mSPDK_SPC_MODE_SELECT_10
 = 0x55,

131 
	mSPDK_SPC_MODE_SENSE_6
 = 0x1a,

132 
	mSPDK_SPC_MODE_SENSE_10
 = 0x5a,

133 
	mSPDK_SPC_PERSISTENT_RESERVE_IN
 = 0x5e,

134 
	mSPDK_SPC_PERSISTENT_RESERVE_OUT
 = 0x5f,

135 
	mSPDK_SPC_PREVENT_ALLOW_MEDIUM_REMOVAL
 = 0x1e,

136 
	mSPDK_SPC_READ_ATTRIBUTE
 = 0x8c,

137 
	mSPDK_SPC_READ_BUFFER
 = 0x3c,

138 
	mSPDK_SPC_RECEIVE_COPY_RESULTS
 = 0x84,

139 
	mSPDK_SPC_RECEIVE_DIAGNOSTIC_RESULTS
 = 0x1c,

140 
	mSPDK_SPC_REPORT_LUNS
 = 0xa0,

141 
	mSPDK_SPC_REQUEST_SENSE
 = 0x03,

142 
	mSPDK_SPC_SEND_DIAGNOSTIC
 = 0x1d,

143 
	mSPDK_SPC_TEST_UNIT_READY
 = 0x00,

144 
	mSPDK_SPC_WRITE_ATTRIBUTE
 = 0x8d,

145 
	mSPDK_SPC_WRITE_BUFFER
 = 0x3b,

147 
	mSPDK_SPC_SERVICE_ACTION_IN_12
 = 0xab,

148 
	mSPDK_SPC_SERVICE_ACTION_OUT_12
 = 0xa9,

149 
	mSPDK_SPC_SERVICE_ACTION_IN_16
 = 0x9e,

150 
	mSPDK_SPC_SERVICE_ACTION_OUT_16
 = 0x9f,

152 
	mSPDK_SPC_VARIABLE_LENGTH
 = 0x7f,

154 
	mSPDK_SPC_MO_CHANGE_ALIASES
 = 0x0b,

155 
	mSPDK_SPC_MO_SET_DEVICE_IDENTIFIER
 = 0x06,

156 
	mSPDK_SPC_MO_SET_PRIORITY
 = 0x0e,

157 
	mSPDK_SPC_MO_SET_TARGET_PORT_GROUPS
 = 0x0a,

158 
	mSPDK_SPC_MO_SET_TIMESTAMP
 = 0x0f,

159 
	mSPDK_SPC_MI_REPORT_ALIASES
 = 0x0b,

160 
	mSPDK_SPC_MI_REPORT_DEVICE_IDENTIFIER
 = 0x05,

161 
	mSPDK_SPC_MI_REPORT_PRIORITY
 = 0x0e,

162 
	mSPDK_SPC_MI_REPORT_SUPPORTED_OPERATION_CODES
 = 0x0c,

163 
	mSPDK_SPC_MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
 = 0x0d,

164 
	mSPDK_SPC_MI_REPORT_TARGET_PORT_GROUPS
 = 0x0a,

165 
	mSPDK_SPC_MI_REPORT_TIMESTAMP
 = 0x0f,

168 
	mSPDK_SPC2_RELEASE_6
 = 0x17,

169 
	mSPDK_SPC2_RELEASE_10
 = 0x57,

170 
	mSPDK_SPC2_RESERVE_6
 = 0x16,

171 
	mSPDK_SPC2_RESERVE_10
 = 0x56,

174 
	e¥dk_scc_İcode
 {

175 
	mSPDK_SCC_MAINTENANCE_IN
 = 0xa3,

176 
	mSPDK_SCC_MAINTENANCE_OUT
 = 0xa4,

179 
	e¥dk_sbc_İcode
 {

180 
	mSPDK_SBC_COMPARE_AND_WRITE
 = 0x89,

181 
	mSPDK_SBC_FORMAT_UNIT
 = 0x04,

182 
	mSPDK_SBC_GET_LBA_STATUS
 = 0x0012009e,

183 
	mSPDK_SBC_ORWRITE_16
 = 0x8b,

184 
	mSPDK_SBC_PRE_FETCH_10
 = 0x34,

185 
	mSPDK_SBC_PRE_FETCH_16
 = 0x90,

186 
	mSPDK_SBC_READ_6
 = 0x08,

187 
	mSPDK_SBC_READ_10
 = 0x28,

188 
	mSPDK_SBC_READ_12
 = 0xa8,

189 
	mSPDK_SBC_READ_16
 = 0x88,

190 
	mSPDK_SBC_READ_ATTRIBUTE
 = 0x8c,

191 
	mSPDK_SBC_READ_BUFFER
 = 0x3c,

192 
	mSPDK_SBC_READ_CAPACITY_10
 = 0x25,

193 
	mSPDK_SBC_READ_DEFECT_DATA_10
 = 0x37,

194 
	mSPDK_SBC_READ_DEFECT_DATA_12
 = 0xb7,

195 
	mSPDK_SBC_READ_LONG_10
 = 0x3e,

196 
	mSPDK_SBC_REASSIGN_BLOCKS
 = 0x07,

197 
	mSPDK_SBC_SANITIZE
 = 0x48,

198 
	mSPDK_SBC_START_STOP_UNIT
 = 0x1b,

199 
	mSPDK_SBC_SYNCHRONIZE_CACHE_10
 = 0x35,

200 
	mSPDK_SBC_SYNCHRONIZE_CACHE_16
 = 0x91,

201 
	mSPDK_SBC_UNMAP
 = 0x42,

202 
	mSPDK_SBC_VERIFY_10
 = 0x2f,

203 
	mSPDK_SBC_VERIFY_12
 = 0xaf,

204 
	mSPDK_SBC_VERIFY_16
 = 0x8f,

205 
	mSPDK_SBC_WRITE_6
 = 0x0a,

206 
	mSPDK_SBC_WRITE_10
 = 0x2a,

207 
	mSPDK_SBC_WRITE_12
 = 0xaa,

208 
	mSPDK_SBC_WRITE_16
 = 0x8a,

209 
	mSPDK_SBC_WRITE_AND_VERIFY_10
 = 0x2e,

210 
	mSPDK_SBC_WRITE_AND_VERIFY_12
 = 0xae,

211 
	mSPDK_SBC_WRITE_AND_VERIFY_16
 = 0x8e,

212 
	mSPDK_SBC_WRITE_LONG_10
 = 0x3f,

213 
	mSPDK_SBC_WRITE_SAME_10
 = 0x41,

214 
	mSPDK_SBC_WRITE_SAME_16
 = 0x93,

215 
	mSPDK_SBC_XDREAD_10
 = 0x52,

216 
	mSPDK_SBC_XDWRITE_10
 = 0x50,

217 
	mSPDK_SBC_XDWRITEREAD_10
 = 0x53,

218 
	mSPDK_SBC_XPWRITE_10
 = 0x51,

220 
	mSPDK_SBC_SAI_READ_CAPACITY_16
 = 0x10,

221 
	mSPDK_SBC_SAI_READ_LONG_16
 = 0x11,

222 
	mSPDK_SBC_SAO_WRITE_LONG_16
 = 0x11,

224 
	mSPDK_SBC_VL_READ_32
 = 0x0009,

225 
	mSPDK_SBC_VL_VERIFY_32
 = 0x000a,

226 
	mSPDK_SBC_VL_WRITE_32
 = 0x000b,

227 
	mSPDK_SBC_VL_WRITE_AND_VERIFY_32
 = 0x000c,

228 
	mSPDK_SBC_VL_WRITE_SAME_32
 = 0x000d,

229 
	mSPDK_SBC_VL_XDREAD_32
 = 0x0003,

230 
	mSPDK_SBC_VL_XDWRITE_32
 = 0x0004,

231 
	mSPDK_SBC_VL_XDWRITEREAD_32
 = 0x0007,

232 
	mSPDK_SBC_VL_XPWRITE_32
 = 0x0006,

235 
	e¥dk_mmc_İcode
 {

237 
	mSPDK_MMC_READ_DISC_STRUCTURE
 = 0xad,

240 
	mSPDK_MMC_BLANK
 = 0xa1,

241 
	mSPDK_MMC_CLOSE_TRACK_SESSION
 = 0x5b,

242 
	mSPDK_MMC_ERASE_10
 = 0x2c,

243 
	mSPDK_MMC_FORMAT_UNIT
 = 0x04,

244 
	mSPDK_MMC_GET_CONFIGURATION
 = 0x46,

245 
	mSPDK_MMC_GET_EVENT_STATUS_NOTIFICATION
 = 0x4a,

246 
	mSPDK_MMC_GET_PERFORMANCE
 = 0xac,

247 
	mSPDK_MMC_INQUIRY
 = 0x12,

248 
	mSPDK_MMC_LOAD_UNLOAD_MEDIUM
 = 0xa6,

249 
	mSPDK_MMC_MECHANISM_STATUS
 = 0xbd,

250 
	mSPDK_MMC_MODE_SELECT_10
 = 0x55,

251 
	mSPDK_MMC_MODE_SENSE_10
 = 0x5a,

252 
	mSPDK_MMC_PAUSE_RESUME
 = 0x4b,

253 
	mSPDK_MMC_PLAY_AUDIO_10
 = 0x45,

254 
	mSPDK_MMC_PLAY_AUDIO_12
 = 0xa5,

255 
	mSPDK_MMC_PLAY_AUDIO_MSF
 = 0x47,

256 
	mSPDK_MMC_PREVENT_ALLOW_MEDIUM_REMOVAL
 = 0x1e,

257 
	mSPDK_MMC_READ_10
 = 0x28,

258 
	mSPDK_MMC_READ_12
 = 0xa8,

259 
	mSPDK_MMC_READ_BUFFER
 = 0x3c,

260 
	mSPDK_MMC_READ_BUFFER_CAPACITY
 = 0x5c,

261 
	mSPDK_MMC_READ_CAPACITY
 = 0x25,

262 
	mSPDK_MMC_READ_CD
 = 0xbe,

263 
	mSPDK_MMC_READ_CD_MSF
 = 0xb9,

264 
	mSPDK_MMC_READ_DISC_INFORMATION
 = 0x51,

265 
	mSPDK_MMC_READ_DVD_STRUCTURE
 = 0xad,

266 
	mSPDK_MMC_READ_FORMAT_CAPACITIES
 = 0x23,

267 
	mSPDK_MMC_READ_SUB_CHANNEL
 = 0x42,

268 
	mSPDK_MMC_READ_TOC_PMA_ATIP
 = 0x43,

269 
	mSPDK_MMC_READ_TRACK_INFORMATION
 = 0x52,

270 
	mSPDK_MMC_REPAIR_TRACK
 = 0x58,

271 
	mSPDK_MMC_REPORT_KEY
 = 0xa4,

272 
	mSPDK_MMC_REQUEST_SENSE
 = 0x03,

273 
	mSPDK_MMC_RESERVE_TRACK
 = 0x53,

274 
	mSPDK_MMC_SCAN
 = 0xba,

275 
	mSPDK_MMC_SEEK_10
 = 0x2b,

276 
	mSPDK_MMC_SEND_CUE_SHEET
 = 0x5d,

277 
	mSPDK_MMC_SEND_DVD_STRUCTURE
 = 0xbf,

278 
	mSPDK_MMC_SEND_KEY
 = 0xa3,

279 
	mSPDK_MMC_SEND_OPC_INFORMATION
 = 0x54,

280 
	mSPDK_MMC_SET_CD_SPEED
 = 0xbb,

281 
	mSPDK_MMC_SET_READ_AHEAD
 = 0xa7,

282 
	mSPDK_MMC_SET_STREAMING
 = 0xb6,

283 
	mSPDK_MMC_START_STOP_UNIT
 = 0x1b,

284 
	mSPDK_MMC_STOP_PLAY_SCAN
 = 0x4e,

285 
	mSPDK_MMC_SYNCHRONIZE_CACHE
 = 0x35,

286 
	mSPDK_MMC_TEST_UNIT_READY
 = 0x00,

287 
	mSPDK_MMC_VERIFY_10
 = 0x2f,

288 
	mSPDK_MMC_WRITE_10
 = 0xa2,

289 
	mSPDK_MMC_WRITE_12
 = 0xaa,

290 
	mSPDK_MMC_WRITE_AND_VERIFY_10
 = 0x2e,

291 
	mSPDK_MMC_WRITE_BUFFER
 = 0x3b,

294 
	e¥dk_ssc_İcode
 {

295 
	mSPDK_SSC_ERASE_6
 = 0x19,

296 
	mSPDK_SSC_FORMAT_MEDIUM
 = 0x04,

297 
	mSPDK_SSC_LOAD_UNLOAD
 = 0x1b,

298 
	mSPDK_SSC_LOCATE_10
 = 0x2b,

299 
	mSPDK_SSC_LOCATE_16
 = 0x92,

300 
	mSPDK_SSC_MOVE_MEDIUM_ATTACHED
 = 0xa7,

301 
	mSPDK_SSC_READ_6
 = 0x08,

302 
	mSPDK_SSC_READ_BLOCK_LIMITS
 = 0x05,

303 
	mSPDK_SSC_READ_ELEMENT_STATUS_ATTACHED
 = 0xb4,

304 
	mSPDK_SSC_READ_POSITION
 = 0x34,

305 
	mSPDK_SSC_READ_REVERSE_6
 = 0x0f,

306 
	mSPDK_SSC_RECOVER_BUFFERED_DATA
 = 0x14,

307 
	mSPDK_SSC_REPORT_DENSITY_SUPPORT
 = 0x44,

308 
	mSPDK_SSC_REWIND
 = 0x01,

309 
	mSPDK_SSC_SET_CAPACITY
 = 0x0b,

310 
	mSPDK_SSC_SPACE_6
 = 0x11,

311 
	mSPDK_SSC_SPACE_16
 = 0x91,

312 
	mSPDK_SSC_VERIFY_6
 = 0x13,

313 
	mSPDK_SSC_WRITE_6
 = 0x0a,

314 
	mSPDK_SSC_WRITE_FILEMARKS_6
 = 0x10,

317 
	e¥dk_¥c_vpd
 {

318 
	mSPDK_SPC_VPD_DEVICE_IDENTIFICATION
 = 0x83,

319 
	mSPDK_SPC_VPD_EXTENDED_INQUIRY_DATA
 = 0x86,

320 
	mSPDK_SPC_VPD_MANAGEMENT_NETWORK_ADDRESSES
 = 0x85,

321 
	mSPDK_SPC_VPD_MODE_PAGE_POLICY
 = 0x87,

322 
	mSPDK_SPC_VPD_SCSI_PORTS
 = 0x88,

323 
	mSPDK_SPC_VPD_SOFTWARE_INTERFACE_IDENTIFICATION
 = 0x84,

324 
	mSPDK_SPC_VPD_SUPPORTED_VPD_PAGES
 = 0x00,

325 
	mSPDK_SPC_VPD_UNIT_SERIAL_NUMBER
 = 0x80,

326 
	mSPDK_SPC_VPD_BLOCK_LIMITS
 = 0xb0,

327 
	mSPDK_SPC_VPD_BLOCK_DEV_CHARS
 = 0xb1,

328 
	mSPDK_SPC_VPD_BLOCK_THIN_PROVISION
 = 0xb2,

332 
	mSPDK_SPC_PERIPHERAL_DEVICE_TYPE_DISK
 = 0x00,

333 
	mSPDK_SPC_PERIPHERAL_DEVICE_TYPE_TAPE
 = 0x01,

334 
	mSPDK_SPC_PERIPHERAL_DEVICE_TYPE_DVD
 = 0x05,

335 
	mSPDK_SPC_PERIPHERAL_DEVICE_TYPE_CHANGER
 = 0x08,

337 
	mSPDK_SPC_VERSION_NONE
 = 0x00,

338 
	mSPDK_SPC_VERSION_SPC
 = 0x03,

339 
	mSPDK_SPC_VERSION_SPC2
 = 0x04,

340 
	mSPDK_SPC_VERSION_SPC3
 = 0x05,

341 
	mSPDK_SPC_VERSION_SPC4
 = 0x06,

343 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_FC
 = 0x00,

344 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_PSCSI
 = 0x01,

345 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_SSA
 = 0x02,

346 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_IEEE1394
 = 0x03,

347 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_RDMA
 = 0x04,

348 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_ISCSI
 = 0x05,

349 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_SAS
 = 0x06,

350 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_ADT
 = 0x07,

351 
	mSPDK_SPC_PROTOCOL_IDENTIFIER_ATA
 = 0x08,

353 
	mSPDK_SPC_VPD_CODE_SET_BINARY
 = 0x01,

354 
	mSPDK_SPC_VPD_CODE_SET_ASCII
 = 0x02,

355 
	mSPDK_SPC_VPD_CODE_SET_UTF8
 = 0x03,

357 
	mSPDK_SPC_VPD_ASSOCIATION_LOGICAL_UNIT
 = 0x00,

358 
	mSPDK_SPC_VPD_ASSOCIATION_TARGET_PORT
 = 0x01,

359 
	mSPDK_SPC_VPD_ASSOCIATION_TARGET_DEVICE
 = 0x02,

361 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_VENDOR_SPECIFIC
 = 0x00,

362 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_T10_VENDOR_ID
 = 0x01,

363 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_EUI64
 = 0x02,

364 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_NAA
 = 0x03,

365 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_RELATIVE_TARGET_PORT
 = 0x04,

366 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_TARGET_PORT_GROUP
 = 0x05,

367 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_LOGICAL_UNIT_GROUP
 = 0x06,

368 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_MD5_LOGICAL_UNIT
 = 0x07,

369 
	mSPDK_SPC_VPD_IDENTIFIER_TYPE_SCSI_NAME
 = 0x08,

372 
	s¥dk_scsi_cdb_šquœy
 {

373 
ušt8_t
 
	mİcode
;

374 
ušt8_t
 
	mevpd
;

375 
ušt8_t
 
	m·ge_code
;

376 
ušt8_t
 
	m®loc_Ën
[2];

377 
ušt8_t
 
	mcÚŒŞ
;

379 
SPDK_STATIC_ASSERT
((
¥dk_scsi_cdb_šquœy
) == 6, "incorrect CDB size");

381 
	s¥dk_scsi_cdb_šquœy_d©a
 {

382 
ušt8_t
 
	m³rh”®
;

383 
ušt8_t
 
	mrmb
;

384 
ušt8_t
 
	mv”siÚ
;

385 
ušt8_t
 
	m»¥Ú£
;

386 
ušt8_t
 
	madd_Ën
;

387 
ušt8_t
 
	mæags
;

388 
ušt8_t
 
	mæags2
;

389 
ušt8_t
 
	mæags3
;

390 
ušt8_t
 
	mt10_v’dÜ_id
[8];

391 
ušt8_t
 
	m´oduù_id
[16];

392 
ušt8_t
 
	m´oduù_»v
[4];

393 
ušt8_t
 
	mv’dÜ
[20];

394 
ušt8_t
 
	mius
;

395 
ušt8_t
 
	m»£rved
;

396 
ušt8_t
 
	mdesc
[];

399 
	s¥dk_scsi_vpd_·ge
 {

400 
ušt8_t
 
	m³rh”®
;

401 
ušt8_t
 
	m·ge_code
;

402 
ušt8_t
 
	m®loc_Ën
[2];

403 
ušt8_t
 
	m·¿ms
[];

406 
	#SPDK_SCSI_VEXT_REF_CHK
 0x01

	)

407 
	#SPDK_SCSI_VEXT_APP_CHK
 0x02

	)

408 
	#SPDK_SCSI_VEXT_GRD_CHK
 0x04

	)

409 
	#SPDK_SCSI_VEXT_SIMPSUP
 0x01

	)

410 
	#SPDK_SCSI_VEXT_ORDSUP
 0x02

	)

411 
	#SPDK_SCSI_VEXT_HEADSUP
 0x04

	)

412 
	#SPDK_SCSI_VEXT_PRIOR_SUP
 0x08

	)

413 
	#SPDK_SCSI_VEXT_GROUP_SUP
 0x10

	)

414 
	#SPDK_SCSI_VEXT_UASK_SUP
 0x20

	)

415 
	#SPDK_SCSI_VEXT_V_SUP
 0x01

	)

416 
	#SPDK_SCSI_VEXT_NV_SUP
 0x02

	)

417 
	#SPDK_SCSI_VEXT_CRD_SUP
 0x04

	)

418 
	#SPDK_SCSI_VEXT_WU_SUP
 0x08

	)

420 
	s¥dk_scsi_vpd_ext_šquœy
 {

421 
ušt8_t
 
	m³rh”®
;

422 
ušt8_t
 
	m·ge_code
;

423 
ušt8_t
 
	m®loc_Ën
[2];

424 
ušt8_t
 
	mcheck
;

425 
ušt8_t
 
	msup
;

426 
ušt8_t
 
	msup2
;

427 
ušt8_t
 
	mluişr
;

428 
ušt8_t
 
	mcbcs
;

429 
ušt8_t
 
	mmiüo_dl
;

430 
ušt8_t
 
	m»£rved
[54];

433 
	#SPDK_SPC_VPD_DESIG_PIV
 0x80

	)

436 
	s¥dk_scsi_desig_desc
 {

437 
ušt8_t
 
	mcode_£t
 : 4;

438 
ušt8_t
 
	m´ÙocŞ_id
 : 4;

439 
ušt8_t
 
	mty³
 : 4;

440 
ušt8_t
 
	massocŸtiÚ
 : 2;

441 
ušt8_t
 
	m»£rved0
 : 1;

442 
ušt8_t
 
	mpiv
 : 1;

443 
ušt8_t
 
	m»£rved1
;

444 
ušt8_t
 
	mËn
;

445 
ušt8_t
 
	mdesig
[];

447 
SPDK_STATIC_ASSERT
((
¥dk_scsi_desig_desc
) == 4, "Invalid size");

450 
	s¥dk_scsi_m·ge_pŞicy_desc
 {

451 
ušt8_t
 
	m·ge_code
;

452 
ušt8_t
 
	msub_·ge_code
;

453 
ušt8_t
 
	mpŞicy
;

454 
ušt8_t
 
	m»£rved
;

458 
	s¥dk_scsi_tgt_pÜt_desc
 {

459 
ušt8_t
 
	mcode_£t
;

460 
ušt8_t
 
	mdesig_ty³
;

461 
ušt8_t
 
	m»£rved
;

462 
ušt8_t
 
	mËn
;

463 
ušt8_t
 
	mdesigÇtÜ
[];

467 
	s¥dk_scsi_pÜt_desc
 {

468 
ušt16_t
 
	m»£rved
;

469 
ušt16_t
 
	m»l_pÜt_id
;

470 
ušt16_t
 
	m»£rved2
;

471 
ušt16_t
 
	mš™_pÜt_Ën
;

472 
ušt16_t
 
	mš™_pÜt_id
;

473 
ušt16_t
 
	m»£rved3
;

474 
ušt16_t
 
	mtgt_desc_Ën
;

475 
ušt8_t
 
	mtgt_desc
[];

479 
	s¥dk_scsi_unm­_bdesc
 {

481 
ušt64_t
 
	mlba
;

484 
ušt32_t
 
	mblock_couÁ
;

487 
ušt32_t
 
	m»£rved
;

490 
	#SPDK_SCSI_UNMAP_LBPU
 1 << 7

	)

491 
	#SPDK_SCSI_UNMAP_LBPWS
 1 << 6

	)

492 
	#SPDK_SCSI_UNMAP_LBPWS10
 1 << 5

	)

494 
	#SPDK_SCSI_UNMAP_FULL_PROVISIONING
 0x00

	)

495 
	#SPDK_SCSI_UNMAP_RESOURCE_PROVISIONING
 0x01

	)

496 
	#SPDK_SCSI_UNMAP_THIN_PROVISIONING
 0x02

	)

	@PDK/core/src/api/include/udd/spdk/stdinc.h

40 #iâdeà
SPDK_STDINC_H


41 
	#SPDK_STDINC_H


	)

43 #ifdeà
__ılu¥lus


48 
	~<as£¹.h
>

49 
	~<ùy³.h
>

50 
	~<”ºo.h
>

51 
	~<š‰y³s.h
>

52 
	~<lim™s.h
>

53 
	~<¡d¬g.h
>

54 
	~<¡dboŞ.h
>

55 
	~<¡ddef.h
>

56 
	~<¡dšt.h
>

57 
	~<¡dio.h
>

58 
	~<¡dlib.h
>

59 
	~<¡ršg.h
>

60 
	~<time.h
>

63 
	~<¬·/š‘.h
>

64 
	~<dœ’t.h
>

65 
	~<fú.h
>

66 
	~<içddrs.h
>

67 
	~<Ãtdb.h
>

68 
	~<pŞl.h
>

69 
	~<±h»ad.h
>

70 
	~<£m­hÜe.h
>

71 
	~<sigÇl.h
>

72 
	~<sy¦og.h
>

73 
	~<‹rmios.h
>

74 
	~<uni¡d.h
>

75 
	~<Ãt/if.h
>

76 
	~<Ãtš‘/š.h
>

77 
	~<Ãtš‘/tı.h
>

78 
	~<sys/ioùl.h
>

79 
	~<sys/mmª.h
>

80 
	~<sys/»sourû.h
>

81 
	~<sys/ty³s.h
>

82 
	~<sys/sock‘.h
>

83 
	~<sys/¡©.h
>

84 
	~<sys/uio.h
>

85 
	~<sys/un.h
>

86 
	~<sys/u£r.h
>

87 
	~<sys/wa™.h
>

89 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/string.h

38 #iâdeà
SPDK_STRING_H


39 
	#SPDK_STRING_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


54 *
¥dk_¥rštf_®loc
(cÚ¡ *
fÜm©
, ...è
__©Œibu‹__
((fÜm©(
´štf
, 1, 2)));

63 *
¥dk_v¥rštf_®loc
(cÚ¡ *
fÜm©
, 
va_li¡
 
¬gs
);

70 *
¥dk_¡¾wr
(*
s
);

83 *
¥dk_¡r£pq
(**
¡ršgp
, cÚ¡ *
d–im
);

90 *
¥dk_¡r_Œim
(*
s
);

102 
¥dk_¡rıy_·d
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
size
, 
·d
);

113 
size_t
 
¥dk_¡¾’_·d
(cÚ¡ *
¡r
, size_ˆ
size
, 
·d
);

128 
¥dk_·r£__addr
(*

, **
ho¡
, **
pÜt
);

130 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/trace.h

39 #iâdeà
_SPDK_TRACE_H_


40 
	#_SPDK_TRACE_H_


	)

42 
	~"¥dk/¡dšc.h
"

44 #ifdeà
__ılu¥lus


48 
	#SPDK_TRACE_SIZE
 (32 * 1024)

	)

50 
	s¥dk_Œaû_’Œy
 {

51 
ušt64_t
 
tsc
;

52 
ušt16_t
 
ošt_id
;

53 
ušt16_t
 
pŞËr_id
;

54 
ušt32_t
 
size
;

55 
ušt64_t
 
objeù_id
;

56 
ušt64_t
 
¬g1
;

60 
	#SPDK_TRACE_MAX_OWNER
 (
UCHAR_MAX
 + 1)

	)

62 
	s¥dk_Œaû_owÃr
 {

63 
ušt8_t
 
ty³
;

64 
id_´efix
;

68 
	#SPDK_TRACE_MAX_OBJECT
 (
UCHAR_MAX
 + 1)

	)

70 
	s¥dk_Œaû_objeù
 {

71 
ušt8_t
 
ty³
;

72 
id_´efix
;

75 
	#SPDK_TRACE_MAX_GROUP_ID
 16

	)

76 
	#SPDK_TRACE_MAX_TPOINT_ID
 (
SPDK_TRACE_MAX_GROUP_ID
 * 64)

	)

77 
	#SPDK_TPOINT_ID
(
group
, 
ošt
è((grou°* 64è+pošt)

	)

79 
	s¥dk_Œaû_ošt
 {

80 
Çme
[44];

81 
shÜt_Çme
[4];

82 
ušt16_t
 
ošt_id
;

83 
ušt8_t
 
owÃr_ty³
;

84 
ušt8_t
 
objeù_ty³
;

85 
ušt8_t
 
Ãw_objeù
;

86 
ušt8_t
 
¬g1_is_±r
;

87 
ušt8_t
 
¬g1_is_®Ÿs
;

88 
¬g1_Çme
[8];

91 
	s¥dk_Œaû_hi¡Üy
 {

93 
lcÜe
;

101 
¥dk_Œaû_’Œy
 
’Œ›s
[
SPDK_TRACE_SIZE
];

108 
ušt64_t
 
ošt_couÁ
[
SPDK_TRACE_MAX_TPOINT_ID
];

111 
ušt32_t
 
Ãxt_’Œy
;

115 
	#SPDK_TRACE_MAX_LCORE
 128

	)

117 
	s¥dk_Œaû_hi¡Ü›s
 {

118 
ušt64_t
 
tsc_¿‹
;

119 
ušt64_t
 
ošt_mask
[
SPDK_TRACE_MAX_GROUP_ID
];

120 
¥dk_Œaû_hi¡Üy
 
³r_lcÜe_hi¡Üy
[
SPDK_TRACE_MAX_LCORE
];

121 
¥dk_Œaû_owÃr
 
owÃr
[
UCHAR_MAX
 + 1];

122 
¥dk_Œaû_objeù
 
objeù
[
UCHAR_MAX
 + 1];

123 
¥dk_Œaû_ošt
 
ošt
[
SPDK_TRACE_MAX_TPOINT_ID
];

127 
¥dk_Œaû_»cÜd
(
ušt16_t
 
ošt_id
, ušt16_ˆ
pŞËr_id
, 
ušt32_t
 
size
,

128 
ušt64_t
 
objeù_id
, ušt64_ˆ
¬g1
);

131 
ušt64_t
 
¥dk_Œaû_g‘_ošt_mask
(
ušt32_t
 
group_id
);

134 
¥dk_Œaû_£t_ošts
(
ušt32_t
 
group_id
, 
ušt64_t
 
ošt_mask
);

137 
¥dk_Œaû_ş—r_ošts
(
ušt32_t
 
group_id
, 
ušt64_t
 
ošt_mask
);

140 
ušt64_t
 
¥dk_Œaû_g‘_ošt_group_mask
();

143 
¥dk_Œaû_£t_ošt_group_mask
(
ušt64_t
 
ošt_group_mask
);

145 
¥dk_Œaû_š™
(cÚ¡ *
shm_Çme
);

146 
¥dk_Œaû_ş—nup
();

148 
	#OWNER_NONE
 0

	)

149 
	#OBJECT_NONE
 0

	)

151 
¥dk_Œaû_»gi¡”_owÃr
(
ušt8_t
 
ty³
, 
id_´efix
);

152 
¥dk_Œaû_»gi¡”_objeù
(
ušt8_t
 
ty³
, 
id_´efix
);

153 
¥dk_Œaû_»gi¡”_desütiÚ
(cÚ¡ *
Çme
, cÚ¡ *
shÜt_Çme
,

154 
ušt16_t
 
ošt_id
, 
ušt8_t
 
owÃr_ty³
,

155 
ušt8_t
 
objeù_ty³
, ušt8_ˆ
Ãw_objeù
,

156 
ušt8_t
 
¬g1_is_±r
, ušt8_ˆ
¬g1_is_®Ÿs
,

157 cÚ¡ *
¬g1_Çme
);

159 
	s¥dk_Œaû_»gi¡”_â
 {

160 (*
»g_â
)();

161 
¥dk_Œaû_»gi¡”_â
 *
Ãxt
;

164 
¥dk_Œaû_add_»gi¡”_â
(
¥dk_Œaû_»gi¡”_â
 *
»g_â
);

166 
	#SPDK_TRACE_REGISTER_FN
(
â
) \

167 
	`â
(); \

168 
¥dk_Œaû_»gi¡”_â
 
»g_
 ## 
â
 = { \

169 .
»g_â
 = 
â
, \

170 .
Ãxt
 = 
NULL
, \

172 
	`__©Œibu‹__
((
cÚ¡ruùÜ
)è
_
 ## 
	`â
() \

174 
	`¥dk_Œaû_add_»gi¡”_â
(&
»g_
 ## 
â
); \

176 
	`â
()

	)

178 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/util.h

38 #iâdeà
SPDK_UTIL_H


39 
	#SPDK_UTIL_H


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
	#¥dk_mš
(
a
,
b
è((×)<(b))?×):(b))

	)

48 
	#¥dk_max
(
a
,
b
è((×)>(b))?×):(b))

	)

50 
	#SPDK_COUNTOF
(
¬r
è(×¼è/ (×¼)[0]))

	)

52 
šlše
 
ušt32_t


53 
¥dk_u32log2
(
ušt32_t
 
x
)

55 ià(
x
 == 0) {

59  31u - 
__butš_şz
(
x
);

62 
šlše
 
ušt32_t


63 
¥dk_®ign32pow2
(
ušt32_t
 
x
)

65  1u << (1 + 
¥dk_u32log2
(
x
 - 1));

68 #ifdeà
__ılu¥lus


	@PDK/core/src/api/include/udd/spdk/vhost.h

39 #iâdeà
SPDK_VHOST_H


40 
	#SPDK_VHOST_H


	)

42 
	~"¥dk/¡dšc.h
"

44 
	~"¥dk/ev’t.h
"

46 
	#SPDK_VHOST_SCSI_CTRLR_MAX_DEVS
 8

	)

51 
¥dk_vho¡_¡¬tup
(*
¬g1
, *
¬g2
);

52 
¥dk_vho¡_shutdown_cb
();

55 
	g¥dk_vho¡_scsi_ù¾r
;

62 
¥dk_vho¡_scsi_ù¾r
 *
¥dk_vho¡_scsi_ù¾r_Ãxt
(¥dk_vho¡_scsi_ù¾¸*
´ev
);

64 cÚ¡ *
¥dk_vho¡_scsi_ù¾r_g‘_Çme
(
¥dk_vho¡_scsi_ù¾r
 *
ù¾
);

65 
ušt64_t
 
¥dk_vho¡_scsi_ù¾r_g‘_ıumask
(
¥dk_vho¡_scsi_ù¾r
 *
ù¾
);

66 
¥dk_vho¡_scsi_ù¾r_cÚ¡ruù
(cÚ¡ *
Çme
, 
ušt64_t
 
ıumask
);

67 
¥dk_vho¡_·r£_cÜe_mask
(cÚ¡ *
mask
, 
ušt64_t
 *
ıumask
);

68 
¥dk_scsi_dev
 *
¥dk_vho¡_scsi_ù¾r_g‘_dev
(
¥dk_vho¡_scsi_ù¾r
 *
ù¾
,

69 
ušt8_t
 
num
);

70 
¥dk_vho¡_scsi_ù¾r_add_dev
(cÚ¡ *
Çme
, 
scsi_dev_num
, cÚ¡ *
lun_Çme
);

	@PDK/core/src/api/src/cfrontend.cpp

35 
	~"kvs_uts.h
"

36 
	~"udd’v.h
"

37 
	~"´iv©e_ty³s.h
"

38 #ifdeà
WITH_EMU


39 
	~"kvemul.hµ
"

40 #–ià
WITH_KDD


41 
	~"kvkdd.hµ
"

43 
	~"udd.hµ
"

46 
	~<m­
>

47 
	~<li¡
>

49 
	~<¡ršg
>

52 
boŞ
 
	mš™Ÿlized
 = 
çl£
;

53 
boŞ
 
	mu£_¥dk
 = 
çl£
;

54 
	mqueued•th
;

55 
	mis_pŞlšg
 = 0;

56 
	m¡d
::
m­
<
¡d
::
¡ršg
, 
	mkv_deviû_´iv
 *> 
	mli¡_deviûs
;

57 
	m¡d
::
li¡
<
kvs_deviû_hªdË
 > 
İ’_deviûs
;

58 #ià
defšed
 
WITH_SPDK


60 
ušt64_t
 
	mcq_masks
[
NR_MAX_SSD
];

61 
ušt64_t
 
	mcÜe_masks
[
NR_MAX_SSD
];

62 
ušt32_t
 
	mmem_size_mb
;

63 
	mnum_deviûs
;

64 
	msyncio
;

65 } 
	mudd_İtiÚ
;

67 
	mcÚfigfe
[256];

68 } 
	gg_’v
;

70 
	g¡d
::
m­
<, std::
¡ršg
> 
”rÜbË
;

72 
kvs_»suÉ
 
	$kvs_ex™_’v
() {

74 
¡d
::
li¡
<
kvs_deviû_hªdË
 > 
	`şÚe
(
g_’v
.
İ’_deviûs
.
	`begš
(),

75 
g_’v
.
İ’_deviûs
.
	`’d
());

78 
kvs_deviû_hªdË
 
t
 : 
şÚe
) {

79 
	`kvs_şo£_deviû
(
t
);

82  
KVS_SUCCESS
;

83 
	}
}

85 
kvs_»suÉ
 
	$kvs_š™_’v_İts
(
kvs_š™_İtiÚs
* 
İtiÚs
) {

86 
	`mem£t
((*è
İtiÚs
, 0, (
kvs_š™_İtiÚs
));

87 
İtiÚs
->
memÜy
.
u£_dpdk
 = 1;

88 
İtiÚs
->
memÜy
.
dpdk_ma¡”cÜeid
 = -1;

89 
İtiÚs
->
memÜy
.
Ä_hug•ages_³r_sock‘
 = 1024;

90 
İtiÚs
->
memÜy
.
sock‘mask
 = 0;

91  
KVS_SUCCESS
;

92 
	}
}

94 
	$kvs_li¡_kvdeviûs
(
kv_deviû_šfo
 **
devs
, 
size
) {

95 
šdex
 = 0;

96 
max
 = 
¡d
::
	`mš
((è
g_’v
.
li¡_deviûs
.
	`size
(), 
size
);

98 cÚ¡‡utØ&
t
 : 
g_’v
.
li¡_deviûs
) {

99 
kv_deviû_´iv
* 
dev_i
 = 
t
.
£cÚd
;

100 
kv_deviû_šfo
* 
dev
 = (kv_deviû_šfo*è
	`m®loc
((kv_device_info));

102 
	`¡rıy
(
dev
->
node
, 
dev_i
->node);

103 
	`¡rıy
(
dev
->
¥dk·th
, 
dev_i
->spdkpath);

104 
dev
->
nsid
 = 
dev_i
->nsid;

105 
	`¡rıy
(
dev
->
pci_¦Ù_Çme
, 
dev_i
->pci_slot_name);

106 
dev
->
numªode
 = 
dev_i
->numanode;

107 
dev
->
v’dÜid
 = 
dev_i
->vendorid;

108 
dev
->
deviûid
 = 
dev_i
->deviceid;

109 
	`¡rıy
(
dev
->
v’_dev_id
, 
dev_i
->ven_dev_id);

111 
devs
[
šdex
++] = 
dev
;

113 ià(
šdex
 =ğ
max
)

116  
šdex
;

117 
	}
}

119 #ià
defšed
 
WITH_SPDK


120 
	$š™Ÿlize_udd_İtiÚs
(
kvs_š™_İtiÚs
* 
İtiÚs
){

121 
i
 = 0;

122 
¡d
::
¡ršg
 
d–im
 = ",";

123 *
±
;

124 
±
 = 
	`¡¹ok
(
İtiÚs
->
udd
.
cÜe_mask_¡r
, ",");

125 
±
 !ğ
NULL
) {

126 
g_’v
.
udd_İtiÚ
.
cÜe_masks
[
i
++] = 
¡d
::
	`¡Ş
(
±
);

127 
±
 = 
	`¡¹ok
(
NULL
, ",");

130 
i
 = 0;

131 
±
 = 
	`¡¹ok
(
İtiÚs
->
udd
.
cq_th»ad_mask
, ",");

132 
±
 !ğ
NULL
) {

133 
g_’v
.
udd_İtiÚ
.
cq_masks
[
i
++] = 
¡d
::
	`¡Ş
(
±
);

134 
±
 = 
	`¡¹ok
(
NULL
, ",");

137 
g_’v
.
udd_İtiÚ
.
num_deviûs
 = 0;

138 
g_’v
.
udd_İtiÚ
.
mem_size_mb
 = 
İtiÚs
->
udd
.mem_size_mb;

139 
g_’v
.
udd_İtiÚ
.
syncio
 = 
İtiÚs
->
udd
.syncio;

142 
	}
}

145 
kvs_»suÉ
 
	$kvs_š™_’v
(
kvs_š™_İtiÚs
* 
İtiÚs
) {

147 ià(
g_’v
.
š™Ÿlized
)

148  
KVS_SUCCESS
;

150 ià(
İtiÚs
) {

151 
g_’v
.
queued•th
 = 
İtiÚs
->
aio
.queuedepth > 0 ? options->aio.queuedepth : 256;

152 
	`¡rıy
(
g_’v
.
cÚfigfe
, 
İtiÚs
->
emul_cÚfig_fe
);

154 ià(
İtiÚs
->
memÜy
.
u£_dpdk
 == 1) {

155 #ià
defšed
 
WITH_SPDK


156 
	`š™_udd
(
İtiÚs
);

157 
g_’v
.
u£_¥dk
 = 
Œue
;

158 
	`š™Ÿlize_udd_İtiÚs
(
İtiÚs
);

160 
	`årštf
(
¡d”r
, "SPDK driver is‚ot‡vailable\n");

161 
	`ex™
(0);

170 ià(
İtiÚs
->
memÜy
.
max_ÿchesize_mb
 > 0) {

171 
	`WRITE_WARNING
("Key-value caching is‚ot supported yet\n");

172  
KVS_ERR_OPTION_INVALID
;

190 
g_’v
.
š™Ÿlized
 = 
Œue
;

193  
KVS_SUCCESS
;

194 
	}
}

197 
kv_deviû_´iv
 *
_fšd_loÿl_deviû_äom_·th
(cÚ¡ 
¡d
::
¡ršg
 &
dev·th
,

198 
¡d
::
m­
<¡d::
¡ršg
, 
kv_deviû_´iv
 *> &
li¡_deviûs
) {

201 
kv_deviû_´iv
 *
	gdev
 = 0;

204 #ià
defšed
 
WITH_SPDK


207 
kv_deviû_´iv
 *
	gudd
 = 
Ãw
 kv_device_priv();

208 
	guddnsid
 = 0;

209 
	gudd
->
	gnsid
 = 
uddnsid
++;

210 
	gudd
->
	gi£mul
 = 
çl£
;

211 
	gudd
->
	gisk”Ãldev
 = 
çl£
;

212 
	gudd
->
	gis¥dkdev
 = 
Œue
;

213  
	gudd
;

221 cÚ¡ *
	gemuÍ©h
 = "/dev/kvemul";

222 ià(
	gdev·th
 =ğ
emuÍ©h
) {

224 
emuÊsid
 = 0;

225 
kv_deviû_´iv
 *
	gemul
 = 
Ãw
 kv_device_priv();

226 
¥rštf
(
emul
->
node
, "%s", 
dev·th
.
c_¡r
());

227 
	gemul
->
	gnsid
 = 
emuÊsid
++;

228 
	gemul
->
	gi£mul
 = 
Œue
;

229 
	gemul
->
	gisk”Ãldev
 = 
çl£
;

230  
	gemul
;

232 
kv_deviû_´iv
 *
	gkdd
 = 
Ãw
 kv_device_priv();

233 
	gkddnsid
 = 0;

234 
	gkdd
->
	gnsid
 = 
kddnsid
++;

235 
	gkdd
->
	gi£mul
 = 
çl£
;

236 
	gkdd
->
	gis¥dkdev
 = 
çl£
;

237 
	gkdd
->
	gisk”Ãldev
 = 
Œue
;

238  
	gkdd
;

241 cÚ¡‡utØ&
	gt
 : 
g_’v
.
li¡_deviûs
) {

242 ià(
dev·th
 =ğ
t
.
£cÚd
->
node
) {

243 
dev
 = 
t
.
£cÚd
;

247  
	gdev
;

250 
KvsDriv”
 *
	$_£Ëù_driv”
(
kv_deviû_´iv
 *
dev
) {

251 #ià
defšed
 
WITH_SPDK


252 ià(
dev
->
is¥dkdev
) {

253 ià(!
g_’v
.
u£_¥dk
) {

254 
	`WRITE_ERR
(

258  
Ãw
 
	`KUDDriv”
(
dev
, 0);

261 #ià
defšed
 
WITH_EMU


263  
Ãw
 
	`KvEmuÏtÜ
(
dev
, 0);

266 #–ià
defšed
 
WITH_KDD


267  
Ãw
 
	`KDDriv”
(
dev
, 0);

272  
nuÎ±r
;

273 
	}
}

275 
	$bud_”rÜ_bË
() {

276 
”rÜbË
[0x0]="KVS_SUCCESS";

277 
”rÜbË
[0x001]="KVS_ERR_BUFFER_SMALL";

278 
”rÜbË
[0x002]="KVS_ERR_COMMAND_INITIALIZED";

279 
”rÜbË
[0x003]="KVS_ERR_COMMAND_SUBMITTED ";

280 
”rÜbË
[0x004]="KVS_ERR_DEV_CAPACITY";

281 
”rÜbË
[0x005]="KVS_ERR_DEV_INIT";

282 
”rÜbË
[0x006]="KVS_ERR_DEV_INITIALIZED";

283 
”rÜbË
[0x007]="KVS_ERR_DEV_NOT_EXIST";

284 
”rÜbË
[0x008]="KVS_ERR_DEV_SANITIZE_FAILED";

285 
”rÜbË
[0x009]="KVS_ERR_DEV_SANIZE_IN_PROGRESS";

286 
”rÜbË
[0x00A]="KVS_ERR_ITERATOR_COND_INVALID";

287 
”rÜbË
[0x00B]="KVS_ERR_ITERATOR_MAX";

288 
”rÜbË
[0x00C]="KVS_ERR_ITERATOR_NOT_EXIST";

289 
”rÜbË
[0x00D]="KVS_ERR_ITERATOR_OPEN";

290 
”rÜbË
[0x00E]="KVS_ERR_KEY_EXIST";

291 
”rÜbË
[0x00F]="KVS_ERR_KEY_INVALID";

292 
”rÜbË
[0x010]="KVS_ERR_KEY_LENGTH_INVALID";

293 
”rÜbË
[0x011]="KVS_ERR_KEY_NOT_EXIST";

294 
”rÜbË
[0x012]="KVS_ERR_OPTION_INVALID";

295 
”rÜbË
[0x013]="KVS_ERR_PARAM_INVALID";

296 
”rÜbË
[0x014]="KVS_ERR_PURGE_IN_PROGRESS ";

297 
”rÜbË
[0x015]="KVS_ERR_QUEUE_CQID_INVALID";

298 
”rÜbË
[0x016]="KVS_ERR_QUEUE_DELETION_INVALID";

299 
”rÜbË
[0x017]="KVS_ERR_QUEUE_IN_SUTDOWN";

300 
”rÜbË
[0x018]="KVS_ERR_QUEUE_IS_FULL";

301 
”rÜbË
[0x019]="KVS_ERR_QUEUE_MAX_QUEUE";

302 
”rÜbË
[0x01A]="KVS_ERR_QUEUE_QID_INVALID";

303 
”rÜbË
[0x01B]="KVS_ERR_QUEUE_QSIZE_INVALID";

304 
”rÜbË
[0x01C]="KVS_ERR_QUEUE_SQID_INVALID";

305 
”rÜbË
[0x01D]="KVS_ERR_SYS_BUSY ";

306 
”rÜbË
[0x01E]="KVS_ERR_SYS_IO";

307 
”rÜbË
[0x01F]="KVS_ERR_TIMEOUT";

308 
”rÜbË
[0x020]="KVS_ERR_UNCORRECTIBLE";

309 
”rÜbË
[0x021]="KVS_ERR_VALUE_LENGTH_INVALID";

310 
”rÜbË
[0x022]="KVS_ERR_VALUE_LENGTH_MISALIGNED";

311 
”rÜbË
[0x023]="KVS_ERR_VALUE_OFFSET_INVALID";

312 
”rÜbË
[0x024]="KVS_ERR_VALUE_UPDATE_NOT_ALLOWED";

313 
”rÜbË
[0x025]="KVS_ERR_VENDOR";

314 
”rÜbË
[0x026]="KVS_ERR_PERMISSION";

315 
”rÜbË
[0x200]="KVS_ERR_CACHE_INVALID_PARAM";

316 
”rÜbË
[0x201]="KVS_ERR_CACHE_NO_CACHED_KEY";

317 
”rÜbË
[0x202]="KVS_ERR_DD_INVALID_QUEUE_TYPE";

318 
”rÜbË
[0x203]="KVS_ERR_DD_NO_AVAILABLE_RESOURCE";

319 
”rÜbË
[0x204]="KVS_ERR_DD_NO_DEVICE";

320 
”rÜbË
[0x205]="KVS_ERR_DD_UNSUPPORTED_CMD";

321 
”rÜbË
[0x206]="KVS_ERR_DECOMPRESSION";

322 
”rÜbË
[0x207]="KVS_ERR_HEAP_ALLOC_FAILURE";

323 
”rÜbË
[0x208]="KVS_ERR_ITERATE_HANDLE_ALREADY_OPENED";

324 
”rÜbË
[0x209]="KVS_ERR_ITERATE_REQUEST_FAIL";

325 
”rÜbË
[0x20A]="KVS_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED";

326 
”rÜbË
[0x20B]="KVS_ERR_MISALIGNED_KEY_SIZE";

327 
”rÜbË
[0x20C]="KVS_ERR_MISALIGNED_VALUE_OFFSET";

328 
”rÜbË
[0x20D]="KVS_ERR_SDK_CLOSE";

329 
”rÜbË
[0x20E]="KVS_ERR_SDK_INVALID_PARAM";

330 
”rÜbË
[0x20F]="KVS_ERR_SDK_OPEN";

331 
”rÜbË
[0x210]="KVS_ERR_SLAB_ALLOC_FAILURE";

332 
”rÜbË
[0x211]="KVS_ERR_UNRECOVERED_ERROR";

333 
”rÜbË
[0x300]="KVS_ERR_NS_ATTACHED";

334 
”rÜbË
[0x301]="KVS_ERR_NS_CAPACITY";

335 
”rÜbË
[0x302]="KVS_ERR_NS_DEFAULT";

336 
”rÜbË
[0x303]="KVS_ERR_NS_INVALID";

337 
”rÜbË
[0x304]="KVS_ERR_NS_MAX";

338 
”rÜbË
[0x305]="KVS_ERR_NS_NOT_ATTACHED";

339 
”rÜbË
[0x400]="KVS_ERR_CONT_CAPACITY";

340 
”rÜbË
[0x401]="KVS_ERR_CONT_CLOSE";

341 
”rÜbË
[0x402]="KVS_ERR_CONT_EXIST";

342 
”rÜbË
[0x403]="KVS_ERR_CONT_GROUP_BY";

343 
”rÜbË
[0x404]="KVS_ERR_CONT_INDEX";

344 
”rÜbË
[0x405]="KVS_ERR_CONT_NAME";

345 
”rÜbË
[0x406]="KVS_ERR_CONT_NOT_EXIST";

346 
”rÜbË
[0x407]="KVS_ERR_CONT_OPEN";

347 
	}
}

349 cÚ¡ *
	$kvs_”r¡r
(
št32_t
 
”rÜno
) {

350  
”rÜbË
[
”rÜno
].
	`c_¡r
();

351 
	}
}

353 
kvs_»suÉ
 
	$kvs_İ’_deviû
(cÚ¡ *
dev_·th
, 
kvs_deviû_hªdË
 *
dev_hd
) {

354 
»t
 = 0;

356 if(
dev_·th
 =ğ
NULL
)

358 
	`årštf
(
¡d”r
, "Please specify‡ valid device…ath\n");

359  
KVS_ERR_PARAM_INVALID
;

362 
	`bud_”rÜ_bË
();

364 ià(!
g_’v
.
š™Ÿlized
) {

365 
	`WRITE_WARNING
(

367  (
kvs_»suÉ
)
»t
;

370 
kvs_deviû_hªdË
 
u£r_dev
 = (kvs_deviû_hªdË)
	`m®loc
((
_kvs_deviû_hªdË
));

372 
kv_deviû_´iv
 *
dev
 = 
	`_fšd_loÿl_deviû_äom_·th
(
dev_·th
, 
g_’v
.
li¡_deviûs
);

373 ià(
dev
 == 0) {

374 
	`WRITE_ERR
("ÿn'ˆfšdhdeviû: %s\n", 
dev_·th
);

375  
KVS_ERR_DEV_NOT_EXIST
;

378 
dev
->
isİ’ed
 = 
Œue
;

379 
u£r_dev
->
dev
 = dev;

380 
u£r_dev
->
driv”
 = 
	`_£Ëù_driv”
(
dev
);

382 #ià
defšed
 
WITH_SPDK


383 if(
dev
->
is¥dkdev
){

384 
cu¼_dev
 = 
g_’v
.
udd_İtiÚ
.
num_deviûs
;

385 
ušt64_t
 
sq_cÜe
 = 
g_’v
.
udd_İtiÚ
.
cÜe_masks
[
cu¼_dev
];

386 
ušt64_t
 
cq_cÜe
 = 
g_’v
.
udd_İtiÚ
.
cq_masks
[
cu¼_dev
];

387 
»t
 = 
u£r_dev
->
driv”
->
	`š™
(
dev_·th
, 
g_’v
.
udd_İtiÚ
.
syncio
 , 
sq_cÜe
, 
cq_cÜe
, g_’v.udd_İtiÚ.
mem_size_mb
, g_’v.
queued•th
);

388 
g_’v
.
udd_İtiÚ
.
num_deviûs
++;

390 
	`årštf
(
¡d”r
, "WRN: Please specify spdk device…ath…roperly\n");

391 
	`ex™
(1);

394 if(
dev
->
i£mul
 || dev->
isk”Ãldev
)

395 
»t
 = 
u£r_dev
->
driv”
->
	`š™
(
dev_·th
, 
g_’v
.
cÚfigfe
, g_’v.
queued•th
, g_’v.
is_pŞlšg
);

398 
g_’v
.
İ’_deviûs
.
	`push_back
(
u£r_dev
);

400 *
dev_hd
 = 
u£r_dev
;

402  (
kvs_»suÉ
)
»t
;

403 
	}
}

405 
kvs_»suÉ
 
	$kvs_şo£_deviû
(
kvs_deviû_hªdË
 
u£r_dev
) {

406 if(!
u£r_dev
)

407  
KVS_ERR_PARAM_INVALID
;

409 autØ
t
 = 
	`fšd
(
g_’v
.
İ’_deviûs
.
	`begš
(), g_’v.İ’_deviûs.
	`’d
(), 
u£r_dev
);

410 ià(
t
 =ğ
g_’v
.
İ’_deviûs
.
	`’d
())

411  
KVS_ERR_DEV_NOT_EXIST
;

413 
d–‘e
 
u£r_dev
->
driv”
;

414 
d–‘e
 
u£r_dev
->
dev
;

415 
g_’v
.
İ’_deviûs
.
	`»move
(
u£r_dev
);

416 
	`ä“
(
u£r_dev
);

417  
KVS_SUCCESS
;

418 
	}
}

421 
kvs_»suÉ
 
	$kvs_ü—‹_cÚš”
 (
kvs_deviû_hªdË
 
dev_hd
, cÚ¡ *
Çme
, 
ušt64_t
 
size
, cÚ¡ 
kvs_cÚš”_cÚ‹xt
 *
ùx
) {

432  
KVS_SUCCESS
;

434 
	}
}

436 
kvs_»suÉ
 
	$kvs_d–‘e_cÚš”
 (
kvs_deviû_hªdË
 
dev_hd
, cÚ¡ *
cÚt_Çme
) {

449  
KVS_SUCCESS
;

450 
	}
}

452 
kvs_»suÉ
 
	$kvs_İ’_cÚš”
 (
kvs_deviû_hªdË
 
dev_hd
, cÚ¡ * 
Çme
, 
kvs_cÚš”_hªdË
 *
cÚt_hd
) {

453 
kvs_cÚš”_hªdË
 
cÚt_hªdË
 = (kvs_cÚš”_hªdË)
	`m®loc
((
_kvs_cÚš”_hªdË
));

454 
cÚt_hªdË
->
dev
 = 
dev_hd
;

455 
	`¡rıy
(
cÚt_hªdË
->
Çme
,‚ame);

457 
dev_hd
->
driv”
->
İ’_cÚš”s
.
	`push_back
(
cÚt_hªdË
);

459 *
cÚt_hd
 = 
cÚt_hªdË
;

461  
KVS_SUCCESS
;

462 
	}
}

464 
kvs_»suÉ
 
	$kvs_şo£_cÚš”
 (
kvs_cÚš”_hªdË
 
cÚt_hd
){

466 
cÚt_hd
->
dev
->
driv”
->
İ’_cÚš”s
.
	`»move
(cont_hd);

467 if(
cÚt_hd
)

468 
	`ä“
(
cÚt_hd
);

470  
KVS_SUCCESS
;

472 
	}
}

474 
kvs_»suÉ
 
	$kvs_g‘_cÚš”_šfo
 (
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_cÚš”
 *
cÚt
) {

476 
	`årštf
(
¡dout
, "WARN:‚ot implemented yet\n");

477  
KVS_SUCCESS
;

478 
	}
}

480 
kvs_»suÉ
 
	$kvs_g‘_tu¶e_šfo
 (
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
, 
kvs_tu¶e_šfo
 *
šfo
) {

482 if(
key
 =ğ
NULL
 || 
šfo
 == NULL) {

483  
KVS_ERR_PARAM_INVALID
;

486 
ušt32_t
 
vËn
 = 32;

487 *
v®ue
 = (*)
	`kvs_m®loc
(
vËn
, 4096);

489 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
;

490 
	`mem£t
(&
İtiÚ
, 0, (
kvs_»Œ›ve_İtiÚ
));

491 
İtiÚ
.
kvs_»Œ›ve_decom´ess
 = 
çl£
;

492 
İtiÚ
.
kvs_»Œ›ve_d–‘e
 = 
çl£
;

493 cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 
»t_ùx
 = {
İtiÚ
, 0, 0};

494 
kvs_v®ue
 
kvsv®ue
 = { 
v®ue
, 
vËn
 , 0, 0 };

496 
»t
 = 
	`kvs_»Œ›ve_tu¶e
(
cÚt_hd
, 
key
, &
kvsv®ue
, &
»t_ùx
);

497 if(
»t
 =ğ
KVS_ERR_BUFFER_SMALL
) {

499 
	`årštf
(
¡d”r
, "kvs_»Œ›ve_tu¶e(): KVS_ERR_BUFFER_SMALL (Key: % w™h bufãr_ËÀğ%d,‡ùu® vËÀğ%d)\n", (*è
key
->key, 
kvsv®ue
.
Ëngth
, kvsv®ue.
aùu®_v®ue_size
);

500 
»t
 = 
KVS_SUCCESS
;

503 if(
»t
 !ğ
KVS_SUCCESS
) {

504 
	`årštf
(
¡d”r
, "g‘_tu¶e_šfØçed: keyğ% ”rÜğ0x%x - %s\n", (*è
key
->key, 
»t
, 
	`kvs_”r¡r
(ret));

506 
šfo
->
key_Ëngth
 = 
key
->
Ëngth
;

507 
šfo
->
v®ue_Ëngth
 = 
kvsv®ue
.
aùu®_v®ue_size
;

508 
	`memıy
(
šfo
->
key
, key->key, key->
Ëngth
);

511 if(
v®ue
è
	`kvs_ä“
(value);

513  (
kvs_»suÉ
)
»t
;

514 
	}
}

516 
kvs_»suÉ
 
	$kvs_¡Üe_tu¶e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
,

517 cÚ¡ 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_¡Üe_cÚ‹xt
 *
ùx
) {

519 
»t
;

521 if(
key
 =ğ
NULL
 || 
v®ue
 == NULL )

522  
KVS_ERR_PARAM_INVALID
;

524 
»t
 = 
	`v®id©e_»que¡
(
key
, 
v®ue
);

525 if(
»t
)

526  (
kvs_»suÉ
)
»t
;

528 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`¡Üe_tu¶e
(0, 
key
, 
v®ue
, 
ùx
->
İtiÚ
,

529 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 1, 0);

530  (
kvs_»suÉ
)
»t
;

531 
	}
}

533 
kvs_»suÉ
 
	$kvs_¡Üe_tu¶e_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
,

534 cÚ¡ 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_¡Üe_cÚ‹xt
 *
ùx
,

535 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

536 
»t
;

537 if(
key
 =ğ
NULL
 || 
v®ue
 == NULL)

538  
KVS_ERR_PARAM_INVALID
;

540 
»t
 = 
	`v®id©e_»que¡
(
key
, 
v®ue
);

541 if(
»t
)

542  (
kvs_»suÉ
)
»t
;

544 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`¡Üe_tu¶e
(0, 
key
, 
v®ue
, 
ùx
->
İtiÚ
,

545 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 0, 
cbâ
);

546  (
kvs_»suÉ
)
»t
;

547 
	}
}

550 
kvs_»suÉ
 
	$kvs_»Œ›ve_tu¶e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
,

551 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 *
ùx
) {

553 
»t
;

554 if(
key
 =ğ
NULL
 || 
v®ue
 == NULL)

555  
KVS_ERR_PARAM_INVALID
;

556 
»t
 = 
	`v®id©e_»que¡
(
key
, 
v®ue
);

557 if(
»t
)

558  (
kvs_»suÉ
)
»t
;

560 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`»Œ›ve_tu¶e
(0, 
key
, 
v®ue
, 
ùx
->
İtiÚ
,

561 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 1, 0);

562  (
kvs_»suÉ
)
»t
;

563 
	}
}

565 
kvs_»suÉ
 
	$kvs_»Œ›ve_tu¶e_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
,

566 
kvs_v®ue
 *
v®ue
, cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 *
ùx
,

567 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

568 
»t
;

569 if(
key
 =ğ
NULL
 || 
v®ue
 == NULL)

570  
KVS_ERR_PARAM_INVALID
;

572 
»t
 = 
	`v®id©e_»que¡
(
key
, 
v®ue
);

573 if(
»t
)

574  (
kvs_»suÉ
)
»t
;

576 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`»Œ›ve_tu¶e
(0, 
key
, 
v®ue
, 
ùx
->
İtiÚ
,

577 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 0, 
cbâ
);

578  (
kvs_»suÉ
)
»t
;

579 
	}
}

582 
kvs_»suÉ
 
	$kvs_d–‘e_tu¶e
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
 *
key
,

583 cÚ¡ 
kvs_d–‘e_cÚ‹xt
 *
ùx
) {

585 
»t
;

586 if(
key
 =ğ
NULL
)

587  
KVS_ERR_PARAM_INVALID
;

588 
»t
 = 
	`v®id©e_»que¡
(
key
, 0);

589 if(
»t
)

590  (
kvs_»suÉ
)
»t
;

592 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`d–‘e_tu¶e
(0, 
key
, 
ùx
->
İtiÚ
, ctx->
´iv©e1
,

593 
ùx
->
´iv©e2
, 1, 0);

594  (
kvs_»suÉ
)
»t
;

595 
	}
}

597 
kvs_»suÉ
 
	$kvs_d–‘e_tu¶e_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_key
* 
key
,

598 cÚ¡ 
kvs_d–‘e_cÚ‹xt
* 
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

599 
»t
;

600 if(
key
 =ğ
NULL
)

601  
KVS_ERR_PARAM_INVALID
;

603 
»t
 = 
	`v®id©e_»que¡
(
key
, 0);

604 if(
»t
è (
kvs_»suÉ
)ret;

606 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`d–‘e_tu¶e
(0, 
key
, 
ùx
->
İtiÚ
, ctx->
´iv©e1
,

607 
ùx
->
´iv©e2
, 0, 
cbâ
);

608  (
kvs_»suÉ
)
»t
;

609 
	}
}

611 
kvs_»suÉ
 
	$kvs_exi¡_tu¶es
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, cÚ¡ 
kvs_exi¡_cÚ‹xt
 *
ùx
) {

612 
»t
;

613 if(
keys
 =ğ
NULL
 || 
»suÉ_bufãr
 == NULL)

614  
KVS_ERR_PARAM_INVALID
;

616 
»t
 = 
	`v®id©e_»que¡
(
keys
, 0);

617 if(
»t
è (
kvs_»suÉ
)ret;

619 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`exi¡_tu¶e
(0, 
key_út
, 
keys
, 
bufãr_size
, 
»suÉ_bufãr
, 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 1, 0);

620  (
kvs_»suÉ
)
»t
;

622 
	}
}

624 
kvs_»suÉ
 
	$kvs_exi¡_tu¶es_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, cÚ¡ 
kvs_exi¡_cÚ‹xt
 *
ùx
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

625 
»t
;

626 if(
keys
 =ğ
NULL
 || 
»suÉ_bufãr
 == NULL)

627  
KVS_ERR_PARAM_INVALID
;

628 
»t
 = 
	`v®id©e_»que¡
(
keys
, 0);

629 if(
»t
è (
kvs_»suÉ
)ret;

631 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`exi¡_tu¶e
(0, 
key_út
, 
keys
, 
bufãr_size
, 
»suÉ_bufãr
, 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 0, 
cbâ
);

633  (
kvs_»suÉ
)
»t
;

634 
	}
}

636 
kvs_»suÉ
 
	$kvs_İ’_™”©Ü
(
kvs_cÚš”_hªdË
 
cÚt_hd
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
,

637 
kvs_™”©Ü_hªdË
 *
™”_hd
) {

638 
»t
;

639 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`İ’_™”©Ü
(0, 
ùx
->
İtiÚ
, ctx->
b™mask
,

640 
ùx
->
b™_·‰”n
, 
™”_hd
);

641  (
kvs_»suÉ
)
»t
;

642 
	}
}

644 
kvs_»suÉ
 
	$kvs_şo£_™”©Ü
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_hªdË
 
h™”
,

645 cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
) {

646 
»t
;

647 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`şo£_™”©Ü
(0, 
h™”
);

648  (
kvs_»suÉ
)
»t
;

649 
	}
}

652 
kvs_»suÉ
 
	$kvs_şo£_™”©Ü_®l
(
kvs_cÚš”_hªdË
 
cÚt_hd
) {

654 
»t
;

655 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`şo£_™”©Ü_®l
(0);

656  (
kvs_»suÉ
)
»t
;

657 
	}
}

659 
kvs_»suÉ
 
	$kvs_li¡_™”©Üs
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
couÁ
) {

660 
»t
;

661 if(
kvs_™”s
 =ğ
NULL
)

662  
KVS_ERR_PARAM_INVALID
;

664 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`li¡_™”©Üs
(0, 
kvs_™”s
, 
couÁ
);

665  (
kvs_»suÉ
)
»t
;

666 
	}
}

668 
kvs_»suÉ
 
	$kvs_™”©Ü_Ãxt
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_hªdË
 
h™”
,

669 
kvs_™”©Ü_li¡
 *
™”_li¡
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
) {

671 
»t
;

672 if(
™”_li¡
 =ğ
NULL
)

673  
KVS_ERR_PARAM_INVALID
;

674 if(
™”_li¡
->
™_li¡
 =ğ
NULL
)

675  
KVS_ERR_PARAM_INVALID
;

676 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`™”©Ü_Ãxt
(
h™”
, 
™”_li¡
, 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 1, 0);

677  (
kvs_»suÉ
)
»t
;

678 
	}
}

680 
kvs_»suÉ
 
	$kvs_™”©Ü_Ãxt_async
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
kvs_™”©Ü_hªdË
 
h™”
,

681 
kvs_™”©Ü_li¡
 *
™”_li¡
, cÚ¡ 
kvs_™”©Ü_cÚ‹xt
 *
ùx
,

682 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

683 
»t
;

684 if(
™”_li¡
 =ğ
NULL
)

685  
KVS_ERR_PARAM_INVALID
;

686 if(
™”_li¡
->
™_li¡
 =ğ
NULL
)

687  
KVS_ERR_PARAM_INVALID
;

689 
»t
 = 
cÚt_hd
->
dev
->
driv”
->
	`™”©Ü_Ãxt
(
h™”
, 
™”_li¡
, 
ùx
->
´iv©e1
, ctx->
´iv©e2
, 0, 
cbâ
);

690  (
kvs_»suÉ
)
»t
;

691 
	}
}

693 
kvs_»suÉ
 
	$kvs_g‘_deviû_waf
(
kvs_deviû_hªdË
 
dev
, *
waf
) {

695 *
waf
 = 
dev
->
driv”
->
	`g‘_waf
();

697  
KVS_SUCCESS
;

698 
	}
}

700 
kvs_»suÉ
 
	$kvs_g‘_deviû_šfo
(
kvs_deviû_hªdË
 
dev_hd
, 
kvs_deviû
 *
dev_šfo
) {

702 
»t
;

704 autØ
t
 = 
	`fšd
(
g_’v
.
İ’_deviûs
.
	`begš
(), g_’v.İ’_deviûs.
	`’d
(), 
dev_hd
);

705 if(
t
 =ğ
g_’v
.
İ’_deviûs
.
	`’d
()) {

706 
»t
 = 
KVS_ERR_DEV_NOT_EXIST
;

708 
»t
 = 
dev_hd
->
driv”
->
	`g‘_tÙ®_size
(&
dev_šfo
->
ÿ·c™y
);

709 
dev_šfo
->
max_v®ue_Ën
 = 
KVS_MAX_VALUE_LENGTH
;

710 
dev_šfo
->
max_key_Ën
 = 
KVS_MAX_KEY_LENGTH
;

711 
dev_šfo
->
İtim®_v®ue_Ën
 = 
KVS_OPTIMAL_VALUE_LENGTH
;

713  (
kvs_»suÉ
)
»t
;

714 
	}
}

716 
kvs_»suÉ
 
	$kvs_g‘_deviû_utiz©iÚ
(
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
dev_ut
) {

717 
»t
;

718 autØ
t
 = 
	`fšd
(
g_’v
.
İ’_deviûs
.
	`begš
(), g_’v.İ’_deviûs.
	`’d
(), 
dev_hd
);

719 if(
t
 =ğ
g_’v
.
İ’_deviûs
.
	`’d
()) {

720 
»t
 = 
KVS_ERR_DEV_NOT_EXIST
;

722 
»t
 = 
dev_hd
->
driv”
->
	`g‘_u£d_size
(
dev_ut
);

724  (
kvs_»suÉ
)
»t
;

725 
	}
}

727 
kvs_»suÉ
 
	$kvs_g‘_deviû_ÿ·c™y
(
kvs_deviû_hªdË
 
dev_hd
, 
št64_t
 *
dev_ÿ·
) {

728 
»t
;

729 autØ
t
 = 
	`fšd
(
g_’v
.
İ’_deviûs
.
	`begš
(), g_’v.İ’_deviûs.
	`’d
(), 
dev_hd
);

730 if(
t
 =ğ
g_’v
.
İ’_deviûs
.
	`’d
()) {

731 
»t
 = 
KVS_ERR_DEV_NOT_EXIST
;

733 
»t
 = 
dev_hd
->
driv”
->
	`g‘_tÙ®_size
(
dev_ÿ·
);

734  (
kvs_»suÉ
)
»t
;

735 
	}
}

737 
kvs_»suÉ
 
	$kvs_g‘_mš_key_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
mš_key_Ëngth
){

738 *
mš_key_Ëngth
 = 
KVS_MIN_KEY_LENGTH
;

739  
KVS_SUCCESS
;

740 
	}
}

742 
kvs_»suÉ
 
	$kvs_g‘_max_key_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
max_key_Ëngth
){

743 *
max_key_Ëngth
 = 
KVS_MAX_KEY_LENGTH
;

744  
KVS_SUCCESS
;

745 
	}
}

747 
kvs_»suÉ
 
	$kvs_g‘_mš_v®ue_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
mš_v®ue_Ëngth
){

748 *
mš_v®ue_Ëngth
 = 
KVS_MIN_VALUE_LENGTH
;

749  
KVS_SUCCESS
;

750 
	}
}

752 
kvs_»suÉ
 
	$kvs_g‘_max_v®ue_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
max_v®ue_Ëngth
){

753 *
max_v®ue_Ëngth
 = 
KVS_MAX_VALUE_LENGTH
;

754  
KVS_SUCCESS
;

755 
	}
}

757 
kvs_»suÉ
 
	$kvs_g‘_İtim®_v®ue_Ëngth
 (
kvs_deviû_hªdË
 
dev_hd
, 
št32_t
 *
İt_v®ue_Ëngth
){

758 *
İt_v®ue_Ëngth
 = 
KVS_OPTIMAL_VALUE_LENGTH
;

759  
KVS_SUCCESS
;

760 
	}
}

763 *
	$_kvs_z®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
, cÚ¡ *
fe
) {

764 
	`WRITE_LOG
("kvs_z®loøsize: %ld,‡lign: %ld, from %s\n", 
size_by‹s
, 
®ignm’t
, 
fe
);

765 #ià
defšed
 
WITH_SPDK


766  (
g_’v
.
u£_¥dk
) ?

767 
	`_udd_z®loc
(
size_by‹s
, 
®ignm’t
è: 
	`m®loc
(size_bytes);

769  
	`m®loc
(
size_by‹s
);

771 
	}
}

773 *
	$_kvs_m®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
, cÚ¡ *
fe
) {

775 
	`WRITE_LOG
("kvs_m®loøsize: %ld,‡lign: %ld, from %s\n", 
size_by‹s
, 
®ignm’t
, 
fe
);

776 #ià
defšed
 
WITH_SPDK


777  (
g_’v
.
u£_¥dk
) ?

778 
	`_udd_m®loc
(
size_by‹s
, 
®ignm’t
è: 
	`m®loc
(size_bytes);

780  
	`m®loc
(
size_by‹s
);

782 
	}
}

783 
	$_kvs_ä“
(* 
buf
, cÚ¡ *
fe
) {

784 
	`WRITE_LOG
("kvs_free..\n");

785 #ià
defšed
 
WITH_SPDK


786  (
g_’v
.
u£_¥dk
è? 
	`_udd_ä“
(
buf
è: 
	`ä“
(buf);

788  
	`ä“
(
buf
);

790 
	}
}

792 
št32_t
 
	$kvs_g‘_iÛv’ts
(
kvs_cÚš”_hªdË
 
cÚt_hd
, 
maxev’ts
) {

793  
cÚt_hd
->
dev
->
driv”
->
	`´oûss_com¶‘iÚs
(
maxev’ts
);

794 
	}
}

	@PDK/core/src/api/src/driver_adapter/kvemuldriver.cpp

35 
	~<io¡»am
>

36 
	~<f¡»am
>

37 
	~"kvs_uts.h
"

38 
	~"kvemul.hµ
"

40 
	~<®gÜ™hm
>

41 
	~<©omic
>

42 
	~<tbb/cÚcu¼’t_queue.h
>

43 
	~<li¡
>

44 
	~<kvs_adi.h
>

46 
	#MAX_POOLSIZE
 10240

	)

47 
	#u£_poŞ


	)

49 
šlše
 
ä“_if_”rÜ
(
»t
, 
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
 *
ùx
, 
¡d
::
queue
<KvEmuÏtÜ::kv_emul_cÚ‹xˆ*> &
poŞ
, std::
mu‹x
& 
poŞ_lock
) {

50 ià(
»t
 != 0) {

51 #ià
defšed
 
u£_poŞ


52 
¡d
::
unique_lock
<¡d::
mu‹x
> 
lock
(
poŞ_lock
);

53 
mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

54 
	gpoŞ
.
push
(
ùx
);

56 
ä“
(
ùx
);

62 
	gKvEmuÏtÜ
::
	$KvEmuÏtÜ
(
kv_deviû_´iv
 *
dev
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
):

63 
	`KvsDriv”
(
dev
, 
u£r_io_com¶‘e_
), 
	`devH
(0),
	`nsH
(0), 
	`sqH
(0), 
	`cqH
(0), 
	$št_hªdËr
(0)

65 
queued•th
 = 256;

66 
	}
}

69 
	$š‹¼u±_func_emu
(*
d©a
, 
numb”
) {

70 (è
d©a
;

71 (è
numb”
;

74 
	}
}

76 
	$Ú_io_com¶‘e
(
kv_io_cÚ‹xt
 *
cÚ‹xt
){

78 if((
cÚ‹xt
->
»tcode
 !ğ
KV_SUCCESS
è&& (cÚ‹xt->»tcod!ğ
KV_ERR_KEY_NOT_EXIST
)

79 && 
cÚ‹xt
->
»tcode
 !ğ
KV_WRN_MORE
 ) {

80 cÚ¡ *
cmd
 = (
cÚ‹xt
->
İcode
 =ğ
KV_OPC_GET
)? "GET": ((cÚ‹xt->İcod=ğ
KV_OPC_STORE
)? "PUT": (cÚ‹xt->İcod=ğ
KV_OPC_DELETE
)? "DEL":"OTHER");

81 
	`årštf
(
¡d”r
, "% çed w™hƒ¼Ü 0x%x\n", 
cmd
, 
cÚ‹xt
->
»tcode
);

86 
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
 *
ùx
 = (KvEmuÏtÜ::kv_emul_cÚ‹xt*)
cÚ‹xt
->
´iv©e_d©a
;

87 
kvs_ÿÎback_cÚ‹xt
 *
iocb
 = &
ùx
->iocb;

88 cÚ¡‡utØ
owÃr
 = 
ùx
->owner;

90 
iocb
->
»suÉ
 = (
kvs_»suÉ
)
cÚ‹xt
->
»tcode
;

92 if(
cÚ‹xt
->
İcode
 =ğ
KV_OPC_GET
)

93 
iocb
->
v®ue
->
aùu®_v®ue_size
 = 
cÚ‹xt
->value->actual_value_size;

95 if(
ùx
->
syncio
) {

96 if(
cÚ‹xt
->
İcode
 =ğ
KV_OPC_OPEN_ITERATOR
) {

99 
kvs_™”©Ü_hªdË
 *
™”h
 = (kvs_™”©Ü_hªdË*)
iocb
->
´iv©e1
;

100 *
™”h
 = 
cÚ‹xt
->
»suÉ
.
h™”
;

102 if(
owÃr
->
št_hªdËr
 != 0) {

103 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

104 
ùx
->
dÚe_sync
 = 1;

105 
ùx
->
dÚe_cÚd_sync
.
	`nÙify_Úe
();

106 
lock_s
.
	`uÆock
();

109 if(
cÚ‹xt
->
İcode
 !ğ
KV_OPC_OPEN_ITERATOR
 && cÚ‹xt->İcod!ğ
KV_OPC_CLOSE_ITERATOR
) {

110 if(
ùx
->
Ú_com¶‘e
 && 
iocb
){

111 
ùx
->
	`Ú_com¶‘e
(
iocb
);

115 #ià
defšed
 
u£_poŞ


116 if(!
ùx
->
syncio
) {

117 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
owÃr
->
lock
);

118 if(
ùx
->
key
) {

119 
owÃr
->
kv_key_poŞ
.
	`push
(
ùx
->
key
);

121 if(
ùx
->
v®ue
) {

122 
owÃr
->
kv_v®ue_poŞ
.
	`push
(
ùx
->
v®ue
);

125 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

126 
owÃr
->
kv_ùx_poŞ
.
	`push
(
ùx
);

127 
lock
.
	`uÆock
();

130 if(!
ùx
->
syncio
) {

131 
	`ä“
(
ùx
);

132 
ùx
 = 
NULL
;

136 
	}
}

138 
	gKvEmuÏtÜ
::
	$ü—‹_queue
(
qd•th
, 
ušt16_t
 
qty³
, 
kv_queue_hªdË
 *
hªdË
, 
cqid
, 
is_pŞlšg
){

139 
qid
 = -1;

140 
kv_queue
 
qšfo
;

141 
qšfo
.
queue_id
 = ++
qid
;

142 
qšfo
.
queue_size
 = 
qd•th
;

143 
qšfo
.
com¶‘iÚ_queue_id
 = 
cqid
;

144 
qšfo
.
queue_ty³
 = 
qty³
;

145 
qšfo
.
ex‹nded_šfo
 = 
NULL
;

146 
kv_»suÉ
 
»t
 = 
	`kv_ü—‹_queue
(
this
->
devH
, &
qšfo
, 
hªdË
);

147 ià(
»t
 !ğ
KV_SUCCESS
è{
	`årštf
(
¡d”r
, "kv_create_queue failed 0x%x\n",„et);}

149 if(
qty³
 =ğ
COMPLETION_Q_TYPE
 && 
is_pŞlšg
 == 0) {

152 
kv_š‹¼u±_hªdËr
 
št_func
 = (kv_š‹¼u±_hªdËr)
	`m®loc
((
_kv_š‹¼u±_hªdËr
));

153 
št_func
->
hªdËr
 = 
š‹¼u±_func_emu
;

154 
št_func
->
´iv©e_d©a
 = 0;

155 
št_func
->
numb”
 = 0;

156 
this
->
št_hªdËr
 = 
št_func
;

158 
	`kv_£t_š‹¼u±_hªdËr
(*
hªdË
, 
št_func
);

161  
qid
;

162 
	}
}

164 
št32_t
 
	gKvEmuÏtÜ
::
	$š™
(cÚ¡ * 
dev·th
, cÚ¡ * 
cÚfigfe
, 
queued•th
, 
is_pŞlšg
) {

166 #iâdeà
WITH_EMU


167 
	`årštf
(
¡d”r
, "Emulator is‚ot supported. \nPlease set compilation option…roperly (-DWITH_EMU=ON)\n");

168 
	`ex™
(1);

171 
i
 = 0; i < 
MAX_POOLSIZE
; i++) {

172 
this
->
kv_key_poŞ
.
	`push
(
Ãw
 
	`kv_key
());

173 
this
->
kv_v®ue_poŞ
.
	`push
(
Ãw
 
	`kv_v®ue
());

174 
this
->
kv_ùx_poŞ
.
	`push
(
Ãw
 
	`kv_emul_cÚ‹xt
());

177 
kv_»suÉ
 
»t
;

179 
kv_deviû_š™_t
 
dev_š™
;

180 
dev_š™
.
dev·th
 = devpath;

181 
dev_š™
.
Ãed_³rsi¡’cy
 = 
FALSE
;

182 
dev_š™
.
cÚfigfe
 = configfile;

183 
dev_š™
.
is_pŞlšg
 = (is_pŞlšg =ğ1 ? 
TRUE
 : 
FALSE
);

185 
»t
 = 
	`kv_š™Ÿlize_deviû
(&
dev_š™
, &
this
->
devH
);

186 ià(
»t
 !ğ
KV_SUCCESS
è{ 
	`årštf
(
¡d”r
, "kv_initialize_device failed 0x%x\n",„et); „et;}

188 
»t
 = 
	`g‘_Çme¥aû_deçuÉ
(
this
->
devH
, &this->
nsH
);

189 ià(
»t
 !ğ
KV_SUCCESS
è{ 
	`årštf
(
¡d”r
, "get_namespace_default failed 0x%x\n",„et); „et;}

191 
this
->
queued•th
 = queuedepth;

192 
cqid
 = 
	`ü—‹_queue
(
this
->
queued•th
, 
COMPLETION_Q_TYPE
, &this->
cqH
, 0, 
is_pŞlšg
);

193 
	`ü—‹_queue
(
this
->
queued•th
, 
SUBMISSION_Q_TYPE
, &this->
sqH
, 
cqid
, 
is_pŞlšg
);

195  
»t
;

196 
	}
}

198 
	gKvEmuÏtÜ
::
kv_emul_cÚ‹xt
* 
KvEmuÏtÜ
::
	$´•_io_cÚ‹xt
(
İcode
, 
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
){

200 #ià
defšed
 
u£_poŞ


201 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

202 
kv_emul_cÚ‹xt
 *
ùx
 = 
this
->
kv_ùx_poŞ
.
	`äÚt
();

203 
this
->
kv_ùx_poŞ
.
	`pİ
();

204 
lock
.
	`uÆock
();

206 
kv_emul_cÚ‹xt
 *
ùx
 = (kv_emul_cÚ‹xˆ*)
	`ÿÎoc
(1, (kv_emul_context));

211 
ùx
->
Ú_com¶‘e
 = 
cbâ
;

212 
ùx
->
iocb
.
İcode
 = opcode;

214 if(
key
) {

215 
ùx
->
iocb
.
key
 = (
kvs_key
*)key;

217 
ùx
->
iocb
.
key
 = 0;

220 if(
v®ue
) {

221 
ùx
->
iocb
.
v®ue
 = (
kvs_v®ue
*)value;

223 
ùx
->
iocb
.
v®ue
 = 0;

226 
ùx
->
iocb
.
´iv©e1
 =…rivate1;

227 
ùx
->
iocb
.
´iv©e2
 =…rivate2;

228 
ùx
->
owÃr
 = 
this
;

231 
ùx
->
syncio
 = syncio;

232 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

233 
ùx
->
dÚe_sync
 = 0;

234  
ùx
;

235 
	}
}

238 
št32_t
 
	gKvEmuÏtÜ
::
	$¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

240 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_PUT_CMD
, 
cÚtid
, 
key
, 
v®ue
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

241 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

243 
kv_¡Üe_İtiÚ
 
İtiÚ_adi
;

244 if(!
İtiÚ
.
kvs_¡Üe_com´ess
) {

246 
İtiÚ
.
¡_ty³
) {

247 
KVS_STORE_POST
:

248 
İtiÚ_adi
 = 
KV_STORE_OPT_DEFAULT
;

250 
KVS_STORE_UPDATE_ONLY
:

251 
İtiÚ_adi
 = 
KV_STORE_OPT_UPDATE_ONLY
;

253 
KVS_STORE_NOOVERWRITE
:

254 
İtiÚ_adi
 = 
KV_STORE_OPT_IDEMPOTENT
;

256 
KVS_STORE_APPEND
:

257 
İtiÚ_adi
 = 
KV_STORE_OPT_APPEND
;

260 
	`årštf
(
¡d”r
, "WARN: Wrong store option\n");

261  
KVS_ERR_OPTION_INVALID
;

265 
İtiÚ
.
¡_ty³
) {

266 
KVS_STORE_POST
:

267 
İtiÚ_adi
 = 
KV_STORE_OPT_POST_WITH_COMPRESS
;

269 
KVS_STORE_UPDATE_ONLY
:

270 
İtiÚ_adi
 = 
KV_STORE_OPT_UPDATE_ONLY_COMPRESS
;

272 
KVS_STORE_NOOVERWRITE
:

273 
İtiÚ_adi
 = 
KV_STORE_OPT_NOOVERWRITE_COMPRESS
;

275 
KVS_STORE_APPEND
:

276 
İtiÚ_adi
 = 
KV_STORE_OPT_APPEND_COMPRESS
;

279 
	`årštf
(
¡d”r
, "WARN: Wrong store option\n");

280  
KVS_ERR_OPTION_INVALID
;

284 #ià
defšed
 
u£_poŞ


285 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

286 
kv_key
 *
key_adi
 = 
this
->
kv_key_poŞ
.
	`äÚt
();

287 
this
->
kv_key_poŞ
.
	`pİ
();

288 
kv_v®ue
 *
v®ue_adi
 = 
this
->
kv_v®ue_poŞ
.
	`äÚt
();

289 
this
->
kv_v®ue_poŞ
.
	`pİ
();

290 
lock
.
	`uÆock
();

292 
ùx
->
key
 = 
key_adi
;

293 
ùx
->
v®ue
 = 
v®ue_adi
;

295 
key_adi
->
key
 = key->key;

296 
key_adi
->
Ëngth
 = (
kv_key_t
)
key
->length;

297 
v®ue_adi
->
v®ue
 = value->value;

298 
v®ue_adi
->
Ëngth
 = (
kv_v®ue_t
)
v®ue
->length;

299 
v®ue_adi
->
off£t
 = 0;

301 
»t
 = 
	`kv_¡Üe
(
this
->
sqH
,his->
nsH
, 
key_adi
, 
v®ue_adi
, 
İtiÚ_adi
, &
f
);

303 
ùx
->
key
 = (
kv_key
*)key;

304 
ùx
->
v®ue
 = (
kv_v®ue
*)value;

306 
»t
 = 
	`kv_¡Üe
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, (
kv_v®ue
*)
v®ue
, 
İtiÚ_adi
, &
f
);

309 if(
syncio
 && 
»t
 == 0) {

310 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

311 
ùx
->
dÚe_sync
 == 0)

312 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

313 
lock_s
.
	`uÆock
();

314 ià(
syncio
 )
»t
 = 
ùx
->
iocb
.
»suÉ
;

316 #ià
defšed
 
u£_poŞ


323 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

324 
this
->
kv_key_poŞ
.
	`push
(
key_adi
);

325 
this
->
kv_v®ue_poŞ
.
	`push
(
v®ue_adi
);

326 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

327 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

332 
	`ä“
(
ùx
);

333 
ùx
 = 
NULL
;

338 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);;

340  
»t
;

341 
	}
}

344 
št32_t
 
	gKvEmuÏtÜ
::
	$»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
 , *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

346 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_GET_CMD
, 
cÚtid
, 
key
, 
v®ue
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

347 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

349 
kv_»Œ›ve_İtiÚ
 
İtiÚ_adi
;

350 if(!
İtiÚ
.
kvs_»Œ›ve_d–‘e
) {

351 if(!
İtiÚ
.
kvs_»Œ›ve_decom´ess
)

352 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DEFAULT
;

354 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DECOMPRESS
;

356 if(!
İtiÚ
.
kvs_»Œ›ve_decom´ess
)

357 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DELETE
;

359 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DECOMPRESS_DELETE
;

362 #ià
defšed
 
u£_poŞ


363 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

364 
kv_key
 *
key_adi
 = 
this
->
kv_key_poŞ
.
	`äÚt
();

365 
this
->
kv_key_poŞ
.
	`pİ
();

366 
kv_v®ue
 *
v®ue_adi
 = 
this
->
kv_v®ue_poŞ
.
	`äÚt
();

367 
this
->
kv_v®ue_poŞ
.
	`pİ
();

368 
lock
.
	`uÆock
();

370 
ùx
->
key
 = 
key_adi
;

371 
ùx
->
v®ue
 = 
v®ue_adi
;

373 
key_adi
->
key
 = key->key;

374 
key_adi
->
Ëngth
 = 
key
->length;

375 
v®ue_adi
->
v®ue
 = value->value;

376 
v®ue_adi
->
Ëngth
 = (
kv_v®ue_t
)
v®ue
->length;

377 
v®ue_adi
->
off£t
 = 0;

379 
»t
 = 
	`kv_»Œ›ve
(
this
->
sqH
,his->
nsH
, 
key_adi
, 
İtiÚ_adi
, 
v®ue_adi
, &
f
);

381 
ùx
->
key
 = (
kv_key
*)key;

382 
ùx
->
v®ue
 = (
kv_v®ue
*)value;

383 
»t
 = 
	`kv_»Œ›ve
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, 
İtiÚ_adi
, (
kv_v®ue
*)
v®ue
, &
f
);

386 if(
syncio
 && 
»t
 == 0) {

387 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

388 
ùx
->
dÚe_sync
 == 0)

389 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

390 
lock_s
.
	`uÆock
();

391 ià(
syncio
) {

392 
»t
 = 
ùx
->
iocb
.
»suÉ
;

393 
v®ue
->
aùu®_v®ue_size
 = 
ùx
->
iocb
.value->actual_value_size;

396 #ià
defšed
 
u£_poŞ


404 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

405 
this
->
kv_key_poŞ
.
	`push
(
key_adi
);

406 
this
->
kv_v®ue_poŞ
.
	`push
(
v®ue_adi
);

407 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

408 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

413 
	`ä“
(
ùx
);

414 
ùx
 = 
NULL
;

417 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);

418  
»t
;

419 
	}
}

421 
št32_t
 
	gKvEmuÏtÜ
::
	$d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
 , *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

422 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_DEL_CMD
, 
cÚtid
, 
key
, 
NULL
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

423 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

425 
kv_d–‘e_İtiÚ
 
İtiÚ_adi
;

426 if(!
İtiÚ
.
kvs_d–‘e_”rÜ
)

427 
İtiÚ_adi
 = 
KV_DELETE_OPT_DEFAULT
;

429 
İtiÚ_adi
 = 
KV_DELETE_OPT_ERROR
;

431 #ià
defšed
 
u£_poŞ


432 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

433 
kv_key
 *
key_adi
 = 
this
->
kv_key_poŞ
.
	`äÚt
();

434 
this
->
kv_key_poŞ
.
	`pİ
();

435 
lock
.
	`uÆock
();

436 
ùx
->
key
 = 
key_adi
;

437 
ùx
->
v®ue
 = 
NULL
;

439 
key_adi
->
key
 = key->key;

440 
key_adi
->
Ëngth
 = 
key
->length;

442 
»t
 = 
	`kv_d–‘e
(
this
->
sqH
,his->
nsH
, 
key_adi
, 
İtiÚ_adi
, &
f
);

444 
ùx
->
key
 = (
kv_key
*)key;

445 
ùx
->
v®ue
 = 
NULL
;

446 
»t
 = 
	`kv_d–‘e
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, 
İtiÚ_adi
, &
f
);

449 if(
syncio
 && 
»t
 == 0) {

450 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

451 
ùx
->
dÚe_sync
 == 0)

452 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

453 
lock_s
.
	`uÆock
();

454 ià(
syncio
 )
»t
 = 
ùx
->
iocb
.
»suÉ
;

456 #ià
defšed
 
u£_poŞ


463 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

464 
this
->
kv_key_poŞ
.
	`push
(
key_adi
);

465 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

466 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

470 
	`ä“
(
ùx
);

471 
ùx
 = 
NULL
;

475 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);;

476  
»t
;

477 
	}
}

479 
št32_t
 
	gKvEmuÏtÜ
::
	$exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

481 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
, 
cÚtid
, 
keys
, 
NULL
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

482 
ùx
->
iocb
.
key_út
 = key_cnt;

483 
ùx
->
iocb
.
»suÉ_bufãr
 =„esult_buffer;

484 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

487 
ùx
->
key
 = 
NULL
;

488 
ùx
->
v®ue
 = 
NULL
;

490 
»t
 = 
	`kv_exi¡
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
keys
, 
key_út
, 
bufãr_size
, 
»suÉ_bufãr
, &
f
);

492 if(
syncio
 && 
»t
 == 0) {

493 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

494 
ùx
->
dÚe_sync
 == 0)

495 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

496 
lock_s
.
	`uÆock
();

497 ià(
syncio
 )
»t
 = 
ùx
->
iocb
.
»suÉ
;

499 #ià
defšed
 
u£_poŞ


500 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

501 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

502 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

504 
	`ä“
(
ùx
);

505 
ùx
 = 
NULL
;

508 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);;

510 
	}
}

512 
št32_t
 
	gKvEmuÏtÜ
::
	$İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
, 
ušt32_t
 
b™mask
,

513 
ušt32_t
 
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
) {

515 
»t
 = 0;

518 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_ITER_OPEN_CMD
, 0, 0, 0, (*)
™”_hd
, 0 , 
TRUE
, 0);

519 
kv_group_cÚd™iÚ
 
g½_cÚd
 = {
b™mask
, 
b™_·‰”n
};

520 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

522 
kv_™”©Ü_İtiÚ
 
İtiÚ_adi
;

524 if(
İtiÚ
.
™”_ty³
 =ğ
KVS_ITERATOR_KEY
) {

525 
İtiÚ_adi
 = 
KV_ITERATOR_OPT_KEY
;

527 
İtiÚ_adi
 = 
KV_ITERATOR_OPT_KV
;

529 
»t
 = 
	`kv_İ’_™”©Ü
(
this
->
sqH
,his->
nsH
, 
İtiÚ_adi
, &
g½_cÚd
, &
f
);

531 if(
»t
 !ğ
KV_SUCCESS
) {

532 
	`årštf
(
¡d”r
, "kv_İ’_™”©Ü faed w™hƒ¼Ü: 0x%X\n", 
»t
);

533  
»t
;

536 if(!
this
->
št_hªdËr
) {

537 
ušt32_t
 
´oûs£d
 = 0;

539 
»t
 = 
	`kv_pŞl_com¶‘iÚ
(
this
->
cqH
, 0, &
´oûs£d
);

540 } 
´oûs£d
 == 0);

542 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

543 
ùx
->
dÚe_sync
 == 0)

544 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

545 
lock_s
.
	`uÆock
();

548 
»t
 = 
ùx
->
iocb
.
»suÉ
;

550 #ià
defšed
 
u£_poŞ


552 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

553 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

554 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

555 
lock
.
	`uÆock
();

560 
	`ä“
(
ùx
);

561 
ùx
 = 
NULL
;

564 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);;

566  
»t
;

567 
	}
}

569 
št32_t
 
	gKvEmuÏtÜ
::
	$şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
) {

571 
»t
 = 0;

572 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_ITER_CLOSE_CMD
, 0, 0, 0, 0,0 , 
TRUE
, 0);

574 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

576 
»t
 = 
	`kv_şo£_™”©Ü
(
this
->
sqH
,his->
nsH
, 
h™”
 , &
f
);

577 if(
»t
 !ğ
KV_SUCCESS
) {

578 
	`årštf
(
¡d”r
, "kv_İ’_™”©Ü faed w™hƒ¼Ü: 0x%X\n", 
»t
);

579 
	`ex™
(1);

582 if(!
this
->
št_hªdËr
) {

583 
ušt32_t
 
´oûs£d
 = 0;

585 
»t
 = 
	`kv_pŞl_com¶‘iÚ
(
this
->
cqH
, 0, &
´oûs£d
);

586 } 
´oûs£d
 == 0);

588 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

589 
ùx
->
dÚe_sync
 == 0)

590 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

591 
lock_s
.
	`uÆock
();

596 #ià
defšed
 
u£_poŞ


598 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

599 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

600 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

601 
lock
.
	`uÆock
();

606 
	`ä“
(
ùx
);

607 
ùx
 = 
NULL
;

609 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);;

612 
	}
}

615 
št32_t
 
	gKvEmuÏtÜ
::
	$şo£_™”©Ü_®l
(
cÚtid
) {

617 
	`årštf
(
¡d”r
, "WARN:his feature is‚ot supported inheƒmulator\n");

618  
KVS_ERR_OPTION_INVALID
;

619 
	}
}

622 
št32_t
 
	gKvEmuÏtÜ
::
	$li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
) {

628 
kv_»suÉ
 
»s
 = 
	`kv_li¡_™”©Üs
(
sqH
, 
nsH
, (
kv_™”©Ü
 *)
kvs_™”s
, &
couÁ
, 
NULL
 );

630 
ušt32_t
 
i
 = 0; i< 
couÁ
; i++){

631 if(
kvs_™”s
[
i
].
¡©us
 =ğ1è
	`årštf
(
¡dout
, "found handler %d %x %x\n",

632 
kvs_™”s
[
i
].
™”_hªdË
, kvs_™”s[i].
b™_·‰”n
, kvs_™”s[i].
b™mask
);

637  
»s
;

638 
	}
}

640 
št32_t
 
	gKvEmuÏtÜ
::
	$™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

642 
»t
 = 0;

643 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_ITER_NEXT_CMD
, 0, 0, 0, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

644 
kv_po¡´oûss_funùiÚ
 
f
 = {
Ú_io_com¶‘e
, (*)
ùx
};

646 
»t
 = 
	`kv_™”©Ü_Ãxt
(
this
->
sqH
,his->
nsH
, 
h™”
 , (
kv_™”©Ü_li¡
 *)
™”_li¡
, &
f
);

647 if(
»t
 !ğ
KV_SUCCESS
) {

648 
	`årštf
(
¡d”r
, "kv_™”©Ü_Ãxˆçed w™hƒ¼Ü: 0x%X\n", 
»t
);

649  
»t
;

652 if(
syncio
) {

653 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock_s
(
ùx
->
lock_sync
);

654 
ùx
->
dÚe_sync
 == 0)

655 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock_s
);

656 
lock_s
.
	`uÆock
();

657 
»t
 = 
ùx
->
iocb
.
»suÉ
;

659 #ià
defšed
 
u£_poŞ


661 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
ùx
->
lock_sync
);

662 
	`mem£t
(
ùx
, 0, (
KvEmuÏtÜ
::
kv_emul_cÚ‹xt
));

663 
this
->
kv_ùx_poŞ
.
	`push
(
ùx
);

664 
lock
.
	`uÆock
();

669 
	`ä“
(
ùx
);

670 
ùx
 = 
NULL
;

673 
	`ä“_if_”rÜ
(
»t
, 
ùx
, 
this
->
kv_ùx_poŞ
,his->
lock
);;

674  
»t
;

675 
	}
}

677 
	gKvEmuÏtÜ
::
	$g‘_waf
(){

678 
	`WRITE_WARNING
("Emulator: get waf is‚ot supported inƒmulator\n");

680 
	}
}

682 
št32_t
 
	gKvEmuÏtÜ
::
	$g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
) {

684 
	}
}

686 
št32_t
 
	gKvEmuÏtÜ
::
	$g‘_u£d_size
(
št32_t
 *
dev_ut
){

688 
»t
 = 0;

689 
kv_deviû_¡©
 *
¡©
 = (kv_deviû_¡©*)
	`m®loc
((kv_device_stat));

690 
»t
 = 
	`kv_g‘_deviû_¡©
(
devH
, 
¡©
);

691 ià(
»t
) {

692 
	`årštf
(
¡dout
, "Thho¡ faedØcommuniÿ‹ w™hhdeivû: 0x%x", 
»t
);

693 if(
¡©
è
	`ä“
(stat);

694 
	`ex™
(1);

697 *
dev_ut
 = 
¡©
->
utiz©iÚ
;

698 if(
¡©
è
	`ä“
(stat);

700  
»t
;

701 
	}
}

703 
št32_t
 
	gKvEmuÏtÜ
::
	$g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
){

704 
»t
 = 0;

705 
kv_deviû
 *
devšfo
 = (kv_deviû *)
	`m®loc
((kv_device));

706 
»t
 = 
	`kv_g‘_deviû_šfo
(
devH
, 
devšfo
);

708 ià(
»t
) {

709 
	`årštf
(
¡dout
, "Thho¡ faedØcommuniÿ‹ w™hhdeivû: 0x%x", 
»t
);

710 if(
devšfo
è
	`ä“
(devinfo);

711 
	`ex™
(1);

714 *
dev_ÿ·
 = 
devšfo
->
ÿ·c™y
;

715 if(
devšfo
è
	`ä“
(devinfo);

717  
»t
;

718 
	}
}

720 
št32_t
 
	gKvEmuÏtÜ
::
	$´oûss_com¶‘iÚs
(
max
)

722 
»t
;

723 
ušt32_t
 
´oûs£d
 = 0;

725 
»t
 = 
	`kv_pŞl_com¶‘iÚ
(
this
->
cqH
, 0, &
´oûs£d
);

726 ià(
»t
 !ğ
KV_SUCCESS
 &&„‘ !ğ
KV_WRN_MORE
)

727 
	`årštf
(
¡dout
, "Polling failed\n");

729  
´oûs£d
;

730 
	}
}

733 
	gKvEmuÏtÜ
::~
	$KvEmuÏtÜ
() {

735 !
this
->
kv_key_poŞ
.
	`em±y
()) {

736 autØ
p
 = 
this
->
kv_key_poŞ
.
	`äÚt
();

737 
this
->
kv_key_poŞ
.
	`pİ
();

738 
d–‘e
 
p
;

741 !
this
->
kv_v®ue_poŞ
.
	`em±y
()) {

742 autØ
p
 = 
this
->
kv_v®ue_poŞ
.
	`äÚt
();

743 
this
->
kv_v®ue_poŞ
.
	`pİ
();

744 
d–‘e
 
p
;

747 !
this
->
kv_ùx_poŞ
.
	`em±y
()) {

748 autØ
p
 = 
this
->
kv_ùx_poŞ
.
	`äÚt
();

749 
this
->
kv_ùx_poŞ
.
	`pİ
();

750 
d–‘e
 
p
;

754 if(
this
->
št_hªdËr
) {

755 
	`ä“
(
št_hªdËr
);

763 ià(
	`kv_d–‘e_queue
(
this
->
devH
,his->
sqH
è!ğ
KV_SUCCESS
) {

764 
	`årštf
(
¡d”r
, "kv delete submission queue failed\n");

765 
	`ex™
(1);

768 ià(
	`kv_d–‘e_queue
(
this
->
devH
,his->
cqH
è!ğ
KV_SUCCESS
) {

769 
	`årštf
(
¡d”r
, "kv delete completion queue failed\n");

770 
	`ex™
(1);

773 
	`kv_d–‘e_Çme¥aû
(
devH
, 
nsH
);

774 
	`kv_ş—nup_deviû
(
devH
);

776 
	}
}

	@PDK/core/src/api/src/driver_adapter/kvkdd.cpp

35 
	~<io¡»am
>

36 
	~<f¡»am
>

38 
	~"kvs_uts.h
"

39 
	~"kvkdd.hµ
"

40 
	~<®gÜ™hm
>

41 
	~<©omic
>

42 
	~<tbb/cÚcu¼’t_queue.h
>

43 
	~<li¡
>

44 
	~<kvs_adi.h
>

45 
	~<kvs_adi_š‹º®.h
>

46 
	~<kadi.h
>

48 #ifdeà
KVKDD_DEBUG


49 şas 
	cKvsRWLogg”
 {

50 
	mpublic
:

52 
FILE
 *
å
;

53 
	m¡d
::
mu‹x
 
m
;

56 
	$KvsRWLogg”
() {

57 
å
 = 
	`fİ’
( "/tmp/kvkdd.txt", "w" );

60 ~
	$KvsRWLogg”
() {

61 
	`fşo£
(
å
);

62 
	}
}

65 
	$DJBHash
(cÚ¡ * 
¡r
, 
Ëngth
)

67 
hash
 = 5381;

68 
i
 = 0;

70 
i
 = 0; i < 
Ëngth
; ++
¡r
, ++i)

72 
hash
 = ((hash << 5è+ hashè+ (*
¡r
);

75  
hash
;

76 
	}
}

78 
	$´št_key
(*
key
, 
keyËngth
) {

79 cÚ¡ * 
š
 = (cÚ¡ *)
key
;

80 
	`årštf
(
å
, "key (%d by‹s)ğ '", 
keyËngth
);

81 
i
 =0; i < 
keyËngth
; i++) {

82 
	`årštf
(
å
, "%02x", ()()
š
[
i
]);

84 
	`årštf
(
å
, "'");

85 
	}
}

86 
´št_v®ue
(*
v®ue
, 
Ëngth
, 
aùu®size
 = -1) {

87 
h
 = 
DJBHash
((cÚ¡ *)
v®ue
, 
Ëngth
);

89 
årštf
(
å
, "hashed v®ue='%u', v®uËngth = %d", 
h
, 
Ëngth
);

90 ià(
	gaùu®size
 != -1)

91 
årštf
(
å
, ",‡ùu®†’gth = %d", 
aùu®size
);

94 
	$log_wr™e
(*
key
, 
keyËngth
, *
v®ue
, 
Ëngth
, 
»tcode
) {

95 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
m
);

96 
	`årštf
(
å
, "write: ");

97 
	`´št_key
(
key
, 
keyËngth
);

98 
	`´št_v®ue
(
v®ue
, 
Ëngth
);

99 
	`årštf
(
å
, "-> %d\n", 
»tcode
);

100 
	}
}

102 
	$log_»ad
(*
key
, 
keyËngth
, *
v®ue
, 
Ëngth
, 
aùu®size
, 
»tcode
) {

103 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
m
);

104 
	`årštf
(
å
, "read: ");

105 
	`´št_key
(
key
, 
keyËngth
);

106 
	`´št_v®ue
(
v®ue
,
Ëngth
, 
aùu®size
);

107 
	`årštf
(
å
, "-> %d\n", 
»tcode
);

108 
	}
}

111 
KvsRWLogg”
 
	gkvkdd_logg”
;

115 
šlše
 
	$ä“_if_”rÜ
(
»t
, 
KDDriv”
::
kv_kdd_cÚ‹xt
 *
ùx
) {

116 ià(
»t
 !ğ0 && 
ùx
) {

117 
d–‘e
 
ùx
;

119 
	}
}

121 
	gKDDriv”
::
	$KDDriv”
(
kv_deviû_´iv
 *
dev
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
):

122 
	`KvsDriv”
(
dev
, 
u£r_io_com¶‘e_
), 
	`devH
(0),
	`nsH
(0), 
	`sqH
(0), 
	`cqH
(0), 
	$št_hªdËr
(0)

124 
queued•th
 = 256;

125 
	}
}

127 
	$»fÜm©_™”bufãr
(
kvs_™”©Ü_li¡
 *
™”_li¡
)

129 cÚ¡ 
KEY_LEN_BYTES
 = 4;

130 
»t
 = 0;

131 
key_size
 = 0;

132 
keyd©a_Ën_w™h_·ddšg
 = 0;

133 *
d©a_buff
 = (*)
™”_li¡
->
™_li¡
;

134 
bufãr_size
 = 
™”_li¡
->
size
;

135 
key_couÁ
 = 
™”_li¡
->
num_’Œ›s
;

141 *
cu¼’t_±r
 = 
d©a_buff
;

142 
buffd©a_Ën
 = 
bufãr_size
;

144 ià(
cu¼’t_±r
 =ğ0è 
KV_ERR_PARAM_INVALID
;

146 ià(
buffd©a_Ën
 < 
KEY_LEN_BYTES
è{  
KV_ERR_SYS_IO
; }

148 
buffd©a_Ën
 -ğ
KEY_LEN_BYTES
;

149 
d©a_buff
 +ğ
KEY_LEN_BYTES
;

150 
ušt32_t
 
i
 = 0; i < 
key_couÁ
 && 
buffd©a_Ën
 > 0; i++)

152 ià(
buffd©a_Ën
 < 
KEY_LEN_BYTES
)

154 
»t
 = 
KV_ERR_SYS_IO
;

159 
	`memmove
(
cu¼’t_±r
, 
d©a_buff
, 
KEY_LEN_BYTES
);

160 
cu¼’t_±r
 +ğ
KEY_LEN_BYTES
;

163 
key_size
 = *((
ušt32_t
 *)
d©a_buff
);

164 
buffd©a_Ën
 -ğ
KEY_LEN_BYTES
;

165 
d©a_buff
 +ğ
KEY_LEN_BYTES
;

167 ià(
key_size
 > 
buffd©a_Ën
)

169 
»t
 = 
KV_ERR_SYS_IO
;

172 ià(
key_size
 >= 256)

174 
»t
 = 
KV_ERR_SYS_IO
;

179 
	`memmove
(
cu¼’t_±r
, 
d©a_buff
, 
key_size
);

180 
cu¼’t_±r
 +ğ
key_size
;

183 
keyd©a_Ën_w™h_·ddšg
 = (((
key_size
 + 3) >> 2) << 2);

186 
buffd©a_Ën
 -ğ
keyd©a_Ën_w™h_·ddšg
;

187 
d©a_buff
 +ğ
keyd©a_Ën_w™h_·ddšg
;

189 
™”_li¡
->
size
 = 
cu¼’t_±r
 - (*)™”_li¡->
™_li¡
;

191  
»t
;

192 
	}
}

194 
šlše
 
kvs_»suÉ
 
	$cÚv”t_»tuº_code
(
İcode
, 
dev_¡©us_code
)

196 ià(
dev_¡©us_code
 == 0)

197  
KVS_SUCCESS
;

199 ià(
dev_¡©us_code
 < 0)

201  
KVS_ERR_SYS_IO
;

205 ià(
İcode
 =ğ
IOCB_ASYNC_ITER_OPEN_CMD
)

207 ià(
dev_¡©us_code
 == 0x391)

209  
KVS_ERR_ITERATOR_MAX
;

211 ià(
dev_¡©us_code
 == 0x304)

213  
KVS_ERR_OPTION_INVALID
;

215 ià(
dev_¡©us_code
 == 0x394)

217  
KVS_ERR_ITERATE_REQUEST_FAIL
;

220 ià(
İcode
 =ğ
IOCB_ASYNC_ITER_CLOSE_CMD
)

223 ià(
dev_¡©us_code
 == 0x390)

225  
KVS_ERR_ITERATOR_NOT_EXIST
;

227 ià(
dev_¡©us_code
 == 0x304)

229  
KVS_ERR_OPTION_INVALID
;

231 ià(
dev_¡©us_code
 == 0x394)

233  
KVS_ERR_ITERATE_REQUEST_FAIL
;

237 ià(
İcode
 =ğ
IOCB_ASYNC_ITER_NEXT_CMD
)

239 ià(
dev_¡©us_code
 == 0x301)

241  
KVS_ERR_BUFFER_SMALL
;

243 ià(
dev_¡©us_code
 == 0x390)

245  
KVS_ERR_ITERATOR_NOT_EXIST
;

247 ià(
dev_¡©us_code
 == 0x308)

249  
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

251 ià(
dev_¡©us_code
 == 0x394)

253  
KVS_ERR_ITERATE_REQUEST_FAIL
;

255 ià((
dev_¡©us_code
 == 0x393))

258  
KVS_SUCCESS
;

262  
KVS_ERR_SYS_IO
;

266 ià(
İcode
 =ğ
IOCB_ASYNC_GET_CMD
)

268 ià(
dev_¡©us_code
 == 0x301)

270  
KVS_ERR_VALUE_LENGTH_INVALID
;

272 ià(
dev_¡©us_code
 == 0x302)

274  
KVS_ERR_VALUE_OFFSET_INVALID
;

276 ià(
dev_¡©us_code
 == 0x303)

278  
KVS_ERR_KEY_LENGTH_INVALID
;

280 ià(
dev_¡©us_code
 == 0x304)

282  
KVS_ERR_OPTION_INVALID
;

284 ià(
dev_¡©us_code
 == 0x308)

286  
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

288 ià(
dev_¡©us_code
 == 0x310)

290  
KVS_ERR_KEY_NOT_EXIST
;

292 ià(
dev_¡©us_code
 == 0x311)

294  
KVS_ERR_UNCORRECTIBLE
;

298  
KVS_ERR_SYS_IO
;

301 ià(
İcode
 =ğ
IOCB_ASYNC_PUT_CMD
)

303 ià(
dev_¡©us_code
 == 0x301)

305  
KVS_ERR_VALUE_LENGTH_INVALID
;

307 ià(
dev_¡©us_code
 == 0x303)

309  
KVS_ERR_KEY_LENGTH_INVALID
;

311 ià(
dev_¡©us_code
 == 0x304)

313  
KVS_ERR_OPTION_INVALID
;

315 ià(
dev_¡©us_code
 == 0x308)

317  
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

319 ià(
dev_¡©us_code
 == 0x310)

321  
KVS_ERR_KEY_NOT_EXIST
;

323 ià(
dev_¡©us_code
 == 0x311)

325  
KVS_ERR_UNCORRECTIBLE
;

327 ià(
dev_¡©us_code
 == 0x312)

329  
KVS_ERR_DEV_CAPACITY
;

331 ià(
dev_¡©us_code
 == 0x380)

333  
KVS_ERR_KEY_EXIST
;

337  
KVS_ERR_SYS_IO
;

341 ià(
İcode
 =ğ
IOCB_ASYNC_DEL_CMD
)

343 ià(
dev_¡©us_code
 == 0x310)

345  
KVS_ERR_KEY_NOT_EXIST
;

347 ià(
dev_¡©us_code
 == 0x304)

349  
KVS_ERR_OPTION_INVALID
;

353  
KVS_ERR_SYS_IO
;

356 ià(
İcode
 =ğ
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
)

358 ià(
dev_¡©us_code
 == 0x301)

360  
KVS_ERR_VALUE_LENGTH_INVALID
;

362 ià(
dev_¡©us_code
 == 0x303)

364  
KVS_ERR_KEY_LENGTH_INVALID
;

366 ià(
dev_¡©us_code
 == 0x305)

368  
KVS_ERR_NS_INVALID
;

370 ià(
dev_¡©us_code
 == 0x310)

374  
KVS_SUCCESS
;

378  
KVS_ERR_SYS_IO
;

382  
KVS_ERR_SYS_IO
;

384 
	}
}

388 
	$kdd_Ú_io_com¶‘e
(
kv_io_cÚ‹xt
 *
cÚ‹xt
){

391 if((
cÚ‹xt
->
»tcode
 !ğ
KV_SUCCESS
è&& (cÚ‹xt->»tcod!ğ
KV_ERR_KEY_NOT_EXIST
) ) {

392 cÚ¡ *
cmd
 = (
cÚ‹xt
->
İcode
 =ğ
KV_OPC_GET
)? "GET": ((cÚ‹xt->İcod=ğ
KV_OPC_STORE
)? "PUT": (cÚ‹xt->İcod=ğ
KV_OPC_DELETE
)? "DEL":"OTHER");

393 
	`årštf
(
¡d”r
, "% çed w™hƒ¼Ü 0x%x %s\n", 
cmd
, 
cÚ‹xt
->
»tcode
, 
	`kvs_”r¡r
(context->retcode));

398 
KDDriv”
::
kv_kdd_cÚ‹xt
 *
ùx
 = (KDDriv”::kv_kdd_cÚ‹xt*)
cÚ‹xt
->
´iv©e_d©a
;

400 
kvs_ÿÎback_cÚ‹xt
 *
iocb
 = &
ùx
->iocb;

401 
iocb
->
»suÉ
 = 
	`cÚv”t_»tuº_code
(iocb->
İcode
, 
cÚ‹xt
->
»tcode
);

403 if(
iocb
->
İcode
 =ğ
IOCB_ASYNC_GET_CMD
) {

404 
iocb
->
v®ue
->
aùu®_v®ue_size
 = 
cÚ‹xt
->value->actual_value_size;

405 
iocb
->
v®ue
->
Ëngth
 = 
cÚ‹xt
->value->length;

406 if(
iocb
->
v®ue
->
Ëngth
 < iocb->v®ue->
aùu®_v®ue_size
)

407 
iocb
->
»suÉ
 = 
KVS_ERR_BUFFER_SMALL
;

409 ià(
iocb
->
İcode
 =ğ
IOCB_ASYNC_ITER_NEXT_CMD
 && 
cÚ‹xt
->
»tcode
 == 0) {

411 
kvs_™”©Ü_li¡
* 
li¡
 = (kvs_™”©Ü_li¡*è
iocb
->
»suÉ_bufãr
;

412 
li¡
->
’d
 = (
cÚ‹xt
->
h™”
.’d)?
TRUE
:
FALSE
;

414 
li¡
->
™_li¡
 = 
cÚ‹xt
->
h™”
.
buf
;

415 
li¡
->
size
 = 
cÚ‹xt
->
h™”
.
buæ’gth
;

416 ià(
cÚ‹xt
->
h™”
.
buf
 && 
li¡
->
size
 > 0) {

417 
li¡
->
num_’Œ›s
 = *((*)
cÚ‹xt
->
h™”
.
buf
);

418 
	`»fÜm©_™”bufãr
(
li¡
);

420 
li¡
->
num_’Œ›s
 = 0;

423 } ià(
iocb
->
İcode
 =ğ
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
) {

424 *(
ušt8_t
*)
iocb
->
»suÉ_bufãr
 = (
cÚ‹xt
->
»tcode
 == 0x310)? 0:1;

427 #ifdeà
KVKDD_DEBUG


428 if(
iocb
->
İcode
 =ğ
IOCB_ASYNC_PUT_CMD
) {

429 
kvkdd_logg”
.
	`log_wr™e
(
cÚ‹xt
->
key
->key, cÚ‹xt->key->
Ëngth
, cÚ‹xt->
v®ue
->v®ue, cÚ‹xt->v®ue->Ëngth, cÚ‹xt->
»tcode
);

430 } if(
iocb
->
İcode
 =ğ
IOCB_ASYNC_GET_CMD
) {

431 
kvkdd_logg”
.
	`log_»ad
(
cÚ‹xt
->
key
->key, cÚ‹xt->key->
Ëngth
, cÚ‹xt->
v®ue
->v®ue, cÚ‹xt->v®ue->Ëngth, cÚ‹xt->v®ue->
aùu®_v®ue_size
, cÚ‹xt->
»tcode
);

435 if(
ùx
->
syncio
) {

436 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
ùx
->
lock_sync
);

437 
ùx
->
dÚe
 = 
Œue
;

438 
ùx
->
dÚe_cÚd_sync
.
	`nÙify_Úe
();

443 if(
ùx
->
Ú_com¶‘e
 && 
iocb
) {

444 
ùx
->
	`Ú_com¶‘e
(
iocb
);

447 
d–‘e
 
ùx
;

448 
ùx
 = 
NULL
;

450 
	}
}

452 
	gKDDriv”
::
	$ü—‹_queue
(
qd•th
, 
ušt16_t
 
qty³
, 
kv_queue_hªdË
 *
hªdË
, 
cqid
, 
is_pŞlšg
){

454 
qid
 = -1;

455 
kv_queue
 
qšfo
;

456 
qšfo
.
queue_id
 = ++
qid
;

457 
qšfo
.
queue_size
 = 
qd•th
;

458 
qšfo
.
com¶‘iÚ_queue_id
 = 
cqid
;

459 
qšfo
.
queue_ty³
 = 
qty³
;

460 
qšfo
.
ex‹nded_šfo
 = 
NULL
;

461 
kv_»suÉ
 
»t
 = 
	`kv_ü—‹_queue
(
this
->
devH
, &
qšfo
, 
hªdË
);

462 ià(
»t
 !ğ
KV_SUCCESS
è{
	`årštf
(
¡d”r
, "kv_create_queue failed 0x%x\n",„et);}

464 ià(!
is_pŞlšg
) {

465 
KADI
 *
adi
 = (KADI*)(
this
->
devH
->
dev
);

466 
adi
->
	`¡¬t_cbth»ad
();

470  
qid
;

471 
	}
}

473 
št32_t
 
	gKDDriv”
::
	$š™
(cÚ¡ * 
dev·th
, cÚ¡ * 
cÚfigfe
, 
queue_d•th
, 
is_pŞlšg
) {

475 #iâdeà
WITH_KDD


476 
	`årštf
(
¡d”r
, "Kernel Driver is‚ot supported. \nPlease set compilation option…roperly (-DWITH_KDD=ON)\n");

477 
	`ex™
(1);

480 
kv_»suÉ
 
»t
;

482 
kv_deviû_š™_t
 
dev_š™
;

483 
dev_š™
.
dev·th
 = devpath;

484 
dev_š™
.
Ãed_³rsi¡’cy
 = 
FALSE
;

485 
dev_š™
.
is_pŞlšg
 = (is_pŞlšg =ğ1 ? 
TRUE
 : 
FALSE
);

486 
dev_š™
.
cÚfigfe
 = 
NULL
;

487 
dev_š™
.
queued•th
 = 
queue_d•th
;

489 
»t
 = 
	`kv_š™Ÿlize_deviû
(&
dev_š™
, &
this
->
devH
);

490 ià(
»t
 !ğ
KV_SUCCESS
è{ 
	`årštf
(
¡d”r
, "kv_š™Ÿlize_deviû faed 0x%x - %s\n",„‘, 
	`kvs_”r¡r
(ret));

492  
»t
;

495 
»t
 = 
	`g‘_Çme¥aû_deçuÉ
(
this
->
devH
, &this->
nsH
);

496 ià(
»t
 !ğ
KV_SUCCESS
è{ 
	`årštf
(
¡d”r
, "get_namespace_default failed 0x%x\n",„et);

498  
»t
;

501 
this
->
queued•th
 = 
queue_d•th
;

502 
cqid
 = 
	`ü—‹_queue
(
this
->
queued•th
, 
COMPLETION_Q_TYPE
, &this->
cqH
, 0, 
is_pŞlšg
);

503 
	`ü—‹_queue
(
this
->
queued•th
, 
SUBMISSION_Q_TYPE
, &this->
sqH
, 
cqid
, 
is_pŞlšg
);

507  
»t
;

508 
	}
}

512 
št32_t
 
	gKDDriv”
::
	$¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

514 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_PUT_CMD
, 
cÚtid
, 
key
, 
v®ue
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

515 
kv_po¡´oûss_funùiÚ
 
f
 = {

516 
kdd_Ú_io_com¶‘e
, (*)
ùx


519 
kv_¡Üe_İtiÚ
 
İtiÚ_adi
;

520 if(!
İtiÚ
.
kvs_¡Üe_com´ess
) {

522 
İtiÚ
.
¡_ty³
) {

523 
KVS_STORE_POST
:

524 
İtiÚ_adi
 = 
KV_STORE_OPT_DEFAULT
;

526 
KVS_STORE_UPDATE_ONLY
:

527 
İtiÚ_adi
 = 
KV_STORE_OPT_UPDATE_ONLY
;

529 
KVS_STORE_NOOVERWRITE
:

530 
İtiÚ_adi
 = 
KV_STORE_OPT_IDEMPOTENT
;

532 
KVS_STORE_APPEND
:

533 
İtiÚ_adi
 = 
KV_STORE_OPT_APPEND
;

536 
	`årštf
(
¡d”r
, "WARN: Wrong store option\n");

537 
d–‘e
 
ùx
;

538 
ùx
 = 
NULL
;

539  
KVS_ERR_OPTION_INVALID
;

543 
İtiÚ
.
¡_ty³
) {

544 
KVS_STORE_POST
:

545 
İtiÚ_adi
 = 
KV_STORE_OPT_POST_WITH_COMPRESS
;

547 
KVS_STORE_UPDATE_ONLY
:

548 
İtiÚ_adi
 = 
KV_STORE_OPT_UPDATE_ONLY_COMPRESS
;

550 
KVS_STORE_NOOVERWRITE
:

551 
İtiÚ_adi
 = 
KV_STORE_OPT_NOOVERWRITE_COMPRESS
;

553 
KVS_STORE_APPEND
:

554 
İtiÚ_adi
 = 
KV_STORE_OPT_APPEND_COMPRESS
;

557 
	`årštf
(
¡d”r
, "WARN: Wrong store option\n");

558  
KVS_ERR_OPTION_INVALID
;

562 
»t
 = 
	`kv_¡Üe
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, (
kv_v®ue
*)
v®ue
, 
İtiÚ_adi
, &
f
);

564 
»t
 =ğ
KV_ERR_QUEUE_IS_FULL
) {

565 
»t
 = 
	`kv_¡Üe
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, (
kv_v®ue
*)
v®ue
, 
İtiÚ_adi
, &
f
);

568 if(
syncio
 && 
»t
 == 0) {

569 
	`wa™_fÜ_io
(
ùx
);

570 
»t
 = 
ùx
->
iocb
.
»suÉ
;

572 
d–‘e
 
ùx
; ctx = 
NULL
;

575 
	`ä“_if_”rÜ
(
»t
, 
ùx
);

578  
»t
;

579 
	}
}

581 
	gKDDriv”
::
	$wa™_fÜ_io
(
kv_kdd_cÚ‹xt
 *
ùx
) {

582 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
ùx
->
lock_sync
);

584 !
ùx
->
dÚe
)

585 
ùx
->
dÚe_cÚd_sync
.
	`wa™
(
lock
);

587 
	}
}

589 
št32_t
 
	gKDDriv”
::
	$»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

591 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_GET_CMD
, 
cÚtid
, 
key
, 
v®ue
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

592 
kv_po¡´oûss_funùiÚ
 
f
 = {
kdd_Ú_io_com¶‘e
, (*)
ùx
};

594 
kv_»Œ›ve_İtiÚ
 
İtiÚ_adi
;

595 if(!
İtiÚ
.
kvs_»Œ›ve_d–‘e
) {

596 if(!
İtiÚ
.
kvs_»Œ›ve_decom´ess
)

597 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DEFAULT
;

599 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DECOMPRESS
;

601 if(!
İtiÚ
.
kvs_»Œ›ve_decom´ess
)

602 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DELETE
;

604 
İtiÚ_adi
 = 
KV_RETRIEVE_OPT_DECOMPRESS_DELETE
;

607 
»t
 = 
	`kv_»Œ›ve
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, 
İtiÚ_adi
, (
kv_v®ue
*)
v®ue
, &
f
);

609 
»t
 =ğ
KV_ERR_QUEUE_IS_FULL
) {

610 
»t
 = 
	`kv_»Œ›ve
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, 
İtiÚ_adi
, (
kv_v®ue
*)
v®ue
, &
f
);

613 if(
syncio
 && 
»t
 == 0) {

615 
	`wa™_fÜ_io
(
ùx
);

616 
»t
 = 
ùx
->
iocb
.
»suÉ
;

618 
d–‘e
 
ùx
;

619 
ùx
 = 
NULL
;

622 
	`ä“_if_”rÜ
(
»t
, 
ùx
);

623  
»t
;

624 
	}
}

626 
št32_t
 
	gKDDriv”
::
	$d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

627 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_DEL_CMD
, 
cÚtid
, 
key
, 
NULL
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

628 
kv_po¡´oûss_funùiÚ
 
f
 = {
kdd_Ú_io_com¶‘e
, (*)
ùx
};

630 
kv_d–‘e_İtiÚ
 
İtiÚ_adi
;

631 if(!
İtiÚ
.
kvs_d–‘e_”rÜ
)

632 
İtiÚ_adi
 = 
KV_DELETE_OPT_DEFAULT
;

634 
İtiÚ_adi
 = 
KV_DELETE_OPT_ERROR
;

636 
»t
 = 
	`kv_d–‘e
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, 
İtiÚ_adi
, &
f
);

638 
»t
 =ğ
KV_ERR_QUEUE_IS_FULL
) {

639 
»t
 = 
	`kv_d–‘e
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
key
, 
İtiÚ_adi
, &
f
);

642 if(
syncio
 && 
»t
 == 0) {

644 
	`wa™_fÜ_io
(
ùx
);

645 
»t
 = 
ùx
->
iocb
.
»suÉ
;

647 
d–‘e
 
ùx
;

648 
ùx
 = 
NULL
;

651 
	`ä“_if_”rÜ
(
»t
, 
ùx
);

652  
»t
;

653 
	}
}

656 
št32_t
 
	gKDDriv”
::
	$exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

658 if(
key_út
 > 1) {

659 
	`årštf
(
¡d”r
, "WARN: kernel driver only supports one key check \n");

660 
	`ex™
(1);

662 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
, 
cÚtid
, 
keys
, 
NULL
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

663 
ùx
->
iocb
.
key_út
 = key_cnt;

664 
ùx
->
iocb
.
»suÉ_bufãr
 =„esult_buffer;

666 
kv_po¡´oûss_funùiÚ
 
f
 = {
kdd_Ú_io_com¶‘e
, (*)
ùx
};

668 
»t
 = 
	`kv_exi¡
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
keys
, 
key_út
, 
bufãr_size
, 
»suÉ_bufãr
, &
f
);

670 
»t
 =ğ
KV_ERR_QUEUE_IS_FULL
) {

671 
»t
 = 
	`kv_exi¡
(
this
->
sqH
,his->
nsH
, (
kv_key
*)
keys
, 
key_út
, 
bufãr_size
, 
»suÉ_bufãr
, &
f
);

674 if(
syncio
 && 
»t
 == 0) {

675 
	`wa™_fÜ_io
(
ùx
);

676 
»t
 = 
ùx
->
iocb
.
»suÉ
;

678 
d–‘e
 
ùx
;

679 
ùx
 = 
NULL
;

682 
	`ä“_if_”rÜ
(
»t
, 
ùx
);

684  
»t
;

685 
	}
}

687 
	gKDDriv”
::
	$check_İ’ed_™”©Üs
(
ušt32_t
 
b™mask
, ušt32_ˆ
b™_·‰”n
) {

688 
kv_™”©Ü
 
kv_™”s
[
SAMSUNG_MAX_ITERATORS
];

689 
	`mem£t
(
kv_™”s
, 0, (kv_iters));

690 
ušt32_t
 
couÁ
 = 
SAMSUNG_MAX_ITERATORS
;

692 
kv_»suÉ
 
»s
 = 
	`kv_li¡_™”©Üs_sync
(
sqH
, 
nsH
, 
kv_™”s
, &
couÁ
);

693 if(
»s
)

694  
»s
;

695 
İ’ed
 = 0;

696 
ušt32_t
 
i
 = 0; i< 
couÁ
; i++){

697 if(
kv_™”s
[
i
].
¡©us
 == 1) {

698 
İ’ed
++;

700 if(
kv_™”s
[
i
].
´efix
 =ğ
b™_·‰”n
 && kv_™”s[i].
b™mask
 == bitmask) {

701 
	`årštf
(
¡dout
, "WARN: Iterator with same…refix/bitmask is‡lready opened\n");

702  
KVS_ERR_ITERATOR_OPEN
;

707 if(
İ’ed
 =ğ
SAMSUNG_MAX_ITERATORS
)

708  
KVS_ERR_ITERATOR_MAX
;

711 
	}
}

713 
št32_t
 
	gKDDriv”
::
	$İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
 , 
ušt32_t
 
b™mask
,

714 
ušt32_t
 
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
) {

715 
»t
 = 0;

717 if(
İtiÚ
.
™”_ty³
 !ğ
KVS_ITERATOR_KEY
) {

718 
	`årštf
(
¡d”r
, "Kernel driver does‚ot support iterator for key-value„etrieve\n");

719 
	`ex™
(1);

722 
»t
 = 
	`check_İ’ed_™”©Üs
(
b™mask
, 
b™_·‰”n
);

723 ià(
»t
) „et;

725 
kv_group_cÚd™iÚ
 
g½_cÚd
 = {
b™mask
, 
b™_·‰”n
};

727 
kv_™”©Ü_İtiÚ
 
İtiÚ_adi
;

728 
İtiÚ
.
™”_ty³
) {

729 
KVS_ITERATOR_KEY
:

730 
İtiÚ_adi
 = 
KV_ITERATOR_OPT_KEY
;

732 
KVS_ITERATOR_KEY_VALUE
:

733 
İtiÚ_adi
 = 
KV_ITERATOR_OPT_KV
;

735 
KVS_ITERATOR_WITH_DELETE
:

736 
İtiÚ_adi
 = 
KV_ITERATOR_OPT_KV_WITH_DELETE
;

739 
	`årštf
(
¡d”r
, "WARN: Wrong iterator option\n");

740  
KVS_ERR_OPTION_INVALID
;

743 
»t
 = 
	`kv_İ’_™”©Ü_sync
(
this
->
sqH
,his->
nsH
, 
İtiÚ_adi
, &
g½_cÚd
, 
™”_hd
);

749  
	`cÚv”t_»tuº_code
(
IOCB_ASYNC_ITER_OPEN_CMD
, 
»t
);

750 
	}
}

752 
št32_t
 
	gKDDriv”
::
	$şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
) {

753 
»t
 = 
	`kv_şo£_™”©Ü_sync
(
this
->
sqH
,his->
nsH
, 
h™”
 );

759  
	`cÚv”t_»tuº_code
(
IOCB_ASYNC_ITER_CLOSE_CMD
, 
»t
);;

760 
	}
}

762 
št32_t
 
	gKDDriv”
::
	$şo£_™”©Ü_®l
(
cÚtid
) {

764 
	`årštf
(
¡d”r
, "WARN:his feature is‚ot supported inhe kernel driver\n");

765  
KVS_ERR_OPTION_INVALID
;

767 
	}
}

769 
št32_t
 
	gKDDriv”
::
	$li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
) {

771  
	`kv_li¡_™”©Üs_sync
(
sqH
, 
nsH
, (
kv_™”©Ü
 *)
kvs_™”s
, &
couÁ
);

772 
	}
}

775 
št32_t
 
	gKDDriv”
::
	$™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

776 
»t
;

777 ià(
syncio
) {

778 
»t
 = 
	`kv_™”©Ü_Ãxt_sync
(
this
->
sqH
,his->
nsH
, 
h™”
 , (
kv_™”©Ü_li¡
 *)
™”_li¡
);

780 
	`»fÜm©_™”bufãr
(
™”_li¡
);

784  
	`cÚv”t_»tuº_code
(
IOCB_ASYNC_ITER_NEXT_CMD
, 
»t
);;

787 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_ITER_NEXT_CMD
, 0, 0, 0, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

788 
ùx
->
iocb
.
»suÉ_bufãr
 = (
ušt8_t
*)
™”_li¡
;

790 
kv_po¡´oûss_funùiÚ
 
f
 = {

791 
kdd_Ú_io_com¶‘e
, (*)
ùx


793 
»t
 = 
	`kv_™”©Ü_Ãxt
(
this
->
sqH
,his->
nsH
, 
h™”
 , (
kv_™”©Ü_li¡
 *)
™”_li¡
, &
f
);

795 if(
»t
 !ğ
KV_SUCCESS
) {

796 
	`årštf
(
¡d”r
, "kv_™”©Ü_Ãxˆçed w™hƒ¼Ü: 0x%X\n", 
»t
);

798 
d–‘e
 
ùx
;

799 
ùx
 = 
NULL
;

802  
»t
;

803 
	}
}

805 
št32_t
 
	gKDDriv”
::
	$g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
) {

808 
	}
}

810 
št32_t
 
	gKDDriv”
::
	$g‘_u£d_size
(
št32_t
 *
dev_ut
){

811 
»t
 = 0;

812 
kv_deviû_¡©
 *
¡©
 = (kv_deviû_¡©*)
	`m®loc
((kv_device_stat));

814 
»t
 = 
	`kv_g‘_deviû_¡©
(
devH
, 
¡©
);

815 ià(
»t
) {

816 
	`årštf
(
¡dout
, "Thho¡ faedØcommuniÿ‹ w™hhdeivû: 0x%x", 
»t
);

817 if(
¡©
è
	`ä“
(stat);

818 
	`ex™
(1);

820 *
dev_ut
 = 
¡©
->
utiz©iÚ
;

822 if(
¡©
è
	`ä“
(stat);

824  
»t
;

825 
	}
}

827 
št32_t
 
	gKDDriv”
::
	$g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
) {

829 
»t
 = 0;

831 
kv_deviû
 *
devšfo
 = (kv_deviû *)
	`m®loc
((kv_device));

832 
»t
 = 
	`kv_g‘_deviû_šfo
(
devH
, 
devšfo
);

834 ià(
»t
) {

835 
	`årštf
(
¡dout
, "Thho¡ faedØcommuniÿ‹ w™hhdeivû: 0x%x", 
»t
);

836 if(
devšfo
è
	`ä“
(devinfo);

837 
	`ex™
(1);

840 *
dev_ÿ·
 = 
devšfo
->
ÿ·c™y
;

842 if(
devšfo
è
	`ä“
(devinfo);

843  
»t
;

844 
	}
}

846 
št32_t
 
	gKDDriv”
::
	$´oûss_com¶‘iÚs
(
max
)

848 
»t
;

849 
ušt32_t
 
´oûs£d
 = 0;

851 
»t
 = 
	`kv_pŞl_com¶‘iÚ
(
this
->
cqH
, 0, &
´oûs£d
);

852 ià(
»t
 !ğ
KV_SUCCESS
 &&„‘ !ğ
KV_WRN_MORE
)

853 
	`årštf
(
¡dout
, "Polling failed\n");

855  
´oûs£d
;

856 
	}
}

861 
	gKDDriv”
::~
	$KDDriv”
() {

863 ià(
	`kv_d–‘e_queue
(
this
->
devH
,his->
sqH
è!ğ
KV_SUCCESS
) {

864 
	`årštf
(
¡d”r
, "kv delete submission queue failed\n");

865 
	`ex™
(1);

868 ià(
	`kv_d–‘e_queue
(
this
->
devH
,his->
cqH
è!ğ
KV_SUCCESS
) {

869 
	`årštf
(
¡d”r
, "kv delete completion queue failed\n");

870 
	`ex™
(1);

873 
	`kv_d–‘e_Çme¥aû
(
devH
, 
nsH
);

874 
	`kv_ş—nup_deviû
(
devH
);

875 
	}
}

877 
	gKDDriv”
::
kv_kdd_cÚ‹xt
* 
KDDriv”
::
	$´•_io_cÚ‹xt
(
İcode
, 
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
){

879 
kv_kdd_cÚ‹xt
 *
ùx
 = 
Ãw
 
	`kv_kdd_cÚ‹xt
();

881 
ùx
->
owÃr
 = 
this
;

882 
ùx
->
iocb
.
İcode
 = opcode;

884 if(
key
) {

885 
ùx
->
iocb
.
key
 = (
kvs_key
*)key;

887 
ùx
->
iocb
.
key
 = 0;

890 if(
v®ue
) {

891 
ùx
->
iocb
.
v®ue
 = (
kvs_v®ue
*)value;

893 
ùx
->
iocb
.
v®ue
 = 0;

896 
ùx
->
iocb
.
´iv©e1
 =…rivate1;

897 
ùx
->
iocb
.
´iv©e2
 =…rivate2;

898 
ùx
->
iocb
.
»suÉ_bufãr
 = 
NULL
;

899 
ùx
->
Ú_com¶‘e
 = 
cbâ
;

901 
ùx
->
dÚe
ğ
çl£
;

902 
ùx
->
syncio
 = syncio;

904  
ùx
;

905 
	}
}

907 
	gKDDriv”
::
	$g‘_waf
(){

909 
ušt32_t
 
tmp_waf
;

910 
	`kv_g‘_deviû_waf
(
devH
, &
tmp_waf
);

912  (è
tmp_waf
/10.0;

913 
	}
}

	@PDK/core/src/api/src/driver_adapter/kvudd.cpp

34 
	~<io¡»am
>

35 
	~<f¡»am
>

36 
	~<®gÜ™hm
>

37 
	~<©omic
>

38 
	~<tbb/cÚcu¼’t_queue.h
>

39 
	~<li¡
>

41 
	~"kvs_uts.h
"

42 
	~"udd.hµ
"

43 
	~"udd’v.h
"

45 
	~<udd/kvnvme.h
>

46 
	~<udd/kv_ty³s.h
>

48 
	#MAX_POOLSIZE
 10240

	)

49 
	#GB_SIZE
 (1024 * 1024 * 1024)

	)

51 
	gKUDDriv”
::
	$KUDDriv”
(
kv_deviû_´iv
 *
dev
, 
kvs_ÿÎback_funùiÚ
 
u£r_io_com¶‘e_
):

52 
	`KvsDriv”
(
dev
, 
u£r_io_com¶‘e_
), 
	`queue_d•th
(256), 
	`num_cq_th»ads
(1), 
	$mem_size_mb
(1024)

54 
	`årštf
(
¡dout
, "init udd\n");

55 
	}
}

57 
	$udd_™”©e_cb
(
kv_™”©e
 *
™
, 
»suÉ
, 
¡©us
) {

58 
KUDDriv”
::
kv_udd_cÚ‹xt
 *
ùx
 = (KUDDriv”::kv_udd_cÚ‹xt*)
™
->
kv
.
·¿m
.
´iv©e_d©a
;

59 
kvs_ÿÎback_cÚ‹xt
 *
iocb
 = &
ùx
->iocb;

60 
iocb
->
»suÉ
 = (
kvs_»suÉ
)
¡©us
;

61 if(
¡©us
 !ğ
KV_SUCCESS
){

62 if(
¡©us
 =ğ
KV_ERR_ITERATE_READ_EOF
){

64 
iocb
->
»suÉ
 = 
KVS_SUCCESS
;

65 
ùx
->
™”_li¡
->
’d
 = 0x01;

66 } ià(
¡©us
 =ğ
KV_ERR_ITERATE_FAIL_TO_PROCESS_REQUEST
) {

67 
iocb
->
»suÉ
 = 
KVS_ERR_ITERATOR_NOT_EXIST
;

68 } ià(
¡©us
 =ğ
KV_WRN_MORE
) {

69 
iocb
->
»suÉ
 = 
KVS_SUCCESS
;

70 } ià(
¡©us
 =ğ
KV_ERR_BUFFER
) {

71 
iocb
->
»suÉ
 = 
KVS_ERR_BUFFER_SMALL
;

72 } ià(
¡©us
 =ğ
KV_ERR_INVALID_OPTION
){

73 
iocb
->
»suÉ
 = 
KVS_ERR_OPTION_INVALID
;

75 
iocb
->
»suÉ
 = 
KVS_ERR_SYS_IO
;

76 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü.„esuÉ=0x%x stus=0x%x\n", 
__FUNCTION__
, 
»suÉ
, 
¡©us
);

80 if(
¡©us
 =ğ
KV_SUCCESS
 || stu =ğ
KV_ERR_ITERATE_READ_EOF
 || stu =ğ
KV_WRN_MORE
) {

83 
ušt32_t
 
num_key
 = *((*)
™
->
kv
.
v®ue
.value);

84 
ùx
->
™”_li¡
->
num_’Œ›s
 = 
num_key
;

86 *
d©a_buff
 = (*)
™
->
kv
.
v®ue
.value;

87 
bufãr_size
 = 
™
->
kv
.
v®ue
.
Ëngth
;

88 *
cu¼’t_±r
 = 
d©a_buff
;

90 
key_size
 = 0;

91 
keyd©a_Ën_w™h_·ddšg
 = 0;

92 
buffd©a_Ën
 = 
bufãr_size
;

94 
buffd©a_Ën
 -ğ
KV_IT_READ_BUFFER_META_LEN
;

95 
d©a_buff
 +ğ
KV_IT_READ_BUFFER_META_LEN
;

96 
ušt32_t
 
i
 = 0; i < 
num_key
 && 
buffd©a_Ën
 > 0; i++) {

97 ià(
buffd©a_Ën
 < 
KV_IT_READ_BUFFER_META_LEN
) {

98 
iocb
->
»suÉ
 = 
KVS_ERR_SYS_IO
;

103 
	`memmove
(
cu¼’t_±r
, 
d©a_buff
, 
KV_IT_READ_BUFFER_META_LEN
);

104 
cu¼’t_±r
 +ğ
KV_IT_READ_BUFFER_META_LEN
;

107 
key_size
 = *((
ušt32_t
 *)
d©a_buff
);

108 
buffd©a_Ën
 -ğ
KV_IT_READ_BUFFER_META_LEN
;

109 
d©a_buff
 +ğ
KV_IT_READ_BUFFER_META_LEN
;

111 ià(
key_size
 > 
buffd©a_Ën
) {

112 
iocb
->
»suÉ
 = 
KVS_ERR_SYS_IO
;

115 ià(
key_size
 >= 256) {

116 
iocb
->
»suÉ
 = 
KVS_ERR_SYS_IO
;

121 
	`memmove
(
cu¼’t_±r
, 
d©a_buff
, 
key_size
);

122 
cu¼’t_±r
 +ğ
key_size
;

125 
keyd©a_Ën_w™h_·ddšg
 = (((
key_size
 + 3) >> 2) << 2);

128 
buffd©a_Ën
 -ğ
keyd©a_Ën_w™h_·ddšg
;

129 
d©a_buff
 +ğ
keyd©a_Ën_w™h_·ddšg
;

133 
ùx
->
™”_li¡
->
™_li¡
 = 
™
->
kv
.
v®ue
.value;

134 
ùx
->
™”_li¡
->
size
 = 
™
->
kv
.
v®ue
.
Ëngth
;

135 if(
ùx
->
Ú_com¶‘e
 && 
iocb
èùx->
	`Ú_com¶‘e
(iocb);

137 ià(
ùx
) {

138 
	`ä“
(
ùx
);

139 
ùx
 = 
NULL
;

141 if(
™
) {

142 
	`kv_ä“
(
™
);

143 
™
 = 
NULL
;

145 
	}
}

147 
	$udd_wr™e_cb
(
kv_·œ
 *
kv
, 
»suÉ
, 
¡©us
) {

149 if(
¡©us
 !ğ
KV_SUCCESS
 && stu !ğ
KV_ERR_NOT_EXIST_KEY
 ){

150 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü. key=% İtiÚ=%d v®ue.Ëngth=%d v®ue.off£t=%d stu codğ0x%x\n", 
__FUNCTION__
, (*)
kv
->
key
.key, kv->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
,kv->
v®ue
.
Ëngth
, kv->v®ue.
off£t
, 
¡©us
);

153 
KUDDriv”
::
kv_udd_cÚ‹xt
 *
ùx
 = (KUDDriv”::kv_udd_cÚ‹xt*)
kv
->
·¿m
.
´iv©e_d©a
;

155 
kvs_ÿÎback_cÚ‹xt
 *
iocb
 = &
ùx
->iocb;

156 if(
iocb
->
İcode
 =ğ
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
) {

157 
iocb
->
»suÉ
 = (
kvs_»suÉ
)result;

158 if(
¡©us
 =ğ
KV_ERR_NOT_EXIST_KEY
)

159 
¡©us
 = 0;

160 ià(
¡©us
 =ğ
KV_SUCCESS
)

161 
¡©us
 = 1;

162 *
iocb
->
»suÉ_bufãr
 = 
¡©us
;

164 if(
¡©us
 =ğ
KV_SUCCESS
) {

165 
iocb
->
»suÉ
 = 
KVS_SUCCESS
;

166 } if(
¡©us
 =ğ
KV_ERR_INVALID_VALUE_SIZE
 || stu =ğ
KV_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
) {

167 
iocb
->
»suÉ
 = 
KVS_ERR_VALUE_LENGTH_INVALID
;

168 } ià(
¡©us
 =ğ
KV_ERR_INVALID_VALUE_OFFSET
) {

169 
iocb
->
»suÉ
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

170 } ià(
¡©us
 =ğ
KV_ERR_INVALID_KEY_SIZE
) {

171 
iocb
->
»suÉ
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

172 } ià(
¡©us
 =ğ
KV_ERR_MISALIGNED_VALUE_SIZE
) {

173 
iocb
->
»suÉ
 = 
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

174 } ià(
¡©us
 =ğ
KV_ERR_MISALIGNED_VALUE_OFFSET
) {

175 
iocb
->
»suÉ
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

176 } ià(
¡©us
 =ğ
KV_ERR_MISALIGNED_KEY_SIZE
) {

177 
iocb
->
»suÉ
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

178 } ià(
¡©us
 =ğ
KV_ERR_NOT_EXIST_KEY
) {

179 
iocb
->
»suÉ
 = 
KVS_ERR_KEY_NOT_EXIST
;

180 } ià(
¡©us
 =ğ
KV_ERR_CAPACITY_EXCEEDED
) {

181 
iocb
->
»suÉ
 = 
KVS_ERR_CONT_CAPACITY
;

182 } ià(
¡©us
 =ğ
KV_ERR_DD_INVALID_PARAM
) {

183 
iocb
->
»suÉ
 = 
KVS_ERR_PARAM_INVALID
;

184 } ià(
¡©us
 =ğ
KV_ERR_DD_UNSUPPORTED_CMD
 || stu =ğ
KV_ERR_INVALID_OPTION
){

185 
iocb
->
»suÉ
 = 
KVS_ERR_OPTION_INVALID
;

186 } ià(
¡©us
 =ğ
KV_ERR_BUFFER
) {

187 
iocb
->
»suÉ
 = 
KVS_ERR_BUFFER_SMALL
;

188 } if(
¡©us
 =ğ
KV_ERR_IDEMPOTENT_STORE_FAIL
) {

189 
iocb
->
»suÉ
 = 
KVS_ERR_KEY_EXIST
;

191 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü. key=% İtiÚ=%d v®ue.Ëngth=%d v®ue.off£t=%d stu codğ0x%x\n", 
__FUNCTION__
, (*)
kv
->
key
.key, kv->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
,kv->
v®ue
.
Ëngth
, kv->v®ue.
off£t
, 
¡©us
);

192 
iocb
->
»suÉ
 = 
KVS_ERR_SYS_IO
;

196 if(
iocb
->
key
) {

197 
iocb
->
key
->key = 
kv
->key.key;

198 
iocb
->
key
->
Ëngth
 = 
kv
->key.length;

200 if(
iocb
->
v®ue
)

201 
iocb
->
v®ue
->
aùu®_v®ue_size
 = 
kv
->value.actual_value_size;

203 if(
ùx
->
Ú_com¶‘e
 && 
iocb
èùx->
	`Ú_com¶‘e
(iocb);

205 cÚ¡‡utØ
owÃr
 = 
ùx
->owner;

206 ià(
ùx
) {

207 
	`ä“
(
ùx
);

208 
ùx
 = 
NULL
;

210 ià(
kv
) {

211 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
owÃr
->
lock
);

212 
owÃr
->
kv_·œ_poŞ
.
	`push
(
kv
);

213 
lock
.
	`uÆock
();

215 
	}
}

217 
	$´št_cÜemask
(
ušt64_t
 
x
)

219 
z
;

220 
b
[65];

221 
b
[64] = '\0';

222 
z
 = 0; z < 64; z++) {

223 
b
[63-
z
] = ((
x
>>z) & 0x1) + '0';

225 
	`´štf
("cÜemask = %s\n", 
b
);

226 
	}
}

228 
št32_t
 
	gKUDDriv”
::
	$š™
(cÚ¡ * 
dev·th
, 
boŞ
 
syncio
, 
ušt64_t
 
sq_cÜe
, ušt64_ˆ
cq_cÜe
, 
ušt32_t
 
mem_size_mb
, 
queue_d•th
) {

230 
»t
;

232 
kv_nvme_io_İtiÚs
 
İtiÚs
 = {0};

233 
İtiÚs
.
cÜe_mask
 = (1ULL << 
sq_cÜe
);

234 ià(
syncio
)

235 
İtiÚs
.
sync_mask
 = 1;

237 
İtiÚs
.
sync_mask
 = 0;

238 
İtiÚs
.
num_cq_th»ads
 = 1;

239 
İtiÚs
.
cq_th»ad_mask
 = (1ULL << 
cq_cÜe
);

240 
İtiÚs
.
queue_d•th
 = queue_depth;

241 
İtiÚs
.
mem_size_mb
 = mem_size_mb;

242 
ssd_ty³
 = 
KV_TYPE_SSD
;

245 
»t
 = 
	`kv_nvme_š™
(
dev·th
, &
İtiÚs
, 
ssd_ty³
);

246 if(
»t
) {

247 ià(
»t
 =ğ
KV_ERR_DD_NO_DEVICE
) {

248 
»t
 = 
KVS_ERR_DEV_NOT_EXIST
;

249 } ià(
»t
 =ğ
KV_ERR_DD_INVALID_PARAM
) {

250 
»t
 = 
KVS_ERR_PARAM_INVALID
;

251 } ià(
»t
 =ğ
KV_ERR_DD_UNSUPPORTED_CMD
) {

252 
»t
 = 
KVS_ERR_OPTION_INVALID
;

254 
	`årštf
(
¡d”r
, "FaedØİ’ deviû: % 0x%x\n", "KVS_ERR_DEV_INIT", 
»t
);

255 
»t
 = 
KVS_ERR_SYS_IO
;

257  
»t
;

260 
ıu_£t_t
 
ıu£t
;

261 
	`CPU_ZERO
(&
ıu£t
);

262 
	`CPU_SET
(0, &
ıu£t
);

263 
	`sched_£ffš™y
(0, (
ıu_£t_t
), &
ıu£t
);

265 
	`memıy
(
Œid
, 
dev·th
, 1024);

266 
hªdË
 = 
	`kv_nvme_İ’
(
dev·th
);

267 if(
hªdË
 == 0) {

268 
	`årštf
(
¡d”r
, "Failedo open device: %s", "KVS_ERR_DEV_INIT");

269 
	`ex™
(1);

271 
	`årštf
(
¡dout
, "O³ÀhªdË %ld w™h…©h %s\n", 
hªdË
, 
Œid
);

274 
i
 = 0; i < 
MAX_POOLSIZE
; i++) {

275 
kv_·œ
 *
kv
 = (kv_·œ*)
	`kv_z®loc
((kv_pair));

276 if(!
kv
) {

277 
	`årštf
(
¡d”r
, "Failedo‡llocate kv…air\n");

278 
	`ex™
(1);

280 
this
->
kv_·œ_poŞ
.
	`push
(
kv
);

283  
»t
;

284 
	}
}

287 
	gKUDDriv”
::
kv_udd_cÚ‹xt
* 
KUDDriv”
::
	$´•_io_cÚ‹xt
(
İcode
, 
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

289 
kv_udd_cÚ‹xt
 *
ùx
 = (kv_udd_cÚ‹xt*)
	`ÿÎoc
(1, (kv_udd_context));

291 
ùx
->
Ú_com¶‘e
 = 
cbâ
;

292 
ùx
->
iocb
.
İcode
 = opcode;

293 if(
key
) {

294 
ùx
->
iocb
.
key
 = (
kvs_key
*)key;

296 
ùx
->
iocb
.
key
 = 0;

299 
ùx
->
iocb
.
»suÉ
 = 
KVS_SUCCESS
;

300 if(
v®ue
) {

301 
ùx
->
iocb
.
v®ue
 = (
kvs_v®ue
*)value;

303 
ùx
->
iocb
.
v®ue
 = 0;

306 
ùx
->
iocb
.
´iv©e1
 =…rivate1;

307 
ùx
->
iocb
.
´iv©e2
 =…rivate2;

308 
ùx
->
owÃr
 = 
this
;

310  
ùx
;

312 
	}
}

315 
št32_t
 
	gKUDDriv”
::
	$¡Üe_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, cÚ¡ 
kvs_v®ue
 *
v®ue
, 
kvs_¡Üe_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

317 
»t
 = -
EINVAL
;

319 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_PUT_CMD
, 
cÚtid
, 
key
, 
v®ue
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

321 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

322 
kv_·œ
 *
kv
 = 
this
->
kv_·œ_poŞ
.
	`äÚt
();

323 
this
->
kv_·œ_poŞ
.
	`pİ
();

324 
lock
.
	`uÆock
();

325 if(!
kv
) {

326 
	`årštf
(
¡d”r
, "failedo‡llocate kv…airs\n");

327 
	`ex™
(1);

330 
İtiÚ_adi
;

331 if(!
İtiÚ
.
kvs_¡Üe_com´ess
) {

333 
İtiÚ
.
¡_ty³
) {

334 
KVS_STORE_POST
:

335 
İtiÚ_adi
 = 
KV_STORE_DEFAULT
;

337 
KVS_STORE_NOOVERWRITE
:

338 
İtiÚ_adi
 = 
KV_STORE_IDEMPOTENT
;

340 
KVS_STORE_APPEND
:

341 
KVS_STORE_UPDATE_ONLY
:

343 
	`årštf
(
¡d”r
, "WARN: Wrong store option\n");

344  
KVS_ERR_OPTION_INVALID
;

348 
İtiÚ
.
¡_ty³
) {

349 
KVS_STORE_POST
:

350 
İtiÚ_adi
 = 
KV_STORE_COMPRESSION
;

352 
KVS_STORE_UPDATE_ONLY
:

353 
KVS_STORE_NOOVERWRITE
:

354 
KVS_STORE_APPEND
:

356 
	`årštf
(
¡d”r
, "WARN: Wrong store option\n");

357  
KVS_ERR_OPTION_INVALID
;

361 
kv
->
key
.key = key->key;

362 
kv
->
key
.
Ëngth
 = key->length;

364 
kv
->
v®ue
.value = value->value;

365 
kv
->
v®ue
.
Ëngth
 = value->length;

366 
kv
->
v®ue
.
off£t
 = value->offset;

368 
kv
->
·¿m
.
async_cb
 = 
udd_wr™e_cb
;

369 
kv
->
·¿m
.
´iv©e_d©a
 = 
ùx
;

370 
kv
->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
 = 
İtiÚ_adi
;

372 if(
syncio
) {

373 
»t
 = 
	`kv_nvme_wr™e
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

374 
this
->
kv_·œ_poŞ
.
	`push
(
kv
);

375 
	`ä“
(
ùx
);

376 
ùx
 = 
NULL
;

378 if(
»t
 =ğ
KV_SUCCESS
) {

379 
»t
 = 
KVS_SUCCESS
;

380 } if(
»t
 =ğ
KV_ERR_INVALID_VALUE_SIZE
 ||„‘ =ğ
KV_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
) {

381 
»t
 = 
KVS_ERR_VALUE_LENGTH_INVALID
;

382 } ià(
»t
 =ğ
KV_ERR_INVALID_VALUE_OFFSET
) {

383 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

384 } ià(
»t
 =ğ
KV_ERR_INVALID_KEY_SIZE
) {

385 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

386 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_SIZE
) {

387 
»t
 = 
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

388 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_OFFSET
) {

389 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

390 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_KEY_SIZE
) {

391 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

392 } ià(
»t
 =ğ
KV_ERR_NOT_EXIST_KEY
) {

393 
»t
 = 
KVS_ERR_KEY_NOT_EXIST
;

394 } ià(
»t
 =ğ
KV_ERR_CAPACITY_EXCEEDED
) {

395 
»t
 = 
KVS_ERR_CONT_CAPACITY
;

396 } ià(
»t
 =ğ
KV_ERR_DD_INVALID_PARAM
) {

397 
»t
 = 
KVS_ERR_PARAM_INVALID
;

398 } ià(
»t
 =ğ
KV_ERR_DD_UNSUPPORTED_CMD
 ||„‘ =ğ
KV_ERR_INVALID_OPTION
){

399 
»t
 = 
KVS_ERR_OPTION_INVALID
;

400 } ià(
»t
 =ğ
KV_ERR_BUFFER
) {

401 
»t
 = 
KVS_ERR_BUFFER_SMALL
;

402 } ià(
»t
 =ğ
KV_ERR_IDEMPOTENT_STORE_FAIL
) {

403 
»t
 = 
KVS_ERR_KEY_EXIST
;

405 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü. key=% İtiÚ=%d v®ue.Ëngth=%d v®ue.off£t=%d stu codğ0x%x\n", 
__FUNCTION__
, (*)
key
->key, 
kv
->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
,kv->
v®ue
.
Ëngth
, kv->v®ue.
off£t
, 
»t
);

406 
»t
 = 
KVS_ERR_SYS_IO
;

409 
»t
) {

410 
»t
 = 
	`kv_nvme_wr™e_async
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

411 if(
»t
) {

412 
	`u¦“p
(1);

420  
»t
;

421 
	}
}

423 
št32_t
 
	gKUDDriv”
::
	$»Œ›ve_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
, 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

425 
»t
 = -
EINVAL
;

427 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_GET_CMD
, 
cÚtid
, 
key
, 
v®ue
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

429 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

430 
kv_·œ
 *
kv
 = 
this
->
kv_·œ_poŞ
.
	`äÚt
();

431 
this
->
kv_·œ_poŞ
.
	`pİ
();

432 
lock
.
	`uÆock
();

433 if(!
kv
) {

434 
	`årštf
(
¡d”r
, "failedo‡llocate kv…airs\n");

435 
	`ex™
(1);

438 
İtiÚ_adi
;

439 if(!
İtiÚ
.
kvs_»Œ›ve_d–‘e
) {

440 if(!
İtiÚ
.
kvs_»Œ›ve_decom´ess
)

441 
İtiÚ_adi
 = 
KV_RETRIEVE_DEFAULT
;

443 
İtiÚ_adi
 = 
KV_RETRIEVE_DECOMPRESSION
;

445  
KVS_ERR_OPTION_INVALID
;

448 
kv
->
key
.key = key->key;

449 
kv
->
key
.
Ëngth
 = key->length;

451 
kv
->
v®ue
.value = value->value;

452 
kv
->
v®ue
.
Ëngth
 = value->length;

453 
kv
->
v®ue
.
off£t
 = value->offset;

455 
kv
->
·¿m
.
io_İtiÚ
.
»Œ›ve_İtiÚ
 = 
İtiÚ_adi
;

456 
kv
->
·¿m
.
async_cb
 = 
udd_wr™e_cb
;

457 
kv
->
·¿m
.
´iv©e_d©a
 = 
ùx
;

459 if(
syncio
) {

460 
»t
 = 
	`kv_nvme_»ad
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

461 
v®ue
->
aùu®_v®ue_size
 = 
kv
->value.actual_value_size;

462 
this
->
kv_·œ_poŞ
.
	`push
(
kv
);

463 
	`ä“
(
ùx
);

464 
ùx
 = 
NULL
;

466 if(
»t
 =ğ
KV_SUCCESS
) {

467 
»t
 = 
KVS_SUCCESS
;

468 } if(
»t
 =ğ
KV_ERR_INVALID_VALUE_SIZE
 ||„‘ =ğ
KV_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
) {

469 
»t
 = 
KVS_ERR_VALUE_LENGTH_INVALID
;

470 } ià(
»t
 =ğ
KV_ERR_INVALID_VALUE_OFFSET
) {

471 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

472 } ià(
»t
 =ğ
KV_ERR_INVALID_KEY_SIZE
) {

473 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

474 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_SIZE
) {

475 
»t
 = 
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

476 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_OFFSET
) {

477 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

478 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_KEY_SIZE
) {

479 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

480 } ià(
»t
 =ğ
KV_ERR_NOT_EXIST_KEY
) {

481 
»t
 = 
KVS_ERR_KEY_NOT_EXIST
;

482 } ià(
»t
 =ğ
KV_ERR_CAPACITY_EXCEEDED
) {

483 
»t
 = 
KVS_ERR_CONT_CAPACITY
;

484 } ià(
»t
 =ğ
KV_ERR_DD_INVALID_PARAM
) {

485 
»t
 = 
KVS_ERR_PARAM_INVALID
;

486 } ià(
»t
 =ğ
KV_ERR_DD_UNSUPPORTED_CMD
 ||„‘ =ğ
KV_ERR_INVALID_OPTION
){

487 
»t
 = 
KVS_ERR_OPTION_INVALID
;

488 } ià(
»t
 =ğ
KV_ERR_BUFFER
) {

489 
»t
 = 
KVS_ERR_BUFFER_SMALL
;

491 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü. key=% İtiÚ=%d v®ue.Ëngth=%d v®ue.off£t=%d stu codğ0x%x\n", 
__FUNCTION__
, (*)
key
->key, 
kv
->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
,kv->
v®ue
.
Ëngth
, kv->v®ue.
off£t
, 
»t
);

492 
»t
 = 
KVS_ERR_SYS_IO
;

496 
»t
) {

497 
»t
 = 
	`kv_nvme_»ad_async
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

498 if(
»t
) {

499 
	`u¦“p
(1);

506  
»t
;

507 
	}
}

509 
št32_t
 
	gKUDDriv”
::
	$d–‘e_tu¶e
(
cÚtid
, cÚ¡ 
kvs_key
 *
key
, 
kvs_d–‘e_İtiÚ
 
İtiÚ
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

511 
»t
 = -
EINVAL
;

512 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_DEL_CMD
, 
cÚtid
, 
key
, 
NULL
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

514 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

515 
kv_·œ
 *
kv
 = 
this
->
kv_·œ_poŞ
.
	`äÚt
();

516 
this
->
kv_·œ_poŞ
.
	`pİ
();

517 
lock
.
	`uÆock
();

518 if(!
kv
) {

519 
	`årštf
(
¡d”r
, "failedo‡llocate kv…airs\n");

520 
	`ex™
(1);

523 
İtiÚ_adi
;

524 if(!
İtiÚ
.
kvs_d–‘e_”rÜ
)

525 
İtiÚ_adi
 = 
KV_DELETE_DEFAULT
;

527 
İtiÚ_adi
 = 
KV_DELETE_CHECK_IDEMPOTENT
;

529 
kv
->
key
.key = key->key;

530 
kv
->
key
.
Ëngth
 = key->length;

531 
kv
->
v®ue
.value = 0;

533 
kv
->
·¿m
.
io_İtiÚ
.
d–‘e_İtiÚ
 = 
İtiÚ_adi
;

534 
kv
->
·¿m
.
async_cb
 = 
udd_wr™e_cb
;

535 
kv
->
·¿m
.
´iv©e_d©a
 = 
ùx
;

537 if(
syncio
){

538 
»t
 = 
	`kv_nvme_d–‘e
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

539 
this
->
kv_·œ_poŞ
.
	`push
(
kv
);

540 
	`ä“
(
ùx
);

541 
ùx
 = 
NULL
;

543 if(
»t
 =ğ
KV_SUCCESS
) {

544 
»t
 = 
KVS_SUCCESS
;

545 } if(
»t
 =ğ
KV_ERR_INVALID_VALUE_SIZE
 ||„‘ =ğ
KV_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
) {

546 
»t
 = 
KVS_ERR_VALUE_LENGTH_INVALID
;

547 } ià(
»t
 =ğ
KV_ERR_INVALID_VALUE_OFFSET
) {

548 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

549 } ià(
»t
 =ğ
KV_ERR_INVALID_KEY_SIZE
) {

550 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

551 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_SIZE
) {

552 
»t
 = 
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

553 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_OFFSET
) {

554 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

555 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_KEY_SIZE
) {

556 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

557 } ià(
»t
 =ğ
KV_ERR_NOT_EXIST_KEY
) {

558 
»t
 = 
KVS_ERR_KEY_NOT_EXIST
;

559 } ià(
»t
 =ğ
KV_ERR_CAPACITY_EXCEEDED
) {

560 
»t
 = 
KVS_ERR_CONT_CAPACITY
;

561 } ià(
»t
 =ğ
KV_ERR_DD_INVALID_PARAM
) {

562 
»t
 = 
KVS_ERR_PARAM_INVALID
;

563 } ià(
»t
 =ğ
KV_ERR_DD_UNSUPPORTED_CMD
 ||„‘ =ğ
KV_ERR_INVALID_OPTION
){

564 
»t
 = 
KVS_ERR_OPTION_INVALID
;

565 } ià(
»t
 =ğ
KV_ERR_BUFFER
) {

566 
»t
 = 
KVS_ERR_BUFFER_SMALL
;

568 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü. key=% İtiÚ=%d v®ue.Ëngth=%d v®ue.off£t=%d stu codğ0x%x\n", 
__FUNCTION__
, (*)
key
->key, 
kv
->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
,kv->
v®ue
.
Ëngth
, kv->v®ue.
off£t
, 
»t
);

569 
»t
 = 
KVS_ERR_SYS_IO
;

573 
»t
){

574 
»t
 = 
	`kv_nvme_d–‘e_async
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

575 if(
»t
){

576 
	`u¦“p
(1);

583  
»t
;

584 
	}
}

586 
št32_t
 
	gKUDDriv”
::
	$exi¡_tu¶e
(
cÚtid
, 
ušt32_t
 
key_út
, cÚ¡ 
kvs_key
 *
keys
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
»suÉ_bufãr
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
 ) {

588 
»t
;

589 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_CHECK_KEY_EXIST_CMD
, 
cÚtid
, 
keys
, 
NULL
, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

590 
ùx
->
iocb
.
»suÉ_bufãr
 =„esult_buffer;

592 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
this
->
lock
);

593 
kv_·œ
 *
kv
 = 
this
->
kv_·œ_poŞ
.
	`äÚt
();

594 
this
->
kv_·œ_poŞ
.
	`pİ
();

595 
lock
.
	`uÆock
();

596 if(!
kv
) {

597 
	`årštf
(
¡d”r
, "failedo‡llocate kv…airs\n");

598 
	`ex™
(1);

601 
kv
->
key
.key = 
keys
->key;

602 
kv
->
key
.
Ëngth
 = 
keys
->length;

604 
kv
->
·¿m
.
io_İtiÚ
.
exi¡_İtiÚ
 = 
KV_EXIST_DEFAULT
;

605 
kv
->
·¿m
.
async_cb
 = 
udd_wr™e_cb
;

606 
kv
->
·¿m
.
´iv©e_d©a
 = 
ùx
;

608 if(
syncio
) {

609 
»t
 = 
	`kv_nvme_exi¡
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

610 if(
»t
 =ğ
KV_SUCCESS
) {

611 *
»suÉ_bufãr
 = 1;

612 
»t
 = 
KVS_SUCCESS
;

613 } if(
»t
 =ğ
KV_ERR_INVALID_VALUE_SIZE
 ||„‘ =ğ
KV_ERR_MAXIMUM_VALUE_SIZE_LIMIT_EXCEEDED
) {

614 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_VALUE_LENGTH_INVALID
;

615 } ià(
»t
 =ğ
KV_ERR_INVALID_VALUE_OFFSET
) {

616 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

617 } ià(
»t
 =ğ
KV_ERR_INVALID_KEY_SIZE
) {

618 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

619 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_SIZE
) {

620 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_VALUE_LENGTH_MISALIGNED
;

621 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_VALUE_OFFSET
) {

622 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_VALUE_OFFSET_INVALID
;

623 } ià(
»t
 =ğ
KV_ERR_MISALIGNED_KEY_SIZE
) {

624 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_KEY_LENGTH_INVALID
;

625 } ià(
»t
 =ğ
KV_ERR_NOT_EXIST_KEY
) {

626 *
»suÉ_bufãr
 = 0;

627 
»t
 = 
KVS_SUCCESS
;

628 } ià(
»t
 =ğ
KV_ERR_CAPACITY_EXCEEDED
) {

629 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_CONT_CAPACITY
;

630 } ià(
»t
 =ğ
KV_ERR_DD_INVALID_PARAM
) {

631 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_PARAM_INVALID
;

632 } ià(
»t
 =ğ
KV_ERR_DD_UNSUPPORTED_CMD
 ||„‘ =ğ
KV_ERR_INVALID_OPTION
){

633 *
»suÉ_bufãr
 = 
KVS_ERR_OPTION_INVALID
;

634 } ià(
»t
 =ğ
KV_ERR_BUFFER
) {

635 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_BUFFER_SMALL
;

637 
	`årštf
(
¡d”r
, "[%s]ƒ¼Ü. key=% İtiÚ=%d v®ue.Ëngth=%d v®ue.off£t=%d stu codğ0x%x\n", 
__FUNCTION__
, (*)
keys
->
key
, 
kv
->
·¿m
.
io_İtiÚ
.
¡Üe_İtiÚ
,kv->
v®ue
.
Ëngth
, kv->v®ue.
off£t
, 
»t
);

638 *
»suÉ_bufãr
 = 
»t
 = 
KVS_ERR_SYS_IO
;

641 
this
->
kv_·œ_poŞ
.
	`push
(
kv
);

642 
	`ä“
(
ùx
);

643 
ùx
 = 
NULL
;

645 
»t
 = 
	`kv_nvme_exi¡_async
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
kv
);

646 if(
»t
 =ğ
KV_ERR_NOT_EXIST_KEY
) {

647 *
»suÉ_bufãr
 = 
KVS_ERR_KEY_NOT_EXIST
;

648 
»t
 = 
KVS_SUCCESS
;

651 *
»suÉ_bufãr
 = 
»t
;

654  
»t
;

655 
	}
}

657 
št32_t
 
	gKUDDriv”
::
	$İ’_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_İtiÚ
 
İtiÚ
, 
ušt32_t
 
b™mask
,

658 
ušt32_t
 
b™_·‰”n
, 
kvs_™”©Ü_hªdË
 *
™”_hd
) {

660 
»t
 = 0;

662 
ušt8_t
 
İtiÚ_udd
;

664 if(
İtiÚ
.
™”_ty³
 =ğ
KVS_ITERATOR_KEY
)

665 
İtiÚ_udd
 = 
KV_KEY_ITERATE
;

667 
İtiÚ_udd
 = 
KV_KEY_ITERATE_WITH_RETRIEVE
;

669 
Ä_™”©e_hªdË
 = 
KV_MAX_ITERATE_HANDLE
;

670 
İ’ed
 = 0;

671 
kv_™”©e_hªdË_šfo
 
šfo
[
KV_MAX_ITERATE_HANDLE
];

672 
»t
 = 
	`kv_nvme_™”©e_šfo
(
hªdË
, 
šfo
, 
Ä_™”©e_hªdË
);

673 ià(
»t
 =ğ
KV_SUCCESS
) {

674 
i
=0;i<
Ä_™”©e_hªdË
;i++){

675 if(
šfo
[
i
].
¡©us
 =ğ
ITERATE_HANDLE_OPENED
){

676 
İ’ed
++;

677 if(
šfo
[
i
].
b™mask
 =ğb™mask && info[i].
´efix
 =ğ
b™_·‰”n
) {

679 
	`årštf
(
¡dout
, "WARN: Iterator with same…refix/bitmask is‡lready opened\n");

680  
KVS_ERR_ITERATOR_OPEN
;

688 if(
İ’ed
 =ğ
KV_MAX_ITERATE_HANDLE
)

689  
KVS_ERR_ITERATOR_MAX
;

691 
ušt32_t
 
™”©Ü
 = 
KV_INVALID_ITERATE_HANDLE
;

692 
™”©Ü
 = 
	`kv_nvme_™”©e_İ’
(
hªdË
, 
KV_KEYSPACE_IODATA
, 
b™mask
, 
b™_·‰”n
, 
İtiÚ_udd
);

694 if(
™”©Ü
 !ğ
KV_INVALID_ITERATE_HANDLE
){

695 if(
™”©Ü
 =ğ
KV_ERR_ITERATE_HANDLE_ALREADY_OPENED
)

696 
»t
 = 
KVS_ERR_ITERATOR_OPEN
;

697 ià(
™”©Ü
 =ğ
KV_ERR_ITERATE_NO_AVAILABLE_HANDLE
)

698 
»t
 = 
KVS_ERR_ITERATOR_MAX
;

700 
	`årštf
(
¡dout
, "I‹¿‹_O³ÀSucûss: i‹¿tÜ id=0x%x\n", 
™”©Ü
);

701 
»t
 = 0;

706 *
™”_hd
 = 
™”©Ü
;

708 
»t
 = 
KVS_ERR_ITERATE_REQUEST_FAIL
;

710  
»t
;

711 
	}
}

713 
št32_t
 
	gKUDDriv”
::
	$şo£_™”©Ü
(
cÚtid
, 
kvs_™”©Ü_hªdË
 
h™”
) {

715 
»t
 = 0;

717 if(
h™”
 > 0)

718 
»t
 = 
	`kv_nvme_™”©e_şo£
(
hªdË
, 
h™”
 );

720 if(
»t
 !ğ
KV_SUCCESS
) {

721 if(
»t
 =ğ
KV_ERR_ITERATE_FAIL_TO_PROCESS_REQUEST
) {

722 
»t
 = 
KVS_ERR_ITERATOR_NOT_EXIST
;

724 
»t
 = 
KVS_ERR_SYS_IO
;

728  
»t
;

729 
	}
}

732 
št32_t
 
	gKUDDriv”
::
	$şo£_™”©Ü_®l
(
cÚtid
) {

733 
»t
;

734 
Ä_™”©e_hªdË
 = 
KV_MAX_ITERATE_HANDLE
;

735 
kv_™”©e_hªdË_šfo
 
šfo
[
KV_MAX_ITERATE_HANDLE
];

736 
»t
 = 
	`kv_nvme_™”©e_šfo
(
hªdË
, 
šfo
, 
Ä_™”©e_hªdË
);

737 ià(
»t
 =ğ
KV_SUCCESS
) {

738 
i
=0;i<
Ä_™”©e_hªdË
;i++){

739 if(
šfo
[
i
].
¡©us
 =ğ
ITERATE_HANDLE_OPENED
){

740 
	`kv_nvme_™”©e_şo£
(
hªdË
, 
šfo
[
i
].
hªdË_id
);

741 
	`årštf
(
¡dout
, "Clo£ i‹¹Ü %d\n", 
šfo
[
i
].
hªdË_id
);

745  
KVS_SUCCESS
;

746 
	}
}

748 
št32_t
 
	gKUDDriv”
::
	$li¡_™”©Üs
(
cÚtid
, 
kvs_™”©Ü_šfo
 *
kvs_™”s
, 
ušt32_t
 
couÁ
) {

753 
»t
 = 
	`kv_nvme_™”©e_šfo
(
hªdË
, (
kv_™”©e_hªdË_šfo
*)
kvs_™”s
, 
couÁ
);

755 if(
»t
 =ğ
KV_ERR_DD_INVALID_PARAM
)

756 
»t
 = 
KVS_ERR_PARAM_INVALID
;

758  
»t
;

759 
	}
}

761 
št32_t
 
	gKUDDriv”
::
	$™”©Ü_Ãxt
(
kvs_™”©Ü_hªdË
 
h™”
, 
kvs_™”©Ü_li¡
 *
™”_li¡
, *
´iv©e1
, *
´iv©e2
, 
boŞ
 
syncio
, 
kvs_ÿÎback_funùiÚ
 
cbâ
) {

763 
»t
 = -
EINVAL
;

765 autØ
ùx
 = 
	`´•_io_cÚ‹xt
(
IOCB_ASYNC_ITER_NEXT_CMD
, 0, 0, 0, 
´iv©e1
, 
´iv©e2
, 
syncio
, 
cbâ
);

767 
ùx
->
™”_li¡
 = iter_list;

769 
kv_™”©e
 *
™
 = (kv_™”©*)
	`kv_z®loc
((kv_iterate));

770 if(!
™
) {

771  -
ENOMEM
;

774 
™
->
™”©Ü
 = 
h™”
;

775 
™
->
kv
.
key
.
Ëngth
 = 0;

776 
™
->
kv
.
key
.key = 
NULL
;

777 
™
->
kv
.
v®ue
.v®uğ
™”_li¡
->
™_li¡
;

778 
™
->
kv
.
v®ue
.
Ëngth
 = 
™”_li¡
->
size
;

779 
™
->
kv
.
v®ue
.
off£t
 = 0;

781 
™
->
kv
.
·¿m
.
async_cb
 = 
udd_™”©e_cb
;

782 
™
->
kv
.
·¿m
.
´iv©e_d©a
 = 
ùx
;

783 
™
->
kv
.
·¿m
.
io_İtiÚ
.
™”©e_»ad_İtiÚ
 = 
KV_ITERATE_READ_DEFAULT
;

784 ià(
syncio
) {

785 
»t
 = 
	`kv_nvme_™”©e_»ad
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
™
);

787 if(
»t
 !ğ
KV_SUCCESS
) {

788 if(
»t
 =ğ
KV_ERR_ITERATE_READ_EOF
 ) {

789 
™”_li¡
->
’d
 = 0x01;

790 
»t
 = 0;

791 } ià(
»t
 =ğ
KV_ERR_ITERATE_FAIL_TO_PROCESS_REQUEST
) {

792 
»t
 = 
KVS_ERR_ITERATOR_NOT_EXIST
;

793 } ià(
»t
 =ğ
KV_ERR_BUFFER
) {

794 
»t
 = 
KVS_ERR_BUFFER_SMALL
;

795 } ià(
»t
 =ğ
KV_ERR_INVALID_OPTION
) {

796 
»t
 = 
KVS_ERR_OPTION_INVALID
;

798 
»t
 = 
KVS_ERR_SYS_IO
;

802 if(
»t
 =ğ
KV_SUCCESS
) {

805 
ušt32_t
 
num_key
 = *((*)
™
->
kv
.
v®ue
.value);

806 
™”_li¡
->
num_’Œ›s
 = 
num_key
;

808 *
d©a_buff
 = (*)
™
->
kv
.
v®ue
.value;

809 
bufãr_size
 = 
™
->
kv
.
v®ue
.
Ëngth
;

810 *
cu¼’t_±r
 = 
d©a_buff
;

812 
key_size
 = 0;

813 
keyd©a_Ën_w™h_·ddšg
 = 0;

814 
buffd©a_Ën
 = 
bufãr_size
;

816 
buffd©a_Ën
 -ğ
KV_IT_READ_BUFFER_META_LEN
;

817 
d©a_buff
 +ğ
KV_IT_READ_BUFFER_META_LEN
;

818 
ušt32_t
 
i
 = 0; i < 
num_key
 && 
buffd©a_Ën
 > 0; i++) {

819 ià(
buffd©a_Ën
 < 
KV_IT_READ_BUFFER_META_LEN
) {

820 
»t
 = 
KVS_ERR_SYS_IO
;

825 
	`memmove
(
cu¼’t_±r
, 
d©a_buff
, 
KV_IT_READ_BUFFER_META_LEN
);

826 
cu¼’t_±r
 +ğ
KV_IT_READ_BUFFER_META_LEN
;

829 
key_size
 = *((
ušt32_t
 *)
d©a_buff
);

830 
buffd©a_Ën
 -ğ
KV_IT_READ_BUFFER_META_LEN
;

831 
d©a_buff
 +ğ
KV_IT_READ_BUFFER_META_LEN
;

833 ià(
key_size
 > 
buffd©a_Ën
) {

834 
»t
 = 
KVS_ERR_SYS_IO
;

837 ià(
key_size
 >= 256) {

838 
»t
 = 
KVS_ERR_SYS_IO
;

843 
	`memmove
(
cu¼’t_±r
, 
d©a_buff
, 
key_size
);

844 
cu¼’t_±r
 +ğ
key_size
;

847 
keyd©a_Ën_w™h_·ddšg
 = (((
key_size
 + 3) >> 2) << 2);

850 
buffd©a_Ën
 -ğ
keyd©a_Ën_w™h_·ddšg
;

851 
d©a_buff
 +ğ
keyd©a_Ën_w™h_·ddšg
;

864 
™”_li¡
->
™_li¡
 = 
™
->
kv
.
v®ue
.value;

865 
™”_li¡
->
size
 = 
™
->
kv
.
v®ue
.
Ëngth
;

867 ià(
™
) {

868 
	`kv_ä“
(
™
);

869 
™
 = 
NULL
;

871 if(
ùx
) {

872 
	`ä“
(
ùx
);

873 
ùx
 = 
NULL
;

876 
»t
) {

877 
»t
 = 
	`kv_nvme_™”©e_»ad_async
(
hªdË
, 
DEFAULT_IO_QUEUE_ID
, 
™
);

878 if(
»t
) {

879 
	`u¦“p
(1);

886  
»t
;

887 
	}
}

889 
	gKUDDriv”
::
	$g‘_waf
(){

891  ()
	`kv_nvme_g‘_waf
(
hªdË
) / 10;

892 
	}
}

894 
št32_t
 
	gKUDDriv”
::
	$g‘_deviû_šfo
(
kvs_deviû
 *
dev_šfo
) {

896 
	}
}

898 
št32_t
 
	gKUDDriv”
::
	$g‘_u£d_size
(
št32_t
 *
dev_ut
){

900 *
dev_ut
 = 
	`kv_nvme_g‘_u£d_size
(
hªdË
);

902 
	}
}

904 
št32_t
 
	gKUDDriv”
::
	$g‘_tÙ®_size
(
št64_t
 *
dev_ÿ·
){

906 *
dev_ÿ·
 = 
	`kv_nvme_g‘_tÙ®_size
(
hªdË
);

908 
	}
}

910 
št32_t
 
	gKUDDriv”
::
	$´oûss_com¶‘iÚs
(
max
)

914 
	}
}

917 
	gKUDDriv”
::~
	$KUDDriv”
() {

918 
»t
;

920 
»t
 = 
	`kv_nvme_şo£
(
hªdË
);

921 if(
»t
){

922 
	`årštf
(
¡d”r
, "FaedØşo£‚vme,„‘ %d\n", 
»t
);

924 
»t
 = 
	`kv_nvme_fš®ize
(
Œid
);

926 !
this
->
kv_·œ_poŞ
.
	`em±y
()) {

927 autØ
p
 = 
this
->
kv_·œ_poŞ
.
	`äÚt
();

928 
this
->
kv_·œ_poŞ
.
	`pİ
();

929 
	`kv_ä“
(
p
);

939 
	}
}

	@PDK/core/src/api/src/kvsdevice.cpp

35 
	~"´iv©e_ty³s.h
"

36 
	~"kvs_uts.h
"

38 
št32_t
 
	gKvsDriv”
::
	$š™
() {

39 
cursock‘
, 
curcÜe
;

40 
	`g‘_curıu
(&
cursock‘
, &
curcÜe
);

43  
	`š™
();

44 
	}
}

46 *
	gKvsDriv”
::
İ”©Ü
 
	$Ãw
(
¡d
::
size_t
 
sz
) {

47  
	`numa_®igÃd_®loc
(-1, 4096, 
sz
);

48 
	}
}

50 
	gKvsDriv”
::
İ”©Ü
 
	$d–‘e
(*
p
) {

51  
	`numa_®igÃd_ä“
(
p
);

52 
	}
}

54 
	gkv_deviû_´iv
::~
	$kv_deviû_´iv
() {

56 
	}
}

	@PDK/core/src/api/src/uddenv.cpp

35 
	~<kvs_­i.h
>

36 
	~<kvs_uts.h
>

37 
	~<s¡»am
>

38 
	~<s¡»am
>

39 
	~<´iv©e/udd’v.h
>

40 
	~<´iv©e/kvs_uts.h
>

41 
	~<´iv©e/´iv©e_ty³s.h
>

42 
	~<kvnvme.h
>

44 
	#ATTACH_ALL


	)

46 
	$š™_udd
(
kvs_š™_İtiÚs
 *
İtiÚs
) {

48 
	`kv_’v_š™
(1024);

50  
KVS_SUCCESS
;

51 
	}
}

53 *
	$_udd_z®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
) {

54  
	`kv_z®loc
(
size_by‹s
);

55 
	}
}

57 *
	$_udd_m®loc
(
size_t
 
size_by‹s
, size_ˆ
®ignm’t
) {

58  
	`kv_z®loc
(
size_by‹s
);

59 
	}
}

61 
	$_udd_ä“
(* 
buf
)

63 
	`kv_ä“
(
buf
);

64 
	}
}

	@PDK/core/src/device_abstract_layer/emulator/src/io_cmd.cpp

34 
	~<ùime
>

35 
	~<chrÚo
>

36 
	~<th»ad
>

38 
	~"kvs_uts.h
"

39 
	~"kv_cÚfig.hµ
"

41 
	~"io_cmd.hµ
"

42 
	~"kv_deviû.hµ
"

43 
	~"kv_Çme¥aû.hµ
"

45 
Çme¥aû
 
	gkvadi
 {

49 
	gio_cmd
::
io_cmd
(
kv_deviû_š‹º®
 *
dev
, 
kv_Çme¥aû_š‹º®
 *
ns
, 
kv_queue_hªdË
 
que_hdl
) {

51 
	gm_th»ad_id
 = 
¡d
::
this_th»ad
::
g‘_id
();

53 
	gm_dev
 = 
dev
;

54 
	gm_ns
 = 
ns
;

55 
	gm_cmd_id
 = 0;

58 
ioqueue
 *
	gque
 = (ioqueu*)
que_hdl
->
queue
;

59 
	gm_que
 = 
que
;

61 
	gm_sqid
 = 
que
->
g‘_qid
();

67 
	gio_cmd
::
£t_»tcode
(
kv_»suÉ
 
cu¼’t_»suÉ
) {

68 
ioùx
.
»tcode
 = 
cu¼’t_»suÉ
;

71 cÚ¡ 
kv_key
* 
	gio_cmd
::
g‘_key
() {

72  
ioùx
.
key
;

74 cÚ¡ 
kv_v®ue
* 
	gio_cmd
::
g‘_v®ue
() {

75  
ioùx
.
v®ue
;

78 
ušt16_t
 
	gio_cmd
::
g‘_sqid
() {

79  
m_sqid
;

85 
	gio_cmd
::
£t_sqid
(
ušt16_t
 
sqid
) {

86 
m_sqid
 = 
sqid
;

93 
ioqueue
 *
	gio_cmd
::
g‘_queue
() {

94  
m_que
;

99 
	gio_cmd
::
ÿÎ_po¡_´oûss_func
() {

100 ià(
ioùx
.
po¡_â
 !ğ
NULL
) {

101 
ioùx
.
po¡_â
((
kv_io_cÚ‹xt
 *)&
this
->ioctx);

109 
kv_»suÉ
 
	gio_cmd
::
execu‹_cmd
() {

111 
kv_Çme¥aû_š‹º®
 *
ns
 = 
m_ns
;

113 
	gioùx
.
	gİcode
) {

114 
	gKV_OPC_GET
: {

116 
İ_g‘_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
g‘_šfo
;

117 
	gioùx
.
	g»tcode
 = 
ns
->
kv_»Œ›ve
(
ioùx
.
key
, 
šfo
.
İtiÚ
, ioùx.
v®ue
, (*è
this
);

121 
	gKV_OPC_STORE
: {

122 
ušt32_t
 
cÚsumed_by‹s
 = 0;

123 
İ_¡Üe_¡ruù_t
 
	gšfo
 = 
ioùx
.
commªd
.
¡Üe_šfo
;

124 
	gioùx
.
	g»tcode
 = 
ns
->
kv_¡Üe
(
ioùx
.
key
, ioùx.
v®ue
, 
šfo
.
İtiÚ
, &
cÚsumed_by‹s
, (*è
this
);

133 
	gKV_OPC_DELETE
: {

134 
ušt32_t
 
»şaimed_by‹s
 = 0;

135 
İ_d–‘e_¡ruù_t
 
	gšfo
 = 
ioùx
.
commªd
.
d–‘e_šfo
;

136 
	gioùx
.
	g»tcode
 = 
ns
->
kv_d–‘e
(
ioùx
.
key
, 
šfo
.
İtiÚ
, &
»şaimed_by‹s
, (*è
this
);

141 
	gKV_OPC_DELETE_GROUP
: {

142 
ušt64_t
 
»şaimed_by‹s
 = 0;

143 
İ_d–‘e_group_¡ruù_t
 
	gšfo
 = 
ioùx
.
commªd
.
d–‘e_group_šfo
;

144 
	gioùx
.
	g»tcode
 = 
ns
->
kv_d–‘e_group
(
šfo
.
g½_cÚd
, &
»şaimed_by‹s
, (*è
this
);

148 
	gKV_OPC_PURGE
: {

149 
İ_purge_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
purge_šfo
;

150 
	gioùx
.
	g»tcode
 = 
ns
->
kv_purge
(
šfo
.
İtiÚ
, (*è
this
);

154 
	gKV_OPC_CHECK_KEY_EXIST
: {

155 
İ_key_exi¡_¡ruù_t
 &
šfo
 = 
ioùx
.
commªd
.
key_exi¡_šfo
;

156 
	gioùx
.
	g»tcode
 = 
ns
->
kv_exi¡
(
ioùx
.
key
, 
šfo
.
keycouÁ
, info.
»suÉ
, info.
»suÉ_size
, (*è
this
);

157 
	gioùx
.
	g»suÉ
.
	gbufãr_size
 = 
šfo
.
»suÉ_size
;

158 
	gioùx
.
	g»suÉ
.
	gbufãr_couÁ
 = 
šfo
.
keycouÁ
;

162 
	gKV_OPC_OPEN_ITERATOR
: {

163 
İ_™”©Ü_İ’_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
™”©Ü_İ’_šfo
;

164 
	gioùx
.
	g»tcode
 = 
ns
->
kv_İ’_™”©Ü
(
šfo
.
™_İ
, &šfo.
™_cÚd
, &
ioùx
.
»suÉ
.
h™”
, (*è
this
);

168 
	gKV_OPC_CLOSE_ITERATOR
: {

169 
İ_şo£_™”©Ü_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
™”©Ü_şo£_šfo
;

170 
	gioùx
.
	g»tcode
 = 
ns
->
kv_şo£_™”©Ü
(
šfo
.
™”_hdl
, (*è
this
);

171 
	gioùx
.
	g»suÉ
.
	gh™”
 = 0;

175 
	gKV_OPC_ITERATE_NEXT
: {

176 
İ_™”©Ü_Ãxt_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
™”©Ü_Ãxt_šfo
;

177 
	gioùx
.
	g»tcode
 = 
ns
->
kv_™”©Ü_Ãxt_£t
(
šfo
.
™”_hdl
, info.
™”_li¡
, (*è
this
);

181 
	gKV_OPC_ITERATE_NEXT_SINGLE_KV
: {

182 
İ_™”©Ü_Ãxt_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
™”©Ü_Ãxt_šfo
;

183 
	gioùx
.
	g»tcode
 = 
ns
->
kv_™”©Ü_Ãxt
(
šfo
.
™”_hdl
, info.
key
, info.
v®ue
, (*è
this
);

187 
	gKV_OPC_SANITIZE_DEVICE
: {

190 
ioùx
.
»tcode
 = 
ns
->
kv_purge
(
KV_PURGE_OPT_DEFAULT
, (*è
this
);

194 
	gKV_OPC_LIST_ITERATOR
: {

195 
İ_li¡_™”©Ü_¡ruù_t
 
šfo
 = 
ioùx
.
commªd
.
™”©Ü_li¡_šfo
;

196 
	gioùx
.
	g»tcode
 = 
ns
->
kv_li¡_™”©Üs
(
šfo
.
kv_™”s
, info.
™”_út
, (*è
this
);

201 
WRITE_WARN
("OPCODE %d‚Ù„ecognized", 
ioùx
.
İcode
);

202 
	gioùx
.
	g»tcode
 = 
KV_ERR_SYS_IO
;

212  
	gioùx
.
	g»tcode
;

	@PDK/core/src/device_abstract_layer/emulator/src/kv_config.cpp

34 
	~<¡ršg
>

35 
	~<f¡»am
>

36 
	~"kvs_adi.h
"

37 
	~"kvs_adi_š‹º®.h
"

38 
	~"kv_cÚfig.hµ
"

40 
Çme¥aû
 
	gkvadi
 {

42 cÚ¡ 
	g¡d
::
¡ršg
 
kv_cÚfig
::
m—n_£ùiÚ_Çme
 = "latency";

43 cÚ¡ 
	g¡d
::
¡ršg
 
kv_cÚfig
::
¡dev_£ùiÚ_Çme
 = "latency";

48 
ušt32_t
 
	gkv_cÚfig
::
g’”©e_§m¶e_Ï‹ncy
(
ušt16_t
 
İcode
) {

50 
ušt32_t
 
m—n_Ï‹ncy
 = 
g‘_m—n_Ï‹ncy
(
İcode
);

51 
ušt32_t
 
	g¡dev_Ï‹ncy
 = 
g‘_¡dev_Ï‹ncy
(
İcode
);

54 ià(
	gm—n_Ï‹ncy
 == 0) {

59 
	g¡d
::
nÜm®_di¡ributiÚ
<> 
di¡ributiÚ
(
m—n_Ï‹ncy
, 
¡dev_Ï‹ncy
);

61 
ušt32_t
 
	gÇno£c
 = ušt32_t(
di¡ributiÚ
(
m_g’”©Ü
));

65 
ušt32_t
 
	glow”_bound
 = ušt32_t(
m—n_Ï‹ncy
 - 
¡dev_Ï‹ncy
 *.5);

66 ià(
	glow”_bound
 < 0) {

67 
	glow”_bound
 = 0;

69 
ušt32_t
 
	guµ”_bound
 = ušt32_t(
m—n_Ï‹ncy
 + 
¡dev_Ï‹ncy
 *.5);

71 ià(
	gÇno£c
 < 
	glow”_bound
) {

72 
	gÇno£c
 = 
low”_bound
;

73 } ià(
	gÇno£c
 > 
	guµ”_bound
) {

74 
	gÇno£c
 = 
uµ”_bound
;

77  
	gÇno£c
;

80 
	g¡d
::
¡ršg
 
kv_cÚfig
::
g‘kv
(
¡d
::¡ršg cÚ¡& 
£ùiÚ
, std::¡ršg cÚ¡& 
key
) const {

81 
¡d
::
unÜd”ed_m­
<¡d::
¡ršg
, 
	g¡d
::¡ršg>::
cÚ¡_™”©Ü
 
™
 = 
m_cÚfig_kv
.
fšd
(
£ùiÚ
 + '/' + 
key
);

82 ià(
	g™
 =ğ
m_cÚfig_kv
.
’d
()) {

86  
	g™
->
	g£cÚd
;

89 
	g¡d
::
¡ršg
 
İcode_to_¡ršg
(
ušt16_t
 
İcode
) {

90 
¡d
::
¡ršg
 
¡r
("");

91 
	gİcode
) {

92 
	gKV_OPC_GET
:

93 
¡r
 = "GET";

95 
	gKV_OPC_STORE
:

96 
¡r
 = "STORE";

98 
	gKV_OPC_DELETE
:

99 
¡r
 = "DELETE";

101 
	gKV_OPC_PURGE
:

102 
¡r
 = "PURGE";

104 
	gKV_OPC_CHECK_KEY_EXIST
:

105 
¡r
 = "CHECK_KEY_EXIST";

107 
	gKV_OPC_OPEN_ITERATOR
:

108 
¡r
 = "OPEN_ITERATOR";

110 
	gKV_OPC_CLOSE_ITERATOR
:

111 
¡r
 = "CLOSE_ITERATOR";

113 
	gKV_OPC_ITERATE_NEXT
:

114 
¡r
 = "ITERATE_NEXT";

116 
	gKV_OPC_SANITIZE_DEVICE
:

117 
¡r
 = "SANITIZE_DEVICE";

120  
	g¡r
;

125 
ušt32_t
 
	gkv_cÚfig
::
g‘_m—n_Ï‹ncy
(
ušt16_t
 
İcode
) {

126 
¡d
::
¡ršg
 
keyÇme
 = 
İcode_to_¡ršg
(
İcode
);

127 autØ
	g™
 = 
m_cÚfig_kv
.
fšd
(
kv_cÚfig
::
m—n_£ùiÚ_Çme
 + "/" + 
keyÇme
 + ".mean");

129 
	g¡d
::
¡ršg
 
Ï‹ncy
 = "0";

130 ià(
	g™
 !ğ
m_cÚfig_kv
.
’d
()) {

131 
Ï‹ncy
 = 
™
->
£cÚd
;

133  
	g¡d
::
¡oi
(
Ï‹ncy
, 
NULL
, 10);

137 
ušt32_t
 
	gkv_cÚfig
::
g‘_¡dev_Ï‹ncy
(
ušt16_t
 
İcode
) {

139 
¡d
::
¡ršg
 
keyÇme
 = 
İcode_to_¡ršg
(
İcode
);

140 autØ
	g™
 = 
m_cÚfig_kv
.
fšd
(
kv_cÚfig
::
¡dev_£ùiÚ_Çme
 + "/" + 
keyÇme
 + ".stdev");

142 
	g¡d
::
¡ršg
 
Ï‹ncy
 = "0";

143 ià(
	g™
 !ğ
m_cÚfig_kv
.
’d
()) {

144 
Ï‹ncy
 = 
™
->
£cÚd
;

146  
	g¡d
::
¡oi
(
Ï‹ncy
, 
NULL
, 10);

151 
	g¡d
::
¡ršg
 
kv_cÚfig
::
Œim
(
¡d
::¡ršg cÚ¡& 
sourû
, cÚ¡* 
d–ims
 = " \t\r\n") {

153 
¡d
::
¡ršg
 
»suÉ
(
sourû
);

154 
	g¡d
::
¡ršg
::
size_ty³
 
šdex
 = 
»suÉ
.
fšd_Ï¡_nÙ_of
(
d–ims
);

155 if(
	gšdex
 !ğ
¡d
::
¡ršg
::
Åos
)

156 
»suÉ
.
”a£
(++
šdex
);

158 
	gšdex
 = 
»suÉ
.
fšd_fœ¡_nÙ_of
(
d–ims
);

159 if(
	gšdex
 !ğ
¡d
::
¡ršg
::
Åos
)

160 
»suÉ
.
”a£
(0, 
šdex
);

162 
	g»suÉ
.
”a£
();

163  
	g»suÉ
;

166 
	gkv_cÚfig
::
kv_cÚfig
(cÚ¡ 
¡d
::
¡ršg
 
cÚfigfe
) {

167 
lßd_cÚfig
(
cÚfigfe
);

170 
boŞ_t
 
	gkv_cÚfig
::
lßd_cÚfig
(cÚ¡ 
¡d
::
¡ršg
 
cÚfigfe
) {

173 
¡d
::
if¡»am
 
fe
(
cÚfigfe
.
c_¡r
());

175 
	g¡d
::
¡ršg
 
lše
;

176 
	g¡d
::
¡ršg
 
key
;

177 
	g¡d
::
¡ršg
 
v®ue
;

178 
	g¡d
::
¡ršg
 
£ùiÚ_Çme
;

179 
	gequ®_pos
;

181 
	g¡d
::
g‘lše
(
fe
,
lše
)) {

182 
	glše
 = 
Œim
(
lše
);

183 ià(! 
	glše
.
Ëngth
()) ;

184 ià(
	glše
[0] == '#') ;

185 ià(
	glše
[0] == ';') ;

187 ià(
	glše
[0] == '[') {

188 
£ùiÚ_Çme
 = 
Œim
(
lše
.
sub¡r
(1,lše.
fšd
(']')-1));

192 
	gequ®_pos
 = 
lše
.
fšd
('=');

193 
	gkey
 = 
Œim
(
lše
.
sub¡r
(0, 
equ®_pos
));

194 
	gv®ue
 = 
Œim
(
lše
.
sub¡r
(
equ®_pos
 + 1));

197 
	gm_cÚfig_kv
.
š£¹
(
¡d
::
make_·œ
(
£ùiÚ_Çme
 + "/" + 
key
, 
v®ue
));

200  
	gTRUE
;

	@PDK/core/src/device_abstract_layer/emulator/src/kv_device.cpp

34 
	~<futu»
>

35 
	~<th»ad
>

36 
	~<¡ršg
>

37 
	~<®gÜ™hm
>

39 
	~"kvs_adi.h
"

40 
	~"kvs_adi_š‹º®.h
"

42 
	~"queue.hµ
"

43 
	~"kv_deviû.hµ
"

45 
Çme¥aû
 
	gkvadi
 {

47 cÚ¡ 
	g¡d
::
¡ršg
 
kv_deviû_š‹º®
::
cÚfigfe
 = "./kvssd_emul.conf";

50 
	g¡d
::
»cursive_mu‹x
 
kv_deviû_š‹º®
::
s_mu‹x
;

51 
ušt32_t
 
	gkv_deviû_š‹º®
::
s_Ãxt_devid
 = 1;

52 
	g¡d
::
unÜd”ed_m­
<
ušt32_t
, 
	gkv_deviû_š‹º®
 *> kv_deviû_š‹º®::
s_glob®_deviû_li¡
;

54 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
g‘_š™_¡©us
() {

55  
m_š™_¡©us
;

57 
	gkv_deviû_š‹º®
::
£t_š™_¡©us
(
kv_»suÉ
 
»suÉ
) {

58 
m_š™_¡©us
 = 
»suÉ
;

61 
ušt64_t
 
	gkv_deviû_š‹º®
::
g‘_ÿ·c™y
() {

62  
m_ÿ·c™y
;

65 
ušt64_t
 
	gkv_deviû_š‹º®
::
g‘_avaabË
() {

66  
g‘_Çme¥aû
(
KV_NAMESPACE_DEFAULT
)->
g‘_avaabË
();

69 
	gkv_cÚfig
*& 
	gkv_deviû_š‹º®
::
g‘_cÚfig
() {

70  
m_cÚfig
;

73 
boŞ_t
 
	gkv_deviû_š‹º®
::
is_pŞlšg
() {

74  
m_is_pŞl
;

77 
kv_¿w_dev_ty³
 
	gkv_deviû_š‹º®
::
g‘_dev_ty³
() {

78  
m_dev_ty³
;

82 
kv_»suÉ
 
v®id©e_key_v®ue
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
) {

83 ià(
	gkey
->key =ğ
NULL
) {

84  
KV_ERR_KEY_INVALID
;

86 ià(
	gkey
->
	gËngth
 > 
	gSAMSUNG_KV_MAX_KEY_LEN
 || key->Ëngth < 
	gSAMSUNG_KV_MIN_KEY_LEN
) {

87  
	gKV_ERR_KEY_LENGTH_INVALID
;

90 ià(
	gv®ue
 !ğ
NULL
) {

91 ià(
v®ue
->
Ëngth
 < 
SAMSUNG_KV_MIN_VALUE_LEN
 || v®ue->Ëngth > 
SAMSUNG_KV_MAX_VALUE_LEN
) {

92  
KV_ERR_VALUE_LENGTH_INVALID
;

96  
	gKV_SUCCESS
;

104 
	gkv_deviû_š‹º®
::
kv_deviû_š‹º®
(
kv_deviû_š™_t
 *
İtiÚs
) {

105 cÚ¡ 
ušt64_t
 
GB
 = 1024 * 1024 * 1024UL;

107 
	gm_dev_ty³
 = 
KV_DEV_TYPE_NONE
;

108 ià(
	gİtiÚs
->
	gdev·th
 !ğ
NULL
 && 
¡rcmp
(
İtiÚs
->
dev·th
, 
KVSSD_EMULATOR_PATH
) == 0) {

109 
m_dev_ty³
 = 
KV_DEV_TYPE_EMULATOR
;

111 
WRITE_WARN
("NÙ suµÜ‹d deviû…©h: %s", 
İtiÚs
->
dev·th
);

112 
ex™
(1);

115 
	gm_is_pŞl
 = 
İtiÚs
->
is_pŞlšg
;

117 
	gm_ÿ·c™y
 = 7 * 
GB
;

118 
	gm_has_fixed_keyËn
 = 
TRUE
;

122 
	gm_Ãed_³rsi£ncy
 = 
İtiÚs
->
Ãed_³rsi¡’cy
;

123 
	gm_cÚfig
 = 
NULL
;

124 ià(
	gm_dev_ty³
 =ğ
KV_DEV_TYPE_EMULATOR
) {

125 
m_cÚfig
 = 
Ãw
 
kv_cÚfig
(
İtiÚs
->
cÚfigfe
);

126 
	g¡d
::
¡ršg
 
ÿp_¡r
 = 
m_cÚfig
->
g‘kv
("general", "capacity");

129 
	gm_ÿ·c™y
 = 0;

131 ià(!
	gÿp_¡r
.
em±y
()) {

132 
	g¡d
::
size_t
 
pos
 = 0;

133 
	gm_ÿ·c™y
 = 
¡d
::
¡ouÎ
(
ÿp_¡r
, &
pos
, 10);

136 
	g¡d
::
¡ršg
 
un™_¡r
 = 
ÿp_¡r
.
sub¡r
(
pos
);

137 
	g¡d
::
ŒªsfÜm
(
un™_¡r
.
begš
(), un™_¡r.
’d
(), un™_¡r.begš(), ::
tŞow”
);

140 ià(
	gm_ÿ·c™y
 <= 0) {

141 
m_ÿ·c™y
 = 4 * 
GB
;

144 ià(
	gun™_¡r
.
fšd
("gb"è!ğ
¡d
::
¡ršg
::
Åos
) {

145 
m_ÿ·c™y
 *ğ
GB
;

146 } ià(
	gun™_¡r
.
fšd
("mb"è!ğ
¡d
::
¡ršg
::
Åos
) {

147 
m_ÿ·c™y
 *= 1024 * 1024;

149 
	gm_ÿ·c™y
 *= 1024 * 1024;

150 
WRITE_WARN
("capacity has‚o units specified, use MB\n");

157 
	gm_is_pŞl
 = 
İtiÚs
->
is_pŞlšg
;

158 
	g¡d
::
¡ršg
 
pŞl
 = 
m_cÚfig
->
g‘kv
("general", "polling");

159 ià(!
¡rÿ£cmp
(
pŞl
.
c_¡r
(), "false")) {

160 
	gm_is_pŞl
 = 
FALSE
;

161 } ià(!
¡rÿ£cmp
(
pŞl
.
c_¡r
(), "true")) {

162 
	gm_is_pŞl
 = 
TRUE
;

166 
	gm_has_fixed_keyËn
 = 
TRUE
;

167 
	g¡d
::
¡ršg
 
fixed_keyËn_¡r
 = 
m_cÚfig
->
g‘kv
("general", "keylen_fixed");

168 ià(!
¡rÿ£cmp
(
fixed_keyËn_¡r
.
c_¡r
(), "false")) {

169 
	gm_has_fixed_keyËn
 = 
FALSE
;

174 
	gm_u£_iİs_mod–
 = 
TRUE
;

175 
	g¡d
::
¡ršg
 
u£_iİs_mod–_¡r
 = 
m_cÚfig
->
g‘kv
("general", "use_iops_model");

176 ià(!
¡rÿ£cmp
(
u£_iİs_mod–_¡r
.
c_¡r
(), "false")) {

177 
	gm_u£_iİs_mod–
 = 
FALSE
;

183 
	gm_dev·th
 = 
İtiÚs
->
dev·th
;

185 
	gm_Ãxt_qid
 = 1;

186 
	gm_devid
 = 
kv_deviû_š‹º®
::
g‘_Ãxt_devid
();

189 
	gm_nsid
 = (
ušt32_t
è
KV_NAMESPACE_DEFAULT
;

192 
	gm_deviû_šfo
.
	gv”siÚ
 = 1;

193 
	gm_deviû_ty³
 = 
KV_DEVICE_TYPE_KV
;

197 
	gm_deviû_šfo
.
	gmax_Çme¥aûs
 = 1;

198 
	gm_deviû_šfo
.
	gmax_queues
 = 64*1024 - 1;

201 
	gm_deviû_šfo
.
	gmš_v®ue_Ën
 = (
kv_v®ue_t
è
SAMSUNG_KV_MIN_VALUE_LEN
;

203 
	gm_deviû_šfo
.
	gmax_v®ue_Ën
 = (
kv_v®ue_t
è
SAMSUNG_KV_MAX_VALUE_LEN
;

205 
	gm_deviû_šfo
.
	gmš_key_Ën
 = (
kv_key_t
è
SAMSUNG_KV_MIN_KEY_LEN
;

207 
	gm_deviû_šfo
.
	gmax_key_Ën
 = (
kv_key_t
è
SAMSUNG_KV_MAX_KEY_LEN
;

209 
	gm_deviû_šfo
.
	gÿ·c™y
 = 
m_ÿ·c™y
;

212 
	gm_deviû_šfo
.
	gex‹nded_šfo
 = (
kv_§msung_deviû
 *è
m®loc
((kv_samsung_device));

213 
kv_§msung_deviû
 *
	gv’dÜ_šfo
 = (kv_§msung_deviû *è
m_deviû_šfo
.
ex‹nded_šfo
;

215 
	gv’dÜ_šfo
->
	gkey_un™
 = 255;

216 
	gv’dÜ_šfo
->
	gv®ue_un™
 = 32;

219 
	gm_deviû_¡©
.
	gÇme¥aû_couÁ
 = 1;

220 
	gm_deviû_¡©
.
	gqueue_couÁ
 = 2;

221 
	gm_deviû_¡©
.
	gutiz©iÚ
 = 0;

222 
	gm_deviû_¡©
.
	gwaf
 = 0;

223 
	gm_deviû_¡©
.
	gex‹nded_šfo
 = 
NULL
;

230 
	gm_¡¬t_tim•ošt
 = 
¡d
::
chrÚo
::
sy¡em_şock
::
now
();

232 
	gm_š™Ÿlized
 = 
TRUE
;

236 
	gkv_deviû_š‹º®
::~
kv_deviû_š‹º®
() {

237 ià(
m_deviû_šfo
.
ex‹nded_šfo
 !ğ
NULL
) {

238 
ä“
(
m_deviû_šfo
.
ex‹nded_šfo
);

240 ià(
	gm_deviû_¡©
.
	gex‹nded_šfo
 !ğ
NULL
) {

241 
ä“
(
m_deviû_¡©
.
ex‹nded_šfo
);

245 
shutdown_®l_queues
();

248 autØ
	g™
 = 
m_ns_li¡
.
fšd
(
KV_NAMESPACE_DEFAULT
);

249 
kv_Çme¥aû_š‹º®
 *
	gns
 = 
™
->
£cÚd
;

250 
d–‘e
 
	gns
;

252 ià(
	gm_cÚfig
 !ğ
NULL
) {

253 
d–‘e
 
m_cÚfig
;

257 
boŞ_t
 
	gkv_deviû_š‹º®
::
is_š™Ÿlized
() {

258  
m_š™Ÿlized
;

262 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_š™Ÿlize_deviû
(
kv_deviû_š™_t
 *
İtiÚs
, 
kv_deviû_hªdË
 *
dev_hdl
) {

264 
	g¡d
::
lock_gu¬d
<
¡d
::
»cursive_mu‹x
> 
lock
(
s_mu‹x
);

266 ià(
	gdev_hdl
 =ğ
NULL
) {

267  
KV_ERR_PARAM_INVALID
;

269 ià(*
	gdev_hdl
 !ğ
NULL
) {

270 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è(*
dev_hdl
)->dev;

272 ià(
	gdev
 !ğ
NULL
 && 
dev
->
is_š™Ÿlized
()) {

273  
KV_ERR_DEV_INITIALIZED
;

278 (*
	gdev_hdl
èğ
Ãw
 
_kv_deviû_hªdË
;

280 
kv_deviû_š‹º®
 *
	gdev
 = 
Ãw
 kv_deviû_š‹º®(
İtiÚs
);

281 ià(
	gdev
 =ğ
NULL
) {

282  
KV_ERR_DEV_INIT
;

284 (*
	gdev_hdl
)->
	gdev
 = (*è
dev
;

285 (*
	gdev_hdl
)->
	gdevid
 = 
dev
->
g‘_devid
();

288 
	gs_glob®_deviû_li¡
.
š£¹
(
¡d
::
make_·œ
((*
dev_hdl
)->
devid
, 
dev
));

293 
kv_Çme¥aû
 
	gnsšfo
;

294 
	gnsšfo
.
	gÿ·c™y
 = 
dev
->
g‘_ÿ·c™y
();

295 
	gnsšfo
.
	gnsid
 = 
KV_NAMESPACE_DEFAULT
;

296 
	gnsšfo
.
	g©ched
 = 
TRUE
;

298 
kv_Çme¥aû_š‹º®
 *
	gns
 = 
Ãw
 kv_Çme¥aû_š‹º®(
dev
, (
ušt32_t
è
KV_NAMESPACE_DEFAULT
, &
nsšfo
);

299 ià(
	gns
 =ğ
NULL
) {

300 
dev
->
£t_š™_¡©us
(
KV_ERR_DEV_INIT
);

301  
	gKV_ERR_DEV_INIT
;

304 
	gdev
->
š£¹_Çme¥aû
((
ušt32_t
è
KV_NAMESPACE_DEFAULT
, 
ns
);

305 
kv_»suÉ
 
	g¡©us
 = 
ns
->
g‘_š™_¡©us
();

306 
	gdev
->
£t_š™_¡©us
(
¡©us
);

308 
	gnsšfo
.
	gex‹nded_šfo
 = 
NULL
;

310  
	g¡©us
;

314 
boŞ_t
 
	gkv_deviû_š‹º®
::
š£¹_Çme¥aû
(
ušt32_t
 
nsid
, 
kv_Çme¥aû_š‹º®
 *
ns
) {

315 
	gm_ns_li¡
.
š£¹
(
¡d
::
make_·œ
(
nsid
, 
ns
));

316  
	gTRUE
;

319 
ušt32_t
 
	gkv_deviû_š‹º®
::
g‘_devid
() {

320  
m_devid
;

323 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
g‘_io_queue_šfo
(
ušt16_t
 
qid
, 
kv_queue
 *
queue_šfo
) {

324 ià(
	gqueue_šfo
 =ğ
NULL
) {

325  
KV_ERR_PARAM_INVALID
;

328 
	g¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gioqueue
 *>::
cÚ¡_™”©Ü
 
™
 = 
m_ioque_li¡
.
fšd
(
qid
);

329 ià(
	g™
 !ğ
m_ioque_li¡
.
’d
()) {

330  (
™
->
£cÚd
->
kv_g‘_queue_šfo
(
queue_šfo
));

332  
	gKV_ERR_QUEUE_QID_INVALID
;

337 
	g¡d
::
£t
<
ušt16_t
> 
kv_deviû_š‹º®
::
g‘_·œed_SQ_ids
(ušt16_ˆ
CQ_id
) {

339 autØ
™
 = 
m_sq_to_cq_·œs
.
begš
();

340 autØ
	g™e
 = 
m_sq_to_cq_·œs
.
’d
();

342 
	g¡d
::
£t
<
ušt16_t
> 
s
;

343 ; 
	g™
 !ğ
™e
; it++) {

344 ià(
	g™
->
	g£cÚd
 =ğ
CQ_id
) {

345 
s
.
š£¹
(
™
->
fœ¡
);

349  
	gs
;

353 
boŞ_t
 
qid_exi¡
(
ušt16_t
 
qid
, 
¡d
::
unÜd”ed_m­
<ušt16_t, 
ioqueue
 *>& 
qli¡
) {

354 
	g¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gioqueue
 *>::
™”©Ü
 
™e
 = 
qli¡
.
’d
();

355 
	g¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gioqueue
 *>::
™”©Ü
 
™
 = 
qli¡
.
fšd
(
qid
);

356 ià(
	g™
 =ğ
™e
) {

357  
FALSE
;

359  
	gTRUE
;

363 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
ü—‹_queue
(cÚ¡ 
kv_queue
 *
quešfo
, 
kv_queue_hªdË
 *
que_hdl
) {

365 
	g¡d
::
lock_gu¬d
<
¡d
::
mu‹x
> 
lock
(
m_mu‹x
);

367 ià(
	gquešfo
 =ğ
NULL
 || 
que_hdl
 == NULL) {

368 
WRITE_WARN
("parameter can't be NULL.\n");

369  
	gKV_ERR_PARAM_INVALID
;

373 ià(
	gm_ioque_li¡
.
size
() == 64*1024 - 1) {

374 
WRITE_WARN
("Max queue count„eached.\n");

375  
	gKV_ERR_QUEUE_MAX_QUEUE
;

380 ià(
	gquešfo
->
	gqueue_size
 > 64*1024 - 1) {

381 
WRITE_WARN
("queue sizeoo big.\n");

382  
	gKV_ERR_QUEUE_QSIZE_INVALID
;

387 
ušt16_t
 
	gqid
 = 
quešfo
->
queue_id
;

388 ià(
qid_exi¡
(
qid
, 
m_ioque_li¡
)) {

389 ià(
	gquešfo
->
	gqueue_ty³
 =ğ
SUBMISSION_Q_TYPE
) {

390 
WRITE_WARN
("submissiÚ queuid %d‡Ì—dyƒxi¡s\n", 
qid
);

391  
	gKV_ERR_QUEUE_QID_INVALID
;

393 
WRITE_WARN
("com¶‘iÚ queuid %d‡Ì—dyƒxi¡s\n", 
qid
);

394  
	gKV_ERR_QUEUE_CQID_INVALID
;

398 
ioqueue
 *
	gout_q
 = 0;

400 ià(
	gquešfo
->
	gqueue_ty³
 =ğ
SUBMISSION_Q_TYPE
) {

401 
out_q
 = 
g‘_ioqueue
(
quešfo
->
com¶‘iÚ_queue_id
);

402 ià(
	gout_q
 == 0) {

403 
WRITE_WARN
("com¶‘iÚ queuid %d dÛ¢'ˆexi¡\n", 
quešfo
->
com¶‘iÚ_queue_id
);

404  
	gKV_ERR_QUEUE_CQID_INVALID
;

408 
ioqueue
 *
	gque
 = 0;

409 ià(
g‘_dev_ty³
(è=ğ
KV_DEV_TYPE_LINUX_KERNEL
) {

410 
que
 = 
Ãw
 
k”Ãl_ioqueue
(
quešfo
, 
this
);

413 
	gque
 = 
Ãw
 
emul_ioqueue
(
quešfo
, 
this
, (emul_ioqueue*è
out_q
);

416 
	gm_deviû_¡©
.
	gqueue_couÁ
++;

419 
	gm_ioque_li¡
.
š£¹
(
¡d
::
make_·œ
(
qid
, 
que
));

422 ià(
	gquešfo
->
	gqueue_ty³
 =ğ
SUBMISSION_Q_TYPE
) {

423 
m_sq_to_cq_·œs
.
š£¹
(
¡d
::
make_·œ
(
qid
, 
quešfo
->
com¶‘iÚ_queue_id
));

426 (*
	gque_hdl
èğ
Ãw
 
_kv_queue_hªdË
();

429 (*
	gque_hdl
)->
	gqid
 = 
qid
;

430 (*
	gque_hdl
)->
	gdev
 = (*)
this
;

431 (*
	gque_hdl
)->
	gqueue
 = (*)
que
;

435  
	gKV_SUCCESS
;

438 
kv_deviû_š‹º®
 *
	gkv_deviû_š‹º®
::
g‘_deviû_š¡ªû
(
kv_deviû_hªdË
 
dev_hdl
) {

439 ià(
dev_hdl
 =ğ
NULL
) {

440  
NULL
;

442  (
	gkv_deviû_š‹º®
 *è
	gdev_hdl
->
	gdev
;

445 
kv_deviû_š‹º®
 *
	gkv_deviû_š‹º®
::
g‘_deviû_š¡ªû
(
ušt32_t
 
devid
) {

446 
¡d
::
lock_gu¬d
<¡d::
»cursive_mu‹x
> 
lock
(
s_mu‹x
);

448 
	g¡d
::
unÜd”ed_m­
<
ušt32_t
, 
	gkv_deviû_š‹º®
 *>::
™”©Ü
 
™
 = 
kv_deviû_š‹º®
::
s_glob®_deviû_li¡
.
fšd
(
devid
);

449 ià(
	g™
 !ğ
s_glob®_deviû_li¡
.
’d
()) {

450  
™
->
£cÚd
;

452  
	gNULL
;

457 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_ş—nup_deviû
(
kv_deviû_hªdË
 
dev_hdl
) {

458 
¡d
::
lock_gu¬d
<¡d::
»cursive_mu‹x
> 
lock
(
s_mu‹x
);

460 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

463 
	gs_glob®_deviû_li¡
.
”a£
(
dev_hdl
->
devid
);

465 ià(
	gdev
 !ğ
NULL
) {

466 
d–‘e
 
dev
;

469 
d–‘e
 
	gdev_hdl
;

471  
	gKV_SUCCESS
;

474 
	gkv_deviû_š‹º®
::
shutdown_®l_queues
() {

476 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
lock
(
m_mu‹x
);

477 auto& 
	g™
 : 
m_ioque_li¡
) {

478 
ioqueue
 *
que
 = 
™
.
£cÚd
;

479 
	gque
->
‹rmš©e
();

480 
d–‘e
 
	gque
;

484 
kv_deviû
 
	gkv_deviû_š‹º®
::
g‘_devšfo
() {

485  
m_deviû_šfo
;

488 
kv_deviû_¡©
 
	gkv_deviû_š‹º®
::
g‘_dev_¡©
() {

489  
m_deviû_¡©
;

492 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_deviû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû
 *
devšfo
) {

493 ià(
	gdevšfo
 =ğ
NULL
) {

494  
KV_ERR_PARAM_INVALID
;

496 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

497 ià(
	gdev
 =ğ
NULL
) {

498  
KV_ERR_DEV_NOT_EXIST
;

501 
	gdev
->
upd©e_ÿ·c™y_cÚsumed
();

502 *
	gdevšfo
 = 
dev
->
g‘_devšfo
();

503  
	gKV_SUCCESS
;

506 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_deviû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû_¡©
 *
dev¡©
) {

507 ià(
	gdev¡©
 =ğ
NULL
) {

508  
KV_ERR_PARAM_INVALID
;

510 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

511 ià(
	gdev
 =ğ
NULL
) {

512  
KV_ERR_DEV_NOT_EXIST
;

515 
	gdev
->
upd©e_ÿ·c™y_cÚsumed
();

516 *
	gdev¡©
 = 
dev
->
g‘_dev_¡©
();

517  
	gKV_SUCCESS
;

520 
ioqueue
 *
	gkv_deviû_š‹º®
::
g‘_ioqueue
(
ušt16_t
 
qid
) {

521 
¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gioqueue
 *>::
cÚ¡_™”©Ü
 
™
 = 
m_ioque_li¡
.
fšd
(
qid
);

522 ià(
	g™
 !ğ
m_ioque_li¡
.
’d
()) {

523  
™
->
£cÚd
;

525  
	gNULL
;

529 
kv_Çme¥aû_š‹º®
 *
	gkv_deviû_š‹º®
::
g‘_Çme¥aû_deçuÉ
() {

530  
g‘_Çme¥aû
(
KV_NAMESPACE_DEFAULT
);

533 
kv_Çme¥aû_š‹º®
 *
	gkv_deviû_š‹º®
::
g‘_Çme¥aû
(cÚ¡ 
ušt32_t
 
nsid
) {

534 
¡d
::
unÜd”ed_m­
<
št32_t
, 
	gkv_Çme¥aû_š‹º®
 *>::
™”©Ü
 
™
 = 
m_ns_li¡
.
fšd
(
nsid
);

535 ià(
	g™
 !ğ
m_ns_li¡
.
’d
()) {

536  
™
->
£cÚd
;

538  
	gNULL
;

544 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_§n™ize
(
kv_queue_hªdË
 
que_hdl
, 
kv_deviû_hªdË
 
dev_hdl
, 
kv_§n™ize_İtiÚ
 
İtiÚ
, 
kv_§n™ize_·‰”n
 *
·‰”n
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

546 ià(
	gİtiÚ
 !ğ
KV_SANITIZE_OPT_KV_ERASE
 && 
İtiÚ
 !ğ
KV_SANITIZE_OPT_CRYPTO_ERASE
 && o±iÚ !ğ
KV_SANITIZE_OPT_OVERWRITE
) {

547  
KV_ERR_OPTION_INVALID
;

550 ià(
	gque_hdl
 =ğ
NULL
 || 
dev_hdl
 == NULL) {

551  
KV_ERR_PARAM_INVALID
;

554 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

555 ià(
	gdev
 =ğ
NULL
) {

556  
KV_ERR_DEV_NOT_EXIST
;

559 
ioqueue
 *
	gque
 = (ioqueu*)(
que_hdl
->
queue
);

560 ià(
	gque
 =ğ
NULL
) {

561  
KV_ERR_QUEUE_QID_INVALID
;

567 
kv_Çme¥aû_š‹º®
 *
	gns
 = 
dev
->
g‘_Çme¥aû
(
KV_NAMESPACE_DEFAULT
);

568 ià(
	gns
 =ğ
NULL
) {

569  
KV_ERR_VENDOR
;

572 
İ_§n™ize_¡ruù_t
 
	gšfo
;

573 
	gšfo
.
	g·‰”n
 = 
·‰”n
;

574 
	gšfo
.
	gİtiÚ
 = 
İtiÚ
;

576 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

578 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

579 ià(
	gpo¡_â
) {

580 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

581 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

583 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

585 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_SANITIZE_DEVICE
;

586 
	gcmd
->
	gioùx
.
	gcommªd
.
	g§n™ize_šfo
 = 
šfo
;

587 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

588 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

594  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

597 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
»move_queue
(
ušt16_t
 
qid
) {

599 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
lock
(
m_mu‹x
);

601 
ioqueue
 *
	gque
 = 
g‘_ioqueue
(
qid
);

602 ià(
	gque
 =ğ
NULL
) {

603 
WRITE_WARN
("Queuid %d inv®id", 
qid
);

604  
	gKV_ERR_QUEUE_QID_INVALID
;

607 
ušt16_t
 
	gqty³
 = 
que
->
g‘_ty³
();

611 ià(
	gqty³
 =ğ
COMPLETION_Q_TYPE
) {

614 
¡d
::
£t
<
ušt16_t
> 
sqids
 = 
g‘_·œed_SQ_ids
(
qid
);

615 
	g¡d
::
£t
<
ušt16_t
>::
™”©Ü
 
™
 = 
sqids
.
begš
();

616 
	g¡d
::
£t
<
ušt16_t
>::
™”©Ü
 
™e
 = 
sqids
.
’d
();

619 ; 
	g™
 !ğ
™e
; it++) {

620 ià(
	gm_ioque_li¡
.
fšd
(*
™
è!ğ
m_ioque_li¡
.
’d
()) {

621 
WRITE_WARN
("can't delete‡ completion queue before‡ll‡ssociated submission queues have been deleted\n");

622  (
	gKV_ERR_QUEUE_DELETION_INVALID
);

630 
	gm_ioque_li¡
.
”a£
(
qid
);

631 
	gm_sq_to_cq_·œs
.
”a£
(
qid
);

632 
	gque
->
‹rmš©e
();

633 
d–‘e
 
	gque
;

634 
	gm_deviû_¡©
.
	gqueue_couÁ
--;

636  
	gKV_SUCCESS
;

640 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_d–‘e_queue
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 
que_hdl
) {

641 ià(
	gdev_hdl
 =ğ
NULL
 || 
que_hdl
 == NULL) {

642  
KV_ERR_PARAM_INVALID
;

645 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

646 ià(
	gdev
 =ğ
NULL
) {

647  
KV_ERR_DEV_NOT_EXIST
;

650 autØ
	g»t
 = 
dev
->
»move_queue
(
que_hdl
->
qid
);

651 
d–‘e
 
	gque_hdl
;

653  
	g»t
;

657 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_ü—‹_queue
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue
 *
quešfo
, 
kv_queue_hªdË
 *
que_hdl
) {

659 ià(
	gdev_hdl
 =ğ
NULL
 || 
quešfo
 =ğNULL || 
que_hdl
 == NULL) {

660  
KV_ERR_PARAM_INVALID
;

663 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

664 ià(
	gdev
 =ğ
NULL
) {

666  
KV_ERR_DEV_NOT_EXIST
;

669  
	gdev
->
ü—‹_queue
(
quešfo
, 
que_hdl
);

673 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_queue_hªdËs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
) {

674 ià(
	gdev_hdl
 =ğ
NULL
 || 
que_hdls
 =ğNULL || 
que_út
 == NULL) {

675  
KV_ERR_PARAM_INVALID
;

678 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

679 ià(
	gdev
 =ğ
NULL
) {

680  
KV_ERR_DEV_NOT_EXIST
;

682  
	gdev
->
kv_g‘_queue_hªdËs
(
que_hdls
, 
que_út
);

686 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_queue_hªdËs
(
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
) {

687 
kv_»suÉ
 
	g»s
 = 
KV_SUCCESS
;

689 ià(
	gm_ioque_li¡
.
size
(è> *
	gque_út
) {

690 
	g»s
 = 
KV_WRN_MORE
;

693 
ušt32_t
 
	gi
 = 0;

694 auto& 
	g™
 : 
m_ioque_li¡
) {

695 ià(
i
 =ğ*
que_út
) {

698 
ušt16_t
 
	gqid
 = 
™
.
fœ¡
;

699 
	gque_hdls
[
i
]->
	gqid
 = 
qid
;

700 
	gque_hdls
[
i
]->
	gdev
 = (*è
this
;

701 
	gi
++;

703 *
	gque_út
 = 
i
;

704  
	g»s
;

707 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_queue_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue
 *
quešfo
) {

708 ià(
	gquešfo
 =ğ
NULL
 || 
dev_hdl
 =ğNULL || 
que_hdl
 == NULL) {

709  
KV_ERR_PARAM_INVALID
;

712 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

713 ià(
	gdev
 =ğ
NULL
) {

714  
KV_ERR_DEV_NOT_EXIST
;

717 
ioqueue
 *
	gque
 = (ioqueu*)(
que_hdl
->
queue
);

718 ià(
	gque
 =ğ
NULL
) {

719  
KV_ERR_QUEUE_QID_INVALID
;

722  (
	gque
->
kv_g‘_queue_šfo
(
quešfo
));

725 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_queue_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue_¡©
 *
que_¡©
) {

726 ià(
	gque_¡©
 =ğ
NULL
 || 
dev_hdl
 =ğNULL || 
que_hdl
 == NULL) {

727  
KV_ERR_PARAM_INVALID
;

730 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

731 ià(
	gdev
 =ğ
NULL
) {

732  
KV_ERR_DEV_NOT_EXIST
;

735 
ioqueue
 *
	gque
 = (ioqueu*)(
que_hdl
->
queue
);

736 ià(
	gque
 =ğ
NULL
) {

737  
KV_ERR_QUEUE_QID_INVALID
;

740  (
	gque
->
kv_g‘_queue_¡©
(
que_¡©
));

743 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_ü—‹_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû
 *
ns
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

744 (è
	gdev_hdl
;

745 (è
	gns
;

746 (è
	gns_hdl
;

747  
	gKV_ERR_DEV_MAX_NS
;

750 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_d–‘e_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

751 ià(
	gns_hdl
) {

752 
d–‘e
 
	gns_hdl
;

753  
	gKV_SUCCESS
;

755  
	gKV_ERR_NS_DEFAULT
;

758 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_©ch_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

759 (è
	gdev_hdl
;

760 (è
	gns_hdl
;

761  
	gKV_ERR_NS_DEFAULT
;

764 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_d‘ach_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

765 (è
	gdev_hdl
;

766 (è
	gns_hdl
;

767  
	gKV_ERR_NS_DEFAULT
;

770 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_li¡_Çme¥aûs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdls
, 
ušt32_t
 *
ns_út
) {

771 ià(
	gdev_hdl
 =ğ
NULL
 || 
ns_hdls
 =ğNULL || 
ns_út
 == NULL) {

772  
KV_ERR_PARAM_INVALID
;

775 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

776 ià(
	gdev
 =ğ
NULL
) {

777  
KV_ERR_DEV_NOT_EXIST
;

781 *
	gns_út
 = 1;

782 
	gns_hdls
[0]->
	gnsid
 = (
ušt32_t
è
KV_NAMESPACE_DEFAULT
;

783 
	gns_hdls
[0]->
	gdev
 = 
dev_hdl
->
dev
;

784 
	gns_hdls
[0]->
	gns
 = (*è
dev
->
g‘_Çme¥aû
(
KV_NAMESPACE_DEFAULT
);

786  
	gKV_SUCCESS
;

790 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_Çme¥aû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû
 *
nsšfo
) {

791 ià(
	gdev_hdl
 =ğ
NULL
 || 
nsšfo
 == NULL) {

792  
KV_ERR_PARAM_INVALID
;

795 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

796 ià(
	gdev
 =ğ
NULL
) {

797  
KV_ERR_DEV_NOT_EXIST
;

800 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

801 ià(
	gns
 =ğ
NULL
) {

802  
KV_ERR_NS_INVALID
;

805  (
	gns
->
kv_g‘_Çme¥aû_šfo
(
nsšfo
));

809 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
_kv_by·ss_Çme¥aû
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
boŞ_t
 
by·ss
) {

810 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

811 ià(
	gns
 =ğ
NULL
) {

812  
KV_ERR_NS_INVALID
;

814 
	gns
->
sw­_deviû
(
by·ss
);

815  
	gKV_SUCCESS
;

818 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_g‘_Çme¥aû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû_¡©
 *
ns_¡©
) {

819 ià(
	gdev_hdl
 =ğ
NULL
 || 
ns_¡©
 == NULL) {

820  
KV_ERR_PARAM_INVALID
;

823 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
dev_hdl
->
dev
;

824 ià(
	gdev
 =ğ
NULL
) {

825  
KV_ERR_DEV_NOT_EXIST
;

828 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

829 ià(
	gns
 =ğ
NULL
) {

830  
KV_ERR_NS_INVALID
;

833  (
	gns
->
kv_g‘_Çme¥aû_¡©
(
ns_¡©
));

839 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_purge
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_purge_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

841 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 == NULL) {

842  
KV_ERR_PARAM_INVALID
;

845 ià(
	gİtiÚ
 !ğ
KV_PURGE_OPT_DEFAULT
 && 
İtiÚ
 !ğ
KV_PURGE_OPT_KV_ERASE
 && o±iÚ !ğ
KV_PURGE_OPT_CRYPTO_ERASE
) {

846  
KV_ERR_OPTION_INVALID
;

849 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

850 ià(
	gdev
 =ğ
NULL
) {

851  
KV_ERR_DEV_NOT_EXIST
;

854 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

855 ià(
	gns
 =ğ
NULL
) {

856  
KV_ERR_NS_INVALID
;

859 
ioqueue
 *
	gque
 = (ioqueu*)(
que_hdl
->
queue
);

860 ià(
	gque
 =ğ
NULL
) {

861  
KV_ERR_QUEUE_QID_INVALID
;

864 
İ_purge_¡ruù_t
 
	gšfo
;

865 
	gšfo
.
	gİtiÚ
 = 
İtiÚ
;

867 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

868 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

869 ià(
	gpo¡_â
) {

870 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

871 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

873 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

875 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_PURGE
;

876 
	gcmd
->
	gioùx
.
	gcommªd
.
	gpurge_šfo
 = 
šfo
;

877 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

878 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

883  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

887 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_İ’_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

889 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™_cÚd
 == NULL) {

890  
KV_ERR_PARAM_INVALID
;

892 ià(
	g™_İ
 !ğ
KV_ITERATOR_OPT_KEY
 && 
™_İ
 !ğ
KV_ITERATOR_OPT_KV
 && it_İ !ğ
KV_ITERATOR_OPT_KV_WITH_DELETE
) {

893  
KV_ERR_OPTION_INVALID
;

896 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

897 ià(
	gns
 =ğ
NULL
) {

898  
KV_ERR_NS_INVALID
;

901 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

902 ià(
	gdev
 =ğ
NULL
) {

903  
KV_ERR_DEV_NOT_EXIST
;

906 
ioqueue
 *
	gque
 = (ioqueu*)(
que_hdl
->
queue
);

907 ià(
	gque
 =ğ
NULL
) {

908  
KV_ERR_QUEUE_QID_INVALID
;

911 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

912 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

913 
	gcmd
->
	gioùx
.
	g»suÉ
.
	gh™”
 = 0;

914 ià(
	gpo¡_â
) {

915 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

916 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

918 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

920 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_OPEN_ITERATOR
;

921 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_İ’_šfo
.
	g™_İ
 = 
™_İ
;

922 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_İ’_šfo
.
	g™_cÚd
.
	gb™mask
 = 
™_cÚd
->
b™mask
;

923 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_İ’_šfo
.
	g™_cÚd
.
	gb™_·‰”n
 = 
™_cÚd
->
b™_·‰”n
;

924 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

925 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

927  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

930 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_şo£_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_™”©Ü_hªdË
 
™”_hdl
) {

931 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 == 0) {

932  
KV_ERR_PARAM_INVALID
;

935 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

936 ià(
	gns
 =ğ
NULL
) {

937  
KV_ERR_NS_INVALID
;

940 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

941 ià(
	gdev
 =ğ
NULL
) {

942  
KV_ERR_DEV_NOT_EXIST
;

945 
ioqueue
 *
	gque
 = (ioqueu*)(
que_hdl
->
queue
);

946 ià(
	gque
 =ğ
NULL
) {

947  
KV_ERR_QUEUE_QID_INVALID
;

950 
İ_şo£_™”©Ü_¡ruù_t
 
	gšfo
;

951 
	gšfo
.
	g™”_hdl
 = 
™”_hdl
;

953 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

954 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

955 
	gcmd
->
	gioùx
.
	g»suÉ
.
	gh™”
 = 
™”_hdl
;

956 ià(
	gpo¡_â
) {

957 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

958 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

960 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

962 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_CLOSE_ITERATOR
;

963 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_şo£_šfo
 = 
šfo
;

964 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

965 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

967  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

971 
boŞ_t
 
	gkv_deviû_š‹º®
::
u£_iİs_mod–
() {

972  
m_u£_iİs_mod–
;

975 
boŞ_t
 
	gkv_deviû_š‹º®
::
is_keyËn_fixed
() {

976  
m_has_fixed_keyËn
;

980 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_™”©Ü_Ãxt_£t
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_™”©Ü_li¡
 *
™”_li¡
) {

981 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 == 0) {

982  
KV_ERR_PARAM_INVALID
;

985 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

986 ià(
	gqueue
 =ğ
NULL
) {

987  
KV_ERR_QUEUE_QID_INVALID
;

990 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

991 ià(
	gdev
 =ğ
NULL
) {

992  
KV_ERR_DEV_NOT_EXIST
;

995 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

996 ià(
	gns
 =ğ
NULL
) {

997  
KV_ERR_NS_INVALID
;

1000 
İ_™”©Ü_Ãxt_¡ruù_t
 
	gšfo
;

1001 
	gšfo
.
	g™”_li¡
 = 
™”_li¡
;

1002 
	gšfo
.
	g™”_hdl
 = 
™”_hdl
;

1004 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1005 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1006 
	gcmd
->
	gioùx
.
	g»suÉ
.
	gh™”
 = 
™”_hdl
;

1007 ià(
	gpo¡_â
) {

1008 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1009 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1011 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1013 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_ITERATE_NEXT
;

1014 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_Ãxt_šfo
 = 
šfo
;

1015 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

1016 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

1019  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1023 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_™”©Ü_Ãxt
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
) {

1024 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 == 0) {

1025  
KV_ERR_PARAM_INVALID
;

1028 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1029 ià(
	gqueue
 =ğ
NULL
) {

1030  
KV_ERR_QUEUE_QID_INVALID
;

1033 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1034 ià(
	gdev
 =ğ
NULL
) {

1035  
KV_ERR_DEV_NOT_EXIST
;

1038 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1039 ià(
	gns
 =ğ
NULL
) {

1040  
KV_ERR_NS_INVALID
;

1043 
İ_™”©Ü_Ãxt_¡ruù_t
 
	gšfo
;

1044 
	gšfo
.
	gkey
 = 
key
;

1045 
	gšfo
.
	gv®ue
 = 
v®ue
;

1046 
	gšfo
.
	g™”_hdl
 = 
™”_hdl
;

1048 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1049 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1050 
	gcmd
->
	gioùx
.
	g»suÉ
.
	gh™”
 = 
™”_hdl
;

1051 ià(
	gpo¡_â
) {

1052 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1053 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1055 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1057 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_ITERATE_NEXT_SINGLE_KV
;

1058 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_Ãxt_šfo
 = 
šfo
;

1059 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

1060 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

1063  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1067 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_li¡_™”©Üs
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
) {

1068 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
kv_™”s
 =ğNULL || 
™”_út
 == NULL) {

1069  
KV_ERR_PARAM_INVALID
;

1072 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1073 ià(
	gqueue
 =ğ
NULL
) {

1074  
KV_ERR_QUEUE_QID_INVALID
;

1077 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1078 ià(
	gdev
 =ğ
NULL
) {

1079  
KV_ERR_DEV_NOT_EXIST
;

1082 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1083 ià(
	gns
 =ğ
NULL
) {

1084  
KV_ERR_NS_INVALID
;

1087 
İ_li¡_™”©Ü_¡ruù_t
 
	gšfo
;

1088 
	gšfo
.
	gkv_™”s
 = 
kv_™”s
;

1089 
	gšfo
.
	g™”_út
 = 
™”_út
;

1091 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1092 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1093 
	gcmd
->
	gioùx
.
	g»suÉ
.
	gh™”
 = 0;

1094 ià(
	gpo¡_â
) {

1095 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1096 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1098 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1100 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_LIST_ITERATOR
;

1101 
	gcmd
->
	gioùx
.
	gcommªd
.
	g™”©Ü_li¡_šfo
 = 
šfo
;

1102 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

1103 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

1106  
	gns
->
kv_li¡_™”©Üs
(
kv_™”s
, 
™”_út
, 
cmd
);

1110 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_d–‘e
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_d–‘e_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

1111 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 == NULL) {

1112  
KV_ERR_PARAM_INVALID
;

1115 
kv_»suÉ
 
	g»s
 = 
v®id©e_key_v®ue
(
key
, 
NULL
);

1116 ià(
	g»s
 !ğ
KV_SUCCESS
) {

1117  
»s
;

1126 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1127 ià(
	gdev
 =ğ
NULL
) {

1128  
KV_ERR_DEV_NOT_EXIST
;

1131 
emul_ioqueue
 *
	gque
 = (emul_ioqueu*)(
que_hdl
->
queue
);

1132 ià(
	gque
 =ğ
NULL
) {

1133  
KV_ERR_QUEUE_QID_INVALID
;

1136 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1137 ià(
	gns
 =ğ
NULL
) {

1138  
KV_ERR_NS_INVALID
;

1141 
İ_d–‘e_¡ruù_t
 
	gšfo
;

1142 
	gšfo
.
	gİtiÚ
 = 
İtiÚ
;

1144 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1145 
	gcmd
->
	gioùx
.
	gkey
 = 
key
;

1146 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

1147 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1148 ià(
	gpo¡_â
) {

1149 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1150 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1152 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1154 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_DELETE
;

1155 
	gcmd
->
	gioùx
.
	gcommªd
.
	gd–‘e_šfo
 = 
šfo
;

1158  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1161 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_d–‘e_group
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

1162 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
g½_cÚd
 == NULL) {

1163  
KV_ERR_PARAM_INVALID
;

1166 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1167 ià(
	gdev
 =ğ
NULL
) {

1168  
KV_ERR_DEV_NOT_EXIST
;

1171 
emul_ioqueue
 *
	gque
 = (emul_ioqueu*)(
que_hdl
->
queue
);

1172 ià(
	gque
 =ğ
NULL
) {

1173  
KV_ERR_QUEUE_QID_INVALID
;

1176 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1177 ià(
	gns
 =ğ
NULL
) {

1178  
KV_ERR_NS_INVALID
;

1181 
İ_d–‘e_group_¡ruù_t
 
	gšfo
;

1182 
	gšfo
.
	gg½_cÚd
 = 
g½_cÚd
;

1184 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1185 
	gcmd
->
	gioùx
.
	gkey
 = 
NULL
;

1186 
	gcmd
->
	gioùx
.
	gv®ue
 = 
NULL
;

1187 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1188 ià(
	gpo¡_â
) {

1189 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1190 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1192 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1194 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_DELETE_GROUP
;

1195 
	gcmd
->
	gioùx
.
	gcommªd
.
	gd–‘e_group_šfo
ğ
šfo
;

1198  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1201 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_exi¡
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
keys
, 
ušt32_t
 
key_út
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
bufãr
) {

1203 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
keys
 =ğNULL || 
bufãr
 == NULL) {

1204  
KV_ERR_PARAM_INVALID
;

1208 
ušt32_t
 
	gi
 = 0; i < 
	gkey_út
; i++) {

1209 
kv_»suÉ
 
	g»s
 = 
v®id©e_key_v®ue
(
keys
 + 
i
, 
NULL
);

1210 ià(
	g»s
 !ğ
KV_SUCCESS
) {

1211  
»s
;

1215 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1216 ià(
	gqueue
 =ğ
NULL
) {

1217  
KV_ERR_QUEUE_QID_INVALID
;

1220 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1221 ià(
	gdev
 =ğ
NULL
) {

1222  
KV_ERR_DEV_NOT_EXIST
;

1225 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1226 ià(
	gns
 =ğ
NULL
) {

1227  
KV_ERR_NS_INVALID
;

1231 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1232 
	gcmd
->
	gioùx
.
	gkey
 = 
keys
;

1233 
	gcmd
->
	gioùx
.
	gv®ue
 = 0;

1234 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1235 ià(
	gpo¡_â
) {

1236 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1237 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1239 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1241 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_CHECK_KEY_EXIST
;

1242 
	gcmd
->
	gioùx
.
	g»suÉ
.
	gbufãr
 = 
bufãr
;

1243 
	gcmd
->
	gioùx
.
	gcommªd
.
	gkey_exi¡_šfo
.
	g»suÉ
 = 
bufãr
;

1244 
	gcmd
->
	gioùx
.
	gcommªd
.
	gkey_exi¡_šfo
.
	g»suÉ_size
 = 
bufãr_size
;

1245 
	gcmd
->
	gioùx
.
	gcommªd
.
	gkey_exi¡_šfo
.
	gkeycouÁ
 = 
key_út
;

1247  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1251 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_»Œ›ve
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_»Œ›ve_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_v®ue
 *
v®ue
) {

1252 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

1253  
KV_ERR_PARAM_INVALID
;

1256 
kv_»suÉ
 
	g»s
 = 
v®id©e_key_v®ue
(
key
, 
NULL
);

1257 ià(
	g»s
 !ğ
KV_SUCCESS
) {

1258  
»s
;

1267 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1268 ià(
	gdev
 =ğ
NULL
) {

1269  
KV_ERR_DEV_NOT_EXIST
;

1272 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1273 ià(
	gqueue
 =ğ
NULL
) {

1275  
KV_ERR_QUEUE_QID_INVALID
;

1278 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1279 ià(
	gns
 =ğ
NULL
) {

1280  
KV_ERR_NS_INVALID
;

1283 
İ_g‘_¡ruù_t
 
	gšfo
;

1284 
	gšfo
.
	gİtiÚ
 = 
İtiÚ
;

1286 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1287 
	gcmd
->
	gioùx
.
	gkey
 = 
key
;

1288 
	gcmd
->
	gioùx
.
	gv®ue
 = 
v®ue
;

1289 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1290 ià(
	gpo¡_â
) {

1291 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1292 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1294 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1296 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_GET
;

1297 
	gcmd
->
	gioùx
.
	gcommªd
.
	gg‘_šfo
 = 
šfo
;

1300  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1305 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_¡Üe
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
kv_¡Üe_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

1306 ià(
	gque_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

1307  
KV_ERR_PARAM_INVALID
;

1310 
kv_»suÉ
 
	g»s
 = 
v®id©e_key_v®ue
(
key
, 
v®ue
);

1311 ià(
	g»s
 !ğ
KV_SUCCESS
) {

1312  
»s
;

1321 
kv_deviû_š‹º®
 *
	gdev
 = (kv_deviû_š‹º® *è
que_hdl
->
dev
;

1322 ià(
	gdev
 =ğ
NULL
) {

1323  
KV_ERR_DEV_NOT_EXIST
;

1326 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1327 ià(
	gqueue
 =ğ
NULL
) {

1328  
KV_ERR_QUEUE_QID_INVALID
;

1331 
kv_Çme¥aû_š‹º®
 *
	gns
 = (kv_Çme¥aû_š‹º® *è
ns_hdl
->
ns
;

1332 ià(
	gns
 =ğ
NULL
) {

1333  
KV_ERR_NS_INVALID
;

1336 
İ_¡Üe_¡ruù_t
 
	gšfo
;

1337 
	gšfo
.
	gİtiÚ
 = 
İtiÚ
;

1339 
io_cmd
 *
	gcmd
 = 
Ãw
 io_cmd(
dev
, 
ns
, 
que_hdl
);

1341 
	gcmd
->
	gioùx
.
	gkey
 = 
key
;

1342 
	gcmd
->
	gioùx
.
	gv®ue
 = 
cÚ¡_ÿ¡
<
kv_v®ue
 *>(
v®ue
);

1343 
	gcmd
->
	gioùx
.
	gtimeout_u£c
 = 0;

1344 ià(
	gpo¡_â
) {

1345 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
po¡_â
->post_fn;

1346 
	gcmd
->
	gioùx
.
	g´iv©e_d©a
 = 
po¡_â
->
´iv©e_d©a
;

1348 
	gcmd
->
	gioùx
.
	gpo¡_â
 = 
NULL
;

1350 
	gcmd
->
	gioùx
.
	gİcode
 = 
KV_OPC_STORE
;

1351 
	gcmd
->
	gioùx
.
	gcommªd
.
	g¡Üe_šfo
 = 
šfo
;

1354  
	gdev
->
subm™_io
(
que_hdl
, 
cmd
);

1360 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_pŞl_com¶‘iÚ
(
kv_queue_hªdË
 
que_hdl
, 
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
) {

1361 ià(
	gque_hdl
 =ğ
NULL
 || 
num_ev’ts
 == NULL) {

1362  
KV_ERR_PARAM_INVALID
;

1365 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1366 ià(
	gqueue
 =ğ
NULL
 || 
queue
->
g‘_ty³
(è!ğ
COMPLETION_Q_TYPE
) {

1367  
KV_ERR_QUEUE_QID_INVALID
;

1370  
	gqueue
->
pŞl_com¶‘iÚ
(
timeout_u£c
, 
num_ev’ts
);

1375 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
kv_£t_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
) {

1376 ià(
	gque_hdl
 =ğ
NULL
 || 
št_hdl
 == NULL) {

1377  
KV_ERR_PARAM_INVALID
;

1380 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1381 ià(
	gqueue
 =ğ
NULL
) {

1382  
KV_ERR_QUEUE_QID_INVALID
;

1386 ià(
	gqueue
->
g‘_ty³
(è!ğ
COMPLETION_Q_TYPE
) {

1387 
WRITE_WARN
("queuid %d i nÙ com¶‘iÚ queufÜ iÁ”ru± s‘up", 
que_hdl
->
qid
);

1388  
	gKV_ERR_QUEUE_QID_INVALID
;

1391 ià(
	gšt_hdl
 =ğ
NULL
) {

1392  
KV_ERR_PARAM_INVALID
;

1395  
	gqueue
->
š™_š‹¼u±_hªdËr
(
this
, 
št_hdl
);

1401 
kv_š‹¼u±_hªdËr
 
	gkv_deviû_š‹º®
::
kv_g‘_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
) {

1402 
ioqueue
 *
queue
 = (ioqueu*)(
que_hdl
->queue);

1403  
	gqueue
->
g‘_š‹¼u±_hªdËr
();

1407 
kv_»suÉ
 
	gkv_deviû_š‹º®
::
subm™_io
(
kv_queue_hªdË
 
que_hdl
, 
io_cmd
 *
cmd
) {

1409 ià(
	gque_hdl
 =ğ
NULL
 || 
cmd
 == NULL) {

1410  
KV_ERR_PARAM_INVALID
;

1419 
ioqueue
 *
	gqueue
 = (ioqueu*)(
que_hdl
->
queue
);

1420 ià(
	gqueue
 =ğ
NULL
) {

1421  
KV_ERR_QUEUE_QID_INVALID
;

1424 ià(
	gqueue
->
g‘_ty³
(è!ğ
SUBMISSION_Q_TYPE
) {

1425  
KV_ERR_QUEUE_QID_INVALID
;

1434 ià(
	gm_dev_ty³
 =ğ
KV_DEV_TYPE_LINUX_KERNEL
) {

1435 
k”Ãl_ioqueue
* 
kque
 = (k”Ãl_ioqueue*)
queue
;

1437 ià(
	gkque
->
fuÎ
()) {

1438  
	gKV_ERR_QUEUE_IS_FULL
;

1445 
kv_»suÉ
 
	g»s
 = 
cmd
->
execu‹_cmd
();

1446 ià(
	g»s
 =ğ
KV_SUCCESS
) {

1447 
kque
->
šü—£_qd•th
();

1450  
	g»s
;

1453 
emul_ioqueue
* 
	geque
 = (emul_ioqueue*)
queue
;

1455 autØ
	g»s
 = 
eque
->
’queue
(
cmd
, 
çl£
);

1457  
	g»s
;

1462 
ušt16_t
 
	gkv_deviû_š‹º®
::
g‘_cqid_äom_sqid
(ušt16_ˆ
sqid
) {

1463 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
lock
(
m_mu‹x
);

1464 
	g¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gušt16_t
>::
™”©Ü
 
™
 = 
m_sq_to_cq_·œs
.
fšd
(
sqid
);

1465 ià(
	g™
 !ğ
m_sq_to_cq_·œs
.
’d
()) {

1466  
™
->
£cÚd
;

1471 
ušt32_t
 
	gkv_deviû_š‹º®
::
g‘_Ãxt_devid
() {

1473 
¡d
::
lock_gu¬d
<¡d::
»cursive_mu‹x
> 
lock
(
s_mu‹x
);

1474 
ušt32_t
 
	gdevid
 = 
kv_deviû_š‹º®
::
s_Ãxt_devid
;

1475 
	gkv_deviû_š‹º®
::
s_Ãxt_devid
++;

1476  
	gdevid
;

1481 
boŞ_t
 
	gkv_deviû_š‹º®
::
upd©e_ÿ·c™y_cÚsumed
() {

1482 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
lock
(
m_mu‹x
);

1483 
ušt64_t
 
	gcÚsumed
 = 0;

1484 
ušt64_t
 
	gÿ·c™y
 = 0;

1486 auto& 
	g™
 : 
m_ns_li¡
) {

1487 
kv_Çme¥aû_š‹º®
 *
ns
 = 
™
.
£cÚd
;

1489 
	gcÚsumed
 +ğ
ns
->
g‘_cÚsumed_¥aû
();

1490 
	gÿ·c™y
 +ğ
ns
->
g‘_tÙ®_ÿ·c™y
();

1493 
	gutiz©iÚ
 = (1.0 * 
cÚsumed
 / 
ÿ·c™y
) * 10000;

1496 
	gm_ÿ·c™y
 = 
ÿ·c™y
;

1497 
	gm_deviû_šfo
.
	gÿ·c™y
 = 
ÿ·c™y
;

1499 
	gm_deviû_¡©
.
	gutiz©iÚ
 = 
round
(
utiz©iÚ
);

1504  
	gTRUE
;

1507 
	g¡d
::
¡ršg
& 
kv_deviû_š‹º®
::
g‘_dev·th
() {

1508  
m_dev·th
;

	@PDK/core/src/device_abstract_layer/emulator/src/kv_emulator.cpp

34 
	~<¡ršg
>

35 
	~<®gÜ™hm
>

36 
	~<b™£t
>

37 
	~<¡ršg
>

39 
	~<time.h
>

40 
	~"io_cmd.hµ
"

41 
	~"kv_emuÏtÜ.hµ
"

43 
ušt64_t
 
	g_kv_emul_queue_Ï‹ncy
;

45 
Çme¥aû
 
	gkvadi
 {

47 
kv_tim”
 
	gkv_emul_tim”
;

49 
	gkv_emuÏtÜ
::
kv_emuÏtÜ
(
ušt64_t
 
ÿ·c™y
, 
¡d
::
veùÜ
<> 
iİs_mod–_cÛffic›Ás
, 
boŞ_t
 
u£_iİs_mod–
, 
ušt32_t
 
nsid
): 
¡©
(iİs_mod–_cÛffic›Ás), 
m_ÿ·c™y
(ÿ·c™y),
m_avaabË
(ÿ·c™y), 
m_u£_iİs_mod–
(u£_iİs_mod–), 
m_nsid
(nsid) {

50 
mem£t
(
m_™”©Ü_li¡
, 0, (m_iterator_list));

54 
	gkv_emuÏtÜ
::~
kv_emuÏtÜ
() {

55 
¡d
::
unique_lock
<¡d::
mu‹x
> 
lock
(
m_m­_mu‹x
);

56 
	gemuÏtÜ_m­_t
::
™”©Ü
 
™_tmp
;

57 autØ
	g™
 = 
m_m­
.
begš
();

58 
	g™
 !ğ
m_m­
.
’d
()) {

59 
kv_key
 *
key
 = 
™
->
fœ¡
;

60 
ä“
(
key
->key);

61 
d–‘e
 
	gkey
;

63 
	g™_tmp
 = 
™
;

64 
	g™
++;

65 
	gm_m­
.
”a£
(
™_tmp
);

69 
šlše
 
kv_key
 *
Ãw_kv_key
(cÚ¡ kv_key *
key
) {

70 
kv_key
 *
	gcİ›d_key
 = 
Ãw
 kv_key();

71 
	gcİ›d_key
->
	gËngth
 = 
key
->
Ëngth
;

72 
	gcİ›d_key
->
	gkey
 = 
m®loc
(
key
->
Ëngth
);

73 
memıy
(
cİ›d_key
->
key
, key->key, key->
Ëngth
);

75  
	gcİ›d_key
;

78 
ušt64_t
 
	gcouÁ”
 = 0;

81 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_¡Üe
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
cÚsumed_by‹s
, *
ioùx
) {

82 (è
	gioùx
;

84 ià(
	gm_ÿ·c™y
 !ğ0 && 
m_avaabË
 < (
v®ue
->
Ëngth
 + 
key
->length)) {

86  
KV_ERR_DEV_CAPACITY
;

89 ià(
	gİtiÚ
 !ğ
KV_STORE_OPT_DEFAULT
 && 
İtiÚ
 !ğ
KV_STORE_OPT_IDEMPOTENT
) {

90  
KV_ERR_OPTION_INVALID
;

93 cÚ¡ 
	g¡d
::
¡ršg
 
v®¡r
 = 
¡d
::¡ršg((*)
v®ue
->v®ue, v®ue->
Ëngth
);

94 
time¥ec
 
	gbegš
;

95 ià(
	gm_u£_iİs_mod–
) {

96 
	gkv_emul_tim”
.
¡¬t2
(&
begš
);

100 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

103 autØ
	g™
 = 
m_m­
.
fšd
((
kv_key
 *)
key
);

104 ià(
	g™
 !ğ
m_m­
.
’d
()) {

105 ià(
İtiÚ
 =ğ
KV_STORE_OPT_IDEMPOTENT
è 
KV_ERR_KEY_EXIST
;

108 
	gm_avaabË
 -ğ
v®ue
->
Ëngth
 + 
™
->
£cÚd
.length();

111 
	g™
->
	g£cÚd
 = 
v®¡r
;

113 *
	gcÚsumed_by‹s
 = 
v®ue
->
Ëngth
;

114 ià(
	gm_u£_iİs_mod–
) {

115 
	g¡©
.
cŞËù
(
STAT_UPDATE
, 
v®ue
->
Ëngth
);

119 
kv_key
 *
	gÃw_key
 = 
Ãw_kv_key
(
key
);

120 
	gm_m­
.
em¶aû
(
¡d
::
make_·œ
(
Ãw_key
, std::
move
(
v®¡r
)));

122 
	gm_avaabË
 -ğ
key
->
Ëngth
 + 
v®ue
->length;

124 *
	gcÚsumed_by‹s
 = 
key
->
Ëngth
 + 
v®ue
->length;

126 ià(
	gm_u£_iİs_mod–
) {

127 
	g¡©
.
cŞËù
(
STAT_INSERT
, 
v®ue
->
Ëngth
);

130 
	gcouÁ”
 ++;

133 ià(
	gm_u£_iİs_mod–
) {

134 
	gkv_emul_tim”
.
wa™_uÁ2
(&
begš
,
¡©
.
g‘_ex³ùed_Ï‹ncy_ns
(è- 
_kv_emul_queue_Ï‹ncy
);

138  
	gKV_SUCCESS
;

141 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_»Œ›ve
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, *
ioùx
) {

142 (è
	gioùx
;

144 
kv_»suÉ
 
	g»t
 = 
KV_ERR_KEY_NOT_EXIST
;

146 
time¥ec
 
	gbegš
;

147 ià(
	gm_u£_iİs_mod–
) {

148 
	gkv_emul_tim”
.
¡¬t2
(&
begš
);

151 ià(
	gİtiÚ
 !ğ
KV_RETRIEVE_OPT_DEFAULT
) {

152  
KV_ERR_OPTION_INVALID
;

158 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

159 autØ
	g™
 = 
m_m­
.
fšd
((
kv_key
*)
key
);

160 ià(
	g™
 !ğ
m_m­
.
’d
()) {

161 
ušt32_t
 
dËn
 = 
™
->
£cÚd
.
Ëngth
();

162 ià(
	gv®ue
->
	goff£t
 >ğ
dËn
) {

163  
KV_ERR_VALUE_OFFSET_INVALID
;

165 
ušt32_t
 
	gcİyËn
 = 
¡d
::
mš
(
dËn
 - 
v®ue
->
off£t
, v®ue->
Ëngth
);

167 
memıy
(
v®ue
->v®ue, 
™
->
£cÚd
.
d©a
(è+ v®ue->
off£t
, 
cİyËn
);

169 
	gv®ue
->
	gËngth
 = 
cİyËn
;

170 
	gv®ue
->
	gaùu®_v®ue_size
 = 
dËn
;

172 ià(
	gm_u£_iİs_mod–
) {

173 
	g¡©
.
cŞËù
(
STAT_READ
, 
cİyËn
);

175 
	g»t
 = 
KV_SUCCESS
;

177  
	gKV_ERR_KEY_NOT_EXIST
;

180 ià(
	gm_u£_iİs_mod–
) {

182 
	gkv_emul_tim”
.
wa™_uÁ2
(&
begš
,
¡©
.
g‘_ex³ùed_Ï‹ncy_ns
(è- 
_kv_emul_queue_Ï‹ncy
);

184  
	g»t
;

188 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_exi¡
(cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
keycouÁ
, 
ušt8_t
 *
bufãrs
, ušt32_ˆ&
bufãr_size
, *
ioùx
) {

189 (è
	gioùx
;

191 
	gb™pos
 = 0;

193 ià(
	gkeycouÁ
 == 0) {

194  
KV_SUCCESS
;

197 cÚ¡ 
ušt32_t
 
	gby‹s_to_wr™e
 = ((
keycouÁ
 -1) / 8) + 1;

199 ià(
	gby‹s_to_wr™e
 > 
	gbufãr_size
) {

200  
	gKV_ERR_BUFFER_SMALL
;

203 
mem£t
 (
bufãrs
, 0, 
by‹s_to_wr™e
 );

205 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

207 
ušt32_t
 
	gi
 = 0 ; i < 
	gkeycouÁ
 ; i++, 
	gb™pos
++) {

208 cÚ¡ 
	g£tidx
 = (
b™pos
 / 8);

209 cÚ¡ 
	gb™off£t
 = 
b™pos
 - 
£tidx
 * 8;

211 autØ
	g™
 = 
m_m­
.
fšd
((
kv_key
*)&
key
[
i
]);

212 ià(
	g™
 !ğ
m_m­
.
’d
()) {

213 
bufãrs
[
£tidx
] |ğ(1 << 
b™off£t
);

217 
	gbufãr_size
 = 
by‹s_to_wr™e
;

219  
	gKV_SUCCESS
;

222 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_purge
(
kv_purge_İtiÚ
 
İtiÚ
, *
ioùx
) {

223 (è
	gioùx
;

225 ià(
	gİtiÚ
 !ğ
KV_PURGE_OPT_DEFAULT
) {

226 
WRITE_WARN
("only default…urge option is supported");

227  
	gKV_ERR_OPTION_INVALID
;

230 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

231 autØ
	g™
 = 
m_m­
.
begš
(); iˆ!ğm_m­.
’d
(); it++) {

232 
kv_key
 *
	gkey
 = 
™
->
fœ¡
;

233 
	gm_m­
.
”a£
(
™
);

234 
ä“
(
key
->key);

235 
d–‘e
 
	gkey
;

238 
	gm_avaabË
 = 
m_ÿ·c™y
;

239  
	gKV_SUCCESS
;

242 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_d–‘e
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
»cov”ed_by‹s
, *
ioùx
) {

243 (è
	gioùx
;

245 ià(
	gkey
 =ğ
NULL
 || 
key
->key == NULL) {

246  
KV_ERR_KEY_INVALID
;

249 ià(
	gİtiÚ
 !ğ
KV_DELETE_OPT_DEFAULT
 && 
İtiÚ
 !ğ
KV_DELETE_OPT_ERROR
) {

250  
KV_ERR_OPTION_INVALID
;

253 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

254 autØ
	g™
 = 
m_m­
.
fšd
((
kv_key
*)
key
);

255 ià(
	g™
 !ğ
m_m­
.
’d
()) {

256 
kv_key
 *
key
 = 
™
->
fœ¡
;

258 
ušt32_t
 
	gËn
 = 
key
->
Ëngth
 + 
™
->
£cÚd
.length();

259 
	gm_avaabË
 +ğ
Ën
;

260 ià(
	g»cov”ed_by‹s
 !ğ
NULL
) {

261 *
»cov”ed_by‹s
 = 
Ën
;

264 
	gm_m­
.
”a£
(
™
);

265 
ä“
(
key
->key);

266 
d–‘e
 
	gkey
;

268 ià(
	gİtiÚ
 =ğ
KV_DELETE_OPT_ERROR
) {

269  
KV_ERR_KEY_NOT_EXIST
;

273  
	gKV_SUCCESS
;

277 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_İ’_™”©Ü
(cÚ¡ 
kv_™”©Ü_İtiÚ
 
İt
, cÚ¡ 
kv_group_cÚd™iÚ
 *
cÚd
, 
boŞ_t
 
keyËn_fixed
, 
kv_™”©Ü_hªdË
 *
™”_hdl
, *
ioùx
) {

278 (è
	gioùx
;

280 ià(
	gcÚd
 =ğ
NULL
 || 
™”_hdl
 =ğNULL || 
cÚd
 == NULL) {

281  
KV_ERR_PARAM_INVALID
;

284 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_™_m­_mu‹x
);

285 
ušt32_t
 
	gcur_™_couÁ
 = 
m_™_m­
.
size
();

286 ià(
	gcur_™_couÁ
 >ğ
SAMSUNG_MAX_ITERATORS
) {

287 *
™”_hdl
 = 0;

288  
	gKV_ERR_TOO_MANY_ITERATORS_OPEN
;

292 
	gi
 = 0; i < 
	gSAMSUNG_MAX_ITERATORS
; i++) {

293 ià(
	gm_™”©Ü_li¡
[
i
].
	g´efix
 =ğ
cÚd
->
b™_·‰”n


294 && 
m_™”©Ü_li¡
[
i
].
b™mask
 =ğ
cÚd
->bitmask

295 && 
m_™”©Ü_li¡
[
i
].
¡©us
 == 1) {

296 *
™”_hdl
 = 0;

297  
	gKVS_ERR_ITERATOR_OPEN
;

301 
_kv_™”©Ü_hªdË
 *
	giH
 = 
Ãw
 _kv_iterator_handle();

302 
	giH
->
	g™_İ
 = 
İt
;

303 
	giH
->
	g™_cÚd
.
	gb™mask
 = 
cÚd
->
b™mask
;

304 
	giH
->
	g™_cÚd
.
	gb™_·‰”n
 = 
cÚd
->
b™_·‰”n
;

305 
	giH
->
	ghas_fixed_keyËn
 = 
keyËn_fixed
;

307 
ušt32_t
 
	g´efix
 = 
iH
->
™_cÚd
.
b™_·‰”n
 & iH->™_cÚd.
b™mask
;

308 
memıy
((*)
iH
->
cu¼’t_key
, (*)&
´efix
, 4);

309 
	giH
->
	gkeyËngth
 = 4;

310 
	giH
->
	g’d
 = 
FALSE
;

316 
kv_™”©Ü_hªdË
 
	g™id
 = 1;

317 ; 
	g™id
 <ğ
SAMSUNG_MAX_ITERATORS
; itid++) {

318 ià(
	gm_™_m­
.
fšd
(
™id
è=ğ
m_™_m­
.
’d
()) {

323 
	gm_™_m­
.
š£¹
(
¡d
::
make_·œ
(
™id
, 
iH
));

326 
	gm_™”©Ü_li¡
[
™id
 - 1].
	ghªdË_id
 = itid;

327 
	gm_™”©Ü_li¡
[
™id
 - 1].
	g¡©us
 = 1;

328 
	gm_™”©Ü_li¡
[
™id
 - 1].
	gty³
 = 
İt
;

329 
	gm_™”©Ü_li¡
[
™id
 - 1].
	gkey¥aû_id
 = 
m_nsid
;

330 
	gm_™”©Ü_li¡
[
™id
 - 1].
	g´efix
 = 
cÚd
->
b™_·‰”n
;

331 
	gm_™”©Ü_li¡
[
™id
 - 1].
	gb™mask
 = 
cÚd
->
b™mask
;

332 
	gm_™”©Ü_li¡
[
™id
 - 1].
	gis_eof
 = 0;

334 (*
	g™”_hdl
èğ
™id
;

335  
	gKV_SUCCESS
;

338 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_™”©Ü_Ãxt_£t
(
kv_™”©Ü_hªdË
 
™”_hªdË_id
, 
kv_™”©Ü_li¡
 *
™”_li¡
, *
ioùx
) {

339 (è
	gioùx
;

341 ià(
	g™”_hªdË_id
 =ğ0 || 
™”_li¡
 =ğ
NULL
) {

342  
KV_ERR_PARAM_INVALID
;

345 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

346 
_kv_™”©Ü_hªdË
 *
	g™”_hdl
 = 
NULL
;

347 autØ
	g™1
 = 
m_™_m­
.
fšd
(
™”_hªdË_id
);

348 ià(
	g™1
 !ğ
m_™_m­
.
’d
()) {

349 
™”_hdl
 = 
™1
->
£cÚd
;

351  
	gKV_ERR_ITERATOR_NOT_EXIST
;

354 cÚ¡ 
boŞ
 
	gšşude_v®ue
 = 
™”_hdl
->
™_İ
 =ğ
KV_ITERATOR_OPT_KV
 || i‹r_hdl->™_İ =ğ
KV_ITERATOR_OPT_KV_WITH_DELETE
;

355 cÚ¡ 
boŞ
 
	gd–‘e_v®ue
 = 
™”_hdl
->
™_İ
 =ğ
KV_ITERATOR_OPT_KV_WITH_DELETE
;

357 
kv_key
 
	gkey
;

358 
	gkey
.key = 
™”_hdl
->
cu¼’t_key
;

359 
	gkey
.
	gËngth
 = 
™”_hdl
->
keyËngth
;

362 
ušt32_t
 
	gto_m©ch
 = 
™”_hdl
->
™_cÚd
.
b™mask
 & i‹r_hdl->™_cÚd.
b™_·‰”n
;

365 
boŞ
 
	g™”©e_®l
 = (
™”_hdl
->
™_cÚd
.
b™mask
 == 0);

367 
boŞ_t
 
	g’d
 = 
TRUE
;

368 
	g™”_li¡
->
	g’d
 = 
TRUE
;

370 
	g™”_li¡
->
	gnum_’Œ›s
 = 0;

371 cÚ¡ 
ušt32_t
 
	gbufãr_size
 = 
™”_li¡
->
size
;

372 *
	gbufãr
 = (*è
™”_li¡
->
™_li¡
;

373 
ušt32_t
 
	gbufãr_pos
 = 0;

374 
	gcouÁ”
 = 0;

377 
ušt32_t
 
	g´efix
 = 0;

378 autØ
	g™
 = 
m_m­
.
low”_bound
(&
key
);

379 
	g™
 !ğ
m_m­
.
’d
()) {

380 cÚ¡ 
kËngth
 = 
™
->
fœ¡
->
Ëngth
;

381 cÚ¡ 
	gvËngth
 = 
™
->
£cÚd
.
Ëngth
();

384 ià(!
	g™”©e_®l
) {

386 
memıy
(&
´efix
, 
™
->
fœ¡
->
key
, 4);

389 ià(((
	g´efix
 & 
	g™”_hdl
->
	g™_cÚd
.
	gb™mask
è& i‹r_hdl->™_cÚd.
	gb™_·‰”n
è!ğ
to_m©ch
) {

390 
™”_li¡
->
’d
 = 
TRUE
;

391 
	g’d
 = 
TRUE
;

398 
size_t
 
	gd©asize
 = 
kËngth
;

399 ià(!
	g™”_hdl
->
	ghas_fixed_keyËn
) {

400 
	gd©asize
 +ğ(
ušt32_t
);

402 
	gd©asize
 +ğ(
šşude_v®ue
)? (
vËngth
 + (
ušt32_t
)):0;

404 ià((
	gbufãr_pos
 + 
	gd©asize
è> 
	gbufãr_size
) {

406 
	g™”_li¡
->
	g’d
 = 
FALSE
;

407 
	g’d
 = 
FALSE
;

408 
	g™”_hdl
->
	gkeyËngth
 = 
kËngth
;

409 
memıy
(
™”_hdl
->
cu¼’t_key
, 
™
->
fœ¡
->
key
, 
kËngth
);

417 ià(!
	g™”_hdl
->
	ghas_fixed_keyËn
) {

418 
memıy
(
bufãr
 + 
bufãr_pos
, &
kËngth
, (
ušt32_t
));

419 
	gbufãr_pos
 +ğ(
ušt32_t
);

421 
memıy
(
bufãr
 + 
bufãr_pos
, 
™
->
fœ¡
->
key
, 
kËngth
);

422 
	gbufãr_pos
 +ğ
kËngth
;

424 ià(
	gšşude_v®ue
) {

425 
memıy
(
bufãr
 + 
bufãr_pos
, &
vËngth
, (
kv_v®ue_t
));

426 
	gbufãr_pos
 +ğ(
kv_v®ue_t
);

428 
memıy
(
bufãr
 + 
bufãr_pos
, 
™
->
£cÚd
.
d©a
(), 
vËngth
);

429 
	gbufãr_pos
 +ğ
vËngth
;

431 
	gcouÁ”
++;

433 ià(
	gd–‘e_v®ue
) {

434 
	g™
 = 
m_m­
.
”a£
(
™
);

436 
	g™
++;

442 
	g™”_li¡
->
	gnum_’Œ›s
 = 
couÁ”
;

443 ià(
	g’d
 !ğ
TRUE
) {

444 
m_™”©Ü_li¡
[
™”_hªdË_id
 - 1].
is_eof
 = 0;

446 
	gm_™”©Ü_li¡
[
™”_hªdË_id
 - 1].
	gis_eof
 = 1;

449  
	gKV_SUCCESS
;

453 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_™”©Ü_Ãxt
(
kv_™”©Ü_hªdË
 
™”_hªdË_id
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, *
ioùx
) {

454 (è
	gioùx
;

456 ià(
	g™”_hªdË_id
 =ğ0 || 
key
 =ğ
NULL
 || key->key =ğNULL || 
v®ue
 == NULL || value->value == NULL) {

457  
KV_ERR_PARAM_INVALID
;

460 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

461 
_kv_™”©Ü_hªdË
 *
	g™”_hdl
 = 
NULL
;

462 autØ
	g™1
 = 
m_™_m­
.
fšd
(
™”_hªdË_id
);

463 ià(
	g™1
 !ğ
m_™_m­
.
’d
()) {

464 
™”_hdl
 = 
™1
->
£cÚd
;

466  
	gKV_ERR_ITERATOR_NOT_EXIST
;

469 cÚ¡ 
boŞ
 
	gšşude_v®ue
 = 
™”_hdl
->
™_İ
 =ğ
KV_ITERATOR_OPT_KV
 || i‹r_hdl->™_İ =ğ
KV_ITERATOR_OPT_KV_WITH_DELETE
;

470 cÚ¡ 
boŞ
 
	gd–‘e_v®ue
 = 
™”_hdl
->
™_İ
 =ğ
KV_ITERATOR_OPT_KV_WITH_DELETE
;

472 
kv_key
 
	gkey1
;

473 
	gkey1
.
	gkey
 = 
™”_hdl
->
cu¼’t_key
;

474 
	gkey1
.
	gËngth
 = 
™”_hdl
->
keyËngth
;

477 ià(
	g™”_hdl
->
	g’d
) {

478 
	g™”_hdl
->
	g’d
 = 
TRUE
;

479  
	gKV_SUCCESS
;

483 
ušt32_t
 
	gto_m©ch
 = 
™”_hdl
->
™_cÚd
.
b™mask
 & i‹r_hdl->™_cÚd.
b™_·‰”n
;

485 
ušt32_t
 
	g´efix
 = 0;

486 autØ
	g™
 = 
m_m­
.
low”_bound
(&
key1
);

489 ià(
	g™
 =ğ
m_m­
.
’d
()) {

490 
™”_hdl
->
’d
 = 
TRUE
;

491  
	gKV_SUCCESS
;

494 cÚ¡ 
ušt32_t
 
	gkËngth
 = 
™
->
fœ¡
->
Ëngth
;

495 cÚ¡ 
ušt32_t
 
	gvËngth
 = 
™
->
£cÚd
.
Ëngth
();

498 
memıy
(&
´efix
, 
™
->
fœ¡
->
key
, 4);

501 ià(((
	g´efix
 & 
	g™”_hdl
->
	g™_cÚd
.
	gb™mask
è& i‹r_hdl->™_cÚd.
	gb™_·‰”n
è!ğ
to_m©ch
) {

502 
™”_hdl
->
’d
 = 
TRUE
;

503  
	gKV_SUCCESS
;

509 
	gkey
->
	gËngth
 = 
kËngth
;

510 ià(
	gkËngth
 > 
	gkey
->
	gËngth
) {

512 
	g™”_hdl
->
	gkeyËngth
 = 
kËngth
;

513 
memıy
(
™”_hdl
->
cu¼’t_key
, 
™
->
fœ¡
->
key
, 
kËngth
);

514  
	gKV_ERR_BUFFER_SMALL
;

517 ià(
	g™”_hdl
->
	g™_İ
 =ğ
KV_ITERATOR_OPT_KV
 || 
™”_hdl
->
™_İ
 =ğ
KV_ITERATOR_OPT_KV_WITH_DELETE
) {

518 
v®ue
->
aùu®_v®ue_size
 = 
vËngth
;

519 ià(
	gvËngth
 > 
	gv®ue
->
	gËngth
) {

520 
	gv®ue
->
	gËngth
= 0;

521 
	gv®ue
->
	goff£t
 = 0;

522 
	g™”_hdl
->
	gkeyËngth
 = 
kËngth
;

524 
memıy
(
™”_hdl
->
cu¼’t_key
, 
™
->
fœ¡
->
key
, 
kËngth
);

525  
	gKV_ERR_BUFFER_SMALL
;

529 
memıy
(
key
->key, 
™
->
fœ¡
->key, 
kËngth
);

531 ià(
	gšşude_v®ue
) {

532 
memıy
(
v®ue
->v®ue, 
™
->
£cÚd
.
d©a
(), 
vËngth
);

533 
	gv®ue
->
	gËngth
ğ
vËngth
;

534 
	gv®ue
->
	gaùu®_v®ue_size
 = 
vËngth
;

535 
	gv®ue
->
	goff£t
 = 0;

539 ià(
	gd–‘e_v®ue
) {

540 
	g™
 = 
m_m­
.
”a£
(
™
);

542 
	g™
++;

545 ià(
	g™
 !ğ
m_m­
.
’d
()) {

546 
key
->
Ëngth
 = 
kËngth
;

547 
	g™”_hdl
->
	gkeyËngth
 = 
kËngth
;

548 
memıy
(
™”_hdl
->
cu¼’t_key
, 
™
->
fœ¡
->
key
, 
kËngth
);

549 
	gm_™”©Ü_li¡
[
™”_hªdË_id
 - 1].
	gis_eof
 = 0;

551 
	g™”_hdl
->
	g’d
 = 
TRUE
;

552 
	gm_™”©Ü_li¡
[
™”_hªdË_id
 - 1].
	gis_eof
 = 1;

555  
	gKV_SUCCESS
;

558 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_şo£_™”©Ü
(
kv_™”©Ü_hªdË
 
™”_hªdË_id
, *
ioùx
) {

559 (è
	gioùx
;

561 ià(
	g™”_hªdË_id
 <ğ0è 
KV_ERR_PARAM_INVALID
;

563 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_™_m­_mu‹x
);

564 autØ
	g™
 = 
m_™_m­
.
fšd
(
™”_hªdË_id
);

565 ià(
	g™
 !ğ
m_™_m­
.
’d
()) {

566 
d–‘e
 
™
->
£cÚd
;

567 
	gm_™_m­
.
”a£
(
™
);

570 
	gm_™”©Ü_li¡
[
™”_hªdË_id
 - 1].
	g¡©us
 = 0;

573  
	gKV_SUCCESS
;

577 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_li¡_™”©Üs
(
kv_™”©Ü
 *
™”_li¡
, 
ušt32_t
 *
couÁ
, *
ioùx
) {

579 ià(
	g™”_li¡
 =ğ
NULL
 || 
couÁ
 == NULL) {

580  
KV_ERR_PARAM_INVALID
;

583 
ušt32_t
 
	gi
 = 0;

584 cÚ¡ 
ušt32_t
 
	gmš
 = 
¡d
::
mš
(*
couÁ
, (ušt32_tè
SAMSUNG_MAX_ITERATORS
);

585 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_™_m­_mu‹x
);

587 ; 
	gi
 < 
	gmš
; i++) {

588 
	g™”_li¡
[
i
].
	ghªdË_id
 = 
m_™”©Ü_li¡
[i].
hªdË_id
;

589 
	g™”_li¡
[
i
].
	g¡©us
 = 
m_™”©Ü_li¡
[i].
¡©us
;

590 
	g™”_li¡
[
i
].
	gty³
 = 
m_™”©Ü_li¡
[i].
ty³
;

591 
	g™”_li¡
[
i
].
	gkey¥aû_id
 = 
m_™”©Ü_li¡
[i].
key¥aû_id
;

592 
	g™”_li¡
[
i
].
	g´efix
 = 
m_™”©Ü_li¡
[i].
´efix
;

593 
	g™”_li¡
[
i
].
	gb™mask
 = 
m_™”©Ü_li¡
[i].
b™mask
;

594 
	g™”_li¡
[
i
].
	gis_eof
 = 
m_™”©Ü_li¡
[i].
is_eof
;

596 *
	gcouÁ
 = 
mš
;

600 
io_cmd
 *
	giÜeq
 = (io_cmd *è
ioùx
;

601 
	giÜeq
->
ÿÎ_po¡_´oûss_func
();

602 
d–‘e
 
	giÜeq
;

604  
	gKV_SUCCESS
;

607 
kv_»suÉ
 
	gkv_emuÏtÜ
::
kv_d–‘e_group
(
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
ušt64_t
 *
»cov”ed_by‹s
, *
ioùx
) {

608 (è
	gioùx
;

610 
ušt32_t
 
	gmškey
 = 
g½_cÚd
->
b™mask
 & g½_cÚd->
b™_·‰”n
;

612 
kv_key
 
	gkey
;

613 
	gkey
.key = &
mškey
;

614 
	gkey
.
	gËngth
 = 4;

617 
ušt32_t
 
	gto_m©ch
 = 
g½_cÚd
->
b™mask
 & g½_cÚd->
b™_·‰”n
;

618 
	gemuÏtÜ_m­_t
::
™”©Ü
 
™_tmp
;

620 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
m_m­_mu‹x
);

622 autØ
	g™
 = 
m_m­
.
low”_bound
(&
key
);

623 
	g™
 !ğ
m_m­
.
’d
()) {

624 
ušt32_t
 
´efix
 = 0;

625 
memıy
(&
´efix
, 
™
->
fœ¡
->
key
, 4);

630 ià(((
	g´efix
 & 
	gg½_cÚd
->
	gb™mask
è& g½_cÚd->
	gb™_·‰”n
è!ğ
to_m©ch
 ) {

631  
KV_SUCCESS
;

635 
kv_key
 *
	gk
 = 
™
->
fœ¡
;

636 
	gm_avaabË
 +ğ
k
->
Ëngth
 + 
™
->
£cÚd
.length();

638 
	g™_tmp
 = 
™
;

639 
	g™
++;

640 
	gm_m­
.
”a£
(
™_tmp
);

643  
	gKV_SUCCESS
;

646 
kv_»suÉ
 
	gkv_emuÏtÜ
::
£t_š‹¼u±_hªdËr
(cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
) {

647 ià(
št_hdl
 =ğ
NULL
) {

648  
KV_ERR_PARAM_INVALID
;

650 
	gm_š‹¼u±_hªdËr
 = 
št_hdl
;

651  
	gKV_SUCCESS
;

654 
kv_š‹¼u±_hªdËr
 
	gkv_emuÏtÜ
::
g‘_š‹¼u±_hªdËr
() {

655  
m_š‹¼u±_hªdËr
;

659 
kv_»suÉ
 
	gkv_emuÏtÜ
::
pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
) {

660 (è
	gtimeout_u£c
;

661 (è
	gnum_ev’ts
;

662  
	gKV_ERR_DEV_INIT
;

665 
ušt64_t
 
	gkv_emuÏtÜ
::
g‘_tÙ®_ÿ·c™y
(è{  
m_ÿ·c™y
; }

666 
ušt64_t
 
	gkv_emuÏtÜ
::
g‘_avaabË
(è{  
m_avaabË
; }

	@PDK/core/src/device_abstract_layer/emulator/src/kv_namespace.cpp

34 
	~<boo¡/tok’iz”.hµ
>

35 
	~"kvs_adi.h
"

36 
	~"kvs_adi_š‹º®.h
"

38 
	~"kv_Çme¥aû.hµ
"

39 
	~"kv_emuÏtÜ.hµ
"

40 
	~"kv_deviû.hµ
"

42 
Çme¥aû
 
	gkvadi
 {

44 
kv_deviû_­i
 *
	gkv_Çme¥aû_š‹º®
::
g‘_kv¡Üe
() {

45  
m_kv¡Üe
;

50 
ušt32_t
 
	gkv_Çme¥aû_š‹º®
::
g‘_nsid
() {

51  
m_nsid
;

54 
kv_deviû_š‹º®
 *
	gkv_Çme¥aû_š‹º®
::
g‘_dev
() {

55  
m_dev
;

58 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
g‘_š™_¡©us
() {

59  
m_š™_¡©us
;

62 
	gkv_Çme¥aû_š‹º®
::
kv_Çme¥aû_š‹º®
(
kv_deviû_š‹º®
 *
dev
, 
ušt32_t
 
nsid
, cÚ¡ 
kv_Çme¥aû
 *
ns
) {

63 
	gm_nsid
 = 
nsid
;

64 
	gm_dev
 = 
dev
;

66 ià(
	gns
 !ğ
NULL
) {

67 
m_ns_šfo
 = *
ns
;

70 
	gm_ns_¡©
.
	gnsid
 = 
nsid
;

71 
	gm_ns_¡©
.
	g©ched
 = 
TRUE
;

72 
	gm_ns_¡©
.
	gÿ·c™y
 = 
m_ns_šfo
.
ÿ·c™y
;

73 
	gm_ns_¡©
.
	guÇÎoÿ‹d_ÿ·c™y
 = 
m_ns_¡©
.
ÿ·c™y
;

75 ià(
	gdev
->
g‘_dev_ty³
(è=ğ
KV_DEV_TYPE_EMULATOR
) {

77 
kv_cÚfig
 *
devcÚfig
 = 
dev
->
g‘_cÚfig
();

78 
	g¡d
::
¡ršg
 
mod–_¡ršg
 = 
devcÚfig
->
g‘kv
("iops_model", "parameters");

79 
boŞ_t
 
	gu£_iİs_mod–
 = 
dev
->
u£_iİs_mod–
();

81 
	g¡d
::
veùÜ
<> 
iİs_mod–_·¿m‘”s
;

83 ià(
	gmod–_¡ršg
.
size
() > 0) {

84 
	gboo¡
::
	ttok’iz”
<
	tboo¡
::
	tch¬_£·¿tÜ
<> >okenizer;

85 
	gboo¡
::
ch¬_£·¿tÜ
<> 
£p
(" ,");

86 
tok’iz”
 
tok’s
(
mod–_¡ršg
, 
£p
);

87 
	gtok’iz”
::
™”©Ü
 
tok_™”
 = 
tok’s
.
begš
(); 
	gtok_™”
 !ğtok’s.
’d
(); ++tok_iter) {

89 
	giİs_mod–_·¿m‘”s
.
push_back
(
¡d
::
¡od
(*
tok_™”
));

94 
	gm_emul
 = 
Ãw
 
kv_emuÏtÜ
(
m_ns_¡©
.
ÿ·c™y
, 
iİs_mod–_·¿m‘”s
, 
u£_iİs_mod–
, 
nsid
);

96 
	gm_dummy
 = 
Ãw
 
kv_noİ_emuÏtÜ
(
m_ns_¡©
.
ÿ·c™y
);

97 
	gm_kv¡Üe
 = 
m_emul
;

100 
årštf
(
¡d”r
, "Unsupported device detected,…lease validate device…ath‡nd„einitialize.\n");

101 
abÜt
();

104 ià(
	gm_kv¡Üe
 =ğ
NULL
) {

105 
m_š™_¡©us
 = 
KV_ERR_DEV_INIT
;

107 
	gm_š™_¡©us
 = 
m_kv¡Üe
->
g‘_š™_¡©us
();

111 
	gkv_Çme¥aû_š‹º®
::~
kv_Çme¥aû_š‹º®
() {

112 ià(
m_kv¡Üe
è
d–‘e
 m_kvstore;

113 ià(
	gm_dummy
è
d–‘e
 m_dummy;

116 
boŞ_t
 
	gkv_Çme¥aû_š‹º®
::
is_purge_š_´og»ss
() {

117  
m_purgšg_š_´og»ss
;

120 
	gkv_Çme¥aû_š‹º®
::
£t_purge_š_´og»ss
(
boŞ_t
 
š_´og»ss
) {

121 
m_purgšg_š_´og»ss
 = 
š_´og»ss
;

125 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_g‘_Çme¥aû_šfo
(
kv_Çme¥aû
 *
nsšfo
) {

126 ià(
nsšfo
 =ğ
NULL
) {

127  
KV_ERR_PARAM_INVALID
;

129 *
	gnsšfo
 = 
m_ns_šfo
;

130  
	gKV_SUCCESS
;

133 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_g‘_Çme¥aû_¡©
(
kv_Çme¥aû_¡©
 *
ns_¡
) {

134 ià(
ns_¡
 =ğ
NULL
) {

135  
KV_ERR_PARAM_INVALID
;

140 
	gm_ns_¡©
.
	guÇÎoÿ‹d_ÿ·c™y
 = 
m_kv¡Üe
->
g‘_avaabË
();

142 *
	gns_¡
 = 
m_ns_¡©
;

143  
	gKV_SUCCESS
;

148 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_purge
(
kv_purge_İtiÚ
 
İtiÚ
, *
ioùx
) {

149 
£t_purge_š_´og»ss
(
TRUE
);

150 
kv_»suÉ
 
	g»s
 = 
m_kv¡Üe
->
kv_purge
(
İtiÚ
, 
ioùx
);

153 ià(
	g»s
 =ğ
KV_SUCCESS
) {

154 
m_ns_¡©
.
uÇÎoÿ‹d_ÿ·c™y
 = m_ns_¡©.
ÿ·c™y
;

156 
£t_purge_š_´og»ss
(
FALSE
);

158  
	g»s
;

163 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_¡Üe
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
cÚsumed_by‹s
, *
ioùx
) {

164 ià(
	gkey
 =ğ
NULL
 || 
v®ue
 == NULL) {

165  
KV_ERR_PARAM_INVALID
;

168 
kv_»suÉ
 
	g»s
 = 
m_kv¡Üe
->
kv_¡Üe
(
key
, 
v®ue
, 
İtiÚ
, 
cÚsumed_by‹s
, 
ioùx
);

170 ià(
	g»s
 =ğ
KV_SUCCESS
 && 
cÚsumed_by‹s
 !ğ
NULL
) {

172 
m_ns_¡©
.
uÇÎoÿ‹d_ÿ·c™y
 -ğ*
cÚsumed_by‹s
;

175  
	g»s
;

178 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_d–‘e
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
»cov”ed_by‹s
, *
ioùx
) {

179 ià(
	gkey
 =ğ
NULL
) {

180  
KV_ERR_PARAM_INVALID
;

183 
kv_»suÉ
 
	g»s
 = 
m_kv¡Üe
->
kv_d–‘e
(
key
, 
İtiÚ
, 
»cov”ed_by‹s
, 
ioùx
);

185 ià(
	g»s
 =ğ
KV_SUCCESS
 && 
»cov”ed_by‹s
 !ğ
NULL
) {

187 
m_ns_¡©
.
uÇÎoÿ‹d_ÿ·c™y
 +ğ*
»cov”ed_by‹s
;

189  
	g»s
;

193 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_exi¡
(cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
keycouÁ
, 
ušt8_t
 *
v®ue
, ušt32_ˆ&
v®uesize
, *
ioùx
) {

194 ià(
	gkey
 =ğ
NULL
 || 
v®ue
== NULL) {

195  
KV_ERR_PARAM_INVALID
;

197  
	gm_kv¡Üe
->
kv_exi¡
(
key
, 
keycouÁ
, 
v®ue
, 
v®uesize
, 
ioùx
);

200 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_»Œ›ve
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, *
ioùx
) {

201 ià(
	gkey
 =ğ
NULL
 || 
v®ue
 == NULL) {

202  
KV_ERR_PARAM_INVALID
;

205  
	gm_kv¡Üe
->
kv_»Œ›ve
(
key
, 
İtiÚ
, 
v®ue
, 
ioùx
);

210 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_İ’_™”©Ü
(cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
kv_™”©Ü_hªdË
 *
™”_hdl
, *
ioùx
) {

211 ià(
	g™”_hdl
 =ğ0 || 
™_cÚd
 =ğ
NULL
) {

212  
KV_ERR_PARAM_INVALID
;

215  
	gm_kv¡Üe
->
kv_İ’_™”©Ü
(
™_İ
, 
™_cÚd
, 
m_dev
->
is_keyËn_fixed
(), 
™”_hdl
, 
ioùx
);

219 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_şo£_™”©Ü
(
kv_™”©Ü_hªdË
 
™”_hdl
, *
ioùx
) {

221  (
	gm_kv¡Üe
->
kv_şo£_™”©Ü
(
™”_hdl
, 
ioùx
));

224 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_™”©Ü_Ãxt_£t
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, *
ioùx
) {

225 ià(
	g™”_hdl
 =ğ0 || 
™”_li¡
 =ğ
NULL
) {

226  
KV_ERR_PARAM_INVALID
;

229  
	gm_kv¡Üe
->
kv_™”©Ü_Ãxt_£t
(
™”_hdl
, 
™”_li¡
, 
ioùx
);

233 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_™”©Ü_Ãxt
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, *
ioùx
) {

234 ià(
	g™”_hdl
 =ğ0 || 
key
 =ğ
NULL
 || 
v®ue
 == NULL) {

235  
KV_ERR_PARAM_INVALID
;

238  
	gm_kv¡Üe
->
kv_™”©Ü_Ãxt
(
™”_hdl
, 
key
, 
v®ue
, 
ioùx
);

241 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_li¡_™”©Üs
(
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
, *
ioùx
) {

242 ià(
	gkv_™”s
 =ğ
NULL
 || 
™”_út
 == NULL) {

243  
KV_ERR_PARAM_INVALID
;

246  
	gm_kv¡Üe
->
kv_li¡_™”©Üs
(
kv_™”s
, 
™”_út
, 
ioùx
);

249 
kv_»suÉ
 
	gkv_Çme¥aû_š‹º®
::
kv_d–‘e_group
(
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
ušt64_t
 *
»cov”ed_by‹s
, *
ioùx
) {

250 ià(
	gg½_cÚd
 =ğ
NULL
) {

251  
KV_ERR_PARAM_INVALID
;

254  
	gm_kv¡Üe
->
kv_d–‘e_group
(
g½_cÚd
, 
»cov”ed_by‹s
, 
ioùx
);

257 
ušt64_t
 
	gkv_Çme¥aû_š‹º®
::
g‘_tÙ®_ÿ·c™y
() {

258  
m_kv¡Üe
->
g‘_tÙ®_ÿ·c™y
();

261 
ušt64_t
 
	gkv_Çme¥aû_š‹º®
::
g‘_avaabË
() {

262  
m_kv¡Üe
->
g‘_avaabË
();

266 
	gkv_Çme¥aû_š‹º®
::
sw­_deviû
(
boŞ
 
u£dummy
) {

267 ià(
m_dev
->
g‘_dev_ty³
(è=ğ
KV_DEV_TYPE_EMULATOR
) {

268 
m_kv¡Üe
 = (
u£dummy
)? 
m_dummy
:
m_emul
;

272 
ušt64_t
 
	gkv_Çme¥aû_š‹º®
::
g‘_cÚsumed_¥aû
() {

273 
ušt64_t
 
ÿ·c™y
 = 
m_kv¡Üe
->
g‘_tÙ®_ÿ·c™y
();

274 
	gm_ns_¡©
.
	gÿ·c™y
 = 
ÿ·c™y
;

276 
ušt64_t
 
	gavaabË
 = 
m_kv¡Üe
->
g‘_avaabË
();

277 
	gm_ns_¡©
.
	guÇÎoÿ‹d_ÿ·c™y
 = 
avaabË
;

279  (
	gÿ·c™y
 - 
	gavaabË
);

	@PDK/core/src/device_abstract_layer/emulator/src/kvs_adi.cpp

34 
	~<m­
>

40 
	~"kvs_adi.h
"

41 
	~"kvs_adi_š‹º®.h
"

44 
	~"io_cmd.hµ
"

45 
	~"queue.hµ
"

47 
	~"kv_deviû.hµ
"

48 
	~"kv_Çme¥aû.hµ
"

49 
	~"kvs_adi_š‹º®.h
"

50 
	~"th»ad_poŞ.hµ
"

54 
usšg
 
Çme¥aû
 
	gkvadi
;

58 
kv_»suÉ
 
	$kv_š™Ÿlize_deviû
(*
dev_š™
, 
kv_deviû_hªdË
 *
dev_hdl
) {

59  
kv_deviû_š‹º®
::
	`kv_š™Ÿlize_deviû
((
kv_deviû_š™_t
 *è
dev_š™
, 
dev_hdl
);

60 
	}
}

62 
kv_»suÉ
 
	$kv_ş—nup_deviû
(
kv_deviû_hªdË
 
dev_hdl
) {

63  
kv_deviû_š‹º®
::
	`kv_ş—nup_deviû
(
dev_hdl
);

64 
	}
}

66 
kv_»suÉ
 
	$kv_g‘_deviû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû
 *
devšfo
)

68  
kv_deviû_š‹º®
::
	`kv_g‘_deviû_šfo
(
dev_hdl
, 
devšfo
);

69 
	}
}

71 
kv_»suÉ
 
	$kv_g‘_deviû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû_¡©
 *
dev_¡
) {

72  
kv_deviû_š‹º®
::
	`kv_g‘_deviû_¡©
(
dev_hdl
, 
dev_¡
);

73 
	}
}

75 
kv_»suÉ
 
	$kv_§n™ize
(
kv_queue_hªdË
 
que_hdl
, 
kv_deviû_hªdË
 
dev_hdl
, 
kv_§n™ize_İtiÚ
 
İtiÚ
, 
kv_§n™ize_·‰”n
 *
·‰”n
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
)

77  
kv_deviû_š‹º®
::
	`kv_§n™ize
(
que_hdl
, 
dev_hdl
, 
İtiÚ
, 
·‰”n
, 
po¡_â
);

78 
	}
}

81 
kv_»suÉ
 
	$kv_ü—‹_queue
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue
 *
que
, 
kv_queue_hªdË
 *
que_hdl
) {

82  
kv_deviû_š‹º®
::
	`kv_ü—‹_queue
(
dev_hdl
, 
que
, 
que_hdl
);

83 
	}
}

85 
kv_»suÉ
 
	$kv_d–‘e_queue
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 
que_hdl
) {

86  
kv_deviû_š‹º®
::
	`kv_d–‘e_queue
(
dev_hdl
, 
que_hdl
);

87 
	}
}

89 
kv_»suÉ
 
	$kv_g‘_queue_hªdËs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
) {

90  
kv_deviû_š‹º®
::
	`kv_g‘_queue_hªdËs
(
dev_hdl
, 
que_hdls
, 
que_út
);

91 
	}
}

93 
kv_»suÉ
 
	$kv_g‘_queue_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue
 *
quešfo
) {

94  
kv_deviû_š‹º®
::
	`kv_g‘_queue_šfo
(
dev_hdl
, 
que_hdl
, 
quešfo
);

95 
	}
}

97 
kv_»suÉ
 
	$kv_g‘_queue_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue_¡©
 *
que_¡
) {

98  
kv_deviû_š‹º®
::
	`kv_g‘_queue_¡©
(
dev_hdl
, 
que_hdl
, 
que_¡
);

99 
	}
}

102 
kv_»suÉ
 
	$kv_ü—‹_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû
 *
ns
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

103  
kv_deviû_š‹º®
::
	`kv_ü—‹_Çme¥aû
(
dev_hdl
, 
ns
, 
ns_hdl
);

104 
	}
}

106 
kv_»suÉ
 
	$kv_d–‘e_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

107  
kv_deviû_š‹º®
::
	`kv_d–‘e_Çme¥aû
(
dev_hdl
, 
ns_hdl
);

108 
	}
}

110 
kv_»suÉ
 
	$kv_©ch_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

111  
kv_deviû_š‹º®
::
	`kv_©ch_Çme¥aû
(
dev_hdl
, 
ns_hdl
);

112 
	}
}

114 
kv_»suÉ
 
	$kv_d‘ach_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

115  
kv_deviû_š‹º®
::
	`kv_d‘ach_Çme¥aû
(
dev_hdl
, 
ns_hdl
);

116 
	}
}

118 
kv_»suÉ
 
	$kv_li¡_Çme¥aûs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdls
, 
ušt32_t
 *
ns_út
) {

119  
kv_deviû_š‹º®
::
	`kv_li¡_Çme¥aûs
(
dev_hdl
, 
ns_hdls
, 
ns_út
);

120 
	}
}

122 
kv_»suÉ
 
	$kv_g‘_Çme¥aû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû
 *
nsšfo
) {

123  
kv_deviû_š‹º®
::
	`kv_g‘_Çme¥aû_šfo
(
dev_hdl
, 
ns_hdl
, 
nsšfo
);

124 
	}
}

126 
kv_»suÉ
 
	$kv_g‘_Çme¥aû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû_¡©
 *
ns_¡
) {

127  
kv_deviû_š‹º®
::
	`kv_g‘_Çme¥aû_¡©
(
dev_hdl
, 
ns_hdl
, 
ns_¡
);

128 
	}
}

131 
kv_»suÉ
 
	$_kv_by·ss_Çme¥aû
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
boŞ_t
 
by·ss
) {

132  
kv_deviû_š‹º®
::
	`_kv_by·ss_Çme¥aû
(
dev_hdl
, 
ns_hdl
, 
by·ss
);

133 
	}
}

136 
kv_»suÉ
 
	$kv_purge
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_purge_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

138 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 == NULL) {

139  
KV_ERR_PARAM_INVALID
;

142 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

143  (
dev
->
	`kv_purge
(
que_hdl
, 
ns_hdl
, 
İtiÚ
, 
po¡_â
));

144 
	}
}

146 
kv_»suÉ
 
	$kv_İ’_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

148 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™_cÚd
 == NULL) {

149  
KV_ERR_PARAM_INVALID
;

152 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

153  (
dev
->
	`kv_İ’_™”©Ü
(
que_hdl
, 
ns_hdl
, 
™_İ
, 
™_cÚd
, 
po¡_â
));

154 
	}
}

156 
kv_»suÉ
 
	$kv_şo£_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

157 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 == 0) {

158  
KV_ERR_PARAM_INVALID
;

161 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

162  (
dev
->
	`kv_şo£_™”©Ü
(
que_hdl
, 
ns_hdl
, 
po¡_â
, 
™”_hdl
));

164 
	}
}

166 
kv_»suÉ
 
	$kv_™”©Ü_Ãxt
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

168 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 =ğ0 || 
™”_li¡
 == NULL) {

169  
KV_ERR_PARAM_INVALID
;

172 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

173  (
dev
->
	`kv_™”©Ü_Ãxt_£t
(
que_hdl
, 
ns_hdl
, 
™”_hdl
, 
po¡_â
, 
™”_li¡
));

174 
	}
}

176 
kv_»suÉ
 
	$kv_li¡_™”©Üs
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

177 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
kv_™”s
 =ğNULL || 
™”_út
 == NULL) {

178  
KV_ERR_PARAM_INVALID
;

181 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

182  (
dev
->
	`kv_li¡_™”©Üs
(
que_hdl
, 
ns_hdl
, 
po¡_â
, 
kv_™”s
, 
™”_út
));

183 
	}
}

185 
kv_»suÉ
 
	$kv_d–‘e
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_d–‘e_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

187 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 == NULL) {

188  
KV_ERR_PARAM_INVALID
;

191 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

192  (
dev
->
	`kv_d–‘e
(
que_hdl
, 
ns_hdl
, 
key
, 
İtiÚ
, 
po¡_â
));

193 
	}
}

195 
kv_»suÉ
 
	$kv_d–‘e_group
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

197 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
g½_cÚd
 == NULL) {

198  
KV_ERR_PARAM_INVALID
;

201 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

202  (
dev
->
	`kv_d–‘e_group
(
que_hdl
, 
ns_hdl
, 
g½_cÚd
, 
po¡_â
));

204 
	}
}

206 
kv_»suÉ
 
	$kv_exi¡
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
key_út
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
bufãr
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

208 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
bufãr
 == NULL) {

209  
KV_ERR_PARAM_INVALID
;

212 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

213  (
dev
->
	`kv_exi¡
(
que_hdl
, 
ns_hdl
, 
key
, 
key_út
, 
po¡_â
, 
bufãr_size
, 
bufãr
));

214 
	}
}

216 
kv_»suÉ
 
	$kv_»Œ›ve
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_»Œ›ve_İtiÚ
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

217 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

218  
KV_ERR_PARAM_INVALID
;

221 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

222  (
dev
->
	`kv_»Œ›ve
(
que_hdl
, 
ns_hdl
, 
key
, 
İtiÚ
, 
po¡_â
, 
v®ue
));

224 
	}
}

226 
kv_»suÉ
 
	$kv_¡Üe
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
kv_¡Üe_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

228 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

229  
KV_ERR_PARAM_INVALID
;

232 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

233  (
dev
->
	`kv_¡Üe
(
que_hdl
, 
ns_hdl
, 
key
, 
v®ue
, 
İtiÚ
, 
po¡_â
));

234 
	}
}

237 
kv_»suÉ
 
	$kv_pŞl_com¶‘iÚ
(
kv_queue_hªdË
 
que_hdl
, 
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
) {

238 ià(
que_hdl
 =ğ
NULL
 || 
num_ev’ts
 == NULL) {

239  
KV_ERR_PARAM_INVALID
;

242 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

243  (
dev
->
	`kv_pŞl_com¶‘iÚ
(
que_hdl
, 
timeout_u£c
, 
num_ev’ts
));

244 
	}
}

246 
kv_»suÉ
 
	$kv_£t_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
) {

247 ià(
que_hdl
 =ğ
NULL
 || 
št_hdl
 == NULL) {

248  
KV_ERR_PARAM_INVALID
;

251 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
que_hdl
->dev;

252  (
dev
->
	`kv_£t_š‹¼u±_hªdËr
(
que_hdl
, 
št_hdl
));

253 
	}
}

256 
kv_»suÉ
 
	$g‘_Çme¥aû_deçuÉ
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdl
) {

257 ià(
dev_hdl
 =ğ
NULL
 || 
ns_hdl
 == NULL) {

258  
KV_ERR_PARAM_INVALID
;

260 
kv_deviû_š‹º®
 *
dev
 = (kv_deviû_š‹º® *è
dev_hdl
->dev;

261 ià(
dev
 =ğ
NULL
) {

262  
KV_ERR_DEV_NOT_EXIST
;

265 
kv_Çme¥aû_š‹º®
 *
ns
 = 
dev
->
	`g‘_Çme¥aû_deçuÉ
();

266 ià(
ns
 =ğ
NULL
) {

267  
KV_ERR_NS_INVALID
;

270 (*
ns_hdl
èğ
Ãw
 
	`_kv_Çme¥aû_hªdË
();

271 (*
ns_hdl
)->
dev
 = dev;

272 (*
ns_hdl
)->
ns
 =‚s;

273 (*
ns_hdl
)->
nsid
 = 
ns
->
	`g‘_nsid
();

275  
KV_SUCCESS
;

276 
	}
}

279 
ušt32_t
 
	$g‘_queued_commªds_couÁ
(
kv_queue_hªdË
 
que_hdl
) {

280 ià(
que_hdl
 !ğ
NULL
) {

281 
ioqueue
 *
que
 = (ioqueu*è
que_hdl
->
queue
;

282 ià(
que
 !ğ
NULL
) {

283  
que
->
	`size
();

288 
	}
}

	@PDK/core/src/device_abstract_layer/emulator/src/queue.cpp

34 
	~"queue.hµ
"

35 
	~"kv_deviû.hµ
"

37 
usšg
 
Çme¥aû
 
	gkvadi
;

40 
´oûss_subm™‹d_commªds
(*
que
);

41 
´oûss_š‹¼u±s
(*
que
);

43 
	gemul_ioqueue
::
	$emul_ioqueue
(cÚ¡ 
kv_queue
 *
quešfo_
, 
kv_deviû_š‹º®
 *
dev
, 
emul_ioqueue
 *
out_
):

44 
	`ioqueue
(
quešfo_
), 
	`shutdown
(
çl£
), 
	`out
(
out_
), 
	`queue
(quešfo_->
queue_size
)

46 
this
->
kv¡Üe
 = 
dev
->
	`g‘_Çme¥aû
(
KV_NAMESPACE_DEFAULT
)->
	`g‘_kv¡Üe
();

47 iàĞ
this
->
quešfo
.
queue_ty³
 =ğ
SUBMISSION_Q_TYPE
) {

48 
th»ads
.
	`£t_devid
(
dev
->
	`g‘_devid
());

49 
th»ads
.
	`ü—‹_subm™_th»ads
(
´oûss_subm™‹d_commªds
, 
this
, 1);

51 
	}
}

55 
kv_»suÉ
 
	gemul_ioqueue
::
	$š™_š‹¼u±_hªdËr
(
kv_deviû_š‹º®
 *
dev
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
)

57 ià(
dev
->
	`is_pŞlšg
()){

58  
KV_ERR_OPTION_INVALID
;

60 
this
->
š‹¼u±_hªdËr
 = 
št_hdl
;

62 
th»ads
.
	`£t_devid
(
dev
->
	`g‘_devid
());

63 
th»ads
.
	`ü—‹_š‹¼u±_th»ads
(
´oûss_š‹¼u±s
, 
this
, 1);

64  
KV_SUCCESS
;

65 
	}
}

68 
kv_»suÉ
 
	gemul_ioqueue
::
	$’queue
 (
io_cmd
 *
cmd
, 
boŞ
 
block
 ) {

69 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
li¡_mu‹x
);

70 ià(
shutdown
è 
KV_ERR_QUEUE_IN_SHUTDOWN
;

71 
queue
.
	`fuÎ
(è&& !
	`Ãed_shutdown
()) {

72 ià(!
block
è 
KV_ERR_QUEUE_IS_FULL
;

73 
cÚd_nÙfuÎ
.
	`wa™_fÜ
(
lock
, 
¡d
::
chrÚo
::
	`miüo£cÚds
(10));

75 
queue
.
	`push_back
(
cmd
);

76 
cÚd_nÙem±y
.
	`nÙify_Úe
();

77  
KV_SUCCESS
;

78 
	}
}

80 
kv_»suÉ
 
	gemul_ioqueue
::
	$dequeue
(
io_cmd
 **
cmd
, 
boŞ
 
block
, 
ušt32_t
 
timeout_u£c
) {

81 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
li¡_mu‹x
);

82 
queue
.
	`em±y
(è&& !
	`Ãed_shutdown
()) {

83 ià(!
block
) {

84 *
cmd
 = 0;

85  
KV_SUCCESS
;

88 cÚ¡ 
ušt32_t
 
timeout
 = (
timeout_u£c
 == 0)? 10:timeout_usec;

89 autØ
¡©us
 = 
cÚd_nÙem±y
.
	`wa™_fÜ
(
lock
, 
¡d
::
chrÚo
::
	`miüo£cÚds
(
timeout
));

90 ià(
¡©us
 =ğ
¡d
::
cv_¡©us
::
timeout
 && 
timeout_u£c
 != 0) {

91  
KV_ERR_TIMEOUT
;

95 ià(
	`Ãed_shutdown
()è 
KV_ERR_QUEUE_IN_SHUTDOWN
;

97 (*
cmd
èğ
queue
.
	`äÚt
(); queue.
	`pİ_äÚt
();

98 
cÚd_nÙfuÎ
.
	`nÙify_Úe
();

99  
KV_SUCCESS
;

100 
	}
}

102 
boŞ
 
	gemul_ioqueue
::
	$em±y
() {

103 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
li¡_mu‹x
);

104  
queue
.
	`em±y
();

105 
	}
}

107 
size_t
 
	gemul_ioqueue
::
	$size
() {

108 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
li¡_mu‹x
);

109  
queue
.
	`size
();

110 
	}
}

112 
kv_»suÉ
 
	gemul_ioqueue
::
	$pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
)

115 ià(
this
->
	`g‘_ty³
(è!ğ
COMPLETION_Q_TYPE
è 
KV_ERR_QUEUE_CQID_INVALID
;

116 
kv_»suÉ
 
»s
;

117 
num_com¶‘ed
 = 0;

118 cÚ¡ 
couÁ
 = 
¡d
::
	`max
(¡d::
	`mš
(*
num_ev’ts
, 128u), 1u);

119 
i
 = 0 ; i < 
couÁ
; i++) {

120 
io_cmd
 *
cmd
;

121 
»s
 = 
	`dequeue
(&
cmd
, 
çl£
, 
timeout_u£c
);

122 ià(
»s
 !ğ
KV_SUCCESS
) {

123 
	`årštf
(
¡d”r
, "”¸ğ%d,imeouˆğ%u\n", 
»s
, 
timeout_u£c
);

127 ià(
cmd
) {

128 
cmd
->
	`ÿÎ_po¡_´oûss_func
();

130 #ifdeà
ENABLE_LATENCY_TRACING


131 
cmd
->
eviùed_o
 = 
¡d
::
chrÚo
::
sy¡em_şock
::
	`now
();

132 
cmd
->
	`´št_Ï‹ncy
();

135 
d–‘e
 
cmd
;

136 
num_com¶‘ed
++;

139 *
num_ev’ts
 = 
num_com¶‘ed
;

142 ià(
»s
 !ğ
KV_SUCCESS
) { „es; }

144  (
this
->
	`size
(è=ğ0)? 
KV_SUCCESS
:
KV_WRN_MORE
;

145 
	}
}

149 
	$´oûss_subm™‹d_commªds
(*
que_
)

152 
emul_ioqueue
 *
que
 = (emul_ioqueu*)
que_
;

153 !
que
->
	`Ãed_shutdown
()) {

155 
io_cmd
 *
cmd
;

156 
kv_»suÉ
 
»s
 = 
que
->
	`dequeue
(&
cmd
, 
Œue
);

157 ià(
»s
 !ğ
KV_SUCCESS
 || 
cmd
 == 0) ;

159 #ifdeà
ENABLE_LATENCY_TRACING


160 
cmd
->
eviùed_i
 = 
¡d
::
chrÚo
::
sy¡em_şock
::
	`now
();

163 
cmd
->
	`execu‹_cmd
();

165 
emul_ioqueue
 *
out
 = 
que
->
	`g‘_out_queue
();

166 ià(
out
)

167 
out
->
	`’queue
(
cmd
);

169 
	}
}

172 
	$´oûss_š‹¼u±s
(*
que_
) {

174 
emul_ioqueue
 *
que
 = (emul_ioqueu*)
que_
;

176 !
que
->
	`Ãed_shutdown
()) {

178 
io_cmd
 *
cmd
;

179 
kv_»suÉ
 
»s
 = 
que
->
	`dequeue
(&
cmd
, 
Œue
);

180 ià(
»s
 !ğ
KV_SUCCESS
 || 
cmd
 == 0) ;

187 autØ
ihªdËr
 = 
que
->
	`g‘_š‹¼u±_hªdËr
();

188 ià(
ihªdËr
 ) {

189 
ihªdËr
->
	`hªdËr
(ihªdËr->
´iv©e_d©a
, ihªdËr->
numb”
);

192 
cmd
->
	`ÿÎ_po¡_´oûss_func
();

195 
d–‘e
 
cmd
;

197 
	}
}

199 
	gk”Ãl_ioqueue
::
	$k”Ãl_ioqueue
(cÚ¡ 
kv_queue
 *
quešfo_
 ,
kv_deviû_š‹º®
 *
dev
): 
	`ioqueue
(quešfo_), 
	`maxd•th
(quešfo_->
queue_size
), 
	$curd•th
(0) {

200 
this
->
kv¡Üe
 = 
dev
->
	`g‘_Çme¥aû
(
KV_NAMESPACE_DEFAULT
)->
	`g‘_kv¡Üe
();

201 
	}
}

203 
kv_»suÉ
 
	gk”Ãl_ioqueue
::
	$pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_com¶‘ed
) {

204  
this
->
kv¡Üe
->
	`pŞl_com¶‘iÚ
(
timeout_u£c
, 
num_com¶‘ed
);

205 
	}
}

	@PDK/core/src/device_abstract_layer/emulator/src/thread_pool.cpp

34 
	~"th»ad_poŞ.hµ
"

35 
	~"kv_deviû.hµ
"

37 
Çme¥aû
 
	gkvadi
 {

39 
	gth»ad_poŞ
::
th»ad_poŞ
() {}

41 
th»ad_poŞ
::th»ad_poŞ(
ušt32_t
 
devid
, ušt32_ˆ
th»ad_couÁ_³r_sq
, ušt32_ˆ
th»ad_couÁ_³r_cq
) {

42 
	gm_devid
 = 
devid
;

43 
	gm_th»ad_couÁ_³r_sq
 = 
th»ad_couÁ_³r_sq
;

44 
	gm_th»ad_couÁ_³r_cq
 = 
th»ad_couÁ_³r_cq
;

54 
	gth»ad_poŞ
::
£t_devid
(
št32_t
 
devid
) {

55 
m_devid
 = 
devid
;

57 
kv_»suÉ
 
	gth»ad_poŞ
::
ü—‹_subm™_th»ads
((*
func
)(*), * 
que
, 
num_th»ads
)

59 
	gthis
->
	gm_th»ad_couÁ_³r_sq
 = 
num_th»ads
;

60 
	gi
 = 0; i < 
	gm_th»ad_couÁ_³r_sq
; i++) {

61 
	gm_th»ads
.
push_back
(
¡d
::
th»ad
(
func
, 
que
));

63  
	gKV_SUCCESS
;

66 
kv_»suÉ
 
	gth»ad_poŞ
::
ü—‹_š‹¼u±_th»ads
((*
func
)(*), * 
que
,
num_th»ads
)

68 
	gthis
->
	gm_th»ad_couÁ_³r_cq
 = 
num_th»ads
;

69 
	gi
 = 0; i < 
	gm_th»ad_couÁ_³r_cq
; i++) {

70 
	gm_th»ads
.
push_back
(
¡d
::
th»ad
(
func
,
que
));

72  
	gKV_SUCCESS
;

75 
kv_»suÉ
 
	gth»ad_poŞ
::
ü—‹_q_th»ads
(
ušt16_t
 
qid
) {

76 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
lock
(
m_mu‹x
);

78 
kv_deviû_š‹º®
 *
	gdev
 = kv_deviû_š‹º®::
g‘_deviû_š¡ªû
(
m_devid
);

79 ià(
	gdev
 =ğ
NULL
) {

80 
WRITE_WARN
("Deviû‚Ù found whü—tšgh»ad fÜhqueu%d\n", 
qid
);

81  
	gKV_ERR_DEV_NOT_EXIST
;

84 
ioqueue
 *
	gque
 = 
dev
->
g‘_emul_ioqueue
(
qid
);

85 ià(
	gque
 =ğ
NULL
) {

86  
KV_ERR_QUEUE_QID_INVALID
;

90 
boŞ_t
 
	gis_pŞlšg
 = 
dev
->
is_pŞlšg
();

96 ià(
	gdev
->
g‘_dev_ty³
(è=ğ
KV_DEV_TYPE_EMULATOR
 &&

97 
que
->
g‘_qty³
(è=ğ
SUBMISSION_Q_TYPE
) {

99 
i
 = 0; 
	gi
 < 
	gm_th»ad_couÁ_³r_sq
; i++) {

100 
	gm_th»ads
.
push_back
(
¡d
::
th»ad
(&
emul_ioqueue
::
´oûss_submissiÚ_queue
, 
que
));

109 ià(
	gdev
->
g‘_dev_ty³
(è=ğ
KV_DEV_TYPE_EMULATOR
 &&

110 !
is_pŞlšg
 && 
que
->
g‘_qty³
(è=ğ
COMPLETION_Q_TYPE
) {

112 
i
 = 0; 
	gi
 < 
	gm_th»ad_couÁ_³r_cq
; i++) {

113 
	gm_th»ads
.
push_back
(
¡d
::
th»ad
(&
emul_ioqueue
::
´oûss_com¶‘iÚ_queue
, 
que
));

118  
	gKV_SUCCESS
;

123 
	gth»ad_poŞ
::
još
() {

124 
¡d
::
th»ad
& 
™
 : 
m_th»ads
) {

125 ià(
™
.
jošabË
()) {

126 
™
.
još
();

132 
	gth»ad_poŞ
::~
th»ad_poŞ
() {

134 
¡d
::
th»ad
& 
™
 : 
m_th»ads
) {

135 ià(
™
.
jošabË
()) {

136 
™
.
još
();

	@PDK/core/src/device_abstract_layer/include/kvs_adi.h

33 #iâdeà
SAMSUNG_KVS_ADI_H


34 
	#SAMSUNG_KVS_ADI_H


	)

36 
	~"¡dšt.h
"

37 
	~"kvs_»suÉ.h
"

39 #ifdeà
__ılu¥lus


44 
	#SAMSUNG_ADI_VERSION
 "0.5.0.0"

	)

46 
	#SAMSUNG_KV_MIN_KEY_LEN
 4

	)

47 
	#SAMSUNG_KV_MAX_KEY_LEN
 255

	)

48 
	#SAMSUNG_KV_MIN_VALUE_LEN
 0

	)

49 
	#SAMSUNG_KV_MAX_VALUE_LEN
 (2*1024*1024)

	)

51 
	#SAMSUNG_MAX_ITERATORS
 16

	)

56 
št32_t
 
	tkv_»suÉ
;

59 
	#KV_SUCCESS
 0x0

60 

	)

62 
	#KV_WRN_MORE
 0xF000

63 

	)

65 
	#KV_ERR_DEV_CAPACITY
 
KVS_ERR_DEV_CAPACITY


66 
	#KV_ERR_DEV_INIT
 
KVS_ERR_DEV_INIT


67 
	#KV_ERR_DEV_INITIALIZED
 
KVS_ERR_DEV_INITIALIZED


68 
	#KV_ERR_DEV_NOT_EXIST
 
KVS_ERR_DEV_NOT_EXIST


69 
	#KV_ERR_DEV_SANITIZE_FAILED
 
KVS_ERR_DEV_SANITIZE_FAILED


70 

	)

71 
	#KV_ERR_ITERATOR_NOT_EXIST
 
KVS_ERR_ITERATOR_NOT_EXIST


72 
	#KV_ERR_KEY_INVALID
 
KVS_ERR_KEY_INVALID


73 
	#KV_ERR_KEY_LENGTH_INVALID
 
KVS_ERR_KEY_LENGTH_INVALID


74 
	#KV_ERR_KEY_NOT_EXIST
 
KVS_ERR_KEY_NOT_EXIST


75 
	#KV_ERR_NS_DEFAULT
 
KVS_ERR_NS_DEFAULT


76 
	#KV_ERR_NS_INVALID
 
KVS_ERR_NS_INVALID


77 
	#KV_ERR_OPTION_INVALID
 
KVS_ERR_OPTION_INVALID


78 
	#KV_ERR_PARAM_INVALID
 
KVS_ERR_PARAM_INVALID


79 
	#KV_ERR_PURGE_IN_PRGRESS
 
KVS_ERR_PURGE_IN_PROGRESS


80 
	#KV_ERR_SYS_IO
 
KVS_ERR_SYS_IO


81 
	#KV_ERR_VALUE_LENGTH_INVALID
 
KVS_ERR_VALUE_LENGTH_INVALID


82 
	#KV_ERR_VALUE_LENGTH_MISALIGNED
 
KVS_ERR_VALUE_LENGTH_MISALIGNED


83 
	#KV_ERR_VALUE_OFFSET_INVALID
 
KVS_ERR_VALUE_OFFSET_INVALID


84 
	#KV_ERR_VENDOR
 
KVS_ERR_VENDOR


85 
	#KV_ERR_PERMISSION
 
KVS_ERR_PERMISSION


86 

	)

88 
	#KV_ERR_BUFFER_SMALL
 
KVS_ERR_BUFFER_SMALL


89 
	#KV_ERR_DEV_MAX_NS
 
KVS_ERR_NS_MAX


90 
	#KV_ERR_ITERATOR_COND_INVALID
 
KVS_ERR_ITERATOR_COND_INVALID


91 
	#KV_ERR_KEY_EXIST
 
KVS_ERR_KEY_EXIST


92 
	#KV_ERR_NS_ATTAHED
 
KVS_ERR_NS_ATTACHED


93 
	#KV_ERR_NS_CAPACITY
 
KVS_ERR_NS_CAPACITY


94 
	#KV_ERR_NS_NOT_ATTACHED
 
KVS_ERR_NS_NOT_ATTACHED


95 
	#KV_ERR_QUEUE_CQID_INVALID
 
KVS_ERR_QUEUE_CQID_INVALID


96 
	#KV_ERR_QUEUE_SQID_INVALID
 
KVS_ERR_QUEUE_SQID_INVALID


97 
	#KV_ERR_QUEUE_DELETION_INVALID
 
KVS_ERR_QUEUE_DELETION_INVALID


98 

	)

99 
	#KV_ERR_QUEUE_MAX_QUEUE
 
KVS_ERR_QUEUE_MAX_QUEUE


100 
	#KV_ERR_QUEUE_QID_INVALID
 
KVS_ERR_QUEUE_QID_INVALID


101 
	#KV_ERR_QUEUE_QSIZE_INVALID
 
KVS_ERR_QUEUE_QSIZE_INVALID


102 

	)

103 
	#KV_ERR_TIMEOUT
 
KVS_ERR_TIMEOUT


104 

	)

106 
	#KV_ERR_UNCORRECTIBLE
 
KVS_ERR_UNCORRECTIBLE


107 

	)

109 
	#KV_ERR_QUEUE_IN_SHUTDOWN
 
KVS_ERR_QUEUE_IN_SUTDOWN


110 

	)

112 
	#KV_ERR_QUEUE_IS_FULL
 
KVS_ERR_QUEUE_IS_FULL


113 

	)

115 
	#KV_ERR_COMMAND_SUBMITTED
 
KVS_ERR_COMMAND_SUBMITTED


116 

	)

118 
	#KV_ERR_TOO_MANY_ITERATORS_OPEN
 
KVS_ERR_ITERATOR_MAX


119 

	)

121 
	#KV_ERR_SYS_BUSY
 
KVS_ERR_SYS_BUSY


122 

	)

124 
	#KV_ERR_COMMAND_INITIALIZED
 
KVS_ERR_COMMAND_INITIALIZED


125 

	)

126 
	#KV_ERR_DD_UNSUPPORTED_CMD
 
KVS_ERR_DD_UNSUPPORTED_CMD


127 

	)

128 
	#KV_ERR_ITERATE_REQUEST_FAIL
 
KVS_ERR_ITERATE_REQUEST_FAIL


129 

	)

135 
ušt8_t
 
	tkv_™”©Ü_hªdË
;

136 
kv_io_cÚ‹xt
;

137 
_kv_deviû_hªdË
;

138 
_kv_deviû_hªdË
* 
	tkv_deviû_hªdË
;

139 
_kv_Çme¥aû_hªdË
;

140 
_kv_Çme¥aû_hªdË
* 
	tkv_Çme¥aû_hªdË
;

142 
_kv_queue_hªdË
;

143 
_kv_queue_hªdË
* 
	tkv_queue_hªdË
;

145 
	ecmd_İcode_t
 {

146 
KV_OPC_FLUSH
 = 0,

148 
KV_OPC_GET
 = 1,

149 
KV_OPC_STORE
 = 2,

150 
KV_OPC_DELETE
 = 3,

151 
KV_OPC_PURGE
 = 4,

152 
KV_OPC_CHECK_KEY_EXIST
 = 6,

154 
KV_OPC_OPEN_ITERATOR
 = 7,

155 
KV_OPC_CLOSE_ITERATOR
 = 8,

156 
KV_OPC_ITERATE_NEXT
 = 9,

158 
KV_OPC_SANITIZE_DEVICE
 = 10,

160 
KV_OPC_LIST_ITERATOR
 = 11,

161 
KV_OPC_DELETE_GROUP
 = 12,

162 
KV_OPC_ITERATE_NEXT_SINGLE_KV
 = 13,

163 } 
	tcmd_İcode_t
;

169 
ušt8_t
 
	tkv_key_t
;

175 
ušt32_t
 
	tkv_v®ue_t
;

182 
	s_kv_š‹¼u±_hªdËr
 {

183 (*
hªdËr
)(*, );

184 *
´iv©e_d©a
;

185 
numb”
;

186 } 
	tš‹¼u±_hªdËr_t
;

190 
_kv_š‹¼u±_hªdËr
* 
	tkv_š‹¼u±_hªdËr
;

198 
	#KV_MIN_KEY_LEN
 
SAMSUNG_KV_MIN_KEY_LEN


199 

	)

207 
	#KV_MIN_VALUE_LEN
 
SAMSUNG_KV_MIN_VALUE_LEN


208 

	)

215 
	#KV_MAX_KEY_LEN
 
SAMSUNG_KV_MAX_KEY_LEN


216 

	)

223 
	#KV_MAX_VALUE_LEN
 
SAMSUNG_KV_MAX_VALUE_LEN


224 

	)

228 
	#KV_NAMESPACE_ALL
 (
ušt32_t
)(-1)

229 

	)

233 
	#KV_NAMESPACE_DEFAULT
 1

234 

	)

237 
	#SUBMISSION_Q_TYPE
 0

	)

241 
	#COMPLETION_Q_TYPE
 1

	)

246 
FALSE
 = 0x00,

247 
TRUE
 = 0x01,

248 } 
	tboŞ_t
;

256 
KV_DEVICE_TYPE_BLK
 = 0x00,

257 
KV_DEVICE_TYPE_KV
 = 0x01,

258 } 
	tkv_deviû_ty³
;

265 
KV_DELETE_OPT_DEFAULT
 = 0x00,

266 
KV_DELETE_OPT_ERROR
 = 0x01,

267 } 
	tkv_d–‘e_İtiÚ
;

273 
KV_EXIST_OPT_DEFAULT
 = 0x00,

274 } 
	tkv_exi¡_İtiÚ
;

280 
KV_ITERATOR_OPT_KEY
 = 0x00,

281 
KV_ITERATOR_OPT_KV
 = 0x01,

282 
KV_ITERATOR_OPT_KV_WITH_DELETE
 = 0x02,

284 } 
	tkv_™”©Ü_İtiÚ
;

290 
KV_PURGE_OPT_DEFAULT
 = 0x00,

291 
KV_PURGE_OPT_KV_ERASE
 = 0x01,

292 
KV_PURGE_OPT_CRYPTO_ERASE
 = 0x02,

293 } 
	tkv_purge_İtiÚ
;

301 
KV_RETRIEVE_OPT_DEFAULT
 = 0x00,

302 
KV_RETRIEVE_OPT_DECOMPRESS
 = 0x01,

303 
KV_RETRIEVE_OPT_DELETE
 = 0x02,

304 
KV_RETRIEVE_OPT_DECOMPRESS_DELETE
 = 0x03,

305 } 
	tkv_»Œ›ve_İtiÚ
;

309 
RESERVED
 = 0x00,

310 
RESERVED1
 = 0x01,

311 
KV_SANITIZE_OPT_KV_ERASE
 = 0x02,

313 
KV_SANITIZE_OPT_OVERWRITE
 = 0x03,

315 
KV_SANITIZE_OPT_CRYPTO_ERASE
 = 0x04,

316 } 
	tkv_§n™ize_İtiÚ
;

321 
KV_STORE_OPT_DEFAULT
 = 0x00,

322 
KV_STORE_OPT_COMPRESS
 = 0x01,

323 
KV_STORE_OPT_IDEMPOTENT
 = 0x02,

325 
KV_STORE_OPT_UPDATE_ONLY
 = 0x03,

326 
KV_STORE_OPT_APPEND
 = 0x04,

327 
KV_STORE_OPT_POST_WITH_COMPRESS
 = 0x05,

328 
KV_STORE_OPT_UPDATE_ONLY_COMPRESS
 = 0x06,

329 
KV_STORE_OPT_NOOVERWRITE_COMPRESS
 = 0x07,

330 
KV_STORE_OPT_APPEND_COMPRESS
 = 0x08,

331 } 
	tkv_¡Üe_İtiÚ
;

337 
ušt32_t
 
v”siÚ
;

338 
ušt16_t
 
max_Çme¥aûs
;

339 
ušt16_t
 
max_queues
;

340 
ušt64_t
 
ÿ·c™y
;

341 
kv_v®ue_t
 
mš_v®ue_Ën
;

342 
kv_v®ue_t
 
max_v®ue_Ën
;

343 
kv_key_t
 
mš_key_Ën
;

344 
kv_key_t
 
max_key_Ën
;

345 *
ex‹nded_šfo
;

346 } 
	tkv_deviû
;

353 
kv_v®ue_t
 
key_un™
;

354 
kv_v®ue_t
 
v®ue_un™
;

355 } 
	tkv_§msung_deviû
;

361 
ušt16_t
 
Çme¥aû_couÁ
;

362 
ušt16_t
 
queue_couÁ
;

363 
ušt16_t
 
utiz©iÚ
;

364 
ušt16_t
 
waf
;

365 *
ex‹nded_šfo
;

366 } 
	tkv_deviû_¡©
;

373 
ušt32_t
 
b™mask
;

374 
ušt32_t
 
b™_·‰”n
;

375 } 
	tkv_group_cÚd™iÚ
;

383 
ušt8_t
 
hªdË_id
;

384 
ušt8_t
 
¡©us
;

385 
ušt8_t
 
ty³
;

386 
ušt8_t
 
key¥aû_id
;

387 
ušt32_t
 
´efix
;

388 
ušt32_t
 
b™mask
;

389 
ušt8_t
 
is_eof
;

390 
ušt8_t
 
»£rved
[3];

391 } 
	tkv_™”©Ü
;

398 
ušt32_t
 
num_’Œ›s
;

399 
ušt32_t
 
size
;

400 
boŞ_t
 
’d
;

401 *
™_li¡
;

402 } 
	tkv_™”©Ü_li¡
;

413 *
key
;

414 
kv_key_t
 
Ëngth
;

415 } 
	tkv_key
;

427 *
v®ue
;

429 
kv_v®ue_t
 
Ëngth
;

430 
kv_v®ue_t
 
aùu®_v®ue_size
;

431 
kv_v®ue_t
 
off£t
;

433 } 
	tkv_v®ue
;

443 
ušt32_t
 
nsid
;

444 
boŞ_t
 
©ched
;

445 
ušt64_t
 
ÿ·c™y
;

446 *
ex‹nded_šfo
;

447 } 
	tkv_Çme¥aû
;

454 
ušt32_t
 
nsid
;

455 
boŞ_t
 
©ched
;

456 
ušt64_t
 
ÿ·c™y
;

457 
ušt64_t
 
uÇÎoÿ‹d_ÿ·c™y
;

458 *
ex‹nded_šfo
;

459 } 
	tkv_Çme¥aû_¡©
;

467 
ušt16_t
 
queue_id
;

468 
ušt16_t
 
queue_size
;

469 
ušt16_t
 
com¶‘iÚ_queue_id
;

470 
ušt16_t
 
queue_ty³
;

471 *
ex‹nded_šfo
;

472 } 
	tkv_queue
;

479 
ušt16_t
 
queue_id
;

480 *
ex‹nded_šfo
;

481 } 
	tkv_queue_¡©
;

488 
ušt32_t
 
·‰”n_Ëngth
;

489 *
·‰”n
;

490 } 
	tkv_§n™ize_·‰”n
;

522 
kv_»suÉ
 
kv_š™Ÿlize_deviû
(*
dev_š™
, 
kv_deviû_hªdË
 *
dev_hdl
);

543 
kv_»suÉ
 
kv_ş—nup_deviû
(
kv_deviû_hªdË
 
dev_hdl
);

565 
kv_»suÉ
 
kv_g‘_deviû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû
 *
devšfo
);

587 
kv_»suÉ
 
kv_g‘_deviû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû_¡©
 *
dev_¡
);

589 
kv_»suÉ
 
kv_g‘_deviû_waf
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
ušt32_t
 *
waf
);

597 
kv_»Œ›ve_İtiÚ
 
İtiÚ
;

598 } 
	tİ_g‘_¡ruù_t
;

601 
kv_¡Üe_İtiÚ
 
İtiÚ
;

602 } 
	tİ_¡Üe_¡ruù_t
;

605 
kv_d–‘e_İtiÚ
 
İtiÚ
;

606 } 
	tİ_d–‘e_¡ruù_t
;

609 
kv_purge_İtiÚ
 
İtiÚ
;

610 } 
	tİ_purge_¡ruù_t
;

613 
kv_exi¡_İtiÚ
 
İtiÚ
;

614 
ušt32_t
 
keycouÁ
;

615 
ušt8_t
 *
»suÉ
;

616 
ušt32_t
 
»suÉ_size
;

617 } 
	tİ_key_exi¡_¡ruù_t
;

620 
kv_™”©Ü_İtiÚ
 
™_İ
;

621 
kv_group_cÚd™iÚ
 
™_cÚd
;

622 } 
	tİ_™”©Ü_İ’_¡ruù_t
;

625 
kv_™”©Ü_hªdË
 
™”_hdl
;

626 
kv_™”©Ü_li¡
 *
™”_li¡
;

627 
kv_key
 *
key
;

628 
kv_v®ue
 *
v®ue
;

629 } 
	tİ_™”©Ü_Ãxt_¡ruù_t
;

632 
kv_§n™ize_İtiÚ
 
İtiÚ
;

633 
kv_§n™ize_·‰”n
 *
·‰”n
;

634 } 
	tİ_§n™ize_¡ruù_t
;

637 
kv_™”©Ü_hªdË
 
™”_hdl
;

638 } 
	tİ_şo£_™”©Ü_¡ruù_t
;

641 
kv_™”©Ü
 *
kv_™”s
;

642 
ušt32_t
 *
™”_út
;

643 } 
	tİ_li¡_™”©Ü_¡ruù_t
;

646 
kv_group_cÚd™iÚ
 *
g½_cÚd
;

647 } 
	tİ_d–‘e_group_¡ruù_t
;

653 
	skv_io_cÚ‹xt
{

654 
İcode
;

655 cÚ¡ 
kv_key
 *
key
;

656 
kv_v®ue
 *
v®ue
;

657 *
´iv©e_d©a
;

658 
kv_»suÉ
 
»tcode
;

662 
ušt8_t
 *
bufãr
;

663 
ušt32_t
 
bufãr_size
 ;

664 
ušt32_t
 
bufãr_couÁ
;

666 
kv_™”©Ü_hªdË
 
h™”
;

667 } 
»suÉ
;

669 
id
;

670 
boŞ
 
’d
;

671 *
buf
;

672 
buæ’gth
;

673 } 
h™”
;

680 
cmd_İcode_t
 
İcode
;

681 cÚ¡ 
kv_key
 *
key
;

682 
kv_v®ue
 *
v®ue
;

683 *
´iv©e_d©a
;

684 
kv_»suÉ
 
»tcode
;

689 
ušt8_t
 *
bufãr
;

690 
ušt32_t
 
bufãr_size
 ;

691 
ušt32_t
 
bufãr_couÁ
;

693 
kv_™”©Ü_hªdË
 
h™”
;

694 } 
»suÉ
;

698 (*
po¡_â
)(
kv_io_cÚ‹xt
 *
İ
);

699 
ušt32_t
 
timeout_u£c
;

700 
ušt16_t
 
qid
;

701 
ušt32_t
 
nsid
;

706 
İ_§n™ize_¡ruù_t
 
§n™ize_šfo
;

707 
İ_g‘_¡ruù_t
 
g‘_šfo
;

708 
İ_¡Üe_¡ruù_t
 
¡Üe_šfo
;

709 
İ_d–‘e_¡ruù_t
 
d–‘e_šfo
;

710 
İ_purge_¡ruù_t
 
purge_šfo
;

711 
İ_key_exi¡_¡ruù_t
 
key_exi¡_šfo
;

712 
İ_™”©Ü_İ’_¡ruù_t
 
™”©Ü_İ’_šfo
;

713 
İ_™”©Ü_Ãxt_¡ruù_t
 
™”©Ü_Ãxt_šfo
;

714 
İ_şo£_™”©Ü_¡ruù_t
 
™”©Ü_şo£_šfo
;

715 
İ_li¡_™”©Ü_¡ruù_t
 
™”©Ü_li¡_šfo
;

716 
İ_d–‘e_group_¡ruù_t
 
d–‘e_group_šfo
;

717 } 
commªd
;

719 } 
	tio_ùx_t
;

728 (*
po¡_â
)(
kv_io_cÚ‹xt
 *
İ
);

729 *
´iv©e_d©a
;

730 } 
	tkv_po¡´oûss_funùiÚ
;

770 
kv_»suÉ
 
kv_§n™ize
 (
kv_queue_hªdË
 
que_hdl
, 
kv_deviû_hªdË
 
dev_hdl
, 
kv_§n™ize_İtiÚ
 
İtiÚ
, 
kv_§n™ize_·‰”n
 *
·‰”n
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

798 
kv_»suÉ
 
kv_ü—‹_queue
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue
 *
quešfo
, 
kv_queue_hªdË
 *
que_hdl
);

820 
kv_»suÉ
 
kv_d–‘e_queue
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 
que_hdl
);

843 
kv_»suÉ
 
kv_g‘_queue_hªdËs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
);

867 
kv_»suÉ
 
kv_g‘_queue_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue
 *
quešfo
);

891 
kv_»suÉ
 
kv_g‘_queue_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue_¡©
 *
que_¡
);

920 
kv_»suÉ
 
kv_ü—‹_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû
 *
ns
, 
kv_Çme¥aû_hªdË
 *
ns_hdl
);

945 
kv_»suÉ
 
kv_d–‘e_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

972 
kv_»suÉ
 
kv_©ch_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

998 
kv_»suÉ
 
kv_d‘ach_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

1024 
kv_»suÉ
 
kv_li¡_Çme¥aûs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdls
, 
ušt32_t
 *
ns_út
);

1047 
kv_»suÉ
 
kv_g‘_Çme¥aû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû
 *
nsšfo
);

1070 
kv_»suÉ
 
kv_g‘_Çme¥aû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû_¡©
 *
ns_¡
);

1113 
kv_»suÉ
 
kv_purge
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_purge_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1157 
kv_»suÉ
 
kv_İ’_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1159 
kv_»suÉ
 
kv_İ’_™”©Ü_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
ušt8_t
 *
™”hªdË
);

1160 
kv_»suÉ
 
kv_şo£_™”©Ü_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
);

1161 
kv_»suÉ
 
kv_li¡_™”©Üs_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
);

1162 
kv_»suÉ
 
kv_™”©Ü_Ãxt_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
);

1185 
kv_»suÉ
 
kv_şo£_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1226 
kv_»suÉ
 
kv_™”©Ü_Ãxt
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1259 
kv_»suÉ
 
kv_li¡_™”©Üs
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1305 
kv_»suÉ
 
kv_d–‘e
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_d–‘e_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1337 
kv_»suÉ
 
kv_d–‘e_group
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1378 
kv_»suÉ
 
kv_exi¡
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
keys
, 
ušt32_t
 
keycouÁ
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
bufãr
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1427 
kv_»suÉ
 
kv_»Œ›ve
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_»Œ›ve_İtiÚ
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1480 
kv_»suÉ
 
kv_¡Üe
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
kv_¡Üe_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

1524 
kv_»suÉ
 
kv_pŞl_com¶‘iÚ
(
kv_queue_hªdË
 
que_hdl
, 
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
);

1550 
kv_»suÉ
 
kv_£t_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
);

1553 
ušt32_t
 
g‘_queued_commªds_couÁ
(
kv_queue_hªdË
 
que_hdl
);

1556 
kv_»suÉ
 
g‘_Çme¥aû_deçuÉ
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdl
);

1559 
ušt64_t
 
_kv_emul_queue_Ï‹ncy
;

1560 
kv_»suÉ
 
_kv_by·ss_Çme¥aû
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
boŞ_t
 
by·ss
);

1569 cÚ¡ *
	gdev·th
;

1573 cÚ¡ *
	gcÚfigfe
;

1576 
boŞ_t
 
	gÃed_³rsi¡’cy
;

1581 
boŞ_t
 
	gis_pŞlšg
;

1583 
	gqueued•th
;

1585 } 
	tkv_deviû_š™_t
;

1589 
kv_key
 *
	gkey
;

1590 
kv_v®ue
 *
	gv®ue
;

1591 } 
	tkv_·œ_t
;

1593 #ifdeà
__ılu¥lus


	@PDK/core/src/device_abstract_layer/include/private/history.hpp

34 #iâdeà
ADI_HISTORY_HPP


35 
	#ADI_HISTORY_HPP


	)

37 
	~"¡dio.h
"

38 
	~"¡dlib.h
"

39 
	~"m©h.h
"

40 
	~"¡dšt.h
"

41 
	~<veùÜ
>

43 
	eİ_ty³
 {

44 
	mSTAT_FIRST
 =0,

45 
	mSTAT_READ
 =0,

46 
	mSTAT_UPDATE
 =1,

47 
	mSTAT_INSERT
 =2,

48 
	mSTAT_DELETE
 =3,

49 
	mSTAT_LAST
 =
STAT_DELETE
,

51 
	g‹m¶©e
 <
	gsize
>

52 şas 
	cİ_hi¡Üy
 {

54 
	mbufãrsize
 = 
size
+1;

55 
	mbufãr
[
size
+1];

56 
	mäÚt
;

57 
	m
;

58 
	mcouÁ”s
[4] = { 0, 0, 0,0 };

59 
	gËngth
 = 0;

60 
	gpublic
:

61 
	$İ_hi¡Üy
():
	`äÚt
(0),
	$
(0) {

62 
	}
}

64 
	$add
 (
v®ue
) {

65 
bufãr
[
äÚt
] = 
v®ue
;

66 
couÁ”s
[
v®ue
]++;

67 
äÚt
 = (äÚt+1è% 
bufãrsize
;

68 
Ëngth
 +=1 ;

70 ià(
äÚt
 =ğ

) {

72 
couÁ”s
[
bufãr
[

]]--;

73 

 = (+1è% 
bufãrsize
;

74 
Ëngth
 --;

76 
	}
}

78 
	$g‘_»adp
() {

80  
couÁ”s
[
STAT_READ
] / 
Ëngth
;

81 
	}
}

83 
	$g‘_upd©•
() {

85  
couÁ”s
[
STAT_UPDATE
] / 
Ëngth
;

86 
	}
}

88 
	$g‘_š£¹p
() {

90  
couÁ”s
[
STAT_INSERT
] / 
Ëngth
;

91 
	}
}

92 
	$g‘_d–‘•
() {

93  
couÁ”s
[
STAT_DELETE
] / 
Ëngth
;

94 
	}
}

98 
	g‹m¶©e
 <
	gsize
>

99 şas 
	cv®ue_hi¡Üy
 {

100 
ušt32_t
 
	msum
 = 0;

101 
	mbufãrsize
 = 
size
+1;

102 
	mbufãr
[
size
+1];

103 
	mäÚt
;

104 
	m
;

105 
	mËngth
;

106 
	mpublic
:

107 
	$v®ue_hi¡Üy
():
	`äÚt
(0),
	`
(0), 
	$Ëngth
(0) {}

109 
	$add
 (
v®ue
) {

110 
bufãr
[
äÚt
] = 
v®ue
;

111 
sum
 +ğ
v®ue
;

112 
äÚt
 = (äÚt+1è% 
bufãrsize
;

113 
Ëngth
++;

115 ià(
äÚt
 =ğ

) {

117 
sum
 -ğ
bufãr
[

];

118 

 = (+1è% 
bufãrsize
;

119 
Ëngth
--;

121 
	}
}

123 
	$m—n_v®ue
() {

124  
¡d
::
	`round
(()
sum
 / 
Ëngth
);

125 
	}
}

129 
	#MAX_FEATURES
 35

	)

131 şas 
	cÏ‹ncy_mod–
 {

132 
	mpublic
:

135 
	$Ï‹ncy_mod–
() {}

139 
	`Ï‹ncy_mod–
(
¡d
::
veùÜ
<> 
iİs_mod–_cÛffic›Ás
) {

140 
size
 = 
iİs_mod–_cÛffic›Ás
.
	`size
();

143 ià(
size
 > 0) {

144 ià(
size
 !ğ(
MAX_FEATURES
 + 1)) {

145 
	`årštf
(
¡d”r
, "WARNING:Ù®‚umb” oàIOPS mod–…¬am‹r should b%d\n", 
MAX_FEATURES
 + 1);

146 
	`årštf
(
¡d”r
, "Please validate device configuration file. Fall backo use default IOPS model\n");

149 
š‹rû±
 = 
iİs_mod–_cÛffic›Ás
[0];

151 
i
 = 1; i <ğ
MAX_FEATURES
; i++) {

152 
cÛffic›Á
[
i
 - 1] = 
iİs_mod–_cÛffic›Ás
[i];

155 
	}
}

158 
	gš‹rû±
 = 93.55536664;

159 
	gcÛffic›Á
[
MAX_FEATURES
] = {

184 
	$ÿlcuÏ‹_ã©u»s
(*
ã©u»s
, 
ušt32_t
 
ã©u»_couÁ
, 
vËn
, 
š£¹
, 
»ad
, 
upd©e
) {

185 ià(
ã©u»_couÁ
 !ğ
MAX_FEATURES
) {

186 
	`´štf
("model feature count doesn't match\n");

190 
ušt32_t
 
x0
 = 
vËn
;

191 
x1
 = 
š£¹
;

192 
x2
 = 
»ad
;

193 
x3
 = 
upd©e
;

195 
ã©u»s
[0] = 1;

196 
ã©u»s
[1] = 
x0
;

197 
ã©u»s
[2] = 
x1
;

198 
ã©u»s
[3] = 
x2
;

199 
ã©u»s
[4] = 
x3
;

201 
ã©u»s
[5] = 
x0
 * x0;

202 
ã©u»s
[6] = 
x0
 * 
x1
;

203 
ã©u»s
[7] = 
x0
 * 
x2
;

204 
ã©u»s
[8] = 
x0
 * 
x3
;

205 
ã©u»s
[9] = 
x1
 * x1;

206 
ã©u»s
[10] = 
x1
 * 
x2
;

207 
ã©u»s
[11] = 
x1
 * 
x3
;

208 
ã©u»s
[12] = 
x2
 * x2;

209 
ã©u»s
[13] = 
x2
 * 
x3
;

210 
ã©u»s
[14] = 
x3
 * x3;

212 
ã©u»s
[15] = 
x0
 * x0 * x0;

213 
ã©u»s
[16] = 
x0
 * x0 * 
x1
;

214 
ã©u»s
[17] = 
x0
 * x0 * 
x2
;

215 
ã©u»s
[18] = 
x0
 * x0 * 
x3
;

216 
ã©u»s
[19] = 
x0
 * 
x1
 * x1;

217 
ã©u»s
[20] = 
x0
 * 
x1
 * 
x2
;

218 
ã©u»s
[21] = 
x0
 * 
x1
 * 
x3
;

219 
ã©u»s
[22] = 
x0
 * 
x2
 * x2;

220 
ã©u»s
[23] = 
x0
 * 
x2
 * 
x3
;

221 
ã©u»s
[24] = 
x0
 * 
x3
 * x3;

223 
ã©u»s
[25] = 
x1
 * x1 * x1;

224 
ã©u»s
[26] = 
x1
 * x1 * 
x2
;

225 
ã©u»s
[27] = 
x1
 * x1 * 
x3
;

226 
ã©u»s
[28] = 
x1
 * 
x2
 * x2;

227 
ã©u»s
[29] = 
x1
 * 
x2
 * 
x3
;

228 
ã©u»s
[30] = 
x1
 * 
x3
 * x3;

229 
ã©u»s
[31] = 
x2
 * x2 * x2;

230 
ã©u»s
[32] = 
x2
 * x2 * 
x3
;

231 
ã©u»s
[33] = 
x2
 * 
x3
 * x3;

232 
ã©u»s
[34] = 
x3
 * x3 * x3;

235 
	}
}

244 
šlše
 
	$mod–_iİs
(
vËn
, 
š£¹
, 
»ad
, 
upd©e
) {

245 
ã©u»s
[
MAX_FEATURES
];

247 ià(
	`ÿlcuÏ‹_ã©u»s
(
ã©u»s
, 
MAX_FEATURES
, 
vËn
, 
š£¹
, 
»ad
, 
upd©e
) < 0) {

251 
iİs
 = 0;

252 
i
 = 0; i < 
MAX_FEATURES
; i++) {

253 
iİs
 +ğ
cÛffic›Á
[
i
] * 
ã©u»s
[i];

256  
iİs
 + 
š‹rû±
;

257 
	}
}

259 
	gpublic
:

260 
št64_t
 
	$ÿlc_Ï‹ncy
(
š£¹p
, 
»adp
, 
upd©•
, 
d–‘•
, 
v®uesize
) {

262 cÚ¡ 
iİs
 = (
	`mod–_iİs
(
v®uesize
, 
š£¹p
, 
»adp
, 
upd©•
) * 1000);

264  1000000000ULL / 
iİs
;

265 
	}
}

268 şas 
	ckv_hi¡Üy
 {

269 
	mpublic
:

270 
İ_hi¡Üy
<16> 
İ_wšdow
;

271 
	mv®ue_hi¡Üy
<16> 
	mv®_wšdow
;

272 
Ï‹ncy_mod–
 
	mmod–
;

276 
	$kv_hi¡Üy
() {}

278 
	`kv_hi¡Üy
(
¡d
::
veùÜ
<> 
iİs_mod–_cÛffic›Ás
è: 
	$mod–
(
iİs_mod–_cÛffic›Ás
è{
	}
}

280 
	$cŞËù
(cÚ¡ 
İ_ty³
 
ty³
, cÚ¡ 
v®uesize
) {

281 
İ_wšdow
.
	`add
(
ty³
);

282 
v®_wšdow
.
	`add
(
v®uesize
);

285 
	}
}

287 
št64_t
 
	$g‘_ex³ùed_Ï‹ncy_ns
() {

288  
mod–
.
	`ÿlc_Ï‹ncy
(
İ_wšdow
.
	`g‘_š£¹p
(), op_wšdow.
	`g‘_»adp
(), op_wšdow.
	`g‘_upd©•
(), op_wšdow.
	`g‘_d–‘•
(), 
v®_wšdow
.
	`m—n_v®ue
());

289 
	}
}

293 şas 
	ckv_tim”
 {

294 
	mg_TicksP”NªoSec
;

295 cÚ¡ 
ušt64_t
 
	mNANO_SECONDS_IN_SEC
 = 1000000000LL;

296 
št64_t
 
	mşock_Ï‹ncy
, 
	mdiff_Ï‹ncy
;

297 
ušt64_t
 
	m§m¶es
[10];

298 
ušt64_t
 
	m§m¶es2
[10];

299 
	mpublic
:

300 
šlše
 
ušt64_t
 
	$RDTSC
() {

302 
lo
,
hi
;

303 
__asm__
 
	`__vŞ©e__
 ("rdtsc" : "÷" (
lo
), "=d" (
hi
));

304  ((
ušt64_t
)
hi
 << 32è| 
lo
;

307 
	$kv_tim”
() {

308 
ušt64_t
 
cyşes_š_us
 = 0;

309 
»t
 = 
	`ÿlc_num_cyşes_³r_us
(&
cyşes_š_us
);

310 ià(
»t
 != -1) {

311 
g_TicksP”NªoSec
 = 
cyşes_š_us
 / 1000.0;

314 
g_TicksP”NªoSec
 = 
	`g‘_cyşes_š_mli
() / 1000000.0;

316 
time¥ec
 
ts1
;

317 
time¥ec
 
ts2
;

318 
time¥ec
 
ts3
;

320 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts1
);

321 
i
 =0 ; i < 10; i++) {

322 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts3
);

323 
§m¶es
[
i
] = 
ts3
.
tv_£c
;

325 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts2
);

326 
şock_Ï‹ncy
 = 
	`TimeS³cDiff2
(&
ts2
, &
ts1
) / 12;

328 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts1
);

329 
i
 =0 ; i < 10; i++) {

330 
§m¶es2
[
i
] = 
	`TimeS³cDiff2
(&
ts2
, &
ts1
);

332 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts2
);

334 
diff_Ï‹ncy
 = (
	`TimeS³cDiff2
(&
ts2
, &
ts1
)) / 10;

338 
	}
}

340 
	$¡¬t2
(
time¥ec
 *
begšts
) {

342 
	`şock_g‘time
(
CLOCK_MONOTONIC
, 
begšts
);

343 
	}
}

345 
	$wa™_uÁ2
 (
time¥ec
 *
begšts
, 
št64_t
 
ex³ùed_Ï‹ncy_ns
) {

346 ià(
ex³ùed_Ï‹ncy_ns
 <= 0) ;

347 
time¥ec
 
’dts
;

349 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
’dts
);

351 
ex³ùed_Ï‹ncy_ns
 -ğ(
şock_Ï‹ncy
) *2;

352 
št64_t
 
n£cEÏp£d
 = 
	`TimeS³cDiff2
(&
’dts
, 
begšts
);

353 
n£cEÏp£d
 < 
ex³ùed_Ï‹ncy_ns
) {

354 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
’dts
);

355 
n£cEÏp£d
 = 
	`TimeS³cDiff2
(&
’dts
, 
begšts
);

356 
n£cEÏp£d
 +ğ
diff_Ï‹ncy
 + 
şock_Ï‹ncy
;

360 
	}
}

362 
šlše
 
ušt64_t
 
	$TimeS³cDiff2
(
time¥ec
 *
ts1
, time¥eø*
ts2
)

364 
time¥ec
 
ts
;

365 
ts
.
tv_£c
 = 
ts1
->tv_£ø- 
ts2
->tv_sec;

366 
ts
.
tv_n£c
 = 
ts1
->tv_n£ø- 
ts2
->tv_nsec;

367 ià(
ts
.
tv_n£c
 < 0) {

368 
ts
.
tv_£c
--;

369 
ts
.
tv_n£c
 +ğ
NANO_SECONDS_IN_SEC
;

371  
ts
.
tv_£c
 * 1000000000LL +s.
tv_n£c
;

372 
	}
}

374 
ušt64_t
 
	$¡¬t
() {

375  
	`RDTSC
();

376 
	}
}

378 
	$wa™_uÁ
 (
ušt64_t
 
¡¬t
, 
št64_t
 
ex³ùed_Ï‹ncy_ns
, ušt64_ˆ
kv_emul_queue_Ï‹ncy
) {

379 ià(
ex³ùed_Ï‹ncy_ns
 <= 0) ;

382 
ušt64_t
 
ex³ùed
 = (
ex³ùed_Ï‹ncy_ns
 - 
kv_emul_queue_Ï‹ncy
è* 
g_TicksP”NªoSec
;

383 
	`RDTSC
(è- 
¡¬t
 < 
ex³ùed
) {

384 
ex³ùed
 -= 100;

386 
	}
}

388 
	g´iv©e
:

389 #´agm¨
GCC
 
push_İtiÚs


390 #´agm¨
GCC
 
İtimize
 ("O0")

392 
	$loİ
() {

393 
ušt64_t
 
i
;

394 
i
 = 0; i < 1000000; i++);

395 
	}
}

396 #´agm¨
GCC
 
pİ_İtiÚs


399 
	$x86tim”
() {

401 
ušt64_t
 
b’ch1
=0;

402 
ušt64_t
 
b’ch2
=0;

404 
b’ch1
=
	`RDTSC
();

406 
	`u¦“p
(250000);

408 
b’ch2
=
	`RDTSC
();

410 
g_TicksP”NªoSec
=
b’ch2
-
b’ch1
;

411 
g_TicksP”NªoSec
*=4.0e-9;

413 
	`årštf
(
¡d”r
, "şock ³¸£cÚd = %f\n", 
g_TicksP”NªoSec
);

414 
	}
}

416 
	$ÿlc_num_cyşes_³r_us
(
ušt64_t
 *
cyşes_³r_us
) {

417 
time¥ec
 
¦“±ime
 = { 0, 0 };

418 
time¥ec
 
ts_¡¬t
, 
ts_’d
;

421 
¦“±ime
.
tv_n£c
 = 1000000000ULL / 2;

423 ià(
	`şock_g‘time
(
CLOCK_MONOTONIC_RAW
, &
ts_¡¬t
) == 0) {

424 
ušt64_t
 
tsc_¡¬t
, 
tsc_’d
, 
ns
;

425 
u£cs
;

427 
tsc_¡¬t
 = 
	`RDTSC
();

428 
	`Çno¦“p
(&
¦“±ime
, 
NULL
);

429 
	`şock_g‘time
(
CLOCK_MONOTONIC_RAW
, &
ts_’d
);

430 
tsc_’d
 = 
	`RDTSC
();

431 
ns
 = ((
ts_’d
.
tv_£c
 - 
ts_¡¬t
.tv_sec) * 1000000000ULL);

432 
ns
 +ğ(
ts_’d
.
tv_n£c
 - 
ts_¡¬t
.tv_nsec);

434 
u£cs
 = ()
ns
 / 1000;

435 *
cyşes_³r_us
 = (
ušt64_t
)((
tsc_’d
 - 
tsc_¡¬t
)/
u£cs
);

439 
	}
}

441 
ušt64_t
 
	$g‘_cyşes_š_mli
() {

442 
khz
;

443 
FILE
 *
å
 =

444 
	`fİ’
("/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq", "r");

445 ià(!
å
) {

446 
	`fşo£
(
å
);

447 
	`³¼Ü
("cannot open cpu max frequency file");

450 
»t
 = 
	`fsÿnf
(
å
, "%d\n", &
khz
);

451 ià(!
»t
) {

454 
	`fşo£
(
å
);

455  
khz
;

456 
	}
}

458 
	$C®ib¿‹Ticks
()

460 
time¥ec
 
begšts
, 
’dts
;

461 
ušt64_t
 
begš
 = 0, 
’d
 = 0;

462 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
begšts
);

463 
begš
 = 
	`RDTSC
();

464 
	`loİ
();

467 
’d
 = 
	`RDTSC
();

468 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
’dts
);

469 
time¥ec
 *
tm±s
 = 
	`TimeS³cDiff
(&
’dts
, &
begšts
);

470 
ušt64_t
 
n£cEÏp£d
 = 
tm±s
->
tv_£c
 * 1000000000LL +m±s->
tv_n£c
;

471 
g_TicksP”NªoSec
 = ()(
’d
 - 
begš
)/()
n£cEÏp£d
;

477 
	}
}

480 
time¥ec
 *
	$TimeS³cDiff
(
time¥ec
 *
ts1
, time¥eø*
ts2
)

482 
time¥ec
 
ts
;

483 
ts
.
tv_£c
 = 
ts1
->tv_£ø- 
ts2
->tv_sec;

484 
ts
.
tv_n£c
 = 
ts1
->tv_n£ø- 
ts2
->tv_nsec;

485 ià(
ts
.
tv_n£c
 < 0) {

486 
ts
.
tv_£c
--;

487 
ts
.
tv_n£c
 +ğ
NANO_SECONDS_IN_SEC
;

489  &
ts
;

490 
	}
}

	@PDK/core/src/device_abstract_layer/include/private/io_cmd.hpp

34 #iâdeà
_IO_CMD_INCLUDE_H_


35 
	#_IO_CMD_INCLUDE_H_


	)

37 
	~<th»ad
>

38 
	~"kvs_adi.h
"

39 
	~"kvs_adi_š‹º®.h
"

44 
Çme¥aû
 
	gkvadi
 {

46 
şass
 
	gkv_deviû_š‹º®
;

47 
şass
 
	gkv_Çme¥aû_š‹º®
;

48 
şass
 
	gioqueue
;

50 şas 
	cio_cmd
 {

51 
	gpublic
:

53 
io_ùx_t
 
ioùx
;

59 
io_cmd
(
kv_deviû_š‹º®
 *, 
kv_Çme¥aû_š‹º®
 *
ns
, 
kv_queue_hªdË
 
que_hdl
);

62 
£t_»tcode
(
kv_»suÉ
 
cu¼’t_»suÉ
);

64 cÚ¡ 
kv_key
* 
g‘_key
();

65 cÚ¡ 
kv_v®ue
* 
g‘_v®ue
();

68 
kv_»suÉ
 
execu‹_cmd
();

70 
ušt16_t
 
g‘_sqid
();

73 
£t_sqid
(
ušt16_t
 
sqid
);

76 
ioqueue
 *
g‘_queue
();

80 
ÿÎ_po¡_´oûss_func
();

85 #ifdeà
ENABLE_LATENCY_TRACING


86 
	g¡d
::
chrÚo
::
time_pošt
<
¡d
::chrÚo::
sy¡em_şock
> 
š£¹ed_i
;

87 
	g¡d
::
chrÚo
::
time_pošt
<
¡d
::chrÚo::
sy¡em_şock
> 
eviùed_i
;

88 
	g¡d
::
chrÚo
::
time_pošt
<
¡d
::chrÚo::
sy¡em_şock
> 
š£¹ed_o
;

89 
	g¡d
::
chrÚo
::
time_pošt
<
¡d
::chrÚo::
sy¡em_şock
> 
eviùed_o
;

91 
´št_Ï‹ncy
() {

92 
årštf
(
¡d”r
, "submissiÚ queuš£¹ - submissiÚ queueviù: %ld‚ \n", 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
Çno£cÚds
>(
eviùed_i
 - 
š£¹ed_i
).
couÁ
() );

93 
årštf
(
¡d”r
, "´oûssšgim: %ld‚ \n", 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
Çno£cÚds
>(
š£¹ed_o
 - 
eviùed_i
 ).
couÁ
() );

94 
årštf
(
¡d”r
, "com¶‘iÚ queuš£¹ -ƒviù : %ld‚ \n", 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
Çno£cÚds
>(
eviùed_o
 - 
eviùed_i
 ).
couÁ
() );

98 
	g´iv©e
:

106 
¡d
::
th»ad
::
id
 
m_th»ad_id
;

117 
kv_deviû_š‹º®
 *
	gm_dev
;

120 
ušt32_t
 
	gm_nsid
;

121 
kv_Çme¥aû_š‹º®
 *
	gm_ns
;

124 
ušt16_t
 
	gm_cmd_id
;

127 
ušt16_t
 
	gm_sqid
;

130 
ušt16_t
 
	gm_cqid
;

133 
ioqueue
 *
	gm_que
;

	@PDK/core/src/device_abstract_layer/include/private/kv_config.hpp

34 #iâdeà
_KV_CONFIG_INCLUDE_H_


35 
	#_KV_CONFIG_INCLUDE_H_


	)

37 
	~<¿ndom
>

38 
	~<cm©h
>

39 
	~<unÜd”ed_m­
>

40 
	~"kvs_adi_š‹º®.h
"

44 
Çme¥aû
 
	gkvadi
 {

46 şas 
	ckv_cÚfig
 {

47 
	gpublic
:

48 
kv_cÚfig
(
¡d
::
¡ršg
 
cÚfigfe
);

49 ~
kv_cÚfig
() {}

52 
boŞ_t
 
lßd_cÚfig
(
¡d
::
¡ršg
 
cÚfigfe
);

56 
ušt32_t
 
g’”©e_§m¶e_Ï‹ncy
(
ušt16_t
 
İcode
);

59 
	g¡d
::
¡ršg
 
g‘kv
(
¡d
::¡ršg cÚ¡& 
£ùiÚ
, std::¡ršg cÚ¡& 
key
) const;

62 
	g¡d
::
¡ršg
 
Œim
(
¡d
::¡ršg cÚ¡& 
sourû
, cÚ¡* 
d–ims
);

65 cÚ¡ 
	g¡d
::
¡ršg
 
m—n_£ùiÚ_Çme
;

67 cÚ¡ 
	g¡d
::
¡ršg
 
¡dev_£ùiÚ_Çme
;

69 
	g´iv©e
:

71 
ušt32_t
 
g‘_m—n_Ï‹ncy
(
ušt16_t
 
İcode
);

73 
ušt32_t
 
g‘_¡dev_Ï‹ncy
(
ušt16_t
 
İcode
);

78 
	g¡d
::
deçuÉ_¿ndom_’gše
 
m_g’”©Ü
;

88 
	g¡d
::
unÜd”ed_m­
<
¡d
::
¡ršg
, std::¡ršg> 
m_cÚfig_kv
;

	@PDK/core/src/device_abstract_layer/include/private/kv_device.hpp

34 #iâdeà
_KV_DEVICE_INTERNAL_INCLUDE_H_


35 
	#_KV_DEVICE_INTERNAL_INCLUDE_H_


	)

37 
	~<chrÚo
>

38 
	~<queue
>

39 
	~<£t
>

40 
	~<unÜd”ed_m­
>

42 
	~"kvs_adi.h
"

43 
	~"kvs_adi_š‹º®.h
"

45 
	~"kv_cÚfig.hµ
"

46 
	~"kv_Çme¥aû.hµ
"

47 
	~"queue.hµ
"

48 
	~"th»ad_poŞ.hµ
"

50 
Çme¥aû
 
	gkvadi
 {

53 şas 
	ckv_deviû_š‹º®
 {

54 
	gpublic
:

57 cÚ¡ 
¡d
::
¡ršg
 
cÚfigfe
;

60 
shutdown_®l_queues
();

63 
boŞ_t
 
is_keyËn_fixed
();

67 
boŞ_t
 
u£_iİs_mod–
();

69 
boŞ_t
 
š£¹_Çme¥aû
(
ušt32_t
 
nsid
, 
kv_Çme¥aû_š‹º®
 *
ns
);

71 
	gkv_cÚfig
*& 
g‘_cÚfig
();

73 
ušt64_t
 
g‘_ÿ·c™y
();

74 
ušt64_t
 
g‘_avaabË
();

77 
ušt32_t
 
g‘_devid
();

80 
kv_»suÉ
 
»move_queue
(
ušt16_t
 
qid
);

83 
ušt16_t
 
g‘_cqid_äom_sqid
(ušt16_ˆ
sqid
);

85 
ioqueue
 *
g‘_ioqueue
(
ušt16_t
 
qid
);

88 
kv_»suÉ
 
g‘_io_queue_šfo
(
ušt16_t
 
qid
, 
kv_queue
 *
queue_šfo
);

91 
	g¡d
::
£t
<
ušt16_t
> 
g‘_·œed_SQ_ids
(ušt16_ˆ
CQ_id
);

94 
kv_»suÉ
 
subm™_io
(
kv_queue_hªdË
 
que_hdl
, 
io_cmd
 *
cmd
);

98 
kv_»suÉ
 
ü—‹_queue
(cÚ¡ 
kv_queue
 *
quešfo
, 
kv_queue_hªdË
 *
que_hdl
);

99 
kv_deviû
 
g‘_devšfo
();

100 
kv_deviû_¡©
 
g‘_dev_¡©
();

101 
ioqueue
 *
g‘_queue_š‹º®
(
ušt16_t
 
qid
);

102 
kv_Çme¥aû_š‹º®
 *
g‘_Çme¥aû_deçuÉ
();

103 
kv_Çme¥aû_š‹º®
 *
g‘_Çme¥aû
(cÚ¡ 
ušt32_t
 
nsid
);

106 
boŞ_t
 
is_š™Ÿlized
();

111 
kv_»suÉ
 
kv_š™Ÿlize_deviû
(
kv_deviû_š™_t
 *
İtiÚs
, 
kv_deviû_hªdË
 *
dev_hdl
);

113 
kv_»suÉ
 
kv_ş—nup_deviû
(
kv_deviû_hªdË
 
dev_hdl
);

115 
kv_»suÉ
 
kv_g‘_deviû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû
 *
devšfo
);

117 
kv_»suÉ
 
kv_g‘_deviû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû_¡©
 *
dev¡©
);

119 
kv_»suÉ
 
kv_g‘_deviû_waf
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, *
waf
);

121 
kv_»suÉ
 
kv_§n™ize
(
kv_queue_hªdË
 
que_hdl
, 
kv_deviû_hªdË
 
dev_hdl
, 
kv_§n™ize_İtiÚ
 
İtiÚ
, 
kv_§n™ize_·‰”n
 *
·‰”n
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

126 
kv_deviû_š‹º®
 *
g‘_deviû_š¡ªû
(
kv_deviû_hªdË
 
dev_hdl
);

127 
kv_deviû_š‹º®
 *
g‘_deviû_š¡ªû
(
ušt32_t
 
devid
);

135 
kv_»suÉ
 
kv_ü—‹_queue
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue
 *
quešfo
, 
kv_queue_hªdË
 *
que_hdl
);

137 
kv_»suÉ
 
kv_d–‘e_queue
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 
que_hdl
);

139 
kv_»suÉ
 
kv_g‘_queue_hªdËs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
);

140 
kv_»suÉ
 
kv_g‘_queue_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue
 *
quešfo
);

141 
kv_»suÉ
 
kv_g‘_queue_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue_¡©
 *
que_¡
);

144 
kv_»suÉ
 
kv_g‘_queue_hªdËs
(
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
);

147 
kv_»suÉ
 
kv_ü—‹_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû
 *
ns
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

148 
kv_»suÉ
 
kv_d–‘e_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

149 
kv_»suÉ
 
kv_©ch_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

150 
kv_»suÉ
 
kv_d‘ach_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
);

151 
kv_»suÉ
 
kv_li¡_Çme¥aûs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdls
, 
ušt32_t
 *
ns_út
);

152 
kv_»suÉ
 
kv_g‘_Çme¥aû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû
 *
nsšfo
);

153 
kv_»suÉ
 
kv_g‘_Çme¥aû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû_¡©
 *
ns_¡©
);

154 
kv_»suÉ
 
_kv_by·ss_Çme¥aû
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
boŞ_t
 
by·ss
);

157 
kv_»suÉ
 
kv_purge
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_purge_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

159 
kv_»suÉ
 
kv_İ’_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

161 
kv_»suÉ
 
kv_şo£_™”©Ü
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_™”©Ü_hªdË
 
™”_hdl
);

163 
kv_»suÉ
 
kv_™”©Ü_Ãxt_£t
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_™”©Ü_li¡
 *
™”_li¡
);

165 
kv_»suÉ
 
kv_™”©Ü_Ãxt
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
);

167 
kv_»suÉ
 
kv_li¡_™”©Üs
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
);

170 
kv_»suÉ
 
kv_d–‘e
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_d–‘e_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

172 
kv_»suÉ
 
kv_d–‘e_group
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

174 
kv_»suÉ
 
kv_exi¡
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
key_út
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
bufãr
);

176 
kv_»suÉ
 
kv_»Œ›ve
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_»Œ›ve_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
, 
kv_v®ue
 *
v®ue
);

177 
kv_»suÉ
 
kv_¡Üe
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
kv_¡Üe_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
);

182 
kv_»suÉ
 
kv_pŞl_com¶‘iÚ
(
kv_queue_hªdË
 
que_hdl
, 
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_com¶‘ed
);

188 
kv_»suÉ
 
kv_£t_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
);

190 
kv_š‹¼u±_hªdËr
 
kv_g‘_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
);

192 
boŞ_t
 
is_pŞlšg
();

193 
kv_¿w_dev_ty³
 
g‘_dev_ty³
();

196 
boŞ_t
 
upd©e_ÿ·c™y_cÚsumed
();

198 
ušt32_t
 
g‘_Ãxt_devid
();

200 
	g¡d
::
¡ršg
& 
g‘_dev·th
();

203 
kv_»suÉ
 
g‘_š™_¡©us
();

204 
£t_š™_¡©us
(
kv_»suÉ
 
»suÉ
);

206 ~
kv_deviû_š‹º®
();

208 
	g´iv©e
:

210 
¡d
::
mu‹x
 
m_mu‹x
;

213 
	g¡d
::
»cursive_mu‹x
 
s_mu‹x
;

214 
	g¡d
::
unÜd”ed_m­
<
ušt32_t
, 
	gkv_deviû_š‹º®
 *> 
	gs_glob®_deviû_li¡
;

215 
ušt32_t
 
	gs_Ãxt_devid
;

218 
kv_deviû_š‹º®
();

219 
kv_deviû_š‹º®
(
kv_deviû_š™_t
 *
İtiÚs
);

222 
kv_deviû_š‹º®
(cÚ¡ kv_deviû_š‹º®&èğ
d–‘e
;

223 
	gkv_deviû_š‹º®
& 
	gİ”©Ü
=(cÚ¡ 
kv_deviû_š‹º®
&èğ
d–‘e
;

226 
boŞ_t
 
	gm_š™Ÿlized
;

228 
kv_»suÉ
 
	gm_š™_¡©us
;

231 
boŞ_t
 
	gm_Ãed_³rsi£ncy
;

237 
kv_¿w_dev_ty³
 
	gm_dev_ty³
;

239 
boŞ_t
 
	gm_is_emuÏtÜ
;

242 
kv_deviû_ty³
 
	gm_deviû_ty³
;

245 
ušt32_t
 
	gm_Ãxt_qid
;

247 
ušt32_t
 
	gm_devid
;

248 
ušt32_t
 
	gm_nsid
;

252 
kv_deviû
 
	gm_deviû_šfo
;

254 
kv_deviû_¡©
 
	gm_deviû_¡©
;

257 
	g¡d
::
¡ršg
 
m_dev·th
;

262 
	g¡d
::
chrÚo
::
sy¡em_şock
::
time_pošt
 
m_¡¬t_tim•ošt
;

267 
	g¡d
::
unÜd”ed_m­
<
št32_t
, 
	gkv_Çme¥aû_š‹º®
 *> 
	gm_ns_li¡
;

270 
	g¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gioqueue
 *> 
	gm_ioque_li¡
;

273 
	g¡d
::
unÜd”ed_m­
<
ušt16_t
, 
	gušt16_t
> 
	gm_sq_to_cq_·œs
;

276 
kv_cÚfig
 *
	gm_cÚfig
;

279 
boŞ_t
 
	gm_is_pŞl
;

283 
boŞ_t
 
	gm_has_fixed_keyËn
;

286 
boŞ_t
 
	gm_u£_iİs_mod–
;

289 
ušt64_t
 
	gm_ÿ·c™y
;

	@PDK/core/src/device_abstract_layer/include/private/kv_emulator.hpp

34 #iâdeà
_KV_STORE_INCLUDE_H_


35 
	#_KV_STORE_INCLUDE_H_


	)

37 
	~<¡ršg
>

38 
	~<unÜd”ed_m­
>

39 
	~<m­
>

40 
	~<£t
>

41 
	~<li¡
>

42 
	~<b™£t
>

43 
	~<unÜd”ed_m­
>

44 
	~"kvs_adi_š‹º®.h
"

45 
	~"hi¡Üy.hµ
"

53 
Çme¥aû
 
	gkvadi
 {

55 
	sCmpEmulP»fix
 {

56 
boŞ
 
İ”©Ü
()(cÚ¡ 
kv_key
* 
	ga
, cÚ¡ kv_key* 
	gb
) const {

58 cÚ¡ *
	g¡rA
 = (cÚ¡ *)
a
->
key
;

59 cÚ¡ *
	g¡rB
 = (cÚ¡ *)
b
->
key
;

62 
ušt32_t
 
	gštA
 = 0;

63 
memıy
(&
štA
, 
¡rA
, 4);

64 
ušt32_t
 
	gštB
 = 0;

65 
memıy
(&
štB
, 
¡rB
, 4);

68 ià(
	gštA
 =ğ
štB
) {

70 ià(
a
->
Ëngth
 < 
b
->length) {

71  
Œue
;

72 } ià(
	ga
->
	gËngth
 > 
	gb
->length) {

73  
	gçl£
;

77  (
memcmp
(
¡rA
 + 4, 
¡rB
 + 4, 
b
->
Ëngth
 - 4) < 0);

80  
	gštA
 < 
	gštB
;

85 şas 
	ckv_noİ_emuÏtÜ
 : 
public
 
kv_deviû_­i
{

86 
public
:

87 
kv_noİ_emuÏtÜ
(
ušt64_t
 
ÿ·c™y
) {}

88 
vœtu®
 ~
kv_noİ_emuÏtÜ
() {}

91 
kv_»suÉ
 
kv_¡Üe
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
cÚsumed_by‹s
, *
ioùx
è{  
	gKV_SUCCESS
; }

92 
kv_»suÉ
 
kv_»Œ›ve
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, *
ioùx
è{  
	gKV_SUCCESS
; }

93 
kv_»suÉ
 
kv_exi¡
(cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
keycouÁ
, 
ušt8_t
 *
v®ue
, ušt32_ˆ&
v®uesize
, *
ioùx
è{  
	gKV_SUCCESS
; }

94 
kv_»suÉ
 
kv_purge
(
kv_purge_İtiÚ
 
İtiÚ
, *
ioùx
è{  
	gKV_SUCCESS
; }

95 
kv_»suÉ
 
kv_d–‘e
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
»cov”ed_by‹s
, *
ioùx
è{  
	gKV_SUCCESS
; }

98 
kv_»suÉ
 
kv_İ’_™”©Ü
(cÚ¡ 
kv_™”©Ü_İtiÚ
 
İt
, cÚ¡ 
kv_group_cÚd™iÚ
 *
cÚd
, 
boŞ_t
 
keyËn_fixed
, 
kv_™”©Ü_hªdË
 *
™”_hdl
, *
ioùx
è{  
	gKV_SUCCESS
; }

99 
kv_»suÉ
 
kv_şo£_™”©Ü
(
kv_™”©Ü_hªdË
 
™”_hdl
, *
ioùx
è{  
	gKV_SUCCESS
; }

100 
kv_»suÉ
 
kv_™”©Ü_Ãxt
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, *
ioùx
è{  
	gKV_SUCCESS
; }

101 
kv_»suÉ
 
kv_™”©Ü_Ãxt_£t
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, *
ioùx
è{  
	gKV_SUCCESS
; }

102 
kv_»suÉ
 
kv_li¡_™”©Üs
(
kv_™”©Ü
 *
™”_li¡
, 
ušt32_t
 *
couÁ
, *
ioùx
è{  
	gKV_SUCCESS
; }

103 
kv_»suÉ
 
kv_d–‘e_group
(
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
ušt64_t
 *
»cov”ed_by‹s
, *
ioùx
è{  
	gKV_SUCCESS
; }

105 
kv_»suÉ
 
£t_š‹¼u±_hªdËr
(cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
è{  
	gKV_SUCCESS
; }

106 
kv_š‹¼u±_hªdËr
 
g‘_š‹¼u±_hªdËr
(è{  
	gNULL
; }

107 
kv_»suÉ
 
pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
è{  
	gKV_SUCCESS
; }

109 
ušt64_t
 
g‘_tÙ®_ÿ·c™y
() {  -1; }

110 
ušt64_t
 
g‘_avaabË
() {  -1; }

113 şas 
	ckv_emuÏtÜ
 : 
public
 
kv_deviû_­i
{

114 
public
:

115 
kv_emuÏtÜ
(
ušt64_t
 
ÿ·c™y
, 
¡d
::
veùÜ
<> 
iİs_mod–_cÛffic›Ás
, 
boŞ_t
 
u£_iİs_mod–
, 
ušt32_t
 
nsid
);

116 
	gvœtu®
 ~
kv_emuÏtÜ
();

119 
kv_»suÉ
 
kv_¡Üe
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
cÚsumed_by‹s
, *
ioùx
);

120 
kv_»suÉ
 
kv_»Œ›ve
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, *
ioùx
);

121 
kv_»suÉ
 
kv_exi¡
(cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
keycouÁ
, 
ušt8_t
 *
v®ue
, ušt32_ˆ&
v®uesize
, *
ioùx
);

122 
kv_»suÉ
 
kv_purge
(
kv_purge_İtiÚ
 
İtiÚ
, *
ioùx
);

123 
kv_»suÉ
 
kv_d–‘e
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
»cov”ed_by‹s
, *
ioùx
);

126 
kv_»suÉ
 
kv_İ’_™”©Ü
(cÚ¡ 
kv_™”©Ü_İtiÚ
 
İt
, cÚ¡ 
kv_group_cÚd™iÚ
 *
cÚd
, 
boŞ_t
 
keyËn_fixed
, 
kv_™”©Ü_hªdË
 *
™”_hdl
, *
ioùx
);

127 
kv_»suÉ
 
kv_şo£_™”©Ü
(
kv_™”©Ü_hªdË
 
™”_hdl
, *
ioùx
);

128 
kv_»suÉ
 
kv_™”©Ü_Ãxt_£t
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, *
ioùx
);

129 
kv_»suÉ
 
kv_™”©Ü_Ãxt
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, *
ioùx
);

130 
kv_»suÉ
 
kv_li¡_™”©Üs
(
kv_™”©Ü
 *
™”_li¡
, 
ušt32_t
 *
couÁ
, *
ioùx
);

131 
kv_»suÉ
 
kv_d–‘e_group
(
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
ušt64_t
 *
»cov”ed_by‹s
, *
ioùx
);

133 
ušt64_t
 
g‘_tÙ®_ÿ·c™y
();

134 
ušt64_t
 
g‘_avaabË
();

138 
kv_»suÉ
 
£t_š‹¼u±_hªdËr
(cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
);

139 
kv_š‹¼u±_hªdËr
 
g‘_š‹¼u±_hªdËr
();

140 
kv_»suÉ
 
pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
);

142 
	g´iv©e
:

144 
kv_hi¡Üy
 
¡©
;

145 
šlše
 
š£¹_to_unÜd”ed_m­
(
¡d
::
unÜd”ed_m­
<
kv_key
*, std::
¡ršg
> &
unÜd”ed
, kv_key* 
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, cÚ¡ std::¡ršg &
v®¡r
, 
ušt8_t
 
İtiÚ
);

147 
ušt64_t
 
	gm_ÿ·c™y
;

150 
ušt64_t
 
	gm_avaabË
;

152 
	g¡d
::
	tm­
<
	tkv_key
*, 
	t¡d
::
	t¡ršg
, 
	tCmpEmulP»fix
> 
	temuÏtÜ_m­_t
;

154 
	g¡d
::
m­
<
kv_key
*, std::
¡ršg
, 
	gCmpEmulP»fix
> 
	gm_m­
;

155 
	g¡d
::
mu‹x
 
m_m­_mu‹x
;

157 
	g¡d
::
m­
<
št32_t
, 
	g_kv_™”©Ü_hªdË
 *> 
	gm_™_m­
;

158 
kv_™”©Ü
 
	gm_™”©Ü_li¡
[
SAMSUNG_MAX_ITERATORS
];

159 
	g¡d
::
mu‹x
 
m_™_m­_mu‹x
;

162 
boŞ_t
 
	gm_u£_iİs_mod–
;

164 
ušt32_t
 
	gm_nsid
;

166 
kv_š‹¼u±_hªdËr
 
	gm_š‹¼u±_hªdËr
;

	@PDK/core/src/device_abstract_layer/include/private/kv_namespace.hpp

34 #iâdeà
_KV_NAMESPACE_INTERNAL_INCLUDE_H_


35 
	#_KV_NAMESPACE_INTERNAL_INCLUDE_H_


	)

37 
	~"kvs_adi.h
"

38 
	~"kvs_adi_š‹º®.h
"

39 
	~"kv_deviû.hµ
"

41 
Çme¥aû
 
	gkvadi
 {

48 
şass
 
	gkv_deviû_š‹º®
;

50 şas 
	ckv_Çme¥aû_š‹º®
 {

51 
	gpublic
:

53 
ušt32_t
 
g‘_nsid
();

54 
kv_deviû_š‹º®
 *
g‘_dev
();

56 
boŞ_t
 
is_purge_š_´og»ss
();

57 
£t_purge_š_´og»ss
(
boŞ_t
 
š_´og»ss
);

62 
kv_»suÉ
 
kv_g‘_Çme¥aû_šfo
(
kv_Çme¥aû
 *
ns
);

63 
kv_»suÉ
 
kv_g‘_Çme¥aû_¡©
(
kv_Çme¥aû_¡©
 *
ns_¡
);

66 
kv_»suÉ
 
kv_purge
(
kv_purge_İtiÚ
 
İtiÚ
, *
ioùx
);

67 
kv_»suÉ
 
kv_d–‘e
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
»cov”ed_by‹s
, *
ioùx
);

68 
kv_»suÉ
 
kv_exi¡
(cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
keycouÁ
, 
ušt8_t
 *
v®ue
, ušt32_ˆ&
v®uesize
, *
ioùx
);

69 
kv_»suÉ
 
kv_»Œ›ve
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, *
ioùx
);

70 
kv_»suÉ
 
kv_¡Üe
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
cÚsumed_by‹s
, *
ioùx
);

72 
kv_»suÉ
 
kv_İ’_™”©Ü
(cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
kv_™”©Ü_hªdË
 *
™”_hdl
, *
ioùx
);

73 
kv_»suÉ
 
kv_şo£_™”©Ü
(
kv_™”©Ü_hªdË
 
™”_hdl
, *
ioùx
);

74 
kv_»suÉ
 
kv_™”©Ü_Ãxt
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, *
ioùx
);

75 
kv_»suÉ
 
kv_™”©Ü_Ãxt_£t
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, *
ioùx
);

76 
kv_»suÉ
 
kv_li¡_™”©Üs
(
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
, *
ioùx
);

77 
kv_»suÉ
 
kv_d–‘e_group
(
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
ušt64_t
 *
»cov”ed_by‹s
, *
ioùx
);

79 
kv_»suÉ
 
£t_š‹¼u±_hªdËr
(cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
);

80 
kv_š‹¼u±_hªdËr
 
g‘_š‹¼u±_hªdËr
();

83 
ušt64_t
 
g‘_cÚsumed_¥aû
();

85 
kv_Çme¥aû_š‹º®
(
kv_deviû_š‹º®
 *
dev
, 
ušt32_t
 
nsid
, cÚ¡ 
kv_Çme¥aû
 *
ns
);

86 ~
kv_Çme¥aû_š‹º®
();

88 
kv_deviû_­i
 *
g‘_kv¡Üe
();

90 
sw­_deviû
(
boŞ
 
u£dummy
);

92 
ušt64_t
 
g‘_tÙ®_ÿ·c™y
();

93 
ušt64_t
 
g‘_avaabË
();

96 
kv_»suÉ
 
g‘_š™_¡©us
();

98 
	g´iv©e
:

99 
kv_»suÉ
 
m_š™_¡©us
;

101 
kv_Çme¥aû_š‹º®
();

103 
	g¡d
::
mu‹x
 
m_mu‹x
;

106 
boŞ_t
 
	gm_purgšg_š_´og»ss
;

107 
kv_po¡´oûss_funùiÚ
 
	gm_po¡´oûss_func
;

110 
ušt32_t
 
	gm_nsid
;

113 
kv_deviû_š‹º®
 *
	gm_dev
;

116 
kv_Çme¥aû
 
	gm_ns_šfo
;

119 
kv_Çme¥aû_¡©
 
	gm_ns_¡©
;

128 
kv_deviû_­i
 *
	gm_kv¡Üe
;

129 
kv_deviû_­i
 *
	gm_emul
;

132 
kv_deviû_­i
 *
	gm_dummy
;

	@PDK/core/src/device_abstract_layer/include/private/kvs_adi_internal.h

34 #iâdeà
_KVS_ADI_INTERNAL_INCLUDE_H_


35 
	#_KVS_ADI_INTERNAL_INCLUDE_H_


	)

37 
	~<¡dšt.h
>

38 
	~<th»ad
>

39 
	~<memÜy.h
>

40 
	~<mu‹x
>

41 
	~<cÚd™iÚ_v¬ŸbË
>

42 
	~<unÜd”ed_m­
>

43 
	~"kvs_adi.h
"

44 
	~"kvs_uts.h
"

46 
	#MAX_LOG_PAGE_SIZE
 512

	)

47 şas 
	ckv_deviû_­i
 {

48 
	mpublic
:

49 
vœtu®
 ~
	$kv_deviû_­i
() {}

51 
vœtu®
 
kv_»suÉ
 
	`kv_¡Üe
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
cÚsumed_by‹s
, *
ioùx
) =0;

52 
vœtu®
 
kv_»suÉ
 
	`kv_»Œ›ve
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, *
ioùx
) =0;

53 
vœtu®
 
kv_»suÉ
 
	`kv_exi¡
(cÚ¡ 
kv_key
 *
key
, 
ušt32_t
 
keycouÁ
, 
ušt8_t
 *
v®ue
, ušt32_ˆ&
v®uesize
, *
ioùx
) =0;

54 
vœtu®
 
kv_»suÉ
 
	`kv_purge
(
kv_purge_İtiÚ
 
İtiÚ
, *
ioùx
) =0;

55 
vœtu®
 
kv_»suÉ
 
	`kv_d–‘e
(cÚ¡ 
kv_key
 *
key
, 
ušt8_t
 
İtiÚ
, 
ušt32_t
 *
»cov”ed_by‹s
, *
ioùx
) =0;

58 
vœtu®
 
kv_»suÉ
 
	`kv_İ’_™”©Ü
(cÚ¡ 
kv_™”©Ü_İtiÚ
 
İt
, cÚ¡ 
kv_group_cÚd™iÚ
 *
cÚd
, 
boŞ_t
 
keyËn_fixed
, 
kv_™”©Ü_hªdË
 *
™”_hdl
, *
ioùx
) =0;

59 
vœtu®
 
kv_»suÉ
 
	`kv_şo£_™”©Ü
(
kv_™”©Ü_hªdË
 
™”_hdl
, *
ioùx
) =0;

60 
vœtu®
 
kv_»suÉ
 
	`kv_™”©Ü_Ãxt_£t
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, *
ioùx
) =0;

61 
vœtu®
 
kv_»suÉ
 
	`kv_™”©Ü_Ãxt
(
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, *
ioùx
) =0;

62 
vœtu®
 
kv_»suÉ
 
	`kv_li¡_™”©Üs
(
kv_™”©Ü
 *
™”_li¡
, 
ušt32_t
 *
couÁ
, *
ioùx
) =0;

63 
vœtu®
 
kv_»suÉ
 
	`kv_d–‘e_group
(
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
ušt64_t
 *
»cov”ed_by‹s
, *
ioùx
) =0;

69 
vœtu®
 
kv_»suÉ
 
	`£t_š‹¼u±_hªdËr
(cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
) = 0;

70 
vœtu®
 
kv_š‹¼u±_hªdËr
 
	`g‘_š‹¼u±_hªdËr
() = 0;

74 
vœtu®
 
kv_»suÉ
 
	`pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
) = 0;

77 
vœtu®
 
ušt64_t
 
	`g‘_tÙ®_ÿ·c™y
() =0;

78 
vœtu®
 
ušt64_t
 
	`g‘_avaabË
() =0;

81 
vœtu®
 
kv_»suÉ
 
	$g‘_š™_¡©us
(è{  
KV_SUCCESS
; 
	}
}

84 #ifdeà
__ılu¥lus


89 
	s_kv_deviû_hªdË
 {

90 
ušt32_t
 
devid
;

92 *
dev
;

95 
	s_kv_queue_hªdË
{

96 
ušt16_t
 
qid
;

98 *
dev
;

100 *
queue
;

104 
	s_kv_Çme¥aû_hªdË
{

105 
ušt32_t
 
nsid
;

107 *
dev
;

109 *
ns
;

113 
	#ITERATOR_BUFFER_LEN
 32 * 1024

	)

114 
	s_kv_™”©Ü_hªdË
 {

115 
id
;

116 
cu¼’t_key
[
SAMSUNG_KV_MAX_KEY_LEN
];

117 
keyËngth
;

119 
ušt32_t
 
nsid
;

121 
kv_™”©Ü_İtiÚ
 
™_İ
;

122 
kv_group_cÚd™iÚ
 
™_cÚd
;

126 
boŞ_t
 
has_fixed_keyËn
;

129 
ušt8_t
 
bufãr
[
ITERATOR_BUFFER_LEN
];

131 
boŞ_t
 
’d
;

134 
	#KVSSD_EMULATOR_PATH
 "/dev/kvemul"

	)

137 
KV_DEV_TYPE_NONE
 = 0,

138 
KV_DEV_TYPE_EMULATOR
 = 1,

139 
KV_DEV_TYPE_LINUX_KERNEL
 = 2

140 } 
	tkv_¿w_dev_ty³
;

142 #ifdeà
__ılu¥lus


	@PDK/core/src/device_abstract_layer/include/private/kvs_utils.h

34 #iâdeà
INCLUDE_KVS_UTILS_H_


35 
	#INCLUDE_KVS_UTILS_H_


	)

37 
	~<®gÜ™hm
>

38 
	~<¡dio.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dlib.h
>

41 
	~<io¡»am
>

42 
	~<s¡»am
>

43 
	~<f¡»am
>

44 
	~<mu‹x
>

45 
	~<dœ’t.h
>

46 
	~<uni¡d.h
>

48 
šlše
 
	$y´štf
(
¡d
::
o¡»am
 &
¡»am
, cÚ¡ * 
fmt
, ...)

50 
bufãr
[1024] = "";

52 
va_li¡
 
¬g±r
;

53 
wr™‹n
 = 0;

54 
	`va_¡¬t
(
¬g±r
,
fmt
);

57 
wr™‹n
 = 
	`v¥rštf
(
bufãr
, 
fmt
, 
¬g±r
);

60 
	`va_’d
(
¬g±r
);

61 
bufãr
[
wr™‹n
] = '\0';

62 
¡»am
 << 
bufãr
;

63 
	}
}

65 
šlše
 
	$log´štf
(cÚ¡ * 
fmt
, ...)

67 
¡d
::
mu‹x
 mutex;

68 
¡d
::
of¡»am
 
	`out
("/tmp/libkvadi.log", std::
ios
::
out
 | std::ios::
­p
);

70 ià(
out
.
	`is_İ’
()) {

71 
bufãr
[1024] = "";

73 
va_li¡
 
¬g±r
;

74 
wr™‹n
 = 0;

75 
	`va_¡¬t
(
¬g±r
,
fmt
);

77 
wr™‹n
 = 
	`v¥rštf
(
bufãr
, 
fmt
, 
¬g±r
);

79 
	`va_’d
(
¬g±r
);

80 
bufãr
[
wr™‹n
] = '\0';

82 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lck
(mutex);

83 
out
<< "[INFO] ";

84 
out
<< 
bufãr
;

85 
out
.
	`æush
();

88 
	`y´štf
(
¡d
::
cout
, "can't open /tmp/libkvadi.log\n");

90 
	}
}

92 
šlše
 
	$wr™e_”r
(cÚ¡ * 
fÜm©
, ... ) {

93 
va_li¡
 
¬gs
;

94 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

95 
	`årštf
(
¡d”r
, "[ERROR] ");

96 
	`vårštf
(
¡d”r
, 
fÜm©
, 
¬gs
);

97 
	`va_’d
(
¬gs
);

98 
	}
}

100 
šlše
 
	$wr™e_w¬n
(
FILE
 * 
out
, cÚ¡ * 
fÜm©
, ... ) {

101 
va_li¡
 
¬gs
;

102 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

103 
	`årštf
(
¡d”r
, "[WARN] ");

104 
	`vårštf
(
¡d”r
, 
fÜm©
, 
¬gs
);

105 
	`va_’d
(
¬gs
);

106 
	}
}

108 
šlše
 
	$wr™e_šfo
(
FILE
 * 
out
, cÚ¡ * 
fÜm©
, ... ) {

109 
va_li¡
 
¬gs
;

110 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

111 
	`årštf
(
¡d”r
, "[INFO] ");

112 
	`vårštf
(
¡d”r
, 
fÜm©
, 
¬gs
);

113 
	`va_’d
(
¬gs
);

114 
	}
}

117 #ifdeà
ENABLE_LOGGING


118 
	#WRITE_ERR
(...èdØ{ 
	`wr™e_”r
(
__VA_ARGS__
); 
	`ex™
(1); } 0)

	)

119 
	#WRITE_WARN
(...è
	`wr™e_w¬n
(
¡d”r
, 
__VA_ARGS__
)

	)

120 
	#WRITE_INFO
(...è
	`wr™e_šfo
(
¡dout
, 
__VA_ARGS__
)

	)

121 
	#WRITE_LOG
(...è
	`log´štf
(
__VA_ARGS__
)

	)

123 
	#WRITE_ERR
(...èdØ{ 
	`wr™e_”r
(
__VA_ARGS__
); 
	`ex™
(1); } 0)

	)

124 
	#WRITE_WARN
(...è
	`wr™e_w¬n
(
¡d”r
, 
__VA_ARGS__
)

	)

125 
	#WRITE_INFO
(...è
	`wr™e_šfo
(
¡dout
, 
__VA_ARGS__
)

	)

126 
	#WRITE_LOG
(...)

	)

131 
šlše
 
	$g‘_curıu
(*
ch
, *
cÜe
)

133 
a
,
d
,
c
;

134 
__asm__
 vŞ©e("rdtsı" : "÷" (
a
), "=d" (
d
), "=c" (
c
));

135 *
ch
 = (
c
 & 0xFFF000)>>12;

136 *
cÜe
 = 
c
 & 0xFFF;

137  (()
a
è| ((()
d
) << 32);;

138 
	}
}

141 
šlše
 
	$run_sh–lcmd
(cÚ¡ *
buf
)

143 
¡©us
 = 
	`sy¡em
(
buf
);

144  
	`WEXITSTATUS
(
¡©us
);

145 
	}
}

147 
šlše
 
	g¡d
::
¡ršg
 
	$run_sh–lcmd_w™h_ouut
(cÚ¡ *
cmd
) {

148 
FILE
 *
š
;

149 
¡d
::
¡ršg¡»am
 
ss
;

150 
buff
[512];

151 ià(!(
š
 = 
	`pİ’
(
cmd
, "r"))) {

155 
	`fg‘s
(
buff
, (buff), 
š
è!ğ
NULL
) {

156 
ss
 << 
buff
;

159 
	`pşo£
(
š
);

160  
ss
.
	`¡r
();

161 
	}
}

164 
šlše
 
	g¡d
::
¡ršg
 
	$do_»adlšk
(
¡d
::
¡ršg
 cÚ¡& 
·th
) {

165 
buff
[
PATH_MAX
];

166 
ssize_t
 
Ën
 = ::
	`»adlšk
(
·th
.
	`c_¡r
(), 
buff
, (buff) - 1);

167 ià(
Ën
 != -1) {

168 
buff
[
Ën
] = '\0';

169  
¡d
::
	`¡ršg
(
buff
);

173 
	}
}

179 
šlše
 
boŞ
 
	$is_dœeùÜy_em±y_Ü_nÙexi¡
(cÚ¡ *
·th
) {

180 
DIR
 *
dp
;

181 
i
 = 0;

182 
dœ’t
 *
•
;

183 
dp
 = 
	`İ’dœ
(
·th
);

185 ià(
dp
 !ğ
NULL
) {

186 (
•
 = 
	`»addœ
(
dp
)è!ğ
NULL
) {

187 
i
++;

188 ià(
i
 > 2)

189  
çl£
;

191 (è
	`şo£dœ
(
dp
);

194  
Œue
;

195 
	}
}

198 
šlše
 
	$Érim
(
¡d
::
¡ršg
 &
s
) {

199 
s
.
	`”a£
(s.
	`begš
(), 
¡d
::
	`fšd_if
(s.begš(), s.
	`’d
(), [](
ch
) {

200  !
¡d
::
	`is¥aû
(
ch
);

202 
	}
}

205 
šlše
 
	$¹rim
(
¡d
::
¡ršg
 &
s
) {

206 
s
.
	`”a£
(
¡d
::
	`fšd_if
(s.
	`rbegš
(), s.
	`»nd
(), [](
ch
) {

207  !
¡d
::
	`is¥aû
(
ch
);

208 }).
	`ba£
(), 
s
.
	`’d
());

209 
	}
}

212 
šlše
 
	$Œim
(
¡d
::
¡ršg
 &
s
) {

213 
	`Érim
(
s
);

214 
	`¹rim
(
s
);

215 
	}
}

	@PDK/core/src/device_abstract_layer/include/private/queue.hpp

34 #iâdeà
_NEW_QUEUE_INCLUDE_H_


35 
	#_NEW_QUEUE_INCLUDE_H_


	)

37 
	~<cÚd™iÚ_v¬ŸbË
>

38 
	~<th»ad
>

39 
	~<mu‹x
>

40 
	~<queue
>

41 
	~<©omic
>

42 
	~<mu‹x
>

43 
	~"kvs_adi.h
"

44 
	~"kvs_adi_š‹º®.h
"

46 
	~"io_cmd.hµ
"

47 
	~"th»ad_poŞ.hµ
"

48 
	~<boo¡/cœcuÏr_bufãr.hµ
>

49 
	~<li¡
>

51 
Çme¥aû
 
	gkvadi
 {

53 
şass
 
	gkv_deviû_š‹º®
;

55 şas 
	cioqueue
 {

56 
	g´Ùeùed
:

57 
kv_queue
 
quešfo
;

58 
kv_queue_¡©
 
	gque¡©
;

59 
kv_š‹¼u±_hªdËr
 
	gš‹¼u±_hªdËr
;

60 
	gpublic
:

61 
ioqueue
(cÚ¡ 
kv_queue
 *
quešfo_
) {

62 
this
->
quešfo
.
queue_id
 = 
quešfo_
->queue_id;

63 
	gthis
->
	gquešfo
.
	gqueue_size
 = 
quešfo_
->
queue_size
;

64 
	gthis
->
	gquešfo
.
	gcom¶‘iÚ_queue_id
 = 
quešfo_
->
com¶‘iÚ_queue_id
;

65 
	gthis
->
	gquešfo
.
	gqueue_ty³
 = 
quešfo_
->
queue_ty³
;

66 
	gthis
->
	gquešfo
.
	gex‹nded_šfo
 = 
quešfo_
->
ex‹nded_šfo
;

69 
	gvœtu®
 ~
ioqueue
() {}

70 
g‘_qid
(è{  
	gquešfo
.
	gqueue_id
; }

71 
g‘_ty³
(è{  
	gquešfo
.
	gqueue_ty³
; }

73 
vœtu®
 
kv_»suÉ
 
š™_š‹¼u±_hªdËr
(
kv_deviû_š‹º®
 *
dev
,cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
) = 0;

74 
kv_š‹¼u±_hªdËr
 
g‘_š‹¼u±_hªdËr
(è{  
	gthis
->
	gš‹¼u±_hªdËr
; }

76 
kv_»suÉ
 
kv_g‘_queue_šfo
(
kv_queue
 *
quešfo
) {

77 
	gquešfo
->
	gqueue_id
 = 
this
->
quešfo
.
queue_id
;

78 
	gquešfo
->
	gqueue_size
 = 
this
->
quešfo
.
queue_size
;

79 
	gquešfo
->
	gcom¶‘iÚ_queue_id
 = 
this
->
quešfo
.
com¶‘iÚ_queue_id
;

80 
	gquešfo
->
	gqueue_ty³
 = 
this
->
quešfo
.
queue_ty³
;

81 
	gquešfo
->
	gex‹nded_šfo
 = 
this
->
quešfo
.
ex‹nded_šfo
;

82  
	gKV_SUCCESS
;

85 
kv_»suÉ
 
kv_g‘_queue_¡©
(
kv_queue_¡©
 *
que_¡©
) {

86 
	gque_¡©
->
	gqueue_id
 = 
g‘_qid
();

87 
	gque_¡©
->
	gex‹nded_šfo
 = 0;

88  
	gKV_SUCCESS
;

91 
vœtu®
 
size_t
 
size
() = 0;

92 
vœtu®
 
kv_»suÉ
 
pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_com¶‘ed
è{  
	gKV_SUCCESS
; }

93 
vœtu®
 
‹rmš©e
() {}

97 şas 
	cemul_ioqueue
: 
public
 
ioqueue
 {

99 
¡d
::
mu‹x
 
li¡_mu‹x
;

100 
	g¡d
::
cÚd™iÚ_v¬ŸbË
 
cÚd_nÙem±y
;

101 
	g¡d
::
cÚd™iÚ_v¬ŸbË
 
cÚd_nÙfuÎ
;

103 
boŞ
 
	gshutdown
;

104 
emul_ioqueue
 *
	gout
;

105 
kv_deviû_­i
 *
	gkv¡Üe
;

106 
	gboo¡
::
cœcuÏr_bufãr
<
io_cmd
*> 
queue
;

107 
th»ad_poŞ
 
	gth»ads
;

108 
	gpublic
:

110 
emul_ioqueue
(cÚ¡ 
kv_queue
 *
quešfo_
, 
kv_deviû_š‹º®
 *
dev
,ƒmul_ioqueu*
out_
 = 0);

111 
	gvœtu®
 ~
emul_ioqueue
(è{ 
‹rmš©e
(); }

113 
kv_»suÉ
 
’queue
 (
io_cmd
 *
cmd
, 
boŞ
 
block
 = 
Œue
);

114 
kv_»suÉ
 
dequeue
(
io_cmd
 **
cmd
, 
boŞ
 
block
 = 
Œue
, 
ušt32_t
 
timeout_u£c
 = 0);

115 
boŞ
 
em±y
();

116 
size_t
 
size
(è
	gov”ride
;

118 
g‘_cqid
() {

119 ià(
	gout
 == 0)  0;

120  
	gout
->
g‘_qid
();

123 
‹rmš©e
() {

126 
	g¡d
::
unique_lock
<
¡d
::
mu‹x
> 
lock
(
li¡_mu‹x
);

127 
	gshutdown
 = 
Œue
;

128 
	gcÚd_nÙem±y
.
nÙify_®l
();

129 
	gcÚd_nÙfuÎ
.
nÙify_®l
();

131 
	gth»ads
.
još
();

133 !
	gqueue
.
em±y
()){

134 
d–‘e
 
	gthis
->
	gqueue
.
äÚt
();

135 
	gthis
->
	gqueue
.
pİ_äÚt
();

139 
šlše
 
boŞ
 
Ãed_shutdown
(è{  
	gshutdown
; }

140 
emul_ioqueue
 *
g‘_out_queue
(è{  
	gout
; }

141 
kv_»suÉ
 
pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_com¶‘ed
è
	gov”ride
;

142 
kv_»suÉ
 
š™_š‹¼u±_hªdËr
(
kv_deviû_š‹º®
 *
dev
,cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
è
	gov”ride
;

145 şas 
	ck”Ãl_ioqueue
: 
public
 
ioqueue


147 
maxd•th
;

148 
	g¡d
::
©omic
<> 
curd•th
;

149 
kv_deviû_­i
 *
	gkv¡Üe
;

150 
	gpublic
:

151 
k”Ãl_ioqueue
(cÚ¡ 
kv_queue
 *
quešfo_
 ,
kv_deviû_š‹º®
 *
dev
);

152 
	gvœtu®
 ~
k”Ãl_ioqueue
() {}

154 
šü—£_qd•th
() {

155 
	gcurd•th
++;

158 
deü—£_qd•th
(
n
) {

159 
	gcurd•th
 -ğ
n
;

162 
boŞ
 
fuÎ
() {

163  (
	gcurd•th
.
lßd
(è>ğ
maxd•th
);

165 
size_t
 
size
(è
	gov”ride
 {  
	gcurd•th
.
lßd
(); }

167 
kv_»suÉ
 
š™_š‹¼u±_hªdËr
(
kv_deviû_š‹º®
 *
dev
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
)

169 
	gthis
->
	gš‹¼u±_hªdËr
 = 
št_hdl
;

170  
	gKV_SUCCESS
;

173 
kv_»suÉ
 
pŞl_com¶‘iÚ
(
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_com¶‘ed
);

	@PDK/core/src/device_abstract_layer/include/private/thread_pool.hpp

34 #iâdeà
_THREAD_POOL_INCLUDE_H_


35 
	#_THREAD_POOL_INCLUDE_H_


	)

37 
	~<th»ad
>

38 
	~<mu‹x
>

39 
	~<veùÜ
>

40 
	~<cÚd™iÚ_v¬ŸbË
>

42 
	~"io_cmd.hµ
"

44 
Çme¥aû
 
	gkvadi
 {

47 şas 
	cth»ad_poŞ
 {

48 
	gpublic
:

49 
th»ad_poŞ
();

52 
th»ad_poŞ
(
ušt32_t
 
devid
, ušt32_ˆ
th»ad_couÁ_³r_sq
, ušt32_ˆ
th»ad_couÁ_³r_cq
);

55 
£t_devid
(
št32_t
 
devid
);

60 
kv_»suÉ
 
ü—‹_subm™_th»ads
((*
func
)(*), *
que
, 
num_th»ads
);

61 
kv_»suÉ
 
ü—‹_š‹¼u±_th»ads
((*
func
)(*), *
que
, 
num_th»ads
);

70 
još
();

72 ~
th»ad_poŞ
();

74 
	g´iv©e
:

75 
ušt32_t
 
m_devid
;

78 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
m_th»ads
;

81 
ušt32_t
 
	gm_th»ad_couÁ_³r_sq
;

82 
ušt32_t
 
	gm_th»ad_couÁ_³r_cq
;

84 
	g¡d
::
mu‹x
 
m_mu‹x
;

	@PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi.cpp

5 
	~<±h»ad.h
>

6 
	~<”ºo.h
>

7 
	~<¡ršg.h
>

8 
	~<sys/ioùl.h
>

9 
	~<sys/ty³s.h
>

10 
	~<sys/¡©.h
>

11 
	~<sys/ev’tfd.h
>

12 
	~<sys/£Ëù.h
>

13 
	~<sys/•Şl.h
>

14 
	~<sys/time.h
>

15 
	~<fú.h
>

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<as£¹.h
>

19 
	~<”ºo.h
>

20 
	~<uni¡d.h
>

21 
	~<lim™s.h
>

22 
	~<m©h.h
>

23 
	~<time.h
>

24 
	~<veùÜ
>

25 
	~"kadi.h
"

26 
	~"lšux_nvme_ioùl.h
"

27 
	~"kadi_debug.h
"

32 #ifdeà
EPOLL_DEV


33 
	gEpŞlFD_dev
;

34 
•Şl_ev’t
 
	gw©ch_ev’ts
;

35 
•Şl_ev’t
 
	gli¡_of_ev’ts
[1];

38 
kv_»suÉ
 
	gKADI
::
™”_»ad®l
(
kv_™”_cÚ‹xt
 *
™”_ùx
, 
¡d
::
li¡
<¡d::
·œ
<*, >> &
buæi¡
)

40 
kv_»suÉ
 
	gr
 = 
™”_İ’
(
™”_ùx
);

41 ià(
	gr
 != 0)

42  
r
;

43 !
	g™”_ùx
->
	g’d
)

45 
	g™”_ùx
->
	gby‹swr™‹n
 = 0;

46 
	g™”_ùx
->
	gbuf
 = 
ÿÎoc
(1, 
™”_ùx
->
buæ’
);

47 
™”_»ad
(
™”_ùx
);

49 ià(
	g™”_ùx
->
	gby‹swr™‹n
 > 0)

51 
	gbuæi¡
.
push_back
(
¡d
::
make_·œ
(
™”_ùx
->
buf
, i‹r_ùx->
by‹swr™‹n
));

54 
	gr
 = 
™”_şo£
(
™”_ùx
);

55  
	gr
;

58 
	gKADI
::
	$İ’
(
¡d
::
¡ršg
 &
dev·th
)

61 
FTRACE


62 
»t
 = 0;

63 
fd
 = ::
	`İ’
(
dev·th
.
	`c_¡r
(), 
O_RDWR
);

64 ià(
fd
 < 0)

66 
¡d
::
û¼
 << "ÿn'ˆİ’‡ deviû : " << 
dev·th
 << std::
’dl
;

67  
fd
;

70 
nsid
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_ID
);

71 ià(
nsid
 == ()-1)

73 
¡d
::
û¼
 << "ÿn'ˆg‘‡ÀID" << std::
’dl
;

77 
¥aû_id
 = 0;

79 
i
 = 0; i < 
qd•th
; i++)

81 
aio_cmd_ùx
 *
ùx
 = (aio_cmd_ùx *)
	`ÿÎoc
(1, (aio_cmd_ctx));

82 
ùx
->
šdex
 = 
i
;

83 
ä“_cmdùxs
.
	`push_back
(
ùx
);

85 #ifdeà
EPOLL_DEV


86 
EpŞlFD_dev
 = 
	`•Şl_ü—‹
(1024);

87 ià(
EpŞlFD_dev
 < 0)

89 
¡d
::
û¼
 << "UÇbËØü—‹ EpŞÈFD;ƒ¼Ü = " << 
EpŞlFD_dev
 << std::
’dl
;

94 
efd
 = 
	`ev’tfd
(0, 0);

95 ià(
efd
 < 0)

97 
¡d
::
û¼
 << "çØü—‹‡Àev’t." << std::
’dl
;

98 #ifdeà
EPOLL_DEV


99 ::
	`şo£
(
EpŞlFD_dev
);

104 #ifdeà
EPOLL_DEV


105 
w©ch_ev’ts
.
ev’ts
 = 
EPOLLIN
;

106 
w©ch_ev’ts
.
d©a
.
fd
 = 
efd
;

107 
»gi¡”_ev’t
;

108 
»gi¡”_ev’t
 = 
	`•Şl_ùl
(
EpŞlFD_dev
, 
EPOLL_CTL_ADD
, 
efd
, &
w©ch_ev’ts
);

109 ià(
»gi¡”_ev’t
)

110 
¡d
::
û¼
 << " FaedØadd FD = " << 
efd
 << ",Ø•ŞÈFD = " << 
EpŞlFD_dev


111 << ", w™hƒ¼Ü cod = " << 
»gi¡”_ev’t
 << 
¡d
::
’dl
;

114 
aioùx
.
ùxid
 = 0;

115 
aioùx
.
ev’tfd
 = 
efd
;

117 ià(
	`ioùl
(
fd
, 
NVME_IOCTL_SET_AIOCTX
, &
aioùx
) < 0)

119 
¡d
::
û¼
 << "çØ£t_aioùx" << std::
’dl
;

125  
»t
;

126 
	}
}

129 *
	gKDTh»ad
::
	$_’Œy_func
(*
¬g
) {

130  ((
KDTh»ad
*)
¬g
)->
	`’Œy
();

131 
	}
}

133 *
	gKDTh»ad
::
	$’Œy
() {

134 
ušt32_t
 
num_ev’ts
 = 2048;

135 !
¡İ_
) {

136 
dev
->
	`pŞl_com¶‘iÚ
(
num_ev’ts
, 500000);

139 
	}
}

142 
	gKADI
::
	$¡¬t_cbth»ad
() {

143 ià(!
this
->
cb_th»ad
.
¡¬‹d
)

144 
this
->
cb_th»ad
.
	`¡¬t
();

146 
	}
}

148 
	gKADI
::
	$şo£
()

150 ià(
fd
 > 0)

152 
this
->
cb_th»ad
.
	`¡İ
();

154 
aio_cmd_ùx
 *
p
: 
ä“_cmdùxs
) {

155 
	`ä“
((*)
p
);

158 
	`ioùl
(
fd
, 
NVME_IOCTL_DEL_AIOCTX
, &
aioùx
);

159 ::
	`şo£
(()
aioùx
.
ev’tfd
);

160 ::
	`şo£
(
fd
);

161 
¡d
::
û¼
 << "KV deviû i şo£d: fd " << 
fd
 << std::
’dl
;

162 
fd
 = -1;

164 #ifdeà
EPOLL_DEV


165 ::
	`şo£
(
EpŞlFD_dev
);

169 
	}
}

171 
	gKADI
::
aio_cmd_ùx
 *
KADI
::
	$g‘_cmd_ùx
(cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
)

173 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
cmdùx_lock
);

175 
ä“_cmdùxs
.
	`em±y
())

177 ià(
cmdùx_cÚd
.
	`wa™_fÜ
(
lock
, 
¡d
::
chrÚo
::
	`£cÚds
(5)è=ğ¡d::
cv_¡©us
::
timeout
)

179 
¡d
::
û¼
 << "max queud•th ha »ached. wa™..." << std::
’dl
;

183 
aio_cmd_ùx
 *
p
 = 
ä“_cmdùxs
.
	`back
();

184 
ä“_cmdùxs
.
	`pİ_back
();

186 
p
->
po¡_â
 = 
cb
->post_fn;

187 
p
->
po¡_d©a
 = 
cb
->
´iv©e_d©a
;

188 
³ndšg_cmdùxs
.
	`š£¹
(
¡d
::
	`make_·œ
(
p
->
šdex
,…));

189  
p
;

190 
	}
}

192 
	gKADI
::
	$»Ëa£_cmd_ùx
(
aio_cmd_ùx
 *
p
)

194 
¡d
::
lock_gu¬d
<¡d::
mu‹x
> 
	`lock
(
cmdùx_lock
);

196 
³ndšg_cmdùxs
.
	`”a£
(
p
->
šdex
);

197 
ä“_cmdùxs
.
	`push_back
(
p
);

198 
cmdùx_cÚd
.
	`nÙify_Úe
();

199 
	}
}

201 
kv_»suÉ
 
	gKADI
::
	$™”_İ’
(
kv_™”_cÚ‹xt
 *
™”_hªdË
)

203 
nvme_·s¡hru_kv_cmd
 
cmd
;

204 
	`mem£t
(&
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

206 
cmd
.
İcode
 = 
nvme_cmd_kv_™”_»q
;

207 
cmd
.
cdw3
 = 
¥aû_id
;

208 
cmd
.
nsid
 =‚sid;

209 
cmd
.
cdw4
 = (
ITER_OPTION_OPEN
 | 
ITER_OPTION_KEY_ONLY
);

210 
cmd
.
cdw12
 = 
™”_hªdË
->
´efix
;

211 
cmd
.
cdw13
 = 
™”_hªdË
->
b™mask
;

212 #ifdeà
DUMP_ISSUE_CMD


213 
	`dump_cmd
(&
cmd
);

215 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_IO_KV_CMD
, &
cmd
);

216 ià(
»t
 < 0)

221 
™”_hªdË
->
hªdË
 = 
cmd
.
»suÉ
 & 0xff;

222 
™”_hªdË
->
’d
 = 
çl£
;

224  
cmd
.
¡©us
;

225 
	}
}

227 
kv_»suÉ
 
	gKADI
::
	$™”_şo£
(
kv_™”_cÚ‹xt
 *
™”_hªdË
)

229 
nvme_·s¡hru_kv_cmd
 
cmd
;

230 
	`mem£t
(&
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

231 
cmd
.
İcode
 = 
nvme_cmd_kv_™”_»q
;

232 
cmd
.
cdw3
 = 
¥aû_id
;

233 
cmd
.
nsid
 =‚sid;

234 
cmd
.
cdw4
 = 
ITER_OPTION_CLOSE
;

235 
cmd
.
cdw5
 = 
™”_hªdË
->
hªdË
;

236 #ifdeà
DUMP_ISSUE_CMD


237 
	`dump_cmd
(&
cmd
);

239 ià(
	`ioùl
(
fd
, 
NVME_IOCTL_IO_KV_CMD
, &
cmd
) < 0)

243  
cmd
.
¡©us
;

244 
	}
}

247 
kv_»suÉ
 
	gKADI
::
	$™”_»ad_async
(
kv_™”_cÚ‹xt
 *
™”_hªdË
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
)

249 
aio_cmd_ùx
 *
ioùx
 = 
	`g‘_cmd_ùx
(
cb
);

250 
	`mem£t
((*)&
ioùx
->
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

251 
ioùx
->
buf
 = 
™”_hªdË
->buf;

252 
ioùx
->
cmd
.
İcode
 = 
nvme_cmd_kv_™”_»ad
;

253 
ioùx
->
cmd
.
nsid
 =‚sid;

254 
ioùx
->
cmd
.
cdw3
 = 
¥aû_id
;

255 
ioùx
->
cmd
.
cdw5
 = 
™”_hªdË
->
hªdË
;

256 
ioùx
->
cmd
.
d©a_addr
 = (
__u64
)
™”_hªdË
->
buf
;

257 
ioùx
->
cmd
.
d©a_Ëngth
 = 
™”_hªdË
->
buæ’
;

258 
ioùx
->
cmd
.
ùxid
 = 
aioùx
.ctxid;

259 
ioùx
->
cmd
.
»qid
 = ioùx->
šdex
;

261 #ifdeà
DUMP_ISSUE_CMD


262 
	`dump_cmd
(&
cmd
);

264 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_AIO_CMD
, &
ioùx
->
cmd
);

265 ià(
»t
 < 0)

267 
	`»Ëa£_cmd_ùx
(
ioùx
);

271  
»t
;

272 
	}
}

274 
kv_»suÉ
 
	gKADI
::
	$™”_»ad
(
kv_™”_cÚ‹xt
 *
™”_hªdË
)

276 
nvme_·s¡hru_kv_cmd
 
cmd
;

277 
	`mem£t
(&
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

279 
cmd
.
İcode
 = 
nvme_cmd_kv_™”_»ad
;

280 
cmd
.
nsid
 =‚sid;

281 
cmd
.
cdw3
 = 
¥aû_id
;

282 
cmd
.
cdw5
 = 
™”_hªdË
->
hªdË
;

283 
cmd
.
d©a_addr
 = (
__u64
)
™”_hªdË
->
buf
;

284 
cmd
.
d©a_Ëngth
 = 
™”_hªdË
->
buæ’
;

285 #ifdeà
DUMP_ISSUE_CMD


286 
	`dump_cmd
(&
cmd
);

288 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_IO_KV_CMD
, &
cmd
);

289 ià(
»t
 < 0)

294 
™”_hªdË
->
by‹swr™‹n
 = 
cmd
.
»suÉ
 & 0xffff;

295 ià(
™”_hªdË
->
by‹swr™‹n
 > i‹r_hªdË->
buæ’
)

297 
¡d
::
û¼
 << " # oà»ad by‹ > bufã¸Ëngth" << std::
’dl
;

301 ià(
cmd
.
¡©us
 == 0x0393)

303 
™”_hªdË
->
’d
 = 
Œue
;

306 
™”_hªdË
->
’d
 = 
çl£
;

308 #ifdeà
DUMP_ISSUE_CMD


309 
¡d
::
û¼
 << "™”©Ü: stu ğ" << 
cmd
.
¡©us
 << ",„esuÉ = " << cmd.
»suÉ
 << ",ƒnd = " << 
™”_hªdË
->
’d
 << ", by‹ »ad = " << i‹r_hªdË->
by‹swr™‹n
 << std::
’dl
;

312  
cmd
.
¡©us
;

313 
	}
}

315 
kv_»suÉ
 
	gKADI
::
	$™”_li¡
(
kv_™”©Ü
 *
™”_li¡
, 
ušt32_t
 *
couÁ
)

317 cÚ¡ 
MAX_LOG_PAGE_SIZE
 = 512;

318 cÚ¡ 
ušt32_t
 
log_·ge_id
 = 0xd0;

319 cÚ¡ 
hªdË_šfo_size
 = 16;

321 
logbuf
[
MAX_LOG_PAGE_SIZE
];

322 
nvme_·s¡hru_cmd
 
cmd
;

324 ià(*
couÁ
 =ğ0è{  
KV_ERR_BUFFER_SMALL
; }

326 
	`mem£t
(
logbuf
, 0, 
MAX_LOG_PAGE_SIZE
);

327 
	`mem£t
(&
cmd
, 0, (
nvme_·s¡hru_cmd
));

329 
ušt32_t
 
bufãr_size
 = 
MAX_LOG_PAGE_SIZE
;

330 
cmd
.
İcode
 = 0x02;

331 
cmd
.
addr
 = (
ušt64_t
)
logbuf
;

332 
cmd
.
d©a_Ën
 = 
bufãr_size
;

333 
cmd
.
nsid
 =‚sid;

334 
cmd
.
cdw10
 = (
__u32
)(((
bufãr_size
 >> 2è- 1è<< 16è| ((__u32)
log_·ge_id
 & 0x000000ff);

336 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_ADMIN_CMD
, &
cmd
);

337 ià(
»t
 !ğ0è{  
KV_ERR_SYS_IO
; }

342 
ušt32_t
 
İ’_couÁ
 = 0;

343 
ušt32_t
 
off£t
 = 0;

344 
ušt32_t
 
max
 = 
¡d
::
	`mš
((ušt32_t)
SAMSUNG_MAX_ITERATORS
, *
couÁ
);

346 
ušt32_t
 
i
 = 0; i < 
max
; i++)

348 
off£t
 = (
i
 * 
hªdË_šfo_size
);

349 
ušt8_t
 
¡©us
 = (*(ušt8_ˆ*)(
logbuf
 + 
off£t
 + 1));

350 
™”_li¡
[
İ’_couÁ
].
¡©us
 = status;

351 
™”_li¡
[
İ’_couÁ
].
hªdË_id
 = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 0));

352 
™”_li¡
[
İ’_couÁ
].
ty³
 = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 2)) -1;

353 
™”_li¡
[
İ’_couÁ
].
key¥aû_id
 = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 3));

354 
™”_li¡
[
İ’_couÁ
].
´efix
 = (*(
ušt32_t
 *)(
logbuf
 + 
off£t
 + 4));

355 
™”_li¡
[
İ’_couÁ
].
b™mask
 = (*(
ušt32_t
 *)(
logbuf
 + 
off£t
 + 8));

356 
™”_li¡
[
İ’_couÁ
].
is_eof
 = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 12));

357 
™”_li¡
[
İ’_couÁ
].
»£rved
[0] = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 13));

358 
™”_li¡
[
İ’_couÁ
].
»£rved
[1] = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 14));

359 
™”_li¡
[
İ’_couÁ
].
»£rved
[2] = (*(
ušt8_t
 *)(
logbuf
 + 
off£t
 + 15));

362 
İ’_couÁ
++;

364 *
couÁ
 = 
İ’_couÁ
;

366  
KV_SUCCESS
;

367 
	}
}

369 
	g™”buf_»ad”
::
	$™”buf_»ad”
(
C•hCÚ‹xt
 *
c
, *
buf_
, 
Ëngth_
, 
KADI
 *
db_
, 
KvsStÜe
 *
¡Üe_
è: 
	`cù
(c), 
	`buf
(buf_), 
	`bufoff£t
(0), 
	`by‹swr™‹n
Ö’gth_), 
	`numkeys
(0), 
	`db
(db_), 
	$¡Üe
(
¡Üe_
)

371 ià(
	`ha¢ext
())

373 
numkeys
 = *((*)
buf
);

374 
bufoff£t
 += 4;

376 
	}
}

378 
boŞ
 
	g™”buf_»ad”
::
	$Ãxtkey
(**
key
, *
Ëngth
)

380 
»do
:

381 
aá”Keyg­
 = 0;

382 *
cu¼’t_pos
 = ((*)
buf
);

384 ià(
bufoff£t
 + 4 >ğ
by‹swr™‹n
)

385  
çl£
;

387 *
Ëngth
 = *((*)(
cu¼’t_pos
 + 
bufoff£t
));

388 
bufoff£t
 += 4;

390 ià(
bufoff£t
 + *
Ëngth
 > 
by‹swr™‹n
)

391  
çl£
;

393 *
key
 = (
cu¼’t_pos
 + 
bufoff£t
);

394 
aá”Keyg­
 = (((*
Ëngth
 + 3) >> 2) << 2);

395 
bufoff£t
 +ğ
aá”Keyg­
;

397 ià(
db
 && !db->
	`exi¡
(*
key
, *
Ëngth
))

399 
»do
;

402  
Œue
;

403 
	}
}

405 
ušt32_t
 
	gKADI
::
	$g‘_dev_waf
()

407 cÚ¡ 
MAX_LOG_PAGE_SIZE
 = 512;

408 cÚ¡ 
ušt32_t
 
log_·ge_id
 = 0xC0;

410 
logbuf
[
MAX_LOG_PAGE_SIZE
];

411 
nvme_·s¡hru_cmd
 
cmd
;

412 
ušt32_t
 
bufãr_size
 = 
MAX_LOG_PAGE_SIZE
;

414 
	`mem£t
(
logbuf
, 0, 
MAX_LOG_PAGE_SIZE
);

415 
	`mem£t
(&
cmd
, 0, (
nvme_·s¡hru_cmd
));

417 
cmd
.
İcode
 = 0x2;

418 
cmd
.
nsid
 =‚sid;

419 
cmd
.
addr
 = (
ušt64_t
)
logbuf
;

420 
cmd
.
d©a_Ën
 = 
bufãr_size
;

422 
cmd
.
cdw10
 = (
__u32
)(((
bufãr_size
 >> 2è- 1è<< 16è| ((__u32)
log_·ge_id
 & 0x000000ff);

424 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_ADMIN_CMD
, &
cmd
);

425 ià(
»t
 != 0) {

426  
KV_ERR_SYS_IO
;

429 
ušt32_t
 
waf
 = *(ušt32_t*)
logbuf
;

431  
waf
;

433 
	}
}

435 
kv_»suÉ
 
	gKADI
::
	$kv_¡Üe
(
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
, 
İtiÚ
)

437 
aio_cmd_ùx
 *
ioùx
 = 
	`g‘_cmd_ùx
(
cb
);

438 
	`mem£t
((*)&
ioùx
->
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

440 ià(
key
 =ğ0 || key->key =ğ0 || 
v®ue
 == 0 || value->value == 0)

442  
KADI_ERR_NULL_INPUT
;

445 
ioùx
->
key
 = key;

446 
ioùx
->
v®ue
 = value;

448 
ioùx
->
cmd
.
İcode
 = 
nvme_cmd_kv_¡Üe
;

449 
ioùx
->
cmd
.
nsid
 =‚sid;

451 ià(
key
->
Ëngth
 > 
KVCMD_INLINE_KEY_MAX
)

453 
ioùx
->
cmd
.
key_addr
 = (
__u64
)
key
->key;

457 
	`memıy
((*)
ioùx
->
cmd
.
key
, (*)key->key, key->
Ëngth
);

459 
ioùx
->
cmd
.
cdw4
 = 
İtiÚ
;

460 
ioùx
->
cmd
.
cdw5
 = 
v®ue
->
off£t
;

461 
ioùx
->
cmd
.
key_Ëngth
 = 
key
->
Ëngth
;

462 
ioùx
->
cmd
.
cdw11
 = 
key
->
Ëngth
 - 1;

463 
ioùx
->
cmd
.
d©a_addr
 = (
__u64
)
v®ue
->value;

464 
ioùx
->
cmd
.
d©a_Ëngth
 = 
v®ue
->
Ëngth
;

465 
ioùx
->
cmd
.
cdw10
 = (
v®ue
->
Ëngth
 >> 2);

466 
ioùx
->
cmd
.
ùxid
 = 
aioùx
.ctxid;

467 
ioùx
->
cmd
.
»qid
 = ioùx->
šdex
;

469 #ifdeà
DUMP_ISSUE_CMD


471 
¡d
::
û¼
 << "IO:kv_¡Üe: key = " << 
	`´št_key
((cÚ¡ *)
key
->key, key->
Ëngth
è<< ",†’ = " << ()key->Ëngth << std::
’dl
;

474 
»t
;

475 ià((
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_AIO_CMD
, &
ioùx
->
cmd
)) < 0)

477 
	`»Ëa£_cmd_ùx
(
ioùx
);

482 
	}
}

484 
kv_»suÉ
 
	gKADI
::
	$kv_»Œ›ve
(
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
)

486 
aio_cmd_ùx
 *
ioùx
 = 
	`g‘_cmd_ùx
(
cb
);

487 
	`mem£t
((*)&
ioùx
->
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

489 ià(
key
 =ğ0 || key->key =ğ0 || 
v®ue
 == 0 || value->value == 0)

491  
KADI_ERR_NULL_INPUT
;

494 
ioùx
->
key
 = key;

495 
ioùx
->
v®ue
 = value;

497 
ioùx
->
cmd
.
İcode
 = 
nvme_cmd_kv_»Œ›ve
;

498 
ioùx
->
cmd
.
nsid
 =‚sid;

499 
ioùx
->
cmd
.
cdw3
 = 
¥aû_id
;

500 
ioùx
->
cmd
.
cdw4
 = 0;

501 
ioùx
->
cmd
.
cdw5
 = 
v®ue
->
off£t
;

502 
ioùx
->
cmd
.
d©a_addr
 = (
__u64
)
v®ue
->value;

503 
ioùx
->
cmd
.
d©a_Ëngth
 = 
v®ue
->
Ëngth
;

504 ià(
key
->
Ëngth
 <ğ
KVCMD_INLINE_KEY_MAX
)

506 
	`memıy
((*)
ioùx
->
cmd
.
key
, (*)key->key, key->
Ëngth
);

510 
ioùx
->
cmd
.
key_addr
 = (
__u64
)
key
->key;

512 
ioùx
->
cmd
.
key_Ëngth
 = 
key
->
Ëngth
;

513 
ioùx
->
cmd
.
»qid
 = ioùx->
šdex
;

514 
ioùx
->
cmd
.
ùxid
 = 
aioùx
.ctxid;

516 #ifdeà
DUMP_ISSUE_CMD


517 
	`dump_»Œ›ve_cmd
(&
ioùx
->
cmd
);

518 
¡d
::
û¼
 << "IO:kv_»Œ›ve: key = " << 
	`´št_key
((cÚ¡ *)
key
->key, key->
Ëngth
è<< ",†’ = " << ()key->Ëngth << std::
’dl
;

520 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_AIO_CMD
, &
ioùx
->
cmd
);

521 ià(
»t
 < 0)

525 
	`»Ëa£_cmd_ùx
(
ioùx
);

526  
KADI_ERR_IO
;

529 
	}
}

531 
kv_»suÉ
 
	gKADI
::
	$kv_»Œ›ve_sync
(
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
)

533 
nvme_·s¡hru_kv_cmd
 
cmd
;

534 
	`mem£t
((*)&
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

536 ià(
key
 =ğ0 || key->key =ğ0 || 
v®ue
 == 0 || value->value == 0)

538  
KADI_ERR_NULL_INPUT
;

541 
cmd
.
İcode
 = 
nvme_cmd_kv_»Œ›ve
;

542 
cmd
.
nsid
 =‚sid;

543 
cmd
.
cdw3
 = 
¥aû_id
;

544 
cmd
.
cdw4
 = 0;

545 
cmd
.
cdw5
 = 
v®ue
->
off£t
;

546 
cmd
.
d©a_addr
 = (
__u64
)
v®ue
->value;

547 
cmd
.
d©a_Ëngth
 = 
v®ue
->
Ëngth
;

548 ià(
key
->
Ëngth
 <ğ
KVCMD_INLINE_KEY_MAX
)

554 
cmd
.
key_addr
 = (
__u64
)
key
->key;

556 
cmd
.
key_Ëngth
 = 
key
->
Ëngth
;

558 #ifdeà
DUMP_ISSUE_CMD


559 
	`dump_»Œ›ve_cmd
(&
cmd
);

560 
¡d
::
û¼
 << "IO:kv_»Œ›vsync: key = " << 
	`´št_key
((cÚ¡ *)
key
->key, key->
Ëngth
è<< ",†’ = " << ()key->Ëngth << std::
’dl
;

563 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_IO_KV_CMD
, &
cmd
);

564 ià(
»t
 == 0)

566 
v®ue
->
aùu®_v®ue_size
 = 
cmd
.
»suÉ
;

567 
v®ue
->
Ëngth
 = 
¡d
::
	`mš
(
cmd
.
»suÉ
, value->length);

570  
»t
;

571 
	}
}

573 
kv_»suÉ
 
	gKADI
::
	$upd©e_ÿ·c™y
()

575 
ušt64_t
 
by‹su£d
, 
ÿ·c™y
;

576 
utiz©iÚ
;

577 
r
 = 
	`g‘_ä“¥aû
(
by‹su£d
, 
ÿ·c™y
, 
utiz©iÚ
);

578 ià(
r
 != 0)

582 
this
->
ÿ·c™y
 = capacity;

583  
r
;

584 
	}
}

586 
kv_»suÉ
 
	gKADI
::
	$g‘_ä“¥aû
(
ušt64_t
 &
by‹su£d
, ušt64_ˆ&
ÿ·c™y
, &
utiz©iÚ
)

588 *
d©a
 = (*)
	`ÿÎoc
(1, 4096);

589 
nvme_·s¡hru_cmd
 
cmd
;

590 
	`mem£t
(&
cmd
, 0, (
nvme_·s¡hru_cmd
));

591 
cmd
.
İcode
 = 0x6;

592 
cmd
.
nsid
 =‚sid;

593 
cmd
.
addr
 = (
__u64
)
d©a
;

594 
cmd
.
d©a_Ën
 = 4096;

595 
cmd
.
cdw10
 = 0;

597 ià(
	`ioùl
(
fd
, 
NVME_IOCTL_ADMIN_CMD
, &
cmd
) < 0)

599 ià(
d©a
)

600 
	`ä“
(
d©a
);

604 cÚ¡ 
__u64
 
£ùÜsu£d
 = *((__u64 *)
d©a
);

605 cÚ¡ 
__u64
 
Çme¥aû_utiz©iÚ
 = *((__u64 *)&
d©a
[16]);

607 
utiz©iÚ
 = (1.0 * 
Çme¥aû_utiz©iÚ
 / 10000.0);

608 
ÿ·c™y
 = 
£ùÜsu£d
 * 512;

609 
by‹su£d
 = 
utiz©iÚ
 * 
ÿ·c™y
;

611 ià(
d©a
)

612 
	`ä“
(
d©a
);

614 
	}
}

616 
boŞ
 
	gKADI
::
	$exi¡
(*
key
, 
Ëngth
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
)

618 
»t
 = 0;

619 
aio_cmd_ùx
 *
ioùx
 = 
	`g‘_cmd_ùx
(
cb
);

620 
	`mem£t
((*)&
ioùx
->
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

621 
ioùx
->
cmd
.
İcode
 = 
nvme_cmd_kv_exi¡
;

622 
ioùx
->
cmd
.
nsid
 =‚sid;

623 
ioùx
->
cmd
.
cdw3
 = 
¥aû_id
;

624 
ioùx
->
cmd
.
key_Ëngth
 = 
Ëngth
;

625 ià(
Ëngth
 > 
KVCMD_INLINE_KEY_MAX
)

627 
ioùx
->
cmd
.
key_addr
 = (
__u64
)
key
;

631 
	`memıy
((*)
ioùx
->
cmd
.
key
, key, 
Ëngth
);

633 
ioùx
->
cmd
.
ùxid
 = 
aioùx
.ctxid;

634 
ioùx
->
cmd
.
»qid
 = ioùx->
šdex
;

636 #ifdeà
DUMP_ISSUE_CMD


637 
	`dump_cmd
(&
cmd
);

639 ià(
cb
 == 0) {

640 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_IO_KV_CMD
, &
ioùx
->
cmd
);

643 
»t
 = 
	`ioùl
(
fd
, 
NVME_IOCTL_AIO_CMD
, &
ioùx
->
cmd
);

645  (
»t
 =ğ0è? 
Œue
 : 
çl£
;

646 
	}
}

648 
boŞ
 
	gKADI
::
	$exi¡
(
kv_key
 *
key
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
)

650  
	`exi¡
((*)
key
->key, key->
Ëngth
, 
cb
);

651 
	}
}

653 
kv_»suÉ
 
	gKADI
::
	$kv_d–‘e
(
kv_key
 *
key
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
, 
check_exi¡
)

655 
aio_cmd_ùx
 *
ioùx
 = 
	`g‘_cmd_ùx
(
cb
);

656 
	`mem£t
((*)&
ioùx
->
cmd
, 0, (
nvme_·s¡hru_kv_cmd
));

658 ià(
key
 == 0 || key->key == 0)

660  
KADI_ERR_NULL_INPUT
;

662 
ioùx
->
key
 = key;

663 
ioùx
->
v®ue
 = 0;

665 
ioùx
->
cmd
.
İcode
 = 
nvme_cmd_kv_d–‘e
;

666 
ioùx
->
cmd
.
nsid
 =‚sid;

667 
ioùx
->
cmd
.
cdw3
 = 
¥aû_id
;

668 
ioùx
->
cmd
.
cdw4
 = 
check_exi¡
;

669 ià(
key
->
Ëngth
 <ğ
KVCMD_INLINE_KEY_MAX
)

671 
	`memıy
((*)
ioùx
->
cmd
.
key
, (*)key->key, key->
Ëngth
);

675 
ioùx
->
cmd
.
key_addr
 = (
__u64
)
key
->key;

677 
ioùx
->
cmd
.
key_Ëngth
 = 
key
->
Ëngth
;

678 
ioùx
->
cmd
.
»qid
 = ioùx->
šdex
;

679 
ioùx
->
cmd
.
ùxid
 = 
aioùx
.ctxid;

681 #ifdeà
DUMP_ISSUE_CMD


682 
	`dump_d–‘e_cmd
(&
ioùx
->
cmd
);

683 
¡d
::
û¼
 << "IO:kv_d–‘e: key = " << 
	`´št_key
((cÚ¡ *)
key
->key, key->
Ëngth
è<< ",†’ = " << ()key->Ëngth << std::
’dl
;

686 ià(
	`ioùl
(
fd
, 
NVME_IOCTL_AIO_CMD
, &
ioùx
->
cmd
) < 0)

688 
	`»Ëa£_cmd_ùx
(
ioùx
);

689  
KADI_ERR_IO
;

693 
	}
}

695 
kv_»suÉ
 
	gKADI
::
	$pŞl_com¶‘iÚ
(
ušt32_t
 &
num_ev’ts
, ušt32_ˆ
timeout_us
)

698 
	`FD_ZERO
(&
rfds
);

700 #ifdeà
EPOLL_DEV


701 
timeout
 = 
timeout_us
 / 1000;

702 
Ä_chªged_fds
 = 
	`•Şl_wa™
(
EpŞlFD_dev
, 
li¡_of_ev’ts
, 1, 
timeout
);

703 ià(
Ä_chªged_fds
 == 0 ||‚r_changed_fds < 0)

705 
num_ev’ts
 = 0;

709 
	`FD_SET
(
aioùx
.
ev’tfd
, &
rfds
);

711 
	`mem£t
(&
timeout
, 0, (timeout));

712 
timeout
.
tv_u£c
 = 
timeout_us
;

713 
Ä_chªged_fds
 = 
	`£Ëù
(
aioùx
.
ev’tfd
 + 1, &
rfds
, 
NULL
, NULL, &
timeout
);

715 ià(
Ä_chªged_fds
 == 0 ||‚r_changed_fds < 0)

717 
num_ev’ts
 = 0;

722 
eád_ùx
 = 0;

723 
»ad_s
 = 
	`»ad
(
aioùx
.
ev’tfd
, &
eád_ùx
, ());

725 ià(
»ad_s
 != ())

727 
¡d
::
û¼
 << "çØ»ad fromƒv’tfd .." << std::
’dl
;

728  
KADI_ERR_IO
;

731 #ifdeà
DUMP_ISSUE_CMD


732 
¡d
::
û¼
 << "# oàev’t ğ" << 
eád_ùx
 << std::
’dl
;

735 
eád_ùx
)

737 
nvme_aiÛv’ts
 
aiÛv’ts
;

739 
check_Ä
 = 
eád_ùx
;

740 ià(
check_Ä
 > 
MAX_AIO_EVENTS
)

742 
check_Ä
 = 
MAX_AIO_EVENTS
;

745 ià(
check_Ä
 > 
qd•th
)

747 
check_Ä
 = 
qd•th
;

750 
aiÛv’ts
.
Ä
 = 
check_Ä
;

751 
aiÛv’ts
.
ùxid
 = 
aioùx
.ctxid;

753 ià(
	`ioùl
(
fd
, 
NVME_IOCTL_GET_AIOEVENT
, &
aiÛv’ts
) < 0)

755 
¡d
::
û¼
 << "NVME_IOCTL_GET_AIOEVENT faed" << std::
’dl
;

756  
KADI_ERR_IO
;

759 
eád_ùx
 -ğ
check_Ä
;

762 
i
 = 0; i < 
aiÛv’ts
.
Ä
; i++)

764 
kv_io_cÚ‹xt
 
iÜesuÉ
;

765 cÚ¡ 
nvme_aiÛv’t
 &
ev’t
 = 
aiÛv’ts
.
ev’ts
[
i
];

767 #ifdeà
DUMP_ISSUE_CMD


768 
¡d
::
û¼
 << "»qid = " << 
ev’t
.
»qid
 << ",„‘ " << (ëv’t.
¡©us
 << "," << ()
aiÛv’ts
.
ev’ts
[
i
].¡©u << std::
’dl
;

770 
aio_cmd_ùx
 *
ioùx
 = 
	`g‘_cmdùx
(
ev’t
.
»qid
);

772 
	`fl_iÜesuÉ
(*
ioùx
, 
ev’t
, 
iÜesuÉ
);

773 
ioùx
->
	`ÿÎ_po¡_â
(
iÜesuÉ
);

775 
	`»Ëa£_cmd_ùx
(
ioùx
);

780 
	}
}

782 
kv_»suÉ
 
	gKADI
::
	$fl_iÜesuÉ
(cÚ¡ 
aio_cmd_ùx
 &
ioùx
, cÚ¡ 
nvme_aiÛv’t
 &
ev’t
,

783 
kv_io_cÚ‹xt
 &
iÜesuÉ
)

785 
iÜesuÉ
.
İcode
 = 
ioùx
.
cmd
.opcode;

786 
iÜesuÉ
.
»tcode
 = 
ev’t
.
¡©us
;

787 
iÜesuÉ
.
key
 = 
ioùx
.key;

788 
iÜesuÉ
.
v®ue
 = 
ioùx
.value;

789 
iÜesuÉ
.
´iv©e_d©a
 = 
ioùx
.
po¡_d©a
;

792 
iÜesuÉ
.
»tcode
)

795 ià(
iÜesuÉ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
)

797 
iÜesuÉ
.
h™”
.
buf
 = 
ioùx
.buf;

798 
iÜesuÉ
.
h™”
.
buæ’gth
 = (
ev’t
.
»suÉ
 & 0xffff);

799 
iÜesuÉ
.
h™”
.
’d
 = 
Œue
;

800 
iÜesuÉ
.
»tcode
 = 0;

806 ià(
iÜesuÉ
.
»tcode
 != 0)

809 
iÜesuÉ
.
İcode
)

812 
nvme_cmd_kv_»Œ›ve
:

814 ià(
ioùx
.
v®ue
)

816 
iÜesuÉ
.
v®ue
->
aùu®_v®ue_size
 = 
ev’t
.
»suÉ
;

817 
iÜesuÉ
.
v®ue
->
Ëngth
 = 
¡d
::
	`mš
(
ev’t
.
»suÉ
, 
ioùx
.value->length);

822 
nvme_cmd_kv_™”_»q
:

824 ià((
ioùx
.
cmd
.
cdw4
 & 
ITER_OPTION_OPEN
) != 0)

826 
iÜesuÉ
.
h™”
.
id
 = (
ev’t
.
»suÉ
 & 0x000000FF);

828 
iÜesuÉ
.
h™”
.
’d
 = 
çl£
;

832 
nvme_cmd_kv_™”_»ad
:

833 ià(
ioùx
.
buf
)

835 
iÜesuÉ
.
h™”
.
buf
 = 
ioùx
.buf;

836 
iÜesuÉ
.
h™”
.
buæ’gth
 = (
ev’t
.
»suÉ
 & 0xffff);

838 
iÜesuÉ
.
h™”
.
’d
 = 
çl£
;

843 
	}
}

	@PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi.h

5 #iâdeà
CEPH_KADI_H


6 
	#CEPH_KADI_H


	)

8 
	~<±h»ad.h
>

9 
	~<m­
>

10 
	~<veùÜ
>

11 
	~<mu‹x
>

12 
	~<li¡
>

13 
	~<©omic
>

14 
	~<¡dboŞ.h
>

15 
	~<cÚd™iÚ_v¬ŸbË
>

16 
	~<sys/ev’tfd.h
>

17 
	~<sys/£Ëù.h
>

18 
	~<sys/time.h
>

19 
	~"lšux_nvme_ioùl.h
"

20 
	~<kvs_adi.h
>

24 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

25 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

26 
	#KVCMD_MIN_KEY_SIZE
 (255)

	)

28 
	#KV_SPACE


	)

33 
	#ITER_BUFSIZE
 32768

	)

36 
şass
 
	gKvsT¿nsCÚ‹xt
;

37 
şass
 
	gKvsR—dCÚ‹xt
;

38 
şass
 
	gKvsSyncWr™eCÚ‹xt
;

39 
şass
 
	gC•hCÚ‹xt
;

40 
ušt8_t
 
	tkv_key_t
;

41 
ušt32_t
 
	tkv_v®ue_t
;

42 
	tkv_»suÉ
;

44 
	envme_kv_¡Üe_İtiÚ
 {

45 
	mSTORE_OPTION_NOTHING
 = 0,

46 
	mSTORE_OPTION_COMP
 = 1,

47 
	mSTORE_OPTION_IDEMPOTENT
 = 2,

48 
	mSTORE_OPTION_BGCOMP
 = 4

51 
	envme_kv_»Œ›ve_İtiÚ
 {

52 
	mRETRIEVE_OPTION_NOTHING
 = 0,

53 
	mRETRIEVE_OPTION_DECOMP
 = 1,

54 
	mRETRIEVE_OPTION_ONLY_VALSIZE
 = 2

57 
	envme_kv_d–‘e_İtiÚ
 {

58 
	mDELETE_OPTION_NOTHING
 = 0,

59 
	mDELETE_OPTION_CHECK_KEY_EXIST
 = 1

62 
	envme_kv_™”_»q_İtiÚ
 {

63 
	mITER_OPTION_NOTHING
 = 0x0,

64 
	mITER_OPTION_OPEN
 = 0x01,

65 
	mITER_OPTION_CLOSE
 = 0x02,

66 
	mITER_OPTION_KEY_ONLY
 = 0x04,

67 
	mITER_OPTION_KEY_VALUE
 = 0x08,

68 
	mITER_OPTION_DEL_KEY_VALUE
 = 0x10,

71 
	envme_kv_İcode
 {

72 
	mnvme_cmd_kv_¡Üe
 = 0x81,

73 
	mnvme_cmd_kv_­³nd
 = 0x83,

74 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

75 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

76 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

77 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

78 
	mnvme_cmd_kv_exi¡
 = 0xB3,

79 
	mnvme_cmd_kv_ÿ·c™y
 = 0x06

112 
şass
 
	gKvsStÜe
;

113 
şass
 
	gKADI
;

116 şas 
	cKDTh»ad
 {

117 
±h»ad_t
 
	mth»ad_id
;

118 
	m¡d
::
©omic_boŞ
 
¡İ_
;

120 
KADI
 *
	mdev
;

121 
	mpublic
:

122 
¡d
::
©omic_boŞ
 
¡¬‹d
;

124 
	$KDTh»ad
(
KADI
 *
dev_
):
	`¡İ_
(
çl£
), 
	`dev
(dev_),
	$¡¬‹d
(
çl£
) { }

126 
	$¡¬t
() {

127 
»t
 = 
	`±h»ad_ü—‹
(&
th»ad_id
, 
NULL
, 
_’Œy_func
, (*)
this
);

128 ià(
»t
 != 0) {

129 
	`årštf
(
¡d”r
, "failedo create‡ interrupthread\n");

132 
¡¬‹d
 = 
Œue
;

133 
	}
}

135 
	$¡İ
() {

136 
¡İ_
 = 
Œue
;

137 
	`još
(0);

138 
	}
}

140 *
’Œy
();

141 *
_’Œy_func
(*
¬g
);

142 
	$još
(**
´v®
)

144 ià(!
¡¬‹d
)  0;

145 ià(
th»ad_id
 == 0) {

146  -
EINVAL
;

149 
¡©us
 = 
	`±h»ad_još
(
th»ad_id
, 
´v®
);

150 ià(
¡©us
 != 0) {

151 
	`årštf
(
¡d”r
, "interrupthread: failedo join\n");

153 
¡¬‹d
 = 
çl£
;

154 
th»ad_id
 = 0;

155  
¡©us
;

156 
	}
}

162 
	mhªdË
;

163 
	m´efix
;

164 
	mb™mask
;

165 *
	mbuf
;

166 
	mbuæ’
;

167 
	mby‹swr™‹n
;

168 
	mbufoff£t
;

169 
boŞ
 
	m’d
;

170 } 
	tkv_™”_cÚ‹xt
;

172 şas 
	c™”buf_»ad”
 {

173 
C•hCÚ‹xt
 *
	mcù
;

174 *
	mbuf
;

175 
	mbufoff£t
;

176 
	mby‹swr™‹n
;

178 
	mnumkeys
;

179 
KADI
 *
	mdb
;

180 
KvsStÜe
 *
	m¡Üe
;

181 
	mpublic
:

183 
™”buf_»ad”
(
C•hCÚ‹xt
 *
c
, *
buf_
, 
Ëngth_
, 
KADI
 *
db
, 
KvsStÜe
 *
¡Üe_
 = 0);

185 
boŞ
 
	$ha¢ext
(è{  
by‹swr™‹n
 - 
bufoff£t
 > 0; }

187 
boŞ
 
	`Ãxtkey
(**
key
, *
Ëngth
);

188 
	}
};

191 şas 
	cKADI
 {

192 
	mpublic
:

193 
ušt64_t
 
ÿ·c™y
;

194 
	m¡d
::
	tli¡
<
	t¡d
::
	t·œ
<
	tkv_key
 *, 
	tkv_v®ue
 *> >::
	t™”©Ü
 
	taio_™”
;

196 
	mšdex
;

197 
kv_key
* 
	mkey
 = 0;

198 
kv_v®ue
 *
	mv®ue
 = 0;

199 *
	mbuf
 = 0;

200 
	mbuæ’
 = 0;

202 (*
	mpo¡_â
)(
kv_io_cÚ‹xt
 *
	m»suÉ
);

203 *
	mpo¡_d©a
;

205 vŞ©
nvme_·s¡hru_kv_cmd
 
	mcmd
;

207 
ÿÎ_po¡_â
(
kv_io_cÚ‹xt
 &
»suÉ
) {

208 ià(
	mpo¡_â
 !ğ
NULL
è
po¡_â
(&
»suÉ
);

210 } 
	taio_cmd_ùx
;

212 
š‹¼u±_hªdËr_t
 
	gšt_hªdËr
;

213 
KDTh»ad
 
	gcb_th»ad
;

214 
	$KADI
(
queued•th_
): 
	`ÿ·c™y
(0),
	`cb_th»ad
(
this
), 
	$qd•th
(
queued•th_
è{ 
št_hªdËr
.
hªdËr
 = 0; 
	}
}

215 ~
	$KADI
(è{ 
	`şo£
(); 
	}
}

217 
¡¬t_cbth»ad
();

219 
	g´iv©e
:

221 
fd
 = -1;

222 
	gnsid
;

223 
	g¥aû_id
;

225 
fd_£t
 
	grfds
;

226 
timev®
 
	gtimeout
;

227 
	g¡d
::
mu‹x
 
cmdùx_lock
;

228 
	g¡d
::
cÚd™iÚ_v¬ŸbË
 
cmdùx_cÚd
;

230 
	g¡d
::
veùÜ
<
aio_cmd_ùx
 *> 
ä“_cmdùxs
;

231 
	g¡d
::
m­
<, 
	gaio_cmd_ùx
 *> 
	g³ndšg_cmdùxs
;

233 
	gqd•th
;

235 
nvme_aioùx
 
	gaioùx
;

237 
aio_cmd_ùx
 *
g‘_cmd_ùx
(cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
);

239 
šlše
 
aio_cmd_ùx
* 
	$g‘_cmdùx
(
»qid
) {

240 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
 (
cmdùx_lock
);

241 autØ
p
 = 
³ndšg_cmdùxs
.
	`fšd
(
»qid
);

242 ià(
p
 =ğ
³ndšg_cmdùxs
.
	`’d
())

244  
p
->
£cÚd
;

245 
	}
}

247 
»Ëa£_cmd_ùx
(
aio_cmd_ùx
 *
p
);

249 
	gpublic
:

251 
ušt32_t
 
g‘_dev_waf
();

252 
kv_»suÉ
 
kv_¡Üe
(
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
* 
cb
, 
İtiÚ
 = 0);

253 
kv_»suÉ
 
kv_»Œ›ve
(
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
* 
cb
);

254 
kv_»suÉ
 
kv_»Œ›ve_sync
(
kv_key
 *
key
, 
kv_v®ue
 *
v®ue
);

255 
kv_»suÉ
 
kv_d–‘e
(
kv_key
 *
key
, cÚ¡ 
kv_po¡´oûss_funùiÚ
* 
cb
, 
check_exi¡
 = 0);

256 
kv_»suÉ
 
™”_İ’
(
kv_™”_cÚ‹xt
 *
™”_hªdË
);

257 
kv_»suÉ
 
™”_şo£
(
kv_™”_cÚ‹xt
 *
™”_hªdË
);

258 
kv_»suÉ
 
™”_»ad
(
kv_™”_cÚ‹xt
 *
™”_hªdË
);

259 
kv_»suÉ
 
™”_»ad_async
(
kv_™”_cÚ‹xt
 *
™”_hªdË
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
);

260 
kv_»suÉ
 
™”_»ad®l
(
kv_™”_cÚ‹xt
 *
™”_ùx
, 
¡d
::
li¡
<¡d::
·œ
<*, > > &
buæi¡
);

261 
kv_»suÉ
 
™”_li¡
(
kv_™”©Ü
 *™”_li¡, 
ušt32_t
 *
couÁ
);

262 
kv_»suÉ
 
pŞl_com¶‘iÚ
(
ušt32_t
 &
num_ev’ts
, ušt32_ˆ
timeout_us
);

263 
boŞ
 
exi¡
(
kv_key
 *
key
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
 = 0);

264 
boŞ
 
exi¡
(*
key
, 
Ëngth
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
cb
 = 0);

265 
İ’
(
¡d
::
¡ršg
 &
dev·th
);

266 
şo£
();

267 
fl_iÜesuÉ
(cÚ¡ 
aio_cmd_ùx
 &
ioùx
, cÚ¡ 
nvme_aiÛv’t
 &
ev’t
, 
kv_io_cÚ‹xt
 &
»suÉ
);

268 
kv_»suÉ
 
upd©e_ÿ·c™y
();

269 
kv_»suÉ
 
g‘_ä“¥aû
(
ušt64_t
 &
by‹su£d
, ušt64_ˆ&
ÿ·c™y
, &
utiz©iÚ
);

271 
	g¡d
::
¡ršg
 
	$”r¡r
(
»s
) {

272 ià(
»s
 =ğ
KV_SUCCESS
)  "SUCCESS";

274 
	}
}

275 
boŞ
 
	$is_İ’ed
(è{  (
fd
 !ğ-1); 
	}
}

276 
dump_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
);

281 
	#KADI_SUCCESS
 0

	)

282 
	#KADI_ERR_ALIGNMENT
 (-1)

	)

283 
	#KADI_ERR_CAPAPCITY
 (-2)

	)

284 
	#KADI_ERR_CLOSE
 (-3)

	)

285 
	#KADI_ERR_CONT_EXIST
 (-4)

	)

286 
	#KADI_ERR_CONT_NAME
 (-5)

	)

287 
	#KADI_ERR_CONT_NOT_EXIST
 (-6)

	)

288 
	#KADI_ERR_DEVICE_NOT_EXIST
 (-7)

	)

289 
	#KADI_ERR_GROUP
 (-8)

	)

290 
	#KADI_ERR_INDEX
 (-9)

	)

291 
	#KADI_ERR_IO
 (-10)

	)

292 
	#KADI_ERR_KEY
 (-11)

	)

293 
	#KADI_ERR_KEY_TYPE
 (-12)

	)

294 
	#KADI_ERR_MEMORY
 (-13)

	)

295 
	#KADI_ERR_NULL_INPUT
 (-14)

	)

296 
	#KADI_ERR_OFFSET
 (-15)

	)

297 
	#KADI_ERR_OPEN
 (-16)

	)

298 
	#KADI_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

299 
	#KADI_ERR_PERMISSION
 (-18)

	)

300 
	#KADI_ERR_SPACE
 (-19)

	)

301 
	#KADI_ERR_TIMEOUT
 (-20)

	)

302 
	#KADI_ERR_TUPLE_EXIST
 (-21)

	)

303 
	#KADI_ERR_TUPLE_NOT_EXIST
 (-22)

	)

304 
	#KADI_ERR_VALUE
 (-23)

	)

312 
nvme_kv_»Œ›ve2
(
¥aû_id
, 
fd
, 
nsid
,

313 cÚ¡ *
key
, 
key_Ën
,

314 cÚ¡ *
v®ue
, *
v®ue_Ën
,

315 
off£t
, 
nvme_kv_»Œ›ve_İtiÚ
 
İtiÚ
);

316 
nvme_kv_™”©e_»q
(
¥aû_id
, 
fd
, 
nsid
,

317 *
™”_hªdË
,

318 
™”_mask
, 
™”_v®ue
,

319 
İtiÚ
);

321 
nvme_kv_™”©e_»ad
(
¥aû_id
, 
fd
, 
nsid
,

322 
™”_hªdË
,

323 cÚ¡ *
»suÉ
, * 
»suÉ_Ën
);

	@PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi_debug.cpp

1 
	~"kadi_debug.h
"

2 
	~"lšux_nvme_ioùl.h
"

4 
	g¡d
::
¡ršg
 
	$´št_key
(cÚ¡ *
d©a
, 
Ëngth
) {

5 
key
[512];

6 
keyËn
 = 0;

7 
i
 =0 ; i < 
Ëngth
; i++) {

8 
keyËn
 +ğ
	`¥rštf
(
key
, "%02x", 
d©a
[
i
]);

10  
¡d
::
	`¡ršg
 (
key
, 
keyËn
);

11 
	}
}

13 
	$dump_d–‘e_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
) {

14 
buf
[2048];

15 
off£t
 = 
	`¥rštf
(
buf
, "[dum°d–‘cmd (%02x)]\n", 
cmd
->
İcode
);

17 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆİcode(%02x)\n", 
cmd
->
İcode
);

18 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆnsid(%04x)\n", 
cmd
->
nsid
);

19 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw3(%04x)\n", 
cmd
->
cdw3
);

20 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw4(%04x)\n", 
cmd
->
cdw4
);

21 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw5(%04x)\n", 
cmd
->
cdw5
);

23 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.key_Ëngth(%02x)\n", 
cmd
->
key_Ëngth
);

25 ià(
cmd
->
key_Ëngth
 <= 16) {

26 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.key (%s)\n", 
	`´št_key
((*)
cmd
->
key
, cmd->
key_Ëngth
).
	`c_¡r
());

29 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.key (%s)\n", 
	`´št_key
((*)
cmd
->
key_addr
, cmd->
key_Ëngth
).
	`c_¡r
());

31 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆ»qid(%04Îu)\n", 
cmd
->
»qid
);

32 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆùxid(%04d)\n", 
cmd
->
ùxid
);

33 
¡d
::
û¼
 << 
buf
 <<¡d::
’dl
;

34 
	}
}

37 
	$dump_»Œ›ve_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
) {

38 
buf
[2048];

39 
off£t
 = 
	`¥rštf
(
buf
, "[dum°»Œ›vcmd (%02x)]\n", 
cmd
->
İcode
);

41 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆİcode(%02x)\n", 
cmd
->
İcode
);

42 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆnsid(%04x)\n", 
cmd
->
nsid
);

43 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw3(%04x)\n", 
cmd
->
cdw3
);

44 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw4(%04x)\n", 
cmd
->
cdw4
);

45 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw5(%04x)\n", 
cmd
->
cdw5
);

47 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.key_Ëngth(%02x)\n", 
cmd
->
key_Ëngth
);

49 ià(
cmd
->
key_Ëngth
 <= 16) {

50 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.key (%s)\n", 
	`´št_key
((*)
cmd
->
key
, cmd->
key_Ëngth
).
	`c_¡r
());

53 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.key (%s)\n", 
	`´št_key
((*)
cmd
->
key_addr
, cmd->
key_Ëngth
).
	`c_¡r
());

56 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.d©a_Ëngth(%02x)\n", 
cmd
->
d©a_Ëngth
);

57 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcmd.d©a(%p)\n", (*)
cmd
->
d©a_addr
);

58 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆ»qid(%04Îu)\n", 
cmd
->
»qid
);

59 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆùxid(%04d)\n", 
cmd
->
ùxid
);

60 
¡d
::
û¼
 << 
buf
 <<¡d::
’dl
;

61 
	}
}

64 
	$dump_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
)

66 
buf
[2048];

67 
off£t
 = 
	`¥rštf
(
buf
, "[dum°issued cmd opcod(%02x)]\n", 
cmd
->
İcode
);

68 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆİcode(%02x)\n", 
cmd
->
İcode
);

69 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆæags(%02x)\n", 
cmd
->
æags
);

70 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆrsvd1(%04d)\n", 
cmd
->
rsvd1
);

71 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆnsid(%08x)\n", 
cmd
->
nsid
);

72 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw2(%08x)\n", 
cmd
->
cdw2
);

73 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw3(%08x)\n", 
cmd
->
cdw3
);

74 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆrsvd2(%08x)\n", 
cmd
->
cdw4
);

75 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw5(%08x)\n", 
cmd
->
cdw5
);

76 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆd©a_addr(%p)\n",(*)
cmd
->
d©a_addr
);

77 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆd©a_Ëngth(%08x)\n", 
cmd
->
d©a_Ëngth
);

78 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆkey_Ëngth(%08x)\n", 
cmd
->
key_Ëngth
);

79 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw10(%08x)\n", 
cmd
->
cdw10
);

80 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw11(%08x)\n", 
cmd
->
cdw11
);

81 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw12(%08x)\n", 
cmd
->
cdw12
);

82 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw13(%08x)\n", 
cmd
->
cdw13
);

83 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw14(%08x)\n", 
cmd
->
cdw14
);

84 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆcdw15(%08x)\n", 
cmd
->
cdw15
);

85 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆtimeout_ms(%08x)\n", 
cmd
->
timeout_ms
);

86 
off£t
 +ğ
	`¥rštf
(
buf
+off£t, "\ˆ»suÉ(%08x)\n", 
cmd
->
»suÉ
);

87 
¡d
::
û¼
 << 
buf
 <<¡d::
’dl
;

88 
	}
}

	@PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi_debug.h

1 #iâdeà
KADI_DEBUG_H


2 
	#KADI_DEBUG_H


	)

4 
	~<¡ršg
>

5 
	~<io¡»am
>

9 #iâdeà
FTRACE


10 
	#FTRACE
 
FŒaûObjeù
 
	`fobj
(
__FUNCTION__
);

	)

13 
	sFŒaûObjeù
 {

14 
	m¡d
::
¡ršg
 
func
;

15 
FŒaûObjeù
(cÚ¡ *
f
è: 
func
(f) {

16 
¡d
::
û¼
 << "ENTER: " << 
func
 << std::
’dl
;

19 ~
FŒaûObjeù
() {

20 
	m¡d
::
û¼
 << "EXIT : " << 
func
 << 
¡d
::
’dl
;

24 
	gnvme_·s¡hru_kv_cmd
;

25 
dump_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
);

26 
dump_»Œ›ve_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
);

27 
dump_d–‘e_cmd
(
nvme_·s¡hru_kv_cmd
 *
cmd
);

28 
	g¡d
::
¡ršg
 
´št_key
(cÚ¡ *
d©a
, 
Ëngth
);

	@PDK/core/src/device_abstract_layer/kernel_driver_adapter/kvs_adi.cpp

34 
	~<m­
>

40 
	~"kvs_adi.h
"

41 
	~"kvs_adi_š‹º®.h
"

43 
	~"io_cmd.hµ
"

44 
	~"queue.hµ
"

46 
	~"kv_deviû.hµ
"

47 
	~"kv_Çme¥aû.hµ
"

48 
	~"kvs_adi_š‹º®.h
"

49 
	~"th»ad_poŞ.hµ
"

50 
	~"kadi.h
"

51 
	#FTRACE


	)

52 
	~"kadi_debug.h
"

54 
usšg
 
Çme¥aû
 
	gkvadi
;

57 
šlše
 
KADI
 *
	$g‘_kadi_äom_hdl
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
)

59 ià(
dev_hdl
->
dev
 =ğ
NULL
) {

63  (
KADI
 *è
dev_hdl
->
dev
;

64 
	}
}

67 
kv_»suÉ
 
	$v®id©e_key_v®ue
(cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
) {

68 ià(
key
->key =ğ
NULL
) {

69  
KV_ERR_KEY_INVALID
;

71 ià(
key
->
Ëngth
 > 
SAMSUNG_KV_MAX_KEY_LEN
 || key->Ëngth < 
SAMSUNG_KV_MIN_KEY_LEN
) {

72  
KV_ERR_KEY_LENGTH_INVALID
;

75 ià(
v®ue
 !ğ
NULL
) {

76 ià(
v®ue
->
Ëngth
 < 
SAMSUNG_KV_MIN_VALUE_LEN
 || v®ue->Ëngth > 
SAMSUNG_KV_MAX_VALUE_LEN
) {

77  
KV_ERR_VALUE_LENGTH_INVALID
;

81  
KV_SUCCESS
;

82 
	}
}

86 şas 
	cdevli¡
 {

87 
	mpublic
:

88 
¡d
::
»cursive_mu‹x
 
s_mu‹x
;

89 
	m¡d
::
£t
<*> 
s_glob®_deviû_li¡
;

90 
	$add
(* 
adi
) {

91 
¡d
::
lock_gu¬d
<¡d::
»cursive_mu‹x
> 
	`lock
(
s_mu‹x
);

92 autØ
p
 = 
s_glob®_deviû_li¡
.
	`š£¹
(
adi
);

93 ià(
p
.
£cÚd
) {

94  
s_glob®_deviû_li¡
.
	`size
() -1;

98 
	$»move
(* 
adi
) {

99 
¡d
::
lock_gu¬d
<¡d::
»cursive_mu‹x
> 
	`lock
(
s_mu‹x
);

100 autØ
p
 = 
s_glob®_deviû_li¡
.
	`fšd
(
adi
);

101 ià(
p
 !ğ
s_glob®_deviû_li¡
.
	`’d
()) {

102 
s_glob®_deviû_li¡
.
	`”a£
(
p
);

107 
	}
}

110 
devli¡
 
	gg_deviûs
;

114 
kv_»suÉ
 
	$kv_š™Ÿlize_deviû
(*
dev_š™
, 
kv_deviû_hªdË
 *
dev_hdl
) {

115 
FTRACE


116 
kv_deviû_š™_t
 *
İtiÚs
 = (kv_deviû_š™_ˆ*è
dev_š™
;

117 
¡d
::
¡ršg
 
	`dev·th
 (
İtiÚs
->
dev·th
);

119 ià(
dev_hdl
 =ğ
NULL
) {

120  
KV_ERR_PARAM_INVALID
;

121 } ià(*
dev_hdl
 !ğ
NULL
) {

122  
KV_ERR_DEV_INITIALIZED
;

126 
kv_deviû_hªdË
 
hnd
 = 
Ãw
 
_kv_deviû_hªdË
;

127 
hnd
->
dev
 = (*è
Ãw
 
	`KADI
(
İtiÚs
->
queued•th
);

128 
devid
 = 
g_deviûs
.
	`add
(
hnd
->
dev
);

130 ià(
devid
 == -1) {

131 
	`kv_ş—nup_deviû
(
hnd
);

132  
KV_ERR_DEV_INIT
;

135 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
hnd
);

136 
»t
 = 
dev
->
	`İ’
(
dev·th
);

137 ià(
»t
 == 0) {

138 
dev
->
	`upd©e_ÿ·c™y
();

139 
hnd
->
devid
 = devid;

141 (*
dev_hdl
èğ
hnd
;

144 ià(
”ºo
 =ğ
ENOENT
) {

145 
»t
 = 
KV_ERR_DEV_NOT_EXIST
;

146 } ià(
”ºo
 =ğ
EACCES
) {

147 
»t
 = 
KV_ERR_PERMISSION
;

149 
»t
 = 
KV_ERR_UNCORRECTIBLE
;

151 
	`kv_ş—nup_deviû
(
hnd
);

154  
»t
;

155 
	}
}

157 
kv_»suÉ
 
	$kv_ş—nup_deviû
(
kv_deviû_hªdË
 
dev_hdl
) {

158 
FTRACE


159 ià(!
dev_hdl
è 
KVS_ERR_PARAM_INVALID
;

160 ià(
dev_hdl
->
dev
) {

161 
g_deviûs
.
	`»move
(
dev_hdl
->
dev
);

162 
	`d–‘e
 (
KADI
*)
dev_hdl
->
dev
;

164 
d–‘e
 
dev_hdl
;

165  
KV_SUCCESS
;

166 
	}
}

168 
kv_»suÉ
 
	$kv_g‘_deviû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû
 *
devšfo
)

170 
FTRACE


171 ià(
devšfo
 =ğ
NULL
 || 
dev_hdl
 == NULL ) {

172  
KV_ERR_PARAM_INVALID
;

174 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

175 ià(
dev
 =ğ
NULL
è{  
KV_ERR_DEV_NOT_EXIST
; }

177 
devšfo
->
v”siÚ
 = 1;

178 
devšfo
->
max_Çme¥aûs
 = 1;

179 
devšfo
->
max_queues
 = 1;

180 
devšfo
->
ÿ·c™y
 = 
dev
->capacity;

181 
devšfo
->
mš_v®ue_Ën
 = 
SAMSUNG_KV_MIN_VALUE_LEN
;

182 
devšfo
->
max_v®ue_Ën
 = 
SAMSUNG_KV_MAX_VALUE_LEN
;

183 
devšfo
->
mš_key_Ën
 = 
SAMSUNG_KV_MIN_KEY_LEN
;

184 
devšfo
->
max_key_Ën
 = 
SAMSUNG_KV_MAX_KEY_LEN
;

185 
devšfo
->
ex‹nded_šfo
 = 0;

187  
KV_SUCCESS
;

188 
	}
}

191 
kv_»suÉ
 
	$kv_g‘_deviû_waf
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
ušt32_t
 *
waf
) {

193 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

194 ià(
dev
 =ğ
NULL
) {

195  
KV_ERR_DEV_NOT_EXIST
;

198 *
waf
 = 
dev
->
	`g‘_dev_waf
();

202 
	}
}

204 
kv_»suÉ
 
	$kv_g‘_deviû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_deviû_¡©
 *
dev_¡
) {

205 
FTRACE


206 ià(
dev_¡
 =ğ
NULL
) {

207  
KV_ERR_PARAM_INVALID
;

210 
ušt64_t
 
by‹su£d
, 
ÿ·c™y
;

211 
utiz©iÚ
;

213 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

214 ià(
dev
 =ğ
NULL
è{  
KV_ERR_DEV_NOT_EXIST
; }

216 
r
 = 
dev
->
	`g‘_ä“¥aû
(
by‹su£d
, 
ÿ·c™y
, 
utiz©iÚ
);

217 ià(
r
 !ğ0è{  
KV_ERR_SYS_IO
; }

219 
dev_¡
->
Çme¥aû_couÁ
 = 1;

220 
dev_¡
->
queue_couÁ
 = 1;

221 
dev_¡
->
utiz©iÚ
 = (
ušt16_t
)(utilization * 10000);

222 
dev_¡
->
waf
 = 0;

223 
dev_¡
->
ex‹nded_šfo
 = 0;

225  
KV_SUCCESS
;

226 
	}
}

228 
kv_»suÉ
 
	$kv_§n™ize
(
kv_queue_hªdË
 
que_hdl
, 
kv_deviû_hªdË
 
dev_hdl
, 
kv_§n™ize_İtiÚ
 
İtiÚ
, 
kv_§n™ize_·‰”n
 *
·‰”n
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
)

230 
FTRACE


231  
KV_ERR_DD_UNSUPPORTED_CMD
;

232 
	}
}

235 
kv_»suÉ
 
	$kv_ü—‹_queue
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue
 *
que
, 
kv_queue_hªdË
 *
que_hdl
) {

236 
FTRACE


237 ià(
dev_hdl
 =ğ
NULL
 || 
que
 =ğNULL || 
que_hdl
 == NULL) {

238  
KV_ERR_PARAM_INVALID
;

241 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

242 ià(
dev
 =ğ
NULL
è{  
KV_ERR_DEV_NOT_EXIST
; }

244 (*
que_hdl
èğ
Ãw
 
	`_kv_queue_hªdË
();

245 (*
que_hdl
)->
qid
 = 0;

246 (*
que_hdl
)->
dev
 = (*)dev;

247 (*
que_hdl
)->
queue
 = (*)
que
;

249  
KV_SUCCESS
;

250 
	}
}

252 
kv_»suÉ
 
	$kv_d–‘e_queue
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 
que_hdl
) {

253 
FTRACE


254 ià(
que_hdl
)

255 
d–‘e
 
que_hdl
;

257 
	}
}

259 
kv_»suÉ
 
	$kv_g‘_queue_hªdËs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_queue_hªdË
 *
que_hdls
, 
ušt16_t
 *
que_út
) {

260 
FTRACE


261  
KV_ERR_DD_UNSUPPORTED_CMD
;

262 
	}
}

264 
kv_»suÉ
 
	$kv_g‘_queue_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue
 *
quešfo
) {

265 
FTRACE


266  
KV_ERR_DD_UNSUPPORTED_CMD
;

267 
	}
}

269 
kv_»suÉ
 
	$kv_g‘_queue_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_queue_hªdË
 
que_hdl
, 
kv_queue_¡©
 *
que_¡
) {

270 
FTRACE


271  
KV_ERR_DD_UNSUPPORTED_CMD
;

272 
	}
}

275 
kv_»suÉ
 
	$kv_ü—‹_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû
 *
ns
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

276 
FTRACE


277  
KV_ERR_DEV_MAX_NS
;

278 
	}
}

280 
kv_»suÉ
 
	$kv_d–‘e_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

281 
FTRACE


282 ià(
ns_hdl
) {

283 
d–‘e
 
ns_hdl
;

284  
KV_SUCCESS
;

286  
KV_ERR_NS_DEFAULT
;

287 
	}
}

289 
kv_»suÉ
 
	$kv_©ch_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

290 
FTRACE


291  
KV_ERR_NS_DEFAULT
;

292 
	}
}

294 
kv_»suÉ
 
	$kv_d‘ach_Çme¥aû
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
) {

295 
FTRACE


296  
KV_ERR_NS_DEFAULT
;

297 
	}
}

299 
kv_»suÉ
 
	$kv_li¡_Çme¥aûs
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdls
, 
ušt32_t
 *
ns_út
) {

300 
FTRACE


301 ià(
dev_hdl
 =ğ
NULL
 || 
ns_hdls
 =ğNULL || 
ns_út
 == NULL) {

302  
KV_ERR_PARAM_INVALID
;

305 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

306 ià(
dev
 =ğ
NULL
) {

307  
KV_ERR_DEV_NOT_EXIST
;

311 *
ns_út
 = 1;

312 
ns_hdls
[0]->
nsid
 = (
ušt32_t
è
KV_NAMESPACE_DEFAULT
;

313 
ns_hdls
[0]->
dev
 = 
dev_hdl
->dev;

314 
ns_hdls
[0]->
ns
 = (*) 0;

316  
KV_SUCCESS
;

317 
	}
}

319 
kv_»suÉ
 
	$kv_g‘_Çme¥aû_šfo
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû
 *
nsšfo
) {

320 
FTRACE


321 ià(
nsšfo
 =ğ
NULL
 || 
ns_hdl
 == NULL ) {

322  
KV_ERR_PARAM_INVALID
;

324 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

325 ià(
dev
 =ğ
NULL
) {

326  
KV_ERR_DEV_NOT_EXIST
;

329 
nsšfo
->
nsid
 = 0;

330 
nsšfo
->
©ched
 = 
TRUE
;

331 
nsšfo
->
ÿ·c™y
 = 
dev
->capacity;

332 
nsšfo
->
ex‹nded_šfo
 = 0;

334  
KV_SUCCESS
;

335 
	}
}

337 
kv_»suÉ
 
	$kv_g‘_Çme¥aû_¡©
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_Çme¥aû_¡©
 *
ns_¡
) {

338 
FTRACE


339 
ušt64_t
 
by‹su£d
, 
ÿ·c™y
;

340 
utiz©iÚ
;

342 
KADI
 *
dev
 = 
	`g‘_kadi_äom_hdl
(
dev_hdl
);

343 ià(
dev
 =ğ
NULL
è{  
KV_ERR_DEV_NOT_EXIST
; }

345 
r
 = 
dev
->
	`g‘_ä“¥aû
(
by‹su£d
, 
ÿ·c™y
, 
utiz©iÚ
);

346 ià(
r
 !ğ0è{  
KV_ERR_SYS_IO
; }

348 
ns_¡
->
uÇÎoÿ‹d_ÿ·c™y
 = 
ÿ·c™y
 - 
by‹su£d
;

349 
ns_¡
->
nsid
 = 0;

351  
KV_SUCCESS
;

352 
	}
}

354 
kv_»suÉ
 
	$g‘_Çme¥aû_deçuÉ
(
kv_deviû_hªdË
 
dev_hdl
, 
kv_Çme¥aû_hªdË
 *
ns_hdl
) {

355 ià(
dev_hdl
 =ğ
NULL
 || 
ns_hdl
 == NULL) {

356  
KV_ERR_PARAM_INVALID
;

358 
KADI
 *
dev
 = (KADI *è
dev_hdl
->dev;

359 ià(
dev
 =ğ
NULL
) {

360  
KV_ERR_DEV_NOT_EXIST
;

363 (*
ns_hdl
èğ
Ãw
 
	`_kv_Çme¥aû_hªdË
();

364 (*
ns_hdl
)->
dev
 = dev;

365 (*
ns_hdl
)->
ns
 = 0;

366 (*
ns_hdl
)->
nsid
 = 0;

368  
KV_SUCCESS
;

369 
	}
}

372 
kv_»suÉ
 
	$_kv_by·ss_Çme¥aû
(cÚ¡ 
kv_deviû_hªdË
 
dev_hdl
, cÚ¡ 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
boŞ_t
 
by·ss
) {

373 
FTRACE


374  
KV_ERR_DD_UNSUPPORTED_CMD
;

375 
	}
}

378 
kv_»suÉ
 
	$kv_purge
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_purge_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

379 
FTRACE


381 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 == NULL) {

382  
KV_ERR_PARAM_INVALID
;

385  
KV_ERR_DD_UNSUPPORTED_CMD
;

386 
	}
}

388 
kv_»suÉ
 
	$kv_İ’_™”©Ü_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_™”©Ü_İtiÚ
 
™_İ
, cÚ¡ 
kv_group_cÚd™iÚ
 *
™_cÚd
, 
ušt8_t
 *
™”_hªdË
) {

389 
kv_™”_cÚ‹xt
 
™”_ùx
;

390 
™”_ùx
.
´efix
 = 
™_cÚd
->
b™_·‰”n
;

391 
™”_ùx
.
b™mask
 = 
™_cÚd
->bitmask;

392 
™”_ùx
.
buæ’
 = 
ITER_BUFSIZE
;

394 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

395 ià(
dev
 =ğ
NULL
è{  
KV_ERR_DEV_NOT_EXIST
; }

397 
kv_»suÉ
 
»t
 = 
dev
->
	`™”_İ’
(&
™”_ùx
);

398 ià(
»t
 =ğ
KV_SUCCESS
) {

399 *
™”_hªdË
 = (
ušt8_t
)
™”_ùx
.
hªdË
;

401  
»t
;

402 
	}
}

404 
kv_»suÉ
 
	$kv_şo£_™”©Ü_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
) {

405 
FTRACE


406 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 == 0) {

407  
KV_ERR_PARAM_INVALID
;

409 
kv_™”_cÚ‹xt
 
™”_ùx
;

410 
™”_ùx
.
hªdË
 = 
™”_hdl
;

412 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

413 ià(
dev
 =ğ
NULL
è{  
KV_ERR_DEV_NOT_EXIST
; }

415  
dev
->
	`™”_şo£
(&
™”_ùx
);

416 
	}
}

417 
kv_»suÉ
 
	$kv_™”©Ü_Ãxt
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
)

419 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 =ğ0 || 
™”_li¡
 == NULL) {

420  
KV_ERR_PARAM_INVALID
;

423 
kv_™”_cÚ‹xt
 
™”_ùx
;

424 
™”_ùx
.
hªdË
 = 
™”_hdl
;

425 
™”_ùx
.
buf
 = 
™”_li¡
->
™_li¡
;

426 
™”_ùx
.
buæ’
 = 
™”_li¡
->
size
;

428 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

429  
dev
->
	`™”_»ad_async
(&
™”_ùx
, 
po¡_â
);

430 
	}
}

432 
kv_»suÉ
 
	$kv_™”©Ü_Ãxt_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü_hªdË
 
™”_hdl
, 
kv_™”©Ü_li¡
 *
™”_li¡
) {

433 
FTRACE


434 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
™”_hdl
 =ğ0 || 
™”_li¡
 == NULL) {

435  
KV_ERR_PARAM_INVALID
;

438 
kv_™”_cÚ‹xt
 
™”_ùx
;

439 
™”_ùx
.
hªdË
 = 
™”_hdl
;

440 
™”_ùx
.
buf
 = 
™”_li¡
->
™_li¡
;

441 
™”_ùx
.
buæ’
 = 
™”_li¡
->
size
;

443 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

444 
kv_»suÉ
 
»t
 = 
dev
->
	`™”_»ad
(&
™”_ùx
);

446 
key_couÁ
 = (
™”_ùx
.
by‹swr™‹n
 =ğ0è? 0 : *((
ušt32_t
 *)™”_ùx.
buf
);

447 
™”_li¡
->
num_’Œ›s
 = 
key_couÁ
;

448 
™”_li¡
->
size
 = 
™”_ùx
.
by‹swr™‹n
;

449 ià(
»t
 =ğ
KV_SUCCESS
) {

450 
™”_li¡
->
’d
 = (
™”_ùx
.’d)? 
TRUE
:
FALSE
;

452 ià(
»t
 == 0x393) {

453 
»t
 = 
KV_SUCCESS
;

454 
™”_li¡
->
’d
 = 
TRUE
;

457  
»t
;

458 
	}
}

459 
kv_»suÉ
 
	$kv_li¡_™”©Üs
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

460  
KV_ERR_DD_UNSUPPORTED_CMD
;

461 
	}
}

463 
kv_»suÉ
 
	$kv_li¡_™”©Üs_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_™”©Ü
 *
kv_™”s
, 
ušt32_t
 *
™”_út
) {

464 
FTRACE


465 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
kv_™”s
 =ğNULL || 
™”_út
 == NULL) {

466  
KV_ERR_PARAM_INVALID
;

469 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

470  
dev
->
	`™”_li¡
(
kv_™”s
, 
™”_út
);

471 
	}
}

473 
kv_»suÉ
 
	$kv_d–‘e
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_d–‘e_İtiÚ
 
İtiÚ
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

474 
FTRACE


476 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 == NULL) {

477  
KV_ERR_PARAM_INVALID
;

479 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

481  
dev
->
	`kv_d–‘e
((
kv_key
 *)
key
, 
po¡_â
, ()
İtiÚ
);

482 
	}
}

484 
kv_»suÉ
 
	$kv_d–‘e_group
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, 
kv_group_cÚd™iÚ
 *
g½_cÚd
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

485 
FTRACE


486 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
g½_cÚd
 == NULL) {

487  
KV_ERR_PARAM_INVALID
;

490  
KV_ERR_DD_UNSUPPORTED_CMD
;

491 
	}
}

493 
kv_»suÉ
 
	$kv_exi¡
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
keys
, 
ušt32_t
 
key_út
, ušt32_ˆ
bufãr_size
, 
ušt8_t
 *
bufãr
, 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

494 
FTRACE


496 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key_út
 < 1 ) {

497  
KV_ERR_PARAM_INVALID
;

503 
ušt32_t
 
i
 = 0; i < 1; i++) {

504 
kv_»suÉ
 
»s
 = 
	`v®id©e_key_v®ue
(&
keys
[
i
], 
NULL
);

505 ià(
»s
 !ğ
KV_SUCCESS
) {

506  
»s
;

510 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

511 
boŞ
 
e
 = 
dev
->
	`exi¡
((
kv_key
 *)&
keys
[0], 
po¡_â
);

512 ià(
po¡_â
 == 0) {

514 ià(
bufãr
 && 
bufãr_size
 > 0èbufãr[0] = (
e
)? 1:0;

515 } ià(
e
 =ğ
çl£
){

517  
KVS_ERR_SYS_IO
;

520  
KV_SUCCESS
;

521 
	}
}

523 
kv_»suÉ
 
	$kv_»Œ›ve
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_»Œ›ve_İtiÚ
 
İtiÚ
, 
kv_v®ue
 *
v®ue
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

524 
FTRACE


525 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

526  
KV_ERR_PARAM_INVALID
;

528 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

529  
dev
->
	`kv_»Œ›ve
((
kv_key
*)
key
, 
v®ue
, 
po¡_â
);

530 
	}
}

532 
kv_»suÉ
 
	$kv_»Œ›ve_sync
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, 
kv_»Œ›ve_İtiÚ
 
İtiÚ
, 
kv_v®ue
 *
v®ue
) {

533 
FTRACE


534 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

535  
KV_ERR_PARAM_INVALID
;

537 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

538  
dev
->
	`kv_»Œ›ve_sync
((
kv_key
*)
key
, 
v®ue
);

539 
	}
}

541 
kv_»suÉ
 
	$kv_¡Üe
(
kv_queue_hªdË
 
que_hdl
, 
kv_Çme¥aû_hªdË
 
ns_hdl
, cÚ¡ 
kv_key
 *
key
, cÚ¡ 
kv_v®ue
 *
v®ue
, 
kv_¡Üe_İtiÚ
 
İtiÚ
, cÚ¡ 
kv_po¡´oûss_funùiÚ
 *
po¡_â
) {

542 
FTRACE


544 ià(
que_hdl
 =ğ
NULL
 || 
ns_hdl
 =ğNULL || 
key
 =ğNULL || 
v®ue
 == NULL) {

545  
KV_ERR_PARAM_INVALID
;

547 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

548  
dev
->
	`kv_¡Üe
((
kv_key
*)
key
, (
kv_v®ue
*)
v®ue
, 
po¡_â
, ()
İtiÚ
);

549 
	}
}

552 
kv_»suÉ
 
	$kv_pŞl_com¶‘iÚ
(
kv_queue_hªdË
 
que_hdl
, 
ušt32_t
 
timeout_u£c
, ušt32_ˆ*
num_ev’ts
) {

553 
FTRACE


554 ià(
que_hdl
 =ğ
NULL
 || 
num_ev’ts
 == NULL) {

555  
KV_ERR_PARAM_INVALID
;

558 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

559  
dev
->
	`pŞl_com¶‘iÚ
(*
num_ev’ts
, 
timeout_u£c
);

560 
	}
}

562 
kv_»suÉ
 
	$kv_£t_š‹¼u±_hªdËr
(
kv_queue_hªdË
 
que_hdl
, cÚ¡ 
kv_š‹¼u±_hªdËr
 
št_hdl
) {

563 
FTRACE


564 ià(
que_hdl
 =ğ
NULL
 || 
št_hdl
 == NULL) {

565  
KV_ERR_PARAM_INVALID
;

568 
KADI
 *
dev
 = (KADI *è
que_hdl
->dev;

569 
dev
->
št_hªdËr
.
hªdËr
 = 
št_hdl
->handler;

570 
dev
->
št_hªdËr
.
numb”
 = 
št_hdl
->number;

571 
dev
->
št_hªdËr
.
´iv©e_d©a
 = 
št_hdl
->private_data;

573  
KV_SUCCESS
;

574 
	}
}

	@PDK/core/src/device_abstract_layer/kernel_driver_adapter/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


16 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	mİcode
;

22 
__u8
 
	mæags
;

23 
__u16
 
	mcÚŒŞ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mm‘ad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¦ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	m»áag
;

31 
__u16
 
	m­±ag
;

32 
__u16
 
	m­pmask
;

35 
	snvme_·s¡hru_cmd
 {

36 
__u8
 
	mİcode
;

37 
__u8
 
	mæags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mm‘ad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mm‘ad©a_Ën
;

45 
__u32
 
	md©a_Ën
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	m»suÉ
;

56 
	snvme_·s¡hru_kv_cmd
 {

57 
__u8
 
	mİcode
;

58 
__u8
 
	mæags
;

59 
__u16
 
	mrsvd1
;

60 
__u32
 
	mnsid
;

61 
__u32
 
	mcdw2
;

62 
__u32
 
	mcdw3
;

63 
__u32
 
	mcdw4
;

64 
__u32
 
	mcdw5
;

65 
__u64
 
	md©a_addr
;

66 
__u32
 
	md©a_Ëngth
;

67 
__u32
 
	mkey_Ëngth
;

68 
__u32
 
	mcdw10
;

69 
__u32
 
	mcdw11
;

72 
__u64
 
	mkey_addr
;

73 
__u32
 
	mrsvd5
;

74 
__u32
 
	mrsvd6
;

76 
__u8
 
	mkey
[16];

78 
__u32
 
	mcdw12
;

79 
__u32
 
	mcdw13
;

80 
__u32
 
	mcdw14
;

81 
__u32
 
	mcdw15
;

84 
__u32
 
	mtimeout_ms
;

85 
__u32
 
	m»suÉ
;

86 
__u32
 
	m¡©us
;

87 
__u32
 
	mùxid
;

88 
__u64
 
	m»qid
;

91 
	snvme_aioùx
 {

92 
__u32
 
	mùxid
;

93 
__u32
 
	mev’tfd
;

97 
	snvme_aiÛv’t
 {

98 
__u64
 
	m»qid
;

99 
__u32
 
	mùxid
;

100 
__u32
 
	m»suÉ
;

101 
__u16
 
	m¡©us
;

104 
	#MAX_AIO_EVENTS
 128

	)

105 
	snvme_aiÛv’ts
 {

106 
__u16
 
	mÄ
;

107 
__u32
 
	mùxid
;

108 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

112 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

114 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

115 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

116 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

117 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

118 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

119 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

120 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

122 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

123 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

124 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

125 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

126 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/core/tools/pci_ids.h

38 #iâdeà
SPDK_PCI_IDS


39 
	#SPDK_PCI_IDS


	)

41 
	~"¥dk/¡dšc.h
"

43 #ifdeà
__ılu¥lus


47 
	#SPDK_PCI_ANY_ID
 0xffff

	)

48 
	#SPDK_PCI_VID_INTEL
 0x8086

	)

49 
	#SPDK_PCI_VID_MEMBLAZE
 0x1c5f

	)

50 
	#SPDK_PCI_VID_VIRTUALBOX
 0x80“

	)

59 
	#SPDK_PCI_CLASS_NVME
 0x010802

	)

61 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB0
 0x3c20

	)

62 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB1
 0x3c21

	)

63 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB2
 0x3c22

	)

64 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB3
 0x3c23

	)

65 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB4
 0x3c24

	)

66 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB5
 0x3c25

	)

67 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB6
 0x3c26

	)

68 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB7
 0x3c27

	)

69 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB8
 0x3c2e

	)

70 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB9
 0x3c2f

	)

72 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB0
 0x0e20

	)

73 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB1
 0x0e21

	)

74 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB2
 0x0e22

	)

75 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB3
 0x0e23

	)

76 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB4
 0x0e24

	)

77 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB5
 0x0e25

	)

78 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB6
 0x0e26

	)

79 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB7
 0x0e27

	)

80 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB8
 0x0e2e

	)

81 
	#PCI_DEVICE_ID_INTEL_IOAT_IVB9
 0x0e2f

	)

83 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW0
 0x2f20

	)

84 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW1
 0x2f21

	)

85 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW2
 0x2f22

	)

86 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW3
 0x2f23

	)

87 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW4
 0x2f24

	)

88 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW5
 0x2f25

	)

89 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW6
 0x2f26

	)

90 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW7
 0x2f27

	)

91 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW8
 0x2f2e

	)

92 
	#PCI_DEVICE_ID_INTEL_IOAT_HSW9
 0x2f2f

	)

94 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD0
 0x0C50

	)

95 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD1
 0x0C51

	)

96 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD2
 0x0C52

	)

97 
	#PCI_DEVICE_ID_INTEL_IOAT_BWD3
 0x0C53

	)

99 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE0
 0x6f50

	)

100 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE1
 0x6f51

	)

101 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE2
 0x6f52

	)

102 
	#PCI_DEVICE_ID_INTEL_IOAT_BDXDE3
 0x6f53

	)

104 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX0
 0x6f20

	)

105 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX1
 0x6f21

	)

106 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX2
 0x6f22

	)

107 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX3
 0x6f23

	)

108 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX4
 0x6f24

	)

109 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX5
 0x6f25

	)

110 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX6
 0x6f26

	)

111 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX7
 0x6f27

	)

112 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX8
 0x6f2e

	)

113 
	#PCI_DEVICE_ID_INTEL_IOAT_BDX9
 0x6f2f

	)

115 
	#PCI_DEVICE_ID_INTEL_IOAT_SKX
 0x2021

	)

117 #ifdeà
__ılu¥lus


	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_H


16 
	#_UAPI_LINUX_NVME_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_id_pow”_¡©e
 {

21 
__Ë16
 
	mmax_pow”
;

22 
__u8
 
	mrsvd2
;

23 
__u8
 
	mæags
;

24 
__Ë32
 
	m’Œy_Ït
;

25 
__Ë32
 
	mex™_Ït
;

26 
__u8
 
	m»ad_ut
;

27 
__u8
 
	m»ad_Ït
;

28 
__u8
 
	mwr™e_ut
;

29 
__u8
 
	mwr™e_Ït
;

30 
__Ë16
 
	midË_pow”
;

31 
__u8
 
	midË_sÿË
;

32 
__u8
 
	mrsvd19
;

33 
__Ë16
 
	maùive_pow”
;

34 
__u8
 
	maùive_wÜk_sÿË
;

35 
__u8
 
	mrsvd23
[9];

39 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

40 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

43 
	snvme_id_ù¾
 {

44 
__Ë16
 
	mvid
;

45 
__Ë16
 
	mssvid
;

46 
	m¢
[20];

47 
	mmn
[40];

48 
	mä
[8];

49 
__u8
 
	m¿b
;

50 
__u8
 
	m›“
[3];

51 
__u8
 
	mmic
;

52 
__u8
 
	mmdts
;

53 
__u16
 
	múid
;

54 
__u32
 
	mv”
;

55 
__u8
 
	mrsvd84
[172];

56 
__Ë16
 
	mßcs
;

57 
__u8
 
	maş
;

58 
__u8
 
	m«¾
;

59 
__u8
 
	mämw
;

60 
__u8
 
	mÍa
;

61 
__u8
 
	m–³
;

62 
__u8
 
	mÅss
;

63 
__u8
 
	mavscc
;

64 
__u8
 
	m­¡a
;

65 
__Ë16
 
	mwùemp
;

66 
__Ë16
 
	mcùemp
;

67 
__u8
 
	mrsvd270
[242];

68 
__u8
 
	msqes
;

69 
__u8
 
	mcqes
;

70 
__u8
 
	mrsvd514
[2];

71 
__Ë32
 
	mÂ
;

72 
__Ë16
 
	mÚcs
;

73 
__Ë16
 
	mfu£s
;

74 
__u8
 
	mâa
;

75 
__u8
 
	mvwc
;

76 
__Ë16
 
	mawun
;

77 
__Ë16
 
	mawupf
;

78 
__u8
 
	mnvscc
;

79 
__u8
 
	mrsvd531
;

80 
__Ë16
 
	macwu
;

81 
__u8
 
	mrsvd534
[2];

82 
__Ë32
 
	msgls
;

83 
__u8
 
	mrsvd540
[1508];

84 
nvme_id_pow”_¡©e
 
	mpsd
[32];

85 
__u8
 
	mvs
[1024];

89 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

90 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

91 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

92 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

95 
	snvme_lbaf
 {

96 
__Ë16
 
	mms
;

97 
__u8
 
	mds
;

98 
__u8
 
	m½
;

101 
	snvme_id_ns
 {

102 
__Ë64
 
	mnsze
;

103 
__Ë64
 
	mnÿp
;

104 
__Ë64
 
	mnu£
;

105 
__u8
 
	mnsã©
;

106 
__u8
 
	mÆbaf
;

107 
__u8
 
	mæbas
;

108 
__u8
 
	mmc
;

109 
__u8
 
	mdpc
;

110 
__u8
 
	mdps
;

111 
__u8
 
	mnmic
;

112 
__u8
 
	m»sÿp
;

113 
__u8
 
	måi
;

114 
__u8
 
	mrsvd33
;

115 
__Ë16
 
	mÇwun
;

116 
__Ë16
 
	mÇwupf
;

117 
__Ë16
 
	mÇcwu
;

118 
__Ë16
 
	mÇb¢
;

119 
__Ë16
 
	mÇbo
;

120 
__Ë16
 
	mÇb¥f
;

121 
__u16
 
	mrsvd46
;

122 
__Ë64
 
	mnvmÿp
[2];

123 
__u8
 
	mrsvd64
[40];

124 
__u8
 
	mnguid
[16];

125 
__u8
 
	meui64
[8];

126 
nvme_lbaf
 
	mlbaf
[16];

127 
__u8
 
	mrsvd192
[192];

128 
__u8
 
	mvs
[3712];

132 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

133 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

134 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

135 
	mNVME_LBAF_RP_BEST
 = 0,

136 
	mNVME_LBAF_RP_BETTER
 = 1,

137 
	mNVME_LBAF_RP_GOOD
 = 2,

138 
	mNVME_LBAF_RP_DEGRADED
 = 3,

139 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

140 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

141 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

142 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

143 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

144 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

145 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

146 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

147 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

148 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

151 
	snvme_sm¬t_log
 {

152 
__u8
 
	mü™iÿl_w¬nšg
;

153 
__u8
 
	m‹m³¿tu»
[2];

154 
__u8
 
	mava_¥¬e
;

155 
__u8
 
	m¥¬e_th»sh
;

156 
__u8
 
	m³rûÁ_u£d
;

157 
__u8
 
	mrsvd6
[26];

158 
__u8
 
	md©a_un™s_»ad
[16];

159 
__u8
 
	md©a_un™s_wr™‹n
[16];

160 
__u8
 
	mho¡_»ads
[16];

161 
__u8
 
	mho¡_wr™es
[16];

162 
__u8
 
	mù¾_busy_time
[16];

163 
__u8
 
	mpow”_cyşes
[16];

164 
__u8
 
	mpow”_Ú_hours
[16];

165 
__u8
 
	mun§ã_shutdowns
[16];

166 
__u8
 
	mmedŸ_”rÜs
[16];

167 
__u8
 
	mnum_”r_log_’Œ›s
[16];

168 
__Ë32
 
	mw¬nšg_‹mp_time
;

169 
__Ë32
 
	mü™iÿl_comp_time
;

170 
__Ë16
 
	m‹mp_£nsÜ
[8];

171 
__u8
 
	mrsvd216
[296];

175 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

176 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

177 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

178 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

179 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

183 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

186 
	snvme_lba_¿nge_ty³
 {

187 
__u8
 
	mty³
;

188 
__u8
 
	m©Œibu‹s
;

189 
__u8
 
	mrsvd2
[14];

190 
__u64
 
	m¦ba
;

191 
__u64
 
	mÆb
;

192 
__u8
 
	mguid
[16];

193 
__u8
 
	mrsvd48
[16];

197 
	mNVME_LBART_TYPE_FS
 = 0x01,

198 
	mNVME_LBART_TYPE_RAID
 = 0x02,

199 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

200 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

202 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

203 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

206 
	snvme_»£rv©iÚ_¡©us
 {

207 
__Ë32
 
	mg’
;

208 
__u8
 
	m¹y³
;

209 
__u8
 
	m»gùl
[2];

210 
__u8
 
	m»sv5
[2];

211 
__u8
 
	m±¶s
;

212 
__u8
 
	m»sv10
[13];

214 
__Ë16
 
	múid
;

215 
__u8
 
	mrc¡s
;

216 
__u8
 
	m»sv3
[5];

217 
__Ë64
 
	mho¡id
;

218 
__Ë64
 
	mrkey
;

219 } 
	m»gùl_ds
[];

224 
	envme_İcode
 {

225 
	mnvme_cmd_æush
 = 0x00,

226 
	mnvme_cmd_wr™e
 = 0x01,

227 
	mnvme_cmd_»ad
 = 0x02,

228 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

229 
	mnvme_cmd_com·»
 = 0x05,

230 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

231 
	mnvme_cmd_dsm
 = 0x09,

232 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

233 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

234 
	mnvme_cmd_»sv_acquœe
 = 0x11,

235 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

237 
	mnvme_cmd_kv_¡Üe
 = 0x81,

238 
	mnvme_cmd_kv_­³nd
 = 0x83,

239 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

240 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

241 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

242 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

243 
	mnvme_cmd_kv_exi¡
 = 0xB3,

248 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

249 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

250 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

251 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

252 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

253 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

254 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

255 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

256 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

257 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

258 
	`is_kv_exi¡_cmd
(
İcode
))

	)

259 
	#kv_nvme_is_wr™e
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(İcode))

	)

262 
	snvme_commÚ_commªd
 {

263 
__u8
 
	mİcode
;

264 
__u8
 
	mæags
;

265 
__u16
 
	mcommªd_id
;

266 
__Ë32
 
	mnsid
;

267 
__Ë32
 
	mcdw2
[2];

268 
__Ë64
 
	mm‘ad©a
;

269 
__Ë64
 
	m´p1
;

270 
__Ë64
 
	m´p2
;

271 
__Ë32
 
	mcdw10
[6];

274 
	snvme_rw_commªd
 {

275 
__u8
 
	mİcode
;

276 
__u8
 
	mæags
;

277 
__u16
 
	mcommªd_id
;

278 
__Ë32
 
	mnsid
;

279 
__u64
 
	mrsvd2
;

280 
__Ë64
 
	mm‘ad©a
;

281 
__Ë64
 
	m´p1
;

282 
__Ë64
 
	m´p2
;

283 
__Ë64
 
	m¦ba
;

284 
__Ë16
 
	mËngth
;

285 
__Ë16
 
	mcÚŒŞ
;

286 
__Ë32
 
	mdsmgmt
;

287 
__Ë32
 
	m»áag
;

288 
__Ë16
 
	m­±ag
;

289 
__Ë16
 
	m­pmask
;

293 
	snvme_kv_¡Üe_commªd
 {

294 
__u8
 
	mİcode
;

295 
__u8
 
	mæags
;

296 
__u16
 
	mcommªd_id
;

297 
__Ë32
 
	mnsid
;

298 
__u64
 
	mrsvd
;

299 
__Ë32
 
	moff£t
;

300 
__u32
 
	mrsvd2
;

301 
__Ë64
 
	m´p1
;

302 
__Ë64
 
	m´p2
;

303 
__Ë32
 
	mv®ue_Ën
;

304 
__u8
 
	mkey_Ën
;

305 
__u8
 
	mİtiÚ
;

306 
__u8
 
	mšv®id_by‹
:2;

307 
__u8
 
	mrsvd3
:6;

308 
__u8
 
	mrsvd4
;

311 
	mkey
[16];

314 
__Ë64
 
	mkey_´p
;

315 
__Ë64
 
	mkey_´p2
;

320 
	snvme_kv_­³nd_commªd
 {

321 
__u8
 
	mİcode
;

322 
__u8
 
	mæags
;

323 
__u16
 
	mcommªd_id
;

324 
__Ë32
 
	mnsid
;

325 
__u64
 
	mrsvd
;

326 
__Ë32
 
	moff£t
;

327 
__u32
 
	mrsvd2
;

328 
__Ë64
 
	m´p1
;

329 
__Ë64
 
	m´p2
;

330 
__Ë32
 
	mv®ue_Ën
;

331 
__u8
 
	mkey_Ën
;

332 
__u8
 
	mİtiÚ
;

333 
__u8
 
	mšv®id_by‹
:2;

334 
__u8
 
	mrsvd3
:6;

335 
__u8
 
	mrsvd4
;

338 
	mkey
[16];

341 
__Ë64
 
	mkey_´p
;

342 
__Ë64
 
	mkey_´p2
;

347 
	snvme_kv_»Œ›ve_commªd
 {

348 
__u8
 
	mİcode
;

349 
__u8
 
	mæags
;

350 
__u16
 
	mcommªd_id
;

351 
__Ë32
 
	mnsid
;

352 
__u64
 
	mrsvd
;

353 
__Ë32
 
	moff£t
;

354 
__u32
 
	mrsvd2
;

355 
__Ë64
 
	m´p1
;

356 
__Ë64
 
	m´p2
;

357 
__Ë32
 
	mv®ue_Ën
;

358 
__u8
 
	mkey_Ën
;

359 
__u8
 
	mİtiÚ
;

360 
__u16
 
	mrsvd3
;

363 
	mkey
[16];

366 
__Ë64
 
	mkey_´p
;

367 
__Ë64
 
	mkey_´p2
;

372 
	snvme_kv_d–‘e_commªd
 {

373 
__u8
 
	mİcode
;

374 
__u8
 
	mæags
;

375 
__u16
 
	mcommªd_id
;

376 
__Ë32
 
	mnsid
;

377 
__u64
 
	mrsvd
;

378 
__Ë32
 
	moff£t
;

379 
__u32
 
	mrsvd2
;

380 
__u64
 
	mrsvd3
[2];

381 
__Ë32
 
	mv®ue_Ën
;

382 
__u8
 
	mkey_Ën
;

383 
__u8
 
	mİtiÚ
;

384 
__u16
 
	mrsvd4
;

387 
	mkey
[16];

390 
__Ë64
 
	mkey_´p
;

391 
__Ë64
 
	mkey_´p2
;

396 
	snvme_kv_exi¡_commªd
 {

397 
__u8
 
	mİcode
;

398 
__u8
 
	mæags
;

399 
__u16
 
	mcommªd_id
;

400 
__Ë32
 
	mnsid
;

401 
__u64
 
	mrsvd
;

402 
__Ë32
 
	moff£t
;

403 
__u32
 
	mrsvd2
;

404 
__u64
 
	mrsvd3
[2];

405 
__Ë32
 
	mv®ue_Ën
;

406 
__u8
 
	mkey_Ën
;

407 
__u8
 
	mİtiÚ
;

408 
__u16
 
	mrsvd4
;

411 
	mkey
[16];

414 
__Ë64
 
	mkey_´p
;

415 
__Ë64
 
	mkey_´p2
;

421 
	snvme_kv_™”_»q_commªd
 {

422 
__u8
 
	mİcode
;

423 
__u8
 
	mæags
;

424 
__u16
 
	mcommªd_id
;

425 
__Ë32
 
	mnsid
;

426 
__u64
 
	mrsvd
[4];

427 
__Ë32
 
	mz”o
;

428 
__u8
 
	m™”_hªdË
;

429 
__u8
 
	mİtiÚ
;

430 
__u16
 
	mrsvd2
;

431 
__Ë32
 
	m™”_v®
;

432 
__Ë32
 
	m™”_b™mask
;

433 
__u64
 
	mrsvd3
;

437 
	snvme_kv_™”_»ad_commªd
 {

438 
__u8
 
	mİcode
;

439 
__u8
 
	mæags
;

440 
__u16
 
	mcommªd_id
;

441 
__Ë32
 
	mnsid
;

442 
__u64
 
	mrsvd
[2];

443 
__Ë64
 
	m´p1
;

444 
__Ë64
 
	m´p2
;

445 
__Ë32
 
	mv®ue_Ën
;

446 
__u8
 
	m™”_hªdË
;

447 
__u8
 
	mİtiÚ
;

448 
__u16
 
	mrsvd2
;

449 
__u64
 
	mrsvd3
[2];

455 
	mNVME_RW_LR
 = 1 << 15,

456 
	mNVME_RW_FUA
 = 1 << 14,

457 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

458 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

459 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

460 
	mNVME_RW_DSM_FREQ_READS
 = 3,

461 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

462 
	mNVME_RW_DSM_FREQ_RW
 = 5,

463 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

464 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

465 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

466 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

467 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

468 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

469 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

470 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

471 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

472 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

473 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

474 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

475 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

478 
	snvme_dsm_cmd
 {

479 
__u8
 
	mİcode
;

480 
__u8
 
	mæags
;

481 
__u16
 
	mcommªd_id
;

482 
__Ë32
 
	mnsid
;

483 
__u64
 
	mrsvd2
[2];

484 
__Ë64
 
	m´p1
;

485 
__Ë64
 
	m´p2
;

486 
__Ë32
 
	mÄ
;

487 
__Ë32
 
	m©Œibu‹s
;

488 
__u32
 
	mrsvd12
[4];

492 
	mNVME_DSMGMT_IDR
 = 1 << 0,

493 
	mNVME_DSMGMT_IDW
 = 1 << 1,

494 
	mNVME_DSMGMT_AD
 = 1 << 2,

497 
	snvme_dsm_¿nge
 {

498 
__Ë32
 
	mÿ‰r
;

499 
__Ë32
 
	mÆb
;

500 
__Ë64
 
	m¦ba
;

505 
	envme_admš_İcode
 {

506 
	mnvme_admš_d–‘e_sq
 = 0x00,

507 
	mnvme_admš_ü—‹_sq
 = 0x01,

508 
	mnvme_admš_g‘_log_·ge
 = 0x02,

509 
	mnvme_admš_d–‘e_cq
 = 0x04,

510 
	mnvme_admš_ü—‹_cq
 = 0x05,

511 
	mnvme_admš_id’tify
 = 0x06,

512 
	mnvme_admš_abÜt_cmd
 = 0x08,

513 
	mnvme_admš_£t_ã©u»s
 = 0x09,

514 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

515 
	mnvme_admš_async_ev’t
 = 0x0c,

516 
	mnvme_admš_aùiv©e_fw
 = 0x10,

517 
	mnvme_admš_dowÆßd_fw
 = 0x11,

518 
	mnvme_admš_fÜm©_nvm
 = 0x80,

519 
	mnvme_admš_£cur™y_£nd
 = 0x81,

520 
	mnvme_admš_£cur™y_»cv
 = 0x82,

524 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

525 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

526 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

527 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

528 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

529 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

530 
	mNVME_FEAT_ARBITRATION
 = 0x01,

531 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

532 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

533 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

534 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

535 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

536 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

537 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

538 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

539 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

540 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

541 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

542 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

543 
	mNVME_FEAT_HOST_ID
 = 0x81,

544 
	mNVME_FEAT_RESV_MASK
 = 0x82,

545 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

546 
	mNVME_LOG_ERROR
 = 0x01,

547 
	mNVME_LOG_SMART
 = 0x02,

548 
	mNVME_LOG_FW_SLOT
 = 0x03,

549 
	mNVME_LOG_RESERVATION
 = 0x80,

550 
	mNVME_FWACT_REPL
 = (0 << 3),

551 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

552 
	mNVME_FWACT_ACTV
 = (2 << 3),

555 
	snvme_id’tify
 {

556 
__u8
 
	mİcode
;

557 
__u8
 
	mæags
;

558 
__u16
 
	mcommªd_id
;

559 
__Ë32
 
	mnsid
;

560 
__u64
 
	mrsvd2
[2];

561 
__Ë64
 
	m´p1
;

562 
__Ë64
 
	m´p2
;

563 
__Ë32
 
	mús
;

564 
__u32
 
	mrsvd11
[5];

567 
	snvme_ã©u»s
 {

568 
__u8
 
	mİcode
;

569 
__u8
 
	mæags
;

570 
__u16
 
	mcommªd_id
;

571 
__Ë32
 
	mnsid
;

572 
__u64
 
	mrsvd2
[2];

573 
__Ë64
 
	m´p1
;

574 
__Ë64
 
	m´p2
;

575 
__Ë32
 
	mfid
;

576 
__Ë32
 
	mdwÜd11
;

577 
__u32
 
	mrsvd12
[4];

580 
	snvme_ü—‹_cq
 {

581 
__u8
 
	mİcode
;

582 
__u8
 
	mæags
;

583 
__u16
 
	mcommªd_id
;

584 
__u32
 
	mrsvd1
[5];

585 
__Ë64
 
	m´p1
;

586 
__u64
 
	mrsvd8
;

587 
__Ë16
 
	mcqid
;

588 
__Ë16
 
	mqsize
;

589 
__Ë16
 
	mcq_æags
;

590 
__Ë16
 
	mœq_veùÜ
;

591 
__u32
 
	mrsvd12
[4];

594 
	snvme_ü—‹_sq
 {

595 
__u8
 
	mİcode
;

596 
__u8
 
	mæags
;

597 
__u16
 
	mcommªd_id
;

598 
__u32
 
	mrsvd1
[5];

599 
__Ë64
 
	m´p1
;

600 
__u64
 
	mrsvd8
;

601 
__Ë16
 
	msqid
;

602 
__Ë16
 
	mqsize
;

603 
__Ë16
 
	msq_æags
;

604 
__Ë16
 
	mcqid
;

605 
__u32
 
	mrsvd12
[4];

608 
	snvme_d–‘e_queue
 {

609 
__u8
 
	mİcode
;

610 
__u8
 
	mæags
;

611 
__u16
 
	mcommªd_id
;

612 
__u32
 
	mrsvd1
[9];

613 
__Ë16
 
	mqid
;

614 
__u16
 
	mrsvd10
;

615 
__u32
 
	mrsvd11
[5];

618 
	snvme_abÜt_cmd
 {

619 
__u8
 
	mİcode
;

620 
__u8
 
	mæags
;

621 
__u16
 
	mcommªd_id
;

622 
__u32
 
	mrsvd1
[9];

623 
__Ë16
 
	msqid
;

624 
__Ë16
 
	mcid
;

625 
__u32
 
	mrsvd11
[5];

628 
	snvme_dowÆßd_fœmw¬e
 {

629 
__u8
 
	mİcode
;

630 
__u8
 
	mæags
;

631 
__u16
 
	mcommªd_id
;

632 
__u32
 
	mrsvd1
[5];

633 
__Ë64
 
	m´p1
;

634 
__Ë64
 
	m´p2
;

635 
__Ë32
 
	mnumd
;

636 
__Ë32
 
	moff£t
;

637 
__u32
 
	mrsvd12
[4];

640 
	snvme_fÜm©_cmd
 {

641 
__u8
 
	mİcode
;

642 
__u8
 
	mæags
;

643 
__u16
 
	mcommªd_id
;

644 
__Ë32
 
	mnsid
;

645 
__u64
 
	mrsvd2
[4];

646 
__Ë32
 
	mcdw10
;

647 
__u32
 
	mrsvd11
[5];

650 
	snvme_commªd
 {

652 
nvme_commÚ_commªd
 
	mcommÚ
;

653 
nvme_rw_commªd
 
	mrw
;

654 
nvme_id’tify
 
	mid’tify
;

655 
nvme_ã©u»s
 
	mã©u»s
;

656 
nvme_ü—‹_cq
 
	mü—‹_cq
;

657 
nvme_ü—‹_sq
 
	mü—‹_sq
;

658 
nvme_d–‘e_queue
 
	md–‘e_queue
;

659 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

660 
nvme_fÜm©_cmd
 
	mfÜm©
;

661 
nvme_dsm_cmd
 
	mdsm
;

662 
nvme_abÜt_cmd
 
	mabÜt
;

664 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

665 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

666 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

667 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

668 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

669 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

670 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

676 
	mNVME_SC_SUCCESS
 = 0x0,

677 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

678 
	mNVME_SC_INVALID_FIELD
 = 0x2,

679 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

680 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

681 
	mNVME_SC_POWER_LOSS
 = 0x5,

682 
	mNVME_SC_INTERNAL
 = 0x6,

683 
	mNVME_SC_ABORT_REQ
 = 0x7,

684 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

685 
	mNVME_SC_FUSED_FAIL
 = 0x9,

686 
	mNVME_SC_FUSED_MISSING
 = 0xa,

687 
	mNVME_SC_INVALID_NS
 = 0xb,

688 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

689 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

690 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

691 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

692 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

693 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

694 
	mNVME_SC_LBA_RANGE
 = 0x80,

695 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

696 
	mNVME_SC_NS_NOT_READY
 = 0x82,

697 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

698 
	mNVME_SC_CQ_INVALID
 = 0x100,

699 
	mNVME_SC_QID_INVALID
 = 0x101,

700 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

701 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

702 
	mNVME_SC_ABORT_MISSING
 = 0x104,

703 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

704 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

705 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

706 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

707 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

708 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

709 
	mNVME_SC_FIRMWARE_NEEDS_RESET
 = 0x10b,

710 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

711 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

712 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

713 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

714 
	mNVME_SC_FW_NEEDS_RESET_SUBSYS
 = 0x110,

715 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

716 
	mNVME_SC_INVALID_PI
 = 0x181,

717 
	mNVME_SC_READ_ONLY
 = 0x182,

718 
	mNVME_SC_WRITE_FAULT
 = 0x280,

719 
	mNVME_SC_READ_ERROR
 = 0x281,

720 
	mNVME_SC_GUARD_CHECK
 = 0x282,

721 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

722 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

723 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

724 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

725 
	mNVME_SC_DNR
 = 0x4000,

728 
	snvme_com¶‘iÚ
 {

729 
__Ë32
 
	m»suÉ
;

730 
__u32
 
	mrsvd
;

731 
__Ë16
 
	msq_h—d
;

732 
__Ë16
 
	msq_id
;

733 
__u16
 
	mcommªd_id
;

734 
__Ë16
 
	m¡©us
;

737 
	snvme_u£r_io
 {

738 
__u8
 
	mİcode
;

739 
__u8
 
	mæags
;

740 
__u16
 
	mcÚŒŞ
;

741 
__u16
 
	mnblocks
;

742 
__u16
 
	mrsvd
;

743 
__u64
 
	mm‘ad©a
;

744 
__u64
 
	maddr
;

745 
__u64
 
	m¦ba
;

746 
__u32
 
	mdsmgmt
;

747 
__u32
 
	m»áag
;

748 
__u16
 
	m­±ag
;

749 
__u16
 
	m­pmask
;

752 
	snvme_·s¡hru_cmd
 {

753 
__u8
 
	mİcode
;

754 
__u8
 
	mæags
;

755 
__u16
 
	mrsvd1
;

756 
__u32
 
	mnsid
;

757 
__u32
 
	mcdw2
;

758 
__u32
 
	mcdw3
;

759 
__u64
 
	mm‘ad©a
;

760 
__u64
 
	maddr
;

761 
__u32
 
	mm‘ad©a_Ën
;

762 
__u32
 
	md©a_Ën
;

763 
__u32
 
	mcdw10
;

764 
__u32
 
	mcdw11
;

765 
__u32
 
	mcdw12
;

766 
__u32
 
	mcdw13
;

767 
__u32
 
	mcdw14
;

768 
__u32
 
	mcdw15
;

769 
__u32
 
	mtimeout_ms
;

770 
__u32
 
	m»suÉ
;

773 
	#NVME_VS
(
majÜ
, 
mšÜ
è(((majÜè<< 16è| ((mšÜè<< 8))

	)

775 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

777 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

778 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

779 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

780 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

781 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

785 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

786 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

787 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

789 
	#KVS_SUCCESS
 0

	)

790 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

791 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

792 
	#KVS_ERR_CLOSE
 (-3)

	)

793 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

794 
	#KVS_ERR_CONT_NAME
 (-5)

	)

795 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

796 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

797 
	#KVS_ERR_GROUP
 (-8)

	)

798 
	#KVS_ERR_INDEX
 (-9)

	)

799 
	#KVS_ERR_IO
 (-10)

	)

800 
	#KVS_ERR_KEY
 (-11)

	)

801 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

802 
	#KVS_ERR_MEMORY
 (-13)

	)

803 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

804 
	#KVS_ERR_OFFSET
 (-15)

	)

805 
	#KVS_ERR_OPEN
 (-16)

	)

806 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

807 
	#KVS_ERR_PERMISSION
 (-18)

	)

808 
	#KVS_ERR_SPACE
 (-19)

	)

809 
	#KVS_ERR_TIMEOUT
 (-20)

	)

810 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

811 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

812 
	#KVS_ERR_VALUE
 (-23)

	)

817 
	snvme_·s¡hru_kv_cmd
 {

818 
__u8
 
	mİcode
;

819 
__u8
 
	mæags
;

820 
__u16
 
	mrsvd1
;

821 
__u32
 
	mnsid
;

822 
__u32
 
	mcdw2
;

823 
__u32
 
	mcdw3
;

824 
__u32
 
	mcdw4
;

825 
__u32
 
	mcdw5
;

826 
__u64
 
	md©a_addr
;

827 
__u32
 
	md©a_Ëngth
;

828 
__u32
 
	mkey_Ëngth
;

829 
__u32
 
	mcdw10
;

830 
__u32
 
	mcdw11
;

833 
__u64
 
	mkey_addr
;

834 
__u32
 
	mrsvd5
;

835 
__u32
 
	mrsvd6
;

837 
__u8
 
	mkey
[16];

839 
__u32
 
	mcdw12
;

840 
__u32
 
	mcdw13
;

841 
__u32
 
	mcdw14
;

842 
__u32
 
	mcdw15
;

845 
__u32
 
	mtimeout_ms
;

846 
__u32
 
	m»suÉ
;

847 
__u32
 
	m¡©us
;

848 
__u32
 
	mùxid
;

849 
__u64
 
	m»qid
;

852 
	snvme_aioùx
 {

853 
__u32
 
	mùxid
;

854 
__u32
 
	mev’tfd
;

858 
	snvme_aiÛv’t
 {

859 
__u64
 
	m»qid
;

860 
__u32
 
	mùxid
;

861 
__u32
 
	m»suÉ
;

862 
__u16
 
	m¡©us
;

865 
	#MAX_AIO_EVENTS
 128

	)

866 
	snvme_aiÛv’ts
 {

867 
__u16
 
	mÄ
;

868 
__u32
 
	mùxid
;

869 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

872 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

873 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

874 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

875 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

876 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/nvme-core.c

15 
	~"nvme.h
"

17 
	~<lšux/nvme.h
>

19 
	~<lšux/b™İs.h
>

20 
	~<lšux/blkdev.h
>

21 
	~<lšux/blk-mq.h
>

22 
	~<lšux/ıu.h
>

23 
	~<lšux/d–ay.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/fs.h
>

26 
	~<lšux/g’hd.h
>

27 
	~<lšux/hd»g.h
>

28 
	~<lšux/idr.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/š‹¼u±.h
>

31 
	~<lšux/io.h
>

32 
	~<lšux/kdev_t.h
>

33 
	~<lšux/kth»ad.h
>

34 
	~<lšux/k”Ãl.h
>

35 
	~<lšux/li¡_sÜt.h
>

36 
	~<lšux/mm.h
>

37 
	~<lšux/moduË.h
>

38 
	~<lšux/moduË·¿m.h
>

39 
	~<lšux/pci.h
>

40 
	~<lšux/poisÚ.h
>

41 
	~<lšux/±¿û.h
>

42 
	~<lšux/sched.h
>

43 
	~<lšux/¦ab.h
>

44 
	~<lšux/ty³s.h
>

45 
	~<scsi/sg.h
>

46 
	~<asm-g’”ic/io-64-nÚ©omic-lo-hi.h
>

49 
	~<lšux/fe.h
>

50 
	~<lšux/fdbË.h
>

51 
	~<lšux/ev’tfd.h
>

52 
	~<lšux/k»f.h
>

55 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

56 
	#NVME_Q_DEPTH
 1024

	)

57 
	#NVME_AQ_DEPTH
 256

	)

58 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

59 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

60 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

61 
	#SHUTDOWN_TIMEOUT
 (
shutdown_timeout
 * 
HZ
)

	)

63 
	gadmš_timeout
 = 60;

64 
moduË_·¿m
(
admš_timeout
, 
by‹
, 0644);

65 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

67 
	gnvme_io_timeout
 = 30;

68 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
by‹
, 0644);

69 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

71 
	gshutdown_timeout
 = 5;

72 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

73 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

75 
	gnvme_majÜ
;

76 
moduË_·¿m
(
nvme_majÜ
, , 0);

78 
	gnvme_ch¬_majÜ
;

79 
moduË_·¿m
(
nvme_ch¬_majÜ
, , 0);

81 
	gu£_th»aded_š‹¼u±s
;

82 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

84 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

85 
LIST_HEAD
(
dev_li¡
);

86 
sk_¡ruù
 *
	gnvme_th»ad
;

87 
wÜkqueue_¡ruù
 *
	gnvme_wÜkq
;

88 
wa™_queue_h—d_t
 
	gnvme_kth»ad_wa™
;

90 
şass
 *
	gnvme_şass
;

92 
nvme_»£t_çed_dev
(
wÜk_¡ruù
 *
ws
);

93 
nvme_»£t
(
nvme_dev
 *
dev
);

94 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

96 
	sasync_cmd_šfo
 {

97 
kth»ad_wÜk
 
	mwÜk
;

98 
kth»ad_wÜk”
 *
	mwÜk”
;

99 
»que¡
 *
	m»q
;

100 
u32
 
	m»suÉ
;

101 
	m¡©us
;

102 *
	mùx
;

109 
	snvme_queue
 {

110 
deviû
 *
	mq_dmadev
;

111 
nvme_dev
 *
	mdev
;

112 
	mœqÇme
[24];

113 
¥šlock_t
 
	mq_lock
;

114 
nvme_commªd
 *
	msq_cmds
;

115 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

116 
blk_mq_gs
 **
	mgs
;

117 
dma_addr_t
 
	msq_dma_addr
;

118 
dma_addr_t
 
	mcq_dma_addr
;

119 
u32
 
__iomem
 *
	mq_db
;

120 
u16
 
	mq_d•th
;

121 
s16
 
	mcq_veùÜ
;

122 
u16
 
	msq_h—d
;

123 
u16
 
	msq_
;

124 
u16
 
	mcq_h—d
;

125 
u16
 
	mqid
;

126 
u8
 
	mcq_pha£
;

127 
u8
 
	mcqe_£’
;

128 
async_cmd_šfo
 
	mcmdšfo
;

134 
šlše
 
	$_nvme_check_size
()

136 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

137 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

138 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

139 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

140 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

141 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

142 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

143 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

144 
	`BUILD_BUG_ON
((
nvme_id_ù¾
) != 4096);

145 
	`BUILD_BUG_ON
((
nvme_id_ns
) != 4096);

146 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

147 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

148 
	}
}

150 (*
	tnvme_com¶‘iÚ_â
)(
	tnvme_queue
 *, *,

151 
	tnvme_com¶‘iÚ
 *);

153 
	snvme_cmd_šfo
 {

154 
nvme_com¶‘iÚ_â
 
â
;

155 *
ùx
;

156 
abÜ‹d
;

157 
nvme_queue
 *
nvmeq
;

158 
nvme_iod
 
iod
[0];

166 
kmem_ÿche
 *
kaioùx_ÿch•
 = 0;

167 
kmem_ÿche
 *
kaiocb_ÿch•
 = 0;

168 
mempoŞ_t
 *
kaiocb_mempoŞ
 = 0;

169 
mempoŞ_t
 *
kaioùx_mempoŞ
 = 0;

171 
__u32
 
aio_cÚ‹xt_id
;

173 
	#AIOCTX_MAX
 1024

	)

174 
	#AIOCB_MAX
 (1024*64)

	)

176 
__u64
 
debug_com¶‘ed
 =0;

177 
debug_out¡ªdšg
 =0;

179 
	snvme_kaioùx


181 
nvme_aioùx
 
uùx
;

182 
ev’tfd_ùx
 *
ev’tùx
;

183 
li¡_h—d
 
kaiocb_li¡
;

184 
¥šlock_t
 
kaioùx_¥šlock
;

185 
k»f
 
»f
;

188 
nvme_kaioùx
 **
g_kaioùx_tb
 = 
NULL
;

189 
¥šlock_t
 
g_kaioùx_tb_¥šlock
;

192 
	saio_u£r_ùx
 {

193 
ÃÁs
;

194 
Ën
;

195 
·ge
 ** 
·ges
;

196 
sÿ‰”li¡
 *
sg
;

197 
d©a
[1];

200 
	snvme_kaiocb


202 
li¡_h—d
 
aiocb_li¡
;

203 
nvme_aiÛv’t
 
ev’t
;

204 
»que¡
* 
»q
;

205 
İcode
;

206 
boŞ
 
u£_m‘a
;

207 
nvme_iod
 *
iod
;

208 
sÿ‰”li¡
 
m‘a_sg
;

209 *
m‘a
;

210 *
kv_d©a
;

211 
aio_u£r_ùx
 *
u£r_ùx
;

214 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

216 
nvme_kaiocb
 *
tmpcb
;

217 
li¡_h—d
 *
pos
, *
q
;

218 
æags
;

219 ià(
ùx
) {

220 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

221 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

222 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

223 
	`li¡_d–
(
pos
);

224 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

226 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

227 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

228 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

230 
	}
}

232 
	$ş—nup_kaioùx
(
k»f
 *kref) {

233 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

234 
	`»move_kaioùx
(
ùx
);

235 
	}
}

237 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

238 
	`k»f_g‘
(&
ùx
->
»f
);

239 
	}
}

241 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

242 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

243 
	}
}

248 
	$de¡roy_aio_mempoŞ
()

250 
i
 = 0;

251 ià(
g_kaioùx_tb
) {

252 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

253 ià(
g_kaioùx_tb
[
i
]) {

254 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

255 
g_kaioùx_tb
[
i
] = 
NULL
;

258 
	`kä“
(
g_kaioùx_tb
);

259 
g_kaioùx_tb
 = 
NULL
;

261 ià(
kaiocb_mempoŞ
)

262 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

263 ià(
kaioùx_mempoŞ
)

264 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

265 ià(
kaioùx_ÿch•
)

266 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

267 ià(
kaiocb_ÿch•
)

268 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

269 
	}
}

274 
	$aio_£rviû_š™
()

276 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

277 ià(!
g_kaioùx_tb
)

278 
ç
;

279 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

282 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

283 ià(!
kaioùx_ÿch•
)

284 
ç
;

286 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

287 ià(!
kaiocb_ÿch•
)

288 
ç
;

290 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

291 ià(!
kaiocb_mempoŞ
)

292 
ç
;

294 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

295 ià(!
kaioùx_mempoŞ
)

296 
ç
;

300 
aio_cÚ‹xt_id
 = 1;

301 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

302 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

305 
ç
:

306 
	`de¡roy_aio_mempoŞ
();

307  -
ENOMEM
;

308 
	}
}

313 
	$aio_£rviû_ex™
()

315 
	`de¡roy_aio_mempoŞ
();

316 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

318 
	}
}

320 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

321 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

324 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

325 ià(
tmp
è
	`»f_kaioùx
(tmp);

327  
tmp
;

328 
	}
}

334 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

336 
nvme_kaioùx
 *
tmp
;

337 
æags
;

338 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

339 ià(
tmp
) {

340 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

341 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

342 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

344 
	`´štk
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

346 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

347 
	`d”ef_kaioùx
(
tmp
);

351 
	`´štk
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

356 
	}
}

362 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

364 
nvme_kaioùx
 
ùx
;

365 
æags
;

366 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

367  -
EFAULT
;

369 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

370 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

371 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

372 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

374 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

376 
	}
}

382 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

384 
nvme_kaioùx
 *
ùx
;

385 
fd
 
efe
;

386 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

387 
æags
;

388 
»t
 = 0;

389 
i
 = 0;

390 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

391  -
EACCES
;

393 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

394 ià(!
ùx
)

395  -
ENOMEM
;

397 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

398  -
EFAULT
;

400 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

401 ià(!
efe
.
fe
) {

402 
	`´štk
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

403 
»t
 = -
EBADF
;

404 
ex™
;

407 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

408 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

409 
	`´štk
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

410 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

411 
put_efe
;

414 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

415 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

416 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

417 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

418 
aio_cÚ‹xt_id
 = 
i
;

422 ià(
i
 >ğ
AIOCTX_MAX
) {

423 
	`´štk
("nvme_set_aioctx:oo many‡ioctx open.\n");

424 
»t
 = -
EMFILE
;

425 
put_ev’t_fd
;

428 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

429 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

430 
aio_cÚ‹xt_id
 = 0;

431 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

432 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

433 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

434 
	`k»f_š™
(&
ùx
->
»f
);

435 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

436 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

438 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

440 
	`´štk
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

441 
»t
 = -
EINVAL
;

442 
ş—nup
;

444 
ev’tfd_ùx
 = 
NULL
;

445 
debug_out¡ªdšg
 = 0;

446 
debug_com¶‘ed
 = 0;

447 
	`fdput
(
efe
);

449 
ş—nup
:

450 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

451 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

452 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

453 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

454 
put_ev’t_fd
:

455 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

456 
put_efe
:

457 
	`fdput
(
efe
);

458 
ex™
:

459  
»t
;

460 
	}
}

464 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

465 
nvme_kaiocb
 *
»q
;

466 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

467 ià(!
»q
)  0;

469 
	`mem£t
(
»q
, 0, (*req));

471 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

473 
»q
->
ev’t
.
»qid
 =„eqid;

475  
»q
;

476 
	}
}

480 
	$nvme_g‘_aiÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

482 
li¡_h—d
 *
pos
, *
q
;

483 
nvme_kaiocb
 *
tmp
;

484 
nvme_kaioùx
 *
tmp_ùx
;

485 
æags
;

486 
	`LIST_HEAD
(
tmp_h—d
);

487 
__u16
 
couÁ
 =0;

488 
__u16
 
Ä
 = 0;

489 
__u32
 
ùxid
 = 0;

491 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

492  -
EACCES
;

494 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

496 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

498 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

500 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

501 ià(
tmp_ùx
) {

502 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

503 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

504 
	`li¡_d–_š™
(
pos
);

505 
	`li¡_add
(
pos
, &
tmp_h—d
);

506 
couÁ
++;

507 ià(
Ä
 =ğ
couÁ
) ;

509 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

510 
	`d”ef_kaioùx
(
tmp_ùx
);

511 
couÁ
 = 0;

512 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

513 
	`li¡_d–
(
pos
);

514 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

515 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

516 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

517 
couÁ
++;

520 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

523 
	}
}

526 
	$kv_async_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
, 
nvme_com¶‘iÚ
 *
cqe
){

527 
nvme_dev
* 
dev
 = 
nvmeq
->dev;

528 
nvme_kaiocb
 *
cmdšfo
 = (nvme_kaiocb *)
ùx
;

529 
cmdšfo
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

530 
cmdšfo
->
ev’t
.
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

531 
	`blk_mq_ä“_»que¡
(
cmdšfo
->
»q
);

532 ià(
cmdšfo
->
kv_d©a
 && cmdšfo->
u£r_ùx
) {

533 ià(
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_™”_»ad_cmd
(cmdinfo->opcode)) {

535 *
d©a
 = 
cmdšfo
->
kv_d©a
;

536 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

537 
d©a
[0], data[1], data[2], data[3],

538 
d©a
[4], data[5], data[6], data[7]);

540 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

541 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

545 ià(
cmdšfo
->
iod
) {

546 
	`nvme_unm­_u£r_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
cmdšfo
->
İcode
), cmdšfo->
iod
);

547 
	`nvme_ä“_iod
(
dev
, 
cmdšfo
->
iod
);

550 ià(
cmdšfo
->
u£r_ùx
) {

551 
i
 = 0;

552 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++)

553 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

554 
	`kä“
(
cmdšfo
->
u£r_ùx
);

556 ià(
cmdšfo
->
kv_d©a
è
	`kä“
(cmdinfo->kv_data);

558 ià(
cmdšfo
->
u£_m‘a
) {

559 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, &
cmdšfo
->
m‘a_sg
, 1, 
DMA_TO_DEVICE
);

560 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

561 ià(
cmdšfo
->
m‘a
) {

562 
	`kä“
(
cmdšfo
->
m‘a
);

566 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

567 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

569 
	}
}

577 
	#NVME_INT_PAGES
 2

	)

578 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
·ge_size
)

	)

579 
	#NVME_INT_MASK
 0x01

	)

586 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

588 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
·ge_size
, dev->page_size);

589  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

590 
	}
}

592 
	$nvme_cmd_size
(
nvme_dev
 *
dev
)

594 
»t
 = (
nvme_cmd_šfo
);

596 
»t
 +ğ(
nvme_iod
);

597 
»t
 +ğ(
__Ë64
 *è* 
	`nvme_Åages
(
	`NVME_INT_BYTES
(
dev
), dev);

598 
»t
 +ğ(
sÿ‰”li¡
è* 
NVME_INT_PAGES
;

600  
»t
;

601 
	}
}

603 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

604 
hùx_idx
)

606 
nvme_dev
 *
dev
 = 
d©a
;

607 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

609 
	`WARN_ON
(
hùx_idx
 != 0);

610 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

611 
	`WARN_ON
(
nvmeq
->
gs
);

613 
hùx
->
driv”_d©a
 = 
nvmeq
;

614 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

616 
	}
}

618 
	$nvme_admš_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

619 
hùx_idx
, 
rq_idx
,

620 
numa_node
)

622 
nvme_dev
 *
dev
 = 
d©a
;

623 
nvme_cmd_šfo
 *
cmd
 = 
	`blk_mq_rq_to_pdu
(
»q
);

624 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

626 
	`BUG_ON
(!
nvmeq
);

627 
cmd
->
nvmeq
 =‚vmeq;

629 
	}
}

631 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

632 
hùx_idx
)

634 
nvme_dev
 *
dev
 = 
d©a
;

635 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

637 ià(!
nvmeq
->
gs
)

638 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

640 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

641 
hùx
->
driv”_d©a
 = 
nvmeq
;

643 
	}
}

645 
	$nvme_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

646 
hùx_idx
, 
rq_idx
,

647 
numa_node
)

649 
nvme_dev
 *
dev
 = 
d©a
;

650 
nvme_cmd_šfo
 *
cmd
 = 
	`blk_mq_rq_to_pdu
(
»q
);

651 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

653 
	`BUG_ON
(!
nvmeq
);

654 
cmd
->
nvmeq
 =‚vmeq;

656 
	}
}

658 
	$nvme_£t_šfo
(
nvme_cmd_šfo
 *
cmd
, *
ùx
,

659 
nvme_com¶‘iÚ_â
 
hªdËr
)

661 
cmd
->
â
 = 
hªdËr
;

662 
cmd
->
ùx
 = ctx;

663 
cmd
->
abÜ‹d
 = 0;

664 
	`blk_mq_¡¬t_»que¡
(
	`blk_mq_rq_äom_pdu
(
cmd
));

665 
	}
}

667 *
	$iod_g‘_´iv©e
(
nvme_iod
 *
iod
)

669  (*è(
iod
->
´iv©e
 & ~0x1UL);

670 
	}
}

675 
boŞ
 
	$iod_should_kä“
(
nvme_iod
 *
iod
)

677  (
iod
->
´iv©e
 & 
NVME_INT_MASK
) == 0;

678 
	}
}

681 
	#CMD_CTX_BASE
 ((*)
POISON_POINTER_DELTA
)

	)

682 
	#CMD_CTX_CANCELLED
 (0x30C + 
CMD_CTX_BASE
)

	)

683 
	#CMD_CTX_COMPLETED
 (0x310 + 
CMD_CTX_BASE
)

	)

684 
	#CMD_CTX_INVALID
 (0x314 + 
CMD_CTX_BASE
)

	)

686 
	$¥ecŸl_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
,

687 
nvme_com¶‘iÚ
 *
cqe
)

689 ià(
ùx
 =ğ
CMD_CTX_CANCELLED
)

691 ià(
ùx
 =ğ
CMD_CTX_COMPLETED
) {

692 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

694 
cqe
->
commªd_id
, 
	`Ë16_to_ıup
(&cqe->
sq_id
));

697 ià(
ùx
 =ğ
CMD_CTX_INVALID
) {

698 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

700 
cqe
->
commªd_id
, 
	`Ë16_to_ıup
(&cqe->
sq_id
));

703 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "UnknowÀ¥ecŸÈcom¶‘iÚ %p\n", 
ùx
);

704 
	}
}

706 *
	$ÿnûl_cmd_šfo
(
nvme_cmd_šfo
 *
cmd
, 
nvme_com¶‘iÚ_â
 *
â
)

708 *
ùx
;

710 ià(
â
)

711 *
â
 = 
cmd
->fn;

712 
ùx
 = 
cmd
->ctx;

713 
cmd
->
â
 = 
¥ecŸl_com¶‘iÚ
;

714 
cmd
->
ùx
 = 
CMD_CTX_CANCELLED
;

715  
ùx
;

716 
	}
}

718 
	$async_»q_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
,

719 
nvme_com¶‘iÚ
 *
cqe
)

721 
u32
 
»suÉ
 = 
	`Ë32_to_ıup
(&
cqe
->result);

722 
u16
 
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

724 ià(
¡©us
 =ğ
NVME_SC_SUCCESS
 || stu =ğ
NVME_SC_ABORT_REQ
)

725 ++
nvmeq
->
dev
->
ev’t_lim™
;

726 ià(
¡©us
 !ğ
NVME_SC_SUCCESS
)

729 
»suÉ
 & 0xff07) {

730 
NVME_AER_NOTICE_NS_CHANGED
:

731 
	`dev_šfo
(
nvmeq
->
q_dmadev
, "rescanning\n");

732 
	`scheduË_wÜk
(&
nvmeq
->
dev
->
sÿn_wÜk
);

734 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

736 
	}
}

738 
	$abÜt_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
,

739 
nvme_com¶‘iÚ
 *
cqe
)

741 
»que¡
 *
»q
 = 
ùx
;

743 
u16
 
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

744 
u32
 
»suÉ
 = 
	`Ë32_to_ıup
(&
cqe
->result);

746 
	`blk_mq_ä“_»que¡
(
»q
);

748 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "AbÜˆ¡©us:%x„esuÉ:%x", 
¡©us
, 
»suÉ
);

749 ++
nvmeq
->
dev
->
abÜt_lim™
;

750 
	}
}

752 
	$async_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
,

753 
nvme_com¶‘iÚ
 *
cqe
)

755 
async_cmd_šfo
 *
cmdšfo
 = 
ùx
;

756 
cmdšfo
->
»suÉ
 = 
	`Ë32_to_ıup
(&
cqe
->result);

757 
cmdšfo
->
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

758 
	`queue_kth»ad_wÜk
(
cmdšfo
->
wÜk”
, &cmdšfo->
wÜk
);

759 
	`blk_mq_ä“_»que¡
(
cmdšfo
->
»q
);

760 
	}
}

762 
šlše
 
nvme_cmd_šfo
 *
	$g‘_cmd_äom_g
(
nvme_queue
 *
nvmeq
,

763 
g
)

765 
»que¡
 *
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
g
);

767  
	`blk_mq_rq_to_pdu
(
»q
);

768 
	}
}

773 *
	$nvme_fšish_cmd
(
nvme_queue
 *
nvmeq
, 
g
,

774 
nvme_com¶‘iÚ_â
 *
â
)

776 
nvme_cmd_šfo
 *
cmd
 = 
	`g‘_cmd_äom_g
(
nvmeq
, 
g
);

777 *
ùx
;

778 ià(
g
 >ğ
nvmeq
->
q_d•th
) {

779 *
â
 = 
¥ecŸl_com¶‘iÚ
;

780  
CMD_CTX_INVALID
;

782 ià(
â
)

783 *
â
 = 
cmd
->fn;

784 
ùx
 = 
cmd
->ctx;

785 
cmd
->
â
 = 
¥ecŸl_com¶‘iÚ
;

786 
cmd
->
ùx
 = 
CMD_CTX_COMPLETED
;

787  
ùx
;

788 
	}
}

797 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
 *
cmd
)

799 
u16
 

 = 
nvmeq
->
sq_
;

801 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

802 ià(++

 =ğ
nvmeq
->
q_d•th
)

803 

 = 0;

804 
	`wr™–
(

, 
nvmeq
->
q_db
);

805 
nvmeq
->
sq_
 = 

;

808 
	}
}

810 
	$nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
 *
cmd
)

812 
æags
;

813 
»t
;

814 
	`¥š_lock_œq§ve
(&
nvmeq
->
q_lock
, 
æags
);

815 
»t
 = 
	`__nvme_subm™_cmd
(
nvmeq
, 
cmd
);

816 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

817  
»t
;

818 
	}
}

820 
__Ë64
 **
	$iod_li¡
(
nvme_iod
 *
iod
)

822  ((*)
iod
è+ iod->
off£t
;

823 
	}
}

825 
šlše
 
	$iod_š™
(
nvme_iod
 *
iod
, 
nby‹s
,

826 
n£g
, 
´iv©e
)

828 
iod
->
´iv©e
 =…rivate;

829 
iod
->
off£t
 = 
	`off£tof
(
nvme_iod
, 
sg
[
n£g
]);

830 
iod
->
Åages
 = -1;

831 
iod
->
Ëngth
 = 
nby‹s
;

832 
iod
->
ÃÁs
 = 0;

833 
	}
}

835 
nvme_iod
 *

836 
	$__nvme_®loc_iod
(
n£g
, 
by‹s
, 
nvme_dev
 *
dev
,

837 
´iv
, 
gå_t
 
gå
)

839 
nvme_iod
 *
iod
 = 
	`km®loc
((nvme_iod) +

840 (
__Ë64
 *è* 
	`nvme_Åages
(
by‹s
, 
dev
) +

841 (
sÿ‰”li¡
è* 
n£g
, 
gå
);

843 ià(
iod
)

844 
	`iod_š™
(
iod
, 
by‹s
, 
n£g
, 
´iv
);

846  
iod
;

847 
	}
}

849 
nvme_iod
 *
	$nvme_®loc_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
,

850 
gå_t
 
gå
)

852 
size
 = !(
rq
->
cmd_æags
 & 
REQ_DISCARD
è? 
	`blk_rq_by‹s
(rq) :

853 (
nvme_dsm_¿nge
);

854 
nvme_iod
 *
iod
;

856 ià(
rq
->
Ä_phys_£gm’ts
 <ğ
NVME_INT_PAGES
 &&

857 
size
 <ğ
	`NVME_INT_BYTES
(
dev
)) {

858 
nvme_cmd_šfo
 *
cmd
 = 
	`blk_mq_rq_to_pdu
(
rq
);

860 
iod
 = 
cmd
->iod;

861 
	`iod_š™
(
iod
, 
size
, 
rq
->
Ä_phys_£gm’ts
,

862 (è
rq
 | 
NVME_INT_MASK
);

863  
iod
;

866  
	`__nvme_®loc_iod
(
rq
->
Ä_phys_£gm’ts
, 
size
, 
dev
,

867 (è
rq
, 
gå
);

868 
	}
}

870 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
nvme_iod
 *
iod
)

872 cÚ¡ 
Ï¡_´p
 = 
dev
->
·ge_size
 / 8 - 1;

873 
i
;

874 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
iod
);

875 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

877 ià(
iod
->
Åages
 == 0)

878 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

879 
i
 = 0; i < 
iod
->
Åages
; i++) {

880 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

881 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

882 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

883 
´p_dma
 = 
Ãxt_´p_dma
;

886 ià(
	`iod_should_kä“
(
iod
))

887 
	`kä“
(
iod
);

888 
	}
}

890 
	$nvme_”rÜ_¡©us
(
u16
 
¡©us
)

892 
¡©us
 & 0x7ff) {

893 
NVME_SC_SUCCESS
:

895 
NVME_SC_CAP_EXCEEDED
:

896  -
ENOSPC
;

898  -
EIO
;

900 
	}
}

902 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


903 
	$nvme_noİ_v”ify
(
blk_š‹gr™y_exchg
 *
exg
)

906 
	}
}

908 
	$nvme_noİ_g’”©e
(
blk_š‹gr™y_exchg
 *
exg
)

910 
	}
}

912 
blk_š‹gr™y
 
	gnvme_m‘a_noİ
 = {

913 .
Çme
 = "NVME_META_NOOP",

914 .
	gg’”©e_â
 = 
nvme_noİ_g’”©e
,

915 .
	gv”ify_â
 = 
nvme_noİ_v”ify
,

917 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

919 
nvme_m‘a_noİ
.
tu¶e_size
 = 
ns
->
ms
;

920 
	`blk_š‹gr™y_»gi¡”
(
ns
->
disk
, &
nvme_m‘a_noİ
);

921 
	`blk_queue_max_š‹gr™y_£gm’ts
(
ns
->
queue
, 1);

922 
	}
}

924 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

926 
	}
}

929 
	$»q_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
,

930 
nvme_com¶‘iÚ
 *
cqe
)

932 
nvme_iod
 *
iod
 = 
ùx
;

933 
»que¡
 *
»q
 = 
	`iod_g‘_´iv©e
(
iod
);

934 
nvme_cmd_šfo
 *
cmd_rq
 = 
	`blk_mq_rq_to_pdu
(
»q
);

936 
u16
 
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

938 ià(
	`uÆik–y
(
¡©us
)) {

939 ià(!(
¡©us
 & 
NVME_SC_DNR
 || 
	`blk_nÜ‘ry_»que¡
(
»q
))

940 && (
jiff›s
 - 
»q
->
¡¬t_time
è<„eq->
timeout
) {

941 
æags
;

943 
	`blk_mq_»queue_»que¡
(
»q
);

944 
	`¥š_lock_œq§ve
(
»q
->
q
->
queue_lock
, 
æags
);

945 ià(!
	`blk_queue_¡İ³d
(
»q
->
q
))

946 
	`blk_mq_kick_»queue_li¡
(
»q
->
q
);

947 
	`¥š_uÆock_œq»¡Üe
(
»q
->
q
->
queue_lock
, 
æags
);

950 
»q
->
”rÜs
 = 
	`nvme_”rÜ_¡©us
(
¡©us
);

952 
»q
->
”rÜs
 = 0;

954 ià(
cmd_rq
->
abÜ‹d
)

955 
	`dev_w¬n
(&
nvmeq
->
dev
->
pci_dev
->dev,

957 
¡©us
);

959 ià(
iod
->
ÃÁs
) {

960 
	`dma_unm­_sg
(&
nvmeq
->
dev
->
pci_dev
->dev, 
iod
->
sg
, iod->
ÃÁs
,

961 
	`rq_d©a_dœ
(
»q
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

962 ià(
	`blk_š‹gr™y_rq
(
»q
))

963 
	`dma_unm­_sg
(&
nvmeq
->
dev
->
pci_dev
->dev, 
iod
->
m‘a_sg
, 1,

964 
	`rq_d©a_dœ
(
»q
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

966 
	`nvme_ä“_iod
(
nvmeq
->
dev
, 
iod
);

968 
	`blk_mq_com¶‘e_»que¡
(
»q
);

969 
	}
}

972 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
nvme_iod
 *
iod
, 
tÙ®_Ën
,

973 
gå_t
 
gå
)

975 
dma_poŞ
 *
poŞ
;

976 
Ëngth
 = 
tÙ®_Ën
;

977 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

978 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

979 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

980 
u32
 
·ge_size
 = 
dev
->page_size;

981 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

982 
__Ë64
 *
´p_li¡
;

983 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
iod
);

984 
dma_addr_t
 
´p_dma
;

985 
Å½s
, 
i
;

987 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

988 ià(
Ëngth
 <= 0)

989  
tÙ®_Ën
;

991 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

992 ià(
dma_Ën
) {

993 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

995 
sg
 = 
	`sg_Ãxt
(sg);

996 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

997 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

1000 ià(
Ëngth
 <ğ
·ge_size
) {

1001 
iod
->
fœ¡_dma
 = 
dma_addr
;

1002  
tÙ®_Ën
;

1005 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

1006 ià(
Å½s
 <= (256 / 8)) {

1007 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

1008 
iod
->
Åages
 = 0;

1010 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

1011 
iod
->
Åages
 = 1;

1014 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
gå
, &
´p_dma
);

1015 ià(!
´p_li¡
) {

1016 
iod
->
fœ¡_dma
 = 
dma_addr
;

1017 
iod
->
Åages
 = -1;

1018  (
tÙ®_Ën
 - 
Ëngth
è+ 
·ge_size
;

1020 
li¡
[0] = 
´p_li¡
;

1021 
iod
->
fœ¡_dma
 = 
´p_dma
;

1022 
i
 = 0;

1024 ià(
i
 =ğ
·ge_size
 >> 3) {

1025 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

1026 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
gå
, &
´p_dma
);

1027 ià(!
´p_li¡
)

1028  
tÙ®_Ën
 - 
Ëngth
;

1029 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

1030 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

1031 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

1032 
i
 = 1;

1034 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

1035 
dma_Ën
 -ğ
·ge_size
;

1036 
dma_addr
 +ğ
·ge_size
;

1037 
Ëngth
 -ğ
·ge_size
;

1038 ià(
Ëngth
 <= 0)

1040 ià(
dma_Ën
 > 0)

1042 
	`BUG_ON
(
dma_Ën
 < 0);

1043 
sg
 = 
	`sg_Ãxt
(sg);

1044 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

1045 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

1048  
tÙ®_Ën
;

1049 
	}
}

1056 
	$nvme_subm™_disÿrd
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

1057 
»que¡
 *
»q
, 
nvme_iod
 *
iod
)

1059 
nvme_dsm_¿nge
 *
¿nge
 =

1060 (
nvme_dsm_¿nge
 *)
	`iod_li¡
(
iod
)[0];

1061 
nvme_commªd
 *
cmnd
 = &
nvmeq
->
sq_cmds
[nvmeq->
sq_
];

1063 
¿nge
->
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

1064 
¿nge
->
Æb
 = 
	`ıu_to_Ë32
(
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

1065 
¿nge
->
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

1067 
	`mem£t
(
cmnd
, 0, (*cmnd));

1068 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

1069 
cmnd
->
dsm
.
commªd_id
 = 
»q
->
g
;

1070 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1071 
cmnd
->
dsm
.
´p1
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

1072 
cmnd
->
dsm
.
Ä
 = 0;

1073 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

1075 ià(++
nvmeq
->
sq_
 =ğnvmeq->
q_d•th
)

1076 
nvmeq
->
sq_
 = 0;

1077 
	`wr™–
(
nvmeq
->
sq_
,‚vmeq->
q_db
);

1078 
	}
}

1080 
	$nvme_subm™_æush
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

1081 
cmdid
)

1083 
nvme_commªd
 *
cmnd
 = &
nvmeq
->
sq_cmds
[nvmeq->
sq_
];

1085 
	`mem£t
(
cmnd
, 0, (*cmnd));

1086 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1087 
cmnd
->
commÚ
.
commªd_id
 = 
cmdid
;

1088 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1090 ià(++
nvmeq
->
sq_
 =ğnvmeq->
q_d•th
)

1091 
nvmeq
->
sq_
 = 0;

1092 
	`wr™–
(
nvmeq
->
sq_
,‚vmeq->
q_db
);

1093 
	}
}

1095 
	$nvme_subm™_iod
(
nvme_queue
 *
nvmeq
, 
nvme_iod
 *
iod
,

1096 
nvme_ns
 *
ns
)

1098 
»que¡
 *
»q
 = 
	`iod_g‘_´iv©e
(
iod
);

1099 
nvme_commªd
 *
cmnd
;

1100 
u16
 
cÚŒŞ
 = 0;

1101 
u32
 
dsmgmt
 = 0;

1103 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

1104 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1105 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

1106 
cÚŒŞ
 |ğ
NVME_RW_LR
;

1108 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

1109 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

1111 
cmnd
 = &
nvmeq
->
sq_cmds
[nvmeq->
sq_
];

1112 
	`mem£t
(
cmnd
, 0, (*cmnd));

1114 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1115 
cmnd
->
rw
.
commªd_id
 = 
»q
->
g
;

1116 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1117 
cmnd
->
rw
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

1118 
cmnd
->
rw
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

1119 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

1120 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

1122 ià(
	`blk_š‹gr™y_rq
(
»q
))

1123 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
m‘a_sg
));

1124 ià(
ns
->
ms
)

1125 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

1127 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1128 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

1130 ià(++
nvmeq
->
sq_
 =ğnvmeq->
q_d•th
)

1131 
nvmeq
->
sq_
 = 0;

1132 
	`wr™–
(
nvmeq
->
sq_
,‚vmeq->
q_db
);

1136 
	}
}

1138 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1139 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1141 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1142 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1143 
»que¡
 *
»q
 = 
bd
->
rq
;

1144 
nvme_cmd_šfo
 *
cmd
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1145 
nvme_iod
 *
iod
;

1146 
dma_d©a_dœeùiÚ
 
dma_dœ
;

1153 ià(
ns
->
ms
 && !
	`blk_š‹gr™y_rq
(
»q
)) {

1154 ià(!(
ns
->
pi_ty³
 &&‚s->
ms
 == 8)) {

1155 
»q
->
”rÜs
 = -
EFAULT
;

1156 
	`blk_mq_com¶‘e_»que¡
(
»q
);

1157  
BLK_MQ_RQ_QUEUE_OK
;

1161 
iod
 = 
	`nvme_®loc_iod
(
»q
, 
ns
->
dev
, 
GFP_ATOMIC
);

1162 ià(!
iod
)

1163  
BLK_MQ_RQ_QUEUE_BUSY
;

1165 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
) {

1166 *
¿nge
;

1172 
¿nge
 = 
	`dma_poŞ_®loc
(
nvmeq
->
dev
->
´p_sm®l_poŞ
,

1173 
GFP_ATOMIC
,

1174 &
iod
->
fœ¡_dma
);

1175 ià(!
¿nge
)

1176 
»Œy_cmd
;

1177 
	`iod_li¡
(
iod
)[0] = (
__Ë64
 *)
¿nge
;

1178 
iod
->
Åages
 = 0;

1179 } ià(
»q
->
Ä_phys_£gm’ts
) {

1180 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

1182 
	`sg_š™_bË
(
iod
->
sg
, 
»q
->
Ä_phys_£gm’ts
);

1183 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
»q
->
q
,„eq, iod->
sg
);

1184 ià(!
iod
->
ÃÁs
)

1185 
”rÜ_cmd
;

1187 ià(!
	`dma_m­_sg
(
nvmeq
->
q_dmadev
, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
))

1188 
»Œy_cmd
;

1190 ià(
	`blk_rq_by‹s
(
»q
) !=

1191 
	`nvme_£tup_´ps
(
nvmeq
->
dev
, 
iod
, 
	`blk_rq_by‹s
(
»q
), 
GFP_ATOMIC
)) {

1192 
	`dma_unm­_sg
(&
nvmeq
->
dev
->
pci_dev
->dev, 
iod
->
sg
,

1193 
iod
->
ÃÁs
, 
dma_dœ
);

1194 
»Œy_cmd
;

1196 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

1197 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
»q
->
q
,„eq->
bio
) != 1)

1198 
”rÜ_cmd
;

1200 
	`sg_š™_bË
(
iod
->
m‘a_sg
, 1);

1201 ià(
	`blk_rq_m­_š‹gr™y_sg
(

1202 
»q
->
q
,„eq->
bio
, 
iod
->
m‘a_sg
) != 1)

1203 
”rÜ_cmd
;

1205 ià(!
	`dma_m­_sg
(
nvmeq
->
q_dmadev
, 
iod
->
m‘a_sg
, 1, 
dma_dœ
))

1206 
”rÜ_cmd
;

1210 
	`nvme_£t_šfo
(
cmd
, 
iod
, 
»q_com¶‘iÚ
);

1211 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1212 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
)

1213 
	`nvme_subm™_disÿrd
(
nvmeq
, 
ns
, 
»q
, 
iod
);

1214 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

1215 
	`nvme_subm™_æush
(
nvmeq
, 
ns
, 
»q
->
g
);

1217 
	`nvme_subm™_iod
(
nvmeq
, 
iod
, 
ns
);

1219 
	`nvme_´oûss_cq
(
nvmeq
);

1220 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1221  
BLK_MQ_RQ_QUEUE_OK
;

1223 
”rÜ_cmd
:

1224 
	`nvme_ä“_iod
(
nvmeq
->
dev
, 
iod
);

1225  
BLK_MQ_RQ_QUEUE_ERROR
;

1226 
»Œy_cmd
:

1227 
	`nvme_ä“_iod
(
nvmeq
->
dev
, 
iod
);

1228  
BLK_MQ_RQ_QUEUE_BUSY
;

1229 
	}
}

1231 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

1233 
u16
 
h—d
, 
pha£
;

1235 
h—d
 = 
nvmeq
->
cq_h—d
;

1236 
pha£
 = 
nvmeq
->
cq_pha£
;

1239 *
ùx
;

1240 
nvme_com¶‘iÚ_â
 
â
;

1241 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[
h—d
];

1242 ià((
	`Ë16_to_ıu
(
cqe
.
¡©us
è& 1è!ğ
pha£
)

1244 
nvmeq
->
sq_h—d
 = 
	`Ë16_to_ıu
(
cqe
.sq_head);

1245 ià(++
h—d
 =ğ
nvmeq
->
q_d•th
) {

1246 
h—d
 = 0;

1247 
pha£
 = !phase;

1249 
ùx
 = 
	`nvme_fšish_cmd
(
nvmeq
, 
cqe
.
commªd_id
, &
â
);

1250 
	`â
(
nvmeq
, 
ùx
, &
cqe
);

1259 ià(
h—d
 =ğ
nvmeq
->
cq_h—d
 && 
pha£
 =ğnvmeq->
cq_pha£
)

1262 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

1263 
nvmeq
->
cq_h—d
 = 
h—d
;

1264 
nvmeq
->
cq_pha£
 = 
pha£
;

1266 
nvmeq
->
cqe_£’
 = 1;

1268 
	}
}

1272 
	$nvme_admš_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1273 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1275 
	`WARN_ON_ONCE
(1);

1276  
BLK_MQ_RQ_QUEUE_ERROR
;

1277 
	}
}

1279 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1281 
œq»tuº_t
 
»suÉ
;

1282 
nvme_queue
 *
nvmeq
 = 
d©a
;

1283 
	`¥š_lock
(&
nvmeq
->
q_lock
);

1284 
	`nvme_´oûss_cq
(
nvmeq
);

1285 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

1286 
nvmeq
->
cqe_£’
 = 0;

1287 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

1288  
»suÉ
;

1289 
	}
}

1291 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1293 
nvme_queue
 *
nvmeq
 = 
d©a
;

1294 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[nvmeq->
cq_h—d
];

1295 ià((
	`Ë16_to_ıu
(
cqe
.
¡©us
è& 1è!ğ
nvmeq
->
cq_pha£
)

1296  
IRQ_NONE
;

1297  
IRQ_WAKE_THREAD
;

1298 
	}
}

1300 
	ssync_cmd_šfo
 {

1301 
sk_¡ruù
 *
	msk
;

1302 
u32
 
	m»suÉ
;

1303 
	m¡©us
;

1306 
	$sync_com¶‘iÚ
(
nvme_queue
 *
nvmeq
, *
ùx
,

1307 
nvme_com¶‘iÚ
 *
cqe
)

1309 
sync_cmd_šfo
 *
cmdšfo
 = 
ùx
;

1310 
cmdšfo
->
»suÉ
 = 
	`Ë32_to_ıup
(&
cqe
->result);

1311 
cmdšfo
->
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

1312 
	`wake_up_´oûss
(
cmdšfo
->
sk
);

1313 
	}
}

1319 
	$nvme_subm™_sync_cmd
(
»que¡
 *
»q
, 
nvme_commªd
 *
cmd
,

1320 
u32
 *
»suÉ
, 
timeout
)

1322 
sync_cmd_šfo
 
cmdšfo
;

1323 
nvme_cmd_šfo
 *
cmd_rq
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1324 
nvme_queue
 *
nvmeq
 = 
cmd_rq
->nvmeq;

1326 
cmdšfo
.
sk
 = 
cu¼’t
;

1327 
cmdšfo
.
¡©us
 = -
EINTR
;

1329 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

1331 
	`nvme_£t_šfo
(
cmd_rq
, &
cmdšfo
, 
sync_com¶‘iÚ
);

1333 
	`£t_cu¼’t_¡©e
(
TASK_UNINTERRUPTIBLE
);

1334 
	`nvme_subm™_cmd
(
nvmeq
, 
cmd
);

1335 
	`scheduË
();

1337 ià(
»suÉ
)

1338 *
»suÉ
 = 
cmdšfo
.result;

1339  
cmdšfo
.
¡©us
;

1340 
	}
}

1342 
	$nvme_subm™_async_admš_»q
(
nvme_dev
 *
dev
)

1344 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1345 
nvme_commªd
 
c
;

1346 
nvme_cmd_šfo
 *
cmd_šfo
;

1347 
»que¡
 *
»q
;

1349 
»q
 = 
	`blk_mq_®loc_»que¡
(
dev
->
admš_q
, 
WRITE
, 
GFP_ATOMIC
, 
Œue
);

1350 ià(
	`IS_ERR
(
»q
))

1351  
	`PTR_ERR
(
»q
);

1353 
»q
->
cmd_æags
 |ğ
REQ_NO_TIMEOUT
;

1354 
cmd_šfo
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1355 
	`nvme_£t_šfo
(
cmd_šfo
, 
NULL
, 
async_»q_com¶‘iÚ
);

1357 
	`mem£t
(&
c
, 0, (c));

1358 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1359 
c
.
commÚ
.
commªd_id
 = 
»q
->
g
;

1361 
	`blk_mq_ä“_»que¡
(
»q
);

1362  
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

1363 
	}
}

1365 
	$nvme_subm™_admš_async_cmd
(
nvme_dev
 *
dev
,

1366 
nvme_commªd
 *
cmd
,

1367 
async_cmd_šfo
 *
cmdšfo
, 
timeout
)

1369 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1370 
»que¡
 *
»q
;

1371 
nvme_cmd_šfo
 *
cmd_rq
;

1373 
»q
 = 
	`blk_mq_®loc_»que¡
(
dev
->
admš_q
, 
WRITE
, 
GFP_KERNEL
, 
çl£
);

1374 ià(
	`IS_ERR
(
»q
))

1375  
	`PTR_ERR
(
»q
);

1377 
»q
->
timeout
 =imeout;

1378 
cmd_rq
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1379 
cmdšfo
->
»q
 =„eq;

1380 
	`nvme_£t_šfo
(
cmd_rq
, 
cmdšfo
, 
async_com¶‘iÚ
);

1381 
cmdšfo
->
¡©us
 = -
EINTR
;

1383 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

1385  
	`nvme_subm™_cmd
(
nvmeq
, 
cmd
);

1386 
	}
}

1388 
	$__nvme_subm™_admš_cmd
(
nvme_dev
 *
dev
, 
nvme_commªd
 *
cmd
,

1389 
u32
 *
»suÉ
, 
timeout
)

1391 
»s
;

1392 
»que¡
 *
»q
;

1394 
»q
 = 
	`blk_mq_®loc_»que¡
(
dev
->
admš_q
, 
WRITE
, 
GFP_KERNEL
, 
çl£
);

1395 ià(
	`IS_ERR
(
»q
))

1396  
	`PTR_ERR
(
»q
);

1397 
»s
 = 
	`nvme_subm™_sync_cmd
(
»q
, 
cmd
, 
»suÉ
, 
timeout
);

1398 
	`blk_mq_ä“_»que¡
(
»q
);

1399  
»s
;

1400 
	}
}

1402 
	$nvme_subm™_admš_cmd
(
nvme_dev
 *
dev
, 
nvme_commªd
 *
cmd
,

1403 
u32
 *
»suÉ
)

1405  
	`__nvme_subm™_admš_cmd
(
dev
, 
cmd
, 
»suÉ
, 
ADMIN_TIMEOUT
);

1406 
	}
}

1408 
	$nvme_subm™_io_cmd
(
nvme_dev
 *
dev
, 
nvme_ns
 *
ns
,

1409 
nvme_commªd
 *
cmd
, 
u32
 *
»suÉ
)

1411 
»s
;

1412 
»que¡
 *
»q
;

1414 
»q
 = 
	`blk_mq_®loc_»que¡
(
ns
->
queue
, 
WRITE
, (
GFP_KERNEL
|
__GFP_WAIT
),

1415 
çl£
);

1416 ià(
	`IS_ERR
(
»q
))

1417  
	`PTR_ERR
(
»q
);

1418 
»s
 = 
	`nvme_subm™_sync_cmd
(
»q
, 
cmd
, 
»suÉ
, 
NVME_IO_TIMEOUT
);

1419 
	`blk_mq_ä“_»que¡
(
»q
);

1420  
»s
;

1421 
	}
}

1423 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1425 
nvme_commªd
 
c
;

1427 
	`mem£t
(&
c
, 0, (c));

1428 
c
.
d–‘e_queue
.
İcode
 = opcode;

1429 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1431  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1432 
	}
}

1434 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1435 
nvme_queue
 *
nvmeq
)

1437 
nvme_commªd
 
c
;

1438 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1440 
	`mem£t
(&
c
, 0, (c));

1441 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1442 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1443 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1444 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1445 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1446 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1448  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1449 
	}
}

1451 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1452 
nvme_queue
 *
nvmeq
)

1454 
nvme_commªd
 
c
;

1455 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_SQ_PRIO_MEDIUM
;

1457 
	`mem£t
(&
c
, 0, (c));

1458 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1459 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1460 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1461 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1462 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1463 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1465  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1466 
	}
}

1468 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1470  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1471 
	}
}

1473 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1475  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1476 
	}
}

1478 
	$nvme_id’tify
(
nvme_dev
 *
dev
, 
nsid
, 
ús
,

1479 
dma_addr_t
 
dma_addr
)

1481 
nvme_commªd
 
c
;

1483 
	`mem£t
(&
c
, 0, (c));

1484 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1485 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1486 
c
.
id’tify
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1487 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(cns);

1489  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1490 
	}
}

1492 
	$nvme_g‘_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
nsid
,

1493 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
)

1495 
nvme_commªd
 
c
;

1497 
	`mem£t
(&
c
, 0, (c));

1498 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_g‘_ã©u»s
;

1499 
c
.
ã©u»s
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1500 
c
.
ã©u»s
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1501 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1503  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
»suÉ
);

1504 
	}
}

1506 
	$nvme_£t_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
dwÜd11
,

1507 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
)

1509 
nvme_commªd
 
c
;

1511 
	`mem£t
(&
c
, 0, (c));

1512 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1513 
c
.
ã©u»s
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1514 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1515 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1517  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
»suÉ
);

1518 
	}
}

1526 
	$nvme_abÜt_»q
(
»que¡
 *
»q
)

1528 
nvme_cmd_šfo
 *
cmd_rq
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1529 
nvme_queue
 *
nvmeq
 = 
cmd_rq
->nvmeq;

1530 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1531 
»que¡
 *
abÜt_»q
;

1532 
nvme_cmd_šfo
 *
abÜt_cmd
;

1533 
nvme_commªd
 
cmd
;

1535 ià(!
nvmeq
->
qid
 || 
cmd_rq
->
abÜ‹d
) {

1536 
æags
;

1538 
	`¥š_lock_œq§ve
(&
dev_li¡_lock
, 
æags
);

1539 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

1540 
out
;

1541 
	`li¡_d–_š™
(&
dev
->
node
);

1542 
	`dev_w¬n
(&
dev
->
pci_dev
->dev,

1544 
»q
->
g
, 
nvmeq
->
qid
);

1545 
	`PREPARE_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_çed_dev
);

1546 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

1547 
out
:

1548 
	`¥š_uÆock_œq»¡Üe
(&
dev_li¡_lock
, 
æags
);

1552 ià(!
dev
->
abÜt_lim™
)

1555 
abÜt_»q
 = 
	`blk_mq_®loc_»que¡
(
dev
->
admš_q
, 
WRITE
, 
GFP_ATOMIC
,

1556 
çl£
);

1557 ià(
	`IS_ERR
(
abÜt_»q
))

1560 
abÜt_cmd
 = 
	`blk_mq_rq_to_pdu
(
abÜt_»q
);

1561 
	`nvme_£t_šfo
(
abÜt_cmd
, 
abÜt_»q
, 
abÜt_com¶‘iÚ
);

1563 
	`mem£t
(&
cmd
, 0, (cmd));

1564 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1565 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1566 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1567 
cmd
.
abÜt
.
commªd_id
 = 
abÜt_»q
->
g
;

1569 --
dev
->
abÜt_lim™
;

1570 
cmd_rq
->
abÜ‹d
 = 1;

1572 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "AbÜtšg I/O %d QID %d\n", 
»q
->
g
,

1573 
nvmeq
->
qid
);

1574 ià(
	`nvme_subm™_cmd
(
dev
->
queues
[0], &
cmd
) < 0) {

1575 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

1577 
»q
->
g
, 
nvmeq
->
qid
);

1578 
	`blk_mq_ä“_»que¡
(
abÜt_»q
);

1580 
	}
}

1582 
	$nvme_ÿnûl_queue_ios
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

1584 
nvme_queue
 *
nvmeq
 = 
d©a
;

1585 *
ùx
;

1586 
nvme_com¶‘iÚ_â
 
â
;

1587 
nvme_cmd_šfo
 *
cmd
;

1588 
nvme_com¶‘iÚ
 
cqe
;

1590 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

1593 
cmd
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1595 ià(
cmd
->
ùx
 =ğ
CMD_CTX_CANCELLED
)

1598 ià(
	`blk_queue_dyšg
(
»q
->
q
))

1599 
cqe
.
¡©us
 = 
	`ıu_to_Ë16
((
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
) << 1);

1601 
cqe
.
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_ABORT_REQ
 << 1);

1604 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "Cancelling I/O %d QID %d\n",

1605 
»q
->
g
, 
nvmeq
->
qid
);

1606 
ùx
 = 
	`ÿnûl_cmd_šfo
(
cmd
, &
â
);

1607 
	`â
(
nvmeq
, 
ùx
, &
cqe
);

1608 
	}
}

1610 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

1612 
nvme_cmd_šfo
 *
cmd
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1613 
nvme_queue
 *
nvmeq
 = 
cmd
->nvmeq;

1615 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "TimeouˆI/O %d QID %d\n", 
»q
->
g
,

1616 
nvmeq
->
qid
);

1617 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1618 
	`nvme_abÜt_»q
(
»q
);

1619 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1626  
BLK_EH_RESET_TIMER
;

1627 
	}
}

1629 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1631 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1632 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1633 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1634 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1635 
	`kä“
(
nvmeq
);

1636 
	}
}

1638 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1640 
i
;

1642 
i
 = 
dev
->
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1643 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1644 
dev
->
queue_couÁ
--;

1645 
dev
->
queues
[
i
] = 
NULL
;

1646 
	`nvme_ä“_queue
(
nvmeq
);

1648 
	}
}

1654 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1656 
veùÜ
;

1658 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1659 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1660 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1663 
veùÜ
 = 
nvmeq
->
dev
->
’Œy
[nvmeq->
cq_veùÜ
].vector;

1664 
nvmeq
->
dev
->
Úlše_queues
--;

1665 
nvmeq
->
cq_veùÜ
 = -1;

1666 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1668 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
admš_q
)

1669 
	`blk_mq_ä“ze_queue_¡¬t
(
nvmeq
->
dev
->
admš_q
);

1671 
	`œq_£t_affš™y_hšt
(
veùÜ
, 
NULL
);

1672 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1675 
	}
}

1677 
	$nvme_ş—r_queue
(
nvme_queue
 *
nvmeq
)

1679 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1680 ià(
nvmeq
->
gs
 && *nvmeq->tags)

1681 
	`blk_mq_®l_g_busy_™”
(*
nvmeq
->
gs
, 
nvme_ÿnûl_queue_ios
,‚vmeq);

1682 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1683 
	}
}

1685 
	$nvme_di§bË_queue
(
nvme_dev
 *
dev
, 
qid
)

1687 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
qid
];

1689 ià(!
nvmeq
)

1691 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1696 ià(
qid
 && 
	`»adl
(&
dev
->
b¬
->
c¡s
) != -1) {

1697 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1698 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1701 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1702 
	`nvme_´oûss_cq
(
nvmeq
);

1703 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1704 
	}
}

1706 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1707 
d•th
)

1709 
deviû
 *
dmadev
 = &
dev
->
pci_dev
->dev;

1710 
nvme_queue
 *
nvmeq
 = 
	`kz®loc
((*nvmeq), 
GFP_KERNEL
);

1711 ià(!
nvmeq
)

1712  
NULL
;

1714 
nvmeq
->
cqes
 = 
	`dma_®loc_coh”’t
(
dmadev
, 
	`CQ_SIZE
(
d•th
),

1715 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1716 ià(!
nvmeq
->
cqes
)

1717 
ä“_nvmeq
;

1718 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
(
d•th
));

1720 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dmadev
, 
	`SQ_SIZE
(
d•th
),

1721 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1722 ià(!
nvmeq
->
sq_cmds
)

1723 
ä“_cqdma
;

1725 
nvmeq
->
q_dmadev
 = 
dmadev
;

1726 
nvmeq
->
dev
 = dev;

1727 
	`¢´štf
(
nvmeq
->
œqÇme
, (nvmeq->irqname), "nvme%dq%d",

1728 
dev
->
š¡ªû
, 
qid
);

1729 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1730 
nvmeq
->
cq_h—d
 = 0;

1731 
nvmeq
->
cq_pha£
 = 1;

1732 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1733 
nvmeq
->
q_d•th
 = 
d•th
;

1734 
nvmeq
->
qid
 = qid;

1735 
dev
->
queue_couÁ
++;

1736 
dev
->
queues
[
qid
] = 
nvmeq
;

1738  
nvmeq
;

1740 
ä“_cqdma
:

1741 
	`dma_ä“_coh”’t
(
dmadev
, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1742 
nvmeq
->
cq_dma_addr
);

1743 
ä“_nvmeq
:

1744 
	`kä“
(
nvmeq
);

1745  
NULL
;

1746 
	}
}

1748 
	$queue_»que¡_œq
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1749 cÚ¡ *
Çme
)

1751 ià(
u£_th»aded_š‹¼u±s
)

1752  
	`»que¡_th»aded_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1753 
nvme_œq_check
, 
nvme_œq
, 
IRQF_SHARED
,

1754 
Çme
, 
nvmeq
);

1755  
	`»que¡_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
, 
nvme_œq
,

1756 
IRQF_SHARED
, 
Çme
, 
nvmeq
);

1757 
	}
}

1759 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1761 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1763 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1764 
nvmeq
->
sq_
 = 0;

1765 
nvmeq
->
cq_h—d
 = 0;

1766 
nvmeq
->
cq_pha£
 = 1;

1767 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1768 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1769 
dev
->
Úlše_queues
++;

1770 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1771 
	}
}

1773 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1775 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1776 
»suÉ
;

1778 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1779 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1780 ià(
»suÉ
 < 0)

1781  
»suÉ
;

1783 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1784 ià(
»suÉ
 < 0)

1785 
»Ëa£_cq
;

1787 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1788 ià(
»suÉ
 < 0)

1789 
»Ëa£_sq
;

1791 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1792  
»suÉ
;

1794 
»Ëa£_sq
:

1795 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1796 
»Ëa£_cq
:

1797 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1798  
»suÉ
;

1799 
	}
}

1801 
	$nvme_wa™_»ady
(
nvme_dev
 *
dev
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

1803 
timeout
;

1804 
u32
 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

1806 
timeout
 = ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

1808 (
	`»adl
(&
dev
->
b¬
->
c¡s
è& 
NVME_CSTS_RDY
è!ğ
b™
) {

1809 
	`m¦“p
(100);

1810 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1811  -
EINTR
;

1812 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1813 
	`dev_”r
(&
dev
->
pci_dev
->dev,

1814 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

1816  -
ENODEV
;

1821 
	}
}

1829 
	$nvme_di§bË_ù¾
(
nvme_dev
 *
dev
, 
u64
 
ÿp
)

1831 
dev
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1832 
dev
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

1833 
	`wr™–
(
dev
->
ù¾_cÚfig
, &dev->
b¬
->
cc
);

1835  
	`nvme_wa™_»ady
(
dev
, 
ÿp
, 
çl£
);

1836 
	}
}

1838 
	$nvme_’abË_ù¾
(
nvme_dev
 *
dev
, 
u64
 
ÿp
)

1840 
dev
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1841 
dev
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

1842 
	`wr™–
(
dev
->
ù¾_cÚfig
, &dev->
b¬
->
cc
);

1844  
	`nvme_wa™_»ady
(
dev
, 
ÿp
, 
Œue
);

1845 
	}
}

1847 
	$nvme_shutdown_ù¾
(
nvme_dev
 *
dev
)

1849 
timeout
;

1851 
dev
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1852 
dev
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

1854 
	`wr™–
(
dev
->
ù¾_cÚfig
, &dev->
b¬
->
cc
);

1856 
timeout
 = 
SHUTDOWN_TIMEOUT
 + 
jiff›s
;

1857 (
	`»adl
(&
dev
->
b¬
->
c¡s
è& 
NVME_CSTS_SHST_MASK
) !=

1858 
NVME_CSTS_SHST_CMPLT
) {

1859 
	`m¦“p
(100);

1860 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1861  -
EINTR
;

1862 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1863 
	`dev_”r
(&
dev
->
pci_dev
->dev,

1865  -
ENODEV
;

1870 
	}
}

1872 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1873 .
queue_rq
 = 
nvme_admš_queue_rq
,

1874 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1875 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1876 .
	gš™_»que¡
 = 
nvme_admš_š™_»que¡
,

1877 .
	gtimeout
 = 
nvme_timeout
,

1880 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1881 .
queue_rq
 = 
nvme_queue_rq
,

1882 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1883 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1884 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1885 .
	gtimeout
 = 
nvme_timeout
,

1888 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1890 ià(
dev
->
admš_q
 && !
	`blk_queue_dyšg
(dev->admin_q)) {

1891 
	`blk_ş—nup_queue
(
dev
->
admš_q
);

1892 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1894 
	}
}

1896 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1898 ià(!
dev
->
admš_q
) {

1899 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1900 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1901 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_DEPTH
 - 1;

1902 
dev
->
admš_g£t
.
»£rved_gs
 = 1;

1903 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1904 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(&dev->
pci_dev
->dev);

1905 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1906 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1908 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1909  -
ENOMEM
;

1911 
dev
->
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1912 ià(!
dev
->
admš_q
) {

1913 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1914  -
ENOMEM
;

1916 ià(!
	`blk_g‘_queue
(
dev
->
admš_q
)) {

1917 
	`nvme_dev_»move_admš
(
dev
);

1918  -
ENODEV
;

1921 
	`blk_mq_unä“ze_queue
(
dev
->
admš_q
);

1924 
	}
}

1926 
	$nvme_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1928 
»suÉ
;

1929 
u32
 
aqa
;

1930 
u64
 
ÿp
 = 
	`»adq
(&
dev
->
b¬
->cap);

1931 
nvme_queue
 *
nvmeq
;

1932 
·ge_shiá
 = 
PAGE_SHIFT
;

1933 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

1934 
dev_·ge_max
 = 
	`NVME_CAP_MPSMAX
(
ÿp
) + 12;

1936 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

1937 
	`dev_”r
(&
dev
->
pci_dev
->dev,

1939 "ho¡ (%u)\n", 1 << 
dev_·ge_mš
,

1940 1 << 
·ge_shiá
);

1941  -
ENODEV
;

1943 ià(
·ge_shiá
 > 
dev_·ge_max
) {

1944 
	`dev_šfo
(&
dev
->
pci_dev
->dev,

1947 1 << 
dev_·ge_max
, 1 << 
·ge_shiá
);

1948 
·ge_shiá
 = 
dev_·ge_max
;

1951 
»suÉ
 = 
	`nvme_di§bË_ù¾
(
dev
, 
ÿp
);

1952 ià(
»suÉ
 < 0)

1953  
»suÉ
;

1955 
nvmeq
 = 
dev
->
queues
[0];

1956 ià(!
nvmeq
) {

1957 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1958 ià(!
nvmeq
)

1959  -
ENOMEM
;

1962 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1963 
aqa
 |=‡qa << 16;

1965 
dev
->
·ge_size
 = 1 << 
·ge_shiá
;

1967 
dev
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

1968 
dev
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

1969 
dev
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

1970 
dev
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

1972 
	`wr™–
(
aqa
, &
dev
->
b¬
->aqa);

1973 
	`wr™eq
(
nvmeq
->
sq_dma_addr
, &
dev
->
b¬
->
asq
);

1974 
	`wr™eq
(
nvmeq
->
cq_dma_addr
, &
dev
->
b¬
->
acq
);

1976 
»suÉ
 = 
	`nvme_’abË_ù¾
(
dev
, 
ÿp
);

1977 ià(
»suÉ
)

1978 
ä“_nvmeq
;

1980 
nvmeq
->
cq_veùÜ
 = 0;

1981 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1982 ià(
»suÉ
)

1983 
ä“_nvmeq
;

1985  
»suÉ
;

1987 
ä“_nvmeq
:

1988 
	`nvme_ä“_queues
(
dev
, 0);

1989  
»suÉ
;

1990 
	}
}

1992 
nvme_iod
 *
	$nvme_m­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

1993 
addr
, 
Ëngth
)

1995 
i
, 
”r
, 
couÁ
, 
ÃÁs
, 
off£t
;

1996 
sÿ‰”li¡
 *
sg
;

1997 
·ge
 **
·ges
;

1998 
nvme_iod
 *
iod
;

2000 ià(
addr
 & 3)

2001  
	`ERR_PTR
(-
EINVAL
);

2002 ià(!
Ëngth
 ||†’gth > 
INT_MAX
 - 
PAGE_SIZE
)

2003  
	`ERR_PTR
(-
EINVAL
);

2005 
off£t
 = 
	`off£t_š_·ge
(
addr
);

2006 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

2007 
·ges
 = 
	`kÿÎoc
(
couÁ
, (*·ges), 
GFP_KERNEL
);

2008 ià(!
·ges
)

2009  
	`ERR_PTR
(-
ENOMEM
);

2011 
”r
 = 
	`g‘_u£r_·ges_ç¡
(
addr
, 
couÁ
, 1, 
·ges
);

2012 ià(
”r
 < 
couÁ
) {

2013 
couÁ
 = 
”r
;

2014 
”r
 = -
EFAULT
;

2015 
put_·ges
;

2018 
”r
 = -
ENOMEM
;

2019 
iod
 = 
	`__nvme_®loc_iod
(
couÁ
, 
Ëngth
, 
dev
, 0, 
GFP_KERNEL
);

2020 ià(!
iod
)

2021 
put_·ges
;

2023 
sg
 = 
iod
->sg;

2024 
	`sg_š™_bË
(
sg
, 
couÁ
);

2025 
i
 = 0; i < 
couÁ
; i++) {

2026 
	`sg_£t_·ge
(&
sg
[
i
], 
·ges
[i],

2027 
	`mš_t
(, 
Ëngth
, 
PAGE_SIZE
 - 
off£t
),

2028 
off£t
);

2029 
Ëngth
 -ğ(
PAGE_SIZE
 - 
off£t
);

2030 
off£t
 = 0;

2032 
	`sg_m¬k_’d
(&
sg
[
i
 - 1]);

2033 
iod
->
ÃÁs
 = 
couÁ
;

2035 
ÃÁs
 = 
	`dma_m­_sg
(&
dev
->
pci_dev
->dev, 
sg
, 
couÁ
,

2036 
wr™e
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

2037 ià(!
ÃÁs
)

2038 
ä“_iod
;

2040 
	`kä“
(
·ges
);

2041  
iod
;

2043 
ä“_iod
:

2044 
	`kä“
(
iod
);

2045 
put_·ges
:

2046 
i
 = 0; i < 
couÁ
; i++)

2047 
	`put_·ge
(
·ges
[
i
]);

2048 
	`kä“
(
·ges
);

2049  
	`ERR_PTR
(
”r
);

2050 
	}
}

2052 
	$nvme_unm­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

2053 
nvme_iod
 *
iod
)

2055 
i
;

2057 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, 
iod
->
sg
, iod->
ÃÁs
,

2058 
wr™e
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

2060 
i
 = 0; i < 
iod
->
ÃÁs
; i++)

2061 
	`put_·ge
(
	`sg_·ge
(&
iod
->
sg
[
i
]));

2062 
	}
}

2064 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

2066 
nvme_dev
 *
dev
 = 
ns
->dev;

2067 
nvme_u£r_io
 
io
;

2068 
nvme_commªd
 
c
;

2069 
Ëngth
, 
m‘a_Ën
, 
´p_Ën
;

2070 
¡©us
, 
wr™e
;

2071 
nvme_iod
 *
iod
;

2072 
dma_addr_t
 
m‘a_dma
 = 0;

2073 *
m‘a
 = 
NULL
;

2075 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

2076  -
EFAULT
;

2077 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

2078 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

2080 ià(
m‘a_Ën
 && ((
io
.
m‘ad©a
 & 3è|| !io.m‘ad©aè&& !
ns
->
ext
)

2081  -
EINVAL
;

2082 ià(
m‘a_Ën
 && 
ns
->
ext
) {

2083 
Ëngth
 +ğ
m‘a_Ën
;

2084 
m‘a_Ën
 = 0;

2087 
wr™e
 = 
io
.
İcode
 & 1;

2089 
io
.
İcode
) {

2090 
nvme_cmd_wr™e
:

2091 
nvme_cmd_»ad
:

2092 
nvme_cmd_com·»
:

2093 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
wr™e
, 
io
.
addr
, 
Ëngth
);

2096  -
EINVAL
;

2099 ià(
	`IS_ERR
(
iod
))

2100  
	`PTR_ERR
(
iod
);

2102 
´p_Ën
 = 
	`nvme_£tup_´ps
(
dev
, 
iod
, 
Ëngth
, 
GFP_KERNEL
);

2103 ià(
Ëngth
 !ğ
´p_Ën
) {

2104 
¡©us
 = -
ENOMEM
;

2105 
unm­
;

2107 ià(
m‘a_Ën
) {

2108 
m‘a
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 
m‘a_Ën
,

2109 &
m‘a_dma
, 
GFP_KERNEL
);

2110 ià(!
m‘a
) {

2111 
¡©us
 = -
ENOMEM
;

2112 
unm­
;

2114 ià(
wr™e
) {

2115 ià(
	`cİy_äom_u£r
(
m‘a
, (
__u£r
 *)
io
.
m‘ad©a
,

2116 
m‘a_Ën
)) {

2117 
¡©us
 = -
EFAULT
;

2118 
unm­
;

2123 
	`mem£t
(&
c
, 0, (c));

2124 
c
.
rw
.
İcode
 = 
io
.opcode;

2125 
c
.
rw
.
æags
 = 
io
.flags;

2126 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2127 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

2128 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

2129 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

2130 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

2131 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

2132 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

2133 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

2134 
c
.
rw
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

2135 
c
.
rw
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

2136 
c
.
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
m‘a_dma
);

2137 
¡©us
 = 
	`nvme_subm™_io_cmd
(
dev
, 
ns
, &
c
, 
NULL
);

2138 
unm­
:

2139 
	`nvme_unm­_u£r_·ges
(
dev
, 
wr™e
, 
iod
);

2140 
	`nvme_ä“_iod
(
dev
, 
iod
);

2142 ià(
m‘a
) {

2143 ià(
¡©us
 =ğ
NVME_SC_SUCCESS
 && !
wr™e
) {

2144 ià(
	`cİy_to_u£r
((
__u£r
 *)
io
.
m‘ad©a
, 
m‘a
,

2145 
m‘a_Ën
))

2146 
¡©us
 = -
EFAULT
;

2148 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 
m‘a_Ën
, 
m‘a
, 
m‘a_dma
);

2150  
¡©us
;

2151 
	}
}

2153 
	$nvme_u£r_cmd
(
nvme_dev
 *
dev
, 
nvme_ns
 *
ns
,

2154 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

2156 
nvme_·s¡hru_cmd
 
cmd
;

2157 
nvme_commªd
 
c
;

2158 
¡©us
, 
Ëngth
;

2159 
nvme_iod
 *
	`unš™Ÿlized_v¬
(
iod
);

2160 
timeout
;

2162 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2163  -
EACCES
;

2164 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

2165  -
EFAULT
;

2167 
	`mem£t
(&
c
, 0, (c));

2168 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

2169 
c
.
commÚ
.
æags
 = 
cmd
.flags;

2170 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

2171 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

2172 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

2173 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

2174 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

2175 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

2176 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

2177 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

2178 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

2180 
Ëngth
 = 
cmd
.
d©a_Ën
;

2181 ià(
cmd
.
d©a_Ën
) {

2182 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
cmd
.
İcode
 & 1, cmd.
addr
,

2183 
Ëngth
);

2184 ià(
	`IS_ERR
(
iod
))

2185  
	`PTR_ERR
(
iod
);

2186 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, 
iod
,†’gth, 
GFP_KERNEL
);

2187 
c
.
commÚ
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

2188 
c
.
commÚ
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

2191 
timeout
 = 
cmd
.
timeout_ms
 ? 
	`m£cs_to_jiff›s
(cmd.timeout_ms) :

2192 
ADMIN_TIMEOUT
;

2194 ià(
Ëngth
 !ğ
cmd
.
d©a_Ën
)

2195 
¡©us
 = -
ENOMEM
;

2196 ià(
ns
) {

2197 
»que¡
 *
»q
;

2199 
»q
 = 
	`blk_mq_®loc_»que¡
(
ns
->
queue
, 
WRITE
,

2200 (
GFP_KERNEL
|
__GFP_WAIT
), 
çl£
);

2201 ià(
	`IS_ERR
(
»q
))

2202 
¡©us
 = 
	`PTR_ERR
(
»q
);

2204 
¡©us
 = 
	`nvme_subm™_sync_cmd
(
»q
, &
c
, &
cmd
.
»suÉ
,

2205 
timeout
);

2206 
	`blk_mq_ä“_»que¡
(
»q
);

2209 
¡©us
 = 
	`__nvme_subm™_admš_cmd
(
dev
, &
c
, &
cmd
.
»suÉ
, 
timeout
);

2211 ià(
cmd
.
d©a_Ën
) {

2212 
	`nvme_unm­_u£r_·ges
(
dev
, 
cmd
.
İcode
 & 1, 
iod
);

2213 
	`nvme_ä“_iod
(
dev
, 
iod
);

2216 ià((
¡©us
 >ğ0è&& 
	`cİy_to_u£r
(&
ucmd
->
»suÉ
, &
cmd
.result,

2217 (
cmd
.
»suÉ
)))

2218 
¡©us
 = -
EFAULT
;

2220  
¡©us
;

2221 
	}
}

2224 
nvme_iod
 *
	$nvme_m­_k”Ãl_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

2225 
addr
, 
Ëngth
)

2227 
i
, 
”r
, 
couÁ
, 
ÃÁs
, 
off£t
;

2228 
sÿ‰”li¡
 *
sg
;

2229 
·ge
 **
·ges
;

2230 
·ge
 *·gğ
NULL
;

2231 
nvme_iod
 *
iod
;

2232 *
¤c_d©a
 = 
NULL
;

2234 ià(
addr
 & 3)

2235  
	`ERR_PTR
(-
EINVAL
);

2236 ià(!
Ëngth
 ||†’gth > 
INT_MAX
 - 
PAGE_SIZE
)

2237  
	`ERR_PTR
(-
EINVAL
);

2239 
off£t
 = 
	`off£t_š_·ge
(
addr
);

2240 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

2241 
·ges
 = 
	`kÿÎoc
(
couÁ
, (*·ges), 
GFP_KERNEL
);

2242 ià(!
·ges
)

2243  
	`ERR_PTR
(-
ENOMEM
);

2245 
¤c_d©a
 = (*)
addr
;

2246 
i
 = 0; i < 
couÁ
; i ++) {

2247 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

2248 
	`g‘_·ge
(
·ge
);

2249 
·ges
[
i
] = 
·ge
;

2250 
¤c_d©a
 +ğ
PAGE_SIZE
;

2253 
iod
 = 
	`__nvme_®loc_iod
(
couÁ
, 
Ëngth
, 
dev
, 0, 
GFP_KERNEL
);

2254 
sg
 = 
iod
->sg;

2255 
	`sg_š™_bË
(
sg
, 
couÁ
);

2256 
i
 = 0; i < 
couÁ
; i++) {

2257 
	`sg_£t_·ge
(&
sg
[
i
], 
·ges
[i],

2258 
	`mš_t
(, 
Ëngth
, 
PAGE_SIZE
 - 
off£t
),

2259 
off£t
);

2260 
Ëngth
 -ğ(
PAGE_SIZE
 - 
off£t
);

2261 
off£t
 = 0;

2263 
	`sg_m¬k_’d
(&
sg
[
i
 - 1]);

2264 
iod
->
ÃÁs
 = 
couÁ
;

2266 
”r
 = -
ENOMEM
;

2267 
ÃÁs
 = 
	`dma_m­_sg
(&
dev
->
pci_dev
->dev, 
sg
, 
couÁ
,

2268 
wr™e
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

2269 ià(!
ÃÁs
)

2270 
ä“_iod
;

2272 
	`kä“
(
·ges
);

2273  
iod
;

2275 
ä“_iod
:

2276 
	`kä“
(
iod
);

2277 
i
 = 0; i < 
couÁ
; i++)

2278 
	`put_·ge
(
·ges
[
i
]);

2279 
	`kä“
(
·ges
);

2280  
	`ERR_PTR
(
”r
);

2281 
	}
}

2285 
	$u£r_addr_Åages
(
off£t
, 
size
)

2287 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

2288  
couÁ
;

2289 
	}
}

2291 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
)

2293 
off£t
 = 
	`off£t_š_·ge
(
addr
);

2294 
d©®’
 = 
Ën
;

2295 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
,
Ën
);

2296 
size
 = 0;

2297 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

2298 
m­³d_·ges
 = 0;

2299 
i
 = 0;

2301 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


2302 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

2304 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

2305 ià(!
u£r_ùx
) {

2306  
NULL
;

2309 
u£r_ùx
->
ÃÁs
 = 0;

2310 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

2311 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

2312 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

2313 0, 
u£r_ùx
->
·ges
);

2314 ià(
m­³d_·ges
 !ğ
num_·ge
) {

2315 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

2316 
ex™
;

2318 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

2319 
u£r_ùx
->
Ën
 = 
d©®’
;

2320 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

2321 
i
 = 0; i < 
num_·ge
; i++) {

2322 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

2323 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

2324 
off£t
);

2325 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

2326 
off£t
 = 0;

2328 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

2329  
u£r_ùx
;

2330 
ex™
:

2331 ià(
u£r_ùx
) {

2332 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

2333 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

2334 
	`kä“
(
u£r_ùx
);

2336  
NULL
;

2337 
	}
}

2339 
	$nvme_subm™_async_kv_cmd
(
»que¡
 * 
»q
, 
nvme_commªd
* 
cmd
, 
nvme_kaiocb
 *
aiocb
, 
timeout
) {

2340 
nvme_cmd_šfo
 *
cmd_šfo
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2341 
nvme_queue
 *
nvmeq
 = 
cmd_šfo
->nvmeq;

2343 
aiocb
->
ev’t
.
¡©us
 = -
EINTR
;

2344 
aiocb
->
»q
 =„eq;

2345 
»q
->
timeout
 =imeout;

2346 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

2348 
	`nvme_£t_šfo
(
cmd_šfo
, 
aiocb
, 
kv_async_com¶‘iÚ
);

2349  
	`nvme_subm™_cmd
(
nvmeq
, 
cmd
);

2350 
	}
}

2352 
boŞ
 
	$check_fÜ_sšgË_phyadd»ss
(
__u£r
* 
add»ss
, 
Ëngth
) {

2353 
off£t
 = 0;

2354 
couÁ
 = 0;

2355 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

2356 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

2357 ià(
couÁ
 > 1 && (()
add»ss
 & 
	`queue_dma_®ignm’t
(
NULL
))) {

2358  
çl£
;

2360  
Œue
;

2361 
	}
}

2362 
	$__nvme_subm™_kv_u£r_cmd
(
nvme_ns
 *
ns
, 
nvme_commªd
 *
cmd
,

2363 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

2364 
__u£r
 *
ubufãr
, 
bufæ’
,

2365 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
,

2366 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

2368 
nvme_dev
 *
dev
 = 
ns
->dev;

2369 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

2370 
sÿ‰”li¡
 *
m‘a_sg_±r
 = 
NULL
;

2371 
sÿ‰”li¡
 
m‘a_sg
;

2372 
nvme_iod
 *
iod
 = 
NULL
;

2373 
Ëngth
 = 0;

2374 
»t
 = 0;

2375 * 
m‘a
 = 
NULL
;

2376 * 
kv_d©a
 = 
NULL
;

2377 
boŞ
 
£t_m‘a
 = 
çl£
;

2378 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

2379 
·ge
 *
p_·ge
 = 
NULL
;

2380 
aio_u£r_ùx
 * 
u£r_ùx
 = 
NULL
;

2381 
»que¡
 *
»q
 = 
NULL
;

2383 
»q
 = 
	`blk_mq_®loc_»que¡
(
ns
->
queue
, 
WRITE
, (
GFP_KERNEL
|
__GFP_WAIT
), 
çl£
);

2384 ià(
	`IS_ERR
(
»q
))

2385  -
ENOMEM
;

2387 ià(
aio
) {

2388 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

2389 ià(!
aiocb
) {

2390 
»t
 = -
ENOMEM
;

2391 
out
;

2395 ià(
ubufãr
 && 
bufæ’
) {

2396 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
NULL
)) {

2397 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

2398 
Ãed_to_cİy
 = 
Œue
;

2399 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

2400 ià(
kv_d©a
 =ğ
NULL
) {

2401 
»t
 = -
ENOMEM
;

2402 
out
;

2405 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
);

2406 ià(
u£r_ùx
 =ğ
NULL
) {

2407 
»t
 = -
ENOMEM
;

2408 
ä“_out
;

2410 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

2411 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

2412 
kv_d©a
, 
u£r_ùx
->
Ën
);

2414 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

2415 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

2416 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

2420 
iod
 = 
	`nvme_m­_k”Ãl_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
±hr_cmd
->
İcode
), ()
kv_d©a
, 
bufæ’
);

2422 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
±hr_cmd
->
İcode
), ()
ubufãr
, 
bufæ’
);

2424 ià(
	`IS_ERR
(
iod
)) {

2425 
»t
 = -
ENOMEM
;

2426 
ä“_out
;

2428 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, 
iod
, 
bufæ’
, 
GFP_KERNEL
);

2429 ià(
Ëngth
 !ğ
bufæ’
) {

2430 
»t
 = -
ENOMEM
;

2431 
out_unm­
;

2433 
cmd
->
commÚ
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

2434 
cmd
->
commÚ
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

2436 ià(
aio
) {

2437 
aiocb
->
iod
 = iod;

2438 
aiocb
->
kv_d©a
 = kv_data;

2439 
aiocb
->
u£r_ùx
 = user_ctx;

2442 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

2443 
off£t
 = 0, 
Ën
 = 0;

2444 ià(!
	`check_fÜ_sšgË_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
)) {

2445 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256)*256;

2446 
m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

2447 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

2448 
»t
 = -
EFAULT
;

2449 
out
;

2451 
off£t
 = 
	`off£t_š_·ge
(
m‘a
);

2452 
p_·ge
 = 
	`vœt_to_·ge
(
m‘a
);

2453 
	`·ge_ÿche_g‘
(
p_·ge
);

2455 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 1, &
p_·ge
);

2456 ià(
»t
 < 1) {

2457 
»t
 = -
ENOMEM
;

2458 
out
;

2460 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

2462 ià(
aio
) {

2463 
aiocb
->
u£_m‘a
 = 
Œue
;

2464 
aiocb
->
m‘a
 = meta;

2465 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

2467 
m‘a_sg_±r
 = &
m‘a_sg
;

2469 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

2470 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

2471 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

2472 ià(!
	`dma_m­_sg
(&
dev
->
pci_dev
->dev, 
m‘a_sg_±r
, 1, 
DMA_TO_DEVICE
)) {

2473 
»t
 = -
ENOMEM
;

2474 
out_unm­
;

2476 
cmd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
m‘a_sg_±r
));

2477 
£t_m‘a
 = 
Œue
;

2480 ià(
aio
) {

2481 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

2482 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

2483 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

2484 
»t
 = 
	`nvme_subm™_async_kv_cmd
(
»q
, 
cmd
, 
aiocb
, 
timeout
);

2485 ià(
»t
 < 0) {

2486 *
¡©us
 = 
»t
;

2487 
out_unm­
;

2491 
»t
 = 
	`nvme_subm™_sync_cmd
(
»q
, 
cmd
, 
»suÉ
, 
timeout
);

2492 *
¡©us
 = 
»t
;

2495 ià(
Ãed_to_cİy
) {

2496 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

2497 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || ((ret& 0x00ff) == 0x0093)))) {

2499 *
d©a
 = 
kv_d©a
;

2500 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

2501 
d©a
[0], data[1], data[2], data[3],

2502 
d©a
[4], data[5], data[6], data[7]);

2504 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

2505 
kv_d©a
, 
u£r_ùx
->
Ën
);

2509 
out_unm­
:

2510 ià(
iod
) {

2511 
	`nvme_unm­_u£r_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
±hr_cmd
->
İcode
), 
iod
);

2512 
	`nvme_ä“_iod
(
dev
, 
iod
);

2514 ià(
p_·ge
) {

2515 ià(
£t_m‘a
)

2516 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, 
m‘a_sg_±r
, 1, 
DMA_TO_DEVICE
);

2517 
	`put_·ge
(
	`sg_·ge
(
m‘a_sg_±r
));

2519 
ä“_out
:

2520 ià(
u£r_ùx
) {

2521 
i
 = 0;

2522 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

2523 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

2524 
	`kä“
(
u£r_ùx
);

2526 ià(
kv_d©a
è
	`kä“
(kv_data);

2527 
out
:

2528 ià(
aio
)

2529 
	`mempoŞ_ä“
(
aiocb
, 
kaiocb_mempoŞ
);

2530 ià(
»q
)

2531 
	`blk_mq_ä“_»que¡
(
»q
);

2532  
»t
;

2533 
	}
}

2536 
	$nvme_u£r_kv_cmd
(
nvme_ns
 *
ns
, 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

2538 
nvme_·s¡hru_kv_cmd
 
cmd
;

2539 
nvme_commªd
 
c
;

2540 
¡©us
 = 0;

2541 
timeout
 = 
NVME_IO_TIMEOUT
;

2542 
__u£r
 *
m‘ad©a
 = 
NULL
;

2543 
m‘a_Ën
 = 0;

2544 
İtiÚ
 = 0;

2545 
™”_hªdË
 = 0;

2547 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

2548  -
EFAULT
;

2549 ià(
cmd
.
æags
)

2550  -
EINVAL
;

2551 ià(!
	`is_kv_cmd
(
cmd
.
İcode
))

2552  -
EINVAL
;

2554 
	`mem£t
(&
c
, 0, (c));

2555 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

2556 
c
.
commÚ
.
æags
 = 
cmd
.flags;

2557 #ifdeà
KSID_SUPPORT


2558 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

2560 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

2562 
timeout
 = 
cmd
.
timeout_ms
 ? 
	`m£cs_to_jiff›s
(cmd.timeout_ms) :

2563 
ADMIN_TIMEOUT
;

2564 
cmd
.
İcode
) {

2565 
nvme_cmd_kv_¡Üe
:

2566 
nvme_cmd_kv_­³nd
:

2567 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2568 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2570 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
) {

2571 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2572 
¡©us
 = -
EINVAL
;

2573 
ex™
;

2575 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2576 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

2578 ià(
cmd
.
d©a_Ëngth
 % 4) {

2579 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

2580 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

2582 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

2585 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2586 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

2587 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2589 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2592 
nvme_cmd_kv_»Œ›ve
:

2593 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2594 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2596 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

2597 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

2598 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2599 
¡©us
 = -
EINVAL
;

2600 
ex™
;

2602 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2603 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

2604 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

2606 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2607 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

2608 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2610 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2613 
nvme_cmd_kv_d–‘e
:

2614 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2616 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

2617 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

2618 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2619 
¡©us
 = -
EINVAL
;

2620 
ex™
;

2622 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2623 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

2624 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2625 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

2626 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2628 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2631 
nvme_cmd_kv_exi¡
:

2632 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2634 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

2635 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

2636 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2637 
¡©us
 = -
EINVAL
;

2638 
ex™
;

2640 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2641 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

2642 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2643 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

2644 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2646 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2650 
nvme_cmd_kv_™”_»q
:

2651 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2652 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2653 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

2654 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

2655 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

2656 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

2658 
nvme_cmd_kv_™”_»ad
:

2659 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2660 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2661 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

2662 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

2663 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

2666 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

2667 
¡©us
 = -
EINVAL
;

2668 
ex™
;

2671 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
, &
c
, &
cmd
,

2672 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
,

2673 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

2674 
ex™
:

2675 ià(!
aio
) {

2676 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

2677  -
EFAULT
;

2678 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

2679  -
EFAULT
;

2681  
¡©us
;

2682 
	}
}

2689 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
, 
cmd
,

2690 
¬g
)

2692 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2694 
cmd
) {

2695 
NVME_IOCTL_ID
:

2696 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

2697  
ns
->
ns_id
;

2698 
NVME_IOCTL_ADMIN_CMD
:

2699  
	`nvme_u£r_cmd
(
ns
->
dev
, 
NULL
, (
__u£r
 *)
¬g
);

2700 
NVME_IOCTL_IO_CMD
:

2701  
	`nvme_u£r_cmd
(
ns
->
dev
,‚s, (
__u£r
 *)
¬g
);

2702 
NVME_IOCTL_SUBMIT_IO
:

2703  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

2704 
SG_GET_VERSION_NUM
:

2705  
	`nvme_sg_g‘_v”siÚ_num
((
__u£r
 *)
¬g
);

2706 
SG_IO
:

2707  
	`nvme_sg_io
(
ns
, (
__u£r
 *)
¬g
);

2712 
NVME_IOCTL_AIO_CMD
:

2713  
	`nvme_u£r_kv_cmd
(
ns
, (
__u£r
 *)
¬g
, 
Œue
);

2714 
NVME_IOCTL_IO_KV_CMD
:

2715  
	`nvme_u£r_kv_cmd
(
ns
, (
__u£r
 *)
¬g
, 
çl£
);

2716 
NVME_IOCTL_SET_AIOCTX
:

2717  
	`nvme_£t_aioùx
((
__u£r
 *)
¬g
);

2718 
NVME_IOCTL_DEL_AIOCTX
:

2719  
	`nvme_d–_aioùx
((
__u£r
 *)
¬g
);

2720 
NVME_IOCTL_GET_AIOEVENT
:

2721  
	`nvme_g‘_aiÛv’ts
((
__u£r
 *)
¬g
);

2724  -
ENOTTY
;

2726 
	}
}

2728 #ifdeà
CONFIG_COMPAT


2729 
	$nvme_com·t_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

2730 
cmd
, 
¬g
)

2732 
cmd
) {

2733 
SG_IO
:

2734  -
ENOIOCTLCMD
;

2736  
	`nvme_ioùl
(
bdev
, 
mode
, 
cmd
, 
¬g
);

2737 
	}
}

2739 
	#nvme_com·t_ioùl
 
NULL


	)

2742 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

2744 
»t
 = 0;

2745 
nvme_ns
 *
ns
;

2747 
	`¥š_lock
(&
dev_li¡_lock
);

2748 
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2749 ià(!
ns
)

2750 
»t
 = -
ENXIO
;

2751 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
dev
->
k»f
))

2752 
»t
 = -
ENXIO
;

2753 
	`¥š_uÆock
(&
dev_li¡_lock
);

2755  
»t
;

2756 
	}
}

2758 
nvme_ä“_dev
(
k»f
 *kref);

2760 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

2762 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2763 
nvme_dev
 *
dev
 = 
ns
->dev;

2765 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

2766 
	}
}

2768 
	$nvme_g‘geo
(
block_deviû
 *
bd
, 
hd_geom‘ry
 *
geo
)

2771 
geo
->
h—ds
 = 1 << 6;

2772 
geo
->
£ùÜs
 = 1 << 5;

2773 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bd
->
bd_disk
) >> 11;

2775 
	}
}

2777 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

2779 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

2780 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

2781 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

2782 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

2783 
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
 = 0xffffffff;

2784 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

2785 
	}
}

2787 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

2789 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2790 
nvme_dev
 *
dev
 = 
ns
->dev;

2791 
nvme_id_ns
 *
id
;

2792 
dma_addr_t
 
dma_addr
;

2793 
u8
 
lbaf
;

2794 
u16
 
Şd_ms
;

2795 
bs
;

2797 
id
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 4096, &
dma_addr
,

2798 
GFP_KERNEL
);

2799 ià(!
id
) {

2800 
	`dev_w¬n
(&
dev
->
pci_dev
->dev, "%s: Memory‡location failure\n",

2801 
__func__
);

2805 ià(
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
)) {

2806 
	`dev_w¬n
(&
dev
->
pci_dev
->dev,

2808 
ns
->
ns_id
);

2809 
	`mem£t
(
id
, 0, (*id));

2812 ià(
id
->
nÿp
 == 0) {

2813 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 4096, 
id
, 
dma_addr
);

2814  -
ENODEV
;

2817 
Şd_ms
 = 
ns
->
ms
;

2818 
lbaf
 = 
id
->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
;

2819 
ns
->
lba_shiá
 = 
id
->
lbaf
[lbaf].
ds
;

2821 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[lbaf].ms);

2822 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

2828 ià(
ns
->
lba_shiá
 == 0)

2829 
ns
->
lba_shiá
 = 9;

2830 
bs
 = 1 << 
ns
->
lba_shiá
;

2832 ià(
	`blk_g‘_š‹gr™y
(
disk
è&& (
ns
->
ms
 !ğ
Şd_ms
 ||

2833 
bs
 !ğ
	`queue_logiÿl_block_size
(
disk
->
queue
) ||

2834 (
ns
->
ms
 &&‚s->
ext
)))

2835 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

2837 
ns
->
pi_ty³
 =‚s->
ms
 =ğ8 ? 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
 : 0;

2838 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 
bs
);

2840 ià(
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
è&& (disk->
æags
 & 
GENHD_FL_UP
) &&

2841 !
ns
->
ext
)

2842 
	`nvme_š™_š‹gr™y
(
ns
);

2844 ià((
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
) &&

2845 !(
ns
->
pi_ty³
 &&‚s->
ms
 == 8)))

2846 
	`£t_ÿ·c™y
(
disk
, 0);

2848 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

2850 ià(
dev
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

2851 
	`nvme_cÚfig_disÿrd
(
ns
);

2853 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 4096, 
id
, 
dma_addr
);

2855 
	}
}

2857 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

2858 .
owÃr
 = 
THIS_MODULE
,

2859 .
	gioùl
 = 
nvme_ioùl
,

2860 .
	gcom·t_ioùl
 = 
nvme_com·t_ioùl
,

2861 .
	gİ’
 = 
nvme_İ’
,

2862 .
	g»Ëa£
 = 
nvme_»Ëa£
,

2863 .
	gg‘geo
 = 
nvme_g‘geo
,

2864 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

2867 
	$nvme_kth»ad
(*
d©a
)

2869 
nvme_dev
 *
dev
, *
Ãxt
;

2871 !
	`kth»ad_should_¡İ
()) {

2872 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

2873 
	`¥š_lock
(&
dev_li¡_lock
);

2874 
	`li¡_fÜ_—ch_’Œy_§ã
(
dev
, 
Ãxt
, &
dev_li¡
, 
node
) {

2875 
i
;

2876 ià(
	`»adl
(&
dev
->
b¬
->
c¡s
è& 
NVME_CSTS_CFS
) {

2877 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

2879 
	`li¡_d–_š™
(&
dev
->
node
);

2880 
	`dev_w¬n
(&
dev
->
pci_dev
->dev,

2882 
	`»adl
(&
dev
->
b¬
->
c¡s
));

2883 
	`PREPARE_WORK
(&
dev
->
»£t_wÜk
,

2884 
nvme_»£t_çed_dev
);

2885 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2888 
i
 = 0; i < 
dev
->
queue_couÁ
; i++) {

2889 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

2890 ià(!
nvmeq
)

2892 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

2893 
	`nvme_´oûss_cq
(
nvmeq
);

2895 (
i
 =ğ0è&& (
dev
->
ev’t_lim™
 > 0)) {

2896 ià(
	`nvme_subm™_async_admš_»q
(
dev
))

2898 
dev
->
ev’t_lim™
--;

2900 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

2903 
	`¥š_uÆock
(&
dev_li¡_lock
);

2904 
	`scheduË_timeout
(
	`round_jiff›s_»Ïtive
(
HZ
));

2907 
	}
}

2909 
	$nvme_®loc_ns
(
nvme_dev
 *
dev
, 
nsid
)

2911 
nvme_ns
 *
ns
;

2912 
g’disk
 *
disk
;

2913 
node
 = 
	`dev_to_node
(&
dev
->
pci_dev
->dev);

2915 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

2916 ià(!
ns
)

2919 
ns
->
queue
 = 
	`blk_mq_š™_queue
(&
dev
->
g£t
);

2920 ià(
	`IS_ERR
(
ns
->
queue
))

2921 
out_ä“_ns
;

2922 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NOMERGES
, 
ns
->
queue
);

2923 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

2924 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_SG_GAPS
, 
ns
->
queue
);

2925 
ns
->
dev
 = dev;

2926 
ns
->
queue
->
queued©a
 =‚s;

2928 
disk
 = 
	`®loc_disk_node
(0, 
node
);

2929 ià(!
disk
)

2930 
out_ä“_queue
;

2932 
ns
->
ns_id
 = 
nsid
;

2933 
ns
->
disk
 = disk;

2934 
ns
->
lba_shiá
 = 9;

2935 
	`li¡_add_
(&
ns
->
li¡
, &
dev
->
Çme¥aûs
);

2937 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

2938 ià(
dev
->
max_hw_£ùÜs
)

2939 
	`blk_queue_max_hw_£ùÜs
(
ns
->
queue
, 
dev
->
max_hw_£ùÜs
);

2940 ià(
dev
->
¡re_size
)

2941 
	`blk_queue_chunk_£ùÜs
(
ns
->
queue
, 
dev
->
¡re_size
 >> 9);

2942 ià(
dev
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2943 
	`blk_queue_æush
(
ns
->
queue
, 
REQ_FLUSH
 | 
REQ_FUA
);

2945 
disk
->
majÜ
 = 
nvme_majÜ
;

2946 
disk
->
fœ¡_mšÜ
 = 0;

2947 
disk
->
fİs
 = &
nvme_fİs
;

2948 
disk
->
´iv©e_d©a
 = 
ns
;

2949 
disk
->
queue
 = 
ns
->queue;

2950 
disk
->
driv”fs_dev
 = 
dev
->
deviû
;

2951 
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

2952 
	`¥rštf
(
disk
->
disk_Çme
, "nvme%dn%d", 
dev
->
š¡ªû
, 
nsid
);

2960 
	`£t_ÿ·c™y
(
disk
, 0);

2961 ià(
	`nvme_»v®id©e_disk
(
ns
->
disk
))

2962 
out_ä“_disk
;

2964 
	`add_disk
(
ns
->
disk
);

2965 ià(
ns
->
ms
)

2966 
	`»v®id©e_disk
(
ns
->
disk
);

2968 
out_ä“_disk
:

2969 
	`kä“
(
disk
);

2970 
	`li¡_d–
(&
ns
->
li¡
);

2971 
out_ä“_queue
:

2972 
	`blk_ş—nup_queue
(
ns
->
queue
);

2973 
out_ä“_ns
:

2974 
	`kä“
(
ns
);

2975 
	}
}

2977 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

2979 
i
;

2981 
i
 = 
dev
->
queue_couÁ
; i <ğdev->
max_qid
; i++)

2982 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
))

2985 
i
 = 
dev
->
Úlše_queues
; i <ğdev->
queue_couÁ
 - 1; i++)

2986 ià(
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i))

2988 
	}
}

2990 
	$£t_queue_couÁ
(
nvme_dev
 *
dev
, 
couÁ
)

2992 
¡©us
;

2993 
u32
 
»suÉ
;

2994 
u32
 
q_couÁ
 = (
couÁ
 - 1) | ((count - 1) << 16);

2996 
¡©us
 = 
	`nvme_£t_ã©u»s
(
dev
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 0,

2997 &
»suÉ
);

2998 ià(
¡©us
 < 0)

2999  
¡©us
;

3000 ià(
¡©us
 > 0) {

3001 
	`dev_”r
(&
dev
->
pci_dev
->dev, "Could‚ot set queue count (%d)\n",

3002 
¡©us
);

3005  
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

3006 
	}
}

3008 
size_t
 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

3010  4096 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

3011 
	}
}

3013 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

3015 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

3016 
pci_dev
 *
pdev
 = 
dev
->pci_dev;

3017 
»suÉ
, 
i
, 
vecs
, 
Ä_io_queues
, 
size
;

3019 
Ä_io_queues
 = 
	`num_possibË_ıus
();

3020 
»suÉ
 = 
	`£t_queue_couÁ
(
dev
, 
Ä_io_queues
);

3021 ià(
»suÉ
 <= 0)

3022  
»suÉ
;

3023 ià(
»suÉ
 < 
Ä_io_queues
)

3024 
Ä_io_queues
 = 
»suÉ
;

3026 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

3027 ià(
size
 > 8192) {

3028 
	`iounm­
(
dev
->
b¬
);

3030 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

3031 ià(
dev
->
b¬
)

3033 ià(!--
Ä_io_queues
)

3034  -
ENOMEM
;

3035 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

3037 
dev
->
dbs
 = ((
__iomem
 *)dev->
b¬
) + 4096;

3038 
admšq
->
q_db
 = 
dev
->
dbs
;

3042 
	`ä“_œq
(
dev
->
’Œy
[0].
veùÜ
, 
admšq
);

3048 ià(!
pdev
->
œq
)

3049 
	`pci_di§bË_msix
(
pdev
);

3051 
vecs
 = 
Ä_io_queues
;

3052 
i
 = 0; i < 
vecs
; i++)

3053 
dev
->
’Œy
[
i
].entry = i;

3055 
»suÉ
 = 
	`pci_’abË_msix
(
pdev
, 
dev
->
’Œy
, 
vecs
);

3056 ià(
»suÉ
 <= 0)

3058 
vecs
 = 
»suÉ
;

3061 ià(
»suÉ
 < 0) {

3062 
vecs
 = 
Ä_io_queues
;

3063 ià(
vecs
 > 32)

3064 
vecs
 = 32;

3066 
»suÉ
 = 
	`pci_’abË_msi_block
(
pdev
, 
vecs
);

3067 ià(
»suÉ
 == 0) {

3068 
i
 = 0; i < 
vecs
; i++)

3069 
dev
->
’Œy
[
i
].
veùÜ
 = i + 
pdev
->
œq
;

3071 } ià(
»suÉ
 < 0) {

3072 
vecs
 = 1;

3075 
vecs
 = 
»suÉ
;

3085 
Ä_io_queues
 = 
vecs
;

3086 
dev
->
max_qid
 = 
Ä_io_queues
;

3088 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
admšq
,‡dmšq->
œqÇme
);

3089 ià(
»suÉ
)

3090 
ä“_queues
;

3093 
	`nvme_ä“_queues
(
dev
, 
Ä_io_queues
 + 1);

3094 
	`nvme_ü—‹_io_queues
(
dev
);

3098 
ä“_queues
:

3099 
	`nvme_ä“_queues
(
dev
, 1);

3100  
»suÉ
;

3101 
	}
}

3103 
	$nvme_ä“_Çme¥aû
(
nvme_ns
 *
ns
)

3105 
	`li¡_d–
(&
ns
->
li¡
);

3107 
	`¥š_lock
(&
dev_li¡_lock
);

3108 
ns
->
disk
->
´iv©e_d©a
 = 
NULL
;

3109 
	`¥š_uÆock
(&
dev_li¡_lock
);

3111 
	`put_disk
(
ns
->
disk
);

3112 
	`kä“
(
ns
);

3113 
	}
}

3115 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

3117 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

3118 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

3120  
n§
->
ns_id
 - 
nsb
->ns_id;

3121 
	}
}

3123 
nvme_ns
 *
	$nvme_fšd_ns
(
nvme_dev
 *
dev
, 
nsid
)

3125 
nvme_ns
 *
ns
;

3127 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
dev
->
Çme¥aûs
, 
li¡
) {

3128 ià(
ns
->
ns_id
 =ğ
nsid
)

3129  
ns
;

3130 ià(
ns
->
ns_id
 > 
nsid
)

3133  
NULL
;

3134 
	}
}

3136 
šlše
 
boŞ
 
	$nvme_io_šÿ·bË
(
nvme_dev
 *
dev
)

3138  (!
dev
->
b¬
 || 
	`»adl
(&dev->b¬->
c¡s
è& 
NVME_CSTS_CFS
 ||

3139 
dev
->
Úlše_queues
 < 2);

3140 
	}
}

3142 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

3144 
boŞ
 
kl
 = 
	`nvme_io_šÿ·bË
(
ns
->
dev
è&& !
	`blk_queue_dyšg
Òs->
queue
);

3146 ià(
kl
)

3147 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

3148 ià(
ns
->
disk
->
æags
 & 
GENHD_FL_UP
) {

3149 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

3150 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

3151 
	`d–_g’disk
(
ns
->
disk
);

3153 ià(
kl
 || !
	`blk_queue_dyšg
(
ns
->
queue
)) {

3154 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

3155 
	`blk_ş—nup_queue
(
ns
->
queue
);

3157 
	}
}

3159 
	$nvme_sÿn_Çme¥aûs
(
nvme_dev
 *
dev
, 
Â
)

3161 
nvme_ns
 *
ns
, *
Ãxt
;

3162 
i
;

3164 
i
 = 1; i <ğ
Â
; i++) {

3165 
ns
 = 
	`nvme_fšd_ns
(
dev
, 
i
);

3166 ià(
ns
) {

3167 ià(
	`»v®id©e_disk
(
ns
->
disk
)) {

3168 
	`nvme_ns_»move
(
ns
);

3169 
	`nvme_ä“_Çme¥aû
(
ns
);

3172 
	`nvme_®loc_ns
(
dev
, 
i
);

3174 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
dev
->
Çme¥aûs
, 
li¡
) {

3175 ià(
ns
->
ns_id
 > 
Â
) {

3176 
	`nvme_ns_»move
(
ns
);

3177 
	`nvme_ä“_Çme¥aû
(
ns
);

3180 
	`li¡_sÜt
(
NULL
, &
dev
->
Çme¥aûs
, 
ns_cmp
);

3181 
	}
}

3183 
	$nvme_dev_sÿn
(
wÜk_¡ruù
 *
wÜk
)

3185 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
sÿn_wÜk
);

3186 
nvme_id_ù¾
 *
ù¾
;

3187 *
mem
;

3188 
dma_addr_t
 
dma_addr
;

3190 ià(!
dev
->
g£t
.
gs
)

3193 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 4096, &
dma_addr
, 
GFP_KERNEL
);

3194 ià(!
mem
)

3196 ià(
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
)) {

3197 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 4096, 
mem
, 
dma_addr
);

3200 
ù¾
 = 
mem
;

3201 
	`nvme_sÿn_Çme¥aûs
(
dev
, 
	`Ë32_to_ıup
(&
ù¾
->
Â
));

3202 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 4096, 
mem
, 
dma_addr
);

3203 
	}
}

3211 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

3213 
pci_dev
 *
pdev
 = 
dev
->pci_dev;

3214 
»s
;

3215 
Â
;

3216 
nvme_id_ù¾
 *
ù¾
;

3217 *
mem
;

3218 
dma_addr_t
 
dma_addr
;

3219 
shiá
 = 
	`NVME_CAP_MPSMIN
(
	`»adq
(&
dev
->
b¬
->
ÿp
)) + 12;

3221 
mem
 = 
	`dma_®loc_coh”’t
(&
pdev
->
dev
, 4096, &
dma_addr
, 
GFP_KERNEL
);

3222 ià(!
mem
)

3223  -
ENOMEM
;

3225 
»s
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

3226 ià(
»s
) {

3227 
	`dev_”r
(&
pdev
->
dev
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»s
);

3228 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 4096, 
mem
, 
dma_addr
);

3229  -
EIO
;

3232 
ù¾
 = 
mem
;

3233 
Â
 = 
	`Ë32_to_ıup
(&
ù¾
->nn);

3234 
dev
->
Úcs
 = 
	`Ë16_to_ıup
(&
ù¾
->oncs);

3235 
dev
->
abÜt_lim™
 = 
ù¾
->
aş
 + 1;

3236 
dev
->
vwc
 = 
ù¾
->vwc;

3237 
	`memıy
(
dev
->
£rŸl
, 
ù¾
->
¢
, (ctrl->sn));

3238 
	`memıy
(
dev
->
mod–
, 
ù¾
->
mn
, (ctrl->mn));

3239 
	`memıy
(
dev
->
fœmw¬e_»v
, 
ù¾
->
ä
, (ctrl->fr));

3240 ià(
ù¾
->
mdts
)

3241 
dev
->
max_hw_£ùÜs
 = 1 << (
ù¾
->
mdts
 + 
shiá
 - 9);

3242 ià((
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_INTEL
) &&

3243 (
pdev
->
deviû
 =ğ0x0953è&& 
ù¾
->
vs
[3]) {

3244 
max_hw_£ùÜs
;

3246 
dev
->
¡re_size
 = 1 << (
ù¾
->
vs
[3] + 
shiá
);

3247 
max_hw_£ùÜs
 = 
dev
->
¡re_size
 >> (
shiá
 - 9);

3248 ià(
dev
->
max_hw_£ùÜs
) {

3249 
dev
->
max_hw_£ùÜs
 = 
	`mš
(max_hw_sectors,

3250 
dev
->
max_hw_£ùÜs
);

3252 
dev
->
max_hw_£ùÜs
 = max_hw_sectors;

3254 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 4096, 
mem
, 
dma_addr
);

3256 ià(!
dev
->
g£t
.
gs
) {

3257 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

3258 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

3259 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

3260 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(&dev->
pci_dev
->dev);

3261 
dev
->
g£t
.
queue_d•th
 =

3262 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

3263 
dev
->
g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

3264 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

3265 
dev
->
g£t
.
driv”_d©a
 = dev;

3267 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

3270 
	`scheduË_wÜk
(&
dev
->
sÿn_wÜk
);

3272 
	}
}

3274 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

3276 
u64
 
ÿp
;

3277 
b¬s
, 
»suÉ
 = -
ENOMEM
;

3278 
pci_dev
 *
pdev
 = 
dev
->pci_dev;

3280 ià(
	`pci_’abË_deviû_mem
(
pdev
))

3281  
»suÉ
;

3283 
dev
->
’Œy
[0].
veùÜ
 = 
pdev
->
œq
;

3284 
	`pci_£t_ma¡”
(
pdev
);

3285 
b¬s
 = 
	`pci_£Ëù_b¬s
(
pdev
, 
IORESOURCE_MEM
);

3286 ià(!
b¬s
)

3287 
di§bË_pci
;

3289 ià(
	`pci_»que¡_£Ëùed_»giÚs
(
pdev
, 
b¬s
, "nvme"))

3290 
di§bË_pci
;

3292 ià(
	`dma_£t_mask_ªd_coh”’t
(&
pdev
->
dev
, 
	`DMA_BIT_MASK
(64)) &&

3293 
	`dma_£t_mask_ªd_coh”’t
(&
pdev
->
dev
, 
	`DMA_BIT_MASK
(32)))

3294 
di§bË
;

3296 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 8192);

3297 ià(!
dev
->
b¬
)

3298 
di§bË
;

3300 ià(
	`»adl
(&
dev
->
b¬
->
c¡s
) == -1) {

3301 
»suÉ
 = -
ENODEV
;

3302 
unm­
;

3309 ià(!
pdev
->
œq
) {

3310 
»suÉ
 = 
	`pci_’abË_msix
(
pdev
, 
dev
->
’Œy
, 1);

3311 ià(
»suÉ
 < 0)

3312 
unm­
;

3315 
ÿp
 = 
	`»adq
(&
dev
->
b¬
->cap);

3316 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ÿp
è+ 1, 
NVME_Q_DEPTH
);

3317 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(
ÿp
);

3318 
dev
->
dbs
 = ((
__iomem
 *)dev->
b¬
) + 4096;

3322 
unm­
:

3323 
	`iounm­
(
dev
->
b¬
);

3324 
dev
->
b¬
 = 
NULL
;

3325 
di§bË
:

3326 
	`pci_»Ëa£_»giÚs
(
pdev
);

3327 
di§bË_pci
:

3328 
	`pci_di§bË_deviû
(
pdev
);

3329  
»suÉ
;

3330 
	}
}

3332 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

3334 ià(
dev
->
pci_dev
->
msi_’abËd
)

3335 
	`pci_di§bË_msi
(
dev
->
pci_dev
);

3336 ià(
dev
->
pci_dev
->
msix_’abËd
)

3337 
	`pci_di§bË_msix
(
dev
->
pci_dev
);

3339 ià(
dev
->
b¬
) {

3340 
	`iounm­
(
dev
->
b¬
);

3341 
dev
->
b¬
 = 
NULL
;

3342 
	`pci_»Ëa£_»giÚs
(
dev
->
pci_dev
);

3345 ià(
	`pci_is_’abËd
(
dev
->
pci_dev
))

3346 
	`pci_di§bË_deviû
(
dev
->
pci_dev
);

3347 
	}
}

3349 
	snvme_d–q_ùx
 {

3350 
sk_¡ruù
 *
	mwa™”
;

3351 
kth»ad_wÜk”
* 
	mwÜk”
;

3352 
©omic_t
 
	m»fcouÁ
;

3355 
	$nvme_wa™_dq
(
nvme_d–q_ùx
 *
dq
, 
nvme_dev
 *
dev
)

3357 
dq
->
wa™”
 = 
cu¼’t
;

3358 
	`mb
();

3361 
	`£t_cu¼’t_¡©e
(
TASK_KILLABLE
);

3362 ià(!
	`©omic_»ad
(&
dq
->
»fcouÁ
))

3364 ià(!
	`scheduË_timeout
(
ADMIN_TIMEOUT
) ||

3365 
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3373 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

3374 
	`nvme_di§bË_ù¾
(
dev
, 
	`»adq
(&dev->
b¬
->
ÿp
));

3375 
	`nvme_ş—r_queue
(
dev
->
queues
[0]);

3376 
	`æush_kth»ad_wÜk”
(
dq
->
wÜk”
);

3377 
	`nvme_di§bË_queue
(
dev
, 0);

3381 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

3382 
	}
}

3384 
	$nvme_put_dq
(
nvme_d–q_ùx
 *
dq
)

3386 
	`©omic_dec
(&
dq
->
»fcouÁ
);

3387 ià(
dq
->
wa™”
)

3388 
	`wake_up_´oûss
(
dq
->
wa™”
);

3389 
	}
}

3391 
nvme_d–q_ùx
 *
	$nvme_g‘_dq
(
nvme_d–q_ùx
 *
dq
)

3393 
	`©omic_šc
(&
dq
->
»fcouÁ
);

3394  
dq
;

3395 
	}
}

3397 
	$nvme_d–_queue_’d
(
nvme_queue
 *
nvmeq
)

3399 
nvme_d–q_ùx
 *
dq
 = 
nvmeq
->
cmdšfo
.
ùx
;

3400 
	`nvme_put_dq
(
dq
);

3401 
	}
}

3403 
	$ad­‹r_async_d–_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
,

3404 
kth»ad_wÜk_func_t
 
â
)

3406 
nvme_commªd
 
c
;

3408 
	`mem£t
(&
c
, 0, (c));

3409 
c
.
d–‘e_queue
.
İcode
 = opcode;

3410 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

3412 
	`š™_kth»ad_wÜk
(&
nvmeq
->
cmdšfo
.
wÜk
, 
â
);

3413  
	`nvme_subm™_admš_async_cmd
(
nvmeq
->
dev
, &
c
, &nvmeq->
cmdšfo
,

3414 
ADMIN_TIMEOUT
);

3415 
	}
}

3417 
	$nvme_d–_cq_wÜk_hªdËr
(
kth»ad_wÜk
 *
wÜk
)

3419 
nvme_queue
 *
nvmeq
 = 
	`cÚš”_of
(
wÜk
, nvme_queue,

3420 
cmdšfo
.
wÜk
);

3421 
	`nvme_d–_queue_’d
(
nvmeq
);

3422 
	}
}

3424 
	$nvme_d–‘e_cq
(
nvme_queue
 *
nvmeq
)

3426  
	`ad­‹r_async_d–_queue
(
nvmeq
, 
nvme_admš_d–‘e_cq
,

3427 
nvme_d–_cq_wÜk_hªdËr
);

3428 
	}
}

3430 
	$nvme_d–_sq_wÜk_hªdËr
(
kth»ad_wÜk
 *
wÜk
)

3432 
nvme_queue
 *
nvmeq
 = 
	`cÚš”_of
(
wÜk
, nvme_queue,

3433 
cmdšfo
.
wÜk
);

3434 
¡©us
 = 
nvmeq
->
cmdšfo
.status;

3436 ià(!
¡©us
)

3437 
¡©us
 = 
	`nvme_d–‘e_cq
(
nvmeq
);

3438 ià(
¡©us
)

3439 
	`nvme_d–_queue_’d
(
nvmeq
);

3440 
	}
}

3442 
	$nvme_d–‘e_sq
(
nvme_queue
 *
nvmeq
)

3444  
	`ad­‹r_async_d–_queue
(
nvmeq
, 
nvme_admš_d–‘e_sq
,

3445 
nvme_d–_sq_wÜk_hªdËr
);

3446 
	}
}

3448 
	$nvme_d–_queue_¡¬t
(
kth»ad_wÜk
 *
wÜk
)

3450 
nvme_queue
 *
nvmeq
 = 
	`cÚš”_of
(
wÜk
, nvme_queue,

3451 
cmdšfo
.
wÜk
);

3452 ià(
	`nvme_d–‘e_sq
(
nvmeq
))

3453 
	`nvme_d–_queue_’d
(
nvmeq
);

3454 
	}
}

3456 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
)

3458 
i
;

3459 
	`DEFINE_KTHREAD_WORKER_ONSTACK
(
wÜk”
);

3460 
nvme_d–q_ùx
 
dq
;

3461 
sk_¡ruù
 *
kwÜk”_sk
 = 
	`kth»ad_run
(
kth»ad_wÜk”_â
,

3462 &
wÜk”
, "nvme%d", 
dev
->
š¡ªû
);

3464 ià(
	`IS_ERR
(
kwÜk”_sk
)) {

3465 
	`dev_”r
(&
dev
->
pci_dev
->dev,

3467 
i
 = 
dev
->
queue_couÁ
 - 1; i > 0; i--)

3468 
	`nvme_di§bË_queue
(
dev
, 
i
);

3472 
dq
.
wa™”
 = 
NULL
;

3473 
	`©omic_£t
(&
dq
.
»fcouÁ
, 0);

3474 
dq
.
wÜk”
 = &worker;

3475 
i
 = 
dev
->
queue_couÁ
 - 1; i > 0; i--) {

3476 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

3478 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

3480 
nvmeq
->
cmdšfo
.
ùx
 = 
	`nvme_g‘_dq
(&
dq
);

3481 
nvmeq
->
cmdšfo
.
wÜk”
 = 
dq
.worker;

3482 
	`š™_kth»ad_wÜk
(&
nvmeq
->
cmdšfo
.
wÜk
, 
nvme_d–_queue_¡¬t
);

3483 
	`queue_kth»ad_wÜk
(
dq
.
wÜk”
, &
nvmeq
->
cmdšfo
.
wÜk
);

3485 
	`nvme_wa™_dq
(&
dq
, 
dev
);

3486 
	`kth»ad_¡İ
(
kwÜk”_sk
);

3487 
	}
}

3493 
	$nvme_dev_li¡_»move
(
nvme_dev
 *
dev
)

3495 
sk_¡ruù
 *
tmp
 = 
NULL
;

3497 
	`¥š_lock
(&
dev_li¡_lock
);

3498 
	`li¡_d–_š™
(&
dev
->
node
);

3499 ià(
	`li¡_em±y
(&
dev_li¡
è&& !
	`IS_ERR_OR_NULL
(
nvme_th»ad
)) {

3500 
tmp
 = 
nvme_th»ad
;

3501 
nvme_th»ad
 = 
NULL
;

3503 
	`¥š_uÆock
(&
dev_li¡_lock
);

3505 ià(
tmp
)

3506 
	`kth»ad_¡İ
(
tmp
);

3507 
	}
}

3509 
	$nvme_ä“ze_queues
(
nvme_dev
 *
dev
)

3511 
nvme_ns
 *
ns
;

3513 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
dev
->
Çme¥aûs
, 
li¡
) {

3514 
	`blk_mq_ä“ze_queue_¡¬t
(
ns
->
queue
);

3516 
	`¥š_lock_œq
(
ns
->
queue
->
queue_lock
);

3517 
	`queue_æag_£t
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

3518 
	`¥š_uÆock_œq
(
ns
->
queue
->
queue_lock
);

3520 
	`blk_mq_ÿnûl_»queue_wÜk
(
ns
->
queue
);

3521 
	`blk_mq_¡İ_hw_queues
(
ns
->
queue
);

3523 
	}
}

3525 
	$nvme_unä“ze_queues
(
nvme_dev
 *
dev
)

3527 
nvme_ns
 *
ns
;

3529 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
dev
->
Çme¥aûs
, 
li¡
) {

3530 
	`queue_æag_ş—r_uÆocked
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

3531 
	`blk_mq_unä“ze_queue
(
ns
->
queue
);

3532 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

3533 
	`blk_mq_kick_»queue_li¡
(
ns
->
queue
);

3535 
	}
}

3537 
	$nvme_dev_shutdown
(
nvme_dev
 *
dev
)

3539 
i
;

3540 
u32
 
c¡s
 = -1;

3542 
	`nvme_dev_li¡_»move
(
dev
);

3544 ià(
dev
->
b¬
) {

3545 
	`nvme_ä“ze_queues
(
dev
);

3546 
c¡s
 = 
	`»adl
(&
dev
->
b¬
->csts);

3548 ià(
c¡s
 & 
NVME_CSTS_CFS
 || !(c¡ & 
NVME_CSTS_RDY
)) {

3549 
i
 = 
dev
->
queue_couÁ
 - 1; i >= 0; i--) {

3550 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

3551 
	`nvme_su¥’d_queue
(
nvmeq
);

3554 
	`nvme_di§bË_io_queues
(
dev
);

3555 
	`nvme_shutdown_ù¾
(
dev
);

3556 
	`nvme_di§bË_queue
(
dev
, 0);

3558 
	`nvme_dev_unm­
(
dev
);

3560 
i
 = 
dev
->
queue_couÁ
 - 1; i >= 0; i--)

3561 
	`nvme_ş—r_queue
(
dev
->
queues
[
i
]);

3562 
	}
}

3564 
	$nvme_dev_»move
(
nvme_dev
 *
dev
)

3566 
nvme_ns
 *
ns
;

3568 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
dev
->
Çme¥aûs
, 
li¡
)

3569 
	`nvme_ns_»move
(
ns
);

3570 
	}
}

3572 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

3574 
deviû
 *
dmadev
 = &
dev
->
pci_dev
->dev;

3575 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("´°li¡…age", 
dmadev
,

3576 
PAGE_SIZE
, PAGE_SIZE, 0);

3577 ià(!
dev
->
´p_·ge_poŞ
)

3578  -
ENOMEM
;

3581 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("´°li¡ 256", 
dmadev
,

3583 ià(!
dev
->
´p_sm®l_poŞ
) {

3584 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

3585  -
ENOMEM
;

3588 
	}
}

3590 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

3592 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

3593 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

3594 
	}
}

3596 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

3598 
	$nvme_£t_š¡ªû
(
nvme_dev
 *
dev
)

3600 
š¡ªû
, 
”rÜ
;

3603 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

3604  -
ENODEV
;

3606 
	`¥š_lock
(&
dev_li¡_lock
);

3607 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

3608 
	`¥š_uÆock
(&
dev_li¡_lock
);

3609 } 
”rÜ
 =ğ-
EAGAIN
);

3611 ià(
”rÜ
)

3612  -
ENODEV
;

3614 
dev
->
š¡ªû
 = instance;

3616 
	}
}

3618 
	$nvme_»Ëa£_š¡ªû
(
nvme_dev
 *
dev
)

3620 
	`¥š_lock
(&
dev_li¡_lock
);

3621 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
dev
->
š¡ªû
);

3622 
	`¥š_uÆock
(&
dev_li¡_lock
);

3623 
	}
}

3625 
	$nvme_ä“_Çme¥aûs
(
nvme_dev
 *
dev
)

3627 
nvme_ns
 *
ns
, *
Ãxt
;

3629 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
dev
->
Çme¥aûs
, 
li¡
)

3630 
	`nvme_ä“_Çme¥aû
(
ns
);

3631 
	}
}

3633 
	$nvme_ä“_dev
(
k»f
 *kref)

3635 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
k»f
, nvme_dev, kref);

3637 
	`pci_dev_put
(
dev
->
pci_dev
);

3638 
	`put_deviû
(
dev
->
deviû
);

3639 
	`nvme_ä“_Çme¥aûs
(
dev
);

3640 
	`nvme_»Ëa£_š¡ªû
(
dev
);

3641 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

3642 
	`blk_put_queue
(
dev
->
admš_q
);

3643 
	`kä“
(
dev
->
queues
);

3644 
	`kä“
(
dev
->
’Œy
);

3645 
	`kä“
(
dev
);

3646 
	}
}

3648 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *
f
)

3650 
nvme_dev
 *
dev
;

3651 
š¡ªû
 = 
	`imšÜ
(
šode
);

3652 
»t
 = -
ENODEV
;

3654 
	`¥š_lock
(&
dev_li¡_lock
);

3655 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
dev_li¡
, 
node
) {

3656 ià(
dev
->
š¡ªû
 == instance) {

3657 ià(!
dev
->
admš_q
) {

3658 
»t
 = -
EWOULDBLOCK
;

3661 ià(!
	`k»f_g‘_uÆess_z”o
(&
dev
->
k»f
))

3663 
f
->
´iv©e_d©a
 = 
dev
;

3664 
»t
 = 0;

3668 
	`¥š_uÆock
(&
dev_li¡_lock
);

3670  
»t
;

3671 
	}
}

3673 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *
f
)

3675 
nvme_dev
 *
dev
 = 
f
->
´iv©e_d©a
;

3676 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

3678 
	}
}

3680 
	$nvme_dev_ioùl
(
fe
 *
f
, 
cmd
, 
¬g
)

3682 
nvme_dev
 *
dev
 = 
f
->
´iv©e_d©a
;

3683 
nvme_ns
 *
ns
;

3685 
cmd
) {

3686 
NVME_IOCTL_ADMIN_CMD
:

3687  
	`nvme_u£r_cmd
(
dev
, 
NULL
, (
__u£r
 *)
¬g
);

3688 
NVME_IOCTL_IO_CMD
:

3689 ià(
	`li¡_em±y
(&
dev
->
Çme¥aûs
))

3690  -
ENOTTY
;

3691 
ns
 = 
	`li¡_fœ¡_’Œy
(&
dev
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

3692  
	`nvme_u£r_cmd
(
dev
, 
ns
, (
__u£r
 *)
¬g
);

3693 
NVME_IOCTL_RESET
:

3694 
	`dev_w¬n
(&
dev
->
pci_dev
->dev, "resetting controller\n");

3695  
	`nvme_»£t
(
dev
);

3697  -
ENOTTY
;

3699 
	}
}

3701 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

3702 .
owÃr
 = 
THIS_MODULE
,

3703 .
	gİ’
 = 
nvme_dev_İ’
,

3704 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

3705 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

3706 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

3709 
	$nvme_£t_œq_hšts
(
nvme_dev
 *
dev
)

3711 
nvme_queue
 *
nvmeq
;

3712 
i
;

3714 
i
 = 0; i < 
dev
->
Úlše_queues
; i++) {

3715 
nvmeq
 = 
dev
->
queues
[
i
];

3717 ià(!
nvmeq
->
gs
 || !(*nvmeq->tags))

3720 
	`œq_£t_affš™y_hšt
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

3721 
	`blk_mq_gs_ıumask
(*
nvmeq
->
gs
));

3723 
	}
}

3725 
	$nvme_dev_¡¬t
(
nvme_dev
 *
dev
)

3727 
»suÉ
;

3728 
boŞ
 
¡¬t_th»ad
 = 
çl£
;

3730 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

3731 ià(
»suÉ
)

3732  
»suÉ
;

3734 
»suÉ
 = 
	`nvme_cÚfigu»_admš_queue
(
dev
);

3735 ià(
»suÉ
)

3736 
unm­
;

3738 
	`¥š_lock
(&
dev_li¡_lock
);

3739 ià(
	`li¡_em±y
(&
dev_li¡
è&& 
	`IS_ERR_OR_NULL
(
nvme_th»ad
)) {

3740 
¡¬t_th»ad
 = 
Œue
;

3741 
nvme_th»ad
 = 
NULL
;

3743 
	`li¡_add
(&
dev
->
node
, &
dev_li¡
);

3744 
	`¥š_uÆock
(&
dev_li¡_lock
);

3746 ià(
¡¬t_th»ad
) {

3747 
nvme_th»ad
 = 
	`kth»ad_run
(
nvme_kth»ad
, 
NULL
, "nvme");

3748 
	`wake_up_®l
(&
nvme_kth»ad_wa™
);

3750 
	`wa™_ev’t_kÏbË
(
nvme_kth»ad_wa™
, 
nvme_th»ad
);

3752 ià(
	`IS_ERR_OR_NULL
(
nvme_th»ad
)) {

3753 
»suÉ
 = 
nvme_th»ad
 ? 
	`PTR_ERR
Òvme_th»adè: -
EINTR
;

3754 
di§bË
;

3757 
	`nvme_š™_queue
(
dev
->
queues
[0], 0);

3758 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

3759 ià(
»suÉ
)

3760 
di§bË
;

3762 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

3763 ià(
»suÉ
)

3764 
ä“_gs
;

3766 
	`nvme_£t_œq_hšts
(
dev
);

3768 
dev
->
ev’t_lim™
 = 1;

3769  
»suÉ
;

3771 
ä“_gs
:

3772 
	`nvme_dev_»move_admš
(
dev
);

3773 
di§bË
:

3774 
	`nvme_di§bË_queue
(
dev
, 0);

3775 
	`nvme_dev_li¡_»move
(
dev
);

3776 
unm­
:

3777 
	`nvme_dev_unm­
(
dev
);

3778  
»suÉ
;

3779 
	}
}

3781 
	$nvme_»move_d—d_ù¾
(*
¬g
)

3783 
nvme_dev
 *
dev
 = (nvme_dev *)
¬g
;

3784 
pci_dev
 *
pdev
 = 
dev
->pci_dev;

3786 ià(
	`pci_g‘_drvd©a
(
pdev
))

3787 
	`pci_¡İ_ªd_»move_bus_deviû_locked
(
pdev
);

3788 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

3790 
	}
}

3792 
	$nvme_»move_disks
(
wÜk_¡ruù
 *
ws
)

3794 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
ws
, nvme_dev, 
»£t_wÜk
);

3796 
	`nvme_ä“_queues
(
dev
, 1);

3797 
	`nvme_dev_»move
(
dev
);

3798 
	}
}

3800 
	$nvme_dev_»sume
(
nvme_dev
 *
dev
)

3802 
»t
;

3804 
»t
 = 
	`nvme_dev_¡¬t
(
dev
);

3805 ià(
»t
)

3806  
»t
;

3807 ià(
dev
->
Úlše_queues
 < 2) {

3808 
	`¥š_lock
(&
dev_li¡_lock
);

3809 
	`PREPARE_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»move_disks
);

3810 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

3811 
	`¥š_uÆock
(&
dev_li¡_lock
);

3813 
	`nvme_unä“ze_queues
(
dev
);

3814 
	`nvme_dev_add
(
dev
);

3815 
	`nvme_£t_œq_hšts
(
dev
);

3818 
	}
}

3820 
	$nvme_d—d_ù¾
(
nvme_dev
 *
dev
)

3822 
	`dev_w¬n
(&
dev
->
pci_dev
->dev, "Device failedo„esume\n");

3823 
	`k»f_g‘
(&
dev
->
k»f
);

3824 ià(
	`IS_ERR
(
	`kth»ad_run
(
nvme_»move_d—d_ù¾
, 
dev
, "nvme%d",

3825 
dev
->
š¡ªû
))) {

3826 
	`dev_”r
(&
dev
->
pci_dev
->dev,

3828 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

3830 
	}
}

3832 
	$nvme_dev_»£t
(
nvme_dev
 *
dev
)

3834 
boŞ
 
š_´obe
 = 
	`wÜk_busy
(&
dev
->
´obe_wÜk
);

3836 
	`nvme_dev_shutdown
(
dev
);

3840 
	`æush_wÜk
(&
dev
->
´obe_wÜk
);

3844 ià(
š_´obe
) {

3845 
	`nvme_d—d_ù¾
(
dev
);

3850 
	`scheduË_wÜk
(&
dev
->
´obe_wÜk
);

3851 
	}
}

3853 
	$nvme_»£t_çed_dev
(
wÜk_¡ruù
 *
ws
)

3855 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
ws
, nvme_dev, 
»£t_wÜk
);

3856 
	`nvme_dev_»£t
(
dev
);

3857 
	}
}

3859 
	$nvme_»£t
(
nvme_dev
 *
dev
)

3861 
»t
 = -
EBUSY
;

3863 ià(!
dev
->
admš_q
 || 
	`blk_queue_dyšg
(dev->admin_q))

3864  -
ENODEV
;

3866 
	`¥š_lock
(&
dev_li¡_lock
);

3867 ià(!
	`wÜk_³ndšg
(&
dev
->
»£t_wÜk
)) {

3868 
	`PREPARE_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_çed_dev
);

3869 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

3870 
»t
 = 0;

3872 
	`¥š_uÆock
(&
dev_li¡_lock
);

3874 ià(!
»t
) {

3875 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

3876 
	`æush_wÜk
(&
dev
->
´obe_wÜk
);

3880  
»t
;

3881 
	}
}

3883 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

3884 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3885 
size_t
 
couÁ
)

3887 
nvme_dev
 *
ndev
 = 
	`dev_g‘_drvd©a
(
dev
);

3888 
»t
;

3890 
»t
 = 
	`nvme_»£t
(
ndev
);

3891 ià(
»t
 < 0)

3892  
»t
;

3894  
couÁ
;

3895 
	}
}

3896 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

3898 
nvme_async_´obe
(
wÜk_¡ruù
 *
wÜk
);

3899 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

3901 
node
, 
»suÉ
 = -
ENOMEM
;

3902 
nvme_dev
 *
dev
;

3904 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

3905 ià(
node
 =ğ
NUMA_NO_NODE
)

3906 
	`£t_dev_node
(&
pdev
->
dev
, 0);

3908 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

3909 ià(!
dev
)

3910  -
ENOMEM
;

3911 
dev
->
’Œy
 = 
	`kz®loc_node
(
	`num_possibË_ıus
() * (*dev->entry),

3912 
GFP_KERNEL
, 
node
);

3913 ià(!
dev
->
’Œy
)

3914 
ä“
;

3915 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

3916 
GFP_KERNEL
, 
node
);

3917 ià(!
dev
->
queues
)

3918 
ä“
;

3920 
	`INIT_LIST_HEAD
(&
dev
->
Çme¥aûs
);

3921 
	`INIT_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_çed_dev
);

3922 
dev
->
pci_dev
 = 
	`pci_dev_g‘
(
pdev
);

3923 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

3924 
»suÉ
 = 
	`nvme_£t_š¡ªû
(
dev
);

3925 ià(
»suÉ
)

3926 
put_pci
;

3928 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

3929 ià(
»suÉ
)

3930 
»Ëa£
;

3932 
	`k»f_š™
(&
dev
->
k»f
);

3933 
dev
->
deviû
 = 
	`deviû_ü—‹
(
nvme_şass
, &
pdev
->dev,

3934 
	`MKDEV
(
nvme_ch¬_majÜ
, 
dev
->
š¡ªû
),

3935 
dev
, "nvme%d", dev->
š¡ªû
);

3936 ià(
	`IS_ERR
(
dev
->
deviû
)) {

3937 
»suÉ
 = 
	`PTR_ERR
(
dev
->
deviû
);

3938 
»Ëa£_poŞs
;

3940 
	`g‘_deviû
(
dev
->
deviû
);

3941 
	`dev_£t_drvd©a
(
dev
->
deviû
, dev);

3943 
»suÉ
 = 
	`deviû_ü—‹_fe
(
dev
->
deviû
, &
dev_©Œ_»£t_cÚŒŞËr
);

3944 ià(
»suÉ
)

3945 
put_dev
;

3947 
	`INIT_LIST_HEAD
(&
dev
->
node
);

3948 
	`INIT_WORK
(&
dev
->
sÿn_wÜk
, 
nvme_dev_sÿn
);

3949 
	`INIT_WORK
(&
dev
->
´obe_wÜk
, 
nvme_async_´obe
);

3950 
	`scheduË_wÜk
(&
dev
->
´obe_wÜk
);

3953 
put_dev
:

3954 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
dev
->
š¡ªû
));

3955 
	`put_deviû
(
dev
->
deviû
);

3956 
»Ëa£_poŞs
:

3957 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

3958 
»Ëa£
:

3959 
	`nvme_»Ëa£_š¡ªû
(
dev
);

3960 
put_pci
:

3961 
	`pci_dev_put
(
dev
->
pci_dev
);

3962 
ä“
:

3963 
	`kä“
(
dev
->
queues
);

3964 
	`kä“
(
dev
->
’Œy
);

3965 
	`kä“
(
dev
);

3966  
»suÉ
;

3967 
	}
}

3969 
	$nvme_async_´obe
(
wÜk_¡ruù
 *
wÜk
)

3971 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
´obe_wÜk
);

3973 ià(
	`nvme_dev_»sume
(
dev
è&& !
	`wÜk_busy
(&dev->
»£t_wÜk
))

3974 
	`nvme_d—d_ù¾
(
dev
);

3975 
	}
}

3977 
	$nvme_»£t_nÙify
(
pci_dev
 *
pdev
, 
boŞ
 
´•¬e
)

3979 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3981 ià(
´•¬e
)

3982 
	`nvme_dev_shutdown
(
dev
);

3984 
	`nvme_dev_»sume
(
dev
);

3985 
	}
}

3987 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

3989 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3990 
	`nvme_dev_shutdown
(
dev
);

3991 
	}
}

3993 
	$nvme_»move
(
pci_dev
 *
pdev
)

3995 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

3997 
	`¥š_lock
(&
dev_li¡_lock
);

3998 
	`li¡_d–_š™
(&
dev
->
node
);

3999 
	`¥š_uÆock
(&
dev_li¡_lock
);

4001 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

4002 
	`æush_wÜk
(&
dev
->
´obe_wÜk
);

4003 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

4004 
	`æush_wÜk
(&
dev
->
sÿn_wÜk
);

4005 
	`deviû_»move_fe
(
dev
->
deviû
, &
dev_©Œ_»£t_cÚŒŞËr
);

4006 
	`nvme_dev_shutdown
(
dev
);

4007 
	`nvme_dev_»move
(
dev
);

4008 
	`nvme_dev_»move_admš
(
dev
);

4009 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
dev
->
š¡ªû
));

4010 
	`nvme_ä“_queues
(
dev
, 0);

4011 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

4012 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

4013 
	}
}

4016 
	#nvme_”rÜ_d‘eùed
 
NULL


	)

4017 
	#nvme_dump_»gi¡”s
 
NULL


	)

4018 
	#nvme_lšk_»£t
 
NULL


	)

4019 
	#nvme_¦Ù_»£t
 
NULL


	)

4020 
	#nvme_”rÜ_»sume
 
NULL


	)

4022 
	$nvme_su¥’d
(
deviû
 *
dev
)

4024 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

4025 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

4027 
	`nvme_dev_shutdown
(
ndev
);

4029 
	}
}

4031 
	$nvme_»sume
(
deviû
 *
dev
)

4033 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

4034 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

4036 ià(
	`nvme_dev_»sume
(
ndev
è&& !
	`wÜk_busy
(&ndev->
»£t_wÜk
)) {

4037 
	`PREPARE_WORK
(&
ndev
->
»£t_wÜk
, 
nvme_»£t_çed_dev
);

4038 
	`queue_wÜk
(
nvme_wÜkq
, &
ndev
->
»£t_wÜk
);

4041 
	}
}

4043 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

4045 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

4046 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

4047 .
	gmmio_’abËd
 = 
nvme_dump_»gi¡”s
,

4048 .
	glšk_»£t
 = 
nvme_lšk_»£t
,

4049 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

4050 .
	g»sume
 = 
nvme_”rÜ_»sume
,

4054 
	#PCI_CLASS_STORAGE_EXPRESS
 0x010802

	)

4056 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

4057 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

4060 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

4062 
pci_driv”_rh
 
	gnvme_driv”_rh
 = {

4063 .
size
 = (
pci_driv”_rh
),

4064 .
	g»£t_nÙify
 = 
nvme_»£t_nÙify


4067 
pci_driv”
 
	gnvme_driv”
 = {

4068 .
Çme
 = "nvme",

4069 .
	gid_bË
 = 
nvme_id_bË
,

4070 .
	g´obe
 = 
nvme_´obe
,

4071 .
	g»move
 = 
nvme_»move
,

4072 .
	gshutdown
 = 
nvme_shutdown
,

4073 .
	gdriv”
 = {

4074 .
pm
 = &
nvme_dev_pm_İs
,

4076 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

4077 .
	gpci_driv”_rh
 = &
nvme_driv”_rh


4080 
__š™
 
	$nvme_š™
()

4082 
»suÉ
;

4084 
	`š™_wa™queue_h—d
(&
nvme_kth»ad_wa™
);

4086 
nvme_wÜkq
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
("nvme");

4087 ià(!
nvme_wÜkq
)

4088  -
ENOMEM
;

4090 
»suÉ
 = 
	`»gi¡”_blkdev
(
nvme_majÜ
, "nvme");

4091 ià(
»suÉ
 < 0)

4092 
kl_wÜkq
;

4093 ià(
»suÉ
 > 0)

4094 
nvme_majÜ
 = 
»suÉ
;

4096 
»suÉ
 = 
	`__»gi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme",

4097 &
nvme_dev_fİs
);

4098 ià(
»suÉ
 < 0)

4099 
uÄegi¡”_blkdev
;

4100 ià(
»suÉ
 > 0)

4101 
nvme_ch¬_majÜ
 = 
»suÉ
;

4103 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

4104 ià(
	`IS_ERR
(
nvme_şass
)) {

4105 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

4106 
uÄegi¡”_chrdev
;

4109 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

4110 ià(
»suÉ
)

4111 
de¡roy_şass
;

4113 
»suÉ
 = 
	`aio_£rviû_š™
();

4114 ià(
»suÉ
)

4115 
de¡roy_şass
;

4119 
de¡roy_şass
:

4120 
	`şass_de¡roy
(
nvme_şass
);

4121 
uÄegi¡”_chrdev
:

4122 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

4123 
uÄegi¡”_blkdev
:

4124 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

4125 
kl_wÜkq
:

4126 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

4127  
»suÉ
;

4128 
	}
}

4130 
__ex™
 
	$nvme_ex™
()

4133 
	`aio_£rviû_ex™
();

4135 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

4136 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

4137 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

4138 
	`şass_de¡roy
(
nvme_şass
);

4139 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

4140 
	`BUG_ON
(
nvme_th»ad
 && !
	`IS_ERR
(nvme_thread));

4141 
	`_nvme_check_size
();

4142 
	}
}

4144 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

4145 
MODULE_LICENSE
("GPL");

4146 
MODULE_VERSION
("1.0");

4147 
moduË_š™
(
nvme_š™
);

4148 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/nvme-scsi.c

20 
	~"nvme.h
"

22 
	~<lšux/nvme.h
>

24 
	~<lšux/bio.h
>

25 
	~<lšux/b™İs.h
>

26 
	~<lšux/blkdev.h
>

27 
	~<lšux/com·t.h
>

28 
	~<lšux/d–ay.h
>

29 
	~<lšux/”ºo.h
>

30 
	~<lšux/fs.h
>

31 
	~<lšux/g’hd.h
>

32 
	~<lšux/idr.h
>

33 
	~<lšux/š™.h
>

34 
	~<lšux/š‹¼u±.h
>

35 
	~<lšux/io.h
>

36 
	~<lšux/kdev_t.h
>

37 
	~<lšux/kth»ad.h
>

38 
	~<lšux/k”Ãl.h
>

39 
	~<lšux/mm.h
>

40 
	~<lšux/moduË.h
>

41 
	~<lšux/moduË·¿m.h
>

42 
	~<lšux/pci.h
>

43 
	~<lšux/poisÚ.h
>

44 
	~<lšux/sched.h
>

45 
	~<lšux/¦ab.h
>

46 
	~<lšux/ty³s.h
>

47 
	~<scsi/sg.h
>

48 
	~<scsi/scsi.h
>

51 
	gsg_v”siÚ_num
 = 30534;

53 
	#SNTI_TRANSLATION_SUCCESS
 0

	)

54 
	#SNTI_INTERNAL_ERROR
 1

	)

57 
	#VPD_SUPPORTED_PAGES
 0x00

	)

58 
	#VPD_SERIAL_NUMBER
 0x80

	)

59 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

60 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

61 
	#VPD_BLOCK_LIMITS
 0xB0

	)

62 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

65 
	#REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
 6

	)

66 
	#REPORT_LUNS_SR_OFFSET
 2

	)

67 
	#READ_CAP_16_CDB_ALLOC_LENGTH_OFFSET
 10

	)

68 
	#REQUEST_SENSE_CDB_ALLOC_LENGTH_OFFSET
 4

	)

69 
	#REQUEST_SENSE_DESC_OFFSET
 1

	)

70 
	#REQUEST_SENSE_DESC_MASK
 0x01

	)

71 
	#DESCRIPTOR_FORMAT_SENSE_DATA_TYPE
 1

	)

72 
	#INQUIRY_EVPD_BYTE_OFFSET
 1

	)

73 
	#INQUIRY_PAGE_CODE_BYTE_OFFSET
 2

	)

74 
	#INQUIRY_EVPD_BIT_MASK
 1

	)

75 
	#INQUIRY_CDB_ALLOCATION_LENGTH_OFFSET
 3

	)

76 
	#START_STOP_UNIT_CDB_IMMED_OFFSET
 1

	)

77 
	#START_STOP_UNIT_CDB_IMMED_MASK
 0x1

	)

78 
	#START_STOP_UNIT_CDB_POWER_COND_MOD_OFFSET
 3

	)

79 
	#START_STOP_UNIT_CDB_POWER_COND_MOD_MASK
 0xF

	)

80 
	#START_STOP_UNIT_CDB_POWER_COND_OFFSET
 4

	)

81 
	#START_STOP_UNIT_CDB_POWER_COND_MASK
 0xF0

	)

82 
	#START_STOP_UNIT_CDB_NO_FLUSH_OFFSET
 4

	)

83 
	#START_STOP_UNIT_CDB_NO_FLUSH_MASK
 0x4

	)

84 
	#START_STOP_UNIT_CDB_START_OFFSET
 4

	)

85 
	#START_STOP_UNIT_CDB_START_MASK
 0x1

	)

86 
	#WRITE_BUFFER_CDB_MODE_OFFSET
 1

	)

87 
	#WRITE_BUFFER_CDB_MODE_MASK
 0x1F

	)

88 
	#WRITE_BUFFER_CDB_BUFFER_ID_OFFSET
 2

	)

89 
	#WRITE_BUFFER_CDB_BUFFER_OFFSET_OFFSET
 3

	)

90 
	#WRITE_BUFFER_CDB_PARM_LIST_LENGTH_OFFSET
 6

	)

91 
	#FORMAT_UNIT_CDB_FORMAT_PROT_INFO_OFFSET
 1

	)

92 
	#FORMAT_UNIT_CDB_FORMAT_PROT_INFO_MASK
 0xC0

	)

93 
	#FORMAT_UNIT_CDB_FORMAT_PROT_INFO_SHIFT
 6

	)

94 
	#FORMAT_UNIT_CDB_LONG_LIST_OFFSET
 1

	)

95 
	#FORMAT_UNIT_CDB_LONG_LIST_MASK
 0x20

	)

96 
	#FORMAT_UNIT_CDB_FORMAT_DATA_OFFSET
 1

	)

97 
	#FORMAT_UNIT_CDB_FORMAT_DATA_MASK
 0x10

	)

98 
	#FORMAT_UNIT_SHORT_PARM_LIST_LEN
 4

	)

99 
	#FORMAT_UNIT_LONG_PARM_LIST_LEN
 8

	)

100 
	#FORMAT_UNIT_PROT_INT_OFFSET
 3

	)

101 
	#FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
 0

	)

102 
	#FORMAT_UNIT_PROT_FIELD_USAGE_MASK
 0x07

	)

103 
	#UNMAP_CDB_PARAM_LIST_LENGTH_OFFSET
 7

	)

106 
	#NIBBLE_SHIFT
 4

	)

107 
	#FIXED_SENSE_DATA
 0x70

	)

108 
	#DESC_FORMAT_SENSE_DATA
 0x72

	)

109 
	#FIXED_SENSE_DATA_ADD_LENGTH
 10

	)

110 
	#LUN_ENTRY_SIZE
 8

	)

111 
	#LUN_DATA_HEADER_SIZE
 8

	)

112 
	#ALL_LUNS_RETURNED
 0x02

	)

113 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

114 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

115 
	#NVME_POWER_STATE_START_VALID
 0x00

	)

116 
	#NVME_POWER_STATE_ACTIVE
 0x01

	)

117 
	#NVME_POWER_STATE_IDLE
 0x02

	)

118 
	#NVME_POWER_STATE_STANDBY
 0x03

	)

119 
	#NVME_POWER_STATE_LU_CONTROL
 0x07

	)

120 
	#POWER_STATE_0
 0

	)

121 
	#POWER_STATE_1
 1

	)

122 
	#POWER_STATE_2
 2

	)

123 
	#POWER_STATE_3
 3

	)

124 
	#DOWNLOAD_SAVE_ACTIVATE
 0x05

	)

125 
	#DOWNLOAD_SAVE_DEFER_ACTIVATE
 0x0E

	)

126 
	#ACTIVATE_DEFERRED_MICROCODE
 0x0F

	)

127 
	#FORMAT_UNIT_IMMED_MASK
 0x2

	)

128 
	#FORMAT_UNIT_IMMED_OFFSET
 1

	)

129 
	#KELVIN_TEMP_FACTOR
 273

	)

130 
	#FIXED_FMT_SENSE_DATA_SIZE
 18

	)

131 
	#DESC_FMT_SENSE_DATA_SIZE
 8

	)

134 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

135 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

136 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

137 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

138 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

139 
	#INQ_BDEV_LIMITS_PAGE
 0xB0

	)

140 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

141 
	#INQ_SERIAL_NUMBER_LENGTH
 0x14

	)

142 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 6

	)

143 
	#VERSION_SPC_4
 0x06

	)

144 
	#ACA_UNSUPPORTED
 0

	)

145 
	#STANDARD_INQUIRY_LENGTH
 36

	)

146 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

147 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

148 
	#RESERVED_FIELD
 0

	)

151 
	#IO_CDB_WP_MASK
 0xE0

	)

152 
	#IO_CDB_WP_SHIFT
 5

	)

153 
	#IO_CDB_FUA_MASK
 0x8

	)

154 
	#IO_6_CDB_LBA_OFFSET
 0

	)

155 
	#IO_6_CDB_LBA_MASK
 0x001FFFFF

	)

156 
	#IO_6_CDB_TX_LEN_OFFSET
 4

	)

157 
	#IO_6_DEFAULT_TX_LEN
 256

	)

158 
	#IO_10_CDB_LBA_OFFSET
 2

	)

159 
	#IO_10_CDB_TX_LEN_OFFSET
 7

	)

160 
	#IO_10_CDB_WP_OFFSET
 1

	)

161 
	#IO_10_CDB_FUA_OFFSET
 1

	)

162 
	#IO_12_CDB_LBA_OFFSET
 2

	)

163 
	#IO_12_CDB_TX_LEN_OFFSET
 6

	)

164 
	#IO_12_CDB_WP_OFFSET
 1

	)

165 
	#IO_12_CDB_FUA_OFFSET
 1

	)

166 
	#IO_16_CDB_FUA_OFFSET
 1

	)

167 
	#IO_16_CDB_WP_OFFSET
 1

	)

168 
	#IO_16_CDB_LBA_OFFSET
 2

	)

169 
	#IO_16_CDB_TX_LEN_OFFSET
 10

	)

172 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

173 
	#MODE_PAGE_CACHING
 0x08

	)

174 
	#MODE_PAGE_CONTROL
 0x0A

	)

175 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

176 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

177 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

178 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

179 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

180 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

181 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

182 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

183 
	#MODE_PAGE_ALL_LEN
 0x54

	)

184 
	#MODE_SENSE6_MPH_SIZE
 4

	)

185 
	#MODE_SENSE6_ALLOC_LEN_OFFSET
 4

	)

186 
	#MODE_SENSE_PAGE_CONTROL_OFFSET
 2

	)

187 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

188 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

189 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

190 
	#MODE_SENSE_LLBAA_OFFSET
 1

	)

191 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

192 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

193 
	#MODE_SENSE_DBD_OFFSET
 1

	)

194 
	#MODE_SENSE_DBD_MASK
 8

	)

195 
	#MODE_SENSE_DBD_SHIFT
 3

	)

196 
	#MODE_SENSE10_MPH_SIZE
 8

	)

197 
	#MODE_SENSE10_ALLOC_LEN_OFFSET
 7

	)

198 
	#MODE_SELECT_CDB_PAGE_FORMAT_OFFSET
 1

	)

199 
	#MODE_SELECT_CDB_SAVE_PAGES_OFFSET
 1

	)

200 
	#MODE_SELECT_6_CDB_PARAM_LIST_LENGTH_OFFSET
 4

	)

201 
	#MODE_SELECT_10_CDB_PARAM_LIST_LENGTH_OFFSET
 7

	)

202 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

203 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

204 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

205 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

206 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

207 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

208 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

209 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

210 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

211 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

212 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

213 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

214 
	#SHORT_DESC_BLOCK
 8

	)

215 
	#LONG_DESC_BLOCK
 16

	)

216 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

217 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

218 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

219 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

220 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

223 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
 0x00

	)

224 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
 0x07

	)

225 
	#LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
 0x2F

	)

226 
	#LOG_PAGE_TEMPERATURE_PAGE
 0x0D

	)

227 
	#LOG_SENSE_CDB_SP_OFFSET
 1

	)

228 
	#LOG_SENSE_CDB_SP_NOT_ENABLED
 0

	)

229 
	#LOG_SENSE_CDB_PC_OFFSET
 2

	)

230 
	#LOG_SENSE_CDB_PC_MASK
 0xC0

	)

231 
	#LOG_SENSE_CDB_PC_SHIFT
 6

	)

232 
	#LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
 1

	)

233 
	#LOG_SENSE_CDB_PAGE_CODE_MASK
 0x3F

	)

234 
	#LOG_SENSE_CDB_ALLOC_LENGTH_OFFSET
 7

	)

235 
	#REMAINING_INFO_EXCP_PAGE_LENGTH
 0x8

	)

236 
	#LOG_INFO_EXCP_PAGE_LENGTH
 0xC

	)

237 
	#REMAINING_TEMP_PAGE_LENGTH
 0xC

	)

238 
	#LOG_TEMP_PAGE_LENGTH
 0x10

	)

239 
	#LOG_TEMP_UNKNOWN
 0xFF

	)

240 
	#SUPPORTED_LOG_PAGES_PAGE_LENGTH
 0x3

	)

243 
	#READ_CAP_10_RESP_SIZE
 8

	)

244 
	#READ_CAP_16_RESP_SIZE
 32

	)

247 
	#BYTES_TO_DWORDS
 4

	)

248 
	#NVME_MAX_FIRMWARE_SLOT
 7

	)

251 
	#REPORT_LUNS_FIRST_LUN_OFFSET
 8

	)

255 
	#SCSI_ASC_NO_SENSE
 0x00

	)

256 
	#SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

257 
	#SCSI_ASC_LUN_NOT_READY
 0x04

	)

258 
	#SCSI_ASC_WARNING
 0x0B

	)

259 
	#SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

260 
	#SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

261 
	#SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

262 
	#SCSI_ASC_UNRECOVERED_READ_ERROR
 0x11

	)

263 
	#SCSI_ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

264 
	#SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
 0x20

	)

265 
	#SCSI_ASC_ILLEGAL_COMMAND
 0x20

	)

266 
	#SCSI_ASC_ILLEGAL_BLOCK
 0x21

	)

267 
	#SCSI_ASC_INVALID_CDB
 0x24

	)

268 
	#SCSI_ASC_INVALID_LUN
 0x25

	)

269 
	#SCSI_ASC_INVALID_PARAMETER
 0x26

	)

270 
	#SCSI_ASC_FORMAT_COMMAND_FAILED
 0x31

	)

271 
	#SCSI_ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

275 
	#SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

276 
	#SCSI_ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

277 
	#SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

278 
	#SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

279 
	#SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

280 
	#SCSI_ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

281 
	#SCSI_ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

282 
	#SCSI_ASCQ_INVALID_LUN_ID
 0x09

	)

288 
	#DEVICE_SPECIFIC_PARAMETER
 0

	)

289 
	#VPD_ID_DESCRIPTOR_LENGTH
 (
VPD_IDENTIFICATION_DESCRIPTOR
)

	)

293 
	#GET_OPCODE
(
cdb
ècdb[0]

	)

295 
	#GET_U8_FROM_CDB
(
cdb
, 
šdex
è(cdb[šdex] << 0)

	)

297 
	#GET_U16_FROM_CDB
(
cdb
, 
šdex
è((cdb[šdex] << 8è| (cdb[šdex + 1] << 0))

	)

299 
	#GET_U24_FROM_CDB
(
cdb
, 
šdex
) ((cdb[index] << 16) | \

300 (
cdb
[
šdex
 + 1] << 8) | \

301 (
cdb
[
šdex
 + 2] << 0))

	)

303 
	#GET_U32_FROM_CDB
(
cdb
, 
šdex
) ((cdb[index] << 24) | \

304 (
cdb
[
šdex
 + 1] << 16) | \

305 (
cdb
[
šdex
 + 2] << 8) | \

306 (
cdb
[
šdex
 + 3] << 0))

	)

308 
	#GET_U64_FROM_CDB
(
cdb
, 
šdex
è((((
u64
)cdb[index]) << 56) | \

309 (((
u64
)
cdb
[
šdex
 + 1]) << 48) | \

310 (((
u64
)
cdb
[
šdex
 + 2]) << 40) | \

311 (((
u64
)
cdb
[
šdex
 + 3]) << 32) | \

312 (((
u64
)
cdb
[
šdex
 + 4]) << 24) | \

313 (((
u64
)
cdb
[
šdex
 + 5]) << 16) | \

314 (((
u64
)
cdb
[
šdex
 + 6]) << 8) | \

315 (((
u64
)
cdb
[
šdex
 + 7]è<< 0))

	)

318 
	#GET_INQ_EVPD_BIT
(
cdb
) \

319 ((
	`GET_U8_FROM_CDB
(
cdb
, 
INQUIRY_EVPD_BYTE_OFFSET
) & \

320 
INQUIRY_EVPD_BIT_MASK
è? 1 : 0)

	)

322 
	#GET_INQ_PAGE_CODE
(
cdb
) \

323 (
	`GET_U8_FROM_CDB
(
cdb
, 
INQUIRY_PAGE_CODE_BYTE_OFFSET
))

	)

325 
	#GET_INQ_ALLOC_LENGTH
(
cdb
) \

326 (
	`GET_U16_FROM_CDB
(
cdb
, 
INQUIRY_CDB_ALLOCATION_LENGTH_OFFSET
))

	)

329 
	#GET_REPORT_LUNS_ALLOC_LENGTH
(
cdb
) \

330 (
	`GET_U32_FROM_CDB
(
cdb
, 
REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
))

	)

333 
	#GET_READ_CAP_16_ALLOC_LENGTH
(
cdb
) \

334 (
	`GET_U32_FROM_CDB
(
cdb
, 
READ_CAP_16_CDB_ALLOC_LENGTH_OFFSET
))

	)

336 
	#IS_READ_CAP_16
(
cdb
) \

337 ((
cdb
[0] =ğ
SERVICE_ACTION_IN_16
 && cdb[1] =ğ
SAI_READ_CAPACITY_16
è? 1 : 0)

	)

340 
	#GET_REQUEST_SENSE_ALLOC_LENGTH
(
cdb
) \

341 (
	`GET_U8_FROM_CDB
(
cdb
, 
REQUEST_SENSE_CDB_ALLOC_LENGTH_OFFSET
))

	)

344 
	#GET_MODE_SENSE_DBD
(
cdb
) \

345 ((
	`GET_U8_FROM_CDB
(
cdb
, 
MODE_SENSE_DBD_OFFSET
è& 
MODE_SENSE_DBD_MASK
) >> \

346 
MODE_SENSE_DBD_SHIFT
)

	)

348 
	#GET_MODE_SENSE_LLBAA
(
cdb
) \

349 ((
	`GET_U8_FROM_CDB
(
cdb
, 
MODE_SENSE_LLBAA_OFFSET
) & \

350 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
)

	)

352 
	#GET_MODE_SENSE_MPH_SIZE
(
cdb10
) \

353 (
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
)

	)

359 
	snvme_Œªs_io_cdb
 {

360 
u8
 
	mfua
;

361 
u8
 
	m´Ù_šfo
;

362 
u64
 
	mlba
;

363 
u32
 
	mxãr_Ën
;

372 
	$nvme_Œªs_cİy_to_u£r
(
sg_io_hdr
 *
hdr
, *
äom
,

373 
n
)

375 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

376 
nÙ_cİ›d
;

377 
i
;

378 *
šdex
 = 
äom
;

379 
size_t
 
»maššg
 = 
n
;

380 
size_t
 
xãr_Ën
;

382 ià(
hdr
->
iovec_couÁ
 > 0) {

383 
sg_iovec
 
sgl
;

385 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

386 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

387 
i
 * (
sg_iovec
),

388 (
sg_iovec
));

389 ià(
nÙ_cİ›d
)

390  -
EFAULT
;

391 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

392 
nÙ_cİ›d
 = 
	`cİy_to_u£r
(
sgl
.
iov_ba£
, 
šdex
,

393 
xãr_Ën
);

394 ià(
nÙ_cİ›d
) {

395 
»s
 = -
EFAULT
;

398 
šdex
 +ğ
xãr_Ën
;

399 
»maššg
 -ğ
xãr_Ën
;

400 ià(
»maššg
 == 0)

403  
»s
;

405 
nÙ_cİ›d
 = 
	`cİy_to_u£r
(
hdr
->
dxã½
, 
äom
, 
n
);

406 ià(
nÙ_cİ›d
)

407 
»s
 = -
EFAULT
;

408  
»s
;

409 
	}
}

413 
	$nvme_Œªs_cİy_äom_u£r
(
sg_io_hdr
 *
hdr
, *
to
,

414 
n
)

416 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

417 
nÙ_cİ›d
;

418 
i
;

419 *
šdex
 = 
to
;

420 
size_t
 
»maššg
 = 
n
;

421 
size_t
 
xãr_Ën
;

423 ià(
hdr
->
iovec_couÁ
 > 0) {

424 
sg_iovec
 
sgl
;

426 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

427 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

428 
i
 * (
sg_iovec
),

429 (
sg_iovec
));

430 ià(
nÙ_cİ›d
)

431  -
EFAULT
;

432 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

433 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(
šdex
, 
sgl
.
iov_ba£
,

434 
xãr_Ën
);

435 ià(
nÙ_cİ›d
) {

436 
»s
 = -
EFAULT
;

439 
šdex
 +ğ
xãr_Ën
;

440 
»maššg
 -ğ
xãr_Ën
;

441 ià(
»maššg
 == 0)

444  
»s
;

447 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(
to
, 
hdr
->
dxã½
, 
n
);

448 ià(
nÙ_cİ›d
)

449 
»s
 = -
EFAULT
;

450  
»s
;

451 
	}
}

455 
	$nvme_Œªs_com¶‘iÚ
(
sg_io_hdr
 *
hdr
, 
u8
 
¡©us
, u8 
£n£_key
,

456 
u8
 
asc
, u8 
ascq
)

458 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

459 
u8
 
xãr_Ën
;

460 
u8
 
»¥
[
DESC_FMT_SENSE_DATA_SIZE
];

462 ià(
	`scsi_¡©us_is_good
(
¡©us
)) {

463 
hdr
->
¡©us
 = 
SAM_STAT_GOOD
;

464 
hdr
->
masked_¡©us
 = 
GOOD
;

465 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

466 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

467 
hdr
->
sb_Ën_wr
 = 0;

469 
hdr
->
¡©us
 = status;

470 
hdr
->
masked_¡©us
 = 
¡©us
 >> 1;

471 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

472 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

474 
	`mem£t
(
»¥
, 0, 
DESC_FMT_SENSE_DATA_SIZE
);

475 
»¥
[0] = 
DESC_FORMAT_SENSE_DATA
;

476 
»¥
[1] = 
£n£_key
;

477 
»¥
[2] = 
asc
;

478 
»¥
[3] = 
ascq
;

480 
xãr_Ën
 = 
	`mš_t
(
u8
, 
hdr
->
mx_sb_Ën
, 
DESC_FMT_SENSE_DATA_SIZE
);

481 
hdr
->
sb_Ën_wr
 = 
xãr_Ën
;

482 ià(
	`cİy_to_u£r
(
hdr
->
sbp
, 
»¥
, 
xãr_Ën
) > 0)

483 
»s
 = -
EFAULT
;

486  
»s
;

487 
	}
}

489 
	$nvme_Œªs_¡©us_code
(
sg_io_hdr
 *
hdr
, 
nvme_sc
)

491 
u8
 
¡©us
, 
£n£_key
, 
asc
, 
ascq
;

492 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

495 ià(
nvme_sc
 < 0)

496  
nvme_sc
;

499 
nvme_sc
 &= 0x7FF;

501 
nvme_sc
) {

503 
NVME_SC_SUCCESS
:

504 
¡©us
 = 
SAM_STAT_GOOD
;

505 
£n£_key
 = 
NO_SENSE
;

506 
asc
 = 
SCSI_ASC_NO_SENSE
;

507 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

509 
NVME_SC_INVALID_OPCODE
:

510 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

511 
£n£_key
 = 
ILLEGAL_REQUEST
;

512 
asc
 = 
SCSI_ASC_ILLEGAL_COMMAND
;

513 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

515 
NVME_SC_INVALID_FIELD
:

516 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

517 
£n£_key
 = 
ILLEGAL_REQUEST
;

518 
asc
 = 
SCSI_ASC_INVALID_CDB
;

519 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

521 
NVME_SC_DATA_XFER_ERROR
:

522 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

523 
£n£_key
 = 
MEDIUM_ERROR
;

524 
asc
 = 
SCSI_ASC_NO_SENSE
;

525 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

527 
NVME_SC_POWER_LOSS
:

528 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

529 
£n£_key
 = 
ABORTED_COMMAND
;

530 
asc
 = 
SCSI_ASC_WARNING
;

531 
ascq
 = 
SCSI_ASCQ_POWER_LOSS_EXPECTED
;

533 
NVME_SC_INTERNAL
:

534 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

535 
£n£_key
 = 
HARDWARE_ERROR
;

536 
asc
 = 
SCSI_ASC_INTERNAL_TARGET_FAILURE
;

537 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

539 
NVME_SC_ABORT_REQ
:

540 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

541 
£n£_key
 = 
ABORTED_COMMAND
;

542 
asc
 = 
SCSI_ASC_NO_SENSE
;

543 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

545 
NVME_SC_ABORT_QUEUE
:

546 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

547 
£n£_key
 = 
ABORTED_COMMAND
;

548 
asc
 = 
SCSI_ASC_NO_SENSE
;

549 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

551 
NVME_SC_FUSED_FAIL
:

552 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

553 
£n£_key
 = 
ABORTED_COMMAND
;

554 
asc
 = 
SCSI_ASC_NO_SENSE
;

555 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

557 
NVME_SC_FUSED_MISSING
:

558 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

559 
£n£_key
 = 
ABORTED_COMMAND
;

560 
asc
 = 
SCSI_ASC_NO_SENSE
;

561 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

563 
NVME_SC_INVALID_NS
:

564 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

565 
£n£_key
 = 
ILLEGAL_REQUEST
;

566 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

567 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

569 
NVME_SC_LBA_RANGE
:

570 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

571 
£n£_key
 = 
ILLEGAL_REQUEST
;

572 
asc
 = 
SCSI_ASC_ILLEGAL_BLOCK
;

573 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

575 
NVME_SC_CAP_EXCEEDED
:

576 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

577 
£n£_key
 = 
MEDIUM_ERROR
;

578 
asc
 = 
SCSI_ASC_NO_SENSE
;

579 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

581 
NVME_SC_NS_NOT_READY
:

582 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

583 
£n£_key
 = 
NOT_READY
;

584 
asc
 = 
SCSI_ASC_LUN_NOT_READY
;

585 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

589 
NVME_SC_INVALID_FORMAT
:

590 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

591 
£n£_key
 = 
ILLEGAL_REQUEST
;

592 
asc
 = 
SCSI_ASC_FORMAT_COMMAND_FAILED
;

593 
ascq
 = 
SCSI_ASCQ_FORMAT_COMMAND_FAILED
;

595 
NVME_SC_BAD_ATTRIBUTES
:

596 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

597 
£n£_key
 = 
ILLEGAL_REQUEST
;

598 
asc
 = 
SCSI_ASC_INVALID_CDB
;

599 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

603 
NVME_SC_WRITE_FAULT
:

604 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

605 
£n£_key
 = 
MEDIUM_ERROR
;

606 
asc
 = 
SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
;

607 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

609 
NVME_SC_READ_ERROR
:

610 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

611 
£n£_key
 = 
MEDIUM_ERROR
;

612 
asc
 = 
SCSI_ASC_UNRECOVERED_READ_ERROR
;

613 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

615 
NVME_SC_GUARD_CHECK
:

616 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

617 
£n£_key
 = 
MEDIUM_ERROR
;

618 
asc
 = 
SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
;

619 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
;

621 
NVME_SC_APPTAG_CHECK
:

622 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

623 
£n£_key
 = 
MEDIUM_ERROR
;

624 
asc
 = 
SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
;

625 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
;

627 
NVME_SC_REFTAG_CHECK
:

628 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

629 
£n£_key
 = 
MEDIUM_ERROR
;

630 
asc
 = 
SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
;

631 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
;

633 
NVME_SC_COMPARE_FAILED
:

634 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

635 
£n£_key
 = 
MISCOMPARE
;

636 
asc
 = 
SCSI_ASC_MISCOMPARE_DURING_VERIFY
;

637 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

639 
NVME_SC_ACCESS_DENIED
:

640 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

641 
£n£_key
 = 
ILLEGAL_REQUEST
;

642 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

643 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

647 
NVME_SC_CMDID_CONFLICT
:

648 
NVME_SC_CMD_SEQ_ERROR
:

649 
NVME_SC_CQ_INVALID
:

650 
NVME_SC_QID_INVALID
:

651 
NVME_SC_QUEUE_SIZE
:

652 
NVME_SC_ABORT_LIMIT
:

653 
NVME_SC_ABORT_MISSING
:

654 
NVME_SC_ASYNC_LIMIT
:

655 
NVME_SC_FIRMWARE_SLOT
:

656 
NVME_SC_FIRMWARE_IMAGE
:

657 
NVME_SC_INVALID_VECTOR
:

658 
NVME_SC_INVALID_LOG_PAGE
:

660 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

661 
£n£_key
 = 
ILLEGAL_REQUEST
;

662 
asc
 = 
SCSI_ASC_NO_SENSE
;

663 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

667 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
¡©us
, 
£n£_key
, 
asc
, 
ascq
);

669  
»s
;

670 
	}
}

674 
	$nvme_Œªs_¡ªd¬d_šquœy_·ge
(
nvme_ns
 *
ns
,

675 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

676 
®loc_Ën
)

678 
nvme_dev
 *
dev
 = 
ns
->dev;

679 
dma_addr_t
 
dma_addr
;

680 *
mem
;

681 
nvme_id_ns
 *
id_ns
;

682 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

683 
nvme_sc
;

684 
xãr_Ën
;

685 
u8
 
»¥_d©a_fÜm©
 = 0x02;

686 
u8
 
´Ùeù
;

687 
u8
 
cmdque
 = 0x01 << 1;

688 
u8
 
fw_off£t
 = (
dev
->
fœmw¬e_»v
);

690 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

691 &
dma_addr
, 
GFP_KERNEL
);

692 ià(
mem
 =ğ
NULL
) {

693 
»s
 = -
ENOMEM
;

694 
out_dma
;

698 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

699 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

707 ià(
»s
)

708 
out_ä“
;

709 ià(
nvme_sc
) {

710 
»s
 = 
nvme_sc
;

711 
out_ä“
;

713 
id_ns
 = 
mem
;

714 (
id_ns
->
dps
è? (
´Ùeù
 = 0x01) : (protect = 0);

716 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

717 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

718 
šq_»¥Ú£
[3] = 
»¥_d©a_fÜm©
;

719 
šq_»¥Ú£
[4] = 
ADDITIONAL_STD_INQ_LENGTH
;

720 
šq_»¥Ú£
[5] = 
´Ùeù
;

721 
šq_»¥Ú£
[7] = 
cmdque
;

722 
	`¡ºıy
(&
šq_»¥Ú£
[8], "NVMe ", 8);

723 
	`¡ºıy
(&
šq_»¥Ú£
[16], 
dev
->
mod–
, 16);

725 
dev
->
fœmw¬e_»v
[
fw_off£t
 - 1] == ' ' && fw_offset > 4)

726 
fw_off£t
--;

727 
fw_off£t
 -= 4;

728 
	`¡ºıy
(&
šq_»¥Ú£
[32], 
dev
->
fœmw¬e_»v
 + 
fw_off£t
, 4);

730 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

731 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

733 
out_ä“
:

734 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

735 
dma_addr
);

736 
out_dma
:

737  
»s
;

738 
	}
}

740 
	$nvme_Œªs_suµÜ‹d_vpd_·ges
(
nvme_ns
 *
ns
,

741 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

742 
®loc_Ën
)

744 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

745 
xãr_Ën
;

747 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

748 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

749 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

750 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

751 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

752 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

753 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

754 
šq_»¥Ú£
[8] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

755 
šq_»¥Ú£
[9] = 
INQ_BDEV_LIMITS_PAGE
;

757 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

758 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

760  
»s
;

761 
	}
}

763 
	$nvme_Œªs_un™_£rŸl_·ge
(
nvme_ns
 *
ns
,

764 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

765 
®loc_Ën
)

767 
nvme_dev
 *
dev
 = 
ns
->dev;

768 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

769 
xãr_Ën
;

771 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

772 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

773 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

774 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
dev
->
£rŸl
, 
INQ_SERIAL_NUMBER_LENGTH
);

776 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

777 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

779  
»s
;

780 
	}
}

782 
	$nvme_Œªs_deviû_id_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

783 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

785 
nvme_dev
 *
dev
 = 
ns
->dev;

786 
dma_addr_t
 
dma_addr
;

787 *
mem
;

788 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

789 
nvme_sc
;

790 
xãr_Ën
;

791 
__be32
 
tmp_id
 = 
	`ıu_to_be32
(
ns
->
ns_id
);

793 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

794 &
dma_addr
, 
GFP_KERNEL
);

795 ià(
mem
 =ğ
NULL
) {

796 
»s
 = -
ENOMEM
;

797 
out_dma
;

800 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

801 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

802 ià(
	`»adl
(&
dev
->
b¬
->
vs
è>ğ
	`NVME_VS
(1, 1)) {

803 
nvme_id_ns
 *
id_ns
 = 
mem
;

804 *
eui
 = 
id_ns
->
eui64
;

805 
Ën
 = (
id_ns
->
eui64
);

807 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

808 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

809 ià(
»s
)

810 
out_ä“
;

811 ià(
nvme_sc
) {

812 
»s
 = 
nvme_sc
;

813 
out_ä“
;

816 ià(
	`»adl
(&
dev
->
b¬
->
vs
è>ğ
	`NVME_VS
(1, 2)) {

817 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

818 
eui
 = 
id_ns
->
nguid
;

819 
Ën
 = (
id_ns
->
nguid
);

822 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8))

823 
scsi_¡ršg
;

825 
šq_»¥Ú£
[3] = 4 + 
Ën
;

827 
šq_»¥Ú£
[4] = 0x01;

828 
šq_»¥Ú£
[5] = 0x02;

829 
šq_»¥Ú£
[6] = 0x00;

830 
šq_»¥Ú£
[7] = 
Ën
;

831 
	`memıy
(&
šq_»¥Ú£
[8], 
eui
, 
Ën
);

833 
scsi_¡ršg
:

834 ià(
®loc_Ën
 < 72) {

835 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

836 
SAM_STAT_CHECK_CONDITION
,

837 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

838 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

839 
out_ä“
;

841 
šq_»¥Ú£
[3] = 0x48;

843 
šq_»¥Ú£
[4] = 0x03;

844 
šq_»¥Ú£
[5] = 0x08;

845 
šq_»¥Ú£
[6] = 0x00;

846 
šq_»¥Ú£
[7] = 0x44;

848 
	`¥rštf
(&
šq_»¥Ú£
[8], "%04x", 
dev
->
pci_dev
->
v’dÜ
);

849 
	`memıy
(&
šq_»¥Ú£
[12], 
dev
->
mod–
, (dev->model));

850 
	`¥rštf
(&
šq_»¥Ú£
[52], "%04x", 
tmp_id
);

851 
	`memıy
(&
šq_»¥Ú£
[56], 
dev
->
£rŸl
, (dev->serial));

853 
xãr_Ën
 = 
®loc_Ën
;

854 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

856 
out_ä“
:

857 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

858 
dma_addr
);

859 
out_dma
:

860  
»s
;

861 
	}
}

863 
	$nvme_Œªs_ext_šq_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

864 
®loc_Ën
)

866 
u8
 *
šq_»¥Ú£
;

867 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

868 
nvme_sc
;

869 
nvme_dev
 *
dev
 = 
ns
->dev;

870 
dma_addr_t
 
dma_addr
;

871 *
mem
;

872 
nvme_id_ù¾
 *
id_ù¾
;

873 
nvme_id_ns
 *
id_ns
;

874 
xãr_Ën
;

875 
u8
 
miüocode
 = 0x80;

876 
u8
 
¥t
;

877 
u8
 
¥t_lut
[8] = {0, 0, 2, 1, 4, 6, 5, 7};

878 
u8
 
grd_chk
, 
­p_chk
, 
»f_chk
, 
´Ùeù
;

879 
u8
 
uask_sup
 = 0x20;

880 
u8
 
v_sup
;

881 
u8
 
luişr
 = 0x01;

883 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

884 ià(
šq_»¥Ú£
 =ğ
NULL
) {

885 
»s
 = -
ENOMEM
;

886 
out_mem
;

889 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

890 &
dma_addr
, 
GFP_KERNEL
);

891 ià(
mem
 =ğ
NULL
) {

892 
»s
 = -
ENOMEM
;

893 
out_dma
;

897 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

898 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

899 ià(
»s
)

900 
out_ä“
;

901 ià(
nvme_sc
) {

902 
»s
 = 
nvme_sc
;

903 
out_ä“
;

905 
id_ns
 = 
mem
;

906 
¥t
 = 
¥t_lut
[(
id_ns
->
dpc
) & 0x07] << 3;

907 (
id_ns
->
dps
è? (
´Ùeù
 = 0x01) : (protect = 0);

908 
grd_chk
 = 
´Ùeù
 << 2;

909 
­p_chk
 = 
´Ùeù
 << 1;

910 
»f_chk
 = 
´Ùeù
;

913 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

914 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

915 ià(
»s
)

916 
out_ä“
;

917 ià(
nvme_sc
) {

918 
»s
 = 
nvme_sc
;

919 
out_ä“
;

921 
id_ù¾
 = 
mem
;

922 
v_sup
 = 
id_ù¾
->
vwc
;

924 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

925 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

926 
šq_»¥Ú£
[2] = 0x00;

927 
šq_»¥Ú£
[3] = 0x3C;

928 
šq_»¥Ú£
[4] = 
miüocode
 | 
¥t
 | 
grd_chk
 | 
­p_chk
 | 
»f_chk
;

929 
šq_»¥Ú£
[5] = 
uask_sup
;

930 
šq_»¥Ú£
[6] = 
v_sup
;

931 
šq_»¥Ú£
[7] = 
luişr
;

932 
šq_»¥Ú£
[8] = 0;

933 
šq_»¥Ú£
[9] = 0;

935 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

936 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

938 
out_ä“
:

939 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

940 
dma_addr
);

941 
out_dma
:

942 
	`kä“
(
šq_»¥Ú£
);

943 
out_mem
:

944  
»s
;

945 
	}
}

947 
	$nvme_Œªs_bdev_lim™s_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

948 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

950 
__be32
 
max_£ùÜs
 = 
	`ıu_to_be32
(
	`queue_max_hw_£ùÜs
(
ns
->
queue
));

951 
__be32
 
max_disÿrd
 = 
	`ıu_to_be32
(
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
);

952 
__be32
 
disÿrd_desc_couÁ
 = 
	`ıu_to_be32
(0x100);

954 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

955 
šq_»¥Ú£
[1] = 
VPD_BLOCK_LIMITS
;

956 
šq_»¥Ú£
[3] = 0x3c;

957 
	`memıy
(&
šq_»¥Ú£
[8], &
max_£ùÜs
, (
u32
));

958 
	`memıy
(&
šq_»¥Ú£
[20], &
max_disÿrd
, (
u32
));

960 ià(
max_disÿrd
)

961 
	`memıy
(&
šq_»¥Ú£
[24], &
disÿrd_desc_couÁ
, (
u32
));

963  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 0x3c);

964 
	}
}

966 
	$nvme_Œªs_bdev_ch¬_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

967 
®loc_Ën
)

969 
u8
 *
šq_»¥Ú£
;

970 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

971 
xãr_Ën
;

973 
šq_»¥Ú£
 = 
	`kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

974 ià(
šq_»¥Ú£
 =ğ
NULL
) {

975 
»s
 = -
ENOMEM
;

976 
out_mem
;

979 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

980 
šq_»¥Ú£
[2] = 0x00;

981 
šq_»¥Ú£
[3] = 0x3C;

982 
šq_»¥Ú£
[4] = 0x00;

983 
šq_»¥Ú£
[5] = 0x01;

984 
šq_»¥Ú£
[6] = 0x00;

986 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

987 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

989 
	`kä“
(
šq_»¥Ú£
);

990 
out_mem
:

991  
»s
;

992 
	}
}

996 
	$nvme_Œªs_log_suµ_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

997 
®loc_Ën
)

999 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1000 
xãr_Ën
;

1001 
u8
 *
log_»¥Ú£
;

1003 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
, 
GFP_KERNEL
);

1004 ià(
log_»¥Ú£
 =ğ
NULL
) {

1005 
»s
 = -
ENOMEM
;

1006 
out_mem
;

1009 
log_»¥Ú£
[0] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

1011 
log_»¥Ú£
[3] = 
SUPPORTED_LOG_PAGES_PAGE_LENGTH
;

1012 
log_»¥Ú£
[4] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

1013 
log_»¥Ú£
[5] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

1014 
log_»¥Ú£
[6] = 
LOG_PAGE_TEMPERATURE_PAGE
;

1016 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

1017 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

1019 
	`kä“
(
log_»¥Ú£
);

1020 
out_mem
:

1021  
»s
;

1022 
	}
}

1024 
	$nvme_Œªs_log_šfo_exû±iÚs
(
nvme_ns
 *
ns
,

1025 
sg_io_hdr
 *
hdr
, 
®loc_Ën
)

1027 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1028 
xãr_Ën
;

1029 
u8
 *
log_»¥Ú£
;

1030 
nvme_commªd
 
c
;

1031 
nvme_dev
 *
dev
 = 
ns
->dev;

1032 
nvme_sm¬t_log
 *
sm¬t_log
;

1033 
dma_addr_t
 
dma_addr
;

1034 *
mem
;

1035 
u8
 
‹mp_c
;

1036 
u16
 
‹mp_k
;

1038 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_INFO_EXCP_PAGE_LENGTH
, 
GFP_KERNEL
);

1039 ià(
log_»¥Ú£
 =ğ
NULL
) {

1040 
»s
 = -
ENOMEM
;

1041 
out_mem
;

1044 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1045 (
nvme_sm¬t_log
),

1046 &
dma_addr
, 
GFP_KERNEL
);

1047 ià(
mem
 =ğ
NULL
) {

1048 
»s
 = -
ENOMEM
;

1049 
out_dma
;

1053 
	`mem£t
(&
c
, 0, (c));

1054 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
;

1055 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF);

1056 
c
.
commÚ
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1057 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(((((
nvme_sm¬t_log
) /

1058 
BYTES_TO_DWORDS
è- 1è<< 16è| 
NVME_LOG_SMART
);

1059 
»s
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1060 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

1061 
‹mp_c
 = 
LOG_TEMP_UNKNOWN
;

1063 
sm¬t_log
 = 
mem
;

1064 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

1065 (
sm¬t_log
->
‹m³¿tu»
[0]);

1066 
‹mp_c
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

1069 
log_»¥Ú£
[0] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

1071 
log_»¥Ú£
[3] = 
REMAINING_INFO_EXCP_PAGE_LENGTH
;

1074 
log_»¥Ú£
[6] = 0x23;

1075 
log_»¥Ú£
[7] = 0x04;

1078 
log_»¥Ú£
[10] = 
‹mp_c
;

1080 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_INFO_EXCP_PAGE_LENGTH
);

1081 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

1083 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_sm¬t_log
),

1084 
mem
, 
dma_addr
);

1085 
out_dma
:

1086 
	`kä“
(
log_»¥Ú£
);

1087 
out_mem
:

1088  
»s
;

1089 
	}
}

1091 
	$nvme_Œªs_log_‹m³¿tu»
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1092 
®loc_Ën
)

1094 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1095 
xãr_Ën
;

1096 
u8
 *
log_»¥Ú£
;

1097 
nvme_commªd
 
c
;

1098 
nvme_dev
 *
dev
 = 
ns
->dev;

1099 
nvme_sm¬t_log
 *
sm¬t_log
;

1100 
dma_addr_t
 
dma_addr
;

1101 *
mem
;

1102 
u32
 
ã©u»_»¥
;

1103 
u8
 
‹mp_c_cur
, 
‹mp_c_th»sh
;

1104 
u16
 
‹mp_k
;

1106 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_TEMP_PAGE_LENGTH
, 
GFP_KERNEL
);

1107 ià(
log_»¥Ú£
 =ğ
NULL
) {

1108 
»s
 = -
ENOMEM
;

1109 
out_mem
;

1112 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1113 (
nvme_sm¬t_log
),

1114 &
dma_addr
, 
GFP_KERNEL
);

1115 ià(
mem
 =ğ
NULL
) {

1116 
»s
 = -
ENOMEM
;

1117 
out_dma
;

1121 
	`mem£t
(&
c
, 0, (c));

1122 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
;

1123 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF);

1124 
c
.
commÚ
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1125 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(((((
nvme_sm¬t_log
) /

1126 
BYTES_TO_DWORDS
è- 1è<< 16è| 
NVME_LOG_SMART
);

1127 
»s
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1128 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

1129 
‹mp_c_cur
 = 
LOG_TEMP_UNKNOWN
;

1131 
sm¬t_log
 = 
mem
;

1132 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

1133 (
sm¬t_log
->
‹m³¿tu»
[0]);

1134 
‹mp_c_cur
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

1138 
»s
 = 
	`nvme_g‘_ã©u»s
(
dev
, 
NVME_FEAT_TEMP_THRESH
, 0, 0,

1139 &
ã©u»_»¥
);

1140 ià(
»s
 !ğ
NVME_SC_SUCCESS
)

1141 
‹mp_c_th»sh
 = 
LOG_TEMP_UNKNOWN
;

1143 
‹mp_c_th»sh
 = (
ã©u»_»¥
 & 0xFFFFè- 
KELVIN_TEMP_FACTOR
;

1145 
log_»¥Ú£
[0] = 
LOG_PAGE_TEMPERATURE_PAGE
;

1147 
log_»¥Ú£
[3] = 
REMAINING_TEMP_PAGE_LENGTH
;

1150 
log_»¥Ú£
[6] = 0x01;

1151 
log_»¥Ú£
[7] = 0x02;

1153 
log_»¥Ú£
[9] = 
‹mp_c_cur
;

1155 
log_»¥Ú£
[11] = 0x01;

1156 
log_»¥Ú£
[12] = 0x01;

1157 
log_»¥Ú£
[13] = 0x02;

1159 
log_»¥Ú£
[15] = 
‹mp_c_th»sh
;

1161 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_TEMP_PAGE_LENGTH
);

1162 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

1164 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_sm¬t_log
),

1165 
mem
, 
dma_addr
);

1166 
out_dma
:

1167 
	`kä“
(
log_»¥Ú£
);

1168 
out_mem
:

1169  
»s
;

1170 
	}
}

1174 
	$nvme_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

1175 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

1178 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

1179  
SNTI_INTERNAL_ERROR
;

1181 ià(
cdb10
) {

1182 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

1183 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

1185 
»¥
[4] = 
Îb¯
;

1186 
»¥
[5] = 
RESERVED_FIELD
;

1187 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

1188 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

1190 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

1192 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

1195  
SNTI_TRANSLATION_SUCCESS
;

1196 
	}
}

1198 
	$nvme_Œªs_fl_blk_desc
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1199 
u8
 *
»¥
, 
Ën
, u8 
Îb¯
)

1201 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1202 
nvme_sc
;

1203 
nvme_dev
 *
dev
 = 
ns
->dev;

1204 
dma_addr_t
 
dma_addr
;

1205 *
mem
;

1206 
nvme_id_ns
 *
id_ns
;

1207 
u8
 
æbas
;

1208 
u32
 
lba_Ëngth
;

1210 ià(
Îb¯
 =ğ0 && 
Ën
 < 
MODE_PAGE_BLK_DES_LEN
)

1211  
SNTI_INTERNAL_ERROR
;

1212 ià(
Îb¯
 > 0 && 
Ën
 < 
MODE_PAGE_LLBAA_BLK_DES_LEN
)

1213  
SNTI_INTERNAL_ERROR
;

1215 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

1216 &
dma_addr
, 
GFP_KERNEL
);

1217 ià(
mem
 =ğ
NULL
) {

1218 
»s
 = -
ENOMEM
;

1219 
out
;

1223 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

1224 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1225 ià(
»s
)

1226 
out_dma
;

1227 ià(
nvme_sc
) {

1228 
»s
 = 
nvme_sc
;

1229 
out_dma
;

1231 
id_ns
 = 
mem
;

1232 
æbas
 = (
id_ns
->flbas) & 0x0F;

1233 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1235 ià(
Îb¯
 == 0) {

1236 
__be32
 
tmp_ÿp
 = 
	`ıu_to_be32
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

1238 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
 & 0x00FFFFFF);

1240 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u32
));

1241 
	`memıy
(&
»¥
[4], &
tmp_Ën
, (
u32
));

1243 
__be64
 
tmp_ÿp
 = 
	`ıu_to_be64
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

1244 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1246 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u64
));

1248 
	`memıy
(&
»¥
[12], &
tmp_Ën
, (
u32
));

1251 
out_dma
:

1252 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

1253 
dma_addr
);

1254 
out
:

1255  
»s
;

1256 
	}
}

1258 
	$nvme_Œªs_fl_cÚŒŞ_·ge
(
nvme_ns
 *
ns
,

1259 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1260 
Ën
)

1262 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

1263  
SNTI_INTERNAL_ERROR
;

1265 
»¥
[0] = 
MODE_PAGE_CONTROL
;

1266 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

1267 
»¥
[2] = 0x0E;

1269 
»¥
[3] = 0x12;

1271 
»¥
[5] = 0x40;

1273 
»¥
[8] = 0xFF;

1274 
»¥
[9] = 0xFF;

1277  
SNTI_TRANSLATION_SUCCESS
;

1278 
	}
}

1280 
	$nvme_Œªs_fl_ÿchšg_·ge
(
nvme_ns
 *
ns
,

1281 
sg_io_hdr
 *
hdr
,

1282 
u8
 *
»¥
, 
Ën
)

1284 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1285 
nvme_sc
;

1286 
nvme_dev
 *
dev
 = 
ns
->dev;

1287 
u32
 
ã©u»_»¥
;

1288 
u8
 
vwc
;

1290 ià(
Ën
 < 
MODE_PAGE_CACHING_LEN
)

1291  
SNTI_INTERNAL_ERROR
;

1293 
nvme_sc
 = 
	`nvme_g‘_ã©u»s
(
dev
, 
NVME_FEAT_VOLATILE_WC
, 0, 0,

1294 &
ã©u»_»¥
);

1295 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1296 ià(
»s
)

1297 
out
;

1298 ià(
nvme_sc
) {

1299 
»s
 = 
nvme_sc
;

1300 
out
;

1302 
vwc
 = 
ã©u»_»¥
 & 0x00000001;

1304 
»¥
[0] = 
MODE_PAGE_CACHING
;

1305 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

1306 
»¥
[2] = 
vwc
 << 2;

1308 
out
:

1309  
»s
;

1310 
	}
}

1312 
	$nvme_Œªs_fl_pow_úd_·ge
(
nvme_ns
 *
ns
,

1313 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1314 
Ën
)

1316 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1318 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

1319  
SNTI_INTERNAL_ERROR
;

1321 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

1322 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

1325  
»s
;

1326 
	}
}

1328 
	$nvme_Œªs_fl_šf_exc_·ge
(
nvme_ns
 *
ns
,

1329 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1330 
Ën
)

1332 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1334 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

1335  
SNTI_INTERNAL_ERROR
;

1337 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

1338 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

1339 
»¥
[2] = 0x88;

1342  
»s
;

1343 
	}
}

1345 
	$nvme_Œªs_fl_®l_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1346 
u8
 *
»¥
, 
Ën
)

1348 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1349 
u16
 
mode_·ges_off£t_1
 = 0;

1350 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

1352 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

1353 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

1354 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

1356 
»s
 = 
	`nvme_Œªs_fl_ÿchšg_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_1
],

1357 
MODE_PAGE_CACHING_LEN
);

1358 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1359 
out
;

1360 
»s
 = 
	`nvme_Œªs_fl_cÚŒŞ_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_2
],

1361 
MODE_PAGE_CONTROL_LEN
);

1362 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1363 
out
;

1364 
»s
 = 
	`nvme_Œªs_fl_pow_úd_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_3
],

1365 
MODE_PAGE_POW_CND_LEN
);

1366 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1367 
out
;

1368 
»s
 = 
	`nvme_Œªs_fl_šf_exc_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_4
],

1369 
MODE_PAGE_INF_EXC_LEN
);

1370 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1371 
out
;

1373 
out
:

1374  
»s
;

1375 
	}
}

1377 
šlše
 
	$nvme_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

1379 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

1381  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

1385 
	}
}

1387 
nvme_Œªs_mode_·ge_ü—‹
(
nvme_ns
 *
ns
,

1388 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
,

1389 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

1390 (*
mode_·ge_fl_func
)

1391 (
nvme_ns
 *,

1392 
sg_io_hdr
 *
hdr
, 
u8
 *, ),

1393 
u16
 
mode_·ges_tÙ_Ën
)

1395 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1396 
xãr_Ën
;

1397 
u8
 *
»¥Ú£
;

1398 
u8
 
dbd
, 
Îb¯
;

1399 
u16
 
»¥_size
;

1400 
mph_size
;

1401 
u16
 
mode_·ges_off£t_1
;

1402 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

1404 
dbd
 = 
	`GET_MODE_SENSE_DBD
(
cmd
);

1405 
Îb¯
 = 
	`GET_MODE_SENSE_LLBAA
(
cmd
);

1406 
mph_size
 = 
	`GET_MODE_SENSE_MPH_SIZE
(
cdb10
);

1407 
blk_desc_Ën
 = 
	`nvme_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

1409 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1411 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1413 
blk_desc_off£t
 = 
mph_size
;

1414 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

1416 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

1417 ià(
»¥Ú£
 =ğ
NULL
) {

1418 
»s
 = -
ENOMEM
;

1419 
out_mem
;

1422 
»s
 = 
	`nvme_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
,

1423 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

1424 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1425 
out_ä“
;

1426 ià(
blk_desc_Ën
 > 0) {

1427 
»s
 = 
	`nvme_Œªs_fl_blk_desc
(
ns
, 
hdr
,

1428 &
»¥Ú£
[
blk_desc_off£t
],

1429 
blk_desc_Ën
, 
Îb¯
);

1430 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1431 
out_ä“
;

1433 
»s
 = 
	`mode_·ge_fl_func
(
ns
, 
hdr
, &
»¥Ú£
[
mode_·ges_off£t_1
],

1434 
mode_·ges_tÙ_Ën
);

1435 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1436 
out_ä“
;

1438 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

1439 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

1441 
out_ä“
:

1442 
	`kä“
(
»¥Ú£
);

1443 
out_mem
:

1444  
»s
;

1445 
	}
}

1449 
	$nvme_Œªs_fl_»ad_ÿp
(
u8
 *
»¥Ú£
, 
nvme_id_ns
 *
id_ns
,

1450 
u8
 
cdb16
)

1452 
u8
 
æbas
;

1453 
u32
 
lba_Ëngth
;

1454 
u64
 
¾ba
;

1455 
u8
 
´Ù_’
;

1456 
u8
 
p_ty³_lut
[4] = {0, 0, 1, 2};

1457 
__be64
 
tmp_¾ba
;

1458 
__be32
 
tmp_¾ba_32
;

1459 
__be32
 
tmp_Ën
;

1461 
æbas
 = (
id_ns
->flbas) & 0x0F;

1462 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1463 
¾ba
 = 
	`Ë64_to_ıup
(&
id_ns
->
nsze
) - 1;

1464 (
id_ns
->
dps
è? (
´Ù_’
 = 0x01) : (prot_en = 0);

1466 ià(!
cdb16
) {

1467 ià(
¾ba
 > 0xFFFFFFFF)

1468 
¾ba
 = 0xFFFFFFFF;

1469 
tmp_¾ba_32
 = 
	`ıu_to_be32
(
¾ba
);

1470 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1471 
	`memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

1472 
	`memıy
(&
»¥Ú£
[4], &
tmp_Ën
, (
u32
));

1474 
tmp_¾ba
 = 
	`ıu_to_be64
(
¾ba
);

1475 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1476 
	`memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

1477 
	`memıy
(&
»¥Ú£
[8], &
tmp_Ën
, (
u32
));

1478 
»¥Ú£
[12] = (
p_ty³_lut
[
id_ns
->
dps
 & 0x3] << 1è| 
´Ù_’
;

1483 
	}
}

1487 
	$nvme_Œªs_pow”_¡©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1488 
u8
 
pc
, u8 
pcmod
, u8 
¡¬t
)

1490 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1491 
nvme_sc
;

1492 
nvme_dev
 *
dev
 = 
ns
->dev;

1493 
dma_addr_t
 
dma_addr
;

1494 *
mem
;

1495 
nvme_id_ù¾
 *
id_ù¾
;

1496 
lowe¡_pow_¡
;

1497 
ps_desœed
 = 0;

1500 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1501 (
nvme_id_ù¾
),

1502 &
dma_addr
, 
GFP_KERNEL
);

1503 ià(
mem
 =ğ
NULL
) {

1504 
»s
 = -
ENOMEM
;

1505 
out
;

1507 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

1508 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1509 ià(
»s
)

1510 
out_dma
;

1511 ià(
nvme_sc
) {

1512 
»s
 = 
nvme_sc
;

1513 
out_dma
;

1515 
id_ù¾
 = 
mem
;

1516 
lowe¡_pow_¡
 = 
	`max
(
POWER_STATE_0
, ()(
id_ù¾
->
Åss
 - 1));

1518 
pc
) {

1519 
NVME_POWER_STATE_START_VALID
:

1521 ià(
pcmod
 =ğ0 && 
¡¬t
 == 0x1)

1522 
ps_desœed
 = 
POWER_STATE_0
;

1523 ià(
pcmod
 =ğ0 && 
¡¬t
 == 0x0)

1524 
ps_desœed
 = 
lowe¡_pow_¡
;

1526 
NVME_POWER_STATE_ACTIVE
:

1528 ià(
pcmod
 == 0)

1529 
ps_desœed
 = 
POWER_STATE_0
;

1531 
NVME_POWER_STATE_IDLE
:

1533 ià(
pcmod
 == 0x0)

1534 
ps_desœed
 = 
POWER_STATE_1
;

1535 ià(
pcmod
 == 0x1)

1536 
ps_desœed
 = 
POWER_STATE_2
;

1537 ià(
pcmod
 == 0x2)

1538 
ps_desœed
 = 
POWER_STATE_3
;

1540 
NVME_POWER_STATE_STANDBY
:

1542 ià(
pcmod
 == 0x0)

1543 
ps_desœed
 = 
	`max
(
POWER_STATE_0
, (
lowe¡_pow_¡
 - 2));

1544 ià(
pcmod
 == 0x1)

1545 
ps_desœed
 = 
	`max
(
POWER_STATE_0
, (
lowe¡_pow_¡
 - 1));

1547 
NVME_POWER_STATE_LU_CONTROL
:

1549 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1550 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1551 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1554 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
dev
, 
NVME_FEAT_POWER_MGMT
, 
ps_desœed
, 0,

1555 
NULL
);

1556 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1557 ià(
»s
)

1558 
out_dma
;

1559 ià(
nvme_sc
)

1560 
»s
 = 
nvme_sc
;

1561 
out_dma
:

1562 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ù¾
), 
mem
,

1563 
dma_addr
);

1564 
out
:

1565  
»s
;

1566 
	}
}

1571 
	$nvme_Œªs_£nd_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1572 
u8
 
İcode
, 
u32
 
tÙ_Ën
, u32 
off£t
,

1573 
u8
 
bufãr_id
)

1575 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1576 
nvme_sc
;

1577 
nvme_dev
 *
dev
 = 
ns
->dev;

1578 
nvme_commªd
 
c
;

1579 
nvme_iod
 *
iod
 = 
NULL
;

1580 
Ëngth
;

1582 
	`mem£t
(&
c
, 0, (c));

1583 
c
.
commÚ
.
İcode
 = opcode;

1584 ià(
İcode
 =ğ
nvme_admš_dowÆßd_fw
) {

1585 ià(
hdr
->
iovec_couÁ
 > 0) {

1587 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1588 
SAM_STAT_CHECK_CONDITION
,

1589 
ILLEGAL_REQUEST
,

1590 
SCSI_ASC_INVALID_CDB
,

1591 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1592 
out
;

1594 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
DMA_TO_DEVICE
,

1595 ()
hdr
->
dxã½
, 
tÙ_Ën
);

1596 ià(
	`IS_ERR
(
iod
)) {

1597 
»s
 = 
	`PTR_ERR
(
iod
);

1598 
out
;

1600 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, 
iod
, 
tÙ_Ën
, 
GFP_KERNEL
);

1601 ià(
Ëngth
 !ğ
tÙ_Ën
) {

1602 
»s
 = -
ENOMEM
;

1603 
out_unm­
;

1606 
c
.
dlfw
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

1607 
c
.
dlfw
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

1608 
c
.
dlfw
.
numd
 = 
	`ıu_to_Ë32
((
tÙ_Ën
/
BYTES_TO_DWORDS
) - 1);

1609 
c
.
dlfw
.
off£t
 = 
	`ıu_to_Ë32
(off£t/
BYTES_TO_DWORDS
);

1610 } ià(
İcode
 =ğ
nvme_admš_aùiv©e_fw
) {

1611 
u32
 
cdw10
 = 
bufãr_id
 | 
NVME_FWACT_REPL_ACTV
;

1612 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

1615 
nvme_sc
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1616 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1617 ià(
»s
)

1618 
out_unm­
;

1619 ià(
nvme_sc
)

1620 
»s
 = 
nvme_sc
;

1622 
out_unm­
:

1623 ià(
İcode
 =ğ
nvme_admš_dowÆßd_fw
) {

1624 
	`nvme_unm­_u£r_·ges
(
dev
, 
DMA_TO_DEVICE
, 
iod
);

1625 
	`nvme_ä“_iod
(
dev
, 
iod
);

1627 
out
:

1628  
»s
;

1629 
	}
}

1633 
šlše
 
	$nvme_Œªs_mode£l_g‘_bd_Ën
(
u8
 *
·rm_li¡
, u8 
cdb10
,

1634 
u16
 *
bd_Ën
, 
u8
 *
Îb¯
)

1636 ià(
cdb10
) {

1638 *
bd_Ën
 = (
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
] << 8) +

1639 
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
 + 1];

1640 *
Îb¯
 = 
·rm_li¡
[
MODE_SELECT_10_LLBAA_OFFSET
] &

1641 
MODE_SELECT_10_LLBAA_MASK
;

1644 *
bd_Ën
 = 
·rm_li¡
[
MODE_SELECT_6_BD_OFFSET
];

1646 
	}
}

1648 
	$nvme_Œªs_mode£l_§ve_bd
(
nvme_ns
 *
ns
, 
u8
 *
·rm_li¡
,

1649 
u16
 
idx
, u16 
bd_Ën
, 
u8
 
Îb¯
)

1651 
u16
 
bd_num
;

1653 
bd_num
 = 
bd_Ën
 / ((
Îb¯
 == 0) ?

1654 
SHORT_DESC_BLOCK
 : 
LONG_DESC_BLOCK
);

1657 ià(
Îb¯
 == 0) {

1659 
ns
->
mode_£Ëù_num_blocks
 =

1660 (
·rm_li¡
[
idx
 + 1] << 16) +

1661 (
·rm_li¡
[
idx
 + 2] << 8) +

1662 (
·rm_li¡
[
idx
 + 3]);

1664 
ns
->
mode_£Ëù_block_Ën
 =

1665 (
·rm_li¡
[
idx
 + 5] << 16) +

1666 (
·rm_li¡
[
idx
 + 6] << 8) +

1667 (
·rm_li¡
[
idx
 + 7]);

1670 
ns
->
mode_£Ëù_num_blocks
 =

1671 (((
u64
)
·rm_li¡
[
idx
 + 0]) << 56) +

1672 (((
u64
)
·rm_li¡
[
idx
 + 1]) << 48) +

1673 (((
u64
)
·rm_li¡
[
idx
 + 2]) << 40) +

1674 (((
u64
)
·rm_li¡
[
idx
 + 3]) << 32) +

1675 (((
u64
)
·rm_li¡
[
idx
 + 4]) << 24) +

1676 (((
u64
)
·rm_li¡
[
idx
 + 5]) << 16) +

1677 (((
u64
)
·rm_li¡
[
idx
 + 6]) << 8) +

1678 ((
u64
)
·rm_li¡
[
idx
 + 7]);

1680 
ns
->
mode_£Ëù_block_Ën
 =

1681 (
·rm_li¡
[
idx
 + 12] << 24) +

1682 (
·rm_li¡
[
idx
 + 13] << 16) +

1683 (
·rm_li¡
[
idx
 + 14] << 8) +

1684 (
·rm_li¡
[
idx
 + 15]);

1686 
	}
}

1688 
	$nvme_Œªs_mode£l_g‘_mp
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1689 
u8
 *
mode_·ge
, u8 
·ge_code
)

1691 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1692 
nvme_sc
;

1693 
nvme_dev
 *
dev
 = 
ns
->dev;

1694 
dwÜd11
;

1696 
·ge_code
) {

1697 
MODE_PAGE_CACHING
:

1698 
dwÜd11
 = ((
mode_·ge
[2] & 
CACHING_MODE_PAGE_WCE_MASK
) ? 1 : 0);

1699 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
dev
, 
NVME_FEAT_VOLATILE_WC
, 
dwÜd11
,

1700 0, 
NULL
);

1701 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1702 ià(
»s
)

1704 ià(
nvme_sc
) {

1705 
»s
 = 
nvme_sc
;

1709 
MODE_PAGE_CONTROL
:

1711 
MODE_PAGE_POWER_CONDITION
:

1713 ià((
mode_·ge
[2] & 0x01) != 0 || (mode_page[3] & 0x0F) != 0) {

1714 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1715 
SAM_STAT_CHECK_CONDITION
,

1716 
ILLEGAL_REQUEST
,

1717 
SCSI_ASC_INVALID_PARAMETER
,

1718 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1719 ià(!
»s
)

1720 
»s
 = 
SNTI_INTERNAL_ERROR
;

1725 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1726 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1727 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1728 ià(!
»s
)

1729 
»s
 = 
SNTI_INTERNAL_ERROR
;

1733  
»s
;

1734 
	}
}

1736 
	$nvme_Œªs_mode£l_d©a
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1737 
u8
 *
cmd
, 
u16
 
·rm_li¡_Ën
, u8 
pf
,

1738 
u8
 
¥
, u8 
cdb10
)

1740 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1741 
u8
 *
·rm_li¡
;

1742 
u16
 
bd_Ën
;

1743 
u8
 
Îb¯
 = 0;

1744 
u16
 
šdex
, 
§ved_šdex
;

1745 
u8
 
·ge_code
;

1746 
u16
 
mp_size
;

1749 
·rm_li¡
 = 
	`km®loc
(
·rm_li¡_Ën
, 
GFP_KERNEL
);

1750 ià(
·rm_li¡
 =ğ
NULL
) {

1751 
»s
 = -
ENOMEM
;

1752 
out
;

1755 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
·rm_li¡_Ën
);

1756 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1757 
out_mem
;

1759 
	`nvme_Œªs_mode£l_g‘_bd_Ën
(
·rm_li¡
, 
cdb10
, &
bd_Ën
, &
Îb¯
);

1760 
šdex
 = (
cdb10
è? (
MODE_SELECT_10_MPH_SIZE
è: (
MODE_SELECT_6_MPH_SIZE
);

1762 ià(
bd_Ën
 != 0) {

1764 
	`nvme_Œªs_mode£l_§ve_bd
(
ns
, 
·rm_li¡
, 
šdex
, 
bd_Ën
, 
Îb¯
);

1765 
šdex
 +ğ
bd_Ën
;

1767 
§ved_šdex
 = 
šdex
;

1772 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1773 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1774 ià((
·ge_code
 !ğ
MODE_PAGE_CACHING
) &&

1775 (
·ge_code
 !ğ
MODE_PAGE_CONTROL
) &&

1776 (
·ge_code
 !ğ
MODE_PAGE_POWER_CONDITION
)) {

1777 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1778 
SAM_STAT_CHECK_CONDITION
,

1779 
ILLEGAL_REQUEST
,

1780 
SCSI_ASC_INVALID_CDB
,

1781 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1782 
out_mem
;

1784 
šdex
 +ğ
mp_size
;

1785 } 
šdex
 < 
·rm_li¡_Ën
);

1788 
šdex
 = 
§ved_šdex
;

1790 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1791 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1792 
»s
 = 
	`nvme_Œªs_mode£l_g‘_mp
(
ns
, 
hdr
, &
·rm_li¡
[
šdex
],

1793 
·ge_code
);

1794 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1796 
šdex
 +ğ
mp_size
;

1797 } 
šdex
 < 
·rm_li¡_Ën
);

1799 
out_mem
:

1800 
	`kä“
(
·rm_li¡
);

1801 
out
:

1802  
»s
;

1803 
	}
}

1807 
	$nvme_Œªs_fmt_£t_blk_size_couÁ
(
nvme_ns
 *
ns
,

1808 
sg_io_hdr
 *
hdr
)

1810 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1811 
nvme_sc
;

1812 
nvme_dev
 *
dev
 = 
ns
->dev;

1813 
dma_addr_t
 
dma_addr
;

1814 *
mem
;

1815 
nvme_id_ns
 *
id_ns
;

1816 
u8
 
æbas
;

1825 ià(
ns
->
mode_£Ëù_num_blocks
 =ğ0 ||‚s->
mode_£Ëù_block_Ën
 == 0) {

1826 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1827 (
nvme_id_ns
), &
dma_addr
, 
GFP_KERNEL
);

1828 ià(
mem
 =ğ
NULL
) {

1829 
»s
 = -
ENOMEM
;

1830 
out
;

1833 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

1834 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1835 ià(
»s
)

1836 
out_dma
;

1837 ià(
nvme_sc
) {

1838 
»s
 = 
nvme_sc
;

1839 
out_dma
;

1841 
id_ns
 = 
mem
;

1843 ià(
ns
->
mode_£Ëù_num_blocks
 == 0)

1844 
ns
->
mode_£Ëù_num_blocks
 = 
	`Ë64_to_ıu
(
id_ns
->
nÿp
);

1845 ià(
ns
->
mode_£Ëù_block_Ën
 == 0) {

1846 
æbas
 = (
id_ns
->flbas) & 0x0F;

1847 
ns
->
mode_£Ëù_block_Ën
 =

1848 (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1850 
out_dma
:

1851 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

1852 
mem
, 
dma_addr
);

1854 
out
:

1855  
»s
;

1856 
	}
}

1858 
	$nvme_Œªs_fmt_g‘_·rm_h—d”
(
sg_io_hdr
 *
hdr
, 
u8
 
Ën
,

1859 
u8
 
fÜm©_´Ù_šfo
, u8 *
nvme_pf_code
)

1861 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1862 
u8
 *
·rm_li¡
;

1863 
u8
 
pf_u§ge
, 
pf_code
;

1865 
·rm_li¡
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1866 ià(
·rm_li¡
 =ğ
NULL
) {

1867 
»s
 = -
ENOMEM
;

1868 
out
;

1870 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
Ën
);

1871 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1872 
out_mem
;

1874 ià((
·rm_li¡
[
FORMAT_UNIT_IMMED_OFFSET
] &

1875 
FORMAT_UNIT_IMMED_MASK
) != 0) {

1876 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1877 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1878 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1879 
out_mem
;

1882 ià(
Ën
 =ğ
FORMAT_UNIT_LONG_PARM_LIST_LEN
 &&

1883 (
·rm_li¡
[
FORMAT_UNIT_PROT_INT_OFFSET
] & 0x0F) != 0) {

1884 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1885 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1886 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1887 
out_mem
;

1889 
pf_u§ge
 = 
·rm_li¡
[
FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
] &

1890 
FORMAT_UNIT_PROT_FIELD_USAGE_MASK
;

1891 
pf_code
 = (
pf_u§ge
 << 2è| 
fÜm©_´Ù_šfo
;

1892 
pf_code
) {

1894 *
nvme_pf_code
 = 0;

1897 *
nvme_pf_code
 = 1;

1900 *
nvme_pf_code
 = 2;

1903 *
nvme_pf_code
 = 3;

1906 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1907 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1908 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1912 
out_mem
:

1913 
	`kä“
(
·rm_li¡
);

1914 
out
:

1915  
»s
;

1916 
	}
}

1918 
	$nvme_Œªs_fmt_£nd_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1919 
u8
 
´Ù_šfo
)

1921 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1922 
nvme_sc
;

1923 
nvme_dev
 *
dev
 = 
ns
->dev;

1924 
dma_addr_t
 
dma_addr
;

1925 *
mem
;

1926 
nvme_id_ns
 *
id_ns
;

1927 
u8
 
i
;

1928 
u8
 
æbas
, 
Æbaf
;

1929 
u8
 
£Ëùed_lbaf
 = 0xFF;

1930 
u32
 
cdw10
 = 0;

1931 
nvme_commªd
 
c
;

1934 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

1935 &
dma_addr
, 
GFP_KERNEL
);

1936 ià(
mem
 =ğ
NULL
) {

1937 
»s
 = -
ENOMEM
;

1938 
out
;

1941 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

1942 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1943 ià(
»s
)

1944 
out_dma
;

1945 ià(
nvme_sc
) {

1946 
»s
 = 
nvme_sc
;

1947 
out_dma
;

1949 
id_ns
 = 
mem
;

1950 
æbas
 = (
id_ns
->flbas) & 0x0F;

1951 
Æbaf
 = 
id_ns
->nlbaf;

1953 
i
 = 0; i < 
Æbaf
; i++) {

1954 ià(
ns
->
mode_£Ëù_block_Ën
 =ğ(1 << (
id_ns
->
lbaf
[
i
].
ds
))) {

1955 
£Ëùed_lbaf
 = 
i
;

1959 ià(
£Ëùed_lbaf
 > 0x0F) {

1960 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1961 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1962 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1964 ià(
ns
->
mode_£Ëù_num_blocks
 !ğ
	`Ë64_to_ıu
(
id_ns
->
nÿp
)) {

1965 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1966 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1967 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1970 
cdw10
 |ğ
´Ù_šfo
 << 5;

1971 
cdw10
 |ğ
£Ëùed_lbaf
 & 0x0F;

1972 
	`mem£t
(&
c
, 0, (c));

1973 
c
.
fÜm©
.
İcode
 = 
nvme_admš_fÜm©_nvm
;

1974 
c
.
fÜm©
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1975 
c
.
fÜm©
.
cdw10
 = 
	`ıu_to_Ë32
(cdw10);

1977 
nvme_sc
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1978 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1979 ià(
»s
)

1980 
out_dma
;

1981 ià(
nvme_sc
)

1982 
»s
 = 
nvme_sc
;

1984 
out_dma
:

1985 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

1986 
dma_addr
);

1987 
out
:

1988  
»s
;

1989 
	}
}

1993 
šlše
 
	$nvme_Œªs_g‘_io_cdb6
(
u8
 *
cmd
,

1994 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1996 
cdb_šfo
->
fua
 = 0;

1997 
cdb_šfo
->
´Ù_šfo
 = 0;

1998 
cdb_šfo
->
lba
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_6_CDB_LBA_OFFSET
) &

1999 
IO_6_CDB_LBA_MASK
;

2000 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_6_CDB_TX_LEN_OFFSET
);

2003 ià(
cdb_šfo
->
xãr_Ën
 == 0)

2004 
cdb_šfo
->
xãr_Ën
 = 
IO_6_DEFAULT_TX_LEN
;

2005 
	}
}

2007 
šlše
 
	$nvme_Œªs_g‘_io_cdb10
(
u8
 *
cmd
,

2008 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

2010 
cdb_šfo
->
fua
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_10_CDB_FUA_OFFSET
) &

2011 
IO_CDB_FUA_MASK
;

2012 
cdb_šfo
->
´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_10_CDB_WP_OFFSET
) &

2013 
IO_CDB_WP_MASK
 >> 
IO_CDB_WP_SHIFT
;

2014 
cdb_šfo
->
lba
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_10_CDB_LBA_OFFSET
);

2015 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
, 
IO_10_CDB_TX_LEN_OFFSET
);

2016 
	}
}

2018 
šlše
 
	$nvme_Œªs_g‘_io_cdb12
(
u8
 *
cmd
,

2019 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

2021 
cdb_šfo
->
fua
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_12_CDB_FUA_OFFSET
) &

2022 
IO_CDB_FUA_MASK
;

2023 
cdb_šfo
->
´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_12_CDB_WP_OFFSET
) &

2024 
IO_CDB_WP_MASK
 >> 
IO_CDB_WP_SHIFT
;

2025 
cdb_šfo
->
lba
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_12_CDB_LBA_OFFSET
);

2026 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_12_CDB_TX_LEN_OFFSET
);

2027 
	}
}

2029 
šlše
 
	$nvme_Œªs_g‘_io_cdb16
(
u8
 *
cmd
,

2030 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

2032 
cdb_šfo
->
fua
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_16_CDB_FUA_OFFSET
) &

2033 
IO_CDB_FUA_MASK
;

2034 
cdb_šfo
->
´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_16_CDB_WP_OFFSET
) &

2035 
IO_CDB_WP_MASK
 >> 
IO_CDB_WP_SHIFT
;

2036 
cdb_šfo
->
lba
 = 
	`GET_U64_FROM_CDB
(
cmd
, 
IO_16_CDB_LBA_OFFSET
);

2037 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_16_CDB_TX_LEN_OFFSET
);

2038 
	}
}

2040 
šlše
 
u32
 
	$nvme_Œªs_io_g‘_num_cmds
(
sg_io_hdr
 *
hdr
,

2041 
nvme_Œªs_io_cdb
 *
cdb_šfo
,

2042 
u32
 
max_blocks
)

2045 ià(
hdr
->
iovec_couÁ
 > 0)

2046  
hdr
->
iovec_couÁ
;

2047 ià(
cdb_šfo
->
xãr_Ën
 > 
max_blocks
)

2048  ((
cdb_šfo
->
xãr_Ën
 - 1è/ 
max_blocks
) + 1;

2051 
	}
}

2053 
u16
 
	$nvme_Œªs_io_g‘_cÚŒŞ
(
nvme_ns
 *
ns
,

2054 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

2056 
u16
 
cÚŒŞ
 = 0;

2060 ià(
cdb_šfo
->
fua
 > 0)

2061 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

2063  
cÚŒŞ
;

2064 
	}
}

2066 
	$nvme_Œªs_do_nvme_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2067 
nvme_Œªs_io_cdb
 *
cdb_šfo
, 
u8
 
is_wr™e
)

2069 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2070 
nvme_sc
;

2071 
nvme_dev
 *
dev
 = 
ns
->dev;

2072 
u32
 
num_cmds
;

2073 
nvme_iod
 *
iod
;

2074 
u64
 
un™_Ën
;

2075 
u64
 
un™_num_blocks
;

2076 
u32
 
»tcode
;

2077 
u32
 
i
 = 0;

2078 
u64
 
nvme_off£t
 = 0;

2079 
__u£r
 *
Ãxt_m­pšg_addr
;

2080 
nvme_commªd
 
c
;

2081 
u8
 
İcode
 = (
is_wr™e
 ? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

2082 
u16
 
cÚŒŞ
;

2083 
u32
 
max_blocks
 = 
	`queue_max_hw_£ùÜs
(
ns
->
queue
);

2085 
num_cmds
 = 
	`nvme_Œªs_io_g‘_num_cmds
(
hdr
, 
cdb_šfo
, 
max_blocks
);

2096 
i
 = 0; i < 
num_cmds
; i++) {

2097 
	`mem£t
(&
c
, 0, (c));

2098 ià(
hdr
->
iovec_couÁ
 > 0) {

2099 
sg_iovec
 
sgl
;

2101 
»tcode
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

2102 
i
 * (
sg_iovec
),

2103 (
sg_iovec
));

2104 ià(
»tcode
)

2105  -
EFAULT
;

2106 
un™_Ën
 = 
sgl
.
iov_Ën
;

2107 
un™_num_blocks
 = 
un™_Ën
 >> 
ns
->
lba_shiá
;

2108 
Ãxt_m­pšg_addr
 = 
sgl
.
iov_ba£
;

2110 
un™_num_blocks
 = 
	`mš
((
u64
)
max_blocks
,

2111 (
cdb_šfo
->
xãr_Ën
 - 
nvme_off£t
));

2112 
un™_Ën
 = 
un™_num_blocks
 << 
ns
->
lba_shiá
;

2113 
Ãxt_m­pšg_addr
 = 
hdr
->
dxã½
 +

2114 ((1 << 
ns
->
lba_shiá
è* 
nvme_off£t
);

2117 
c
.
rw
.
İcode
 = opcode;

2118 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2119 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
cdb_šfo
->
lba
 + 
nvme_off£t
);

2120 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
un™_num_blocks
 - 1);

2121 
cÚŒŞ
 = 
	`nvme_Œªs_io_g‘_cÚŒŞ
(
ns
, 
cdb_šfo
);

2122 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

2124 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
,

2125 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2126 ()
Ãxt_m­pšg_addr
, 
un™_Ën
);

2127 ià(
	`IS_ERR
(
iod
)) {

2128 
»s
 = 
	`PTR_ERR
(
iod
);

2129 
out
;

2131 
»tcode
 = 
	`nvme_£tup_´ps
(
dev
, 
iod
, 
un™_Ën
, 
GFP_KERNEL
);

2132 ià(
»tcode
 !ğ
un™_Ën
) {

2133 
	`nvme_unm­_u£r_·ges
(
dev
,

2134 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2135 
iod
);

2136 
	`nvme_ä“_iod
(
dev
, 
iod
);

2137 
»s
 = -
ENOMEM
;

2138 
out
;

2140 
c
.
rw
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

2141 
c
.
rw
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

2143 
nvme_off£t
 +ğ
un™_num_blocks
;

2145 
nvme_sc
 = 
	`nvme_subm™_io_cmd
(
dev
, 
ns
, &
c
, 
NULL
);

2146 ià(
nvme_sc
 !ğ
NVME_SC_SUCCESS
) {

2147 
	`nvme_unm­_u£r_·ges
(
dev
,

2148 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2149 
iod
);

2150 
	`nvme_ä“_iod
(
dev
, 
iod
);

2151 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2152 
out
;

2154 
	`nvme_unm­_u£r_·ges
(
dev
,

2155 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2156 
iod
);

2157 
	`nvme_ä“_iod
(
dev
, 
iod
);

2159 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2161 
out
:

2162  
»s
;

2163 
	}
}

2168 
	$nvme_Œªs_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
, 
u8
 
is_wr™e
,

2169 
u8
 *
cmd
)

2171 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2172 
nvme_Œªs_io_cdb
 
cdb_šfo
;

2173 
u8
 
İcode
 = 
cmd
[0];

2174 
u64
 
xãr_by‹s
;

2175 
u64
 
sum_iov_Ën
 = 0;

2176 
sg_iovec
 
sgl
;

2177 
i
;

2178 
size_t
 
nÙ_cİ›d
;

2181 
İcode
) {

2182 
WRITE_6
:

2183 
READ_6
:

2184 
	`nvme_Œªs_g‘_io_cdb6
(
cmd
, &
cdb_šfo
);

2186 
WRITE_10
:

2187 
READ_10
:

2188 
	`nvme_Œªs_g‘_io_cdb10
(
cmd
, &
cdb_šfo
);

2190 
WRITE_12
:

2191 
READ_12
:

2192 
	`nvme_Œªs_g‘_io_cdb12
(
cmd
, &
cdb_šfo
);

2194 
WRITE_16
:

2195 
READ_16
:

2196 
	`nvme_Œªs_g‘_io_cdb16
(
cmd
, &
cdb_šfo
);

2200 
»s
 = 
SNTI_INTERNAL_ERROR
;

2201 
out
;

2205 ià(
hdr
->
iovec_couÁ
 > 0) {

2206 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

2207 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

2208 
i
 * (
sg_iovec
),

2209 (
sg_iovec
));

2210 ià(
nÙ_cİ›d
)

2211  -
EFAULT
;

2212 
sum_iov_Ën
 +ğ
sgl
.
iov_Ën
;

2214 ià(
sgl
.
iov_Ën
 % (1 << 
ns
->
lba_shiá
) != 0) {

2215 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2216 
SAM_STAT_CHECK_CONDITION
,

2217 
ILLEGAL_REQUEST
,

2218 
SCSI_ASC_INVALID_PARAMETER
,

2219 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2220 
out
;

2224 
sum_iov_Ën
 = 
hdr
->
dxãr_Ën
;

2228 
xãr_by‹s
 = 
	`mš
(((
u64
)
hdr
->
dxãr_Ën
), 
sum_iov_Ën
);

2231 ià(
xãr_by‹s
 !ğ(
cdb_šfo
.
xãr_Ën
 << 
ns
->
lba_shiá
)) {

2232 
»s
 = -
EINVAL
;

2233 
out
;

2237 ià(
cdb_šfo
.
xãr_Ën
 == 0)

2238 
out
;

2241 
»s
 = 
	`nvme_Œªs_do_nvme_io
(
ns
, 
hdr
, &
cdb_šfo
, 
is_wr™e
);

2242 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2243 
out
;

2245 
out
:

2246  
»s
;

2247 
	}
}

2249 
	$nvme_Œªs_šquœy
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2250 
u8
 *
cmd
)

2252 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2253 
u8
 
evpd
;

2254 
u8
 
·ge_code
;

2255 
®loc_Ën
;

2256 
u8
 *
šq_»¥Ú£
;

2258 
evpd
 = 
	`GET_INQ_EVPD_BIT
(
cmd
);

2259 
·ge_code
 = 
	`GET_INQ_PAGE_CODE
(
cmd
);

2260 
®loc_Ën
 = 
	`GET_INQ_ALLOC_LENGTH
(
cmd
);

2262 
šq_»¥Ú£
 = 
	`km®loc
(
®loc_Ën
, 
GFP_KERNEL
);

2263 ià(
šq_»¥Ú£
 =ğ
NULL
) {

2264 
»s
 = -
ENOMEM
;

2265 
out_mem
;

2268 ià(
evpd
 == 0) {

2269 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

2270 
»s
 = 
	`nvme_Œªs_¡ªd¬d_šquœy_·ge
(
ns
, 
hdr
,

2271 
šq_»¥Ú£
, 
®loc_Ën
);

2273 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2274 
SAM_STAT_CHECK_CONDITION
,

2275 
ILLEGAL_REQUEST
,

2276 
SCSI_ASC_INVALID_CDB
,

2277 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2280 
·ge_code
) {

2281 
VPD_SUPPORTED_PAGES
:

2282 
»s
 = 
	`nvme_Œªs_suµÜ‹d_vpd_·ges
(
ns
, 
hdr
,

2283 
šq_»¥Ú£
, 
®loc_Ën
);

2285 
VPD_SERIAL_NUMBER
:

2286 
»s
 = 
	`nvme_Œªs_un™_£rŸl_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

2287 
®loc_Ën
);

2289 
VPD_DEVICE_IDENTIFIERS
:

2290 
»s
 = 
	`nvme_Œªs_deviû_id_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

2291 
®loc_Ën
);

2293 
VPD_EXTENDED_INQUIRY
:

2294 
»s
 = 
	`nvme_Œªs_ext_šq_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

2296 
VPD_BLOCK_LIMITS
:

2297 
»s
 = 
	`nvme_Œªs_bdev_lim™s_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

2298 
®loc_Ën
);

2300 
VPD_BLOCK_DEV_CHARACTERISTICS
:

2301 
»s
 = 
	`nvme_Œªs_bdev_ch¬_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

2304 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2305 
SAM_STAT_CHECK_CONDITION
,

2306 
ILLEGAL_REQUEST
,

2307 
SCSI_ASC_INVALID_CDB
,

2308 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2312 
	`kä“
(
šq_»¥Ú£
);

2313 
out_mem
:

2314  
»s
;

2315 
	}
}

2317 
	$nvme_Œªs_log_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2318 
u8
 *
cmd
)

2320 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2321 
u16
 
®loc_Ën
;

2322 
u8
 
¥
;

2323 
u8
 
pc
;

2324 
u8
 
·ge_code
;

2326 
¥
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
LOG_SENSE_CDB_SP_OFFSET
);

2327 ià(
¥
 !ğ
LOG_SENSE_CDB_SP_NOT_ENABLED
) {

2328 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2329 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2330 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2331 
out
;

2333 
pc
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
LOG_SENSE_CDB_PC_OFFSET
);

2334 
·ge_code
 = 
pc
 & 
LOG_SENSE_CDB_PAGE_CODE_MASK
;

2335 
pc
 = (pø& 
LOG_SENSE_CDB_PC_MASK
è>> 
LOG_SENSE_CDB_PC_SHIFT
;

2336 ià(
pc
 !ğ
LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
) {

2337 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2338 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2339 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2340 
out
;

2342 
®loc_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
, 
LOG_SENSE_CDB_ALLOC_LENGTH_OFFSET
);

2343 
·ge_code
) {

2344 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
:

2345 
»s
 = 
	`nvme_Œªs_log_suµ_·ges
(
ns
, 
hdr
, 
®loc_Ën
);

2347 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
:

2348 
»s
 = 
	`nvme_Œªs_log_šfo_exû±iÚs
(
ns
, 
hdr
, 
®loc_Ën
);

2350 
LOG_PAGE_TEMPERATURE_PAGE
:

2351 
»s
 = 
	`nvme_Œªs_log_‹m³¿tu»
(
ns
, 
hdr
, 
®loc_Ën
);

2354 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2355 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2356 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2360 
out
:

2361  
»s
;

2362 
	}
}

2364 
	$nvme_Œªs_mode_£Ëù
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2365 
u8
 *
cmd
)

2367 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2368 
u8
 
cdb10
 = 0;

2369 
u16
 
·rm_li¡_Ën
;

2370 
u8
 
·ge_fÜm©
;

2371 
u8
 
§ve_·ges
;

2373 
·ge_fÜm©
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SELECT_CDB_PAGE_FORMAT_OFFSET
);

2374 
·ge_fÜm©
 &ğ
MODE_SELECT_CDB_PAGE_FORMAT_MASK
;

2376 
§ve_·ges
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SELECT_CDB_SAVE_PAGES_OFFSET
);

2377 
§ve_·ges
 &ğ
MODE_SELECT_CDB_SAVE_PAGES_MASK
;

2379 ià(
	`GET_OPCODE
(
cmd
è=ğ
MODE_SELECT
) {

2380 
·rm_li¡_Ën
 = 
	`GET_U8_FROM_CDB
(
cmd
,

2381 
MODE_SELECT_6_CDB_PARAM_LIST_LENGTH_OFFSET
);

2383 
·rm_li¡_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
,

2384 
MODE_SELECT_10_CDB_PARAM_LIST_LENGTH_OFFSET
);

2385 
cdb10
 = 1;

2388 ià(
·rm_li¡_Ën
 != 0) {

2393 
»s
 = 
	`nvme_Œªs_mode£l_d©a
(
ns
, 
hdr
, 
cmd
, 
·rm_li¡_Ën
,

2394 
·ge_fÜm©
, 
§ve_·ges
, 
cdb10
);

2397  
»s
;

2398 
	}
}

2400 
	$nvme_Œªs_mode_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2401 
u8
 *
cmd
)

2403 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2404 
u16
 
®loc_Ën
;

2405 
u8
 
cdb10
 = 0;

2406 
u8
 
·ge_code
;

2407 
u8
 
pc
;

2409 ià(
	`GET_OPCODE
(
cmd
è=ğ
MODE_SENSE
) {

2410 
®loc_Ën
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SENSE6_ALLOC_LEN_OFFSET
);

2412 
®loc_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
,

2413 
MODE_SENSE10_ALLOC_LEN_OFFSET
);

2414 
cdb10
 = 1;

2417 
pc
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SENSE_PAGE_CONTROL_OFFSET
) &

2418 
MODE_SENSE_PAGE_CONTROL_MASK
;

2419 ià(
pc
 !ğ
MODE_SENSE_PC_CURRENT_VALUES
) {

2420 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2421 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2422 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2423 
out
;

2426 
·ge_code
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SENSE_PAGE_CODE_OFFSET
) &

2427 
MODE_SENSE_PAGE_CODE_MASK
;

2428 
·ge_code
) {

2429 
MODE_PAGE_CACHING
:

2430 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2431 
cdb10
,

2432 &
nvme_Œªs_fl_ÿchšg_·ge
,

2433 
MODE_PAGE_CACHING_LEN
);

2435 
MODE_PAGE_CONTROL
:

2436 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2437 
cdb10
,

2438 &
nvme_Œªs_fl_cÚŒŞ_·ge
,

2439 
MODE_PAGE_CONTROL_LEN
);

2441 
MODE_PAGE_POWER_CONDITION
:

2442 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2443 
cdb10
,

2444 &
nvme_Œªs_fl_pow_úd_·ge
,

2445 
MODE_PAGE_POW_CND_LEN
);

2447 
MODE_PAGE_INFO_EXCEP
:

2448 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2449 
cdb10
,

2450 &
nvme_Œªs_fl_šf_exc_·ge
,

2451 
MODE_PAGE_INF_EXC_LEN
);

2453 
MODE_PAGE_RETURN_ALL
:

2454 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2455 
cdb10
,

2456 &
nvme_Œªs_fl_®l_·ges
,

2457 
MODE_PAGE_ALL_LEN
);

2460 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2461 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2462 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2466 
out
:

2467  
»s
;

2468 
	}
}

2470 
	$nvme_Œªs_»ad_ÿ·c™y
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2471 
u8
 *
cmd
)

2473 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2474 
nvme_sc
;

2475 
u32
 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

2476 
u32
 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

2477 
u32
 
xãr_Ën
;

2478 
u8
 
cdb16
;

2479 
nvme_dev
 *
dev
 = 
ns
->dev;

2480 
dma_addr_t
 
dma_addr
;

2481 *
mem
;

2482 
nvme_id_ns
 *
id_ns
;

2483 
u8
 *
»¥Ú£
;

2485 
cdb16
 = 
	`IS_READ_CAP_16
(
cmd
);

2486 ià(
cdb16
) {

2487 
®loc_Ën
 = 
	`GET_READ_CAP_16_ALLOC_LENGTH
(
cmd
);

2488 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

2491 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

2492 &
dma_addr
, 
GFP_KERNEL
);

2493 ià(
mem
 =ğ
NULL
) {

2494 
»s
 = -
ENOMEM
;

2495 
out
;

2498 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

2499 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2500 ià(
»s
)

2501 
out_dma
;

2502 ià(
nvme_sc
) {

2503 
»s
 = 
nvme_sc
;

2504 
out_dma
;

2506 
id_ns
 = 
mem
;

2508 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2509 ià(
»¥Ú£
 =ğ
NULL
) {

2510 
»s
 = -
ENOMEM
;

2511 
out_dma
;

2513 
	`nvme_Œªs_fl_»ad_ÿp
(
»¥Ú£
, 
id_ns
, 
cdb16
);

2515 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2516 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2518 
	`kä“
(
»¥Ú£
);

2519 
out_dma
:

2520 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

2521 
dma_addr
);

2522 
out
:

2523  
»s
;

2524 
	}
}

2526 
	$nvme_Œªs_»pÜt_luns
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2527 
u8
 *
cmd
)

2529 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2530 
nvme_sc
;

2531 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2532 
u8
 
£Ëù_»pÜt
;

2533 
u8
 *
»¥Ú£
;

2534 
nvme_dev
 *
dev
 = 
ns
->dev;

2535 
dma_addr_t
 
dma_addr
;

2536 *
mem
;

2537 
nvme_id_ù¾
 *
id_ù¾
;

2538 
u32
 
Î_Ëngth
, 
lun_id
;

2539 
u8
 
lun_id_off£t
 = 
REPORT_LUNS_FIRST_LUN_OFFSET
;

2540 
__be32
 
tmp_Ën
;

2542 
®loc_Ën
 = 
	`GET_REPORT_LUNS_ALLOC_LENGTH
(
cmd
);

2543 
£Ëù_»pÜt
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
REPORT_LUNS_SR_OFFSET
);

2545 ià((
£Ëù_»pÜt
 !ğ
ALL_LUNS_RETURNED
) &&

2546 (
£Ëù_»pÜt
 !ğ
ALL_WELL_KNOWN_LUNS_RETURNED
) &&

2547 (
£Ëù_»pÜt
 !ğ
RESTRICTED_LUNS_RETURNED
)) {

2548 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2549 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2550 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2551 
out
;

2554 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

2555 (
nvme_id_ù¾
),

2556 &
dma_addr
, 
GFP_KERNEL
);

2557 ià(
mem
 =ğ
NULL
) {

2558 
»s
 = -
ENOMEM
;

2559 
out
;

2561 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

2562 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2563 ià(
»s
)

2564 
out_dma
;

2565 ià(
nvme_sc
) {

2566 
»s
 = 
nvme_sc
;

2567 
out_dma
;

2569 
id_ù¾
 = 
mem
;

2570 
Î_Ëngth
 = 
	`Ë32_to_ıu
(
id_ù¾
->
Â
è* 
LUN_ENTRY_SIZE
;

2571 
»¥_size
 = 
Î_Ëngth
 + 
LUN_DATA_HEADER_SIZE
;

2573 ià(
®loc_Ën
 < 
»¥_size
) {

2574 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2575 
SAM_STAT_CHECK_CONDITION
,

2576 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2577 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2578 
out_dma
;

2581 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2582 ià(
»¥Ú£
 =ğ
NULL
) {

2583 
»s
 = -
ENOMEM
;

2584 
out_dma
;

2588 
lun_id
 = 0;†un_id < 
	`Ë32_to_ıu
(
id_ù¾
->
Â
);†un_id++) {

2593 
__be64
 
tmp_id
 = 
	`ıu_to_be64
(
lun_id
);

2594 
	`memıy
(&
»¥Ú£
[
lun_id_off£t
], &
tmp_id
, (
u64
));

2595 
lun_id_off£t
 +ğ
LUN_ENTRY_SIZE
;

2597 
tmp_Ën
 = 
	`ıu_to_be32
(
Î_Ëngth
);

2598 
	`memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

2601 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2602 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2604 
	`kä“
(
»¥Ú£
);

2605 
out_dma
:

2606 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ù¾
), 
mem
,

2607 
dma_addr
);

2608 
out
:

2609  
»s
;

2610 
	}
}

2612 
	$nvme_Œªs_»que¡_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2613 
u8
 *
cmd
)

2615 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2616 
u8
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2617 
u8
 
desc_fÜm©
;

2618 
u8
 *
»¥Ú£
;

2620 
®loc_Ën
 = 
	`GET_REQUEST_SENSE_ALLOC_LENGTH
(
cmd
);

2621 
desc_fÜm©
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
REQUEST_SENSE_DESC_OFFSET
);

2622 
desc_fÜm©
 &ğ
REQUEST_SENSE_DESC_MASK
;

2624 
»¥_size
 = ((
desc_fÜm©
è? (
DESC_FMT_SENSE_DATA_SIZE
) :

2625 (
FIXED_FMT_SENSE_DATA_SIZE
));

2626 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2627 ià(
»¥Ú£
 =ğ
NULL
) {

2628 
»s
 = -
ENOMEM
;

2629 
out
;

2632 ià(
desc_fÜm©
 =ğ
DESCRIPTOR_FORMAT_SENSE_DATA_TYPE
) {

2634 
»¥Ú£
[0] = 
DESC_FORMAT_SENSE_DATA
;

2635 
»¥Ú£
[1] = 
NO_SENSE
;

2637 
»¥Ú£
[2] = 
SCSI_ASC_NO_SENSE
;

2638 
»¥Ú£
[3] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2642 
»¥Ú£
[0] = 
FIXED_SENSE_DATA
;

2644 
»¥Ú£
[2] = 
NO_SENSE
;

2646 
»¥Ú£
[7] = 
FIXED_SENSE_DATA_ADD_LENGTH
;

2648 
»¥Ú£
[12] = 
SCSI_ASC_NO_SENSE
;

2649 
»¥Ú£
[13] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2654 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2655 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2657 
	`kä“
(
»¥Ú£
);

2658 
out
:

2659  
»s
;

2660 
	}
}

2662 
	$nvme_Œªs_£cur™y_´ÙocŞ
(
nvme_ns
 *
ns
,

2663 
sg_io_hdr
 *
hdr
,

2664 
u8
 *
cmd
)

2666  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2667 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2668 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2669 
	}
}

2671 
	$nvme_Œªs_¡¬t_¡İ
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2672 
u8
 *
cmd
)

2674 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2675 
nvme_sc
;

2676 
nvme_commªd
 
c
;

2677 
u8
 
immed
, 
pcmod
, 
pc
, 
no_æush
, 
¡¬t
;

2679 
immed
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_IMMED_OFFSET
);

2680 
pcmod
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_POWER_COND_MOD_OFFSET
);

2681 
pc
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_POWER_COND_OFFSET
);

2682 
no_æush
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_NO_FLUSH_OFFSET
);

2683 
¡¬t
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_START_OFFSET
);

2685 
immed
 &ğ
START_STOP_UNIT_CDB_IMMED_MASK
;

2686 
pcmod
 &ğ
START_STOP_UNIT_CDB_POWER_COND_MOD_MASK
;

2687 
pc
 = (pø& 
START_STOP_UNIT_CDB_POWER_COND_MASK
è>> 
NIBBLE_SHIFT
;

2688 
no_æush
 &ğ
START_STOP_UNIT_CDB_NO_FLUSH_MASK
;

2689 
¡¬t
 &ğ
START_STOP_UNIT_CDB_START_MASK
;

2691 ià(
immed
 != 0) {

2692 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2693 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2694 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2696 ià(
no_æush
 == 0) {

2698 
	`mem£t
(&
c
, 0, (c));

2699 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2700 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2702 
nvme_sc
 = 
	`nvme_subm™_io_cmd
(
ns
->
dev
,‚s, &
c
, 
NULL
);

2703 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2704 ià(
»s
)

2705 
out
;

2706 ià(
nvme_sc
) {

2707 
»s
 = 
nvme_sc
;

2708 
out
;

2712 
»s
 = 
	`nvme_Œªs_pow”_¡©e
(
ns
, 
hdr
, 
pc
, 
pcmod
, 
¡¬t
);

2715 
out
:

2716  
»s
;

2717 
	}
}

2719 
	$nvme_Œªs_synchrÚize_ÿche
(
nvme_ns
 *
ns
,

2720 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
)

2722 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2723 
nvme_sc
;

2724 
nvme_commªd
 
c
;

2726 
	`mem£t
(&
c
, 0, (c));

2727 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2728 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2730 
nvme_sc
 = 
	`nvme_subm™_io_cmd
(
ns
->
dev
,‚s, &
c
, 
NULL
);

2732 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2733 ià(
»s
)

2734 
out
;

2735 ià(
nvme_sc
)

2736 
»s
 = 
nvme_sc
;

2738 
out
:

2739  
»s
;

2740 
	}
}

2742 
	$nvme_Œªs_fÜm©_un™
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2743 
u8
 *
cmd
)

2745 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2746 
u8
 
·rm_hdr_Ën
 = 0;

2747 
u8
 
nvme_pf_code
 = 0;

2748 
u8
 
fÜm©_´Ù_šfo
, 
lÚg_li¡
, 
fÜm©_d©a
;

2750 
fÜm©_´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
,

2751 
FORMAT_UNIT_CDB_FORMAT_PROT_INFO_OFFSET
);

2752 
lÚg_li¡
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
FORMAT_UNIT_CDB_LONG_LIST_OFFSET
);

2753 
fÜm©_d©a
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
FORMAT_UNIT_CDB_FORMAT_DATA_OFFSET
);

2755 
fÜm©_´Ù_šfo
 = (format_prot_info &

2756 
FORMAT_UNIT_CDB_FORMAT_PROT_INFO_MASK
) >>

2757 
FORMAT_UNIT_CDB_FORMAT_PROT_INFO_SHIFT
;

2758 
lÚg_li¡
 &ğ
FORMAT_UNIT_CDB_LONG_LIST_MASK
;

2759 
fÜm©_d©a
 &ğ
FORMAT_UNIT_CDB_FORMAT_DATA_MASK
;

2761 ià(
fÜm©_d©a
 != 0) {

2762 ià(
fÜm©_´Ù_šfo
 != 0) {

2763 ià(
lÚg_li¡
 == 0)

2764 
·rm_hdr_Ën
 = 
FORMAT_UNIT_SHORT_PARM_LIST_LEN
;

2766 
·rm_hdr_Ën
 = 
FORMAT_UNIT_LONG_PARM_LIST_LEN
;

2768 } ià(
fÜm©_d©a
 =ğ0 && 
fÜm©_´Ù_šfo
 != 0) {

2769 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2770 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2771 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2772 
out
;

2780 ià(
·rm_hdr_Ën
 > 0) {

2781 
»s
 = 
	`nvme_Œªs_fmt_g‘_·rm_h—d”
(
hdr
, 
·rm_hdr_Ën
,

2782 
fÜm©_´Ù_šfo
, &
nvme_pf_code
);

2783 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2784 
out
;

2788 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_aùiv©e_fw
, 0, 0, 0);

2791 
»s
 = 
	`nvme_Œªs_fmt_£t_blk_size_couÁ
(
ns
, 
hdr
);

2792 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2793 
out
;

2795 
»s
 = 
	`nvme_Œªs_fmt_£nd_cmd
(
ns
, 
hdr
, 
nvme_pf_code
);

2797 
out
:

2798  
»s
;

2799 
	}
}

2801 
	$nvme_Œªs_‹¡_un™_»ady
(
nvme_ns
 *
ns
,

2802 
sg_io_hdr
 *
hdr
,

2803 
u8
 *
cmd
)

2805 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2806 
nvme_dev
 *
dev
 = 
ns
->dev;

2808 ià(!(
	`»adl
(&
dev
->
b¬
->
c¡s
è& 
NVME_CSTS_RDY
))

2809 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2810 
NOT_READY
, 
SCSI_ASC_LUN_NOT_READY
,

2811 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2813 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_GOOD
, 
NO_SENSE
, 0, 0);

2815  
»s
;

2816 
	}
}

2818 
	$nvme_Œªs_wr™e_bufãr
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2819 
u8
 *
cmd
)

2821 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2822 
u32
 
bufãr_off£t
, 
·rm_li¡_Ëngth
;

2823 
u8
 
bufãr_id
, 
mode
;

2825 
·rm_li¡_Ëngth
 =

2826 
	`GET_U24_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_PARM_LIST_LENGTH_OFFSET
);

2827 ià(
·rm_li¡_Ëngth
 % 
BYTES_TO_DWORDS
 != 0) {

2829 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2830 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2831 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2832 
out
;

2834 
bufãr_id
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_BUFFER_ID_OFFSET
);

2835 ià(
bufãr_id
 > 
NVME_MAX_FIRMWARE_SLOT
) {

2836 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2837 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2838 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2839 
out
;

2841 
mode
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_MODE_OFFSET
) &

2842 
WRITE_BUFFER_CDB_MODE_MASK
;

2843 
bufãr_off£t
 =

2844 
	`GET_U24_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_BUFFER_OFFSET_OFFSET
);

2846 
mode
) {

2847 
DOWNLOAD_SAVE_ACTIVATE
:

2848 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2849 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2850 
bufãr_id
);

2851 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2852 
out
;

2853 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_aùiv©e_fw
,

2854 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2855 
bufãr_id
);

2857 
DOWNLOAD_SAVE_DEFER_ACTIVATE
:

2858 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2859 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2860 
bufãr_id
);

2862 
ACTIVATE_DEFERRED_MICROCODE
:

2863 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_aùiv©e_fw
,

2864 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2865 
bufãr_id
);

2868 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2869 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2870 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2874 
out
:

2875  
»s
;

2876 
	}
}

2878 
	sscsi_unm­_blk_desc
 {

2879 
__be64
 
	m¦ba
;

2880 
__be32
 
	mÆb
;

2881 
u32
 
	m»sv
;

2884 
	sscsi_unm­_·rm_li¡
 {

2885 
__be16
 
	munm­_d©a_Ën
;

2886 
__be16
 
	munm­_blk_desc_d©a_Ën
;

2887 
u32
 
	m»sv
;

2888 
scsi_unm­_blk_desc
 
	mdesc
[0];

2891 
	$nvme_Œªs_unm­
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2892 
u8
 *
cmd
)

2894 
nvme_dev
 *
dev
 = 
ns
->dev;

2895 
scsi_unm­_·rm_li¡
 *
¶i¡
;

2896 
nvme_dsm_¿nge
 *
¿nge
;

2897 
nvme_commªd
 
c
;

2898 
i
, 
nvme_sc
, 
»s
 = -
ENOMEM
;

2899 
u16
 
ndesc
, 
li¡_Ën
;

2900 
dma_addr_t
 
dma_addr
;

2902 
li¡_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
, 
UNMAP_CDB_PARAM_LIST_LENGTH_OFFSET
);

2903 ià(!
li¡_Ën
)

2904  -
EINVAL
;

2906 
¶i¡
 = 
	`km®loc
(
li¡_Ën
, 
GFP_KERNEL
);

2907 ià(!
¶i¡
)

2908  -
ENOMEM
;

2910 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
¶i¡
, 
li¡_Ën
);

2911 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2912 
out
;

2914 
ndesc
 = 
	`be16_to_ıu
(
¶i¡
->
unm­_blk_desc_d©a_Ën
) >> 4;

2915 ià(!
ndesc
 ||‚desc > 256) {

2916 
»s
 = -
EINVAL
;

2917 
out
;

2920 
¿nge
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 
ndesc
 * (*range),

2921 &
dma_addr
, 
GFP_KERNEL
);

2922 ià(!
¿nge
)

2923 
out
;

2925 
i
 = 0; i < 
ndesc
; i++) {

2926 
¿nge
[
i
].
Æb
 = 
	`ıu_to_Ë32
(
	`be32_to_ıu
(
¶i¡
->
desc
[i].nlb));

2927 
¿nge
[
i
].
¦ba
 = 
	`ıu_to_Ë64
(
	`be64_to_ıu
(
¶i¡
->
desc
[i].slba));

2928 
¿nge
[
i
].
ÿ‰r
 = 0;

2931 
	`mem£t
(&
c
, 0, (c));

2932 
c
.
dsm
.
İcode
 = 
nvme_cmd_dsm
;

2933 
c
.
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2934 
c
.
dsm
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

2935 
c
.
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
ndesc
 - 1);

2936 
c
.
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

2938 
nvme_sc
 = 
	`nvme_subm™_io_cmd
(
dev
, 
ns
, &
c
, 
NULL
);

2939 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2941 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 
ndesc
 * (*
¿nge
),

2942 
¿nge
, 
dma_addr
);

2943 
out
:

2944 
	`kä“
(
¶i¡
);

2945  
»s
;

2946 
	}
}

2948 
	$nvme_scsi_Œª¦©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
)

2950 
u8
 
cmd
[
BLK_MAX_CDB
];

2951 
»tcode
;

2952 
İcode
;

2954 ià(
hdr
->
cmdp
 =ğ
NULL
)

2955  -
EMSGSIZE
;

2956 ià(
	`cİy_äom_u£r
(
cmd
, 
hdr
->
cmdp
, hdr->
cmd_Ën
))

2957  -
EFAULT
;

2963 
»tcode
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2964 ià(
»tcode
)

2965  
»tcode
;

2967 
İcode
 = 
cmd
[0];

2969 
İcode
) {

2970 
READ_6
:

2971 
READ_10
:

2972 
READ_12
:

2973 
READ_16
:

2974 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 0, 
cmd
);

2976 
WRITE_6
:

2977 
WRITE_10
:

2978 
WRITE_12
:

2979 
WRITE_16
:

2980 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 1, 
cmd
);

2982 
INQUIRY
:

2983 
»tcode
 = 
	`nvme_Œªs_šquœy
(
ns
, 
hdr
, 
cmd
);

2985 
LOG_SENSE
:

2986 
»tcode
 = 
	`nvme_Œªs_log_£n£
(
ns
, 
hdr
, 
cmd
);

2988 
MODE_SELECT
:

2989 
MODE_SELECT_10
:

2990 
»tcode
 = 
	`nvme_Œªs_mode_£Ëù
(
ns
, 
hdr
, 
cmd
);

2992 
MODE_SENSE
:

2993 
MODE_SENSE_10
:

2994 
»tcode
 = 
	`nvme_Œªs_mode_£n£
(
ns
, 
hdr
, 
cmd
);

2996 
READ_CAPACITY
:

2997 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
);

2999 
SERVICE_ACTION_IN_16
:

3000 ià(
	`IS_READ_CAP_16
(
cmd
))

3001 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
);

3003 
out
;

3005 
REPORT_LUNS
:

3006 
»tcode
 = 
	`nvme_Œªs_»pÜt_luns
(
ns
, 
hdr
, 
cmd
);

3008 
REQUEST_SENSE
:

3009 
»tcode
 = 
	`nvme_Œªs_»que¡_£n£
(
ns
, 
hdr
, 
cmd
);

3011 
SECURITY_PROTOCOL_IN
:

3012 
SECURITY_PROTOCOL_OUT
:

3013 
»tcode
 = 
	`nvme_Œªs_£cur™y_´ÙocŞ
(
ns
, 
hdr
, 
cmd
);

3015 
START_STOP
:

3016 
»tcode
 = 
	`nvme_Œªs_¡¬t_¡İ
(
ns
, 
hdr
, 
cmd
);

3018 
SYNCHRONIZE_CACHE
:

3019 
»tcode
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
, 
cmd
);

3021 
FORMAT_UNIT
:

3022 
»tcode
 = 
	`nvme_Œªs_fÜm©_un™
(
ns
, 
hdr
, 
cmd
);

3024 
TEST_UNIT_READY
:

3025 
»tcode
 = 
	`nvme_Œªs_‹¡_un™_»ady
(
ns
, 
hdr
, 
cmd
);

3027 
WRITE_BUFFER
:

3028 
»tcode
 = 
	`nvme_Œªs_wr™e_bufãr
(
ns
, 
hdr
, 
cmd
);

3030 
UNMAP
:

3031 
»tcode
 = 
	`nvme_Œªs_unm­
(
ns
, 
hdr
, 
cmd
);

3034 
out
:

3035 
»tcode
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

3036 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

3037 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

3040  
»tcode
;

3041 
	}
}

3043 
	$nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
)

3045 
sg_io_hdr
 
hdr
;

3046 
»tcode
;

3048 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3049  -
EACCES
;

3050 ià(
	`cİy_äom_u£r
(&
hdr
, 
u_hdr
, (hdr)))

3051  -
EFAULT
;

3052 ià(
hdr
.
š‹rçû_id
 != 'S')

3053  -
EINVAL
;

3054 ià(
hdr
.
cmd_Ën
 > 
BLK_MAX_CDB
)

3055  -
EINVAL
;

3057 
»tcode
 = 
	`nvme_scsi_Œª¦©e
(
ns
, &
hdr
);

3058 ià(
»tcode
 < 0)

3059  
»tcode
;

3060 ià(
»tcode
 > 0)

3061 
»tcode
 = 
SNTI_TRANSLATION_SUCCESS
;

3062 ià(
	`cİy_to_u£r
(
u_hdr
, &
hdr
, (
sg_io_hdr_t
)) > 0)

3063  -
EFAULT
;

3065  
»tcode
;

3066 
	}
}

3068 
	$nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

)

3070  
	`put_u£r
(
sg_v”siÚ_num
, 

);

3071 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

19 
	#KSID_SUPPORT


	)

20 
	~"lšux_nvme_ioùl.h
"

22 
	~<u­i/lšux/nvme.h
>

24 
	~<lšux/pci.h
>

25 
	~<lšux/k»f.h
>

26 
	~<lšux/blk-mq.h
>

28 
	snvme_b¬
 {

29 
__u64
 
	mÿp
;

30 
__u32
 
	mvs
;

31 
__u32
 
	mštms
;

32 
__u32
 
	mštmc
;

33 
__u32
 
	mcc
;

34 
__u32
 
	mrsvd1
;

35 
__u32
 
	mc¡s
;

36 
__u32
 
	mrsvd2
;

37 
__u32
 
	maqa
;

38 
__u64
 
	masq
;

39 
__u64
 
	macq
;

42 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

43 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

44 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

45 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

46 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

49 
	mNVME_CC_ENABLE
 = 1 << 0,

50 
	mNVME_CC_CSS_NVM
 = 0 << 4,

51 
	mNVME_CC_MPS_SHIFT
 = 7,

52 
	mNVME_CC_ARB_RR
 = 0 << 11,

53 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

54 
	mNVME_CC_ARB_VS
 = 7 << 11,

55 
	mNVME_CC_SHN_NONE
 = 0 << 14,

56 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

57 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

58 
	mNVME_CC_SHN_MASK
 = 3 << 14,

59 
	mNVME_CC_IOSQES
 = 6 << 16,

60 
	mNVME_CC_IOCQES
 = 4 << 20,

61 
	mNVME_CSTS_RDY
 = 1 << 0,

62 
	mNVME_CSTS_CFS
 = 1 << 1,

63 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

64 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

65 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

66 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

69 
nvme_io_timeout
;

70 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

75 
	snvme_dev
 {

76 
li¡_h—d
 
	mnode
;

77 
nvme_queue
 **
	mqueues
;

78 
»que¡_queue
 *
	madmš_q
;

79 
blk_mq_g_£t
 
	mg£t
;

80 
blk_mq_g_£t
 
	madmš_g£t
;

81 
u32
 
__iomem
 *
	mdbs
;

82 
pci_dev
 *
	mpci_dev
;

83 
dma_poŞ
 *
	m´p_·ge_poŞ
;

84 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

85 
	mš¡ªû
;

86 
	mqueue_couÁ
;

87 
	mÚlše_queues
;

88 
	mmax_qid
;

89 
	mq_d•th
;

90 
u32
 
	mdb_¡ride
;

91 
u32
 
	mù¾_cÚfig
;

92 
msix_’Œy
 *
	m’Œy
;

93 
nvme_b¬
 
__iomem
 *
	mb¬
;

94 
li¡_h—d
 
	mÇme¥aûs
;

95 
k»f
 
	mk»f
;

96 
deviû
 *
	mdeviû
;

97 
wÜk_¡ruù
 
	m»£t_wÜk
;

98 
wÜk_¡ruù
 
	m´obe_wÜk
;

99 
wÜk_¡ruù
 
	msÿn_wÜk
;

100 
	mÇme
[12];

101 
	m£rŸl
[20];

102 
	mmod–
[40];

103 
	mfœmw¬e_»v
[8];

104 
u32
 
	mmax_hw_£ùÜs
;

105 
u32
 
	m¡re_size
;

106 
u32
 
	m·ge_size
;

107 
u16
 
	mÚcs
;

108 
u16
 
	mabÜt_lim™
;

109 
u8
 
	mev’t_lim™
;

110 
u8
 
	mvwc
;

116 
	snvme_ns
 {

117 
li¡_h—d
 
	mli¡
;

119 
nvme_dev
 *
	mdev
;

120 
»que¡_queue
 *
	mqueue
;

121 
g’disk
 *
	mdisk
;

123 
	mns_id
;

124 
	mlba_shiá
;

125 
u16
 
	mms
;

126 
boŞ
 
	mext
;

127 
u8
 
	mpi_ty³
;

128 
u64
 
	mmode_£Ëù_num_blocks
;

129 
u32
 
	mmode_£Ëù_block_Ën
;

138 
	snvme_iod
 {

139 
	m´iv©e
;

140 
	mÅages
;

141 
	moff£t
;

142 
	mÃÁs
;

143 
	mËngth
;

144 
dma_addr_t
 
	mfœ¡_dma
;

145 
sÿ‰”li¡
 
	mm‘a_sg
[1];

146 
sÿ‰”li¡
 
	msg
[0];

149 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

151  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

152 
	}
}

159 
nvme_ä“_iod
(
nvme_dev
 *
dev
, 
nvme_iod
 *
iod
);

161 
nvme_£tup_´ps
(
nvme_dev
 *, 
nvme_iod
 *, , 
gå_t
);

162 
nvme_iod
 *
nvme_m­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

163 
addr
, 
Ëngth
);

164 
nvme_unm­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

165 
nvme_iod
 *
iod
);

166 
nvme_subm™_io_cmd
(
nvme_dev
 *, 
nvme_ns
 *,

167 
nvme_commªd
 *, 
u32
 *);

168 
nvme_subm™_æush_d©a
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
);

169 
nvme_subm™_admš_cmd
(
nvme_dev
 *, 
nvme_commªd
 *,

170 
u32
 *
»suÉ
);

171 
nvme_id’tify
(
nvme_dev
 *, 
nsid
, 
ús
,

172 
dma_addr_t
 
dma_addr
);

173 
nvme_g‘_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
nsid
,

174 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
);

175 
nvme_£t_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
dwÜd11
,

176 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
);

178 
	gsg_io_hdr
;

180 
nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
);

181 
nvme_sg_io32
(
nvme_ns
 *
ns
, 
¬g
);

182 
nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/´.h
>

26 
	~<lšux/±¿û.h
>

28 
	~<lšux/nvme_ioùl.h
>

30 
	~<lšux/idr.h
>

31 
	~<scsi/sg.h
>

32 
	~<asm/uÇligÃd.h
>

35 
	~<lšux/fe.h
>

36 
	~<lšux/fdbË.h
>

37 
	~<lšux/ev’tfd.h
>

38 
	~<lšux/k»f.h
>

39 
	~<lšux/ä“z”.h
>

40 
	~<lšux/wa™.h
>

41 
	~<lšux/kth»ad.h
>

42 
	~<lšux/sk_io_accouÁšg_İs.h
>

43 
	~"lšux_nvme_ioùl.h
"

48 
	~"nvme.h
"

49 
	~"çbrics.h
"

51 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

53 
	gadmš_timeout
 = 60;

54 
moduË_·¿m
(
admš_timeout
, 
by‹
, 0644);

55 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

56 
EXPORT_SYMBOL_GPL
(
admš_timeout
);

58 
	gnvme_io_timeout
 = 30;

59 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
by‹
, 0644);

60 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

61 
EXPORT_SYMBOL_GPL
(
nvme_io_timeout
);

63 
	gshutdown_timeout
 = 5;

64 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

65 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

67 
	gnvme_max_»Œ›s
 = 5;

68 
moduË_·¿m_Çmed
(
max_»Œ›s
, 
nvme_max_»Œ›s
, 
ušt
, 0644);

69 
MODULE_PARM_DESC
(
max_»Œ›s
, "max‚umber of„etries‡ command may have");

70 
EXPORT_SYMBOL_GPL
(
nvme_max_»Œ›s
);

72 
	gnvme_ch¬_majÜ
;

73 
moduË_·¿m
(
nvme_ch¬_majÜ
, , 0);

75 
LIST_HEAD
(
nvme_ù¾_li¡
);

76 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

78 
şass
 *
	gnvme_şass
;

86 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

87 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

88 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

89 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

91 
__u32
 
	gaio_cÚ‹xt_id
;

93 
	#AIOCTX_MAX
 1024

	)

94 
	#AIOCB_MAX
 (1024*64)

	)

96 
__u64
 
	gdebug_com¶‘ed
 =0;

97 
	gdebug_out¡ªdšg
 =0;

99 
	snvme_kaioùx


101 
nvme_aioùx
 
	muùx
;

102 
ev’tfd_ùx
 *
	mev’tùx
;

103 
li¡_h—d
 
	mkaiocb_li¡
;

104 
¥šlock_t
 
	mkaioùx_¥šlock
;

105 
k»f
 
	m»f
;

108 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

109 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

111 
	saio_u£r_ùx
 {

112 
	mÃÁs
;

113 
	mËn
;

114 
·ge
 ** 
	m·ges
;

115 
sÿ‰”li¡
 *
	msg
;

116 
	md©a
[1];

119 
	snvme_kaiocb


121 
li¡_h—d
 
	maiocb_li¡
;

122 
nvme_aiÛv’t
 
	mev’t
;

123 
	mİcode
;

124 
nvme_commªd
 
	mcmd
;

125 
g’disk
 *
	mdisk
;

126 
sÿ‰”li¡
 
	mm‘a_sg
;

127 
boŞ
 
	mÃed_to_cİy
;

128 
	m¡¬t_time
;

129 
boŞ
 
	mu£_m‘a
;

130 *
	mkv_d©a
;

131 *
	mm‘a
;

132 
aio_u£r_ùx
 *
	mu£r_ùx
;

133 
aio_u£r_ùx
 *
	mk”Ãl_ùx
;

134 
»que¡
 *
	m»q
;

138 
	saio_wÜk”_ùx
{

139 
	mıu
;

140 
¥šlock_t
 
	mkaiocb_¥šlock
;

141 
li¡_h—d
 
	mkaiocb_li¡
;

142 
wa™_queue_h—d_t
 
	maio_wa™queue
;

146 
aio_wÜk”_ùx
 * 
__³rıu
 
	gaio_w_ùx
;

148 
sk_¡ruù
 ** 
__³rıu
 
	gaio_wÜk”
;

152 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

154 
nvme_kaiocb
 *
tmpcb
;

155 
li¡_h—d
 *
pos
, *
q
;

156 
æags
;

157 ià(
ùx
) {

158 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

159 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

160 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

161 
	`li¡_d–
(
pos
);

162 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

164 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

165 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

166 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

168 
	}
}

170 
	$ş—nup_kaioùx
(
k»f
 *kref) {

171 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

172 
	`»move_kaioùx
(
ùx
);

173 
	}
}

175 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

176 
	`k»f_g‘
(&
ùx
->
»f
);

177 
	}
}

179 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

180 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

181 
	}
}

186 
	$de¡roy_aio_mempoŞ
()

188 
i
 = 0;

189 ià(
g_kaioùx_tb
) {

190 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

191 ià(
g_kaioùx_tb
[
i
]) {

192 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

193 
g_kaioùx_tb
[
i
] = 
NULL
;

196 
	`kä“
(
g_kaioùx_tb
);

197 
g_kaioùx_tb
 = 
NULL
;

199 ià(
kaiocb_mempoŞ
)

200 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

201 ià(
kaioùx_mempoŞ
)

202 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

203 ià(
kaioùx_ÿch•
)

204 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

205 ià(
kaiocb_ÿch•
)

206 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

207 
	}
}

212 
	$aio_£rviû_š™
()

214 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

215 ià(!
g_kaioùx_tb
)

216 
ç
;

217 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

220 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

221 ià(!
kaioùx_ÿch•
)

222 
ç
;

224 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

225 ià(!
kaiocb_ÿch•
)

226 
ç
;

228 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

229 ià(!
kaiocb_mempoŞ
)

230 
ç
;

232 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

233 ià(!
kaioùx_mempoŞ
)

234 
ç
;

238 
aio_cÚ‹xt_id
 = 1;

239 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

240 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

243 
ç
:

244 
	`de¡roy_aio_mempoŞ
();

245  -
ENOMEM
;

246 
	}
}

251 
	$aio_£rviû_ex™
()

253 
	`de¡roy_aio_mempoŞ
();

254 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

256 
	}
}

258 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

259 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

262 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

263 ià(
tmp
è
	`»f_kaioùx
(tmp);

265  
tmp
;

266 
	}
}

272 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

274 
nvme_kaioùx
 *
tmp
;

275 
æags
;

276 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

277 ià(
tmp
) {

278 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

279 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

280 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

282 
	`´_”r
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

284 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

285 
	`d”ef_kaioùx
(
tmp
);

289 
	`´_”r
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

294 
	}
}

300 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

302 
nvme_kaioùx
 
ùx
;

303 
æags
;

304 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

305  -
EFAULT
;

307 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

308 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

309 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

310 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

312 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

314 
	}
}

320 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

322 
nvme_kaioùx
 *
ùx
;

323 
fd
 
efe
;

324 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

325 
æags
;

326 
»t
 = 0;

327 
i
 = 0;

328 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

329  -
EACCES
;

331 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

332 ià(!
ùx
)

333  -
ENOMEM
;

335 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

336  -
EFAULT
;

338 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

339 ià(!
efe
.
fe
) {

340 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

341 
»t
 = -
EBADF
;

342 
ex™
;

345 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

346 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

347 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

348 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

349 
put_efe
;

352 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

353 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

354 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

355 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

356 
aio_cÚ‹xt_id
 = 
i
;

360 ià(
i
 >ğ
AIOCTX_MAX
) {

361 
	`´_”r
("nvme_set_aioctx:oo many‡ioctx open.\n");

362 
»t
 = -
EMFILE
;

363 
put_ev’t_fd
;

366 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

367 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

368 
aio_cÚ‹xt_id
 = 0;

369 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

370 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

371 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

372 
	`k»f_š™
(&
ùx
->
»f
);

373 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

374 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

376 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

378 
	`´_”r
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

379 
»t
 = -
EINVAL
;

380 
ş—nup
;

382 
ev’tfd_ùx
 = 
NULL
;

383 
debug_out¡ªdšg
 = 0;

384 
debug_com¶‘ed
 = 0;

385 
	`fdput
(
efe
);

387 
ş—nup
:

388 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

389 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

390 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

391 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

392 
put_ev’t_fd
:

393 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

394 
put_efe
:

395 
	`fdput
(
efe
);

396 
ex™
:

397  
»t
;

398 
	}
}

402 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

403 
nvme_kaiocb
 *
»q
;

404 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

405 ià(!
»q
)  0;

407 
	`mem£t
(
»q
, 0, (*req));

409 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

411 
»q
->
ev’t
.
»qid
 =„eqid;

413  
»q
;

414 
	}
}

418 
	$nvme_g‘_iÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

420 
li¡_h—d
 *
pos
, *
q
;

421 
nvme_kaiocb
 *
tmp
;

422 
nvme_kaioùx
 *
tmp_ùx
;

423 
æags
;

424 
	`LIST_HEAD
(
tmp_h—d
);

425 
__u16
 
couÁ
 =0;

426 
__u16
 
Ä
 = 0;

427 
__u32
 
ùxid
 = 0;

429 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

430  -
EACCES
;

432 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

434 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

436 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

438 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

439 ià(
tmp_ùx
) {

440 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

441 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

442 
	`li¡_d–_š™
(
pos
);

443 
	`li¡_add
(
pos
, &
tmp_h—d
);

444 
couÁ
++;

445 ià(
Ä
 =ğ
couÁ
) ;

447 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

448 
	`d”ef_kaioùx
(
tmp_ùx
);

449 
couÁ
 = 0;

450 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

451 
	`li¡_d–
(
pos
);

452 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

453 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

454 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

455 
couÁ
++;

458 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

461 
	}
}

463 
	$kv_com¶‘e_aio_â
(
nvme_kaiocb
 *
cmdšfo
) {

464 
»que¡
 *
»q
 = 
cmdšfo
->req;

465 
i
 = 0;

467 ià(
cmdšfo
->
Ãed_to_cİy
) {

471 ià(
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_™”_»ad_cmd
(cmdinfo->opcode)) {

473 *
d©a
 = 
cmdšfo
->
kv_d©a
;

474 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

476 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

477 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

479 
i
 = 0; i < 
cmdšfo
->
k”Ãl_ùx
->
ÃÁs
; i++) {

480 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
k”Ãl_ùx
->
sg
[
i
]));

483 ià(
cmdšfo
->
u£r_ùx
) {

484 ià(
	`is_kv_¡Üe_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_­³nd_cmd
(cmdinfo->opcode)) {

485 
	`g’”ic_’d_io_acù
(
WRITE
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

487 
	`g’”ic_’d_io_acù
(
READ
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

489 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++) {

490 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

493 
	`blk_mq_ä“_»que¡
(
»q
);

495 ià(
cmdšfo
->
u£_m‘a
) {

496 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

499 ià(
cmdšfo
->
Ãed_to_cİy
) {

500 
	`kä“
(
cmdšfo
->
k”Ãl_ùx
);

501 
	`kä“
(
cmdšfo
->
kv_d©a
);

503 ià(
cmdšfo
->
u£r_ùx
è
	`kä“
(cmdinfo->user_ctx);

504 ià(
cmdšfo
->
m‘a
è
	`kä“
(cmdinfo->meta);

506 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

507 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

509 
	}
}

511 
	$wake_up_aio_wÜk”
(
aio_wÜk”_ùx
 *
aio_ùx
) {

512 
	`wake_up
(&
aio_ùx
->
aio_wa™queue
);

513 
	}
}

515 
	$š£¹_aiocb_to_wÜk”
(
nvme_kaiocb
 *
aiocb
) {

516 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

517 
æags
;

518 
ıu
 = 
	`smp_´oûssÜ_id
();

519 
	`INIT_LIST_HEAD
(&
aiocb
->
aiocb_li¡
);

521 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
ıu
);

522 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

523 
	`li¡_add_
(&
aiocb
->
aiocb_li¡
, &
ùx
->
kaiocb_li¡
);

524 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

525 
	`wake_up_aio_wÜk”
(
ùx
);

527 
	}
}

529 
	$kv_async_com¶‘iÚ
(
»que¡
 *
»q
, 
”rÜ
){

530 
nvme_kaiocb
 *
aiocb
 = 
»q
->
’d_io_d©a
;

532 
aiocb
->
»q
 =„eq;

533 
aiocb
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

534 
aiocb
->
ev’t
.
¡©us
 = 
”rÜ
;

535 
	`š£¹_aiocb_to_wÜk”
(
aiocb
);

537 
	}
}

539 
	$kvaio_³rıu_wÜk”_â
(*
¬g
) {

540 
aio_wÜk”_ùx
 *
ùx
 = (aio_wÜk”_ùx *)
¬g
;

541 
li¡_h—d
 *
pos
, *
Ãxt
;

542 
æags
;

543 
	`LIST_HEAD
(
tmp_li¡
);

544 
	`´_”r
("¡¬ˆaiØwÜk” %u\n", 
ùx
->
ıu
);

545 !
	`kth»ad_should_¡İ
(è|| !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

546 ià(
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

547 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
ùx
->
aio_wa™queue
,

548 !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
), 
HZ
/10);

551 
	`INIT_LIST_HEAD
(&
tmp_li¡
);

552 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

553 
	`li¡_¥liû
(&
ùx
->
kaiocb_li¡
, &
tmp_li¡
);

554 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

555 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

556 ià(!
	`li¡_em±y
(&
tmp_li¡
)) {

557 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, &
tmp_li¡
) {

558 
nvme_kaiocb
 *
aiocb
 = 
	`li¡_’Œy
(
pos
, nvme_kaiocb, 
aiocb_li¡
);

559 
	`li¡_d–_š™
(
pos
);

560 
	`kv_com¶‘e_aio_â
(
aiocb
);

565 
	}
}

567 
	$aio_wÜk”_š™
() {

568 
sk_¡ruù
 **
p
 = 
NULL
;

569 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

570 
i
 = 0;

572 
aio_wÜk”
 = 
	`®loc_³rıu
(
sk_¡ruù
 *);

573 ià(!
aio_wÜk”
) {

574 
	`´_”r
("failo‡lloc…ercpu workerask_struct!\n");

575  -
ENOMEM
;

577 
aio_w_ùx
 = 
	`®loc_³rıu
(
aio_wÜk”_ùx
);

578 ià(!
aio_w_ùx
) {

579 
	`´_”r
("failo‡lloc…ercpu‡io context!\n");

580 
out_ä“
;

583 
	`fÜ_—ch_Úlše_ıu
(
i
) {

584 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
i
);

585 
ùx
->
ıu
 = 
i
;

586 
	`¥š_lock_š™
(&
ùx
->
kaiocb_¥šlock
);

587 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

588 
	`š™_wa™queue_h—d
(&
ùx
->
aio_wa™queue
);

589 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

590 *
p
 = 
	`kth»ad_ü—‹_Ú_node
(
kvaio_³rıu_wÜk”_â
, 
ùx
, 
	`ıu_to_node
(
i
), "aio_completion_worker/%u", i);

591 ià(!(*
p
))

592 
»£t_±h»ad
;

593 
	`kth»ad_bšd
(*
p
, 
i
);

594 
	`wake_up_´oûss
(*
p
);

598 
»£t_±h»ad
:

599 
	`fÜ_—ch_Úlše_ıu
(
i
) {

600 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

601 ià(*
p
è
	`kth»ad_¡İ
(*p);

603 
out_ä“
:

604 ià(
aio_wÜk”
)

605 
	`ä“_³rıu
(
aio_wÜk”
);

606  -
ENOMEM
;

607 
	}
}

609 
	$aio_wÜk”_ex™
() {

610 
sk_¡ruù
 **
p
 = 
NULL
;

611 
i
 = 0;

612 
	`fÜ_—ch_Úlše_ıu
(
i
) {

613 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

614 ià(*
p
è
	`kth»ad_¡İ
(*p);

616 
	`ä“_³rıu
(
aio_wÜk”
);

617 
	`ä“_³rıu
(
aio_w_ùx
);

619 
	}
}

625 
	$nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

627 
¡©us
;

629 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

632 
	`dev_dbg_¿‹lim™ed
(((
nvme_ù¾
 *è
d©a
)->
deviû
,

633 "CªûÎšg I/O %d", 
»q
->
g
);

635 
¡©us
 = 
NVME_SC_ABORT_REQ
;

636 ià(
	`blk_queue_dyšg
(
»q
->
q
))

637 
¡©us
 |ğ
NVME_SC_DNR
;

638 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
¡©us
);

639 
	}
}

640 
EXPORT_SYMBOL_GPL
(
nvme_ÿnûl_»que¡
);

642 
boŞ
 
	$nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

643 
nvme_ù¾_¡©e
 
Ãw_¡©e
)

645 
nvme_ù¾_¡©e
 
Şd_¡©e
;

646 
boŞ
 
chªged
 = 
çl£
;

648 
	`¥š_lock_œq
(&
ù¾
->
lock
);

650 
Şd_¡©e
 = 
ù¾
->
¡©e
;

651 
Ãw_¡©e
) {

652 
NVME_CTRL_LIVE
:

653 
Şd_¡©e
) {

654 
NVME_CTRL_NEW
:

655 
NVME_CTRL_RESETTING
:

656 
NVME_CTRL_RECONNECTING
:

657 
chªged
 = 
Œue
;

663 
NVME_CTRL_RESETTING
:

664 
Şd_¡©e
) {

665 
NVME_CTRL_NEW
:

666 
NVME_CTRL_LIVE
:

667 
NVME_CTRL_RECONNECTING
:

668 
chªged
 = 
Œue
;

674 
NVME_CTRL_RECONNECTING
:

675 
Şd_¡©e
) {

676 
NVME_CTRL_LIVE
:

677 
chªged
 = 
Œue
;

683 
NVME_CTRL_DELETING
:

684 
Şd_¡©e
) {

685 
NVME_CTRL_LIVE
:

686 
NVME_CTRL_RESETTING
:

687 
NVME_CTRL_RECONNECTING
:

688 
chªged
 = 
Œue
;

694 
NVME_CTRL_DEAD
:

695 
Şd_¡©e
) {

696 
NVME_CTRL_DELETING
:

697 
chªged
 = 
Œue
;

707 ià(
chªged
)

708 
ù¾
->
¡©e
 = 
Ãw_¡©e
;

710 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

712  
chªged
;

713 
	}
}

714 
EXPORT_SYMBOL_GPL
(
nvme_chªge_ù¾_¡©e
);

716 
	$nvme_ä“_ns
(
k»f
 *kref)

718 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

720 
	`¥š_lock
(&
dev_li¡_lock
);

721 
ns
->
disk
->
´iv©e_d©a
 = 
NULL
;

722 
	`¥š_uÆock
(&
dev_li¡_lock
);

724 
	`put_disk
(
ns
->
disk
);

725 
	`ida_sim¶e_»move
(&
ns
->
ù¾
->
ns_ida
,‚s->
š¡ªû
);

726 
	`nvme_put_ù¾
(
ns
->
ù¾
);

727 
	`kä“
(
ns
);

728 
	}
}

730 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

732 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

733 
	}
}

735 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
)

737 
nvme_ns
 *
ns
;

739 
	`¥š_lock
(&
dev_li¡_lock
);

740 
ns
 = 
disk
->
´iv©e_d©a
;

741 ià(
ns
) {

742 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

743 
ç
;

744 ià(!
	`Œy_moduË_g‘
(
ns
->
ù¾
->
İs
->
moduË
))

745 
ç_put_ns
;

747 
	`¥š_uÆock
(&
dev_li¡_lock
);

749  
ns
;

751 
ç_put_ns
:

752 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

753 
ç
:

754 
	`¥š_uÆock
(&
dev_li¡_lock
);

755  
NULL
;

756 
	}
}

758 
	$nvme_»queue_»q
(
»que¡
 *
»q
)

760 
æags
;

762 
	`blk_mq_»queue_»que¡
(
»q
, 
çl£
);

763 
	`¥š_lock_œq§ve
(
»q
->
q
->
queue_lock
, 
æags
);

764 ià(!
	`blk_queue_¡İ³d
(
»q
->
q
))

765 
	`blk_mq_kick_»queue_li¡
(
»q
->
q
);

766 
	`¥š_uÆock_œq»¡Üe
(
»q
->
q
->
queue_lock
, 
æags
);

767 
	}
}

768 
EXPORT_SYMBOL_GPL
(
nvme_»queue_»q
);

770 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

771 
nvme_commªd
 *
cmd
, 
æags
, 
qid
)

773 
»que¡
 *
»q
;

775 ià(
qid
 =ğ
NVME_QID_ANY
) {

776 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
);

778 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
,

779 
qid
 ? qid - 1 : 0);

781 ià(
	`IS_ERR
(
»q
))

782  
»q
;

784 
»q
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

785 
»q
->
cmd_æags
 |ğ
REQ_FAILFAST_DRIVER
;

786 
»q
->
__d©a_Ën
 = 0;

787 
»q
->
__£ùÜ
 = (
£ùÜ_t
) -1;

788 
»q
->
bio
 =„eq->
biÙa
 = 
NULL
;

790 
	`nvme_»q
(
»q
)->
cmd
 = cmd;

792  
»q
;

793 
	}
}

794 
EXPORT_SYMBOL_GPL
(
nvme_®loc_»que¡
);

796 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

797 
nvme_commªd
 *
cmnd
)

799 
	`mem£t
(
cmnd
, 0, (*cmnd));

800 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

801 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

802 
	}
}

804 
šlše
 
	$nvme_£tup_disÿrd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

805 
nvme_commªd
 *
cmnd
)

807 
nvme_dsm_¿nge
 *
¿nge
;

808 
·ge
 *page;

809 
off£t
;

810 
Ä_by‹s
 = 
	`blk_rq_by‹s
(
»q
);

812 
¿nge
 = 
	`km®loc
((*¿nge), 
GFP_ATOMIC
);

813 ià(!
¿nge
)

814  
BLK_MQ_RQ_QUEUE_BUSY
;

816 
¿nge
->
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

817 
¿nge
->
Æb
 = 
	`ıu_to_Ë32
(
Ä_by‹s
 >> 
ns
->
lba_shiá
);

818 
¿nge
->
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

820 
	`mem£t
(
cmnd
, 0, (*cmnd));

821 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

822 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

823 
cmnd
->
dsm
.
Ä
 = 0;

824 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

826 
»q
->
com¶‘iÚ_d©a
 = 
¿nge
;

827 
·ge
 = 
	`vœt_to_·ge
(
¿nge
);

828 
off£t
 = 
	`off£t_š_·ge
(
¿nge
);

829 
	`blk_add_»que¡_·ylßd
(
»q
, 
·ge
, 
off£t
, (*
¿nge
));

836 
»q
->
__d©a_Ën
 = 
Ä_by‹s
;

838  
BLK_MQ_RQ_QUEUE_OK
;

839 
	}
}

841 
šlše
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

842 
nvme_commªd
 *
cmnd
)

844 
u16
 
cÚŒŞ
 = 0;

845 
u32
 
dsmgmt
 = 0;

847 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

848 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

849 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

850 
cÚŒŞ
 |ğ
NVME_RW_LR
;

852 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

853 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

855 
	`mem£t
(
cmnd
, 0, (*cmnd));

856 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

857 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

858 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

859 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

861 ià(
ns
->
ms
) {

862 ià(!
	`blk_š‹gr™y_rq
(
»q
))

863 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

866 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

867 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

868 
	}
}

870 
	$nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

871 
nvme_commªd
 *
cmd
)

873 
»t
 = 
BLK_MQ_RQ_QUEUE_OK
;

875 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

876 
	`memıy
(
cmd
, 
	`nvme_»q
(
»q
)->cmd, (*cmd));

877 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

878 
	`nvme_£tup_æush
(
ns
, 
cmd
);

879 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
)

880 
»t
 = 
	`nvme_£tup_disÿrd
(
ns
, 
»q
, 
cmd
);

882 
	`nvme_£tup_rw
(
ns
, 
»q
, 
cmd
);

884 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

886  
»t
;

887 
	}
}

888 
EXPORT_SYMBOL_GPL
(
nvme_£tup_cmd
);

894 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

895 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

896 
timeout
, 
qid
, 
©_h—d
, 
æags
)

898 
»que¡
 *
»q
;

899 
»t
;

901 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
æags
, 
qid
);

902 ià(
	`IS_ERR
(
»q
))

903  
	`PTR_ERR
(
»q
);

905 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

907 ià(
bufãr
 && 
bufæ’
) {

908 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
__GFP_WAIT
);

909 ià(
»t
)

910 
out
;

913 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 
©_h—d
);

914 ià(
»suÉ
)

915 *
»suÉ
 = 
	`nvme_»q
(
»q
)->result;

916 
»t
 = 
»q
->
”rÜs
;

917 
out
:

918 
	`blk_mq_ä“_»que¡
(
»q
);

919  
»t
;

920 
	}
}

921 
EXPORT_SYMBOL_GPL
(
__nvme_subm™_sync_cmd
);

923 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

924 *
bufãr
, 
bufæ’
)

926  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

927 
NVME_QID_ANY
, 0, 0);

928 
	}
}

929 
EXPORT_SYMBOL_GPL
(
nvme_subm™_sync_cmd
);

939 
boŞ
 
	$check_add_fÜ_sšgË_cÚt_phyadd»ss
(
__u£r
 *
add»ss
, 
Ëngth
, 
»que¡_queue
 *
q
)

941 
off£t
 = 0;

942 
couÁ
 = 0;

944 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

945 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

946 ià((
couÁ
 > 1è|| (()
add»ss
 & 
	`queue_dma_®ignm’t
(
q
))) {

948  
çl£
;

950  
Œue
;

951 
	}
}

953 
	$u£r_addr_Åages
(
off£t
, 
size
)

955 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

956  
couÁ
;

957 
	}
}

959 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
, 
boŞ
 
b_k”Ãl
)

961 
off£t
 = 
	`off£t_š_·ge
(
addr
);

962 
d©®’
 = 
Ën
;

963 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
,
Ën
);

964 
size
 = 0;

965 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

966 
m­³d_·ges
 = 0;

967 
i
 = 0;

969 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


970 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

972 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

973 ià(!
u£r_ùx
) {

974  
NULL
;

977 
u£r_ùx
->
ÃÁs
 = 0;

978 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

979 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

980 ià(
b_k”Ãl
) {

981 
·ge
 *·gğ
NULL
;

982 *
¤c_d©a
 = 
addr
;

983 
i
 = 0; i < 
num_·ge
; i++) {

984 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

985 
	`g‘_·ge
(
·ge
);

986 
u£r_ùx
->
·ges
[
i
] = 
·ge
;

987 
¤c_d©a
 +ğ
PAGE_SIZE
;

991 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

992 0, 
u£r_ùx
->
·ges
);

993 ià(
m­³d_·ges
 !ğ
num_·ge
) {

994 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

995 
ex™
;

998 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

999 
u£r_ùx
->
Ën
 = 
d©®’
;

1000 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

1001 
i
 = 0; i < 
num_·ge
; i++) {

1002 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

1003 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

1004 
off£t
);

1005 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

1006 
off£t
 = 0;

1008 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

1009  
u£r_ùx
;

1010 
ex™
:

1011 ià(
u£r_ùx
) {

1012 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

1013 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

1014 
	`kä“
(
u£r_ùx
);

1016  
NULL
;

1017 
	}
}

1018 
	$__nvme_subm™_kv_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1019 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

1020 
__u£r
 *
ubufãr
, 
bufæ’
,

1021 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1022 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

1024 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1025 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1026 
»que¡
 *
»q
;

1027 
»t
 = 0;

1028 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

1029 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1030 
aio_u£r_ùx
 *
k”Ãl_ùx
 = 
NULL
;

1031 
sÿ‰”li¡
* 
m‘a_sg_±r
;

1032 
sÿ‰”li¡
 
m‘a_sg
;

1033 
·ge
* 
p_·ge
 = 
NULL
;

1034 
nvme_io_·¿m
* 
·¿m
 = 
NULL
;

1035 *
kv_d©a
 = 
NULL
;

1036 *
kv_m‘a
 = 
NULL
;

1037 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

1038 
i
 = 0, 
off£t
 = 0;

1039 
Ën
 = 0;

1040 
¡¬t_time
 = 
jiff›s
;

1041 ià(!
disk
)

1042  -
EFAULT
;

1044 ià(
aio
) {

1045 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

1046 ià(!
aiocb
) {

1047 
»t
 = -
ENOMEM
;

1048 
out_’d
;

1050 
aiocb
->
cmd
 = *cmd;

1051 
aiocb
->
disk
 = disk;

1052 
cmd
 = &
aiocb
->cmd;

1054 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1055 ià(
	`IS_ERR
(
»q
)) {

1056 ià(
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1057  
	`PTR_ERR
(
»q
);

1060 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1061 
·¿m
 = 
	`nvme_io_·¿m
(
»q
);

1062 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1063 
·¿m
->
kv_d©a_sg_±r
 = 
NULL
;

1064 
·¿m
->
kv_d©a_ÃÁs
 = 0;

1065 
·¿m
->
kv_d©a_Ën
 = 0;

1067 ià(
ubufãr
 && 
bufæ’
) {

1068 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
q
)) {

1069 
Ãed_to_cİy
 = 
Œue
;

1070 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

1071 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1072 ià(
kv_d©a
 =ğ
NULL
) {

1073 
»t
 = -
ENOMEM
;

1074 
out_»q_’d
;

1077 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
, 
çl£
);

1078 ià(
Ãed_to_cİy
) {

1079 
k”Ãl_ùx
 = 
	`g‘_aio_u£r_ùx
(
kv_d©a
, 
bufæ’
, 
Œue
);

1080 ià(
k”Ãl_ùx
) {

1081 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1082 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1083 
kv_d©a
, 
u£r_ùx
->
Ën
);

1085 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

1086 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

1087 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

1093 
k”Ãl_ùx
 = 
u£r_ùx
;

1095 ià(
u£r_ùx
 =ğ
NULL
 || 
k”Ãl_ùx
 == NULL) {

1096 
»t
 = -
ENOMEM
;

1097 
out_unm­
;

1099 
·¿m
->
kv_d©a_sg_±r
 = 
k”Ãl_ùx
->
sg
;

1100 
·¿m
->
kv_d©a_ÃÁs
 = 
k”Ãl_ùx
->
ÃÁs
;

1101 
·¿m
->
kv_d©a_Ën
 = 
k”Ãl_ùx
->
Ën
;

1102 ià(
aio
) {

1103 
aiocb
->
Ãed_to_cİy
 =‚eed_to_copy;

1104 
aiocb
->
kv_d©a
 = kv_data;

1105 
aiocb
->
k”Ãl_ùx
 = kernel_ctx;

1106 
aiocb
->
u£r_ùx
 = user_ctx;

1107 
aiocb
->
¡¬t_time
 = 
jiff›s
;

1109 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1110 
	`g’”ic_¡¬t_io_acù
(
WRITE
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1112 
	`g’”ic_¡¬t_io_acù
(
READ
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1116 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1117 ià(
	`check_add_fÜ_sšgË_cÚt_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
, 
q
)) {

1118 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 0, &
p_·ge
);

1119 ià(
»t
 != 1) {

1120 
»t
 = -
ENOMEM
;

1121 
out_unm­
;

1123 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

1125 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256) * 256;

1126 
kv_m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1127 ià(!
kv_m‘a
) {

1128 
»t
 = -
ENOMEM
;

1129 
out_unm­
;

1131 ià(
	`cİy_äom_u£r
(
kv_m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

1132 
»t
 = -
EFAULT
;

1133 
out_ä“_m‘a
;

1135 
off£t
 = 
	`off£t_š_·ge
(
kv_m‘a
);

1136 
p_·ge
 = 
	`vœt_to_·ge
(
kv_m‘a
);

1137 
	`g‘_·ge
(
p_·ge
);

1139 ià(
aio
) {

1140 
aiocb
->
u£_m‘a
 = 
Œue
;

1141 
aiocb
->
m‘a
 = 
kv_m‘a
;

1142 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

1144 
m‘a_sg_±r
 = &
m‘a_sg
;

1146 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

1147 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

1148 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

1149 
·¿m
->
kv_m‘a_sg_±r
 = 
m‘a_sg_±r
;

1151 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1154 ià(
aio
) {

1155 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

1156 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

1157 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

1158 
»q
->
’d_io_d©a
 = 
aiocb
;

1159 
	`blk_execu‹_rq_nowa™
(
»q
->
q
, 
disk
,„eq, 0, 
kv_async_com¶‘iÚ
);

1162 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1163 
»t
 = 
»q
->
”rÜs
;

1164 ià(
»suÉ
)

1165 *
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

1166 ià(
¡©us
)

1167 *
¡©us
 = 
»t
;

1168 ià(
»t
 && !
	`is_kv_™”_»q_cmd
(
cmd
->
commÚ
.
İcode
è&& !
	`is_kv_™”_»ad_cmd
(cmd->common.opcode)) {

1170 
	`´_”r
("__nvme_subm™_u£r_cmd faed!!!!!: opcode(%02x)\n", 
cmd
->
commÚ
.
İcode
);

1174 ià(
Ãed_to_cİy
) {

1175 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

1176 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || ((ret & 0x00ff) == 0x0093)))) {

1178 *
d©a
 = 
kv_d©a
;

1179 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

1180 
d©a
[0], data[1], data[2], data[3],

1181 
d©a
[4], data[5], data[6], data[7]);

1183 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1184 
kv_d©a
, 
u£r_ùx
->
Ën
);

1188 
out_ä“_m‘a
:

1189 ià(
p_·ge
è
	`put_·ge
(p_page);

1190 ià(
kv_m‘a
è
	`kä“
(kv_meta);

1191 
out_unm­
:

1192 ià(
u£r_ùx
) {

1193 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++) {

1194 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

1196 
	`kä“
(
u£r_ùx
);

1198 ià(
Ãed_to_cİy
) {

1199 ià(
k”Ãl_ùx
) {

1200 
i
 = 0; i < 
k”Ãl_ùx
->
ÃÁs
; i++) {

1201 
	`put_·ge
(
	`sg_·ge
(&
k”Ãl_ùx
->
sg
[
i
]));

1203 
	`kä“
(
k”Ãl_ùx
);

1205 ià(
kv_d©a
è
	`kä“
(kv_data);

1207 
out_»q_’d
:

1208 ià(
aio
 && 
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1209 
	`blk_mq_ä“_»que¡
(
»q
);

1211 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1212 
	`g’”ic_’d_io_acù
(
WRITE
, &
disk
->
·¹0
, 
¡¬t_time
);

1214 
	`g’”ic_’d_io_acù
(
READ
, &
disk
->
·¹0
, 
¡¬t_time
);

1216 
out_’d
:

1217  
»t
;

1218 
	}
}

1220 
	$nvme_u£r_kv_cmd
(
nvme_ù¾
 *
ù¾
,

1221 
nvme_ns
 *
ns
,

1222 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

1224 
nvme_·s¡hru_kv_cmd
 
cmd
;

1225 
nvme_commªd
 
c
;

1226 
timeout
 = 0;

1227 
¡©us
;

1228 
__u£r
 *
m‘ad©a
 = 
NULL
;

1229 
m‘a_Ën
 = 0;

1230 
İtiÚ
 = 0;

1231 
™”_hªdË
 = 0;

1232 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1233  -
EACCES
;

1234 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1235  -
EFAULT
;

1236 ià(
cmd
.
æags
)

1237  -
EINVAL
;

1241 ià(!
	`is_kv_cmd
(
cmd
.
İcode
)) {

1242  -
EINVAL
;

1244 
	`mem£t
(&
c
, 0, (c));

1245 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1246 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1247 #ifdeà
KSID_SUPPORT


1248 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

1250 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1252 ià(
cmd
.
timeout_ms
)

1253 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1260 
cmd
.
İcode
) {

1261 
nvme_cmd_kv_¡Üe
:

1262 
nvme_cmd_kv_­³nd
:

1263 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1264 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1266 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1267 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1268 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1269 
¡©us
 = -
EINVAL
;

1270 
ex™
;

1272 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1273 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

1275 ià(
cmd
.
d©a_Ëngth
 % 4) {

1276 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

1277 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

1279 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1281 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1282 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1283 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1285 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1288 
nvme_cmd_kv_»Œ›ve
:

1289 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1290 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1292 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1293 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1294 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1295 
¡©us
 = -
EINVAL
;

1296 
ex™
;

1298 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1299 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

1300 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1302 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1303 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1304 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1306 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1309 ià(
aio
 && 
	`off£t_š_·ge
(
cmd
.
d©a_addr
)) {

1311 
¡©us
 = -
EINVAL
;

1312 
ex™
;

1316 
nvme_cmd_kv_d–‘e
:

1317 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1318 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1319 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1320 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1321 
¡©us
 = -
EINVAL
;

1322 
ex™
;

1324 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1325 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

1326 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1327 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1328 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1330 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1333 
nvme_cmd_kv_exi¡
:

1334 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1335 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1336 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1337 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1338 
¡©us
 = -
EINVAL
;

1339 
ex™
;

1341 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1342 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

1343 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1344 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1345 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1347 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1351 
nvme_cmd_kv_™”_»q
:

1352 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1353 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1354 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

1355 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

1356 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1357 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1359 
nvme_cmd_kv_™”_»ad
:

1360 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1361 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1362 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

1363 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

1364 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1367 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

1368 
¡©us
 = -
EINVAL
;

1369 
ex™
;

1378 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
, &
cmd
,

1379 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
, 0,

1380 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

1381 
ex™
:

1382 ià(!
aio
) {

1383 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1384  -
EFAULT
;

1385 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

1386  -
EFAULT
;

1388  
¡©us
;

1390 
	}
}

1392 
	$nvme_u£r_kv_aio_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1393 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
)

1395  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, 
ucmd
, 
Œue
);

1396 
	}
}

1406 
	$__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1407 
__u£r
 *
ubufãr
, 
bufæ’
,

1408 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1409 
u32
 *
»suÉ
, 
timeout
)

1411 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
(
cmd
);

1412 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1413 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1414 
»que¡
 *
»q
;

1415 
bio
 *biØğ
NULL
;

1416 *
m‘a
 = 
NULL
;

1417 
»t
;

1419 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1420 ià(
	`IS_ERR
(
»q
))

1421  
	`PTR_ERR
(
»q
);

1423 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1425 ià(
ubufãr
 && 
bufæ’
) {

1426 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
, 
__GFP_WAIT
);

1427 ià(
»t
)

1428 
out
;

1429 
bio
 = 
»q
->bio;

1431 ià(!
disk
)

1432 
subm™
;

1433 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

1434 ià(!
bio
->
bi_bdev
) {

1435 
»t
 = -
ENODEV
;

1436 
out_unm­
;

1439 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1440 
bio_š‹gr™y_·ylßd
 *
b
;

1442 
m‘a
 = 
	`km®loc
(
m‘a_Ën
, 
GFP_KERNEL
);

1443 ià(!
m‘a
) {

1444 
»t
 = -
ENOMEM
;

1445 
out_unm­
;

1448 ià(
wr™e
) {

1449 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
,

1450 
m‘a_Ën
)) {

1451 
»t
 = -
EFAULT
;

1452 
out_ä“_m‘a
;

1456 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

1457 ià(!
b
) {

1458 
»t
 = -
ENOMEM
;

1459 
out_ä“_m‘a
;

1462 
b
->
b_size
 = 
m‘a_Ën
;

1463 
b
->
b_£ùÜ
 = 
m‘a_£ed
;

1465 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
m‘a
),

1466 
m‘a_Ën
, 
	`off£t_š_·ge
(
m‘a
));

1467 ià(
»t
 !ğ
m‘a_Ën
) {

1468 
»t
 = -
ENOMEM
;

1469 
out_ä“_m‘a
;

1473 
subm™
:

1474 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1475 
»t
 = 
»q
->
”rÜs
;

1476 ià(
»suÉ
)

1477 *
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

1478 ià(
m‘a
 && !
»t
 && !
wr™e
) {

1479 ià(
	`cİy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

1480 
»t
 = -
EFAULT
;

1482 
out_ä“_m‘a
:

1483 
	`kä“
(
m‘a
);

1484 
out_unm­
:

1485 ià(
bio
) {

1486 ià(
disk
 && 
bio
->
bi_bdev
)

1487 
	`bdput
(
bio
->
bi_bdev
);

1488 
	`blk_rq_unm­_u£r
(
bio
);

1490 
out
:

1491 
	`blk_mq_ä“_»que¡
(
»q
);

1492  
»t
;

1493 
	}
}

1495 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1496 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

1497 
timeout
)

1499  
	`__nvme_subm™_u£r_cmd
(
q
, 
cmd
, 
ubufãr
, 
bufæ’
, 
NULL
, 0, 0,

1500 
»suÉ
, 
timeout
);

1501 
	}
}

1503 
	$nvme_k“p_®ive_’d_io
(
»que¡
 *
rq
, 
”rÜ
)

1505 
nvme_ù¾
 *
ù¾
 = 
rq
->
’d_io_d©a
;

1507 
	`blk_mq_ä“_»que¡
(
rq
);

1509 ià(
”rÜ
) {

1510 
	`dev_”r
(
ù¾
->
deviû
,

1511 "çed‚vme_k“p_®ive_’d_iØ”rÜ=%d\n", 
”rÜ
);

1515 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1516 
	}
}

1518 
	$nvme_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1520 
nvme_commªd
 
c
;

1521 
»que¡
 *
rq
;

1523 
	`mem£t
(&
c
, 0, (c));

1524 
c
.
commÚ
.
İcode
 = 
nvme_admš_k“p_®ive
;

1526 
rq
 = 
	`nvme_®loc_»que¡
(
ù¾
->
admš_q
, &
c
, 
BLK_MQ_REQ_RESERVED
,

1527 
NVME_QID_ANY
);

1528 ià(
	`IS_ERR
(
rq
))

1529  
	`PTR_ERR
(
rq
);

1531 
rq
->
timeout
 = 
ù¾
->
k©o
 * 
HZ
;

1532 
rq
->
’d_io_d©a
 = 
ù¾
;

1534 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q, 0, 
nvme_k“p_®ive_’d_io
);

1537 
	}
}

1539 
	$nvme_k“p_®ive_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1541 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

1542 
nvme_ù¾
, 
ka_wÜk
);

1544 ià(
	`nvme_k“p_®ive
(
ù¾
)) {

1546 
	`dev_”r
(
ù¾
->
deviû
, "keep-alive failed\n");

1547 
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

1550 
	}
}

1552 
	$nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1554 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1557 
	`INIT_DELAYED_WORK
(&
ù¾
->
ka_wÜk
, 
nvme_k“p_®ive_wÜk
);

1558 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1559 
	}
}

1560 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_k“p_®ive
);

1562 
	$nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1564 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1567 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
ka_wÜk
);

1568 
	}
}

1569 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_k“p_®ive
);

1571 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1573 
nvme_commªd
 
c
 = {

1574 .
id’tify
.
İcode
 = 
nvme_admš_id’tify
,

1575 .
id’tify
.
ús
 = 
	`ıu_to_Ë32
(
NVME_ID_CNS_CTRL
),

1577 
”rÜ
;

1579 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1580 ià(!*
id
)

1581  -
ENOMEM
;

1583 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1584 (
nvme_id_ù¾
));

1585 ià(
”rÜ
)

1586 
	`kä“
(*
id
);

1587  
”rÜ
;

1588 
	}
}

1590 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1592 
nvme_commªd
 
c
 = { };

1594 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1595 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(
NVME_ID_CNS_NS_ACTIVE_LIST
);

1596 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1597  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
, 0x1000);

1598 
	}
}

1600 
	$nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

1601 
nvme_id_ns
 **
id
)

1603 
nvme_commªd
 
c
 = {

1604 .
id’tify
.
İcode
 = 
nvme_admš_id’tify
,

1605 .
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid),

1607 
”rÜ
;

1609 *
id
 = 
	`km®loc
((
nvme_id_ns
), 
GFP_KERNEL
);

1610 ià(!*
id
)

1611  -
ENOMEM
;

1613 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1614 (
nvme_id_ns
));

1615 ià(
”rÜ
)

1616 
	`kä“
(*
id
);

1617  
”rÜ
;

1618 
	}
}

1620 
	$nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

1621 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1623 
nvme_commªd
 
c
;

1624 
nvme_»suÉ
 
»s
;

1625 
»t
;

1627 
	`mem£t
(&
c
, 0, (c));

1628 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_g‘_ã©u»s
;

1629 
c
.
ã©u»s
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1630 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1632 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
»s
, 
bufãr
, 
buæ’
, 0,

1633 
NVME_QID_ANY
, 0, 0);

1634 ià(
»t
 >ğ0 && 
»suÉ
)

1635 *
»suÉ
 = 
	`Ë32_to_ıu
(
»s
.
u32
);

1636  
»t
;

1637 
	}
}

1639 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1640 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1642 
nvme_commªd
 
c
;

1643 
nvme_»suÉ
 
»s
;

1644 
»t
;

1646 
	`mem£t
(&
c
, 0, (c));

1647 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1648 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1649 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1651 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
»s
,

1652 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 0);

1653 ià(
»t
 >ğ0 && 
»suÉ
)

1654 *
»suÉ
 = 
	`Ë32_to_ıu
(
»s
.
u32
);

1655  
»t
;

1656 
	}
}

1658 
	$nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
)

1660 
nvme_commªd
 
c
 = {

1661 .
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
,

1662 .
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF),

1663 .
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(

1664 ((((
nvme_sm¬t_log
) / 4) - 1) << 16) |

1665 
NVME_LOG_SMART
),

1667 
”rÜ
;

1669 *
log
 = 
	`km®loc
((
nvme_sm¬t_log
), 
GFP_KERNEL
);

1670 ià(!*
log
)

1671  -
ENOMEM
;

1673 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
log
,

1674 (
nvme_sm¬t_log
));

1675 ià(
”rÜ
)

1676 
	`kä“
(*
log
);

1677  
”rÜ
;

1678 
	}
}

1680 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1682 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1683 
u32
 
»suÉ
;

1684 
¡©us
, 
Ä_io_queues
;

1686 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 
NULL
, 0,

1687 &
»suÉ
);

1688 ià(
¡©us
 < 0)

1689  
¡©us
;

1696 ià(
¡©us
 > 0) {

1697 
	`dev_”r
(
ù¾
->
dev
, "Could‚Ù s‘ queucouÁ (%d)\n", 
¡©us
);

1698 *
couÁ
 = 0;

1700 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

1701 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

1705 
	}
}

1706 
EXPORT_SYMBOL_GPL
(
nvme_£t_queue_couÁ
);

1708 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1710 
nvme_u£r_io
 
io
;

1711 
nvme_commªd
 
c
;

1712 
Ëngth
, 
m‘a_Ën
;

1713 
__u£r
 *
m‘ad©a
;

1715 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

1716  -
EFAULT
;

1717 ià(
io
.
æags
)

1718  -
EINVAL
;

1720 
io
.
İcode
) {

1721 
nvme_cmd_wr™e
:

1722 
nvme_cmd_»ad
:

1723 
nvme_cmd_com·»
:

1726  -
EINVAL
;

1729 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1730 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1731 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

1733 ià(
ns
->
ext
) {

1734 
Ëngth
 +ğ
m‘a_Ën
;

1735 
m‘a_Ën
 = 0;

1736 } ià(
m‘a_Ën
) {

1737 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

1738  -
EINVAL
;

1741 
	`mem£t
(&
c
, 0, (c));

1742 
c
.
rw
.
İcode
 = 
io
.opcode;

1743 
c
.
rw
.
æags
 = 
io
.flags;

1744 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1745 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

1746 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

1747 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

1748 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

1749 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

1750 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

1751 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

1753  
	`__nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1754 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

1755 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

1756 
	}
}

1758 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1759 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

1761 
nvme_·s¡hru_cmd
 
cmd
;

1762 
nvme_commªd
 
c
;

1763 
timeout
 = 0;

1764 
¡©us
;

1766 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1767  -
EACCES
;

1768 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1769  -
EFAULT
;

1770 ià(
cmd
.
æags
)

1771  -
EINVAL
;

1773 ià(
	`is_kv_cmd
(
cmd
.
İcode
))

1774  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, (
nvme_·s¡hru_kv_cmd
 
__u£r
 *)
ucmd
, 
çl£
);

1777 
	`mem£t
(&
c
, 0, (c));

1778 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1779 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1780 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1781 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

1782 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

1783 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

1784 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

1785 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1786 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1787 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

1788 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

1790 ià(
cmd
.
timeout_ms
)

1791 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1793 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

1794 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

1795 &
cmd
.
»suÉ
, 
timeout
);

1796 ià(
¡©us
 >= 0) {

1797 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1798  -
EFAULT
;

1801  
¡©us
;

1802 
	}
}

1804 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
, 
cmd
,

1805 
¬g
)

1807 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1809 
cmd
) {

1810 
NVME_IOCTL_ID
:

1811 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

1812  
ns
->
ns_id
;

1813 
NVME_IOCTL_ADMIN_CMD
:

1814  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

1815 
NVME_IOCTL_IO_CMD
:

1816  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1817 
NVME_IOCTL_SUBMIT_IO
:

1818  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

1819 #ifdeà
CONFIG_BLK_DEV_NVME_SCSI


1820 
SG_GET_VERSION_NUM
:

1821  
	`nvme_sg_g‘_v”siÚ_num
((
__u£r
 *)
¬g
);

1822 
SG_IO
:

1823  
	`nvme_sg_io
(
ns
, (
__u£r
 *)
¬g
);

1826 
NVME_IOCTL_IO_KV_CMD
:

1827  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
çl£
);

1828 
NVME_IOCTL_AIO_CMD
:

1829  
	`nvme_u£r_kv_aio_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1830 
NVME_IOCTL_SET_AIOCTX
:

1831  
	`nvme_£t_aioùx
((
__u£r
*)
¬g
);

1832 
NVME_IOCTL_DEL_AIOCTX
:

1833  
	`nvme_d–_aioùx
((
__u£r
*)
¬g
);

1834 
NVME_IOCTL_GET_AIOEVENT
:

1835  
	`nvme_g‘_iÛv’ts
((
__u£r
*)
¬g
);

1839  -
ENOTTY
;

1841 
	}
}

1843 #ifdeà
CONFIG_COMPAT


1844 
	$nvme_com·t_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1845 
cmd
, 
¬g
)

1847 
cmd
) {

1848 
SG_IO
:

1849  -
ENOIOCTLCMD
;

1851  
	`nvme_ioùl
(
bdev
, 
mode
, 
cmd
, 
¬g
);

1852 
	}
}

1854 
	#nvme_com·t_ioùl
 
NULL


	)

1857 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

1859  
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
è? 0 : -
ENXIO
;

1860 
	}
}

1862 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

1864 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1866 
	`moduË_put
(
ns
->
ù¾
->
İs
->
moduË
);

1867 
	`nvme_put_ns
(
ns
);

1868 
	}
}

1870 
	$nvme_g‘geo
(
block_deviû
 *
bd
, 
hd_geom‘ry
 *
geo
)

1873 
geo
->
h—ds
 = 1 << 6;

1874 
geo
->
£ùÜs
 = 1 << 5;

1875 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bd
->
bd_disk
) >> 11;

1877 
	}
}

1879 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


1880 
	$nvme_noİ_v”ify
(
blk_š‹gr™y_exchg
 *
exg
)

1883 
	}
}

1885 
	$nvme_noİ_g’”©e
(
blk_š‹gr™y_exchg
 *
exg
)

1887 
	}
}

1889 
blk_š‹gr™y
 
	gnvme_m‘a_noİ
 = {

1890 .
Çme
 = "NVME_META_NOOP",

1891 .
	gg’”©e_â
 = 
nvme_noİ_g’”©e
,

1892 .
	gv”ify_â
 = 
nvme_noİ_v”ify
,

1894 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1896 
nvme_m‘a_noİ
.
tu¶e_size
 = 
ns
->
ms
;

1897 
	`blk_š‹gr™y_»gi¡”
(
ns
->
disk
, &
nvme_m‘a_noİ
);

1898 
	`blk_queue_max_š‹gr™y_£gm’ts
(
ns
->
queue
, 1);

1899 
	}
}

1901 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1903 
	}
}

1906 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

1908 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1909 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

1911 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DISCARD_ZEROES
)

1912 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 1;

1914 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

1916 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

1917 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

1918 
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
 = 0xffffffff;

1919 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

1920 
	}
}

1922 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

1924 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1925 
nvme_id_ns
 *
id
;

1926 
u8
 
lbaf
;

1927 
u16
 
Şd_ms
;

1928 
bs
;

1930 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

1931 
	`£t_ÿ·c™y
(
disk
, 0);

1932  -
ENODEV
;

1934 ià(
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id
)) {

1935 
	`dev_w¬n
(
	`disk_to_dev
(
ns
->
disk
), "%s: Identify failure\n",

1936 
__func__
);

1937  -
ENODEV
;

1939 ià(
id
->
nÿp
 == 0) {

1940 
	`kä“
(
id
);

1941  -
ENODEV
;

1944 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

1945 
	`memıy
(
ns
->
eui
, 
id
->
eui64
, (ns->eui));

1946 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 0))

1947 
	`memıy
(
ns
->
uuid
, 
id
->
nguid
, (ns->uuid));

1949 
Şd_ms
 = 
ns
->
ms
;

1950 
lbaf
 = 
id
->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
;

1951 
ns
->
lba_shiá
 = 
id
->
lbaf
[lbaf].
ds
;

1952 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[lbaf].ms);

1953 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

1959 ià(
ns
->
lba_shiá
 == 0)

1960 
ns
->
lba_shiá
 = 9;

1961 
bs
 = 1 << 
ns
->
lba_shiá
;

1963 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

1964 ià(
	`blk_g‘_š‹gr™y
(
disk
è&& (
ns
->
ms
 !ğ
Şd_ms
 ||

1965 
bs
 !ğ
	`queue_logiÿl_block_size
(
disk
->
queue
) ||

1966 (
ns
->
ms
 &&‚s->
ext
)))

1967 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

1969 
ns
->
pi_ty³
 =‚s->
ms
 =ğ8 ? 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
 : 0;

1970 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 
bs
);

1972 ià(
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
è&& (disk->
æags
 & 
GENHD_FL_UP
) &&

1973 !
ns
->
ext
)

1974 
	`nvme_š™_š‹gr™y
(
ns
);

1976 ià(
ns
->
ms
 && !Òs->m =ğ8 &&‚s->
pi_ty³
è&& !
	`blk_g‘_š‹gr™y
(
disk
))

1977 
	`£t_ÿ·c™y
(
disk
, 0);

1979 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

1981 ià(
ns
->
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

1982 
	`nvme_cÚfig_disÿrd
(
ns
);

1983 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

1985 
	`kä“
(
id
);

1987 
	}
}

1989 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

1991 
ty³
) {

1992 
PR_WRITE_EXCLUSIVE
:

1994 
PR_EXCLUSIVE_ACCESS
:

1996 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

1998 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

2000 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

2002 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

2007 
	}
};

2009 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

2010 
u64
 
key
, u64 
§_key
, 
u8
 
İ
)

2012 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2013 
nvme_commªd
 
c
;

2014 
u8
 
d©a
[16] = { 0, };

2016 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

2017 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

2019 
	`mem£t
(&
c
, 0, (c));

2020 
c
.
commÚ
.
İcode
 = 
İ
;

2021 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2022 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

2024  
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

2025 
	}
}

2027 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Şd
,

2028 
u64
 
Ãw
, 
æags
)

2030 
u32
 
cdw10
;

2032 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2033  -
EOPNOTSUPP
;

2035 
cdw10
 = 
Şd
 ? 2 : 0;

2036 
cdw10
 |ğ(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

2037 
cdw10
 |= (1 << 30) | (1 << 31);

2038  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

2039 
	}
}

2041 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

2042 
´_ty³
 
ty³
, 
æags
)

2044 
u32
 
cdw10
;

2046 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2047  -
EOPNOTSUPP
;

2049 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

2050 
cdw10
 |ğ((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

2051  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

2052 
	}
}

2054 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Şd
, u64 
Ãw
,

2055 
´_ty³
 
ty³
, 
boŞ
 
abÜt
)

2057 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
abÜt
 ? 2 : 1;

2058  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

2059 
	}
}

2061 
	$nvme_´_ş—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

2063 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

2064  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

2065 
	}
}

2067 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

2069 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
key
 ? 1 << 3 : 0;

2070  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

2071 
	}
}

2073 cÚ¡ 
´_İs
 
	gnvme_´_İs
 = {

2074 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

2075 .
	g´_»£rve
 = 
nvme_´_»£rve
,

2076 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

2077 .
	g´_´“m±
 = 
nvme_´_´“m±
,

2078 .
	g´_ş—r
 = 
nvme_´_ş—r
,

2081 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

2082 .
owÃr
 = 
THIS_MODULE
,

2083 .
	gioùl
 = 
nvme_ioùl
,

2084 .
	gcom·t_ioùl
 = 
nvme_com·t_ioùl
,

2085 .
	gİ’
 = 
nvme_İ’
,

2086 .
	g»Ëa£
 = 
nvme_»Ëa£
,

2087 .
	gg‘geo
 = 
nvme_g‘geo
,

2088 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

2089 .
	g´_İs
 = &
nvme_´_İs
,

2092 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

2094 
timeout
 =

2095 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

2096 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

2097 
»t
;

2099 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2100 ià(
c¡s
 == ~0)

2101  -
ENODEV
;

2102 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ğ
b™
)

2105 
	`m¦“p
(100);

2106 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2107  -
EINTR
;

2108 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2109 
	`dev_”r
(
ù¾
->
deviû
,

2110 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

2112  -
ENODEV
;

2116  
»t
;

2117 
	}
}

2125 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2127 
»t
;

2129 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2130 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

2132 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2133 ià(
»t
)

2134  
»t
;

2136 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

2137 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

2139  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

2140 
	}
}

2141 
EXPORT_SYMBOL_GPL
(
nvme_di§bË_ù¾
);

2143 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2150 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

2151 
»t
;

2153 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

2154 
	`dev_”r
(
ù¾
->
deviû
,

2156 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

2157  -
ENODEV
;

2160 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

2162 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

2163 
ù¾
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

2164 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

2165 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

2166 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

2168 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2169 ià(
»t
)

2170  
»t
;

2171  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

2172 
	}
}

2173 
EXPORT_SYMBOL_GPL
(
nvme_’abË_ù¾
);

2175 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

2177 
timeout
 = 
SHUTDOWN_TIMEOUT
 + 
jiff›s
;

2178 
u32
 
c¡s
;

2179 
»t
;

2181 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2182 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

2184 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2185 ià(
»t
)

2186  
»t
;

2188 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2189 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ğ
NVME_CSTS_SHST_CMPLT
)

2192 
	`m¦“p
(100);

2193 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2194  -
EINTR
;

2195 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2196 
	`dev_”r
(
ù¾
->
deviû
,

2198  -
ENODEV
;

2202  
»t
;

2203 
	}
}

2204 
EXPORT_SYMBOL_GPL
(
nvme_shutdown_ù¾
);

2206 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

2207 
»que¡_queue
 *
q
)

2209 ià(
ù¾
->
max_hw_£ùÜs
) {

2210 
u32
 
max_£gm’ts
 =

2211 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

2213 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2214 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

2216 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
)

2217 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2218 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2219 
	`blk_queue_æush
(
q
, 
REQ_FLUSH
 | 
REQ_FUA
);

2220 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

2221 
	}
}

2228 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

2230 
nvme_id_ù¾
 *
id
;

2231 
u64
 
ÿp
;

2232 
»t
, 
·ge_shiá
;

2233 
u32
 
max_hw_£ùÜs
;

2235 
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

2236 ià(
»t
) {

2237 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg VS faed (%d)\n", 
»t
);

2238  
»t
;

2241 
»t
 = 
ù¾
->
İs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

2242 ià(
»t
) {

2243 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg CAP faed (%d)\n", 
»t
);

2244  
»t
;

2246 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

2248 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

2249 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

2251 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

2252 ià(
»t
) {

2253 
	`dev_”r
(
ù¾
->
deviû
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»t
);

2254  -
EIO
;

2257 
ù¾
->
vid
 = 
	`Ë16_to_ıu
(
id
->vid);

2258 
ù¾
->
Úcs
 = 
	`Ë16_to_ıup
(&
id
->oncs);

2259 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aş
 + 1);

2260 
ù¾
->
vwc
 = 
id
->vwc;

2261 
ù¾
->
úid
 = 
	`Ë16_to_ıup
(&
id
->cntlid);

2262 
	`memıy
(
ù¾
->
£rŸl
, 
id
->
¢
, (id->sn));

2263 
	`memıy
(
ù¾
->
mod–
, 
id
->
mn
, (id->mn));

2264 
	`memıy
(
ù¾
->
fœmw¬e_»v
, 
id
->
ä
, (id->fr));

2265 ià(
id
->
mdts
)

2266 
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

2268 
max_hw_£ùÜs
 = 
UINT_MAX
;

2269 
ù¾
->
max_hw_£ùÜs
 =

2270 
	`mš_nÙ_z”o
(
ù¾
->
max_hw_£ùÜs
, max_hw_sectors);

2272 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

2273 
ù¾
->
sgls
 = 
	`Ë32_to_ıu
(
id
->sgls);

2274 
ù¾
->
kas
 = 
	`Ë16_to_ıu
(
id
->kas);

2276 ià(
ù¾
->
İs
->
is_çbrics
) {

2277 
ù¾
->
icdoff
 = 
	`Ë16_to_ıu
(
id
->icdoff);

2278 
ù¾
->
ioccsz
 = 
	`Ë32_to_ıu
(
id
->ioccsz);

2279 
ù¾
->
iÜcsz
 = 
	`Ë32_to_ıu
(
id
->iorcsz);

2280 
ù¾
->
maxcmd
 = 
	`Ë16_to_ıu
(
id
->maxcmd);

2286 ià(
ù¾
->
úid
 !ğ
	`Ë16_to_ıu
(
id
->cntlid))

2287 
»t
 = -
EINVAL
;

2289 ià(!
ù¾
->
İts
->
discov”y_nqn
 && !ù¾->
kas
) {

2290 
	`dev_”r
(
ù¾
->
dev
,

2292 
»t
 = -
EINVAL
;

2295 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
id
->cntlid);

2298 
	`kä“
(
id
);

2299  
»t
;

2300 
	}
}

2301 
EXPORT_SYMBOL_GPL
(
nvme_š™_id’tify
);

2303 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *file)

2305 
nvme_ù¾
 *
ù¾
;

2306 
š¡ªû
 = 
	`imšÜ
(
šode
);

2307 
»t
 = -
ENODEV
;

2309 
	`¥š_lock
(&
dev_li¡_lock
);

2310 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_ù¾_li¡
, 
node
) {

2311 ià(
ù¾
->
š¡ªû
 != instance)

2314 ià(!
ù¾
->
admš_q
) {

2315 
»t
 = -
EWOULDBLOCK
;

2318 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
k»f
))

2320 
fe
->
´iv©e_d©a
 = 
ù¾
;

2321 
»t
 = 0;

2324 
	`¥š_uÆock
(&
dev_li¡_lock
);

2326  
»t
;

2327 
	}
}

2329 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

2331 
	`nvme_put_ù¾
(
fe
->
´iv©e_d©a
);

2333 
	}
}

2335 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

2337 
nvme_ns
 *
ns
;

2338 
»t
;

2340 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2341 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

2342 
»t
 = -
ENOTTY
;

2343 
out_uÆock
;

2346 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

2347 ià(
ns
 !ğ
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

2348 
	`dev_w¬n
(
ù¾
->
deviû
,

2350 
»t
 = -
EINVAL
;

2351 
out_uÆock
;

2354 
	`dev_w¬n
(
ù¾
->
deviû
,

2356 
	`k»f_g‘
(&
ns
->
k»f
);

2357 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2359 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

2360 
	`nvme_put_ns
(
ns
);

2361  
»t
;

2363 
out_uÆock
:

2364 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2365  
»t
;

2366 
	}
}

2368 
	$nvme_dev_ioùl
(
fe
 *fe, 
cmd
,

2369 
¬g
)

2371 
nvme_ù¾
 *
ù¾
 = 
fe
->
´iv©e_d©a
;

2372 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

2374 
cmd
) {

2375 
NVME_IOCTL_ADMIN_CMD
:

2376  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

2377 
NVME_IOCTL_IO_CMD
:

2378  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

2379 
NVME_IOCTL_RESET
:

2380 
	`dev_w¬n
(
ù¾
->
deviû
, "resetting controller\n");

2381  
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2382 
NVME_IOCTL_SUBSYS_RESET
:

2383  
	`nvme_»£t_subsy¡em
(
ù¾
);

2384 
NVME_IOCTL_RESCAN
:

2385 
	`nvme_queue_sÿn
(
ù¾
);

2388  -
ENOTTY
;

2390 
	}
}

2392 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

2393 .
owÃr
 = 
THIS_MODULE
,

2394 .
	gİ’
 = 
nvme_dev_İ’
,

2395 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

2396 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

2397 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

2400 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

2401 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2402 
size_t
 
couÁ
)

2404 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2405 
»t
;

2407 
»t
 = 
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2408 ià(
»t
 < 0)

2409  
»t
;

2410  
couÁ
;

2411 
	}
}

2412 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

2414 
ssize_t
 
	$nvme_sysfs_»sÿn
(
deviû
 *
dev
,

2415 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2416 
size_t
 
couÁ
)

2418 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2420 
	`nvme_queue_sÿn
(
ù¾
);

2421  
couÁ
;

2422 
	}
}

2423 
DEVICE_ATTR
(
»sÿn_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»sÿn
);

2425 
ssize_t
 
	$wwid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2426 *
buf
)

2428 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2429 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

2430 
£rŸl_Ën
 = (
ù¾
->
£rŸl
);

2431 
mod–_Ën
 = (
ù¾
->
mod–
);

2433 ià(
	`memchr_šv
(
ns
->
uuid
, 0, (ns->uuid)))

2434  
	`¥rštf
(
buf
, "eui.%16phN\n", 
ns
->
uuid
);

2436 ià(
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

2437  
	`¥rštf
(
buf
, "eui.%8phN\n", 
ns
->
eui
);

2439 
ù¾
->
£rŸl
[
£rŸl_Ën
 - 1] == ' ')

2440 
£rŸl_Ën
--;

2441 
ù¾
->
mod–
[
mod–_Ën
 - 1] == ' ')

2442 
mod–_Ën
--;

2444  
	`¥rštf
(
buf
, "nvme.%04x-%*phN-%*phN-%08x\n", 
ù¾
->
vid
,

2445 
£rŸl_Ën
, 
ù¾
->
£rŸl
, 
mod–_Ën
, cŒl->
mod–
, 
ns
->
ns_id
);

2446 
	}
}

2447 
DEVICE_ATTR
(
wwid
, 
S_IRUGO
, 
wwid_show
, 
NULL
);

2449 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2450 *
buf
)

2452 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2453  
	`¥rštf
(
buf
, "%pU\n", 
ns
->
uuid
);

2454 
	}
}

2455 
DEVICE_ATTR
(
uuid
, 
S_IRUGO
, 
uuid_show
, 
NULL
);

2457 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2458 *
buf
)

2460 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2461  
	`¥rštf
(
buf
, "%8phd\n", 
ns
->
eui
);

2462 
	}
}

2463 
DEVICE_ATTR
(
eui
, 
S_IRUGO
, 
eui_show
, 
NULL
);

2465 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2466 *
buf
)

2468 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2469  
	`¥rštf
(
buf
, "%d\n", 
ns
->
ns_id
);

2470 
	}
}

2471 
DEVICE_ATTR
(
nsid
, 
S_IRUGO
, 
nsid_show
, 
NULL
);

2473 
©Œibu‹
 *
	gnvme_ns_©Œs
[] = {

2474 &
dev_©Œ_wwid
.
©Œ
,

2475 &
dev_©Œ_uuid
.
©Œ
,

2476 &
dev_©Œ_eui
.
©Œ
,

2477 &
dev_©Œ_nsid
.
©Œ
,

2478 
NULL
,

2481 
umode_t
 
	$nvme_ns_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2482 
©Œibu‹
 *
a
, 
n
)

2484 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2485 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2487 ià(
a
 =ğ&
dev_©Œ_uuid
.
©Œ
) {

2488 ià(!
	`memchr_šv
(
ns
->
uuid
, 0, (ns->uuid)))

2491 ià(
a
 =ğ&
dev_©Œ_eui
.
©Œ
) {

2492 ià(!
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

2495  
a
->
mode
;

2496 
	}
}

2498 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_©Œ_group
 = {

2499 .
©Œs
 = 
nvme_ns_©Œs
,

2500 .
	gis_visibË
 = 
nvme_ns_©Œs_¬e_visibË
,

2503 
	#nvme_show_¡r_funùiÚ
(
f›ld
) \

2504 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2505 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2507 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2508  
	`¥rštf
(
buf
, "%.*s\n", ()(
ù¾
->
f›ld
), ctrl->field); \

2510 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2512 
	#nvme_show_št_funùiÚ
(
f›ld
) \

2513 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2514 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2516 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2517  
	`¥rštf
(
buf
, "%d\n", 
ù¾
->
f›ld
); \

2519 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2521 
nvme_show_¡r_funùiÚ
(
mod–
);

2522 
nvme_show_¡r_funùiÚ
(
£rŸl
);

2523 
nvme_show_¡r_funùiÚ
(
fœmw¬e_»v
);

2524 
nvme_show_št_funùiÚ
(
úid
);

2526 
	$nvme_sysfs_¡Üe_d–‘e_ÿÎback
(
deviû
 *
dev
)

2528 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2530 
ù¾
->
İs
->
	`d–‘e_ù¾
(ctrl);

2531 
	}
}

2532 
ssize_t
 
	$nvme_sysfs_d–‘e
(
deviû
 *
dev
,

2533 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2534 
size_t
 
couÁ
)

2536 
rc
;

2538 
rc
 = 
	`deviû_scheduË_ÿÎback
(
dev
, 
nvme_sysfs_¡Üe_d–‘e_ÿÎback
);

2539 ià(
rc
)

2540 
couÁ
 = 
rc
;

2542  
couÁ
;

2543 
	}
}

2544 
DEVICE_ATTR
(
d–‘e_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_d–‘e
);

2546 
ssize_t
 
	$nvme_sysfs_show_Œª¥Üt
(
deviû
 *
dev
,

2547 
deviû_©Œibu‹
 *
©Œ
,

2548 *
buf
)

2550 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2552  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
İs
->
Çme
);

2553 
	}
}

2554 
DEVICE_ATTR
(
Œª¥Üt
, 
S_IRUGO
, 
nvme_sysfs_show_Œª¥Üt
, 
NULL
);

2556 
ssize_t
 
	$nvme_sysfs_show_subsy¢qn
(
deviû
 *
dev
,

2557 
deviû_©Œibu‹
 *
©Œ
,

2558 *
buf
)

2560 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2562  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n",

2563 
ù¾
->
İs
->
	`g‘_subsy¢qn
(ctrl));

2564 
	}
}

2565 
DEVICE_ATTR
(
subsy¢qn
, 
S_IRUGO
, 
nvme_sysfs_show_subsy¢qn
, 
NULL
);

2567 
ssize_t
 
	$nvme_sysfs_show_add»ss
(
deviû
 *
dev
,

2568 
deviû_©Œibu‹
 *
©Œ
,

2569 *
buf
)

2571 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2573  
ù¾
->
İs
->
	`g‘_add»ss
(ù¾, 
buf
, 
PAGE_SIZE
);

2574 
	}
}

2575 
DEVICE_ATTR
(
add»ss
, 
S_IRUGO
, 
nvme_sysfs_show_add»ss
, 
NULL
);

2577 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

2578 &
dev_©Œ_»£t_cÚŒŞËr
.
©Œ
,

2579 &
dev_©Œ_»sÿn_cÚŒŞËr
.
©Œ
,

2580 &
dev_©Œ_mod–
.
©Œ
,

2581 &
dev_©Œ_£rŸl
.
©Œ
,

2582 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

2583 &
dev_©Œ_úid
.
©Œ
,

2584 &
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
,

2585 &
dev_©Œ_Œª¥Üt
.
©Œ
,

2586 &
dev_©Œ_subsy¢qn
.
©Œ
,

2587 &
dev_©Œ_add»ss
.
©Œ
,

2588 
NULL


2591 
	#CHECK_ATTR
(
ù¾
, 
a
, 
Çme
) \

2592 ià((
a
è=ğ&
dev_©Œ_
##
Çme
.
©Œ
 && \

2593 !(
ù¾
)->
İs
->
g‘_
##
Çme
) \

2594  0

	)

2596 
umode_t
 
	$nvme_dev_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2597 
©Œibu‹
 *
a
, 
n
)

2599 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2600 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2602 ià(
a
 =ğ&
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
) {

2603 ià(!
ù¾
->
İs
->
d–‘e_ù¾
)

2607 
	`CHECK_ATTR
(
ù¾
, 
a
, 
subsy¢qn
);

2608 
	`CHECK_ATTR
(
ù¾
, 
a
, 
add»ss
);

2610  
a
->
mode
;

2611 
	}
}

2613 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

2614 .
©Œs
 = 
nvme_dev_©Œs
,

2615 .
	gis_visibË
 = 
nvme_dev_©Œs_¬e_visibË
,

2618 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

2619 &
nvme_dev_©Œs_group
,

2620 
NULL
,

2623 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

2625 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

2626 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

2628  
n§
->
ns_id
 - 
nsb
->ns_id;

2629 
	}
}

2631 
nvme_ns
 *
	$nvme_fšd_g‘_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2633 
nvme_ns
 *
ns
, *
»t
 = 
NULL
;

2635 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2636 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2637 ià(
ns
->
ns_id
 =ğ
nsid
) {

2638 
	`k»f_g‘
(&
ns
->
k»f
);

2639 
»t
 = 
ns
;

2642 ià(
ns
->
ns_id
 > 
nsid
)

2645 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2646  
»t
;

2647 
	}
}

2649 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2651 
nvme_ns
 *
ns
;

2652 
g’disk
 *
disk
;

2653 
node
 = 
	`dev_to_node
(
ù¾
->
dev
);

2655 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

2656 ià(!
ns
)

2659 
ns
->
š¡ªû
 = 
	`ida_sim¶e_g‘
(&
ù¾
->
ns_ida
, 1, 0, 
GFP_KERNEL
);

2660 ià(
ns
->
š¡ªû
 < 0)

2661 
out_ä“_ns
;

2663 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

2664 ià(
	`IS_ERR
(
ns
->
queue
))

2665 
out_»Ëa£_š¡ªû
;

2666 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

2667 
ns
->
queue
->
queued©a
 =‚s;

2668 
ns
->
ù¾
 = ctrl;

2670 
disk
 = 
	`®loc_disk_node
(0, 
node
);

2671 ià(!
disk
)

2672 
out_ä“_queue
;

2674 
	`k»f_š™
(&
ns
->
k»f
);

2675 
ns
->
ns_id
 = 
nsid
;

2676 
ns
->
disk
 = disk;

2677 
ns
->
lba_shiá
 = 9;

2680 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

2681 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

2683 
disk
->
fİs
 = &
nvme_fİs
;

2684 
disk
->
´iv©e_d©a
 = 
ns
;

2685 
disk
->
queue
 = 
ns
->queue;

2686 
disk
->
driv”fs_dev
 = 
ù¾
->
deviû
;

2687 
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

2688 
	`¥rštf
(
disk
->
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
ns
->instance);

2690 ià(
	`nvme_»v®id©e_disk
(
ns
->
disk
))

2691 
out_ä“_disk
;

2693 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2694 
	`li¡_add_
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

2695 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2697 
	`k»f_g‘
(&
ù¾
->
k»f
);

2699 
	`add_disk
(
ns
->
disk
);

2700 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2701 &
nvme_ns_©Œ_group
))

2702 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

2703 
ns
->
disk
->
disk_Çme
);

2705 
out_ä“_disk
:

2706 
	`kä“
(
disk
);

2707 
out_ä“_queue
:

2708 
	`blk_ş—nup_queue
(
ns
->
queue
);

2709 
out_»Ëa£_š¡ªû
:

2710 
	`ida_sim¶e_»move
(&
ù¾
->
ns_ida
, 
ns
->
š¡ªû
);

2711 
out_ä“_ns
:

2712 
	`kä“
(
ns
);

2713 
	}
}

2715 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

2717 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

2720 ià(
ns
->
disk
->
æags
 & 
GENHD_FL_UP
) {

2721 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

2722 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

2723 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2724 &
nvme_ns_©Œ_group
);

2725 
	`d–_g’disk
(
ns
->
disk
);

2726 
	`blk_ş—nup_queue
(
ns
->
queue
);

2729 
	`mu‹x_lock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2730 
	`li¡_d–_š™
(&
ns
->
li¡
);

2731 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2733 
	`nvme_put_ns
(
ns
);

2734 
	}
}

2736 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2738 
nvme_ns
 *
ns
;

2740 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
nsid
);

2741 ià(
ns
) {

2742 ià(
	`»v®id©e_disk
(
ns
->
disk
))

2743 
	`nvme_ns_»move
(
ns
);

2744 
	`nvme_put_ns
(
ns
);

2746 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

2747 
	}
}

2749 
	$nvme_»move_šv®id_Çme¥aûs
(
nvme_ù¾
 *
ù¾
,

2750 
nsid
)

2752 
nvme_ns
 *
ns
, *
Ãxt
;

2754 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2755 ià(
ns
->
ns_id
 > 
nsid
)

2756 
	`nvme_ns_»move
(
ns
);

2758 
	}
}

2760 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

2762 
nvme_ns
 *
ns
;

2763 
__Ë32
 *
ns_li¡
;

2764 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

2765 
»t
 = 0;

2767 
ns_li¡
 = 
	`kz®loc
(0x1000, 
GFP_KERNEL
);

2768 ià(!
ns_li¡
)

2769  -
ENOMEM
;

2771 
i
 = 0; i < 
num_li¡s
; i++) {

2772 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

2773 ià(
»t
)

2774 
ä“
;

2776 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

2777 
nsid
 = 
	`Ë32_to_ıu
(
ns_li¡
[
j
]);

2778 ià(!
nsid
)

2779 
out
;

2781 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

2783 ++
´ev
 < 
nsid
) {

2784 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
´ev
);

2785 ià(
ns
) {

2786 
	`nvme_ns_»move
(
ns
);

2787 
	`nvme_put_ns
(
ns
);

2791 
Â
 -ğ
j
;

2793 
out
:

2794 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
´ev
);

2795 
ä“
:

2796 
	`kä“
(
ns_li¡
);

2797  
»t
;

2798 
	}
}

2800 
	$nvme_sÿn_ns_£qu’tŸl
(
nvme_ù¾
 *
ù¾
, 
Â
)

2802 
i
;

2804 
i
 = 1; i <ğ
Â
; i++)

2805 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

2807 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
Â
);

2808 
	}
}

2810 
	$nvme_sÿn_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2812 
nvme_ù¾
 *
ù¾
 =

2813 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
sÿn_wÜk
);

2814 
nvme_id_ù¾
 *
id
;

2815 
Â
;

2817 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
)

2820 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

2823 
Â
 = 
	`Ë32_to_ıu
(
id
->nn);

2824 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0) &&

2825 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

2826 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

2827 
dÚe
;

2829 
	`nvme_sÿn_ns_£qu’tŸl
(
ù¾
, 
Â
);

2830 
dÚe
:

2831 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2832 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

2833 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2834 
	`kä“
(
id
);

2836 ià(
ù¾
->
İs
->
po¡_sÿn
)

2837 
ù¾
->
İs
->
	`po¡_sÿn
(ctrl);

2838 
	}
}

2840 
	$nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
)

2846 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
)

2847 
	`scheduË_wÜk
(&
ù¾
->
sÿn_wÜk
);

2848 
	}
}

2849 
EXPORT_SYMBOL_GPL
(
nvme_queue_sÿn
);

2856 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

2858 
nvme_ns
 *
ns
, *
Ãxt
;

2866 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_DEAD
)

2867 
	`nvme_kl_queues
(
ù¾
);

2869 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
)

2870 
	`nvme_ns_»move
(
ns
);

2871 
	}
}

2872 
EXPORT_SYMBOL_GPL
(
nvme_»move_Çme¥aûs
);

2874 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2876 
nvme_ù¾
 *
ù¾
 =

2877 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
async_ev’t_wÜk
);

2879 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2880 
ù¾
->
ev’t_lim™
 > 0) {

2881 
«r_idx
 = --
ù¾
->
ev’t_lim™
;

2883 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2884 
ù¾
->
İs
->
	`subm™_async_ev’t
(ù¾, 
«r_idx
);

2885 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2887 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2888 
	}
}

2890 
	$nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

2891 
nvme_»suÉ
 *
»s
)

2893 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
»s
->u32);

2894 
boŞ
 
dÚe
 = 
Œue
;

2896 
	`Ë16_to_ıu
(
¡©us
) >> 1) {

2897 
NVME_SC_SUCCESS
:

2898 
dÚe
 = 
çl£
;

2900 
NVME_SC_ABORT_REQ
:

2901 ++
ù¾
->
ev’t_lim™
;

2902 
	`scheduË_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

2908 ià(
dÚe
)

2911 
»suÉ
 & 0xff07) {

2912 
NVME_AER_NOTICE_NS_CHANGED
:

2913 
	`dev_šfo
(
ù¾
->
deviû
, "rescanning\n");

2914 
	`nvme_queue_sÿn
(
ù¾
);

2917 
	`dev_w¬n
(
ù¾
->
deviû
, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

2919 
	}
}

2920 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_async_ev’t
);

2922 
	$nvme_queue_async_ev’ts
(
nvme_ù¾
 *
ù¾
)

2924 
ù¾
->
ev’t_lim™
 = 
NVME_NR_AERS
;

2925 
	`scheduË_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

2926 
	}
}

2927 
EXPORT_SYMBOL_GPL
(
nvme_queue_async_ev’ts
);

2929 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

2931 
	$nvme_£t_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2933 
š¡ªû
, 
”rÜ
;

2936 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

2937  -
ENODEV
;

2939 
	`¥š_lock
(&
dev_li¡_lock
);

2940 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

2941 
	`¥š_uÆock
(&
dev_li¡_lock
);

2942 } 
”rÜ
 =ğ-
EAGAIN
);

2944 ià(
”rÜ
)

2945  -
ENODEV
;

2947 
ù¾
->
š¡ªû
 = instance;

2949 
	}
}

2951 
	$nvme_»Ëa£_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2953 
	`¥š_lock
(&
dev_li¡_lock
);

2954 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

2955 
	`¥š_uÆock
(&
dev_li¡_lock
);

2956 
	}
}

2958 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

2960 
	`æush_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

2961 
	`æush_wÜk
(&
ù¾
->
sÿn_wÜk
);

2962 
	`nvme_»move_Çme¥aûs
(
ù¾
);

2964 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
));

2966 
	`¥š_lock
(&
dev_li¡_lock
);

2967 
	`li¡_d–
(&
ù¾
->
node
);

2968 
	`¥š_uÆock
(&
dev_li¡_lock
);

2969 
	}
}

2970 
EXPORT_SYMBOL_GPL
(
nvme_unš™_ù¾
);

2972 
	$nvme_ä“_ù¾
(
k»f
 *kref)

2974 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
k»f
, nvme_ctrl, kref);

2976 
	`put_deviû
(
ù¾
->
deviû
);

2977 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

2978 
	`ida_de¡roy
(&
ù¾
->
ns_ida
);

2980 
ù¾
->
İs
->
	`ä“_ù¾
(ctrl);

2981 
	}
}

2983 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

2985 
	`k»f_put
(&
ù¾
->
k»f
, 
nvme_ä“_ù¾
);

2986 
	}
}

2987 
EXPORT_SYMBOL_GPL
(
nvme_put_ù¾
);

2994 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

2995 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
)

2997 
»t
;

2999 
ù¾
->
¡©e
 = 
NVME_CTRL_NEW
;

3000 
	`¥š_lock_š™
(&
ù¾
->
lock
);

3001 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

3002 
	`mu‹x_š™
(&
ù¾
->
Çme¥aûs_mu‹x
);

3003 
	`k»f_š™
(&
ù¾
->
k»f
);

3004 
ù¾
->
dev
 = dev;

3005 
ù¾
->
İs
 = ops;

3006 
ù¾
->
quœks
 = quirks;

3007 
	`INIT_WORK
(&
ù¾
->
sÿn_wÜk
, 
nvme_sÿn_wÜk
);

3008 
	`INIT_WORK
(&
ù¾
->
async_ev’t_wÜk
, 
nvme_async_ev’t_wÜk
);

3010 
»t
 = 
	`nvme_£t_š¡ªû
(
ù¾
);

3011 ià(
»t
)

3012 
out
;

3014 
ù¾
->
deviû
 = 
	`deviû_ü—‹_w™h_groups
(
nvme_şass
, cŒl->
dev
,

3015 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
),

3016 
ù¾
, 
nvme_dev_©Œ_groups
,

3017 "nvme%d", 
ù¾
->
š¡ªû
);

3018 ià(
	`IS_ERR
(
ù¾
->
deviû
)) {

3019 
»t
 = 
	`PTR_ERR
(
ù¾
->
deviû
);

3020 
out_»Ëa£_š¡ªû
;

3022 
	`g‘_deviû
(
ù¾
->
deviû
);

3023 
	`ida_š™
(&
ù¾
->
ns_ida
);

3025 
	`¥š_lock
(&
dev_li¡_lock
);

3026 
	`li¡_add_
(&
ù¾
->
node
, &
nvme_ù¾_li¡
);

3027 
	`¥š_uÆock
(&
dev_li¡_lock
);

3030 
out_»Ëa£_š¡ªû
:

3031 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

3032 
out
:

3033  
»t
;

3034 
	}
}

3035 
EXPORT_SYMBOL_GPL
(
nvme_š™_ù¾
);

3044 
	$nvme_kl_queues
(
nvme_ù¾
 *
ù¾
)

3046 
nvme_ns
 *
ns
;

3048 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3049 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3054 ià(!
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &
ns
->
æags
))

3055 
	`»v®id©e_disk
(
ns
->
disk
);

3057 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

3064 
	`blk_mq_¡¬t_hw_queues
(
ns
->
queue
);

3067 
	`blk_mq_kick_»queue_li¡
(
ns
->
queue
);

3069 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3070 
	}
}

3071 
EXPORT_SYMBOL_GPL
(
nvme_kl_queues
);

3073 
	$nvme_unä“ze
(
nvme_ù¾
 *
ù¾
)

3075 
nvme_ns
 *
ns
;

3077 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3078 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3079 
	`blk_mq_unä“ze_queue
(
ns
->
queue
);

3080 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3081 
	}
}

3082 
EXPORT_SYMBOL_GPL
(
nvme_unä“ze
);

3084 
	$nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
)

3086 
nvme_ns
 *
ns
;

3088 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3089 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3090 
timeout
 = 
	`blk_mq_ä“ze_queue_wa™_timeout
(
ns
->
queue
,imeout);

3091 ià(
timeout
 <= 0)

3094 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3095 
	}
}

3096 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze_timeout
);

3098 
	$nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
)

3100 
nvme_ns
 *
ns
;

3102 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3103 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3104 
	`blk_mq_ä“ze_queue_wa™
(
ns
->
queue
);

3105 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3106 
	}
}

3107 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze
);

3109 
	$nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
)

3111 
nvme_ns
 *
ns
;

3113 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3114 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3115 
	`blk_ä“ze_queue_¡¬t
(
ns
->
queue
);

3116 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3117 
	}
}

3118 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ä“ze
);

3120 
	$nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
)

3122 
nvme_ns
 *
ns
;

3124 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3125 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3126 
	`¥š_lock_œq
(
ns
->
queue
->
queue_lock
);

3127 
	`queue_æag_£t
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

3128 
	`¥š_uÆock_œq
(
ns
->
queue
->
queue_lock
);

3130 
	`blk_mq_¡İ_hw_queues
(
ns
->
queue
);

3132 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3133 
	}
}

3134 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_queues
);

3136 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

3138 
nvme_ns
 *
ns
;

3140 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3141 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3142 
	`queue_æag_ş—r_uÆocked
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

3143 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

3144 
	`blk_mq_kick_»queue_li¡
(
ns
->
queue
);

3146 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3147 
	}
}

3148 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_queues
);

3150 
__š™
 
	$nvme_cÜe_š™
()

3152 
»suÉ
;

3154 
»suÉ
 = 
	`__»gi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme",

3155 &
nvme_dev_fİs
);

3156 ià(
»suÉ
 < 0)

3157  
»suÉ
;

3158 ià(
»suÉ
 > 0)

3159 
nvme_ch¬_majÜ
 = 
»suÉ
;

3161 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

3162 ià(
	`IS_ERR
(
nvme_şass
)) {

3163 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

3164 
uÄegi¡”_chrdev
;

3167 
»suÉ
 = 
	`aio_£rviû_š™
();

3168 ià(
»suÉ
)

3169 
uÄegi¡”_chrdev
;

3171 
»suÉ
 = 
	`aio_wÜk”_š™
();

3172 ià(
»suÉ
)

3173 
uÄegi¡”_aio_£rviû
;

3178 
uÄegi¡”_aio_£rviû
:

3179 
	`aio_£rviû_ex™
();

3181 
uÄegi¡”_chrdev
:

3182 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

3183  
»suÉ
;

3184 
	}
}

3186 
	$nvme_cÜe_ex™
()

3188 
	`şass_de¡roy
(
nvme_şass
);

3189 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

3191 
	`aio_wÜk”_ex™
();

3192 
	`aio_£rviû_ex™
();

3194 
	}
}

3196 
MODULE_LICENSE
("GPL");

3197 
MODULE_VERSION
("1.0");

3198 
moduË_š™
(
nvme_cÜe_š™
);

3199 
moduË_ex™
(
nvme_cÜe_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/fabrics.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/š™.h
>

16 
	~<lšux/miscdeviû.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/mu‹x.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~"nvme.h
"

22 
	~"çbrics.h
"

24 
LIST_HEAD
(
nvmf_Œª¥Üts
);

25 
DEFINE_MUTEX
(
nvmf_Œª¥Üts_mu‹x
);

27 
LIST_HEAD
(
nvmf_ho¡s
);

28 
DEFINE_MUTEX
(
nvmf_ho¡s_mu‹x
);

30 
nvmf_ho¡
 *
	gnvmf_deçuÉ_ho¡
;

32 
nvmf_ho¡
 *
	$__nvmf_ho¡_fšd
(cÚ¡ *
ho¡nqn
)

34 
nvmf_ho¡
 *
ho¡
;

36 
	`li¡_fÜ_—ch_’Œy
(
ho¡
, &
nvmf_ho¡s
, 
li¡
) {

37 ià(!
	`¡rcmp
(
ho¡
->
nqn
, 
ho¡nqn
))

38  
ho¡
;

41  
NULL
;

42 
	}
}

44 
nvmf_ho¡
 *
	$nvmf_ho¡_add
(cÚ¡ *
ho¡nqn
)

46 
nvmf_ho¡
 *
ho¡
;

48 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

49 
ho¡
 = 
	`__nvmf_ho¡_fšd
(
ho¡nqn
);

50 ià(
ho¡
) {

51 
	`k»f_g‘
(&
ho¡
->
»f
);

52 
out_uÆock
;

55 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

56 ià(!
ho¡
)

57 
out_uÆock
;

59 
	`k»f_š™
(&
ho¡
->
»f
);

60 
	`memıy
(
ho¡
->
nqn
, 
ho¡nqn
, 
NVMF_NQN_SIZE
);

61 
	`uuid_be_g’
(&
ho¡
->
id
);

63 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

64 
out_uÆock
:

65 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

66  
ho¡
;

67 
	}
}

69 
nvmf_ho¡
 *
	$nvmf_ho¡_deçuÉ
()

71 
nvmf_ho¡
 *
ho¡
;

73 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

74 ià(!
ho¡
)

75  
NULL
;

77 
	`k»f_š™
(&
ho¡
->
»f
);

78 
	`uuid_be_g’
(&
ho¡
->
id
);

79 
	`¢´štf
(
ho¡
->
nqn
, 
NVMF_NQN_SIZE
,

80 "nqn.2014-08.Üg.nvmex´ess:NVMf:uuid:%pUb", &
ho¡
->
id
);

82 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

83 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

84 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

86  
ho¡
;

87 
	}
}

89 
	$nvmf_ho¡_de¡roy
(
k»f
 *
»f
)

91 
nvmf_ho¡
 *
ho¡
 = 
	`cÚš”_of
(
»f
, nvmf_host,„ef);

93 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

94 
	`li¡_d–
(&
ho¡
->
li¡
);

95 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

97 
	`kä“
(
ho¡
);

98 
	}
}

100 
	$nvmf_ho¡_put
(
nvmf_ho¡
 *
ho¡
)

102 ià(
ho¡
)

103 
	`k»f_put
(&
ho¡
->
»f
, 
nvmf_ho¡_de¡roy
);

104 
	}
}

112 
	$nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
)

114 
Ën
 = 0;

116 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRADDR
)

117 
Ën
 +ğ
	`¢´štf
(
buf
, 
size
, "Œaddr=%s", 
ù¾
->
İts
->
Œaddr
);

118 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRSVCID
)

119 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%strsvcid=%s",

120 (
Ën
è? "," : "", 
ù¾
->
İts
->
Œsvcid
);

121 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

122 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%shost_traddr=%s",

123 (
Ën
è? "," : "", 
ù¾
->
İts
->
ho¡_Œaddr
);

124 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "\n");

126  
Ën
;

127 
	}
}

128 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_add»ss
);

134 cÚ¡ *
	$nvmf_g‘_subsy¢qn
(
nvme_ù¾
 *
ù¾
)

136  
ù¾
->
İts
->
subsy¢qn
;

137 
	}
}

138 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_subsy¢qn
);

161 
	$nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

163 
nvme_commªd
 
cmd
;

164 
nvme_»suÉ
 
»s
;

165 
»t
;

167 
	`mem£t
(&
cmd
, 0, (cmd));

168 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

169 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

170 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

172 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

173 
NVME_QID_ANY
, 0, 0);

175 ià(
»t
 >= 0)

176 *
v®
 = 
	`Ë64_to_ıu
(
»s
.
u64
);

177 ià(
	`uÆik–y
(
»t
 != 0))

178 
	`dev_”r
(
ù¾
->
deviû
,

180 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

182  
»t
;

183 
	}
}

184 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad32
);

207 
	$nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

209 
nvme_commªd
 
cmd
;

210 
nvme_»suÉ
 
»s
;

211 
»t
;

213 
	`mem£t
(&
cmd
, 0, (cmd));

214 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

215 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

216 
cmd
.
´İ_g‘
.
©Œib
 = 1;

217 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

219 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

220 
NVME_QID_ANY
, 0, 0);

222 ià(
»t
 >= 0)

223 *
v®
 = 
	`Ë64_to_ıu
(
»s
.
u64
);

224 ià(
	`uÆik–y
(
»t
 != 0))

225 
	`dev_”r
(
ù¾
->
deviû
,

227 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

228  
»t
;

229 
	}
}

230 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad64
);

253 
	$nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

255 
nvme_commªd
 
cmd
;

256 
»t
;

258 
	`mem£t
(&
cmd
, 0, (cmd));

259 
cmd
.
´İ_£t
.
İcode
 = 
nvme_çbrics_commªd
;

260 
cmd
.
´İ_£t
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_£t
;

261 
cmd
.
´İ_£t
.
©Œib
 = 0;

262 
cmd
.
´İ_£t
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

263 
cmd
.
´İ_£t
.
v®ue
 = 
	`ıu_to_Ë64
(
v®
);

265 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, NULL, 0, 0,

266 
NVME_QID_ANY
, 0, 0);

267 ià(
	`uÆik–y
(
»t
))

268 
	`dev_”r
(
ù¾
->
deviû
,

270 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

271  
»t
;

272 
	}
}

273 
EXPORT_SYMBOL_GPL
(
nvmf_»g_wr™e32
);

290 
	$nvmf_log_cÚÃù_”rÜ
(
nvme_ù¾
 *
ù¾
,

291 
”rv®
, 
off£t
, 
nvme_commªd
 *
cmd
,

292 
nvmf_cÚÃù_d©a
 *
d©a
)

294 
”r_sùy³
 = 
”rv®
 & (~
NVME_SC_DNR
);

296 
”r_sùy³
) {

298 (
NVME_SC_CONNECT_INVALID_PARAM
):

299 ià(
off£t
 >> 16) {

300 *
šv_d©a
 = "Connect Invalid Data Parameter";

302 
off£t
 & 0xffff) {

303 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
úid
)):

304 
	`dev_”r
(
ù¾
->
deviû
,

306 
šv_d©a
, 
d©a
->
úid
);

308 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
ho¡nqn
)):

309 
	`dev_”r
(
ù¾
->
deviû
,

311 
šv_d©a
, 
d©a
->
ho¡nqn
);

313 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
subsy¢qn
)):

314 
	`dev_”r
(
ù¾
->
deviû
,

316 
šv_d©a
, 
d©a
->
subsy¢qn
);

319 
	`dev_”r
(
ù¾
->
deviû
,

321 
šv_d©a
, 
off£t
 & 0xffff);

325 *
šv_sqe
 = "Connect Invalid SQE Parameter";

327 
off£t
) {

328 (
	`off£tof
(
nvmf_cÚÃù_commªd
, 
qid
)):

329 
	`dev_”r
(
ù¾
->
deviû
,

331 
šv_sqe
, 
cmd
->
cÚÃù
.
qid
);

334 
	`dev_”r
(
ù¾
->
deviû
,

336 
šv_sqe
, 
off£t
);

341 
	`dev_”r
(
ù¾
->
deviû
,

343 
”r_sùy³
);

346 
	}
}

368 
	$nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
)

370 
nvme_commªd
 
cmd
;

371 
nvme_»suÉ
 
»s
;

372 
nvmf_cÚÃù_d©a
 *
d©a
;

373 
»t
;

375 
	`mem£t
(&
cmd
, 0, (cmd));

376 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

377 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

378 
cmd
.
cÚÃù
.
qid
 = 0;

385 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
NVMF_AQ_DEPTH
 - 1);

391 
cmd
.
cÚÃù
.
k©o
 = 
ù¾
->
İts
->
discov”y_nqn
 ? 0 :

392 
	`ıu_to_Ë32
((
ù¾
->
k©o
 + 
NVME_KATO_GRACE
) * 1000);

394 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

395 ià(!
d©a
)

396  -
ENOMEM
;

398 
	`memıy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
, (
uuid_be
));

399 
d©a
->
úid
 = 
	`ıu_to_Ë16
(0xffff);

400 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

401 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

403 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
,

404 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

405 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

406 ià(
»t
) {

407 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
»s
.
u32
),

408 &
cmd
, 
d©a
);

409 
out_ä“_d©a
;

412 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
»s
.
u16
);

414 
out_ä“_d©a
:

415 
	`kä“
(
d©a
);

416  
»t
;

417 
	}
}

418 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_admš_queue
);

440 
	$nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
)

442 
nvme_commªd
 
cmd
;

443 
nvmf_cÚÃù_d©a
 *
d©a
;

444 
nvme_»suÉ
 
»s
;

445 
»t
;

447 
	`mem£t
(&
cmd
, 0, (cmd));

448 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

449 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

450 
cmd
.
cÚÃù
.
qid
 = 
	`ıu_to_Ë16
(qid);

451 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
ù¾
->sqsize);

453 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

454 ià(!
d©a
)

455  -
ENOMEM
;

457 
	`memıy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
, (
uuid_be
));

458 
d©a
->
úid
 = 
	`ıu_to_Ë16
(
ù¾
->cntlid);

459 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

460 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

462 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
cÚÃù_q
, &
cmd
, &
»s
,

463 
d©a
, (*d©a), 0, 
qid
, 1,

464 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

465 ià(
»t
) {

466 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
»s
.
u32
),

467 &
cmd
, 
d©a
);

469 
	`kä“
(
d©a
);

470  
»t
;

471 
	}
}

472 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_io_queue
);

474 
boŞ
 
	$nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
)

476 ià(
ù¾
->
İts
->
max_»cÚÃùs
 != -1 &&

477 
ù¾
->
İts
->
Ä_»cÚÃùs
 < cŒl->İts->
max_»cÚÃùs
)

478  
Œue
;

480  
çl£
;

481 
	}
}

482 
EXPORT_SYMBOL_GPL
(
nvmf_should_»cÚÃù
);

493 
	$nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

495 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

496 
	`li¡_add_
(&
İs
->
’Œy
, &
nvmf_Œª¥Üts
);

497 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

498 
	}
}

499 
EXPORT_SYMBOL_GPL
(
nvmf_»gi¡”_Œª¥Üt
);

510 
	$nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

512 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

513 
	`li¡_d–
(&
İs
->
’Œy
);

514 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

515 
	}
}

516 
EXPORT_SYMBOL_GPL
(
nvmf_uÄegi¡”_Œª¥Üt
);

518 
nvmf_Œª¥Üt_İs
 *
	$nvmf_lookup_Œª¥Üt
(

519 
nvmf_ù¾_İtiÚs
 *
İts
)

521 
nvmf_Œª¥Üt_İs
 *
İs
;

523 
	`lockd•_as£¹_h–d
(&
nvmf_Œª¥Üts_mu‹x
);

525 
	`li¡_fÜ_—ch_’Œy
(
İs
, &
nvmf_Œª¥Üts
, 
’Œy
) {

526 ià(
	`¡rcmp
(
İs
->
Çme
, 
İts
->
Œª¥Üt
) == 0)

527  
İs
;

530  
NULL
;

531 
	}
}

533 cÚ¡ 
m©ch_bË_t
 
	gİt_tok’s
 = {

534 { 
NVMF_OPT_TRANSPORT
, "transport=%s" },

535 { 
NVMF_OPT_TRADDR
, "traddr=%s" },

536 { 
NVMF_OPT_TRSVCID
, "trsvcid=%s" },

537 { 
NVMF_OPT_NQN
, "nqn=%s" },

538 { 
NVMF_OPT_QUEUE_SIZE
, "queue_size=%d" },

539 { 
NVMF_OPT_NR_IO_QUEUES
, "nr_io_queues=%d" },

540 { 
NVMF_OPT_RECONNECT_DELAY
, "reconnect_delay=%d" },

541 { 
NVMF_OPT_CTRL_LOSS_TMO
, "ctrl_loss_tmo=%d" },

542 { 
NVMF_OPT_KATO
, "keep_alive_tmo=%d" },

543 { 
NVMF_OPT_HOSTNQN
, "hostnqn=%s" },

544 { 
NVMF_OPT_HOST_TRADDR
, "host_traddr=%s" },

545 { 
NVMF_OPT_ERR
, 
NULL
 }

548 
	$nvmf_·r£_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
,

549 cÚ¡ *
buf
)

551 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

552 *
İtiÚs
, *
o
, *
p
;

553 
tok’
, 
»t
 = 0;

554 
size_t
 
nqÆ’
 = 0;

555 
ù¾_loss_tmo
 = 
NVMF_DEF_CTRL_LOSS_TMO
;

558 
İts
->
queue_size
 = 
NVMF_DEF_QUEUE_SIZE
;

559 
İts
->
Ä_io_queues
 = 
	`num_Úlše_ıus
();

560 
İts
->
»cÚÃù_d–ay
 = 
NVMF_DEF_RECONNECT_DELAY
;

562 
İtiÚs
 = 
o
 = 
	`k¡rdup
(
buf
, 
GFP_KERNEL
);

563 ià(!
İtiÚs
)

564  -
ENOMEM
;

566 (
p
 = 
	`¡r£p
(&
o
, ",\n")è!ğ
NULL
) {

567 ià(!*
p
)

570 
tok’
 = 
	`m©ch_tok’
(
p
, 
İt_tok’s
, 
¬gs
);

571 
İts
->
mask
 |ğ
tok’
;

572 
tok’
) {

573 
NVMF_OPT_TRANSPORT
:

574 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

575 ià(!
p
) {

576 
»t
 = -
ENOMEM
;

577 
out
;

579 
İts
->
Œª¥Üt
 = 
p
;

581 
NVMF_OPT_NQN
:

582 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

583 ià(!
p
) {

584 
»t
 = -
ENOMEM
;

585 
out
;

587 
İts
->
subsy¢qn
 = 
p
;

588 
nqÆ’
 = 
	`¡¾’
(
İts
->
subsy¢qn
);

589 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

590 
	`´_”r
("%s‚eedso be < %d bytes\n",

591 
İts
->
subsy¢qn
, 
NVMF_NQN_SIZE
);

592 
»t
 = -
EINVAL
;

593 
out
;

595 
İts
->
discov”y_nqn
 =

596 !(
	`¡rcmp
(
İts
->
subsy¢qn
,

597 
NVME_DISC_SUBSYS_NAME
));

598 ià(
İts
->
discov”y_nqn
)

599 
İts
->
Ä_io_queues
 = 0;

601 
NVMF_OPT_TRADDR
:

602 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

603 ià(!
p
) {

604 
»t
 = -
ENOMEM
;

605 
out
;

607 
İts
->
Œaddr
 = 
p
;

609 
NVMF_OPT_TRSVCID
:

610 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

611 ià(!
p
) {

612 
»t
 = -
ENOMEM
;

613 
out
;

615 
İts
->
Œsvcid
 = 
p
;

617 
NVMF_OPT_QUEUE_SIZE
:

618 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

619 
»t
 = -
EINVAL
;

620 
out
;

622 ià(
tok’
 < 
NVMF_MIN_QUEUE_SIZE
 ||

623 
tok’
 > 
NVMF_MAX_QUEUE_SIZE
) {

624 
	`´_”r
("Inv®id queue_siz%d\n", 
tok’
);

625 
»t
 = -
EINVAL
;

626 
out
;

628 
İts
->
queue_size
 = 
tok’
;

630 
NVMF_OPT_NR_IO_QUEUES
:

631 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

632 
»t
 = -
EINVAL
;

633 
out
;

635 ià(
tok’
 <= 0) {

636 
	`´_”r
("Inv®id‚umb” oàIOQ %d\n", 
tok’
);

637 
»t
 = -
EINVAL
;

638 
out
;

640 
İts
->
Ä_io_queues
 = 
	`mš_t
(,

641 
	`num_Úlše_ıus
(), 
tok’
);

643 
NVMF_OPT_KATO
:

644 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

645 
»t
 = -
EINVAL
;

646 
out
;

649 ià(
İts
->
discov”y_nqn
) {

650 
	`´_”r
("Discovery controllers cannot‡ccept keep_alive_tmo != 0\n");

651 
»t
 = -
EINVAL
;

652 
out
;

655 ià(
tok’
 < 0) {

656 
	`´_”r
("Inv®id k“p_®ive_tmØ%d\n", 
tok’
);

657 
»t
 = -
EINVAL
;

658 
out
;

659 } ià(
tok’
 == 0) {

661 
	`´_w¬n
("keep_alive_tmo 0 won'tƒxecute keep‡lives!!!\n");

663 
İts
->
k©o
 = 
tok’
;

665 
NVMF_OPT_CTRL_LOSS_TMO
:

666 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

667 
»t
 = -
EINVAL
;

668 
out
;

671 ià(
tok’
 < 0)

672 
	`´_w¬n
("ctrl_loss_tmo < 0 will„econnect forever\n");

673 
ù¾_loss_tmo
 = 
tok’
;

675 
NVMF_OPT_HOSTNQN
:

676 ià(
İts
->
ho¡
) {

677 
	`´_”r
("hostnqn‡lready user-assigned: %s\n",

678 
İts
->
ho¡
->
nqn
);

679 
»t
 = -
EADDRINUSE
;

680 
out
;

682 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

683 ià(!
p
) {

684 
»t
 = -
ENOMEM
;

685 
out
;

687 
nqÆ’
 = 
	`¡¾’
(
p
);

688 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

689 
	`´_”r
("%s‚eedso be < %d bytes\n",

690 
p
, 
NVMF_NQN_SIZE
);

691 
	`kä“
(
p
);

692 
»t
 = -
EINVAL
;

693 
out
;

695 
İts
->
ho¡
 = 
	`nvmf_ho¡_add
(
p
);

696 
	`kä“
(
p
);

697 ià(!
İts
->
ho¡
) {

698 
»t
 = -
ENOMEM
;

699 
out
;

702 
NVMF_OPT_RECONNECT_DELAY
:

703 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

704 
»t
 = -
EINVAL
;

705 
out
;

707 ià(
tok’
 <= 0) {

708 
	`´_”r
("Inv®id„ecÚÃù_d–ay %d\n", 
tok’
);

709 
»t
 = -
EINVAL
;

710 
out
;

712 
İts
->
»cÚÃù_d–ay
 = 
tok’
;

714 
NVMF_OPT_HOST_TRADDR
:

715 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

716 ià(!
p
) {

717 
»t
 = -
ENOMEM
;

718 
out
;

720 
İts
->
ho¡_Œaddr
 = 
p
;

723 
	`´_w¬n
("unknown…arameter or missing value '%s' in ctrl creation„equest\n",

724 
p
);

725 
»t
 = -
EINVAL
;

726 
out
;

730 ià(
ù¾_loss_tmo
 < 0)

731 
İts
->
max_»cÚÃùs
 = -1;

733 
İts
->
max_»cÚÃùs
 = 
	`DIV_ROUND_UP
(
ù¾_loss_tmo
,

734 
İts
->
»cÚÃù_d–ay
);

736 ià(!
İts
->
ho¡
) {

737 
	`k»f_g‘
(&
nvmf_deçuÉ_ho¡
->
»f
);

738 
İts
->
ho¡
 = 
nvmf_deçuÉ_ho¡
;

741 
out
:

742 ià(!
İts
->
discov”y_nqn
 && !İts->
k©o
)

743 
İts
->
k©o
 = 
NVME_DEFAULT_KATO
;

744 
	`kä“
(
İtiÚs
);

745  
»t
;

746 
	}
}

748 
	$nvmf_check_»quœed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

749 
»quœed_İts
)

751 ià((
İts
->
mask
 & 
»quœed_İts
) !=„equired_opts) {

752 
i
;

754 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

755 ià((
İt_tok’s
[
i
].
tok’
 & 
»quœed_İts
) &&

756 !(
İt_tok’s
[
i
].
tok’
 & 
İts
->
mask
)) {

757 
	`´_w¬n
("missing…arameter '%s'\n",

758 
İt_tok’s
[
i
].
·‰”n
);

762  -
EINVAL
;

766 
	}
}

768 
	$nvmf_check_®lowed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

769 
®lowed_İts
)

771 ià(
İts
->
mask
 & ~
®lowed_İts
) {

772 
i
;

774 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

775 ià(
İt_tok’s
[
i
].
tok’
 & ~
®lowed_İts
) {

776 
	`´_w¬n
("invalid…arameter '%s'\n",

777 
İt_tok’s
[
i
].
·‰”n
);

781  -
EINVAL
;

785 
	}
}

787 
	$nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
)

789 
	`nvmf_ho¡_put
(
İts
->
ho¡
);

790 
	`kä“
(
İts
->
Œª¥Üt
);

791 
	`kä“
(
İts
->
Œaddr
);

792 
	`kä“
(
İts
->
Œsvcid
);

793 
	`kä“
(
İts
->
subsy¢qn
);

794 
	`kä“
(
İts
->
ho¡_Œaddr
);

795 
	`kä“
(
İts
);

796 
	}
}

797 
EXPORT_SYMBOL_GPL
(
nvmf_ä“_İtiÚs
);

799 
	#NVMF_REQUIRED_OPTS
 (
NVMF_OPT_TRANSPORT
 | 
NVMF_OPT_NQN
)

	)

800 
	#NVMF_ALLOWED_OPTS
 (
NVMF_OPT_QUEUE_SIZE
 | 
NVMF_OPT_NR_IO_QUEUES
 | \

801 
NVMF_OPT_KATO
 | 
NVMF_OPT_HOSTNQN
)

	)

803 
nvme_ù¾
 *

804 
	$nvmf_ü—‹_ù¾
(
deviû
 *
dev
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

806 
nvmf_ù¾_İtiÚs
 *
İts
;

807 
nvmf_Œª¥Üt_İs
 *
İs
;

808 
nvme_ù¾
 *
ù¾
;

809 
»t
;

811 
İts
 = 
	`kz®loc
((*İts), 
GFP_KERNEL
);

812 ià(!
İts
)

813  
	`ERR_PTR
(-
ENOMEM
);

815 
»t
 = 
	`nvmf_·r£_İtiÚs
(
İts
, 
buf
);

816 ià(
»t
)

817 
out_ä“_İts
;

824 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
NVMF_REQUIRED_OPTS
);

825 ià(
»t
)

826 
out_ä“_İts
;

827 
İts
->
mask
 &ğ~
NVMF_REQUIRED_OPTS
;

829 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

830 
İs
 = 
	`nvmf_lookup_Œª¥Üt
(
İts
);

831 ià(!
İs
) {

832 
	`´_šfo
("no handler found forransport %s.\n",

833 
İts
->
Œª¥Üt
);

834 
»t
 = -
EINVAL
;

835 
out_uÆock
;

838 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
İs
->
»quœed_İts
);

839 ià(
»t
)

840 
out_uÆock
;

841 
»t
 = 
	`nvmf_check_®lowed_İts
(
İts
, 
NVMF_ALLOWED_OPTS
 |

842 
İs
->
®lowed_İts
 | ops->
»quœed_İts
);

843 ià(
»t
)

844 
out_uÆock
;

846 
ù¾
 = 
İs
->
	`ü—‹_ù¾
(
dev
, 
İts
);

847 ià(
	`IS_ERR
(
ù¾
)) {

848 
»t
 = 
	`PTR_ERR
(
ù¾
);

849 
out_uÆock
;

852 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

853  
ù¾
;

855 
out_uÆock
:

856 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

857 
out_ä“_İts
:

858 
	`nvmf_ä“_İtiÚs
(
İts
);

859  
	`ERR_PTR
(
»t
);

860 
	}
}

862 
şass
 *
	gnvmf_şass
;

863 
deviû
 *
	gnvmf_deviû
;

864 
DEFINE_MUTEX
(
nvmf_dev_mu‹x
);

866 
ssize_t
 
	$nvmf_dev_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
ubuf
,

867 
size_t
 
couÁ
, 
loff_t
 *
pos
)

869 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

870 
nvme_ù¾
 *
ù¾
;

871 cÚ¡ *
buf
;

872 
»t
 = 0;

874 ià(
couÁ
 > 
PAGE_SIZE
)

875  -
ENOMEM
;

877 
buf
 = 
	`memdup_u£r_nul
(
ubuf
, 
couÁ
);

878 ià(
	`IS_ERR
(
buf
))

879  
	`PTR_ERR
(
buf
);

881 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

882 ià(
£q_fe
->
´iv©e
) {

883 
»t
 = -
EINVAL
;

884 
out_uÆock
;

887 
ù¾
 = 
	`nvmf_ü—‹_ù¾
(
nvmf_deviû
, 
buf
, 
couÁ
);

888 ià(
	`IS_ERR
(
ù¾
)) {

889 
»t
 = 
	`PTR_ERR
(
ù¾
);

890 
out_uÆock
;

893 
£q_fe
->
´iv©e
 = 
ù¾
;

895 
out_uÆock
:

896 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

897 
	`kä“
(
buf
);

898  
»t
 ?„‘ : 
couÁ
;

899 
	}
}

901 
	$nvmf_dev_show
(
£q_fe
 *£q_fe, *
´iv©e
)

903 
nvme_ù¾
 *
ù¾
;

904 
»t
 = 0;

906 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

907 
ù¾
 = 
£q_fe
->
´iv©e
;

908 ià(!
ù¾
) {

909 
»t
 = -
EINVAL
;

910 
out_uÆock
;

913 
	`£q_´štf
(
£q_fe
, "instance=%d,cntlid=%d\n",

914 
ù¾
->
š¡ªû
, cŒl->
úid
);

916 
out_uÆock
:

917 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

918  
»t
;

919 
	}
}

921 
	$nvmf_dev_İ’
(
šode
 *šode, 
fe
 *file)

927 
fe
->
´iv©e_d©a
 = 
NULL
;

928  
	`sšgË_İ’
(
fe
, 
nvmf_dev_show
, 
NULL
);

929 
	}
}

931 
	$nvmf_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

933 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

934 
nvme_ù¾
 *
ù¾
 = 
£q_fe
->
´iv©e
;

936 ià(
ù¾
)

937 
	`nvme_put_ù¾
(
ù¾
);

938  
	`sšgË_»Ëa£
(
šode
, 
fe
);

939 
	}
}

941 cÚ¡ 
fe_İ”©iÚs
 
	gnvmf_dev_fİs
 = {

942 .
owÃr
 = 
THIS_MODULE
,

943 .
	gwr™e
 = 
nvmf_dev_wr™e
,

944 .
	g»ad
 = 
£q_»ad
,

945 .
	gİ’
 = 
nvmf_dev_İ’
,

946 .
	g»Ëa£
 = 
nvmf_dev_»Ëa£
,

949 
miscdeviû
 
	gnvmf_misc
 = {

950 .
mšÜ
 = 
MISC_DYNAMIC_MINOR
,

951 .
	gÇme
 = "nvme-fabrics",

952 .
	gfİs
 = &
nvmf_dev_fİs
,

955 
__š™
 
	$nvmf_š™
()

957 
»t
;

959 
nvmf_deçuÉ_ho¡
 = 
	`nvmf_ho¡_deçuÉ
();

960 ià(!
nvmf_deçuÉ_ho¡
)

961  -
ENOMEM
;

963 
nvmf_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme-fabrics");

964 ià(
	`IS_ERR
(
nvmf_şass
)) {

965 
	`´_”r
("couldn't„egister class‚vme-fabrics\n");

966 
»t
 = 
	`PTR_ERR
(
nvmf_şass
);

967 
out_ä“_ho¡
;

970 
nvmf_deviû
 =

971 
	`deviû_ü—‹
(
nvmf_şass
, 
NULL
, 
	`MKDEV
(0, 0), NULL, "ctl");

972 ià(
	`IS_ERR
(
nvmf_deviû
)) {

973 
	`´_”r
("couldn't create‚vme-fabris device!\n");

974 
»t
 = 
	`PTR_ERR
(
nvmf_deviû
);

975 
out_de¡roy_şass
;

978 
»t
 = 
	`misc_»gi¡”
(&
nvmf_misc
);

979 ià(
»t
) {

980 
	`´_”r
("couldn'ˆ»gi¡” misødeviû: %d\n", 
»t
);

981 
out_de¡roy_deviû
;

986 
out_de¡roy_deviû
:

987 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

988 
out_de¡roy_şass
:

989 
	`şass_de¡roy
(
nvmf_şass
);

990 
out_ä“_ho¡
:

991 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

992  
»t
;

993 
	}
}

995 
__ex™
 
	$nvmf_ex™
()

997 
	`misc_d”egi¡”
(&
nvmf_misc
);

998 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

999 
	`şass_de¡roy
(
nvmf_şass
);

1000 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1002 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_commªd
) != 64);

1003 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_g‘_commªd
) != 64);

1004 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_£t_commªd
) != 64);

1005 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_d©a
) != 1024);

1006 
	}
}

1008 
MODULE_LICENSE
("GPL v2");

1010 
moduË_š™
(
nvmf_š™
);

1011 
moduË_ex™
(
nvmf_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/fabrics.h

14 #iâdeà
_NVME_FABRICS_H


15 
	#_NVME_FABRICS_H
 1

	)

17 
	~<lšux/š.h
>

18 
	~<lšux/š‘.h
>

20 
	#NVMF_MIN_QUEUE_SIZE
 16

	)

21 
	#NVMF_MAX_QUEUE_SIZE
 1024

	)

22 
	#NVMF_DEF_QUEUE_SIZE
 128

	)

23 
	#NVMF_DEF_RECONNECT_DELAY
 10

	)

25 
	#NVMF_DEF_CTRL_LOSS_TMO
 600

	)

35 
	snvmf_ho¡
 {

36 
k»f
 
	m»f
;

37 
li¡_h—d
 
	mli¡
;

38 
	mnqn
[
NVMF_NQN_SIZE
];

39 
uuid_be
 
	mid
;

46 
	mNVMF_OPT_ERR
 = 0,

47 
	mNVMF_OPT_TRANSPORT
 = 1 << 0,

48 
	mNVMF_OPT_NQN
 = 1 << 1,

49 
	mNVMF_OPT_TRADDR
 = 1 << 2,

50 
	mNVMF_OPT_TRSVCID
 = 1 << 3,

51 
	mNVMF_OPT_QUEUE_SIZE
 = 1 << 4,

52 
	mNVMF_OPT_NR_IO_QUEUES
 = 1 << 5,

53 
	mNVMF_OPT_TL_RETRY_COUNT
 = 1 << 6,

54 
	mNVMF_OPT_KATO
 = 1 << 7,

55 
	mNVMF_OPT_HOSTNQN
 = 1 << 8,

56 
	mNVMF_OPT_RECONNECT_DELAY
 = 1 << 9,

57 
	mNVMF_OPT_HOST_TRADDR
 = 1 << 10,

58 
	mNVMF_OPT_CTRL_LOSS_TMO
 = 1 << 11,

88 
	snvmf_ù¾_İtiÚs
 {

89 
	mmask
;

90 *
	mŒª¥Üt
;

91 *
	msubsy¢qn
;

92 *
	mŒaddr
;

93 *
	mŒsvcid
;

94 *
	mho¡_Œaddr
;

95 
size_t
 
	mqueue_size
;

96 
	mÄ_io_queues
;

97 
	m»cÚÃù_d–ay
;

98 
boŞ
 
	mdiscov”y_nqn
;

99 
	mk©o
;

100 
nvmf_ho¡
 *
	mho¡
;

101 
	mÄ_»cÚÃùs
;

102 
	mmax_»cÚÃùs
;

126 
	snvmf_Œª¥Üt_İs
 {

127 
li¡_h—d
 
	m’Œy
;

128 cÚ¡ *
	mÇme
;

129 
	m»quœed_İts
;

130 
	m®lowed_İts
;

131 
	mnvme_ù¾
 *(*
	mü—‹_ù¾
)(
deviû
 *
	mdev
,

132 
nvmf_ù¾_İtiÚs
 *
	mİts
);

135 
nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
);

136 
nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
);

137 
nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
);

138 
nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
);

139 
nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
);

140 
nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

141 
nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

142 
nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
);

143 cÚ¡ *
nvmf_g‘_subsy¢qn
(
nvme_ù¾
 *
ù¾
);

144 
nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
);

145 
boŞ
 
nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/fc.c

17 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

18 
	~<lšux/moduË.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<u­i/scsi/fc/fc_fs.h
>

21 
	~<u­i/scsi/fc/fc_–s.h
>

23 
	~"nvme.h
"

24 
	~"çbrics.h
"

25 
	~<lšux/nvme-fc-driv”.h
>

26 
	~<lšux/nvme-fc.h
>

36 
	#NVME_FC_NR_AEN_COMMANDS
 1

	)

37 
	#NVME_FC_AQ_BLKMQ_DEPTH
 \

38 (
NVMF_AQ_DEPTH
 - 
NVME_FC_NR_AEN_COMMANDS
)

	)

39 
	#AEN_CMDID_BASE
 (
NVME_FC_AQ_BLKMQ_DEPTH
 + 1)

	)

41 
	envme_fc_queue_æags
 {

42 
	mNVME_FC_Q_CONNECTED
 = (1 << 0),

45 
	#NVMEFC_QUEUE_DELAY
 3

	)

47 
	snvme_fc_queue
 {

48 
nvme_fc_ù¾
 *
	mù¾
;

49 
deviû
 *
	mdev
;

50 
blk_mq_hw_ùx
 *
	mhùx
;

51 *
	mÎdd_hªdË
;

52 
	mqueue_size
;

53 
size_t
 
	mcmnd_ÿpsuË_Ën
;

54 
u32
 
	mqnum
;

55 
u32
 
	mrqút
;

56 
u32
 
	m£qno
;

58 
u64
 
	mcÚÃùiÚ_id
;

59 
©omic_t
 
	mc¢
;

61 
	mæags
;

62 } 
__®igÃd
((
u64
));

64 
	snvmefc_ls_»q_İ
 {

65 
nvmefc_ls_»q
 
	mls_»q
;

67 
nvme_fc_ù¾
 *
	mù¾
;

68 
nvme_fc_queue
 *
	mqueue
;

69 
»que¡
 *
	mrq
;

71 
	mls_”rÜ
;

72 
com¶‘iÚ
 
	mls_dÚe
;

73 
li¡_h—d
 
	ml¤eq_li¡
;

74 
boŞ
 
	m»q_queued
;

77 
	envme_fıİ_¡©e
 {

78 
	mFCPOP_STATE_UNINIT
 = 0,

79 
	mFCPOP_STATE_IDLE
 = 1,

80 
	mFCPOP_STATE_ACTIVE
 = 2,

81 
	mFCPOP_STATE_ABORTED
 = 3,

84 
	snvme_fc_fı_İ
 {

85 
nvme_»que¡
 
	mÄeq
;

93 
nvmefc_fı_»q
 
	mfı_»q
;

95 
nvme_fc_ù¾
 *
	mù¾
;

96 
nvme_fc_queue
 *
	mqueue
;

97 
»que¡
 *
	mrq
;

99 
©omic_t
 
	m¡©e
;

100 
u32
 
	mrqno
;

101 
u32
 
	mÃÁs
;

103 
nvme_fc_cmd_iu
 
	mcmd_iu
;

104 
nvme_fc_”¥_iu
 
	mr¥_iu
;

107 
	snvme_fc_ÍÜt
 {

108 
nvme_fc_loÿl_pÜt
 
	mloÿÍÜt
;

110 
ida
 
	m’dp_út
;

111 
li¡_h—d
 
	mpÜt_li¡
;

112 
li¡_h—d
 
	m’dp_li¡
;

113 
deviû
 *
	mdev
;

114 
nvme_fc_pÜt_‹m¶©e
 *
	mİs
;

115 
k»f
 
	m»f
;

116 } 
__®igÃd
((
u64
));

118 
	snvme_fc_½Üt
 {

119 
nvme_fc_»mÙe_pÜt
 
	m»mÙ•Üt
;

121 
li¡_h—d
 
	m’dp_li¡
;

122 
li¡_h—d
 
	mù¾_li¡
;

123 
¥šlock_t
 
	mlock
;

124 
k»f
 
	m»f
;

125 } 
__®igÃd
((
u64
));

127 
	envme_fcù¾_¡©e
 {

128 
	mFCCTRL_INIT
 = 0,

129 
	mFCCTRL_ACTIVE
 = 1,

132 
	snvme_fc_ù¾
 {

133 
¥šlock_t
 
	mlock
;

134 
nvme_fc_queue
 *
	mqueues
;

135 
u32
 
	mqueue_couÁ
;

137 
deviû
 *
	mdev
;

138 
nvme_fc_ÍÜt
 *
	mÍÜt
;

139 
nvme_fc_½Üt
 *
	m½Üt
;

140 
u32
 
	múum
;

142 
u64
 
	massocŸtiÚ_id
;

144 
u64
 
	mÿp
;

146 
li¡_h—d
 
	mù¾_li¡
;

147 
li¡_h—d
 
	mls_»q_li¡
;

149 
blk_mq_g_£t
 
	madmš_g_£t
;

150 
blk_mq_g_£t
 
	mg_£t
;

152 
wÜk_¡ruù
 
	md–‘e_wÜk
;

153 
k»f
 
	m»f
;

154 
	m¡©e
;

156 
nvme_fc_fı_İ
 
	m«n_İs
[
NVME_FC_NR_AEN_COMMANDS
];

158 
nvme_ù¾
 
	mù¾
;

161 
šlše
 
nvme_fc_ù¾
 *

162 
	$to_fc_ù¾
(
nvme_ù¾
 *
ù¾
)

164  
	`cÚš”_of
(
ù¾
, 
nvme_fc_ù¾
, ctrl);

165 
	}
}

167 
šlše
 
nvme_fc_ÍÜt
 *

168 
	$loÿÍÜt_to_ÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

170  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_ÍÜt
, 
loÿÍÜt
);

171 
	}
}

173 
šlše
 
nvme_fc_½Üt
 *

174 
	$»mÙ•Üt_to_½Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

176  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_½Üt
, 
»mÙ•Üt
);

177 
	}
}

179 
šlše
 
nvmefc_ls_»q_İ
 *

180 
	$ls_»q_to_lsİ
(
nvmefc_ls_»q
 *
l¤eq
)

182  
	`cÚš”_of
(
l¤eq
, 
nvmefc_ls_»q_İ
, 
ls_»q
);

183 
	}
}

185 
šlše
 
nvme_fc_fı_İ
 *

186 
	$fı_»q_to_fı_İ
(
nvmefc_fı_»q
 *
fı»q
)

188  
	`cÚš”_of
(
fı»q
, 
nvme_fc_fı_İ
, 
fı_»q
);

189 
	}
}

196 
DEFINE_SPINLOCK
(
nvme_fc_lock
);

198 
LIST_HEAD
(
nvme_fc_ÍÜt_li¡
);

199 
DEFINE_IDA
(
nvme_fc_loÿl_pÜt_út
);

200 
DEFINE_IDA
(
nvme_fc_ù¾_út
);

202 
wÜkqueue_¡ruù
 *
	gnvme_fc_wq
;

208 
__nvme_fc_d–_ù¾
(
nvme_fc_ù¾
 *);

209 
__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *,

210 
nvme_fc_queue
 *, );

231 
	$nvme_fc_»gi¡”_loÿÍÜt
(
nvme_fc_pÜt_šfo
 *
pšfo
,

232 
nvme_fc_pÜt_‹m¶©e
 *
‹m¶©e
,

233 
deviû
 *
dev
,

234 
nvme_fc_loÿl_pÜt
 **
pÜŒ
)

236 
nvme_fc_ÍÜt
 *
Ãw»c
;

237 
æags
;

238 
»t
, 
idx
;

240 ià(!
‹m¶©e
->
loÿÍÜt_d–‘e
 || !‹m¶©e->
»mÙ•Üt_d–‘e
 ||

241 !
‹m¶©e
->
ls_»q
 || !‹m¶©e->
fı_io
 ||

242 !
‹m¶©e
->
ls_abÜt
 || !‹m¶©e->
fı_abÜt
 ||

243 !
‹m¶©e
->
max_hw_queues
 || !‹m¶©e->
max_sgl_£gm’ts
 ||

244 !
‹m¶©e
->
max_dif_sgl_£gm’ts
 || !‹m¶©e->
dma_bound¬y
) {

245 
»t
 = -
EINVAL
;

246 
out_»gho¡_çed
;

249 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
‹m¶©e
->
loÿl_´iv_sz
),

250 
GFP_KERNEL
);

251 ià(!
Ãw»c
) {

252 
»t
 = -
ENOMEM
;

253 
out_»gho¡_çed
;

256 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_loÿl_pÜt_út
, 0, 0, 
GFP_KERNEL
);

257 ià(
idx
 < 0) {

258 
»t
 = -
ENOSPC
;

259 
out_ç_kä“
;

262 ià(!
	`g‘_deviû
(
dev
) && dev) {

263 
»t
 = -
ENODEV
;

264 
out_ida_put
;

267 
	`INIT_LIST_HEAD
(&
Ãw»c
->
pÜt_li¡
);

268 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

269 
	`k»f_š™
(&
Ãw»c
->
»f
);

270 
Ãw»c
->
İs
 = 
‹m¶©e
;

271 
Ãw»c
->
dev
 = dev;

272 
	`ida_š™
(&
Ãw»c
->
’dp_út
);

273 
Ãw»c
->
loÿÍÜt
.
´iv©e
 = &newrec[1];

274 
Ãw»c
->
loÿÍÜt
.
node_Çme
 = 
pšfo
->node_name;

275 
Ãw»c
->
loÿÍÜt
.
pÜt_Çme
 = 
pšfo
->port_name;

276 
Ãw»c
->
loÿÍÜt
.
pÜt_rŞe
 = 
pšfo
->port_role;

277 
Ãw»c
->
loÿÍÜt
.
pÜt_id
 = 
pšfo
->port_id;

278 
Ãw»c
->
loÿÍÜt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

279 
Ãw»c
->
loÿÍÜt
.
pÜt_num
 = 
idx
;

281 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

282 
	`li¡_add_
(&
Ãw»c
->
pÜt_li¡
, &
nvme_fc_ÍÜt_li¡
);

283 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

285 ià(
dev
)

286 
	`dma_£t_£g_bound¬y
(
dev
, 
‹m¶©e
->
dma_bound¬y
);

288 *
pÜŒ
 = &
Ãw»c
->
loÿÍÜt
;

291 
out_ida_put
:

292 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
idx
);

293 
out_ç_kä“
:

294 
	`kä“
(
Ãw»c
);

295 
out_»gho¡_çed
:

296 *
pÜŒ
 = 
NULL
;

298  
»t
;

299 
	}
}

300 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_loÿÍÜt
);

303 
	$nvme_fc_ä“_ÍÜt
(
k»f
 *
»f
)

305 
nvme_fc_ÍÜt
 *
ÍÜt
 =

306 
	`cÚš”_of
(
»f
, 
nvme_fc_ÍÜt
,„ef);

307 
æags
;

309 
	`WARN_ON
(
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
);

310 
	`WARN_ON
(!
	`li¡_em±y
(&
ÍÜt
->
’dp_li¡
));

313 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

314 
	`li¡_d–
(&
ÍÜt
->
pÜt_li¡
);

315 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

318 
ÍÜt
->
İs
->
	`loÿÍÜt_d–‘e
(&ÍÜt->
loÿÍÜt
);

320 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
ÍÜt
->
loÿÍÜt
.
pÜt_num
);

321 
	`ida_de¡roy
(&
ÍÜt
->
’dp_út
);

323 
	`put_deviû
(
ÍÜt
->
dev
);

325 
	`kä“
(
ÍÜt
);

326 
	}
}

329 
	$nvme_fc_ÍÜt_put
(
nvme_fc_ÍÜt
 *
ÍÜt
)

331 
	`k»f_put
(&
ÍÜt
->
»f
, 
nvme_fc_ä“_ÍÜt
);

332 
	}
}

335 
	$nvme_fc_ÍÜt_g‘
(
nvme_fc_ÍÜt
 *
ÍÜt
)

337  
	`k»f_g‘_uÆess_z”o
(&
ÍÜt
->
»f
);

338 
	}
}

352 
	$nvme_fc_uÄegi¡”_loÿÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

354 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
pÜŒ
);

355 
æags
;

357 ià(!
pÜŒ
)

358  -
EINVAL
;

360 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

362 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

363 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

364  -
EINVAL
;

366 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

368 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

370 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

373 
	}
}

374 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_loÿÍÜt
);

393 
	$nvme_fc_»gi¡”_»mÙ•Üt
(
nvme_fc_loÿl_pÜt
 *
loÿÍÜt
,

394 
nvme_fc_pÜt_šfo
 *
pšfo
,

395 
nvme_fc_»mÙe_pÜt
 **
pÜŒ
)

397 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
loÿÍÜt
);

398 
nvme_fc_½Üt
 *
Ãw»c
;

399 
æags
;

400 
»t
, 
idx
;

402 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
ÍÜt
->
İs
->
»mÙe_´iv_sz
),

403 
GFP_KERNEL
);

404 ià(!
Ãw»c
) {

405 
»t
 = -
ENOMEM
;

406 
out_»gho¡_çed
;

409 ià(!
	`nvme_fc_ÍÜt_g‘
(
ÍÜt
)) {

410 
»t
 = -
ESHUTDOWN
;

411 
out_kä“_½Üt
;

414 
idx
 = 
	`ida_sim¶e_g‘
(&
ÍÜt
->
’dp_út
, 0, 0, 
GFP_KERNEL
);

415 ià(
idx
 < 0) {

416 
»t
 = -
ENOSPC
;

417 
out_ÍÜt_put
;

420 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

421 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ù¾_li¡
);

422 
	`k»f_š™
(&
Ãw»c
->
»f
);

423 
	`¥š_lock_š™
(&
Ãw»c
->
lock
);

424 
Ãw»c
->
»mÙ•Üt
.
loÿÍÜt
 = &
ÍÜt
->localport;

425 
Ãw»c
->
»mÙ•Üt
.
´iv©e
 = &newrec[1];

426 
Ãw»c
->
»mÙ•Üt
.
pÜt_rŞe
 = 
pšfo
->port_role;

427 
Ãw»c
->
»mÙ•Üt
.
node_Çme
 = 
pšfo
->node_name;

428 
Ãw»c
->
»mÙ•Üt
.
pÜt_Çme
 = 
pšfo
->port_name;

429 
Ãw»c
->
»mÙ•Üt
.
pÜt_id
 = 
pšfo
->port_id;

430 
Ãw»c
->
»mÙ•Üt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

431 
Ãw»c
->
»mÙ•Üt
.
pÜt_num
 = 
idx
;

433 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

434 
	`li¡_add_
(&
Ãw»c
->
’dp_li¡
, &
ÍÜt
->endp_list);

435 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

437 *
pÜŒ
 = &
Ãw»c
->
»mÙ•Üt
;

440 
out_ÍÜt_put
:

441 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

442 
out_kä“_½Üt
:

443 
	`kä“
(
Ãw»c
);

444 
out_»gho¡_çed
:

445 *
pÜŒ
 = 
NULL
;

446  
»t
;

448 
	}
}

449 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_»mÙ•Üt
);

452 
	$nvme_fc_ä“_½Üt
(
k»f
 *
»f
)

454 
nvme_fc_½Üt
 *
½Üt
 =

455 
	`cÚš”_of
(
»f
, 
nvme_fc_½Üt
,„ef);

456 
nvme_fc_ÍÜt
 *
ÍÜt
 =

457 
	`loÿÍÜt_to_ÍÜt
(
½Üt
->
»mÙ•Üt
.
loÿÍÜt
);

458 
æags
;

460 
	`WARN_ON
(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
);

461 
	`WARN_ON
(!
	`li¡_em±y
(&
½Üt
->
ù¾_li¡
));

464 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

465 
	`li¡_d–
(&
½Üt
->
’dp_li¡
);

466 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

469 
ÍÜt
->
İs
->
	`»mÙ•Üt_d–‘e
(&
½Üt
->
»mÙ•Üt
);

471 
	`ida_sim¶e_»move
(&
ÍÜt
->
’dp_út
, 
½Üt
->
»mÙ•Üt
.
pÜt_num
);

473 
	`kä“
(
½Üt
);

475 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

476 
	}
}

479 
	$nvme_fc_½Üt_put
(
nvme_fc_½Üt
 *
½Üt
)

481 
	`k»f_put
(&
½Üt
->
»f
, 
nvme_fc_ä“_½Üt
);

482 
	}
}

485 
	$nvme_fc_½Üt_g‘
(
nvme_fc_½Üt
 *
½Üt
)

487  
	`k»f_g‘_uÆess_z”o
(&
½Üt
->
»f
);

488 
	}
}

502 
	$nvme_fc_uÄegi¡”_»mÙ•Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

504 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
pÜŒ
);

505 
nvme_fc_ù¾
 *
ù¾
;

506 
æags
;

508 ià(!
pÜŒ
)

509  -
EINVAL
;

511 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

513 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

514 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

515  -
EINVAL
;

517 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

520 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list)

521 
	`__nvme_fc_d–_ù¾
(
ù¾
);

523 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

525 
	`nvme_fc_½Üt_put
(
½Üt
);

527 
	}
}

528 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_»mÙ•Üt
);

549 
šlše
 
dma_addr_t


550 
	$fc_dma_m­_sšgË
(
deviû
 *
dev
, *
±r
, 
size_t
 
size
,

551 
dma_d©a_dœeùiÚ
 
dœ
)

553  
dev
 ? 
	`dma_m­_sšgË
(dev, 
±r
, 
size
, 
dœ
è: (
dma_addr_t
)0L;

554 
	}
}

556 
šlše
 

557 
	$fc_dma_m­pšg_”rÜ
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
)

559  
dev
 ? 
	`dma_m­pšg_”rÜ
(dev, 
dma_addr
) : 0;

560 
	}
}

562 
šlše
 

563 
	$fc_dma_unm­_sšgË
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

564 
dma_d©a_dœeùiÚ
 
dœ
)

566 ià(
dev
)

567 
	`dma_unm­_sšgË
(
dev
, 
addr
, 
size
, 
dœ
);

568 
	}
}

570 
šlše
 

571 
	$fc_dma_sync_sšgË_fÜ_ıu
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

572 
dma_d©a_dœeùiÚ
 
dœ
)

574 ià(
dev
)

575 
	`dma_sync_sšgË_fÜ_ıu
(
dev
, 
addr
, 
size
, 
dœ
);

576 
	}
}

578 
šlše
 

579 
	$fc_dma_sync_sšgË_fÜ_deviû
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

580 
dma_d©a_dœeùiÚ
 
dœ
)

582 ià(
dev
)

583 
	`dma_sync_sšgË_fÜ_deviû
(
dev
, 
addr
, 
size
, 
dœ
);

584 
	}
}

588 
	$fc_m­_sg
(
sÿ‰”li¡
 *
sg
, 
ÃÁs
)

590 
sÿ‰”li¡
 *
s
;

591 
i
;

593 
	`WARN_ON
(
ÃÁs
 =ğ0 || 
sg
[0].
Ëngth
 == 0);

595 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

596 
s
->
dma_add»ss
 = 0L;

597 #ifdeà
CONFIG_NEED_SG_DMA_LENGTH


598 
s
->
dma_Ëngth
 = s->
Ëngth
;

601  
ÃÁs
;

602 
	}
}

604 
šlše
 

605 
	$fc_dma_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

606 
dma_d©a_dœeùiÚ
 
dœ
)

608  
dev
 ? 
	`dma_m­_sg
(dev, 
sg
, 
ÃÁs
, 
dœ
è: 
	`fc_m­_sg
(sg,‚ents);

609 
	}
}

611 
šlše
 

612 
	$fc_dma_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

613 
dma_d©a_dœeùiÚ
 
dœ
)

615 ià(
dev
)

616 
	`dma_unm­_sg
(
dev
, 
sg
, 
ÃÁs
, 
dœ
);

617 
	}
}

622 
nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *);

623 
nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *);

627 
	$__nvme_fc_fšish_ls_»q
(
nvme_fc_ù¾
 *
ù¾
,

628 
nvmefc_ls_»q_İ
 *
lsİ
)

630 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

631 
æags
;

633 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

635 ià(!
lsİ
->
»q_queued
) {

636 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

640 
	`li¡_d–
(&
lsİ
->
l¤eq_li¡
);

642 
lsİ
->
»q_queued
 = 
çl£
;

644 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

646 
	`fc_dma_unm­_sšgË
(
ù¾
->
dev
, 
l¤eq
->
rq¡dma
,

647 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

648 
DMA_BIDIRECTIONAL
);

650 
	`nvme_fc_ù¾_put
(
ù¾
);

651 
	}
}

654 
	$__nvme_fc_£nd_ls_»q
(
nvme_fc_ù¾
 *
ù¾
,

655 
nvmefc_ls_»q_İ
 *
lsİ
,

656 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

658 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

659 
æags
;

660 
»t
;

662 ià(!
	`nvme_fc_ù¾_g‘
(
ù¾
))

663  -
ESHUTDOWN
;

665 
l¤eq
->
dÚe
 = done;

666 
lsİ
->
ù¾
 = ctrl;

667 
lsİ
->
»q_queued
 = 
çl£
;

668 
	`INIT_LIST_HEAD
(&
lsİ
->
l¤eq_li¡
);

669 
	`š™_com¶‘iÚ
(&
lsİ
->
ls_dÚe
);

671 
l¤eq
->
rq¡dma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
dev
,†¤eq->
rq¡addr
,

672 
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
,

673 
DMA_BIDIRECTIONAL
);

674 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
dev
, 
l¤eq
->
rq¡dma
)) {

675 
	`nvme_fc_ù¾_put
(
ù¾
);

676 
	`dev_”r
(
ù¾
->
dev
,

678  -
EFAULT
;

680 
l¤eq
->
r¥dma
 =†¤eq->
rq¡dma
 +†¤eq->
rq¡Ën
;

682 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

684 
	`li¡_add_
(&
lsİ
->
l¤eq_li¡
, &
ù¾
->
ls_»q_li¡
);

686 
lsİ
->
»q_queued
 = 
Œue
;

688 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

690 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`ls_»q
(&ù¾->ÍÜt->
loÿÍÜt
,

691 &
ù¾
->
½Üt
->
»mÙ•Üt
, 
l¤eq
);

692 ià(
»t
)

693 
lsİ
->
ls_”rÜ
 = 
»t
;

695  
»t
;

696 
	}
}

699 
	$nvme_fc_£nd_ls_»q_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

701 
nvmefc_ls_»q_İ
 *
lsİ
 = 
	`ls_»q_to_lsİ
(
l¤eq
);

703 
lsİ
->
ls_”rÜ
 = 
¡©us
;

704 
	`com¶‘e
(&
lsİ
->
ls_dÚe
);

705 
	}
}

708 
	$nvme_fc_£nd_ls_»q
(
nvme_fc_ù¾
 *
ù¾
, 
nvmefc_ls_»q_İ
 *
lsİ
)

710 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

711 
fúvme_ls_rjt
 *
rjt
 = 
l¤eq
->
r¥addr
;

712 
»t
;

714 
»t
 = 
	`__nvme_fc_£nd_ls_»q
(
ù¾
, 
lsİ
, 
nvme_fc_£nd_ls_»q_dÚe
);

716 ià(!
»t
)

723 
	`wa™_fÜ_com¶‘iÚ
(&
lsİ
->
ls_dÚe
);

725 
	`__nvme_fc_fšish_ls_»q
(
ù¾
, 
lsİ
);

727 ià(
»t
) {

728 
	`dev_”r
(
ù¾
->
dev
,

729 "l »que¡ commªd faed (%d).\n", 
»t
);

730  
»t
;

734 ià(
rjt
->
w0
.
ls_cmd
 =ğ
FCNVME_LS_RJT
)

735  -
ENXIO
;

738 
	}
}

741 
	$nvme_fc_£nd_ls_»q_async
(
nvme_fc_ù¾
 *
ù¾
,

742 
nvmefc_ls_»q_İ
 *
lsİ
,

743 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

745 
»t
;

747 
»t
 = 
	`__nvme_fc_£nd_ls_»q
(
ù¾
, 
lsİ
, 
dÚe
);

751 ià(
»t
)

752 
	`dÚe
(&
lsİ
->
ls_»q
, 
»t
);

753 
	}
}

757 
	mVERR_NO_ERROR
 = 0,

758 
	mVERR_LSACC
 = 1,

759 
	mVERR_LSDESC_RQST
 = 2,

760 
	mVERR_LSDESC_RQST_LEN
 = 3,

761 
	mVERR_ASSOC_ID
 = 4,

762 
	mVERR_ASSOC_ID_LEN
 = 5,

763 
	mVERR_CONN_ID
 = 6,

764 
	mVERR_CONN_ID_LEN
 = 7,

765 
	mVERR_CR_ASSOC
 = 8,

766 
	mVERR_CR_ASSOC_ACC_LEN
 = 9,

767 
	mVERR_CR_CONN
 = 10,

768 
	mVERR_CR_CONN_ACC_LEN
 = 11,

769 
	mVERR_DISCONN
 = 12,

770 
	mVERR_DISCONN_ACC_LEN
 = 13,

773 *
	gv®id©iÚ_”rÜs
[] = {

791 
	$nvme_fc_cÚÃù_admš_queue
(
nvme_fc_ù¾
 *
ù¾
,

792 
nvme_fc_queue
 *
queue
, 
u16
 
qsize
, u16 
”¥_¿tio
)

794 
nvmefc_ls_»q_İ
 *
lsİ
;

795 
nvmefc_ls_»q
 *
l¤eq
;

796 
fúvme_ls_ü_assoc_rq¡
 *
assoc_rq¡
;

797 
fúvme_ls_ü_assoc_acc
 *
assoc_acc
;

798 
»t
, 
fü‘
 = 0;

800 
lsİ
 = 
	`kz®loc
(((*lsop) +

801 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

802 (*
assoc_rq¡
è+ (*
assoc_acc
)), 
GFP_KERNEL
);

803 ià(!
lsİ
) {

804 
»t
 = -
ENOMEM
;

805 
out_no_memÜy
;

807 
l¤eq
 = &
lsİ
->
ls_»q
;

809 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

810 
assoc_rq¡
 = (
fúvme_ls_ü_assoc_rq¡
 *)

811 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

812 
assoc_acc
 = (
fúvme_ls_ü_assoc_acc
 *)&
assoc_rq¡
[1];

814 
assoc_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_ASSOCIATION
;

815 
assoc_rq¡
->
desc_li¡_Ën
 =

816 
	`ıu_to_be32
((
fúvme_lsdesc_ü_assoc_cmd
));

818 
assoc_rq¡
->
assoc_cmd
.
desc_g
 =

819 
	`ıu_to_be32
(
FCNVME_LSDESC_CREATE_ASSOC_CMD
);

820 
assoc_rq¡
->
assoc_cmd
.
desc_Ën
 =

821 
	`fúvme_lsdesc_Ën
(

822 (
fúvme_lsdesc_ü_assoc_cmd
));

824 
assoc_rq¡
->
assoc_cmd
.
”¥_¿tio
 = 
	`ıu_to_be16
(ersp_ratio);

825 
assoc_rq¡
->
assoc_cmd
.
sqsize
 = 
	`ıu_to_be16
(
qsize
);

827 
assoc_rq¡
->
assoc_cmd
.
úid
 = 
	`ıu_to_be16
(0xffff);

828 
	`memıy
(&
assoc_rq¡
->
assoc_cmd
.
ho¡id
, &
ù¾
->ù¾.
İts
->
ho¡
->
id
,

829 
	`mš_t
(
size_t
, 
FCNVME_ASSOC_HOSTID_LEN
, (
uuid_be
)));

830 
	`¡ºıy
(
assoc_rq¡
->
assoc_cmd
.
ho¡nqn
, 
ù¾
->ù¾.
İts
->
ho¡
->
nqn
,

831 
	`mš
(
FCNVME_ASSOC_HOSTNQN_LEN
, 
NVMF_NQN_SIZE
));

832 
	`¡ºıy
(
assoc_rq¡
->
assoc_cmd
.
subnqn
, 
ù¾
->ù¾.
İts
->
subsy¢qn
,

833 
	`mš
(
FCNVME_ASSOC_SUBNQN_LEN
, 
NVMF_NQN_SIZE
));

835 
lsİ
->
queue
 = queue;

836 
l¤eq
->
rq¡addr
 = 
assoc_rq¡
;

837 
l¤eq
->
rq¡Ën
 = (*
assoc_rq¡
);

838 
l¤eq
->
r¥addr
 = 
assoc_acc
;

839 
l¤eq
->
r¥Ën
 = (*
assoc_acc
);

840 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

842 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
, 
lsİ
);

843 ià(
»t
)

844 
out_ä“_bufãr
;

849 ià(
assoc_acc
->
hdr
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_ACC
)

850 
fü‘
 = 
VERR_LSACC
;

851 ià(
assoc_acc
->
hdr
.
desc_li¡_Ën
 !=

852 
	`fúvme_lsdesc_Ën
(

853 (
fúvme_ls_ü_assoc_acc
)))

854 
fü‘
 = 
VERR_CR_ASSOC_ACC_LEN
;

855 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_g
 !ğ
	`ıu_to_be32
(
FCNVME_LSDESC_RQST
))

856 
fü‘
 = 
VERR_LSDESC_RQST
;

857 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

858 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

859 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

860 ià(
assoc_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_CREATE_ASSOCIATION
)

861 
fü‘
 = 
VERR_CR_ASSOC
;

862 ià(
assoc_acc
->
associd
.
desc_g
 !=

863 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
))

864 
fü‘
 = 
VERR_ASSOC_ID
;

865 ià(
assoc_acc
->
associd
.
desc_Ën
 !=

866 
	`fúvme_lsdesc_Ën
(

867 (
fúvme_lsdesc_assoc_id
)))

868 
fü‘
 = 
VERR_ASSOC_ID_LEN
;

869 ià(
assoc_acc
->
cÚÃùid
.
desc_g
 !=

870 
	`ıu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

871 
fü‘
 = 
VERR_CONN_ID
;

872 ià(
assoc_acc
->
cÚÃùid
.
desc_Ën
 !=

873 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

874 
fü‘
 = 
VERR_CONN_ID_LEN
;

876 ià(
fü‘
) {

877 
»t
 = -
EBADF
;

878 
	`dev_”r
(
ù¾
->
dev
,

880 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

882 
ù¾
->
assocŸtiÚ_id
 =

883 
	`be64_to_ıu
(
assoc_acc
->
associd
.
assocŸtiÚ_id
);

884 
queue
->
cÚÃùiÚ_id
 =

885 
	`be64_to_ıu
(
assoc_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

886 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

889 
out_ä“_bufãr
:

890 
	`kä“
(
lsİ
);

891 
out_no_memÜy
:

892 ià(
»t
)

893 
	`dev_”r
(
ù¾
->
dev
,

895 
queue
->
qnum
, 
»t
);

896  
»t
;

897 
	}
}

900 
	$nvme_fc_cÚÃù_queue
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

901 
u16
 
qsize
, u16 
”¥_¿tio
)

903 
nvmefc_ls_»q_İ
 *
lsİ
;

904 
nvmefc_ls_»q
 *
l¤eq
;

905 
fúvme_ls_ü_cÚn_rq¡
 *
cÚn_rq¡
;

906 
fúvme_ls_ü_cÚn_acc
 *
cÚn_acc
;

907 
»t
, 
fü‘
 = 0;

909 
lsİ
 = 
	`kz®loc
(((*lsop) +

910 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

911 (*
cÚn_rq¡
è+ (*
cÚn_acc
)), 
GFP_KERNEL
);

912 ià(!
lsİ
) {

913 
»t
 = -
ENOMEM
;

914 
out_no_memÜy
;

916 
l¤eq
 = &
lsİ
->
ls_»q
;

918 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

919 
cÚn_rq¡
 = (
fúvme_ls_ü_cÚn_rq¡
 *)

920 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

921 
cÚn_acc
 = (
fúvme_ls_ü_cÚn_acc
 *)&
cÚn_rq¡
[1];

923 
cÚn_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_CONNECTION
;

924 
cÚn_rq¡
->
desc_li¡_Ën
 = 
	`ıu_to_be32
(

925 (
fúvme_lsdesc_assoc_id
) +

926 (
fúvme_lsdesc_ü_cÚn_cmd
));

928 
cÚn_rq¡
->
associd
.
desc_g
 = 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

929 
cÚn_rq¡
->
associd
.
desc_Ën
 =

930 
	`fúvme_lsdesc_Ën
(

931 (
fúvme_lsdesc_assoc_id
));

932 
cÚn_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ıu_to_be64
(
ù¾
->association_id);

933 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_g
 =

934 
	`ıu_to_be32
(
FCNVME_LSDESC_CREATE_CONN_CMD
);

935 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_Ën
 =

936 
	`fúvme_lsdesc_Ën
(

937 (
fúvme_lsdesc_ü_cÚn_cmd
));

938 
cÚn_rq¡
->
cÚÃù_cmd
.
”¥_¿tio
 = 
	`ıu_to_be16
(ersp_ratio);

939 
cÚn_rq¡
->
cÚÃù_cmd
.
qid
 = 
	`ıu_to_be16
(
queue
->
qnum
);

940 
cÚn_rq¡
->
cÚÃù_cmd
.
sqsize
 = 
	`ıu_to_be16
(
qsize
);

942 
lsİ
->
queue
 = queue;

943 
l¤eq
->
rq¡addr
 = 
cÚn_rq¡
;

944 
l¤eq
->
rq¡Ën
 = (*
cÚn_rq¡
);

945 
l¤eq
->
r¥addr
 = 
cÚn_acc
;

946 
l¤eq
->
r¥Ën
 = (*
cÚn_acc
);

947 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

949 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
, 
lsİ
);

950 ià(
»t
)

951 
out_ä“_bufãr
;

956 ià(
cÚn_acc
->
hdr
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_ACC
)

957 
fü‘
 = 
VERR_LSACC
;

958 ià(
cÚn_acc
->
hdr
.
desc_li¡_Ën
 !=

959 
	`fúvme_lsdesc_Ën
((
fúvme_ls_ü_cÚn_acc
)))

960 
fü‘
 = 
VERR_CR_CONN_ACC_LEN
;

961 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_g
 !ğ
	`ıu_to_be32
(
FCNVME_LSDESC_RQST
))

962 
fü‘
 = 
VERR_LSDESC_RQST
;

963 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

964 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

965 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

966 ià(
cÚn_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_CREATE_CONNECTION
)

967 
fü‘
 = 
VERR_CR_CONN
;

968 ià(
cÚn_acc
->
cÚÃùid
.
desc_g
 !=

969 
	`ıu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

970 
fü‘
 = 
VERR_CONN_ID
;

971 ià(
cÚn_acc
->
cÚÃùid
.
desc_Ën
 !=

972 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

973 
fü‘
 = 
VERR_CONN_ID_LEN
;

975 ià(
fü‘
) {

976 
»t
 = -
EBADF
;

977 
	`dev_”r
(
ù¾
->
dev
,

979 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

981 
queue
->
cÚÃùiÚ_id
 =

982 
	`be64_to_ıu
(
cÚn_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

983 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

986 
out_ä“_bufãr
:

987 
	`kä“
(
lsİ
);

988 
out_no_memÜy
:

989 ià(
»t
)

990 
	`dev_”r
(
ù¾
->
dev
,

992 
queue
->
qnum
, 
»t
);

993  
»t
;

994 
	}
}

997 
	$nvme_fc_discÚÃù_assoc_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

999 
nvmefc_ls_»q_İ
 *
lsİ
 = 
	`ls_»q_to_lsİ
(
l¤eq
);

1000 
nvme_fc_ù¾
 *
ù¾
 = 
lsİ
->ctrl;

1002 
	`__nvme_fc_fšish_ls_»q
(
ù¾
, 
lsİ
);

1004 ià(
¡©us
)

1005 
	`dev_”r
(
ù¾
->
dev
,

1007 
¡©us
);

1011 
	`kä“
(
lsİ
);

1012 
	}
}

1032 
	$nvme_fc_xmt_discÚÃù_assoc
(
nvme_fc_ù¾
 *
ù¾
)

1034 
fúvme_ls_discÚÃù_rq¡
 *
discÚ_rq¡
;

1035 
fúvme_ls_discÚÃù_acc
 *
discÚ_acc
;

1036 
nvmefc_ls_»q_İ
 *
lsİ
;

1037 
nvmefc_ls_»q
 *
l¤eq
;

1039 
lsİ
 = 
	`kz®loc
(((*lsop) +

1040 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

1041 (*
discÚ_rq¡
è+ (*
discÚ_acc
)),

1042 
GFP_KERNEL
);

1043 ià(!
lsİ
)

1047 
l¤eq
 = &
lsİ
->
ls_»q
;

1049 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

1050 
discÚ_rq¡
 = (
fúvme_ls_discÚÃù_rq¡
 *)

1051 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

1052 
discÚ_acc
 = (
fúvme_ls_discÚÃù_acc
 *)&
discÚ_rq¡
[1];

1054 
discÚ_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_DISCONNECT
;

1055 
discÚ_rq¡
->
desc_li¡_Ën
 = 
	`ıu_to_be32
(

1056 (
fúvme_lsdesc_assoc_id
) +

1057 (
fúvme_lsdesc_discÚn_cmd
));

1059 
discÚ_rq¡
->
associd
.
desc_g
 = 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1060 
discÚ_rq¡
->
associd
.
desc_Ën
 =

1061 
	`fúvme_lsdesc_Ën
(

1062 (
fúvme_lsdesc_assoc_id
));

1064 
discÚ_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ıu_to_be64
(
ù¾
->association_id);

1066 
discÚ_rq¡
->
discÚ_cmd
.
desc_g
 = 
	`ıu_to_be32
(

1067 
FCNVME_LSDESC_DISCONN_CMD
);

1068 
discÚ_rq¡
->
discÚ_cmd
.
desc_Ën
 =

1069 
	`fúvme_lsdesc_Ën
(

1070 (
fúvme_lsdesc_discÚn_cmd
));

1071 
discÚ_rq¡
->
discÚ_cmd
.
scİe
 = 
FCNVME_DISCONN_ASSOCIATION
;

1072 
discÚ_rq¡
->
discÚ_cmd
.
id
 = 
	`ıu_to_be64
(
ù¾
->
assocŸtiÚ_id
);

1074 
l¤eq
->
rq¡addr
 = 
discÚ_rq¡
;

1075 
l¤eq
->
rq¡Ën
 = (*
discÚ_rq¡
);

1076 
l¤eq
->
r¥addr
 = 
discÚ_acc
;

1077 
l¤eq
->
r¥Ën
 = (*
discÚ_acc
);

1078 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1080 
	`nvme_fc_£nd_ls_»q_async
(
ù¾
, 
lsİ
, 
nvme_fc_discÚÃù_assoc_dÚe
);

1083 
ù¾
->
assocŸtiÚ_id
 = 0;

1084 
	}
}

1091 
	$nvme_fc_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

1093 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1094 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1096 
	`mem£t
(
cmdiu
, 0, (*cmdiu));

1097 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1098 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1099 
cmdiu
->
iu_Ën
 = 
	`ıu_to_be16
((*cmdiuè/ (
u32
));

1100 
	`mem£t
(&
İ
->
r¥_iu
, 0, (op->rsp_iu));

1103 
	}
}

1106 
	$__nvme_fc_ex™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1107 
nvme_fc_fı_İ
 *
İ
)

1109 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
,

1110 (
İ
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1111 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
,

1112 (
İ
->
cmd_iu
), 
DMA_TO_DEVICE
);

1114 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_UNINIT
);

1115 
	}
}

1118 
	$nvme_fc_ex™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

1119 
hùx_idx
, 
rq_idx
)

1121 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1123  
	`__nvme_fc_ex™_»que¡
(
d©a
, 
İ
);

1124 
	}
}

1127 
	$nvme_fc_ex™_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1129 
nvme_fc_fı_İ
 *
«n_İ
 = 
ù¾
->
«n_İs
;

1130 
i
;

1132 
i
 = 0; i < 
NVME_FC_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1133 ià(
	`©omic_»ad
(&
«n_İ
->
¡©e
è=ğ
FCPOP_STATE_UNINIT
)

1135 
	`__nvme_fc_ex™_»que¡
(
ù¾
, 
«n_İ
);

1136 
	`nvme_fc_ù¾_put
(
ù¾
);

1138 
	}
}

1141 
	$nvme_fc_fıio_dÚe
(
nvmefc_fı_»q
 *
»q
)

1143 
nvme_fc_fı_İ
 *
İ
 = 
	`fı_»q_to_fı_İ
(
»q
);

1144 
»que¡
 *
rq
 = 
İ
->rq;

1145 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1146 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

1147 
nvme_fc_queue
 *
queue
 = 
İ
->queue;

1148 
nvme_com¶‘iÚ
 *
cqe
 = &
İ
->
r¥_iu
.cqe;

1149 
u16
 
¡©us
;

1180 
	`fc_dma_sync_sšgË_fÜ_ıu
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
,

1181 (
İ
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1183 ià(
	`©omic_»ad
(&
İ
->
¡©e
è=ğ
FCPOP_STATE_ABORTED
)

1184 
¡©us
 = 
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
;

1186 
¡©us
 = 
äeq
->status;

1193 ià(
¡©us
)

1194 
dÚe
;

1203 
äeq
->
rcv_r¥Ën
) {

1206 
NVME_FC_SIZEOF_ZEROS_RSP
:

1212 ià(
äeq
->
Œªsã¼ed_Ëngth
 !=

1213 
	`be32_to_ıu
(
İ
->
cmd_iu
.
d©a_Ën
)) {

1214 
¡©us
 = -
EIO
;

1215 
dÚe
;

1217 
İ
->
Äeq
.
»suÉ
.
u64
 = 0;

1220 (
nvme_fc_”¥_iu
):

1225 ià(
	`uÆik–y
(
	`be16_to_ıu
(
İ
->
r¥_iu
.
iu_Ën
) !=

1226 (
äeq
->
rcv_r¥Ën
 / 4) ||

1227 
	`be32_to_ıu
(
İ
->
r¥_iu
.
xäd_Ën
) !=

1228 
äeq
->
Œªsã¼ed_Ëngth
 ||

1229 
İ
->
rqno
 !ğ
	`Ë16_to_ıu
(
cqe
->
commªd_id
))) {

1230 
¡©us
 = -
EIO
;

1231 
dÚe
;

1233 
İ
->
Äeq
.
»suÉ
 = 
cqe
->result;

1234 
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

1238 
¡©us
 = -
EIO
;

1239 
dÚe
;

1242 
dÚe
:

1243 ià(!
queue
->
qnum
 && 
İ
->
rqno
 >ğ
AEN_CMDID_BASE
) {

1244 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
¡©us
,

1245 &
İ
->
Äeq
.
»suÉ
);

1246 
	`nvme_fc_ù¾_put
(
ù¾
);

1250 
	`blk_mq_com¶‘e_»que¡
(
rq
, 
¡©us
);

1251 
	}
}

1254 
	$__nvme_fc_š™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1255 
nvme_fc_queue
 *
queue
, 
nvme_fc_fı_İ
 *
İ
,

1256 
»que¡
 *
rq
, 
u32
 
rqno
)

1258 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1259 
»t
 = 0;

1261 
	`mem£t
(
İ
, 0, (*op));

1262 
İ
->
fı_»q
.
cmdaddr
 = &İ->
cmd_iu
;

1263 
İ
->
fı_»q
.
cmdËn
 = (İ->
cmd_iu
);

1264 
İ
->
fı_»q
.
r¥addr
 = &İ->
r¥_iu
;

1265 
İ
->
fı_»q
.
r¥Ën
 = (İ->
r¥_iu
);

1266 
İ
->
fı_»q
.
dÚe
 = 
nvme_fc_fıio_dÚe
;

1267 
İ
->
fı_»q
.
fœ¡_sgl
 = (
sÿ‰”li¡
 *)&op[1];

1268 
İ
->
fı_»q
.
´iv©e
 = &İ->fı_»q.
fœ¡_sgl
[
SG_CHUNK_SIZE
];

1269 
İ
->
ù¾
 = ctrl;

1270 
İ
->
queue
 = queue;

1271 
İ
->
rq
 =„q;

1272 
İ
->
rqno
 =„qno;

1274 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1275 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1276 
cmdiu
->
iu_Ën
 = 
	`ıu_to_be16
((*cmdiuè/ (
u32
));

1278 
İ
->
fı_»q
.
cmddma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1279 &
İ
->
cmd_iu
, (İ->cmd_iu), 
DMA_TO_DEVICE
);

1280 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
)) {

1281 
	`dev_”r
(
ù¾
->
dev
,

1283 
»t
 = 
EFAULT
;

1284 
out_Ú_”rÜ
;

1287 
İ
->
fı_»q
.
r¥dma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1288 &
İ
->
r¥_iu
, (op->rsp_iu),

1289 
DMA_FROM_DEVICE
);

1290 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
)) {

1291 
	`dev_”r
(
ù¾
->
dev
,

1293 
»t
 = 
EFAULT
;

1296 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

1297 
out_Ú_”rÜ
:

1298  
»t
;

1299 
	}
}

1302 
	$nvme_fc_š™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

1303 
hùx_idx
, 
rq_idx
,

1304 
numa_node
)

1306 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1307 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1308 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
+1];

1310  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
İ
, 
rq
, queue->
rqút
++);

1311 
	}
}

1314 
	$nvme_fc_š™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

1315 
hùx_idx
, 
rq_idx
,

1316 
numa_node
)

1318 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1319 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1320 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[0];

1322  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
İ
, 
rq
, queue->
rqút
++);

1323 
	}
}

1326 
	$nvme_fc_š™_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1328 
nvme_fc_fı_İ
 *
«n_İ
;

1329 
nvme_fc_cmd_iu
 *
cmdiu
;

1330 
nvme_commªd
 *
sqe
;

1331 
i
, 
»t
;

1333 
«n_İ
 = 
ù¾
->
«n_İs
;

1334 
i
 = 0; i < 
NVME_FC_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1335 
cmdiu
 = &
«n_İ
->
cmd_iu
;

1336 
sqe
 = &
cmdiu
->sqe;

1337 
»t
 = 
	`__nvme_fc_š™_»que¡
(
ù¾
, &ù¾->
queues
[0],

1338 
«n_İ
, (
»que¡
 *)
NULL
,

1339 (
AEN_CMDID_BASE
 + 
i
));

1340 ià(
»t
)

1341  
»t
;

1343 
	`mem£t
(
sqe
, 0, (*sqe));

1344 
sqe
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1345 
sqe
->
commÚ
.
commªd_id
 = 
AEN_CMDID_BASE
 + 
i
;

1348 
	}
}

1351 
šlše
 

1352 
	$__nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
nvme_fc_ù¾
 *
ù¾
,

1353 
qidx
)

1355 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
qidx
];

1357 
hùx
->
driv”_d©a
 = 
queue
;

1358 
queue
->
hùx
 = hctx;

1359 
	}
}

1362 
	$nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1363 
hùx_idx
)

1365 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1367 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
 + 1);

1370 
	}
}

1373 
	$nvme_fc_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1374 
hùx_idx
)

1376 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1378 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
);

1381 
	}
}

1384 
	$nvme_fc_š™_queue
(
nvme_fc_ù¾
 *
ù¾
, 
idx
, 
size_t
 
queue_size
)

1386 
nvme_fc_queue
 *
queue
;

1388 
queue
 = &
ù¾
->
queues
[
idx
];

1389 
	`mem£t
(
queue
, 0, (*queue));

1390 
queue
->
ù¾
 = ctrl;

1391 
queue
->
qnum
 = 
idx
;

1392 
	`©omic_£t
(&
queue
->
c¢
, 1);

1393 
queue
->
dev
 = 
ù¾
->dev;

1395 ià(
idx
 > 0)

1396 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

1398 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

1400 
queue
->
queue_size
 = queue_size;

1412 
	}
}

1423 
	$nvme_fc_ä“_queue
(
nvme_fc_queue
 *
queue
)

1425 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
))

1434 
queue
->
cÚÃùiÚ_id
 = 0;

1435 
	`ş—r_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1436 
	}
}

1439 
	$__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1440 
nvme_fc_queue
 *
queue
, 
qidx
)

1442 ià(
ù¾
->
ÍÜt
->
İs
->
d–‘e_queue
)

1443 
ù¾
->
ÍÜt
->
İs
->
	`d–‘e_queue
(&ù¾->ÍÜt->
loÿÍÜt
, 
qidx
,

1444 
queue
->
Îdd_hªdË
);

1445 
queue
->
Îdd_hªdË
 = 
NULL
;

1446 
	}
}

1449 
	$nvme_fc_de¡roy_admš_queue
(
nvme_fc_ù¾
 *
ù¾
)

1451 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

1452 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

1453 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

1454 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

1455 
	}
}

1458 
	$nvme_fc_ä“_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1460 
i
;

1462 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++)

1463 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[
i
]);

1464 
	}
}

1467 
	$__nvme_fc_ü—‹_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1468 
nvme_fc_queue
 *
queue
, 
qidx
, 
u16
 
qsize
)

1470 
»t
 = 0;

1472 
queue
->
Îdd_hªdË
 = 
NULL
;

1473 ià(
ù¾
->
ÍÜt
->
İs
->
ü—‹_queue
)

1474 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`ü—‹_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

1475 
qidx
, 
qsize
, &
queue
->
Îdd_hªdË
);

1477  
»t
;

1478 
	}
}

1481 
	$nvme_fc_d–‘e_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1483 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[ù¾->
queue_couÁ
 - 1];

1484 
i
;

1486 
i
 = 
ù¾
->
queue_couÁ
 - 1; i >ğ1; i--, 
queue
--)

1487 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, 
queue
, 
i
);

1488 
	}
}

1491 
	$nvme_fc_ü—‹_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

1493 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[1];

1494 
i
, 
»t
;

1496 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++, 
queue
++) {

1497 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, 
queue
, 
i
, 
qsize
);

1498 ià(
»t
)

1499 
d–‘e_queues
;

1504 
d–‘e_queues
:

1505 ; 
i
 >= 0; i--)

1506 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[
i
], i);

1507  
»t
;

1508 
	}
}

1511 
	$nvme_fc_cÚÃù_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

1513 
i
, 
»t
 = 0;

1515 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++) {

1516 
»t
 = 
	`nvme_fc_cÚÃù_queue
(
ù¾
, &ù¾->
queues
[
i
], 
qsize
,

1517 (
qsize
 / 5));

1518 ià(
»t
)

1520 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

1521 ià(
»t
)

1525  
»t
;

1526 
	}
}

1529 
	$nvme_fc_š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1531 
i
;

1533 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++)

1534 
	`nvme_fc_š™_queue
(
ù¾
, 
i
, cŒl->ù¾.
sqsize
);

1535 
	}
}

1538 
	$nvme_fc_ù¾_ä“
(
k»f
 *
»f
)

1540 
nvme_fc_ù¾
 *
ù¾
 =

1541 
	`cÚš”_of
(
»f
, 
nvme_fc_ù¾
,„ef);

1542 
æags
;

1544 ià(
ù¾
->
¡©e
 !ğ
FCCTRL_INIT
) {

1546 
	`¥š_lock_œq§ve
(&
ù¾
->
½Üt
->
lock
, 
æags
);

1547 
	`li¡_d–
(&
ù¾
->
ù¾_li¡
);

1548 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
½Üt
->
lock
, 
æags
);

1551 
	`put_deviû
(
ù¾
->
dev
);

1552 
	`nvme_fc_½Üt_put
(
ù¾
->
½Üt
);

1554 
	`kä“
(
ù¾
->
queues
);

1555 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

1556 
	`nvmf_ä“_İtiÚs
(
ù¾
->ù¾.
İts
);

1557 
	`kä“
(
ù¾
);

1558 
	}
}

1561 
	$nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *
ù¾
)

1563 
	`k»f_put
(&
ù¾
->
»f
, 
nvme_fc_ù¾_ä“
);

1564 
	}
}

1567 
	$nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *
ù¾
)

1569  
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
»f
);

1570 
	}
}

1577 
	$nvme_fc_ä“_nvme_ù¾
(
nvme_ù¾
 *
nù¾
)

1579 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

1581 
	`WARN_ON
(
nù¾
 !ğ&
ù¾
->ctrl);

1588 ià(
ù¾
->
¡©e
 !ğ
FCCTRL_INIT
) {

1590 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

1592 ià(
ù¾
->ù¾.
g£t
) {

1593 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1594 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1595 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

1596 
	`nvme_fc_ä“_io_queues
(
ù¾
);

1599 
	`nvme_fc_ex™_«n_İs
(
ù¾
);

1601 
	`nvme_fc_de¡roy_admš_queue
(
ù¾
);

1604 
	`nvme_fc_ù¾_put
(
ù¾
);

1605 
	}
}

1609 
	$__nvme_fc_abÜt_İ
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_fı_İ
 *
İ
)

1611 
¡©e
;

1613 
¡©e
 = 
	`©omic_xchg
(&
İ
->¡©e, 
FCPOP_STATE_ABORTED
);

1614 ià(
¡©e
 !ğ
FCPOP_STATE_ACTIVE
) {

1615 
	`©omic_£t
(&
İ
->
¡©e
, state);

1616  -
ECANCELED
;

1619 
ù¾
->
ÍÜt
->
İs
->
	`fı_abÜt
(&ù¾->ÍÜt->
loÿÍÜt
,

1620 &
ù¾
->
½Üt
->
»mÙ•Üt
,

1621 
İ
->
queue
->
Îdd_hªdË
,

1622 &
İ
->
fı_»q
);

1625 
	}
}

1627 
blk_eh_tim”_»tuº


1628 
	$nvme_fc_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

1630 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1631 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

1632 
»t
;

1634 ià(
»£rved
)

1635  
BLK_EH_RESET_TIMER
;

1637 
»t
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
İ
);

1638 ià(
»t
)

1640  
BLK_EH_HANDLED
;

1649  
BLK_EH_HANDLED
;

1650 
	}
}

1653 
	$nvme_fc_m­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

1654 
nvme_fc_fı_İ
 *
İ
)

1656 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1657 
u32
 
m­_Ën
 = 
	`nvme_m­_Ën
(
rq
);

1658 
dma_d©a_dœeùiÚ
 
dœ
;

1659 
»t
;

1661 
äeq
->
sg_út
 = 0;

1663 ià(!
m­_Ën
)

1666 
äeq
->
sg_bË
.
sgl
 = f»q->
fœ¡_sgl
;

1667 
»t
 = 
	`sg_®loc_bË_chašed
(&
äeq
->
sg_bË
, 
rq
->
Ä_phys_£gm’ts
,

1668 
GFP_ATOMIC
, 
äeq
->
sg_bË
.
sgl
);

1669 ià(
»t
)

1670  -
ENOMEM
;

1672 
İ
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q, 
äeq
->
sg_bË
.
sgl
);

1673 
	`WARN_ON
(
İ
->
ÃÁs
 > 
rq
->
Ä_phys_£gm’ts
);

1674 
dœ
 = (
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

1675 
äeq
->
sg_út
 = 
	`fc_dma_m­_sg
(
ù¾
->
ÍÜt
->
dev
, f»q->
sg_bË
.
sgl
,

1676 
İ
->
ÃÁs
, 
dœ
);

1677 ià(
	`uÆik–y
(
äeq
->
sg_út
 <= 0)) {

1678 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

1679 
äeq
->
sg_út
 = 0;

1680  -
EFAULT
;

1687 
	}
}

1690 
	$nvme_fc_unm­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

1691 
nvme_fc_fı_İ
 *
İ
)

1693 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1695 ià(!
äeq
->
sg_út
)

1698 
	`fc_dma_unm­_sg
(
ù¾
->
ÍÜt
->
dev
, 
äeq
->
sg_bË
.
sgl
, 
İ
->
ÃÁs
,

1699 ((
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
) ?

1700 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
));

1702 
	`nvme_ş—nup_cmd
(
rq
);

1704 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

1706 
äeq
->
sg_út
 = 0;

1707 
	}
}

1733 
	$nvme_fc_¡¬t_fı_İ
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

1734 
nvme_fc_fı_İ
 *
İ
, 
u32
 
d©a_Ën
,

1735 
nvmefc_fı_d©adœ
 
io_dœ
)

1737 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1738 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

1739 
u32
 
c¢
;

1740 
»t
;

1742 ià(!
	`nvme_fc_ù¾_g‘
(
ù¾
))

1743  
BLK_MQ_RQ_QUEUE_ERROR
;

1746 
cmdiu
->
cÚÃùiÚ_id
 = 
	`ıu_to_be64
(
queue
->connection_id);

1747 
c¢
 = 
	`©omic_šc_»tuº
(&
queue
->csn);

1748 
cmdiu
->
c¢
 = 
	`ıu_to_be32
(csn);

1749 
cmdiu
->
d©a_Ën
 = 
	`ıu_to_be32
(data_len);

1750 
io_dœ
) {

1751 
NVMEFC_FCP_WRITE
:

1752 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_WRITE
;

1754 
NVMEFC_FCP_READ
:

1755 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_READ
;

1757 
NVMEFC_FCP_NODATA
:

1758 
cmdiu
->
æags
 = 0;

1761 
İ
->
fı_»q
.
·ylßd_Ëngth
 = 
d©a_Ën
;

1762 
İ
->
fı_»q
.
io_dœ
 = io_dir;

1763 
İ
->
fı_»q
.
Œªsã¼ed_Ëngth
 = 0;

1764 
İ
->
fı_»q
.
rcv_r¥Ën
 = 0;

1765 
İ
->
fı_»q
.
¡©us
 = 0;

1766 
İ
->
fı_»q
.
sqid
 = 
	`ıu_to_Ë16
(
queue
->
qnum
);

1772 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
m‘ad©a
);

1773 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
d±r
.
´p1
);

1774 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
d±r
.
´p2
);

1775 
sqe
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1782 
sqe
->
rw
.
d±r
.
sgl
.
ty³
 = 
NVME_SGL_FMT_OFFSET
;

1783 
sqe
->
rw
.
d±r
.
sgl
.
Ëngth
 = 
	`ıu_to_Ë32
(
d©a_Ën
);

1784 
sqe
->
rw
.
d±r
.
sgl
.
addr
 = 0;

1787 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
commªd_id
 !ğ
	`ıu_to_Ë16
(
İ
->
rqno
));

1789 ià(
İ
->
rq
) {

1790 
»t
 = 
	`nvme_fc_m­_d©a
(
ù¾
, 
İ
->
rq
, op);

1791 ià(
»t
 < 0) {

1792 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1793 "FaedØm­ d©¨(%d)\n", 
»t
);

1794 
	`nvme_ş—nup_cmd
(
İ
->
rq
);

1795 
	`nvme_fc_ù¾_put
(
ù¾
);

1796  (
»t
 =ğ-
ENOMEM
 ||„‘ =ğ-
EAGAIN
) ?

1797 
BLK_MQ_RQ_QUEUE_BUSY
 : 
BLK_MQ_RQ_QUEUE_ERROR
;

1801 
	`fc_dma_sync_sšgË_fÜ_deviû
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
,

1802 (
İ
->
cmd_iu
), 
DMA_TO_DEVICE
);

1804 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_ACTIVE
);

1806 ià(
İ
->
rq
)

1807 
	`blk_mq_¡¬t_»que¡
(
İ
->
rq
);

1809 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`fı_io
(&ù¾->ÍÜt->
loÿÍÜt
,

1810 &
ù¾
->
½Üt
->
»mÙ•Üt
,

1811 
queue
->
Îdd_hªdË
, &
İ
->
fı_»q
);

1813 ià(
»t
) {

1814 
	`dev_”r
(
ù¾
->
dev
,

1815 "S’d‚vmcommªd faed -†ldd„‘uºed %d.\n", 
»t
);

1817 ià(
İ
->
rq
) {

1818 
	`nvme_fc_unm­_d©a
(
ù¾
, 
İ
->
rq
, op);

1819 
	`nvme_ş—nup_cmd
(
İ
->
rq
);

1823 
	`nvme_fc_ù¾_put
(
ù¾
);

1825 ià(
»t
 !ğ-
EBUSY
)

1826  
BLK_MQ_RQ_QUEUE_ERROR
;

1828 ià(
İ
->
rq
) {

1829 
	`blk_mq_¡İ_hw_queues
(
İ
->
rq
->
q
);

1830 
	`blk_mq_d–ay_queue
(
queue
->
hùx
, 
NVMEFC_QUEUE_DELAY
);

1832  
BLK_MQ_RQ_QUEUE_BUSY
;

1835  
BLK_MQ_RQ_QUEUE_OK
;

1836 
	}
}

1839 
	$nvme_fc_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1840 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1842 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1843 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1844 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

1845 
»que¡
 *
rq
 = 
bd
->rq;

1846 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1847 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1848 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

1849 
nvmefc_fı_d©adœ
 
io_dœ
;

1850 
u32
 
d©a_Ën
;

1851 
»t
;

1853 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
sqe
);

1854 ià(
»t
)

1855  
»t
;

1857 
d©a_Ën
 = 
	`nvme_m­_Ën
(
rq
);

1858 ià(
d©a_Ën
)

1859 
io_dœ
 = ((
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
) ?

1860 
NVMEFC_FCP_WRITE
 : 
NVMEFC_FCP_READ
);

1862 
io_dœ
 = 
NVMEFC_FCP_NODATA
;

1864  
	`nvme_fc_¡¬t_fı_İ
(
ù¾
, 
queue
, 
İ
, 
d©a_Ën
, 
io_dœ
);

1865 
	}
}

1868 
	$nvme_fc_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
, 
«r_idx
)

1870 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
¬g
);

1871 
nvme_fc_fı_İ
 *
«n_İ
;

1872 
»t
;

1874 ià(
«r_idx
 > 
NVME_FC_NR_AEN_COMMANDS
)

1877 
«n_İ
 = &
ù¾
->
«n_İs
[
«r_idx
];

1879 
»t
 = 
	`nvme_fc_¡¬t_fı_İ
(
ù¾
, 
«n_İ
->
queue
,‡en_op, 0,

1880 
NVMEFC_FCP_NODATA
);

1881 ià(
»t
)

1882 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1883 "çed‡synøev’ˆwÜk [%d]\n", 
«r_idx
);

1884 
	}
}

1887 
	$nvme_fc_com¶‘e_rq
(
»que¡
 *
rq
)

1889 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1890 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

1891 
”rÜ
 = 0, 
¡©e
;

1893 
¡©e
 = 
	`©omic_xchg
(&
İ
->¡©e, 
FCPOP_STATE_IDLE
);

1895 
	`nvme_ş—nup_cmd
(
rq
);

1897 
	`nvme_fc_unm­_d©a
(
ù¾
, 
rq
, 
İ
);

1899 ià(
	`uÆik–y
(
rq
->
”rÜs
)) {

1900 ià(
	`nvme_»q_Ãeds_»Œy
(
rq
,„q->
”rÜs
)) {

1901 
	`nvme_»queue_»q
(
rq
);

1905 ià(
rq
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

1906 
”rÜ
 = 
rq
->
”rÜs
;

1908 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
rq
->
”rÜs
);

1911 
	`nvme_fc_ù¾_put
(
ù¾
);

1913 
	`blk_mq_’d_»que¡
(
rq
, 
”rÜ
);

1914 
	}
}

1916 
blk_mq_İs
 
	gnvme_fc_mq_İs
 = {

1917 .
queue_rq
 = 
nvme_fc_queue_rq
,

1918 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

1919 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

1920 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

1921 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

1922 .
	gš™_hùx
 = 
nvme_fc_š™_hùx
,

1923 .
	gtimeout
 = 
nvme_fc_timeout
,

1926 
blk_mq_İs
 
	gnvme_fc_admš_mq_İs
 = {

1927 .
queue_rq
 = 
nvme_fc_queue_rq
,

1928 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

1929 .
	gš™_»que¡
 = 
nvme_fc_š™_admš_»que¡
,

1930 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

1931 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

1932 .
	gš™_hùx
 = 
nvme_fc_š™_admš_hùx
,

1933 .
	gtimeout
 = 
nvme_fc_timeout
,

1937 
	$nvme_fc_cÚfigu»_admš_queue
(
nvme_fc_ù¾
 *
ù¾
)

1939 
u32
 
£gs
;

1940 
”rÜ
;

1942 
	`nvme_fc_š™_queue
(
ù¾
, 0, 
NVME_FC_AQ_BLKMQ_DEPTH
);

1944 
”rÜ
 = 
	`nvme_fc_cÚÃù_admš_queue
(
ù¾
, &ù¾->
queues
[0],

1945 
NVME_FC_AQ_BLKMQ_DEPTH
,

1946 (
NVME_FC_AQ_BLKMQ_DEPTH
 / 4));

1947 ià(
”rÜ
)

1948  
”rÜ
;

1950 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

1951 
ù¾
->
admš_g_£t
.
İs
 = &
nvme_fc_admš_mq_İs
;

1952 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_FC_AQ_BLKMQ_DEPTH
;

1953 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

1954 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1955 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_fc_fı_İ
) +

1956 (
SG_CHUNK_SIZE
 *

1957 (
sÿ‰”li¡
)) +

1958 
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
;

1959 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

1960 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

1961 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1963 
”rÜ
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

1964 ià(
”rÜ
)

1965 
out_ä“_queue
;

1967 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

1968 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

1969 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

1970 
out_ä“_g£t
;

1973 
”rÜ
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0,

1974 
NVME_FC_AQ_BLKMQ_DEPTH
);

1975 ià(
”rÜ
)

1976 
out_ş—nup_queue
;

1978 
”rÜ
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

1979 ià(
”rÜ
)

1980 
out_d–‘e_hw_queue
;

1982 
”rÜ
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
, &ù¾->
ÿp
);

1983 ià(
”rÜ
) {

1984 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1986 
out_d–‘e_hw_queue
;

1989 
ù¾
->ù¾.
sqsize
 =

1990 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->
ÿp
è+ 1, cŒl->ù¾.
sqsize
);

1992 
”rÜ
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->
ÿp
);

1993 ià(
”rÜ
)

1994 
out_d–‘e_hw_queue
;

1996 
£gs
 = 
	`mš_t
(
u32
, 
NVME_FC_MAX_SEGMENTS
,

1997 
ù¾
->
ÍÜt
->
İs
->
max_sgl_£gm’ts
);

1998 
ù¾
->ù¾.
max_hw_£ùÜs
 = (
£gs
 - 1è<< (
PAGE_SHIFT
 - 9);

2000 
”rÜ
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

2001 ià(
”rÜ
)

2002 
out_d–‘e_hw_queue
;

2004 
	`nvme_¡¬t_k“p_®ive
(&
ù¾
->ctrl);

2008 
out_d–‘e_hw_queue
:

2009 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2010 
out_ş—nup_queue
:

2011 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

2012 
out_ä“_g£t
:

2013 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

2014 
out_ä“_queue
:

2015 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2016  
”rÜ
;

2017 
	}
}

2033 
	$nvme_fc_‹rmš©e_exchªge
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

2035 
nvme_ù¾
 *
nù¾
 = 
d©a
;

2036 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2037 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2038 
¡©us
;

2040 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

2044 
¡©us
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
İ
);

2050 ià(
¡©us
)

2054 
	}
}

2063 
	$nvme_fc_shutdown_ù¾
(
nvme_fc_ù¾
 *
ù¾
)

2077 ià(
ù¾
->
queue_couÁ
 > 1) {

2078 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

2079 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

2080 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2083 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
)

2084 
	`nvme_shutdown_ù¾
(&
ù¾
->ctrl);

2091 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

2092 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

2093 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2094 
	}
}

2101 
	$__nvme_fc_»move_ù¾
(
nvme_fc_ù¾
 *
ù¾
)

2103 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

2106 
	`nvme_fc_shutdown_ù¾
(
ù¾
);

2115 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

2117 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2118 
	}
}

2121 
	$nvme_fc_d–_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2123 
nvme_fc_ù¾
 *
ù¾
 =

2124 
	`cÚš”_of
(
wÜk
, 
nvme_fc_ù¾
, 
d–‘e_wÜk
);

2126 
	`__nvme_fc_»move_ù¾
(
ù¾
);

2127 
	}
}

2130 
	$__nvme_fc_d–_ù¾
(
nvme_fc_ù¾
 *
ù¾
)

2132 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_DELETING
))

2133  -
EBUSY
;

2135 ià(!
	`queue_wÜk
(
nvme_fc_wq
, &
ù¾
->
d–‘e_wÜk
))

2136  -
EBUSY
;

2139 
	}
}

2145 
	$nvme_fc_d–_nvme_ù¾
(
nvme_ù¾
 *
nù¾
)

2147 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2148 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2149 
æags
;

2150 
»t
;

2152 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

2153 
»t
 = 
	`__nvme_fc_d–_ù¾
(
ù¾
);

2154 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

2155 ià(
»t
)

2156  
»t
;

2158 
	`æush_wÜk
(&
ù¾
->
d–‘e_wÜk
);

2161 
	}
}

2164 
	$nvme_fc_»£t_nvme_ù¾
(
nvme_ù¾
 *
nù¾
)

2166  -
EIO
;

2167 
	}
}

2169 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_fc_ù¾_İs
 = {

2170 .
Çme
 = "fc",

2171 .
	gmoduË
 = 
THIS_MODULE
,

2172 .
	gis_çbrics
 = 
Œue
,

2173 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

2174 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

2175 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

2176 .
	g»£t_ù¾
 = 
nvme_fc_»£t_nvme_ù¾
,

2177 .
	gä“_ù¾
 = 
nvme_fc_ä“_nvme_ù¾
,

2178 .
	gsubm™_async_ev’t
 = 
nvme_fc_subm™_async_ev’t
,

2179 .
	gd–‘e_ù¾
 = 
nvme_fc_d–_nvme_ù¾
,

2180 .
	gg‘_subsy¢qn
 = 
nvmf_g‘_subsy¢qn
,

2181 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

2185 
	$nvme_fc_ü—‹_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2187 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2188 
»t
;

2190 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
İts
->
Ä_io_queues
);

2191 ià(
»t
) {

2192 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2193 "£t_queue_couÁ faed: %d\n", 
»t
);

2194  
»t
;

2197 
ù¾
->
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

2198 ià(!
İts
->
Ä_io_queues
)

2201 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "creating %d I/O queues.\n",

2202 
İts
->
Ä_io_queues
);

2204 
	`nvme_fc_š™_io_queues
(
ù¾
);

2206 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

2207 
ù¾
->
g_£t
.
İs
 = &
nvme_fc_mq_İs
;

2208 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
İts
->
queue_size
;

2209 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

2210 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

2211 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2212 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_fc_fı_İ
) +

2213 (
SG_CHUNK_SIZE
 *

2214 (
sÿ‰”li¡
)) +

2215 
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
;

2216 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

2217 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->
queue_couÁ
 - 1;

2218 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2220 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

2221 ià(
»t
)

2222  
»t
;

2224 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

2226 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

2227 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

2228 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

2229 
out_ä“_g_£t
;

2232 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2233 ià(
»t
)

2234 
out_ş—nup_blk_queue
;

2236 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2237 ià(
»t
)

2238 
out_d–‘e_hw_queues
;

2242 
out_d–‘e_hw_queues
:

2243 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2244 
out_ş—nup_blk_queue
:

2245 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

2246 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

2247 
out_ä“_g_£t
:

2248 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

2249 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2252 
ù¾
->ù¾.
g£t
 = 
NULL
;

2254  
»t
;

2255 
	}
}

2258 
nvme_ù¾
 *

2259 
	$__nvme_fc_ü—‹_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_İtiÚs
 *
İts
,

2260 
nvme_fc_ÍÜt
 *
ÍÜt
, 
nvme_fc_½Üt
 *
½Üt
)

2262 
nvme_fc_ù¾
 *
ù¾
;

2263 
æags
;

2264 
»t
, 
idx
;

2265 
boŞ
 
chªged
;

2267 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

2268 ià(!
ù¾
) {

2269 
»t
 = -
ENOMEM
;

2270 
out_ç
;

2273 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_ù¾_út
, 0, 0, 
GFP_KERNEL
);

2274 ià(
idx
 < 0) {

2275 
»t
 = -
ENOSPC
;

2276 
out_ä“_ù¾
;

2279 
ù¾
->ù¾.
İts
 = opts;

2280 
	`INIT_LIST_HEAD
(&
ù¾
->
ù¾_li¡
);

2281 
	`INIT_LIST_HEAD
(&
ù¾
->
ls_»q_li¡
);

2282 
ù¾
->
ÍÜt
 =†port;

2283 
ù¾
->
½Üt
 =„port;

2284 
ù¾
->
dev
 = 
ÍÜt
->dev;

2285 
ù¾
->
¡©e
 = 
FCCTRL_INIT
;

2286 
ù¾
->
úum
 = 
idx
;

2288 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_fc_ù¾_İs
, 0);

2289 ià(
»t
)

2290 
out_ä“_ida
;

2292 
	`g‘_deviû
(
ù¾
->
dev
);

2293 
	`k»f_š™
(&
ù¾
->
»f
);

2295 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_fc_d–_ù¾_wÜk
);

2296 
	`¥š_lock_š™
(&
ù¾
->
lock
);

2299 
ù¾
->
queue_couÁ
 = 
	`mš_t
(,

2300 
İts
->
Ä_io_queues
,

2301 
ÍÜt
->
İs
->
max_hw_queues
);

2302 
İts
->
Ä_io_queues
 = 
ù¾
->
queue_couÁ
;

2303 
ù¾
->
queue_couÁ
++;

2305 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

2306 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

2308 
»t
 = -
ENOMEM
;

2309 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->
queue_couÁ
, (
nvme_fc_queue
),

2310 
GFP_KERNEL
);

2311 ià(!
ù¾
->
queues
)

2312 
out_unš™_ù¾
;

2314 
»t
 = 
	`nvme_fc_cÚfigu»_admš_queue
(
ù¾
);

2315 ià(
»t
)

2316 
out_unš™_ù¾
;

2321 ià(
ù¾
->ù¾.
ioccsz
 != 4) {

2322 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "ioccsz %d is‚ot supported!\n",

2323 
ù¾
->ù¾.
ioccsz
);

2324 
out_»move_admš_queue
;

2327 ià(
ù¾
->ù¾.
iÜcsz
 != 1) {

2328 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "iorcsz %d is‚ot supported!\n",

2329 
ù¾
->ù¾.
iÜcsz
);

2330 
out_»move_admš_queue
;

2333 ià(
ù¾
->ù¾.
icdoff
) {

2334 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff %d is‚ot supported!\n",

2335 
ù¾
->ù¾.
icdoff
);

2336 
out_»move_admš_queue
;

2341 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

2343 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2346 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

2347 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

2350 
»t
 = 
	`nvme_fc_š™_«n_İs
(
ù¾
);

2351 ià(
»t
)

2352 
out_ex™_«n_İs
;

2354 ià(
ù¾
->
queue_couÁ
 > 1) {

2355 
»t
 = 
	`nvme_fc_ü—‹_io_queues
(
ù¾
);

2356 ià(
»t
)

2357 
out_ex™_«n_İs
;

2360 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2361 
ù¾
->
¡©e
 = 
FCCTRL_ACTIVE
;

2362 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2364 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

2365 
	`WARN_ON_ONCE
(!
chªged
);

2367 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2369 
ù¾
->
úum
, cŒl->ù¾.
İts
->
subsy¢qn
);

2371 
	`k»f_g‘
(&
ù¾
->ù¾.
k»f
);

2373 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

2374 
	`li¡_add_
(&
ù¾
->
ù¾_li¡
, &
½Üt
->ctrl_list);

2375 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

2377 ià(
İts
->
Ä_io_queues
) {

2378 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

2379 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

2382  &
ù¾
->ctrl;

2384 
out_ex™_«n_İs
:

2385 
	`nvme_fc_ex™_«n_İs
(
ù¾
);

2386 
out_»move_admš_queue
:

2388 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2389 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

2390 
	`nvme_fc_de¡roy_admš_queue
(
ù¾
);

2391 
out_unš™_ù¾
:

2392 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

2393 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2394 ià(
»t
 > 0)

2395 
»t
 = -
EIO
;

2397  
	`ERR_PTR
(
»t
);

2399 
out_ä“_ida
:

2400 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

2401 
out_ä“_ù¾
:

2402 
	`kä“
(
ù¾
);

2403 
out_ç
:

2404 
	`nvme_fc_½Üt_put
(
½Üt
);

2406  
	`ERR_PTR
(
»t
);

2407 
	}
}

2410 
	mFCT_TRADDR_ERR
 = 0,

2411 
	mFCT_TRADDR_WWNN
 = 1 << 0,

2412 
	mFCT_TRADDR_WWPN
 = 1 << 1,

2415 
	snvm‘_fc_Œaddr
 {

2416 
u64
 
	mÂ
;

2417 
u64
 
	m²
;

2420 cÚ¡ 
m©ch_bË_t
 
	gŒaddr_İt_tok’s
 = {

2421 { 
FCT_TRADDR_WWNN
, "nn-%s" },

2422 { 
FCT_TRADDR_WWPN
, "pn-%s" },

2423 { 
FCT_TRADDR_ERR
, 
NULL
 }

2427 
	$nvme_fc_·r£_add»ss
(
nvm‘_fc_Œaddr
 *
Œaddr
, *
buf
)

2429 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

2430 *
İtiÚs
, *
o
, *
p
;

2431 
tok’
, 
»t
 = 0;

2432 
u64
 
tok’64
;

2434 
İtiÚs
 = 
o
 = 
	`k¡rdup
(
buf
, 
GFP_KERNEL
);

2435 ià(!
İtiÚs
)

2436  -
ENOMEM
;

2438 (
p
 = 
	`¡r£p
(&
o
, ":\n")è!ğ
NULL
) {

2439 ià(!*
p
)

2442 
tok’
 = 
	`m©ch_tok’
(
p
, 
Œaddr_İt_tok’s
, 
¬gs
);

2443 
tok’
) {

2444 
FCT_TRADDR_WWNN
:

2445 ià(
	`m©ch_u64
(
¬gs
, &
tok’64
)) {

2446 
»t
 = -
EINVAL
;

2447 
out
;

2449 
Œaddr
->
Â
 = 
tok’64
;

2451 
FCT_TRADDR_WWPN
:

2452 ià(
	`m©ch_u64
(
¬gs
, &
tok’64
)) {

2453 
»t
 = -
EINVAL
;

2454 
out
;

2456 
Œaddr
->
²
 = 
tok’64
;

2459 
	`´_w¬n
("unknownraddroken or missing value '%s'\n",

2460 
p
);

2461 
»t
 = -
EINVAL
;

2462 
out
;

2466 
out
:

2467 
	`kä“
(
İtiÚs
);

2468  
»t
;

2469 
	}
}

2471 
nvme_ù¾
 *

2472 
	$nvme_fc_ü—‹_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_İtiÚs
 *
İts
)

2474 
nvme_fc_ÍÜt
 *
ÍÜt
;

2475 
nvme_fc_½Üt
 *
½Üt
;

2476 
nvm‘_fc_Œaddr
 
Ïddr
 = { 0L, 0L };

2477 
nvm‘_fc_Œaddr
 
¿ddr
 = { 0L, 0L };

2478 
æags
;

2479 
»t
;

2481 
»t
 = 
	`nvme_fc_·r£_add»ss
(&
¿ddr
, 
İts
->
Œaddr
);

2482 ià(
»t
 || !
¿ddr
.
Â
 || !¿ddr.
²
)

2483  
	`ERR_PTR
(-
EINVAL
);

2485 
»t
 = 
	`nvme_fc_·r£_add»ss
(&
Ïddr
, 
İts
->
ho¡_Œaddr
);

2486 ià(
»t
 || !
Ïddr
.
Â
 || !Ïddr.
²
)

2487  
	`ERR_PTR
(-
EINVAL
);

2490 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

2491 
	`li¡_fÜ_—ch_’Œy
(
ÍÜt
, &
nvme_fc_ÍÜt_li¡
, 
pÜt_li¡
) {

2492 ià(
ÍÜt
->
loÿÍÜt
.
node_Çme
 !ğ
Ïddr
.
Â
 ||

2493 
ÍÜt
->
loÿÍÜt
.
pÜt_Çme
 !ğ
Ïddr
.
²
)

2496 
	`li¡_fÜ_—ch_’Œy
(
½Üt
, &
ÍÜt
->
’dp_li¡
,ƒndp_list) {

2497 ià(
½Üt
->
»mÙ•Üt
.
node_Çme
 !ğ
¿ddr
.
Â
 ||

2498 
½Üt
->
»mÙ•Üt
.
pÜt_Çme
 !ğ
¿ddr
.
²
)

2502 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

2505 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

2507  
	`__nvme_fc_ü—‹_ù¾
(
dev
, 
İts
, 
ÍÜt
, 
½Üt
);

2510 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

2512  
	`ERR_PTR
(-
ENOENT
);

2513 
	}
}

2516 
nvmf_Œª¥Üt_İs
 
	gnvme_fc_Œª¥Üt
 = {

2517 .
Çme
 = "fc",

2518 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
 | 
NVMF_OPT_HOST_TRADDR
,

2519 .
	g®lowed_İts
 = 
NVMF_OPT_RECONNECT_DELAY
,

2520 .
	gü—‹_ù¾
 = 
nvme_fc_ü—‹_ù¾
,

2523 
__š™
 
	$nvme_fc_š™_moduË
()

2525 
	`m¬k_‹ch_´ev›w
("NVMov” FC", 
THIS_MODULE
);

2527 
nvme_fc_wq
 = 
	`ü—‹_wÜkqueue
("nvme_fc_wq");

2528 ià(!
nvme_fc_wq
)

2529  -
ENOMEM
;

2531 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

2533 
	}
}

2535 
__ex™
 
	$nvme_fc_ex™_moduË
()

2538 ià(!
	`li¡_em±y
(&
nvme_fc_ÍÜt_li¡
))

2539 
	`´_w¬n
("%s:†oÿÍÜˆli¡‚Ùƒm±y\n", 
__func__
);

2541 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

2543 
	`de¡roy_wÜkqueue
(
nvme_fc_wq
);

2545 
	`ida_de¡roy
(&
nvme_fc_loÿl_pÜt_út
);

2546 
	`ida_de¡roy
(&
nvme_fc_ù¾_út
);

2547 
	}
}

2549 
moduË_š™
(
nvme_fc_š™_moduË
);

2550 
moduË_ex™
(
nvme_fc_ex™_moduË
);

2552 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/linux_nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/uuid.h
>

22 
	#NVMF_NQN_FIELD_LEN
 256

	)

25 
	#NVMF_NQN_SIZE
 223

	)

27 
	#NVMF_TRSVCID_SIZE
 32

	)

28 
	#NVMF_TRADDR_SIZE
 256

	)

29 
	#NVMF_TSAS_SIZE
 256

	)

31 
	#NVME_DISC_SUBSYS_NAME
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

33 
	#NVME_RDMA_IP_PORT
 4420

	)

35 
	envme_subsys_ty³
 {

36 
	mNVME_NQN_DISC
 = 1,

37 
	mNVME_NQN_NVME
 = 2,

42 
	mNVMF_ADDR_FAMILY_PCI
 = 0,

43 
	mNVMF_ADDR_FAMILY_IP4
 = 1,

44 
	mNVMF_ADDR_FAMILY_IP6
 = 2,

45 
	mNVMF_ADDR_FAMILY_IB
 = 3,

46 
	mNVMF_ADDR_FAMILY_FC
 = 4,

51 
	mNVMF_TRTYPE_RDMA
 = 1,

52 
	mNVMF_TRTYPE_FC
 = 2,

53 
	mNVMF_TRTYPE_LOOP
 = 254,

54 
	mNVMF_TRTYPE_MAX
,

59 
	mNVMF_TREQ_NOT_SPECIFIED
 = 0,

60 
	mNVMF_TREQ_REQUIRED
 = 1,

61 
	mNVMF_TREQ_NOT_REQUIRED
 = 2,

68 
	mNVMF_RDMA_QPTYPE_CONNECTED
 = 1,

69 
	mNVMF_RDMA_QPTYPE_DATAGRAM
 = 2,

76 
	mNVMF_RDMA_PRTYPE_NOT_SPECIFIED
 = 1,

77 
	mNVMF_RDMA_PRTYPE_IB
 = 2,

78 
	mNVMF_RDMA_PRTYPE_ROCE
 = 3,

79 
	mNVMF_RDMA_PRTYPE_ROCEV2
 = 4,

80 
	mNVMF_RDMA_PRTYPE_IWARP
 = 5,

87 
	mNVMF_RDMA_CMS_RDMA_CM
 = 1,

90 
	#NVMF_AQ_DEPTH
 32

	)

93 
	mNVME_REG_CAP
 = 0x0000,

94 
	mNVME_REG_VS
 = 0x0008,

95 
	mNVME_REG_INTMS
 = 0x000c,

96 
	mNVME_REG_INTMC
 = 0x0010,

97 
	mNVME_REG_CC
 = 0x0014,

98 
	mNVME_REG_CSTS
 = 0x001c,

99 
	mNVME_REG_NSSR
 = 0x0020,

100 
	mNVME_REG_AQA
 = 0x0024,

101 
	mNVME_REG_ASQ
 = 0x0028,

102 
	mNVME_REG_ACQ
 = 0x0030,

103 
	mNVME_REG_CMBLOC
 = 0x0038,

104 
	mNVME_REG_CMBSZ
 = 0x003c,

107 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

108 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

109 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

110 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

111 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

112 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

114 
	#NVME_CMB_BIR
(
cmbloc
è((cmblocè& 0x7)

	)

115 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

116 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

117 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

119 
	#NVME_CMB_WDS
(
cmbsz
è((cmbszè& 0x10)

	)

120 
	#NVME_CMB_RDS
(
cmbsz
è((cmbszè& 0x8)

	)

121 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbszè& 0x4)

	)

122 
	#NVME_CMB_CQS
(
cmbsz
è((cmbszè& 0x2)

	)

123 
	#NVME_CMB_SQS
(
cmbsz
è((cmbszè& 0x1)

	)

129 
	#NVME_NVM_IOSQES
 6

	)

130 
	#NVME_NVM_IOCQES
 4

	)

133 
	mNVME_CC_ENABLE
 = 1 << 0,

134 
	mNVME_CC_CSS_NVM
 = 0 << 4,

135 
	mNVME_CC_MPS_SHIFT
 = 7,

136 
	mNVME_CC_ARB_RR
 = 0 << 11,

137 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

138 
	mNVME_CC_ARB_VS
 = 7 << 11,

139 
	mNVME_CC_SHN_NONE
 = 0 << 14,

140 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

141 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

142 
	mNVME_CC_SHN_MASK
 = 3 << 14,

143 
	mNVME_CC_IOSQES
 = 
NVME_NVM_IOSQES
 << 16,

144 
	mNVME_CC_IOCQES
 = 
NVME_NVM_IOCQES
 << 20,

145 
	mNVME_CSTS_RDY
 = 1 << 0,

146 
	mNVME_CSTS_CFS
 = 1 << 1,

147 
	mNVME_CSTS_NSSRO
 = 1 << 4,

148 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

149 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

150 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

151 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

154 
	snvme_id_pow”_¡©e
 {

155 
__Ë16
 
	mmax_pow”
;

156 
__u8
 
	mrsvd2
;

157 
__u8
 
	mæags
;

158 
__Ë32
 
	m’Œy_Ït
;

159 
__Ë32
 
	mex™_Ït
;

160 
__u8
 
	m»ad_ut
;

161 
__u8
 
	m»ad_Ït
;

162 
__u8
 
	mwr™e_ut
;

163 
__u8
 
	mwr™e_Ït
;

164 
__Ë16
 
	midË_pow”
;

165 
__u8
 
	midË_sÿË
;

166 
__u8
 
	mrsvd19
;

167 
__Ë16
 
	maùive_pow”
;

168 
__u8
 
	maùive_wÜk_sÿË
;

169 
__u8
 
	mrsvd23
[9];

173 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

174 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

177 
	snvme_id_ù¾
 {

178 
__Ë16
 
	mvid
;

179 
__Ë16
 
	mssvid
;

180 
	m¢
[20];

181 
	mmn
[40];

182 
	mä
[8];

183 
__u8
 
	m¿b
;

184 
__u8
 
	m›“
[3];

185 
__u8
 
	mcmic
;

186 
__u8
 
	mmdts
;

187 
__Ë16
 
	múid
;

188 
__Ë32
 
	mv”
;

189 
__Ë32
 
	m¹d3r
;

190 
__Ë32
 
	m¹d3e
;

191 
__Ë32
 
	mßes
;

192 
__Ë32
 
	mù¿‰
;

193 
__u8
 
	mrsvd100
[156];

194 
__Ë16
 
	mßcs
;

195 
__u8
 
	maş
;

196 
__u8
 
	m«¾
;

197 
__u8
 
	mämw
;

198 
__u8
 
	mÍa
;

199 
__u8
 
	m–³
;

200 
__u8
 
	mÅss
;

201 
__u8
 
	mavscc
;

202 
__u8
 
	m­¡a
;

203 
__Ë16
 
	mwùemp
;

204 
__Ë16
 
	mcùemp
;

205 
__Ë16
 
	mmtç
;

206 
__Ë32
 
	mhm´e
;

207 
__Ë32
 
	mhmmš
;

208 
__u8
 
	mŠvmÿp
[16];

209 
__u8
 
	munvmÿp
[16];

210 
__Ë32
 
	m½mbs
;

211 
__u8
 
	mrsvd316
[4];

212 
__Ë16
 
	mkas
;

213 
__u8
 
	mrsvd322
[190];

214 
__u8
 
	msqes
;

215 
__u8
 
	mcqes
;

216 
__Ë16
 
	mmaxcmd
;

217 
__Ë32
 
	mÂ
;

218 
__Ë16
 
	mÚcs
;

219 
__Ë16
 
	mfu£s
;

220 
__u8
 
	mâa
;

221 
__u8
 
	mvwc
;

222 
__Ë16
 
	mawun
;

223 
__Ë16
 
	mawupf
;

224 
__u8
 
	mnvscc
;

225 
__u8
 
	mrsvd531
;

226 
__Ë16
 
	macwu
;

227 
__u8
 
	mrsvd534
[2];

228 
__Ë32
 
	msgls
;

229 
__u8
 
	mrsvd540
[228];

230 
	msubnqn
[256];

231 
__u8
 
	mrsvd1024
[768];

232 
__Ë32
 
	mioccsz
;

233 
__Ë32
 
	miÜcsz
;

234 
__Ë16
 
	micdoff
;

235 
__u8
 
	mù¿‰r
;

236 
__u8
 
	mmsdbd
;

237 
__u8
 
	mrsvd1804
[244];

238 
nvme_id_pow”_¡©e
 
	mpsd
[32];

239 
__u8
 
	mvs
[1024];

243 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

244 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

245 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

246 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

249 
	snvme_lbaf
 {

250 
__Ë16
 
	mms
;

251 
__u8
 
	mds
;

252 
__u8
 
	m½
;

255 
	snvme_id_ns
 {

256 
__Ë64
 
	mnsze
;

257 
__Ë64
 
	mnÿp
;

258 
__Ë64
 
	mnu£
;

259 
__u8
 
	mnsã©
;

260 
__u8
 
	mÆbaf
;

261 
__u8
 
	mæbas
;

262 
__u8
 
	mmc
;

263 
__u8
 
	mdpc
;

264 
__u8
 
	mdps
;

265 
__u8
 
	mnmic
;

266 
__u8
 
	m»sÿp
;

267 
__u8
 
	måi
;

268 
__u8
 
	mrsvd33
;

269 
__Ë16
 
	mÇwun
;

270 
__Ë16
 
	mÇwupf
;

271 
__Ë16
 
	mÇcwu
;

272 
__Ë16
 
	mÇb¢
;

273 
__Ë16
 
	mÇbo
;

274 
__Ë16
 
	mÇb¥f
;

275 
__u16
 
	mrsvd46
;

276 
__u8
 
	mnvmÿp
[16];

277 
__u8
 
	mrsvd64
[40];

278 
__u8
 
	mnguid
[16];

279 
__u8
 
	meui64
[8];

280 
nvme_lbaf
 
	mlbaf
[16];

281 
__u8
 
	mrsvd192
[192];

282 
__u8
 
	mvs
[3712];

286 
	mNVME_ID_CNS_NS
 = 0x00,

287 
	mNVME_ID_CNS_CTRL
 = 0x01,

288 
	mNVME_ID_CNS_NS_ACTIVE_LIST
 = 0x02,

289 
	mNVME_ID_CNS_NS_PRESENT_LIST
 = 0x10,

290 
	mNVME_ID_CNS_NS_PRESENT
 = 0x11,

291 
	mNVME_ID_CNS_CTRL_NS_LIST
 = 0x12,

292 
	mNVME_ID_CNS_CTRL_LIST
 = 0x13,

296 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

297 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

298 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

299 
	mNVME_LBAF_RP_BEST
 = 0,

300 
	mNVME_LBAF_RP_BETTER
 = 1,

301 
	mNVME_LBAF_RP_GOOD
 = 2,

302 
	mNVME_LBAF_RP_DEGRADED
 = 3,

303 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

304 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

305 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

306 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

307 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

308 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

309 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

310 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

311 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

312 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

315 
	snvme_sm¬t_log
 {

316 
__u8
 
	mü™iÿl_w¬nšg
;

317 
__u8
 
	m‹m³¿tu»
[2];

318 
__u8
 
	mava_¥¬e
;

319 
__u8
 
	m¥¬e_th»sh
;

320 
__u8
 
	m³rûÁ_u£d
;

321 
__u8
 
	mrsvd6
[26];

322 
__u8
 
	md©a_un™s_»ad
[16];

323 
__u8
 
	md©a_un™s_wr™‹n
[16];

324 
__u8
 
	mho¡_»ads
[16];

325 
__u8
 
	mho¡_wr™es
[16];

326 
__u8
 
	mù¾_busy_time
[16];

327 
__u8
 
	mpow”_cyşes
[16];

328 
__u8
 
	mpow”_Ú_hours
[16];

329 
__u8
 
	mun§ã_shutdowns
[16];

330 
__u8
 
	mmedŸ_”rÜs
[16];

331 
__u8
 
	mnum_”r_log_’Œ›s
[16];

332 
__Ë32
 
	mw¬nšg_‹mp_time
;

333 
__Ë32
 
	mü™iÿl_comp_time
;

334 
__Ë16
 
	m‹mp_£nsÜ
[8];

335 
__u8
 
	mrsvd216
[296];

339 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

340 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

341 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

342 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

343 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

347 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

350 
	snvme_lba_¿nge_ty³
 {

351 
__u8
 
	mty³
;

352 
__u8
 
	m©Œibu‹s
;

353 
__u8
 
	mrsvd2
[14];

354 
__u64
 
	m¦ba
;

355 
__u64
 
	mÆb
;

356 
__u8
 
	mguid
[16];

357 
__u8
 
	mrsvd48
[16];

361 
	mNVME_LBART_TYPE_FS
 = 0x01,

362 
	mNVME_LBART_TYPE_RAID
 = 0x02,

363 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

364 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

366 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

367 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

370 
	snvme_»£rv©iÚ_¡©us
 {

371 
__Ë32
 
	mg’
;

372 
__u8
 
	m¹y³
;

373 
__u8
 
	m»gùl
[2];

374 
__u8
 
	m»sv5
[2];

375 
__u8
 
	m±¶s
;

376 
__u8
 
	m»sv10
[13];

378 
__Ë16
 
	múid
;

379 
__u8
 
	mrc¡s
;

380 
__u8
 
	m»sv3
[5];

381 
__Ë64
 
	mho¡id
;

382 
__Ë64
 
	mrkey
;

383 } 
	m»gùl_ds
[];

386 
	envme_async_ev’t_ty³
 {

387 
	mNVME_AER_TYPE_ERROR
 = 0,

388 
	mNVME_AER_TYPE_SMART
 = 1,

389 
	mNVME_AER_TYPE_NOTICE
 = 2,

394 
	envme_İcode
 {

395 
	mnvme_cmd_æush
 = 0x00,

396 
	mnvme_cmd_wr™e
 = 0x01,

397 
	mnvme_cmd_»ad
 = 0x02,

398 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

399 
	mnvme_cmd_com·»
 = 0x05,

400 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

401 
	mnvme_cmd_dsm
 = 0x09,

402 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

403 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

404 
	mnvme_cmd_»sv_acquœe
 = 0x11,

405 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

407 
	mnvme_cmd_kv_¡Üe
 = 0x81,

408 
	mnvme_cmd_kv_­³nd
 = 0x83,

409 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

410 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

411 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

412 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

413 
	mnvme_cmd_kv_exi¡
 = 0xB3,

417 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

418 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

419 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

432 
	mNVME_SGL_FMT_ADDRESS
 = 0x00,

433 
	mNVME_SGL_FMT_OFFSET
 = 0x01,

434 
	mNVME_SGL_FMT_INVALIDATE
 = 0x0f,

449 
	mNVME_SGL_FMT_DATA_DESC
 = 0x00,

450 
	mNVME_SGL_FMT_SEG_DESC
 = 0x02,

451 
	mNVME_SGL_FMT_LAST_SEG_DESC
 = 0x03,

452 
	mNVME_KEY_SGL_FMT_DATA_DESC
 = 0x04,

455 
	snvme_sgl_desc
 {

456 
__Ë64
 
	maddr
;

457 
__Ë32
 
	mËngth
;

458 
__u8
 
	mrsvd
[3];

459 
__u8
 
	mty³
;

462 
	snvme_keyed_sgl_desc
 {

463 
__Ë64
 
	maddr
;

464 
__u8
 
	mËngth
[3];

465 
__u8
 
	mkey
[4];

466 
__u8
 
	mty³
;

469 
	unvme_d©a_±r
 {

471 
__Ë64
 
	m´p1
;

472 
__Ë64
 
	m´p2
;

474 
nvme_sgl_desc
 
	msgl
;

475 
nvme_keyed_sgl_desc
 
	mksgl
;

493 
	mNVME_CMD_FUSE_FIRST
 = (1 << 0),

494 
	mNVME_CMD_FUSE_SECOND
 = (1 << 1),

496 
	mNVME_CMD_SGL_METABUF
 = (1 << 6),

497 
	mNVME_CMD_SGL_METASEG
 = (1 << 7),

498 
	mNVME_CMD_SGL_ALL
 = 
NVME_CMD_SGL_METABUF
 | 
NVME_CMD_SGL_METASEG
,

501 
	snvme_commÚ_commªd
 {

502 
__u8
 
	mİcode
;

503 
__u8
 
	mæags
;

504 
__u16
 
	mcommªd_id
;

505 
__Ë32
 
	mnsid
;

506 
__Ë32
 
	mcdw2
[2];

507 
__Ë64
 
	mm‘ad©a
;

508 
nvme_d©a_±r
 
	md±r
;

509 
__Ë32
 
	mcdw10
[6];

512 
	snvme_rw_commªd
 {

513 
__u8
 
	mİcode
;

514 
__u8
 
	mæags
;

515 
__u16
 
	mcommªd_id
;

516 
__Ë32
 
	mnsid
;

517 
__u64
 
	mrsvd2
;

518 
__Ë64
 
	mm‘ad©a
;

519 
nvme_d©a_±r
 
	md±r
;

520 
__Ë64
 
	m¦ba
;

521 
__Ë16
 
	mËngth
;

522 
__Ë16
 
	mcÚŒŞ
;

523 
__Ë32
 
	mdsmgmt
;

524 
__Ë32
 
	m»áag
;

525 
__Ë16
 
	m­±ag
;

526 
__Ë16
 
	m­pmask
;

530 
	mNVME_RW_LR
 = 1 << 15,

531 
	mNVME_RW_FUA
 = 1 << 14,

532 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

533 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

534 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

535 
	mNVME_RW_DSM_FREQ_READS
 = 3,

536 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

537 
	mNVME_RW_DSM_FREQ_RW
 = 5,

538 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

539 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

540 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

541 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

542 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

543 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

544 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

545 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

546 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

547 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

548 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

549 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

550 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

553 
	snvme_dsm_cmd
 {

554 
__u8
 
	mİcode
;

555 
__u8
 
	mæags
;

556 
__u16
 
	mcommªd_id
;

557 
__Ë32
 
	mnsid
;

558 
__u64
 
	mrsvd2
[2];

559 
nvme_d©a_±r
 
	md±r
;

560 
__Ë32
 
	mÄ
;

561 
__Ë32
 
	m©Œibu‹s
;

562 
__u32
 
	mrsvd12
[4];

566 
	mNVME_DSMGMT_IDR
 = 1 << 0,

567 
	mNVME_DSMGMT_IDW
 = 1 << 1,

568 
	mNVME_DSMGMT_AD
 = 1 << 2,

571 
	snvme_dsm_¿nge
 {

572 
__Ë32
 
	mÿ‰r
;

573 
__Ë32
 
	mÆb
;

574 
__Ë64
 
	m¦ba
;

579 
	snvme_kv_¡Üe_commªd
 {

580 
__u8
 
	mİcode
;

581 
__u8
 
	mæags
;

582 
__u16
 
	mcommªd_id
;

583 
__Ë32
 
	mnsid
;

584 
__u64
 
	mrsvd
;

585 
__Ë32
 
	moff£t
;

586 
__u32
 
	mrsvd2
;

587 
nvme_d©a_±r
 
	md±r
;

588 
__Ë32
 
	mv®ue_Ën
;

589 
__u8
 
	mkey_Ën
;

590 
__u8
 
	mİtiÚ
;

591 
__u8
 
	mšv®id_by‹
:2;

592 
__u8
 
	mrsvd3
:6;

593 
__u8
 
	mrsvd4
;

596 
	mkey
[16];

599 
__Ë64
 
	mkey_´p
;

600 
__Ë64
 
	mkey_´p2
;

605 
	snvme_kv_­³nd_commªd
 {

606 
__u8
 
	mİcode
;

607 
__u8
 
	mæags
;

608 
__u16
 
	mcommªd_id
;

609 
__Ë32
 
	mnsid
;

610 
__u64
 
	mrsvd
;

611 
__Ë32
 
	moff£t
;

612 
__u32
 
	mrsvd2
;

613 
nvme_d©a_±r
 
	md±r
;

614 
__Ë32
 
	mv®ue_Ën
;

615 
__u8
 
	mkey_Ën
;

616 
__u8
 
	mİtiÚ
;

617 
__u8
 
	mšv®id_by‹
:2;

618 
__u8
 
	mrsvd3
:6;

619 
__u8
 
	mrsvd4
;

622 
	mkey
[16];

625 
__Ë64
 
	mkey_´p
;

626 
__Ë64
 
	mkey_´p2
;

631 
	snvme_kv_»Œ›ve_commªd
 {

632 
__u8
 
	mİcode
;

633 
__u8
 
	mæags
;

634 
__u16
 
	mcommªd_id
;

635 
__Ë32
 
	mnsid
;

636 
__u64
 
	mrsvd
;

637 
__Ë32
 
	moff£t
;

638 
__u32
 
	mrsvd2
;

639 
nvme_d©a_±r
 
	md±r
;

640 
__Ë32
 
	mv®ue_Ën
;

641 
__u8
 
	mkey_Ën
;

642 
__u8
 
	mİtiÚ
;

643 
__u16
 
	mrsvd3
;

646 
	mkey
[16];

649 
__Ë64
 
	mkey_´p
;

650 
__Ë64
 
	mkey_´p2
;

655 
	snvme_kv_d–‘e_commªd
 {

656 
__u8
 
	mİcode
;

657 
__u8
 
	mæags
;

658 
__u16
 
	mcommªd_id
;

659 
__Ë32
 
	mnsid
;

660 
__u64
 
	mrsvd
;

661 
__Ë32
 
	moff£t
;

662 
__u32
 
	mrsvd2
;

663 
__u64
 
	mrsvd3
[2];

664 
__Ë32
 
	mv®ue_Ën
;

665 
__u8
 
	mkey_Ën
;

666 
__u8
 
	mİtiÚ
;

667 
__u16
 
	mrsvd4
;

670 
	mkey
[16];

673 
__Ë64
 
	mkey_´p
;

674 
__Ë64
 
	mkey_´p2
;

679 
	snvme_kv_™”_»q_commªd
 {

680 
__u8
 
	mİcode
;

681 
__u8
 
	mæags
;

682 
__u16
 
	mcommªd_id
;

683 
__Ë32
 
	mnsid
;

684 
__u64
 
	mrsvd
[4];

685 
__Ë32
 
	mz”o
;

686 
__u8
 
	m™”_hªdË
;

687 
__u8
 
	mİtiÚ
;

688 
__u16
 
	mrsvd2
;

689 
__Ë32
 
	m™”_v®
;

690 
__Ë32
 
	m™”_b™mask
;

691 
__u64
 
	mrsvd3
;

695 
	snvme_kv_™”_»ad_commªd
 {

696 
__u8
 
	mİcode
;

697 
__u8
 
	mæags
;

698 
__u16
 
	mcommªd_id
;

699 
__Ë32
 
	mnsid
;

700 
__u64
 
	mrsvd
[2];

701 
nvme_d©a_±r
 
	md±r
;

702 
__Ë32
 
	mv®ue_Ën
;

703 
__u8
 
	m™”_hªdË
;

704 
__u8
 
	mİtiÚ
;

705 
__u16
 
	mrsvd2
;

706 
__u64
 
	mrsvd3
[2];

708 
	snvme_kv_exi¡_commªd
 {

709 
__u8
 
	mİcode
;

710 
__u8
 
	mæags
;

711 
__u16
 
	mcommªd_id
;

712 
__Ë32
 
	mnsid
;

713 
__u64
 
	mrsvd
;

714 
__Ë32
 
	moff£t
;

715 
__u32
 
	mrsvd2
;

716 
__u64
 
	mrsvd3
[2];

717 
__Ë32
 
	mv®ue_Ën
;

718 
__u8
 
	mkey_Ën
;

719 
__u8
 
	mİtiÚ
;

720 
__u16
 
	mrsvd4
;

723 
	mkey
[16];

726 
__Ë64
 
	mkey_´p
;

727 
__Ë64
 
	mkey_´p2
;

736 
	envme_admš_İcode
 {

737 
	mnvme_admš_d–‘e_sq
 = 0x00,

738 
	mnvme_admš_ü—‹_sq
 = 0x01,

739 
	mnvme_admš_g‘_log_·ge
 = 0x02,

740 
	mnvme_admš_d–‘e_cq
 = 0x04,

741 
	mnvme_admš_ü—‹_cq
 = 0x05,

742 
	mnvme_admš_id’tify
 = 0x06,

743 
	mnvme_admš_abÜt_cmd
 = 0x08,

744 
	mnvme_admš_£t_ã©u»s
 = 0x09,

745 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

746 
	mnvme_admš_async_ev’t
 = 0x0c,

747 
	mnvme_admš_ns_mgmt
 = 0x0d,

748 
	mnvme_admš_aùiv©e_fw
 = 0x10,

749 
	mnvme_admš_dowÆßd_fw
 = 0x11,

750 
	mnvme_admš_ns_©ch
 = 0x15,

751 
	mnvme_admš_k“p_®ive
 = 0x18,

752 
	mnvme_admš_fÜm©_nvm
 = 0x80,

753 
	mnvme_admš_£cur™y_£nd
 = 0x81,

754 
	mnvme_admš_£cur™y_»cv
 = 0x82,

758 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

759 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

760 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

761 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

762 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

763 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

764 
	mNVME_FEAT_ARBITRATION
 = 0x01,

765 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

766 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

767 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

768 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

769 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

770 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

771 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

772 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

773 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

774 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

775 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

776 
	mNVME_FEAT_HOST_MEM_BUF
 = 0x0d,

777 
	mNVME_FEAT_KATO
 = 0x0f,

778 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

779 
	mNVME_FEAT_HOST_ID
 = 0x81,

780 
	mNVME_FEAT_RESV_MASK
 = 0x82,

781 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

782 
	mNVME_LOG_ERROR
 = 0x01,

783 
	mNVME_LOG_SMART
 = 0x02,

784 
	mNVME_LOG_FW_SLOT
 = 0x03,

785 
	mNVME_LOG_DISC
 = 0x70,

786 
	mNVME_LOG_RESERVATION
 = 0x80,

787 
	mNVME_FWACT_REPL
 = (0 << 3),

788 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

789 
	mNVME_FWACT_ACTV
 = (2 << 3),

792 
	snvme_id’tify
 {

793 
__u8
 
	mİcode
;

794 
__u8
 
	mæags
;

795 
__u16
 
	mcommªd_id
;

796 
__Ë32
 
	mnsid
;

797 
__u64
 
	mrsvd2
[2];

798 
nvme_d©a_±r
 
	md±r
;

799 
__Ë32
 
	mús
;

800 
__u32
 
	mrsvd11
[5];

803 
	snvme_ã©u»s
 {

804 
__u8
 
	mİcode
;

805 
__u8
 
	mæags
;

806 
__u16
 
	mcommªd_id
;

807 
__Ë32
 
	mnsid
;

808 
__u64
 
	mrsvd2
[2];

809 
nvme_d©a_±r
 
	md±r
;

810 
__Ë32
 
	mfid
;

811 
__Ë32
 
	mdwÜd11
;

812 
__u32
 
	mrsvd12
[4];

815 
	snvme_ü—‹_cq
 {

816 
__u8
 
	mİcode
;

817 
__u8
 
	mæags
;

818 
__u16
 
	mcommªd_id
;

819 
__u32
 
	mrsvd1
[5];

820 
__Ë64
 
	m´p1
;

821 
__u64
 
	mrsvd8
;

822 
__Ë16
 
	mcqid
;

823 
__Ë16
 
	mqsize
;

824 
__Ë16
 
	mcq_æags
;

825 
__Ë16
 
	mœq_veùÜ
;

826 
__u32
 
	mrsvd12
[4];

829 
	snvme_ü—‹_sq
 {

830 
__u8
 
	mİcode
;

831 
__u8
 
	mæags
;

832 
__u16
 
	mcommªd_id
;

833 
__u32
 
	mrsvd1
[5];

834 
__Ë64
 
	m´p1
;

835 
__u64
 
	mrsvd8
;

836 
__Ë16
 
	msqid
;

837 
__Ë16
 
	mqsize
;

838 
__Ë16
 
	msq_æags
;

839 
__Ë16
 
	mcqid
;

840 
__u32
 
	mrsvd12
[4];

843 
	snvme_d–‘e_queue
 {

844 
__u8
 
	mİcode
;

845 
__u8
 
	mæags
;

846 
__u16
 
	mcommªd_id
;

847 
__u32
 
	mrsvd1
[9];

848 
__Ë16
 
	mqid
;

849 
__u16
 
	mrsvd10
;

850 
__u32
 
	mrsvd11
[5];

853 
	snvme_abÜt_cmd
 {

854 
__u8
 
	mİcode
;

855 
__u8
 
	mæags
;

856 
__u16
 
	mcommªd_id
;

857 
__u32
 
	mrsvd1
[9];

858 
__Ë16
 
	msqid
;

859 
__u16
 
	mcid
;

860 
__u32
 
	mrsvd11
[5];

863 
	snvme_dowÆßd_fœmw¬e
 {

864 
__u8
 
	mİcode
;

865 
__u8
 
	mæags
;

866 
__u16
 
	mcommªd_id
;

867 
__u32
 
	mrsvd1
[5];

868 
nvme_d©a_±r
 
	md±r
;

869 
__Ë32
 
	mnumd
;

870 
__Ë32
 
	moff£t
;

871 
__u32
 
	mrsvd12
[4];

874 
	snvme_fÜm©_cmd
 {

875 
__u8
 
	mİcode
;

876 
__u8
 
	mæags
;

877 
__u16
 
	mcommªd_id
;

878 
__Ë32
 
	mnsid
;

879 
__u64
 
	mrsvd2
[4];

880 
__Ë32
 
	mcdw10
;

881 
__u32
 
	mrsvd11
[5];

884 
	snvme_g‘_log_·ge_commªd
 {

885 
__u8
 
	mİcode
;

886 
__u8
 
	mæags
;

887 
__u16
 
	mcommªd_id
;

888 
__Ë32
 
	mnsid
;

889 
__u64
 
	mrsvd2
[2];

890 
nvme_d©a_±r
 
	md±r
;

891 
__u8
 
	mlid
;

892 
__u8
 
	mrsvd10
;

893 
__Ë16
 
	mnumdl
;

894 
__Ë16
 
	mnumdu
;

895 
__u16
 
	mrsvd11
;

896 
__Ë32
 
	mÍŞ
;

897 
__Ë32
 
	mÍou
;

898 
__u32
 
	mrsvd14
[2];

904 
	envmf_çbrics_İcode
 {

905 
	mnvme_çbrics_commªd
 = 0x7f,

908 
	envmf_ÿpsuË_commªd
 {

909 
	mnvme_çbrics_ty³_´İ”ty_£t
 = 0x00,

910 
	mnvme_çbrics_ty³_cÚÃù
 = 0x01,

911 
	mnvme_çbrics_ty³_´İ”ty_g‘
 = 0x04,

914 
	snvmf_commÚ_commªd
 {

915 
__u8
 
	mİcode
;

916 
__u8
 
	m»sv1
;

917 
__u16
 
	mcommªd_id
;

918 
__u8
 
	mfùy³
;

919 
__u8
 
	m»sv2
[35];

920 
__u8
 
	mts
[24];

929 
	#NVME_CNTLID_MIN
 1

	)

930 
	#NVME_CNTLID_MAX
 0xfãf

	)

931 
	#NVME_CNTLID_DYNAMIC
 0xffff

	)

933 
	#MAX_DISC_LOGS
 255

	)

936 
	snvmf_disc_r¥_·ge_’Œy
 {

937 
__u8
 
	mŒty³
;

938 
__u8
 
	madrçm
;

939 
__u8
 
	msubty³
;

940 
__u8
 
	mŒeq
;

941 
__Ë16
 
	mpÜtid
;

942 
__Ë16
 
	múid
;

943 
__Ë16
 
	masqsz
;

944 
__u8
 
	m»sv8
[22];

945 
	mŒsvcid
[
NVMF_TRSVCID_SIZE
];

946 
__u8
 
	m»sv64
[192];

947 
	msubnqn
[
NVMF_NQN_FIELD_LEN
];

948 
	mŒaddr
[
NVMF_TRADDR_SIZE
];

949 
	ut§s
 {

950 
	mcommÚ
[
NVMF_TSAS_SIZE
];

951 
	srdma
 {

952 
__u8
 
	mq±y³
;

953 
__u8
 
	m´ty³
;

954 
__u8
 
	mcms
;

955 
__u8
 
	m»sv3
[5];

956 
__u16
 
	mpkey
;

957 
__u8
 
	m»sv10
[246];

958 } 
	mrdma
;

959 } 
	mt§s
;

963 
	snvmf_disc_r¥_·ge_hdr
 {

964 
__Ë64
 
	mg’ùr
;

965 
__Ë64
 
	mnum»c
;

966 
__Ë16
 
	m»cfmt
;

967 
__u8
 
	m»sv14
[1006];

968 
nvmf_disc_r¥_·ge_’Œy
 
	m’Œ›s
[0];

971 
	snvmf_cÚÃù_commªd
 {

972 
__u8
 
	mİcode
;

973 
__u8
 
	m»sv1
;

974 
__u16
 
	mcommªd_id
;

975 
__u8
 
	mfùy³
;

976 
__u8
 
	m»sv2
[19];

977 
nvme_d©a_±r
 
	md±r
;

978 
__Ë16
 
	m»cfmt
;

979 
__Ë16
 
	mqid
;

980 
__Ë16
 
	msqsize
;

981 
__u8
 
	mÿ‰r
;

982 
__u8
 
	m»sv3
;

983 
__Ë32
 
	mk©o
;

984 
__u8
 
	m»sv4
[12];

987 
	snvmf_cÚÃù_d©a
 {

988 
uuid_be
 
	mho¡id
;

989 
__Ë16
 
	múid
;

990 
	m»sv4
[238];

991 
	msubsy¢qn
[
NVMF_NQN_FIELD_LEN
];

992 
	mho¡nqn
[
NVMF_NQN_FIELD_LEN
];

993 
	m»sv5
[256];

996 
	snvmf_´İ”ty_£t_commªd
 {

997 
__u8
 
	mİcode
;

998 
__u8
 
	m»sv1
;

999 
__u16
 
	mcommªd_id
;

1000 
__u8
 
	mfùy³
;

1001 
__u8
 
	m»sv2
[35];

1002 
__u8
 
	m©Œib
;

1003 
__u8
 
	m»sv3
[3];

1004 
__Ë32
 
	moff£t
;

1005 
__Ë64
 
	mv®ue
;

1006 
__u8
 
	m»sv4
[8];

1009 
	snvmf_´İ”ty_g‘_commªd
 {

1010 
__u8
 
	mİcode
;

1011 
__u8
 
	m»sv1
;

1012 
__u16
 
	mcommªd_id
;

1013 
__u8
 
	mfùy³
;

1014 
__u8
 
	m»sv2
[35];

1015 
__u8
 
	m©Œib
;

1016 
__u8
 
	m»sv3
[3];

1017 
__Ë32
 
	moff£t
;

1018 
__u8
 
	m»sv4
[16];

1021 
	snvme_commªd
 {

1023 
nvme_commÚ_commªd
 
	mcommÚ
;

1024 
nvme_rw_commªd
 
	mrw
;

1025 
nvme_id’tify
 
	mid’tify
;

1026 
nvme_ã©u»s
 
	mã©u»s
;

1027 
nvme_ü—‹_cq
 
	mü—‹_cq
;

1028 
nvme_ü—‹_sq
 
	mü—‹_sq
;

1029 
nvme_d–‘e_queue
 
	md–‘e_queue
;

1030 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

1031 
nvme_fÜm©_cmd
 
	mfÜm©
;

1032 
nvme_dsm_cmd
 
	mdsm
;

1033 
nvme_abÜt_cmd
 
	mabÜt
;

1034 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

1035 
nvmf_commÚ_commªd
 
	mçbrics
;

1036 
nvmf_cÚÃù_commªd
 
	mcÚÃù
;

1037 
nvmf_´İ”ty_£t_commªd
 
	m´İ_£t
;

1038 
nvmf_´İ”ty_g‘_commªd
 
	m´İ_g‘
;

1040 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

1041 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

1042 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

1043 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

1044 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

1045 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

1046 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

1051 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1059 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_¡Üe
 || cmd->commÚ.İcod=ğ
nvme_cmd_kv_­³nd
)

1061 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_»Œ›ve
 ||

1062 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_d–‘e
 ||

1063 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»q
 ||

1064 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
 ||

1065 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_exi¡
 )

1068 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1069  
cmd
->
çbrics
.
İcode
 & 1;

1070  
cmd
->
commÚ
.
İcode
 & 1;

1071 
	}
}

1077 
	mNVME_SC_SUCCESS
 = 0x0,

1078 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

1079 
	mNVME_SC_INVALID_FIELD
 = 0x2,

1080 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

1081 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

1082 
	mNVME_SC_POWER_LOSS
 = 0x5,

1083 
	mNVME_SC_INTERNAL
 = 0x6,

1084 
	mNVME_SC_ABORT_REQ
 = 0x7,

1085 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

1086 
	mNVME_SC_FUSED_FAIL
 = 0x9,

1087 
	mNVME_SC_FUSED_MISSING
 = 0xa,

1088 
	mNVME_SC_INVALID_NS
 = 0xb,

1089 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

1090 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

1091 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

1092 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

1093 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

1094 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

1096 
	mNVME_SC_SGL_INVALID_OFFSET
 = 0x16,

1097 
	mNVME_SC_SGL_INVALID_SUBTYPE
 = 0x17,

1099 
	mNVME_SC_LBA_RANGE
 = 0x80,

1100 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

1101 
	mNVME_SC_NS_NOT_READY
 = 0x82,

1102 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

1107 
	mNVME_SC_CQ_INVALID
 = 0x100,

1108 
	mNVME_SC_QID_INVALID
 = 0x101,

1109 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

1110 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

1111 
	mNVME_SC_ABORT_MISSING
 = 0x104,

1112 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

1113 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

1114 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

1115 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

1116 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

1117 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

1118 
	mNVME_SC_FW_NEEDS_CONV_RESET
 = 0x10b,

1119 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

1120 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

1121 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

1122 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

1123 
	mNVME_SC_FW_NEEDS_SUBSYS_RESET
 = 0x110,

1124 
	mNVME_SC_FW_NEEDS_RESET
 = 0x111,

1125 
	mNVME_SC_FW_NEEDS_MAX_TIME
 = 0x112,

1126 
	mNVME_SC_FW_ACIVATE_PROHIBITED
 = 0x113,

1127 
	mNVME_SC_OVERLAPPING_RANGE
 = 0x114,

1128 
	mNVME_SC_NS_INSUFFICENT_CAP
 = 0x115,

1129 
	mNVME_SC_NS_ID_UNAVAILABLE
 = 0x116,

1130 
	mNVME_SC_NS_ALREADY_ATTACHED
 = 0x118,

1131 
	mNVME_SC_NS_IS_PRIVATE
 = 0x119,

1132 
	mNVME_SC_NS_NOT_ATTACHED
 = 0x11a,

1133 
	mNVME_SC_THIN_PROV_NOT_SUPP
 = 0x11b,

1134 
	mNVME_SC_CTRL_LIST_INVALID
 = 0x11c,

1139 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

1140 
	mNVME_SC_INVALID_PI
 = 0x181,

1141 
	mNVME_SC_READ_ONLY
 = 0x182,

1146 
	mNVME_SC_CONNECT_FORMAT
 = 0x180,

1147 
	mNVME_SC_CONNECT_CTRL_BUSY
 = 0x181,

1148 
	mNVME_SC_CONNECT_INVALID_PARAM
 = 0x182,

1149 
	mNVME_SC_CONNECT_RESTART_DISC
 = 0x183,

1150 
	mNVME_SC_CONNECT_INVALID_HOST
 = 0x184,

1152 
	mNVME_SC_DISCOVERY_RESTART
 = 0x190,

1153 
	mNVME_SC_AUTH_REQUIRED
 = 0x191,

1158 
	mNVME_SC_WRITE_FAULT
 = 0x280,

1159 
	mNVME_SC_READ_ERROR
 = 0x281,

1160 
	mNVME_SC_GUARD_CHECK
 = 0x282,

1161 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

1162 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

1163 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

1164 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

1165 
	mNVME_SC_UNWRITTEN_BLOCK
 = 0x287,

1167 
	mNVME_SC_DNR
 = 0x4000,

1177 
	mNVME_SC_FC_TRANSPORT_ERROR
 = 0x00B0,

1180 
	mNVME_SC_FC_TRANSPORT_ABORTED
 = 0x00B1,

1183 
	snvme_com¶‘iÚ
 {

1187 
	unvme_»suÉ
 {

1188 
__Ë16
 
	mu16
;

1189 
__Ë32
 
	mu32
;

1190 
__Ë64
 
	mu64
;

1191 } 
	m»suÉ
;

1192 
__Ë16
 
	msq_h—d
;

1193 
__Ë16
 
	msq_id
;

1194 
__u16
 
	mcommªd_id
;

1195 
__Ë16
 
	m¡©us
;

1198 
	#NVME_VS
(
majÜ
, 
mšÜ
, 
‹¹Ÿry
) \

1199 (((
majÜ
è<< 16è| ((
mšÜ
è<< 8è| (
‹¹Ÿry
))

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


16 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	mİcode
;

22 
__u8
 
	mæags
;

23 
__u16
 
	mcÚŒŞ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mm‘ad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¦ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	m»áag
;

31 
__u16
 
	m­±ag
;

32 
__u16
 
	m­pmask
;

35 
	snvme_·s¡hru_cmd
 {

36 
__u8
 
	mİcode
;

37 
__u8
 
	mæags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mm‘ad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mm‘ad©a_Ën
;

45 
__u32
 
	md©a_Ën
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	m»suÉ
;

56 
	#KVS_SUCCESS
 0

	)

57 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

58 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

59 
	#KVS_ERR_CLOSE
 (-3)

	)

60 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

61 
	#KVS_ERR_CONT_NAME
 (-5)

	)

62 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

63 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

64 
	#KVS_ERR_GROUP
 (-8)

	)

65 
	#KVS_ERR_INDEX
 (-9)

	)

66 
	#KVS_ERR_IO
 (-10)

	)

67 
	#KVS_ERR_KEY
 (-11)

	)

68 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

69 
	#KVS_ERR_MEMORY
 (-13)

	)

70 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

71 
	#KVS_ERR_OFFSET
 (-15)

	)

72 
	#KVS_ERR_OPEN
 (-16)

	)

73 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

74 
	#KVS_ERR_PERMISSION
 (-18)

	)

75 
	#KVS_ERR_SPACE
 (-19)

	)

76 
	#KVS_ERR_TIMEOUT
 (-20)

	)

77 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

78 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

79 
	#KVS_ERR_VALUE
 (-23)

	)

82 
	snvme_·s¡hru_kv_cmd
 {

83 
__u8
 
	mİcode
;

84 
__u8
 
	mæags
;

85 
__u16
 
	mrsvd1
;

86 
__u32
 
	mnsid
;

87 
__u32
 
	mcdw2
;

88 
__u32
 
	mcdw3
;

89 
__u32
 
	mcdw4
;

90 
__u32
 
	mcdw5
;

91 
__u64
 
	md©a_addr
;

92 
__u32
 
	md©a_Ëngth
;

93 
__u32
 
	mkey_Ëngth
;

94 
__u32
 
	mcdw10
;

95 
__u32
 
	mcdw11
;

98 
__u64
 
	mkey_addr
;

99 
__u32
 
	mrsvd5
;

100 
__u32
 
	mrsvd6
;

102 
__u8
 
	mkey
[16];

104 
__u32
 
	mcdw12
;

105 
__u32
 
	mcdw13
;

106 
__u32
 
	mcdw14
;

107 
__u32
 
	mcdw15
;

110 
__u32
 
	mtimeout_ms
;

111 
__u32
 
	m»suÉ
;

112 
__u32
 
	m¡©us
;

113 
__u32
 
	mùxid
;

114 
__u64
 
	m»qid
;

117 
	snvme_aioùx
 {

118 
__u32
 
	mùxid
;

119 
__u32
 
	mev’tfd
;

123 
	snvme_aiÛv’t
 {

124 
__u64
 
	m»qid
;

125 
__u32
 
	mùxid
;

126 
__u32
 
	m»suÉ
;

127 
__u16
 
	m¡©us
;

130 
	#MAX_AIO_EVENTS
 128

	)

131 
	snvme_aiÛv’ts
 {

132 
__u16
 
	mÄ
;

133 
__u32
 
	mùxid
;

134 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

138 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

140 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

141 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

142 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

143 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

144 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

145 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

146 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

148 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

149 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

150 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

151 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

152 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/nvme.h

14 #iâdeà
_NVME_H


15 
	#_NVME_H


	)

20 
	#KSID_SUPPORT


	)

24 
	~"lšux_nvme.h
"

26 
	~<lšux/nvme.h
>

29 
	~<lšux/pci.h
>

30 
	~<lšux/k»f.h
>

31 
	~<lšux/blk-mq.h
>

32 
	~<lšux/idr.h
>

35 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

36 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

37 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

38 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

39 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

40 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

41 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

42 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

43 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

44 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

45 
	`is_kv_exi¡_cmd
(
İcode
))

	)

55 
	mNVME_SC_CANCELLED
 = -
EINTR
,

58 
nvme_io_timeout
;

59 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

61 
admš_timeout
;

62 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

64 
shutdown_timeout
;

65 
	#SHUTDOWN_TIMEOUT
 (
shutdown_timeout
 * 
HZ
)

	)

67 
	#NVME_DEFAULT_KATO
 5

	)

68 
	#NVME_KATO_GRACE
 10

	)

70 
nvme_max_»Œ›s
;

76 
	envme_quœks
 {

81 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

87 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

93 
	mNVME_QUIRK_DISCARD_ZEROES
 = (1 << 2),

99 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

106 
	snvme_»que¡
 {

107 
nvme_commªd
 *
	mcmd
;

108 
nvme_»suÉ
 
	m»suÉ
;

111 
šlše
 
nvme_»que¡
 *
	$nvme_»q
(
»que¡
 *
»q
)

113  
	`blk_mq_rq_to_pdu
(
»q
);

114 
	}
}

117 
	snvme_io_·¿m
 {

118 
sÿ‰”li¡
* 
	mkv_d©a_sg_±r
;

119 
sÿ‰”li¡
* 
	mkv_m‘a_sg_±r
;

120 
	mkv_d©a_ÃÁs
;

121 
	mkv_d©a_Ën
;

124 
šlše
 
nvme_io_·¿m
 *
	$nvme_io_·¿m
(
»que¡
 *
»q
)

126  (
nvme_io_·¿m
 *)(
	`blk_mq_rq_to_pdu
(
»q
è+ (
nvme_»que¡
));

127 
	}
}

139 
	#NVME_QUIRK_DELAY_AMOUNT
 2000

	)

141 
	envme_ù¾_¡©e
 {

142 
	mNVME_CTRL_NEW
,

143 
	mNVME_CTRL_LIVE
,

144 
	mNVME_CTRL_RESETTING
,

145 
	mNVME_CTRL_RECONNECTING
,

146 
	mNVME_CTRL_DELETING
,

147 
	mNVME_CTRL_DEAD
,

150 
	snvme_ù¾
 {

151 
nvme_ù¾_¡©e
 
	m¡©e
;

152 
¥šlock_t
 
	mlock
;

153 cÚ¡ 
nvme_ù¾_İs
 *
	mİs
;

154 
»que¡_queue
 *
	madmš_q
;

155 
»que¡_queue
 *
	mcÚÃù_q
;

156 
deviû
 *
	mdev
;

157 
k»f
 
	mk»f
;

158 
	mš¡ªû
;

159 
blk_mq_g_£t
 *
	mg£t
;

160 
li¡_h—d
 
	mÇme¥aûs
;

161 
mu‹x
 
	mÇme¥aûs_mu‹x
;

162 
deviû
 *
	mdeviû
;

163 
li¡_h—d
 
	mnode
;

164 
ida
 
	mns_ida
;

166 
	mÇme
[12];

167 
	m£rŸl
[20];

168 
	mmod–
[40];

169 
	mfœmw¬e_»v
[8];

170 
u16
 
	múid
;

172 
u32
 
	mù¾_cÚfig
;

174 
u32
 
	m·ge_size
;

175 
u32
 
	mmax_hw_£ùÜs
;

176 
u16
 
	mÚcs
;

177 
u16
 
	mvid
;

178 
©omic_t
 
	mabÜt_lim™
;

179 
u8
 
	mev’t_lim™
;

180 
u8
 
	mvwc
;

181 
u32
 
	mvs
;

182 
u32
 
	msgls
;

183 
u16
 
	mkas
;

184 
	mk©o
;

185 
boŞ
 
	msubsy¡em
;

186 
	mquœks
;

187 
wÜk_¡ruù
 
	msÿn_wÜk
;

188 
wÜk_¡ruù
 
	masync_ev’t_wÜk
;

189 
d–ayed_wÜk
 
	mka_wÜk
;

192 
u16
 
	msqsize
;

193 
u32
 
	mioccsz
;

194 
u32
 
	miÜcsz
;

195 
u16
 
	micdoff
;

196 
u16
 
	mmaxcmd
;

197 
nvmf_ù¾_İtiÚs
 *
	mİts
;

203 
	snvme_ns
 {

204 
li¡_h—d
 
	mli¡
;

206 
nvme_ù¾
 *
	mù¾
;

207 
»que¡_queue
 *
	mqueue
;

208 
g’disk
 *
	mdisk
;

209 
k»f
 
	mk»f
;

210 
	mš¡ªû
;

212 
u8
 
	meui
[8];

213 
u8
 
	muuid
[16];

215 
	mns_id
;

216 
	mlba_shiá
;

217 
u16
 
	mms
;

218 
boŞ
 
	mext
;

219 
u8
 
	mpi_ty³
;

220 
	mæags
;

222 
	#NVME_NS_REMOVING
 0

	)

223 
	#NVME_NS_DEAD
 1

	)

225 
u64
 
	mmode_£Ëù_num_blocks
;

226 
u32
 
	mmode_£Ëù_block_Ën
;

229 
	snvme_ù¾_İs
 {

230 cÚ¡ *
	mÇme
;

231 
moduË
 *
	mmoduË
;

232 
boŞ
 
	mis_çbrics
;

233 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

234 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

235 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

236 (*
	m»£t_ù¾
)(
nvme_ù¾
 *
	mù¾
);

237 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

238 (*
	mpo¡_sÿn
)(
nvme_ù¾
 *
	mù¾
);

239 (*
	msubm™_async_ev’t
)(
nvme_ù¾
 *
	mù¾
, 
	m«r_idx
);

240 (*
	md–‘e_ù¾
)(
nvme_ù¾
 *
	mù¾
);

241 cÚ¡ *(*
	mg‘_subsy¢qn
)(
nvme_ù¾
 *
	mù¾
);

242 (*
	mg‘_add»ss
)(
nvme_ù¾
 *
	mù¾
, *
	mbuf
, 
	msize
);

245 
šlše
 
boŞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

247 
u32
 
v®
 = 0;

249 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

250  
çl£
;

251  
v®
 & 
NVME_CSTS_RDY
;

252 
	}
}

254 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

256 ià(!
ù¾
->
subsy¡em
)

257  -
ENOTTY
;

258  
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

259 
	}
}

261 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

263  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

264 
	}
}

266 
šlše
 
	$nvme_m­_Ën
(
»que¡
 *
rq
)

268 ià(
rq
->
cmd_æags
 & 
REQ_DISCARD
)

269  (
nvme_dsm_¿nge
);

271  
	`blk_rq_by‹s
(
rq
);

272 
	}
}

274 
šlše
 
	$nvme_ş—nup_cmd
(
»que¡
 *
»q
)

276 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
)

277 
	`kä“
(
»q
->
com¶‘iÚ_d©a
);

278 
	}
}

280 
šlše
 
	$nvme_”rÜ_¡©us
(
u16
 
¡©us
)

282 
¡©us
 & 0x7ff) {

283 
NVME_SC_SUCCESS
:

285 
NVME_SC_CAP_EXCEEDED
:

286  -
ENOSPC
;

288  -
EIO
;

290 
	}
}

292 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
, 
u16
 
¡©us
)

294  !(
¡©us
 & 
NVME_SC_DNR
 || 
	`blk_nÜ‘ry_»que¡
(
»q
)) &&

295 (
jiff›s
 - 
»q
->
¡¬t_time
è<„eq->
timeout
 &&

296 
»q
->
»Œ›s
 < 
nvme_max_»Œ›s
;

297 
	}
}

299 
nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
);

300 
boŞ
 
nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

301 
nvme_ù¾_¡©e
 
Ãw_¡©e
);

302 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

303 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

304 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

305 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

306 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
);

307 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

308 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

309 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

311 
nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
);

312 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

314 
	#NVME_NR_AERS
 1

	)

315 
nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

316 
nvme_»suÉ
 *
»s
);

317 
nvme_queue_async_ev’ts
(
nvme_ù¾
 *
ù¾
);

319 
nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
);

320 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

321 
nvme_kl_queues
(
nvme_ù¾
 *
ù¾
);

322 
nvme_unä“ze
(
nvme_ù¾
 *
ù¾
);

323 
nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
);

324 
nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
);

325 
nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
);

327 
	#NVME_QID_ANY
 -1

	)

328 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

329 
nvme_commªd
 *
cmd
, 
æags
, 
qid
);

330 
nvme_»queue_»q
(
»que¡
 *
»q
);

331 
nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

332 
nvme_commªd
 *
cmd
);

333 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

334 *
buf
, 
bufæ’
);

335 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

336 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

337 
timeout
, 
qid
, 
©_h—d
, 
æags
);

338 
nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

339 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

340 
timeout
);

341 
__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

342 
__u£r
 *
ubufãr
, 
bufæ’
,

343 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

344 
u32
 *
»suÉ
, 
timeout
);

345 
nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
);

346 
nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

347 
nvme_id_ns
 **
id
);

348 
nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
);

349 
nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

350 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
);

351 
nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

352 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
);

353 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

354 
nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

355 
nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

357 
	gsg_io_hdr
;

359 
nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
);

360 
nvme_sg_io32
(
nvme_ns
 *
ns
, 
¬g
);

361 
nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

);

363 
__š™
 
nvme_cÜe_š™
();

364 
nvme_cÜe_ex™
();

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/b™İs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/blk-mq.h
>

19 
	~<lšux/ıu.h
>

20 
	~<lšux/d–ay.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/g’hd.h
>

24 
	~<lšux/hd»g.h
>

25 
	~<lšux/idr.h
>

26 
	~<lšux/š™.h
>

27 
	~<lšux/š‹¼u±.h
>

28 
	~<lšux/io.h
>

29 
	~<lšux/kdev_t.h
>

30 
	~<lšux/k”Ãl.h
>

31 
	~<lšux/mm.h
>

32 
	~<lšux/moduË.h
>

33 
	~<lšux/moduË·¿m.h
>

34 
	~<lšux/mu‹x.h
>

35 
	~<lšux/pci.h
>

36 
	~<lšux/poisÚ.h
>

37 
	~<lšux/±¿û.h
>

38 
	~<lšux/sched.h
>

39 
	~<lšux/¦ab.h
>

40 
	~<lšux/tim”.h
>

41 
	~<lšux/ty³s.h
>

42 
	~<asm-g’”ic/io-64-nÚ©omic-lo-hi.h
>

43 
	~<asm/uÇligÃd.h
>

45 
	~"nvme.h
"

47 
	#NVME_Q_DEPTH
 1024

	)

48 
	#NVME_AQ_DEPTH
 256

	)

49 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

50 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

56 
	#NVME_AQ_BLKMQ_DEPTH
 (
NVME_AQ_DEPTH
 - 
NVME_NR_AERS
)

	)

58 
	gu£_th»aded_š‹¼u±s
;

59 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

61 
boŞ
 
	gu£_cmb_sqes
 = 
Œue
;

62 
moduË_·¿m
(
u£_cmb_sqes
, 
boŞ
, 0644);

63 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

65 
wÜkqueue_¡ruù
 *
	gnvme_wÜkq
;

67 
	gnvme_dev
;

68 
	gnvme_queue
;

70 
nvme_»£t
(
nvme_dev
 *
dev
);

71 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

72 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
);

77 
	snvme_dev
 {

78 
nvme_queue
 **
	mqueues
;

79 
blk_mq_g_£t
 
	mg£t
;

80 
blk_mq_g_£t
 
	madmš_g£t
;

81 
u32
 
__iomem
 *
	mdbs
;

82 
deviû
 *
	mdev
;

83 
dma_poŞ
 *
	m´p_·ge_poŞ
;

84 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

85 
	mqueue_couÁ
;

86 
	mÚlše_queues
;

87 
	mmax_qid
;

88 
	mq_d•th
;

89 
u32
 
	mdb_¡ride
;

90 
msix_’Œy
 *
	m’Œy
;

91 
__iomem
 *
	mb¬
;

92 
wÜk_¡ruù
 
	m»£t_wÜk
;

93 
wÜk_¡ruù
 
	m»move_wÜk
;

94 
tim”_li¡
 
	mw©chdog_tim”
;

95 
mu‹x
 
	mshutdown_lock
;

96 
boŞ
 
	msubsy¡em
;

97 
__iomem
 *
	mcmb
;

98 
dma_addr_t
 
	mcmb_dma_addr
;

99 
u64
 
	mcmb_size
;

100 
u32
 
	mcmbsz
;

101 
u32
 
	mcmbloc
;

102 
nvme_ù¾
 
	mù¾
;

103 
com¶‘iÚ
 
	mioq_wa™
;

106 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

108  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

109 
	}
}

115 
	snvme_queue
 {

116 
deviû
 *
	mq_dmadev
;

117 
nvme_dev
 *
	mdev
;

118 
	mœqÇme
[24];

119 
¥šlock_t
 
	mq_lock
;

120 
nvme_commªd
 *
	msq_cmds
;

121 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

122 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

123 
blk_mq_gs
 **
	mgs
;

124 
dma_addr_t
 
	msq_dma_addr
;

125 
dma_addr_t
 
	mcq_dma_addr
;

126 
u32
 
__iomem
 *
	mq_db
;

127 
u16
 
	mq_d•th
;

128 
s16
 
	mcq_veùÜ
;

129 
u16
 
	msq_
;

130 
u16
 
	mcq_h—d
;

131 
u16
 
	mqid
;

132 
u8
 
	mcq_pha£
;

133 
u8
 
	mcqe_£’
;

142 
	snvme_iod
 {

143 
nvme_»que¡
 
	m»q
;

145 
nvme_io_·¿m
 
	m·¿m
;

146 
	mkv_cmd
;

147 
	m»rv
;

149 
nvme_queue
 *
	mnvmeq
;

150 
	mabÜ‹d
;

151 
	mÅages
;

152 
	mÃÁs
;

153 
	mËngth
;

154 
dma_addr_t
 
	mfœ¡_dma
;

155 
sÿ‰”li¡
 
	mm‘a_sg
[1];

156 
sÿ‰”li¡
 *
	msg
;

157 
sÿ‰”li¡
 
	mšlše_sg
[0];

163 
šlše
 
	$_nvme_check_size
()

165 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

166 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

167 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

168 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

169 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

170 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

171 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

172 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

173 
	`BUILD_BUG_ON
((
nvme_id_ù¾
) != 4096);

174 
	`BUILD_BUG_ON
((
nvme_id_ns
) != 4096);

175 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

176 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

177 
	}
}

182 
	#NVME_INT_PAGES
 2

	)

183 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

190 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

192 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

193 
dev
->
ù¾
.
·ge_size
);

194  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

195 
	}
}

197 
	$nvme_iod_®loc_size
(
nvme_dev
 *
dev
,

198 
size
, 
n£g
)

200  (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
) +

201 (
sÿ‰”li¡
è* 
n£g
;

202 
	}
}

204 
	$nvme_cmd_size
(
nvme_dev
 *
dev
)

206  (
nvme_iod
) +

207 
	`nvme_iod_®loc_size
(
dev
, 
	`NVME_INT_BYTES
(dev), 
NVME_INT_PAGES
);

208 
	}
}

210 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

211 
hùx_idx
)

213 
nvme_dev
 *
dev
 = 
d©a
;

214 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

216 
	`WARN_ON
(
hùx_idx
 != 0);

217 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

218 
	`WARN_ON
(
nvmeq
->
gs
);

220 
hùx
->
driv”_d©a
 = 
nvmeq
;

221 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

223 
	}
}

225 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

227 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

229 
nvmeq
->
gs
 = 
NULL
;

230 
	}
}

232 
	$nvme_admš_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

233 
hùx_idx
, 
rq_idx
,

234 
numa_node
)

236 
nvme_dev
 *
dev
 = 
d©a
;

237 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

238 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

240 
	`BUG_ON
(!
nvmeq
);

241 
iod
->
nvmeq
 =‚vmeq;

243 
	}
}

245 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

246 
hùx_idx
)

248 
nvme_dev
 *
dev
 = 
d©a
;

249 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

251 ià(!
nvmeq
->
gs
)

252 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

254 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

255 
hùx
->
driv”_d©a
 = 
nvmeq
;

257 
	}
}

259 
	$nvme_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

260 
hùx_idx
, 
rq_idx
,

261 
numa_node
)

263 
nvme_dev
 *
dev
 = 
d©a
;

264 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

265 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

267 
	`BUG_ON
(!
nvmeq
);

268 
iod
->
nvmeq
 =‚vmeq;

270 
	}
}

279 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
,

280 
nvme_commªd
 *
cmd
)

282 
u16
 

 = 
nvmeq
->
sq_
;

284 ià(
nvmeq
->
sq_cmds_io
)

285 
	`memıy_toio
(&
nvmeq
->
sq_cmds_io
[

], 
cmd
, (*cmd));

287 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

289 ià(++

 =ğ
nvmeq
->
q_d•th
)

290 

 = 0;

291 
	`wr™–
(

, 
nvmeq
->
q_db
);

292 
nvmeq
->
sq_
 = 

;

293 
	}
}

295 
__Ë64
 **
	$iod_li¡
(
»que¡
 *
»q
)

297 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

298  (
__Ë64
 **)(
iod
->
sg
 + 
»q
->
Ä_phys_£gm’ts
);

299 
	}
}

302 
	$__nvme_š™_iod
(
»que¡
 *
rq
, 
size
,

303 
nvme_dev
 *
dev
, 
boŞ
 
kv
)

305 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

306 
n£g
;

307 ià(
kv
) {

308 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

309 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

311 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

314 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

315 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

316 ià(!
iod
->
sg
)

317  
BLK_MQ_RQ_QUEUE_BUSY
;

319 
iod
->
sg
 = iod->
šlše_sg
;

321 
iod
->
kv_cmd
 = 0;

322 
iod
->
abÜ‹d
 = 0;

323 
iod
->
Åages
 = -1;

324 
iod
->
ÃÁs
 = 0;

325 
iod
->
Ëngth
 = 
size
;

327 ià(!(
rq
->
cmd_æags
 & 
REQ_DONTPREP
)) {

328 
rq
->
»Œ›s
 = 0;

329 
rq
->
cmd_æags
 |ğ
REQ_DONTPREP
;

332 
	}
}

335 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
size
,

336 
nvme_dev
 *
dev
)

338  
	`__nvme_š™_iod
(
rq
, 
size
, 
dev
, 
çl£
);

339 
	}
}

341 
	$nvme_š™_iod_fÜ_kv
(
»que¡
 *
rq
, 
size
,

342 
nvme_dev
 *
dev
)

344  
	`__nvme_š™_iod
(
rq
, 
size
, 
dev
, 
Œue
);

345 
	}
}

348 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
size
,

349 
nvme_dev
 *
dev
)

351 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

352 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

354 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

355 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

356 ià(!
iod
->
sg
)

357  
BLK_MQ_RQ_QUEUE_BUSY
;

359 
iod
->
sg
 = iod->
šlše_sg
;

362 
iod
->
abÜ‹d
 = 0;

363 
iod
->
Åages
 = -1;

364 
iod
->
ÃÁs
 = 0;

365 
iod
->
Ëngth
 = 
size
;

367 ià(!(
rq
->
cmd_æags
 & 
REQ_DONTPREP
)) {

368 
rq
->
»Œ›s
 = 0;

369 
rq
->
cmd_æags
 |ğ
REQ_DONTPREP
;

371  
BLK_MQ_RQ_QUEUE_OK
;

372 
	}
}

374 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

376 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

377 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / 8 - 1;

378 
i
;

379 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

380 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

382 
	`nvme_ş—nup_cmd
(
»q
);

384 ià(
iod
->
Åages
 == 0)

385 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

386 
i
 = 0; i < 
iod
->
Åages
; i++) {

387 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

388 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

389 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

390 
´p_dma
 = 
Ãxt_´p_dma
;

393 ià(
iod
->
sg
 !ğiod->
šlše_sg
)

394 
	`kä“
(
iod
->
sg
);

395 
	}
}

397 
boŞ
 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

398 
tÙ®_Ën
)

400 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

401 
dma_poŞ
 *
poŞ
;

402 
Ëngth
 = 
tÙ®_Ën
;

403 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

404 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

405 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

406 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

407 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

408 
__Ë64
 *
´p_li¡
;

409 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

410 
dma_addr_t
 
´p_dma
;

411 
Å½s
, 
i
;

413 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

414 ià(
Ëngth
 <= 0)

415  
Œue
;

417 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

418 ià(
dma_Ën
) {

419 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

421 
sg
 = 
	`sg_Ãxt
(sg);

422 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

423 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

426 ià(
Ëngth
 <ğ
·ge_size
) {

427 
iod
->
fœ¡_dma
 = 
dma_addr
;

428  
Œue
;

431 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

432 ià(
Å½s
 <= (256 / 8)) {

433 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

434 
iod
->
Åages
 = 0;

436 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

437 
iod
->
Åages
 = 1;

440 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

441 ià(!
´p_li¡
) {

442 
iod
->
fœ¡_dma
 = 
dma_addr
;

443 
iod
->
Åages
 = -1;

444  
çl£
;

446 
li¡
[0] = 
´p_li¡
;

447 
iod
->
fœ¡_dma
 = 
´p_dma
;

448 
i
 = 0;

450 ià(
i
 =ğ
·ge_size
 >> 3) {

451 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

452 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

453 ià(!
´p_li¡
)

454  
çl£
;

455 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

456 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

457 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

458 
i
 = 1;

460 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

461 
dma_Ën
 -ğ
·ge_size
;

462 
dma_addr
 +ğ
·ge_size
;

463 
Ëngth
 -ğ
·ge_size
;

464 ià(
Ëngth
 <= 0)

466 ià(
dma_Ën
 > 0)

468 
	`BUG_ON
(
dma_Ën
 < 0);

469 
sg
 = 
	`sg_Ãxt
(sg);

470 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

471 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

474  
Œue
;

475 
	}
}

478 
	$nvme_kv_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

479 
size
, 
nvme_commªd
 *
cmnd
)

481 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

482 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

483 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

484 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

486 ià(
·¿m
->
kv_d©a_sg_±r
) {

487 
sÿ‰”li¡
* 
sg
;

488 
i
;

490 
	`fÜ_—ch_sg
(
·¿m
->
kv_d©a_sg_±r
, 
sg
,…¬am->
kv_d©a_ÃÁs
, 
i
) {

491 
iod
->
sg
[
i
] = *sg;

493 
iod
->
ÃÁs
 = 
·¿m
->
kv_d©a_ÃÁs
;

494 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

496 ià(!
	`dma_m­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
))

497 
out
;

499 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
size
))

500 
out_unm­
;

502 
cmnd
->
kv_¡Üe
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

503 
cmnd
->
kv_¡Üe
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

505 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

507 ià(
·¿m
->
kv_m‘a_sg_±r
)

509 ià(!
	`dma_m­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
))

510 
out_unm­
;

511 
cmnd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
·¿m
->
kv_m‘a_sg_±r
));

513  
BLK_MQ_RQ_QUEUE_OK
;

515 
out_unm­
:

516 ià(
·¿m
->
kv_d©a_sg_±r
)

517 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

518 
out
:

519  
»t
;

520 
	}
}

523 
	$nvme_kv_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

525 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

526 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

527 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

529 ià(
·¿m
->
kv_d©a_sg_±r
) {

530 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

532 ià(
·¿m
->
kv_m‘a_sg_±r
)

534 
	`dma_unm­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
);

536 
	`nvme_ä“_iod
(
dev
, 
»q
);

537 
	}
}

541 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

542 
size
, 
nvme_commªd
 *
cmnd
)

544 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

545 
»que¡_queue
 *
q
 = 
»q
->q;

546 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

547 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

548 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

550 ià(
	`is_kv_cmd
(
cmnd
->
commÚ
.
İcode
)) {

551  
	`nvme_kv_m­_d©a
(
dev
, 
»q
, 
size
, 
cmnd
);

554 
	`sg_š™_bË
(
iod
->
sg
, 
»q
->
Ä_phys_£gm’ts
);

555 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

556 ià(!
iod
->
ÃÁs
)

557 
out
;

559 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

560 ià(!
	`dma_m­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
))

561 
out
;

563 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
size
))

564 
out_unm­
;

566 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

567 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

568 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

569 
out_unm­
;

571 
	`sg_š™_bË
(
iod
->
m‘a_sg
, 1);

572 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, 
iod
->
m‘a_sg
) != 1)

573 
out_unm­
;

575 ià(!
	`dma_m­_sg
(
dev
->dev, 
iod
->
m‘a_sg
, 1, 
dma_dœ
))

576 
out_unm­
;

579 
cmnd
->
rw
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

580 
cmnd
->
rw
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

581 ià(
	`blk_š‹gr™y_rq
(
»q
))

582 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
m‘a_sg
));

583  
BLK_MQ_RQ_QUEUE_OK
;

585 
out_unm­
:

586 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

587 
out
:

588  
»t
;

589 
	}
}

591 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

593 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

594 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

595 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

597 ià(
iod
->
kv_cmd
) {

598  
	`nvme_kv_unm­_d©a
(
dev
, 
»q
);

602 ià(
iod
->
ÃÁs
) {

603 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

604 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

605 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
m‘a_sg
, 1, 
dma_dœ
);

609 
	`nvme_ä“_iod
(
dev
, 
»q
);

610 
	}
}

615 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

616 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

618 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

619 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

620 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

621 
»que¡
 *
»q
 = 
bd
->
rq
;

622 
nvme_commªd
 
cmnd
;

623 
m­_Ën
;

624 
»t
 = 
BLK_MQ_RQ_QUEUE_OK
;

626 
boŞ
 
b_kv_cmd
 = 
çl£
;

633 ià(
ns
 &&‚s->
ms
 && !
	`blk_š‹gr™y_rq
(
»q
)) {

634 ià(!(
ns
->
pi_ty³
 &&‚s->
ms
 == 8) &&

635 
»q
->
cmd_ty³
 !ğ
REQ_TYPE_DRV_PRIV
) {

636 
	`blk_mq_’d_»que¡
(
»q
, -
EFAULT
);

637  
BLK_MQ_RQ_QUEUE_OK
;

641 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
»q
, &
cmnd
);

642 ià(
»t
 !ğ
BLK_MQ_RQ_QUEUE_OK
)

643 
out
;

645 
b_kv_cmd
 = 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
);

647 ià(
b_kv_cmd
) {

648 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

649 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

650 
m­_Ën
 = 
·¿m
->
kv_d©a_Ën
;

651 
»t
 = 
	`nvme_š™_iod_fÜ_kv
(
»q
, 
m­_Ën
, 
dev
);

652 ià(
»t
)

653 
out
;

654 
iod
->
kv_cmd
 = 1;

656 
m­_Ën
 = 
	`nvme_m­_Ën
(
»q
);

657 
»t
 = 
	`nvme_š™_iod
(
»q
, 
m­_Ën
, 
dev
);

658 ià(
»t
)

659 
out
;

663 ià(!
b_kv_cmd
) {

664 #ifdeà
REPORT_NON_KV


665 
	`´_”r
("nvme_queue_rq:‚Ú-kv-İcod(%02xèns_id(%d)\n", 
cmnd
.
commÚ
.
İcode
, ((
ns
)?‚s->
ns_id
 : 0));

669 ià(
»q
->
Ä_phys_£gm’ts
 || 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
))

670 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, 
m­_Ën
, &
cmnd
);

672 ià(
»t
 !ğ
BLK_MQ_RQ_QUEUE_OK
)

673 
out
;

677 
m­_Ën
 = 
	`nvme_m­_Ën
(
»q
);

678 
»t
 = 
	`nvme_š™_iod
(
»q
, 
m­_Ën
, 
dev
);

679 ià(
»t
 !ğ
BLK_MQ_RQ_QUEUE_OK
)

680  
»t
;

682 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
»q
, &
cmnd
);

683 ià(
»t
 !ğ
BLK_MQ_RQ_QUEUE_OK
)

684 
out
;

686 ià(
»q
->
Ä_phys_£gm’ts
)

687 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, 
m­_Ën
, &
cmnd
);

689 ià(
»t
 !ğ
BLK_MQ_RQ_QUEUE_OK
)

690 
out
;

692 
	`blk_mq_¡¬t_»que¡
(
»q
);

694 #ifdeà
KV_NVME_DUMMY_OP


695 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

696 #ifdeà
KV_NVME_DUMMY_OP_REPORT


697 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

698 
	`´_”r
("[dump‚vme kv comand]\n");

699 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

700 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

701 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

702 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

703 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

704 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

705 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

706 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

707 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

708 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

709 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

710 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

711 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

712 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

713 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

714 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

715 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

716 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

718 ià(
	`is_kv_»Œ›ve_cmd
(
cmnd
.
commÚ
.
İcode
)) {

719 
	`nvme_»q
(
»q
)->
»suÉ
 = 
cmnd
.
commÚ
.
cdw10
[5];

721 
	`blk_mq_com¶‘e_»que¡
(
»q
, 0);

722  
BLK_MQ_RQ_QUEUE_OK
;

725 #ifdeà
KV_NVME_OP_REPORT


726 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

727 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

728 
	`´_”r
("[dump‚vme kv comand]\n");

729 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

730 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

731 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

732 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

733 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

734 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

735 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

736 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

737 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

738 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

739 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

740 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

741 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

742 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

743 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

744 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

745 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

746 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

751 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

752 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0)) {

753 ià(
ns
 && !
	`‹¡_b™
(
NVME_NS_DEAD
, &ns->
æags
))

754 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

756 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

757 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

758 
out
;

760 
	`__nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

761 
	`nvme_´oûss_cq
(
nvmeq
);

762 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

763  
BLK_MQ_RQ_QUEUE_OK
;

764 
out
:

765 
	`nvme_ä“_iod
(
dev
, 
»q
);

766  
»t
;

767 
	}
}

769 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

771 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

772 
nvme_dev
 *
dev
 = 
iod
->
nvmeq
->dev;

773 
”rÜ
 = 0;

775 
	`nvme_unm­_d©a
(
dev
, 
»q
);

777 ià(
	`uÆik–y
(
»q
->
”rÜs
)) {

778 ià(
	`nvme_»q_Ãeds_»Œy
(
»q
,„eq->
”rÜs
)) {

779 
»q
->
»Œ›s
++;

780 
	`nvme_»queue_»q
(
»q
);

784 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

785 
”rÜ
 = 
»q
->
”rÜs
;

787 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
»q
->
”rÜs
);

790 ià(
	`uÆik–y
(
iod
->
abÜ‹d
)) {

791 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

793 
»q
->
”rÜs
);

796 
	`blk_mq_’d_»que¡
(
»q
, 
”rÜ
);

797 
	}
}

800 
šlše
 
boŞ
 
	$nvme_cqe_v®id
(
nvme_queue
 *
nvmeq
, 
u16
 
h—d
,

801 
u16
 
pha£
)

803  (
	`Ë16_to_ıu
(
nvmeq
->
cqes
[
h—d
].
¡©us
è& 1è=ğ
pha£
;

804 
	}
}

806 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

808 
u16
 
h—d
, 
pha£
;

810 
h—d
 = 
nvmeq
->
cq_h—d
;

811 
pha£
 = 
nvmeq
->
cq_pha£
;

813 
	`nvme_cqe_v®id
(
nvmeq
, 
h—d
, 
pha£
)) {

814 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[
h—d
];

815 
»que¡
 *
»q
;

817 ià(++
h—d
 =ğ
nvmeq
->
q_d•th
) {

818 
h—d
 = 0;

819 
pha£
 = !phase;

823 ià(
	`uÆik–y
(
cqe
.
commªd_id
 >ğ
nvmeq
->
q_d•th
)) {

824 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

826 
cqe
.
commªd_id
, 
	`Ë16_to_ıu
(cqe.
sq_id
));

836 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

837 
cqe
.
commªd_id
 >ğ
NVME_AQ_BLKMQ_DEPTH
)) {

838 
	`nvme_com¶‘e_async_ev’t
(&
nvmeq
->
dev
->
ù¾
,

839 
cqe
.
¡©us
, &cqe.
»suÉ
);

843 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
.
commªd_id
);

844 
	`nvme_»q
(
»q
)->
»suÉ
 = 
cqe
.result;

845 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
	`Ë16_to_ıu
(
cqe
.
¡©us
) >> 1);

848 ià(
h—d
 =ğ
nvmeq
->
cq_h—d
 && 
pha£
 =ğnvmeq->
cq_pha£
)

851 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0))

852 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

853 
nvmeq
->
cq_h—d
 = 
h—d
;

854 
nvmeq
->
cq_pha£
 = 
pha£
;

856 
nvmeq
->
cqe_£’
 = 1;

858 
	}
}

860 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

862 
œq»tuº_t
 
»suÉ
;

863 
nvme_queue
 *
nvmeq
 = 
d©a
;

864 
	`¥š_lock
(&
nvmeq
->
q_lock
);

865 
	`nvme_´oûss_cq
(
nvmeq
);

866 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

867 
nvmeq
->
cqe_£’
 = 0;

868 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

869  
»suÉ
;

870 
	}
}

872 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

874 
nvme_queue
 *
nvmeq
 = 
d©a
;

875 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

876  
IRQ_WAKE_THREAD
;

877  
IRQ_NONE
;

878 
	}
}

880 
	$nvme_pci_subm™_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
«r_idx
)

882 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

883 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

884 
nvme_commªd
 
c
;

886 
	`mem£t
(&
c
, 0, (c));

887 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

888 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLKMQ_DEPTH
 + 
«r_idx
;

890 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

891 
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

892 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

893 
	}
}

895 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

897 
nvme_commªd
 
c
;

899 
	`mem£t
(&
c
, 0, (c));

900 
c
.
d–‘e_queue
.
İcode
 = opcode;

901 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

903  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

904 
	}
}

906 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

907 
nvme_queue
 *
nvmeq
)

909 
nvme_commªd
 
c
;

910 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

916 
	`mem£t
(&
c
, 0, (c));

917 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

918 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

919 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

920 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

921 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

922 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

924  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

925 
	}
}

927 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

928 
nvme_queue
 *
nvmeq
)

930 
nvme_commªd
 
c
;

931 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_SQ_PRIO_MEDIUM
;

937 
	`mem£t
(&
c
, 0, (c));

938 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

939 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

940 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

941 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

942 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

943 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

945  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

946 
	}
}

948 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

950  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

951 
	}
}

953 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

955  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

956 
	}
}

958 
	$abÜt_’dio
(
»que¡
 *
»q
, 
”rÜ
)

960 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

961 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

962 
u16
 
¡©us
 = 
»q
->
”rÜs
;

964 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
, "AbÜˆ¡©us: 0x%x", 
¡©us
);

965 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

966 
	`blk_mq_ä“_»que¡
(
»q
);

967 
	}
}

969 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

971 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

972 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

973 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

974 
»que¡
 *
abÜt_»q
;

975 
nvme_commªd
 
cmd
;

983 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
) {

984 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

986 
»q
->
g
, 
nvmeq
->
qid
);

987 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

988 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

989  
BLK_EH_HANDLED
;

997 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

998 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1000 
»q
->
g
, 
nvmeq
->
qid
);

1001 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1002 
	`nvme_»£t
(
dev
);

1008 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1009  
BLK_EH_HANDLED
;

1012 #ifdeà
REPORT_TIMEOUT


1014 
nvme_ns
 *
ns
 = 
NULL
;

1015 
cmd
.
commÚ
.
nsid
 = 0;

1016 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

1017 
	`memıy
(&
cmd
, 
»q
->cmd,  (
nvme_commªd
));

1019 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
) {

1020 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1021 } ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
) {

1022 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_dsm
;

1024 
cmd
.
commÚ
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
: 
nvme_cmd_»ad
);

1026 ià(
»q
->
rq_disk
) {

1027 
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

1028 ià(
ns
è
cmd
.
commÚ
.
nsid
 =‚s->
ns_id
;

1031 ià(
iod
->
kv_cmd
)

1033 
__u32
 *
d©a
 = (__u32*è
cmd
.
commÚ
.
cdw2
;

1034 
	`´_”r
("nvme_timeout: opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1035 
	`´_”r
("[dump‚vme kv comand]\n");

1036 
	`´_”r
("\tİcode:(%02x)\n", 
cmd
.
commÚ
.
İcode
);

1037 
	`´_”r
("\tæags:(%02x)\n", 
cmd
.
commÚ
.
æags
);

1038 
	`´_”r
("\tcommªd id:(%04x)\n", 
»q
->
g
);

1039 
	`´_”r
("\Š id:(%08x)\n", 
cmd
.
commÚ
.
nsid
);

1040 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

1041 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

1042 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

1043 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

1044 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

1045 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

1046 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

1047 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

1048 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

1049 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

1050 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

1051 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

1052 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

1053 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

1055 
	`´_”r
("nvme_timeout:‚Ú kv opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1060 
iod
->
abÜ‹d
 = 1;

1062 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1063 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1064  
BLK_EH_RESET_TIMER
;

1067 
	`mem£t
(&
cmd
, 0, (cmd));

1068 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1069 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1070 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1072 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1074 
»q
->
g
, 
nvmeq
->
qid
);

1076 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1077 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1078 ià(
	`IS_ERR
(
abÜt_»q
)) {

1079 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1080  
BLK_EH_RESET_TIMER
;

1083 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1084 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1085 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1092  
BLK_EH_RESET_TIMER
;

1093 
	}
}

1095 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1097 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1098 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1099 ià(
nvmeq
->
sq_cmds
)

1100 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1101 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1102 
	`kä“
(
nvmeq
);

1103 
	}
}

1105 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1107 
i
;

1109 
i
 = 
dev
->
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1110 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1111 
dev
->
queue_couÁ
--;

1112 
dev
->
queues
[
i
] = 
NULL
;

1113 
	`nvme_ä“_queue
(
nvmeq
);

1115 
	}
}

1121 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1123 
veùÜ
;

1125 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1126 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1127 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1130 
veùÜ
 = 
nvmeq
->
dev
->
’Œy
[nvmeq->
cq_veùÜ
].vector;

1131 
nvmeq
->
dev
->
Úlše_queues
--;

1132 
nvmeq
->
cq_veùÜ
 = -1;

1133 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1135 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1136 
	`blk_mq_¡İ_hw_queues
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1138 
	`œq_£t_affš™y_hšt
(
veùÜ
, 
NULL
);

1139 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1142 
	}
}

1144 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1146 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1148 ià(!
nvmeq
)

1150 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1153 ià(
shutdown
)

1154 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1156 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
	`lo_hi_»adq
(

1157 
dev
->
b¬
 + 
NVME_REG_CAP
));

1159 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1160 
	`nvme_´oûss_cq
(
nvmeq
);

1161 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1162 
	}
}

1164 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1165 
’Œy_size
)

1167 
q_d•th
 = 
dev
->q_depth;

1168 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1169 
dev
->
ù¾
.
·ge_size
);

1171 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1172 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1173 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1174 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1181 ià(
q_d•th
 < 64)

1182  -
ENOMEM
;

1185  
q_d•th
;

1186 
	}
}

1188 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1189 
qid
, 
d•th
)

1191 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1192 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
d•th
),

1193 
dev
->
ù¾
.
·ge_size
);

1194 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_dma_addr
 + 
off£t
;

1195 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1197 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1198 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1199 ià(!
nvmeq
->
sq_cmds
)

1200  -
ENOMEM
;

1204 
	}
}

1206 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1207 
d•th
)

1209 
nvme_queue
 *
nvmeq
 = 
	`kz®loc
((*nvmeq), 
GFP_KERNEL
);

1210 ià(!
nvmeq
)

1211  
NULL
;

1213 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1214 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1215 ià(!
nvmeq
->
cqes
)

1216 
ä“_nvmeq
;

1217 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
(
d•th
));

1219 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1220 
ä“_cqdma
;

1222 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1223 
nvmeq
->
dev
 = dev;

1224 
	`¢´štf
(
nvmeq
->
œqÇme
, (nvmeq->irqname), "nvme%dq%d",

1225 
dev
->
ù¾
.
š¡ªû
, 
qid
);

1226 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1227 
nvmeq
->
cq_h—d
 = 0;

1228 
nvmeq
->
cq_pha£
 = 1;

1229 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1230 
nvmeq
->
q_d•th
 = 
d•th
;

1231 
nvmeq
->
qid
 = qid;

1232 
nvmeq
->
cq_veùÜ
 = -1;

1233 
dev
->
queues
[
qid
] = 
nvmeq
;

1234 
dev
->
queue_couÁ
++;

1236  
nvmeq
;

1238 
ä“_cqdma
:

1239 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1240 
nvmeq
->
cq_dma_addr
);

1241 
ä“_nvmeq
:

1242 
	`kä“
(
nvmeq
);

1243  
NULL
;

1244 
	}
}

1246 
	$queue_»que¡_œq
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1247 cÚ¡ *
Çme
)

1249 ià(
u£_th»aded_š‹¼u±s
)

1250  
	`»que¡_th»aded_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1251 
nvme_œq_check
, 
nvme_œq
, 
IRQF_SHARED
,

1252 
Çme
, 
nvmeq
);

1253  
	`»que¡_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
, 
nvme_œq
,

1254 
IRQF_SHARED
, 
Çme
, 
nvmeq
);

1255 
	}
}

1257 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1259 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1261 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1262 
nvmeq
->
sq_
 = 0;

1263 
nvmeq
->
cq_h—d
 = 0;

1264 
nvmeq
->
cq_pha£
 = 1;

1265 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1266 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1267 
dev
->
Úlše_queues
++;

1268 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1269 
	}
}

1271 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1273 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1274 
»suÉ
;

1276 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1277 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1278 ià(
»suÉ
 < 0)

1279  
»suÉ
;

1281 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1282 ià(
»suÉ
 < 0)

1283 
»Ëa£_cq
;

1285 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1286 ià(
»suÉ
 < 0)

1287 
»Ëa£_sq
;

1289 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1290  
»suÉ
;

1292 
»Ëa£_sq
:

1293 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1294 
»Ëa£_cq
:

1295 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1296  
»suÉ
;

1297 
	}
}

1300 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1301 .
queue_rq
 = 
nvme_queue_rq
,

1302 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1303 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1304 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1305 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1306 .
	gš™_»que¡
 = 
nvme_admš_š™_»que¡
,

1307 .
	gtimeout
 = 
nvme_timeout
,

1310 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1311 .
queue_rq
 = 
nvme_queue_rq
,

1312 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1313 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1314 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1315 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1316 .
	gtimeout
 = 
nvme_timeout
,

1319 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1321 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1327 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1328 
	`blk_ş—nup_queue
(
dev
->
ù¾
.
admš_q
);

1329 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1331 
	}
}

1333 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1335 ià(!
dev
->
ù¾
.
admš_q
) {

1336 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1337 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1343 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_BLKMQ_DEPTH
 - 1;

1344 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1345 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1346 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1347 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1349 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1350  -
ENOMEM
;

1352 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1353 ià(!
dev
->
ù¾
.
admš_q
) {

1354 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1355  -
ENOMEM
;

1357 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1358 
	`nvme_dev_»move_admš
(
dev
);

1359 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1360  -
ENODEV
;

1363 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1366 
	}
}

1368 
	$nvme_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1370 
»suÉ
;

1371 
u32
 
aqa
;

1372 
u64
 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

1373 
nvme_queue
 *
nvmeq
;

1375 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 1, 0) ?

1376 
	`NVME_CAP_NSSRC
(
ÿp
) : 0;

1378 ià(
dev
->
subsy¡em
 &&

1379 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1380 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1382 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1383 ià(
»suÉ
 < 0)

1384  
»suÉ
;

1386 
nvmeq
 = 
dev
->
queues
[0];

1387 ià(!
nvmeq
) {

1388 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1389 ià(!
nvmeq
)

1390  -
ENOMEM
;

1393 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1394 
aqa
 |=‡qa << 16;

1396 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1397 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1398 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

1400 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1401 ià(
»suÉ
)

1402  
»suÉ
;

1404 
nvmeq
->
cq_veùÜ
 = 0;

1405 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1406 ià(
»suÉ
) {

1407 
nvmeq
->
cq_veùÜ
 = -1;

1408  
»suÉ
;

1411  
»suÉ
;

1412 
	}
}

1414 
boŞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1420 
boŞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1423 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

1424  
çl£
;

1429 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1430  
çl£
;

1435 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1436  
çl£
;

1438  
Œue
;

1439 
	}
}

1441 
	$nvme_w¬n_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1444 
u16
 
pci_¡©us
;

1445 
»suÉ
;

1447 
»suÉ
 = 
	`pci_»ad_cÚfig_wÜd
(
	`to_pci_dev
(
dev
->dev), 
PCI_STATUS
,

1448 &
pci_¡©us
);

1449 ià(
»suÉ
 =ğ
PCIBIOS_SUCCESSFUL
)

1450 
	`dev_w¬n
(
dev
->dev,

1452 
c¡s
, 
pci_¡©us
);

1454 
	`dev_w¬n
(
dev
->dev,

1456 
c¡s
, 
»suÉ
);

1457 
	}
}

1459 
	$nvme_w©chdog_tim”
(
d©a
)

1461 
nvme_dev
 *
dev
 = (nvme_dev *)
d©a
;

1462 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1465 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1466 ià(!
	`nvme_»£t
(
dev
))

1467 
	`nvme_w¬n_»£t
(
dev
, 
c¡s
);

1471 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

1472 
	}
}

1474 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

1476 
i
, 
max
;

1477 
»t
 = 0;

1479 
i
 = 
dev
->
queue_couÁ
; i <ğdev->
max_qid
; i++) {

1480 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
)) {

1481 
»t
 = -
ENOMEM
;

1486 
max
 = 
	`mš
(
dev
->
max_qid
, dev->
queue_couÁ
 - 1);

1487 
i
 = 
dev
->
Úlše_queues
; i <ğ
max
; i++) {

1488 
»t
 = 
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i);

1489 ià(
»t
)

1499  
»t
 >= 0 ? 0 :„et;

1500 
	}
}

1502 
ssize_t
 
	$nvme_cmb_show
(
deviû
 *
dev
,

1503 
deviû_©Œibu‹
 *
©Œ
,

1504 *
buf
)

1506 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_g‘_drvd©a
(
dev
));

1508  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "cmbloc : x%08x\ncmbsz : x%08x\n",

1509 
ndev
->
cmbloc
,‚dev->
cmbsz
);

1510 
	}
}

1511 
DEVICE_ATTR
(
cmb
, 
S_IRUGO
, 
nvme_cmb_show
, 
NULL
);

1513 
__iomem
 *
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

1515 
u64
 
szu
, 
size
, 
off£t
;

1516 
»sourû_size_t
 
b¬_size
;

1517 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1518 
__iomem
 *
cmb
;

1519 
dma_addr_t
 
dma_addr
;

1521 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

1522 ià(!(
	`NVME_CMB_SZ
(
dev
->
cmbsz
)))

1523  
NULL
;

1524 
dev
->
cmbloc
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBLOC
);

1526 ià(!
u£_cmb_sqes
)

1527  
NULL
;

1529 
szu
 = (
u64
)1 << (12 + 4 * 
	`NVME_CMB_SZU
(
dev
->
cmbsz
));

1530 
size
 = 
szu
 * 
	`NVME_CMB_SZ
(
dev
->
cmbsz
);

1531 
off£t
 = 
szu
 * 
	`NVME_CMB_OFST
(
dev
->
cmbloc
);

1532 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
	`NVME_CMB_BIR
(
dev
->
cmbloc
));

1534 ià(
off£t
 > 
b¬_size
)

1535  
NULL
;

1542 ià(
size
 > 
b¬_size
 - 
off£t
)

1543 
size
 = 
b¬_size
 - 
off£t
;

1545 
dma_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
	`NVME_CMB_BIR
(
dev
->
cmbloc
)è+ 
off£t
;

1546 
cmb
 = 
	`iÜem­_wc
(
dma_addr
, 
size
);

1547 ià(!
cmb
)

1548  
NULL
;

1550 
dev
->
cmb_dma_addr
 = 
dma_addr
;

1551 
dev
->
cmb_size
 = 
size
;

1552  
cmb
;

1553 
	}
}

1555 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

1557 ià(
dev
->
cmb
) {

1558 
	`iounm­
(
dev
->
cmb
);

1559 
dev
->
cmb
 = 
NULL
;

1561 
	}
}

1563 
size_t
 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1565  4096 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1566 
	}
}

1568 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

1570 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

1571 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1572 
»suÉ
, 
i
, 
vecs
, 
Ä_io_queues
, 
size
;

1574 
Ä_io_queues
 = 
	`num_Úlše_ıus
();

1575 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

1576 ià(
»suÉ
 < 0)

1577  
»suÉ
;

1579 ià(
Ä_io_queues
 == 0)

1582 ià(
dev
->
cmb
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1583 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

1584 (
nvme_commªd
));

1585 ià(
»suÉ
 > 0)

1586 
dev
->
q_d•th
 = 
»suÉ
;

1588 
	`nvme_»Ëa£_cmb
(
dev
);

1591 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1592 ià(
size
 > 8192) {

1593 
	`iounm­
(
dev
->
b¬
);

1595 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1596 ià(
dev
->
b¬
)

1598 ià(!--
Ä_io_queues
)

1599  -
ENOMEM
;

1600 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1602 
dev
->
dbs
 = dev->
b¬
 + 4096;

1603 
admšq
->
q_db
 = 
dev
->
dbs
;

1607 
	`ä“_œq
(
dev
->
’Œy
[0].
veùÜ
, 
admšq
);

1613 ià(
pdev
->
msi_’abËd
)

1614 
	`pci_di§bË_msi
(
pdev
);

1615 ià(
pdev
->
msix_’abËd
)

1616 
	`pci_di§bË_msix
(
pdev
);

1618 
i
 = 0; i < 
Ä_io_queues
; i++)

1619 
dev
->
’Œy
[
i
].entry = i;

1620 
vecs
 = 
	`pci_’abË_msix_¿nge
(
pdev
, 
dev
->
’Œy
, 1, 
Ä_io_queues
);

1621 ià(
vecs
 < 0) {

1622 
vecs
 = 
	`pci_’abË_msi_¿nge
(
pdev
, 1, 
	`mš
(
Ä_io_queues
, 32));

1623 ià(
vecs
 < 0) {

1624 
vecs
 = 1;

1626 
i
 = 0; i < 
vecs
; i++)

1627 
dev
->
’Œy
[
i
].
veùÜ
 = i + 
pdev
->
œq
;

1637 
Ä_io_queues
 = 
vecs
;

1638 
dev
->
max_qid
 = 
Ä_io_queues
;

1640 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
admšq
,‡dmšq->
œqÇme
);

1641 ià(
»suÉ
) {

1642 
admšq
->
cq_veùÜ
 = -1;

1643  
»suÉ
;

1645  
	`nvme_ü—‹_io_queues
(
dev
);

1646 
	}
}

1648 
	$nvme_pci_po¡_sÿn
(
nvme_ù¾
 *
ù¾
)

1650 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

1651 
nvme_queue
 *
nvmeq
;

1652 
i
;

1654 
i
 = 0; i < 
dev
->
Úlše_queues
; i++) {

1655 
nvmeq
 = 
dev
->
queues
[
i
];

1657 ià(!
nvmeq
->
gs
 || !(*nvmeq->tags))

1660 
	`œq_£t_affš™y_hšt
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1661 
	`blk_mq_gs_ıumask
(*
nvmeq
->
gs
));

1663 
	}
}

1665 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
”rÜ
)

1667 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

1669 
	`blk_mq_ä“_»que¡
(
»q
);

1670 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

1671 
	}
}

1673 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
”rÜ
)

1675 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

1677 ià(!
”rÜ
) {

1678 
æags
;

1685 
	`¥š_lock_œq§ve_Ã¡ed
(&
nvmeq
->
q_lock
, 
æags
,

1686 
SINGLE_DEPTH_NESTING
);

1687 
	`nvme_´oûss_cq
(
nvmeq
);

1688 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

1691 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

1692 
	}
}

1694 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
)

1696 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

1697 
»que¡
 *
»q
;

1698 
nvme_commªd
 
cmd
;

1700 
	`mem£t
(&
cmd
, 0, (cmd));

1701 
cmd
.
d–‘e_queue
.
İcode
 = opcode;

1702 
cmd
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

1704 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1705 ià(
	`IS_ERR
(
»q
))

1706  
	`PTR_ERR
(
»q
);

1708 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1709 
»q
->
’d_io_d©a
 = 
nvmeq
;

1711 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

1712 
İcode
 =ğ
nvme_admš_d–‘e_cq
 ?

1713 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

1715 
	}
}

1717 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
, 
queues
)

1719 
·ss
;

1720 
timeout
;

1721 
u8
 
İcode
 = 
nvme_admš_d–‘e_sq
;

1723 
·ss
 = 0;…ass < 2;…ass++) {

1724 
£Á
 = 0, 
i
 = 
queues
;

1726 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

1727 
»Œy
:

1728 
timeout
 = 
ADMIN_TIMEOUT
;

1729 ; 
i
 > 0; i--, 
£Á
++)

1730 ià(
	`nvme_d–‘e_queue
(
dev
->
queues
[
i
], 
İcode
))

1733 
£Á
--) {

1734 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

1735 ià(
timeout
 == 0)

1737 ià(
i
)

1738 
»Œy
;

1740 
İcode
 = 
nvme_admš_d–‘e_cq
;

1742 
	}
}

1750 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

1752 ià(!
dev
->
ù¾
.
g£t
) {

1753 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

1754 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

1755 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

1756 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1757 
dev
->
g£t
.
queue_d•th
 =

1758 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

1759 
dev
->
g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1760 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

1761 
dev
->
g£t
.
driv”_d©a
 = dev;

1763 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

1765 
dev
->
ù¾
.
g£t
 = &dev->tagset;

1767 
	`blk_mq_upd©e_Ä_hw_queues
(&
dev
->
g£t
, dev->
Úlše_queues
 - 1);

1770 
	`nvme_ä“_queues
(
dev
, dev->
Úlše_queues
);

1774 
	}
}

1776 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

1778 
u64
 
ÿp
;

1779 
»suÉ
 = -
ENOMEM
;

1780 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1782 ià(
	`pci_’abË_deviû_mem
(
pdev
))

1783  
»suÉ
;

1785 
	`pci_£t_ma¡”
(
pdev
);

1787 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

1788 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

1789 
di§bË
;

1791 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

1792 
»suÉ
 = -
ENODEV
;

1793 
di§bË
;

1801 ià(
	`pci_’abË_msix
(
pdev
, 
dev
->
’Œy
, 1)) {

1802 
	`pci_’abË_msi
(
pdev
);

1803 
dev
->
’Œy
[0].
veùÜ
 = 
pdev
->
œq
;

1806 ià(!
dev
->
’Œy
[0].
veùÜ
) {

1807 
»suÉ
 = -
ENODEV
;

1808 
di§bË
;

1811 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

1813 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ÿp
è+ 1, 
NVME_Q_DEPTH
);

1814 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(
ÿp
);

1815 
dev
->
dbs
 = dev->
b¬
 + 4096;

1824 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 2, 0)) {

1825 
dev
->
cmb
 = 
	`nvme_m­_cmb
(dev);

1827 ià(
dev
->
cmbsz
) {

1828 ià(
	`sysfs_add_fe_to_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

1829 &
dev_©Œ_cmb
.
©Œ
, 
NULL
))

1830 
	`dev_w¬n
(
dev
->dev,

1835 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

1836 
	`pci_§ve_¡©e
(
pdev
);

1839 
di§bË
:

1840 
	`pci_di§bË_deviû
(
pdev
);

1841  
»suÉ
;

1842 
	}
}

1844 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

1846 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1847 
b¬s
;

1849 ià(
dev
->
b¬
)

1850 
	`iounm­
(
dev
->
b¬
);

1852 
b¬s
 = 
	`pci_£Ëù_b¬s
(
pdev
, 
IORESOURCE_MEM
);

1853 
	`pci_»Ëa£_£Ëùed_»giÚs
(
pdev
, 
b¬s
);

1854 
	}
}

1856 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

1858 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1860 ià(
pdev
->
msi_’abËd
)

1861 
	`pci_di§bË_msi
(
pdev
);

1862 ià(
pdev
->
msix_’abËd
)

1863 
	`pci_di§bË_msix
(
pdev
);

1865 ià(
	`pci_is_’abËd
(
pdev
)) {

1866 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

1867 
	`pci_di§bË_deviû
(
pdev
);

1869 
	}
}

1871 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1873 
i
, 
queues
;

1874 
boŞ
 
d—d
 = 
Œue
;

1875 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1877 
	`d–_tim”_sync
(&
dev
->
w©chdog_tim”
);

1879 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

1880 ià(
	`pci_is_’abËd
(
pdev
)) {

1881 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1883 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_LIVE
)

1884 
	`nvme_¡¬t_ä“ze
(&
dev
->
ù¾
);

1885 
d—d
 = !!((
c¡s
 & 
NVME_CSTS_CFS
è|| !(c¡ & 
NVME_CSTS_RDY
) ||

1886 
pdev
->
”rÜ_¡©e
 !ğ
pci_chªÃl_io_nÜm®
);

1893 ià(!
d—d
 && 
shutdown
)

1894 
	`nvme_wa™_ä“ze_timeout
(&
dev
->
ù¾
, 
NVME_IO_TIMEOUT
);

1895 
	`nvme_¡İ_queues
(&
dev
->
ù¾
);

1897 
queues
 = 
dev
->
Úlše_queues
 - 1;

1898 
i
 = 
dev
->
queue_couÁ
 - 1; i > 0; i--)

1899 
	`nvme_su¥’d_queue
(
dev
->
queues
[
i
]);

1901 ià(
d—d
) {

1906 ià(
dev
->
queue_couÁ
)

1907 
	`nvme_su¥’d_queue
(
dev
->
queues
[0]);

1909 
	`nvme_di§bË_io_queues
(
dev
, 
queues
);

1910 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

1912 
	`nvme_pci_di§bË
(
dev
);

1914 
	`blk_mq_g£t_busy_™”
(&
dev
->
g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

1915 
	`blk_mq_g£t_busy_™”
(&
dev
->
admš_g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

1922 ià(
shutdown
)

1923 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

1924 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

1925 
	}
}

1927 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

1929 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist…age", dev->dev,

1930 
PAGE_SIZE
, PAGE_SIZE, 0);

1931 ià(!
dev
->
´p_·ge_poŞ
)

1932  -
ENOMEM
;

1935 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist 256", dev->dev,

1937 ià(!
dev
->
´p_sm®l_poŞ
) {

1938 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

1939  -
ENOMEM
;

1942 
	}
}

1944 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

1946 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

1947 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

1948 
	}
}

1950 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

1952 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

1954 
	`put_deviû
(
dev
->dev);

1955 ià(
dev
->
g£t
.
gs
)

1956 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

1957 ià(
dev
->
ù¾
.
admš_q
)

1958 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

1959 
	`kä“
(
dev
->
queues
);

1960 
	`kä“
(
dev
->
’Œy
);

1961 
	`kä“
(
dev
);

1962 
	}
}

1964 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
, 
¡©us
)

1966 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "Removšg‡á”…robçu» stus: %d\n", 
¡©us
);

1968 
	`k»f_g‘
(&
dev
->
ù¾
.
k»f
);

1969 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1970 ià(!
	`scheduË_wÜk
(&
dev
->
»move_wÜk
))

1971 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

1972 
	}
}

1974 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1976 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»£t_wÜk
);

1977 
»suÉ
 = -
ENODEV
;

1979 ià(
	`WARN_ON
(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
))

1980 
out
;

1986 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

1987 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1989 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_RESETTING
))

1990 
out
;

1992 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

1993 ià(
»suÉ
)

1994 
out
;

1996 
»suÉ
 = 
	`nvme_cÚfigu»_admš_queue
(
dev
);

1997 ià(
»suÉ
)

1998 
out
;

2000 
	`nvme_š™_queue
(
dev
->
queues
[0], 0);

2001 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2002 ià(
»suÉ
)

2003 
out
;

2005 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2006 ià(
»suÉ
)

2007 
out
;

2009 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2010 ià(
»suÉ
)

2011 
out
;

2019 ià(
dev
->
Úlše_queues
 > 1)

2020 
	`nvme_queue_async_ev’ts
(&
dev
->
ù¾
);

2022 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

2028 ià(
dev
->
Úlše_queues
 < 2) {

2029 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "IO queues‚ot created\n");

2030 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2031 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2033 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2034 
	`nvme_wa™_ä“ze
(&
dev
->
ù¾
);

2035 
	`nvme_dev_add
(
dev
);

2036 
	`nvme_unä“ze
(&
dev
->
ù¾
);

2039 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_LIVE
)) {

2040 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "failedo mark controller†ive\n");

2041 
out
;

2044 ià(
dev
->
Úlše_queues
 > 1)

2045 
	`nvme_queue_sÿn
(&
dev
->
ù¾
);

2048 
out
:

2049 
	`nvme_»move_d—d_ù¾
(
dev
, 
»suÉ
);

2050 
	}
}

2052 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2054 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2055 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2057 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2058 ià(
	`pci_g‘_drvd©a
(
pdev
))

2059 
	`deviû_»Ëa£_driv”
(&
pdev
->
dev
);

2060 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2061 
	}
}

2063 
	$nvme_»£t
(
nvme_dev
 *
dev
)

2065 ià(!
dev
->
ù¾
.
admš_q
 || 
	`blk_queue_dyšg
(dev->ctrl.admin_q))

2066  -
ENODEV
;

2067 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

2068  -
ENODEV
;

2069 ià(!
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
))

2070  -
EBUSY
;

2072 
	}
}

2074 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2076 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2078 
	}
}

2080 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2082 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2084 
	}
}

2086 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2088 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2090 
	}
}

2092 
	$nvme_pci_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

2094 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2095 
»t
 = 
	`nvme_»£t
(
dev
);

2097 ià(!
»t
)

2098 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2099  
»t
;

2100 
	}
}

2102 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_pci_ù¾_İs
 = {

2103 .
Çme
 = "pcie",

2104 .
	gmoduË
 = 
THIS_MODULE
,

2105 .
	g»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2106 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2107 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2108 .
	g»£t_ù¾
 = 
nvme_pci_»£t_ù¾
,

2109 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2110 .
	gpo¡_sÿn
 = 
nvme_pci_po¡_sÿn
,

2111 .
	gsubm™_async_ev’t
 = 
nvme_pci_subm™_async_ev’t
,

2114 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2116 
b¬s
;

2117 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2119 
b¬s
 = 
	`pci_£Ëù_b¬s
(
pdev
, 
IORESOURCE_MEM
);

2120 ià(!
b¬s
)

2121  -
ENODEV
;

2122 ià(
	`pci_»que¡_£Ëùed_»giÚs
(
pdev
, 
b¬s
, "nvme"))

2123  -
ENODEV
;

2125 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 8192);

2126 ià(!
dev
->
b¬
)

2127 
»Ëa£
;

2130 
»Ëa£
:

2131 
	`pci_»Ëa£_£Ëùed_»giÚs
(
pdev
, 
b¬s
);

2132  -
ENODEV
;

2133 
	}
}

2135 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2137 
node
, 
»suÉ
 = -
ENOMEM
;

2138 
nvme_dev
 *
dev
;

2140 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2141 ià(
node
 =ğ
NUMA_NO_NODE
)

2142 
	`£t_dev_node
(&
pdev
->
dev
, 
fœ¡_memÜy_node
);

2144 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

2145 ià(!
dev
)

2146  -
ENOMEM
;

2147 
dev
->
’Œy
 = 
	`kz®loc_node
(
	`num_possibË_ıus
() * (*dev->entry),

2148 
GFP_KERNEL
, 
node
);

2149 ià(!
dev
->
’Œy
)

2150 
ä“
;

2151 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

2152 
GFP_KERNEL
, 
node
);

2153 ià(!
dev
->
queues
)

2154 
ä“
;

2156 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

2157 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2159 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

2160 ià(
»suÉ
)

2161 
ä“
;

2163 
	`INIT_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_wÜk
);

2164 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

2165 
	`£tup_tim”
(&
dev
->
w©chdog_tim”
, 
nvme_w©chdog_tim”
,

2166 ()
dev
);

2167 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

2168 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2170 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2171 ià(
»suÉ
)

2172 
put_pci
;

2174 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_İs
,

2175 
id
->
driv”_d©a
);

2176 ià(
»suÉ
)

2177 
»Ëa£_poŞs
;

2179 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "pc˜funùiÚ %s\n", 
	`dev_Çme
(&
pdev
->dev));

2181 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2184 
»Ëa£_poŞs
:

2185 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2186 
put_pci
:

2187 
	`put_deviû
(
dev
->dev);

2188 
	`nvme_dev_unm­
(
dev
);

2189 
ä“
:

2190 
	`kä“
(
dev
->
queues
);

2191 
	`kä“
(
dev
->
’Œy
);

2192 
	`kä“
(
dev
);

2193  
»suÉ
;

2194 
	}
}

2196 
	$nvme_»£t_nÙify
(
pci_dev
 *
pdev
, 
boŞ
 
´•¬e
)

2198 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2200 ià(
´•¬e
)

2201 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2203 
	`nvme_»£t
(
dev
);

2204 
	}
}

2206 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2208 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2209 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2210 
	}
}

2217 
	$nvme_»move
(
pci_dev
 *
pdev
)

2219 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2221 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DELETING
);

2223 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2225 ià(!
	`pci_deviû_is_´e£Á
(
pdev
))

2226 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DEAD
);

2228 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2229 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

2230 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2231 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2232 
	`nvme_dev_»move_admš
(
dev
);

2233 
	`nvme_ä“_queues
(
dev
, 0);

2234 
	`nvme_»Ëa£_cmb
(
dev
);

2235 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2236 
	`nvme_dev_unm­
(
dev
);

2237 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2238 
	}
}

2240 
	$nvme_pci_¤iov_cÚfigu»
(
pci_dev
 *
pdev
, 
numvfs
)

2242 
»t
 = 0;

2244 ià(
numvfs
 == 0) {

2245 ià(
	`pci_vfs_assigÃd
(
pdev
)) {

2246 
	`dev_w¬n
(&
pdev
->
dev
,

2248  -
EPERM
;

2250 
	`pci_di§bË_¤iov
(
pdev
);

2254 
»t
 = 
	`pci_’abË_¤iov
(
pdev
, 
numvfs
);

2255  
»t
 ?„‘ : 
numvfs
;

2256 
	}
}

2258 
	$nvme_su¥’d
(
deviû
 *
dev
)

2260 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2261 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2263 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

2265 
	}
}

2267 
	$nvme_»sume
(
deviû
 *
dev
)

2269 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2270 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2272 
	`nvme_»£t
(
ndev
);

2274 
	}
}

2276 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

2278 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

2279 
pci_chªÃl_¡©e_t
 
¡©e
)

2281 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2288 
¡©e
) {

2289 
pci_chªÃl_io_nÜm®
:

2290  
PCI_ERS_RESULT_CAN_RECOVER
;

2291 
pci_chªÃl_io_äoz’
:

2292 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2294 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2295  
PCI_ERS_RESULT_NEED_RESET
;

2296 
pci_chªÃl_io_³rm_çu»
:

2297 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2299  
PCI_ERS_RESULT_DISCONNECT
;

2301  
PCI_ERS_RESULT_NEED_RESET
;

2302 
	}
}

2304 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

2306 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2308 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "restart‡fter slot„eset\n");

2309 
	`pci_»¡Üe_¡©e
(
pdev
);

2310 
	`nvme_»£t
(
dev
);

2311  
PCI_ERS_RESULT_RECOVERED
;

2312 
	}
}

2314 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

2316 
	`pci_ş—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

2317 
	}
}

2319 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2320 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2321 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2322 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2325 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

2326 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2327 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2328 
NVME_QUIRK_DISCARD_ZEROES
, },

2329 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

2330 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2331 
NVME_QUIRK_DISCARD_ZEROES
, },

2332 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

2333 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2334 
NVME_QUIRK_DISCARD_ZEROES
, },

2335 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2336 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

2337 { 
PCI_DEVICE
(0x1c58, 0x0003),

2338 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2339 { 
PCI_DEVICE
(0x1c5f, 0x0540),

2340 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2341 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2344 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2346 
pci_driv”_rh
 
	gnvme_driv”_rh
 = {

2347 .
size
 = (
pci_driv”_rh
),

2348 .
	g»£t_nÙify
 = 
nvme_»£t_nÙify


2351 
pci_driv”
 
	gnvme_driv”
 = {

2352 .
Çme
 = "nvme",

2353 .
	gid_bË
 = 
nvme_id_bË
,

2354 .
	g´obe
 = 
nvme_´obe
,

2355 .
	g»move
 = 
nvme_»move
,

2356 .
	gshutdown
 = 
nvme_shutdown
,

2357 .
	gdriv”
 = {

2358 .
pm
 = &
nvme_dev_pm_İs
,

2360 .
	g¤iov_cÚfigu»
 = 
nvme_pci_¤iov_cÚfigu»
,

2361 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2362 .
	gpci_driv”_rh
 = &
nvme_driv”_rh


2365 
__š™
 
	$nvme_š™
()

2367 
»suÉ
;

2369 
nvme_wÜkq
 = 
	`®loc_wÜkqueue
("nvme", 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
, 0);

2370 ià(!
nvme_wÜkq
)

2371  -
ENOMEM
;

2373 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2374 ià(
»suÉ
)

2375 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2376  
»suÉ
;

2377 
	}
}

2379 
__ex™
 
	$nvme_ex™
()

2381 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2382 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2383 
	`_nvme_check_size
();

2384 
	}
}

2386 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

2387 
MODULE_LICENSE
("GPL");

2388 
MODULE_VERSION
("1.0");

2389 
moduË_š™
(
nvme_š™
);

2390 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/rdma.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/moduË.h
>

17 
	~<lšux/š™.h
>

18 
	~<lšux/¦ab.h
>

19 
	~<lšux/”r.h
>

20 
	~<lšux/¡ršg.h
>

21 
	~<lšux/jiff›s.h
>

22 
	~<lšux/©omic.h
>

23 
	~<lšux/blk-mq.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/li¡.h
>

26 
	~<lšux/mu‹x.h
>

27 
	~<lšux/sÿ‰”li¡.h
>

29 
	~"lšux_nvme.h
"

31 
	~<lšux/nvme.h
>

33 
	~<asm/uÇligÃd.h
>

35 
	~<rdma/ib_v”bs.h
>

36 
	~<rdma/rdma_cm.h
>

37 
	~<lšux/nvme-rdma.h
>

39 
	~"nvme.h
"

40 
	~"çbrics.h
"

43 
	#NVME_RDMA_CONNECT_TIMEOUT_MS
 1000

	)

45 
	#NVME_RDMA_MAX_SEGMENT_SIZE
 0xfffffà

	)

47 
	#NVME_RDMA_MAX_SEGMENTS
 256

	)

49 
	#NVME_RDMA_MAX_INLINE_SEGMENTS
 1

	)

55 
	#NVME_RDMA_NR_AEN_COMMANDS
 1

	)

56 
	#NVME_RDMA_AQ_BLKMQ_DEPTH
 \

57 (
NVMF_AQ_DEPTH
 - 
NVME_RDMA_NR_AEN_COMMANDS
)

	)

59 
	snvme_rdma_deviû
 {

60 
ib_deviû
 *
	mdev
;

61 
ib_pd
 *
	mpd
;

62 
k»f
 
	m»f
;

63 
li¡_h—d
 
	m’Œy
;

66 
	snvme_rdma_qe
 {

67 
ib_cqe
 
	mcqe
;

68 *
	md©a
;

69 
u64
 
	mdma
;

72 
	gnvme_rdma_queue
;

73 
	snvme_rdma_»que¡
 {

74 
nvme_»que¡
 
	m»q
;

75 
ib_mr
 *
	mmr
;

76 
nvme_rdma_qe
 
	msqe
;

77 
ib_sge
 
	msge
[1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
];

78 
u32
 
	mnum_sge
;

79 
	mÃÁs
;

80 
boŞ
 
	mšlše_d©a
;

81 
ib_»g_wr
 
	m»g_wr
;

82 
ib_cqe
 
	m»g_cqe
;

83 
nvme_rdma_queue
 *
	mqueue
;

84 
sg_bË
 
	msg_bË
;

85 
sÿ‰”li¡
 
	mfœ¡_sgl
[];

88 
	envme_rdma_queue_æags
 {

89 
	mNVME_RDMA_Q_CONNECTED
 = (1 << 0),

90 
	mNVME_RDMA_IB_QUEUE_ALLOCATED
 = (1 << 1),

91 
	mNVME_RDMA_Q_DELETING
 = (1 << 2),

92 
	mNVME_RDMA_Q_LIVE
 = (1 << 3),

95 
	snvme_rdma_queue
 {

96 
nvme_rdma_qe
 *
	mr¥_ršg
;

97 
u8
 
	msig_couÁ
;

98 
	mqueue_size
;

99 
size_t
 
	mcmnd_ÿpsuË_Ën
;

100 
nvme_rdma_ù¾
 *
	mù¾
;

101 
nvme_rdma_deviû
 *
	mdeviû
;

102 
ib_cq
 *
	mib_cq
;

103 
ib_qp
 *
	mqp
;

105 
	mæags
;

106 
rdma_cm_id
 *
	mcm_id
;

107 
	mcm_”rÜ
;

108 
com¶‘iÚ
 
	mcm_dÚe
;

111 
	snvme_rdma_ù¾
 {

113 
¥šlock_t
 
	mlock
;

116 
nvme_rdma_queue
 *
	mqueues
;

117 
u32
 
	mqueue_couÁ
;

120 
blk_mq_g_£t
 
	mg_£t
;

121 
wÜk_¡ruù
 
	md–‘e_wÜk
;

122 
wÜk_¡ruù
 
	m»£t_wÜk
;

123 
wÜk_¡ruù
 
	m”r_wÜk
;

125 
nvme_rdma_qe
 
	masync_ev’t_sqe
;

127 
d–ayed_wÜk
 
	m»cÚÃù_wÜk
;

129 
li¡_h—d
 
	mli¡
;

131 
blk_mq_g_£t
 
	madmš_g_£t
;

132 
nvme_rdma_deviû
 *
	mdeviû
;

134 
u64
 
	mÿp
;

135 
u32
 
	mmax_ä_·ges
;

138 
sockaddr
 
	maddr
;

139 
sockaddr_š
 
	maddr_š
;

142 
nvme_ù¾
 
	mù¾
;

145 
šlše
 
nvme_rdma_ù¾
 *
	$to_rdma_ù¾
(
nvme_ù¾
 *
ù¾
)

147  
	`cÚš”_of
(
ù¾
, 
nvme_rdma_ù¾
, ctrl);

148 
	}
}

150 
LIST_HEAD
(
deviû_li¡
);

151 
DEFINE_MUTEX
(
deviû_li¡_mu‹x
);

153 
LIST_HEAD
(
nvme_rdma_ù¾_li¡
);

154 
DEFINE_MUTEX
(
nvme_rdma_ù¾_mu‹x
);

156 
wÜkqueue_¡ruù
 *
	gnvme_rdma_wq
;

163 
boŞ
 
	g»gi¡”_®ways
 = 
Œue
;

164 
moduË_·¿m
(
»gi¡”_®ways
, 
boŞ
, 0444);

165 
MODULE_PARM_DESC
(
»gi¡”_®ways
,

168 
nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

169 
rdma_cm_ev’t
 *
ev’t
);

170 
nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
);

173 
šlše
 
	$put_uÇligÃd_Ë24
(
u32
 
v®
, 
u8
 *
p
)

175 *
p
++ = 
v®
;

176 *
p
++ = 
v®
 >> 8;

177 *
p
++ = 
v®
 >> 16;

178 
	}
}

180 
šlše
 
	$nvme_rdma_queue_idx
(
nvme_rdma_queue
 *
queue
)

182  
queue
 - queue->
ù¾
->
queues
;

183 
	}
}

185 
šlše
 
size_t
 
	$nvme_rdma_šlše_d©a_size
(
nvme_rdma_queue
 *
queue
)

187  
queue
->
cmnd_ÿpsuË_Ën
 - (
nvme_commªd
);

188 
	}
}

190 
	$nvme_rdma_ä“_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

191 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

193 
	`ib_dma_unm­_sšgË
(
ibdev
, 
qe
->
dma
, 
ÿpsuË_size
, 
dœ
);

194 
	`kä“
(
qe
->
d©a
);

195 
	}
}

197 
	$nvme_rdma_®loc_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

198 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

200 
qe
->
d©a
 = 
	`kz®loc
(
ÿpsuË_size
, 
GFP_KERNEL
);

201 ià(!
qe
->
d©a
)

202  -
ENOMEM
;

204 
qe
->
dma
 = 
	`ib_dma_m­_sšgË
(
ibdev
, qe->
d©a
, 
ÿpsuË_size
, 
dœ
);

205 ià(
	`ib_dma_m­pšg_”rÜ
(
ibdev
, 
qe
->
dma
)) {

206 
	`kä“
(
qe
->
d©a
);

207  -
ENOMEM
;

211 
	}
}

213 
	$nvme_rdma_ä“_ršg
(
ib_deviû
 *
ibdev
,

214 
nvme_rdma_qe
 *
ršg
, 
size_t
 
ib_queue_size
,

215 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

217 
i
;

219 
i
 = 0; i < 
ib_queue_size
; i++)

220 
	`nvme_rdma_ä“_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
);

221 
	`kä“
(
ršg
);

222 
	}
}

224 
nvme_rdma_qe
 *
	$nvme_rdma_®loc_ršg
(
ib_deviû
 *
ibdev
,

225 
size_t
 
ib_queue_size
, size_ˆ
ÿpsuË_size
,

226 
dma_d©a_dœeùiÚ
 
dœ
)

228 
nvme_rdma_qe
 *
ršg
;

229 
i
;

231 
ršg
 = 
	`kÿÎoc
(
ib_queue_size
, (
nvme_rdma_qe
), 
GFP_KERNEL
);

232 ià(!
ršg
)

233  
NULL
;

235 
i
 = 0; i < 
ib_queue_size
; i++) {

236 ià(
	`nvme_rdma_®loc_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
))

237 
out_ä“_ršg
;

240  
ršg
;

242 
out_ä“_ršg
:

243 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
ršg
, 
i
, 
ÿpsuË_size
, 
dœ
);

244  
NULL
;

245 
	}
}

247 
	$nvme_rdma_qp_ev’t
(
ib_ev’t
 *
ev’t
, *
cÚ‹xt
)

249 
	`´_debug
("QPƒvent %s (%d)\n",

250 
	`ib_ev’t_msg
(
ev’t
->event),ƒvent->event);

252 
	}
}

254 
	$nvme_rdma_wa™_fÜ_cm
(
nvme_rdma_queue
 *
queue
)

256 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(&
queue
->
cm_dÚe
,

257 
	`m£cs_to_jiff›s
(
NVME_RDMA_CONNECT_TIMEOUT_MS
) + 1);

258  
queue
->
cm_”rÜ
;

259 
	}
}

261 
	$nvme_rdma_ü—‹_qp
(
nvme_rdma_queue
 *
queue
, cÚ¡ 
çùÜ
)

263 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

264 
ib_qp_š™_©Œ
 
š™_©Œ
;

265 
»t
;

267 
	`mem£t
(&
š™_©Œ
, 0, (init_attr));

268 
š™_©Œ
.
ev’t_hªdËr
 = 
nvme_rdma_qp_ev’t
;

270 
š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
çùÜ
 * 
queue
->
queue_size
 + 1;

272 
š™_©Œ
.
ÿp
.
max_»cv_wr
 = 
queue
->
queue_size
 + 1;

273 
š™_©Œ
.
ÿp
.
max_»cv_sge
 = 1;

274 
š™_©Œ
.
ÿp
.
max_£nd_sge
 = 1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
;

275 
š™_©Œ
.
sq_sig_ty³
 = 
IB_SIGNAL_REQ_WR
;

276 
š™_©Œ
.
qp_ty³
 = 
IB_QPT_RC
;

277 
š™_©Œ
.
£nd_cq
 = 
queue
->
ib_cq
;

278 
š™_©Œ
.
»cv_cq
 = 
queue
->
ib_cq
;

280 
»t
 = 
	`rdma_ü—‹_qp
(
queue
->
cm_id
, 
dev
->
pd
, &
š™_©Œ
);

282 
queue
->
qp
 = queue->
cm_id
->qp;

283  
»t
;

284 
	}
}

286 
	$nvme_rdma_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

288 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

289 
nvme_rdma_deviû
 *
dev
 = 
ù¾
->
deviû
;

290 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

291 
»t
 = 0;

293 ià(!
»q
->
mr
->
Ãed_šv®
)

294 
out
;

296 
	`ib_d”eg_mr
(
»q
->
mr
);

298 
»q
->
mr
 = 
	`ib_®loc_mr
(
dev
->
pd
, 
IB_MR_TYPE_MEM_REG
,

299 
ù¾
->
max_ä_·ges
);

300 ià(
	`IS_ERR
(
»q
->
mr
)) {

301 
»t
 = 
	`PTR_ERR
(
»q
->
mr
);

302 
»q
->
mr
 = 
NULL
;

303 
out
;

306 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

308 
out
:

309  
»t
;

310 
	}
}

312 
	$__nvme_rdma_ex™_»que¡
(
nvme_rdma_ù¾
 *
ù¾
,

313 
»que¡
 *
rq
, 
queue_idx
)

315 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

316 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

317 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

319 ià(
»q
->
mr
)

320 
	`ib_d”eg_mr
(
»q
->
mr
);

322 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

323 
DMA_TO_DEVICE
);

324 
	}
}

326 
	$nvme_rdma_ex™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

327 
hùx_idx
, 
rq_idx
)

329  
	`__nvme_rdma_ex™_»que¡
(
d©a
, 
rq
, 
hùx_idx
 + 1);

330 
	}
}

332 
	$nvme_rdma_ex™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

333 
hùx_idx
, 
rq_idx
)

335  
	`__nvme_rdma_ex™_»que¡
(
d©a
, 
rq
, 0);

336 
	}
}

338 
	$__nvme_rdma_š™_»que¡
(
nvme_rdma_ù¾
 *
ù¾
,

339 
»que¡
 *
rq
, 
queue_idx
)

341 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

342 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

343 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

344 
ib_deviû
 *
ibdev
 = 
dev
->dev;

345 
»t
;

347 
	`BUG_ON
(
queue_idx
 >ğ
ù¾
->
queue_couÁ
);

349 
»t
 = 
	`nvme_rdma_®loc_qe
(
ibdev
, &
»q
->
sqe
, (
nvme_commªd
),

350 
DMA_TO_DEVICE
);

351 ià(
»t
)

352  
»t
;

354 
»q
->
mr
 = 
	`ib_®loc_mr
(
dev
->
pd
, 
IB_MR_TYPE_MEM_REG
,

355 
ù¾
->
max_ä_·ges
);

356 ià(
	`IS_ERR
(
»q
->
mr
)) {

357 
»t
 = 
	`PTR_ERR
(
»q
->
mr
);

358 
out_ä“_qe
;

361 
»q
->
queue
 = queue;

365 
out_ä“_qe
:

366 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

367 
DMA_TO_DEVICE
);

368  -
ENOMEM
;

369 
	}
}

371 
	$nvme_rdma_š™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

372 
hùx_idx
, 
rq_idx
,

373 
numa_node
)

375  
	`__nvme_rdma_š™_»que¡
(
d©a
, 
rq
, 
hùx_idx
 + 1);

376 
	}
}

378 
	$nvme_rdma_š™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

379 
hùx_idx
, 
rq_idx
,

380 
numa_node
)

382  
	`__nvme_rdma_š™_»que¡
(
d©a
, 
rq
, 0);

383 
	}
}

385 
	$nvme_rdma_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

386 
hùx_idx
)

388 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

389 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
 + 1];

391 
	`BUG_ON
(
hùx_idx
 >ğ
ù¾
->
queue_couÁ
);

393 
hùx
->
driv”_d©a
 = 
queue
;

395 
	}
}

397 
	$nvme_rdma_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

398 
hùx_idx
)

400 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

401 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

403 
	`BUG_ON
(
hùx_idx
 != 0);

405 
hùx
->
driv”_d©a
 = 
queue
;

407 
	}
}

409 
	$nvme_rdma_ä“_dev
(
k»f
 *
»f
)

411 
nvme_rdma_deviû
 *
ndev
 =

412 
	`cÚš”_of
(
»f
, 
nvme_rdma_deviû
,„ef);

414 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

415 
	`li¡_d–
(&
ndev
->
’Œy
);

416 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

418 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

419 
	`kä“
(
ndev
);

420 
	}
}

422 
	$nvme_rdma_dev_put
(
nvme_rdma_deviû
 *
dev
)

424 
	`k»f_put
(&
dev
->
»f
, 
nvme_rdma_ä“_dev
);

425 
	}
}

427 
	$nvme_rdma_dev_g‘
(
nvme_rdma_deviû
 *
dev
)

429  
	`k»f_g‘_uÆess_z”o
(&
dev
->
»f
);

430 
	}
}

432 
nvme_rdma_deviû
 *

433 
	$nvme_rdma_fšd_g‘_deviû
(
rdma_cm_id
 *
cm_id
)

435 
nvme_rdma_deviû
 *
ndev
;

437 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

438 
	`li¡_fÜ_—ch_’Œy
(
ndev
, &
deviû_li¡
, 
’Œy
) {

439 ià(
ndev
->
dev
->
node_guid
 =ğ
cm_id
->
deviû
->node_guid &&

440 
	`nvme_rdma_dev_g‘
(
ndev
))

441 
out_uÆock
;

444 
ndev
 = 
	`kz®loc
((*ndev), 
GFP_KERNEL
);

445 ià(!
ndev
)

446 
out_”r
;

448 
ndev
->
dev
 = 
cm_id
->
deviû
;

449 
	`k»f_š™
(&
ndev
->
»f
);

451 
ndev
->
pd
 = 
	`ib_®loc_pd
Òdev->
dev
,

452 
»gi¡”_®ways
 ? 0 : 
IB_PD_UNSAFE_GLOBAL_RKEY
);

453 ià(
	`IS_ERR
(
ndev
->
pd
))

454 
out_ä“_dev
;

456 ià(!(
ndev
->
dev
->
©Œs
.
deviû_ÿp_æags
 &

457 
IB_DEVICE_MEM_MGT_EXTENSIONS
)) {

458 
	`dev_”r
(&
ndev
->
dev
->dev,

460 
out_ä“_pd
;

463 
	`li¡_add
(&
ndev
->
’Œy
, &
deviû_li¡
);

464 
out_uÆock
:

465 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

466  
ndev
;

468 
out_ä“_pd
:

469 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

470 
out_ä“_dev
:

471 
	`kä“
(
ndev
);

472 
out_”r
:

473 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

474  
NULL
;

475 
	}
}

477 
	$nvme_rdma_de¡roy_queue_ib
(
nvme_rdma_queue
 *
queue
)

479 
nvme_rdma_deviû
 *
dev
;

480 
ib_deviû
 *
ibdev
;

482 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_RDMA_IB_QUEUE_ALLOCATED
, &
queue
->
æags
))

485 
dev
 = 
queue
->
deviû
;

486 
ibdev
 = 
dev
->dev;

487 
	`rdma_de¡roy_qp
(
queue
->
cm_id
);

488 
	`ib_ä“_cq
(
queue
->
ib_cq
);

490 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

491 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

493 
	`nvme_rdma_dev_put
(
dev
);

494 
	}
}

496 
	$nvme_rdma_ü—‹_queue_ib
(
nvme_rdma_queue
 *
queue
,

497 
nvme_rdma_deviû
 *
dev
)

499 
ib_deviû
 *
ibdev
 = 
dev
->dev;

500 cÚ¡ 
£nd_wr_çùÜ
 = 3;

501 cÚ¡ 
cq_çùÜ
 = 
£nd_wr_çùÜ
 + 1;

502 
comp_veùÜ
, 
idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

504 
»t
;

506 
queue
->
deviû
 = 
dev
;

512 ià(
idx
 == 0)

513 
comp_veùÜ
 = 0;

515 
comp_veùÜ
 = 
idx
 % 
ibdev
->
num_comp_veùÜs
;

519 
queue
->
ib_cq
 = 
	`ib_®loc_cq
(
dev
->dev, queue,

520 
cq_çùÜ
 * 
queue
->
queue_size
 + 1, 
comp_veùÜ
,

521 
IB_POLL_SOFTIRQ
);

522 ià(
	`IS_ERR
(
queue
->
ib_cq
)) {

523 
»t
 = 
	`PTR_ERR
(
queue
->
ib_cq
);

524 
out
;

527 
»t
 = 
	`nvme_rdma_ü—‹_qp
(
queue
, 
£nd_wr_çùÜ
);

528 ià(
»t
)

529 
out_de¡roy_ib_cq
;

531 
queue
->
r¥_ršg
 = 
	`nvme_rdma_®loc_ršg
(
ibdev
, queue->
queue_size
,

532 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

533 ià(!
queue
->
r¥_ršg
) {

534 
»t
 = -
ENOMEM
;

535 
out_de¡roy_qp
;

537 
	`£t_b™
(
NVME_RDMA_IB_QUEUE_ALLOCATED
, &
queue
->
æags
);

541 
out_de¡roy_qp
:

542 
	`ib_de¡roy_qp
(
queue
->
qp
);

543 
out_de¡roy_ib_cq
:

544 
	`ib_ä“_cq
(
queue
->
ib_cq
);

545 
out
:

546  
»t
;

547 
	}
}

549 
	$nvme_rdma_š™_queue
(
nvme_rdma_ù¾
 *
ù¾
,

550 
idx
, 
size_t
 
queue_size
)

552 
nvme_rdma_queue
 *
queue
;

553 
»t
;

555 
queue
 = &
ù¾
->
queues
[
idx
];

556 
queue
->
ù¾
 = ctrl;

557 
	`š™_com¶‘iÚ
(&
queue
->
cm_dÚe
);

559 ià(
idx
 > 0)

560 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

562 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

564 
queue
->
queue_size
 = queue_size;

566 
queue
->
cm_id
 = 
	`rdma_ü—‹_id
(&
š™_Ãt
, 
nvme_rdma_cm_hªdËr
, queue,

567 
RDMA_PS_TCP
, 
IB_QPT_RC
);

568 ià(
	`IS_ERR
(
queue
->
cm_id
)) {

569 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

570 "çedØü—‹ CM ID: %ld\n", 
	`PTR_ERR
(
queue
->
cm_id
));

571  
	`PTR_ERR
(
queue
->
cm_id
);

574 
queue
->
cm_”rÜ
 = -
ETIMEDOUT
;

575 
»t
 = 
	`rdma_»sŞve_addr
(
queue
->
cm_id
, 
NULL
, &
ù¾
->
addr
,

576 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

577 ià(
»t
) {

578 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

579 "rdma_»sŞve_add¸çed (%d).\n", 
»t
);

580 
out_de¡roy_cm_id
;

583 
»t
 = 
	`nvme_rdma_wa™_fÜ_cm
(
queue
);

584 ià(
»t
) {

585 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

586 "rdma_»sŞve_add¸wa™ faed (%d).\n", 
»t
);

587 
out_de¡roy_cm_id
;

590 
	`ş—r_b™
(
NVME_RDMA_Q_DELETING
, &
queue
->
æags
);

591 
	`£t_b™
(
NVME_RDMA_Q_CONNECTED
, &
queue
->
æags
);

595 
out_de¡roy_cm_id
:

596 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

597 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

598  
»t
;

599 
	}
}

601 
	$nvme_rdma_¡İ_queue
(
nvme_rdma_queue
 *
queue
)

603 
	`rdma_discÚÃù
(
queue
->
cm_id
);

604 
	`ib_d¿š_qp
(
queue
->
qp
);

605 
	}
}

607 
	$nvme_rdma_ä“_queue
(
nvme_rdma_queue
 *
queue
)

609 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

610 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

611 
	}
}

613 
	$nvme_rdma_¡İ_ªd_ä“_queue
(
nvme_rdma_queue
 *
queue
)

615 ià(
	`‹¡_ªd_£t_b™
(
NVME_RDMA_Q_DELETING
, &
queue
->
æags
))

617 
	`nvme_rdma_¡İ_queue
(
queue
);

618 
	`nvme_rdma_ä“_queue
(
queue
);

619 
	}
}

621 
	$nvme_rdma_ä“_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

623 
i
;

625 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++)

626 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[
i
]);

627 
	}
}

629 
	$nvme_rdma_cÚÃù_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

631 
i
, 
»t
 = 0;

633 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++) {

634 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

635 ià(
»t
) {

636 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

637 "çedØcÚÃù i/Øqueue: %d\n", 
»t
);

638 
out_ä“_queues
;

640 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

645 
out_ä“_queues
:

646 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

647  
»t
;

648 
	}
}

650 
	$nvme_rdma_š™_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

652 
i
, 
»t
;

654 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++) {

655 
»t
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 
i
,

656 
ù¾
->ù¾.
İts
->
queue_size
);

657 ià(
»t
) {

658 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

659 "çedØš™Ÿlizi/Øqueue: %d\n", 
»t
);

660 
out_ä“_queues
;

666 
out_ä“_queues
:

667 
i
--; i >= 1; i--)

668 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[
i
]);

670  
»t
;

671 
	}
}

673 
	$nvme_rdma_de¡roy_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
)

675 
	`nvme_rdma_ä“_qe
(
ù¾
->
queues
[0].
deviû
->
dev
, &ù¾->
async_ev’t_sqe
,

676 (
nvme_commªd
), 
DMA_TO_DEVICE
);

677 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[0]);

678 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

679 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

680 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

681 
	}
}

683 
	$nvme_rdma_ä“_ù¾
(
nvme_ù¾
 *
nù¾
)

685 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

687 ià(
	`li¡_em±y
(&
ù¾
->
li¡
))

688 
ä“_ù¾
;

690 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

691 
	`li¡_d–
(&
ù¾
->
li¡
);

692 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

694 
	`kä“
(
ù¾
->
queues
);

695 
	`nvmf_ä“_İtiÚs
(
nù¾
->
İts
);

696 
ä“_ù¾
:

697 
	`kä“
(
ù¾
);

698 
	}
}

700 
	$nvme_rdma_»cÚÃù_Ü_»move
(
nvme_rdma_ù¾
 *
ù¾
)

703 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_RECONNECTING
) {

704 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
 ||

705 
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
);

709 ià(
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

710 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Reconnecting in %d seconds...\n",

711 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
);

712 
	`queue_d–ayed_wÜk
(
nvme_rdma_wq
, &
ù¾
->
»cÚÃù_wÜk
,

713 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
 * 
HZ
);

715 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Removing controller...\n");

716 
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
d–‘e_wÜk
);

718 
	}
}

720 
	$nvme_rdma_»cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

722 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

723 
nvme_rdma_ù¾
, 
»cÚÃù_wÜk
);

724 
boŞ
 
chªged
;

725 
»t
;

727 ++
ù¾
->ù¾.
İts
->
Ä_»cÚÃùs
;

729 ià(
ù¾
->
queue_couÁ
 > 1) {

730 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

732 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

733 ià(
»t
)

734 
»queue
;

737 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[0]);

739 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
admš_g_£t
);

740 ià(
»t
)

741 
»queue
;

743 
»t
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 0, 
NVMF_AQ_DEPTH
);

744 ià(
»t
)

745 
»queue
;

747 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

749 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

750 ià(
»t
)

751 
¡İ_admš_q
;

753 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

755 
»t
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->
ÿp
);

756 ià(
»t
)

757 
¡İ_admš_q
;

759 
	`nvme_¡¬t_k“p_®ive
(&
ù¾
->ctrl);

761 ià(
ù¾
->
queue_couÁ
 > 1) {

762 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

763 ià(
»t
)

764 
¡İ_admš_q
;

766 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

767 ià(
»t
)

768 
¡İ_admš_q
;

771 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

772 
	`WARN_ON_ONCE
(!
chªged
);

773 
ù¾
->ù¾.
İts
->
Ä_»cÚÃùs
 = 0;

775 ià(
ù¾
->
queue_couÁ
 > 1) {

776 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

777 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

778 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

781 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Successfully„econnected\n");

785 
¡İ_admš_q
:

786 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

787 
»queue
:

788 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Failed„econnect‡ttempt %d\n",

789 
ù¾
->ù¾.
İts
->
Ä_»cÚÃùs
);

790 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

791 
	}
}

793 
	$nvme_rdma_”rÜ_»cov”y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

795 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

796 
nvme_rdma_ù¾
, 
”r_wÜk
);

797 
i
;

799 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

801 
i
 = 0; i < 
ù¾
->
queue_couÁ
; i++) {

802 
	`ş—r_b™
(
NVME_RDMA_Q_CONNECTED
, &
ù¾
->
queues
[
i
].
æags
);

803 
	`ş—r_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

806 ià(
ù¾
->
queue_couÁ
 > 1)

807 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

808 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

811 ià(
ù¾
->
queue_couÁ
 > 1)

812 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

813 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

814 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

815 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

817 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

818 
	}
}

820 
	$nvme_rdma_”rÜ_»cov”y
(
nvme_rdma_ù¾
 *
ù¾
)

822 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
))

825 
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
”r_wÜk
);

826 
	}
}

828 
	$nvme_rdma_wr_”rÜ
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
,

829 cÚ¡ *
İ
)

831 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

832 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

834 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
)

835 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

837 
İ
, 
wc
->
wr_cqe
,

838 
	`ib_wc_¡©us_msg
(
wc
->
¡©us
), wc->status);

839 
	`nvme_rdma_”rÜ_»cov”y
(
ù¾
);

840 
	}
}

842 
	$nvme_rdma_mem»g_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

844 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

845 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "MEMREG");

846 
	}
}

848 
	$nvme_rdma_šv_rkey_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

850 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

851 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "LOCAL_INV");

852 
	}
}

854 
	$nvme_rdma_šv_rkey
(
nvme_rdma_queue
 *
queue
,

855 
nvme_rdma_»que¡
 *
»q
)

857 
ib_£nd_wr
 *
bad_wr
;

858 
ib_£nd_wr
 
wr
 = {

859 .
İcode
 = 
IB_WR_LOCAL_INV
,

860 .
Ãxt
 = 
NULL
,

861 .
num_sge
 = 0,

862 .
£nd_æags
 = 0,

863 .
ex
.
šv®id©e_rkey
 = 
»q
->
mr
->
rkey
,

866 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_šv_rkey_dÚe
;

867 
wr
.
wr_cqe
 = &
»q
->
»g_cqe
;

869  
	`ib_po¡_£nd
(
queue
->
qp
, &
wr
, &
bad_wr
);

870 
	}
}

872 
	$nvme_rdma_unm­_d©a
(
nvme_rdma_queue
 *
queue
,

873 
»que¡
 *
rq
)

875 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

876 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

877 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

878 
ib_deviû
 *
ibdev
 = 
dev
->dev;

879 
»s
;

881 ià(!
	`blk_rq_by‹s
(
rq
))

884 ià(
»q
->
mr
->
Ãed_šv®
) {

885 
»s
 = 
	`nvme_rdma_šv_rkey
(
queue
, 
»q
);

886 ià(
»s
 < 0) {

887 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

889 
»q
->
mr
->
rkey
, 
»s
);

890 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

894 
	`ib_dma_unm­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,

895 
»q
->
ÃÁs
, 
	`rq_d©a_dœ
(
rq
) ==

896 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

898 
	`nvme_ş—nup_cmd
(
rq
);

899 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

900 
	}
}

902 
	$nvme_rdma_£t_sg_nuÎ
(
nvme_commªd
 *
c
)

904 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

906 
sg
->
addr
 = 0;

907 
	`put_uÇligÃd_Ë24
(0, 
sg
->
Ëngth
);

908 
	`put_uÇligÃd_Ë32
(0, 
sg
->
key
);

909 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

911 
	}
}

913 
	$nvme_rdma_m­_sg_šlše
(
nvme_rdma_queue
 *
queue
,

914 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

916 
nvme_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
sgl
;

918 
»q
->
sge
[1].
addr
 = 
	`sg_dma_add»ss
Ôeq->
sg_bË
.
sgl
);

919 
»q
->
sge
[1].
Ëngth
 = 
	`sg_dma_Ën
Ôeq->
sg_bË
.
sgl
);

920 
»q
->
sge
[1].
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

922 
sg
->
addr
 = 
	`ıu_to_Ë64
(
queue
->
ù¾
->ù¾.
icdoff
);

923 
sg
->
Ëngth
 = 
	`ıu_to_Ë32
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
));

924 
sg
->
ty³
 = (
NVME_SGL_FMT_DATA_DESC
 << 4è| 
NVME_SGL_FMT_OFFSET
;

926 
»q
->
šlše_d©a
 = 
Œue
;

927 
»q
->
num_sge
++;

929 
	}
}

931 
	$nvme_rdma_m­_sg_sšgË
(
nvme_rdma_queue
 *
queue
,

932 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

934 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

936 
sg
->
addr
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
»q
->
sg_bË
.
sgl
));

937 
	`put_uÇligÃd_Ë24
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
), 
sg
->
Ëngth
);

938 
	`put_uÇligÃd_Ë32
(
queue
->
deviû
->
pd
->
un§ã_glob®_rkey
, 
sg
->
key
);

939 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

941 
	}
}

943 
	$nvme_rdma_m­_sg_ä
(
nvme_rdma_queue
 *
queue
,

944 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
,

945 
couÁ
)

947 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

948 
Ä
;

950 
Ä
 = 
	`ib_m­_mr_sg
(
»q
->
mr
,„eq->
sg_bË
.
sgl
, 
couÁ
, 
NULL
, 
PAGE_SIZE
);

951 ià(
Ä
 < 
couÁ
) {

952 ià(
Ä
 < 0)

953  
Ä
;

954  -
EINVAL
;

957 
	`ib_upd©e_ç¡_»g_key
(
»q
->
mr
, 
	`ib_šc_rkey
Ôeq->mr->
rkey
));

959 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_mem»g_dÚe
;

960 
	`mem£t
(&
»q
->
»g_wr
, 0, (req->reg_wr));

961 
»q
->
»g_wr
.
wr
.
İcode
 = 
IB_WR_REG_MR
;

962 
»q
->
»g_wr
.
wr
.
wr_cqe
 = &»q->
»g_cqe
;

963 
»q
->
»g_wr
.
wr
.
num_sge
 = 0;

964 
»q
->
»g_wr
.
mr
 =„eq->mr;

965 
»q
->
»g_wr
.
key
 =„eq->
mr
->
rkey
;

966 
»q
->
»g_wr
.
acûss
 = 
IB_ACCESS_LOCAL_WRITE
 |

967 
IB_ACCESS_REMOTE_READ
 |

968 
IB_ACCESS_REMOTE_WRITE
;

970 
»q
->
mr
->
Ãed_šv®
 = 
Œue
;

972 
sg
->
addr
 = 
	`ıu_to_Ë64
(
»q
->
mr
->
iova
);

973 
	`put_uÇligÃd_Ë24
(
»q
->
mr
->
Ëngth
, 
sg
->length);

974 
	`put_uÇligÃd_Ë32
(
»q
->
mr
->
rkey
, 
sg
->
key
);

975 
sg
->
ty³
 = (
NVME_KEY_SGL_FMT_DATA_DESC
 << 4) |

976 
NVME_SGL_FMT_INVALIDATE
;

979 
	}
}

981 
	$nvme_rdma_m­_d©a
(
nvme_rdma_queue
 *
queue
,

982 
»que¡
 *
rq
, 
m­_Ën
,

983 
nvme_commªd
 *
c
)

985 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

986 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

987 
ib_deviû
 *
ibdev
 = 
dev
->dev;

988 
ÃÁs
, 
couÁ
;

989 
»t
;

991 
»q
->
num_sge
 = 1;

992 
»q
->
šlše_d©a
 = 
çl£
;

993 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

995 
c
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

997 ià(!
	`blk_rq_by‹s
(
rq
))

998  
	`nvme_rdma_£t_sg_nuÎ
(
c
);

1000 
»q
->
sg_bË
.
sgl
 =„eq->
fœ¡_sgl
;

1001 
»t
 = 
	`sg_®loc_bË_chašed
(&
»q
->
sg_bË
, 
rq
->
Ä_phys_£gm’ts
,

1002 
GFP_ATOMIC
, 
»q
->
sg_bË
.
sgl
);

1003 ià(
»t
)

1004  -
ENOMEM
;

1006 
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q, 
»q
->
sg_bË
.
sgl
);

1007 
	`BUG_ON
(
ÃÁs
 > 
rq
->
Ä_phys_£gm’ts
);

1008 
»q
->
ÃÁs
 =‚ents;

1010 
couÁ
 = 
	`ib_dma_m­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
, 
ÃÁs
,

1011 
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1012 ià(
	`uÆik–y
(
couÁ
 <= 0)) {

1013 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

1014  -
EIO
;

1017 ià(
couÁ
 == 1) {

1018 ià(
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 &&

1019 
m­_Ën
 <ğ
	`nvme_rdma_šlše_d©a_size
(
queue
) &&

1020 
	`nvme_rdma_queue_idx
(
queue
))

1021  
	`nvme_rdma_m­_sg_šlše
(
queue
, 
»q
, 
c
);

1023 ià(
dev
->
pd
->
æags
 & 
IB_PD_UNSAFE_GLOBAL_RKEY
)

1024  
	`nvme_rdma_m­_sg_sšgË
(
queue
, 
»q
, 
c
);

1027  
	`nvme_rdma_m­_sg_ä
(
queue
, 
»q
, 
c
, 
couÁ
);

1028 
	}
}

1030 
	$nvme_rdma_£nd_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1032 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

1033 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "SEND");

1034 
	}
}

1036 
	$nvme_rdma_po¡_£nd
(
nvme_rdma_queue
 *
queue
,

1037 
nvme_rdma_qe
 *
qe
, 
ib_sge
 *
sge
, 
u32
 
num_sge
,

1038 
ib_£nd_wr
 *
fœ¡
, 
boŞ
 
æush
)

1040 
ib_£nd_wr
 
wr
, *
bad_wr
;

1041 
»t
;

1043 
sge
->
addr
 = 
qe
->
dma
;

1044 
sge
->
Ëngth
 = (
nvme_commªd
),

1045 
sge
->
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1047 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_£nd_dÚe
;

1049 
wr
.
Ãxt
 = 
NULL
;

1050 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1051 
wr
.
sg_li¡
 = 
sge
;

1052 
wr
.
num_sge
 =‚um_sge;

1053 
wr
.
İcode
 = 
IB_WR_SEND
;

1054 
wr
.
£nd_æags
 = 0;

1073 ià((++
queue
->
sig_couÁ
 % 32è=ğ0 || 
æush
)

1074 
wr
.
£nd_æags
 |ğ
IB_SEND_SIGNALED
;

1076 ià(
fœ¡
)

1077 
fœ¡
->
Ãxt
 = &
wr
;

1079 
fœ¡
 = &
wr
;

1081 
»t
 = 
	`ib_po¡_£nd
(
queue
->
qp
, 
fœ¡
, &
bad_wr
);

1082 ià(
»t
) {

1083 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1084 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1086  
»t
;

1087 
	}
}

1089 
	$nvme_rdma_po¡_»cv
(
nvme_rdma_queue
 *
queue
,

1090 
nvme_rdma_qe
 *
qe
)

1092 
ib_»cv_wr
 
wr
, *
bad_wr
;

1093 
ib_sge
 
li¡
;

1094 
»t
;

1096 
li¡
.
addr
 = 
qe
->
dma
;

1097 
li¡
.
Ëngth
 = (
nvme_com¶‘iÚ
);

1098 
li¡
.
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1100 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_»cv_dÚe
;

1102 
wr
.
Ãxt
 = 
NULL
;

1103 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1104 
wr
.
sg_li¡
 = &
li¡
;

1105 
wr
.
num_sge
 = 1;

1107 
»t
 = 
	`ib_po¡_»cv
(
queue
->
qp
, &
wr
, &
bad_wr
);

1108 ià(
»t
) {

1109 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1110 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1112  
»t
;

1113 
	}
}

1115 
blk_mq_gs
 *
	$nvme_rdma_g£t
(
nvme_rdma_queue
 *
queue
)

1117 
u32
 
queue_idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

1119 ià(
queue_idx
 == 0)

1120  
queue
->
ù¾
->
admš_g_£t
.
gs
[
queue_idx
];

1121  
queue
->
ù¾
->
g_£t
.
gs
[
queue_idx
 - 1];

1122 
	}
}

1124 
	$nvme_rdma_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
, 
«r_idx
)

1126 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
¬g
);

1127 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

1128 
ib_deviû
 *
dev
 = 
queue
->
deviû
->dev;

1129 
nvme_rdma_qe
 *
sqe
 = &
ù¾
->
async_ev’t_sqe
;

1130 
nvme_commªd
 *
cmd
 = 
sqe
->
d©a
;

1131 
ib_sge
 
sge
;

1132 
»t
;

1134 ià(
	`WARN_ON_ONCE
(
«r_idx
 != 0))

1137 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
, (*
cmd
), 
DMA_TO_DEVICE
);

1139 
	`mem£t
(
cmd
, 0, (*cmd));

1140 
cmd
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1141 
cmd
->
commÚ
.
commªd_id
 = 
NVME_RDMA_AQ_BLKMQ_DEPTH
;

1142 
cmd
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1143 
	`nvme_rdma_£t_sg_nuÎ
(
cmd
);

1145 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
, (*
cmd
),

1146 
DMA_TO_DEVICE
);

1148 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, &
sge
, 1, 
NULL
, 
çl£
);

1149 
	`WARN_ON_ONCE
(
»t
);

1150 
	}
}

1152 
	$nvme_rdma_´oûss_nvme_r¥
(
nvme_rdma_queue
 *
queue
,

1153 
nvme_com¶‘iÚ
 *
cqe
, 
ib_wc
 *
wc
, 
g
)

1155 
»que¡
 *
rq
;

1156 
nvme_rdma_»que¡
 *
»q
;

1157 
»t
 = 0;

1159 
rq
 = 
	`blk_mq_g_to_rq
(
	`nvme_rdma_g£t
(
queue
), 
cqe
->
commªd_id
);

1160 ià(!
rq
) {

1161 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1163 
cqe
->
commªd_id
, 
queue
->
qp
->
qp_num
);

1164 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1165  
»t
;

1167 
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1169 ià(
rq
->
g
 ==ag)

1170 
»t
 = 1;

1172 ià((
wc
->
wc_æags
 & 
IB_WC_WITH_INVALIDATE
) &&

1173 
wc
->
ex
.
šv®id©e_rkey
 =ğ
»q
->
mr
->
rkey
)

1174 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

1176 
»q
->»q.
»suÉ
 = 
cqe
->result;

1177 
	`blk_mq_com¶‘e_»que¡
(
rq
, 
	`Ë16_to_ıu
(
cqe
->
¡©us
) >> 1);

1178  
»t
;

1179 
	}
}

1181 
	$__nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
, 
g
)

1183 
nvme_rdma_qe
 *
qe
 =

1184 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1185 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

1186 
ib_deviû
 *
ibdev
 = 
queue
->
deviû
->
dev
;

1187 
nvme_com¶‘iÚ
 *
cqe
 = 
qe
->
d©a
;

1188 cÚ¡ 
size_t
 
Ën
 = (
nvme_com¶‘iÚ
);

1189 
»t
 = 0;

1191 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
)) {

1192 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "RECV");

1196 
	`ib_dma_sync_sšgË_fÜ_ıu
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1203 ià(
	`uÆik–y
(
	`nvme_rdma_queue_idx
(
queue
) == 0 &&

1204 
cqe
->
commªd_id
 >ğ
NVME_RDMA_AQ_BLKMQ_DEPTH
))

1205 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
cqe
->
¡©us
,

1206 &
cqe
->
»suÉ
);

1208 
»t
 = 
	`nvme_rdma_´oûss_nvme_r¥
(
queue
, 
cqe
, 
wc
, 
g
);

1209 
	`ib_dma_sync_sšgË_fÜ_deviû
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1211 
	`nvme_rdma_po¡_»cv
(
queue
, 
qe
);

1212  
»t
;

1213 
	}
}

1215 
	$nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1217 
	`__nvme_rdma_»cv_dÚe
(
cq
, 
wc
, -1);

1218 
	}
}

1220 
	$nvme_rdma_cÚn_e¡ablished
(
nvme_rdma_queue
 *
queue
)

1222 
»t
, 
i
;

1224 
i
 = 0; i < 
queue
->
queue_size
; i++) {

1225 
»t
 = 
	`nvme_rdma_po¡_»cv
(
queue
, &queue->
r¥_ršg
[
i
]);

1226 ià(
»t
)

1227 
out_de¡roy_queue_ib
;

1232 
out_de¡roy_queue_ib
:

1233 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1234  
»t
;

1235 
	}
}

1237 
	$nvme_rdma_cÚn_»jeùed
(
nvme_rdma_queue
 *
queue
,

1238 
rdma_cm_ev’t
 *
ev
)

1240 ià(
ev
->
·¿m
.
cÚn
.
´iv©e_d©a_Ën
) {

1241 
nvme_rdma_cm_»j
 *
»j
 =

1242 (
nvme_rdma_cm_»j
 *)
ev
->
·¿m
.
cÚn
.
´iv©e_d©a
;

1244 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1245 "CÚÃù„ejeùed, stu %d.", 
	`Ë16_to_ıu
(
»j
->
¡s
));

1248 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1252  -
ECONNRESET
;

1253 
	}
}

1255 
	$nvme_rdma_addr_»sŞved
(
nvme_rdma_queue
 *
queue
)

1257 
nvme_rdma_deviû
 *
dev
;

1258 
»t
;

1260 
dev
 = 
	`nvme_rdma_fšd_g‘_deviû
(
queue
->
cm_id
);

1261 ià(!
dev
) {

1262 
	`dev_”r
(
queue
->
cm_id
->
deviû
->
dma_deviû
,

1264  -
ECONNREFUSED
;

1267 
»t
 = 
	`nvme_rdma_ü—‹_queue_ib
(
queue
, 
dev
);

1268 ià(
»t
) {

1269 
	`nvme_rdma_dev_put
(
dev
);

1270 
out
;

1273 
»t
 = 
	`rdma_»sŞve_rou‹
(
queue
->
cm_id
, 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

1274 ià(
»t
) {

1275 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1277 
queue
->
cm_”rÜ
);

1278 
out_de¡roy_queue
;

1283 
out_de¡roy_queue
:

1284 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1285 
out
:

1286  
»t
;

1287 
	}
}

1289 
	$nvme_rdma_rou‹_»sŞved
(
nvme_rdma_queue
 *
queue
)

1291 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1292 
rdma_cÚn_·¿m
 
·¿m
 = { };

1293 
nvme_rdma_cm_»q
 
´iv
 = { };

1294 
»t
;

1296 
·¿m
.
qp_num
 = 
queue
->
qp
->qp_num;

1297 
·¿m
.
æow_cÚŒŞ
 = 1;

1299 
·¿m
.
»¥Úd”_»sourûs
 = 
queue
->
deviû
->
dev
->
©Œs
.
max_qp_rd_©om
;

1301 
·¿m
.
»Œy_couÁ
 = 7;

1302 
·¿m
.
ºr_»Œy_couÁ
 = 7;

1303 
·¿m
.
´iv©e_d©a
 = &
´iv
;

1304 
·¿m
.
´iv©e_d©a_Ën
 = (
´iv
);

1306 
´iv
.
»cfmt
 = 
	`ıu_to_Ë16
(
NVME_RDMA_CM_FMT_1_0
);

1307 
´iv
.
qid
 = 
	`ıu_to_Ë16
(
	`nvme_rdma_queue_idx
(
queue
));

1312 ià(
´iv
.
qid
 == 0) {

1313 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
NVMF_AQ_DEPTH
);

1314 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
NVMF_AQ_DEPTH
 - 1);

1321 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
queue
->
queue_size
);

1322 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
queue
->
ù¾
->ù¾.
sqsize
);

1325 
»t
 = 
	`rdma_cÚÃù
(
queue
->
cm_id
, &
·¿m
);

1326 ià(
»t
) {

1327 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1328 "rdma_cÚÃù faed (%d).\n", 
»t
);

1329 
out_de¡roy_queue_ib
;

1334 
out_de¡roy_queue_ib
:

1335 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1336  
»t
;

1337 
	}
}

1339 
	$nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

1340 
rdma_cm_ev’t
 *
ev
)

1342 
nvme_rdma_queue
 *
queue
 = 
cm_id
->
cÚ‹xt
;

1343 
cm_”rÜ
 = 0;

1345 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
, "%s (%d): status %d id %p\n",

1346 
	`rdma_ev’t_msg
(
ev
->
ev’t
),ƒv->event,

1347 
ev
->
¡©us
, 
cm_id
);

1349 
ev
->
ev’t
) {

1350 
RDMA_CM_EVENT_ADDR_RESOLVED
:

1351 
cm_”rÜ
 = 
	`nvme_rdma_addr_»sŞved
(
queue
);

1353 
RDMA_CM_EVENT_ROUTE_RESOLVED
:

1354 
cm_”rÜ
 = 
	`nvme_rdma_rou‹_»sŞved
(
queue
);

1356 
RDMA_CM_EVENT_ESTABLISHED
:

1357 
queue
->
cm_”rÜ
 = 
	`nvme_rdma_cÚn_e¡ablished
(queue);

1359 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1361 
RDMA_CM_EVENT_REJECTED
:

1362 
cm_”rÜ
 = 
	`nvme_rdma_cÚn_»jeùed
(
queue
, 
ev
);

1364 
RDMA_CM_EVENT_ADDR_ERROR
:

1365 
RDMA_CM_EVENT_ROUTE_ERROR
:

1366 
RDMA_CM_EVENT_CONNECT_ERROR
:

1367 
RDMA_CM_EVENT_UNREACHABLE
:

1368 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1369 "CMƒ¼Üƒv’ˆ%d\n", 
ev
->
ev’t
);

1370 
cm_”rÜ
 = -
ECONNRESET
;

1372 
RDMA_CM_EVENT_DISCONNECTED
:

1373 
RDMA_CM_EVENT_ADDR_CHANGE
:

1374 
RDMA_CM_EVENT_TIMEWAIT_EXIT
:

1375 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1377 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1379 
RDMA_CM_EVENT_DEVICE_REMOVAL
:

1383 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1384 "UÃx³ùed RDMA CMƒv’ˆ(%d)\n", 
ev
->
ev’t
);

1385 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1389 ià(
cm_”rÜ
) {

1390 
queue
->
cm_”rÜ
 = cm_error;

1391 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1395 
	}
}

1397 
blk_eh_tim”_»tuº


1398 
	$nvme_rdma_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

1400 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1403 
	`nvme_rdma_”rÜ_»cov”y
(
»q
->
queue
->
ù¾
);

1406 
rq
->
”rÜs
 = 
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
;

1408  
BLK_EH_HANDLED
;

1409 
	}
}

1414 
šlše
 
boŞ
 
	$nvme_rdma_queue_is_»ady
(
nvme_rdma_queue
 *
queue
,

1415 
»que¡
 *
rq
)

1417 ià(
	`uÆik–y
(!
	`‹¡_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
))) {

1418 
nvme_commªd
 *
cmd
 = 
	`nvme_»q
(
rq
)->cmd;

1420 ià(
rq
->
cmd_ty³
 !ğ
REQ_TYPE_DRV_PRIV
 ||

1421 
cmd
->
commÚ
.
İcode
 !ğ
nvme_çbrics_commªd
 ||

1422 
cmd
->
çbrics
.
fùy³
 !ğ
nvme_çbrics_ty³_cÚÃù
)

1423  
çl£
;

1426  
Œue
;

1427 
	}
}

1429 
	$nvme_rdma_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1430 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1432 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1433 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1434 
»que¡
 *
rq
 = 
bd
->rq;

1435 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1436 
nvme_rdma_qe
 *
sqe
 = &
»q
->sqe;

1437 
nvme_commªd
 *
c
 = 
sqe
->
d©a
;

1438 
boŞ
 
æush
 = 
çl£
;

1439 
ib_deviû
 *
dev
;

1440 
m­_Ën
;

1441 
»t
;

1443 
	`WARN_ON_ONCE
(
rq
->
g
 < 0);

1445 ià(!
	`nvme_rdma_queue_is_»ady
(
queue
, 
rq
))

1446  
BLK_MQ_RQ_QUEUE_BUSY
;

1448 
dev
 = 
queue
->
deviû
->dev;

1449 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
,

1450 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1452 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
c
);

1453 ià(
»t
 !ğ
BLK_MQ_RQ_QUEUE_OK
)

1454  
»t
;

1456 
	`blk_mq_¡¬t_»que¡
(
rq
);

1458 
m­_Ën
 = 
	`nvme_m­_Ën
(
rq
);

1459 
»t
 = 
	`nvme_rdma_m­_d©a
(
queue
, 
rq
, 
m­_Ën
, 
c
);

1460 ià(
»t
 < 0) {

1461 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1462 "FaedØm­ d©¨(%d)\n", 
»t
);

1463 
	`nvme_ş—nup_cmd
(
rq
);

1464 
”r
;

1467 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
,

1468 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1470 ià(
rq
->
cmd_ty³
 =ğ
REQ_TYPE_FS
 &&„q->
cmd_æags
 & 
REQ_FLUSH
)

1471 
æush
 = 
Œue
;

1472 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, 
»q
->
sge
,„eq->
num_sge
,

1473 
»q
->
mr
->
Ãed_šv®
 ? &»q->
»g_wr
.
wr
 : 
NULL
, 
æush
);

1474 ià(
»t
) {

1475 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1476 
”r
;

1479  
BLK_MQ_RQ_QUEUE_OK
;

1480 
”r
:

1481  (
»t
 =ğ-
ENOMEM
 ||„‘ =ğ-
EAGAIN
) ?

1482 
BLK_MQ_RQ_QUEUE_BUSY
 : 
BLK_MQ_RQ_QUEUE_ERROR
;

1483 
	}
}

1485 
	$nvme_rdma_com¶‘e_rq
(
»que¡
 *
rq
)

1487 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1488 
nvme_rdma_queue
 *
queue
 = 
»q
->queue;

1489 
”rÜ
 = 0;

1491 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1493 ià(
	`uÆik–y
(
rq
->
”rÜs
)) {

1494 ià(
	`nvme_»q_Ãeds_»Œy
(
rq
,„q->
”rÜs
)) {

1495 
	`nvme_»queue_»q
(
rq
);

1499 ià(
rq
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

1500 
”rÜ
 = 
rq
->
”rÜs
;

1502 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
rq
->
”rÜs
);

1505 
	`blk_mq_’d_»que¡
(
rq
, 
”rÜ
);

1506 
	}
}

1508 
blk_mq_İs
 
	gnvme_rdma_mq_İs
 = {

1509 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1510 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1511 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1512 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1513 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1514 .
	g»š™_»que¡
 = 
nvme_rdma_»š™_»que¡
,

1515 .
	gš™_hùx
 = 
nvme_rdma_š™_hùx
,

1516 .
	gtimeout
 = 
nvme_rdma_timeout
,

1519 
blk_mq_İs
 
	gnvme_rdma_admš_mq_İs
 = {

1520 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1521 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1522 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1523 .
	gš™_»que¡
 = 
nvme_rdma_š™_admš_»que¡
,

1524 .
	gex™_»que¡
 = 
nvme_rdma_ex™_admš_»que¡
,

1525 .
	g»š™_»que¡
 = 
nvme_rdma_»š™_»que¡
,

1526 .
	gš™_hùx
 = 
nvme_rdma_š™_admš_hùx
,

1527 .
	gtimeout
 = 
nvme_rdma_timeout
,

1530 
	$nvme_rdma_cÚfigu»_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
)

1532 
”rÜ
;

1534 
”rÜ
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 0, 
NVMF_AQ_DEPTH
);

1535 ià(
”rÜ
)

1536  
”rÜ
;

1538 
ù¾
->
deviû
 = cŒl->
queues
[0].device;

1544 
”rÜ
 = -
EINVAL
;

1545 ià(!
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
))

1546 
out_ä“_queue
;

1548 
ù¾
->
max_ä_·ges
 = 
	`mš_t
(
u32
, 
NVME_RDMA_MAX_SEGMENTS
,

1549 
ù¾
->
deviû
->
dev
->
©Œs
.
max_ç¡_»g_·ge_li¡_Ën
);

1551 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

1552 
ù¾
->
admš_g_£t
.
İs
 = &
nvme_rdma_admš_mq_İs
;

1553 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_RDMA_AQ_BLKMQ_DEPTH
;

1554 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

1555 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1556 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_rdma_»que¡
) +

1557 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

1558 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

1559 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

1560 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1562 
”rÜ
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

1563 ià(
”rÜ
)

1564 
out_put_dev
;

1566 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

1567 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

1568 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

1569 
out_ä“_g£t
;

1572 
”rÜ
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

1573 ià(
”rÜ
)

1574 
out_ş—nup_queue
;

1576 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

1578 
”rÜ
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
, &ù¾->
ÿp
);

1579 ià(
”rÜ
) {

1580 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1582 
out_ş—nup_queue
;

1585 
ù¾
->ù¾.
sqsize
 =

1586 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->
ÿp
è+ 1, cŒl->ù¾.
sqsize
);

1588 
”rÜ
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->
ÿp
);

1589 ià(
”rÜ
)

1590 
out_ş—nup_queue
;

1592 
ù¾
->ù¾.
max_hw_£ùÜs
 =

1593 (
ù¾
->
max_ä_·ges
 - 1è<< (
PAGE_SHIFT
 - 9);

1595 
”rÜ
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

1596 ià(
”rÜ
)

1597 
out_ş—nup_queue
;

1599 
”rÜ
 = 
	`nvme_rdma_®loc_qe
(
ù¾
->
queues
[0].
deviû
->
dev
,

1600 &
ù¾
->
async_ev’t_sqe
, (
nvme_commªd
),

1601 
DMA_TO_DEVICE
);

1602 ià(
”rÜ
)

1603 
out_ş—nup_queue
;

1605 
	`nvme_¡¬t_k“p_®ive
(&
ù¾
->ctrl);

1609 
out_ş—nup_queue
:

1610 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

1611 
out_ä“_g£t
:

1613 
	`nvme_rdma_¡İ_queue
(&
ù¾
->
queues
[0]);

1614 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

1615 
out_put_dev
:

1616 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1617 
out_ä“_queue
:

1618 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

1619  
”rÜ
;

1620 
	}
}

1622 
	$nvme_rdma_shutdown_ù¾
(
nvme_rdma_ù¾
 *
ù¾
)

1624 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

1625 
	`ÿnûl_wÜk_sync
(&
ù¾
->
”r_wÜk
);

1626 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
»cÚÃù_wÜk
);

1628 ià(
ù¾
->
queue_couÁ
 > 1) {

1629 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

1630 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

1631 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1632 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

1635 ià(
	`‹¡_b™
(
NVME_RDMA_Q_CONNECTED
, &
ù¾
->
queues
[0].
æags
))

1636 
	`nvme_shutdown_ù¾
(&
ù¾
->ctrl);

1638 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

1639 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

1640 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1641 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
);

1642 
	}
}

1644 
	$__nvme_rdma_»move_ù¾
(
nvme_rdma_ù¾
 *
ù¾
, 
boŞ
 
shutdown
)

1646 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1647 ià(
shutdown
)

1648 
	`nvme_rdma_shutdown_ù¾
(
ù¾
);

1650 ià(
ù¾
->ù¾.
g£t
) {

1651 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1652 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1653 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1656 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1657 
	}
}

1659 
	$nvme_rdma_d–_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1661 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1662 
nvme_rdma_ù¾
, 
d–‘e_wÜk
);

1664 
	`__nvme_rdma_»move_ù¾
(
ù¾
, 
Œue
);

1665 
	}
}

1667 
	$__nvme_rdma_d–_ù¾
(
nvme_rdma_ù¾
 *
ù¾
)

1669 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_DELETING
))

1670  -
EBUSY
;

1672 ià(!
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
d–‘e_wÜk
))

1673  -
EBUSY
;

1676 
	}
}

1678 
	$nvme_rdma_d–_ù¾
(
nvme_ù¾
 *
nù¾
)

1680 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

1681 
»t
 = 0;

1687 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->ù¾.
k»f
))

1688  -
EBUSY
;

1689 
»t
 = 
	`__nvme_rdma_d–_ù¾
(
ù¾
);

1690 ià(!
»t
)

1691 
	`æush_wÜk
(&
ù¾
->
d–‘e_wÜk
);

1692 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1693  
»t
;

1694 
	}
}

1696 
	$nvme_rdma_»move_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1698 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1699 
nvme_rdma_ù¾
, 
d–‘e_wÜk
);

1701 
	`__nvme_rdma_»move_ù¾
(
ù¾
, 
çl£
);

1702 
	}
}

1704 
	$nvme_rdma_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1706 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1707 
nvme_rdma_ù¾
, 
»£t_wÜk
);

1708 
»t
;

1709 
boŞ
 
chªged
;

1711 
	`nvme_rdma_shutdown_ù¾
(
ù¾
);

1713 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
);

1714 ià(
»t
) {

1716 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_rdma_»move_ù¾_wÜk
);

1717 
d–_d—d_ù¾
;

1720 ià(
ù¾
->
queue_couÁ
 > 1) {

1721 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

1722 ià(
»t
)

1723 
d–_d—d_ù¾
;

1725 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

1726 ià(
»t
)

1727 
d–_d—d_ù¾
;

1729 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

1730 ià(
»t
)

1731 
d–_d—d_ù¾
;

1734 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1735 
	`WARN_ON_ONCE
(!
chªged
);

1737 ià(
ù¾
->
queue_couÁ
 > 1) {

1738 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

1739 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

1740 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

1745 
d–_d—d_ù¾
:

1747 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
, "Removing‡fter„eset failure\n");

1748 
	`WARN_ON
(!
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
d–‘e_wÜk
));

1749 
	}
}

1751 
	$nvme_rdma_»£t_ù¾
(
nvme_ù¾
 *
nù¾
)

1753 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

1755 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RESETTING
))

1756  -
EBUSY
;

1758 ià(!
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
»£t_wÜk
))

1759  -
EBUSY
;

1761 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

1764 
	}
}

1766 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_rdma_ù¾_İs
 = {

1767 .
Çme
 = "rdma",

1768 .
	gmoduË
 = 
THIS_MODULE
,

1769 .
	gis_çbrics
 = 
Œue
,

1770 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

1771 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

1772 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

1773 .
	g»£t_ù¾
 = 
nvme_rdma_»£t_ù¾
,

1774 .
	gä“_ù¾
 = 
nvme_rdma_ä“_ù¾
,

1775 .
	gsubm™_async_ev’t
 = 
nvme_rdma_subm™_async_ev’t
,

1776 .
	gd–‘e_ù¾
 = 
nvme_rdma_d–_ù¾
,

1777 .
	gg‘_subsy¢qn
 = 
nvmf_g‘_subsy¢qn
,

1778 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

1781 
	$nvme_rdma_ü—‹_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

1783 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

1784 
»t
;

1786 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
İts
->
Ä_io_queues
);

1787 ià(
»t
)

1788  
»t
;

1790 
ù¾
->
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

1791 ià(
ù¾
->
queue_couÁ
 < 2)

1794 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

1795 "ü—tšg %d I/O queues.\n", 
İts
->
Ä_io_queues
);

1797 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

1798 ià(
»t
)

1799  
»t
;

1805 
»t
 = -
EINVAL
;

1806 ià(!
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
))

1807 
out_ä“_io_queues
;

1809 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

1810 
ù¾
->
g_£t
.
İs
 = &
nvme_rdma_mq_İs
;

1811 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
İts
->
queue_size
;

1812 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

1813 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1814 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

1815 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_rdma_»que¡
) +

1816 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

1817 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

1818 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->
queue_couÁ
 - 1;

1819 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

1821 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

1822 ià(
»t
)

1823 
out_put_dev
;

1824 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

1826 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

1827 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

1828 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

1829 
out_ä“_g_£t
;

1832 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

1833 ià(
»t
)

1834 
out_ş—nup_cÚÃù_q
;

1838 
out_ş—nup_cÚÃù_q
:

1839 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1840 
out_ä“_g_£t
:

1841 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1842 
out_put_dev
:

1843 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1844 
out_ä“_io_queues
:

1845 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

1846  
»t
;

1847 
	}
}

1849 
	$nvme_rdma_·r£_addr
(
sockaddr_š
 *
š_addr
, *
p
)

1851 
u8
 *
addr
 = (u8 *)&
š_addr
->
sš_addr
.
s_addr
;

1852 
size_t
 
buæ’
 = 
	`¡¾’
(
p
);

1856 ià(
buæ’
 > 
INET_ADDRSTRLEN
)

1857  -
EINVAL
;

1858 ià(
	`š4_±Ú
(
p
, 
buæ’
, 
addr
, '\0', 
NULL
) == 0)

1859  -
EINVAL
;

1860 
š_addr
->
sš_çmy
 = 
AF_INET
;

1862 
	}
}

1864 
nvme_ù¾
 *
	$nvme_rdma_ü—‹_ù¾
(
deviû
 *
dev
,

1865 
nvmf_ù¾_İtiÚs
 *
İts
)

1867 
nvme_rdma_ù¾
 *
ù¾
;

1868 
»t
;

1869 
boŞ
 
chªged
;

1871 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

1872 ià(!
ù¾
)

1873  
	`ERR_PTR
(-
ENOMEM
);

1874 
ù¾
->ù¾.
İts
 = opts;

1875 
	`INIT_LIST_HEAD
(&
ù¾
->
li¡
);

1877 
»t
 = 
	`nvme_rdma_·r£_addr
(&
ù¾
->
addr_š
, 
İts
->
Œaddr
);

1878 ià(
»t
) {

1879 
	`´_”r
("m®fÜmed IP‡dd»s ·s£d: %s\n", 
İts
->
Œaddr
);

1880 
out_ä“_ù¾
;

1883 ià(
İts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

1884 
u16
 
pÜt
;

1886 
»t
 = 
	`k¡¹ou16
(
İts
->
Œsvcid
, 0, &
pÜt
);

1887 ià(
»t
)

1888 
out_ä“_ù¾
;

1890 
ù¾
->
addr_š
.
sš_pÜt
 = 
	`ıu_to_be16
(
pÜt
);

1892 
ù¾
->
addr_š
.
sš_pÜt
 = 
	`ıu_to_be16
(
NVME_RDMA_IP_PORT
);

1895 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_rdma_ù¾_İs
,

1897 ià(
»t
)

1898 
out_ä“_ù¾
;

1900 
	`INIT_DELAYED_WORK
(&
ù¾
->
»cÚÃù_wÜk
,

1901 
nvme_rdma_»cÚÃù_ù¾_wÜk
);

1902 
	`INIT_WORK
(&
ù¾
->
”r_wÜk
, 
nvme_rdma_”rÜ_»cov”y_wÜk
);

1903 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_rdma_d–_ù¾_wÜk
);

1904 
	`INIT_WORK
(&
ù¾
->
»£t_wÜk
, 
nvme_rdma_»£t_ù¾_wÜk
);

1905 
	`¥š_lock_š™
(&
ù¾
->
lock
);

1907 
ù¾
->
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

1908 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

1909 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

1911 
»t
 = -
ENOMEM
;

1912 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->
queue_couÁ
, (*ctrl->queues),

1913 
GFP_KERNEL
);

1914 ià(!
ù¾
->
queues
)

1915 
out_unš™_ù¾
;

1917 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
);

1918 ià(
»t
)

1919 
out_kä“_queues
;

1922 ià(
ù¾
->ù¾.
icdoff
) {

1923 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff is‚ot supported!\n");

1924 
out_»move_admš_queue
;

1928 ià(!(
ù¾
->ù¾.
sgls
 & (1 << 20))) {

1929 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "Mandatory keyed sgls‡re‚ot support\n");

1930 
out_»move_admš_queue
;

1933 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

1935 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1937 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

1938 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

1941 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
sqsize
 + 1) {

1943 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1945 
İts
->
queue_size
, 
ù¾
->ù¾.
sqsize
 + 1);

1946 
İts
->
queue_size
 = 
ù¾
->ù¾.
sqsize
 + 1;

1949 ià(
İts
->
Ä_io_queues
) {

1950 
»t
 = 
	`nvme_rdma_ü—‹_io_queues
(
ù¾
);

1951 ià(
»t
)

1952 
out_»move_admš_queue
;

1955 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1956 
	`WARN_ON_ONCE
(!
chªged
);

1958 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "new ctrl: NQN \"%s\",‡ddr %pISp\n",

1959 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

1961 
	`k»f_g‘
(&
ù¾
->ù¾.
k»f
);

1963 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

1964 
	`li¡_add_
(&
ù¾
->
li¡
, &
nvme_rdma_ù¾_li¡
);

1965 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

1967 ià(
İts
->
Ä_io_queues
) {

1968 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

1969 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

1972  &
ù¾
->ctrl;

1974 
out_»move_admš_queue
:

1975 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

1976 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
);

1977 
out_kä“_queues
:

1978 
	`kä“
(
ù¾
->
queues
);

1979 
out_unš™_ù¾
:

1980 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1981 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1982 ià(
»t
 > 0)

1983 
»t
 = -
EIO
;

1984  
	`ERR_PTR
(
»t
);

1985 
out_ä“_ù¾
:

1986 
	`kä“
(
ù¾
);

1987  
	`ERR_PTR
(
»t
);

1988 
	}
}

1990 
nvmf_Œª¥Üt_İs
 
	gnvme_rdma_Œª¥Üt
 = {

1991 .
Çme
 = "rdma",

1992 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
,

1993 .
	g®lowed_İts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
 |

1994 
NVMF_OPT_CTRL_LOSS_TMO
,

1995 .
	gü—‹_ù¾
 = 
nvme_rdma_ü—‹_ù¾
,

1998 
	$nvme_rdma_add_Úe
(
ib_deviû
 *ib_device)

2000 
	}
}

2002 
	$nvme_rdma_»move_Úe
(
ib_deviû
 *ib_deviû, *
ş›Á_d©a
)

2004 
nvme_rdma_ù¾
 *
ù¾
;

2007 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

2008 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

2009 ià(
ù¾
->
deviû
->
dev
 !ğ
ib_deviû
)

2011 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2013 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

2014 
	`__nvme_rdma_d–_ù¾
(
ù¾
);

2016 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2018 
	`æush_wÜkqueue
(
nvme_rdma_wq
);

2019 
	}
}

2021 
ib_ş›Á
 
	gnvme_rdma_ib_ş›Á
 = {

2022 .
Çme
 = "nvme_rdma",

2023 .
	gadd
 = 
nvme_rdma_add_Úe
,

2024 .
	g»move
 = 
nvme_rdma_»move_Úe


2027 
__š™
 
	$nvme_rdma_š™_moduË
()

2029 
»t
;

2031 
nvme_rdma_wq
 = 
	`ü—‹_wÜkqueue
("nvme_rdma_wq");

2032 ià(!
nvme_rdma_wq
)

2033  -
ENOMEM
;

2035 
»t
 = 
	`ib_»gi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2036 ià(
»t
) {

2037 
	`de¡roy_wÜkqueue
(
nvme_rdma_wq
);

2038  
»t
;

2041 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2043 
	}
}

2045 
__ex™
 
	$nvme_rdma_ş—nup_moduË
()

2047 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2048 
	`ib_uÄegi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2049 
	`de¡roy_wÜkqueue
(
nvme_rdma_wq
);

2050 
	}
}

2052 
moduË_š™
(
nvme_rdma_š™_moduË
);

2053 
moduË_ex™
(
nvme_rdma_ş—nup_moduË
);

2055 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/scsi.c

20 
	~<lšux/bio.h
>

21 
	~<lšux/b™İs.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/com·t.h
>

24 
	~<lšux/d–ay.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/g’hd.h
>

28 
	~<lšux/idr.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/š‹¼u±.h
>

31 
	~<lšux/io.h
>

32 
	~<lšux/kdev_t.h
>

33 
	~<lšux/kth»ad.h
>

34 
	~<lšux/k”Ãl.h
>

35 
	~<lšux/mm.h
>

36 
	~<lšux/moduË.h
>

37 
	~<lšux/moduË·¿m.h
>

38 
	~<lšux/pci.h
>

39 
	~<lšux/poisÚ.h
>

40 
	~<lšux/sched.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/ty³s.h
>

43 
	~<asm/uÇligÃd.h
>

44 
	~<scsi/sg.h
>

45 
	~<scsi/scsi.h
>

47 
	~"nvme.h
"

49 
	gsg_v”siÚ_num
 = 30534;

52 
	#VPD_SUPPORTED_PAGES
 0x00

	)

53 
	#VPD_SERIAL_NUMBER
 0x80

	)

54 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

55 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

56 
	#VPD_BLOCK_LIMITS
 0xB0

	)

57 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

60 
	#FORMAT_UNIT_SHORT_PARM_LIST_LEN
 4

	)

61 
	#FORMAT_UNIT_LONG_PARM_LIST_LEN
 8

	)

62 
	#FORMAT_UNIT_PROT_INT_OFFSET
 3

	)

63 
	#FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
 0

	)

64 
	#FORMAT_UNIT_PROT_FIELD_USAGE_MASK
 0x07

	)

67 
	#FIXED_SENSE_DATA
 0x70

	)

68 
	#DESC_FORMAT_SENSE_DATA
 0x72

	)

69 
	#FIXED_SENSE_DATA_ADD_LENGTH
 10

	)

70 
	#LUN_ENTRY_SIZE
 8

	)

71 
	#LUN_DATA_HEADER_SIZE
 8

	)

72 
	#ALL_LUNS_RETURNED
 0x02

	)

73 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

74 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

75 
	#DOWNLOAD_SAVE_ACTIVATE
 0x05

	)

76 
	#DOWNLOAD_SAVE_DEFER_ACTIVATE
 0x0E

	)

77 
	#ACTIVATE_DEFERRED_MICROCODE
 0x0F

	)

78 
	#FORMAT_UNIT_IMMED_MASK
 0x2

	)

79 
	#FORMAT_UNIT_IMMED_OFFSET
 1

	)

80 
	#KELVIN_TEMP_FACTOR
 273

	)

81 
	#FIXED_FMT_SENSE_DATA_SIZE
 18

	)

82 
	#DESC_FMT_SENSE_DATA_SIZE
 8

	)

85 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

86 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

87 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

88 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

89 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

90 
	#INQ_BDEV_LIMITS_PAGE
 0xB0

	)

91 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

92 
	#INQ_SERIAL_NUMBER_LENGTH
 0x14

	)

93 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 6

	)

94 
	#VERSION_SPC_4
 0x06

	)

95 
	#ACA_UNSUPPORTED
 0

	)

96 
	#STANDARD_INQUIRY_LENGTH
 36

	)

97 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

98 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

99 
	#RESERVED_FIELD
 0

	)

102 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

103 
	#MODE_PAGE_CACHING
 0x08

	)

104 
	#MODE_PAGE_CONTROL
 0x0A

	)

105 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

106 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

107 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

108 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

109 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

110 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

111 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

112 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

113 
	#MODE_PAGE_ALL_LEN
 0x54

	)

114 
	#MODE_SENSE6_MPH_SIZE
 4

	)

115 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

116 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

117 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

118 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

119 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

120 
	#MODE_SENSE_DBD_MASK
 8

	)

121 
	#MODE_SENSE_DBD_SHIFT
 3

	)

122 
	#MODE_SENSE10_MPH_SIZE
 8

	)

123 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

124 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

125 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

126 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

127 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

128 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

129 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

130 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

131 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

132 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

133 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

134 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

135 
	#SHORT_DESC_BLOCK
 8

	)

136 
	#LONG_DESC_BLOCK
 16

	)

137 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

138 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

139 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

140 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

141 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

144 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
 0x00

	)

145 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
 0x07

	)

146 
	#LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
 0x2F

	)

147 
	#LOG_PAGE_TEMPERATURE_PAGE
 0x0D

	)

148 
	#LOG_SENSE_CDB_SP_NOT_ENABLED
 0

	)

149 
	#LOG_SENSE_CDB_PC_MASK
 0xC0

	)

150 
	#LOG_SENSE_CDB_PC_SHIFT
 6

	)

151 
	#LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
 1

	)

152 
	#LOG_SENSE_CDB_PAGE_CODE_MASK
 0x3F

	)

153 
	#REMAINING_INFO_EXCP_PAGE_LENGTH
 0x8

	)

154 
	#LOG_INFO_EXCP_PAGE_LENGTH
 0xC

	)

155 
	#REMAINING_TEMP_PAGE_LENGTH
 0xC

	)

156 
	#LOG_TEMP_PAGE_LENGTH
 0x10

	)

157 
	#LOG_TEMP_UNKNOWN
 0xFF

	)

158 
	#SUPPORTED_LOG_PAGES_PAGE_LENGTH
 0x3

	)

161 
	#READ_CAP_10_RESP_SIZE
 8

	)

162 
	#READ_CAP_16_RESP_SIZE
 32

	)

165 
	#BYTES_TO_DWORDS
 4

	)

166 
	#NVME_MAX_FIRMWARE_SLOT
 7

	)

169 
	#REPORT_LUNS_FIRST_LUN_OFFSET
 8

	)

173 
	#SCSI_ASC_NO_SENSE
 0x00

	)

174 
	#SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

175 
	#SCSI_ASC_LUN_NOT_READY
 0x04

	)

176 
	#SCSI_ASC_WARNING
 0x0B

	)

177 
	#SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

178 
	#SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

179 
	#SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

180 
	#SCSI_ASC_UNRECOVERED_READ_ERROR
 0x11

	)

181 
	#SCSI_ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

182 
	#SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
 0x20

	)

183 
	#SCSI_ASC_ILLEGAL_COMMAND
 0x20

	)

184 
	#SCSI_ASC_ILLEGAL_BLOCK
 0x21

	)

185 
	#SCSI_ASC_INVALID_CDB
 0x24

	)

186 
	#SCSI_ASC_INVALID_LUN
 0x25

	)

187 
	#SCSI_ASC_INVALID_PARAMETER
 0x26

	)

188 
	#SCSI_ASC_FORMAT_COMMAND_FAILED
 0x31

	)

189 
	#SCSI_ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

193 
	#SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

194 
	#SCSI_ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

195 
	#SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

196 
	#SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

197 
	#SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

198 
	#SCSI_ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

199 
	#SCSI_ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

200 
	#SCSI_ASCQ_INVALID_LUN_ID
 0x09

	)

203 
šlše
 
u32
 
	$g‘_uÇligÃd_be24
(
u8
 *
buf
)

205  0xfffffà& (
u32
è
	`g‘_uÇligÃd_be32
(
buf
 - 1);

206 
	}
}

211 
	snvme_Œªs_io_cdb
 {

212 
u8
 
	mfua
;

213 
u8
 
	m´Ù_šfo
;

214 
u64
 
	mlba
;

215 
u32
 
	mxãr_Ën
;

224 
	$nvme_Œªs_cİy_to_u£r
(
sg_io_hdr
 *
hdr
, *
äom
,

225 
n
)

227 
i
;

228 *
šdex
 = 
äom
;

229 
size_t
 
»maššg
 = 
n
;

230 
size_t
 
xãr_Ën
;

232 ià(
hdr
->
iovec_couÁ
 > 0) {

233 
sg_iovec
 
sgl
;

235 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

236 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

237 
i
 * (
sg_iovec
),

238 (
sg_iovec
)))

239  -
EFAULT
;

240 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

241 ià(
	`cİy_to_u£r
(
sgl
.
iov_ba£
, 
šdex
, 
xãr_Ën
))

242  -
EFAULT
;

244 
šdex
 +ğ
xãr_Ën
;

245 
»maššg
 -ğ
xãr_Ën
;

246 ià(
»maššg
 == 0)

252 ià(
	`cİy_to_u£r
(
hdr
->
dxã½
, 
äom
, 
n
))

253  -
EFAULT
;

255 
	}
}

259 
	$nvme_Œªs_cİy_äom_u£r
(
sg_io_hdr
 *
hdr
, *
to
,

260 
n
)

262 
i
;

263 *
šdex
 = 
to
;

264 
size_t
 
»maššg
 = 
n
;

265 
size_t
 
xãr_Ën
;

267 ià(
hdr
->
iovec_couÁ
 > 0) {

268 
sg_iovec
 
sgl
;

270 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

271 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

272 
i
 * (
sg_iovec
),

273 (
sg_iovec
)))

274  -
EFAULT
;

275 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

276 ià(
	`cİy_äom_u£r
(
šdex
, 
sgl
.
iov_ba£
, 
xãr_Ën
))

277  -
EFAULT
;

278 
šdex
 +ğ
xãr_Ën
;

279 
»maššg
 -ğ
xãr_Ën
;

280 ià(
»maššg
 == 0)

286 ià(
	`cİy_äom_u£r
(
to
, 
hdr
->
dxã½
, 
n
))

287  -
EFAULT
;

289 
	}
}

293 
	$nvme_Œªs_com¶‘iÚ
(
sg_io_hdr
 *
hdr
, 
u8
 
¡©us
, u8 
£n£_key
,

294 
u8
 
asc
, u8 
ascq
)

296 
u8
 
xãr_Ën
;

297 
u8
 
»¥
[
DESC_FMT_SENSE_DATA_SIZE
];

299 ià(
	`scsi_¡©us_is_good
(
¡©us
)) {

300 
hdr
->
¡©us
 = 
SAM_STAT_GOOD
;

301 
hdr
->
masked_¡©us
 = 
GOOD
;

302 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

303 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

304 
hdr
->
sb_Ën_wr
 = 0;

306 
hdr
->
¡©us
 = status;

307 
hdr
->
masked_¡©us
 = 
¡©us
 >> 1;

308 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

309 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

311 
	`mem£t
(
»¥
, 0, 
DESC_FMT_SENSE_DATA_SIZE
);

312 
»¥
[0] = 
DESC_FORMAT_SENSE_DATA
;

313 
»¥
[1] = 
£n£_key
;

314 
»¥
[2] = 
asc
;

315 
»¥
[3] = 
ascq
;

317 
xãr_Ën
 = 
	`mš_t
(
u8
, 
hdr
->
mx_sb_Ën
, 
DESC_FMT_SENSE_DATA_SIZE
);

318 
hdr
->
sb_Ën_wr
 = 
xãr_Ën
;

319 ià(
	`cİy_to_u£r
(
hdr
->
sbp
, 
»¥
, 
xãr_Ën
) > 0)

320  -
EFAULT
;

324 
	}
}

332 
	$nvme_Œªs_¡©us_code
(
sg_io_hdr
 *
hdr
, 
nvme_sc
)

334 
u8
 
¡©us
, 
£n£_key
, 
asc
, 
ascq
;

335 
»s
;

338 ià(
nvme_sc
 < 0)

339  
nvme_sc
;

342 
nvme_sc
 & 0x7FF) {

344 
NVME_SC_SUCCESS
:

345 
¡©us
 = 
SAM_STAT_GOOD
;

346 
£n£_key
 = 
NO_SENSE
;

347 
asc
 = 
SCSI_ASC_NO_SENSE
;

348 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

350 
NVME_SC_INVALID_OPCODE
:

351 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

352 
£n£_key
 = 
ILLEGAL_REQUEST
;

353 
asc
 = 
SCSI_ASC_ILLEGAL_COMMAND
;

354 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

356 
NVME_SC_INVALID_FIELD
:

357 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

358 
£n£_key
 = 
ILLEGAL_REQUEST
;

359 
asc
 = 
SCSI_ASC_INVALID_CDB
;

360 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

362 
NVME_SC_DATA_XFER_ERROR
:

363 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

364 
£n£_key
 = 
MEDIUM_ERROR
;

365 
asc
 = 
SCSI_ASC_NO_SENSE
;

366 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

368 
NVME_SC_POWER_LOSS
:

369 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

370 
£n£_key
 = 
ABORTED_COMMAND
;

371 
asc
 = 
SCSI_ASC_WARNING
;

372 
ascq
 = 
SCSI_ASCQ_POWER_LOSS_EXPECTED
;

374 
NVME_SC_INTERNAL
:

375 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

376 
£n£_key
 = 
HARDWARE_ERROR
;

377 
asc
 = 
SCSI_ASC_INTERNAL_TARGET_FAILURE
;

378 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

380 
NVME_SC_ABORT_REQ
:

381 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

382 
£n£_key
 = 
ABORTED_COMMAND
;

383 
asc
 = 
SCSI_ASC_NO_SENSE
;

384 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

386 
NVME_SC_ABORT_QUEUE
:

387 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

388 
£n£_key
 = 
ABORTED_COMMAND
;

389 
asc
 = 
SCSI_ASC_NO_SENSE
;

390 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

392 
NVME_SC_FUSED_FAIL
:

393 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

394 
£n£_key
 = 
ABORTED_COMMAND
;

395 
asc
 = 
SCSI_ASC_NO_SENSE
;

396 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

398 
NVME_SC_FUSED_MISSING
:

399 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

400 
£n£_key
 = 
ABORTED_COMMAND
;

401 
asc
 = 
SCSI_ASC_NO_SENSE
;

402 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

404 
NVME_SC_INVALID_NS
:

405 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

406 
£n£_key
 = 
ILLEGAL_REQUEST
;

407 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

408 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

410 
NVME_SC_LBA_RANGE
:

411 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

412 
£n£_key
 = 
ILLEGAL_REQUEST
;

413 
asc
 = 
SCSI_ASC_ILLEGAL_BLOCK
;

414 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

416 
NVME_SC_CAP_EXCEEDED
:

417 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

418 
£n£_key
 = 
MEDIUM_ERROR
;

419 
asc
 = 
SCSI_ASC_NO_SENSE
;

420 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

422 
NVME_SC_NS_NOT_READY
:

423 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

424 
£n£_key
 = 
NOT_READY
;

425 
asc
 = 
SCSI_ASC_LUN_NOT_READY
;

426 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

430 
NVME_SC_INVALID_FORMAT
:

431 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

432 
£n£_key
 = 
ILLEGAL_REQUEST
;

433 
asc
 = 
SCSI_ASC_FORMAT_COMMAND_FAILED
;

434 
ascq
 = 
SCSI_ASCQ_FORMAT_COMMAND_FAILED
;

436 
NVME_SC_BAD_ATTRIBUTES
:

437 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

438 
£n£_key
 = 
ILLEGAL_REQUEST
;

439 
asc
 = 
SCSI_ASC_INVALID_CDB
;

440 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

444 
NVME_SC_WRITE_FAULT
:

445 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

446 
£n£_key
 = 
MEDIUM_ERROR
;

447 
asc
 = 
SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
;

448 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

450 
NVME_SC_READ_ERROR
:

451 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

452 
£n£_key
 = 
MEDIUM_ERROR
;

453 
asc
 = 
SCSI_ASC_UNRECOVERED_READ_ERROR
;

454 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

456 
NVME_SC_GUARD_CHECK
:

457 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

458 
£n£_key
 = 
MEDIUM_ERROR
;

459 
asc
 = 
SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
;

460 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
;

462 
NVME_SC_APPTAG_CHECK
:

463 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

464 
£n£_key
 = 
MEDIUM_ERROR
;

465 
asc
 = 
SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
;

466 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
;

468 
NVME_SC_REFTAG_CHECK
:

469 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

470 
£n£_key
 = 
MEDIUM_ERROR
;

471 
asc
 = 
SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
;

472 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
;

474 
NVME_SC_COMPARE_FAILED
:

475 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

476 
£n£_key
 = 
MISCOMPARE
;

477 
asc
 = 
SCSI_ASC_MISCOMPARE_DURING_VERIFY
;

478 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

480 
NVME_SC_ACCESS_DENIED
:

481 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

482 
£n£_key
 = 
ILLEGAL_REQUEST
;

483 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

484 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

488 
NVME_SC_CMDID_CONFLICT
:

489 
NVME_SC_CMD_SEQ_ERROR
:

490 
NVME_SC_CQ_INVALID
:

491 
NVME_SC_QID_INVALID
:

492 
NVME_SC_QUEUE_SIZE
:

493 
NVME_SC_ABORT_LIMIT
:

494 
NVME_SC_ABORT_MISSING
:

495 
NVME_SC_ASYNC_LIMIT
:

496 
NVME_SC_FIRMWARE_SLOT
:

497 
NVME_SC_FIRMWARE_IMAGE
:

498 
NVME_SC_INVALID_VECTOR
:

499 
NVME_SC_INVALID_LOG_PAGE
:

501 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

502 
£n£_key
 = 
ILLEGAL_REQUEST
;

503 
asc
 = 
SCSI_ASC_NO_SENSE
;

504 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

508 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
¡©us
, 
£n£_key
, 
asc
, 
ascq
);

509  
»s
 ?„e : 
nvme_sc
;

510 
	}
}

514 
	$nvme_Œªs_¡ªd¬d_šquœy_·ge
(
nvme_ns
 *
ns
,

515 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

516 
®loc_Ën
)

518 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

519 
nvme_id_ns
 *
id_ns
;

520 
»s
;

521 
nvme_sc
;

522 
xãr_Ën
;

523 
u8
 
»¥_d©a_fÜm©
 = 0x02;

524 
u8
 
´Ùeù
;

525 
u8
 
cmdque
 = 0x01 << 1;

526 
u8
 
fw_off£t
 = (
ù¾
->
fœmw¬e_»v
);

529 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

530 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

531 ià(
»s
)

532  
»s
;

534 ià(
id_ns
->
dps
)

535 
´Ùeù
 = 0x01;

537 
´Ùeù
 = 0;

538 
	`kä“
(
id_ns
);

540 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

541 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

542 
šq_»¥Ú£
[3] = 
»¥_d©a_fÜm©
;

543 
šq_»¥Ú£
[4] = 
ADDITIONAL_STD_INQ_LENGTH
;

544 
šq_»¥Ú£
[5] = 
´Ùeù
;

545 
šq_»¥Ú£
[7] = 
cmdque
;

546 
	`¡ºıy
(&
šq_»¥Ú£
[8], "NVMe ", 8);

547 
	`¡ºıy
(&
šq_»¥Ú£
[16], 
ù¾
->
mod–
, 16);

549 
ù¾
->
fœmw¬e_»v
[
fw_off£t
 - 1] == ' ' && fw_offset > 4)

550 
fw_off£t
--;

551 
fw_off£t
 -= 4;

552 
	`¡ºıy
(&
šq_»¥Ú£
[32], 
ù¾
->
fœmw¬e_»v
 + 
fw_off£t
, 4);

554 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

555  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

556 
	}
}

558 
	$nvme_Œªs_suµÜ‹d_vpd_·ges
(
nvme_ns
 *
ns
,

559 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

560 
®loc_Ën
)

562 
xãr_Ën
;

564 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

565 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

566 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

567 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

568 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

569 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

570 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

571 
šq_»¥Ú£
[8] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

572 
šq_»¥Ú£
[9] = 
INQ_BDEV_LIMITS_PAGE
;

574 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

575  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

576 
	}
}

578 
	$nvme_Œªs_un™_£rŸl_·ge
(
nvme_ns
 *
ns
,

579 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

580 
®loc_Ën
)

582 
xãr_Ën
;

584 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

585 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

586 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

587 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
ns
->
ù¾
->
£rŸl
, 
INQ_SERIAL_NUMBER_LENGTH
);

589 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

590  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

591 
	}
}

593 
	$nvme_fl_deviû_id_eui64
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

594 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

596 
nvme_id_ns
 *
id_ns
;

597 
nvme_sc
, 
»s
;

598 
size_t
 
Ën
;

599 *
eui
;

601 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

602 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

603 ià(
»s
)

604  
»s
;

606 
eui
 = 
id_ns
->
eui64
;

607 
Ën
 = (
id_ns
->
eui64
);

609 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 0)) {

610 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

611 
eui
 = 
id_ns
->
nguid
;

612 
Ën
 = (
id_ns
->
nguid
);

616 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

617 
»s
 = -
EOPNOTSUPP
;

618 
out_ä“_id
;

621 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

622 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

623 
šq_»¥Ú£
[3] = 4 + 
Ën
;

626 
šq_»¥Ú£
[4] = 0x01;

627 
šq_»¥Ú£
[5] = 0x02;

628 
šq_»¥Ú£
[6] = 0x00;

629 
šq_»¥Ú£
[7] = 
Ën
;

630 
	`memıy
(&
šq_»¥Ú£
[8], 
eui
, 
Ën
);

632 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

633 
out_ä“_id
:

634 
	`kä“
(
id_ns
);

635  
»s
;

636 
	}
}

638 
	$nvme_fl_deviû_id_scsi_¡ršg
(
nvme_ns
 *
ns
,

639 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

641 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

642 
nvme_id_ù¾
 *
id_ù¾
;

643 
nvme_sc
, 
»s
;

645 ià(
®loc_Ën
 < 72) {

646  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

647 
SAM_STAT_CHECK_CONDITION
,

648 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

649 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

652 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

653 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

654 ià(
»s
)

655  
»s
;

657 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

658 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

659 
šq_»¥Ú£
[3] = 0x48;

662 
šq_»¥Ú£
[4] = 0x03;

663 
šq_»¥Ú£
[5] = 0x08;

664 
šq_»¥Ú£
[6] = 0x00;

665 
šq_»¥Ú£
[7] = 0x44;

667 
	`¥rštf
(&
šq_»¥Ú£
[8], "%04x", 
	`Ë16_to_ıu
(
id_ù¾
->
vid
));

668 
	`memıy
(&
šq_»¥Ú£
[12], 
ù¾
->
mod–
, (ctrl->model));

669 
	`¥rštf
(&
šq_»¥Ú£
[52], "%04x", 
	`ıu_to_be32
(
ns
->
ns_id
));

670 
	`memıy
(&
šq_»¥Ú£
[56], 
ù¾
->
£rŸl
, (ctrl->serial));

672 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

673 
	`kä“
(
id_ù¾
);

674  
»s
;

675 
	}
}

677 
	$nvme_Œªs_deviû_id_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

678 
u8
 *
»¥
, 
®loc_Ën
)

680 
»s
;

682 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0)) {

683 
»s
 = 
	`nvme_fl_deviû_id_eui64
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

684 ià(
»s
 !ğ-
EOPNOTSUPP
)

685  
»s
;

688  
	`nvme_fl_deviû_id_scsi_¡ršg
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

689 
	}
}

691 
	$nvme_Œªs_ext_šq_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

692 
®loc_Ën
)

694 
u8
 *
šq_»¥Ú£
;

695 
»s
;

696 
nvme_sc
;

697 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

698 
nvme_id_ù¾
 *
id_ù¾
;

699 
nvme_id_ns
 *
id_ns
;

700 
xãr_Ën
;

701 
u8
 
miüocode
 = 0x80;

702 
u8
 
¥t
;

703 
u8
 
¥t_lut
[8] = {0, 0, 2, 1, 4, 6, 5, 7};

704 
u8
 
grd_chk
, 
­p_chk
, 
»f_chk
, 
´Ùeù
;

705 
u8
 
uask_sup
 = 0x20;

706 
u8
 
v_sup
;

707 
u8
 
luişr
 = 0x01;

709 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

710 ià(
šq_»¥Ú£
 =ğ
NULL
)

711  -
ENOMEM
;

713 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

714 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

715 ià(
»s
)

716 
out_ä“_šq
;

718 
¥t
 = 
¥t_lut
[
id_ns
->
dpc
 & 0x07] << 3;

719 ià(
id_ns
->
dps
)

720 
´Ùeù
 = 0x01;

722 
´Ùeù
 = 0;

723 
	`kä“
(
id_ns
);

725 
grd_chk
 = 
´Ùeù
 << 2;

726 
­p_chk
 = 
´Ùeù
 << 1;

727 
»f_chk
 = 
´Ùeù
;

729 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

730 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

731 ià(
»s
)

732 
out_ä“_šq
;

734 
v_sup
 = 
id_ù¾
->
vwc
;

735 
	`kä“
(
id_ù¾
);

737 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

738 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

739 
šq_»¥Ú£
[2] = 0x00;

740 
šq_»¥Ú£
[3] = 0x3C;

741 
šq_»¥Ú£
[4] = 
miüocode
 | 
¥t
 | 
grd_chk
 | 
­p_chk
 | 
»f_chk
;

742 
šq_»¥Ú£
[5] = 
uask_sup
;

743 
šq_»¥Ú£
[6] = 
v_sup
;

744 
šq_»¥Ú£
[7] = 
luişr
;

745 
šq_»¥Ú£
[8] = 0;

746 
šq_»¥Ú£
[9] = 0;

748 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

749 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

751 
out_ä“_šq
:

752 
	`kä“
(
šq_»¥Ú£
);

753  
»s
;

754 
	}
}

756 
	$nvme_Œªs_bdev_lim™s_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

757 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

759 
__be32
 
max_£ùÜs
 = 
	`ıu_to_be32
(

760 
	`nvme_block_Ä
(
ns
, 
	`queue_max_hw_£ùÜs
Òs->
queue
)));

761 
__be32
 
max_disÿrd
 = 
	`ıu_to_be32
(
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
);

762 
__be32
 
disÿrd_desc_couÁ
 = 
	`ıu_to_be32
(0x100);

764 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

765 
šq_»¥Ú£
[1] = 
VPD_BLOCK_LIMITS
;

766 
šq_»¥Ú£
[3] = 0x3c;

767 
	`memıy
(&
šq_»¥Ú£
[8], &
max_£ùÜs
, (
u32
));

768 
	`memıy
(&
šq_»¥Ú£
[20], &
max_disÿrd
, (
u32
));

770 ià(
max_disÿrd
)

771 
	`memıy
(&
šq_»¥Ú£
[24], &
disÿrd_desc_couÁ
, (
u32
));

773  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 0x3c);

774 
	}
}

776 
	$nvme_Œªs_bdev_ch¬_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

777 
®loc_Ën
)

779 
u8
 *
šq_»¥Ú£
;

780 
»s
;

781 
xãr_Ën
;

783 
šq_»¥Ú£
 = 
	`kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

784 ià(
šq_»¥Ú£
 =ğ
NULL
) {

785 
»s
 = -
ENOMEM
;

786 
out_mem
;

789 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

790 
šq_»¥Ú£
[2] = 0x00;

791 
šq_»¥Ú£
[3] = 0x3C;

792 
šq_»¥Ú£
[4] = 0x00;

793 
šq_»¥Ú£
[5] = 0x01;

794 
šq_»¥Ú£
[6] = 0x00;

796 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

797 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

799 
	`kä“
(
šq_»¥Ú£
);

800 
out_mem
:

801  
»s
;

802 
	}
}

806 
	$nvme_Œªs_log_suµ_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

807 
®loc_Ën
)

809 
»s
;

810 
xãr_Ën
;

811 
u8
 *
log_»¥Ú£
;

813 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
, 
GFP_KERNEL
);

814 ià(
log_»¥Ú£
 =ğ
NULL
) {

815 
»s
 = -
ENOMEM
;

816 
out_mem
;

819 
log_»¥Ú£
[0] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

821 
log_»¥Ú£
[3] = 
SUPPORTED_LOG_PAGES_PAGE_LENGTH
;

822 
log_»¥Ú£
[4] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

823 
log_»¥Ú£
[5] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

824 
log_»¥Ú£
[6] = 
LOG_PAGE_TEMPERATURE_PAGE
;

826 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

827 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

829 
	`kä“
(
log_»¥Ú£
);

830 
out_mem
:

831  
»s
;

832 
	}
}

834 
	$nvme_Œªs_log_šfo_exû±iÚs
(
nvme_ns
 *
ns
,

835 
sg_io_hdr
 *
hdr
, 
®loc_Ën
)

837 
»s
;

838 
xãr_Ën
;

839 
u8
 *
log_»¥Ú£
;

840 
nvme_sm¬t_log
 *
sm¬t_log
;

841 
u8
 
‹mp_c
;

842 
u16
 
‹mp_k
;

844 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_INFO_EXCP_PAGE_LENGTH
, 
GFP_KERNEL
);

845 ià(
log_»¥Ú£
 =ğ
NULL
)

846  -
ENOMEM
;

848 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

849 ià(
»s
 < 0)

850 
out_ä“_»¥Ú£
;

852 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

853 
‹mp_c
 = 
LOG_TEMP_UNKNOWN
;

855 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

856 (
sm¬t_log
->
‹m³¿tu»
[0]);

857 
‹mp_c
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

859 
	`kä“
(
sm¬t_log
);

861 
log_»¥Ú£
[0] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

863 
log_»¥Ú£
[3] = 
REMAINING_INFO_EXCP_PAGE_LENGTH
;

866 
log_»¥Ú£
[6] = 0x23;

867 
log_»¥Ú£
[7] = 0x04;

870 
log_»¥Ú£
[10] = 
‹mp_c
;

872 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_INFO_EXCP_PAGE_LENGTH
);

873 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

875 
out_ä“_»¥Ú£
:

876 
	`kä“
(
log_»¥Ú£
);

877  
»s
;

878 
	}
}

880 
	$nvme_Œªs_log_‹m³¿tu»
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

881 
®loc_Ën
)

883 
»s
;

884 
xãr_Ën
;

885 
u8
 *
log_»¥Ú£
;

886 
nvme_sm¬t_log
 *
sm¬t_log
;

887 
u32
 
ã©u»_»¥
;

888 
u8
 
‹mp_c_cur
, 
‹mp_c_th»sh
;

889 
u16
 
‹mp_k
;

891 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_TEMP_PAGE_LENGTH
, 
GFP_KERNEL
);

892 ià(
log_»¥Ú£
 =ğ
NULL
)

893  -
ENOMEM
;

895 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

896 ià(
»s
 < 0)

897 
out_ä“_»¥Ú£
;

899 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

900 
‹mp_c_cur
 = 
LOG_TEMP_UNKNOWN
;

902 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

903 (
sm¬t_log
->
‹m³¿tu»
[0]);

904 
‹mp_c_cur
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

906 
	`kä“
(
sm¬t_log
);

909 
»s
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_TEMP_THRESH
, 0, 
NULL
, 0,

910 &
ã©u»_»¥
);

911 ià(
»s
 !ğ
NVME_SC_SUCCESS
)

912 
‹mp_c_th»sh
 = 
LOG_TEMP_UNKNOWN
;

914 
‹mp_c_th»sh
 = (
ã©u»_»¥
 & 0xFFFFè- 
KELVIN_TEMP_FACTOR
;

916 
log_»¥Ú£
[0] = 
LOG_PAGE_TEMPERATURE_PAGE
;

918 
log_»¥Ú£
[3] = 
REMAINING_TEMP_PAGE_LENGTH
;

921 
log_»¥Ú£
[6] = 0x01;

922 
log_»¥Ú£
[7] = 0x02;

924 
log_»¥Ú£
[9] = 
‹mp_c_cur
;

926 
log_»¥Ú£
[11] = 0x01;

927 
log_»¥Ú£
[12] = 0x01;

928 
log_»¥Ú£
[13] = 0x02;

930 
log_»¥Ú£
[15] = 
‹mp_c_th»sh
;

932 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_TEMP_PAGE_LENGTH
);

933 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

935 
out_ä“_»¥Ú£
:

936 
	`kä“
(
log_»¥Ú£
);

937  
»s
;

938 
	}
}

942 
	$nvme_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

943 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

946 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

947  -
EINVAL
;

949 ià(
cdb10
) {

950 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

951 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

952 
»¥
[3] = 0x10 ;

953 
»¥
[4] = 
Îb¯
;

954 
»¥
[5] = 
RESERVED_FIELD
;

955 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

956 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

958 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

959 
»¥
[2] = 0x10 ;

960 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

964 
	}
}

966 
	$nvme_Œªs_fl_blk_desc
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

967 
u8
 *
»¥
, 
Ën
, u8 
Îb¯
)

969 
»s
;

970 
nvme_sc
;

971 
nvme_id_ns
 *
id_ns
;

972 
u8
 
æbas
;

973 
u32
 
lba_Ëngth
;

975 ià(
Îb¯
 =ğ0 && 
Ën
 < 
MODE_PAGE_BLK_DES_LEN
)

976  -
EINVAL
;

977 ià(
Îb¯
 > 0 && 
Ën
 < 
MODE_PAGE_LLBAA_BLK_DES_LEN
)

978  -
EINVAL
;

980 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

981 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

982 ià(
»s
)

983  
»s
;

985 
æbas
 = (
id_ns
->flbas) & 0x0F;

986 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

988 ià(
Îb¯
 == 0) {

989 
__be32
 
tmp_ÿp
 = 
	`ıu_to_be32
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

991 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
 & 0x00FFFFFF);

993 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u32
));

994 
	`memıy
(&
»¥
[4], &
tmp_Ën
, (
u32
));

996 
__be64
 
tmp_ÿp
 = 
	`ıu_to_be64
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

997 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

999 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u64
));

1001 
	`memıy
(&
»¥
[12], &
tmp_Ën
, (
u32
));

1004 
	`kä“
(
id_ns
);

1005  
»s
;

1006 
	}
}

1008 
	$nvme_Œªs_fl_cÚŒŞ_·ge
(
nvme_ns
 *
ns
,

1009 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1010 
Ën
)

1012 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

1013  -
EINVAL
;

1015 
»¥
[0] = 
MODE_PAGE_CONTROL
;

1016 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

1017 
»¥
[2] = 0x0E;

1019 
»¥
[3] = 0x12;

1021 
»¥
[5] = 0x40;

1023 
»¥
[8] = 0xFF;

1024 
»¥
[9] = 0xFF;

1028 
	}
}

1030 
	$nvme_Œªs_fl_ÿchšg_·ge
(
nvme_ns
 *
ns
,

1031 
sg_io_hdr
 *
hdr
,

1032 
u8
 *
»¥
, 
Ën
)

1034 
»s
 = 0;

1035 
nvme_sc
;

1036 
u32
 
ã©u»_»¥
;

1037 
u8
 
vwc
;

1039 ià(
Ën
 < 
MODE_PAGE_CACHING_LEN
)

1040  -
EINVAL
;

1042 
nvme_sc
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
, 0, 
NULL
, 0,

1043 &
ã©u»_»¥
);

1044 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1045 ià(
»s
)

1046  
»s
;

1048 
vwc
 = 
ã©u»_»¥
 & 0x00000001;

1050 
»¥
[0] = 
MODE_PAGE_CACHING
;

1051 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

1052 
»¥
[2] = 
vwc
 << 2;

1054 
	}
}

1056 
	$nvme_Œªs_fl_pow_úd_·ge
(
nvme_ns
 *
ns
,

1057 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1058 
Ën
)

1060 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

1061  -
EINVAL
;

1063 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

1064 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

1068 
	}
}

1070 
	$nvme_Œªs_fl_šf_exc_·ge
(
nvme_ns
 *
ns
,

1071 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1072 
Ën
)

1074 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

1075  -
EINVAL
;

1077 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

1078 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

1079 
»¥
[2] = 0x88;

1083 
	}
}

1085 
	$nvme_Œªs_fl_®l_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1086 
u8
 *
»¥
, 
Ën
)

1088 
»s
;

1089 
u16
 
mode_·ges_off£t_1
 = 0;

1090 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

1092 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

1093 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

1094 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

1096 
»s
 = 
	`nvme_Œªs_fl_ÿchšg_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_1
],

1097 
MODE_PAGE_CACHING_LEN
);

1098 ià(
»s
)

1099  
»s
;

1100 
»s
 = 
	`nvme_Œªs_fl_cÚŒŞ_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_2
],

1101 
MODE_PAGE_CONTROL_LEN
);

1102 ià(
»s
)

1103  
»s
;

1104 
»s
 = 
	`nvme_Œªs_fl_pow_úd_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_3
],

1105 
MODE_PAGE_POW_CND_LEN
);

1106 ià(
»s
)

1107  
»s
;

1108  
	`nvme_Œªs_fl_šf_exc_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_4
],

1109 
MODE_PAGE_INF_EXC_LEN
);

1110 
	}
}

1112 
šlše
 
	$nvme_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

1114 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

1116  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

1120 
	}
}

1122 
nvme_Œªs_mode_·ge_ü—‹
(
nvme_ns
 *
ns
,

1123 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
,

1124 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

1125 (*
mode_·ge_fl_func
)

1126 (
nvme_ns
 *,

1127 
sg_io_hdr
 *
hdr
, 
u8
 *, ),

1128 
u16
 
mode_·ges_tÙ_Ën
)

1130 
»s
;

1131 
xãr_Ën
;

1132 
u8
 *
»¥Ú£
;

1133 
u8
 
dbd
, 
Îb¯
;

1134 
u16
 
»¥_size
;

1135 
mph_size
;

1136 
u16
 
mode_·ges_off£t_1
;

1137 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

1139 
dbd
 = (
cmd
[1] & 
MODE_SENSE_DBD_MASK
è>> 
MODE_SENSE_DBD_SHIFT
;

1140 
Îb¯
 = (
cmd
[1] & 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
;

1141 
mph_size
 = 
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
;

1143 
blk_desc_Ën
 = 
	`nvme_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

1145 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1147 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1149 
blk_desc_off£t
 = 
mph_size
;

1150 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

1152 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

1153 ià(
»¥Ú£
 =ğ
NULL
) {

1154 
»s
 = -
ENOMEM
;

1155 
out_mem
;

1158 
»s
 = 
	`nvme_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
,

1159 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

1160 ià(
»s
)

1161 
out_ä“
;

1162 ià(
blk_desc_Ën
 > 0) {

1163 
»s
 = 
	`nvme_Œªs_fl_blk_desc
(
ns
, 
hdr
,

1164 &
»¥Ú£
[
blk_desc_off£t
],

1165 
blk_desc_Ën
, 
Îb¯
);

1166 ià(
»s
)

1167 
out_ä“
;

1169 
»s
 = 
	`mode_·ge_fl_func
(
ns
, 
hdr
, &
»¥Ú£
[
mode_·ges_off£t_1
],

1170 
mode_·ges_tÙ_Ën
);

1171 ià(
»s
)

1172 
out_ä“
;

1174 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

1175 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

1177 
out_ä“
:

1178 
	`kä“
(
»¥Ú£
);

1179 
out_mem
:

1180  
»s
;

1181 
	}
}

1185 
	$nvme_Œªs_fl_»ad_ÿp
(
u8
 *
»¥Ú£
, 
nvme_id_ns
 *
id_ns
,

1186 
u8
 
cdb16
)

1188 
u8
 
æbas
;

1189 
u32
 
lba_Ëngth
;

1190 
u64
 
¾ba
;

1191 
u8
 
´Ù_’
;

1192 
u8
 
p_ty³_lut
[4] = {0, 0, 1, 2};

1193 
__be64
 
tmp_¾ba
;

1194 
__be32
 
tmp_¾ba_32
;

1195 
__be32
 
tmp_Ën
;

1197 
æbas
 = (
id_ns
->flbas) & 0x0F;

1198 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1199 
¾ba
 = 
	`Ë64_to_ıup
(&
id_ns
->
nsze
) - 1;

1200 (
id_ns
->
dps
è? (
´Ù_’
 = 0x01) : (prot_en = 0);

1202 ià(!
cdb16
) {

1203 ià(
¾ba
 > 0xFFFFFFFF)

1204 
¾ba
 = 0xFFFFFFFF;

1205 
tmp_¾ba_32
 = 
	`ıu_to_be32
(
¾ba
);

1206 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1207 
	`memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

1208 
	`memıy
(&
»¥Ú£
[4], &
tmp_Ën
, (
u32
));

1210 
tmp_¾ba
 = 
	`ıu_to_be64
(
¾ba
);

1211 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1212 
	`memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

1213 
	`memıy
(&
»¥Ú£
[8], &
tmp_Ën
, (
u32
));

1214 
»¥Ú£
[12] = (
p_ty³_lut
[
id_ns
->
dps
 & 0x3] << 1è| 
´Ù_’
;

1219 
	}
}

1223 
	$nvme_Œªs_£nd_aùiv©e_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1224 
u8
 
bufãr_id
)

1226 
nvme_commªd
 
c
;

1227 
nvme_sc
;

1229 
	`mem£t
(&
c
, 0, (c));

1230 
c
.
commÚ
.
İcode
 = 
nvme_admš_aùiv©e_fw
;

1231 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
bufãr_id
 | 
NVME_FWACT_REPL_ACTV
);

1233 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

1234  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1235 
	}
}

1237 
	$nvme_Œªs_£nd_dowÆßd_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1238 
u8
 
İcode
, 
u32
 
tÙ_Ën
, u32 
off£t
,

1239 
u8
 
bufãr_id
)

1241 
nvme_sc
;

1242 
nvme_commªd
 
c
;

1244 ià(
hdr
->
iovec_couÁ
 > 0) {

1246  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1247 
SAM_STAT_CHECK_CONDITION
,

1248 
ILLEGAL_REQUEST
,

1249 
SCSI_ASC_INVALID_CDB
,

1250 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1253 
	`mem£t
(&
c
, 0, (c));

1254 
c
.
commÚ
.
İcode
 = 
nvme_admš_dowÆßd_fw
;

1255 
c
.
dlfw
.
numd
 = 
	`ıu_to_Ë32
((
tÙ_Ën
/
BYTES_TO_DWORDS
) - 1);

1256 
c
.
dlfw
.
off£t
 = 
	`ıu_to_Ë32
(off£t/
BYTES_TO_DWORDS
);

1258 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
ù¾
->
admš_q
, &
c
,

1259 
hdr
->
dxã½
, 
tÙ_Ën
, 
NULL
, 0);

1260  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1261 
	}
}

1265 
šlše
 
	$nvme_Œªs_mode£l_g‘_bd_Ën
(
u8
 *
·rm_li¡
, u8 
cdb10
,

1266 
u16
 *
bd_Ën
, 
u8
 *
Îb¯
)

1268 ià(
cdb10
) {

1270 *
bd_Ën
 = (
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
] << 8) +

1271 
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
 + 1];

1272 *
Îb¯
 = 
·rm_li¡
[
MODE_SELECT_10_LLBAA_OFFSET
] &

1273 
MODE_SELECT_10_LLBAA_MASK
;

1276 *
bd_Ën
 = 
·rm_li¡
[
MODE_SELECT_6_BD_OFFSET
];

1278 
	}
}

1280 
	$nvme_Œªs_mode£l_§ve_bd
(
nvme_ns
 *
ns
, 
u8
 *
·rm_li¡
,

1281 
u16
 
idx
, u16 
bd_Ën
, 
u8
 
Îb¯
)

1285 ià(
Îb¯
 == 0) {

1287 
ns
->
mode_£Ëù_num_blocks
 =

1288 (
·rm_li¡
[
idx
 + 1] << 16) +

1289 (
·rm_li¡
[
idx
 + 2] << 8) +

1290 (
·rm_li¡
[
idx
 + 3]);

1292 
ns
->
mode_£Ëù_block_Ën
 =

1293 (
·rm_li¡
[
idx
 + 5] << 16) +

1294 (
·rm_li¡
[
idx
 + 6] << 8) +

1295 (
·rm_li¡
[
idx
 + 7]);

1298 
ns
->
mode_£Ëù_num_blocks
 =

1299 (((
u64
)
·rm_li¡
[
idx
 + 0]) << 56) +

1300 (((
u64
)
·rm_li¡
[
idx
 + 1]) << 48) +

1301 (((
u64
)
·rm_li¡
[
idx
 + 2]) << 40) +

1302 (((
u64
)
·rm_li¡
[
idx
 + 3]) << 32) +

1303 (((
u64
)
·rm_li¡
[
idx
 + 4]) << 24) +

1304 (((
u64
)
·rm_li¡
[
idx
 + 5]) << 16) +

1305 (((
u64
)
·rm_li¡
[
idx
 + 6]) << 8) +

1306 ((
u64
)
·rm_li¡
[
idx
 + 7]);

1308 
ns
->
mode_£Ëù_block_Ën
 =

1309 (
·rm_li¡
[
idx
 + 12] << 24) +

1310 (
·rm_li¡
[
idx
 + 13] << 16) +

1311 (
·rm_li¡
[
idx
 + 14] << 8) +

1312 (
·rm_li¡
[
idx
 + 15]);

1314 
	}
}

1316 
	$nvme_Œªs_mode£l_g‘_mp
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1317 
u8
 *
mode_·ge
, u8 
·ge_code
)

1319 
»s
 = 0;

1320 
nvme_sc
;

1321 
dwÜd11
;

1323 
·ge_code
) {

1324 
MODE_PAGE_CACHING
:

1325 
dwÜd11
 = ((
mode_·ge
[2] & 
CACHING_MODE_PAGE_WCE_MASK
) ? 1 : 0);

1326 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
,

1327 
dwÜd11
, 
NULL
, 0, NULL);

1328 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1330 
MODE_PAGE_CONTROL
:

1332 
MODE_PAGE_POWER_CONDITION
:

1334 ià((
mode_·ge
[2] & 0x01) != 0 || (mode_page[3] & 0x0F) != 0) {

1335 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1336 
SAM_STAT_CHECK_CONDITION
,

1337 
ILLEGAL_REQUEST
,

1338 
SCSI_ASC_INVALID_PARAMETER
,

1339 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1344 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1345 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1346 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1350  
»s
;

1351 
	}
}

1353 
	$nvme_Œªs_mode£l_d©a
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1354 
u8
 *
cmd
, 
u16
 
·rm_li¡_Ën
, u8 
pf
,

1355 
u8
 
¥
, u8 
cdb10
)

1357 
»s
;

1358 
u8
 *
·rm_li¡
;

1359 
u16
 
bd_Ën
;

1360 
u8
 
Îb¯
 = 0;

1361 
u16
 
šdex
, 
§ved_šdex
;

1362 
u8
 
·ge_code
;

1363 
u16
 
mp_size
;

1366 
·rm_li¡
 = 
	`km®loc
(
·rm_li¡_Ën
, 
GFP_KERNEL
);

1367 ià(
·rm_li¡
 =ğ
NULL
) {

1368 
»s
 = -
ENOMEM
;

1369 
out
;

1372 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
·rm_li¡_Ën
);

1373 ià(
»s
)

1374 
out_mem
;

1376 
	`nvme_Œªs_mode£l_g‘_bd_Ën
(
·rm_li¡
, 
cdb10
, &
bd_Ën
, &
Îb¯
);

1377 
šdex
 = (
cdb10
è? (
MODE_SELECT_10_MPH_SIZE
è: (
MODE_SELECT_6_MPH_SIZE
);

1379 ià(
bd_Ën
 != 0) {

1381 
	`nvme_Œªs_mode£l_§ve_bd
(
ns
, 
·rm_li¡
, 
šdex
, 
bd_Ën
, 
Îb¯
);

1382 
šdex
 +ğ
bd_Ën
;

1384 
§ved_šdex
 = 
šdex
;

1389 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1390 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1391 ià((
·ge_code
 !ğ
MODE_PAGE_CACHING
) &&

1392 (
·ge_code
 !ğ
MODE_PAGE_CONTROL
) &&

1393 (
·ge_code
 !ğ
MODE_PAGE_POWER_CONDITION
)) {

1394 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1395 
SAM_STAT_CHECK_CONDITION
,

1396 
ILLEGAL_REQUEST
,

1397 
SCSI_ASC_INVALID_CDB
,

1398 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1399 
out_mem
;

1401 
šdex
 +ğ
mp_size
;

1402 } 
šdex
 < 
·rm_li¡_Ën
);

1405 
šdex
 = 
§ved_šdex
;

1407 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1408 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1409 
»s
 = 
	`nvme_Œªs_mode£l_g‘_mp
(
ns
, 
hdr
, &
·rm_li¡
[
šdex
],

1410 
·ge_code
);

1411 ià(
»s
)

1413 
šdex
 +ğ
mp_size
;

1414 } 
šdex
 < 
·rm_li¡_Ën
);

1416 
out_mem
:

1417 
	`kä“
(
·rm_li¡
);

1418 
out
:

1419  
»s
;

1420 
	}
}

1424 
	$nvme_Œªs_fmt_£t_blk_size_couÁ
(
nvme_ns
 *
ns
,

1425 
sg_io_hdr
 *
hdr
)

1427 
»s
 = 0;

1428 
nvme_sc
;

1429 
u8
 
æbas
;

1438 ià(
ns
->
mode_£Ëù_num_blocks
 =ğ0 ||‚s->
mode_£Ëù_block_Ën
 == 0) {

1439 
nvme_id_ns
 *
id_ns
;

1441 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1442 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1443 ià(
»s
)

1444  
»s
;

1446 ià(
ns
->
mode_£Ëù_num_blocks
 == 0)

1447 
ns
->
mode_£Ëù_num_blocks
 = 
	`Ë64_to_ıu
(
id_ns
->
nÿp
);

1448 ià(
ns
->
mode_£Ëù_block_Ën
 == 0) {

1449 
æbas
 = (
id_ns
->flbas) & 0x0F;

1450 
ns
->
mode_£Ëù_block_Ën
 =

1451 (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1454 
	`kä“
(
id_ns
);

1458 
	}
}

1460 
	$nvme_Œªs_fmt_g‘_·rm_h—d”
(
sg_io_hdr
 *
hdr
, 
u8
 
Ën
,

1461 
u8
 
fÜm©_´Ù_šfo
, u8 *
nvme_pf_code
)

1463 
»s
;

1464 
u8
 *
·rm_li¡
;

1465 
u8
 
pf_u§ge
, 
pf_code
;

1467 
·rm_li¡
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1468 ià(
·rm_li¡
 =ğ
NULL
) {

1469 
»s
 = -
ENOMEM
;

1470 
out
;

1472 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
Ën
);

1473 ià(
»s
)

1474 
out_mem
;

1476 ià((
·rm_li¡
[
FORMAT_UNIT_IMMED_OFFSET
] &

1477 
FORMAT_UNIT_IMMED_MASK
) != 0) {

1478 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1479 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1480 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1481 
out_mem
;

1484 ià(
Ën
 =ğ
FORMAT_UNIT_LONG_PARM_LIST_LEN
 &&

1485 (
·rm_li¡
[
FORMAT_UNIT_PROT_INT_OFFSET
] & 0x0F) != 0) {

1486 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1487 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1488 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1489 
out_mem
;

1491 
pf_u§ge
 = 
·rm_li¡
[
FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
] &

1492 
FORMAT_UNIT_PROT_FIELD_USAGE_MASK
;

1493 
pf_code
 = (
pf_u§ge
 << 2è| 
fÜm©_´Ù_šfo
;

1494 
pf_code
) {

1496 *
nvme_pf_code
 = 0;

1499 *
nvme_pf_code
 = 1;

1502 *
nvme_pf_code
 = 2;

1505 *
nvme_pf_code
 = 3;

1508 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1509 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1510 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1514 
out_mem
:

1515 
	`kä“
(
·rm_li¡
);

1516 
out
:

1517  
»s
;

1518 
	}
}

1520 
	$nvme_Œªs_fmt_£nd_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1521 
u8
 
´Ù_šfo
)

1523 
»s
;

1524 
nvme_sc
;

1525 
nvme_id_ns
 *
id_ns
;

1526 
u8
 
i
;

1527 
u8
 
Æbaf
;

1528 
u8
 
£Ëùed_lbaf
 = 0xFF;

1529 
u32
 
cdw10
 = 0;

1530 
nvme_commªd
 
c
;

1533 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1534 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1535 ià(
»s
)

1536  
»s
;

1538 
Æbaf
 = 
id_ns
->nlbaf;

1540 
i
 = 0; i < 
Æbaf
; i++) {

1541 ià(
ns
->
mode_£Ëù_block_Ën
 =ğ(1 << (
id_ns
->
lbaf
[
i
].
ds
))) {

1542 
£Ëùed_lbaf
 = 
i
;

1546 ià(
£Ëùed_lbaf
 > 0x0F) {

1547 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1548 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1549 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1551 ià(
ns
->
mode_£Ëù_num_blocks
 !ğ
	`Ë64_to_ıu
(
id_ns
->
nÿp
)) {

1552 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1553 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1554 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1557 
cdw10
 |ğ
´Ù_šfo
 << 5;

1558 
cdw10
 |ğ
£Ëùed_lbaf
 & 0x0F;

1559 
	`mem£t
(&
c
, 0, (c));

1560 
c
.
fÜm©
.
İcode
 = 
nvme_admš_fÜm©_nvm
;

1561 
c
.
fÜm©
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1562 
c
.
fÜm©
.
cdw10
 = 
	`ıu_to_Ë32
(cdw10);

1564 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

1565 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1567 
	`kä“
(
id_ns
);

1568  
»s
;

1569 
	}
}

1571 
šlše
 
u32
 
	$nvme_Œªs_io_g‘_num_cmds
(
sg_io_hdr
 *
hdr
,

1572 
nvme_Œªs_io_cdb
 *
cdb_šfo
,

1573 
u32
 
max_blocks
)

1576 ià(
hdr
->
iovec_couÁ
 > 0)

1577  
hdr
->
iovec_couÁ
;

1578 ià(
cdb_šfo
->
xãr_Ën
 > 
max_blocks
)

1579  ((
cdb_šfo
->
xãr_Ën
 - 1è/ 
max_blocks
) + 1;

1582 
	}
}

1584 
u16
 
	$nvme_Œªs_io_g‘_cÚŒŞ
(
nvme_ns
 *
ns
,

1585 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1587 
u16
 
cÚŒŞ
 = 0;

1591 ià(
cdb_šfo
->
fua
 > 0)

1592 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1594  
cÚŒŞ
;

1595 
	}
}

1597 
	$nvme_Œªs_do_nvme_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1598 
nvme_Œªs_io_cdb
 *
cdb_šfo
, 
u8
 
is_wr™e
)

1600 
nvme_sc
 = 
NVME_SC_SUCCESS
;

1601 
u32
 
num_cmds
;

1602 
u64
 
un™_Ën
;

1603 
u64
 
un™_num_blocks
;

1604 
u32
 
»tcode
;

1605 
u32
 
i
 = 0;

1606 
u64
 
nvme_off£t
 = 0;

1607 
__u£r
 *
Ãxt_m­pšg_addr
;

1608 
nvme_commªd
 
c
;

1609 
u8
 
İcode
 = (
is_wr™e
 ? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1610 
u16
 
cÚŒŞ
;

1611 
u32
 
max_blocks
 = 
	`queue_max_hw_£ùÜs
(
ns
->
queue
);

1613 
num_cmds
 = 
	`nvme_Œªs_io_g‘_num_cmds
(
hdr
, 
cdb_šfo
, 
max_blocks
);

1624 
i
 = 0; i < 
num_cmds
; i++) {

1625 
	`mem£t
(&
c
, 0, (c));

1626 ià(
hdr
->
iovec_couÁ
 > 0) {

1627 
sg_iovec
 
sgl
;

1629 
»tcode
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1630 
i
 * (
sg_iovec
),

1631 (
sg_iovec
));

1632 ià(
»tcode
)

1633  -
EFAULT
;

1634 
un™_Ën
 = 
sgl
.
iov_Ën
;

1635 
un™_num_blocks
 = 
un™_Ën
 >> 
ns
->
lba_shiá
;

1636 
Ãxt_m­pšg_addr
 = 
sgl
.
iov_ba£
;

1638 
un™_num_blocks
 = 
	`mš
((
u64
)
max_blocks
,

1639 (
cdb_šfo
->
xãr_Ën
 - 
nvme_off£t
));

1640 
un™_Ën
 = 
un™_num_blocks
 << 
ns
->
lba_shiá
;

1641 
Ãxt_m­pšg_addr
 = 
hdr
->
dxã½
 +

1642 ((1 << 
ns
->
lba_shiá
è* 
nvme_off£t
);

1645 
c
.
rw
.
İcode
 = opcode;

1646 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1647 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
cdb_šfo
->
lba
 + 
nvme_off£t
);

1648 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
un™_num_blocks
 - 1);

1649 
cÚŒŞ
 = 
	`nvme_Œªs_io_g‘_cÚŒŞ
(
ns
, 
cdb_šfo
);

1650 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1652 ià(
	`g‘_ÿ·c™y
(
ns
->
disk
è- 
un™_num_blocks
 <

1653 
cdb_šfo
->
lba
 + 
nvme_off£t
) {

1654 
nvme_sc
 = 
NVME_SC_LBA_RANGE
;

1657 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1658 
Ãxt_m­pšg_addr
, 
un™_Ën
, 
NULL
, 0);

1659 ià(
nvme_sc
)

1662 
nvme_off£t
 +ğ
un™_num_blocks
;

1665  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1666 
	}
}

1671 
	$nvme_Œªs_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
, 
u8
 
is_wr™e
,

1672 
u8
 *
cmd
)

1674 
»s
 = 0;

1675 
nvme_Œªs_io_cdb
 
cdb_šfo
 = { 0, };

1676 
u8
 
İcode
 = 
cmd
[0];

1677 
u64
 
xãr_by‹s
;

1678 
u64
 
sum_iov_Ën
 = 0;

1679 
sg_iovec
 
sgl
;

1680 
i
;

1681 
size_t
 
nÙ_cİ›d
;

1687 
İcode
) {

1688 
WRITE_6
:

1689 
READ_6
:

1692 
cdb_šfo
.
fua
 = 
cmd
[1] & 0x8;

1693 
cdb_šfo
.
´Ù_šfo
 = (
cmd
[1] & 0xe0) >> 5;

1694 ià(
cdb_šfo
.
´Ù_šfo
 && !
ns
->
pi_ty³
) {

1695  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1696 
SAM_STAT_CHECK_CONDITION
,

1697 
ILLEGAL_REQUEST
,

1698 
SCSI_ASC_INVALID_CDB
,

1699 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1703 
İcode
) {

1704 
WRITE_6
:

1705 
READ_6
:

1706 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[1]);

1707 
cdb_šfo
.
xãr_Ën
 = 
cmd
[4];

1708 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1709 
cdb_šfo
.
xãr_Ën
 = 256;

1711 
WRITE_10
:

1712 
READ_10
:

1713 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1714 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1716 
WRITE_12
:

1717 
READ_12
:

1718 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1719 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

1721 
WRITE_16
:

1722 
READ_16
:

1723 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be64
(&
cmd
[2]);

1724 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

1728 
»s
 = -
EIO
;

1729 
out
;

1733 ià(
hdr
->
iovec_couÁ
 > 0) {

1734 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

1735 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1736 
i
 * (
sg_iovec
),

1737 (
sg_iovec
));

1738 ià(
nÙ_cİ›d
)

1739  -
EFAULT
;

1740 
sum_iov_Ën
 +ğ
sgl
.
iov_Ën
;

1742 ià(
sgl
.
iov_Ën
 % (1 << 
ns
->
lba_shiá
) != 0) {

1743 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1744 
SAM_STAT_CHECK_CONDITION
,

1745 
ILLEGAL_REQUEST
,

1746 
SCSI_ASC_INVALID_PARAMETER
,

1747 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1748 
out
;

1752 
sum_iov_Ën
 = 
hdr
->
dxãr_Ën
;

1756 
xãr_by‹s
 = 
	`mš
(((
u64
)
hdr
->
dxãr_Ën
), 
sum_iov_Ën
);

1759 ià(
xãr_by‹s
 !ğ(
cdb_šfo
.
xãr_Ën
 << 
ns
->
lba_shiá
)) {

1760 
»s
 = -
EINVAL
;

1761 
out
;

1765 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1766 
out
;

1769 
»s
 = 
	`nvme_Œªs_do_nvme_io
(
ns
, 
hdr
, &
cdb_šfo
, 
is_wr™e
);

1770 ià(
»s
)

1771 
out
;

1773 
out
:

1774  
»s
;

1775 
	}
}

1777 
	$nvme_Œªs_šquœy
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1778 
u8
 *
cmd
)

1780 
»s
 = 0;

1781 
u8
 
evpd
;

1782 
u8
 
·ge_code
;

1783 
®loc_Ën
;

1784 
u8
 *
šq_»¥Ú£
;

1786 
evpd
 = 
cmd
[1] & 0x01;

1787 
·ge_code
 = 
cmd
[2];

1788 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[3]);

1790 
šq_»¥Ú£
 = 
	`km®loc
(
	`max
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
),

1791 
GFP_KERNEL
);

1792 ià(
šq_»¥Ú£
 =ğ
NULL
) {

1793 
»s
 = -
ENOMEM
;

1794 
out_mem
;

1797 ià(
evpd
 == 0) {

1798 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

1799 
»s
 = 
	`nvme_Œªs_¡ªd¬d_šquœy_·ge
(
ns
, 
hdr
,

1800 
šq_»¥Ú£
, 
®loc_Ën
);

1802 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1803 
SAM_STAT_CHECK_CONDITION
,

1804 
ILLEGAL_REQUEST
,

1805 
SCSI_ASC_INVALID_CDB
,

1806 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1809 
·ge_code
) {

1810 
VPD_SUPPORTED_PAGES
:

1811 
»s
 = 
	`nvme_Œªs_suµÜ‹d_vpd_·ges
(
ns
, 
hdr
,

1812 
šq_»¥Ú£
, 
®loc_Ën
);

1814 
VPD_SERIAL_NUMBER
:

1815 
»s
 = 
	`nvme_Œªs_un™_£rŸl_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1816 
®loc_Ën
);

1818 
VPD_DEVICE_IDENTIFIERS
:

1819 
»s
 = 
	`nvme_Œªs_deviû_id_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1820 
®loc_Ën
);

1822 
VPD_EXTENDED_INQUIRY
:

1823 
»s
 = 
	`nvme_Œªs_ext_šq_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1825 
VPD_BLOCK_LIMITS
:

1826 
»s
 = 
	`nvme_Œªs_bdev_lim™s_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1827 
®loc_Ën
);

1829 
VPD_BLOCK_DEV_CHARACTERISTICS
:

1830 
»s
 = 
	`nvme_Œªs_bdev_ch¬_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1833 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1834 
SAM_STAT_CHECK_CONDITION
,

1835 
ILLEGAL_REQUEST
,

1836 
SCSI_ASC_INVALID_CDB
,

1837 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1841 
	`kä“
(
šq_»¥Ú£
);

1842 
out_mem
:

1843  
»s
;

1844 
	}
}

1846 
	$nvme_Œªs_log_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1847 
u8
 *
cmd
)

1849 
»s
;

1850 
u16
 
®loc_Ën
;

1851 
u8
 
pc
;

1852 
u8
 
·ge_code
;

1854 ià(
cmd
[1] !ğ
LOG_SENSE_CDB_SP_NOT_ENABLED
) {

1855 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1856 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1857 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1858 
out
;

1861 
·ge_code
 = 
cmd
[2] & 
LOG_SENSE_CDB_PAGE_CODE_MASK
;

1862 
pc
 = (
cmd
[2] & 
LOG_SENSE_CDB_PC_MASK
è>> 
LOG_SENSE_CDB_PC_SHIFT
;

1863 ià(
pc
 !ğ
LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
) {

1864 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1865 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1866 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1867 
out
;

1869 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1870 
·ge_code
) {

1871 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
:

1872 
»s
 = 
	`nvme_Œªs_log_suµ_·ges
(
ns
, 
hdr
, 
®loc_Ën
);

1874 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
:

1875 
»s
 = 
	`nvme_Œªs_log_šfo_exû±iÚs
(
ns
, 
hdr
, 
®loc_Ën
);

1877 
LOG_PAGE_TEMPERATURE_PAGE
:

1878 
»s
 = 
	`nvme_Œªs_log_‹m³¿tu»
(
ns
, 
hdr
, 
®loc_Ën
);

1881 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1882 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1883 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1887 
out
:

1888  
»s
;

1889 
	}
}

1891 
	$nvme_Œªs_mode_£Ëù
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1892 
u8
 *
cmd
)

1894 
u8
 
cdb10
 = 0;

1895 
u16
 
·rm_li¡_Ën
;

1896 
u8
 
·ge_fÜm©
;

1897 
u8
 
§ve_·ges
;

1899 
·ge_fÜm©
 = 
cmd
[1] & 
MODE_SELECT_CDB_PAGE_FORMAT_MASK
;

1900 
§ve_·ges
 = 
cmd
[1] & 
MODE_SELECT_CDB_SAVE_PAGES_MASK
;

1902 ià(
cmd
[0] =ğ
MODE_SELECT
) {

1903 
·rm_li¡_Ën
 = 
cmd
[4];

1905 
·rm_li¡_Ën
 = 
cmd
[7];

1906 
cdb10
 = 1;

1909 ià(
·rm_li¡_Ën
 != 0) {

1914  
	`nvme_Œªs_mode£l_d©a
(
ns
, 
hdr
, 
cmd
, 
·rm_li¡_Ën
,

1915 
·ge_fÜm©
, 
§ve_·ges
, 
cdb10
);

1919 
	}
}

1921 
	$nvme_Œªs_mode_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1922 
u8
 *
cmd
)

1924 
»s
 = 0;

1925 
u16
 
®loc_Ën
;

1926 
u8
 
cdb10
 = 0;

1928 ià(
cmd
[0] =ğ
MODE_SENSE
) {

1929 
®loc_Ën
 = 
cmd
[4];

1931 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1932 
cdb10
 = 1;

1935 ià((
cmd
[2] & 
MODE_SENSE_PAGE_CONTROL_MASK
) !=

1936 
MODE_SENSE_PC_CURRENT_VALUES
) {

1937 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1938 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1939 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1940 
out
;

1943 
cmd
[2] & 
MODE_SENSE_PAGE_CODE_MASK
) {

1944 
MODE_PAGE_CACHING
:

1945 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1946 
cdb10
,

1947 &
nvme_Œªs_fl_ÿchšg_·ge
,

1948 
MODE_PAGE_CACHING_LEN
);

1950 
MODE_PAGE_CONTROL
:

1951 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1952 
cdb10
,

1953 &
nvme_Œªs_fl_cÚŒŞ_·ge
,

1954 
MODE_PAGE_CONTROL_LEN
);

1956 
MODE_PAGE_POWER_CONDITION
:

1957 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1958 
cdb10
,

1959 &
nvme_Œªs_fl_pow_úd_·ge
,

1960 
MODE_PAGE_POW_CND_LEN
);

1962 
MODE_PAGE_INFO_EXCEP
:

1963 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1964 
cdb10
,

1965 &
nvme_Œªs_fl_šf_exc_·ge
,

1966 
MODE_PAGE_INF_EXC_LEN
);

1968 
MODE_PAGE_RETURN_ALL
:

1969 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1970 
cdb10
,

1971 &
nvme_Œªs_fl_®l_·ges
,

1972 
MODE_PAGE_ALL_LEN
);

1975 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1976 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1977 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1981 
out
:

1982  
»s
;

1983 
	}
}

1985 
	$nvme_Œªs_»ad_ÿ·c™y
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1986 
u8
 *
cmd
, u8 
cdb16
)

1988 
»s
;

1989 
nvme_sc
;

1990 
u32
 
®loc_Ën
;

1991 
u32
 
»¥_size
;

1992 
u32
 
xãr_Ën
;

1993 
nvme_id_ns
 *
id_ns
;

1994 
u8
 *
»¥Ú£
;

1996 ià(
cdb16
) {

1997 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

1998 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

2000 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

2001 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

2004 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

2005 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2006 ià(
»s
)

2007  
»s
;

2009 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2010 ià(
»¥Ú£
 =ğ
NULL
) {

2011 
»s
 = -
ENOMEM
;

2012 
out_ä“_id
;

2014 
	`nvme_Œªs_fl_»ad_ÿp
(
»¥Ú£
, 
id_ns
, 
cdb16
);

2016 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2017 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2019 
	`kä“
(
»¥Ú£
);

2020 
out_ä“_id
:

2021 
	`kä“
(
id_ns
);

2022  
»s
;

2023 
	}
}

2025 
	$nvme_Œªs_»pÜt_luns
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2026 
u8
 *
cmd
)

2028 
»s
;

2029 
nvme_sc
;

2030 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2031 
u8
 *
»¥Ú£
;

2032 
nvme_id_ù¾
 *
id_ù¾
;

2033 
u32
 
Î_Ëngth
, 
lun_id
;

2034 
u8
 
lun_id_off£t
 = 
REPORT_LUNS_FIRST_LUN_OFFSET
;

2035 
__be32
 
tmp_Ën
;

2037 
cmd
[2]) {

2039  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2040 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2041 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2042 
ALL_LUNS_RETURNED
:

2043 
ALL_WELL_KNOWN_LUNS_RETURNED
:

2044 
RESTRICTED_LUNS_RETURNED
:

2045 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ns
->
ù¾
, &
id_ù¾
);

2046 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2047 ià(
»s
)

2048  
»s
;

2050 
Î_Ëngth
 = 
	`Ë32_to_ıu
(
id_ù¾
->
Â
è* 
LUN_ENTRY_SIZE
;

2051 
»¥_size
 = 
Î_Ëngth
 + 
LUN_DATA_HEADER_SIZE
;

2053 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

2054 ià(
®loc_Ën
 < 
»¥_size
) {

2055 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2056 
SAM_STAT_CHECK_CONDITION
,

2057 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2058 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2059 
out_ä“_id
;

2062 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2063 ià(
»¥Ú£
 =ğ
NULL
) {

2064 
»s
 = -
ENOMEM
;

2065 
out_ä“_id
;

2069 
lun_id
 = 0;†un_id < 
	`Ë32_to_ıu
(
id_ù¾
->
Â
);†un_id++) {

2074 
__be64
 
tmp_id
 = 
	`ıu_to_be64
(
lun_id
);

2075 
	`memıy
(&
»¥Ú£
[
lun_id_off£t
], &
tmp_id
, (
u64
));

2076 
lun_id_off£t
 +ğ
LUN_ENTRY_SIZE
;

2078 
tmp_Ën
 = 
	`ıu_to_be32
(
Î_Ëngth
);

2079 
	`memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

2082 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2083 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2085 
	`kä“
(
»¥Ú£
);

2086 
out_ä“_id
:

2087 
	`kä“
(
id_ù¾
);

2088  
»s
;

2089 
	}
}

2091 
	$nvme_Œªs_»que¡_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2092 
u8
 *
cmd
)

2094 
»s
;

2095 
u8
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2096 
u8
 
desc_fÜm©
;

2097 
u8
 *
»¥Ú£
;

2099 
desc_fÜm©
 = 
cmd
[1] & 0x01;

2100 
®loc_Ën
 = 
cmd
[4];

2102 
»¥_size
 = ((
desc_fÜm©
è? (
DESC_FMT_SENSE_DATA_SIZE
) :

2103 (
FIXED_FMT_SENSE_DATA_SIZE
));

2104 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2105 ià(
»¥Ú£
 =ğ
NULL
) {

2106 
»s
 = -
ENOMEM
;

2107 
out
;

2110 ià(
desc_fÜm©
) {

2112 
»¥Ú£
[0] = 
DESC_FORMAT_SENSE_DATA
;

2113 
»¥Ú£
[1] = 
NO_SENSE
;

2115 
»¥Ú£
[2] = 
SCSI_ASC_NO_SENSE
;

2116 
»¥Ú£
[3] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2120 
»¥Ú£
[0] = 
FIXED_SENSE_DATA
;

2122 
»¥Ú£
[2] = 
NO_SENSE
;

2124 
»¥Ú£
[7] = 
FIXED_SENSE_DATA_ADD_LENGTH
;

2126 
»¥Ú£
[12] = 
SCSI_ASC_NO_SENSE
;

2127 
»¥Ú£
[13] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2132 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2133 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2135 
	`kä“
(
»¥Ú£
);

2136 
out
:

2137  
»s
;

2138 
	}
}

2140 
	$nvme_Œªs_£cur™y_´ÙocŞ
(
nvme_ns
 *
ns
,

2141 
sg_io_hdr
 *
hdr
,

2142 
u8
 *
cmd
)

2144  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2145 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2146 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2147 
	}
}

2149 
	$nvme_Œªs_synchrÚize_ÿche
(
nvme_ns
 *
ns
,

2150 
sg_io_hdr
 *
hdr
)

2152 
nvme_sc
;

2153 
nvme_commªd
 
c
;

2155 
	`mem£t
(&
c
, 0, (c));

2156 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2157 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2159 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

2160  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2161 
	}
}

2163 
	$nvme_Œªs_fÜm©_un™
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2164 
u8
 *
cmd
)

2166 
»s
;

2167 
u8
 
·rm_hdr_Ën
 = 0;

2168 
u8
 
nvme_pf_code
 = 0;

2169 
u8
 
fÜm©_´Ù_šfo
, 
lÚg_li¡
, 
fÜm©_d©a
;

2171 
fÜm©_´Ù_šfo
 = (
cmd
[1] & 0xc0) >> 6;

2172 
lÚg_li¡
 = 
cmd
[1] & 0x20;

2173 
fÜm©_d©a
 = 
cmd
[1] & 0x10;

2175 ià(
fÜm©_d©a
 != 0) {

2176 ià(
fÜm©_´Ù_šfo
 != 0) {

2177 ià(
lÚg_li¡
 == 0)

2178 
·rm_hdr_Ën
 = 
FORMAT_UNIT_SHORT_PARM_LIST_LEN
;

2180 
·rm_hdr_Ën
 = 
FORMAT_UNIT_LONG_PARM_LIST_LEN
;

2182 } ià(
fÜm©_d©a
 =ğ0 && 
fÜm©_´Ù_šfo
 != 0) {

2183 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2184 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2185 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2186 
out
;

2194 ià(
·rm_hdr_Ën
 > 0) {

2195 
»s
 = 
	`nvme_Œªs_fmt_g‘_·rm_h—d”
(
hdr
, 
·rm_hdr_Ën
,

2196 
fÜm©_´Ù_šfo
, &
nvme_pf_code
);

2197 ià(
»s
)

2198 
out
;

2202 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 0);

2205 
»s
 = 
	`nvme_Œªs_fmt_£t_blk_size_couÁ
(
ns
, 
hdr
);

2206 ià(
»s
)

2207 
out
;

2209 
»s
 = 
	`nvme_Œªs_fmt_£nd_cmd
(
ns
, 
hdr
, 
nvme_pf_code
);

2211 
out
:

2212  
»s
;

2213 
	}
}

2215 
	$nvme_Œªs_‹¡_un™_»ady
(
nvme_ns
 *
ns
,

2216 
sg_io_hdr
 *
hdr
,

2217 
u8
 *
cmd
)

2219 ià(
	`nvme_ù¾_»ady
(
ns
->
ù¾
))

2220  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2221 
NOT_READY
, 
SCSI_ASC_LUN_NOT_READY
,

2222 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2224  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_GOOD
, 
NO_SENSE
, 0, 0);

2225 
	}
}

2227 
	$nvme_Œªs_wr™e_bufãr
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2228 
u8
 *
cmd
)

2230 
»s
 = 0;

2231 
u32
 
bufãr_off£t
, 
·rm_li¡_Ëngth
;

2232 
u8
 
bufãr_id
, 
mode
;

2234 
·rm_li¡_Ëngth
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[6]);

2235 ià(
·rm_li¡_Ëngth
 % 
BYTES_TO_DWORDS
 != 0) {

2237 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2238 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2239 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2240 
out
;

2242 
bufãr_id
 = 
cmd
[2];

2243 ià(
bufãr_id
 > 
NVME_MAX_FIRMWARE_SLOT
) {

2244 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2245 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2246 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2247 
out
;

2249 
mode
 = 
cmd
[1] & 0x1f;

2250 
bufãr_off£t
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[3]);

2252 
mode
) {

2253 
DOWNLOAD_SAVE_ACTIVATE
:

2254 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2255 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2256 
bufãr_id
);

2257 ià(
»s
)

2258 
out
;

2259 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2261 
DOWNLOAD_SAVE_DEFER_ACTIVATE
:

2262 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2263 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2264 
bufãr_id
);

2266 
ACTIVATE_DEFERRED_MICROCODE
:

2267 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2270 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2271 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2272 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2276 
out
:

2277  
»s
;

2278 
	}
}

2280 
	sscsi_unm­_blk_desc
 {

2281 
__be64
 
	m¦ba
;

2282 
__be32
 
	mÆb
;

2283 
u32
 
	m»sv
;

2286 
	sscsi_unm­_·rm_li¡
 {

2287 
__be16
 
	munm­_d©a_Ën
;

2288 
__be16
 
	munm­_blk_desc_d©a_Ën
;

2289 
u32
 
	m»sv
;

2290 
scsi_unm­_blk_desc
 
	mdesc
[0];

2293 
	$nvme_Œªs_unm­
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2294 
u8
 *
cmd
)

2296 
scsi_unm­_·rm_li¡
 *
¶i¡
;

2297 
nvme_dsm_¿nge
 *
¿nge
;

2298 
nvme_commªd
 
c
;

2299 
i
, 
nvme_sc
, 
»s
;

2300 
u16
 
ndesc
, 
li¡_Ën
;

2302 
li¡_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

2303 ià(!
li¡_Ën
)

2304  -
EINVAL
;

2306 
¶i¡
 = 
	`km®loc
(
li¡_Ën
, 
GFP_KERNEL
);

2307 ià(!
¶i¡
)

2308  -
ENOMEM
;

2310 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
¶i¡
, 
li¡_Ën
);

2311 ià(
»s
)

2312 
out
;

2314 
ndesc
 = 
	`be16_to_ıu
(
¶i¡
->
unm­_blk_desc_d©a_Ën
) >> 4;

2315 ià(!
ndesc
 ||‚desc > 256) {

2316 
»s
 = -
EINVAL
;

2317 
out
;

2320 
¿nge
 = 
	`kÿÎoc
(
ndesc
, (*¿nge), 
GFP_KERNEL
);

2321 ià(!
¿nge
) {

2322 
»s
 = -
ENOMEM
;

2323 
out
;

2326 
i
 = 0; i < 
ndesc
; i++) {

2327 
¿nge
[
i
].
Æb
 = 
	`ıu_to_Ë32
(
	`be32_to_ıu
(
¶i¡
->
desc
[i].nlb));

2328 
¿nge
[
i
].
¦ba
 = 
	`ıu_to_Ë64
(
	`be64_to_ıu
(
¶i¡
->
desc
[i].slba));

2329 
¿nge
[
i
].
ÿ‰r
 = 0;

2332 
	`mem£t
(&
c
, 0, (c));

2333 
c
.
dsm
.
İcode
 = 
nvme_cmd_dsm
;

2334 
c
.
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2335 
c
.
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
ndesc
 - 1);

2336 
c
.
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

2338 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
¿nge
,

2339 
ndesc
 * (*
¿nge
));

2340 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2342 
	`kä“
(
¿nge
);

2343 
out
:

2344 
	`kä“
(
¶i¡
);

2345  
»s
;

2346 
	}
}

2348 
	$nvme_scsi_Œª¦©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
)

2350 
u8
 
cmd
[
BLK_MAX_CDB
];

2351 
»tcode
;

2352 
İcode
;

2354 ià(
hdr
->
cmdp
 =ğ
NULL
)

2355  -
EMSGSIZE
;

2356 ià(
	`cİy_äom_u£r
(
cmd
, 
hdr
->
cmdp
, hdr->
cmd_Ën
))

2357  -
EFAULT
;

2363 
»tcode
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2364 ià(
»tcode
)

2365  
»tcode
;

2367 
İcode
 = 
cmd
[0];

2369 
İcode
) {

2370 
READ_6
:

2371 
READ_10
:

2372 
READ_12
:

2373 
READ_16
:

2374 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 0, 
cmd
);

2376 
WRITE_6
:

2377 
WRITE_10
:

2378 
WRITE_12
:

2379 
WRITE_16
:

2380 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 1, 
cmd
);

2382 
INQUIRY
:

2383 
»tcode
 = 
	`nvme_Œªs_šquœy
(
ns
, 
hdr
, 
cmd
);

2385 
LOG_SENSE
:

2386 
»tcode
 = 
	`nvme_Œªs_log_£n£
(
ns
, 
hdr
, 
cmd
);

2388 
MODE_SELECT
:

2389 
MODE_SELECT_10
:

2390 
»tcode
 = 
	`nvme_Œªs_mode_£Ëù
(
ns
, 
hdr
, 
cmd
);

2392 
MODE_SENSE
:

2393 
MODE_SENSE_10
:

2394 
»tcode
 = 
	`nvme_Œªs_mode_£n£
(
ns
, 
hdr
, 
cmd
);

2396 
READ_CAPACITY
:

2397 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 0);

2399 
SERVICE_ACTION_IN_16
:

2400 
cmd
[1]) {

2401 
SAI_READ_CAPACITY_16
:

2402 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 1);

2405 
out
;

2408 
REPORT_LUNS
:

2409 
»tcode
 = 
	`nvme_Œªs_»pÜt_luns
(
ns
, 
hdr
, 
cmd
);

2411 
REQUEST_SENSE
:

2412 
»tcode
 = 
	`nvme_Œªs_»que¡_£n£
(
ns
, 
hdr
, 
cmd
);

2414 
SECURITY_PROTOCOL_IN
:

2415 
SECURITY_PROTOCOL_OUT
:

2416 
»tcode
 = 
	`nvme_Œªs_£cur™y_´ÙocŞ
(
ns
, 
hdr
, 
cmd
);

2418 
SYNCHRONIZE_CACHE
:

2419 
»tcode
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2421 
FORMAT_UNIT
:

2422 
»tcode
 = 
	`nvme_Œªs_fÜm©_un™
(
ns
, 
hdr
, 
cmd
);

2424 
TEST_UNIT_READY
:

2425 
»tcode
 = 
	`nvme_Œªs_‹¡_un™_»ady
(
ns
, 
hdr
, 
cmd
);

2427 
WRITE_BUFFER
:

2428 
»tcode
 = 
	`nvme_Œªs_wr™e_bufãr
(
ns
, 
hdr
, 
cmd
);

2430 
UNMAP
:

2431 
»tcode
 = 
	`nvme_Œªs_unm­
(
ns
, 
hdr
, 
cmd
);

2434 
out
:

2435 
»tcode
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2436 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2437 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2440  
»tcode
;

2441 
	}
}

2443 
	$nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
)

2445 
sg_io_hdr
 
hdr
;

2446 
»tcode
;

2448 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2449  -
EACCES
;

2450 ià(
	`cİy_äom_u£r
(&
hdr
, 
u_hdr
, (hdr)))

2451  -
EFAULT
;

2452 ià(
hdr
.
š‹rçû_id
 != 'S')

2453  -
EINVAL
;

2454 ià(
hdr
.
cmd_Ën
 > 
BLK_MAX_CDB
)

2455  -
EINVAL
;

2461 
»tcode
 = 
	`nvme_scsi_Œª¦©e
(
ns
, &
hdr
);

2462 ià(
»tcode
 < 0)

2463  
»tcode
;

2464 ià(
	`cİy_to_u£r
(
u_hdr
, &
hdr
, (
sg_io_hdr_t
)) > 0)

2465  -
EFAULT
;

2467 
	}
}

2469 
	$nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

)

2471  
	`put_u£r
(
sg_v”siÚ_num
, 

);

2472 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10/nvme-core.c

19 
	~"nvme.h
"

21 
	~<lšux/nvme.h
>

23 
	~<lšux/bio.h
>

24 
	~<lšux/b™İs.h
>

25 
	~<lšux/blkdev.h
>

26 
	~<lšux/d–ay.h
>

27 
	~<lšux/”ºo.h
>

28 
	~<lšux/fs.h
>

29 
	~<lšux/g’hd.h
>

30 
	~<lšux/idr.h
>

31 
	~<lšux/š™.h
>

32 
	~<lšux/š‹¼u±.h
>

33 
	~<lšux/io.h
>

34 
	~<lšux/kdev_t.h
>

35 
	~<lšux/kth»ad.h
>

36 
	~<lšux/k”Ãl.h
>

37 
	~<lšux/mm.h
>

38 
	~<lšux/moduË.h
>

39 
	~<lšux/moduË·¿m.h
>

40 
	~<lšux/pci.h
>

41 
	~<lšux/poisÚ.h
>

42 
	~<lšux/sched.h
>

43 
	~<lšux/¦ab.h
>

44 
	~<lšux/ty³s.h
>

45 
	~<scsi/sg.h
>

46 
	~<asm-g’”ic/io-64-nÚ©omic-lo-hi.h
>

49 
	~<lšux/fe.h
>

50 
	~<lšux/fdbË.h
>

51 
	~<lšux/ev’tfd.h
>

52 
	~<lšux/k»f.h
>

55 
	#NVME_Q_DEPTH
 1024

	)

56 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

57 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

58 
	#NVME_MINORS
 64

	)

59 
	#ADMIN_TIMEOUT
 (60 * 
HZ
)

	)

61 
	gnvme_majÜ
;

62 
moduË_·¿m
(
nvme_majÜ
, , 0);

64 
	gu£_th»aded_š‹¼u±s
;

65 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

67 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

68 
LIST_HEAD
(
dev_li¡
);

69 
sk_¡ruù
 *
	gnvme_th»ad
;

76 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

77 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

78 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

79 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

81 
__u32
 
	gaio_cÚ‹xt_id
;

83 
	#AIOCTX_MAX
 1024

	)

84 
	#AIOCB_MAX
 (1024*64)

	)

86 
__u64
 
	gdebug_com¶‘ed
 =0;

87 
	gdebug_out¡ªdšg
 =0;

89 
	snvme_kaioùx


91 
nvme_aioùx
 
	muùx
;

92 
ev’tfd_ùx
 *
	mev’tùx
;

93 
li¡_h—d
 
	mkaiocb_li¡
;

94 
¥šlock_t
 
	mkaioùx_¥šlock
;

95 
k»f
 
	m»f
;

98 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

99 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

102 
	saio_u£r_ùx
 {

103 
	mÃÁs
;

104 
	mËn
;

105 
·ge
 ** 
	m·ges
;

106 
sÿ‰”li¡
 *
	msg
;

107 
	md©a
[1];

110 
	snvme_kaiocb


112 
li¡_h—d
 
	maiocb_li¡
;

113 
nvme_aiÛv’t
 
	mev’t
;

114 
nvme_com¶‘iÚ
 
	mcqe
;

115 
	mİcode
;

116 
boŞ
 
	mu£_m‘a
;

117 
nvme_iod
 *
	miod
;

118 
sÿ‰”li¡
 
	mm‘a_sg
;

119 *
	mm‘a
;

120 *
	mkv_d©a
;

121 
aio_u£r_ùx
 *
	mu£r_ùx
;

124 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

126 
nvme_kaiocb
 *
tmpcb
;

127 
li¡_h—d
 *
pos
, *
q
;

128 
æags
;

129 ià(
ùx
) {

130 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

131 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

132 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

133 
	`li¡_d–
(
pos
);

134 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

136 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

137 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

138 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

140 
	}
}

142 
	$ş—nup_kaioùx
(
k»f
 *kref) {

143 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

144 
	`»move_kaioùx
(
ùx
);

145 
	}
}

147 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

148 
	`k»f_g‘
(&
ùx
->
»f
);

149 
	}
}

151 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

152 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

153 
	}
}

158 
	$de¡roy_aio_mempoŞ
()

160 
i
 = 0;

161 ià(
g_kaioùx_tb
) {

162 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

163 ià(
g_kaioùx_tb
[
i
]) {

164 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

165 
g_kaioùx_tb
[
i
] = 
NULL
;

168 
	`kä“
(
g_kaioùx_tb
);

169 
g_kaioùx_tb
 = 
NULL
;

171 ià(
kaiocb_mempoŞ
)

172 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

173 ià(
kaioùx_mempoŞ
)

174 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

175 ià(
kaioùx_ÿch•
)

176 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

177 ià(
kaiocb_ÿch•
)

178 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

179 
	}
}

184 
	$aio_£rviû_š™
()

186 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

187 ià(!
g_kaioùx_tb
)

188 
ç
;

189 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

192 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

193 ià(!
kaioùx_ÿch•
)

194 
ç
;

196 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

197 ià(!
kaiocb_ÿch•
)

198 
ç
;

200 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

201 ià(!
kaiocb_mempoŞ
)

202 
ç
;

204 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

205 ià(!
kaioùx_mempoŞ
)

206 
ç
;

210 
aio_cÚ‹xt_id
 = 1;

211 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

212 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

215 
ç
:

216 
	`de¡roy_aio_mempoŞ
();

217  -
ENOMEM
;

218 
	}
}

223 
	$aio_£rviû_ex™
()

225 
	`de¡roy_aio_mempoŞ
();

226 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

228 
	}
}

230 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

231 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

234 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

235 ià(
tmp
è
	`»f_kaioùx
(tmp);

237  
tmp
;

238 
	}
}

244 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

246 
nvme_kaioùx
 *
tmp
;

247 
æags
;

248 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

249 ià(
tmp
) {

250 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

251 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

252 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

254 
	`´štk
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

256 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

257 
	`d”ef_kaioùx
(
tmp
);

261 
	`´štk
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

266 
	}
}

272 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

274 
nvme_kaioùx
 
ùx
;

275 
æags
;

276 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

277  -
EFAULT
;

279 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

280 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

281 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

282 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

284 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

286 
	}
}

292 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

294 
nvme_kaioùx
 *
ùx
;

295 
fd
 
efe
;

296 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

297 
æags
;

298 
»t
 = 0;

299 
i
 = 0;

300 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

301  -
EACCES
;

303 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

304 ià(!
ùx
)

305  -
ENOMEM
;

307 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

308  -
EFAULT
;

310 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

311 ià(!
efe
.
fe
) {

312 
	`´štk
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

313 
»t
 = -
EBADF
;

314 
ex™
;

317 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

318 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

319 
	`´štk
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

320 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

321 
put_efe
;

324 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

325 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

326 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

327 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

328 
aio_cÚ‹xt_id
 = 
i
;

332 ià(
i
 >ğ
AIOCTX_MAX
) {

333 
	`´štk
("nvme_set_aioctx:oo many‡ioctx open.\n");

334 
»t
 = -
EMFILE
;

335 
put_ev’t_fd
;

338 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

339 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

340 
aio_cÚ‹xt_id
 = 0;

341 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

342 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

343 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

344 
	`k»f_š™
(&
ùx
->
»f
);

345 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

346 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

348 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

350 
	`´štk
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

351 
»t
 = -
EINVAL
;

352 
ş—nup
;

354 
ev’tfd_ùx
 = 
NULL
;

355 
debug_out¡ªdšg
 = 0;

356 
debug_com¶‘ed
 = 0;

357 
	`fdput
(
efe
);

359 
ş—nup
:

360 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

361 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

362 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

363 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

364 
put_ev’t_fd
:

365 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

366 
put_efe
:

367 
	`fdput
(
efe
);

368 
ex™
:

369  
»t
;

370 
	}
}

374 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

375 
nvme_kaiocb
 *
»q
;

376 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

377 ià(!
»q
)  0;

379 
	`mem£t
(
»q
, 0, (*req));

381 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

383 
»q
->
ev’t
.
»qid
 =„eqid;

385  
»q
;

386 
	}
}

390 
	$nvme_g‘_aiÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

392 
li¡_h—d
 *
pos
, *
q
;

393 
nvme_kaiocb
 *
tmp
;

394 
nvme_kaioùx
 *
tmp_ùx
;

395 
æags
;

396 
	`LIST_HEAD
(
tmp_h—d
);

397 
__u16
 
couÁ
 =0;

398 
__u16
 
Ä
 = 0;

399 
__u32
 
ùxid
 = 0;

401 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

402  -
EACCES
;

404 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

406 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

408 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

410 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

411 ià(
tmp_ùx
) {

412 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

413 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

414 
	`li¡_d–_š™
(
pos
);

415 
	`li¡_add
(
pos
, &
tmp_h—d
);

416 
couÁ
++;

417 ià(
Ä
 =ğ
couÁ
) ;

419 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

420 
	`d”ef_kaioùx
(
tmp_ùx
);

421 
couÁ
 = 0;

422 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

423 
	`li¡_d–
(
pos
);

424 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

425 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

426 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

427 
couÁ
++;

430 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

433 
	}
}

436 
	$kv_async_com¶‘iÚ
(
nvme_dev
 *
dev
, *
ùx
, 
nvme_com¶‘iÚ
 *
cqe
){

437 
nvme_kaiocb
 *
cmdšfo
 = (nvme_kaiocb *)
ùx
;

438 
cmdšfo
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

439 
cmdšfo
->
ev’t
.
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

441 
	`´štk
("kv_async_completion: call unmap...\n");

443 ià(
cmdšfo
->
kv_d©a
 && cmdšfo->
u£r_ùx
) {

444 ià(
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_™”_»ad_cmd
(cmdinfo->opcode)) {

446 *
d©a
 = 
cmdšfo
->
kv_d©a
;

447 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

448 
d©a
[0], data[1], data[2], data[3],

449 
d©a
[4], data[5], data[6], data[7]);

451 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

452 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

456 ià(
cmdšfo
->
iod
) {

457 
	`nvme_unm­_u£r_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
cmdšfo
->
İcode
), cmdšfo->
iod
);

458 
	`nvme_ä“_iod
(
dev
, 
cmdšfo
->
iod
);

461 ià(
cmdšfo
->
u£r_ùx
) {

462 
i
 = 0;

463 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++)

464 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

465 
	`kä“
(
cmdšfo
->
u£r_ùx
);

467 ià(
cmdšfo
->
kv_d©a
è
	`kä“
(cmdinfo->kv_data);

469 ià(
cmdšfo
->
u£_m‘a
) {

470 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, &
cmdšfo
->
m‘a_sg
, 1, 
DMA_TO_DEVICE
);

471 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

472 ià(
cmdšfo
->
m‘a
) {

473 
	`kä“
(
cmdšfo
->
m‘a
);

477 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

478 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

480 
	}
}

490 
	snvme_queue
 {

491 
deviû
 *
	mq_dmadev
;

492 
nvme_dev
 *
	mdev
;

493 
¥šlock_t
 
	mq_lock
;

494 
nvme_commªd
 *
	msq_cmds
;

495 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

496 
dma_addr_t
 
	msq_dma_addr
;

497 
dma_addr_t
 
	mcq_dma_addr
;

498 
wa™_queue_h—d_t
 
	msq_fuÎ
;

499 
wa™_queue_t
 
	msq_cÚg_wa™
;

500 
bio_li¡
 
	msq_cÚg
;

501 
u32
 
__iomem
 *
	mq_db
;

502 
u16
 
	mq_d•th
;

503 
u16
 
	mcq_veùÜ
;

504 
u16
 
	msq_h—d
;

505 
u16
 
	msq_
;

506 
u16
 
	mcq_h—d
;

507 
u16
 
	mcq_pha£
;

508 
	mcmdid_d©a
[];

514 
šlše
 
	$_nvme_check_size
()

516 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

517 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

518 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

519 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

520 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

521 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

522 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

523 
	`BUILD_BUG_ON
((
nvme_id_ù¾
) != 4096);

524 
	`BUILD_BUG_ON
((
nvme_id_ns
) != 4096);

525 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

526 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

527 
	}
}

529 (*
	tnvme_com¶‘iÚ_â
)(
	tnvme_dev
 *, *,

530 
	tnvme_com¶‘iÚ
 *);

532 
	snvme_cmd_šfo
 {

533 
nvme_com¶‘iÚ_â
 
â
;

534 *
ùx
;

535 
timeout
;

538 
nvme_cmd_šfo
 *
	$nvme_cmd_šfo
(
nvme_queue
 *
nvmeq
)

540  (*)&
nvmeq
->
cmdid_d©a
[
	`BITS_TO_LONGS
Òvmeq->
q_d•th
)];

541 
	}
}

558 
	$®loc_cmdid
(
nvme_queue
 *
nvmeq
, *
ùx
,

559 
nvme_com¶‘iÚ_â
 
hªdËr
, 
timeout
)

561 
d•th
 = 
nvmeq
->
q_d•th
 - 1;

562 
nvme_cmd_šfo
 *
šfo
 = 
	`nvme_cmd_šfo
(
nvmeq
);

563 
cmdid
;

566 
cmdid
 = 
	`fšd_fœ¡_z”o_b™
(
nvmeq
->
cmdid_d©a
, 
d•th
);

567 ià(
cmdid
 >ğ
d•th
)

568  -
EBUSY
;

569 } 
	`‹¡_ªd_£t_b™
(
cmdid
, 
nvmeq
->
cmdid_d©a
));

571 
šfo
[
cmdid
].
â
 = 
hªdËr
;

572 
šfo
[
cmdid
].
ùx
 = ctx;

573 
šfo
[
cmdid
].
timeout
 = 
jiff›s
 +imeout;

574  
cmdid
;

575 
	}
}

577 
	$®loc_cmdid_kÏbË
(
nvme_queue
 *
nvmeq
, *
ùx
,

578 
nvme_com¶‘iÚ_â
 
hªdËr
, 
timeout
)

580 
cmdid
;

581 
	`wa™_ev’t_kÏbË
(
nvmeq
->
sq_fuÎ
,

582 (
cmdid
 = 
	`®loc_cmdid
(
nvmeq
, 
ùx
, 
hªdËr
, 
timeout
)) >= 0);

583  (
cmdid
 < 0è? -
EINTR
 : cmdid;

584 
	}
}

587 
	#CMD_CTX_BASE
 ((*)
POISON_POINTER_DELTA
)

	)

588 
	#CMD_CTX_CANCELLED
 (0x30C + 
CMD_CTX_BASE
)

	)

589 
	#CMD_CTX_COMPLETED
 (0x310 + 
CMD_CTX_BASE
)

	)

590 
	#CMD_CTX_INVALID
 (0x314 + 
CMD_CTX_BASE
)

	)

591 
	#CMD_CTX_FLUSH
 (0x318 + 
CMD_CTX_BASE
)

	)

593 
	$¥ecŸl_com¶‘iÚ
(
nvme_dev
 *
dev
, *
ùx
,

594 
nvme_com¶‘iÚ
 *
cqe
)

596 ià(
ùx
 =ğ
CMD_CTX_CANCELLED
)

598 ià(
ùx
 =ğ
CMD_CTX_FLUSH
)

600 ià(
ùx
 =ğ
CMD_CTX_COMPLETED
) {

601 
	`dev_w¬n
(&
dev
->
pci_dev
->dev,

603 
cqe
->
commªd_id
, 
	`Ë16_to_ıup
(&cqe->
sq_id
));

606 ià(
ùx
 =ğ
CMD_CTX_INVALID
) {

607 
	`dev_w¬n
(&
dev
->
pci_dev
->dev,

609 
cqe
->
commªd_id
, 
	`Ë16_to_ıup
(&cqe->
sq_id
));

613 
	`dev_w¬n
(&
dev
->
pci_dev
->dev, "UnknowÀ¥ecŸÈcom¶‘iÚ %p\n", 
ùx
);

614 
	}
}

619 *
	$ä“_cmdid
(
nvme_queue
 *
nvmeq
, 
cmdid
,

620 
nvme_com¶‘iÚ_â
 *
â
)

622 *
ùx
;

623 
nvme_cmd_šfo
 *
šfo
 = 
	`nvme_cmd_šfo
(
nvmeq
);

625 ià(
cmdid
 >ğ
nvmeq
->
q_d•th
) {

626 *
â
 = 
¥ecŸl_com¶‘iÚ
;

627  
CMD_CTX_INVALID
;

629 ià(
â
)

630 *
â
 = 
šfo
[
cmdid
].fn;

631 
ùx
 = 
šfo
[
cmdid
].ctx;

632 
šfo
[
cmdid
].
â
 = 
¥ecŸl_com¶‘iÚ
;

633 
šfo
[
cmdid
].
ùx
 = 
CMD_CTX_COMPLETED
;

634 
	`ş—r_b™
(
cmdid
, 
nvmeq
->
cmdid_d©a
);

635 
	`wake_up
(&
nvmeq
->
sq_fuÎ
);

636  
ùx
;

637 
	}
}

639 *
	$ÿnûl_cmdid
(
nvme_queue
 *
nvmeq
, 
cmdid
,

640 
nvme_com¶‘iÚ_â
 *
â
)

642 *
ùx
;

643 
nvme_cmd_šfo
 *
šfo
 = 
	`nvme_cmd_šfo
(
nvmeq
);

644 ià(
â
)

645 *
â
 = 
šfo
[
cmdid
].fn;

646 
ùx
 = 
šfo
[
cmdid
].ctx;

647 
šfo
[
cmdid
].
â
 = 
¥ecŸl_com¶‘iÚ
;

648 
šfo
[
cmdid
].
ùx
 = 
CMD_CTX_CANCELLED
;

649  
ùx
;

650 
	}
}

652 
nvme_queue
 *
	$g‘_nvmeq
(
nvme_dev
 *
dev
)

654  
dev
->
queues
[
	`g‘_ıu
() + 1];

655 
	}
}

657 
	$put_nvmeq
(
nvme_queue
 *
nvmeq
)

659 
	`put_ıu
();

660 
	}
}

669 
	$nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
 *
cmd
)

671 
æags
;

672 
u16
 

;

673 
	`¥š_lock_œq§ve
(&
nvmeq
->
q_lock
, 
æags
);

674 

 = 
nvmeq
->
sq_
;

675 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

676 ià(++

 =ğ
nvmeq
->
q_d•th
)

677 

 = 0;

678 
	`wr™–
(

, 
nvmeq
->
q_db
);

679 
nvmeq
->
sq_
 = 

;

680 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

683 
	}
}

685 
__Ë64
 **
	$iod_li¡
(
nvme_iod
 *
iod
)

687  ((*)
iod
è+ iod->
off£t
;

688 
	}
}

695 
	$nvme_Åages
(
size
)

697 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
PAGE_SIZE
, PAGE_SIZE);

698  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

699 
	}
}

701 
nvme_iod
 *

702 
	$nvme_®loc_iod
(
n£g
, 
nby‹s
, 
gå_t
 
gå
)

704 
nvme_iod
 *
iod
 = 
	`km®loc
((nvme_iod) +

705 (
__Ë64
 *è* 
	`nvme_Åages
(
nby‹s
) +

706 (
sÿ‰”li¡
è* 
n£g
, 
gå
);

708 ià(
iod
) {

709 
iod
->
off£t
 = 
	`off£tof
(
nvme_iod
, 
sg
[
n£g
]);

710 
iod
->
Åages
 = -1;

711 
iod
->
Ëngth
 = 
nby‹s
;

712 
iod
->
ÃÁs
 = 0;

715  
iod
;

716 
	}
}

718 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
nvme_iod
 *
iod
)

720 cÚ¡ 
Ï¡_´p
 = 
PAGE_SIZE
 / 8 - 1;

721 
i
;

722 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
iod
);

723 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

725 ià(
iod
->
Åages
 == 0)

726 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

727 
i
 = 0; i < 
iod
->
Åages
; i++) {

728 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

729 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

730 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

731 
´p_dma
 = 
Ãxt_´p_dma
;

733 
	`kä“
(
iod
);

734 
	}
}

736 
	$bio_com¶‘iÚ
(
nvme_dev
 *
dev
, *
ùx
,

737 
nvme_com¶‘iÚ
 *
cqe
)

739 
nvme_iod
 *
iod
 = 
ùx
;

740 
bio
 *biØğ
iod
->
´iv©e
;

741 
u16
 
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

743 ià(
iod
->
ÃÁs
)

744 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, 
iod
->
sg
, iod->
ÃÁs
,

745 
	`bio_d©a_dœ
(
bio
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

746 
	`nvme_ä“_iod
(
dev
, 
iod
);

747 ià(
¡©us
)

748 
	`bio_’dio
(
bio
, -
EIO
);

750 
	`bio_’dio
(
bio
, 0);

751 
	}
}

754 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
nvme_commÚ_commªd
 *
cmd
,

755 
nvme_iod
 *
iod
, 
tÙ®_Ën
, 
gå_t
 
gå
)

757 
dma_poŞ
 *
poŞ
;

758 
Ëngth
 = 
tÙ®_Ën
;

759 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

760 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

761 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

762 
off£t
 = 
	`off£t_š_·ge
(
dma_addr
);

763 
__Ë64
 *
´p_li¡
;

764 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
iod
);

765 
dma_addr_t
 
´p_dma
;

766 
Å½s
, 
i
;

768 
cmd
->
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

769 
Ëngth
 -ğ(
PAGE_SIZE
 - 
off£t
);

770 ià(
Ëngth
 <= 0)

771  
tÙ®_Ën
;

773 
dma_Ën
 -ğ(
PAGE_SIZE
 - 
off£t
);

774 ià(
dma_Ën
) {

775 
dma_addr
 +ğ(
PAGE_SIZE
 - 
off£t
);

777 
sg
 = 
	`sg_Ãxt
(sg);

778 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

779 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

782 ià(
Ëngth
 <ğ
PAGE_SIZE
) {

783 
cmd
->
´p2
 = 
	`ıu_to_Ë64
(
dma_addr
);

784  
tÙ®_Ën
;

787 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
PAGE_SIZE
);

788 ià(
Å½s
 <= (256 / 8)) {

789 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

790 
iod
->
Åages
 = 0;

792 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

793 
iod
->
Åages
 = 1;

796 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
gå
, &
´p_dma
);

797 ià(!
´p_li¡
) {

798 
cmd
->
´p2
 = 
	`ıu_to_Ë64
(
dma_addr
);

799 
iod
->
Åages
 = -1;

800  (
tÙ®_Ën
 - 
Ëngth
è+ 
PAGE_SIZE
;

802 
li¡
[0] = 
´p_li¡
;

803 
iod
->
fœ¡_dma
 = 
´p_dma
;

804 
cmd
->
´p2
 = 
	`ıu_to_Ë64
(
´p_dma
);

805 
i
 = 0;

807 ià(
i
 =ğ
PAGE_SIZE
 / 8) {

808 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

809 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
gå
, &
´p_dma
);

810 ià(!
´p_li¡
)

811  
tÙ®_Ën
 - 
Ëngth
;

812 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

813 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

814 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

815 
i
 = 1;

817 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

818 
dma_Ën
 -ğ
PAGE_SIZE
;

819 
dma_addr
 +ğ
PAGE_SIZE
;

820 
Ëngth
 -ğ
PAGE_SIZE
;

821 ià(
Ëngth
 <= 0)

823 ià(
dma_Ën
 > 0)

825 
	`BUG_ON
(
dma_Ën
 < 0);

826 
sg
 = 
	`sg_Ãxt
(sg);

827 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

828 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

831  
tÙ®_Ën
;

832 
	}
}

834 
	snvme_bio_·œ
 {

835 
bio
 
	mb1
, 
	mb2
, *
	m·»Á
;

836 
bio_vec
 *
	mbv1
, *
	mbv2
;

837 
	m”r
;

838 
©omic_t
 
	mút
;

841 
	$nvme_bio_·œ_’dio
(
bio
 *bio, 
”r
)

843 
nvme_bio_·œ
 *
bp
 = 
bio
->
bi_´iv©e
;

845 ià(
”r
)

846 
bp
->
”r
 =ƒrr;

848 ià(
	`©omic_dec_ªd_‹¡
(&
bp
->
út
)) {

849 
	`bio_’dio
(
bp
->
·»Á
, bp->
”r
);

850 ià(
bp
->
bv1
)

851 
	`kä“
(
bp
->
bv1
);

852 ià(
bp
->
bv2
)

853 
	`kä“
(
bp
->
bv2
);

854 
	`kä“
(
bp
);

856 
	}
}

858 
nvme_bio_·œ
 *
	$nvme_bio_¥l™
(
bio
 *bio, 
idx
,

859 
Ën
, 
off£t
)

861 
nvme_bio_·œ
 *
bp
;

863 
	`BUG_ON
(
Ën
 > 
bio
->
bi_size
);

864 
	`BUG_ON
(
idx
 > 
bio
->
bi_vút
);

866 
bp
 = 
	`km®loc
((*bp), 
GFP_ATOMIC
);

867 ià(!
bp
)

868  
NULL
;

869 
bp
->
”r
 = 0;

871 
bp
->
b1
 = *
bio
;

872 
bp
->
b2
 = *
bio
;

874 
bp
->
b1
.
bi_size
 = 
Ën
;

875 
bp
->
b2
.
bi_size
 -ğ
Ën
;

876 
bp
->
b1
.
bi_vút
 = 
idx
;

877 
bp
->
b2
.
bi_idx
 = 
idx
;

878 
bp
->
b2
.
bi_£ùÜ
 +ğ
Ën
 >> 9;

880 ià(
off£t
) {

881 
bp
->
bv1
 = 
	`km®loc
(
bio
->
bi_max_vecs
 * (
bio_vec
),

882 
GFP_ATOMIC
);

883 ià(!
bp
->
bv1
)

884 
¥l™_ç_1
;

886 
bp
->
bv2
 = 
	`km®loc
(
bio
->
bi_max_vecs
 * (
bio_vec
),

887 
GFP_ATOMIC
);

888 ià(!
bp
->
bv2
)

889 
¥l™_ç_2
;

891 
	`memıy
(
bp
->
bv1
, 
bio
->
bi_io_vec
,

892 
bio
->
bi_max_vecs
 * (
bio_vec
));

893 
	`memıy
(
bp
->
bv2
, 
bio
->
bi_io_vec
,

894 
bio
->
bi_max_vecs
 * (
bio_vec
));

896 
bp
->
b1
.
bi_io_vec
 = bp->
bv1
;

897 
bp
->
b2
.
bi_io_vec
 = bp->
bv2
;

898 
bp
->
b2
.
bi_io_vec
[
idx
].
bv_off£t
 +ğ
off£t
;

899 
bp
->
b2
.
bi_io_vec
[
idx
].
bv_Ën
 -ğ
off£t
;

900 
bp
->
b1
.
bi_io_vec
[
idx
].
bv_Ën
 = 
off£t
;

901 
bp
->
b1
.
bi_vút
++;

903 
bp
->
bv1
 = bp->
bv2
 = 
NULL
;

905 
bp
->
b1
.
bi_´iv©e
 = bp;

906 
bp
->
b2
.
bi_´iv©e
 = bp;

908 
bp
->
b1
.
bi_’d_io
 = 
nvme_bio_·œ_’dio
;

909 
bp
->
b2
.
bi_’d_io
 = 
nvme_bio_·œ_’dio
;

911 
bp
->
·»Á
 = 
bio
;

912 
	`©omic_£t
(&
bp
->
út
, 2);

914  
bp
;

916 
¥l™_ç_2
:

917 
	`kä“
(
bp
->
bv1
);

918 
¥l™_ç_1
:

919 
	`kä“
(
bp
);

920  
NULL
;

921 
	}
}

923 
	$nvme_¥l™_ªd_subm™
(
bio
 *bio, 
nvme_queue
 *
nvmeq
,

924 
idx
, 
Ën
, 
off£t
)

926 
nvme_bio_·œ
 *
bp
 = 
	`nvme_bio_¥l™
(
bio
, 
idx
, 
Ën
, 
off£t
);

927 ià(!
bp
)

928  -
ENOMEM
;

930 ià(
	`bio_li¡_em±y
(&
nvmeq
->
sq_cÚg
))

931 
	`add_wa™_queue
(&
nvmeq
->
sq_fuÎ
, &nvmeq->
sq_cÚg_wa™
);

932 
	`bio_li¡_add
(&
nvmeq
->
sq_cÚg
, &
bp
->
b1
);

933 
	`bio_li¡_add
(&
nvmeq
->
sq_cÚg
, &
bp
->
b2
);

936 
	}
}

939 
	#BIOVEC_NOT_VIRT_MERGEABLE
(
vec1
, 
vec2
è((vec2)->
bv_off£t
 || \

940 (((
vec1
)->
bv_off£t
 + (vec1)->
bv_Ën
è% 
PAGE_SIZE
))

	)

942 
	$nvme_m­_bio
(
nvme_queue
 *
nvmeq
, 
nvme_iod
 *
iod
,

943 
bio
 *bio, 
dma_d©a_dœeùiÚ
 
dma_dœ
, 
p£gs
)

945 
bio_vec
 *
bvec
, *
bv´v
 = 
NULL
;

946 
sÿ‰”li¡
 *
sg
 = 
NULL
;

947 
i
, 
Ëngth
 = 0, 
n£gs
 = 0, 
¥l™_Ën
 = 
bio
->
bi_size
;

949 ià(
nvmeq
->
dev
->
¡re_size
)

950 
¥l™_Ën
 = 
nvmeq
->
dev
->
¡re_size
 -

951 ((
bio
->
bi_£ùÜ
 << 9è& (
nvmeq
->
dev
->
¡re_size
 - 1));

953 
	`sg_š™_bË
(
iod
->
sg
, 
p£gs
);

954 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
i
) {

955 ià(
bv´v
 && 
	`BIOVEC_PHYS_MERGEABLE
(bv´v, 
bvec
)) {

956 
sg
->
Ëngth
 +ğ
bvec
->
bv_Ën
;

958 ià(
bv´v
 && 
	`BIOVEC_NOT_VIRT_MERGEABLE
(bv´v, 
bvec
))

959  
	`nvme_¥l™_ªd_subm™
(
bio
, 
nvmeq
, 
i
,

960 
Ëngth
, 0);

962 
sg
 = sg ? sg + 1 : 
iod
->sg;

963 
	`sg_£t_·ge
(
sg
, 
bvec
->
bv_·ge
, bvec->
bv_Ën
,

964 
bvec
->
bv_off£t
);

965 
n£gs
++;

968 ià(
¥l™_Ën
 - 
Ëngth
 < 
bvec
->
bv_Ën
)

969  
	`nvme_¥l™_ªd_subm™
(
bio
, 
nvmeq
, 
i
, 
¥l™_Ën
,

970 
¥l™_Ën
 - 
Ëngth
);

971 
Ëngth
 +ğ
bvec
->
bv_Ën
;

972 
bv´v
 = 
bvec
;

974 
iod
->
ÃÁs
 = 
n£gs
;

975 
	`sg_m¬k_’d
(
sg
);

976 ià(
	`dma_m­_sg
(
nvmeq
->
q_dmadev
, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
) == 0)

977  -
ENOMEM
;

979 
	`BUG_ON
(
Ëngth
 !ğ
bio
->
bi_size
);

980  
Ëngth
;

981 
	}
}

988 
	$nvme_subm™_disÿrd
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

989 
bio
 *bio, 
nvme_iod
 *
iod
, 
cmdid
)

991 
nvme_dsm_¿nge
 *
¿nge
;

992 
nvme_commªd
 *
cmnd
 = &
nvmeq
->
sq_cmds
[nvmeq->
sq_
];

994 
¿nge
 = 
	`dma_poŞ_®loc
(
nvmeq
->
dev
->
´p_sm®l_poŞ
, 
GFP_ATOMIC
,

995 &
iod
->
fœ¡_dma
);

996 ià(!
¿nge
)

997  -
ENOMEM
;

999 
	`iod_li¡
(
iod
)[0] = (
__Ë64
 *)
¿nge
;

1000 
iod
->
Åages
 = 0;

1002 
¿nge
->
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

1003 
¿nge
->
Æb
 = 
	`ıu_to_Ë32
(
bio
->
bi_size
 >> 
ns
->
lba_shiá
);

1004 
¿nge
->
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
bio
->
bi_£ùÜ
));

1006 
	`mem£t
(
cmnd
, 0, (*cmnd));

1007 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

1008 
cmnd
->
dsm
.
commªd_id
 = 
cmdid
;

1009 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1010 
cmnd
->
dsm
.
´p1
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

1011 
cmnd
->
dsm
.
Ä
 = 0;

1012 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

1014 ià(++
nvmeq
->
sq_
 =ğnvmeq->
q_d•th
)

1015 
nvmeq
->
sq_
 = 0;

1016 
	`wr™–
(
nvmeq
->
sq_
,‚vmeq->
q_db
);

1019 
	}
}

1021 
	$nvme_subm™_æush
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

1022 
cmdid
)

1024 
nvme_commªd
 *
cmnd
 = &
nvmeq
->
sq_cmds
[nvmeq->
sq_
];

1026 
	`mem£t
(
cmnd
, 0, (*cmnd));

1027 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1028 
cmnd
->
commÚ
.
commªd_id
 = 
cmdid
;

1029 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1031 ià(++
nvmeq
->
sq_
 =ğnvmeq->
q_d•th
)

1032 
nvmeq
->
sq_
 = 0;

1033 
	`wr™–
(
nvmeq
->
sq_
,‚vmeq->
q_db
);

1036 
	}
}

1038 
	$nvme_subm™_æush_d©a
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
)

1040 
cmdid
 = 
	`®loc_cmdid
(
nvmeq
, (*)
CMD_CTX_FLUSH
,

1041 
¥ecŸl_com¶‘iÚ
, 
NVME_IO_TIMEOUT
);

1042 ià(
	`uÆik–y
(
cmdid
 < 0))

1043  
cmdid
;

1045  
	`nvme_subm™_æush
(
nvmeq
, 
ns
, 
cmdid
);

1046 
	}
}

1051 
	$nvme_subm™_bio_queue
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

1052 
bio
 *bio)

1054 
nvme_commªd
 *
cmnd
;

1055 
nvme_iod
 *
iod
;

1056 
dma_d©a_dœeùiÚ
 
dma_dœ
;

1057 
cmdid
, 
Ëngth
, 
»suÉ
;

1058 
u16
 
cÚŒŞ
;

1059 
u32
 
dsmgmt
;

1060 
p£gs
 = 
	`bio_phys_£gm’ts
(
ns
->
queue
, 
bio
);

1062 ià((
bio
->
bi_rw
 & 
REQ_FLUSH
è&& 
p£gs
) {

1063 
»suÉ
 = 
	`nvme_subm™_æush_d©a
(
nvmeq
, 
ns
);

1064 ià(
»suÉ
)

1065  
»suÉ
;

1068 
»suÉ
 = -
ENOMEM
;

1069 
iod
 = 
	`nvme_®loc_iod
(
p£gs
, 
bio
->
bi_size
, 
GFP_ATOMIC
);

1070 ià(!
iod
)

1071 
nomem
;

1072 
iod
->
´iv©e
 = 
bio
;

1074 
»suÉ
 = -
EBUSY
;

1075 
cmdid
 = 
	`®loc_cmdid
(
nvmeq
, 
iod
, 
bio_com¶‘iÚ
, 
NVME_IO_TIMEOUT
);

1076 ià(
	`uÆik–y
(
cmdid
 < 0))

1077 
ä“_iod
;

1079 ià(
bio
->
bi_rw
 & 
REQ_DISCARD
) {

1080 
»suÉ
 = 
	`nvme_subm™_disÿrd
(
nvmeq
, 
ns
, 
bio
, 
iod
, 
cmdid
);

1081 ià(
»suÉ
)

1082 
ä“_cmdid
;

1083  
»suÉ
;

1085 ià((
bio
->
bi_rw
 & 
REQ_FLUSH
è&& !
p£gs
)

1086  
	`nvme_subm™_æush
(
nvmeq
, 
ns
, 
cmdid
);

1088 
cÚŒŞ
 = 0;

1089 ià(
bio
->
bi_rw
 & 
REQ_FUA
)

1090 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1091 ià(
bio
->
bi_rw
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

1092 
cÚŒŞ
 |ğ
NVME_RW_LR
;

1094 
dsmgmt
 = 0;

1095 ià(
bio
->
bi_rw
 & 
REQ_RAHEAD
)

1096 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

1098 
cmnd
 = &
nvmeq
->
sq_cmds
[nvmeq->
sq_
];

1100 
	`mem£t
(
cmnd
, 0, (*cmnd));

1101 ià(
	`bio_d©a_dœ
(
bio
)) {

1102 
cmnd
->
rw
.
İcode
 = 
nvme_cmd_wr™e
;

1103 
dma_dœ
 = 
DMA_TO_DEVICE
;

1105 
cmnd
->
rw
.
İcode
 = 
nvme_cmd_»ad
;

1106 
dma_dœ
 = 
DMA_FROM_DEVICE
;

1109 
»suÉ
 = 
	`nvme_m­_bio
(
nvmeq
, 
iod
, 
bio
, 
dma_dœ
, 
p£gs
);

1110 ià(
»suÉ
 <= 0)

1111 
ä“_cmdid
;

1112 
Ëngth
 = 
»suÉ
;

1114 
cmnd
->
rw
.
commªd_id
 = 
cmdid
;

1115 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1116 
Ëngth
 = 
	`nvme_£tup_´ps
(
nvmeq
->
dev
, &
cmnd
->
commÚ
, 
iod
,†ength,

1117 
GFP_ATOMIC
);

1118 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
bio
->
bi_£ùÜ
));

1119 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(Ö’gth >> 
ns
->
lba_shiá
) - 1);

1120 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1121 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

1123 ià(++
nvmeq
->
sq_
 =ğnvmeq->
q_d•th
)

1124 
nvmeq
->
sq_
 = 0;

1125 
	`wr™–
(
nvmeq
->
sq_
,‚vmeq->
q_db
);

1129 
ä“_cmdid
:

1130 
	`ä“_cmdid
(
nvmeq
, 
cmdid
, 
NULL
);

1131 
ä“_iod
:

1132 
	`nvme_ä“_iod
(
nvmeq
->
dev
, 
iod
);

1133 
nomem
:

1134  
»suÉ
;

1135 
	}
}

1137 
	$nvme_make_»que¡
(
»que¡_queue
 *
q
, 
bio
 *bio)

1139 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1140 
nvme_queue
 *
nvmeq
 = 
	`g‘_nvmeq
(
ns
->
dev
);

1141 
»suÉ
 = -
EBUSY
;

1143 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1144 ià(
	`bio_li¡_em±y
(&
nvmeq
->
sq_cÚg
))

1145 
»suÉ
 = 
	`nvme_subm™_bio_queue
(
nvmeq
, 
ns
, 
bio
);

1146 ià(
	`uÆik–y
(
»suÉ
)) {

1147 ià(
	`bio_li¡_em±y
(&
nvmeq
->
sq_cÚg
))

1148 
	`add_wa™_queue
(&
nvmeq
->
sq_fuÎ
, &nvmeq->
sq_cÚg_wa™
);

1149 
	`bio_li¡_add
(&
nvmeq
->
sq_cÚg
, 
bio
);

1152 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1153 
	`put_nvmeq
(
nvmeq
);

1154 
	}
}

1156 
œq»tuº_t
 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

1158 
u16
 
h—d
, 
pha£
;

1160 
h—d
 = 
nvmeq
->
cq_h—d
;

1161 
pha£
 = 
nvmeq
->
cq_pha£
;

1164 *
ùx
;

1165 
nvme_com¶‘iÚ_â
 
â
;

1166 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[
h—d
];

1167 ià((
	`Ë16_to_ıu
(
cqe
.
¡©us
è& 1è!ğ
pha£
)

1169 
nvmeq
->
sq_h—d
 = 
	`Ë16_to_ıu
(
cqe
.sq_head);

1170 ià(++
h—d
 =ğ
nvmeq
->
q_d•th
) {

1171 
h—d
 = 0;

1172 
pha£
 = !phase;

1175 
ùx
 = 
	`ä“_cmdid
(
nvmeq
, 
cqe
.
commªd_id
, &
â
);

1176 
	`â
(
nvmeq
->
dev
, 
ùx
, &
cqe
);

1185 ià(
h—d
 =ğ
nvmeq
->
cq_h—d
 && 
pha£
 =ğnvmeq->
cq_pha£
)

1186  
IRQ_NONE
;

1188 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 + (1 <<‚vmeq->
dev
->
db_¡ride
));

1189 
nvmeq
->
cq_h—d
 = 
h—d
;

1190 
nvmeq
->
cq_pha£
 = 
pha£
;

1192  
IRQ_HANDLED
;

1193 
	}
}

1195 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1197 
œq»tuº_t
 
»suÉ
;

1198 
nvme_queue
 *
nvmeq
 = 
d©a
;

1199 
	`¥š_lock
(&
nvmeq
->
q_lock
);

1200 
»suÉ
 = 
	`nvme_´oûss_cq
(
nvmeq
);

1201 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

1202  
»suÉ
;

1203 
	}
}

1205 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1207 
nvme_queue
 *
nvmeq
 = 
d©a
;

1208 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[nvmeq->
cq_h—d
];

1209 ià((
	`Ë16_to_ıu
(
cqe
.
¡©us
è& 1è!ğ
nvmeq
->
cq_pha£
)

1210  
IRQ_NONE
;

1211  
IRQ_WAKE_THREAD
;

1212 
	}
}

1214 
	$nvme_abÜt_commªd
(
nvme_queue
 *
nvmeq
, 
cmdid
)

1216 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1217 
	`ÿnûl_cmdid
(
nvmeq
, 
cmdid
, 
NULL
);

1218 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1219 
	}
}

1221 
	ssync_cmd_šfo
 {

1222 
sk_¡ruù
 *
	msk
;

1223 
u32
 
	m»suÉ
;

1224 
	m¡©us
;

1227 
	$sync_com¶‘iÚ
(
nvme_dev
 *
dev
, *
ùx
,

1228 
nvme_com¶‘iÚ
 *
cqe
)

1230 
sync_cmd_šfo
 *
cmdšfo
 = 
ùx
;

1231 
cmdšfo
->
»suÉ
 = 
	`Ë32_to_ıup
(&
cqe
->result);

1232 
cmdšfo
->
¡©us
 = 
	`Ë16_to_ıup
(&
cqe
->status) >> 1;

1233 
	`wake_up_´oûss
(
cmdšfo
->
sk
);

1234 
	}
}

1240 
	$nvme_subm™_sync_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
 *
cmd
,

1241 
u32
 *
»suÉ
, 
timeout
)

1243 
cmdid
;

1244 
sync_cmd_šfo
 
cmdšfo
;

1246 
cmdšfo
.
sk
 = 
cu¼’t
;

1247 
cmdšfo
.
¡©us
 = -
EINTR
;

1249 
cmdid
 = 
	`®loc_cmdid_kÏbË
(
nvmeq
, &
cmdšfo
, 
sync_com¶‘iÚ
,

1250 
timeout
);

1251 ià(
cmdid
 < 0)

1252  
cmdid
;

1253 
cmd
->
commÚ
.
commªd_id
 = 
cmdid
;

1255 
	`£t_cu¼’t_¡©e
(
TASK_KILLABLE
);

1256 
	`nvme_subm™_cmd
(
nvmeq
, 
cmd
);

1257 
	`scheduË_timeout
(
timeout
);

1259 ià(
cmdšfo
.
¡©us
 =ğ-
EINTR
) {

1260 
	`nvme_abÜt_commªd
(
nvmeq
, 
cmdid
);

1261  -
EINTR
;

1264 ià(
»suÉ
)

1265 *
»suÉ
 = 
cmdšfo
.result;

1267  
cmdšfo
.
¡©us
;

1268 
	}
}

1270 
	$nvme_subm™_admš_cmd
(
nvme_dev
 *
dev
, 
nvme_commªd
 *
cmd
,

1271 
u32
 *
»suÉ
)

1273  
	`nvme_subm™_sync_cmd
(
dev
->
queues
[0], 
cmd
, 
»suÉ
, 
ADMIN_TIMEOUT
);

1274 
	}
}

1276 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1278 
¡©us
;

1279 
nvme_commªd
 
c
;

1281 
	`mem£t
(&
c
, 0, (c));

1282 
c
.
d–‘e_queue
.
İcode
 = opcode;

1283 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1285 
¡©us
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1286 ià(
¡©us
)

1287  -
EIO
;

1289 
	}
}

1291 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1292 
nvme_queue
 *
nvmeq
)

1294 
¡©us
;

1295 
nvme_commªd
 
c
;

1296 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1298 
	`mem£t
(&
c
, 0, (c));

1299 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1300 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1301 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1302 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1303 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1304 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1306 
¡©us
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1307 ià(
¡©us
)

1308  -
EIO
;

1310 
	}
}

1312 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1313 
nvme_queue
 *
nvmeq
)

1315 
¡©us
;

1316 
nvme_commªd
 
c
;

1317 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_SQ_PRIO_MEDIUM
;

1319 
	`mem£t
(&
c
, 0, (c));

1320 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1321 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1322 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1323 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1324 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1325 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1327 
¡©us
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1328 ià(
¡©us
)

1329  -
EIO
;

1331 
	}
}

1333 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1335  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1336 
	}
}

1338 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1340  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1341 
	}
}

1343 
	$nvme_id’tify
(
nvme_dev
 *
dev
, 
nsid
, 
ús
,

1344 
dma_addr_t
 
dma_addr
)

1346 
nvme_commªd
 
c
;

1348 
	`mem£t
(&
c
, 0, (c));

1349 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1350 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1351 
c
.
id’tify
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1352 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(cns);

1354  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1355 
	}
}

1357 
	$nvme_g‘_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
nsid
,

1358 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
)

1360 
nvme_commªd
 
c
;

1362 
	`mem£t
(&
c
, 0, (c));

1363 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_g‘_ã©u»s
;

1364 
c
.
ã©u»s
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1365 
c
.
ã©u»s
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1366 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1368  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
»suÉ
);

1369 
	}
}

1371 
	$nvme_£t_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
dwÜd11
,

1372 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
)

1374 
nvme_commªd
 
c
;

1376 
	`mem£t
(&
c
, 0, (c));

1377 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1378 
c
.
ã©u»s
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1379 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1380 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1382  
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
»suÉ
);

1383 
	}
}

1390 
	$nvme_ÿnûl_ios
(
nvme_queue
 *
nvmeq
, 
boŞ
 
timeout
)

1392 
d•th
 = 
nvmeq
->
q_d•th
 - 1;

1393 
nvme_cmd_šfo
 *
šfo
 = 
	`nvme_cmd_šfo
(
nvmeq
);

1394 
now
 = 
jiff›s
;

1395 
cmdid
;

1397 
	`fÜ_—ch_£t_b™
(
cmdid
, 
nvmeq
->
cmdid_d©a
, 
d•th
) {

1398 *
ùx
;

1399 
nvme_com¶‘iÚ_â
 
â
;

1400 
nvme_com¶‘iÚ
 
cqe
 = {

1401 .
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_ABORT_REQ
 << 1),

1404 ià(
timeout
 && !
	`time_aá”
(
now
, 
šfo
[
cmdid
].timeout))

1406 ià(
šfo
[
cmdid
].
ùx
 =ğ
CMD_CTX_CANCELLED
)

1408 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "CªûÎšg I/O %d\n", 
cmdid
);

1409 
ùx
 = 
	`ÿnûl_cmdid
(
nvmeq
, 
cmdid
, &
â
);

1410 
	`â
(
nvmeq
->
dev
, 
ùx
, &
cqe
);

1412 
	}
}

1414 
	$nvme_ä“_queue_mem
(
nvme_queue
 *
nvmeq
)

1416 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1417 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1418 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1419 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1420 
	`kä“
(
nvmeq
);

1421 
	}
}

1423 
	$nvme_ä“_queue
(
nvme_dev
 *
dev
, 
qid
)

1425 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
qid
];

1426 
veùÜ
 = 
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].vector;

1428 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1429 
	`nvme_ÿnûl_ios
(
nvmeq
, 
çl£
);

1430 
	`bio_li¡_³ek
(&
nvmeq
->
sq_cÚg
)) {

1431 
bio
 *biØğ
	`bio_li¡_pİ
(&
nvmeq
->
sq_cÚg
);

1432 
	`bio_’dio
(
bio
, -
EIO
);

1434 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1436 
	`œq_£t_affš™y_hšt
(
veùÜ
, 
NULL
);

1437 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1440 ià(
qid
) {

1441 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1442 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1445 
	`nvme_ä“_queue_mem
(
nvmeq
);

1446 
	}
}

1448 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1449 
d•th
, 
veùÜ
)

1451 
deviû
 *
dmadev
 = &
dev
->
pci_dev
->dev;

1452 
exŒa
 = 
	`DIV_ROUND_UP
(
d•th
, 8) + (depth *

1453 (
nvme_cmd_šfo
));

1454 
nvme_queue
 *
nvmeq
 = 
	`kz®loc
((*nvmeqè+ 
exŒa
, 
GFP_KERNEL
);

1455 ià(!
nvmeq
)

1456  
NULL
;

1458 
nvmeq
->
cqes
 = 
	`dma_®loc_coh”’t
(
dmadev
, 
	`CQ_SIZE
(
d•th
),

1459 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1460 ià(!
nvmeq
->
cqes
)

1461 
ä“_nvmeq
;

1462 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
(
d•th
));

1464 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dmadev
, 
	`SQ_SIZE
(
d•th
),

1465 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1466 ià(!
nvmeq
->
sq_cmds
)

1467 
ä“_cqdma
;

1469 
nvmeq
->
q_dmadev
 = 
dmadev
;

1470 
nvmeq
->
dev
 = dev;

1471 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1472 
nvmeq
->
cq_h—d
 = 0;

1473 
nvmeq
->
cq_pha£
 = 1;

1474 
	`š™_wa™queue_h—d
(&
nvmeq
->
sq_fuÎ
);

1475 
	`š™_wa™queue_’Œy
(&
nvmeq
->
sq_cÚg_wa™
, 
nvme_th»ad
);

1476 
	`bio_li¡_š™
(&
nvmeq
->
sq_cÚg
);

1477 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 << (dev->
db_¡ride
 + 1)];

1478 
nvmeq
->
q_d•th
 = 
d•th
;

1479 
nvmeq
->
cq_veùÜ
 = 
veùÜ
;

1481  
nvmeq
;

1483 
ä“_cqdma
:

1484 
	`dma_ä“_coh”’t
(
dmadev
, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1485 
nvmeq
->
cq_dma_addr
);

1486 
ä“_nvmeq
:

1487 
	`kä“
(
nvmeq
);

1488  
NULL
;

1489 
	}
}

1491 
	$queue_»que¡_œq
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1492 cÚ¡ *
Çme
)

1494 ià(
u£_th»aded_š‹¼u±s
)

1495  
	`»que¡_th»aded_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1496 
nvme_œq_check
, 
nvme_œq
,

1497 
IRQF_DISABLED
 | 
IRQF_SHARED
,

1498 
Çme
, 
nvmeq
);

1499  
	`»que¡_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
, 
nvme_œq
,

1500 
IRQF_DISABLED
 | 
IRQF_SHARED
, 
Çme
, 
nvmeq
);

1501 
	}
}

1503 
nvme_queue
 *
	$nvme_ü—‹_queue
(
nvme_dev
 *
dev
, 
qid
,

1504 
cq_size
, 
veùÜ
)

1506 
»suÉ
;

1507 
nvme_queue
 *
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 
qid
, 
cq_size
, 
veùÜ
);

1509 ià(!
nvmeq
)

1510  
	`ERR_PTR
(-
ENOMEM
);

1512 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1513 ià(
»suÉ
 < 0)

1514 
ä“_nvmeq
;

1516 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1517 ià(
»suÉ
 < 0)

1518 
»Ëa£_cq
;

1520 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
, "nvme");

1521 ià(
»suÉ
 < 0)

1522 
»Ëa£_sq
;

1524  
nvmeq
;

1526 
»Ëa£_sq
:

1527 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1528 
»Ëa£_cq
:

1529 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1530 
ä“_nvmeq
:

1531 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1532 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1533 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1534 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1535 
	`kä“
(
nvmeq
);

1536  
	`ERR_PTR
(
»suÉ
);

1537 
	}
}

1539 
	$nvme_wa™_»ady
(
nvme_dev
 *
dev
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

1541 
timeout
;

1542 
u32
 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

1544 
timeout
 = ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

1546 (
	`»adl
(&
dev
->
b¬
->
c¡s
è& 
NVME_CSTS_RDY
è!ğ
b™
) {

1547 
	`m¦“p
(100);

1548 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1549  -
EINTR
;

1550 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1551 
	`dev_”r
(&
dev
->
pci_dev
->dev,

1553  -
ENODEV
;

1558 
	}
}

1566 
	$nvme_di§bË_ù¾
(
nvme_dev
 *
dev
, 
u64
 
ÿp
)

1568 
u32
 
cc
 = 
	`»adl
(&
dev
->
b¬
->cc);

1570 ià(
cc
 & 
NVME_CC_ENABLE
)

1571 
	`wr™–
(
cc
 & ~
NVME_CC_ENABLE
, &
dev
->
b¬
->cc);

1572  
	`nvme_wa™_»ady
(
dev
, 
ÿp
, 
çl£
);

1573 
	}
}

1575 
	$nvme_’abË_ù¾
(
nvme_dev
 *
dev
, 
u64
 
ÿp
)

1577  
	`nvme_wa™_»ady
(
dev
, 
ÿp
, 
Œue
);

1578 
	}
}

1580 
	$nvme_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1582 
»suÉ
;

1583 
u32
 
aqa
;

1584 
u64
 
ÿp
 = 
	`»adq
(&
dev
->
b¬
->cap);

1585 
nvme_queue
 *
nvmeq
;

1587 
dev
->
dbs
 = ((
__iomem
 *)dev->
b¬
) + 4096;

1588 
dev
->
db_¡ride
 = 
	`NVME_CAP_STRIDE
(
ÿp
);

1590 
»suÉ
 = 
	`nvme_di§bË_ù¾
(
dev
, 
ÿp
);

1591 ià(
»suÉ
 < 0)

1592  
»suÉ
;

1594 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 64, 0);

1595 ià(!
nvmeq
)

1596  -
ENOMEM
;

1598 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1599 
aqa
 |=‡qa << 16;

1601 
dev
->
ù¾_cÚfig
 = 
NVME_CC_ENABLE
 | 
NVME_CC_CSS_NVM
;

1602 
dev
->
ù¾_cÚfig
 |ğ(
PAGE_SHIFT
 - 12è<< 
NVME_CC_MPS_SHIFT
;

1603 
dev
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

1604 
dev
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

1606 
	`wr™–
(
aqa
, &
dev
->
b¬
->aqa);

1607 
	`wr™eq
(
nvmeq
->
sq_dma_addr
, &
dev
->
b¬
->
asq
);

1608 
	`wr™eq
(
nvmeq
->
cq_dma_addr
, &
dev
->
b¬
->
acq
);

1609 
	`wr™–
(
dev
->
ù¾_cÚfig
, &dev->
b¬
->
cc
);

1611 
»suÉ
 = 
	`nvme_’abË_ù¾
(
dev
, 
ÿp
);

1612 ià(
»suÉ
)

1613 
ä“_q
;

1615 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
, "nvme‡dmin");

1616 ià(
»suÉ
)

1617 
ä“_q
;

1619 
dev
->
queues
[0] = 
nvmeq
;

1620  
»suÉ
;

1622 
ä“_q
:

1623 
	`nvme_ä“_queue_mem
(
nvmeq
);

1624  
»suÉ
;

1625 
	}
}

1627 
nvme_iod
 *
	$nvme_m­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

1628 
addr
, 
Ëngth
)

1630 
i
, 
”r
, 
couÁ
, 
ÃÁs
, 
off£t
;

1631 
sÿ‰”li¡
 *
sg
;

1632 
·ge
 **
·ges
;

1633 
nvme_iod
 *
iod
;

1635 ià(
addr
 & 3)

1636  
	`ERR_PTR
(-
EINVAL
);

1637 ià(!
Ëngth
 ||†’gth > 
INT_MAX
 - 
PAGE_SIZE
)

1638  
	`ERR_PTR
(-
EINVAL
);

1640 
off£t
 = 
	`off£t_š_·ge
(
addr
);

1641 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

1642 
·ges
 = 
	`kÿÎoc
(
couÁ
, (*·ges), 
GFP_KERNEL
);

1643 ià(!
·ges
)

1644  
	`ERR_PTR
(-
ENOMEM
);

1646 
”r
 = 
	`g‘_u£r_·ges_ç¡
(
addr
, 
couÁ
, 1, 
·ges
);

1647 ià(
”r
 < 
couÁ
) {

1648 
couÁ
 = 
”r
;

1649 
”r
 = -
EFAULT
;

1650 
put_·ges
;

1653 
iod
 = 
	`nvme_®loc_iod
(
couÁ
, 
Ëngth
, 
GFP_KERNEL
);

1654 
sg
 = 
iod
->sg;

1655 
	`sg_š™_bË
(
sg
, 
couÁ
);

1656 
i
 = 0; i < 
couÁ
; i++) {

1657 
	`sg_£t_·ge
(&
sg
[
i
], 
·ges
[i],

1658 
	`mš_t
(, 
Ëngth
, 
PAGE_SIZE
 - 
off£t
),

1659 
off£t
);

1660 
Ëngth
 -ğ(
PAGE_SIZE
 - 
off£t
);

1661 
off£t
 = 0;

1663 
	`sg_m¬k_’d
(&
sg
[
i
 - 1]);

1664 
iod
->
ÃÁs
 = 
couÁ
;

1666 
”r
 = -
ENOMEM
;

1667 
ÃÁs
 = 
	`dma_m­_sg
(&
dev
->
pci_dev
->dev, 
sg
, 
couÁ
,

1668 
wr™e
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1669 ià(!
ÃÁs
)

1670 
ä“_iod
;

1672 
	`kä“
(
·ges
);

1673  
iod
;

1675 
ä“_iod
:

1676 
	`kä“
(
iod
);

1677 
put_·ges
:

1678 
i
 = 0; i < 
couÁ
; i++)

1679 
	`put_·ge
(
·ges
[
i
]);

1680 
	`kä“
(
·ges
);

1681  
	`ERR_PTR
(
”r
);

1682 
	}
}

1684 
	$nvme_unm­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

1685 
nvme_iod
 *
iod
)

1687 
i
;

1689 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, 
iod
->
sg
, iod->
ÃÁs
,

1690 
wr™e
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1692 
i
 = 0; i < 
iod
->
ÃÁs
; i++)

1693 
	`put_·ge
(
	`sg_·ge
(&
iod
->
sg
[
i
]));

1694 
	}
}

1696 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1698 
nvme_dev
 *
dev
 = 
ns
->dev;

1699 
nvme_queue
 *
nvmeq
;

1700 
nvme_u£r_io
 
io
;

1701 
nvme_commªd
 
c
;

1702 
Ëngth
, 
m‘a_Ën
;

1703 
¡©us
, 
i
;

1704 
nvme_iod
 *
iod
, *
m‘a_iod
 = 
NULL
;

1705 
dma_addr_t
 
m‘a_dma_addr
;

1706 *
m‘a
, *
	`unš™Ÿlized_v¬
(
m‘a_mem
);

1708 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

1709  -
EFAULT
;

1710 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1711 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1713 ià(
m‘a_Ën
 && ((
io
.
m‘ad©a
 & 3) || !io.metadata))

1714  -
EINVAL
;

1716 
io
.
İcode
) {

1717 
nvme_cmd_wr™e
:

1718 
nvme_cmd_»ad
:

1719 
nvme_cmd_com·»
:

1720 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
io
.
İcode
 & 1, io.
addr
, 
Ëngth
);

1723  -
EINVAL
;

1726 ià(
	`IS_ERR
(
iod
))

1727  
	`PTR_ERR
(
iod
);

1729 
	`mem£t
(&
c
, 0, (c));

1730 
c
.
rw
.
İcode
 = 
io
.opcode;

1731 
c
.
rw
.
æags
 = 
io
.flags;

1732 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1733 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

1734 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

1735 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

1736 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

1737 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

1738 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

1739 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

1741 ià(
m‘a_Ën
) {

1742 
m‘a_iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
io
.
İcode
 & 1, io.
m‘ad©a
, 
m‘a_Ën
);

1743 ià(
	`IS_ERR
(
m‘a_iod
)) {

1744 
¡©us
 = 
	`PTR_ERR
(
m‘a_iod
);

1745 
m‘a_iod
 = 
NULL
;

1746 
unm­
;

1749 
m‘a_mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 
m‘a_Ën
,

1750 &
m‘a_dma_addr
, 
GFP_KERNEL
);

1751 ià(!
m‘a_mem
) {

1752 
¡©us
 = -
ENOMEM
;

1753 
unm­
;

1756 ià(
io
.
İcode
 & 1) {

1757 
m‘a_off£t
 = 0;

1759 
i
 = 0; i < 
m‘a_iod
->
ÃÁs
; i++) {

1760 
m‘a
 = 
	`km­_©omic
(
	`sg_·ge
(&
m‘a_iod
->
sg
[
i
])) +

1761 
m‘a_iod
->
sg
[
i
].
off£t
;

1762 
	`memıy
(
m‘a_mem
 + 
m‘a_off£t
, 
m‘a
,

1763 
m‘a_iod
->
sg
[
i
].
Ëngth
);

1764 
	`kunm­_©omic
(
m‘a
);

1765 
m‘a_off£t
 +ğ
m‘a_iod
->
sg
[
i
].
Ëngth
;

1769 
c
.
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
m‘a_dma_addr
);

1772 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, &
c
.
commÚ
, 
iod
,†’gth, 
GFP_KERNEL
);

1774 
nvmeq
 = 
	`g‘_nvmeq
(
dev
);

1781 
	`put_nvmeq
(
nvmeq
);

1782 ià(
Ëngth
 !ğ(
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
)

1783 
¡©us
 = -
ENOMEM
;

1785 
¡©us
 = 
	`nvme_subm™_sync_cmd
(
nvmeq
, &
c
, 
NULL
, 
NVME_IO_TIMEOUT
);

1787 ià(
m‘a_Ën
) {

1788 ià(
¡©us
 =ğ
NVME_SC_SUCCESS
 && !(
io
.
İcode
 & 1)) {

1789 
m‘a_off£t
 = 0;

1791 
i
 = 0; i < 
m‘a_iod
->
ÃÁs
; i++) {

1792 
m‘a
 = 
	`km­_©omic
(
	`sg_·ge
(&
m‘a_iod
->
sg
[
i
])) +

1793 
m‘a_iod
->
sg
[
i
].
off£t
;

1794 
	`memıy
(
m‘a
, 
m‘a_mem
 + 
m‘a_off£t
,

1795 
m‘a_iod
->
sg
[
i
].
Ëngth
);

1796 
	`kunm­_©omic
(
m‘a
);

1797 
m‘a_off£t
 +ğ
m‘a_iod
->
sg
[
i
].
Ëngth
;

1801 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 
m‘a_Ën
, 
m‘a_mem
,

1802 
m‘a_dma_addr
);

1805 
unm­
:

1806 
	`nvme_unm­_u£r_·ges
(
dev
, 
io
.
İcode
 & 1, 
iod
);

1807 
	`nvme_ä“_iod
(
dev
, 
iod
);

1809 ià(
m‘a_iod
) {

1810 
	`nvme_unm­_u£r_·ges
(
dev
, 
io
.
İcode
 & 1, 
m‘a_iod
);

1811 
	`nvme_ä“_iod
(
dev
, 
m‘a_iod
);

1814  
¡©us
;

1815 
	}
}

1817 
	$nvme_u£r_admš_cmd
(
nvme_dev
 *
dev
,

1818 
nvme_admš_cmd
 
__u£r
 *
ucmd
)

1820 
nvme_admš_cmd
 
cmd
;

1821 
nvme_commªd
 
c
;

1822 
¡©us
, 
Ëngth
;

1823 
nvme_iod
 *
	`unš™Ÿlized_v¬
(
iod
);

1824 
timeout
;

1826 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1827  -
EACCES
;

1828 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1829  -
EFAULT
;

1831 
	`mem£t
(&
c
, 0, (c));

1832 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1833 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1834 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1835 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

1836 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

1837 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

1838 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

1839 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1840 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1841 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

1842 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

1844 
Ëngth
 = 
cmd
.
d©a_Ën
;

1845 ià(
cmd
.
d©a_Ën
) {

1846 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
cmd
.
İcode
 & 1, cmd.
addr
,

1847 
Ëngth
);

1848 ià(
	`IS_ERR
(
iod
))

1849  
	`PTR_ERR
(
iod
);

1850 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, &
c
.
commÚ
, 
iod
,†ength,

1851 
GFP_KERNEL
);

1854 
timeout
 = 
cmd
.
timeout_ms
 ? 
	`m£cs_to_jiff›s
(cmd.timeout_ms) :

1855 
ADMIN_TIMEOUT
;

1856 ià(
Ëngth
 !ğ
cmd
.
d©a_Ën
)

1857 
¡©us
 = -
ENOMEM
;

1859 
¡©us
 = 
	`nvme_subm™_sync_cmd
(
dev
->
queues
[0], &
c
, &
cmd
.
»suÉ
,

1860 
timeout
);

1862 ià(
cmd
.
d©a_Ën
) {

1863 
	`nvme_unm­_u£r_·ges
(
dev
, 
cmd
.
İcode
 & 1, 
iod
);

1864 
	`nvme_ä“_iod
(
dev
, 
iod
);

1867 ià((
¡©us
 >ğ0è&& 
	`cİy_to_u£r
(&
ucmd
->
»suÉ
, &
cmd
.result,

1868 (
cmd
.
»suÉ
)))

1869 
¡©us
 = -
EFAULT
;

1871  
¡©us
;

1872 
	}
}

1876 
nvme_iod
 *
	$nvme_m­_k”Ãl_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

1877 
addr
, 
Ëngth
)

1879 
i
, 
”r
, 
couÁ
, 
ÃÁs
, 
off£t
;

1880 
sÿ‰”li¡
 *
sg
;

1881 
·ge
 **
·ges
;

1882 
·ge
 *·gğ
NULL
;

1883 
nvme_iod
 *
iod
;

1884 *
¤c_d©a
 = 
NULL
;

1886 ià(
addr
 & 3)

1887  
	`ERR_PTR
(-
EINVAL
);

1888 ià(!
Ëngth
 ||†’gth > 
INT_MAX
 - 
PAGE_SIZE
)

1889  
	`ERR_PTR
(-
EINVAL
);

1891 
off£t
 = 
	`off£t_š_·ge
(
addr
);

1892 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

1893 
·ges
 = 
	`kÿÎoc
(
couÁ
, (*·ges), 
GFP_KERNEL
);

1894 ià(!
·ges
)

1895  
	`ERR_PTR
(-
ENOMEM
);

1897 
¤c_d©a
 = (*)
addr
;

1898 
i
 = 0; i < 
couÁ
; i ++) {

1899 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

1900 
	`g‘_·ge
(
·ge
);

1901 
·ges
[
i
] = 
·ge
;

1902 
¤c_d©a
 +ğ
PAGE_SIZE
;

1905 
iod
 = 
	`nvme_®loc_iod
(
couÁ
, 
Ëngth
, 
GFP_KERNEL
);

1906 
sg
 = 
iod
->sg;

1907 
	`sg_š™_bË
(
sg
, 
couÁ
);

1908 
i
 = 0; i < 
couÁ
; i++) {

1909 
	`sg_£t_·ge
(&
sg
[
i
], 
·ges
[i],

1910 
	`mš_t
(, 
Ëngth
, 
PAGE_SIZE
 - 
off£t
),

1911 
off£t
);

1912 
Ëngth
 -ğ(
PAGE_SIZE
 - 
off£t
);

1913 
off£t
 = 0;

1915 
	`sg_m¬k_’d
(&
sg
[
i
 - 1]);

1916 
iod
->
ÃÁs
 = 
couÁ
;

1918 
”r
 = -
ENOMEM
;

1919 
ÃÁs
 = 
	`dma_m­_sg
(&
dev
->
pci_dev
->dev, 
sg
, 
couÁ
,

1920 
wr™e
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1921 ià(!
ÃÁs
)

1922 
ä“_iod
;

1924 
	`kä“
(
·ges
);

1925  
iod
;

1927 
ä“_iod
:

1928 
	`kä“
(
iod
);

1929 
i
 = 0; i < 
couÁ
; i++)

1930 
	`put_·ge
(
·ges
[
i
]);

1931 
	`kä“
(
·ges
);

1932  
	`ERR_PTR
(
”r
);

1933 
	}
}

1937 
	$u£r_addr_Åages
(
off£t
, 
size
)

1939 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

1940  
couÁ
;

1941 
	}
}

1943 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
)

1945 
off£t
 = 
	`off£t_š_·ge
(
addr
);

1946 
d©®’
 = 
Ën
;

1947 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
,
Ën
);

1948 
size
 = 0;

1949 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1950 
m­³d_·ges
 = 0;

1951 
i
 = 0;

1953 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


1954 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

1956 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

1957 ià(!
u£r_ùx
) {

1958  
NULL
;

1961 
u£r_ùx
->
ÃÁs
 = 0;

1962 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

1963 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

1964 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

1965 0, 
u£r_ùx
->
·ges
);

1966 ià(
m­³d_·ges
 !ğ
num_·ge
) {

1967 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

1968 
ex™
;

1970 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

1971 
u£r_ùx
->
Ën
 = 
d©®’
;

1972 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

1973 
i
 = 0; i < 
num_·ge
; i++) {

1974 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

1975 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

1976 
off£t
);

1977 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

1978 
off£t
 = 0;

1980 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

1981  
u£r_ùx
;

1982 
ex™
:

1983 ià(
u£r_ùx
) {

1984 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

1985 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

1986 
	`kä“
(
u£r_ùx
);

1988  
NULL
;

1989 
	}
}

1991 
	$nvme_subm™_async_kv_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
* 
cmd
,

1992 
u32
 *
»suÉ
, 
timeout
, 
nvme_kaiocb
 *
aiocb
) {

1993 
cmdid
;

1994 
aiocb
->
ev’t
.
¡©us
 = -
EINTR
;

1995 
cmdid
 = 
	`®loc_cmdid_kÏbË
(
nvmeq
, 
aiocb
, 
kv_async_com¶‘iÚ
, 
timeout
);

1996 ià(
cmdid
 < 0)

1997  
cmdid
;

1998 
cmd
->
commÚ
.
commªd_id
 = 
cmdid
;

1999 
	`nvme_subm™_cmd
(
nvmeq
, 
cmd
);

2001 
	}
}

2003 
boŞ
 
	$check_fÜ_sšgË_phyadd»ss
(
__u£r
* 
add»ss
, 
Ëngth
) {

2004 
off£t
 = 0;

2005 
couÁ
 = 0;

2006 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

2007 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

2008 ià(
couÁ
 > 1 && (()
add»ss
 & 
	`queue_dma_®ignm’t
(
NULL
))) {

2009  
çl£
;

2011  
Œue
;

2012 
	}
}

2013 
	$__nvme_subm™_kv_u£r_cmd
(
nvme_ns
 *
ns
, 
nvme_commªd
 *
cmd
,

2014 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

2015 
__u£r
 *
ubufãr
, 
bufæ’
,

2016 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
,

2017 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

2019 
nvme_dev
 *
dev
 = 
ns
->dev;

2020 
nvme_queue
 *
nvmeq
 = 
NULL
;

2021 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

2022 
sÿ‰”li¡
 *
m‘a_sg_±r
 = 
NULL
;

2023 
sÿ‰”li¡
 
m‘a_sg
;

2024 
nvme_iod
 *
iod
 = 
NULL
;

2025 
Ëngth
 = 0;

2026 
»t
 = 0;

2027 * 
m‘a
 = 
NULL
;

2028 * 
kv_d©a
 = 
NULL
;

2029 
boŞ
 
£t_m‘a
 = 
çl£
;

2030 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

2031 
·ge
 *
p_·ge
 = 
NULL
;

2032 
aio_u£r_ùx
 * 
u£r_ùx
 = 
NULL
;

2033 ià(
aio
) {

2034 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

2035 ià(!
aiocb
)

2036  -
ENOMEM
;

2039 ià(
ubufãr
 && 
bufæ’
) {

2040 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
NULL
)) {

2041 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

2042 
Ãed_to_cİy
 = 
Œue
;

2043 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

2044 ià(
kv_d©a
 =ğ
NULL
) {

2045 
»t
 = -
ENOMEM
;

2046 
out
;

2049 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
);

2050 ià(
u£r_ùx
 =ğ
NULL
) {

2051 
»t
 = -
ENOMEM
;

2052 
ä“_out
;

2054 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

2055 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

2056 
kv_d©a
, 
u£r_ùx
->
Ën
);

2058 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

2059 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

2060 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

2064 
iod
 = 
	`nvme_m­_k”Ãl_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
±hr_cmd
->
İcode
), ()
kv_d©a
, 
bufæ’
);

2066 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
±hr_cmd
->
İcode
), ()
ubufãr
, 
bufæ’
);

2068 ià(
	`IS_ERR
(
iod
)) {

2069 
»t
 = -
ENOMEM
;

2070 
ä“_out
;

2072 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, &
cmd
->
commÚ
, 
iod
, 
bufæ’
, 
GFP_KERNEL
);

2073 ià(
Ëngth
 !ğ
bufæ’
) {

2074 
»t
 = -
ENOMEM
;

2075 
out_unm­
;

2077 ià(
aio
) {

2078 
aiocb
->
iod
 = iod;

2079 
aiocb
->
kv_d©a
 = kv_data;

2080 
aiocb
->
u£r_ùx
 = user_ctx;

2083 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

2084 
off£t
 = 0, 
Ën
 = 0;

2085 ià(!
	`check_fÜ_sšgË_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
)) {

2086 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256)*256;

2087 
m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

2088 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

2089 
»t
 = -
EFAULT
;

2090 
out
;

2092 
off£t
 = 
	`off£t_š_·ge
(
m‘a
);

2093 
p_·ge
 = 
	`vœt_to_·ge
(
m‘a
);

2094 
	`·ge_ÿche_g‘
(
p_·ge
);

2096 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 1, &
p_·ge
);

2097 ià(
»t
 < 1) {

2098 
»t
 = -
ENOMEM
;

2099 
out
;

2101 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

2103 ià(
aio
) {

2104 
aiocb
->
u£_m‘a
 = 
Œue
;

2105 
aiocb
->
m‘a
 = meta;

2106 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

2108 
m‘a_sg_±r
 = &
m‘a_sg
;

2110 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

2111 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

2112 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

2113 ià(!
	`dma_m­_sg
(&
dev
->
pci_dev
->dev, 
m‘a_sg_±r
, 1, 
DMA_TO_DEVICE
)) {

2114 
»t
 = -
ENOMEM
;

2115 
out_unm­
;

2117 
cmd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
m‘a_sg_±r
));

2118 
£t_m‘a
 = 
Œue
;

2121 
nvmeq
 = 
	`g‘_nvmeq
(
dev
);

2128 
	`put_nvmeq
(
nvmeq
);

2129 ià(
aio
) {

2130 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

2131 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

2132 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

2133 
»t
 = 
	`nvme_subm™_async_kv_cmd
(
nvmeq
, 
cmd
, 
»suÉ
, 
timeout
, 
aiocb
);

2134 ià(
»t
 < 0) {

2135 *
¡©us
 = 
»t
;

2136 
out_unm­
;

2140 
»t
 = 
	`nvme_subm™_sync_cmd
(
nvmeq
, 
cmd
, 
»suÉ
, 
timeout
);

2141 *
¡©us
 = 
»t
;

2144 ià(
Ãed_to_cİy
) {

2145 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

2146 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || ((ret& 0x00ff) == 0x0093)))) {

2148 *
d©a
 = 
kv_d©a
;

2149 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

2150 
d©a
[0], data[1], data[2], data[3],

2151 
d©a
[4], data[5], data[6], data[7]);

2153 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

2154 
kv_d©a
, 
u£r_ùx
->
Ën
);

2158 
out_unm­
:

2159 ià(
iod
) {

2160 
	`nvme_unm­_u£r_·ges
(
dev
, 
	`kv_nvme_is_wr™e
(
±hr_cmd
->
İcode
), 
iod
);

2161 
	`nvme_ä“_iod
(
dev
, 
iod
);

2163 ià(
p_·ge
) {

2164 ià(
£t_m‘a
)

2165 
	`dma_unm­_sg
(&
dev
->
pci_dev
->dev, 
m‘a_sg_±r
, 1, 
DMA_TO_DEVICE
);

2166 
	`put_·ge
(
	`sg_·ge
(
m‘a_sg_±r
));

2168 
ä“_out
:

2169 ià(
u£r_ùx
) {

2170 
i
 = 0;

2171 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

2172 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

2173 
	`kä“
(
u£r_ùx
);

2175 ià(
kv_d©a
è
	`kä“
(kv_data);

2176 
out
:

2177 ià(
aio
)

2178 
	`mempoŞ_ä“
(
aiocb
, 
kaiocb_mempoŞ
);

2179  
»t
;

2180 
	}
}

2183 
	$nvme_u£r_kv_cmd
(
nvme_ns
 *
ns
, 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

2185 
nvme_·s¡hru_kv_cmd
 
cmd
;

2186 
nvme_commªd
 
c
;

2187 
¡©us
 = 0;

2188 
timeout
 = 
NVME_IO_TIMEOUT
;

2189 
__u£r
 *
m‘ad©a
 = 
NULL
;

2190 
m‘a_Ën
 = 0;

2191 
İtiÚ
 = 0;

2192 
™”_hªdË
 = 0;

2194 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

2195  -
EFAULT
;

2196 ià(
cmd
.
æags
)

2197  -
EINVAL
;

2198 ià(!
	`is_kv_cmd
(
cmd
.
İcode
))

2199  -
EINVAL
;

2201 
	`mem£t
(&
c
, 0, (c));

2202 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

2203 
c
.
commÚ
.
æags
 = 
cmd
.flags;

2204 #ifdeà
KSID_SUPPORT


2205 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

2207 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

2209 ià(
cmd
.
timeout_ms
)

2210 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

2212 
cmd
.
İcode
) {

2213 
nvme_cmd_kv_¡Üe
:

2214 
nvme_cmd_kv_­³nd
:

2215 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2216 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2218 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
) {

2219 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2220 
¡©us
 = -
EINVAL
;

2221 
ex™
;

2223 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2224 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

2226 ià(
cmd
.
d©a_Ëngth
 % 4) {

2227 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

2228 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

2230 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

2233 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2234 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

2235 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2237 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2240 
nvme_cmd_kv_»Œ›ve
:

2241 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2242 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2244 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

2245 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

2246 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2247 
¡©us
 = -
EINVAL
;

2248 
ex™
;

2250 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2251 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

2252 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

2254 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2255 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

2256 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2258 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2261 
nvme_cmd_kv_d–‘e
:

2262 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2264 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

2265 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

2266 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2267 
¡©us
 = -
EINVAL
;

2268 
ex™
;

2270 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2271 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

2272 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2273 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

2274 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2276 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2279 
nvme_cmd_kv_exi¡
:

2280 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2282 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

2283 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

2284 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

2285 
¡©us
 = -
EINVAL
;

2286 
ex™
;

2288 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

2289 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

2290 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

2291 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

2292 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

2294 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

2298 
nvme_cmd_kv_™”_»q
:

2299 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2300 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2301 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

2302 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

2303 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

2304 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

2306 
nvme_cmd_kv_™”_»ad
:

2307 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

2308 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

2309 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

2310 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

2311 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

2314 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

2315 
¡©us
 = -
EINVAL
;

2316 
ex™
;

2319 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
, &
c
, &
cmd
,

2320 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
,

2321 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

2322 
ex™
:

2323 ià(!
aio
) {

2324 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

2325  -
EFAULT
;

2326 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

2327  -
EFAULT
;

2329  
¡©us
;

2330 
	}
}

2335 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
, 
cmd
,

2336 
¬g
)

2338 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2340 
cmd
) {

2341 
NVME_IOCTL_ID
:

2342  
ns
->
ns_id
;

2343 
NVME_IOCTL_ADMIN_CMD
:

2344  
	`nvme_u£r_admš_cmd
(
ns
->
dev
, (
__u£r
 *)
¬g
);

2345 
NVME_IOCTL_SUBMIT_IO
:

2346  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

2347 
SG_GET_VERSION_NUM
:

2348  
	`nvme_sg_g‘_v”siÚ_num
((
__u£r
 *)
¬g
);

2349 
SG_IO
:

2350  
	`nvme_sg_io
(
ns
, (
__u£r
 *)
¬g
);

2355 
NVME_IOCTL_AIO_CMD
:

2356  
	`nvme_u£r_kv_cmd
(
ns
, (
__u£r
 *)
¬g
, 
Œue
);

2357 
NVME_IOCTL_IO_KV_CMD
:

2358  
	`nvme_u£r_kv_cmd
(
ns
, (
__u£r
 *)
¬g
, 
çl£
);

2359 
NVME_IOCTL_SET_AIOCTX
:

2360  
	`nvme_£t_aioùx
((
__u£r
 *)
¬g
);

2361 
NVME_IOCTL_DEL_AIOCTX
:

2362  
	`nvme_d–_aioùx
((
__u£r
 *)
¬g
);

2363 
NVME_IOCTL_GET_AIOEVENT
:

2364  
	`nvme_g‘_aiÛv’ts
((
__u£r
 *)
¬g
);

2367  -
ENOTTY
;

2369 
	}
}

2371 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

2372 .
owÃr
 = 
THIS_MODULE
,

2373 .
	gioùl
 = 
nvme_ioùl
,

2374 .
	gcom·t_ioùl
 = 
nvme_ioùl
,

2377 
	$nvme_»subm™_bios
(
nvme_queue
 *
nvmeq
)

2379 
	`bio_li¡_³ek
(&
nvmeq
->
sq_cÚg
)) {

2380 
bio
 *biØğ
	`bio_li¡_pİ
(&
nvmeq
->
sq_cÚg
);

2381 
nvme_ns
 *
ns
 = 
bio
->
bi_bdev
->
bd_disk
->
´iv©e_d©a
;

2383 ià(
	`bio_li¡_em±y
(&
nvmeq
->
sq_cÚg
))

2384 
	`»move_wa™_queue
(&
nvmeq
->
sq_fuÎ
,

2385 &
nvmeq
->
sq_cÚg_wa™
);

2386 ià(
	`nvme_subm™_bio_queue
(
nvmeq
, 
ns
, 
bio
)) {

2387 ià(
	`bio_li¡_em±y
(&
nvmeq
->
sq_cÚg
))

2388 
	`add_wa™_queue
(&
nvmeq
->
sq_fuÎ
,

2389 &
nvmeq
->
sq_cÚg_wa™
);

2390 
	`bio_li¡_add_h—d
(&
nvmeq
->
sq_cÚg
, 
bio
);

2394 
	}
}

2396 
	$nvme_kth»ad
(*
d©a
)

2398 
nvme_dev
 *
dev
;

2400 !
	`kth»ad_should_¡İ
()) {

2401 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

2402 
	`¥š_lock
(&
dev_li¡_lock
);

2403 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
dev_li¡
, 
node
) {

2404 
i
;

2405 
i
 = 0; i < 
dev
->
queue_couÁ
; i++) {

2406 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

2407 ià(!
nvmeq
)

2409 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

2410 ià(
	`nvme_´oûss_cq
(
nvmeq
))

2411 
	`´štk
("process_cq did something\n");

2412 
	`nvme_ÿnûl_ios
(
nvmeq
, 
Œue
);

2413 
	`nvme_»subm™_bios
(
nvmeq
);

2414 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

2417 
	`¥š_uÆock
(&
dev_li¡_lock
);

2418 
	`scheduË_timeout
(
	`round_jiff›s_»Ïtive
(
HZ
));

2421 
	}
}

2423 
DEFINE_IDA
(
nvme_šdex_ida
);

2425 
	$nvme_g‘_ns_idx
()

2427 
šdex
, 
”rÜ
;

2430 ià(!
	`ida_´e_g‘
(&
nvme_šdex_ida
, 
GFP_KERNEL
))

2433 
	`¥š_lock
(&
dev_li¡_lock
);

2434 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_šdex_ida
, &
šdex
);

2435 
	`¥š_uÆock
(&
dev_li¡_lock
);

2436 } 
”rÜ
 =ğ-
EAGAIN
);

2438 ià(
”rÜ
)

2439 
šdex
 = -1;

2440  
šdex
;

2441 
	}
}

2443 
	$nvme_put_ns_idx
(
šdex
)

2445 
	`¥š_lock
(&
dev_li¡_lock
);

2446 
	`ida_»move
(&
nvme_šdex_ida
, 
šdex
);

2447 
	`¥š_uÆock
(&
dev_li¡_lock
);

2448 
	}
}

2450 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

2452 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

2453 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

2454 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

2455 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

2456 
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
 = 0xffffffff;

2457 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

2458 
	}
}

2460 
nvme_ns
 *
	$nvme_®loc_ns
(
nvme_dev
 *
dev
, 
nsid
,

2461 
nvme_id_ns
 *
id
, 
nvme_lba_¿nge_ty³
 *
¹
)

2463 
nvme_ns
 *
ns
;

2464 
g’disk
 *
disk
;

2465 
lbaf
;

2467 ià(
¹
->
©Œibu‹s
 & 
NVME_LBART_ATTRIB_HIDE
)

2468  
NULL
;

2470 
ns
 = 
	`kz®loc
((*ns), 
GFP_KERNEL
);

2471 ià(!
ns
)

2472  
NULL
;

2473 
ns
->
queue
 = 
	`blk_®loc_queue
(
GFP_KERNEL
);

2474 ià(!
ns
->
queue
)

2475 
out_ä“_ns
;

2476 
ns
->
queue
->
queue_æags
 = 
QUEUE_FLAG_DEFAULT
;

2477 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NOMERGES
, 
ns
->
queue
);

2478 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

2479 
	`blk_queue_make_»que¡
(
ns
->
queue
, 
nvme_make_»que¡
);

2480 
ns
->
dev
 = dev;

2481 
ns
->
queue
->
queued©a
 =‚s;

2483 
disk
 = 
	`®loc_disk
(
NVME_MINORS
);

2484 ià(!
disk
)

2485 
out_ä“_queue
;

2486 
ns
->
ns_id
 = 
nsid
;

2487 
ns
->
disk
 = disk;

2488 
lbaf
 = 
id
->
æbas
 & 0xf;

2489 
ns
->
lba_shiá
 = 
id
->
lbaf
[lbaf].
ds
;

2490 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[lbaf].ms);

2491 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

2492 ià(
dev
->
max_hw_£ùÜs
)

2493 
	`blk_queue_max_hw_£ùÜs
(
ns
->
queue
, 
dev
->
max_hw_£ùÜs
);

2495 
disk
->
majÜ
 = 
nvme_majÜ
;

2496 
disk
->
mšÜs
 = 
NVME_MINORS
;

2497 
disk
->
fœ¡_mšÜ
 = 
NVME_MINORS
 * 
	`nvme_g‘_ns_idx
();

2498 
disk
->
fİs
 = &
nvme_fİs
;

2499 
disk
->
´iv©e_d©a
 = 
ns
;

2500 
disk
->
queue
 = 
ns
->queue;

2501 
disk
->
driv”fs_dev
 = &
dev
->
pci_dev
->dev;

2502 
	`¥rštf
(
disk
->
disk_Çme
, "nvme%dn%d", 
dev
->
š¡ªû
, 
nsid
);

2503 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

2505 ià(
dev
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

2506 
	`nvme_cÚfig_disÿrd
(
ns
);

2508  
ns
;

2510 
out_ä“_queue
:

2511 
	`blk_ş—nup_queue
(
ns
->
queue
);

2512 
out_ä“_ns
:

2513 
	`kä“
(
ns
);

2514  
NULL
;

2515 
	}
}

2517 
	$nvme_ns_ä“
(
nvme_ns
 *
ns
)

2519 
šdex
 = 
ns
->
disk
->
fœ¡_mšÜ
 / 
NVME_MINORS
;

2520 
	`put_disk
(
ns
->
disk
);

2521 
	`nvme_put_ns_idx
(
šdex
);

2522 
	`blk_ş—nup_queue
(
ns
->
queue
);

2523 
	`kä“
(
ns
);

2524 
	}
}

2526 
	$£t_queue_couÁ
(
nvme_dev
 *
dev
, 
couÁ
)

2528 
¡©us
;

2529 
u32
 
»suÉ
;

2530 
u32
 
q_couÁ
 = (
couÁ
 - 1) | ((count - 1) << 16);

2532 
¡©us
 = 
	`nvme_£t_ã©u»s
(
dev
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 0,

2533 &
»suÉ
);

2534 ià(
¡©us
)

2535  -
EIO
;

2536  
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

2537 
	}
}

2539 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

2541 
pci_dev
 *
pdev
 = 
dev
->pci_dev;

2542 
»suÉ
, 
ıu
, 
i
, 
Ä_io_queues
, 
db_b¬_size
, 
q_d•th
, 
q_couÁ
;

2544 
Ä_io_queues
 = 
	`num_Úlše_ıus
();

2545 
»suÉ
 = 
	`£t_queue_couÁ
(
dev
, 
Ä_io_queues
);

2546 ià(
»suÉ
 < 0)

2547  
»suÉ
;

2548 ià(
»suÉ
 < 
Ä_io_queues
)

2549 
Ä_io_queues
 = 
»suÉ
;

2551 
q_couÁ
 = 
Ä_io_queues
;

2553 
	`ä“_œq
(
dev
->
’Œy
[0].
veùÜ
, dev->
queues
[0]);

2555 
db_b¬_size
 = 4096 + ((
Ä_io_queues
 + 1è<< (
dev
->
db_¡ride
 + 3));

2556 ià(
db_b¬_size
 > 8192) {

2557 
	`iounm­
(
dev
->
b¬
);

2558 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
db_b¬_size
);

2559 
dev
->
dbs
 = ((
__iomem
 *)dev->
b¬
) + 4096;

2560 
dev
->
queues
[0]->
q_db
 = dev->
dbs
;

2563 
i
 = 0; i < 
Ä_io_queues
; i++)

2564 
dev
->
’Œy
[
i
].entry = i;

2566 
»suÉ
 = 
	`pci_’abË_msix
(
pdev
, 
dev
->
’Œy
, 
Ä_io_queues
);

2567 ià(
»suÉ
 == 0) {

2569 } ià(
»suÉ
 > 0) {

2570 
Ä_io_queues
 = 
»suÉ
;

2573 
Ä_io_queues
 = 0;

2578 ià(
Ä_io_queues
 == 0) {

2579 
Ä_io_queues
 = 
q_couÁ
;

2581 
»suÉ
 = 
	`pci_’abË_msi_block
(
pdev
, 
Ä_io_queues
);

2582 ià(
»suÉ
 == 0) {

2583 
i
 = 0; i < 
Ä_io_queues
; i++)

2584 
dev
->
’Œy
[
i
].
veùÜ
 = i + 
pdev
->
œq
;

2586 } ià(
»suÉ
 > 0) {

2587 
Ä_io_queues
 = 
»suÉ
;

2590 
Ä_io_queues
 = 1;

2596 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, dev->
queues
[0], "nvme‡dmin");

2599 
ıu
 = 
	`ıumask_fœ¡
(
ıu_Úlše_mask
);

2600 
i
 = 0; i < 
Ä_io_queues
; i++) {

2601 
	`œq_£t_affš™y_hšt
(
dev
->
’Œy
[
i
].
veùÜ
, 
	`g‘_ıu_mask
(
ıu
));

2602 
ıu
 = 
	`ıumask_Ãxt
(ıu, 
ıu_Úlše_mask
);

2605 
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(
	`»adq
(&
dev
->
b¬
->
ÿp
)) + 1,

2606 
NVME_Q_DEPTH
);

2607 
i
 = 0; i < 
Ä_io_queues
; i++) {

2608 
dev
->
queues
[
i
 + 1] = 
	`nvme_ü—‹_queue
(dev, i + 1, 
q_d•th
, i);

2609 ià(
	`IS_ERR
(
dev
->
queues
[
i
 + 1]))

2610  
	`PTR_ERR
(
dev
->
queues
[
i
 + 1]);

2611 
dev
->
queue_couÁ
++;

2614 ; 
i
 < 
	`num_possibË_ıus
(); i++) {

2615 
rg‘
 = 
i
 % 
	`rounddown_pow_of_two
(
dev
->
queue_couÁ
 - 1);

2616 
dev
->
queues
[
i
 + 1] = dev->queues[
rg‘
 + 1];

2620 
	}
}

2622 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
)

2624 
i
;

2626 
i
 = 
dev
->
queue_couÁ
 - 1; i >= 0; i--)

2627 
	`nvme_ä“_queue
(
dev
, 
i
);

2628 
	}
}

2636 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2638 
»s
, 
Â
, 
i
;

2639 
nvme_ns
 *
ns
;

2640 
nvme_id_ù¾
 *
ù¾
;

2641 
nvme_id_ns
 *
id_ns
;

2642 *
mem
;

2643 
dma_addr_t
 
dma_addr
;

2644 
shiá
 = 
	`NVME_CAP_MPSMIN
(
	`»adq
(&
dev
->
b¬
->
ÿp
)) + 12;

2646 
»s
 = 
	`nvme_£tup_io_queues
(
dev
);

2647 ià(
»s
)

2648  
»s
;

2650 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 8192, &
dma_addr
,

2651 
GFP_KERNEL
);

2652 ià(!
mem
)

2653  -
ENOMEM
;

2655 
»s
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

2656 ià(
»s
) {

2657 
»s
 = -
EIO
;

2658 
out
;

2661 
ù¾
 = 
mem
;

2662 
Â
 = 
	`Ë32_to_ıup
(&
ù¾
->nn);

2663 
dev
->
Úcs
 = 
	`Ë16_to_ıup
(&
ù¾
->oncs);

2664 
	`memıy
(
dev
->
£rŸl
, 
ù¾
->
¢
, (ctrl->sn));

2665 
	`memıy
(
dev
->
mod–
, 
ù¾
->
mn
, (ctrl->mn));

2666 
	`memıy
(
dev
->
fœmw¬e_»v
, 
ù¾
->
ä
, (ctrl->fr));

2667 ià(
ù¾
->
mdts
)

2668 
dev
->
max_hw_£ùÜs
 = 1 << (
ù¾
->
mdts
 + 
shiá
 - 9);

2669 ià((
dev
->
pci_dev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_INTEL
) &&

2670 (
dev
->
pci_dev
->
deviû
 =ğ0x0953è&& 
ù¾
->
vs
[3])

2671 
dev
->
¡re_size
 = 1 << (
ù¾
->
vs
[3] + 
shiá
);

2673 
id_ns
 = 
mem
;

2674 
i
 = 1; i <ğ
Â
; i++) {

2675 
»s
 = 
	`nvme_id’tify
(
dev
, 
i
, 0, 
dma_addr
);

2676 ià(
»s
)

2679 ià(
id_ns
->
nÿp
 == 0)

2682 
»s
 = 
	`nvme_g‘_ã©u»s
(
dev
, 
NVME_FEAT_LBA_RANGE
, 
i
,

2683 
dma_addr
 + 4096, 
NULL
);

2684 ià(
»s
)

2685 
	`mem£t
(
mem
 + 4096, 0, 4096);

2687 
ns
 = 
	`nvme_®loc_ns
(
dev
, 
i
, 
mem
, mem + 4096);

2688 ià(
ns
)

2689 
	`li¡_add_
(&
ns
->
li¡
, &
dev
->
Çme¥aûs
);

2691 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
dev
->
Çme¥aûs
, 
li¡
)

2692 
	`add_disk
(
ns
->
disk
);

2693 
»s
 = 0;

2695 
out
:

2696 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 8192, 
mem
, 
dma_addr
);

2697  
»s
;

2698 
	}
}

2700 
	$nvme_dev_»move
(
nvme_dev
 *
dev
)

2702 
nvme_ns
 *
ns
, *
Ãxt
;

2704 
	`¥š_lock
(&
dev_li¡_lock
);

2705 
	`li¡_d–
(&
dev
->
node
);

2706 
	`¥š_uÆock
(&
dev_li¡_lock
);

2708 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
dev
->
Çme¥aûs
, 
li¡
) {

2709 
	`li¡_d–
(&
ns
->
li¡
);

2710 
	`d–_g’disk
(
ns
->
disk
);

2711 
	`nvme_ns_ä“
(
ns
);

2714 
	`nvme_ä“_queues
(
dev
);

2717 
	}
}

2719 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

2721 
deviû
 *
dmadev
 = &
dev
->
pci_dev
->dev;

2722 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("´°li¡…age", 
dmadev
,

2723 
PAGE_SIZE
, PAGE_SIZE, 0);

2724 ià(!
dev
->
´p_·ge_poŞ
)

2725  -
ENOMEM
;

2728 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("´°li¡ 256", 
dmadev
,

2730 ià(!
dev
->
´p_sm®l_poŞ
) {

2731 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2732  -
ENOMEM
;

2735 
	}
}

2737 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

2739 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2740 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

2741 
	}
}

2743 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

2745 
	$nvme_£t_š¡ªû
(
nvme_dev
 *
dev
)

2747 
š¡ªû
, 
”rÜ
;

2750 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

2751  -
ENODEV
;

2753 
	`¥š_lock
(&
dev_li¡_lock
);

2754 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

2755 
	`¥š_uÆock
(&
dev_li¡_lock
);

2756 } 
”rÜ
 =ğ-
EAGAIN
);

2758 ià(
”rÜ
)

2759  -
ENODEV
;

2761 
dev
->
š¡ªû
 = instance;

2763 
	}
}

2765 
	$nvme_»Ëa£_š¡ªû
(
nvme_dev
 *
dev
)

2767 
	`¥š_lock
(&
dev_li¡_lock
);

2768 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
dev
->
š¡ªû
);

2769 
	`¥š_uÆock
(&
dev_li¡_lock
);

2770 
	}
}

2772 
	$nvme_ä“_dev
(
k»f
 *kref)

2774 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
k»f
, nvme_dev, kref);

2775 
	`nvme_dev_»move
(
dev
);

2776 ià(
dev
->
pci_dev
->
msi_’abËd
)

2777 
	`pci_di§bË_msi
(
dev
->
pci_dev
);

2778 ià(
dev
->
pci_dev
->
msix_’abËd
)

2779 
	`pci_di§bË_msix
(
dev
->
pci_dev
);

2780 
	`iounm­
(
dev
->
b¬
);

2781 
	`nvme_»Ëa£_š¡ªû
(
dev
);

2782 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2783 
	`pci_di§bË_deviû
(
dev
->
pci_dev
);

2784 
	`pci_»Ëa£_»giÚs
(
dev
->
pci_dev
);

2785 
	`kä“
(
dev
->
queues
);

2786 
	`kä“
(
dev
->
’Œy
);

2787 
	`kä“
(
dev
);

2788 
	}
}

2790 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *
f
)

2792 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
f
->
´iv©e_d©a
, nvme_dev,

2793 
miscdev
);

2794 
	`k»f_g‘
(&
dev
->
k»f
);

2795 
f
->
´iv©e_d©a
 = 
dev
;

2797 
	}
}

2799 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *
f
)

2801 
nvme_dev
 *
dev
 = 
f
->
´iv©e_d©a
;

2802 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

2804 
	}
}

2806 
	$nvme_dev_ioùl
(
fe
 *
f
, 
cmd
, 
¬g
)

2808 
nvme_dev
 *
dev
 = 
f
->
´iv©e_d©a
;

2809 
cmd
) {

2810 
NVME_IOCTL_ADMIN_CMD
:

2811  
	`nvme_u£r_admš_cmd
(
dev
, (
__u£r
 *)
¬g
);

2813  -
ENOTTY
;

2815 
	}
}

2817 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

2818 .
owÃr
 = 
THIS_MODULE
,

2819 .
	gİ’
 = 
nvme_dev_İ’
,

2820 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

2821 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

2822 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

2825 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2827 
b¬s
, 
»suÉ
 = -
ENOMEM
;

2828 
nvme_dev
 *
dev
;

2830 
dev
 = 
	`kz®loc
((*dev), 
GFP_KERNEL
);

2831 ià(!
dev
)

2832  -
ENOMEM
;

2833 
dev
->
’Œy
 = 
	`kÿÎoc
(
	`num_possibË_ıus
(), (*dev->entry),

2834 
GFP_KERNEL
);

2835 ià(!
dev
->
’Œy
)

2836 
ä“
;

2837 
dev
->
queues
 = 
	`kÿÎoc
(
	`num_possibË_ıus
() + 1, (*),

2838 
GFP_KERNEL
);

2839 ià(!
dev
->
queues
)

2840 
ä“
;

2842 ià(
	`pci_’abË_deviû_mem
(
pdev
))

2843 
ä“
;

2844 
	`pci_£t_ma¡”
(
pdev
);

2845 
b¬s
 = 
	`pci_£Ëù_b¬s
(
pdev
, 
IORESOURCE_MEM
);

2846 ià(
	`pci_»que¡_£Ëùed_»giÚs
(
pdev
, 
b¬s
, "nvme"))

2847 
di§bË
;

2849 
	`INIT_LIST_HEAD
(&
dev
->
Çme¥aûs
);

2850 
dev
->
pci_dev
 = 
pdev
;

2851 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2853 ià(!
	`dma_£t_mask
(&
pdev
->
dev
, 
	`DMA_BIT_MASK
(64)))

2854 
	`dma_£t_coh”’t_mask
(&
pdev
->
dev
, 
	`DMA_BIT_MASK
(64));

2855 ià(!
	`dma_£t_mask
(&
pdev
->
dev
, 
	`DMA_BIT_MASK
(32)))

2856 
	`dma_£t_coh”’t_mask
(&
pdev
->
dev
, 
	`DMA_BIT_MASK
(32));

2858 
di§bË
;

2860 
»suÉ
 = 
	`nvme_£t_š¡ªû
(
dev
);

2861 ià(
»suÉ
)

2862 
di§bË
;

2864 
dev
->
’Œy
[0].
veùÜ
 = 
pdev
->
œq
;

2866 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2867 ià(
»suÉ
)

2868 
di§bË_msix
;

2870 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 8192);

2871 ià(!
dev
->
b¬
) {

2872 
»suÉ
 = -
ENOMEM
;

2873 
di§bË_msix
;

2876 
»suÉ
 = 
	`nvme_cÚfigu»_admš_queue
(
dev
);

2877 ià(
»suÉ
)

2878 
unm­
;

2879 
dev
->
queue_couÁ
++;

2881 
	`¥š_lock
(&
dev_li¡_lock
);

2882 
	`li¡_add
(&
dev
->
node
, &
dev_li¡
);

2883 
	`¥š_uÆock
(&
dev_li¡_lock
);

2885 
»suÉ
 = 
	`nvme_dev_add
(
dev
);

2886 ià(
»suÉ
)

2887 
d–‘e
;

2889 
	`sú´štf
(
dev
->
Çme
, (dev->Çme), "nvme%d", dev->
š¡ªû
);

2890 
dev
->
miscdev
.
mšÜ
 = 
MISC_DYNAMIC_MINOR
;

2891 
dev
->
miscdev
.
·»Á
 = &
pdev
->dev;

2892 
dev
->
miscdev
.
Çme
 = dev->name;

2893 
dev
->
miscdev
.
fİs
 = &
nvme_dev_fİs
;

2894 
»suÉ
 = 
	`misc_»gi¡”
(&
dev
->
miscdev
);

2895 ià(
»suÉ
)

2896 
»move
;

2898 
	`k»f_š™
(&
dev
->
k»f
);

2901 
»move
:

2902 
	`nvme_dev_»move
(
dev
);

2903 
d–‘e
:

2904 
	`¥š_lock
(&
dev_li¡_lock
);

2905 
	`li¡_d–
(&
dev
->
node
);

2906 
	`¥š_uÆock
(&
dev_li¡_lock
);

2908 
	`nvme_ä“_queues
(
dev
);

2909 
unm­
:

2910 
	`iounm­
(
dev
->
b¬
);

2911 
di§bË_msix
:

2912 ià(
dev
->
pci_dev
->
msi_’abËd
)

2913 
	`pci_di§bË_msi
(
dev
->
pci_dev
);

2914 ià(
dev
->
pci_dev
->
msix_’abËd
)

2915 
	`pci_di§bË_msix
(
dev
->
pci_dev
);

2916 
	`nvme_»Ëa£_š¡ªû
(
dev
);

2917 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2918 
di§bË
:

2919 
	`pci_di§bË_deviû
(
pdev
);

2920 
	`pci_»Ëa£_»giÚs
(
pdev
);

2921 
ä“
:

2922 
	`kä“
(
dev
->
queues
);

2923 
	`kä“
(
dev
->
’Œy
);

2924 
	`kä“
(
dev
);

2925  
»suÉ
;

2926 
	}
}

2928 
	$nvme_»move
(
pci_dev
 *
pdev
)

2930 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2931 
	`misc_d”egi¡”
(&
dev
->
miscdev
);

2932 
	`k»f_put
(&
dev
->
k»f
, 
nvme_ä“_dev
);

2933 
	}
}

2936 
	#nvme_”rÜ_d‘eùed
 
NULL


	)

2937 
	#nvme_dump_»gi¡”s
 
NULL


	)

2938 
	#nvme_lšk_»£t
 
NULL


	)

2939 
	#nvme_¦Ù_»£t
 
NULL


	)

2940 
	#nvme_”rÜ_»sume
 
NULL


	)

2941 
	#nvme_su¥’d
 
NULL


	)

2942 
	#nvme_»sume
 
NULL


	)

2944 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2945 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2946 .
	gmmio_’abËd
 = 
nvme_dump_»gi¡”s
,

2947 .
	glšk_»£t
 = 
nvme_lšk_»£t
,

2948 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2949 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2953 
	#PCI_CLASS_STORAGE_EXPRESS
 0x010802

	)

2955 
DEFINE_PCI_DEVICE_TABLE
(
nvme_id_bË
) = {

2956 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2959 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2961 
pci_driv”
 
	gnvme_driv”
 = {

2962 .
Çme
 = "nvme",

2963 .
	gid_bË
 = 
nvme_id_bË
,

2964 .
	g´obe
 = 
nvme_´obe
,

2965 .
	g»move
 = 
nvme_»move
,

2966 .
	gsu¥’d
 = 
nvme_su¥’d
,

2967 .
	g»sume
 = 
nvme_»sume
,

2968 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2971 
__š™
 
	$nvme_š™
()

2973 
»suÉ
;

2975 
nvme_th»ad
 = 
	`kth»ad_run
(
nvme_kth»ad
, 
NULL
, "nvme");

2976 ià(
	`IS_ERR
(
nvme_th»ad
))

2977  
	`PTR_ERR
(
nvme_th»ad
);

2979 
»suÉ
 = 
	`»gi¡”_blkdev
(
nvme_majÜ
, "nvme");

2980 ià(
»suÉ
 < 0)

2981 
kl_kth»ad
;

2982 ià(
»suÉ
 > 0)

2983 
nvme_majÜ
 = 
»suÉ
;

2985 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2986 ià(
»suÉ
)

2987 
uÄegi¡”_blkdev
;

2989 
»suÉ
 = 
	`aio_£rviû_š™
();

2990 ià(
»suÉ
)

2991 
uÄegi¡”_pcidev
;

2994 
uÄegi¡”_pcidev
:

2995 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2996 
uÄegi¡”_blkdev
:

2997 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

2998 
kl_kth»ad
:

2999 
	`kth»ad_¡İ
(
nvme_th»ad
);

3000  
»suÉ
;

3001 
	}
}

3003 
__ex™
 
	$nvme_ex™
()

3005 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

3006 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

3007 
	`kth»ad_¡İ
(
nvme_th»ad
);

3009 
	`aio_£rviû_ex™
();

3011 
	}
}

3013 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

3014 
MODULE_LICENSE
("GPL");

3015 
MODULE_VERSION
("0.8");

3016 
moduË_š™
(
nvme_š™
);

3017 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10/nvme-scsi.c

24 
	~"nvme.h
"

26 
	~<lšux/nvme.h
>

28 
	~<lšux/bio.h
>

29 
	~<lšux/b™İs.h
>

30 
	~<lšux/blkdev.h
>

31 
	~<lšux/d–ay.h
>

32 
	~<lšux/”ºo.h
>

33 
	~<lšux/fs.h
>

34 
	~<lšux/g’hd.h
>

35 
	~<lšux/idr.h
>

36 
	~<lšux/š™.h
>

37 
	~<lšux/š‹¼u±.h
>

38 
	~<lšux/io.h
>

39 
	~<lšux/kdev_t.h
>

40 
	~<lšux/kth»ad.h
>

41 
	~<lšux/k”Ãl.h
>

42 
	~<lšux/mm.h
>

43 
	~<lšux/moduË.h
>

44 
	~<lšux/moduË·¿m.h
>

45 
	~<lšux/pci.h
>

46 
	~<lšux/poisÚ.h
>

47 
	~<lšux/sched.h
>

48 
	~<lšux/¦ab.h
>

49 
	~<lšux/ty³s.h
>

51 
	~"sg.h
"

52 
	~"scsi.h
"

54 
	~<scsi/sg.h
>

55 
	~<scsi/scsi.h
>

58 
	gsg_v”siÚ_num
 = 30534;

60 
	#SNTI_TRANSLATION_SUCCESS
 0

	)

61 
	#SNTI_INTERNAL_ERROR
 1

	)

64 
	#VPD_SUPPORTED_PAGES
 0x00

	)

65 
	#VPD_SERIAL_NUMBER
 0x80

	)

66 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

67 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

68 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

71 
	#REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
 6

	)

72 
	#REPORT_LUNS_SR_OFFSET
 2

	)

73 
	#READ_CAP_16_CDB_ALLOC_LENGTH_OFFSET
 10

	)

74 
	#REQUEST_SENSE_CDB_ALLOC_LENGTH_OFFSET
 4

	)

75 
	#REQUEST_SENSE_DESC_OFFSET
 1

	)

76 
	#REQUEST_SENSE_DESC_MASK
 0x01

	)

77 
	#DESCRIPTOR_FORMAT_SENSE_DATA_TYPE
 1

	)

78 
	#INQUIRY_EVPD_BYTE_OFFSET
 1

	)

79 
	#INQUIRY_PAGE_CODE_BYTE_OFFSET
 2

	)

80 
	#INQUIRY_EVPD_BIT_MASK
 1

	)

81 
	#INQUIRY_CDB_ALLOCATION_LENGTH_OFFSET
 3

	)

82 
	#START_STOP_UNIT_CDB_IMMED_OFFSET
 1

	)

83 
	#START_STOP_UNIT_CDB_IMMED_MASK
 0x1

	)

84 
	#START_STOP_UNIT_CDB_POWER_COND_MOD_OFFSET
 3

	)

85 
	#START_STOP_UNIT_CDB_POWER_COND_MOD_MASK
 0xF

	)

86 
	#START_STOP_UNIT_CDB_POWER_COND_OFFSET
 4

	)

87 
	#START_STOP_UNIT_CDB_POWER_COND_MASK
 0xF0

	)

88 
	#START_STOP_UNIT_CDB_NO_FLUSH_OFFSET
 4

	)

89 
	#START_STOP_UNIT_CDB_NO_FLUSH_MASK
 0x4

	)

90 
	#START_STOP_UNIT_CDB_START_OFFSET
 4

	)

91 
	#START_STOP_UNIT_CDB_START_MASK
 0x1

	)

92 
	#WRITE_BUFFER_CDB_MODE_OFFSET
 1

	)

93 
	#WRITE_BUFFER_CDB_MODE_MASK
 0x1F

	)

94 
	#WRITE_BUFFER_CDB_BUFFER_ID_OFFSET
 2

	)

95 
	#WRITE_BUFFER_CDB_BUFFER_OFFSET_OFFSET
 3

	)

96 
	#WRITE_BUFFER_CDB_PARM_LIST_LENGTH_OFFSET
 6

	)

97 
	#FORMAT_UNIT_CDB_FORMAT_PROT_INFO_OFFSET
 1

	)

98 
	#FORMAT_UNIT_CDB_FORMAT_PROT_INFO_MASK
 0xC0

	)

99 
	#FORMAT_UNIT_CDB_FORMAT_PROT_INFO_SHIFT
 6

	)

100 
	#FORMAT_UNIT_CDB_LONG_LIST_OFFSET
 1

	)

101 
	#FORMAT_UNIT_CDB_LONG_LIST_MASK
 0x20

	)

102 
	#FORMAT_UNIT_CDB_FORMAT_DATA_OFFSET
 1

	)

103 
	#FORMAT_UNIT_CDB_FORMAT_DATA_MASK
 0x10

	)

104 
	#FORMAT_UNIT_SHORT_PARM_LIST_LEN
 4

	)

105 
	#FORMAT_UNIT_LONG_PARM_LIST_LEN
 8

	)

106 
	#FORMAT_UNIT_PROT_INT_OFFSET
 3

	)

107 
	#FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
 0

	)

108 
	#FORMAT_UNIT_PROT_FIELD_USAGE_MASK
 0x07

	)

109 
	#UNMAP_CDB_PARAM_LIST_LENGTH_OFFSET
 7

	)

112 
	#NIBBLE_SHIFT
 4

	)

113 
	#FIXED_SENSE_DATA
 0x70

	)

114 
	#DESC_FORMAT_SENSE_DATA
 0x72

	)

115 
	#FIXED_SENSE_DATA_ADD_LENGTH
 10

	)

116 
	#LUN_ENTRY_SIZE
 8

	)

117 
	#LUN_DATA_HEADER_SIZE
 8

	)

118 
	#ALL_LUNS_RETURNED
 0x02

	)

119 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

120 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

121 
	#NVME_POWER_STATE_START_VALID
 0x00

	)

122 
	#NVME_POWER_STATE_ACTIVE
 0x01

	)

123 
	#NVME_POWER_STATE_IDLE
 0x02

	)

124 
	#NVME_POWER_STATE_STANDBY
 0x03

	)

125 
	#NVME_POWER_STATE_LU_CONTROL
 0x07

	)

126 
	#POWER_STATE_0
 0

	)

127 
	#POWER_STATE_1
 1

	)

128 
	#POWER_STATE_2
 2

	)

129 
	#POWER_STATE_3
 3

	)

130 
	#DOWNLOAD_SAVE_ACTIVATE
 0x05

	)

131 
	#DOWNLOAD_SAVE_DEFER_ACTIVATE
 0x0E

	)

132 
	#ACTIVATE_DEFERRED_MICROCODE
 0x0F

	)

133 
	#FORMAT_UNIT_IMMED_MASK
 0x2

	)

134 
	#FORMAT_UNIT_IMMED_OFFSET
 1

	)

135 
	#KELVIN_TEMP_FACTOR
 273

	)

136 
	#FIXED_FMT_SENSE_DATA_SIZE
 18

	)

137 
	#DESC_FMT_SENSE_DATA_SIZE
 8

	)

140 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

141 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

142 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

143 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

144 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

145 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

146 
	#INQ_SERIAL_NUMBER_LENGTH
 0x14

	)

147 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 5

	)

148 
	#VERSION_SPC_4
 0x06

	)

149 
	#ACA_UNSUPPORTED
 0

	)

150 
	#STANDARD_INQUIRY_LENGTH
 36

	)

151 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

152 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

153 
	#RESERVED_FIELD
 0

	)

156 
	#IO_CDB_WP_MASK
 0xE0

	)

157 
	#IO_CDB_WP_SHIFT
 5

	)

158 
	#IO_CDB_FUA_MASK
 0x8

	)

159 
	#IO_6_CDB_LBA_OFFSET
 0

	)

160 
	#IO_6_CDB_LBA_MASK
 0x001FFFFF

	)

161 
	#IO_6_CDB_TX_LEN_OFFSET
 4

	)

162 
	#IO_6_DEFAULT_TX_LEN
 256

	)

163 
	#IO_10_CDB_LBA_OFFSET
 2

	)

164 
	#IO_10_CDB_TX_LEN_OFFSET
 7

	)

165 
	#IO_10_CDB_WP_OFFSET
 1

	)

166 
	#IO_10_CDB_FUA_OFFSET
 1

	)

167 
	#IO_12_CDB_LBA_OFFSET
 2

	)

168 
	#IO_12_CDB_TX_LEN_OFFSET
 6

	)

169 
	#IO_12_CDB_WP_OFFSET
 1

	)

170 
	#IO_12_CDB_FUA_OFFSET
 1

	)

171 
	#IO_16_CDB_FUA_OFFSET
 1

	)

172 
	#IO_16_CDB_WP_OFFSET
 1

	)

173 
	#IO_16_CDB_LBA_OFFSET
 2

	)

174 
	#IO_16_CDB_TX_LEN_OFFSET
 10

	)

177 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

178 
	#MODE_PAGE_CACHING
 0x08

	)

179 
	#MODE_PAGE_CONTROL
 0x0A

	)

180 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

181 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

182 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

183 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

184 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

185 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

186 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

187 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

188 
	#MODE_PAGE_ALL_LEN
 0x54

	)

189 
	#MODE_SENSE6_MPH_SIZE
 4

	)

190 
	#MODE_SENSE6_ALLOC_LEN_OFFSET
 4

	)

191 
	#MODE_SENSE_PAGE_CONTROL_OFFSET
 2

	)

192 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

193 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

194 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

195 
	#MODE_SENSE_LLBAA_OFFSET
 1

	)

196 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

197 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

198 
	#MODE_SENSE_DBD_OFFSET
 1

	)

199 
	#MODE_SENSE_DBD_MASK
 8

	)

200 
	#MODE_SENSE_DBD_SHIFT
 3

	)

201 
	#MODE_SENSE10_MPH_SIZE
 8

	)

202 
	#MODE_SENSE10_ALLOC_LEN_OFFSET
 7

	)

203 
	#MODE_SELECT_CDB_PAGE_FORMAT_OFFSET
 1

	)

204 
	#MODE_SELECT_CDB_SAVE_PAGES_OFFSET
 1

	)

205 
	#MODE_SELECT_6_CDB_PARAM_LIST_LENGTH_OFFSET
 4

	)

206 
	#MODE_SELECT_10_CDB_PARAM_LIST_LENGTH_OFFSET
 7

	)

207 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

208 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

209 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

210 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

211 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

212 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

213 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

214 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

215 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

216 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

217 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

218 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

219 
	#SHORT_DESC_BLOCK
 8

	)

220 
	#LONG_DESC_BLOCK
 16

	)

221 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

222 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

223 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

224 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

225 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

228 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
 0x00

	)

229 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
 0x07

	)

230 
	#LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
 0x2F

	)

231 
	#LOG_PAGE_TEMPERATURE_PAGE
 0x0D

	)

232 
	#LOG_SENSE_CDB_SP_OFFSET
 1

	)

233 
	#LOG_SENSE_CDB_SP_NOT_ENABLED
 0

	)

234 
	#LOG_SENSE_CDB_PC_OFFSET
 2

	)

235 
	#LOG_SENSE_CDB_PC_MASK
 0xC0

	)

236 
	#LOG_SENSE_CDB_PC_SHIFT
 6

	)

237 
	#LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
 1

	)

238 
	#LOG_SENSE_CDB_PAGE_CODE_MASK
 0x3F

	)

239 
	#LOG_SENSE_CDB_ALLOC_LENGTH_OFFSET
 7

	)

240 
	#REMAINING_INFO_EXCP_PAGE_LENGTH
 0x8

	)

241 
	#LOG_INFO_EXCP_PAGE_LENGTH
 0xC

	)

242 
	#REMAINING_TEMP_PAGE_LENGTH
 0xC

	)

243 
	#LOG_TEMP_PAGE_LENGTH
 0x10

	)

244 
	#LOG_TEMP_UNKNOWN
 0xFF

	)

245 
	#SUPPORTED_LOG_PAGES_PAGE_LENGTH
 0x3

	)

248 
	#READ_CAP_10_RESP_SIZE
 8

	)

249 
	#READ_CAP_16_RESP_SIZE
 32

	)

252 
	#NVME_GET_SMART_LOG_PAGE
 0x02

	)

253 
	#NVME_GET_FEAT_TEMP_THRESH
 0x04

	)

254 
	#BYTES_TO_DWORDS
 4

	)

255 
	#NVME_MAX_FIRMWARE_SLOT
 7

	)

258 
	#REPORT_LUNS_FIRST_LUN_OFFSET
 8

	)

262 
	#SCSI_ASC_NO_SENSE
 0x00

	)

263 
	#SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

264 
	#SCSI_ASC_LUN_NOT_READY
 0x04

	)

265 
	#SCSI_ASC_WARNING
 0x0B

	)

266 
	#SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

267 
	#SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

268 
	#SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

269 
	#SCSI_ASC_UNRECOVERED_READ_ERROR
 0x11

	)

270 
	#SCSI_ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

271 
	#SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
 0x20

	)

272 
	#SCSI_ASC_ILLEGAL_COMMAND
 0x20

	)

273 
	#SCSI_ASC_ILLEGAL_BLOCK
 0x21

	)

274 
	#SCSI_ASC_INVALID_CDB
 0x24

	)

275 
	#SCSI_ASC_INVALID_LUN
 0x25

	)

276 
	#SCSI_ASC_INVALID_PARAMETER
 0x26

	)

277 
	#SCSI_ASC_FORMAT_COMMAND_FAILED
 0x31

	)

278 
	#SCSI_ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

282 
	#SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

283 
	#SCSI_ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

284 
	#SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

285 
	#SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

286 
	#SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

287 
	#SCSI_ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

288 
	#SCSI_ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

289 
	#SCSI_ASCQ_INVALID_LUN_ID
 0x09

	)

295 
	#DEVICE_SPECIFIC_PARAMETER
 0

	)

296 
	#VPD_ID_DESCRIPTOR_LENGTH
 (
VPD_IDENTIFICATION_DESCRIPTOR
)

	)

300 
	#GET_OPCODE
(
cdb
ècdb[0]

	)

302 
	#GET_U8_FROM_CDB
(
cdb
, 
šdex
è(cdb[šdex] << 0)

	)

304 
	#GET_U16_FROM_CDB
(
cdb
, 
šdex
è((cdb[šdex] << 8è| (cdb[šdex + 1] << 0))

	)

306 
	#GET_U24_FROM_CDB
(
cdb
, 
šdex
) ((cdb[index] << 16) | \

307 (
cdb
[
šdex
 + 1] << 8) | \

308 (
cdb
[
šdex
 + 2] << 0))

	)

310 
	#GET_U32_FROM_CDB
(
cdb
, 
šdex
) ((cdb[index] << 24) | \

311 (
cdb
[
šdex
 + 1] << 16) | \

312 (
cdb
[
šdex
 + 2] << 8) | \

313 (
cdb
[
šdex
 + 3] << 0))

	)

315 
	#GET_U64_FROM_CDB
(
cdb
, 
šdex
è((((
u64
)cdb[index]) << 56) | \

316 (((
u64
)
cdb
[
šdex
 + 1]) << 48) | \

317 (((
u64
)
cdb
[
šdex
 + 2]) << 40) | \

318 (((
u64
)
cdb
[
šdex
 + 3]) << 32) | \

319 (((
u64
)
cdb
[
šdex
 + 4]) << 24) | \

320 (((
u64
)
cdb
[
šdex
 + 5]) << 16) | \

321 (((
u64
)
cdb
[
šdex
 + 6]) << 8) | \

322 (((
u64
)
cdb
[
šdex
 + 7]è<< 0))

	)

325 
	#GET_INQ_EVPD_BIT
(
cdb
) \

326 ((
	`GET_U8_FROM_CDB
(
cdb
, 
INQUIRY_EVPD_BYTE_OFFSET
) & \

327 
INQUIRY_EVPD_BIT_MASK
è? 1 : 0)

	)

329 
	#GET_INQ_PAGE_CODE
(
cdb
) \

330 (
	`GET_U8_FROM_CDB
(
cdb
, 
INQUIRY_PAGE_CODE_BYTE_OFFSET
))

	)

332 
	#GET_INQ_ALLOC_LENGTH
(
cdb
) \

333 (
	`GET_U16_FROM_CDB
(
cdb
, 
INQUIRY_CDB_ALLOCATION_LENGTH_OFFSET
))

	)

336 
	#GET_REPORT_LUNS_ALLOC_LENGTH
(
cdb
) \

337 (
	`GET_U32_FROM_CDB
(
cdb
, 
REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
))

	)

340 
	#GET_READ_CAP_16_ALLOC_LENGTH
(
cdb
) \

341 (
	`GET_U32_FROM_CDB
(
cdb
, 
READ_CAP_16_CDB_ALLOC_LENGTH_OFFSET
))

	)

343 
	#IS_READ_CAP_16
(
cdb
) \

344 ((
cdb
[0] =ğ
SERVICE_ACTION_IN
 && cdb[1] =ğ
SAI_READ_CAPACITY_16
è? 1 : 0)

	)

347 
	#GET_REQUEST_SENSE_ALLOC_LENGTH
(
cdb
) \

348 (
	`GET_U8_FROM_CDB
(
cdb
, 
REQUEST_SENSE_CDB_ALLOC_LENGTH_OFFSET
))

	)

351 
	#GET_MODE_SENSE_DBD
(
cdb
) \

352 ((
	`GET_U8_FROM_CDB
(
cdb
, 
MODE_SENSE_DBD_OFFSET
è& 
MODE_SENSE_DBD_MASK
) >> \

353 
MODE_SENSE_DBD_SHIFT
)

	)

355 
	#GET_MODE_SENSE_LLBAA
(
cdb
) \

356 ((
	`GET_U8_FROM_CDB
(
cdb
, 
MODE_SENSE_LLBAA_OFFSET
) & \

357 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
)

	)

359 
	#GET_MODE_SENSE_MPH_SIZE
(
cdb10
) \

360 (
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
)

	)

366 
	snvme_Œªs_io_cdb
 {

367 
u8
 
	mfua
;

368 
u8
 
	m´Ù_šfo
;

369 
u64
 
	mlba
;

370 
u32
 
	mxãr_Ën
;

379 
	$nvme_Œªs_cİy_to_u£r
(
sg_io_hdr
 *
hdr
, *
äom
,

380 
n
)

382 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

383 
nÙ_cİ›d
;

384 
i
;

385 *
šdex
 = 
äom
;

386 
size_t
 
»maššg
 = 
n
;

387 
size_t
 
xãr_Ën
;

389 ià(
hdr
->
iovec_couÁ
 > 0) {

390 
sg_iovec
 
sgl
;

392 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

393 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

394 
i
 * (
sg_iovec
),

395 (
sg_iovec
));

396 ià(
nÙ_cİ›d
)

397  -
EFAULT
;

398 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

399 
nÙ_cİ›d
 = 
	`cİy_to_u£r
(
sgl
.
iov_ba£
, 
šdex
,

400 
xãr_Ën
);

401 ià(
nÙ_cİ›d
) {

402 
»s
 = -
EFAULT
;

405 
šdex
 +ğ
xãr_Ën
;

406 
»maššg
 -ğ
xãr_Ën
;

407 ià(
»maššg
 == 0)

410  
»s
;

412 
nÙ_cİ›d
 = 
	`cİy_to_u£r
(
hdr
->
dxã½
, 
äom
, 
n
);

413 ià(
nÙ_cİ›d
)

414 
»s
 = -
EFAULT
;

415  
»s
;

416 
	}
}

420 
	$nvme_Œªs_cİy_äom_u£r
(
sg_io_hdr
 *
hdr
, *
to
,

421 
n
)

423 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

424 
nÙ_cİ›d
;

425 
i
;

426 *
šdex
 = 
to
;

427 
size_t
 
»maššg
 = 
n
;

428 
size_t
 
xãr_Ën
;

430 ià(
hdr
->
iovec_couÁ
 > 0) {

431 
sg_iovec
 
sgl
;

433 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

434 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

435 
i
 * (
sg_iovec
),

436 (
sg_iovec
));

437 ià(
nÙ_cİ›d
)

438  -
EFAULT
;

439 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

440 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(
šdex
, 
sgl
.
iov_ba£
,

441 
xãr_Ën
);

442 ià(
nÙ_cİ›d
) {

443 
»s
 = -
EFAULT
;

446 
šdex
 +ğ
xãr_Ën
;

447 
»maššg
 -ğ
xãr_Ën
;

448 ià(
»maššg
 == 0)

451  
»s
;

454 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(
to
, 
hdr
->
dxã½
, 
n
);

455 ià(
nÙ_cİ›d
)

456 
»s
 = -
EFAULT
;

457  
»s
;

458 
	}
}

462 
	$nvme_Œªs_com¶‘iÚ
(
sg_io_hdr
 *
hdr
, 
u8
 
¡©us
, u8 
£n£_key
,

463 
u8
 
asc
, u8 
ascq
)

465 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

466 
u8
 
xãr_Ën
;

467 
u8
 
»¥
[
DESC_FMT_SENSE_DATA_SIZE
];

469 ià(
	`scsi_¡©us_is_good
(
¡©us
)) {

470 
hdr
->
¡©us
 = 
SAM_STAT_GOOD
;

471 
hdr
->
masked_¡©us
 = 
GOOD
;

472 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

473 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

474 
hdr
->
sb_Ën_wr
 = 0;

476 
hdr
->
¡©us
 = status;

477 
hdr
->
masked_¡©us
 = 
¡©us
 >> 1;

478 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

479 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

481 
	`mem£t
(
»¥
, 0, 
DESC_FMT_SENSE_DATA_SIZE
);

482 
»¥
[0] = 
DESC_FORMAT_SENSE_DATA
;

483 
»¥
[1] = 
£n£_key
;

484 
»¥
[2] = 
asc
;

485 
»¥
[3] = 
ascq
;

487 
xãr_Ën
 = 
	`mš_t
(
u8
, 
hdr
->
mx_sb_Ën
, 
DESC_FMT_SENSE_DATA_SIZE
);

488 
hdr
->
sb_Ën_wr
 = 
xãr_Ën
;

489 ià(
	`cİy_to_u£r
(
hdr
->
sbp
, 
»¥
, 
xãr_Ën
) > 0)

490 
»s
 = -
EFAULT
;

493  
»s
;

494 
	}
}

496 
	$nvme_Œªs_¡©us_code
(
sg_io_hdr
 *
hdr
, 
nvme_sc
)

498 
u8
 
¡©us
, 
£n£_key
, 
asc
, 
ascq
;

499 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

502 ià(
nvme_sc
 < 0)

503  
nvme_sc
;

506 
nvme_sc
 &= 0x7FF;

508 
nvme_sc
) {

510 
NVME_SC_SUCCESS
:

511 
¡©us
 = 
SAM_STAT_GOOD
;

512 
£n£_key
 = 
NO_SENSE
;

513 
asc
 = 
SCSI_ASC_NO_SENSE
;

514 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

516 
NVME_SC_INVALID_OPCODE
:

517 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

518 
£n£_key
 = 
ILLEGAL_REQUEST
;

519 
asc
 = 
SCSI_ASC_ILLEGAL_COMMAND
;

520 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

522 
NVME_SC_INVALID_FIELD
:

523 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

524 
£n£_key
 = 
ILLEGAL_REQUEST
;

525 
asc
 = 
SCSI_ASC_INVALID_CDB
;

526 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

528 
NVME_SC_DATA_XFER_ERROR
:

529 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

530 
£n£_key
 = 
MEDIUM_ERROR
;

531 
asc
 = 
SCSI_ASC_NO_SENSE
;

532 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

534 
NVME_SC_POWER_LOSS
:

535 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

536 
£n£_key
 = 
ABORTED_COMMAND
;

537 
asc
 = 
SCSI_ASC_WARNING
;

538 
ascq
 = 
SCSI_ASCQ_POWER_LOSS_EXPECTED
;

540 
NVME_SC_INTERNAL
:

541 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

542 
£n£_key
 = 
HARDWARE_ERROR
;

543 
asc
 = 
SCSI_ASC_INTERNAL_TARGET_FAILURE
;

544 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

546 
NVME_SC_ABORT_REQ
:

547 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

548 
£n£_key
 = 
ABORTED_COMMAND
;

549 
asc
 = 
SCSI_ASC_NO_SENSE
;

550 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

552 
NVME_SC_ABORT_QUEUE
:

553 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

554 
£n£_key
 = 
ABORTED_COMMAND
;

555 
asc
 = 
SCSI_ASC_NO_SENSE
;

556 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

558 
NVME_SC_FUSED_FAIL
:

559 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

560 
£n£_key
 = 
ABORTED_COMMAND
;

561 
asc
 = 
SCSI_ASC_NO_SENSE
;

562 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

564 
NVME_SC_FUSED_MISSING
:

565 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

566 
£n£_key
 = 
ABORTED_COMMAND
;

567 
asc
 = 
SCSI_ASC_NO_SENSE
;

568 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

570 
NVME_SC_INVALID_NS
:

571 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

572 
£n£_key
 = 
ILLEGAL_REQUEST
;

573 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

574 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

576 
NVME_SC_LBA_RANGE
:

577 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

578 
£n£_key
 = 
ILLEGAL_REQUEST
;

579 
asc
 = 
SCSI_ASC_ILLEGAL_BLOCK
;

580 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

582 
NVME_SC_CAP_EXCEEDED
:

583 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

584 
£n£_key
 = 
MEDIUM_ERROR
;

585 
asc
 = 
SCSI_ASC_NO_SENSE
;

586 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

588 
NVME_SC_NS_NOT_READY
:

589 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

590 
£n£_key
 = 
NOT_READY
;

591 
asc
 = 
SCSI_ASC_LUN_NOT_READY
;

592 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

596 
NVME_SC_INVALID_FORMAT
:

597 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

598 
£n£_key
 = 
ILLEGAL_REQUEST
;

599 
asc
 = 
SCSI_ASC_FORMAT_COMMAND_FAILED
;

600 
ascq
 = 
SCSI_ASCQ_FORMAT_COMMAND_FAILED
;

602 
NVME_SC_BAD_ATTRIBUTES
:

603 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

604 
£n£_key
 = 
ILLEGAL_REQUEST
;

605 
asc
 = 
SCSI_ASC_INVALID_CDB
;

606 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

610 
NVME_SC_WRITE_FAULT
:

611 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

612 
£n£_key
 = 
MEDIUM_ERROR
;

613 
asc
 = 
SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
;

614 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

616 
NVME_SC_READ_ERROR
:

617 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

618 
£n£_key
 = 
MEDIUM_ERROR
;

619 
asc
 = 
SCSI_ASC_UNRECOVERED_READ_ERROR
;

620 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

622 
NVME_SC_GUARD_CHECK
:

623 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

624 
£n£_key
 = 
MEDIUM_ERROR
;

625 
asc
 = 
SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
;

626 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
;

628 
NVME_SC_APPTAG_CHECK
:

629 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

630 
£n£_key
 = 
MEDIUM_ERROR
;

631 
asc
 = 
SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
;

632 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
;

634 
NVME_SC_REFTAG_CHECK
:

635 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

636 
£n£_key
 = 
MEDIUM_ERROR
;

637 
asc
 = 
SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
;

638 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
;

640 
NVME_SC_COMPARE_FAILED
:

641 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

642 
£n£_key
 = 
MISCOMPARE
;

643 
asc
 = 
SCSI_ASC_MISCOMPARE_DURING_VERIFY
;

644 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

646 
NVME_SC_ACCESS_DENIED
:

647 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

648 
£n£_key
 = 
ILLEGAL_REQUEST
;

649 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

650 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

654 
NVME_SC_CMDID_CONFLICT
:

655 
NVME_SC_CMD_SEQ_ERROR
:

656 
NVME_SC_CQ_INVALID
:

657 
NVME_SC_QID_INVALID
:

658 
NVME_SC_QUEUE_SIZE
:

659 
NVME_SC_ABORT_LIMIT
:

660 
NVME_SC_ABORT_MISSING
:

661 
NVME_SC_ASYNC_LIMIT
:

662 
NVME_SC_FIRMWARE_SLOT
:

663 
NVME_SC_FIRMWARE_IMAGE
:

664 
NVME_SC_INVALID_VECTOR
:

665 
NVME_SC_INVALID_LOG_PAGE
:

667 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

668 
£n£_key
 = 
ILLEGAL_REQUEST
;

669 
asc
 = 
SCSI_ASC_NO_SENSE
;

670 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

674 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
¡©us
, 
£n£_key
, 
asc
, 
ascq
);

676  
»s
;

677 
	}
}

681 
	$nvme_Œªs_¡ªd¬d_šquœy_·ge
(
nvme_ns
 *
ns
,

682 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

683 
®loc_Ën
)

685 
nvme_dev
 *
dev
 = 
ns
->dev;

686 
dma_addr_t
 
dma_addr
;

687 *
mem
;

688 
nvme_id_ns
 *
id_ns
;

689 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

690 
nvme_sc
;

691 
xãr_Ën
;

692 
u8
 
»¥_d©a_fÜm©
 = 0x02;

693 
u8
 
´Ùeù
;

694 
u8
 
cmdque
 = 0x01 << 1;

696 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

697 &
dma_addr
, 
GFP_KERNEL
);

698 ià(
mem
 =ğ
NULL
) {

699 
»s
 = -
ENOMEM
;

700 
out_dma
;

704 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

705 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

713 ià(
»s
)

714 
out_ä“
;

715 ià(
nvme_sc
) {

716 
»s
 = 
nvme_sc
;

717 
out_ä“
;

719 
id_ns
 = 
mem
;

720 (
id_ns
->
dps
è? (
´Ùeù
 = 0x01) : (protect = 0);

722 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

723 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

724 
šq_»¥Ú£
[3] = 
»¥_d©a_fÜm©
;

725 
šq_»¥Ú£
[4] = 
ADDITIONAL_STD_INQ_LENGTH
;

726 
šq_»¥Ú£
[5] = 
´Ùeù
;

727 
šq_»¥Ú£
[7] = 
cmdque
;

728 
	`¡ºıy
(&
šq_»¥Ú£
[8], "NVMe ", 8);

729 
	`¡ºıy
(&
šq_»¥Ú£
[16], 
dev
->
mod–
, 16);

730 
	`¡ºıy
(&
šq_»¥Ú£
[32], 
dev
->
fœmw¬e_»v
, 4);

732 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

733 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

735 
out_ä“
:

736 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

737 
dma_addr
);

738 
out_dma
:

739  
»s
;

740 
	}
}

742 
	$nvme_Œªs_suµÜ‹d_vpd_·ges
(
nvme_ns
 *
ns
,

743 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

744 
®loc_Ën
)

746 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

747 
xãr_Ën
;

749 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

750 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

751 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

752 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

753 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

754 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

755 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

756 
šq_»¥Ú£
[8] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

758 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

759 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

761  
»s
;

762 
	}
}

764 
	$nvme_Œªs_un™_£rŸl_·ge
(
nvme_ns
 *
ns
,

765 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

766 
®loc_Ën
)

768 
nvme_dev
 *
dev
 = 
ns
->dev;

769 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

770 
xãr_Ën
;

772 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

773 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

774 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

775 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
dev
->
£rŸl
, 
INQ_SERIAL_NUMBER_LENGTH
);

777 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

778 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

780  
»s
;

781 
	}
}

783 
	$nvme_Œªs_deviû_id_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

784 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

786 
nvme_dev
 *
dev
 = 
ns
->dev;

787 
dma_addr_t
 
dma_addr
;

788 *
mem
;

789 
nvme_id_ù¾
 *
id_ù¾
;

790 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

791 
nvme_sc
;

792 
u8
 
›“
[4];

793 
xãr_Ën
;

794 
__be32
 
tmp_id
 = 
	`ıu_to_be32
(
ns
->
ns_id
);

796 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

797 &
dma_addr
, 
GFP_KERNEL
);

798 ià(
mem
 =ğ
NULL
) {

799 
»s
 = -
ENOMEM
;

800 
out_dma
;

804 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

805 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

806 ià(
»s
)

807 
out_ä“
;

808 ià(
nvme_sc
) {

809 
»s
 = 
nvme_sc
;

810 
out_ä“
;

812 
id_ù¾
 = 
mem
;

815 
›“
[0] = 
id_ù¾
->ieee[0] << 4;

816 
›“
[1] = 
id_ù¾
->ieee[0] >> 4 | id_ctrl->ieee[1] << 4;

817 
›“
[2] = 
id_ù¾
->ieee[1] >> 4 | id_ctrl->ieee[2] << 4;

818 
›“
[3] = 
id_ù¾
->ieee[2] >> 4;

820 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

821 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

822 
šq_»¥Ú£
[3] = 20;

824 
šq_»¥Ú£
[4] = 0x01;

825 
šq_»¥Ú£
[5] = 0x03;

826 
šq_»¥Ú£
[6] = 0x00;

827 
šq_»¥Ú£
[7] = 16;

829 
šq_»¥Ú£
[8] = 0x60 | 
›“
[3];

830 
šq_»¥Ú£
[9] = 
›“
[2];

831 
šq_»¥Ú£
[10] = 
›“
[1];

832 
šq_»¥Ú£
[11] = 
›“
[0];

833 
šq_»¥Ú£
[12] = (
dev
->
pci_dev
->
v’dÜ
 & 0xFF00) >> 8;

834 
šq_»¥Ú£
[13] = (
dev
->
pci_dev
->
v’dÜ
 & 0x00FF);

835 
šq_»¥Ú£
[14] = 
dev
->
£rŸl
[0];

836 
šq_»¥Ú£
[15] = 
dev
->
£rŸl
[1];

837 
šq_»¥Ú£
[16] = 
dev
->
mod–
[0];

838 
šq_»¥Ú£
[17] = 
dev
->
mod–
[1];

839 
	`memıy
(&
šq_»¥Ú£
[18], &
tmp_id
, (
u32
));

842 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

843 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

845 
out_ä“
:

846 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

847 
dma_addr
);

848 
out_dma
:

849  
»s
;

850 
	}
}

852 
	$nvme_Œªs_ext_šq_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

853 
®loc_Ën
)

855 
u8
 *
šq_»¥Ú£
;

856 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

857 
nvme_sc
;

858 
nvme_dev
 *
dev
 = 
ns
->dev;

859 
dma_addr_t
 
dma_addr
;

860 *
mem
;

861 
nvme_id_ù¾
 *
id_ù¾
;

862 
nvme_id_ns
 *
id_ns
;

863 
xãr_Ën
;

864 
u8
 
miüocode
 = 0x80;

865 
u8
 
¥t
;

866 
u8
 
¥t_lut
[8] = {0, 0, 2, 1, 4, 6, 5, 7};

867 
u8
 
grd_chk
, 
­p_chk
, 
»f_chk
, 
´Ùeù
;

868 
u8
 
uask_sup
 = 0x20;

869 
u8
 
v_sup
;

870 
u8
 
luişr
 = 0x01;

872 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

873 ià(
šq_»¥Ú£
 =ğ
NULL
) {

874 
»s
 = -
ENOMEM
;

875 
out_mem
;

878 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

879 &
dma_addr
, 
GFP_KERNEL
);

880 ià(
mem
 =ğ
NULL
) {

881 
»s
 = -
ENOMEM
;

882 
out_dma
;

886 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

887 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

888 ià(
»s
)

889 
out_ä“
;

890 ià(
nvme_sc
) {

891 
»s
 = 
nvme_sc
;

892 
out_ä“
;

894 
id_ns
 = 
mem
;

895 
¥t
 = 
¥t_lut
[(
id_ns
->
dpc
) & 0x07] << 3;

896 (
id_ns
->
dps
è? (
´Ùeù
 = 0x01) : (protect = 0);

897 
grd_chk
 = 
´Ùeù
 << 2;

898 
­p_chk
 = 
´Ùeù
 << 1;

899 
»f_chk
 = 
´Ùeù
;

902 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

903 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

904 ià(
»s
)

905 
out_ä“
;

906 ià(
nvme_sc
) {

907 
»s
 = 
nvme_sc
;

908 
out_ä“
;

910 
id_ù¾
 = 
mem
;

911 
v_sup
 = 
id_ù¾
->
vwc
;

913 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

914 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

915 
šq_»¥Ú£
[2] = 0x00;

916 
šq_»¥Ú£
[3] = 0x3C;

917 
šq_»¥Ú£
[4] = 
miüocode
 | 
¥t
 | 
grd_chk
 | 
­p_chk
 | 
»f_chk
;

918 
šq_»¥Ú£
[5] = 
uask_sup
;

919 
šq_»¥Ú£
[6] = 
v_sup
;

920 
šq_»¥Ú£
[7] = 
luişr
;

921 
šq_»¥Ú£
[8] = 0;

922 
šq_»¥Ú£
[9] = 0;

924 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

925 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

927 
out_ä“
:

928 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

929 
dma_addr
);

930 
out_dma
:

931 
	`kä“
(
šq_»¥Ú£
);

932 
out_mem
:

933  
»s
;

934 
	}
}

936 
	$nvme_Œªs_bdev_ch¬_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

937 
®loc_Ën
)

939 
u8
 *
šq_»¥Ú£
;

940 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

941 
xãr_Ën
;

943 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

944 ià(
šq_»¥Ú£
 =ğ
NULL
) {

945 
»s
 = -
ENOMEM
;

946 
out_mem
;

949 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

950 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

951 
šq_»¥Ú£
[2] = 0x00;

952 
šq_»¥Ú£
[3] = 0x3C;

953 
šq_»¥Ú£
[4] = 0x00;

954 
šq_»¥Ú£
[5] = 0x01;

955 
šq_»¥Ú£
[6] = 0x00;

957 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

958 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

960 
	`kä“
(
šq_»¥Ú£
);

961 
out_mem
:

962  
»s
;

963 
	}
}

967 
	$nvme_Œªs_log_suµ_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

968 
®loc_Ën
)

970 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

971 
xãr_Ën
;

972 
u8
 *
log_»¥Ú£
;

974 
log_»¥Ú£
 = 
	`km®loc
(
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
, 
GFP_KERNEL
);

975 ià(
log_»¥Ú£
 =ğ
NULL
) {

976 
»s
 = -
ENOMEM
;

977 
out_mem
;

979 
	`mem£t
(
log_»¥Ú£
, 0, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

981 
log_»¥Ú£
[0] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

983 
log_»¥Ú£
[3] = 
SUPPORTED_LOG_PAGES_PAGE_LENGTH
;

984 
log_»¥Ú£
[4] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

985 
log_»¥Ú£
[5] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

986 
log_»¥Ú£
[6] = 
LOG_PAGE_TEMPERATURE_PAGE
;

988 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

989 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

991 
	`kä“
(
log_»¥Ú£
);

992 
out_mem
:

993  
»s
;

994 
	}
}

996 
	$nvme_Œªs_log_šfo_exû±iÚs
(
nvme_ns
 *
ns
,

997 
sg_io_hdr
 *
hdr
, 
®loc_Ën
)

999 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1000 
xãr_Ën
;

1001 
u8
 *
log_»¥Ú£
;

1002 
nvme_commªd
 
c
;

1003 
nvme_dev
 *
dev
 = 
ns
->dev;

1004 
nvme_sm¬t_log
 *
sm¬t_log
;

1005 
dma_addr_t
 
dma_addr
;

1006 *
mem
;

1007 
u8
 
‹mp_c
;

1008 
u16
 
‹mp_k
;

1010 
log_»¥Ú£
 = 
	`km®loc
(
LOG_INFO_EXCP_PAGE_LENGTH
, 
GFP_KERNEL
);

1011 ià(
log_»¥Ú£
 =ğ
NULL
) {

1012 
»s
 = -
ENOMEM
;

1013 
out_mem
;

1015 
	`mem£t
(
log_»¥Ú£
, 0, 
LOG_INFO_EXCP_PAGE_LENGTH
);

1017 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1018 (
nvme_sm¬t_log
),

1019 &
dma_addr
, 
GFP_KERNEL
);

1020 ià(
mem
 =ğ
NULL
) {

1021 
»s
 = -
ENOMEM
;

1022 
out_dma
;

1026 
	`mem£t
(&
c
, 0, (c));

1027 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
;

1028 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF);

1029 
c
.
commÚ
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1030 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
((((
nvme_sm¬t_log
) /

1031 
BYTES_TO_DWORDS
è<< 16è| 
NVME_GET_SMART_LOG_PAGE
);

1032 
»s
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1033 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

1034 
‹mp_c
 = 
LOG_TEMP_UNKNOWN
;

1036 
sm¬t_log
 = 
mem
;

1037 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

1038 (
sm¬t_log
->
‹m³¿tu»
[0]);

1039 
‹mp_c
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

1042 
log_»¥Ú£
[0] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

1044 
log_»¥Ú£
[3] = 
REMAINING_INFO_EXCP_PAGE_LENGTH
;

1047 
log_»¥Ú£
[6] = 0x23;

1048 
log_»¥Ú£
[7] = 0x04;

1051 
log_»¥Ú£
[10] = 
‹mp_c
;

1053 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_INFO_EXCP_PAGE_LENGTH
);

1054 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

1056 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_sm¬t_log
),

1057 
mem
, 
dma_addr
);

1058 
out_dma
:

1059 
	`kä“
(
log_»¥Ú£
);

1060 
out_mem
:

1061  
»s
;

1062 
	}
}

1064 
	$nvme_Œªs_log_‹m³¿tu»
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1065 
®loc_Ën
)

1067 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1068 
xãr_Ën
;

1069 
u8
 *
log_»¥Ú£
;

1070 
nvme_commªd
 
c
;

1071 
nvme_dev
 *
dev
 = 
ns
->dev;

1072 
nvme_sm¬t_log
 *
sm¬t_log
;

1073 
dma_addr_t
 
dma_addr
;

1074 *
mem
;

1075 
u32
 
ã©u»_»¥
;

1076 
u8
 
‹mp_c_cur
, 
‹mp_c_th»sh
;

1077 
u16
 
‹mp_k
;

1079 
log_»¥Ú£
 = 
	`km®loc
(
LOG_TEMP_PAGE_LENGTH
, 
GFP_KERNEL
);

1080 ià(
log_»¥Ú£
 =ğ
NULL
) {

1081 
»s
 = -
ENOMEM
;

1082 
out_mem
;

1084 
	`mem£t
(
log_»¥Ú£
, 0, 
LOG_TEMP_PAGE_LENGTH
);

1086 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1087 (
nvme_sm¬t_log
),

1088 &
dma_addr
, 
GFP_KERNEL
);

1089 ià(
mem
 =ğ
NULL
) {

1090 
»s
 = -
ENOMEM
;

1091 
out_dma
;

1095 
	`mem£t
(&
c
, 0, (c));

1096 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
;

1097 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF);

1098 
c
.
commÚ
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1099 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
((((
nvme_sm¬t_log
) /

1100 
BYTES_TO_DWORDS
è<< 16è| 
NVME_GET_SMART_LOG_PAGE
);

1101 
»s
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1102 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

1103 
‹mp_c_cur
 = 
LOG_TEMP_UNKNOWN
;

1105 
sm¬t_log
 = 
mem
;

1106 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

1107 (
sm¬t_log
->
‹m³¿tu»
[0]);

1108 
‹mp_c_cur
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

1112 
»s
 = 
	`nvme_g‘_ã©u»s
(
dev
, 
NVME_FEAT_TEMP_THRESH
, 0, 0,

1113 &
ã©u»_»¥
);

1114 ià(
»s
 !ğ
NVME_SC_SUCCESS
)

1115 
‹mp_c_th»sh
 = 
LOG_TEMP_UNKNOWN
;

1117 
‹mp_c_th»sh
 = (
ã©u»_»¥
 & 0xFFFFè- 
KELVIN_TEMP_FACTOR
;

1119 
log_»¥Ú£
[0] = 
LOG_PAGE_TEMPERATURE_PAGE
;

1121 
log_»¥Ú£
[3] = 
REMAINING_TEMP_PAGE_LENGTH
;

1124 
log_»¥Ú£
[6] = 0x01;

1125 
log_»¥Ú£
[7] = 0x02;

1127 
log_»¥Ú£
[9] = 
‹mp_c_cur
;

1129 
log_»¥Ú£
[11] = 0x01;

1130 
log_»¥Ú£
[12] = 0x01;

1131 
log_»¥Ú£
[13] = 0x02;

1133 
log_»¥Ú£
[15] = 
‹mp_c_th»sh
;

1135 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_TEMP_PAGE_LENGTH
);

1136 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

1138 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_sm¬t_log
),

1139 
mem
, 
dma_addr
);

1140 
out_dma
:

1141 
	`kä“
(
log_»¥Ú£
);

1142 
out_mem
:

1143  
»s
;

1144 
	}
}

1148 
	$nvme_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

1149 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

1152 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

1153  
SNTI_INTERNAL_ERROR
;

1155 ià(
cdb10
) {

1156 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

1157 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

1159 
»¥
[4] = 
Îb¯
;

1160 
»¥
[5] = 
RESERVED_FIELD
;

1161 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

1162 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

1164 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

1166 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

1169  
SNTI_TRANSLATION_SUCCESS
;

1170 
	}
}

1172 
	$nvme_Œªs_fl_blk_desc
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1173 
u8
 *
»¥
, 
Ën
, u8 
Îb¯
)

1175 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1176 
nvme_sc
;

1177 
nvme_dev
 *
dev
 = 
ns
->dev;

1178 
dma_addr_t
 
dma_addr
;

1179 *
mem
;

1180 
nvme_id_ns
 *
id_ns
;

1181 
u8
 
æbas
;

1182 
u32
 
lba_Ëngth
;

1184 ià(
Îb¯
 =ğ0 && 
Ën
 < 
MODE_PAGE_BLK_DES_LEN
)

1185  
SNTI_INTERNAL_ERROR
;

1186 ià(
Îb¯
 > 0 && 
Ën
 < 
MODE_PAGE_LLBAA_BLK_DES_LEN
)

1187  
SNTI_INTERNAL_ERROR
;

1189 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

1190 &
dma_addr
, 
GFP_KERNEL
);

1191 ià(
mem
 =ğ
NULL
) {

1192 
»s
 = -
ENOMEM
;

1193 
out
;

1197 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

1198 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1199 ià(
»s
)

1200 
out_dma
;

1201 ià(
nvme_sc
) {

1202 
»s
 = 
nvme_sc
;

1203 
out_dma
;

1205 
id_ns
 = 
mem
;

1206 
æbas
 = (
id_ns
->flbas) & 0x0F;

1207 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1209 ià(
Îb¯
 == 0) {

1210 
__be32
 
tmp_ÿp
 = 
	`ıu_to_be32
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

1212 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
 & 0x00FFFFFF);

1214 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u32
));

1215 
	`memıy
(&
»¥
[4], &
tmp_Ën
, (
u32
));

1217 
__be64
 
tmp_ÿp
 = 
	`ıu_to_be64
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

1218 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1220 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u64
));

1222 
	`memıy
(&
»¥
[12], &
tmp_Ën
, (
u32
));

1225 
out_dma
:

1226 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

1227 
dma_addr
);

1228 
out
:

1229  
»s
;

1230 
	}
}

1232 
	$nvme_Œªs_fl_cÚŒŞ_·ge
(
nvme_ns
 *
ns
,

1233 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1234 
Ën
)

1236 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

1237  
SNTI_INTERNAL_ERROR
;

1239 
»¥
[0] = 
MODE_PAGE_CONTROL
;

1240 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

1241 
»¥
[2] = 0x0E;

1243 
»¥
[3] = 0x12;

1245 
»¥
[5] = 0x40;

1247 
»¥
[8] = 0xFF;

1248 
»¥
[9] = 0xFF;

1251  
SNTI_TRANSLATION_SUCCESS
;

1252 
	}
}

1254 
	$nvme_Œªs_fl_ÿchšg_·ge
(
nvme_ns
 *
ns
,

1255 
sg_io_hdr
 *
hdr
,

1256 
u8
 *
»¥
, 
Ën
)

1258 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1259 
nvme_sc
;

1260 
nvme_dev
 *
dev
 = 
ns
->dev;

1261 
u32
 
ã©u»_»¥
;

1262 
u8
 
vwc
;

1264 ià(
Ën
 < 
MODE_PAGE_CACHING_LEN
)

1265  
SNTI_INTERNAL_ERROR
;

1267 
nvme_sc
 = 
	`nvme_g‘_ã©u»s
(
dev
, 
NVME_FEAT_VOLATILE_WC
, 0, 0,

1268 &
ã©u»_»¥
);

1269 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1270 ià(
»s
)

1271 
out
;

1272 ià(
nvme_sc
) {

1273 
»s
 = 
nvme_sc
;

1274 
out
;

1276 
vwc
 = 
ã©u»_»¥
 & 0x00000001;

1278 
»¥
[0] = 
MODE_PAGE_CACHING
;

1279 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

1280 
»¥
[2] = 
vwc
 << 2;

1282 
out
:

1283  
»s
;

1284 
	}
}

1286 
	$nvme_Œªs_fl_pow_úd_·ge
(
nvme_ns
 *
ns
,

1287 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1288 
Ën
)

1290 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1292 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

1293  
SNTI_INTERNAL_ERROR
;

1295 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

1296 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

1299  
»s
;

1300 
	}
}

1302 
	$nvme_Œªs_fl_šf_exc_·ge
(
nvme_ns
 *
ns
,

1303 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1304 
Ën
)

1306 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1308 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

1309  
SNTI_INTERNAL_ERROR
;

1311 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

1312 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

1313 
»¥
[2] = 0x88;

1316  
»s
;

1317 
	}
}

1319 
	$nvme_Œªs_fl_®l_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1320 
u8
 *
»¥
, 
Ën
)

1322 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1323 
u16
 
mode_·ges_off£t_1
 = 0;

1324 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

1326 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

1327 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

1328 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

1330 
»s
 = 
	`nvme_Œªs_fl_ÿchšg_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_1
],

1331 
MODE_PAGE_CACHING_LEN
);

1332 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1333 
out
;

1334 
»s
 = 
	`nvme_Œªs_fl_cÚŒŞ_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_2
],

1335 
MODE_PAGE_CONTROL_LEN
);

1336 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1337 
out
;

1338 
»s
 = 
	`nvme_Œªs_fl_pow_úd_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_3
],

1339 
MODE_PAGE_POW_CND_LEN
);

1340 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1341 
out
;

1342 
»s
 = 
	`nvme_Œªs_fl_šf_exc_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_4
],

1343 
MODE_PAGE_INF_EXC_LEN
);

1344 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1345 
out
;

1347 
out
:

1348  
»s
;

1349 
	}
}

1351 
šlše
 
	$nvme_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

1353 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

1355  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

1359 
	}
}

1361 
nvme_Œªs_mode_·ge_ü—‹
(
nvme_ns
 *
ns
,

1362 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
,

1363 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

1364 (*
mode_·ge_fl_func
)

1365 (
nvme_ns
 *,

1366 
sg_io_hdr
 *
hdr
, 
u8
 *, ),

1367 
u16
 
mode_·ges_tÙ_Ën
)

1369 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1370 
xãr_Ën
;

1371 
u8
 *
»¥Ú£
;

1372 
u8
 
dbd
, 
Îb¯
;

1373 
u16
 
»¥_size
;

1374 
mph_size
;

1375 
u16
 
mode_·ges_off£t_1
;

1376 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

1378 
dbd
 = 
	`GET_MODE_SENSE_DBD
(
cmd
);

1379 
Îb¯
 = 
	`GET_MODE_SENSE_LLBAA
(
cmd
);

1380 
mph_size
 = 
	`GET_MODE_SENSE_MPH_SIZE
(
cdb10
);

1381 
blk_desc_Ën
 = 
	`nvme_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

1383 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1385 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1387 
blk_desc_off£t
 = 
mph_size
;

1388 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

1390 
»¥Ú£
 = 
	`km®loc
(
»¥_size
, 
GFP_KERNEL
);

1391 ià(
»¥Ú£
 =ğ
NULL
) {

1392 
»s
 = -
ENOMEM
;

1393 
out_mem
;

1395 
	`mem£t
(
»¥Ú£
, 0, 
»¥_size
);

1397 
»s
 = 
	`nvme_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
,

1398 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

1399 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1400 
out_ä“
;

1401 ià(
blk_desc_Ën
 > 0) {

1402 
»s
 = 
	`nvme_Œªs_fl_blk_desc
(
ns
, 
hdr
,

1403 &
»¥Ú£
[
blk_desc_off£t
],

1404 
blk_desc_Ën
, 
Îb¯
);

1405 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1406 
out_ä“
;

1408 
»s
 = 
	`mode_·ge_fl_func
(
ns
, 
hdr
, &
»¥Ú£
[
mode_·ges_off£t_1
],

1409 
mode_·ges_tÙ_Ën
);

1410 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1411 
out_ä“
;

1413 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

1414 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

1416 
out_ä“
:

1417 
	`kä“
(
»¥Ú£
);

1418 
out_mem
:

1419  
»s
;

1420 
	}
}

1424 
	$nvme_Œªs_fl_»ad_ÿp
(
u8
 *
»¥Ú£
, 
nvme_id_ns
 *
id_ns
,

1425 
u8
 
cdb16
)

1427 
u8
 
æbas
;

1428 
u32
 
lba_Ëngth
;

1429 
u64
 
¾ba
;

1430 
u8
 
´Ù_’
;

1431 
u8
 
p_ty³_lut
[4] = {0, 0, 1, 2};

1432 
__be64
 
tmp_¾ba
;

1433 
__be32
 
tmp_¾ba_32
;

1434 
__be32
 
tmp_Ën
;

1436 
æbas
 = (
id_ns
->flbas) & 0x0F;

1437 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1438 
¾ba
 = 
	`Ë64_to_ıup
(&
id_ns
->
nsze
) - 1;

1439 (
id_ns
->
dps
è? (
´Ù_’
 = 0x01) : (prot_en = 0);

1441 ià(!
cdb16
) {

1442 ià(
¾ba
 > 0xFFFFFFFF)

1443 
¾ba
 = 0xFFFFFFFF;

1444 
tmp_¾ba_32
 = 
	`ıu_to_be32
(
¾ba
);

1445 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1446 
	`memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

1447 
	`memıy
(&
»¥Ú£
[4], &
tmp_Ën
, (
u32
));

1449 
tmp_¾ba
 = 
	`ıu_to_be64
(
¾ba
);

1450 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1451 
	`memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

1452 
	`memıy
(&
»¥Ú£
[8], &
tmp_Ën
, (
u32
));

1453 
»¥Ú£
[12] = (
p_ty³_lut
[
id_ns
->
dps
 & 0x3] << 1è| 
´Ù_’
;

1458 
	}
}

1462 
	$nvme_Œªs_pow”_¡©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1463 
u8
 
pc
, u8 
pcmod
, u8 
¡¬t
)

1465 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1466 
nvme_sc
;

1467 
nvme_dev
 *
dev
 = 
ns
->dev;

1468 
dma_addr_t
 
dma_addr
;

1469 *
mem
;

1470 
nvme_id_ù¾
 *
id_ù¾
;

1471 
lowe¡_pow_¡
;

1472 
ps_desœed
 = 0;

1475 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1476 (
nvme_id_ù¾
),

1477 &
dma_addr
, 
GFP_KERNEL
);

1478 ià(
mem
 =ğ
NULL
) {

1479 
»s
 = -
ENOMEM
;

1480 
out
;

1482 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

1483 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1484 ià(
»s
)

1485 
out_dma
;

1486 ià(
nvme_sc
) {

1487 
»s
 = 
nvme_sc
;

1488 
out_dma
;

1490 
id_ù¾
 = 
mem
;

1491 
lowe¡_pow_¡
 = 
id_ù¾
->
Åss
 - 1;

1493 
pc
) {

1494 
NVME_POWER_STATE_START_VALID
:

1496 ià(
pcmod
 =ğ0 && 
¡¬t
 == 0x1)

1497 
ps_desœed
 = 
POWER_STATE_0
;

1498 ià(
pcmod
 =ğ0 && 
¡¬t
 == 0x0)

1499 
ps_desœed
 = 
lowe¡_pow_¡
;

1501 
NVME_POWER_STATE_ACTIVE
:

1503 ià(
pcmod
 == 0)

1504 
ps_desœed
 = 
POWER_STATE_0
;

1506 
NVME_POWER_STATE_IDLE
:

1509 ià(
pcmod
 == 0x0)

1510 
ps_desœed
 = 
	`mš
(
POWER_STATE_1
, (
lowe¡_pow_¡
 - 1));

1511 ià(
pcmod
 == 0x1)

1512 
ps_desœed
 = 
	`mš
(
POWER_STATE_2
, (
lowe¡_pow_¡
 - 1));

1513 ià(
pcmod
 == 0x2)

1514 
ps_desœed
 = 
	`mš
(
POWER_STATE_3
, (
lowe¡_pow_¡
 - 1));

1516 
NVME_POWER_STATE_STANDBY
:

1518 ià(
pcmod
 == 0x0)

1519 
ps_desœed
 = 
	`max
(0, (
lowe¡_pow_¡
 - 2));

1520 ià(
pcmod
 == 0x1)

1521 
ps_desœed
 = 
	`max
(0, (
lowe¡_pow_¡
 - 1));

1523 
NVME_POWER_STATE_LU_CONTROL
:

1525 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1526 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1527 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1530 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
dev
, 
NVME_FEAT_POWER_MGMT
, 
ps_desœed
, 0,

1531 
NULL
);

1532 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1533 ià(
»s
)

1534 
out_dma
;

1535 ià(
nvme_sc
)

1536 
»s
 = 
nvme_sc
;

1537 
out_dma
:

1538 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ù¾
), 
mem
,

1539 
dma_addr
);

1540 
out
:

1541  
»s
;

1542 
	}
}

1547 
	$nvme_Œªs_£nd_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1548 
u8
 
İcode
, 
u32
 
tÙ_Ën
, u32 
off£t
,

1549 
u8
 
bufãr_id
)

1551 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1552 
nvme_sc
;

1553 
nvme_dev
 *
dev
 = 
ns
->dev;

1554 
nvme_commªd
 
c
;

1555 
nvme_iod
 *
iod
 = 
NULL
;

1556 
Ëngth
;

1558 
	`mem£t
(&
c
, 0, (c));

1559 
c
.
commÚ
.
İcode
 = opcode;

1560 ià(
İcode
 =ğ
nvme_admš_dowÆßd_fw
) {

1561 ià(
hdr
->
iovec_couÁ
 > 0) {

1563 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1564 
SAM_STAT_CHECK_CONDITION
,

1565 
ILLEGAL_REQUEST
,

1566 
SCSI_ASC_INVALID_CDB
,

1567 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1568 
out
;

1570 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
, 
DMA_TO_DEVICE
,

1571 ()
hdr
->
dxã½
, 
tÙ_Ën
);

1572 ià(
	`IS_ERR
(
iod
)) {

1573 
»s
 = 
	`PTR_ERR
(
iod
);

1574 
out
;

1576 
Ëngth
 = 
	`nvme_£tup_´ps
(
dev
, &
c
.
commÚ
, 
iod
, 
tÙ_Ën
,

1577 
GFP_KERNEL
);

1578 ià(
Ëngth
 !ğ
tÙ_Ën
) {

1579 
»s
 = -
ENOMEM
;

1580 
out_unm­
;

1583 
c
.
dlfw
.
numd
 = 
	`ıu_to_Ë32
((
tÙ_Ën
/
BYTES_TO_DWORDS
) - 1);

1584 
c
.
dlfw
.
off£t
 = 
	`ıu_to_Ë32
(off£t/
BYTES_TO_DWORDS
);

1585 } ià(
İcode
 =ğ
nvme_admš_aùiv©e_fw
) {

1586 
u32
 
cdw10
 = 
bufãr_id
 | 
NVME_FWACT_REPL_ACTV
;

1587 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

1590 
nvme_sc
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1591 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1592 ià(
»s
)

1593 
out_unm­
;

1594 ià(
nvme_sc
)

1595 
»s
 = 
nvme_sc
;

1597 
out_unm­
:

1598 ià(
İcode
 =ğ
nvme_admš_dowÆßd_fw
) {

1599 
	`nvme_unm­_u£r_·ges
(
dev
, 
DMA_TO_DEVICE
, 
iod
);

1600 
	`nvme_ä“_iod
(
dev
, 
iod
);

1602 
out
:

1603  
»s
;

1604 
	}
}

1608 
šlše
 
	$nvme_Œªs_mode£l_g‘_bd_Ën
(
u8
 *
·rm_li¡
, u8 
cdb10
,

1609 
u16
 *
bd_Ën
, 
u8
 *
Îb¯
)

1611 ià(
cdb10
) {

1613 *
bd_Ën
 = (
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
] << 8) +

1614 
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
 + 1];

1615 *
Îb¯
 = 
·rm_li¡
[
MODE_SELECT_10_LLBAA_OFFSET
] &&

1616 
MODE_SELECT_10_LLBAA_MASK
;

1619 *
bd_Ën
 = 
·rm_li¡
[
MODE_SELECT_6_BD_OFFSET
];

1621 
	}
}

1623 
	$nvme_Œªs_mode£l_§ve_bd
(
nvme_ns
 *
ns
, 
u8
 *
·rm_li¡
,

1624 
u16
 
idx
, u16 
bd_Ën
, 
u8
 
Îb¯
)

1626 
u16
 
bd_num
;

1628 
bd_num
 = 
bd_Ën
 / ((
Îb¯
 == 0) ?

1629 
SHORT_DESC_BLOCK
 : 
LONG_DESC_BLOCK
);

1632 ià(
Îb¯
 == 0) {

1634 
ns
->
mode_£Ëù_num_blocks
 =

1635 (
·rm_li¡
[
idx
 + 1] << 16) +

1636 (
·rm_li¡
[
idx
 + 2] << 8) +

1637 (
·rm_li¡
[
idx
 + 3]);

1639 
ns
->
mode_£Ëù_block_Ën
 =

1640 (
·rm_li¡
[
idx
 + 5] << 16) +

1641 (
·rm_li¡
[
idx
 + 6] << 8) +

1642 (
·rm_li¡
[
idx
 + 7]);

1645 
ns
->
mode_£Ëù_num_blocks
 =

1646 (((
u64
)
·rm_li¡
[
idx
 + 0]) << 56) +

1647 (((
u64
)
·rm_li¡
[
idx
 + 1]) << 48) +

1648 (((
u64
)
·rm_li¡
[
idx
 + 2]) << 40) +

1649 (((
u64
)
·rm_li¡
[
idx
 + 3]) << 32) +

1650 (((
u64
)
·rm_li¡
[
idx
 + 4]) << 24) +

1651 (((
u64
)
·rm_li¡
[
idx
 + 5]) << 16) +

1652 (((
u64
)
·rm_li¡
[
idx
 + 6]) << 8) +

1653 ((
u64
)
·rm_li¡
[
idx
 + 7]);

1655 
ns
->
mode_£Ëù_block_Ën
 =

1656 (
·rm_li¡
[
idx
 + 12] << 24) +

1657 (
·rm_li¡
[
idx
 + 13] << 16) +

1658 (
·rm_li¡
[
idx
 + 14] << 8) +

1659 (
·rm_li¡
[
idx
 + 15]);

1661 
	}
}

1663 
	$nvme_Œªs_mode£l_g‘_mp
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1664 
u8
 *
mode_·ge
, u8 
·ge_code
)

1666 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1667 
nvme_sc
;

1668 
nvme_dev
 *
dev
 = 
ns
->dev;

1669 
dwÜd11
;

1671 
·ge_code
) {

1672 
MODE_PAGE_CACHING
:

1673 
dwÜd11
 = ((
mode_·ge
[2] & 
CACHING_MODE_PAGE_WCE_MASK
) ? 1 : 0);

1674 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
dev
, 
NVME_FEAT_VOLATILE_WC
, 
dwÜd11
,

1675 0, 
NULL
);

1676 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1677 ià(
»s
)

1679 ià(
nvme_sc
) {

1680 
»s
 = 
nvme_sc
;

1684 
MODE_PAGE_CONTROL
:

1686 
MODE_PAGE_POWER_CONDITION
:

1688 ià((
mode_·ge
[2] & 0x01) != 0 || (mode_page[3] & 0x0F) != 0) {

1689 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1690 
SAM_STAT_CHECK_CONDITION
,

1691 
ILLEGAL_REQUEST
,

1692 
SCSI_ASC_INVALID_PARAMETER
,

1693 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1694 ià(!
»s
)

1695 
»s
 = 
SNTI_INTERNAL_ERROR
;

1700 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1701 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1702 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1703 ià(!
»s
)

1704 
»s
 = 
SNTI_INTERNAL_ERROR
;

1708  
»s
;

1709 
	}
}

1711 
	$nvme_Œªs_mode£l_d©a
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1712 
u8
 *
cmd
, 
u16
 
·rm_li¡_Ën
, u8 
pf
,

1713 
u8
 
¥
, u8 
cdb10
)

1715 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1716 
u8
 *
·rm_li¡
;

1717 
u16
 
bd_Ën
;

1718 
u8
 
Îb¯
 = 0;

1719 
u16
 
šdex
, 
§ved_šdex
;

1720 
u8
 
·ge_code
;

1721 
u16
 
mp_size
;

1724 
·rm_li¡
 = 
	`km®loc
(
·rm_li¡_Ën
, 
GFP_KERNEL
);

1725 ià(
·rm_li¡
 =ğ
NULL
) {

1726 
»s
 = -
ENOMEM
;

1727 
out
;

1730 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
·rm_li¡_Ën
);

1731 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1732 
out_mem
;

1734 
	`nvme_Œªs_mode£l_g‘_bd_Ën
(
·rm_li¡
, 
cdb10
, &
bd_Ën
, &
Îb¯
);

1735 
šdex
 = (
cdb10
è? (
MODE_SELECT_10_MPH_SIZE
è: (
MODE_SELECT_6_MPH_SIZE
);

1737 ià(
bd_Ën
 != 0) {

1739 
	`nvme_Œªs_mode£l_§ve_bd
(
ns
, 
·rm_li¡
, 
šdex
, 
bd_Ën
, 
Îb¯
);

1740 
šdex
 +ğ
bd_Ën
;

1742 
§ved_šdex
 = 
šdex
;

1747 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1748 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1749 ià((
·ge_code
 !ğ
MODE_PAGE_CACHING
) &&

1750 (
·ge_code
 !ğ
MODE_PAGE_CONTROL
) &&

1751 (
·ge_code
 !ğ
MODE_PAGE_POWER_CONDITION
)) {

1752 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1753 
SAM_STAT_CHECK_CONDITION
,

1754 
ILLEGAL_REQUEST
,

1755 
SCSI_ASC_INVALID_CDB
,

1756 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1757 
out_mem
;

1759 
šdex
 +ğ
mp_size
;

1760 } 
šdex
 < 
·rm_li¡_Ën
);

1763 
šdex
 = 
§ved_šdex
;

1765 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1766 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1767 
»s
 = 
	`nvme_Œªs_mode£l_g‘_mp
(
ns
, 
hdr
, &
·rm_li¡
[
šdex
],

1768 
·ge_code
);

1769 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1771 
šdex
 +ğ
mp_size
;

1772 } 
šdex
 < 
·rm_li¡_Ën
);

1774 
out_mem
:

1775 
	`kä“
(
·rm_li¡
);

1776 
out
:

1777  
»s
;

1778 
	}
}

1782 
	$nvme_Œªs_fmt_£t_blk_size_couÁ
(
nvme_ns
 *
ns
,

1783 
sg_io_hdr
 *
hdr
)

1785 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1786 
nvme_sc
;

1787 
nvme_dev
 *
dev
 = 
ns
->dev;

1788 
dma_addr_t
 
dma_addr
;

1789 *
mem
;

1790 
nvme_id_ns
 *
id_ns
;

1791 
u8
 
æbas
;

1800 ià(
ns
->
mode_£Ëù_num_blocks
 =ğ0 ||‚s->
mode_£Ëù_block_Ën
 == 0) {

1801 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

1802 (
nvme_id_ns
), &
dma_addr
, 
GFP_KERNEL
);

1803 ià(
mem
 =ğ
NULL
) {

1804 
»s
 = -
ENOMEM
;

1805 
out
;

1808 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

1809 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1810 ià(
»s
)

1811 
out_dma
;

1812 ià(
nvme_sc
) {

1813 
»s
 = 
nvme_sc
;

1814 
out_dma
;

1816 
id_ns
 = 
mem
;

1818 ià(
ns
->
mode_£Ëù_num_blocks
 == 0)

1819 
ns
->
mode_£Ëù_num_blocks
 = 
	`Ë64_to_ıu
(
id_ns
->
nÿp
);

1820 ià(
ns
->
mode_£Ëù_block_Ën
 == 0) {

1821 
æbas
 = (
id_ns
->flbas) & 0x0F;

1822 
ns
->
mode_£Ëù_block_Ën
 =

1823 (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1825 
out_dma
:

1826 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

1827 
mem
, 
dma_addr
);

1829 
out
:

1830  
»s
;

1831 
	}
}

1833 
	$nvme_Œªs_fmt_g‘_·rm_h—d”
(
sg_io_hdr
 *
hdr
, 
u8
 
Ën
,

1834 
u8
 
fÜm©_´Ù_šfo
, u8 *
nvme_pf_code
)

1836 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1837 
u8
 *
·rm_li¡
;

1838 
u8
 
pf_u§ge
, 
pf_code
;

1840 
·rm_li¡
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1841 ià(
·rm_li¡
 =ğ
NULL
) {

1842 
»s
 = -
ENOMEM
;

1843 
out
;

1845 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
Ën
);

1846 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

1847 
out_mem
;

1849 ià((
·rm_li¡
[
FORMAT_UNIT_IMMED_OFFSET
] &

1850 
FORMAT_UNIT_IMMED_MASK
) != 0) {

1851 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1852 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1853 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1854 
out_mem
;

1857 ià(
Ën
 =ğ
FORMAT_UNIT_LONG_PARM_LIST_LEN
 &&

1858 (
·rm_li¡
[
FORMAT_UNIT_PROT_INT_OFFSET
] & 0x0F) != 0) {

1859 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1860 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1861 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1862 
out_mem
;

1864 
pf_u§ge
 = 
·rm_li¡
[
FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
] &

1865 
FORMAT_UNIT_PROT_FIELD_USAGE_MASK
;

1866 
pf_code
 = (
pf_u§ge
 << 2è| 
fÜm©_´Ù_šfo
;

1867 
pf_code
) {

1869 *
nvme_pf_code
 = 0;

1872 *
nvme_pf_code
 = 1;

1875 *
nvme_pf_code
 = 2;

1878 *
nvme_pf_code
 = 3;

1881 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1882 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1883 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1887 
out_mem
:

1888 
	`kä“
(
·rm_li¡
);

1889 
out
:

1890  
»s
;

1891 
	}
}

1893 
	$nvme_Œªs_fmt_£nd_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1894 
u8
 
´Ù_šfo
)

1896 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

1897 
nvme_sc
;

1898 
nvme_dev
 *
dev
 = 
ns
->dev;

1899 
dma_addr_t
 
dma_addr
;

1900 *
mem
;

1901 
nvme_id_ns
 *
id_ns
;

1902 
u8
 
i
;

1903 
u8
 
æbas
, 
Æbaf
;

1904 
u8
 
£Ëùed_lbaf
 = 0xFF;

1905 
u32
 
cdw10
 = 0;

1906 
nvme_commªd
 
c
;

1909 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

1910 &
dma_addr
, 
GFP_KERNEL
);

1911 ià(
mem
 =ğ
NULL
) {

1912 
»s
 = -
ENOMEM
;

1913 
out
;

1916 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

1917 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1918 ià(
»s
)

1919 
out_dma
;

1920 ià(
nvme_sc
) {

1921 
»s
 = 
nvme_sc
;

1922 
out_dma
;

1924 
id_ns
 = 
mem
;

1925 
æbas
 = (
id_ns
->flbas) & 0x0F;

1926 
Æbaf
 = 
id_ns
->nlbaf;

1928 
i
 = 0; i < 
Æbaf
; i++) {

1929 ià(
ns
->
mode_£Ëù_block_Ën
 =ğ(1 << (
id_ns
->
lbaf
[
i
].
ds
))) {

1930 
£Ëùed_lbaf
 = 
i
;

1934 ià(
£Ëùed_lbaf
 > 0x0F) {

1935 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1936 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1937 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1939 ià(
ns
->
mode_£Ëù_num_blocks
 !ğ
	`Ë64_to_ıu
(
id_ns
->
nÿp
)) {

1940 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1941 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1942 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1945 
cdw10
 |ğ
´Ù_šfo
 << 5;

1946 
cdw10
 |ğ
£Ëùed_lbaf
 & 0x0F;

1947 
	`mem£t
(&
c
, 0, (c));

1948 
c
.
fÜm©
.
İcode
 = 
nvme_admš_fÜm©_nvm
;

1949 
c
.
fÜm©
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1950 
c
.
fÜm©
.
cdw10
 = 
	`ıu_to_Ë32
(cdw10);

1952 
nvme_sc
 = 
	`nvme_subm™_admš_cmd
(
dev
, &
c
, 
NULL
);

1953 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1954 ià(
»s
)

1955 
out_dma
;

1956 ià(
nvme_sc
)

1957 
»s
 = 
nvme_sc
;

1959 
out_dma
:

1960 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

1961 
dma_addr
);

1962 
out
:

1963  
»s
;

1964 
	}
}

1968 
šlše
 
	$nvme_Œªs_g‘_io_cdb6
(
u8
 *
cmd
,

1969 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1971 
cdb_šfo
->
fua
 = 0;

1972 
cdb_šfo
->
´Ù_šfo
 = 0;

1973 
cdb_šfo
->
lba
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_6_CDB_LBA_OFFSET
) &

1974 
IO_6_CDB_LBA_MASK
;

1975 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_6_CDB_TX_LEN_OFFSET
);

1978 ià(
cdb_šfo
->
xãr_Ën
 == 0)

1979 
cdb_šfo
->
xãr_Ën
 = 
IO_6_DEFAULT_TX_LEN
;

1980 
	}
}

1982 
šlše
 
	$nvme_Œªs_g‘_io_cdb10
(
u8
 *
cmd
,

1983 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1985 
cdb_šfo
->
fua
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_10_CDB_FUA_OFFSET
) &

1986 
IO_CDB_FUA_MASK
;

1987 
cdb_šfo
->
´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_10_CDB_WP_OFFSET
) &

1988 
IO_CDB_WP_MASK
 >> 
IO_CDB_WP_SHIFT
;

1989 
cdb_šfo
->
lba
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_10_CDB_LBA_OFFSET
);

1990 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
, 
IO_10_CDB_TX_LEN_OFFSET
);

1991 
	}
}

1993 
šlše
 
	$nvme_Œªs_g‘_io_cdb12
(
u8
 *
cmd
,

1994 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1996 
cdb_šfo
->
fua
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_12_CDB_FUA_OFFSET
) &

1997 
IO_CDB_FUA_MASK
;

1998 
cdb_šfo
->
´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_12_CDB_WP_OFFSET
) &

1999 
IO_CDB_WP_MASK
 >> 
IO_CDB_WP_SHIFT
;

2000 
cdb_šfo
->
lba
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_12_CDB_LBA_OFFSET
);

2001 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_12_CDB_TX_LEN_OFFSET
);

2002 
	}
}

2004 
šlše
 
	$nvme_Œªs_g‘_io_cdb16
(
u8
 *
cmd
,

2005 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

2007 
cdb_šfo
->
fua
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_16_CDB_FUA_OFFSET
) &

2008 
IO_CDB_FUA_MASK
;

2009 
cdb_šfo
->
´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
IO_16_CDB_WP_OFFSET
) &

2010 
IO_CDB_WP_MASK
 >> 
IO_CDB_WP_SHIFT
;

2011 
cdb_šfo
->
lba
 = 
	`GET_U64_FROM_CDB
(
cmd
, 
IO_16_CDB_LBA_OFFSET
);

2012 
cdb_šfo
->
xãr_Ën
 = 
	`GET_U32_FROM_CDB
(
cmd
, 
IO_16_CDB_TX_LEN_OFFSET
);

2013 
	}
}

2015 
šlše
 
u32
 
	$nvme_Œªs_io_g‘_num_cmds
(
sg_io_hdr
 *
hdr
,

2016 
nvme_Œªs_io_cdb
 *
cdb_šfo
,

2017 
u32
 
max_blocks
)

2020 ià(
hdr
->
iovec_couÁ
 > 0)

2021  
hdr
->
iovec_couÁ
;

2022 ià(
cdb_šfo
->
xãr_Ën
 > 
max_blocks
)

2023  ((
cdb_šfo
->
xãr_Ën
 - 1è/ 
max_blocks
) + 1;

2026 
	}
}

2028 
u16
 
	$nvme_Œªs_io_g‘_cÚŒŞ
(
nvme_ns
 *
ns
,

2029 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

2031 
u16
 
cÚŒŞ
 = 0;

2035 ià(
cdb_šfo
->
fua
 > 0)

2036 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

2038  
cÚŒŞ
;

2039 
	}
}

2041 
	$nvme_Œªs_do_nvme_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2042 
nvme_Œªs_io_cdb
 *
cdb_šfo
, 
u8
 
is_wr™e
)

2044 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2045 
nvme_sc
;

2046 
nvme_dev
 *
dev
 = 
ns
->dev;

2047 
nvme_queue
 *
nvmeq
;

2048 
u32
 
num_cmds
;

2049 
nvme_iod
 *
iod
;

2050 
u64
 
un™_Ën
;

2051 
u64
 
un™_num_blocks
;

2052 
u32
 
»tcode
;

2053 
u32
 
i
 = 0;

2054 
u64
 
nvme_off£t
 = 0;

2055 
__u£r
 *
Ãxt_m­pšg_addr
;

2056 
nvme_commªd
 
c
;

2057 
u8
 
İcode
 = (
is_wr™e
 ? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

2058 
u16
 
cÚŒŞ
;

2059 
u32
 
max_blocks
 = 
	`nvme_block_Ä
(
ns
, 
dev
->
max_hw_£ùÜs
);

2061 
num_cmds
 = 
	`nvme_Œªs_io_g‘_num_cmds
(
hdr
, 
cdb_šfo
, 
max_blocks
);

2072 
i
 = 0; i < 
num_cmds
; i++) {

2073 
	`mem£t
(&
c
, 0, (c));

2074 ià(
hdr
->
iovec_couÁ
 > 0) {

2075 
sg_iovec
 
sgl
;

2077 
»tcode
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

2078 
i
 * (
sg_iovec
),

2079 (
sg_iovec
));

2080 ià(
»tcode
)

2081  -
EFAULT
;

2082 
un™_Ën
 = 
sgl
.
iov_Ën
;

2083 
un™_num_blocks
 = 
un™_Ën
 >> 
ns
->
lba_shiá
;

2084 
Ãxt_m­pšg_addr
 = 
sgl
.
iov_ba£
;

2086 
un™_num_blocks
 = 
	`mš
((
u64
)
max_blocks
,

2087 (
cdb_šfo
->
xãr_Ën
 - 
nvme_off£t
));

2088 
un™_Ën
 = 
un™_num_blocks
 << 
ns
->
lba_shiá
;

2089 
Ãxt_m­pšg_addr
 = 
hdr
->
dxã½
 +

2090 ((1 << 
ns
->
lba_shiá
è* 
nvme_off£t
);

2093 
c
.
rw
.
İcode
 = opcode;

2094 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2095 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
cdb_šfo
->
lba
 + 
nvme_off£t
);

2096 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
un™_num_blocks
 - 1);

2097 
cÚŒŞ
 = 
	`nvme_Œªs_io_g‘_cÚŒŞ
(
ns
, 
cdb_šfo
);

2098 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

2100 
iod
 = 
	`nvme_m­_u£r_·ges
(
dev
,

2101 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2102 ()
Ãxt_m­pšg_addr
, 
un™_Ën
);

2103 ià(
	`IS_ERR
(
iod
)) {

2104 
»s
 = 
	`PTR_ERR
(
iod
);

2105 
out
;

2107 
»tcode
 = 
	`nvme_£tup_´ps
(
dev
, &
c
.
commÚ
, 
iod
, 
un™_Ën
,

2108 
GFP_KERNEL
);

2109 ià(
»tcode
 !ğ
un™_Ën
) {

2110 
	`nvme_unm­_u£r_·ges
(
dev
,

2111 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2112 
iod
);

2113 
	`nvme_ä“_iod
(
dev
, 
iod
);

2114 
»s
 = -
ENOMEM
;

2115 
out
;

2118 
nvme_off£t
 +ğ
un™_num_blocks
;

2120 
nvmeq
 = 
	`g‘_nvmeq
(
dev
);

2129 
	`put_nvmeq
(
nvmeq
);

2130 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
nvmeq
, &
c
, 
NULL
,

2131 
NVME_IO_TIMEOUT
);

2132 ià(
nvme_sc
 !ğ
NVME_SC_SUCCESS
) {

2133 
	`nvme_unm­_u£r_·ges
(
dev
,

2134 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2135 
iod
);

2136 
	`nvme_ä“_iod
(
dev
, 
iod
);

2137 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2138 
out
;

2140 
	`nvme_unm­_u£r_·ges
(
dev
,

2141 (
is_wr™e
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
,

2142 
iod
);

2143 
	`nvme_ä“_iod
(
dev
, 
iod
);

2145 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2147 
out
:

2148  
»s
;

2149 
	}
}

2154 
	$nvme_Œªs_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
, 
u8
 
is_wr™e
,

2155 
u8
 *
cmd
)

2157 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2158 
nvme_Œªs_io_cdb
 
cdb_šfo
;

2159 
u8
 
İcode
 = 
cmd
[0];

2160 
u64
 
xãr_by‹s
;

2161 
u64
 
sum_iov_Ën
 = 0;

2162 
sg_iovec
 
sgl
;

2163 
i
;

2164 
size_t
 
nÙ_cİ›d
;

2167 
İcode
) {

2168 
WRITE_6
:

2169 
READ_6
:

2170 
	`nvme_Œªs_g‘_io_cdb6
(
cmd
, &
cdb_šfo
);

2172 
WRITE_10
:

2173 
READ_10
:

2174 
	`nvme_Œªs_g‘_io_cdb10
(
cmd
, &
cdb_šfo
);

2176 
WRITE_12
:

2177 
READ_12
:

2178 
	`nvme_Œªs_g‘_io_cdb12
(
cmd
, &
cdb_šfo
);

2180 
WRITE_16
:

2181 
READ_16
:

2182 
	`nvme_Œªs_g‘_io_cdb16
(
cmd
, &
cdb_šfo
);

2186 
»s
 = 
SNTI_INTERNAL_ERROR
;

2187 
out
;

2191 ià(
hdr
->
iovec_couÁ
 > 0) {

2192 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

2193 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

2194 
i
 * (
sg_iovec
),

2195 (
sg_iovec
));

2196 ià(
nÙ_cİ›d
)

2197  -
EFAULT
;

2198 
sum_iov_Ën
 +ğ
sgl
.
iov_Ën
;

2200 ià(
sgl
.
iov_Ën
 % (1 << 
ns
->
lba_shiá
) != 0) {

2201 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2202 
SAM_STAT_CHECK_CONDITION
,

2203 
ILLEGAL_REQUEST
,

2204 
SCSI_ASC_INVALID_PARAMETER
,

2205 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2206 
out
;

2210 
sum_iov_Ën
 = 
hdr
->
dxãr_Ën
;

2214 
xãr_by‹s
 = 
	`mš
(((
u64
)
hdr
->
dxãr_Ën
), 
sum_iov_Ën
);

2217 ià(
xãr_by‹s
 !ğ(
cdb_šfo
.
xãr_Ën
 << 
ns
->
lba_shiá
)) {

2218 
»s
 = -
EINVAL
;

2219 
out
;

2223 ià(
cdb_šfo
.
xãr_Ën
 == 0)

2224 
out
;

2227 
»s
 = 
	`nvme_Œªs_do_nvme_io
(
ns
, 
hdr
, &
cdb_šfo
, 
is_wr™e
);

2228 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2229 
out
;

2231 
out
:

2232  
»s
;

2233 
	}
}

2235 
	$nvme_Œªs_šquœy
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2236 
u8
 *
cmd
)

2238 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2239 
u8
 
evpd
;

2240 
u8
 
·ge_code
;

2241 
®loc_Ën
;

2242 
u8
 *
šq_»¥Ú£
;

2244 
evpd
 = 
	`GET_INQ_EVPD_BIT
(
cmd
);

2245 
·ge_code
 = 
	`GET_INQ_PAGE_CODE
(
cmd
);

2246 
®loc_Ën
 = 
	`GET_INQ_ALLOC_LENGTH
(
cmd
);

2248 
šq_»¥Ú£
 = 
	`km®loc
(
STANDARD_INQUIRY_LENGTH
, 
GFP_KERNEL
);

2249 ià(
šq_»¥Ú£
 =ğ
NULL
) {

2250 
»s
 = -
ENOMEM
;

2251 
out_mem
;

2254 ià(
evpd
 == 0) {

2255 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

2256 
»s
 = 
	`nvme_Œªs_¡ªd¬d_šquœy_·ge
(
ns
, 
hdr
,

2257 
šq_»¥Ú£
, 
®loc_Ën
);

2259 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2260 
SAM_STAT_CHECK_CONDITION
,

2261 
ILLEGAL_REQUEST
,

2262 
SCSI_ASC_INVALID_CDB
,

2263 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2266 
·ge_code
) {

2267 
VPD_SUPPORTED_PAGES
:

2268 
»s
 = 
	`nvme_Œªs_suµÜ‹d_vpd_·ges
(
ns
, 
hdr
,

2269 
šq_»¥Ú£
, 
®loc_Ën
);

2271 
VPD_SERIAL_NUMBER
:

2272 
»s
 = 
	`nvme_Œªs_un™_£rŸl_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

2273 
®loc_Ën
);

2275 
VPD_DEVICE_IDENTIFIERS
:

2276 
»s
 = 
	`nvme_Œªs_deviû_id_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

2277 
®loc_Ën
);

2279 
VPD_EXTENDED_INQUIRY
:

2280 
»s
 = 
	`nvme_Œªs_ext_šq_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

2282 
VPD_BLOCK_DEV_CHARACTERISTICS
:

2283 
»s
 = 
	`nvme_Œªs_bdev_ch¬_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

2286 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2287 
SAM_STAT_CHECK_CONDITION
,

2288 
ILLEGAL_REQUEST
,

2289 
SCSI_ASC_INVALID_CDB
,

2290 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2294 
	`kä“
(
šq_»¥Ú£
);

2295 
out_mem
:

2296  
»s
;

2297 
	}
}

2299 
	$nvme_Œªs_log_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2300 
u8
 *
cmd
)

2302 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2303 
u16
 
®loc_Ën
;

2304 
u8
 
¥
;

2305 
u8
 
pc
;

2306 
u8
 
·ge_code
;

2308 
¥
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
LOG_SENSE_CDB_SP_OFFSET
);

2309 ià(
¥
 !ğ
LOG_SENSE_CDB_SP_NOT_ENABLED
) {

2310 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2311 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2312 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2313 
out
;

2315 
pc
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
LOG_SENSE_CDB_PC_OFFSET
);

2316 
·ge_code
 = 
pc
 & 
LOG_SENSE_CDB_PAGE_CODE_MASK
;

2317 
pc
 = (pø& 
LOG_SENSE_CDB_PC_MASK
è>> 
LOG_SENSE_CDB_PC_SHIFT
;

2318 ià(
pc
 !ğ
LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
) {

2319 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2320 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2321 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2322 
out
;

2324 
®loc_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
, 
LOG_SENSE_CDB_ALLOC_LENGTH_OFFSET
);

2325 
·ge_code
) {

2326 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
:

2327 
»s
 = 
	`nvme_Œªs_log_suµ_·ges
(
ns
, 
hdr
, 
®loc_Ën
);

2329 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
:

2330 
»s
 = 
	`nvme_Œªs_log_šfo_exû±iÚs
(
ns
, 
hdr
, 
®loc_Ën
);

2332 
LOG_PAGE_TEMPERATURE_PAGE
:

2333 
»s
 = 
	`nvme_Œªs_log_‹m³¿tu»
(
ns
, 
hdr
, 
®loc_Ën
);

2336 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2337 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2338 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2342 
out
:

2343  
»s
;

2344 
	}
}

2346 
	$nvme_Œªs_mode_£Ëù
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2347 
u8
 *
cmd
)

2349 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2350 
u8
 
cdb10
 = 0;

2351 
u16
 
·rm_li¡_Ën
;

2352 
u8
 
·ge_fÜm©
;

2353 
u8
 
§ve_·ges
;

2355 
·ge_fÜm©
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SELECT_CDB_PAGE_FORMAT_OFFSET
);

2356 
·ge_fÜm©
 &ğ
MODE_SELECT_CDB_PAGE_FORMAT_MASK
;

2358 
§ve_·ges
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SELECT_CDB_SAVE_PAGES_OFFSET
);

2359 
§ve_·ges
 &ğ
MODE_SELECT_CDB_SAVE_PAGES_MASK
;

2361 ià(
	`GET_OPCODE
(
cmd
è=ğ
MODE_SELECT
) {

2362 
·rm_li¡_Ën
 = 
	`GET_U8_FROM_CDB
(
cmd
,

2363 
MODE_SELECT_6_CDB_PARAM_LIST_LENGTH_OFFSET
);

2365 
·rm_li¡_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
,

2366 
MODE_SELECT_10_CDB_PARAM_LIST_LENGTH_OFFSET
);

2367 
cdb10
 = 1;

2370 ià(
·rm_li¡_Ën
 != 0) {

2375 
»s
 = 
	`nvme_Œªs_mode£l_d©a
(
ns
, 
hdr
, 
cmd
, 
·rm_li¡_Ën
,

2376 
·ge_fÜm©
, 
§ve_·ges
, 
cdb10
);

2379  
»s
;

2380 
	}
}

2382 
	$nvme_Œªs_mode_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2383 
u8
 *
cmd
)

2385 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2386 
u16
 
®loc_Ën
;

2387 
u8
 
cdb10
 = 0;

2388 
u8
 
·ge_code
;

2389 
u8
 
pc
;

2391 ià(
	`GET_OPCODE
(
cmd
è=ğ
MODE_SENSE
) {

2392 
®loc_Ën
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SENSE6_ALLOC_LEN_OFFSET
);

2394 
®loc_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
,

2395 
MODE_SENSE10_ALLOC_LEN_OFFSET
);

2396 
cdb10
 = 1;

2399 
pc
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SENSE_PAGE_CONTROL_OFFSET
) &

2400 
MODE_SENSE_PAGE_CONTROL_MASK
;

2401 ià(
pc
 !ğ
MODE_SENSE_PC_CURRENT_VALUES
) {

2402 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2403 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2404 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2405 
out
;

2408 
·ge_code
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
MODE_SENSE_PAGE_CODE_OFFSET
) &

2409 
MODE_SENSE_PAGE_CODE_MASK
;

2410 
·ge_code
) {

2411 
MODE_PAGE_CACHING
:

2412 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2413 
cdb10
,

2414 &
nvme_Œªs_fl_ÿchšg_·ge
,

2415 
MODE_PAGE_CACHING_LEN
);

2417 
MODE_PAGE_CONTROL
:

2418 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2419 
cdb10
,

2420 &
nvme_Œªs_fl_cÚŒŞ_·ge
,

2421 
MODE_PAGE_CONTROL_LEN
);

2423 
MODE_PAGE_POWER_CONDITION
:

2424 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2425 
cdb10
,

2426 &
nvme_Œªs_fl_pow_úd_·ge
,

2427 
MODE_PAGE_POW_CND_LEN
);

2429 
MODE_PAGE_INFO_EXCEP
:

2430 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2431 
cdb10
,

2432 &
nvme_Œªs_fl_šf_exc_·ge
,

2433 
MODE_PAGE_INF_EXC_LEN
);

2435 
MODE_PAGE_RETURN_ALL
:

2436 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2437 
cdb10
,

2438 &
nvme_Œªs_fl_®l_·ges
,

2439 
MODE_PAGE_ALL_LEN
);

2442 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2443 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2444 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2448 
out
:

2449  
»s
;

2450 
	}
}

2452 
	$nvme_Œªs_»ad_ÿ·c™y
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2453 
u8
 *
cmd
)

2455 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2456 
nvme_sc
;

2457 
u32
 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

2458 
u32
 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

2459 
u32
 
xãr_Ën
;

2460 
u8
 
cdb16
;

2461 
nvme_dev
 *
dev
 = 
ns
->dev;

2462 
dma_addr_t
 
dma_addr
;

2463 *
mem
;

2464 
nvme_id_ns
 *
id_ns
;

2465 
u8
 *
»¥Ú£
;

2467 
cdb16
 = 
	`IS_READ_CAP_16
(
cmd
);

2468 ià(
cdb16
) {

2469 
®loc_Ën
 = 
	`GET_READ_CAP_16_ALLOC_LENGTH
(
cmd
);

2470 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

2473 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
),

2474 &
dma_addr
, 
GFP_KERNEL
);

2475 ià(
mem
 =ğ
NULL
) {

2476 
»s
 = -
ENOMEM
;

2477 
out
;

2480 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 
ns
->
ns_id
, 0, 
dma_addr
);

2481 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2482 ià(
»s
)

2483 
out_dma
;

2484 ià(
nvme_sc
) {

2485 
»s
 = 
nvme_sc
;

2486 
out_dma
;

2488 
id_ns
 = 
mem
;

2490 
»¥Ú£
 = 
	`km®loc
(
»¥_size
, 
GFP_KERNEL
);

2491 ià(
»¥Ú£
 =ğ
NULL
) {

2492 
»s
 = -
ENOMEM
;

2493 
out_dma
;

2495 
	`mem£t
(
»¥Ú£
, 0, 
»¥_size
);

2496 
	`nvme_Œªs_fl_»ad_ÿp
(
»¥Ú£
, 
id_ns
, 
cdb16
);

2498 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2499 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2501 
	`kä“
(
»¥Ú£
);

2502 
out_dma
:

2503 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ns
), 
mem
,

2504 
dma_addr
);

2505 
out
:

2506  
»s
;

2507 
	}
}

2509 
	$nvme_Œªs_»pÜt_luns
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2510 
u8
 *
cmd
)

2512 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2513 
nvme_sc
;

2514 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2515 
u8
 
£Ëù_»pÜt
;

2516 
u8
 *
»¥Ú£
;

2517 
nvme_dev
 *
dev
 = 
ns
->dev;

2518 
dma_addr_t
 
dma_addr
;

2519 *
mem
;

2520 
nvme_id_ù¾
 *
id_ù¾
;

2521 
u32
 
Î_Ëngth
, 
lun_id
;

2522 
u8
 
lun_id_off£t
 = 
REPORT_LUNS_FIRST_LUN_OFFSET
;

2523 
__be32
 
tmp_Ën
;

2525 
®loc_Ën
 = 
	`GET_REPORT_LUNS_ALLOC_LENGTH
(
cmd
);

2526 
£Ëù_»pÜt
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
REPORT_LUNS_SR_OFFSET
);

2528 ià((
£Ëù_»pÜt
 !ğ
ALL_LUNS_RETURNED
) &&

2529 (
£Ëù_»pÜt
 !ğ
ALL_WELL_KNOWN_LUNS_RETURNED
) &&

2530 (
£Ëù_»pÜt
 !ğ
RESTRICTED_LUNS_RETURNED
)) {

2531 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2532 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2533 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2534 
out
;

2537 
mem
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev,

2538 (
nvme_id_ù¾
),

2539 &
dma_addr
, 
GFP_KERNEL
);

2540 ià(
mem
 =ğ
NULL
) {

2541 
»s
 = -
ENOMEM
;

2542 
out
;

2544 
nvme_sc
 = 
	`nvme_id’tify
(
dev
, 0, 1, 
dma_addr
);

2545 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2546 ià(
»s
)

2547 
out_dma
;

2548 ià(
nvme_sc
) {

2549 
»s
 = 
nvme_sc
;

2550 
out_dma
;

2552 
id_ù¾
 = 
mem
;

2553 
Î_Ëngth
 = 
	`Ë32_to_ıu
(
id_ù¾
->
Â
è* 
LUN_ENTRY_SIZE
;

2554 
»¥_size
 = 
Î_Ëngth
 + 
LUN_DATA_HEADER_SIZE
;

2556 ià(
®loc_Ën
 < 
»¥_size
) {

2557 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2558 
SAM_STAT_CHECK_CONDITION
,

2559 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2560 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2561 
out_dma
;

2564 
»¥Ú£
 = 
	`km®loc
(
»¥_size
, 
GFP_KERNEL
);

2565 ià(
»¥Ú£
 =ğ
NULL
) {

2566 
»s
 = -
ENOMEM
;

2567 
out_dma
;

2569 
	`mem£t
(
»¥Ú£
, 0, 
»¥_size
);

2572 
lun_id
 = 0;†un_id < 
	`Ë32_to_ıu
(
id_ù¾
->
Â
);†un_id++) {

2577 
__be64
 
tmp_id
 = 
	`ıu_to_be64
(
lun_id
);

2578 
	`memıy
(&
»¥Ú£
[
lun_id_off£t
], &
tmp_id
, (
u64
));

2579 
lun_id_off£t
 +ğ
LUN_ENTRY_SIZE
;

2581 
tmp_Ën
 = 
	`ıu_to_be32
(
Î_Ëngth
);

2582 
	`memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

2585 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2586 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2588 
	`kä“
(
»¥Ú£
);

2589 
out_dma
:

2590 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, (
nvme_id_ù¾
), 
mem
,

2591 
dma_addr
);

2592 
out
:

2593  
»s
;

2594 
	}
}

2596 
	$nvme_Œªs_»que¡_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2597 
u8
 *
cmd
)

2599 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2600 
u8
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2601 
u8
 
desc_fÜm©
;

2602 
u8
 *
»¥Ú£
;

2604 
®loc_Ën
 = 
	`GET_REQUEST_SENSE_ALLOC_LENGTH
(
cmd
);

2605 
desc_fÜm©
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
REQUEST_SENSE_DESC_OFFSET
);

2606 
desc_fÜm©
 &ğ
REQUEST_SENSE_DESC_MASK
;

2608 
»¥_size
 = ((
desc_fÜm©
è? (
DESC_FMT_SENSE_DATA_SIZE
) :

2609 (
FIXED_FMT_SENSE_DATA_SIZE
));

2610 
»¥Ú£
 = 
	`km®loc
(
»¥_size
, 
GFP_KERNEL
);

2611 ià(
»¥Ú£
 =ğ
NULL
) {

2612 
»s
 = -
ENOMEM
;

2613 
out
;

2615 
	`mem£t
(
»¥Ú£
, 0, 
»¥_size
);

2617 ià(
desc_fÜm©
 =ğ
DESCRIPTOR_FORMAT_SENSE_DATA_TYPE
) {

2619 
»¥Ú£
[0] = 
DESC_FORMAT_SENSE_DATA
;

2620 
»¥Ú£
[1] = 
NO_SENSE
;

2622 
»¥Ú£
[2] = 
SCSI_ASC_NO_SENSE
;

2623 
»¥Ú£
[3] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2627 
»¥Ú£
[0] = 
FIXED_SENSE_DATA
;

2629 
»¥Ú£
[2] = 
NO_SENSE
;

2631 
»¥Ú£
[7] = 
FIXED_SENSE_DATA_ADD_LENGTH
;

2633 
»¥Ú£
[12] = 
SCSI_ASC_NO_SENSE
;

2634 
»¥Ú£
[13] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2639 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2640 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2642 
	`kä“
(
»¥Ú£
);

2643 
out
:

2644  
»s
;

2645 
	}
}

2647 
	$nvme_Œªs_£cur™y_´ÙocŞ
(
nvme_ns
 *
ns
,

2648 
sg_io_hdr
 *
hdr
,

2649 
u8
 *
cmd
)

2651  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2652 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2653 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2654 
	}
}

2656 
	$nvme_Œªs_¡¬t_¡İ
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2657 
u8
 *
cmd
)

2659 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2660 
nvme_sc
;

2661 
nvme_queue
 *
nvmeq
;

2662 
nvme_commªd
 
c
;

2663 
u8
 
immed
, 
pcmod
, 
pc
, 
no_æush
, 
¡¬t
;

2665 
immed
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_IMMED_OFFSET
);

2666 
pcmod
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_POWER_COND_MOD_OFFSET
);

2667 
pc
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_POWER_COND_OFFSET
);

2668 
no_æush
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_NO_FLUSH_OFFSET
);

2669 
¡¬t
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
START_STOP_UNIT_CDB_START_OFFSET
);

2671 
immed
 &ğ
START_STOP_UNIT_CDB_IMMED_MASK
;

2672 
pcmod
 &ğ
START_STOP_UNIT_CDB_POWER_COND_MOD_MASK
;

2673 
pc
 = (pø& 
START_STOP_UNIT_CDB_POWER_COND_MASK
è>> 
NIBBLE_SHIFT
;

2674 
no_æush
 &ğ
START_STOP_UNIT_CDB_NO_FLUSH_MASK
;

2675 
¡¬t
 &ğ
START_STOP_UNIT_CDB_START_MASK
;

2677 ià(
immed
 != 0) {

2678 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2679 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2680 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2682 ià(
no_æush
 == 0) {

2684 
	`mem£t
(&
c
, 0, (c));

2685 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2686 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2688 
nvmeq
 = 
	`g‘_nvmeq
(
ns
->
dev
);

2689 
	`put_nvmeq
(
nvmeq
);

2690 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
nvmeq
, &
c
, 
NULL
, 
NVME_IO_TIMEOUT
);

2692 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2693 ià(
»s
)

2694 
out
;

2695 ià(
nvme_sc
) {

2696 
»s
 = 
nvme_sc
;

2697 
out
;

2701 
»s
 = 
	`nvme_Œªs_pow”_¡©e
(
ns
, 
hdr
, 
pc
, 
pcmod
, 
¡¬t
);

2704 
out
:

2705  
»s
;

2706 
	}
}

2708 
	$nvme_Œªs_synchrÚize_ÿche
(
nvme_ns
 *
ns
,

2709 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
)

2711 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2712 
nvme_sc
;

2713 
nvme_commªd
 
c
;

2714 
nvme_queue
 *
nvmeq
;

2716 
	`mem£t
(&
c
, 0, (c));

2717 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2718 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2720 
nvmeq
 = 
	`g‘_nvmeq
(
ns
->
dev
);

2721 
	`put_nvmeq
(
nvmeq
);

2722 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
nvmeq
, &
c
, 
NULL
, 
NVME_IO_TIMEOUT
);

2724 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2725 ià(
»s
)

2726 
out
;

2727 ià(
nvme_sc
)

2728 
»s
 = 
nvme_sc
;

2730 
out
:

2731  
»s
;

2732 
	}
}

2734 
	$nvme_Œªs_fÜm©_un™
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2735 
u8
 *
cmd
)

2737 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2738 
u8
 
·rm_hdr_Ën
 = 0;

2739 
u8
 
nvme_pf_code
 = 0;

2740 
u8
 
fÜm©_´Ù_šfo
, 
lÚg_li¡
, 
fÜm©_d©a
;

2742 
fÜm©_´Ù_šfo
 = 
	`GET_U8_FROM_CDB
(
cmd
,

2743 
FORMAT_UNIT_CDB_FORMAT_PROT_INFO_OFFSET
);

2744 
lÚg_li¡
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
FORMAT_UNIT_CDB_LONG_LIST_OFFSET
);

2745 
fÜm©_d©a
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
FORMAT_UNIT_CDB_FORMAT_DATA_OFFSET
);

2747 
fÜm©_´Ù_šfo
 = (format_prot_info &

2748 
FORMAT_UNIT_CDB_FORMAT_PROT_INFO_MASK
) >>

2749 
FORMAT_UNIT_CDB_FORMAT_PROT_INFO_SHIFT
;

2750 
lÚg_li¡
 &ğ
FORMAT_UNIT_CDB_LONG_LIST_MASK
;

2751 
fÜm©_d©a
 &ğ
FORMAT_UNIT_CDB_FORMAT_DATA_MASK
;

2753 ià(
fÜm©_d©a
 != 0) {

2754 ià(
fÜm©_´Ù_šfo
 != 0) {

2755 ià(
lÚg_li¡
 == 0)

2756 
·rm_hdr_Ën
 = 
FORMAT_UNIT_SHORT_PARM_LIST_LEN
;

2758 
·rm_hdr_Ën
 = 
FORMAT_UNIT_LONG_PARM_LIST_LEN
;

2760 } ià(
fÜm©_d©a
 =ğ0 && 
fÜm©_´Ù_šfo
 != 0) {

2761 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2762 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2763 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2764 
out
;

2772 ià(
·rm_hdr_Ën
 > 0) {

2773 
»s
 = 
	`nvme_Œªs_fmt_g‘_·rm_h—d”
(
hdr
, 
·rm_hdr_Ën
,

2774 
fÜm©_´Ù_šfo
, &
nvme_pf_code
);

2775 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2776 
out
;

2780 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_aùiv©e_fw
, 0, 0, 0);

2783 
»s
 = 
	`nvme_Œªs_fmt_£t_blk_size_couÁ
(
ns
, 
hdr
);

2784 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2785 
out
;

2787 
»s
 = 
	`nvme_Œªs_fmt_£nd_cmd
(
ns
, 
hdr
, 
nvme_pf_code
);

2789 
out
:

2790  
»s
;

2791 
	}
}

2793 
	$nvme_Œªs_‹¡_un™_»ady
(
nvme_ns
 *
ns
,

2794 
sg_io_hdr
 *
hdr
,

2795 
u8
 *
cmd
)

2797 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2798 
nvme_dev
 *
dev
 = 
ns
->dev;

2800 ià(!(
	`»adl
(&
dev
->
b¬
->
c¡s
è& 
NVME_CSTS_RDY
))

2801 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2802 
NOT_READY
, 
SCSI_ASC_LUN_NOT_READY
,

2803 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2805 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_GOOD
, 
NO_SENSE
, 0, 0);

2807  
»s
;

2808 
	}
}

2810 
	$nvme_Œªs_wr™e_bufãr
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2811 
u8
 *
cmd
)

2813 
»s
 = 
SNTI_TRANSLATION_SUCCESS
;

2814 
u32
 
bufãr_off£t
, 
·rm_li¡_Ëngth
;

2815 
u8
 
bufãr_id
, 
mode
;

2817 
·rm_li¡_Ëngth
 =

2818 
	`GET_U24_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_PARM_LIST_LENGTH_OFFSET
);

2819 ià(
·rm_li¡_Ëngth
 % 
BYTES_TO_DWORDS
 != 0) {

2821 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2822 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2823 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2824 
out
;

2826 
bufãr_id
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_BUFFER_ID_OFFSET
);

2827 ià(
bufãr_id
 > 
NVME_MAX_FIRMWARE_SLOT
) {

2828 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2829 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2830 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2831 
out
;

2833 
mode
 = 
	`GET_U8_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_MODE_OFFSET
) &

2834 
WRITE_BUFFER_CDB_MODE_MASK
;

2835 
bufãr_off£t
 =

2836 
	`GET_U24_FROM_CDB
(
cmd
, 
WRITE_BUFFER_CDB_BUFFER_OFFSET_OFFSET
);

2838 
mode
) {

2839 
DOWNLOAD_SAVE_ACTIVATE
:

2840 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2841 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2842 
bufãr_id
);

2843 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2844 
out
;

2845 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_aùiv©e_fw
,

2846 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2847 
bufãr_id
);

2849 
DOWNLOAD_SAVE_DEFER_ACTIVATE
:

2850 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2851 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2852 
bufãr_id
);

2854 
ACTIVATE_DEFERRED_MICROCODE
:

2855 
»s
 = 
	`nvme_Œªs_£nd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_aùiv©e_fw
,

2856 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2857 
bufãr_id
);

2860 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2861 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2862 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2866 
out
:

2867  
»s
;

2868 
	}
}

2870 
	sscsi_unm­_blk_desc
 {

2871 
__be64
 
	m¦ba
;

2872 
__be32
 
	mÆb
;

2873 
u32
 
	m»sv
;

2876 
	sscsi_unm­_·rm_li¡
 {

2877 
__be16
 
	munm­_d©a_Ën
;

2878 
__be16
 
	munm­_blk_desc_d©a_Ën
;

2879 
u32
 
	m»sv
;

2880 
scsi_unm­_blk_desc
 
	mdesc
[0];

2883 
	$nvme_Œªs_unm­
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2884 
u8
 *
cmd
)

2886 
nvme_dev
 *
dev
 = 
ns
->dev;

2887 
scsi_unm­_·rm_li¡
 *
¶i¡
;

2888 
nvme_dsm_¿nge
 *
¿nge
;

2889 
nvme_queue
 *
nvmeq
;

2890 
nvme_commªd
 
c
;

2891 
i
, 
nvme_sc
, 
»s
 = -
ENOMEM
;

2892 
u16
 
ndesc
, 
li¡_Ën
;

2893 
dma_addr_t
 
dma_addr
;

2895 
li¡_Ën
 = 
	`GET_U16_FROM_CDB
(
cmd
, 
UNMAP_CDB_PARAM_LIST_LENGTH_OFFSET
);

2896 ià(!
li¡_Ën
)

2897  -
EINVAL
;

2899 
¶i¡
 = 
	`km®loc
(
li¡_Ën
, 
GFP_KERNEL
);

2900 ià(!
¶i¡
)

2901  -
ENOMEM
;

2903 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
¶i¡
, 
li¡_Ën
);

2904 ià(
»s
 !ğ
SNTI_TRANSLATION_SUCCESS
)

2905 
out
;

2907 
ndesc
 = 
	`be16_to_ıu
(
¶i¡
->
unm­_blk_desc_d©a_Ën
) >> 4;

2908 ià(!
ndesc
 ||‚desc > 256) {

2909 
»s
 = -
EINVAL
;

2910 
out
;

2913 
¿nge
 = 
	`dma_®loc_coh”’t
(&
dev
->
pci_dev
->dev, 
ndesc
 * (*range),

2914 &
dma_addr
, 
GFP_KERNEL
);

2915 ià(!
¿nge
)

2916 
out
;

2918 
i
 = 0; i < 
ndesc
; i++) {

2919 
¿nge
[
i
].
Æb
 = 
	`ıu_to_Ë32
(
	`be32_to_ıu
(
¶i¡
->
desc
[i].nlb));

2920 
¿nge
[
i
].
¦ba
 = 
	`ıu_to_Ë64
(
	`be64_to_ıu
(
¶i¡
->
desc
[i].slba));

2921 
¿nge
[
i
].
ÿ‰r
 = 0;

2924 
	`mem£t
(&
c
, 0, (c));

2925 
c
.
dsm
.
İcode
 = 
nvme_cmd_dsm
;

2926 
c
.
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2927 
c
.
dsm
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

2928 
c
.
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
ndesc
 - 1);

2929 
c
.
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

2931 
nvmeq
 = 
	`g‘_nvmeq
(
dev
);

2932 
	`put_nvmeq
(
nvmeq
);

2934 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
nvmeq
, &
c
, 
NULL
, 
NVME_IO_TIMEOUT
);

2935 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2937 
	`dma_ä“_coh”’t
(&
dev
->
pci_dev
->dev, 
ndesc
 * (*
¿nge
),

2938 
¿nge
, 
dma_addr
);

2939 
out
:

2940 
	`kä“
(
¶i¡
);

2941  
»s
;

2942 
	}
}

2944 
	$nvme_scsi_Œª¦©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
)

2946 
u8
 
cmd
[
BLK_MAX_CDB
];

2947 
»tcode
;

2948 
İcode
;

2950 ià(
hdr
->
cmdp
 =ğ
NULL
)

2951  -
EMSGSIZE
;

2952 ià(
	`cİy_äom_u£r
(
cmd
, 
hdr
->
cmdp
, hdr->
cmd_Ën
))

2953  -
EFAULT
;

2955 
İcode
 = 
cmd
[0];

2957 
İcode
) {

2958 
READ_6
:

2959 
READ_10
:

2960 
READ_12
:

2961 
READ_16
:

2962 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 0, 
cmd
);

2964 
WRITE_6
:

2965 
WRITE_10
:

2966 
WRITE_12
:

2967 
WRITE_16
:

2968 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 1, 
cmd
);

2970 
INQUIRY
:

2971 
»tcode
 = 
	`nvme_Œªs_šquœy
(
ns
, 
hdr
, 
cmd
);

2973 
LOG_SENSE
:

2974 
»tcode
 = 
	`nvme_Œªs_log_£n£
(
ns
, 
hdr
, 
cmd
);

2976 
MODE_SELECT
:

2977 
MODE_SELECT_10
:

2978 
»tcode
 = 
	`nvme_Œªs_mode_£Ëù
(
ns
, 
hdr
, 
cmd
);

2980 
MODE_SENSE
:

2981 
MODE_SENSE_10
:

2982 
»tcode
 = 
	`nvme_Œªs_mode_£n£
(
ns
, 
hdr
, 
cmd
);

2984 
READ_CAPACITY
:

2985 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
);

2987 
SERVICE_ACTION_IN
:

2988 ià(
	`IS_READ_CAP_16
(
cmd
))

2989 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
);

2991 
out
;

2993 
REPORT_LUNS
:

2994 
»tcode
 = 
	`nvme_Œªs_»pÜt_luns
(
ns
, 
hdr
, 
cmd
);

2996 
REQUEST_SENSE
:

2997 
»tcode
 = 
	`nvme_Œªs_»que¡_£n£
(
ns
, 
hdr
, 
cmd
);

2999 
SECURITY_PROTOCOL_IN
:

3000 
SECURITY_PROTOCOL_OUT
:

3001 
»tcode
 = 
	`nvme_Œªs_£cur™y_´ÙocŞ
(
ns
, 
hdr
, 
cmd
);

3003 
START_STOP
:

3004 
»tcode
 = 
	`nvme_Œªs_¡¬t_¡İ
(
ns
, 
hdr
, 
cmd
);

3006 
SYNCHRONIZE_CACHE
:

3007 
»tcode
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
, 
cmd
);

3009 
FORMAT_UNIT
:

3010 
»tcode
 = 
	`nvme_Œªs_fÜm©_un™
(
ns
, 
hdr
, 
cmd
);

3012 
TEST_UNIT_READY
:

3013 
»tcode
 = 
	`nvme_Œªs_‹¡_un™_»ady
(
ns
, 
hdr
, 
cmd
);

3015 
WRITE_BUFFER
:

3016 
»tcode
 = 
	`nvme_Œªs_wr™e_bufãr
(
ns
, 
hdr
, 
cmd
);

3018 
UNMAP
:

3019 
»tcode
 = 
	`nvme_Œªs_unm­
(
ns
, 
hdr
, 
cmd
);

3022 
out
:

3023 
»tcode
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

3024 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

3025 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

3028  
»tcode
;

3029 
	}
}

3031 
	$nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
)

3033 
sg_io_hdr
 
hdr
;

3034 
»tcode
;

3036 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3037  -
EACCES
;

3038 ià(
	`cİy_äom_u£r
(&
hdr
, 
u_hdr
, (hdr)))

3039  -
EFAULT
;

3040 ià(
hdr
.
š‹rçû_id
 != 'S')

3041  -
EINVAL
;

3042 ià(
hdr
.
cmd_Ën
 > 
BLK_MAX_CDB
)

3043  -
EINVAL
;

3045 
»tcode
 = 
	`nvme_scsi_Œª¦©e
(
ns
, &
hdr
);

3046 ià(
»tcode
 < 0)

3047  
»tcode
;

3048 ià(
»tcode
 > 0)

3049 
»tcode
 = 
SNTI_TRANSLATION_SUCCESS
;

3050 ià(
	`cİy_to_u£r
(
u_hdr
, &
hdr
, (
sg_io_hdr_t
)) > 0)

3051  -
EFAULT
;

3053  
»tcode
;

3054 
	}
}

3056 
	$nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

)

3058  
	`put_u£r
(
sg_v”siÚ_num
, 

);

3059 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10/nvme.h

19 #iâdeà
_LINUX_NVME_H


20 
	#_LINUX_NVME_H


	)

22 
	~<lšux/ty³s.h
>

25 
	#KSID_SUPPORT


	)

28 
	snvme_b¬
 {

29 
__u64
 
	mÿp
;

30 
__u32
 
	mvs
;

31 
__u32
 
	mštms
;

32 
__u32
 
	mštmc
;

33 
__u32
 
	mcc
;

34 
__u32
 
	mrsvd1
;

35 
__u32
 
	mc¡s
;

36 
__u32
 
	mrsvd2
;

37 
__u32
 
	maqa
;

38 
__u64
 
	masq
;

39 
__u64
 
	macq
;

42 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

43 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

44 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

45 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

48 
	mNVME_CC_ENABLE
 = 1 << 0,

49 
	mNVME_CC_CSS_NVM
 = 0 << 4,

50 
	mNVME_CC_MPS_SHIFT
 = 7,

51 
	mNVME_CC_ARB_RR
 = 0 << 11,

52 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

53 
	mNVME_CC_ARB_VS
 = 7 << 11,

54 
	mNVME_CC_SHN_NONE
 = 0 << 14,

55 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

56 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

57 
	mNVME_CC_IOSQES
 = 6 << 16,

58 
	mNVME_CC_IOCQES
 = 4 << 20,

59 
	mNVME_CSTS_RDY
 = 1 << 0,

60 
	mNVME_CSTS_CFS
 = 1 << 1,

61 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

62 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

63 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

66 
	snvme_id_pow”_¡©e
 {

67 
__Ë16
 
	mmax_pow”
;

68 
__u16
 
	mrsvd2
;

69 
__Ë32
 
	m’Œy_Ït
;

70 
__Ë32
 
	mex™_Ït
;

71 
__u8
 
	m»ad_ut
;

72 
__u8
 
	m»ad_Ït
;

73 
__u8
 
	mwr™e_ut
;

74 
__u8
 
	mwr™e_Ït
;

75 
__u8
 
	mrsvd16
[16];

78 
	#NVME_VS
(
majÜ
, 
mšÜ
è(majÜ << 16 | mšÜ)

	)

80 
	snvme_id_ù¾
 {

81 
__Ë16
 
	mvid
;

82 
__Ë16
 
	mssvid
;

83 
	m¢
[20];

84 
	mmn
[40];

85 
	mä
[8];

86 
__u8
 
	m¿b
;

87 
__u8
 
	m›“
[3];

88 
__u8
 
	mmic
;

89 
__u8
 
	mmdts
;

90 
__u8
 
	mrsvd78
[178];

91 
__Ë16
 
	mßcs
;

92 
__u8
 
	maş
;

93 
__u8
 
	m«¾
;

94 
__u8
 
	mämw
;

95 
__u8
 
	mÍa
;

96 
__u8
 
	m–³
;

97 
__u8
 
	mÅss
;

98 
__u8
 
	mrsvd264
[248];

99 
__u8
 
	msqes
;

100 
__u8
 
	mcqes
;

101 
__u8
 
	mrsvd514
[2];

102 
__Ë32
 
	mÂ
;

103 
__Ë16
 
	mÚcs
;

104 
__Ë16
 
	mfu£s
;

105 
__u8
 
	mâa
;

106 
__u8
 
	mvwc
;

107 
__Ë16
 
	mawun
;

108 
__Ë16
 
	mawupf
;

109 
__u8
 
	mrsvd530
[1518];

110 
nvme_id_pow”_¡©e
 
	mpsd
[32];

111 
__u8
 
	mvs
[1024];

115 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

116 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

117 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

120 
	snvme_lbaf
 {

121 
__Ë16
 
	mms
;

122 
__u8
 
	mds
;

123 
__u8
 
	m½
;

126 
	snvme_id_ns
 {

127 
__Ë64
 
	mnsze
;

128 
__Ë64
 
	mnÿp
;

129 
__Ë64
 
	mnu£
;

130 
__u8
 
	mnsã©
;

131 
__u8
 
	mÆbaf
;

132 
__u8
 
	mæbas
;

133 
__u8
 
	mmc
;

134 
__u8
 
	mdpc
;

135 
__u8
 
	mdps
;

136 
__u8
 
	mrsvd30
[98];

137 
nvme_lbaf
 
	mlbaf
[16];

138 
__u8
 
	mrsvd192
[192];

139 
__u8
 
	mvs
[3712];

143 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

144 
	mNVME_LBAF_RP_BEST
 = 0,

145 
	mNVME_LBAF_RP_BETTER
 = 1,

146 
	mNVME_LBAF_RP_GOOD
 = 2,

147 
	mNVME_LBAF_RP_DEGRADED
 = 3,

150 
	snvme_sm¬t_log
 {

151 
__u8
 
	mü™iÿl_w¬nšg
;

152 
__u8
 
	m‹m³¿tu»
[2];

153 
__u8
 
	mava_¥¬e
;

154 
__u8
 
	m¥¬e_th»sh
;

155 
__u8
 
	m³rûÁ_u£d
;

156 
__u8
 
	mrsvd6
[26];

157 
__u8
 
	md©a_un™s_»ad
[16];

158 
__u8
 
	md©a_un™s_wr™‹n
[16];

159 
__u8
 
	mho¡_»ads
[16];

160 
__u8
 
	mho¡_wr™es
[16];

161 
__u8
 
	mù¾_busy_time
[16];

162 
__u8
 
	mpow”_cyşes
[16];

163 
__u8
 
	mpow”_Ú_hours
[16];

164 
__u8
 
	mun§ã_shutdowns
[16];

165 
__u8
 
	mmedŸ_”rÜs
[16];

166 
__u8
 
	mnum_”r_log_’Œ›s
[16];

167 
__u8
 
	mrsvd192
[320];

171 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

172 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

173 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

174 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

175 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

178 
	snvme_lba_¿nge_ty³
 {

179 
__u8
 
	mty³
;

180 
__u8
 
	m©Œibu‹s
;

181 
__u8
 
	mrsvd2
[14];

182 
__u64
 
	m¦ba
;

183 
__u64
 
	mÆb
;

184 
__u8
 
	mguid
[16];

185 
__u8
 
	mrsvd48
[16];

189 
	mNVME_LBART_TYPE_FS
 = 0x01,

190 
	mNVME_LBART_TYPE_RAID
 = 0x02,

191 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

192 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

194 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

195 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

200 
	envme_İcode
 {

201 
	mnvme_cmd_æush
 = 0x00,

202 
	mnvme_cmd_wr™e
 = 0x01,

203 
	mnvme_cmd_»ad
 = 0x02,

204 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

205 
	mnvme_cmd_com·»
 = 0x05,

206 
	mnvme_cmd_dsm
 = 0x09,

208 
	mnvme_cmd_kv_¡Üe
 = 0x81,

209 
	mnvme_cmd_kv_­³nd
 = 0x83,

210 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

211 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

212 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

213 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

214 
	mnvme_cmd_kv_exi¡
 = 0xB3,

219 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

220 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

221 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

222 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

223 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

224 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

225 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

226 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

227 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

228 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

229 
	`is_kv_exi¡_cmd
(
İcode
))

	)

230 
	#kv_nvme_is_wr™e
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(İcode))

	)

233 
	snvme_commÚ_commªd
 {

234 
__u8
 
	mİcode
;

235 
__u8
 
	mæags
;

236 
__u16
 
	mcommªd_id
;

237 
__Ë32
 
	mnsid
;

238 
__Ë32
 
	mcdw2
[2];

239 
__Ë64
 
	mm‘ad©a
;

240 
__Ë64
 
	m´p1
;

241 
__Ë64
 
	m´p2
;

242 
__Ë32
 
	mcdw10
[6];

245 
	snvme_rw_commªd
 {

246 
__u8
 
	mİcode
;

247 
__u8
 
	mæags
;

248 
__u16
 
	mcommªd_id
;

249 
__Ë32
 
	mnsid
;

250 
__u64
 
	mrsvd2
;

251 
__Ë64
 
	mm‘ad©a
;

252 
__Ë64
 
	m´p1
;

253 
__Ë64
 
	m´p2
;

254 
__Ë64
 
	m¦ba
;

255 
__Ë16
 
	mËngth
;

256 
__Ë16
 
	mcÚŒŞ
;

257 
__Ë32
 
	mdsmgmt
;

258 
__Ë32
 
	m»áag
;

259 
__Ë16
 
	m­±ag
;

260 
__Ë16
 
	m­pmask
;

264 
	snvme_kv_¡Üe_commªd
 {

265 
__u8
 
	mİcode
;

266 
__u8
 
	mæags
;

267 
__u16
 
	mcommªd_id
;

268 
__Ë32
 
	mnsid
;

269 
__u64
 
	mrsvd
;

270 
__Ë32
 
	moff£t
;

271 
__u32
 
	mrsvd2
;

272 
__Ë64
 
	m´p1
;

273 
__Ë64
 
	m´p2
;

274 
__Ë32
 
	mv®ue_Ën
;

275 
__u8
 
	mkey_Ën
;

276 
__u8
 
	mİtiÚ
;

277 
__u8
 
	mšv®id_by‹
:2;

278 
__u8
 
	mrsvd3
:6;

279 
__u8
 
	mrsvd4
;

282 
	mkey
[16];

285 
__Ë64
 
	mkey_´p
;

286 
__Ë64
 
	mkey_´p2
;

291 
	snvme_kv_­³nd_commªd
 {

292 
__u8
 
	mİcode
;

293 
__u8
 
	mæags
;

294 
__u16
 
	mcommªd_id
;

295 
__Ë32
 
	mnsid
;

296 
__u64
 
	mrsvd
;

297 
__Ë32
 
	moff£t
;

298 
__u32
 
	mrsvd2
;

299 
__Ë64
 
	m´p1
;

300 
__Ë64
 
	m´p2
;

301 
__Ë32
 
	mv®ue_Ën
;

302 
__u8
 
	mkey_Ën
;

303 
__u8
 
	mİtiÚ
;

304 
__u8
 
	mšv®id_by‹
:2;

305 
__u8
 
	mrsvd3
:6;

306 
__u8
 
	mrsvd4
;

309 
	mkey
[16];

312 
__Ë64
 
	mkey_´p
;

313 
__Ë64
 
	mkey_´p2
;

318 
	snvme_kv_»Œ›ve_commªd
 {

319 
__u8
 
	mİcode
;

320 
__u8
 
	mæags
;

321 
__u16
 
	mcommªd_id
;

322 
__Ë32
 
	mnsid
;

323 
__u64
 
	mrsvd
;

324 
__Ë32
 
	moff£t
;

325 
__u32
 
	mrsvd2
;

326 
__Ë64
 
	m´p1
;

327 
__Ë64
 
	m´p2
;

328 
__Ë32
 
	mv®ue_Ën
;

329 
__u8
 
	mkey_Ën
;

330 
__u8
 
	mİtiÚ
;

331 
__u16
 
	mrsvd3
;

334 
	mkey
[16];

337 
__Ë64
 
	mkey_´p
;

338 
__Ë64
 
	mkey_´p2
;

343 
	snvme_kv_d–‘e_commªd
 {

344 
__u8
 
	mİcode
;

345 
__u8
 
	mæags
;

346 
__u16
 
	mcommªd_id
;

347 
__Ë32
 
	mnsid
;

348 
__u64
 
	mrsvd
;

349 
__Ë32
 
	moff£t
;

350 
__u32
 
	mrsvd2
;

351 
__u64
 
	mrsvd3
[2];

352 
__Ë32
 
	mv®ue_Ën
;

353 
__u8
 
	mkey_Ën
;

354 
__u8
 
	mİtiÚ
;

355 
__u16
 
	mrsvd4
;

358 
	mkey
[16];

361 
__Ë64
 
	mkey_´p
;

362 
__Ë64
 
	mkey_´p2
;

367 
	snvme_kv_exi¡_commªd
 {

368 
__u8
 
	mİcode
;

369 
__u8
 
	mæags
;

370 
__u16
 
	mcommªd_id
;

371 
__Ë32
 
	mnsid
;

372 
__u64
 
	mrsvd
;

373 
__Ë32
 
	moff£t
;

374 
__u32
 
	mrsvd2
;

375 
__u64
 
	mrsvd3
[2];

376 
__Ë32
 
	mv®ue_Ën
;

377 
__u8
 
	mkey_Ën
;

378 
__u8
 
	mİtiÚ
;

379 
__u16
 
	mrsvd4
;

382 
	mkey
[16];

385 
__Ë64
 
	mkey_´p
;

386 
__Ë64
 
	mkey_´p2
;

392 
	snvme_kv_™”_»q_commªd
 {

393 
__u8
 
	mİcode
;

394 
__u8
 
	mæags
;

395 
__u16
 
	mcommªd_id
;

396 
__Ë32
 
	mnsid
;

397 
__u64
 
	mrsvd
[4];

398 
__Ë32
 
	mz”o
;

399 
__u8
 
	m™”_hªdË
;

400 
__u8
 
	mİtiÚ
;

401 
__u16
 
	mrsvd2
;

402 
__Ë32
 
	m™”_v®
;

403 
__Ë32
 
	m™”_b™mask
;

404 
__u64
 
	mrsvd3
;

408 
	snvme_kv_™”_»ad_commªd
 {

409 
__u8
 
	mİcode
;

410 
__u8
 
	mæags
;

411 
__u16
 
	mcommªd_id
;

412 
__Ë32
 
	mnsid
;

413 
__u64
 
	mrsvd
[2];

414 
__Ë64
 
	m´p1
;

415 
__Ë64
 
	m´p2
;

416 
__Ë32
 
	mv®ue_Ën
;

417 
__u8
 
	m™”_hªdË
;

418 
__u8
 
	mİtiÚ
;

419 
__u16
 
	mrsvd2
;

420 
__u64
 
	mrsvd3
[2];

426 
	mNVME_RW_LR
 = 1 << 15,

427 
	mNVME_RW_FUA
 = 1 << 14,

428 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

429 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

430 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

431 
	mNVME_RW_DSM_FREQ_READS
 = 3,

432 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

433 
	mNVME_RW_DSM_FREQ_RW
 = 5,

434 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

435 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

436 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

437 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

438 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

439 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

440 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

441 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

442 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

445 
	snvme_dsm_cmd
 {

446 
__u8
 
	mİcode
;

447 
__u8
 
	mæags
;

448 
__u16
 
	mcommªd_id
;

449 
__Ë32
 
	mnsid
;

450 
__u64
 
	mrsvd2
[2];

451 
__Ë64
 
	m´p1
;

452 
__Ë64
 
	m´p2
;

453 
__Ë32
 
	mÄ
;

454 
__Ë32
 
	m©Œibu‹s
;

455 
__u32
 
	mrsvd12
[4];

459 
	mNVME_DSMGMT_IDR
 = 1 << 0,

460 
	mNVME_DSMGMT_IDW
 = 1 << 1,

461 
	mNVME_DSMGMT_AD
 = 1 << 2,

464 
	snvme_dsm_¿nge
 {

465 
__Ë32
 
	mÿ‰r
;

466 
__Ë32
 
	mÆb
;

467 
__Ë64
 
	m¦ba
;

472 
	envme_admš_İcode
 {

473 
	mnvme_admš_d–‘e_sq
 = 0x00,

474 
	mnvme_admš_ü—‹_sq
 = 0x01,

475 
	mnvme_admš_g‘_log_·ge
 = 0x02,

476 
	mnvme_admš_d–‘e_cq
 = 0x04,

477 
	mnvme_admš_ü—‹_cq
 = 0x05,

478 
	mnvme_admš_id’tify
 = 0x06,

479 
	mnvme_admš_abÜt_cmd
 = 0x08,

480 
	mnvme_admš_£t_ã©u»s
 = 0x09,

481 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

482 
	mnvme_admš_async_ev’t
 = 0x0c,

483 
	mnvme_admš_aùiv©e_fw
 = 0x10,

484 
	mnvme_admš_dowÆßd_fw
 = 0x11,

485 
	mnvme_admš_fÜm©_nvm
 = 0x80,

486 
	mnvme_admš_£cur™y_£nd
 = 0x81,

487 
	mnvme_admš_£cur™y_»cv
 = 0x82,

491 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

492 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

493 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

494 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

495 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

496 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

497 
	mNVME_FEAT_ARBITRATION
 = 0x01,

498 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

499 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

500 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

501 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

502 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

503 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

504 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

505 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

506 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

507 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

508 
	mNVME_FEAT_SW_PROGRESS
 = 0x0c,

509 
	mNVME_FWACT_REPL
 = (0 << 3),

510 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

511 
	mNVME_FWACT_ACTV
 = (2 << 3),

514 
	snvme_id’tify
 {

515 
__u8
 
	mİcode
;

516 
__u8
 
	mæags
;

517 
__u16
 
	mcommªd_id
;

518 
__Ë32
 
	mnsid
;

519 
__u64
 
	mrsvd2
[2];

520 
__Ë64
 
	m´p1
;

521 
__Ë64
 
	m´p2
;

522 
__Ë32
 
	mús
;

523 
__u32
 
	mrsvd11
[5];

526 
	snvme_ã©u»s
 {

527 
__u8
 
	mİcode
;

528 
__u8
 
	mæags
;

529 
__u16
 
	mcommªd_id
;

530 
__Ë32
 
	mnsid
;

531 
__u64
 
	mrsvd2
[2];

532 
__Ë64
 
	m´p1
;

533 
__Ë64
 
	m´p2
;

534 
__Ë32
 
	mfid
;

535 
__Ë32
 
	mdwÜd11
;

536 
__u32
 
	mrsvd12
[4];

539 
	snvme_ü—‹_cq
 {

540 
__u8
 
	mİcode
;

541 
__u8
 
	mæags
;

542 
__u16
 
	mcommªd_id
;

543 
__u32
 
	mrsvd1
[5];

544 
__Ë64
 
	m´p1
;

545 
__u64
 
	mrsvd8
;

546 
__Ë16
 
	mcqid
;

547 
__Ë16
 
	mqsize
;

548 
__Ë16
 
	mcq_æags
;

549 
__Ë16
 
	mœq_veùÜ
;

550 
__u32
 
	mrsvd12
[4];

553 
	snvme_ü—‹_sq
 {

554 
__u8
 
	mİcode
;

555 
__u8
 
	mæags
;

556 
__u16
 
	mcommªd_id
;

557 
__u32
 
	mrsvd1
[5];

558 
__Ë64
 
	m´p1
;

559 
__u64
 
	mrsvd8
;

560 
__Ë16
 
	msqid
;

561 
__Ë16
 
	mqsize
;

562 
__Ë16
 
	msq_æags
;

563 
__Ë16
 
	mcqid
;

564 
__u32
 
	mrsvd12
[4];

567 
	snvme_d–‘e_queue
 {

568 
__u8
 
	mİcode
;

569 
__u8
 
	mæags
;

570 
__u16
 
	mcommªd_id
;

571 
__u32
 
	mrsvd1
[9];

572 
__Ë16
 
	mqid
;

573 
__u16
 
	mrsvd10
;

574 
__u32
 
	mrsvd11
[5];

577 
	snvme_dowÆßd_fœmw¬e
 {

578 
__u8
 
	mİcode
;

579 
__u8
 
	mæags
;

580 
__u16
 
	mcommªd_id
;

581 
__u32
 
	mrsvd1
[5];

582 
__Ë64
 
	m´p1
;

583 
__Ë64
 
	m´p2
;

584 
__Ë32
 
	mnumd
;

585 
__Ë32
 
	moff£t
;

586 
__u32
 
	mrsvd12
[4];

589 
	snvme_fÜm©_cmd
 {

590 
__u8
 
	mİcode
;

591 
__u8
 
	mæags
;

592 
__u16
 
	mcommªd_id
;

593 
__Ë32
 
	mnsid
;

594 
__u64
 
	mrsvd2
[4];

595 
__Ë32
 
	mcdw10
;

596 
__u32
 
	mrsvd11
[5];

599 
	snvme_commªd
 {

601 
nvme_commÚ_commªd
 
	mcommÚ
;

602 
nvme_rw_commªd
 
	mrw
;

603 
nvme_id’tify
 
	mid’tify
;

604 
nvme_ã©u»s
 
	mã©u»s
;

605 
nvme_ü—‹_cq
 
	mü—‹_cq
;

606 
nvme_ü—‹_sq
 
	mü—‹_sq
;

607 
nvme_d–‘e_queue
 
	md–‘e_queue
;

608 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

609 
nvme_fÜm©_cmd
 
	mfÜm©
;

610 
nvme_dsm_cmd
 
	mdsm
;

612 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

613 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

614 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

615 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

616 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

617 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

618 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

625 
	mNVME_SC_SUCCESS
 = 0x0,

626 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

627 
	mNVME_SC_INVALID_FIELD
 = 0x2,

628 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

629 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

630 
	mNVME_SC_POWER_LOSS
 = 0x5,

631 
	mNVME_SC_INTERNAL
 = 0x6,

632 
	mNVME_SC_ABORT_REQ
 = 0x7,

633 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

634 
	mNVME_SC_FUSED_FAIL
 = 0x9,

635 
	mNVME_SC_FUSED_MISSING
 = 0xa,

636 
	mNVME_SC_INVALID_NS
 = 0xb,

637 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

638 
	mNVME_SC_LBA_RANGE
 = 0x80,

639 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

640 
	mNVME_SC_NS_NOT_READY
 = 0x82,

641 
	mNVME_SC_CQ_INVALID
 = 0x100,

642 
	mNVME_SC_QID_INVALID
 = 0x101,

643 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

644 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

645 
	mNVME_SC_ABORT_MISSING
 = 0x104,

646 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

647 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

648 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

649 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

650 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

651 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

652 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

653 
	mNVME_SC_WRITE_FAULT
 = 0x280,

654 
	mNVME_SC_READ_ERROR
 = 0x281,

655 
	mNVME_SC_GUARD_CHECK
 = 0x282,

656 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

657 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

658 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

659 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

662 
	snvme_com¶‘iÚ
 {

663 
__Ë32
 
	m»suÉ
;

664 
__u32
 
	mrsvd
;

665 
__Ë16
 
	msq_h—d
;

666 
__Ë16
 
	msq_id
;

667 
__u16
 
	mcommªd_id
;

668 
__Ë16
 
	m¡©us
;

671 
	snvme_u£r_io
 {

672 
__u8
 
	mİcode
;

673 
__u8
 
	mæags
;

674 
__u16
 
	mcÚŒŞ
;

675 
__u16
 
	mnblocks
;

676 
__u16
 
	mrsvd
;

677 
__u64
 
	mm‘ad©a
;

678 
__u64
 
	maddr
;

679 
__u64
 
	m¦ba
;

680 
__u32
 
	mdsmgmt
;

681 
__u32
 
	m»áag
;

682 
__u16
 
	m­±ag
;

683 
__u16
 
	m­pmask
;

686 
	snvme_admš_cmd
 {

687 
__u8
 
	mİcode
;

688 
__u8
 
	mæags
;

689 
__u16
 
	mrsvd1
;

690 
__u32
 
	mnsid
;

691 
__u32
 
	mcdw2
;

692 
__u32
 
	mcdw3
;

693 
__u64
 
	mm‘ad©a
;

694 
__u64
 
	maddr
;

695 
__u32
 
	mm‘ad©a_Ën
;

696 
__u32
 
	md©a_Ën
;

697 
__u32
 
	mcdw10
;

698 
__u32
 
	mcdw11
;

699 
__u32
 
	mcdw12
;

700 
__u32
 
	mcdw13
;

701 
__u32
 
	mcdw14
;

702 
__u32
 
	mcdw15
;

703 
__u32
 
	mtimeout_ms
;

704 
__u32
 
	m»suÉ
;

707 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

708 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

709 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

713 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

714 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

715 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

717 
	#KVS_SUCCESS
 0

	)

718 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

719 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

720 
	#KVS_ERR_CLOSE
 (-3)

	)

721 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

722 
	#KVS_ERR_CONT_NAME
 (-5)

	)

723 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

724 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

725 
	#KVS_ERR_GROUP
 (-8)

	)

726 
	#KVS_ERR_INDEX
 (-9)

	)

727 
	#KVS_ERR_IO
 (-10)

	)

728 
	#KVS_ERR_KEY
 (-11)

	)

729 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

730 
	#KVS_ERR_MEMORY
 (-13)

	)

731 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

732 
	#KVS_ERR_OFFSET
 (-15)

	)

733 
	#KVS_ERR_OPEN
 (-16)

	)

734 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

735 
	#KVS_ERR_PERMISSION
 (-18)

	)

736 
	#KVS_ERR_SPACE
 (-19)

	)

737 
	#KVS_ERR_TIMEOUT
 (-20)

	)

738 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

739 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

740 
	#KVS_ERR_VALUE
 (-23)

	)

745 
	snvme_·s¡hru_kv_cmd
 {

746 
__u8
 
	mİcode
;

747 
__u8
 
	mæags
;

748 
__u16
 
	mrsvd1
;

749 
__u32
 
	mnsid
;

750 
__u32
 
	mcdw2
;

751 
__u32
 
	mcdw3
;

752 
__u32
 
	mcdw4
;

753 
__u32
 
	mcdw5
;

754 
__u64
 
	md©a_addr
;

755 
__u32
 
	md©a_Ëngth
;

756 
__u32
 
	mkey_Ëngth
;

757 
__u32
 
	mcdw10
;

758 
__u32
 
	mcdw11
;

761 
__u64
 
	mkey_addr
;

762 
__u32
 
	mrsvd5
;

763 
__u32
 
	mrsvd6
;

765 
__u8
 
	mkey
[16];

767 
__u32
 
	mcdw12
;

768 
__u32
 
	mcdw13
;

769 
__u32
 
	mcdw14
;

770 
__u32
 
	mcdw15
;

773 
__u32
 
	mtimeout_ms
;

774 
__u32
 
	m»suÉ
;

775 
__u32
 
	m¡©us
;

776 
__u32
 
	mùxid
;

777 
__u64
 
	m»qid
;

780 
	snvme_aioùx
 {

781 
__u32
 
	mùxid
;

782 
__u32
 
	mev’tfd
;

786 
	snvme_aiÛv’t
 {

787 
__u64
 
	m»qid
;

788 
__u32
 
	mùxid
;

789 
__u32
 
	m»suÉ
;

790 
__u16
 
	m¡©us
;

793 
	#MAX_AIO_EVENTS
 128

	)

794 
	snvme_aiÛv’ts
 {

795 
__u16
 
	mÄ
;

796 
__u32
 
	mùxid
;

797 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

800 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

801 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

802 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

803 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

804 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

807 #ifdeà
__KERNEL__


808 
	~<lšux/pci.h
>

809 
	~<lšux/miscdeviû.h
>

810 
	~<lšux/k»f.h
>

812 
	#NVME_IO_TIMEOUT
 (5 * 
HZ
)

	)

817 
	snvme_dev
 {

818 
li¡_h—d
 
	mnode
;

819 
nvme_queue
 **
	mqueues
;

820 
u32
 
__iomem
 *
	mdbs
;

821 
pci_dev
 *
	mpci_dev
;

822 
dma_poŞ
 *
	m´p_·ge_poŞ
;

823 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

824 
	mš¡ªû
;

825 
	mqueue_couÁ
;

826 
	mdb_¡ride
;

827 
u32
 
	mù¾_cÚfig
;

828 
msix_’Œy
 *
	m’Œy
;

829 
nvme_b¬
 
__iomem
 *
	mb¬
;

830 
li¡_h—d
 
	mÇme¥aûs
;

831 
k»f
 
	mk»f
;

832 
miscdeviû
 
	mmiscdev
;

833 
	mÇme
[12];

834 
	m£rŸl
[20];

835 
	mmod–
[40];

836 
	mfœmw¬e_»v
[8];

837 
u32
 
	mmax_hw_£ùÜs
;

838 
u32
 
	m¡re_size
;

839 
u16
 
	mÚcs
;

845 
	snvme_ns
 {

846 
li¡_h—d
 
	mli¡
;

848 
nvme_dev
 *
	mdev
;

849 
»que¡_queue
 *
	mqueue
;

850 
g’disk
 *
	mdisk
;

852 
	mns_id
;

853 
	mlba_shiá
;

854 
	mms
;

855 
u64
 
	mmode_£Ëù_num_blocks
;

856 
u32
 
	mmode_£Ëù_block_Ën
;

865 
	snvme_iod
 {

866 *
	m´iv©e
;

867 
	mÅages
;

868 
	moff£t
;

869 
	mÃÁs
;

870 
	mËngth
;

871 
dma_addr_t
 
	mfœ¡_dma
;

872 
sÿ‰”li¡
 
	msg
[0];

875 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

877  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

878 
	}
}

885 
nvme_ä“_iod
(
nvme_dev
 *
dev
, 
nvme_iod
 *
iod
);

887 
nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
nvme_commÚ_commªd
 *
cmd
,

888 
nvme_iod
 *
iod
, 
tÙ®_Ën
, 
gå_t
 
gå
);

889 
nvme_iod
 *
nvme_m­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

890 
addr
, 
Ëngth
);

891 
nvme_unm­_u£r_·ges
(
nvme_dev
 *
dev
, 
wr™e
,

892 
nvme_iod
 *
iod
);

893 
nvme_queue
 *
g‘_nvmeq
(
nvme_dev
 *
dev
);

894 
put_nvmeq
(
nvme_queue
 *
nvmeq
);

895 
nvme_subm™_sync_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_commªd
 *
cmd
,

896 
u32
 *
»suÉ
, 
timeout
);

897 
nvme_subm™_æush_d©a
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
);

898 
nvme_subm™_admš_cmd
(
nvme_dev
 *, 
nvme_commªd
 *,

899 
u32
 *
»suÉ
);

900 
nvme_id’tify
(
nvme_dev
 *, 
nsid
, 
ús
,

901 
dma_addr_t
 
dma_addr
);

902 
nvme_g‘_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
nsid
,

903 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
);

904 
nvme_£t_ã©u»s
(
nvme_dev
 *
dev
, 
fid
, 
dwÜd11
,

905 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
);

907 
	gsg_io_hdr
;

909 
nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
);

910 
nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

);

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10/scsi.h

8 #iâdeà
_SCSI_SCSI_H


9 
	#_SCSI_SCSI_H


	)

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/sÿ‰”li¡.h
>

14 
	gscsi_cmnd
;

23 
	#SCSI_MAX_SG_SEGMENTS
 128

	)

29 #ifdeà
ARCH_HAS_SG_CHAIN


30 
	#SCSI_MAX_SG_CHAIN_SEGMENTS
 2048

	)

32 
	#SCSI_MAX_SG_CHAIN_SEGMENTS
 
SCSI_MAX_SG_SEGMENTS


	)

39 
	#SCSI_MAX_PROT_SG_SEGMENTS
 0xFFFF

	)

45 
	#SCAN_WILD_CARD
 ~0

	)

51 
	#TEST_UNIT_READY
 0x00

	)

52 
	#REZERO_UNIT
 0x01

	)

53 
	#REQUEST_SENSE
 0x03

	)

54 
	#FORMAT_UNIT
 0x04

	)

55 
	#READ_BLOCK_LIMITS
 0x05

	)

56 
	#REASSIGN_BLOCKS
 0x07

	)

57 
	#INITIALIZE_ELEMENT_STATUS
 0x07

	)

58 
	#READ_6
 0x08

	)

59 
	#WRITE_6
 0x0a

	)

60 
	#SEEK_6
 0x0b

	)

61 
	#READ_REVERSE
 0x0f

	)

62 
	#WRITE_FILEMARKS
 0x10

	)

63 
	#SPACE
 0x11

	)

64 
	#INQUIRY
 0x12

	)

65 
	#RECOVER_BUFFERED_DATA
 0x14

	)

66 
	#MODE_SELECT
 0x15

	)

67 
	#RESERVE
 0x16

	)

68 
	#RELEASE
 0x17

	)

69 
	#COPY
 0x18

	)

70 
	#ERASE
 0x19

	)

71 
	#MODE_SENSE
 0x1a

	)

72 
	#START_STOP
 0x1b

	)

73 
	#RECEIVE_DIAGNOSTIC
 0x1c

	)

74 
	#SEND_DIAGNOSTIC
 0x1d

	)

75 
	#ALLOW_MEDIUM_REMOVAL
 0x1e

	)

77 
	#READ_FORMAT_CAPACITIES
 0x23

	)

78 
	#SET_WINDOW
 0x24

	)

79 
	#READ_CAPACITY
 0x25

	)

80 
	#READ_10
 0x28

	)

81 
	#WRITE_10
 0x2a

	)

82 
	#SEEK_10
 0x2b

	)

83 
	#POSITION_TO_ELEMENT
 0x2b

	)

84 
	#WRITE_VERIFY
 0x2e

	)

85 
	#VERIFY
 0x2f

	)

86 
	#SEARCH_HIGH
 0x30

	)

87 
	#SEARCH_EQUAL
 0x31

	)

88 
	#SEARCH_LOW
 0x32

	)

89 
	#SET_LIMITS
 0x33

	)

90 
	#PRE_FETCH
 0x34

	)

91 
	#READ_POSITION
 0x34

	)

92 
	#SYNCHRONIZE_CACHE
 0x35

	)

93 
	#LOCK_UNLOCK_CACHE
 0x36

	)

94 
	#READ_DEFECT_DATA
 0x37

	)

95 
	#MEDIUM_SCAN
 0x38

	)

96 
	#COMPARE
 0x39

	)

97 
	#COPY_VERIFY
 0x3a

	)

98 
	#WRITE_BUFFER
 0x3b

	)

99 
	#READ_BUFFER
 0x3c

	)

100 
	#UPDATE_BLOCK
 0x3d

	)

101 
	#READ_LONG
 0x3e

	)

102 
	#WRITE_LONG
 0x3f

	)

103 
	#CHANGE_DEFINITION
 0x40

	)

104 
	#WRITE_SAME
 0x41

	)

105 
	#UNMAP
 0x42

	)

106 
	#READ_TOC
 0x43

	)

107 
	#READ_HEADER
 0x44

	)

108 
	#GET_EVENT_STATUS_NOTIFICATION
 0x4a

	)

109 
	#LOG_SELECT
 0x4c

	)

110 
	#LOG_SENSE
 0x4d

	)

111 
	#XDWRITEREAD_10
 0x53

	)

112 
	#MODE_SELECT_10
 0x55

	)

113 
	#RESERVE_10
 0x56

	)

114 
	#RELEASE_10
 0x57

	)

115 
	#MODE_SENSE_10
 0x5a

	)

116 
	#PERSISTENT_RESERVE_IN
 0x5e

	)

117 
	#PERSISTENT_RESERVE_OUT
 0x5f

	)

118 
	#VARIABLE_LENGTH_CMD
 0x7f

	)

119 
	#REPORT_LUNS
 0xa0

	)

120 
	#SECURITY_PROTOCOL_IN
 0xa2

	)

121 
	#MAINTENANCE_IN
 0xa3

	)

122 
	#MAINTENANCE_OUT
 0xa4

	)

123 
	#MOVE_MEDIUM
 0xa5

	)

124 
	#EXCHANGE_MEDIUM
 0xa6

	)

125 
	#READ_12
 0xa8

	)

126 
	#WRITE_12
 0x¯

	)

127 
	#READ_MEDIA_SERIAL_NUMBER
 0xab

	)

128 
	#WRITE_VERIFY_12
 0x«

	)

129 
	#VERIFY_12
 0xaf

	)

130 
	#SEARCH_HIGH_12
 0xb0

	)

131 
	#SEARCH_EQUAL_12
 0xb1

	)

132 
	#SEARCH_LOW_12
 0xb2

	)

133 
	#SECURITY_PROTOCOL_OUT
 0xb5

	)

134 
	#READ_ELEMENT_STATUS
 0xb8

	)

135 
	#SEND_VOLUME_TAG
 0xb6

	)

136 
	#WRITE_LONG_2
 0x—

	)

137 
	#EXTENDED_COPY
 0x83

	)

138 
	#RECEIVE_COPY_RESULTS
 0x84

	)

139 
	#ACCESS_CONTROL_IN
 0x86

	)

140 
	#ACCESS_CONTROL_OUT
 0x87

	)

141 
	#READ_16
 0x88

	)

142 
	#WRITE_16
 0x8a

	)

143 
	#READ_ATTRIBUTE
 0x8c

	)

144 
	#WRITE_ATTRIBUTE
 0x8d

	)

145 
	#VERIFY_16
 0x8f

	)

146 
	#SYNCHRONIZE_CACHE_16
 0x91

	)

147 
	#WRITE_SAME_16
 0x93

	)

148 
	#SERVICE_ACTION_IN
 0x9e

	)

150 
	#SAI_READ_CAPACITY_16
 0x10

	)

151 
	#SAI_GET_LBA_STATUS
 0x12

	)

154 
	#VLC_SA_RECEIVE_CREDENTIAL
 0x1800

	)

156 
	#MI_REPORT_IDENTIFYING_INFORMATION
 0x05

	)

157 
	#MI_REPORT_TARGET_PGS
 0x0a

	)

158 
	#MI_REPORT_ALIASES
 0x0b

	)

159 
	#MI_REPORT_SUPPORTED_OPERATION_CODES
 0x0c

	)

160 
	#MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
 0x0d

	)

161 
	#MI_REPORT_PRIORITY
 0x0e

	)

162 
	#MI_REPORT_TIMESTAMP
 0x0f

	)

163 
	#MI_MANAGEMENT_PROTOCOL_IN
 0x10

	)

165 
	#MI_EXT_HDR_PARAM_FMT
 0x20

	)

167 
	#MO_SET_IDENTIFYING_INFORMATION
 0x06

	)

168 
	#MO_SET_TARGET_PGS
 0x0a

	)

169 
	#MO_CHANGE_ALIASES
 0x0b

	)

170 
	#MO_SET_PRIORITY
 0x0e

	)

171 
	#MO_SET_TIMESTAMP
 0x0f

	)

172 
	#MO_MANAGEMENT_PROTOCOL_OUT
 0x10

	)

174 
	#XDREAD_32
 0x03

	)

175 
	#XDWRITE_32
 0x04

	)

176 
	#XPWRITE_32
 0x06

	)

177 
	#XDWRITEREAD_32
 0x07

	)

178 
	#READ_32
 0x09

	)

179 
	#VERIFY_32
 0x0a

	)

180 
	#WRITE_32
 0x0b

	)

181 
	#WRITE_SAME_32
 0x0d

	)

184 
	#ATA_16
 0x85

	)

185 
	#ATA_12
 0xa1

	)

191 
	#SCSI_MAX_VARLEN_CDB_SIZE
 260

	)

194 
	sscsi_v¬Ën_cdb_hdr
 {

195 
__u8
 
	mİcode
;

196 
__u8
 
	mcÚŒŞ
;

197 
__u8
 
	mmisc
[5];

198 
__u8
 
	madd™iÚ®_cdb_Ëngth
;

199 
__be16
 
	m£rviû_aùiÚ
;

203 
šlše
 

204 
	$scsi_v¬Ën_cdb_Ëngth
(cÚ¡ *
hdr
)

206  ((
scsi_v¬Ën_cdb_hdr
 *)
hdr
)->
add™iÚ®_cdb_Ëngth
 + 8;

207 
	}
}

209 cÚ¡ 
scsi_commªd_size_tbl
[8];

210 
	#COMMAND_SIZE
(
İcode
è
scsi_commªd_size_tbl
[((İcodeè>> 5è& 7]

	)

212 
šlše
 

213 
	$scsi_commªd_size
(cÚ¡ *
cmnd
)

215  (
cmnd
[0] =ğ
VARIABLE_LENGTH_CMD
) ?

216 
	`scsi_v¬Ën_cdb_Ëngth
(
cmnd
è: 
	`COMMAND_SIZE
(cmnd[0]);

217 
	}
}

219 #ifdeà
CONFIG_ACPI


220 
	gaıi_bus_ty³
;

223 
scsi_»gi¡”_aıi_bus_ty³
(
aıi_bus_ty³
 *
bus
);

226 
scsi_uÄegi¡”_aıi_bus_ty³
(
aıi_bus_ty³
 *
bus
);

233 
	#SAM_STAT_GOOD
 0x00

	)

234 
	#SAM_STAT_CHECK_CONDITION
 0x02

	)

235 
	#SAM_STAT_CONDITION_MET
 0x04

	)

236 
	#SAM_STAT_BUSY
 0x08

	)

237 
	#SAM_STAT_INTERMEDIATE
 0x10

	)

238 
	#SAM_STAT_INTERMEDIATE_CONDITION_MET
 0x14

	)

239 
	#SAM_STAT_RESERVATION_CONFLICT
 0x18

	)

240 
	#SAM_STAT_COMMAND_TERMINATED
 0x22

	)

241 
	#SAM_STAT_TASK_SET_FULL
 0x28

	)

242 
	#SAM_STAT_ACA_ACTIVE
 0x30

	)

243 
	#SAM_STAT_TASK_ABORTED
 0x40

	)

253 
šlše
 
	$scsi_¡©us_is_good
(
¡©us
)

260 
¡©us
 &= 0xfe;

261  ((
¡©us
 =ğ
SAM_STAT_GOOD
) ||

262 (
¡©us
 =ğ
SAM_STAT_INTERMEDIATE
) ||

263 (
¡©us
 =ğ
SAM_STAT_INTERMEDIATE_CONDITION_MET
) ||

265 (
¡©us
 =ğ
SAM_STAT_COMMAND_TERMINATED
));

266 
	}
}

275 
	#GOOD
 0x00

	)

276 
	#CHECK_CONDITION
 0x01

	)

277 
	#CONDITION_GOOD
 0x02

	)

278 
	#BUSY
 0x04

	)

279 
	#INTERMEDIATE_GOOD
 0x08

	)

280 
	#INTERMEDIATE_C_GOOD
 0x0a

	)

281 
	#RESERVATION_CONFLICT
 0x0c

	)

282 
	#COMMAND_TERMINATED
 0x11

	)

283 
	#QUEUE_FULL
 0x14

	)

284 
	#ACA_ACTIVE
 0x18

	)

285 
	#TASK_ABORTED
 0x20

	)

287 
	#STATUS_MASK
 0xã

	)

293 
	#NO_SENSE
 0x00

	)

294 
	#RECOVERED_ERROR
 0x01

	)

295 
	#NOT_READY
 0x02

	)

296 
	#MEDIUM_ERROR
 0x03

	)

297 
	#HARDWARE_ERROR
 0x04

	)

298 
	#ILLEGAL_REQUEST
 0x05

	)

299 
	#UNIT_ATTENTION
 0x06

	)

300 
	#DATA_PROTECT
 0x07

	)

301 
	#BLANK_CHECK
 0x08

	)

302 
	#COPY_ABORTED
 0x0a

	)

303 
	#ABORTED_COMMAND
 0x0b

	)

304 
	#VOLUME_OVERFLOW
 0x0d

	)

305 
	#MISCOMPARE
 0x0e

	)

313 
	#TYPE_DISK
 0x00

	)

314 
	#TYPE_TAPE
 0x01

	)

315 
	#TYPE_PRINTER
 0x02

	)

316 
	#TYPE_PROCESSOR
 0x03

	)

317 
	#TYPE_WORM
 0x04

	)

318 
	#TYPE_ROM
 0x05

	)

319 
	#TYPE_SCANNER
 0x06

	)

320 
	#TYPE_MOD
 0x07

	)

322 
	#TYPE_MEDIUM_CHANGER
 0x08

	)

323 
	#TYPE_COMM
 0x09

	)

324 
	#TYPE_RAID
 0x0c

	)

325 
	#TYPE_ENCLOSURE
 0x0d

	)

326 
	#TYPE_RBC
 0x0e

	)

327 
	#TYPE_OSD
 0x11

	)

328 
	#TYPE_NO_LUN
 0x7f

	)

331 
	escsi_´ÙocŞ
 {

332 
	mSCSI_PROTOCOL_FCP
 = 0,

333 
	mSCSI_PROTOCOL_SPI
 = 1,

334 
	mSCSI_PROTOCOL_SSA
 = 2,

335 
	mSCSI_PROTOCOL_SBP
 = 3,

336 
	mSCSI_PROTOCOL_SRP
 = 4,

337 
	mSCSI_PROTOCOL_ISCSI
 = 5,

338 
	mSCSI_PROTOCOL_SAS
 = 6,

339 
	mSCSI_PROTOCOL_ADT
 = 7,

340 
	mSCSI_PROTOCOL_ATA
 = 8,

341 
	mSCSI_PROTOCOL_UNSPEC
 = 0xf,

345 cÚ¡ * 
scsi_deviû_ty³
(
ty³
);

351 
	sccs_mode£l_h—d
 {

352 
__u8
 
	m_r1
;

353 
__u8
 
	mmedium
;

354 
__u8
 
	m_r2
;

355 
__u8
 
	mblock_desc_Ëngth
;

356 
__u8
 
	md’s™y
;

357 
__u8
 
	mnumb”_blocks_hi
;

358 
__u8
 
	mnumb”_blocks_med
;

359 
__u8
 
	mnumb”_blocks_lo
;

360 
__u8
 
	m_r3
;

361 
__u8
 
	mblock_Ëngth_hi
;

362 
__u8
 
	mblock_Ëngth_med
;

363 
__u8
 
	mblock_Ëngth_lo
;

369 
	sscsi_lun
 {

370 
__u8
 
	mscsi_lun
[8];

376 
	#SCSI_W_LUN_BASE
 0xc100

	)

377 
	#SCSI_W_LUN_REPORT_LUNS
 (
SCSI_W_LUN_BASE
 + 1)

	)

378 
	#SCSI_W_LUN_ACCESS_CONTROL
 (
SCSI_W_LUN_BASE
 + 2)

	)

379 
	#SCSI_W_LUN_TARGET_LOG_PAGE
 (
SCSI_W_LUN_BASE
 + 3)

	)

381 
šlše
 
	$scsi_is_wlun
(
lun
)

383  (
lun
 & 0xff00è=ğ
SCSI_W_LUN_BASE
;

384 
	}
}

391 
	#COMMAND_COMPLETE
 0x00

	)

392 
	#EXTENDED_MESSAGE
 0x01

	)

393 
	#EXTENDED_MODIFY_DATA_POINTER
 0x00

	)

394 
	#EXTENDED_SDTR
 0x01

	)

395 
	#EXTENDED_EXTENDED_IDENTIFY
 0x02

	)

396 
	#EXTENDED_WDTR
 0x03

	)

397 
	#EXTENDED_PPR
 0x04

	)

398 
	#EXTENDED_MODIFY_BIDI_DATA_PTR
 0x05

	)

399 
	#SAVE_POINTERS
 0x02

	)

400 
	#RESTORE_POINTERS
 0x03

	)

401 
	#DISCONNECT
 0x04

	)

402 
	#INITIATOR_ERROR
 0x05

	)

403 
	#ABORT_TASK_SET
 0x06

	)

404 
	#MESSAGE_REJECT
 0x07

	)

405 
	#NOP
 0x08

	)

406 
	#MSG_PARITY_ERROR
 0x09

	)

407 
	#LINKED_CMD_COMPLETE
 0x0a

	)

408 
	#LINKED_FLG_CMD_COMPLETE
 0x0b

	)

409 
	#TARGET_RESET
 0x0c

	)

410 
	#ABORT_TASK
 0x0d

	)

411 
	#CLEAR_TASK_SET
 0x0e

	)

412 
	#INITIATE_RECOVERY
 0x0à

	)

413 
	#RELEASE_RECOVERY
 0x10

	)

414 
	#CLEAR_ACA
 0x16

	)

415 
	#LOGICAL_UNIT_RESET
 0x17

	)

416 
	#SIMPLE_QUEUE_TAG
 0x20

	)

417 
	#HEAD_OF_QUEUE_TAG
 0x21

	)

418 
	#ORDERED_QUEUE_TAG
 0x22

	)

419 
	#IGNORE_WIDE_RESIDUE
 0x23

	)

420 
	#ACA
 0x24

	)

421 
	#QAS_REQUEST
 0x55

	)

424 
	#BUS_DEVICE_RESET
 
TARGET_RESET


	)

425 
	#ABORT
 
ABORT_TASK_SET


	)

431 
	#DID_OK
 0x00

	)

432 
	#DID_NO_CONNECT
 0x01

	)

433 
	#DID_BUS_BUSY
 0x02

	)

434 
	#DID_TIME_OUT
 0x03

	)

435 
	#DID_BAD_TARGET
 0x04

	)

436 
	#DID_ABORT
 0x05

	)

437 
	#DID_PARITY
 0x06

	)

438 
	#DID_ERROR
 0x07

	)

439 
	#DID_RESET
 0x08

	)

440 
	#DID_BAD_INTR
 0x09

	)

441 
	#DID_PASSTHROUGH
 0x0¨

	)

442 
	#DID_SOFT_ERROR
 0x0b

	)

443 
	#DID_IMM_RETRY
 0x0ø

	)

444 
	#DID_REQUEUE
 0x0d

	)

446 
	#DID_TRANSPORT_DISRUPTED
 0x0

	)

450 
	#DID_TRANSPORT_FAILFAST
 0x0à

	)

451 
	#DID_TARGET_FAILURE
 0x10

	)

453 
	#DID_NEXUS_FAILURE
 0x11

	)

455 
	#DRIVER_OK
 0x00

	)

461 
	#DRIVER_BUSY
 0x01

	)

462 
	#DRIVER_SOFT
 0x02

	)

463 
	#DRIVER_MEDIA
 0x03

	)

464 
	#DRIVER_ERROR
 0x04

	)

466 
	#DRIVER_INVALID
 0x05

	)

467 
	#DRIVER_TIMEOUT
 0x06

	)

468 
	#DRIVER_HARD
 0x07

	)

469 
	#DRIVER_SENSE
 0x08

	)

475 
	#NEEDS_RETRY
 0x2001

	)

476 
	#SUCCESS
 0x2002

	)

477 
	#FAILED
 0x2003

	)

478 
	#QUEUED
 0x2004

	)

479 
	#SOFT_ERROR
 0x2005

	)

480 
	#ADD_TO_MLQUEUE
 0x2006

	)

481 
	#TIMEOUT_ERROR
 0x2007

	)

482 
	#SCSI_RETURN_NOT_HANDLED
 0x2008

	)

483 
	#FAST_IO_FAIL
 0x2009

	)

484 
	#TARGET_ERROR
 0x200A

	)

489 
	#SCSI_MLQUEUE_HOST_BUSY
 0x1055

	)

490 
	#SCSI_MLQUEUE_DEVICE_BUSY
 0x1056

	)

491 
	#SCSI_MLQUEUE_EH_RETRY
 0x1057

	)

492 
	#SCSI_MLQUEUE_TARGET_BUSY
 0x1058

	)

504 
	#¡©us_by‹
(
»suÉ
è((ÔesuÉè>> 1è& 0x7f)

	)

505 
	#msg_by‹
(
»suÉ
è((ÔesuÉè>> 8è& 0xff)

	)

506 
	#ho¡_by‹
(
»suÉ
è((ÔesuÉè>> 16è& 0xff)

	)

507 
	#driv”_by‹
(
»suÉ
è((ÔesuÉè>> 24è& 0xff)

	)

509 
	#£n£_şass
(
£n£
è(((£n£è>> 4è& 0x7)

	)

510 
	#£n£_”rÜ
(
£n£
è((£n£è& 0xf)

	)

511 
	#£n£_v®id
(
£n£
è((£n£è& 0x80)

	)

516 
	#FORMAT_UNIT_TIMEOUT
 (2 * 60 * 60 * 
HZ
)

	)

517 
	#START_STOP_TIMEOUT
 (60 * 
HZ
)

	)

518 
	#MOVE_MEDIUM_TIMEOUT
 (5 * 60 * 
HZ
)

	)

519 
	#READ_ELEMENT_STATUS_TIMEOUT
 (5 * 60 * 
HZ
)

	)

520 
	#READ_DEFECT_DATA_TIMEOUT
 (60 * 
HZ
 )

	)

523 
	#IDENTIFY_BASE
 0x80

	)

524 
	#IDENTIFY
(
ÿn_discÚÃù
, 
lun
è(
IDENTIFY_BASE
 |\

525 ((
ÿn_discÚÃù
) ? 0x40 : 0) |\

526 ((
lun
è& 0x07))

	)

535 
	#SCSI_UNKNOWN
 0

	)

536 
	#SCSI_1
 1

	)

537 
	#SCSI_1_CCS
 2

	)

538 
	#SCSI_2
 3

	)

539 
	#SCSI_3
 4

	)

540 
	#SCSI_SPC_2
 5

	)

541 
	#SCSI_SPC_3
 6

	)

546 
	#SCSI_INQ_PQ_CON
 0x00

	)

547 
	#SCSI_INQ_PQ_NOT_CON
 0x01

	)

548 
	#SCSI_INQ_PQ_NOT_CAP
 0x03

	)

558 
	#SCSI_IOCTL_GET_IDLUN
 0x5382

	)

563 
	#SCSI_IOCTL_PROBE_HOST
 0x5385

	)

566 
	#SCSI_IOCTL_GET_BUS_NUMBER
 0x5386

	)

569 
	#SCSI_IOCTL_GET_PCI
 0x5387

	)

572 
šlše
 
__u32
 
	$scsi_to_u32
(
__u8
 *
±r
)

574  (
±r
[0]<<24) + (ptr[1]<<16) + (ptr[2]<<8) +…tr[3];

575 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v3.10/sg.h

1 #iâdeà
_SCSI_GENERIC_H


2 
	#_SCSI_GENERIC_H


	)

4 
	~<lšux/comp”.h
>

73 #ifdeà
__KERNEL__


74 
sg_big_buff
;

79 
	ssg_iovec


81 
__u£r
 *
	miov_ba£
;

82 
size_t
 
	miov_Ën
;

83 } 
	tsg_iovec_t
;

86 
	ssg_io_hdr


88 
	mš‹rçû_id
;

89 
	mdxãr_dœeùiÚ
;

90 
	mcmd_Ën
;

91 
	mmx_sb_Ën
;

92 
	miovec_couÁ
;

93 
	mdxãr_Ën
;

94 
__u£r
 *
	mdxã½
;

96 
__u£r
 *
	mcmdp
;

97 
__u£r
 *
	msbp
;

98 
	mtimeout
;

99 
	mæags
;

100 
	m·ck_id
;

101 
__u£r
 * 
	mu¤_±r
;

102 
	m¡©us
;

103 
	mmasked_¡©us
;

104 
	mmsg_¡©us
;

105 
	msb_Ën_wr
;

106 
	mho¡_¡©us
;

107 
	mdriv”_¡©us
;

108 
	m»sid
;

109 
	mdu¿tiÚ
;

110 
	mšfo
;

111 } 
	tsg_io_hdr_t
;

113 
	#SG_INTERFACE_ID_ORIG
 'S'

	)

116 
	#SG_DXFER_NONE
 (-1è

	)

117 
	#SG_DXFER_TO_DEV
 (-2è

	)

118 
	#SG_DXFER_FROM_DEV
 (-3è

	)

119 
	#SG_DXFER_TO_FROM_DEV
 (-4è

	)

123 
	#SG_DXFER_UNKNOWN
 (-5è

	)

126 
	#SG_FLAG_DIRECT_IO
 1

	)

127 
	#SG_FLAG_UNUSED_LUN_INHIBIT
 2

	)

129 
	#SG_FLAG_MMAP_IO
 4

	)

130 
	#SG_FLAG_NO_DXFER
 0x10000

	)

134 
	#SG_INFO_OK_MASK
 0x1

	)

135 
	#SG_INFO_OK
 0x0

	)

136 
	#SG_INFO_CHECK
 0x1

	)

138 
	#SG_INFO_DIRECT_IO_MASK
 0x6

	)

139 
	#SG_INFO_INDIRECT_IO
 0x0

	)

140 
	#SG_INFO_DIRECT_IO
 0x2

	)

141 
	#SG_INFO_MIXED_IO
 0x4

	)

144 
	ssg_scsi_id
 {

145 
	mho¡_no
;

146 
	mchªÃl
;

147 
	mscsi_id
;

148 
	mlun
;

149 
	mscsi_ty³
;

150 
	mh_cmd_³r_lun
;

151 
	md_queue_d•th
;

152 
	munu£d
[2];

153 } 
	tsg_scsi_id_t
;

155 
	ssg_»q_šfo
 {

156 
	m»q_¡©e
;

157 
	mÜphª
;

158 
	msg_io_owÃd
;

159 
	m´obËm
;

160 
	m·ck_id
;

161 
__u£r
 *
	mu¤_±r
;

162 
	mdu¿tiÚ
;

164 
	munu£d
;

165 } 
	tsg_»q_šfo_t
;

172 
	#SG_EMULATED_HOST
 0x2203

	)

176 
	#SG_SET_TRANSFORM
 0x2204

	)

178 
	#SG_GET_TRANSFORM
 0x2205

	)

180 
	#SG_SET_RESERVED_SIZE
 0x2275

	)

181 
	#SG_GET_RESERVED_SIZE
 0x2272

	)

184 
	#SG_GET_SCSI_ID
 0x2276

	)

188 
	#SG_SET_FORCE_LOW_DMA
 0x2279

	)

189 
	#SG_GET_LOW_DMA
 0x227¨

	)

195 
	#SG_SET_FORCE_PACK_ID
 0x227b

	)

196 
	#SG_GET_PACK_ID
 0x227ø

	)

198 
	#SG_GET_NUM_WAITING
 0x227d

	)

201 
	#SG_GET_SG_TABLESIZE
 0x227F

	)

203 
	#SG_GET_VERSION_NUM
 0x2282

	)

206 
	#SG_SCSI_RESET
 0x2284

	)

208 
	#SG_SCSI_RESET_NOTHING
 0

	)

209 
	#SG_SCSI_RESET_DEVICE
 1

	)

210 
	#SG_SCSI_RESET_BUS
 2

	)

211 
	#SG_SCSI_RESET_HOST
 3

	)

212 
	#SG_SCSI_RESET_TARGET
 4

	)

215 
	#SG_IO
 0x2285

	)

217 
	#SG_GET_REQUEST_TABLE
 0x2286

	)

220 
	#SG_SET_KEEP_ORPHAN
 0x2287

	)

221 
	#SG_GET_KEEP_ORPHAN
 0x2288

	)

224 
	#SG_GET_ACCESS_COUNT
 0x2289

	)

227 
	#SG_SCATTER_SZ
 (8 * 4096)

	)

234 
	#SG_DEFAULT_RETRIES
 0

	)

237 
	#SG_DEF_FORCE_LOW_DMA
 0

	)

238 
	#SG_DEF_FORCE_PACK_ID
 0

	)

239 
	#SG_DEF_KEEP_ORPHAN
 0

	)

240 
	#SG_DEF_RESERVED_SIZE
 
SG_SCATTER_SZ


	)

243 
	#SG_MAX_QUEUE
 16

	)

245 
	#SG_BIG_BUFF
 
SG_DEF_RESERVED_SIZE


	)

248 
sg_io_hdr
 
	tSg_io_hdr
;

249 
sg_io_vec
 
	tSg_io_vec
;

250 
sg_scsi_id
 
	tSg_scsi_id
;

251 
sg_»q_šfo
 
	tSg_»q_šfo
;

258 
	#SG_MAX_SENSE
 16

	)

260 
	ssg_h—d”


262 
	m·ck_Ën
;

263 
	m»¶y_Ën
;

264 
	m·ck_id
;

265 
	m»suÉ
;

266 
	mtw–ve_by‹
:1;

268 
	mrg‘_¡©us
:5;

269 
	mho¡_¡©us
:8;

270 
	mdriv”_¡©us
:8;

271 
	mÙh”_æags
:10;

272 
	m£n£_bufãr
[
SG_MAX_SENSE
];

283 
	#SG_SET_TIMEOUT
 0x2201

	)

284 
	#SG_GET_TIMEOUT
 0x2202

	)

289 
	#SG_GET_COMMAND_Q
 0x2270

	)

290 
	#SG_SET_COMMAND_Q
 0x2271

	)

294 
	#SG_SET_DEBUG
 0x227

	)

296 
	#SG_NEXT_CMD_LEN
 0x2283

	)

301 #ifdeà
__KERNEL__


302 
	#SG_DEFAULT_TIMEOUT_USER
 (60*
USER_HZ
è

	)

304 
	#SG_DEFAULT_TIMEOUT
 (60*
HZ
è

	)

307 
	#SG_DEF_COMMAND_Q
 0

	)

309 
	#SG_DEF_UNDERRUN_FLAG
 0

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/´.h
>

26 
	~<lšux/±¿û.h
>

27 
	~<lšux/t10-pi.h
>

28 
	~<lšux/pm_qos.h
>

29 
	~<asm/uÇligÃd.h
>

31 
	~"nvme.h
"

32 
	~<lšux/fe.h
>

33 
	~<lšux/fdbË.h
>

34 
	~<lšux/ev’tfd.h
>

35 
	~<lšux/k»f.h
>

36 
	~<lšux/bio.h
>

37 
	~<lšux/ä“z”.h
>

38 
	~<lšux/wa™.h
>

39 
	~<lšux/kth»ad.h
>

40 
	~<lšux/sk_io_accouÁšg_İs.h
>

41 
	~"lšux_nvme_ioùl.h
"

42 
	~"çbrics.h
"

44 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

46 
	gadmš_timeout
 = 60;

47 
moduË_·¿m
(
admš_timeout
, 
by‹
, 0644);

48 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

49 
EXPORT_SYMBOL_GPL
(
admš_timeout
);

51 
	gnvme_io_timeout
 = 30;

52 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
by‹
, 0644);

53 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

54 
EXPORT_SYMBOL_GPL
(
nvme_io_timeout
);

56 
	gshutdown_timeout
 = 5;

57 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

58 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

60 
u8
 
	gnvme_max_»Œ›s
 = 5;

61 
moduË_·¿m_Çmed
(
max_»Œ›s
, 
nvme_max_»Œ›s
, 
by‹
, 0644);

62 
MODULE_PARM_DESC
(
max_»Œ›s
, "max‚umber of„etries‡ command may have");

64 
	gnvme_ch¬_majÜ
;

65 
moduË_·¿m
(
nvme_ch¬_majÜ
, , 0);

67 
	gdeçuÉ_ps_max_Ï‹ncy_us
 = 100000;

68 
moduË_·¿m
(
deçuÉ_ps_max_Ï‹ncy_us
, 
ulÚg
, 0644);

69 
MODULE_PARM_DESC
(
deçuÉ_ps_max_Ï‹ncy_us
,

72 
boŞ
 
	gfÜû_­¡
;

73 
moduË_·¿m
(
fÜû_­¡
, 
boŞ
, 0644);

74 
MODULE_PARM_DESC
(
fÜû_­¡
, "allow APST for‚ewlyƒnumerated devicesƒven if quirked off");

76 
boŞ
 
	g¡»ams
;

77 
moduË_·¿m
(
¡»ams
, 
boŞ
, 0644);

78 
MODULE_PARM_DESC
(
¡»ams
, "turn on support for Streams write directives");

80 
wÜkqueue_¡ruù
 *
	gnvme_wq
;

81 
EXPORT_SYMBOL_GPL
(
nvme_wq
);

83 
LIST_HEAD
(
nvme_ù¾_li¡
);

84 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

86 
şass
 *
	gnvme_şass
;

94 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

95 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

96 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

97 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

99 
__u32
 
	gaio_cÚ‹xt_id
;

101 
	#AIOCTX_MAX
 1024

	)

102 
	#AIOCB_MAX
 (1024*64)

	)

104 
__u64
 
	gdebug_com¶‘ed
 =0;

105 
	gdebug_out¡ªdšg
 =0;

107 
	snvme_kaioùx


109 
nvme_aioùx
 
	muùx
;

110 
ev’tfd_ùx
 *
	mev’tùx
;

111 
li¡_h—d
 
	mkaiocb_li¡
;

112 
¥šlock_t
 
	mkaioùx_¥šlock
;

113 
k»f
 
	m»f
;

116 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

117 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

119 
	saio_u£r_ùx
 {

120 
	mÃÁs
;

121 
	mËn
;

122 
·ge
 ** 
	m·ges
;

123 
sÿ‰”li¡
 *
	msg
;

124 
	md©a
[1];

127 
	snvme_kaiocb


129 
li¡_h—d
 
	maiocb_li¡
;

130 
nvme_aiÛv’t
 
	mev’t
;

131 
	mİcode
;

132 
nvme_commªd
 
	mcmd
;

133 
g’disk
 *
	mdisk
;

134 
	m¡¬t_time
;

135 
sÿ‰”li¡
 
	mm‘a_sg
;

136 
boŞ
 
	mÃed_to_cİy
;

137 
boŞ
 
	mu£_m‘a
;

138 *
	mkv_d©a
;

139 *
	mm‘a
;

140 
aio_u£r_ùx
 *
	mu£r_ùx
;

141 
aio_u£r_ùx
 *
	mk”Ãl_ùx
;

142 
»que¡
 *
	m»q
;

146 
	saio_wÜk”_ùx
{

147 
	mıu
;

148 
¥šlock_t
 
	mkaiocb_¥šlock
;

149 
li¡_h—d
 
	mkaiocb_li¡
;

150 
wa™_queue_h—d_t
 
	maio_wa™queue
;

154 
aio_wÜk”_ùx
 * 
__³rıu
 
	gaio_w_ùx
;

156 
sk_¡ruù
 ** 
__³rıu
 
	gaio_wÜk”
;

160 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

162 
nvme_kaiocb
 *
tmpcb
;

163 
li¡_h—d
 *
pos
, *
q
;

164 
æags
;

165 ià(
ùx
) {

166 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

167 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

168 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

169 
	`li¡_d–
(
pos
);

170 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

172 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

173 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

174 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

176 
	}
}

178 
	$ş—nup_kaioùx
(
k»f
 *kref) {

179 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

180 
	`»move_kaioùx
(
ùx
);

181 
	}
}

183 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

184 
	`k»f_g‘
(&
ùx
->
»f
);

185 
	}
}

187 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

188 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

189 
	}
}

194 
	$de¡roy_aio_mempoŞ
()

196 
i
 = 0;

197 ià(
g_kaioùx_tb
) {

198 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

199 ià(
g_kaioùx_tb
[
i
]) {

200 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

201 
g_kaioùx_tb
[
i
] = 
NULL
;

204 
	`kä“
(
g_kaioùx_tb
);

205 
g_kaioùx_tb
 = 
NULL
;

207 ià(
kaiocb_mempoŞ
)

208 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

209 ià(
kaioùx_mempoŞ
)

210 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

211 ià(
kaioùx_ÿch•
)

212 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

213 ià(
kaiocb_ÿch•
)

214 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

215 
	}
}

220 
	$aio_£rviû_š™
()

222 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

223 ià(!
g_kaioùx_tb
)

224 
ç
;

225 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

228 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

229 ià(!
kaioùx_ÿch•
)

230 
ç
;

232 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

233 ià(!
kaiocb_ÿch•
)

234 
ç
;

236 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

237 ià(!
kaiocb_mempoŞ
)

238 
ç
;

240 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

241 ià(!
kaioùx_mempoŞ
)

242 
ç
;

246 
aio_cÚ‹xt_id
 = 1;

247 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

248 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

251 
ç
:

252 
	`de¡roy_aio_mempoŞ
();

253  -
ENOMEM
;

254 
	}
}

259 
	$aio_£rviû_ex™
()

261 
	`de¡roy_aio_mempoŞ
();

262 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

264 
	}
}

266 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

267 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

270 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

271 ià(
tmp
è
	`»f_kaioùx
(tmp);

273  
tmp
;

274 
	}
}

280 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

282 
nvme_kaioùx
 *
tmp
;

283 
æags
;

284 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

285 ià(
tmp
) {

286 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

287 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

288 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

289 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

291 
	`´_”r
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

293 
	`d”ef_kaioùx
(
tmp
);

297 
	`´_”r
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

302 
	}
}

308 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

310 
nvme_kaioùx
 
ùx
;

311 
æags
;

312 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

313  -
EFAULT
;

315 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

316 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

317 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

318 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

320 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

322 
	}
}

328 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

330 
nvme_kaioùx
 *
ùx
;

331 
fd
 
efe
;

332 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

333 
æags
;

334 
»t
 = 0;

335 
i
 = 0;

336 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

337  -
EACCES
;

339 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

340 ià(!
ùx
)

341  -
ENOMEM
;

343 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

344  -
EFAULT
;

346 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

347 ià(!
efe
.
fe
) {

348 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

349 
»t
 = -
EBADF
;

350 
ex™
;

353 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

354 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

355 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

356 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

357 
put_efe
;

360 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

361 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

362 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

363 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

364 
aio_cÚ‹xt_id
 = 
i
;

368 ià(
i
 >ğ
AIOCTX_MAX
) {

369 
	`´_”r
("nvme_set_aioctx:oo many‡ioctx open.\n");

370 
»t
 = -
EMFILE
;

371 
put_ev’t_fd
;

374 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

375 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

376 
aio_cÚ‹xt_id
 = 0;

377 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

378 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

379 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

380 
	`k»f_š™
(&
ùx
->
»f
);

381 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

382 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

384 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

386 
	`´_”r
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

387 
»t
 = -
EINVAL
;

388 
ş—nup
;

390 
ev’tfd_ùx
 = 
NULL
;

391 
debug_out¡ªdšg
 = 0;

392 
debug_com¶‘ed
 = 0;

393 
	`fdput
(
efe
);

395 
ş—nup
:

396 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

397 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

398 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

399 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

400 
put_ev’t_fd
:

401 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

402 
put_efe
:

403 
	`fdput
(
efe
);

404 
ex™
:

405  
»t
;

406 
	}
}

410 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

411 
nvme_kaiocb
 *
»q
;

412 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

413 ià(!
»q
)  0;

415 
	`mem£t
(
»q
, 0, (*req));

417 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

419 
»q
->
ev’t
.
»qid
 =„eqid;

421  
»q
;

422 
	}
}

426 
	$nvme_g‘_iÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

428 
li¡_h—d
 *
pos
, *
q
;

429 
nvme_kaiocb
 *
tmp
;

430 
nvme_kaioùx
 *
tmp_ùx
;

431 
æags
;

432 
	`LIST_HEAD
(
tmp_h—d
);

433 
__u16
 
couÁ
 =0;

434 
__u16
 
Ä
 = 0;

435 
__u32
 
ùxid
 = 0;

437 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

438  -
EACCES
;

440 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

442 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

444 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

446 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

447 ià(
tmp_ùx
) {

448 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

449 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

450 
	`li¡_d–_š™
(
pos
);

451 
	`li¡_add
(
pos
, &
tmp_h—d
);

452 
couÁ
++;

453 ià(
Ä
 =ğ
couÁ
) ;

455 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

456 
	`d”ef_kaioùx
(
tmp_ùx
);

457 
couÁ
 = 0;

458 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

459 
	`li¡_d–
(
pos
);

460 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

461 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

462 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

463 
couÁ
++;

466 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

469 
	}
}

471 
	$kv_com¶‘e_aio_â
(
nvme_kaiocb
 *
cmdšfo
) {

472 
»que¡
 *
»q
 = 
cmdšfo
->req;

473 
i
 = 0;

474 
	`blk_mq_ä“_»que¡
(
»q
);

475 ià(
cmdšfo
->
Ãed_to_cİy
) {

476 ià((
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è&& !cmdšfo->
ev’t
.
¡©us
) ||

477 (
	`is_kv_™”_»ad_cmd
(
cmdšfo
->
İcode
è&& (!cmdšfo->
ev’t
.
¡©us
 || ((cmdinfo->event.status & 0x00ff) == 0x0093)))) {

482 *
d©a
 = 
cmdšfo
->
kv_d©a
;

483 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

485 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

486 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

488 
i
 = 0; i < 
cmdšfo
->
k”Ãl_ùx
->
ÃÁs
; i++) {

489 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
k”Ãl_ùx
->
sg
[
i
]));

492 ià(
cmdšfo
->
u£r_ùx
) {

493 ià(
	`is_kv_¡Üe_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_­³nd_cmd
(cmdinfo->opcode)) {

494 
	`g’”ic_’d_io_acù
(
WRITE
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

496 
	`g’”ic_’d_io_acù
(
READ
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

498 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++) {

499 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

502 ià(
cmdšfo
->
u£_m‘a
) {

503 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

506 ià(
cmdšfo
->
Ãed_to_cİy
) {

507 
	`kä“
(
cmdšfo
->
k”Ãl_ùx
);

508 
	`kä“
(
cmdšfo
->
kv_d©a
);

510 ià(
cmdšfo
->
u£r_ùx
è
	`kä“
(cmdinfo->user_ctx);

511 ià(
cmdšfo
->
m‘a
è
	`kä“
(cmdinfo->meta);

514 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

515 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

517 
	}
}

520 
	$wake_up_aio_wÜk”
(
aio_wÜk”_ùx
 *
aio_ùx
) {

521 
	`wake_up
(&
aio_ùx
->
aio_wa™queue
);

522 
	}
}

524 
	$š£¹_aiocb_to_wÜk”
(
nvme_kaiocb
 *
aiocb
) {

525 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

526 
æags
;

527 
ıu
 = 
	`smp_´oûssÜ_id
();

528 
	`INIT_LIST_HEAD
(&
aiocb
->
aiocb_li¡
);

530 
	`´_”r
("š£¹‡iocb(%pètØaio_wÜk”(%d)!\n", 
aiocb
, 
ıu
);

532 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
ıu
);

533 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

534 
	`li¡_add_
(&
aiocb
->
aiocb_li¡
, &
ùx
->
kaiocb_li¡
);

535 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

536 
	`wake_up_aio_wÜk”
(
ùx
);

538 
	}
}

540 
	$kv_async_com¶‘iÚ
(
»que¡
 *
»q
, 
blk_¡©us_t
 
¡©us
){

541 
nvme_kaiocb
 *
aiocb
 = 
»q
->
’d_io_d©a
;

543 
	`´_”r
("com¶™iÚ hªdË¸fÜ‡iocb(%p)!\n", 
aiocb
);

545 
aiocb
->
»q
 =„eq;

546 
aiocb
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

547 
aiocb
->
ev’t
.
¡©us
 = 
	`Ë16_to_ıu
(
	`nvme_»q
(
»q
)->status);

549 
	`´_”r
("»suÉ‡iocb %°¡©u %x„esuÉ %x\n", 
aiocb
,‡iocb->
ev’t
.
¡©us
,‡iocb->ev’t.
»suÉ
);

551 
	`š£¹_aiocb_to_wÜk”
(
aiocb
);

553 
	}
}

555 
	$kvaio_³rıu_wÜk”_â
(*
¬g
) {

556 
aio_wÜk”_ùx
 *
ùx
 = (aio_wÜk”_ùx *)
¬g
;

557 
li¡_h—d
 *
pos
, *
Ãxt
;

558 
æags
;

559 
	`LIST_HEAD
(
tmp_li¡
);

560 
	`´_”r
("¡¬ˆaiØwÜk” %u\n", 
ùx
->
ıu
);

561 !
	`kth»ad_should_¡İ
(è|| !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

562 ià(
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

563 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
ùx
->
aio_wa™queue
,

564 !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
), 
HZ
/10);

567 
	`INIT_LIST_HEAD
(&
tmp_li¡
);

568 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

569 
	`li¡_¥liû
(&
ùx
->
kaiocb_li¡
, &
tmp_li¡
);

570 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

571 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

572 ià(!
	`li¡_em±y
(&
tmp_li¡
)) {

573 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, &
tmp_li¡
) {

574 
nvme_kaiocb
 *
aiocb
 = 
	`li¡_’Œy
(
pos
, nvme_kaiocb, 
aiocb_li¡
);

575 
	`li¡_d–_š™
(
pos
);

577 
	`´_”r
("´oûs com¶‘iÚ %p\n",
aiocb
);

579 
	`kv_com¶‘e_aio_â
(
aiocb
);

584 
	}
}

586 
	$aio_wÜk”_š™
() {

587 
sk_¡ruù
 **
p
 = 
NULL
;

588 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

589 
i
 = 0;

591 
aio_wÜk”
 = 
	`®loc_³rıu
(
sk_¡ruù
 *);

592 ià(!
aio_wÜk”
) {

593 
	`´_”r
("failo‡lloc…ercpu workerask_struct!\n");

594  -
ENOMEM
;

596 
aio_w_ùx
 = 
	`®loc_³rıu
(
aio_wÜk”_ùx
);

597 ià(!
aio_w_ùx
) {

598 
	`´_”r
("failo‡lloc…ercpu‡io context!\n");

599 
out_ä“
;

602 
	`fÜ_—ch_Úlše_ıu
(
i
) {

603 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
i
);

604 
ùx
->
ıu
 = 
i
;

605 
	`¥š_lock_š™
(&
ùx
->
kaiocb_¥šlock
);

606 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

607 
	`š™_wa™queue_h—d
(&
ùx
->
aio_wa™queue
);

608 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

609 *
p
 = 
	`kth»ad_ü—‹_Ú_node
(
kvaio_³rıu_wÜk”_â
, 
ùx
, 
	`ıu_to_node
(
i
), "aio_completion_worker/%u", i);

610 ià(!(*
p
))

611 
»£t_±h»ad
;

612 
	`kth»ad_bšd
(*
p
, 
i
);

613 
	`wake_up_´oûss
(*
p
);

617 
»£t_±h»ad
:

618 
	`fÜ_—ch_Úlše_ıu
(
i
) {

619 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

620 ià(*
p
è
	`kth»ad_¡İ
(*p);

622 
out_ä“
:

623 ià(
aio_wÜk”
)

624 
	`ä“_³rıu
(
aio_wÜk”
);

625  -
ENOMEM
;

626 
	}
}

628 
	$aio_wÜk”_ex™
() {

629 
sk_¡ruù
 **
p
 = 
NULL
;

630 
i
 = 0;

631 
	`fÜ_—ch_Úlše_ıu
(
i
) {

632 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

633 ià(*
p
è
	`kth»ad_¡İ
(*p);

635 
	`ä“_³rıu
(
aio_wÜk”
);

636 
	`ä“_³rıu
(
aio_w_ùx
);

638 
	}
}

642 
	$nvme_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

644 ià(!
	`nvme_chªge_ù¾_¡©e
(
ù¾
, 
NVME_CTRL_RESETTING
))

645  -
EBUSY
;

646 ià(!
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
»£t_wÜk
))

647  -
EBUSY
;

649 
	}
}

650 
EXPORT_SYMBOL_GPL
(
nvme_»£t_ù¾
);

652 
	$nvme_»£t_ù¾_sync
(
nvme_ù¾
 *
ù¾
)

654 
»t
;

656 
»t
 = 
	`nvme_»£t_ù¾
(
ù¾
);

657 ià(!
»t
)

658 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

659  
»t
;

660 
	}
}

662 
blk_¡©us_t
 
	$nvme_”rÜ_¡©us
(
»que¡
 *
»q
)

664 
	`nvme_»q
(
»q
)->
¡©us
 & 0x7ff) {

665 
NVME_SC_SUCCESS
:

666  
BLK_STS_OK
;

667 
NVME_SC_CAP_EXCEEDED
:

668  
BLK_STS_NOSPC
;

669 
NVME_SC_ONCS_NOT_SUPPORTED
:

670  
BLK_STS_NOTSUPP
;

671 
NVME_SC_WRITE_FAULT
:

672 
NVME_SC_READ_ERROR
:

673 
NVME_SC_UNWRITTEN_BLOCK
:

674  
BLK_STS_MEDIUM
;

676  
BLK_STS_IOERR
;

678 
	}
}

680 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
)

682 ià(
	`blk_nÜ‘ry_»que¡
(
»q
))

683  
çl£
;

684 ià(
	`nvme_»q
(
»q
)->
¡©us
 & 
NVME_SC_DNR
)

685  
çl£
;

686 ià(
jiff›s
 - 
»q
->
¡¬t_time
 >ğ»q->
timeout
)

687  
çl£
;

688 ià(
	`nvme_»q
(
»q
)->
»Œ›s
 >ğ
nvme_max_»Œ›s
)

689  
çl£
;

690  
Œue
;

691 
	}
}

693 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

695 ià(
	`uÆik–y
(
	`nvme_»q
(
»q
)->
¡©us
 && 
	`nvme_»q_Ãeds_»Œy
(req))) {

696 
	`nvme_»q
(
»q
)->
»Œ›s
++;

697 
	`blk_mq_»queue_»que¡
(
»q
, 
Œue
);

700 
	`blk_mq_’d_»que¡
(
»q
, 
	`nvme_”rÜ_¡©us
(req));

701 
	}
}

702 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_rq
);

704 
	$nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

706 
¡©us
;

708 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

711 
	`dev_dbg_¿‹lim™ed
(((
nvme_ù¾
 *è
d©a
)->
deviû
,

712 "CªûÎšg I/O %d", 
»q
->
g
);

714 
¡©us
 = 
NVME_SC_ABORT_REQ
;

715 ià(
	`blk_queue_dyšg
(
»q
->
q
))

716 
¡©us
 |ğ
NVME_SC_DNR
;

717 
	`nvme_»q
(
»q
)->
¡©us
 = status;

718 
	`blk_mq_com¶‘e_»que¡
(
»q
);

720 
	}
}

721 
EXPORT_SYMBOL_GPL
(
nvme_ÿnûl_»que¡
);

723 
boŞ
 
	$nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

724 
nvme_ù¾_¡©e
 
Ãw_¡©e
)

726 
nvme_ù¾_¡©e
 
Şd_¡©e
;

727 
boŞ
 
chªged
 = 
çl£
;

729 
	`¥š_lock_œq
(&
ù¾
->
lock
);

731 
Şd_¡©e
 = 
ù¾
->
¡©e
;

732 
Ãw_¡©e
) {

733 
NVME_CTRL_LIVE
:

734 
Şd_¡©e
) {

735 
NVME_CTRL_NEW
:

736 
NVME_CTRL_RESETTING
:

737 
NVME_CTRL_RECONNECTING
:

738 
chªged
 = 
Œue
;

744 
NVME_CTRL_RESETTING
:

745 
Şd_¡©e
) {

746 
NVME_CTRL_NEW
:

747 
NVME_CTRL_LIVE
:

748 
chªged
 = 
Œue
;

754 
NVME_CTRL_RECONNECTING
:

755 
Şd_¡©e
) {

756 
NVME_CTRL_LIVE
:

757 
chªged
 = 
Œue
;

763 
NVME_CTRL_DELETING
:

764 
Şd_¡©e
) {

765 
NVME_CTRL_LIVE
:

766 
NVME_CTRL_RESETTING
:

767 
NVME_CTRL_RECONNECTING
:

768 
chªged
 = 
Œue
;

774 
NVME_CTRL_DEAD
:

775 
Şd_¡©e
) {

776 
NVME_CTRL_DELETING
:

777 
chªged
 = 
Œue
;

787 ià(
chªged
)

788 
ù¾
->
¡©e
 = 
Ãw_¡©e
;

790 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

792  
chªged
;

793 
	}
}

794 
EXPORT_SYMBOL_GPL
(
nvme_chªge_ù¾_¡©e
);

796 
	$nvme_ä“_ns
(
k»f
 *kref)

798 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

800 ià(
ns
->
ndev
)

801 
	`nvme_nvm_uÄegi¡”
(
ns
);

803 ià(
ns
->
disk
) {

804 
	`¥š_lock
(&
dev_li¡_lock
);

805 
ns
->
disk
->
´iv©e_d©a
 = 
NULL
;

806 
	`¥š_uÆock
(&
dev_li¡_lock
);

809 
	`put_disk
(
ns
->
disk
);

810 
	`ida_sim¶e_»move
(&
ns
->
ù¾
->
ns_ida
,‚s->
š¡ªû
);

811 
	`nvme_put_ù¾
(
ns
->
ù¾
);

812 
	`kä“
(
ns
);

813 
	}
}

815 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

817 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

818 
	}
}

820 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
)

822 
nvme_ns
 *
ns
;

824 
	`¥š_lock
(&
dev_li¡_lock
);

825 
ns
 = 
disk
->
´iv©e_d©a
;

826 ià(
ns
) {

827 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

828 
ç
;

829 ià(!
	`Œy_moduË_g‘
(
ns
->
ù¾
->
İs
->
moduË
))

830 
ç_put_ns
;

832 
	`¥š_uÆock
(&
dev_li¡_lock
);

834  
ns
;

836 
ç_put_ns
:

837 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

838 
ç
:

839 
	`¥š_uÆock
(&
dev_li¡_lock
);

840  
NULL
;

841 
	}
}

843 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

844 
nvme_commªd
 *
cmd
, 
æags
, 
qid
)

846 
İ
 = 
	`nvme_is_wr™e
(
cmd
è? 
REQ_OP_DRV_OUT
 : 
REQ_OP_DRV_IN
;

847 
»que¡
 *
»q
;

849 ià(
qid
 =ğ
NVME_QID_ANY
) {

850 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
İ
, 
æags
);

852 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
İ
, 
æags
,

853 
qid
 ? qid - 1 : 0);

855 ià(
	`IS_ERR
(
»q
))

856  
»q
;

858 
»q
->
cmd_æags
 |ğ
REQ_FAILFAST_DRIVER
;

859 
	`nvme_»q
(
»q
)->
cmd
 = cmd;

861  
»q
;

862 
	}
}

863 
EXPORT_SYMBOL_GPL
(
nvme_®loc_»que¡
);

865 
	$nvme_toggË_¡»ams
(
nvme_ù¾
 *
ù¾
, 
boŞ
 
’abË
)

867 
nvme_commªd
 
c
;

869 
	`mem£t
(&
c
, 0, (c));

871 
c
.
dœeùive
.
İcode
 = 
nvme_admš_dœeùive_£nd
;

872 
c
.
dœeùive
.
nsid
 = 
	`ıu_to_Ë32
(0xffffffff);

873 
c
.
dœeùive
.
dİ”
 = 
NVME_DIR_SND_ID_OP_ENABLE
;

874 
c
.
dœeùive
.
dty³
 = 
NVME_DIR_IDENTIFY
;

875 
c
.
dœeùive
.
tdty³
 = 
NVME_DIR_STREAMS
;

876 
c
.
dœeùive
.
’dœ
 = 
’abË
 ? 
NVME_DIR_ENDIR
 : 0;

878  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

879 
	}
}

881 
	$nvme_di§bË_¡»ams
(
nvme_ù¾
 *
ù¾
)

883  
	`nvme_toggË_¡»ams
(
ù¾
, 
çl£
);

884 
	}
}

886 
	$nvme_’abË_¡»ams
(
nvme_ù¾
 *
ù¾
)

888  
	`nvme_toggË_¡»ams
(
ù¾
, 
Œue
);

889 
	}
}

891 
	$nvme_g‘_¡»am_·¿ms
(
nvme_ù¾
 *
ù¾
,

892 
¡»ams_dœeùive_·¿ms
 *
s
, 
u32
 
nsid
)

894 
nvme_commªd
 
c
;

896 
	`mem£t
(&
c
, 0, (c));

897 
	`mem£t
(
s
, 0, (*s));

899 
c
.
dœeùive
.
İcode
 = 
nvme_admš_dœeùive_»cv
;

900 
c
.
dœeùive
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

901 
c
.
dœeùive
.
numd
 = 
	`ıu_to_Ë32
(((*
s
) >> 2) - 1);

902 
c
.
dœeùive
.
dİ”
 = 
NVME_DIR_RCV_ST_OP_PARAM
;

903 
c
.
dœeùive
.
dty³
 = 
NVME_DIR_STREAMS
;

905  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
s
, (*s));

906 
	}
}

908 
	$nvme_cÚfigu»_dœeùives
(
nvme_ù¾
 *
ù¾
)

910 
¡»ams_dœeùive_·¿ms
 
s
;

911 
»t
;

913 ià(!(
ù¾
->
ßcs
 & 
NVME_CTRL_OACS_DIRECTIVES
))

915 ià(!
¡»ams
)

918 
»t
 = 
	`nvme_’abË_¡»ams
(
ù¾
);

919 ià(
»t
)

920  
»t
;

922 
»t
 = 
	`nvme_g‘_¡»am_·¿ms
(
ù¾
, &
s
, 0xffffffff);

923 ià(
»t
)

924  
»t
;

926 
ù¾
->
ns§
 = 
	`Ë16_to_ıu
(
s
.nssa);

927 ià(
ù¾
->
ns§
 < 
BLK_MAX_WRITE_HINTS
 - 1) {

928 
	`dev_šfo
(
ù¾
->
deviû
, "too few streams (%u)‡vailable\n",

929 
ù¾
->
ns§
);

930 
	`nvme_di§bË_¡»ams
(
ù¾
);

934 
ù¾
->
Ä_¡»ams
 = 
	`mš_t
(, cŒl->
ns§
, 
BLK_MAX_WRITE_HINTS
 - 1);

935 
	`dev_šfo
(
ù¾
->
deviû
, "Usšg %u sŒ—ms\n", cŒl->
Ä_¡»ams
);

937 
	}
}

943 
	$nvme_assign_wr™e_¡»am
(
nvme_ù¾
 *
ù¾
,

944 
»que¡
 *
»q
, 
u16
 *
cÚŒŞ
,

945 
u32
 *
dsmgmt
)

947 
rw_hšt
 
¡»amid
 = 
»q
->
wr™e_hšt
;

949 ià(
¡»amid
 =ğ
WRITE_LIFE_NOT_SET
 || sŒ—mid =ğ
WRITE_LIFE_NONE
)

950 
¡»amid
 = 0;

952 
¡»amid
--;

953 ià(
	`WARN_ON_ONCE
(
¡»amid
 > 
ù¾
->
Ä_¡»ams
))

956 *
cÚŒŞ
 |ğ
NVME_RW_DTYPE_STREAMS
;

957 *
dsmgmt
 |ğ
¡»amid
 << 16;

960 ià(
¡»amid
 < 
	`ARRAY_SIZE
(
»q
->
q
->
wr™e_hšts
))

961 
»q
->
q
->
wr™e_hšts
[
¡»amid
] +ğ
	`blk_rq_by‹s
(req) >> 9;

962 
	}
}

964 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

965 
nvme_commªd
 *
cmnd
)

967 
	`mem£t
(
cmnd
, 0, (*cmnd));

968 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

969 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

970 
	}
}

972 
blk_¡©us_t
 
	$nvme_£tup_disÿrd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

973 
nvme_commªd
 *
cmnd
)

975 
£gm’ts
 = 
	`blk_rq_Ä_disÿrd_£gm’ts
(
»q
), 
n
 = 0;

976 
nvme_dsm_¿nge
 *
¿nge
;

977 
bio
 *bio;

979 
¿nge
 = 
	`km®loc_¬¿y
(
£gm’ts
, (*¿nge), 
GFP_ATOMIC
);

980 ià(!
¿nge
)

981  
BLK_STS_RESOURCE
;

983 
	`__rq_fÜ_—ch_bio
(
bio
, 
»q
) {

984 
u64
 
¦ba
 = 
	`nvme_block_Ä
(
ns
, 
bio
->
bi_™”
.
bi_£ùÜ
);

985 
u32
 
Æb
 = 
bio
->
bi_™”
.
bi_size
 >> 
ns
->
lba_shiá
;

987 
¿nge
[
n
].
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

988 
¿nge
[
n
].
Æb
 = 
	`ıu_to_Ë32
(nlb);

989 
¿nge
[
n
].
¦ba
 = 
	`ıu_to_Ë64
(slba);

990 
n
++;

993 ià(
	`WARN_ON_ONCE
(
n
 !ğ
£gm’ts
)) {

994 
	`kä“
(
¿nge
);

995  
BLK_STS_IOERR
;

998 
	`mem£t
(
cmnd
, 0, (*cmnd));

999 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

1000 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1001 
cmnd
->
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
£gm’ts
 - 1);

1002 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

1004 
»q
->
¥ecŸl_vec
.
bv_·ge
 = 
	`vœt_to_·ge
(
¿nge
);

1005 
»q
->
¥ecŸl_vec
.
bv_off£t
 = 
	`off£t_š_·ge
(
¿nge
);

1006 
»q
->
¥ecŸl_vec
.
bv_Ën
 = (*
¿nge
è* 
£gm’ts
;

1007 
»q
->
rq_æags
 |ğ
RQF_SPECIAL_PAYLOAD
;

1009  
BLK_STS_OK
;

1010 
	}
}

1012 
šlše
 
blk_¡©us_t
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
,

1013 
»que¡
 *
»q
, 
nvme_commªd
 *
cmnd
)

1015 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1016 
u16
 
cÚŒŞ
 = 0;

1017 
u32
 
dsmgmt
 = 0;

1024 ià(
ns
 &&‚s->
ms
 &&

1025 (!
ns
->
pi_ty³
 ||‚s->
ms
 !ğ(
t10_pi_tu¶e
)) &&

1026 !
	`blk_š‹gr™y_rq
(
»q
è&& !
	`blk_rq_is_·s¡hrough
(req))

1027  
BLK_STS_NOTSUPP
;

1029 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

1030 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1031 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

1032 
cÚŒŞ
 |ğ
NVME_RW_LR
;

1034 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

1035 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

1037 
	`mem£t
(
cmnd
, 0, (*cmnd));

1038 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1039 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1040 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

1041 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

1043 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_WRITE
 && 
ù¾
->
Ä_¡»ams
)

1044 
	`nvme_assign_wr™e_¡»am
(
ù¾
, 
»q
, &
cÚŒŞ
, &
dsmgmt
);

1046 ià(
ns
->
ms
) {

1047 
ns
->
pi_ty³
) {

1048 
NVME_NS_DPS_PI_TYPE3
:

1049 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
;

1051 
NVME_NS_DPS_PI_TYPE1
:

1052 
NVME_NS_DPS_PI_TYPE2
:

1053 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
 |

1054 
NVME_RW_PRINFO_PRCHK_REF
;

1055 
cmnd
->
rw
.
»áag
 = 
	`ıu_to_Ë32
(

1056 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

1059 ià(!
	`blk_š‹gr™y_rq
(
»q
))

1060 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

1063 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1064 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

1066 
	}
}

1068 
blk_¡©us_t
 
	$nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

1069 
nvme_commªd
 *
cmd
)

1071 
blk_¡©us_t
 
»t
 = 
BLK_STS_OK
;

1073 ià(!(
»q
->
rq_æags
 & 
RQF_DONTPREP
)) {

1074 
	`nvme_»q
(
»q
)->
»Œ›s
 = 0;

1075 
	`nvme_»q
(
»q
)->
æags
 = 0;

1076 
»q
->
rq_æags
 |ğ
RQF_DONTPREP
;

1079 
	`»q_İ
(
»q
)) {

1080 
REQ_OP_DRV_IN
:

1081 
REQ_OP_DRV_OUT
:

1082 
	`memıy
(
cmd
, 
	`nvme_»q
(
»q
)->cmd, (*cmd));

1084 
REQ_OP_FLUSH
:

1085 
	`nvme_£tup_æush
(
ns
, 
cmd
);

1087 
REQ_OP_WRITE_ZEROES
:

1089 
REQ_OP_DISCARD
:

1090 
»t
 = 
	`nvme_£tup_disÿrd
(
ns
, 
»q
, 
cmd
);

1092 
REQ_OP_READ
:

1093 
REQ_OP_WRITE
:

1094 
»t
 = 
	`nvme_£tup_rw
(
ns
, 
»q
, 
cmd
);

1097 
	`WARN_ON_ONCE
(1);

1098  
BLK_STS_IOERR
;

1101 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

1102  
»t
;

1103 
	}
}

1104 
EXPORT_SYMBOL_GPL
(
nvme_£tup_cmd
);

1110 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1111 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

1112 
timeout
, 
qid
, 
©_h—d
, 
æags
)

1114 
»que¡
 *
»q
;

1115 
»t
;

1117 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
æags
, 
qid
);

1118 ià(
	`IS_ERR
(
»q
))

1119  
	`PTR_ERR
(
»q
);

1121 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1123 ià(
bufãr
 && 
bufæ’
) {

1124 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
GFP_KERNEL
);

1125 ià(
»t
)

1126 
out
;

1129 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 
©_h—d
);

1130 ià(
»suÉ
)

1131 *
»suÉ
 = 
	`nvme_»q
(
»q
)->result;

1132 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

1133 
»t
 = -
EINTR
;

1135 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

1136 
out
:

1137 
	`blk_mq_ä“_»que¡
(
»q
);

1138  
»t
;

1139 
	}
}

1140 
EXPORT_SYMBOL_GPL
(
__nvme_subm™_sync_cmd
);

1142 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1143 *
bufãr
, 
bufæ’
)

1145  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

1146 
NVME_QID_ANY
, 0, 0);

1147 
	}
}

1148 
EXPORT_SYMBOL_GPL
(
nvme_subm™_sync_cmd
);

1150 
	$__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1151 
__u£r
 *
ubufãr
, 
bufæ’
,

1152 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1153 
u32
 *
»suÉ
, 
timeout
)

1155 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
(
cmd
);

1156 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1157 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1158 
»que¡
 *
»q
;

1159 
bio
 *biØğ
NULL
;

1160 *
m‘a
 = 
NULL
;

1161 
»t
;

1163 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1164 ià(
	`IS_ERR
(
»q
))

1165  
	`PTR_ERR
(
»q
);

1167 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1169 ià(
ubufãr
 && 
bufæ’
) {

1170 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
,

1171 
GFP_KERNEL
);

1172 ià(
»t
)

1173 
out
;

1174 
bio
 = 
»q
->bio;

1176 ià(!
disk
)

1177 
subm™
;

1178 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

1179 ià(!
bio
->
bi_bdev
) {

1180 
»t
 = -
ENODEV
;

1181 
out_unm­
;

1184 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1185 
bio_š‹gr™y_·ylßd
 *
b
;

1187 
m‘a
 = 
	`km®loc
(
m‘a_Ën
, 
GFP_KERNEL
);

1188 ià(!
m‘a
) {

1189 
»t
 = -
ENOMEM
;

1190 
out_unm­
;

1193 ià(
wr™e
) {

1194 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
,

1195 
m‘a_Ën
)) {

1196 
»t
 = -
EFAULT
;

1197 
out_ä“_m‘a
;

1201 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

1202 ià(
	`IS_ERR
(
b
)) {

1203 
»t
 = 
	`PTR_ERR
(
b
);

1204 
out_ä“_m‘a
;

1207 
b
->
b_™”
.
bi_size
 = 
m‘a_Ën
;

1208 
b
->
b_™”
.
bi_£ùÜ
 = 
m‘a_£ed
;

1210 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
m‘a
),

1211 
m‘a_Ën
, 
	`off£t_š_·ge
(
m‘a
));

1212 ià(
»t
 !ğ
m‘a_Ën
) {

1213 
»t
 = -
ENOMEM
;

1214 
out_ä“_m‘a
;

1218 
subm™
:

1219 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1220 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

1221 
»t
 = -
EINTR
;

1223 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

1224 ià(
»suÉ
)

1225 *
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

1226 ià(
m‘a
 && !
»t
 && !
wr™e
) {

1227 ià(
	`cİy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

1228 
»t
 = -
EFAULT
;

1230 
out_ä“_m‘a
:

1231 
	`kä“
(
m‘a
);

1232 
out_unm­
:

1233 ià(
bio
) {

1234 ià(
disk
 && 
bio
->
bi_bdev
)

1235 
	`bdput
(
bio
->
bi_bdev
);

1236 
	`blk_rq_unm­_u£r
(
bio
);

1238 
out
:

1239 
	`blk_mq_ä“_»que¡
(
»q
);

1240  
»t
;

1241 
	}
}

1243 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1244 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

1245 
timeout
)

1247  
	`__nvme_subm™_u£r_cmd
(
q
, 
cmd
, 
ubufãr
, 
bufæ’
, 
NULL
, 0, 0,

1248 
»suÉ
, 
timeout
);

1249 
	}
}

1261 
boŞ
 
	$check_add_fÜ_sšgË_cÚt_phyadd»ss
(
__u£r
 *
add»ss
, 
Ëngth
, 
»que¡_queue
 *
q
)

1263 
off£t
 = 0;

1264 
couÁ
 = 0;

1266 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

1267 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

1268 ià((
couÁ
 > 1è|| (()
add»ss
 & 
	`queue_dma_®ignm’t
(
q
))) {

1270  
çl£
;

1272  
Œue
;

1273 
	}
}

1275 
	$u£r_addr_Åages
(
off£t
, 
size
)

1277 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

1278  
couÁ
;

1279 
	}
}

1281 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
, 
boŞ
 
b_k”Ãl
)

1283 
off£t
 = 
	`off£t_š_·ge
(
addr
);

1284 
d©®’
 = 
Ën
;

1285 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
, 
Ën
);

1286 
size
 = 0;

1287 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1288 
m­³d_·ges
 = 0;

1289 
i
 = 0;

1290 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


1291 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

1293 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

1294 ià(!
u£r_ùx
) {

1295  
NULL
;

1298 
u£r_ùx
->
ÃÁs
 = 0;

1299 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

1300 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

1301 ià(
b_k”Ãl
) {

1302 
·ge
 *·gğ
NULL
;

1303 *
¤c_d©a
 = 
addr
;

1304 
i
 = 0; i < 
num_·ge
; i++) {

1305 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

1306 
	`g‘_·ge
(
·ge
);

1307 
u£r_ùx
->
·ges
[
i
] = 
·ge
;

1308 
¤c_d©a
 +ğ
PAGE_SIZE
;

1312 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

1313 0, 
u£r_ùx
->
·ges
);

1314 ià(
m­³d_·ges
 !ğ
num_·ge
) {

1315 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

1316 
ex™
;

1319 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

1320 
u£r_ùx
->
Ën
 = 
d©®’
;

1321 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

1322 
i
 = 0; i < 
num_·ge
; i++) {

1323 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

1324 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

1325 
off£t
);

1326 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

1327 
off£t
 = 0;

1329 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

1330  
u£r_ùx
;

1331 
ex™
:

1332 ià(
u£r_ùx
) {

1333 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

1334 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

1335 
	`kä“
(
u£r_ùx
);

1337  
NULL
;

1338 
	}
}

1339 
	$__nvme_subm™_kv_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1340 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

1341 
__u£r
 *
ubufãr
, 
bufæ’
,

1342 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1343 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

1345 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1346 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1347 
»que¡
 *
»q
;

1348 
»t
 = 0;

1349 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

1350 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1351 
aio_u£r_ùx
 *
k”Ãl_ùx
 = 
NULL
;

1352 
sÿ‰”li¡
* 
m‘a_sg_±r
;

1353 
sÿ‰”li¡
 
m‘a_sg
;

1354 
·ge
* 
p_·ge
 = 
NULL
;

1355 
nvme_io_·¿m
* 
·¿m
 = 
NULL
;

1356 *
kv_d©a
 = 
NULL
;

1357 *
kv_m‘a
 = 
NULL
;

1358 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

1359 
i
 = 0, 
off£t
 = 0;

1360 
Ën
 = 0;

1361 
¡¬t_time
 = 
jiff›s
;

1363 ià(!
disk
)

1364  -
EFAULT
;

1366 ià(
aio
) {

1367 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

1368 ià(!
aiocb
) {

1369 
»t
 = -
ENOMEM
;

1370 
out_’d
;

1372 
aiocb
->
cmd
 = *cmd;

1373 
aiocb
->
disk
 = disk;

1374 
cmd
 = &
aiocb
->cmd;

1376 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1377 ià(
	`IS_ERR
(
»q
)) {

1378 ià(
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1379  
	`PTR_ERR
(
»q
);

1382 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1383 
·¿m
 = 
	`nvme_io_·¿m
(
»q
);

1385 
·¿m
->
kv_d©a_sg_±r
 = 
NULL
;

1386 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1387 
·¿m
->
kv_d©a_ÃÁs
 = 0;

1388 
·¿m
->
kv_d©a_Ën
 = 0;

1390 ià(
ubufãr
 && 
bufæ’
) {

1391 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
q
)) {

1392 
Ãed_to_cİy
 = 
Œue
;

1393 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

1394 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1395 ià(
kv_d©a
 =ğ
NULL
) {

1396 
»t
 = -
ENOMEM
;

1397 
out_»q_’d
;

1400 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
, 
çl£
);

1401 ià(
Ãed_to_cİy
) {

1402 
k”Ãl_ùx
 = 
	`g‘_aio_u£r_ùx
(
kv_d©a
, 
bufæ’
, 
Œue
);

1403 ià(
k”Ãl_ùx
) {

1404 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1405 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1406 
kv_d©a
, 
u£r_ùx
->
Ën
);

1408 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

1409 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

1410 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

1416 
k”Ãl_ùx
 = 
u£r_ùx
;

1418 ià(
u£r_ùx
 =ğ
NULL
 || 
k”Ãl_ùx
 == NULL) {

1419 
»t
 = -
ENOMEM
;

1420 
out_unm­
;

1422 
·¿m
->
kv_d©a_sg_±r
 = 
k”Ãl_ùx
->
sg
;

1423 
·¿m
->
kv_d©a_ÃÁs
 = 
k”Ãl_ùx
->
ÃÁs
;

1424 
·¿m
->
kv_d©a_Ën
 = 
k”Ãl_ùx
->
Ën
;

1425 ià(
aio
) {

1426 
aiocb
->
Ãed_to_cİy
 =‚eed_to_copy;

1427 
aiocb
->
kv_d©a
 = kv_data;

1428 
aiocb
->
k”Ãl_ùx
 = kernel_ctx;

1429 
aiocb
->
u£r_ùx
 = user_ctx;

1430 
aiocb
->
¡¬t_time
 = start_time;

1432 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1433 
	`g’”ic_¡¬t_io_acù
(
WRITE
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1435 
	`g’”ic_¡¬t_io_acù
(
READ
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1439 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1440 ià(
	`check_add_fÜ_sšgË_cÚt_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
, 
q
)) {

1441 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 0, &
p_·ge
);

1442 ià(
»t
 != 1) {

1443 
»t
 = -
ENOMEM
;

1444 
out_unm­
;

1446 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

1448 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256) * 256;

1449 
kv_m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1450 ià(!
kv_m‘a
) {

1451 
»t
 = -
ENOMEM
;

1452 
out_unm­
;

1454 ià(
	`cİy_äom_u£r
(
kv_m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

1455 
»t
 = -
EFAULT
;

1456 
out_ä“_m‘a
;

1458 
off£t
 = 
	`off£t_š_·ge
(
kv_m‘a
);

1459 
p_·ge
 = 
	`vœt_to_·ge
(
kv_m‘a
);

1460 
	`g‘_·ge
(
p_·ge
);

1462 ià(
aio
) {

1463 
aiocb
->
u£_m‘a
 = 
Œue
;

1464 
aiocb
->
m‘a
 = 
kv_m‘a
;

1465 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

1467 
m‘a_sg_±r
 = &
m‘a_sg
;

1469 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

1470 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

1471 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

1472 
·¿m
->
kv_m‘a_sg_±r
 = 
m‘a_sg_±r
;

1474 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1477 ià(
aio
) {

1478 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

1479 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

1480 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

1481 
»q
->
’d_io_d©a
 = 
aiocb
;

1482 
	`blk_execu‹_rq_nowa™
(
»q
->
q
, 
disk
,„eq, 0, 
kv_async_com¶‘iÚ
);

1486 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1487 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

1488 
»t
 = 
EINTR
;

1490 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

1492 ià(
»suÉ
)

1493 *
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

1494 ià(
¡©us
)

1495 *
¡©us
 = 
	`Ë16_to_ıu
(
	`nvme_»q
(
»q
)->status);

1496 ià(
»t
 && !
	`is_kv_™”_»q_cmd
(
cmd
->
commÚ
.
İcode
è&& !
	`is_kv_™”_»ad_cmd
(cmd->common.opcode)) {

1498 
	`´_”r
("__nvme_subm™_u£r_cmd faed!!!!!: opcode(%02x)\n", 
cmd
->
commÚ
.
İcode
);

1502 ià(
Ãed_to_cİy
) {

1503 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

1504 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || ((
	`Ë16_to_ıu
(
	`nvme_»q
(
»q
)->
¡©us
) & 0x00ff) == 0x0093)))) {

1506 *
d©a
 = 
kv_d©a
;

1507 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

1509 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1510 
kv_d©a
, 
u£r_ùx
->
Ën
);

1513 
out_ä“_m‘a
:

1514 ià(
p_·ge
è
	`put_·ge
(p_page);

1515 ià(
kv_m‘a
è
	`kä“
(kv_meta);

1516 
out_unm­
:

1517 ià(
u£r_ùx
) {

1518 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++) {

1519 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

1521 
	`kä“
(
u£r_ùx
);

1523 ià(
Ãed_to_cİy
) {

1524 ià(
k”Ãl_ùx
) {

1525 
i
 = 0; i < 
k”Ãl_ùx
->
ÃÁs
; i++) {

1526 
	`put_·ge
(
	`sg_·ge
(&
k”Ãl_ùx
->
sg
[
i
]));

1528 
	`kä“
(
k”Ãl_ùx
);

1530 ià(
kv_d©a
è
	`kä“
(kv_data);

1532 
out_»q_’d
:

1533 ià(
aio
 && 
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1534 
	`blk_mq_ä“_»que¡
(
»q
);

1536 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1537 
	`g’”ic_’d_io_acù
(
WRITE
, &
disk
->
·¹0
, 
¡¬t_time
);

1539 
	`g’”ic_’d_io_acù
(
READ
, &
disk
->
·¹0
, 
¡¬t_time
);

1541 
out_’d
:

1542  
»t
;

1543 
	}
}

1545 
	$nvme_u£r_kv_cmd
(
nvme_ù¾
 *
ù¾
,

1546 
nvme_ns
 *
ns
,

1547 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

1549 
nvme_·s¡hru_kv_cmd
 
cmd
;

1550 
nvme_commªd
 
c
;

1551 
timeout
 = 0;

1552 
¡©us
;

1553 
__u£r
 *
m‘ad©a
 = 
NULL
;

1554 
m‘a_Ën
 = 0;

1555 
İtiÚ
 = 0;

1556 
™”_hªdË
 = 0;

1557 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1558  -
EACCES
;

1559 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1560  -
EFAULT
;

1561 ià(
cmd
.
æags
)

1562  -
EINVAL
;

1566 ià(!
	`is_kv_cmd
(
cmd
.
İcode
)) {

1567  -
EINVAL
;

1569 
	`mem£t
(&
c
, 0, (c));

1570 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1571 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1572 #ifdeà
KSID_SUPPORT


1573 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

1575 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1577 ià(
cmd
.
timeout_ms
)

1578 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1585 
cmd
.
İcode
) {

1586 
nvme_cmd_kv_¡Üe
:

1587 
nvme_cmd_kv_­³nd
:

1588 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1589 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1591 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1592 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1593 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1594 
¡©us
 = -
EINVAL
;

1595 
ex™
;

1597 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1598 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

1600 ià(
cmd
.
d©a_Ëngth
 % 4) {

1601 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

1602 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

1604 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1607 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1608 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1609 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1611 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1614 
nvme_cmd_kv_»Œ›ve
:

1615 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1616 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1618 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1619 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1620 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1621 
¡©us
 = -
EINVAL
;

1622 
ex™
;

1624 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1625 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

1626 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1628 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1629 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1630 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1632 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1635 
nvme_cmd_kv_d–‘e
:

1636 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1638 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1639 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1640 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1641 
¡©us
 = -
EINVAL
;

1642 
ex™
;

1644 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1645 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

1646 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1647 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1648 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1650 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1653 
nvme_cmd_kv_exi¡
:

1654 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1656 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1657 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1658 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1659 
¡©us
 = -
EINVAL
;

1660 
ex™
;

1662 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1663 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

1664 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1665 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1666 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1668 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1671 
nvme_cmd_kv_™”_»q
:

1672 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1673 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1674 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

1675 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

1676 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1677 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1679 
nvme_cmd_kv_™”_»ad
:

1680 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1681 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1682 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

1683 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

1684 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1687 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

1688 
¡©us
 = -
EINVAL
;

1689 
ex™
;

1698 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
, &
cmd
,

1699 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
, 0,

1700 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

1701 
ex™
:

1702 ià(!
aio
) {

1703 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1704  -
EFAULT
;

1705 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

1706  -
EFAULT
;

1708  
¡©us
;

1710 
	}
}

1715 
	$nvme_k“p_®ive_’d_io
(
»que¡
 *
rq
, 
blk_¡©us_t
 
¡©us
)

1717 
nvme_ù¾
 *
ù¾
 = 
rq
->
’d_io_d©a
;

1719 
	`blk_mq_ä“_»que¡
(
rq
);

1721 ià(
¡©us
) {

1722 
	`dev_”r
(
ù¾
->
deviû
,

1724 
¡©us
);

1728 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1729 
	}
}

1731 
	$nvme_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1733 
nvme_commªd
 
c
;

1734 
»que¡
 *
rq
;

1736 
	`mem£t
(&
c
, 0, (c));

1737 
c
.
commÚ
.
İcode
 = 
nvme_admš_k“p_®ive
;

1739 
rq
 = 
	`nvme_®loc_»que¡
(
ù¾
->
admš_q
, &
c
, 
BLK_MQ_REQ_RESERVED
,

1740 
NVME_QID_ANY
);

1741 ià(
	`IS_ERR
(
rq
))

1742  
	`PTR_ERR
(
rq
);

1744 
rq
->
timeout
 = 
ù¾
->
k©o
 * 
HZ
;

1745 
rq
->
’d_io_d©a
 = 
ù¾
;

1747 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q, 0, 
nvme_k“p_®ive_’d_io
);

1750 
	}
}

1752 
	$nvme_k“p_®ive_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1754 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

1755 
nvme_ù¾
, 
ka_wÜk
);

1757 ià(
	`nvme_k“p_®ive
(
ù¾
)) {

1759 
	`dev_”r
(
ù¾
->
deviû
, "keep-alive failed\n");

1760 
	`nvme_»£t_ù¾
(
ù¾
);

1763 
	}
}

1765 
	$nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1767 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1770 
	`INIT_DELAYED_WORK
(&
ù¾
->
ka_wÜk
, 
nvme_k“p_®ive_wÜk
);

1771 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1772 
	}
}

1773 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_k“p_®ive
);

1775 
	$nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1777 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1780 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
ka_wÜk
);

1781 
	}
}

1782 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_k“p_®ive
);

1784 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1786 
nvme_commªd
 
c
 = { };

1787 
”rÜ
;

1790 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1791 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_CTRL
;

1793 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1794 ià(!*
id
)

1795  -
ENOMEM
;

1797 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1798 (
nvme_id_ù¾
));

1799 ià(
”rÜ
)

1800 
	`kä“
(*
id
);

1801  
”rÜ
;

1802 
	}
}

1804 
	$nvme_id’tify_ns_descs
(
nvme_ns
 *
ns
, 
nsid
)

1806 
nvme_commªd
 
c
 = { };

1807 
¡©us
;

1808 *
d©a
;

1809 
pos
;

1810 
Ën
;

1812 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1813 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1814 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS_DESC_LIST
;

1816 
d©a
 = 
	`kz®loc
(
NVME_IDENTIFY_DATA_SIZE
, 
GFP_KERNEL
);

1817 ià(!
d©a
)

1818  -
ENOMEM
;

1820 
¡©us
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, &
c
, 
d©a
,

1821 
NVME_IDENTIFY_DATA_SIZE
);

1822 ià(
¡©us
)

1823 
ä“_d©a
;

1825 
pos
 = 0;…o < 
NVME_IDENTIFY_DATA_SIZE
;…o +ğ
Ën
) {

1826 
nvme_ns_id_desc
 *
cur
 = 
d©a
 + 
pos
;

1828 ià(
cur
->
nidl
 == 0)

1831 
cur
->
nidt
) {

1832 
NVME_NIDT_EUI64
:

1833 ià(
cur
->
nidl
 !ğ
NVME_NIDT_EUI64_LEN
) {

1834 
	`dev_w¬n
(
ns
->
ù¾
->
deviû
,

1836 
cur
->
nidl
);

1837 
ä“_d©a
;

1839 
Ën
 = 
NVME_NIDT_EUI64_LEN
;

1840 
	`memıy
(
ns
->
eui
, 
d©a
 + 
pos
 + (*
cur
), 
Ën
);

1842 
NVME_NIDT_NGUID
:

1843 ià(
cur
->
nidl
 !ğ
NVME_NIDT_NGUID_LEN
) {

1844 
	`dev_w¬n
(
ns
->
ù¾
->
deviû
,

1846 
cur
->
nidl
);

1847 
ä“_d©a
;

1849 
Ën
 = 
NVME_NIDT_NGUID_LEN
;

1850 
	`memıy
(
ns
->
nguid
, 
d©a
 + 
pos
 + (*
cur
), 
Ën
);

1852 
NVME_NIDT_UUID
:

1853 ià(
cur
->
nidl
 !ğ
NVME_NIDT_UUID_LEN
) {

1854 
	`dev_w¬n
(
ns
->
ù¾
->
deviû
,

1856 
cur
->
nidl
);

1857 
ä“_d©a
;

1859 
Ën
 = 
NVME_NIDT_UUID_LEN
;

1860 
	`uuid_cİy
(&
ns
->
uuid
, 
d©a
 + 
pos
 + (*
cur
));

1864 
Ën
 = 
cur
->
nidl
;

1868 
Ën
 +ğ(*
cur
);

1870 
ä“_d©a
:

1871 
	`kä“
(
d©a
);

1872  
¡©us
;

1873 
	}
}

1875 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1877 
nvme_commªd
 
c
 = { };

1879 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1880 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS_ACTIVE_LIST
;

1881 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1882  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
, 0x1000);

1883 
	}
}

1885 
	$nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

1886 
nvme_id_ns
 **
id
)

1888 
nvme_commªd
 
c
 = { };

1889 
”rÜ
;

1892 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1893 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1894 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS
;

1896 *
id
 = 
	`km®loc
((
nvme_id_ns
), 
GFP_KERNEL
);

1897 ià(!*
id
)

1898  -
ENOMEM
;

1900 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1901 (
nvme_id_ns
));

1902 ià(
”rÜ
)

1903 
	`kä“
(*
id
);

1904  
”rÜ
;

1905 
	}
}

1907 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1908 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1910 
nvme_commªd
 
c
;

1911 
nvme_»suÉ
 
»s
;

1912 
»t
;

1914 
	`mem£t
(&
c
, 0, (c));

1915 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1916 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1917 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1919 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
»s
,

1920 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 0);

1921 ià(
»t
 >ğ0 && 
»suÉ
)

1922 *
»suÉ
 = 
	`Ë32_to_ıu
(
»s
.
u32
);

1923  
»t
;

1924 
	}
}

1926 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1928 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1929 
u32
 
»suÉ
;

1930 
¡©us
, 
Ä_io_queues
;

1932 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 
NULL
, 0,

1933 &
»suÉ
);

1934 ià(
¡©us
 < 0)

1935  
¡©us
;

1942 ià(
¡©us
 > 0) {

1943 
	`dev_”r
(
ù¾
->
deviû
, "Could‚Ù s‘ queucouÁ (%d)\n", 
¡©us
);

1944 *
couÁ
 = 0;

1946 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

1947 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

1951 
	}
}

1952 
EXPORT_SYMBOL_GPL
(
nvme_£t_queue_couÁ
);

1954 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1956 
nvme_u£r_io
 
io
;

1957 
nvme_commªd
 
c
;

1958 
Ëngth
, 
m‘a_Ën
;

1959 
__u£r
 *
m‘ad©a
;

1961 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

1962  -
EFAULT
;

1963 ià(
io
.
æags
)

1964  -
EINVAL
;

1966 
io
.
İcode
) {

1967 
nvme_cmd_wr™e
:

1968 
nvme_cmd_»ad
:

1969 
nvme_cmd_com·»
:

1972  -
EINVAL
;

1975 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1976 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1977 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

1979 ià(
ns
->
ext
) {

1980 
Ëngth
 +ğ
m‘a_Ën
;

1981 
m‘a_Ën
 = 0;

1982 } ià(
m‘a_Ën
) {

1983 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

1984  -
EINVAL
;

1987 
	`mem£t
(&
c
, 0, (c));

1988 
c
.
rw
.
İcode
 = 
io
.opcode;

1989 
c
.
rw
.
æags
 = 
io
.flags;

1990 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1991 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

1992 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

1993 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

1994 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

1995 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

1996 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

1997 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

1999  
	`__nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

2000 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

2001 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

2002 
	}
}

2004 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

2005 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

2007 
nvme_·s¡hru_cmd
 
cmd
;

2008 
nvme_commªd
 
c
;

2009 
timeout
 = 0;

2010 
¡©us
;

2012 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2013  -
EACCES
;

2014 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

2015  -
EFAULT
;

2016 ià(
cmd
.
æags
)

2017  -
EINVAL
;

2019 
	`mem£t
(&
c
, 0, (c));

2020 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

2021 
c
.
commÚ
.
æags
 = 
cmd
.flags;

2022 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

2023 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

2024 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

2025 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

2026 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

2027 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

2028 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

2029 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

2030 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

2032 ià(
cmd
.
timeout_ms
)

2033 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

2035 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

2036 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

2037 &
cmd
.
»suÉ
, 
timeout
);

2038 ià(
¡©us
 >= 0) {

2039 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

2040  -
EFAULT
;

2043  
¡©us
;

2044 
	}
}

2046 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

2047 
cmd
, 
¬g
)

2049 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2051 
cmd
) {

2052 
NVME_IOCTL_ID
:

2053 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

2054  
ns
->
ns_id
;

2055 
NVME_IOCTL_ADMIN_CMD
:

2056  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

2057 
NVME_IOCTL_IO_CMD
:

2058  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

2059 
NVME_IOCTL_SUBMIT_IO
:

2060  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

2062 
NVME_IOCTL_IO_KV_CMD
:

2063  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
çl£
);

2064 
NVME_IOCTL_AIO_CMD
:

2065  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
Œue
);

2066 
NVME_IOCTL_SET_AIOCTX
:

2067  
	`nvme_£t_aioùx
((
__u£r
*)
¬g
);

2068 
NVME_IOCTL_DEL_AIOCTX
:

2069  
	`nvme_d–_aioùx
((
__u£r
*)
¬g
);

2070 
NVME_IOCTL_GET_AIOEVENT
:

2071  
	`nvme_g‘_iÛv’ts
((
__u£r
*)
¬g
);

2074 #ifdeà
CONFIG_NVM


2075 ià(
ns
->
ndev
)

2076  
	`nvme_nvm_ioùl
(
ns
, 
cmd
, 
¬g
);

2078 ià(
	`is_£d_ioùl
(
cmd
))

2079  
	`£d_ioùl
(
ns
->
ù¾
->
İ®_dev
, 
cmd
,

2080 (
__u£r
 *è
¬g
);

2081  -
ENOTTY
;

2083 
	}
}

2085 #ifdeà
CONFIG_COMPAT


2086 
	$nvme_com·t_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

2087 
cmd
, 
¬g
)

2089  
	`nvme_ioùl
(
bdev
, 
mode
, 
cmd
, 
¬g
);

2090 
	}
}

2092 
	#nvme_com·t_ioùl
 
NULL


	)

2095 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

2097  
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
è? 0 : -
ENXIO
;

2098 
	}
}

2100 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

2102 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2104 
	`moduË_put
(
ns
->
ù¾
->
İs
->
moduË
);

2105 
	`nvme_put_ns
(
ns
);

2106 
	}
}

2108 
	$nvme_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

2111 
geo
->
h—ds
 = 1 << 6;

2112 
geo
->
£ùÜs
 = 1 << 5;

2113 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bdev
->
bd_disk
) >> 11;

2115 
	}
}

2117 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


2118 
	$nvme_´•_š‹gr™y
(
g’disk
 *
disk
, 
nvme_id_ns
 *
id
,

2119 
u16
 
bs
)

2121 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2122 
u16
 
Şd_ms
 = 
ns
->
ms
;

2123 
u8
 
pi_ty³
 = 0;

2125 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[id->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
].ms);

2126 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

2129 ià(
ns
->
ms
 =ğ(
t10_pi_tu¶e
))

2130 
pi_ty³
 = 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
;

2132 ià(
	`blk_g‘_š‹gr™y
(
disk
) &&

2133 (
ns
->
pi_ty³
 !ğpi_ty³ ||‚s->
ms
 !ğ
Şd_ms
 ||

2134 
bs
 !ğ
	`queue_logiÿl_block_size
(
disk
->
queue
) ||

2135 (
ns
->
ms
 &&‚s->
ext
)))

2136 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

2138 
ns
->
pi_ty³
 =…i_type;

2139 
	}
}

2141 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

2143 
blk_š‹gr™y
 
š‹gr™y
;

2145 
	`mem£t
(&
š‹gr™y
, 0, (integrity));

2146 
ns
->
pi_ty³
) {

2147 
NVME_NS_DPS_PI_TYPE3
:

2148 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³3_üc
;

2149 
š‹gr™y
.
g_size
 = (
u16
è+ (
u32
);

2150 
š‹gr™y
.
æags
 |ğ
BLK_INTEGRITY_DEVICE_CAPABLE
;

2152 
NVME_NS_DPS_PI_TYPE1
:

2153 
NVME_NS_DPS_PI_TYPE2
:

2154 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³1_üc
;

2155 
š‹gr™y
.
g_size
 = (
u16
);

2156 
š‹gr™y
.
æags
 |ğ
BLK_INTEGRITY_DEVICE_CAPABLE
;

2159 
š‹gr™y
.
´ofe
 = 
NULL
;

2162 
š‹gr™y
.
tu¶e_size
 = 
ns
->
ms
;

2163 
	`blk_š‹gr™y_»gi¡”
(
ns
->
disk
, &
š‹gr™y
);

2164 
	`blk_queue_max_š‹gr™y_£gm’ts
(
ns
->
queue
, 1);

2165 
	}
}

2167 
	$nvme_´•_š‹gr™y
(
g’disk
 *
disk
, 
nvme_id_ns
 *
id
,

2168 
u16
 
bs
)

2170 
	}
}

2171 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

2173 
	}
}

2176 
	$nvme_£t_chunk_size
(
nvme_ns
 *
ns
)

2178 
u32
 
chunk_size
 = (((u32)
ns
->
noiob
è<< (ns->
lba_shiá
 - 9));

2179 
	`blk_queue_chunk_£ùÜs
(
ns
->
queue
, 
	`rounddown_pow_of_two
(
chunk_size
));

2180 
	}
}

2182 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

2184 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

2185 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

2187 
	`BUILD_BUG_ON
(
PAGE_SIZE
 / (
nvme_dsm_¿nge
) <

2188 
NVME_DSM_MAX_RANGES
);

2190 ià(
ù¾
->
Ä_¡»ams
 && 
ns
->
sws
 &&‚s->
sgs
) {

2191 
sz
 = 
logiÿl_block_size
 * 
ns
->
sws
 *‚s->
sgs
;

2193 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
sz
;

2194 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
sz
;

2196 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

2197 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

2199 
	`blk_queue_max_disÿrd_£ùÜs
(
ns
->
queue
, 
UINT_MAX
);

2200 
	`blk_queue_max_disÿrd_£gm’ts
(
ns
->
queue
, 
NVME_DSM_MAX_RANGES
);

2201 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

2203 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DEALLOCATE_ZEROES
)

2204 
	`blk_queue_max_wr™e_z”Ûs_£ùÜs
(
ns
->
queue
, 
UINT_MAX
);

2205 
	}
}

2207 
	$nvme_»v®id©e_ns
(
nvme_ns
 *
ns
, 
nvme_id_ns
 **
id
)

2209 ià(
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, 
id
)) {

2210 
	`dev_w¬n
(
ns
->
ù¾
->
dev
, "%s: Id’tify fau»\n", 
__func__
);

2211  -
ENODEV
;

2214 ià((*
id
)->
nÿp
 == 0) {

2215 
	`kä“
(*
id
);

2216  -
ENODEV
;

2219 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

2220 
	`memıy
(
ns
->
eui
, (*
id
)->
eui64
, (ns->eui));

2221 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 0))

2222 
	`memıy
(
ns
->
nguid
, (*
id
)->nguid, (ns->nguid));

2223 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 3, 0)) {

2227 ià(
	`nvme_id’tify_ns_descs
(
ns
,‚s->
ns_id
))

2228 
	`dev_w¬n
(
ns
->
ù¾
->
deviû
,

2229 "%s: Id’tify DesütÜ çed\n", 
__func__
);

2233 
	}
}

2235 
	$__nvme_»v®id©e_disk
(
g’disk
 *
disk
, 
nvme_id_ns
 *
id
)

2237 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2238 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

2239 
u16
 
bs
;

2245 
ns
->
lba_shiá
 = 
id
->
lbaf
[id->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
].
ds
;

2246 ià(
ns
->
lba_shiá
 == 0)

2247 
ns
->
lba_shiá
 = 9;

2248 
bs
 = 1 << 
ns
->
lba_shiá
;

2249 
ns
->
noiob
 = 
	`Ë16_to_ıu
(
id
->noiob);

2251 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

2253 ià(
ù¾
->
İs
->
æags
 & 
NVME_F_METADATA_SUPPORTED
)

2254 
	`nvme_´•_š‹gr™y
(
disk
, 
id
, 
bs
);

2255 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 
bs
);

2256 ià(
ns
->
noiob
)

2257 
	`nvme_£t_chunk_size
(
ns
);

2258 ià(
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
è&& !ns->
ext
)

2259 
	`nvme_š™_š‹gr™y
(
ns
);

2260 ià(
ns
->
ms
 && !Òs->m =ğ8 &&‚s->
pi_ty³
è&& !
	`blk_g‘_š‹gr™y
(
disk
))

2261 
	`£t_ÿ·c™y
(
disk
, 0);

2263 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

2265 ià(
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

2266 
	`nvme_cÚfig_disÿrd
(
ns
);

2267 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

2268 
	}
}

2270 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

2272 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2273 
nvme_id_ns
 *
id
 = 
NULL
;

2274 
»t
;

2276 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

2277 
	`£t_ÿ·c™y
(
disk
, 0);

2278  -
ENODEV
;

2281 
»t
 = 
	`nvme_»v®id©e_ns
(
ns
, &
id
);

2282 ià(
»t
)

2283  
»t
;

2285 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

2286 
	`kä“
(
id
);

2289 
	}
}

2291 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

2293 
ty³
) {

2294 
PR_WRITE_EXCLUSIVE
:

2296 
PR_EXCLUSIVE_ACCESS
:

2298 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

2300 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

2302 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

2304 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

2309 
	}
};

2311 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

2312 
u64
 
key
, u64 
§_key
, 
u8
 
İ
)

2314 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2315 
nvme_commªd
 
c
;

2316 
u8
 
d©a
[16] = { 0, };

2318 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

2319 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

2321 
	`mem£t
(&
c
, 0, (c));

2322 
c
.
commÚ
.
İcode
 = 
İ
;

2323 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2324 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

2326  
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

2327 
	}
}

2329 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Şd
,

2330 
u64
 
Ãw
, 
æags
)

2332 
u32
 
cdw10
;

2334 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2335  -
EOPNOTSUPP
;

2337 
cdw10
 = 
Şd
 ? 2 : 0;

2338 
cdw10
 |ğ(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

2339 
cdw10
 |= (1 << 30) | (1 << 31);

2340  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

2341 
	}
}

2343 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

2344 
´_ty³
 
ty³
, 
æags
)

2346 
u32
 
cdw10
;

2348 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2349  -
EOPNOTSUPP
;

2351 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

2352 
cdw10
 |ğ((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

2353  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

2354 
	}
}

2356 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Şd
, u64 
Ãw
,

2357 
´_ty³
 
ty³
, 
boŞ
 
abÜt
)

2359 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
abÜt
 ? 2 : 1;

2360  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

2361 
	}
}

2363 
	$nvme_´_ş—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

2365 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

2366  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

2367 
	}
}

2369 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

2371 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
key
 ? 1 << 3 : 0;

2372  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

2373 
	}
}

2375 cÚ¡ 
´_İs
 
	gnvme_´_İs
 = {

2376 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

2377 .
	g´_»£rve
 = 
nvme_´_»£rve
,

2378 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

2379 .
	g´_´“m±
 = 
nvme_´_´“m±
,

2380 .
	g´_ş—r
 = 
nvme_´_ş—r
,

2383 #ifdeà
CONFIG_BLK_SED_OPAL


2384 
	$nvme_£c_subm™
(*
d©a
, 
u16
 
¥¥
, 
u8
 
£ı
, *
bufãr
, 
size_t
 
Ën
,

2385 
boŞ
 
£nd
)

2387 
nvme_ù¾
 *
ù¾
 = 
d©a
;

2388 
nvme_commªd
 
cmd
;

2390 
	`mem£t
(&
cmd
, 0, (cmd));

2391 ià(
£nd
)

2392 
cmd
.
commÚ
.
İcode
 = 
nvme_admš_£cur™y_£nd
;

2394 
cmd
.
commÚ
.
İcode
 = 
nvme_admš_£cur™y_»cv
;

2395 
cmd
.
commÚ
.
nsid
 = 0;

2396 
cmd
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(((
u32
)
£ı
è<< 24 | ((u32)
¥¥
) << 8);

2397 
cmd
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
Ën
);

2399  
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, 
bufãr
, 
Ën
,

2400 
ADMIN_TIMEOUT
, 
NVME_QID_ANY
, 1, 0);

2401 
	}
}

2402 
EXPORT_SYMBOL_GPL
(
nvme_£c_subm™
);

2405 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

2406 .
owÃr
 = 
THIS_MODULE
,

2407 .
	gioùl
 = 
nvme_ioùl
,

2408 .
	gcom·t_ioùl
 = 
nvme_com·t_ioùl
,

2409 .
	gİ’
 = 
nvme_İ’
,

2410 .
	g»Ëa£
 = 
nvme_»Ëa£
,

2411 .
	gg‘geo
 = 
nvme_g‘geo
,

2412 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

2413 .
	g´_İs
 = &
nvme_´_İs
,

2416 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

2418 
timeout
 =

2419 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

2420 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

2421 
»t
;

2423 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2424 ià(
c¡s
 == ~0)

2425  -
ENODEV
;

2426 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ğ
b™
)

2429 
	`m¦“p
(100);

2430 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2431  -
EINTR
;

2432 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2433 
	`dev_”r
(
ù¾
->
deviû
,

2434 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

2436  -
ENODEV
;

2440  
»t
;

2441 
	}
}

2449 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2451 
»t
;

2453 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2454 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

2456 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2457 ià(
»t
)

2458  
»t
;

2460 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

2461 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

2463  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

2464 
	}
}

2465 
EXPORT_SYMBOL_GPL
(
nvme_di§bË_ù¾
);

2467 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2474 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

2475 
»t
;

2477 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

2478 
	`dev_”r
(
ù¾
->
deviû
,

2480 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

2481  -
ENODEV
;

2484 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

2486 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

2487 
ù¾
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

2488 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

2489 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

2490 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

2492 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2493 ià(
»t
)

2494  
»t
;

2495  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

2496 
	}
}

2497 
EXPORT_SYMBOL_GPL
(
nvme_’abË_ù¾
);

2499 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

2501 
timeout
 = 
jiff›s
 + (
shutdown_timeout
 * 
HZ
);

2502 
u32
 
c¡s
;

2503 
»t
;

2505 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2506 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

2508 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2509 ià(
»t
)

2510  
»t
;

2512 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2513 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ğ
NVME_CSTS_SHST_CMPLT
)

2516 
	`m¦“p
(100);

2517 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2518  -
EINTR
;

2519 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2520 
	`dev_”r
(
ù¾
->
deviû
,

2522  -
ENODEV
;

2526  
»t
;

2527 
	}
}

2528 
EXPORT_SYMBOL_GPL
(
nvme_shutdown_ù¾
);

2530 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

2531 
»que¡_queue
 *
q
)

2533 
boŞ
 
vwc
 = 
çl£
;

2535 ià(
ù¾
->
max_hw_£ùÜs
) {

2536 
u32
 
max_£gm’ts
 =

2537 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

2539 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2540 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

2542 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
)

2543 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2544 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

2545 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2546 
vwc
 = 
Œue
;

2547 
	`blk_queue_wr™e_ÿche
(
q
, 
vwc
, vwc);

2548 
	}
}

2550 
	$nvme_cÚfigu»_­¡
(
nvme_ù¾
 *
ù¾
)

2568 
­¡e
;

2569 
nvme_ã©_auto_p¡
 *
bË
;

2570 
u64
 
max_Ït_us
 = 0;

2571 
max_ps
 = -1;

2572 
»t
;

2578 ià(!
ù¾
->
­¡a
)

2581 ià(
ù¾
->
Åss
 > 31) {

2582 
	`dev_w¬n
(
ù¾
->
deviû
, "NPSS is invalid;‚ot using APST\n");

2586 
bË
 = 
	`kz®loc
((*bË), 
GFP_KERNEL
);

2587 ià(!
bË
)

2590 ià(!
ù¾
->
­¡_’abËd
 || cŒl->
ps_max_Ï‹ncy_us
 == 0) {

2592 
­¡e
 = 0;

2593 
	`dev_dbg
(
ù¾
->
deviû
, "APST disabled\n");

2595 
__Ë64
 
rg‘
 = 
	`ıu_to_Ë64
(0);

2596 
¡©e
;

2604 
¡©e
 = ()
ù¾
->
Åss
; state >= 0; state--) {

2605 
u64
 
tÙ®_Ï‹ncy_us
, 
ex™_Ï‹ncy_us
, 
Œªs™iÚ_ms
;

2607 ià(
rg‘
)

2608 
bË
->
’Œ›s
[
¡©e
] = 
rg‘
;

2614 ià(
¡©e
 =ğ
ù¾
->
Åss
 &&

2615 (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
))

2622 ià(!(
ù¾
->
psd
[
¡©e
].
æags
 &

2623 
NVME_PS_FLAGS_NON_OP_STATE
))

2626 
ex™_Ï‹ncy_us
 =

2627 (
u64
)
	`Ë32_to_ıu
(
ù¾
->
psd
[
¡©e
].
ex™_Ït
);

2628 ià(
ex™_Ï‹ncy_us
 > 
ù¾
->
ps_max_Ï‹ncy_us
)

2631 
tÙ®_Ï‹ncy_us
 =

2632 
ex™_Ï‹ncy_us
 +

2633 
	`Ë32_to_ıu
(
ù¾
->
psd
[
¡©e
].
’Œy_Ït
);

2639 
Œªs™iÚ_ms
 = 
tÙ®_Ï‹ncy_us
 + 19;

2640 
	`do_div
(
Œªs™iÚ_ms
, 20);

2641 ià(
Œªs™iÚ_ms
 > (1 << 24) - 1)

2642 
Œªs™iÚ_ms
 = (1 << 24) - 1;

2644 
rg‘
 = 
	`ıu_to_Ë64
((
¡©e
 << 3) |

2645 (
Œªs™iÚ_ms
 << 8));

2647 ià(
max_ps
 == -1)

2648 
max_ps
 = 
¡©e
;

2650 ià(
tÙ®_Ï‹ncy_us
 > 
max_Ït_us
)

2651 
max_Ït_us
 = 
tÙ®_Ï‹ncy_us
;

2654 
­¡e
 = 1;

2656 ià(
max_ps
 == -1) {

2657 
	`dev_dbg
(
ù¾
->
deviû
, "APSTƒnabled but‚o‚on-operational states‡re‡vailable\n");

2659 
	`dev_dbg
(
ù¾
->
deviû
, "APSTƒnabled: max PS = %d, max„ound-trip†atency = %lluus,able = %*phN\n",

2660 
max_ps
, 
max_Ït_us
, ()(*
bË
),able);

2664 
»t
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_AUTO_PST
, 
­¡e
,

2665 
bË
, (*bË), 
NULL
);

2666 ià(
»t
)

2667 
	`dev_”r
(
ù¾
->
deviû
, "çedØ£ˆAPST f—tu» (%d)\n", 
»t
);

2669 
	`kä“
(
bË
);

2670  
»t
;

2671 
	}
}

2673 
	$nvme_£t_Ï‹ncy_tŞ”ªû
(
deviû
 *
dev
, 
s32
 
v®
)

2675 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2676 
u64
 
Ï‹ncy
;

2678 
v®
) {

2679 
PM_QOS_LATENCY_TOLERANCE_NO_CONSTRAINT
:

2680 
PM_QOS_LATENCY_ANY
:

2681 
Ï‹ncy
 = 
U64_MAX
;

2685 
Ï‹ncy
 = 
v®
;

2688 ià(
ù¾
->
ps_max_Ï‹ncy_us
 !ğ
Ï‹ncy
) {

2689 
ù¾
->
ps_max_Ï‹ncy_us
 = 
Ï‹ncy
;

2690 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2692 
	}
}

2694 
	snvme_cÜe_quœk_’Œy
 {

2700 
u16
 
	mvid
;

2701 cÚ¡ *
	mmn
;

2702 cÚ¡ *
	mä
;

2703 
	mquœks
;

2706 cÚ¡ 
nvme_cÜe_quœk_’Œy
 
	gcÜe_quœks
[] = {

2712 .
vid
 = 0x1179,

2713 .
	gmn
 = "THNSF5256GPUK TOSHIBA",

2714 .
	gquœks
 = 
NVME_QUIRK_NO_APST
,

2719 
boŞ
 
	$¡ršg_m©ches
(cÚ¡ *
id¡r
, cÚ¡ *
m©ch
, 
size_t
 
Ën
)

2721 
size_t
 
m©chËn
;

2723 ià(!
m©ch
)

2724  
Œue
;

2726 
m©chËn
 = 
	`¡¾’
(
m©ch
);

2727 
	`WARN_ON_ONCE
(
m©chËn
 > 
Ën
);

2729 ià(
	`memcmp
(
id¡r
, 
m©ch
, 
m©chËn
))

2730  
çl£
;

2732 ; 
m©chËn
 < 
Ën
; matchlen++)

2733 ià(
id¡r
[
m©chËn
] != ' ')

2734  
çl£
;

2736  
Œue
;

2737 
	}
}

2739 
boŞ
 
	$quœk_m©ches
(cÚ¡ 
nvme_id_ù¾
 *
id
,

2740 cÚ¡ 
nvme_cÜe_quœk_’Œy
 *
q
)

2742  
q
->
vid
 =ğ
	`Ë16_to_ıu
(
id
->vid) &&

2743 
	`¡ršg_m©ches
(
id
->
mn
, 
q
->mn, (id->mn)) &&

2744 
	`¡ršg_m©ches
(
id
->
ä
, 
q
->fr, (id->fr));

2745 
	}
}

2747 
	$nvme_š™_subnqn
(
nvme_ù¾
 *
ù¾
, 
nvme_id_ù¾
 *
id
)

2749 
size_t
 
nqÆ’
;

2750 
off
;

2752 
nqÆ’
 = 
	`¡ºËn
(
id
->
subnqn
, 
NVMF_NQN_SIZE
);

2753 ià(
nqÆ’
 > 0 &&‚qÆ’ < 
NVMF_NQN_SIZE
) {

2754 
	`¡rıy
(
ù¾
->
subnqn
, 
id
->subnqn);

2758 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 1))

2759 
	`dev_w¬n
(
ù¾
->
deviû
, "missing or invalid SUBNQN field.\n");

2762 
off
 = 
	`¢´štf
(
ù¾
->
subnqn
, 
NVMF_NQN_SIZE
,

2764 
	`Ë16_to_ıu
(
id
->
vid
),†e16_to_ıu(id->
ssvid
));

2765 
	`memıy
(
ù¾
->
subnqn
 + 
off
, 
id
->
¢
, (id->sn));

2766 
off
 +ğ(
id
->
¢
);

2767 
	`memıy
(
ù¾
->
subnqn
 + 
off
, 
id
->
mn
, (id->mn));

2768 
off
 +ğ(
id
->
mn
);

2769 
	`mem£t
(
ù¾
->
subnqn
 + 
off
, 0, (ctrl->subnqn) - off);

2770 
	}
}

2777 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

2779 
nvme_id_ù¾
 *
id
;

2780 
u64
 
ÿp
;

2781 
»t
, 
·ge_shiá
;

2782 
u32
 
max_hw_£ùÜs
;

2783 
boŞ
 
´ev_­¡_’abËd
;

2785 
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

2786 ià(
»t
) {

2787 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg VS faed (%d)\n", 
»t
);

2788  
»t
;

2791 
»t
 = 
ù¾
->
İs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

2792 ià(
»t
) {

2793 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg CAP faed (%d)\n", 
»t
);

2794  
»t
;

2796 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

2798 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

2799 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

2801 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

2802 ià(
»t
) {

2803 
	`dev_”r
(
ù¾
->
deviû
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»t
);

2804  -
EIO
;

2807 
	`nvme_š™_subnqn
(
ù¾
, 
id
);

2809 ià(!
ù¾
->
id’tif›d
) {

2819 
i
;

2821 
i
 = 0; i < 
	`ARRAY_SIZE
(
cÜe_quœks
); i++) {

2822 ià(
	`quœk_m©ches
(
id
, &
cÜe_quœks
[
i
]))

2823 
ù¾
->
quœks
 |ğ
cÜe_quœks
[
i
].quirks;

2827 ià(
fÜû_­¡
 && (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
)) {

2828 
	`dev_w¬n
(
ù¾
->
deviû
, "forcibly‡llowing‡ll…ower states dueo‚vme_core.force_apst -- use‡t your own„isk\n");

2829 
ù¾
->
quœks
 &ğ~
NVME_QUIRK_NO_DEEPEST_PS
;

2832 
ù¾
->
ßcs
 = 
	`Ë16_to_ıu
(
id
->oacs);

2833 
ù¾
->
vid
 = 
	`Ë16_to_ıu
(
id
->vid);

2834 
ù¾
->
Úcs
 = 
	`Ë16_to_ıup
(&
id
->oncs);

2835 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aş
 + 1);

2836 
ù¾
->
vwc
 = 
id
->vwc;

2837 
ù¾
->
úid
 = 
	`Ë16_to_ıup
(&
id
->cntlid);

2838 
	`memıy
(
ù¾
->
£rŸl
, 
id
->
¢
, (id->sn));

2839 
	`memıy
(
ù¾
->
mod–
, 
id
->
mn
, (id->mn));

2840 
	`memıy
(
ù¾
->
fœmw¬e_»v
, 
id
->
ä
, (id->fr));

2841 ià(
id
->
mdts
)

2842 
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

2844 
max_hw_£ùÜs
 = 
UINT_MAX
;

2845 
ù¾
->
max_hw_£ùÜs
 =

2846 
	`mš_nÙ_z”o
(
ù¾
->
max_hw_£ùÜs
, max_hw_sectors);

2848 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

2849 
ù¾
->
sgls
 = 
	`Ë32_to_ıu
(
id
->sgls);

2850 
ù¾
->
kas
 = 
	`Ë16_to_ıu
(
id
->kas);

2852 
ù¾
->
Åss
 = 
id
->npss;

2853 
ù¾
->
­¡a
 = 
id
->apsta;

2854 
´ev_­¡_’abËd
 = 
ù¾
->
­¡_’abËd
;

2855 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_NO_APST
) {

2856 ià(
fÜû_­¡
 && 
id
->
­¡a
) {

2857 
	`dev_w¬n
(
ù¾
->
deviû
, "forcibly‡llowing APST dueo‚vme_core.force_apst -- use‡t your own„isk\n");

2858 
ù¾
->
­¡_’abËd
 = 
Œue
;

2860 
ù¾
->
­¡_’abËd
 = 
çl£
;

2863 
ù¾
->
­¡_’abËd
 = 
id
->
­¡a
;

2865 
	`memıy
(
ù¾
->
psd
, 
id
->psd, (ctrl->psd));

2867 ià(
ù¾
->
İs
->
æags
 & 
NVME_F_FABRICS
) {

2868 
ù¾
->
icdoff
 = 
	`Ë16_to_ıu
(
id
->icdoff);

2869 
ù¾
->
ioccsz
 = 
	`Ë32_to_ıu
(
id
->ioccsz);

2870 
ù¾
->
iÜcsz
 = 
	`Ë32_to_ıu
(
id
->iorcsz);

2871 
ù¾
->
maxcmd
 = 
	`Ë16_to_ıu
(
id
->maxcmd);

2877 ià(
ù¾
->
úid
 !ğ
	`Ë16_to_ıu
(
id
->cntlid)) {

2878 
»t
 = -
EINVAL
;

2879 
out_ä“
;

2882 ià(!
ù¾
->
İts
->
discov”y_nqn
 && !ù¾->
kas
) {

2883 
	`dev_”r
(
ù¾
->
deviû
,

2885 
»t
 = -
EINVAL
;

2886 
out_ä“
;

2889 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
id
->cntlid);

2890 
ù¾
->
hm´e
 = 
	`Ë32_to_ıu
(
id
->hmpre);

2891 
ù¾
->
hmmš
 = 
	`Ë32_to_ıu
(
id
->hmmin);

2894 
	`kä“
(
id
);

2896 ià(
ù¾
->
­¡_’abËd
 && !
´ev_­¡_’abËd
)

2897 
	`dev_pm_qos_expo£_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
);

2898 ià(!
ù¾
->
­¡_’abËd
 && 
´ev_­¡_’abËd
)

2899 
	`dev_pm_qos_hide_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
);

2901 
»t
 = 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2902 ià(
»t
 < 0)

2903  
»t
;

2905 
»t
 = 
	`nvme_cÚfigu»_dœeùives
(
ù¾
);

2906 ià(
»t
 < 0)

2907  
»t
;

2909 
ù¾
->
id’tif›d
 = 
Œue
;

2913 
out_ä“
:

2914 
	`kä“
(
id
);

2915  
»t
;

2916 
	}
}

2917 
EXPORT_SYMBOL_GPL
(
nvme_š™_id’tify
);

2919 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *file)

2921 
nvme_ù¾
 *
ù¾
;

2922 
š¡ªû
 = 
	`imšÜ
(
šode
);

2923 
»t
 = -
ENODEV
;

2925 
	`¥š_lock
(&
dev_li¡_lock
);

2926 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_ù¾_li¡
, 
node
) {

2927 ià(
ù¾
->
š¡ªû
 != instance)

2930 ià(!
ù¾
->
admš_q
) {

2931 
»t
 = -
EWOULDBLOCK
;

2934 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
k»f
))

2936 
fe
->
´iv©e_d©a
 = 
ù¾
;

2937 
»t
 = 0;

2940 
	`¥š_uÆock
(&
dev_li¡_lock
);

2942  
»t
;

2943 
	}
}

2945 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

2947 
	`nvme_put_ù¾
(
fe
->
´iv©e_d©a
);

2949 
	}
}

2951 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

2953 
nvme_ns
 *
ns
;

2954 
»t
;

2956 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2957 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

2958 
»t
 = -
ENOTTY
;

2959 
out_uÆock
;

2962 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

2963 ià(
ns
 !ğ
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

2964 
	`dev_w¬n
(
ù¾
->
deviû
,

2966 
»t
 = -
EINVAL
;

2967 
out_uÆock
;

2970 
	`dev_w¬n
(
ù¾
->
deviû
,

2972 
	`k»f_g‘
(&
ns
->
k»f
);

2973 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2975 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

2976 
	`nvme_put_ns
(
ns
);

2977  
»t
;

2979 
out_uÆock
:

2980 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2981  
»t
;

2982 
	}
}

2984 
	$nvme_dev_ioùl
(
fe
 *fe, 
cmd
,

2985 
¬g
)

2987 
nvme_ù¾
 *
ù¾
 = 
fe
->
´iv©e_d©a
;

2988 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

2990 
cmd
) {

2991 
NVME_IOCTL_ADMIN_CMD
:

2992  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

2993 
NVME_IOCTL_IO_CMD
:

2994  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

2995 
NVME_IOCTL_RESET
:

2996 
	`dev_w¬n
(
ù¾
->
deviû
, "resetting controller\n");

2997  
	`nvme_»£t_ù¾_sync
(
ù¾
);

2998 
NVME_IOCTL_SUBSYS_RESET
:

2999  
	`nvme_»£t_subsy¡em
(
ù¾
);

3000 
NVME_IOCTL_RESCAN
:

3001 
	`nvme_queue_sÿn
(
ù¾
);

3004  -
ENOTTY
;

3006 
	}
}

3008 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

3009 .
owÃr
 = 
THIS_MODULE
,

3010 .
	gİ’
 = 
nvme_dev_İ’
,

3011 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

3012 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

3013 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

3016 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

3017 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3018 
size_t
 
couÁ
)

3020 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3021 
»t
;

3023 
»t
 = 
	`nvme_»£t_ù¾_sync
(
ù¾
);

3024 ià(
»t
 < 0)

3025  
»t
;

3026  
couÁ
;

3027 
	}
}

3028 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

3030 
ssize_t
 
	$nvme_sysfs_»sÿn
(
deviû
 *
dev
,

3031 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3032 
size_t
 
couÁ
)

3034 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3036 
	`nvme_queue_sÿn
(
ù¾
);

3037  
couÁ
;

3038 
	}
}

3039 
DEVICE_ATTR
(
»sÿn_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»sÿn
);

3041 
ssize_t
 
	$wwid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3042 *
buf
)

3044 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

3045 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

3046 
£rŸl_Ën
 = (
ù¾
->
£rŸl
);

3047 
mod–_Ën
 = (
ù¾
->
mod–
);

3049 ià(!
	`uuid_is_nuÎ
(&
ns
->
uuid
))

3050  
	`¥rštf
(
buf
, "uuid.%pU\n", &
ns
->
uuid
);

3052 ià(
	`memchr_šv
(
ns
->
nguid
, 0, (ns->nguid)))

3053  
	`¥rštf
(
buf
, "eui.%16phN\n", 
ns
->
nguid
);

3055 ià(
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

3056  
	`¥rštf
(
buf
, "eui.%8phN\n", 
ns
->
eui
);

3058 
£rŸl_Ën
 > 0 && (
ù¾
->
£rŸl
[serial_len - 1] == ' ' ||

3059 
ù¾
->
£rŸl
[
£rŸl_Ën
 - 1] == '\0'))

3060 
£rŸl_Ën
--;

3061 
mod–_Ën
 > 0 && (
ù¾
->
mod–
[model_len - 1] == ' ' ||

3062 
ù¾
->
mod–
[
mod–_Ën
 - 1] == '\0'))

3063 
mod–_Ën
--;

3065  
	`¥rštf
(
buf
, "nvme.%04x-%*phN-%*phN-%08x\n", 
ù¾
->
vid
,

3066 
£rŸl_Ën
, 
ù¾
->
£rŸl
, 
mod–_Ën
, cŒl->
mod–
, 
ns
->
ns_id
);

3067 
	}
}

3068 
DEVICE_ATTR
(
wwid
, 
S_IRUGO
, 
wwid_show
, 
NULL
);

3070 
ssize_t
 
	$nguid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3071 *
buf
)

3073 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

3074  
	`¥rštf
(
buf
, "%pU\n", 
ns
->
nguid
);

3075 
	}
}

3076 
DEVICE_ATTR
(
nguid
, 
S_IRUGO
, 
nguid_show
, 
NULL
);

3078 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3079 *
buf
)

3081 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

3086 ià(
	`uuid_is_nuÎ
(&
ns
->
uuid
)) {

3087 
	`´štk_¿‹lim™ed
(
KERN_WARNING


3089  
	`¥rštf
(
buf
, "%pU\n", 
ns
->
nguid
);

3091  
	`¥rštf
(
buf
, "%pU\n", &
ns
->
uuid
);

3092 
	}
}

3093 
DEVICE_ATTR
(
uuid
, 
S_IRUGO
, 
uuid_show
, 
NULL
);

3095 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3096 *
buf
)

3098 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

3099  
	`¥rštf
(
buf
, "%8phd\n", 
ns
->
eui
);

3100 
	}
}

3101 
DEVICE_ATTR
(
eui
, 
S_IRUGO
, 
eui_show
, 
NULL
);

3103 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3104 *
buf
)

3106 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

3107  
	`¥rštf
(
buf
, "%d\n", 
ns
->
ns_id
);

3108 
	}
}

3109 
DEVICE_ATTR
(
nsid
, 
S_IRUGO
, 
nsid_show
, 
NULL
);

3111 
©Œibu‹
 *
	gnvme_ns_©Œs
[] = {

3112 &
dev_©Œ_wwid
.
©Œ
,

3113 &
dev_©Œ_uuid
.
©Œ
,

3114 &
dev_©Œ_nguid
.
©Œ
,

3115 &
dev_©Œ_eui
.
©Œ
,

3116 &
dev_©Œ_nsid
.
©Œ
,

3117 
NULL
,

3120 
umode_t
 
	$nvme_ns_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

3121 
©Œibu‹
 *
a
, 
n
)

3123 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

3124 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

3126 ià(
a
 =ğ&
dev_©Œ_uuid
.
©Œ
) {

3127 ià(
	`uuid_is_nuÎ
(&
ns
->
uuid
) ||

3128 !
	`memchr_šv
(
ns
->
nguid
, 0, (ns->nguid)))

3131 ià(
a
 =ğ&
dev_©Œ_nguid
.
©Œ
) {

3132 ià(!
	`memchr_šv
(
ns
->
nguid
, 0, (ns->nguid)))

3135 ià(
a
 =ğ&
dev_©Œ_eui
.
©Œ
) {

3136 ià(!
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

3139  
a
->
mode
;

3140 
	}
}

3142 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_©Œ_group
 = {

3143 .
©Œs
 = 
nvme_ns_©Œs
,

3144 .
	gis_visibË
 = 
nvme_ns_©Œs_¬e_visibË
,

3147 
	#nvme_show_¡r_funùiÚ
(
f›ld
) \

3148 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

3149 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

3151 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

3152  
	`¥rštf
(
buf
, "%.*s\n", ()(
ù¾
->
f›ld
), ctrl->field); \

3154 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

3156 
	#nvme_show_št_funùiÚ
(
f›ld
) \

3157 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

3158 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

3160 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

3161  
	`¥rštf
(
buf
, "%d\n", 
ù¾
->
f›ld
); \

3163 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

3165 
nvme_show_¡r_funùiÚ
(
mod–
);

3166 
nvme_show_¡r_funùiÚ
(
£rŸl
);

3167 
nvme_show_¡r_funùiÚ
(
fœmw¬e_»v
);

3168 
nvme_show_št_funùiÚ
(
úid
);

3170 
ssize_t
 
	$nvme_sysfs_d–‘e
(
deviû
 *
dev
,

3171 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3172 
size_t
 
couÁ
)

3174 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3176 ià(
	`deviû_»move_fe_£lf
(
dev
, 
©Œ
))

3177 
ù¾
->
İs
->
	`d–‘e_ù¾
(ctrl);

3178  
couÁ
;

3179 
	}
}

3180 
DEVICE_ATTR
(
d–‘e_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_d–‘e
);

3182 
ssize_t
 
	$nvme_sysfs_show_Œª¥Üt
(
deviû
 *
dev
,

3183 
deviû_©Œibu‹
 *
©Œ
,

3184 *
buf
)

3186 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3188  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
İs
->
Çme
);

3189 
	}
}

3190 
DEVICE_ATTR
(
Œª¥Üt
, 
S_IRUGO
, 
nvme_sysfs_show_Œª¥Üt
, 
NULL
);

3192 
ssize_t
 
	$nvme_sysfs_show_¡©e
(
deviû
 *
dev
,

3193 
deviû_©Œibu‹
 *
©Œ
,

3194 *
buf
)

3196 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3197 cÚ¡ *cÚ¡ 
¡©e_Çme
[] = {

3198 [
NVME_CTRL_NEW
] = "new",

3199 [
NVME_CTRL_LIVE
] = "live",

3200 [
NVME_CTRL_RESETTING
] = "resetting",

3201 [
NVME_CTRL_RECONNECTING
]= "reconnecting",

3202 [
NVME_CTRL_DELETING
] = "deleting",

3203 [
NVME_CTRL_DEAD
] = "dead",

3206 ià(()
ù¾
->
¡©e
 < 
	`ARRAY_SIZE
(
¡©e_Çme
) &&

3207 
¡©e_Çme
[
ù¾
->
¡©e
])

3208  
	`¥rštf
(
buf
, "%s\n", 
¡©e_Çme
[
ù¾
->
¡©e
]);

3210  
	`¥rštf
(
buf
, "unknown state\n");

3211 
	}
}

3213 
DEVICE_ATTR
(
¡©e
, 
S_IRUGO
, 
nvme_sysfs_show_¡©e
, 
NULL
);

3215 
ssize_t
 
	$nvme_sysfs_show_subsy¢qn
(
deviû
 *
dev
,

3216 
deviû_©Œibu‹
 *
©Œ
,

3217 *
buf
)

3219 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3221  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
subnqn
);

3222 
	}
}

3223 
DEVICE_ATTR
(
subsy¢qn
, 
S_IRUGO
, 
nvme_sysfs_show_subsy¢qn
, 
NULL
);

3225 
ssize_t
 
	$nvme_sysfs_show_add»ss
(
deviû
 *
dev
,

3226 
deviû_©Œibu‹
 *
©Œ
,

3227 *
buf
)

3229 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3231  
ù¾
->
İs
->
	`g‘_add»ss
(ù¾, 
buf
, 
PAGE_SIZE
);

3232 
	}
}

3233 
DEVICE_ATTR
(
add»ss
, 
S_IRUGO
, 
nvme_sysfs_show_add»ss
, 
NULL
);

3235 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

3236 &
dev_©Œ_»£t_cÚŒŞËr
.
©Œ
,

3237 &
dev_©Œ_»sÿn_cÚŒŞËr
.
©Œ
,

3238 &
dev_©Œ_mod–
.
©Œ
,

3239 &
dev_©Œ_£rŸl
.
©Œ
,

3240 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

3241 &
dev_©Œ_úid
.
©Œ
,

3242 &
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
,

3243 &
dev_©Œ_Œª¥Üt
.
©Œ
,

3244 &
dev_©Œ_subsy¢qn
.
©Œ
,

3245 &
dev_©Œ_add»ss
.
©Œ
,

3246 &
dev_©Œ_¡©e
.
©Œ
,

3247 
NULL


3250 
umode_t
 
	$nvme_dev_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

3251 
©Œibu‹
 *
a
, 
n
)

3253 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

3254 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3256 ià(
a
 =ğ&
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
 && !
ù¾
->
İs
->
d–‘e_ù¾
)

3258 ià(
a
 =ğ&
dev_©Œ_add»ss
.
©Œ
 && !
ù¾
->
İs
->
g‘_add»ss
)

3261  
a
->
mode
;

3262 
	}
}

3264 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

3265 .
©Œs
 = 
nvme_dev_©Œs
,

3266 .
	gis_visibË
 = 
nvme_dev_©Œs_¬e_visibË
,

3269 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

3270 &
nvme_dev_©Œs_group
,

3271 
NULL
,

3274 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

3276 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

3277 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

3279  
n§
->
ns_id
 - 
nsb
->ns_id;

3280 
	}
}

3282 
nvme_ns
 *
	$nvme_fšd_g‘_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3284 
nvme_ns
 *
ns
, *
»t
 = 
NULL
;

3286 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3287 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3288 ià(
ns
->
ns_id
 =ğ
nsid
) {

3289 
	`k»f_g‘
(&
ns
->
k»f
);

3290 
»t
 = 
ns
;

3293 ià(
ns
->
ns_id
 > 
nsid
)

3296 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3297  
»t
;

3298 
	}
}

3300 
	$nvme_£tup_¡»ams_ns
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
)

3302 
¡»ams_dœeùive_·¿ms
 
s
;

3303 
»t
;

3305 ià(!
ù¾
->
Ä_¡»ams
)

3308 
»t
 = 
	`nvme_g‘_¡»am_·¿ms
(
ù¾
, &
s
, 
ns
->
ns_id
);

3309 ià(
»t
)

3310  
»t
;

3312 
ns
->
sws
 = 
	`Ë32_to_ıu
(
s
.sws);

3313 
ns
->
sgs
 = 
	`Ë16_to_ıu
(
s
.sgs);

3315 ià(
ns
->
sws
) {

3316 
bs
 = 1 << 
ns
->
lba_shiá
;

3318 
	`blk_queue_io_mš
(
ns
->
queue
, 
bs
 *‚s->
sws
);

3319 ià(
ns
->
sgs
)

3320 
	`blk_queue_io_İt
(
ns
->
queue
, 
bs
 *‚s->
sws
 *‚s->
sgs
);

3324 
	}
}

3326 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3328 
nvme_ns
 *
ns
;

3329 
g’disk
 *
disk
;

3330 
nvme_id_ns
 *
id
;

3331 
disk_Çme
[
DISK_NAME_LEN
];

3332 
node
 = 
	`dev_to_node
(
ù¾
->
dev
);

3334 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

3335 ià(!
ns
)

3338 
ns
->
š¡ªû
 = 
	`ida_sim¶e_g‘
(&
ù¾
->
ns_ida
, 1, 0, 
GFP_KERNEL
);

3339 ià(
ns
->
š¡ªû
 < 0)

3340 
out_ä“_ns
;

3342 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

3343 ià(
	`IS_ERR
(
ns
->
queue
))

3344 
out_»Ëa£_š¡ªû
;

3345 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

3346 
ns
->
queue
->
queued©a
 =‚s;

3347 
ns
->
ù¾
 = ctrl;

3349 
	`k»f_š™
(&
ns
->
k»f
);

3350 
ns
->
ns_id
 = 
nsid
;

3351 
ns
->
lba_shiá
 = 9;

3353 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

3354 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

3355 
	`nvme_£tup_¡»ams_ns
(
ù¾
, 
ns
);

3357 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
ns
->instance);

3359 ià(
	`nvme_»v®id©e_ns
(
ns
, &
id
))

3360 
out_ä“_queue
;

3362 ià(
	`nvme_nvm_ns_suµÜ‹d
(
ns
, 
id
) &&

3363 
	`nvme_nvm_»gi¡”
(
ns
, 
disk_Çme
, 
node
)) {

3364 
	`dev_w¬n
(
ù¾
->
deviû
, "%s: LightNVM in™ fau»\n", 
__func__
);

3365 
out_ä“_id
;

3368 
disk
 = 
	`®loc_disk_node
(0, 
node
);

3369 ià(!
disk
)

3370 
out_ä“_id
;

3372 
disk
->
fİs
 = &
nvme_fİs
;

3373 
disk
->
´iv©e_d©a
 = 
ns
;

3374 
disk
->
queue
 = 
ns
->queue;

3375 
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

3376 
	`memıy
(
disk
->
disk_Çme
, disk_Çme, 
DISK_NAME_LEN
);

3377 
ns
->
disk
 = disk;

3379 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

3381 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3382 
	`li¡_add_
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

3383 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3385 
	`k»f_g‘
(&
ù¾
->
k»f
);

3387 
	`kä“
(
id
);

3389 
	`deviû_add_disk
(
ù¾
->
deviû
, 
ns
->
disk
);

3390 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

3391 &
nvme_ns_©Œ_group
))

3392 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

3393 
ns
->
disk
->
disk_Çme
);

3394 ià(
ns
->
ndev
 && 
	`nvme_nvm_»gi¡”_sysfs
(ns))

3395 
	`´_w¬n
("%s: failedo„egister†ightnvm sysfs group for identification\n",

3396 
ns
->
disk
->
disk_Çme
);

3398 
out_ä“_id
:

3399 
	`kä“
(
id
);

3400 
out_ä“_queue
:

3401 
	`blk_ş—nup_queue
(
ns
->
queue
);

3402 
out_»Ëa£_š¡ªû
:

3403 
	`ida_sim¶e_»move
(&
ù¾
->
ns_ida
, 
ns
->
š¡ªû
);

3404 
out_ä“_ns
:

3405 
	`kä“
(
ns
);

3406 
	}
}

3408 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

3410 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

3413 ià(
ns
->
disk
 &&‚s->disk->
æags
 & 
GENHD_FL_UP
) {

3414 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

3415 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

3416 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

3417 &
nvme_ns_©Œ_group
);

3418 ià(
ns
->
ndev
)

3419 
	`nvme_nvm_uÄegi¡”_sysfs
(
ns
);

3420 
	`d–_g’disk
(
ns
->
disk
);

3421 
	`blk_ş—nup_queue
(
ns
->
queue
);

3424 
	`mu‹x_lock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

3425 
	`li¡_d–_š™
(&
ns
->
li¡
);

3426 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

3428 
	`nvme_put_ns
(
ns
);

3429 
	}
}

3431 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3433 
nvme_ns
 *
ns
;

3435 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
nsid
);

3436 ià(
ns
) {

3437 ià(
ns
->
disk
 && 
	`»v®id©e_disk
(ns->disk))

3438 
	`nvme_ns_»move
(
ns
);

3439 
	`nvme_put_ns
(
ns
);

3441 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

3442 
	}
}

3444 
	$nvme_»move_šv®id_Çme¥aûs
(
nvme_ù¾
 *
ù¾
,

3445 
nsid
)

3447 
nvme_ns
 *
ns
, *
Ãxt
;

3449 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3450 ià(
ns
->
ns_id
 > 
nsid
)

3451 
	`nvme_ns_»move
(
ns
);

3453 
	}
}

3455 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

3457 
nvme_ns
 *
ns
;

3458 
__Ë32
 *
ns_li¡
;

3459 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

3460 
»t
 = 0;

3462 
ns_li¡
 = 
	`kz®loc
(0x1000, 
GFP_KERNEL
);

3463 ià(!
ns_li¡
)

3464  -
ENOMEM
;

3466 
i
 = 0; i < 
num_li¡s
; i++) {

3467 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

3468 ià(
»t
)

3469 
ä“
;

3471 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

3472 
nsid
 = 
	`Ë32_to_ıu
(
ns_li¡
[
j
]);

3473 ià(!
nsid
)

3474 
out
;

3476 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

3478 ++
´ev
 < 
nsid
) {

3479 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
´ev
);

3480 ià(
ns
) {

3481 
	`nvme_ns_»move
(
ns
);

3482 
	`nvme_put_ns
(
ns
);

3486 
Â
 -ğ
j
;

3488 
out
:

3489 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
´ev
);

3490 
ä“
:

3491 
	`kä“
(
ns_li¡
);

3492  
»t
;

3493 
	}
}

3495 
	$nvme_sÿn_ns_£qu’tŸl
(
nvme_ù¾
 *
ù¾
, 
Â
)

3497 
i
;

3499 
i
 = 1; i <ğ
Â
; i++)

3500 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

3502 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
Â
);

3503 
	}
}

3505 
	$nvme_sÿn_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3507 
nvme_ù¾
 *
ù¾
 =

3508 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
sÿn_wÜk
);

3509 
nvme_id_ù¾
 *
id
;

3510 
Â
;

3512 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
)

3515 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

3518 
Â
 = 
	`Ë32_to_ıu
(
id
->nn);

3519 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0) &&

3520 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

3521 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

3522 
dÚe
;

3524 
	`nvme_sÿn_ns_£qu’tŸl
(
ù¾
, 
Â
);

3525 
dÚe
:

3526 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3527 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

3528 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3529 
	`kä“
(
id
);

3530 
	}
}

3532 
	$nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
)

3538 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
)

3539 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
sÿn_wÜk
);

3540 
	}
}

3541 
EXPORT_SYMBOL_GPL
(
nvme_queue_sÿn
);

3548 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

3550 
nvme_ns
 *
ns
, *
Ãxt
;

3558 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_DEAD
)

3559 
	`nvme_kl_queues
(
ù¾
);

3561 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3562 
	`nvme_ns_»move
(
ns
);

3563 
	}
}

3564 
EXPORT_SYMBOL_GPL
(
nvme_»move_Çme¥aûs
);

3566 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3568 
nvme_ù¾
 *
ù¾
 =

3569 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
async_ev’t_wÜk
);

3571 
	`¥š_lock_œq
(&
ù¾
->
lock
);

3572 
ù¾
->
ev’t_lim™
 > 0) {

3573 
«r_idx
 = --
ù¾
->
ev’t_lim™
;

3575 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

3576 
ù¾
->
İs
->
	`subm™_async_ev’t
(ù¾, 
«r_idx
);

3577 
	`¥š_lock_œq
(&
ù¾
->
lock
);

3579 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

3580 
	}
}

3582 
	$nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

3583 
nvme_»suÉ
 *
»s
)

3585 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
»s
->u32);

3586 
boŞ
 
dÚe
 = 
Œue
;

3588 
	`Ë16_to_ıu
(
¡©us
) >> 1) {

3589 
NVME_SC_SUCCESS
:

3590 
dÚe
 = 
çl£
;

3592 
NVME_SC_ABORT_REQ
:

3593 ++
ù¾
->
ev’t_lim™
;

3594 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
async_ev’t_wÜk
);

3600 ià(
dÚe
)

3603 
»suÉ
 & 0xff07) {

3604 
NVME_AER_NOTICE_NS_CHANGED
:

3605 
	`dev_šfo
(
ù¾
->
deviû
, "rescanning\n");

3606 
	`nvme_queue_sÿn
(
ù¾
);

3609 
	`dev_w¬n
(
ù¾
->
deviû
, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

3611 
	}
}

3612 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_async_ev’t
);

3614 
	$nvme_queue_async_ev’ts
(
nvme_ù¾
 *
ù¾
)

3616 
ù¾
->
ev’t_lim™
 = 
NVME_NR_AERS
;

3617 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
async_ev’t_wÜk
);

3618 
	}
}

3619 
EXPORT_SYMBOL_GPL
(
nvme_queue_async_ev’ts
);

3621 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

3623 
	$nvme_£t_š¡ªû
(
nvme_ù¾
 *
ù¾
)

3625 
š¡ªû
, 
”rÜ
;

3628 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

3629  -
ENODEV
;

3631 
	`¥š_lock
(&
dev_li¡_lock
);

3632 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

3633 
	`¥š_uÆock
(&
dev_li¡_lock
);

3634 } 
”rÜ
 =ğ-
EAGAIN
);

3636 ià(
”rÜ
)

3637  -
ENODEV
;

3639 
ù¾
->
š¡ªû
 = instance;

3641 
	}
}

3643 
	$nvme_»Ëa£_š¡ªû
(
nvme_ù¾
 *
ù¾
)

3645 
	`¥š_lock
(&
dev_li¡_lock
);

3646 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

3647 
	`¥š_uÆock
(&
dev_li¡_lock
);

3648 
	}
}

3650 
	$nvme_¡İ_ù¾
(
nvme_ù¾
 *
ù¾
)

3652 
	`nvme_¡İ_k“p_®ive
(
ù¾
);

3653 
	`æush_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

3654 
	`æush_wÜk
(&
ù¾
->
sÿn_wÜk
);

3655 
	}
}

3656 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_ù¾
);

3658 
	$nvme_¡¬t_ù¾
(
nvme_ù¾
 *
ù¾
)

3660 ià(
ù¾
->
k©o
)

3661 
	`nvme_¡¬t_k“p_®ive
(
ù¾
);

3663 ià(
ù¾
->
queue_couÁ
 > 1) {

3664 
	`nvme_queue_sÿn
(
ù¾
);

3665 
	`nvme_queue_async_ev’ts
(
ù¾
);

3666 
	`nvme_¡¬t_queues
(
ù¾
);

3668 
	}
}

3669 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ù¾
);

3671 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

3673 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
));

3675 
	`¥š_lock
(&
dev_li¡_lock
);

3676 
	`li¡_d–
(&
ù¾
->
node
);

3677 
	`¥š_uÆock
(&
dev_li¡_lock
);

3678 
	}
}

3679 
EXPORT_SYMBOL_GPL
(
nvme_unš™_ù¾
);

3681 
	$nvme_ä“_ù¾
(
k»f
 *kref)

3683 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
k»f
, nvme_ctrl, kref);

3685 
	`put_deviû
(
ù¾
->
deviû
);

3686 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

3687 
	`ida_de¡roy
(&
ù¾
->
ns_ida
);

3689 
ù¾
->
İs
->
	`ä“_ù¾
(ctrl);

3690 
	}
}

3692 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

3694 
	`k»f_put
(&
ù¾
->
k»f
, 
nvme_ä“_ù¾
);

3695 
	}
}

3696 
EXPORT_SYMBOL_GPL
(
nvme_put_ù¾
);

3703 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

3704 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
)

3706 
»t
;

3708 
ù¾
->
¡©e
 = 
NVME_CTRL_NEW
;

3709 
	`¥š_lock_š™
(&
ù¾
->
lock
);

3710 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

3711 
	`mu‹x_š™
(&
ù¾
->
Çme¥aûs_mu‹x
);

3712 
	`k»f_š™
(&
ù¾
->
k»f
);

3713 
ù¾
->
dev
 = dev;

3714 
ù¾
->
İs
 = ops;

3715 
ù¾
->
quœks
 = quirks;

3716 
	`INIT_WORK
(&
ù¾
->
sÿn_wÜk
, 
nvme_sÿn_wÜk
);

3717 
	`INIT_WORK
(&
ù¾
->
async_ev’t_wÜk
, 
nvme_async_ev’t_wÜk
);

3719 
»t
 = 
	`nvme_£t_š¡ªû
(
ù¾
);

3720 ià(
»t
)

3721 
out
;

3723 
ù¾
->
deviû
 = 
	`deviû_ü—‹_w™h_groups
(
nvme_şass
, cŒl->
dev
,

3724 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
),

3725 
ù¾
, 
nvme_dev_©Œ_groups
,

3726 "nvme%d", 
ù¾
->
š¡ªû
);

3727 ià(
	`IS_ERR
(
ù¾
->
deviû
)) {

3728 
»t
 = 
	`PTR_ERR
(
ù¾
->
deviû
);

3729 
out_»Ëa£_š¡ªû
;

3731 
	`g‘_deviû
(
ù¾
->
deviû
);

3732 
	`ida_š™
(&
ù¾
->
ns_ida
);

3734 
	`¥š_lock
(&
dev_li¡_lock
);

3735 
	`li¡_add_
(&
ù¾
->
node
, &
nvme_ù¾_li¡
);

3736 
	`¥š_uÆock
(&
dev_li¡_lock
);

3742 
ù¾
->
deviû
->
pow”
.
£t_Ï‹ncy_tŞ”ªû
 = 
nvme_£t_Ï‹ncy_tŞ”ªû
;

3743 
	`dev_pm_qos_upd©e_u£r_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
,

3744 
	`mš
(
deçuÉ_ps_max_Ï‹ncy_us
, ()
S32_MAX
));

3747 
out_»Ëa£_š¡ªû
:

3748 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

3749 
out
:

3750  
»t
;

3751 
	}
}

3752 
EXPORT_SYMBOL_GPL
(
nvme_š™_ù¾
);

3761 
	$nvme_kl_queues
(
nvme_ù¾
 *
ù¾
)

3763 
nvme_ns
 *
ns
;

3765 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3768 ià(
ù¾
->
admš_q
)

3769 
	`blk_mq_unqu›sû_queue
(
ù¾
->
admš_q
);

3771 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3776 ià(!
ns
->
disk
 || 
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &ns->
æags
))

3778 
	`»v®id©e_disk
(
ns
->
disk
);

3779 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

3782 
	`blk_mq_unqu›sû_queue
(
ns
->
queue
);

3784 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3785 
	}
}

3786 
EXPORT_SYMBOL_GPL
(
nvme_kl_queues
);

3788 
	$nvme_unä“ze
(
nvme_ù¾
 *
ù¾
)

3790 
nvme_ns
 *
ns
;

3792 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3793 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3794 
	`blk_mq_unä“ze_queue
(
ns
->
queue
);

3795 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3796 
	}
}

3797 
EXPORT_SYMBOL_GPL
(
nvme_unä“ze
);

3799 
	$nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
)

3801 
nvme_ns
 *
ns
;

3803 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3804 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3805 
timeout
 = 
	`blk_mq_ä“ze_queue_wa™_timeout
(
ns
->
queue
,imeout);

3806 ià(
timeout
 <= 0)

3809 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3810 
	}
}

3811 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze_timeout
);

3813 
	$nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
)

3815 
nvme_ns
 *
ns
;

3817 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3818 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3819 
	`blk_mq_ä“ze_queue_wa™
(
ns
->
queue
);

3820 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3821 
	}
}

3822 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze
);

3824 
	$nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
)

3826 
nvme_ns
 *
ns
;

3828 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3829 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3830 
	`blk_ä“ze_queue_¡¬t
(
ns
->
queue
);

3831 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3832 
	}
}

3833 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ä“ze
);

3835 
	$nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
)

3837 
nvme_ns
 *
ns
;

3839 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3840 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3841 
	`blk_mq_qu›sû_queue
(
ns
->
queue
);

3842 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3843 
	}
}

3844 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_queues
);

3846 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

3848 
nvme_ns
 *
ns
;

3850 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3851 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

3852 
	`blk_mq_unqu›sû_queue
(
ns
->
queue
);

3853 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3854 
	}
}

3855 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_queues
);

3857 
__š™
 
	$nvme_cÜe_š™
()

3859 
»suÉ
;

3861 
nvme_wq
 = 
	`®loc_wÜkqueue
("nvme-wq",

3862 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

3863 ià(!
nvme_wq
)

3864  -
ENOMEM
;

3866 
»suÉ
 = 
	`__»gi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme",

3867 &
nvme_dev_fİs
);

3868 ià(
»suÉ
 < 0)

3869 
de¡roy_wq
;

3870 ià(
»suÉ
 > 0)

3871 
nvme_ch¬_majÜ
 = 
»suÉ
;

3873 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

3874 ià(
	`IS_ERR
(
nvme_şass
)) {

3875 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

3876 
uÄegi¡”_chrdev
;

3879 
»suÉ
 = 
	`aio_£rviû_š™
();

3880 ià(
»suÉ
)

3881 
uÄegi¡”_chrdev
;

3883 
»suÉ
 = 
	`aio_wÜk”_š™
();

3884 ià(
»suÉ
)

3885 
uÄegi¡”_chrdev
;

3889 
uÄegi¡”_chrdev
:

3890 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

3891 
de¡roy_wq
:

3892 
	`de¡roy_wÜkqueue
(
nvme_wq
);

3893  
»suÉ
;

3894 
	}
}

3896 
	$nvme_cÜe_ex™
()

3898 
	`şass_de¡roy
(
nvme_şass
);

3899 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

3900 
	`de¡roy_wÜkqueue
(
nvme_wq
);

3902 
	`aio_wÜk”_ex™
();

3903 
	`aio_£rviû_ex™
();

3905 
	}
}

3907 
MODULE_LICENSE
("GPL");

3908 
MODULE_VERSION
("1.0");

3909 
moduË_š™
(
nvme_cÜe_š™
);

3910 
moduË_ex™
(
nvme_cÜe_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/fabrics.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/š™.h
>

16 
	~<lšux/miscdeviû.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/mu‹x.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~"nvme.h
"

22 
	~"çbrics.h
"

24 
LIST_HEAD
(
nvmf_Œª¥Üts
);

25 
DEFINE_MUTEX
(
nvmf_Œª¥Üts_mu‹x
);

27 
LIST_HEAD
(
nvmf_ho¡s
);

28 
DEFINE_MUTEX
(
nvmf_ho¡s_mu‹x
);

30 
nvmf_ho¡
 *
	gnvmf_deçuÉ_ho¡
;

32 
nvmf_ho¡
 *
	$__nvmf_ho¡_fšd
(cÚ¡ *
ho¡nqn
)

34 
nvmf_ho¡
 *
ho¡
;

36 
	`li¡_fÜ_—ch_’Œy
(
ho¡
, &
nvmf_ho¡s
, 
li¡
) {

37 ià(!
	`¡rcmp
(
ho¡
->
nqn
, 
ho¡nqn
))

38  
ho¡
;

41  
NULL
;

42 
	}
}

44 
nvmf_ho¡
 *
	$nvmf_ho¡_add
(cÚ¡ *
ho¡nqn
)

46 
nvmf_ho¡
 *
ho¡
;

48 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

49 
ho¡
 = 
	`__nvmf_ho¡_fšd
(
ho¡nqn
);

50 ià(
ho¡
) {

51 
	`k»f_g‘
(&
ho¡
->
»f
);

52 
out_uÆock
;

55 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

56 ià(!
ho¡
)

57 
out_uÆock
;

59 
	`k»f_š™
(&
ho¡
->
»f
);

60 
	`memıy
(
ho¡
->
nqn
, 
ho¡nqn
, 
NVMF_NQN_SIZE
);

62 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

63 
out_uÆock
:

64 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

65  
ho¡
;

66 
	}
}

68 
nvmf_ho¡
 *
	$nvmf_ho¡_deçuÉ
()

70 
nvmf_ho¡
 *
ho¡
;

72 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

73 ià(!
ho¡
)

74  
NULL
;

76 
	`k»f_š™
(&
ho¡
->
»f
);

77 
	`¢´štf
(
ho¡
->
nqn
, 
NVMF_NQN_SIZE
,

78 "nqn.2014-08.Üg.nvmex´ess:uuid:%pUb", &
ho¡
->
id
);

80 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

81 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

82 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

84  
ho¡
;

85 
	}
}

87 
	$nvmf_ho¡_de¡roy
(
k»f
 *
»f
)

89 
nvmf_ho¡
 *
ho¡
 = 
	`cÚš”_of
(
»f
, nvmf_host,„ef);

91 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

92 
	`li¡_d–
(&
ho¡
->
li¡
);

93 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

95 
	`kä“
(
ho¡
);

96 
	}
}

98 
	$nvmf_ho¡_put
(
nvmf_ho¡
 *
ho¡
)

100 ià(
ho¡
)

101 
	`k»f_put
(&
ho¡
->
»f
, 
nvmf_ho¡_de¡roy
);

102 
	}
}

110 
	$nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
)

112 
Ën
 = 0;

114 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRADDR
)

115 
Ën
 +ğ
	`¢´štf
(
buf
, 
size
, "Œaddr=%s", 
ù¾
->
İts
->
Œaddr
);

116 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRSVCID
)

117 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%strsvcid=%s",

118 (
Ën
è? "," : "", 
ù¾
->
İts
->
Œsvcid
);

119 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

120 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%shost_traddr=%s",

121 (
Ën
è? "," : "", 
ù¾
->
İts
->
ho¡_Œaddr
);

122 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "\n");

124  
Ën
;

125 
	}
}

126 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_add»ss
);

149 
	$nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

151 
nvme_commªd
 
cmd
;

152 
nvme_»suÉ
 
»s
;

153 
»t
;

155 
	`mem£t
(&
cmd
, 0, (cmd));

156 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

157 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

158 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

160 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

161 
NVME_QID_ANY
, 0, 0);

163 ià(
»t
 >= 0)

164 *
v®
 = 
	`Ë64_to_ıu
(
»s
.
u64
);

165 ià(
	`uÆik–y
(
»t
 != 0))

166 
	`dev_”r
(
ù¾
->
deviû
,

168 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

170  
»t
;

171 
	}
}

172 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad32
);

195 
	$nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

197 
nvme_commªd
 
cmd
;

198 
nvme_»suÉ
 
»s
;

199 
»t
;

201 
	`mem£t
(&
cmd
, 0, (cmd));

202 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

203 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

204 
cmd
.
´İ_g‘
.
©Œib
 = 1;

205 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

207 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

208 
NVME_QID_ANY
, 0, 0);

210 ià(
»t
 >= 0)

211 *
v®
 = 
	`Ë64_to_ıu
(
»s
.
u64
);

212 ià(
	`uÆik–y
(
»t
 != 0))

213 
	`dev_”r
(
ù¾
->
deviû
,

215 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

216  
»t
;

217 
	}
}

218 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad64
);

241 
	$nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

243 
nvme_commªd
 
cmd
;

244 
»t
;

246 
	`mem£t
(&
cmd
, 0, (cmd));

247 
cmd
.
´İ_£t
.
İcode
 = 
nvme_çbrics_commªd
;

248 
cmd
.
´İ_£t
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_£t
;

249 
cmd
.
´İ_£t
.
©Œib
 = 0;

250 
cmd
.
´İ_£t
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

251 
cmd
.
´İ_£t
.
v®ue
 = 
	`ıu_to_Ë64
(
v®
);

253 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, NULL, 0, 0,

254 
NVME_QID_ANY
, 0, 0);

255 ià(
	`uÆik–y
(
»t
))

256 
	`dev_”r
(
ù¾
->
deviû
,

258 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

259  
»t
;

260 
	}
}

261 
EXPORT_SYMBOL_GPL
(
nvmf_»g_wr™e32
);

278 
	$nvmf_log_cÚÃù_”rÜ
(
nvme_ù¾
 *
ù¾
,

279 
”rv®
, 
off£t
, 
nvme_commªd
 *
cmd
,

280 
nvmf_cÚÃù_d©a
 *
d©a
)

282 
”r_sùy³
 = 
”rv®
 & (~
NVME_SC_DNR
);

284 
”r_sùy³
) {

286 (
NVME_SC_CONNECT_INVALID_PARAM
):

287 ià(
off£t
 >> 16) {

288 *
šv_d©a
 = "Connect Invalid Data Parameter";

290 
off£t
 & 0xffff) {

291 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
úid
)):

292 
	`dev_”r
(
ù¾
->
deviû
,

294 
šv_d©a
, 
d©a
->
úid
);

296 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
ho¡nqn
)):

297 
	`dev_”r
(
ù¾
->
deviû
,

299 
šv_d©a
, 
d©a
->
ho¡nqn
);

301 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
subsy¢qn
)):

302 
	`dev_”r
(
ù¾
->
deviû
,

304 
šv_d©a
, 
d©a
->
subsy¢qn
);

307 
	`dev_”r
(
ù¾
->
deviû
,

309 
šv_d©a
, 
off£t
 & 0xffff);

313 *
šv_sqe
 = "Connect Invalid SQE Parameter";

315 
off£t
) {

316 (
	`off£tof
(
nvmf_cÚÃù_commªd
, 
qid
)):

317 
	`dev_”r
(
ù¾
->
deviû
,

319 
šv_sqe
, 
cmd
->
cÚÃù
.
qid
);

322 
	`dev_”r
(
ù¾
->
deviû
,

324 
šv_sqe
, 
off£t
);

329 
NVME_SC_CONNECT_INVALID_HOST
:

330 
	`dev_”r
(
ù¾
->
deviû
,

332 
d©a
->
subsy¢qn
, d©a->
ho¡nqn
);

335 
NVME_SC_CONNECT_CTRL_BUSY
:

336 
	`dev_”r
(
ù¾
->
deviû
,

340 
NVME_SC_CONNECT_FORMAT
:

341 
	`dev_”r
(
ù¾
->
deviû
,

343 
cmd
->
cÚÃù
.
»cfmt
);

347 
	`dev_”r
(
ù¾
->
deviû
,

349 
”r_sùy³
);

352 
	}
}

374 
	$nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
)

376 
nvme_commªd
 
cmd
;

377 
nvme_»suÉ
 
»s
;

378 
nvmf_cÚÃù_d©a
 *
d©a
;

379 
»t
;

381 
	`mem£t
(&
cmd
, 0, (cmd));

382 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

383 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

384 
cmd
.
cÚÃù
.
qid
 = 0;

385 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
NVME_AQ_DEPTH
 - 1);

391 
cmd
.
cÚÃù
.
k©o
 = 
ù¾
->
İts
->
discov”y_nqn
 ? 0 :

392 
	`ıu_to_Ë32
((
ù¾
->
k©o
 + 
NVME_KATO_GRACE
) * 1000);

394 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

395 ià(!
d©a
)

396  -
ENOMEM
;

398 
	`uuid_cİy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
);

399 
d©a
->
úid
 = 
	`ıu_to_Ë16
(0xffff);

400 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

401 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

403 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
,

404 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

405 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

406 ià(
»t
) {

407 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
»s
.
u32
),

408 &
cmd
, 
d©a
);

409 
out_ä“_d©a
;

412 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
»s
.
u16
);

414 
out_ä“_d©a
:

415 
	`kä“
(
d©a
);

416  
»t
;

417 
	}
}

418 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_admš_queue
);

440 
	$nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
)

442 
nvme_commªd
 
cmd
;

443 
nvmf_cÚÃù_d©a
 *
d©a
;

444 
nvme_»suÉ
 
»s
;

445 
»t
;

447 
	`mem£t
(&
cmd
, 0, (cmd));

448 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

449 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

450 
cmd
.
cÚÃù
.
qid
 = 
	`ıu_to_Ë16
(qid);

451 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
ù¾
->sqsize);

453 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

454 ià(!
d©a
)

455  -
ENOMEM
;

457 
	`uuid_cİy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
);

458 
d©a
->
úid
 = 
	`ıu_to_Ë16
(
ù¾
->cntlid);

459 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

460 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

462 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
cÚÃù_q
, &
cmd
, &
»s
,

463 
d©a
, (*d©a), 0, 
qid
, 1,

464 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

465 ià(
»t
) {

466 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
»s
.
u32
),

467 &
cmd
, 
d©a
);

469 
	`kä“
(
d©a
);

470  
»t
;

471 
	}
}

472 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_io_queue
);

474 
boŞ
 
	$nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
)

476 ià(
ù¾
->
İts
->
max_»cÚÃùs
 != -1 &&

477 
ù¾
->
Ä_»cÚÃùs
 < cŒl->
İts
->
max_»cÚÃùs
)

478  
Œue
;

480  
çl£
;

481 
	}
}

482 
EXPORT_SYMBOL_GPL
(
nvmf_should_»cÚÃù
);

493 
	$nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

495 ià(!
İs
->
ü—‹_ù¾
)

496  -
EINVAL
;

498 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

499 
	`li¡_add_
(&
İs
->
’Œy
, &
nvmf_Œª¥Üts
);

500 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

503 
	}
}

504 
EXPORT_SYMBOL_GPL
(
nvmf_»gi¡”_Œª¥Üt
);

515 
	$nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

517 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

518 
	`li¡_d–
(&
İs
->
’Œy
);

519 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

520 
	}
}

521 
EXPORT_SYMBOL_GPL
(
nvmf_uÄegi¡”_Œª¥Üt
);

523 
nvmf_Œª¥Üt_İs
 *
	$nvmf_lookup_Œª¥Üt
(

524 
nvmf_ù¾_İtiÚs
 *
İts
)

526 
nvmf_Œª¥Üt_İs
 *
İs
;

528 
	`lockd•_as£¹_h–d
(&
nvmf_Œª¥Üts_mu‹x
);

530 
	`li¡_fÜ_—ch_’Œy
(
İs
, &
nvmf_Œª¥Üts
, 
’Œy
) {

531 ià(
	`¡rcmp
(
İs
->
Çme
, 
İts
->
Œª¥Üt
) == 0)

532  
İs
;

535  
NULL
;

536 
	}
}

538 cÚ¡ 
m©ch_bË_t
 
	gİt_tok’s
 = {

539 { 
NVMF_OPT_TRANSPORT
, "transport=%s" },

540 { 
NVMF_OPT_TRADDR
, "traddr=%s" },

541 { 
NVMF_OPT_TRSVCID
, "trsvcid=%s" },

542 { 
NVMF_OPT_NQN
, "nqn=%s" },

543 { 
NVMF_OPT_QUEUE_SIZE
, "queue_size=%d" },

544 { 
NVMF_OPT_NR_IO_QUEUES
, "nr_io_queues=%d" },

545 { 
NVMF_OPT_RECONNECT_DELAY
, "reconnect_delay=%d" },

546 { 
NVMF_OPT_CTRL_LOSS_TMO
, "ctrl_loss_tmo=%d" },

547 { 
NVMF_OPT_KATO
, "keep_alive_tmo=%d" },

548 { 
NVMF_OPT_HOSTNQN
, "hostnqn=%s" },

549 { 
NVMF_OPT_HOST_TRADDR
, "host_traddr=%s" },

550 { 
NVMF_OPT_HOST_ID
, "hostid=%s" },

551 { 
NVMF_OPT_ERR
, 
NULL
 }

554 
	$nvmf_·r£_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
,

555 cÚ¡ *
buf
)

557 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

558 *
İtiÚs
, *
o
, *
p
;

559 
tok’
, 
»t
 = 0;

560 
size_t
 
nqÆ’
 = 0;

561 
ù¾_loss_tmo
 = 
NVMF_DEF_CTRL_LOSS_TMO
;

562 
uuid_t
 
ho¡id
;

565 
İts
->
queue_size
 = 
NVMF_DEF_QUEUE_SIZE
;

566 
İts
->
Ä_io_queues
 = 
	`num_Úlše_ıus
();

567 
İts
->
»cÚÃù_d–ay
 = 
NVMF_DEF_RECONNECT_DELAY
;

569 
İtiÚs
 = 
o
 = 
	`k¡rdup
(
buf
, 
GFP_KERNEL
);

570 ià(!
İtiÚs
)

571  -
ENOMEM
;

573 
	`uuid_g’
(&
ho¡id
);

575 (
p
 = 
	`¡r£p
(&
o
, ",\n")è!ğ
NULL
) {

576 ià(!*
p
)

579 
tok’
 = 
	`m©ch_tok’
(
p
, 
İt_tok’s
, 
¬gs
);

580 
İts
->
mask
 |ğ
tok’
;

581 
tok’
) {

582 
NVMF_OPT_TRANSPORT
:

583 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

584 ià(!
p
) {

585 
»t
 = -
ENOMEM
;

586 
out
;

588 
İts
->
Œª¥Üt
 = 
p
;

590 
NVMF_OPT_NQN
:

591 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

592 ià(!
p
) {

593 
»t
 = -
ENOMEM
;

594 
out
;

596 
İts
->
subsy¢qn
 = 
p
;

597 
nqÆ’
 = 
	`¡¾’
(
İts
->
subsy¢qn
);

598 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

599 
	`´_”r
("%s‚eedso be < %d bytes\n",

600 
İts
->
subsy¢qn
, 
NVMF_NQN_SIZE
);

601 
»t
 = -
EINVAL
;

602 
out
;

604 
İts
->
discov”y_nqn
 =

605 !(
	`¡rcmp
(
İts
->
subsy¢qn
,

606 
NVME_DISC_SUBSYS_NAME
));

607 ià(
İts
->
discov”y_nqn
)

608 
İts
->
Ä_io_queues
 = 0;

610 
NVMF_OPT_TRADDR
:

611 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

612 ià(!
p
) {

613 
»t
 = -
ENOMEM
;

614 
out
;

616 
İts
->
Œaddr
 = 
p
;

618 
NVMF_OPT_TRSVCID
:

619 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

620 ià(!
p
) {

621 
»t
 = -
ENOMEM
;

622 
out
;

624 
İts
->
Œsvcid
 = 
p
;

626 
NVMF_OPT_QUEUE_SIZE
:

627 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

628 
»t
 = -
EINVAL
;

629 
out
;

631 ià(
tok’
 < 
NVMF_MIN_QUEUE_SIZE
 ||

632 
tok’
 > 
NVMF_MAX_QUEUE_SIZE
) {

633 
	`´_”r
("Inv®id queue_siz%d\n", 
tok’
);

634 
»t
 = -
EINVAL
;

635 
out
;

637 
İts
->
queue_size
 = 
tok’
;

639 
NVMF_OPT_NR_IO_QUEUES
:

640 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

641 
»t
 = -
EINVAL
;

642 
out
;

644 ià(
tok’
 <= 0) {

645 
	`´_”r
("Inv®id‚umb” oàIOQ %d\n", 
tok’
);

646 
»t
 = -
EINVAL
;

647 
out
;

649 
İts
->
Ä_io_queues
 = 
	`mš_t
(,

650 
	`num_Úlše_ıus
(), 
tok’
);

652 
NVMF_OPT_KATO
:

653 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

654 
»t
 = -
EINVAL
;

655 
out
;

658 ià(
İts
->
discov”y_nqn
) {

659 
	`´_”r
("Discovery controllers cannot‡ccept keep_alive_tmo != 0\n");

660 
»t
 = -
EINVAL
;

661 
out
;

664 ià(
tok’
 < 0) {

665 
	`´_”r
("Inv®id k“p_®ive_tmØ%d\n", 
tok’
);

666 
»t
 = -
EINVAL
;

667 
out
;

668 } ià(
tok’
 == 0) {

670 
	`´_w¬n
("keep_alive_tmo 0 won'tƒxecute keep‡lives!!!\n");

672 
İts
->
k©o
 = 
tok’
;

674 
NVMF_OPT_CTRL_LOSS_TMO
:

675 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

676 
»t
 = -
EINVAL
;

677 
out
;

680 ià(
tok’
 < 0)

681 
	`´_w¬n
("ctrl_loss_tmo < 0 will„econnect forever\n");

682 
ù¾_loss_tmo
 = 
tok’
;

684 
NVMF_OPT_HOSTNQN
:

685 ià(
İts
->
ho¡
) {

686 
	`´_”r
("hostnqn‡lready user-assigned: %s\n",

687 
İts
->
ho¡
->
nqn
);

688 
»t
 = -
EADDRINUSE
;

689 
out
;

691 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

692 ià(!
p
) {

693 
»t
 = -
ENOMEM
;

694 
out
;

696 
nqÆ’
 = 
	`¡¾’
(
p
);

697 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

698 
	`´_”r
("%s‚eedso be < %d bytes\n",

699 
p
, 
NVMF_NQN_SIZE
);

700 
	`kä“
(
p
);

701 
»t
 = -
EINVAL
;

702 
out
;

704 
İts
->
ho¡
 = 
	`nvmf_ho¡_add
(
p
);

705 
	`kä“
(
p
);

706 ià(!
İts
->
ho¡
) {

707 
»t
 = -
ENOMEM
;

708 
out
;

711 
NVMF_OPT_RECONNECT_DELAY
:

712 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

713 
»t
 = -
EINVAL
;

714 
out
;

716 ià(
tok’
 <= 0) {

717 
	`´_”r
("Inv®id„ecÚÃù_d–ay %d\n", 
tok’
);

718 
»t
 = -
EINVAL
;

719 
out
;

721 
İts
->
»cÚÃù_d–ay
 = 
tok’
;

723 
NVMF_OPT_HOST_TRADDR
:

724 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

725 ià(!
p
) {

726 
»t
 = -
ENOMEM
;

727 
out
;

729 
İts
->
ho¡_Œaddr
 = 
p
;

731 
NVMF_OPT_HOST_ID
:

732 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

733 ià(!
p
) {

734 
»t
 = -
ENOMEM
;

735 
out
;

737 ià(
	`uuid_·r£
(
p
, &
ho¡id
)) {

738 
»t
 = -
EINVAL
;

739 
out
;

743 
	`´_w¬n
("unknown…arameter or missing value '%s' in ctrl creation„equest\n",

744 
p
);

745 
»t
 = -
EINVAL
;

746 
out
;

750 ià(
ù¾_loss_tmo
 < 0)

751 
İts
->
max_»cÚÃùs
 = -1;

753 
İts
->
max_»cÚÃùs
 = 
	`DIV_ROUND_UP
(
ù¾_loss_tmo
,

754 
İts
->
»cÚÃù_d–ay
);

756 ià(!
İts
->
ho¡
) {

757 
	`k»f_g‘
(&
nvmf_deçuÉ_ho¡
->
»f
);

758 
İts
->
ho¡
 = 
nvmf_deçuÉ_ho¡
;

761 
	`uuid_cİy
(&
İts
->
ho¡
->
id
, &
ho¡id
);

763 
out
:

764 ià(!
İts
->
discov”y_nqn
 && !İts->
k©o
)

765 
İts
->
k©o
 = 
NVME_DEFAULT_KATO
;

766 
	`kä“
(
İtiÚs
);

767  
»t
;

768 
	}
}

770 
	$nvmf_check_»quœed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

771 
»quœed_İts
)

773 ià((
İts
->
mask
 & 
»quœed_İts
) !=„equired_opts) {

774 
i
;

776 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

777 ià((
İt_tok’s
[
i
].
tok’
 & 
»quœed_İts
) &&

778 !(
İt_tok’s
[
i
].
tok’
 & 
İts
->
mask
)) {

779 
	`´_w¬n
("missing…arameter '%s'\n",

780 
İt_tok’s
[
i
].
·‰”n
);

784  -
EINVAL
;

788 
	}
}

790 
	$nvmf_check_®lowed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

791 
®lowed_İts
)

793 ià(
İts
->
mask
 & ~
®lowed_İts
) {

794 
i
;

796 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

797 ià((
İt_tok’s
[
i
].
tok’
 & 
İts
->
mask
) &&

798 (
İt_tok’s
[
i
].
tok’
 & ~
®lowed_İts
)) {

799 
	`´_w¬n
("invalid…arameter '%s'\n",

800 
İt_tok’s
[
i
].
·‰”n
);

804  -
EINVAL
;

808 
	}
}

810 
	$nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
)

812 
	`nvmf_ho¡_put
(
İts
->
ho¡
);

813 
	`kä“
(
İts
->
Œª¥Üt
);

814 
	`kä“
(
İts
->
Œaddr
);

815 
	`kä“
(
İts
->
Œsvcid
);

816 
	`kä“
(
İts
->
subsy¢qn
);

817 
	`kä“
(
İts
->
ho¡_Œaddr
);

818 
	`kä“
(
İts
);

819 
	}
}

820 
EXPORT_SYMBOL_GPL
(
nvmf_ä“_İtiÚs
);

822 
	#NVMF_REQUIRED_OPTS
 (
NVMF_OPT_TRANSPORT
 | 
NVMF_OPT_NQN
)

	)

823 
	#NVMF_ALLOWED_OPTS
 (
NVMF_OPT_QUEUE_SIZE
 | 
NVMF_OPT_NR_IO_QUEUES
 | \

824 
NVMF_OPT_KATO
 | 
NVMF_OPT_HOSTNQN
 | \

825 
NVMF_OPT_HOST_ID
)

	)

827 
nvme_ù¾
 *

828 
	$nvmf_ü—‹_ù¾
(
deviû
 *
dev
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

830 
nvmf_ù¾_İtiÚs
 *
İts
;

831 
nvmf_Œª¥Üt_İs
 *
İs
;

832 
nvme_ù¾
 *
ù¾
;

833 
»t
;

835 
İts
 = 
	`kz®loc
((*İts), 
GFP_KERNEL
);

836 ià(!
İts
)

837  
	`ERR_PTR
(-
ENOMEM
);

839 
»t
 = 
	`nvmf_·r£_İtiÚs
(
İts
, 
buf
);

840 ià(
»t
)

841 
out_ä“_İts
;

848 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
NVMF_REQUIRED_OPTS
);

849 ià(
»t
)

850 
out_ä“_İts
;

851 
İts
->
mask
 &ğ~
NVMF_REQUIRED_OPTS
;

853 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

854 
İs
 = 
	`nvmf_lookup_Œª¥Üt
(
İts
);

855 ià(!
İs
) {

856 
	`´_šfo
("no handler found forransport %s.\n",

857 
İts
->
Œª¥Üt
);

858 
»t
 = -
EINVAL
;

859 
out_uÆock
;

862 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
İs
->
»quœed_İts
);

863 ià(
»t
)

864 
out_uÆock
;

865 
»t
 = 
	`nvmf_check_®lowed_İts
(
İts
, 
NVMF_ALLOWED_OPTS
 |

866 
İs
->
®lowed_İts
 | ops->
»quœed_İts
);

867 ià(
»t
)

868 
out_uÆock
;

870 
ù¾
 = 
İs
->
	`ü—‹_ù¾
(
dev
, 
İts
);

871 ià(
	`IS_ERR
(
ù¾
)) {

872 
»t
 = 
	`PTR_ERR
(
ù¾
);

873 
out_uÆock
;

876 ià(
	`¡rcmp
(
ù¾
->
subnqn
, 
İts
->
subsy¢qn
)) {

877 
	`dev_w¬n
(
ù¾
->
deviû
,

879 
ù¾
->
subnqn
);

880 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

881 
ù¾
->
İs
->
	`d–‘e_ù¾
(ctrl);

882  
	`ERR_PTR
(-
EINVAL
);

885 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

886  
ù¾
;

888 
out_uÆock
:

889 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

890 
out_ä“_İts
:

891 
	`nvmf_ä“_İtiÚs
(
İts
);

892  
	`ERR_PTR
(
»t
);

893 
	}
}

895 
şass
 *
	gnvmf_şass
;

896 
deviû
 *
	gnvmf_deviû
;

897 
DEFINE_MUTEX
(
nvmf_dev_mu‹x
);

899 
ssize_t
 
	$nvmf_dev_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
ubuf
,

900 
size_t
 
couÁ
, 
loff_t
 *
pos
)

902 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

903 
nvme_ù¾
 *
ù¾
;

904 cÚ¡ *
buf
;

905 
»t
 = 0;

907 ià(
couÁ
 > 
PAGE_SIZE
)

908  -
ENOMEM
;

910 
buf
 = 
	`memdup_u£r_nul
(
ubuf
, 
couÁ
);

911 ià(
	`IS_ERR
(
buf
))

912  
	`PTR_ERR
(
buf
);

914 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

915 ià(
£q_fe
->
´iv©e
) {

916 
»t
 = -
EINVAL
;

917 
out_uÆock
;

920 
ù¾
 = 
	`nvmf_ü—‹_ù¾
(
nvmf_deviû
, 
buf
, 
couÁ
);

921 ià(
	`IS_ERR
(
ù¾
)) {

922 
»t
 = 
	`PTR_ERR
(
ù¾
);

923 
out_uÆock
;

926 
£q_fe
->
´iv©e
 = 
ù¾
;

928 
out_uÆock
:

929 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

930 
	`kä“
(
buf
);

931  
»t
 ?„‘ : 
couÁ
;

932 
	}
}

934 
	$nvmf_dev_show
(
£q_fe
 *£q_fe, *
´iv©e
)

936 
nvme_ù¾
 *
ù¾
;

937 
»t
 = 0;

939 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

940 
ù¾
 = 
£q_fe
->
´iv©e
;

941 ià(!
ù¾
) {

942 
»t
 = -
EINVAL
;

943 
out_uÆock
;

946 
	`£q_´štf
(
£q_fe
, "instance=%d,cntlid=%d\n",

947 
ù¾
->
š¡ªû
, cŒl->
úid
);

949 
out_uÆock
:

950 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

951  
»t
;

952 
	}
}

954 
	$nvmf_dev_İ’
(
šode
 *šode, 
fe
 *file)

960 
fe
->
´iv©e_d©a
 = 
NULL
;

961  
	`sšgË_İ’
(
fe
, 
nvmf_dev_show
, 
NULL
);

962 
	}
}

964 
	$nvmf_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

966 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

967 
nvme_ù¾
 *
ù¾
 = 
£q_fe
->
´iv©e
;

969 ià(
ù¾
)

970 
	`nvme_put_ù¾
(
ù¾
);

971  
	`sšgË_»Ëa£
(
šode
, 
fe
);

972 
	}
}

974 cÚ¡ 
fe_İ”©iÚs
 
	gnvmf_dev_fİs
 = {

975 .
owÃr
 = 
THIS_MODULE
,

976 .
	gwr™e
 = 
nvmf_dev_wr™e
,

977 .
	g»ad
 = 
£q_»ad
,

978 .
	gİ’
 = 
nvmf_dev_İ’
,

979 .
	g»Ëa£
 = 
nvmf_dev_»Ëa£
,

982 
miscdeviû
 
	gnvmf_misc
 = {

983 .
mšÜ
 = 
MISC_DYNAMIC_MINOR
,

984 .
	gÇme
 = "nvme-fabrics",

985 .
	gfİs
 = &
nvmf_dev_fİs
,

988 
__š™
 
	$nvmf_š™
()

990 
»t
;

992 
nvmf_deçuÉ_ho¡
 = 
	`nvmf_ho¡_deçuÉ
();

993 ià(!
nvmf_deçuÉ_ho¡
)

994  -
ENOMEM
;

996 
nvmf_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme-fabrics");

997 ià(
	`IS_ERR
(
nvmf_şass
)) {

998 
	`´_”r
("couldn't„egister class‚vme-fabrics\n");

999 
»t
 = 
	`PTR_ERR
(
nvmf_şass
);

1000 
out_ä“_ho¡
;

1003 
nvmf_deviû
 =

1004 
	`deviû_ü—‹
(
nvmf_şass
, 
NULL
, 
	`MKDEV
(0, 0), NULL, "ctl");

1005 ià(
	`IS_ERR
(
nvmf_deviû
)) {

1006 
	`´_”r
("couldn't create‚vme-fabris device!\n");

1007 
»t
 = 
	`PTR_ERR
(
nvmf_deviû
);

1008 
out_de¡roy_şass
;

1011 
»t
 = 
	`misc_»gi¡”
(&
nvmf_misc
);

1012 ià(
»t
) {

1013 
	`´_”r
("couldn'ˆ»gi¡” misødeviû: %d\n", 
»t
);

1014 
out_de¡roy_deviû
;

1019 
out_de¡roy_deviû
:

1020 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

1021 
out_de¡roy_şass
:

1022 
	`şass_de¡roy
(
nvmf_şass
);

1023 
out_ä“_ho¡
:

1024 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1025  
»t
;

1026 
	}
}

1028 
__ex™
 
	$nvmf_ex™
()

1030 
	`misc_d”egi¡”
(&
nvmf_misc
);

1031 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

1032 
	`şass_de¡roy
(
nvmf_şass
);

1033 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1035 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_commªd
) != 64);

1036 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_g‘_commªd
) != 64);

1037 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_£t_commªd
) != 64);

1038 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_d©a
) != 1024);

1039 
	}
}

1041 
MODULE_LICENSE
("GPL v2");

1043 
moduË_š™
(
nvmf_š™
);

1044 
moduË_ex™
(
nvmf_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/fabrics.h

14 #iâdeà
_NVME_FABRICS_H


15 
	#_NVME_FABRICS_H
 1

	)

17 
	~<lšux/š.h
>

18 
	~<lšux/š‘.h
>

20 
	#NVMF_MIN_QUEUE_SIZE
 16

	)

21 
	#NVMF_MAX_QUEUE_SIZE
 1024

	)

22 
	#NVMF_DEF_QUEUE_SIZE
 128

	)

23 
	#NVMF_DEF_RECONNECT_DELAY
 10

	)

25 
	#NVMF_DEF_CTRL_LOSS_TMO
 600

	)

35 
	snvmf_ho¡
 {

36 
k»f
 
	m»f
;

37 
li¡_h—d
 
	mli¡
;

38 
	mnqn
[
NVMF_NQN_SIZE
];

39 
uuid_t
 
	mid
;

46 
	mNVMF_OPT_ERR
 = 0,

47 
	mNVMF_OPT_TRANSPORT
 = 1 << 0,

48 
	mNVMF_OPT_NQN
 = 1 << 1,

49 
	mNVMF_OPT_TRADDR
 = 1 << 2,

50 
	mNVMF_OPT_TRSVCID
 = 1 << 3,

51 
	mNVMF_OPT_QUEUE_SIZE
 = 1 << 4,

52 
	mNVMF_OPT_NR_IO_QUEUES
 = 1 << 5,

53 
	mNVMF_OPT_TL_RETRY_COUNT
 = 1 << 6,

54 
	mNVMF_OPT_KATO
 = 1 << 7,

55 
	mNVMF_OPT_HOSTNQN
 = 1 << 8,

56 
	mNVMF_OPT_RECONNECT_DELAY
 = 1 << 9,

57 
	mNVMF_OPT_HOST_TRADDR
 = 1 << 10,

58 
	mNVMF_OPT_CTRL_LOSS_TMO
 = 1 << 11,

59 
	mNVMF_OPT_HOST_ID
 = 1 << 12,

88 
	snvmf_ù¾_İtiÚs
 {

89 
	mmask
;

90 *
	mŒª¥Üt
;

91 *
	msubsy¢qn
;

92 *
	mŒaddr
;

93 *
	mŒsvcid
;

94 *
	mho¡_Œaddr
;

95 
size_t
 
	mqueue_size
;

96 
	mÄ_io_queues
;

97 
	m»cÚÃù_d–ay
;

98 
boŞ
 
	mdiscov”y_nqn
;

99 
	mk©o
;

100 
nvmf_ho¡
 *
	mho¡
;

101 
	mmax_»cÚÃùs
;

125 
	snvmf_Œª¥Üt_İs
 {

126 
li¡_h—d
 
	m’Œy
;

127 cÚ¡ *
	mÇme
;

128 
	m»quœed_İts
;

129 
	m®lowed_İts
;

130 
	mnvme_ù¾
 *(*
	mü—‹_ù¾
)(
deviû
 *
	mdev
,

131 
nvmf_ù¾_İtiÚs
 *
	mİts
);

134 
nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
);

135 
nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
);

136 
nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
);

137 
nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
);

138 
nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
);

139 
nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

140 
nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

141 
nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
);

142 
nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
);

143 
boŞ
 
nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/fc.c

17 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

18 
	~<lšux/moduË.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<u­i/scsi/fc/fc_fs.h
>

21 
	~<u­i/scsi/fc/fc_–s.h
>

22 
	~<lšux/d–ay.h
>

24 
	~"nvme.h
"

25 
	~"çbrics.h
"

26 
	~<lšux/nvme-fc-driv”.h
>

27 
	~<lšux/nvme-fc.h
>

37 
	#NVME_FC_NR_AEN_COMMANDS
 1

	)

38 
	#NVME_FC_AQ_BLKMQ_DEPTH
 \

39 (
NVME_AQ_DEPTH
 - 
NVME_FC_NR_AEN_COMMANDS
)

	)

40 
	#AEN_CMDID_BASE
 (
NVME_FC_AQ_BLKMQ_DEPTH
 + 1)

	)

42 
	envme_fc_queue_æags
 {

43 
	mNVME_FC_Q_CONNECTED
 = (1 << 0),

46 
	#NVMEFC_QUEUE_DELAY
 3

	)

48 
	snvme_fc_queue
 {

49 
nvme_fc_ù¾
 *
	mù¾
;

50 
deviû
 *
	mdev
;

51 
blk_mq_hw_ùx
 *
	mhùx
;

52 *
	mÎdd_hªdË
;

53 
	mqueue_size
;

54 
size_t
 
	mcmnd_ÿpsuË_Ën
;

55 
u32
 
	mqnum
;

56 
u32
 
	mrqút
;

57 
u32
 
	m£qno
;

59 
u64
 
	mcÚÃùiÚ_id
;

60 
©omic_t
 
	mc¢
;

62 
	mæags
;

63 } 
__®igÃd
((
u64
));

65 
	envme_fcİ_æags
 {

66 
	mFCOP_FLAGS_TERMIO
 = (1 << 0),

67 
	mFCOP_FLAGS_RELEASED
 = (1 << 1),

68 
	mFCOP_FLAGS_COMPLETE
 = (1 << 2),

69 
	mFCOP_FLAGS_AEN
 = (1 << 3),

72 
	snvmefc_ls_»q_İ
 {

73 
nvmefc_ls_»q
 
	mls_»q
;

75 
nvme_fc_½Üt
 *
	m½Üt
;

76 
nvme_fc_queue
 *
	mqueue
;

77 
»que¡
 *
	mrq
;

78 
u32
 
	mæags
;

80 
	mls_”rÜ
;

81 
com¶‘iÚ
 
	mls_dÚe
;

82 
li¡_h—d
 
	ml¤eq_li¡
;

83 
boŞ
 
	m»q_queued
;

86 
	envme_fıİ_¡©e
 {

87 
	mFCPOP_STATE_UNINIT
 = 0,

88 
	mFCPOP_STATE_IDLE
 = 1,

89 
	mFCPOP_STATE_ACTIVE
 = 2,

90 
	mFCPOP_STATE_ABORTED
 = 3,

91 
	mFCPOP_STATE_COMPLETE
 = 4,

94 
	snvme_fc_fı_İ
 {

95 
nvme_»que¡
 
	mÄeq
;

103 
nvmefc_fı_»q
 
	mfı_»q
;

105 
nvme_fc_ù¾
 *
	mù¾
;

106 
nvme_fc_queue
 *
	mqueue
;

107 
»que¡
 *
	mrq
;

109 
©omic_t
 
	m¡©e
;

110 
u32
 
	mæags
;

111 
u32
 
	mrqno
;

112 
u32
 
	mÃÁs
;

114 
nvme_fc_cmd_iu
 
	mcmd_iu
;

115 
nvme_fc_”¥_iu
 
	mr¥_iu
;

118 
	snvme_fc_ÍÜt
 {

119 
nvme_fc_loÿl_pÜt
 
	mloÿÍÜt
;

121 
ida
 
	m’dp_út
;

122 
li¡_h—d
 
	mpÜt_li¡
;

123 
li¡_h—d
 
	m’dp_li¡
;

124 
deviû
 *
	mdev
;

125 
nvme_fc_pÜt_‹m¶©e
 *
	mİs
;

126 
k»f
 
	m»f
;

127 } 
__®igÃd
((
u64
));

129 
	snvme_fc_½Üt
 {

130 
nvme_fc_»mÙe_pÜt
 
	m»mÙ•Üt
;

132 
li¡_h—d
 
	m’dp_li¡
;

133 
li¡_h—d
 
	mù¾_li¡
;

134 
li¡_h—d
 
	mls_»q_li¡
;

135 
deviû
 *
	mdev
;

136 
nvme_fc_ÍÜt
 *
	mÍÜt
;

137 
¥šlock_t
 
	mlock
;

138 
k»f
 
	m»f
;

139 } 
__®igÃd
((
u64
));

141 
	envme_fcù¾_æags
 {

142 
	mFCCTRL_TERMIO
 = (1 << 0),

145 
	snvme_fc_ù¾
 {

146 
¥šlock_t
 
	mlock
;

147 
nvme_fc_queue
 *
	mqueues
;

148 
deviû
 *
	mdev
;

149 
nvme_fc_ÍÜt
 *
	mÍÜt
;

150 
nvme_fc_½Üt
 *
	m½Üt
;

151 
u32
 
	múum
;

153 
u64
 
	massocŸtiÚ_id
;

155 
li¡_h—d
 
	mù¾_li¡
;

157 
blk_mq_g_£t
 
	madmš_g_£t
;

158 
blk_mq_g_£t
 
	mg_£t
;

160 
wÜk_¡ruù
 
	md–‘e_wÜk
;

161 
d–ayed_wÜk
 
	mcÚÃù_wÜk
;

163 
k»f
 
	m»f
;

164 
u32
 
	mæags
;

165 
u32
 
	mioút
;

166 
wa™_queue_h—d_t
 
	mißbÜt_wa™
;

168 
nvme_fc_fı_İ
 
	m«n_İs
[
NVME_FC_NR_AEN_COMMANDS
];

170 
nvme_ù¾
 
	mù¾
;

173 
šlše
 
nvme_fc_ù¾
 *

174 
	$to_fc_ù¾
(
nvme_ù¾
 *
ù¾
)

176  
	`cÚš”_of
(
ù¾
, 
nvme_fc_ù¾
, ctrl);

177 
	}
}

179 
šlše
 
nvme_fc_ÍÜt
 *

180 
	$loÿÍÜt_to_ÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

182  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_ÍÜt
, 
loÿÍÜt
);

183 
	}
}

185 
šlše
 
nvme_fc_½Üt
 *

186 
	$»mÙ•Üt_to_½Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

188  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_½Üt
, 
»mÙ•Üt
);

189 
	}
}

191 
šlše
 
nvmefc_ls_»q_İ
 *

192 
	$ls_»q_to_lsİ
(
nvmefc_ls_»q
 *
l¤eq
)

194  
	`cÚš”_of
(
l¤eq
, 
nvmefc_ls_»q_İ
, 
ls_»q
);

195 
	}
}

197 
šlše
 
nvme_fc_fı_İ
 *

198 
	$fı_»q_to_fı_İ
(
nvmefc_fı_»q
 *
fı»q
)

200  
	`cÚš”_of
(
fı»q
, 
nvme_fc_fı_İ
, 
fı_»q
);

201 
	}
}

208 
DEFINE_SPINLOCK
(
nvme_fc_lock
);

210 
LIST_HEAD
(
nvme_fc_ÍÜt_li¡
);

211 
DEFINE_IDA
(
nvme_fc_loÿl_pÜt_út
);

212 
DEFINE_IDA
(
nvme_fc_ù¾_út
);

219 
__nvme_fc_d–_ù¾
(
nvme_fc_ù¾
 *);

220 
__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *,

221 
nvme_fc_queue
 *, );

242 
	$nvme_fc_»gi¡”_loÿÍÜt
(
nvme_fc_pÜt_šfo
 *
pšfo
,

243 
nvme_fc_pÜt_‹m¶©e
 *
‹m¶©e
,

244 
deviû
 *
dev
,

245 
nvme_fc_loÿl_pÜt
 **
pÜŒ
)

247 
nvme_fc_ÍÜt
 *
Ãw»c
;

248 
æags
;

249 
»t
, 
idx
;

251 ià(!
‹m¶©e
->
loÿÍÜt_d–‘e
 || !‹m¶©e->
»mÙ•Üt_d–‘e
 ||

252 !
‹m¶©e
->
ls_»q
 || !‹m¶©e->
fı_io
 ||

253 !
‹m¶©e
->
ls_abÜt
 || !‹m¶©e->
fı_abÜt
 ||

254 !
‹m¶©e
->
max_hw_queues
 || !‹m¶©e->
max_sgl_£gm’ts
 ||

255 !
‹m¶©e
->
max_dif_sgl_£gm’ts
 || !‹m¶©e->
dma_bound¬y
) {

256 
»t
 = -
EINVAL
;

257 
out_»gho¡_çed
;

260 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
‹m¶©e
->
loÿl_´iv_sz
),

261 
GFP_KERNEL
);

262 ià(!
Ãw»c
) {

263 
»t
 = -
ENOMEM
;

264 
out_»gho¡_çed
;

267 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_loÿl_pÜt_út
, 0, 0, 
GFP_KERNEL
);

268 ià(
idx
 < 0) {

269 
»t
 = -
ENOSPC
;

270 
out_ç_kä“
;

273 ià(!
	`g‘_deviû
(
dev
) && dev) {

274 
»t
 = -
ENODEV
;

275 
out_ida_put
;

278 
	`INIT_LIST_HEAD
(&
Ãw»c
->
pÜt_li¡
);

279 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

280 
	`k»f_š™
(&
Ãw»c
->
»f
);

281 
Ãw»c
->
İs
 = 
‹m¶©e
;

282 
Ãw»c
->
dev
 = dev;

283 
	`ida_š™
(&
Ãw»c
->
’dp_út
);

284 
Ãw»c
->
loÿÍÜt
.
´iv©e
 = &newrec[1];

285 
Ãw»c
->
loÿÍÜt
.
node_Çme
 = 
pšfo
->node_name;

286 
Ãw»c
->
loÿÍÜt
.
pÜt_Çme
 = 
pšfo
->port_name;

287 
Ãw»c
->
loÿÍÜt
.
pÜt_rŞe
 = 
pšfo
->port_role;

288 
Ãw»c
->
loÿÍÜt
.
pÜt_id
 = 
pšfo
->port_id;

289 
Ãw»c
->
loÿÍÜt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

290 
Ãw»c
->
loÿÍÜt
.
pÜt_num
 = 
idx
;

292 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

293 
	`li¡_add_
(&
Ãw»c
->
pÜt_li¡
, &
nvme_fc_ÍÜt_li¡
);

294 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

296 ià(
dev
)

297 
	`dma_£t_£g_bound¬y
(
dev
, 
‹m¶©e
->
dma_bound¬y
);

299 *
pÜŒ
 = &
Ãw»c
->
loÿÍÜt
;

302 
out_ida_put
:

303 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
idx
);

304 
out_ç_kä“
:

305 
	`kä“
(
Ãw»c
);

306 
out_»gho¡_çed
:

307 *
pÜŒ
 = 
NULL
;

309  
»t
;

310 
	}
}

311 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_loÿÍÜt
);

314 
	$nvme_fc_ä“_ÍÜt
(
k»f
 *
»f
)

316 
nvme_fc_ÍÜt
 *
ÍÜt
 =

317 
	`cÚš”_of
(
»f
, 
nvme_fc_ÍÜt
,„ef);

318 
æags
;

320 
	`WARN_ON
(
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
);

321 
	`WARN_ON
(!
	`li¡_em±y
(&
ÍÜt
->
’dp_li¡
));

324 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

325 
	`li¡_d–
(&
ÍÜt
->
pÜt_li¡
);

326 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

329 
ÍÜt
->
İs
->
	`loÿÍÜt_d–‘e
(&ÍÜt->
loÿÍÜt
);

331 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
ÍÜt
->
loÿÍÜt
.
pÜt_num
);

332 
	`ida_de¡roy
(&
ÍÜt
->
’dp_út
);

334 
	`put_deviû
(
ÍÜt
->
dev
);

336 
	`kä“
(
ÍÜt
);

337 
	}
}

340 
	$nvme_fc_ÍÜt_put
(
nvme_fc_ÍÜt
 *
ÍÜt
)

342 
	`k»f_put
(&
ÍÜt
->
»f
, 
nvme_fc_ä“_ÍÜt
);

343 
	}
}

346 
	$nvme_fc_ÍÜt_g‘
(
nvme_fc_ÍÜt
 *
ÍÜt
)

348  
	`k»f_g‘_uÆess_z”o
(&
ÍÜt
->
»f
);

349 
	}
}

363 
	$nvme_fc_uÄegi¡”_loÿÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

365 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
pÜŒ
);

366 
æags
;

368 ià(!
pÜŒ
)

369  -
EINVAL
;

371 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

373 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

374 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

375  -
EINVAL
;

377 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

379 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

381 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

384 
	}
}

385 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_loÿÍÜt
);

404 
	$nvme_fc_»gi¡”_»mÙ•Üt
(
nvme_fc_loÿl_pÜt
 *
loÿÍÜt
,

405 
nvme_fc_pÜt_šfo
 *
pšfo
,

406 
nvme_fc_»mÙe_pÜt
 **
pÜŒ
)

408 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
loÿÍÜt
);

409 
nvme_fc_½Üt
 *
Ãw»c
;

410 
æags
;

411 
»t
, 
idx
;

413 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
ÍÜt
->
İs
->
»mÙe_´iv_sz
),

414 
GFP_KERNEL
);

415 ià(!
Ãw»c
) {

416 
»t
 = -
ENOMEM
;

417 
out_»gho¡_çed
;

420 ià(!
	`nvme_fc_ÍÜt_g‘
(
ÍÜt
)) {

421 
»t
 = -
ESHUTDOWN
;

422 
out_kä“_½Üt
;

425 
idx
 = 
	`ida_sim¶e_g‘
(&
ÍÜt
->
’dp_út
, 0, 0, 
GFP_KERNEL
);

426 ià(
idx
 < 0) {

427 
»t
 = -
ENOSPC
;

428 
out_ÍÜt_put
;

431 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

432 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ù¾_li¡
);

433 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ls_»q_li¡
);

434 
	`k»f_š™
(&
Ãw»c
->
»f
);

435 
	`¥š_lock_š™
(&
Ãw»c
->
lock
);

436 
Ãw»c
->
»mÙ•Üt
.
loÿÍÜt
 = &
ÍÜt
->localport;

437 
Ãw»c
->
dev
 = 
ÍÜt
->dev;

438 
Ãw»c
->
ÍÜt
 =†port;

439 
Ãw»c
->
»mÙ•Üt
.
´iv©e
 = &newrec[1];

440 
Ãw»c
->
»mÙ•Üt
.
pÜt_rŞe
 = 
pšfo
->port_role;

441 
Ãw»c
->
»mÙ•Üt
.
node_Çme
 = 
pšfo
->node_name;

442 
Ãw»c
->
»mÙ•Üt
.
pÜt_Çme
 = 
pšfo
->port_name;

443 
Ãw»c
->
»mÙ•Üt
.
pÜt_id
 = 
pšfo
->port_id;

444 
Ãw»c
->
»mÙ•Üt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

445 
Ãw»c
->
»mÙ•Üt
.
pÜt_num
 = 
idx
;

447 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

448 
	`li¡_add_
(&
Ãw»c
->
’dp_li¡
, &
ÍÜt
->endp_list);

449 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

451 *
pÜŒ
 = &
Ãw»c
->
»mÙ•Üt
;

454 
out_ÍÜt_put
:

455 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

456 
out_kä“_½Üt
:

457 
	`kä“
(
Ãw»c
);

458 
out_»gho¡_çed
:

459 *
pÜŒ
 = 
NULL
;

460  
»t
;

461 
	}
}

462 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_»mÙ•Üt
);

465 
	$nvme_fc_ä“_½Üt
(
k»f
 *
»f
)

467 
nvme_fc_½Üt
 *
½Üt
 =

468 
	`cÚš”_of
(
»f
, 
nvme_fc_½Üt
,„ef);

469 
nvme_fc_ÍÜt
 *
ÍÜt
 =

470 
	`loÿÍÜt_to_ÍÜt
(
½Üt
->
»mÙ•Üt
.
loÿÍÜt
);

471 
æags
;

473 
	`WARN_ON
(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
);

474 
	`WARN_ON
(!
	`li¡_em±y
(&
½Üt
->
ù¾_li¡
));

477 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

478 
	`li¡_d–
(&
½Üt
->
’dp_li¡
);

479 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

482 
ÍÜt
->
İs
->
	`»mÙ•Üt_d–‘e
(&
½Üt
->
»mÙ•Üt
);

484 
	`ida_sim¶e_»move
(&
ÍÜt
->
’dp_út
, 
½Üt
->
»mÙ•Üt
.
pÜt_num
);

486 
	`kä“
(
½Üt
);

488 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

489 
	}
}

492 
	$nvme_fc_½Üt_put
(
nvme_fc_½Üt
 *
½Üt
)

494 
	`k»f_put
(&
½Üt
->
»f
, 
nvme_fc_ä“_½Üt
);

495 
	}
}

498 
	$nvme_fc_½Üt_g‘
(
nvme_fc_½Üt
 *
½Üt
)

500  
	`k»f_g‘_uÆess_z”o
(&
½Üt
->
»f
);

501 
	}
}

504 
	$nvme_fc_abÜt_lsİs
(
nvme_fc_½Üt
 *
½Üt
)

506 
nvmefc_ls_»q_İ
 *
lsİ
;

507 
æags
;

509 
»¡¬t
:

510 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

512 
	`li¡_fÜ_—ch_’Œy
(
lsİ
, &
½Üt
->
ls_»q_li¡
, 
l¤eq_li¡
) {

513 ià(!(
lsİ
->
æags
 & 
FCOP_FLAGS_TERMIO
)) {

514 
lsİ
->
æags
 |ğ
FCOP_FLAGS_TERMIO
;

515 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

516 
½Üt
->
ÍÜt
->
İs
->
	`ls_abÜt
(&½Üt->ÍÜt->
loÿÍÜt
,

517 &
½Üt
->
»mÙ•Üt
,

518 &
lsİ
->
ls_»q
);

519 
»¡¬t
;

522 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

525 
	}
}

539 
	$nvme_fc_uÄegi¡”_»mÙ•Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

541 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
pÜŒ
);

542 
nvme_fc_ù¾
 *
ù¾
;

543 
æags
;

545 ià(!
pÜŒ
)

546  -
EINVAL
;

548 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

550 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

551 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

552  -
EINVAL
;

554 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

557 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list)

558 
	`__nvme_fc_d–_ù¾
(
ù¾
);

560 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

562 
	`nvme_fc_abÜt_lsİs
(
½Üt
);

564 
	`nvme_fc_½Üt_put
(
½Üt
);

566 
	}
}

567 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_»mÙ•Üt
);

588 
šlše
 
dma_addr_t


589 
	$fc_dma_m­_sšgË
(
deviû
 *
dev
, *
±r
, 
size_t
 
size
,

590 
dma_d©a_dœeùiÚ
 
dœ
)

592  
dev
 ? 
	`dma_m­_sšgË
(dev, 
±r
, 
size
, 
dœ
è: (
dma_addr_t
)0L;

593 
	}
}

595 
šlše
 

596 
	$fc_dma_m­pšg_”rÜ
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
)

598  
dev
 ? 
	`dma_m­pšg_”rÜ
(dev, 
dma_addr
) : 0;

599 
	}
}

601 
šlše
 

602 
	$fc_dma_unm­_sšgË
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

603 
dma_d©a_dœeùiÚ
 
dœ
)

605 ià(
dev
)

606 
	`dma_unm­_sšgË
(
dev
, 
addr
, 
size
, 
dœ
);

607 
	}
}

609 
šlše
 

610 
	$fc_dma_sync_sšgË_fÜ_ıu
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

611 
dma_d©a_dœeùiÚ
 
dœ
)

613 ià(
dev
)

614 
	`dma_sync_sšgË_fÜ_ıu
(
dev
, 
addr
, 
size
, 
dœ
);

615 
	}
}

617 
šlše
 

618 
	$fc_dma_sync_sšgË_fÜ_deviû
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

619 
dma_d©a_dœeùiÚ
 
dœ
)

621 ià(
dev
)

622 
	`dma_sync_sšgË_fÜ_deviû
(
dev
, 
addr
, 
size
, 
dœ
);

623 
	}
}

627 
	$fc_m­_sg
(
sÿ‰”li¡
 *
sg
, 
ÃÁs
)

629 
sÿ‰”li¡
 *
s
;

630 
i
;

632 
	`WARN_ON
(
ÃÁs
 =ğ0 || 
sg
[0].
Ëngth
 == 0);

634 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

635 
s
->
dma_add»ss
 = 0L;

636 #ifdeà
CONFIG_NEED_SG_DMA_LENGTH


637 
s
->
dma_Ëngth
 = s->
Ëngth
;

640  
ÃÁs
;

641 
	}
}

643 
šlše
 

644 
	$fc_dma_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

645 
dma_d©a_dœeùiÚ
 
dœ
)

647  
dev
 ? 
	`dma_m­_sg
(dev, 
sg
, 
ÃÁs
, 
dœ
è: 
	`fc_m­_sg
(sg,‚ents);

648 
	}
}

650 
šlše
 

651 
	$fc_dma_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

652 
dma_d©a_dœeùiÚ
 
dœ
)

654 ià(
dev
)

655 
	`dma_unm­_sg
(
dev
, 
sg
, 
ÃÁs
, 
dœ
);

656 
	}
}

661 
nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *);

662 
nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *);

666 
	$__nvme_fc_fšish_ls_»q
(
nvmefc_ls_»q_İ
 *
lsİ
)

668 
nvme_fc_½Üt
 *
½Üt
 = 
lsİ
->rport;

669 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

670 
æags
;

672 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

674 ià(!
lsİ
->
»q_queued
) {

675 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

679 
	`li¡_d–
(&
lsİ
->
l¤eq_li¡
);

681 
lsİ
->
»q_queued
 = 
çl£
;

683 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

685 
	`fc_dma_unm­_sšgË
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
,

686 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

687 
DMA_BIDIRECTIONAL
);

689 
	`nvme_fc_½Üt_put
(
½Üt
);

690 
	}
}

693 
	$__nvme_fc_£nd_ls_»q
(
nvme_fc_½Üt
 *
½Üt
,

694 
nvmefc_ls_»q_İ
 *
lsİ
,

695 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

697 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

698 
æags
;

699 
»t
 = 0;

701 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
)

702  -
ECONNREFUSED
;

704 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

705  -
ESHUTDOWN
;

707 
l¤eq
->
dÚe
 = done;

708 
lsİ
->
½Üt
 =„port;

709 
lsİ
->
»q_queued
 = 
çl£
;

710 
	`INIT_LIST_HEAD
(&
lsİ
->
l¤eq_li¡
);

711 
	`š™_com¶‘iÚ
(&
lsİ
->
ls_dÚe
);

713 
l¤eq
->
rq¡dma
 = 
	`fc_dma_m­_sšgË
(
½Üt
->
dev
,†¤eq->
rq¡addr
,

714 
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
,

715 
DMA_BIDIRECTIONAL
);

716 ià(
	`fc_dma_m­pšg_”rÜ
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
)) {

717 
»t
 = -
EFAULT
;

718 
out_puŒpÜt
;

720 
l¤eq
->
r¥dma
 =†¤eq->
rq¡dma
 +†¤eq->
rq¡Ën
;

722 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

724 
	`li¡_add_
(&
lsİ
->
l¤eq_li¡
, &
½Üt
->
ls_»q_li¡
);

726 
lsİ
->
»q_queued
 = 
Œue
;

728 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

730 
»t
 = 
½Üt
->
ÍÜt
->
İs
->
	`ls_»q
(&½Üt->ÍÜt->
loÿÍÜt
,

731 &
½Üt
->
»mÙ•Üt
, 
l¤eq
);

732 ià(
»t
)

733 
out_uÆšk
;

737 
out_uÆšk
:

738 
lsİ
->
ls_”rÜ
 = 
»t
;

739 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

740 
lsİ
->
»q_queued
 = 
çl£
;

741 
	`li¡_d–
(&
lsİ
->
l¤eq_li¡
);

742 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

743 
	`fc_dma_unm­_sšgË
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
,

744 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

745 
DMA_BIDIRECTIONAL
);

746 
out_puŒpÜt
:

747 
	`nvme_fc_½Üt_put
(
½Üt
);

749  
»t
;

750 
	}
}

753 
	$nvme_fc_£nd_ls_»q_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

755 
nvmefc_ls_»q_İ
 *
lsİ
 = 
	`ls_»q_to_lsİ
(
l¤eq
);

757 
lsİ
->
ls_”rÜ
 = 
¡©us
;

758 
	`com¶‘e
(&
lsİ
->
ls_dÚe
);

759 
	}
}

762 
	$nvme_fc_£nd_ls_»q
(
nvme_fc_½Üt
 *
½Üt
, 
nvmefc_ls_»q_İ
 *
lsİ
)

764 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

765 
fúvme_ls_rjt
 *
rjt
 = 
l¤eq
->
r¥addr
;

766 
»t
;

768 
»t
 = 
	`__nvme_fc_£nd_ls_»q
(
½Üt
, 
lsİ
, 
nvme_fc_£nd_ls_»q_dÚe
);

770 ià(!
»t
) {

777 
	`wa™_fÜ_com¶‘iÚ
(&
lsİ
->
ls_dÚe
);

779 
	`__nvme_fc_fšish_ls_»q
(
lsİ
);

781 
»t
 = 
lsİ
->
ls_”rÜ
;

784 ià(
»t
)

785  
»t
;

788 ià(
rjt
->
w0
.
ls_cmd
 =ğ
FCNVME_LS_RJT
)

789  -
ENXIO
;

792 
	}
}

795 
	$nvme_fc_£nd_ls_»q_async
(
nvme_fc_½Üt
 *
½Üt
,

796 
nvmefc_ls_»q_İ
 *
lsİ
,

797 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

801  
	`__nvme_fc_£nd_ls_»q
(
½Üt
, 
lsİ
, 
dÚe
);

802 
	}
}

806 
	mVERR_NO_ERROR
 = 0,

807 
	mVERR_LSACC
 = 1,

808 
	mVERR_LSDESC_RQST
 = 2,

809 
	mVERR_LSDESC_RQST_LEN
 = 3,

810 
	mVERR_ASSOC_ID
 = 4,

811 
	mVERR_ASSOC_ID_LEN
 = 5,

812 
	mVERR_CONN_ID
 = 6,

813 
	mVERR_CONN_ID_LEN
 = 7,

814 
	mVERR_CR_ASSOC
 = 8,

815 
	mVERR_CR_ASSOC_ACC_LEN
 = 9,

816 
	mVERR_CR_CONN
 = 10,

817 
	mVERR_CR_CONN_ACC_LEN
 = 11,

818 
	mVERR_DISCONN
 = 12,

819 
	mVERR_DISCONN_ACC_LEN
 = 13,

822 *
	gv®id©iÚ_”rÜs
[] = {

840 
	$nvme_fc_cÚÃù_admš_queue
(
nvme_fc_ù¾
 *
ù¾
,

841 
nvme_fc_queue
 *
queue
, 
u16
 
qsize
, u16 
”¥_¿tio
)

843 
nvmefc_ls_»q_İ
 *
lsİ
;

844 
nvmefc_ls_»q
 *
l¤eq
;

845 
fúvme_ls_ü_assoc_rq¡
 *
assoc_rq¡
;

846 
fúvme_ls_ü_assoc_acc
 *
assoc_acc
;

847 
»t
, 
fü‘
 = 0;

849 
lsİ
 = 
	`kz®loc
(((*lsop) +

850 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

851 (*
assoc_rq¡
è+ (*
assoc_acc
)), 
GFP_KERNEL
);

852 ià(!
lsİ
) {

853 
»t
 = -
ENOMEM
;

854 
out_no_memÜy
;

856 
l¤eq
 = &
lsİ
->
ls_»q
;

858 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

859 
assoc_rq¡
 = (
fúvme_ls_ü_assoc_rq¡
 *)

860 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

861 
assoc_acc
 = (
fúvme_ls_ü_assoc_acc
 *)&
assoc_rq¡
[1];

863 
assoc_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_ASSOCIATION
;

864 
assoc_rq¡
->
desc_li¡_Ën
 =

865 
	`ıu_to_be32
((
fúvme_lsdesc_ü_assoc_cmd
));

867 
assoc_rq¡
->
assoc_cmd
.
desc_g
 =

868 
	`ıu_to_be32
(
FCNVME_LSDESC_CREATE_ASSOC_CMD
);

869 
assoc_rq¡
->
assoc_cmd
.
desc_Ën
 =

870 
	`fúvme_lsdesc_Ën
(

871 (
fúvme_lsdesc_ü_assoc_cmd
));

873 
assoc_rq¡
->
assoc_cmd
.
”¥_¿tio
 = 
	`ıu_to_be16
(ersp_ratio);

874 
assoc_rq¡
->
assoc_cmd
.
sqsize
 = 
	`ıu_to_be16
(
qsize
);

876 
assoc_rq¡
->
assoc_cmd
.
úid
 = 
	`ıu_to_be16
(0xffff);

877 
	`uuid_cİy
(&
assoc_rq¡
->
assoc_cmd
.
ho¡id
, &
ù¾
->ù¾.
İts
->
ho¡
->
id
);

878 
	`¡ºıy
(
assoc_rq¡
->
assoc_cmd
.
ho¡nqn
, 
ù¾
->ù¾.
İts
->
ho¡
->
nqn
,

879 
	`mš
(
FCNVME_ASSOC_HOSTNQN_LEN
, 
NVMF_NQN_SIZE
));

880 
	`¡ºıy
(
assoc_rq¡
->
assoc_cmd
.
subnqn
, 
ù¾
->ù¾.
İts
->
subsy¢qn
,

881 
	`mš
(
FCNVME_ASSOC_SUBNQN_LEN
, 
NVMF_NQN_SIZE
));

883 
lsİ
->
queue
 = queue;

884 
l¤eq
->
rq¡addr
 = 
assoc_rq¡
;

885 
l¤eq
->
rq¡Ën
 = (*
assoc_rq¡
);

886 
l¤eq
->
r¥addr
 = 
assoc_acc
;

887 
l¤eq
->
r¥Ën
 = (*
assoc_acc
);

888 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

890 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
->
½Üt
, 
lsİ
);

891 ià(
»t
)

892 
out_ä“_bufãr
;

897 ià(
assoc_acc
->
hdr
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_ACC
)

898 
fü‘
 = 
VERR_LSACC
;

899 ià(
assoc_acc
->
hdr
.
desc_li¡_Ën
 !=

900 
	`fúvme_lsdesc_Ën
(

901 (
fúvme_ls_ü_assoc_acc
)))

902 
fü‘
 = 
VERR_CR_ASSOC_ACC_LEN
;

903 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_g
 !=

904 
	`ıu_to_be32
(
FCNVME_LSDESC_RQST
))

905 
fü‘
 = 
VERR_LSDESC_RQST
;

906 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

907 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

908 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

909 ià(
assoc_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_CREATE_ASSOCIATION
)

910 
fü‘
 = 
VERR_CR_ASSOC
;

911 ià(
assoc_acc
->
associd
.
desc_g
 !=

912 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
))

913 
fü‘
 = 
VERR_ASSOC_ID
;

914 ià(
assoc_acc
->
associd
.
desc_Ën
 !=

915 
	`fúvme_lsdesc_Ën
(

916 (
fúvme_lsdesc_assoc_id
)))

917 
fü‘
 = 
VERR_ASSOC_ID_LEN
;

918 ià(
assoc_acc
->
cÚÃùid
.
desc_g
 !=

919 
	`ıu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

920 
fü‘
 = 
VERR_CONN_ID
;

921 ià(
assoc_acc
->
cÚÃùid
.
desc_Ën
 !=

922 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

923 
fü‘
 = 
VERR_CONN_ID_LEN
;

925 ià(
fü‘
) {

926 
»t
 = -
EBADF
;

927 
	`dev_”r
(
ù¾
->
dev
,

929 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

931 
ù¾
->
assocŸtiÚ_id
 =

932 
	`be64_to_ıu
(
assoc_acc
->
associd
.
assocŸtiÚ_id
);

933 
queue
->
cÚÃùiÚ_id
 =

934 
	`be64_to_ıu
(
assoc_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

935 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

938 
out_ä“_bufãr
:

939 
	`kä“
(
lsİ
);

940 
out_no_memÜy
:

941 ià(
»t
)

942 
	`dev_”r
(
ù¾
->
dev
,

944 
queue
->
qnum
, 
»t
);

945  
»t
;

946 
	}
}

949 
	$nvme_fc_cÚÃù_queue
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

950 
u16
 
qsize
, u16 
”¥_¿tio
)

952 
nvmefc_ls_»q_İ
 *
lsİ
;

953 
nvmefc_ls_»q
 *
l¤eq
;

954 
fúvme_ls_ü_cÚn_rq¡
 *
cÚn_rq¡
;

955 
fúvme_ls_ü_cÚn_acc
 *
cÚn_acc
;

956 
»t
, 
fü‘
 = 0;

958 
lsİ
 = 
	`kz®loc
(((*lsop) +

959 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

960 (*
cÚn_rq¡
è+ (*
cÚn_acc
)), 
GFP_KERNEL
);

961 ià(!
lsİ
) {

962 
»t
 = -
ENOMEM
;

963 
out_no_memÜy
;

965 
l¤eq
 = &
lsİ
->
ls_»q
;

967 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

968 
cÚn_rq¡
 = (
fúvme_ls_ü_cÚn_rq¡
 *)

969 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

970 
cÚn_acc
 = (
fúvme_ls_ü_cÚn_acc
 *)&
cÚn_rq¡
[1];

972 
cÚn_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_CONNECTION
;

973 
cÚn_rq¡
->
desc_li¡_Ën
 = 
	`ıu_to_be32
(

974 (
fúvme_lsdesc_assoc_id
) +

975 (
fúvme_lsdesc_ü_cÚn_cmd
));

977 
cÚn_rq¡
->
associd
.
desc_g
 = 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

978 
cÚn_rq¡
->
associd
.
desc_Ën
 =

979 
	`fúvme_lsdesc_Ën
(

980 (
fúvme_lsdesc_assoc_id
));

981 
cÚn_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ıu_to_be64
(
ù¾
->association_id);

982 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_g
 =

983 
	`ıu_to_be32
(
FCNVME_LSDESC_CREATE_CONN_CMD
);

984 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_Ën
 =

985 
	`fúvme_lsdesc_Ën
(

986 (
fúvme_lsdesc_ü_cÚn_cmd
));

987 
cÚn_rq¡
->
cÚÃù_cmd
.
”¥_¿tio
 = 
	`ıu_to_be16
(ersp_ratio);

988 
cÚn_rq¡
->
cÚÃù_cmd
.
qid
 = 
	`ıu_to_be16
(
queue
->
qnum
);

989 
cÚn_rq¡
->
cÚÃù_cmd
.
sqsize
 = 
	`ıu_to_be16
(
qsize
);

991 
lsİ
->
queue
 = queue;

992 
l¤eq
->
rq¡addr
 = 
cÚn_rq¡
;

993 
l¤eq
->
rq¡Ën
 = (*
cÚn_rq¡
);

994 
l¤eq
->
r¥addr
 = 
cÚn_acc
;

995 
l¤eq
->
r¥Ën
 = (*
cÚn_acc
);

996 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

998 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
->
½Üt
, 
lsİ
);

999 ià(
»t
)

1000 
out_ä“_bufãr
;

1005 ià(
cÚn_acc
->
hdr
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_ACC
)

1006 
fü‘
 = 
VERR_LSACC
;

1007 ià(
cÚn_acc
->
hdr
.
desc_li¡_Ën
 !=

1008 
	`fúvme_lsdesc_Ën
((
fúvme_ls_ü_cÚn_acc
)))

1009 
fü‘
 = 
VERR_CR_CONN_ACC_LEN
;

1010 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_g
 !ğ
	`ıu_to_be32
(
FCNVME_LSDESC_RQST
))

1011 
fü‘
 = 
VERR_LSDESC_RQST
;

1012 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

1013 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

1014 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

1015 ià(
cÚn_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_CREATE_CONNECTION
)

1016 
fü‘
 = 
VERR_CR_CONN
;

1017 ià(
cÚn_acc
->
cÚÃùid
.
desc_g
 !=

1018 
	`ıu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1019 
fü‘
 = 
VERR_CONN_ID
;

1020 ià(
cÚn_acc
->
cÚÃùid
.
desc_Ën
 !=

1021 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

1022 
fü‘
 = 
VERR_CONN_ID_LEN
;

1024 ià(
fü‘
) {

1025 
»t
 = -
EBADF
;

1026 
	`dev_”r
(
ù¾
->
dev
,

1028 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

1030 
queue
->
cÚÃùiÚ_id
 =

1031 
	`be64_to_ıu
(
cÚn_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

1032 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1035 
out_ä“_bufãr
:

1036 
	`kä“
(
lsİ
);

1037 
out_no_memÜy
:

1038 ià(
»t
)

1039 
	`dev_”r
(
ù¾
->
dev
,

1041 
queue
->
qnum
, 
»t
);

1042  
»t
;

1043 
	}
}

1046 
	$nvme_fc_discÚÃù_assoc_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

1048 
nvmefc_ls_»q_İ
 *
lsİ
 = 
	`ls_»q_to_lsİ
(
l¤eq
);

1050 
	`__nvme_fc_fšish_ls_»q
(
lsİ
);

1054 
	`kä“
(
lsİ
);

1055 
	}
}

1075 
	$nvme_fc_xmt_discÚÃù_assoc
(
nvme_fc_ù¾
 *
ù¾
)

1077 
fúvme_ls_discÚÃù_rq¡
 *
discÚ_rq¡
;

1078 
fúvme_ls_discÚÃù_acc
 *
discÚ_acc
;

1079 
nvmefc_ls_»q_İ
 *
lsİ
;

1080 
nvmefc_ls_»q
 *
l¤eq
;

1081 
»t
;

1083 
lsİ
 = 
	`kz®loc
(((*lsop) +

1084 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

1085 (*
discÚ_rq¡
è+ (*
discÚ_acc
)),

1086 
GFP_KERNEL
);

1087 ià(!
lsİ
)

1091 
l¤eq
 = &
lsİ
->
ls_»q
;

1093 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

1094 
discÚ_rq¡
 = (
fúvme_ls_discÚÃù_rq¡
 *)

1095 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

1096 
discÚ_acc
 = (
fúvme_ls_discÚÃù_acc
 *)&
discÚ_rq¡
[1];

1098 
discÚ_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_DISCONNECT
;

1099 
discÚ_rq¡
->
desc_li¡_Ën
 = 
	`ıu_to_be32
(

1100 (
fúvme_lsdesc_assoc_id
) +

1101 (
fúvme_lsdesc_discÚn_cmd
));

1103 
discÚ_rq¡
->
associd
.
desc_g
 = 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1104 
discÚ_rq¡
->
associd
.
desc_Ën
 =

1105 
	`fúvme_lsdesc_Ën
(

1106 (
fúvme_lsdesc_assoc_id
));

1108 
discÚ_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ıu_to_be64
(
ù¾
->association_id);

1110 
discÚ_rq¡
->
discÚ_cmd
.
desc_g
 = 
	`ıu_to_be32
(

1111 
FCNVME_LSDESC_DISCONN_CMD
);

1112 
discÚ_rq¡
->
discÚ_cmd
.
desc_Ën
 =

1113 
	`fúvme_lsdesc_Ën
(

1114 (
fúvme_lsdesc_discÚn_cmd
));

1115 
discÚ_rq¡
->
discÚ_cmd
.
scİe
 = 
FCNVME_DISCONN_ASSOCIATION
;

1116 
discÚ_rq¡
->
discÚ_cmd
.
id
 = 
	`ıu_to_be64
(
ù¾
->
assocŸtiÚ_id
);

1118 
l¤eq
->
rq¡addr
 = 
discÚ_rq¡
;

1119 
l¤eq
->
rq¡Ën
 = (*
discÚ_rq¡
);

1120 
l¤eq
->
r¥addr
 = 
discÚ_acc
;

1121 
l¤eq
->
r¥Ën
 = (*
discÚ_acc
);

1122 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1124 
»t
 = 
	`nvme_fc_£nd_ls_»q_async
(
ù¾
->
½Üt
, 
lsİ
,

1125 
nvme_fc_discÚÃù_assoc_dÚe
);

1126 ià(
»t
)

1127 
	`kä“
(
lsİ
);

1130 
ù¾
->
assocŸtiÚ_id
 = 0;

1131 
	}
}

1136 
__nvme_fc_fš®_İ_ş—nup
(
»que¡
 *
rq
);

1137 
nvme_fc_”rÜ_»cov”y
(
nvme_fc_ù¾
 *
ù¾
, *
”rmsg
);

1140 
	$nvme_fc_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

1142 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1143 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1145 
	`mem£t
(
cmdiu
, 0, (*cmdiu));

1146 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1147 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1148 
cmdiu
->
iu_Ën
 = 
	`ıu_to_be16
((*cmdiuè/ (
u32
));

1149 
	`mem£t
(&
İ
->
r¥_iu
, 0, (op->rsp_iu));

1152 
	}
}

1155 
	$__nvme_fc_ex™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1156 
nvme_fc_fı_İ
 *
İ
)

1158 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
,

1159 (
İ
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1160 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
,

1161 (
İ
->
cmd_iu
), 
DMA_TO_DEVICE
);

1163 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_UNINIT
);

1164 
	}
}

1167 
	$nvme_fc_ex™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
rq
,

1168 
hùx_idx
)

1170 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1172  
	`__nvme_fc_ex™_»que¡
(
£t
->
driv”_d©a
, 
İ
);

1173 
	}
}

1176 
	$__nvme_fc_abÜt_İ
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_fı_İ
 *
İ
)

1178 
¡©e
;

1180 
¡©e
 = 
	`©omic_xchg
(&
İ
->¡©e, 
FCPOP_STATE_ABORTED
);

1181 ià(
¡©e
 !ğ
FCPOP_STATE_ACTIVE
) {

1182 
	`©omic_£t
(&
İ
->
¡©e
, state);

1183  -
ECANCELED
;

1186 
ù¾
->
ÍÜt
->
İs
->
	`fı_abÜt
(&ù¾->ÍÜt->
loÿÍÜt
,

1187 &
ù¾
->
½Üt
->
»mÙ•Üt
,

1188 
İ
->
queue
->
Îdd_hªdË
,

1189 &
İ
->
fı_»q
);

1192 
	}
}

1195 
	$nvme_fc_abÜt_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1197 
nvme_fc_fı_İ
 *
«n_İ
 = 
ù¾
->
«n_İs
;

1198 
æags
;

1199 
i
, 
»t
;

1201 
i
 = 0; i < 
NVME_FC_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1202 ià(
	`©omic_»ad
(&
«n_İ
->
¡©e
è!ğ
FCPOP_STATE_ACTIVE
)

1205 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1206 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

1207 
ù¾
->
ioút
++;

1208 
«n_İ
->
æags
 |ğ
FCOP_FLAGS_TERMIO
;

1210 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1212 
»t
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
«n_İ
);

1213 ià(
»t
) {

1221 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1222 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

1223 
ù¾
->
ioút
--;

1224 
«n_İ
->
æags
 &ğ~
FCOP_FLAGS_TERMIO
;

1225 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1229 
	}
}

1231 
šlše
 

1232 
	$__nvme_fc_fıİ_chk_‹¬downs
(
nvme_fc_ù¾
 *
ù¾
,

1233 
nvme_fc_fı_İ
 *
İ
)

1235 
æags
;

1236 
boŞ
 
com¶‘e_rq
 = 
çl£
;

1238 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1239 ià(
	`uÆik–y
(
İ
->
æags
 & 
FCOP_FLAGS_TERMIO
)) {

1240 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

1241 ià(!--
ù¾
->
ioút
)

1242 
	`wake_up
(&
ù¾
->
ißbÜt_wa™
);

1245 ià(
İ
->
æags
 & 
FCOP_FLAGS_RELEASED
)

1246 
com¶‘e_rq
 = 
Œue
;

1248 
İ
->
æags
 |ğ
FCOP_FLAGS_COMPLETE
;

1249 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1251  
com¶‘e_rq
;

1252 
	}
}

1255 
	$nvme_fc_fıio_dÚe
(
nvmefc_fı_»q
 *
»q
)

1257 
nvme_fc_fı_İ
 *
İ
 = 
	`fı_»q_to_fı_İ
(
»q
);

1258 
»que¡
 *
rq
 = 
İ
->rq;

1259 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1260 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

1261 
nvme_fc_queue
 *
queue
 = 
İ
->queue;

1262 
nvme_com¶‘iÚ
 *
cqe
 = &
İ
->
r¥_iu
.cqe;

1263 
nvme_commªd
 *
sqe
 = &
İ
->
cmd_iu
.sqe;

1264 
__Ë16
 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_SUCCESS
 << 1);

1265 
nvme_»suÉ
 
»suÉ
;

1266 
boŞ
 
com¶‘e_rq
, 
‹rmš©e_assoc
 = 
Œue
;

1305 
	`fc_dma_sync_sšgË_fÜ_ıu
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
,

1306 (
İ
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1308 ià(
	`©omic_»ad
(&
İ
->
¡©e
è=ğ
FCPOP_STATE_ABORTED
)

1309 
¡©us
 = 
	`ıu_to_Ë16
((
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
) << 1);

1310 ià(
äeq
->
¡©us
)

1311 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_FC_TRANSPORT_ERROR
 << 1);

1318 ià(
¡©us
)

1319 
dÚe
;

1328 
äeq
->
rcv_r¥Ën
) {

1331 
NVME_FC_SIZEOF_ZEROS_RSP
:

1337 ià(
äeq
->
Œªsã¼ed_Ëngth
 !=

1338 
	`be32_to_ıu
(
İ
->
cmd_iu
.
d©a_Ën
)) {

1339 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_FC_TRANSPORT_ERROR
 << 1);

1340 
dÚe
;

1342 
»suÉ
.
u64
 = 0;

1345 (
nvme_fc_”¥_iu
):

1350 ià(
	`uÆik–y
(
	`be16_to_ıu
(
İ
->
r¥_iu
.
iu_Ën
) !=

1351 (
äeq
->
rcv_r¥Ën
 / 4) ||

1352 
	`be32_to_ıu
(
İ
->
r¥_iu
.
xäd_Ën
) !=

1353 
äeq
->
Œªsã¼ed_Ëngth
 ||

1354 
İ
->
r¥_iu
.
¡©us_code
 ||

1355 
sqe
->
commÚ
.
commªd_id
 !ğ
cqe
->command_id)) {

1356 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_FC_TRANSPORT_ERROR
 << 1);

1357 
dÚe
;

1359 
»suÉ
 = 
cqe
->result;

1360 
¡©us
 = 
cqe
->status;

1364 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_FC_TRANSPORT_ERROR
 << 1);

1365 
dÚe
;

1368 
‹rmš©e_assoc
 = 
çl£
;

1370 
dÚe
:

1371 ià(
İ
->
æags
 & 
FCOP_FLAGS_AEN
) {

1372 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
¡©us
, &
»suÉ
);

1373 
com¶‘e_rq
 = 
	`__nvme_fc_fıİ_chk_‹¬downs
(
ù¾
, 
İ
);

1374 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

1375 
İ
->
æags
 = 
FCOP_FLAGS_AEN
;

1376 
	`nvme_fc_ù¾_put
(
ù¾
);

1377 
check_”rÜ
;

1380 
com¶‘e_rq
 = 
	`__nvme_fc_fıİ_chk_‹¬downs
(
ù¾
, 
İ
);

1381 ià(!
com¶‘e_rq
) {

1382 ià(
	`uÆik–y
(
İ
->
æags
 & 
FCOP_FLAGS_TERMIO
)) {

1383 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_ABORT_REQ
 << 1);

1384 ià(
	`blk_queue_dyšg
(
rq
->
q
))

1385 
¡©us
 |ğ
	`ıu_to_Ë16
(
NVME_SC_DNR
 << 1);

1387 
	`nvme_’d_»que¡
(
rq
, 
¡©us
, 
»suÉ
);

1389 
	`__nvme_fc_fš®_İ_ş—nup
(
rq
);

1391 
check_”rÜ
:

1392 ià(
‹rmš©e_assoc
)

1393 
	`nvme_fc_”rÜ_»cov”y
(
ù¾
, "transport detected ioƒrror");

1394 
	}
}

1397 
	$__nvme_fc_š™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1398 
nvme_fc_queue
 *
queue
, 
nvme_fc_fı_İ
 *
İ
,

1399 
»que¡
 *
rq
, 
u32
 
rqno
)

1401 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1402 
»t
 = 0;

1404 
	`mem£t
(
İ
, 0, (*op));

1405 
İ
->
fı_»q
.
cmdaddr
 = &İ->
cmd_iu
;

1406 
İ
->
fı_»q
.
cmdËn
 = (İ->
cmd_iu
);

1407 
İ
->
fı_»q
.
r¥addr
 = &İ->
r¥_iu
;

1408 
İ
->
fı_»q
.
r¥Ën
 = (İ->
r¥_iu
);

1409 
İ
->
fı_»q
.
dÚe
 = 
nvme_fc_fıio_dÚe
;

1410 
İ
->
fı_»q
.
fœ¡_sgl
 = (
sÿ‰”li¡
 *)&op[1];

1411 
İ
->
fı_»q
.
´iv©e
 = &İ->fı_»q.
fœ¡_sgl
[
SG_CHUNK_SIZE
];

1412 
İ
->
ù¾
 = ctrl;

1413 
İ
->
queue
 = queue;

1414 
İ
->
rq
 =„q;

1415 
İ
->
rqno
 =„qno;

1417 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1418 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1419 
cmdiu
->
iu_Ën
 = 
	`ıu_to_be16
((*cmdiuè/ (
u32
));

1421 
İ
->
fı_»q
.
cmddma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1422 &
İ
->
cmd_iu
, (İ->cmd_iu), 
DMA_TO_DEVICE
);

1423 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
)) {

1424 
	`dev_”r
(
ù¾
->
dev
,

1426 
»t
 = 
EFAULT
;

1427 
out_Ú_”rÜ
;

1430 
İ
->
fı_»q
.
r¥dma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1431 &
İ
->
r¥_iu
, (op->rsp_iu),

1432 
DMA_FROM_DEVICE
);

1433 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
)) {

1434 
	`dev_”r
(
ù¾
->
dev
,

1436 
»t
 = 
EFAULT
;

1439 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

1440 
out_Ú_”rÜ
:

1441  
»t
;

1442 
	}
}

1445 
	$nvme_fc_š™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
rq
,

1446 
hùx_idx
, 
numa_node
)

1448 
nvme_fc_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

1449 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1450 
queue_idx
 = (
£t
 =ğ&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

1451 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

1453  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
İ
, 
rq
, queue->
rqút
++);

1454 
	}
}

1457 
	$nvme_fc_š™_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1459 
nvme_fc_fı_İ
 *
«n_İ
;

1460 
nvme_fc_cmd_iu
 *
cmdiu
;

1461 
nvme_commªd
 *
sqe
;

1462 *
´iv©e
;

1463 
i
, 
»t
;

1465 
«n_İ
 = 
ù¾
->
«n_İs
;

1466 
i
 = 0; i < 
NVME_FC_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1467 
´iv©e
 = 
	`kz®loc
(
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
,

1468 
GFP_KERNEL
);

1469 ià(!
´iv©e
)

1470  -
ENOMEM
;

1472 
cmdiu
 = &
«n_İ
->
cmd_iu
;

1473 
sqe
 = &
cmdiu
->sqe;

1474 
»t
 = 
	`__nvme_fc_š™_»que¡
(
ù¾
, &ù¾->
queues
[0],

1475 
«n_İ
, (
»que¡
 *)
NULL
,

1476 (
AEN_CMDID_BASE
 + 
i
));

1477 ià(
»t
) {

1478 
	`kä“
(
´iv©e
);

1479  
»t
;

1482 
«n_İ
->
æags
 = 
FCOP_FLAGS_AEN
;

1483 
«n_İ
->
fı_»q
.
fœ¡_sgl
 = 
NULL
;

1484 
«n_İ
->
fı_»q
.
´iv©e
 =…rivate;

1486 
	`mem£t
(
sqe
, 0, (*sqe));

1487 
sqe
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1489 
sqe
->
commÚ
.
commªd_id
 = 
AEN_CMDID_BASE
 + 
i
;

1492 
	}
}

1495 
	$nvme_fc_‹rm_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1497 
nvme_fc_fı_İ
 *
«n_İ
;

1498 
i
;

1500 
«n_İ
 = 
ù¾
->
«n_İs
;

1501 
i
 = 0; i < 
NVME_FC_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1502 ià(!
«n_İ
->
fı_»q
.
´iv©e
)

1505 
	`__nvme_fc_ex™_»que¡
(
ù¾
, 
«n_İ
);

1507 
	`kä“
(
«n_İ
->
fı_»q
.
´iv©e
);

1508 
«n_İ
->
fı_»q
.
´iv©e
 = 
NULL
;

1510 
	}
}

1512 
šlše
 

1513 
	$__nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
nvme_fc_ù¾
 *
ù¾
,

1514 
qidx
)

1516 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
qidx
];

1518 
hùx
->
driv”_d©a
 = 
queue
;

1519 
queue
->
hùx
 = hctx;

1520 
	}
}

1523 
	$nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1524 
hùx_idx
)

1526 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1528 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
 + 1);

1531 
	}
}

1534 
	$nvme_fc_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1535 
hùx_idx
)

1537 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1539 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
);

1542 
	}
}

1545 
	$nvme_fc_š™_queue
(
nvme_fc_ù¾
 *
ù¾
, 
idx
, 
size_t
 
queue_size
)

1547 
nvme_fc_queue
 *
queue
;

1549 
queue
 = &
ù¾
->
queues
[
idx
];

1550 
	`mem£t
(
queue
, 0, (*queue));

1551 
queue
->
ù¾
 = ctrl;

1552 
queue
->
qnum
 = 
idx
;

1553 
	`©omic_£t
(&
queue
->
c¢
, 1);

1554 
queue
->
dev
 = 
ù¾
->dev;

1556 ià(
idx
 > 0)

1557 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

1559 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

1561 
queue
->
queue_size
 = queue_size;

1573 
	}
}

1584 
	$nvme_fc_ä“_queue
(
nvme_fc_queue
 *
queue
)

1586 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
))

1595 
queue
->
cÚÃùiÚ_id
 = 0;

1596 
	`ş—r_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1597 
	}
}

1600 
	$__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1601 
nvme_fc_queue
 *
queue
, 
qidx
)

1603 ià(
ù¾
->
ÍÜt
->
İs
->
d–‘e_queue
)

1604 
ù¾
->
ÍÜt
->
İs
->
	`d–‘e_queue
(&ù¾->ÍÜt->
loÿÍÜt
, 
qidx
,

1605 
queue
->
Îdd_hªdË
);

1606 
queue
->
Îdd_hªdË
 = 
NULL
;

1607 
	}
}

1610 
	$nvme_fc_ä“_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1612 
i
;

1614 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

1615 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[
i
]);

1616 
	}
}

1619 
	$__nvme_fc_ü—‹_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1620 
nvme_fc_queue
 *
queue
, 
qidx
, 
u16
 
qsize
)

1622 
»t
 = 0;

1624 
queue
->
Îdd_hªdË
 = 
NULL
;

1625 ià(
ù¾
->
ÍÜt
->
İs
->
ü—‹_queue
)

1626 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`ü—‹_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

1627 
qidx
, 
qsize
, &
queue
->
Îdd_hªdË
);

1629  
»t
;

1630 
	}
}

1633 
	$nvme_fc_d–‘e_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1635 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[ù¾->ù¾.
queue_couÁ
 - 1];

1636 
i
;

1638 
i
 = 
ù¾
->ù¾.
queue_couÁ
 - 1; i >ğ1; i--, 
queue
--)

1639 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, 
queue
, 
i
);

1640 
	}
}

1643 
	$nvme_fc_ü—‹_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

1645 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[1];

1646 
i
, 
»t
;

1648 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++, 
queue
++) {

1649 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, 
queue
, 
i
, 
qsize
);

1650 ià(
»t
)

1651 
d–‘e_queues
;

1656 
d–‘e_queues
:

1657 ; 
i
 >= 0; i--)

1658 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[
i
], i);

1659  
»t
;

1660 
	}
}

1663 
	$nvme_fc_cÚÃù_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

1665 
i
, 
»t
 = 0;

1667 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

1668 
»t
 = 
	`nvme_fc_cÚÃù_queue
(
ù¾
, &ù¾->
queues
[
i
], 
qsize
,

1669 (
qsize
 / 5));

1670 ià(
»t
)

1672 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

1673 ià(
»t
)

1677  
»t
;

1678 
	}
}

1681 
	$nvme_fc_š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1683 
i
;

1685 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

1686 
	`nvme_fc_š™_queue
(
ù¾
, 
i
, cŒl->ù¾.
sqsize
);

1687 
	}
}

1690 
	$nvme_fc_ù¾_ä“
(
k»f
 *
»f
)

1692 
nvme_fc_ù¾
 *
ù¾
 =

1693 
	`cÚš”_of
(
»f
, 
nvme_fc_ù¾
,„ef);

1694 
æags
;

1696 ià(
ù¾
->ù¾.
g£t
) {

1697 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1698 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1702 
	`¥š_lock_œq§ve
(&
ù¾
->
½Üt
->
lock
, 
æags
);

1703 
	`li¡_d–
(&
ù¾
->
ù¾_li¡
);

1704 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
½Üt
->
lock
, 
æags
);

1706 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1707 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

1708 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

1710 
	`kä“
(
ù¾
->
queues
);

1712 
	`put_deviû
(
ù¾
->
dev
);

1713 
	`nvme_fc_½Üt_put
(
ù¾
->
½Üt
);

1715 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

1716 ià(
ù¾
->ù¾.
İts
)

1717 
	`nvmf_ä“_İtiÚs
(
ù¾
->ù¾.
İts
);

1718 
	`kä“
(
ù¾
);

1719 
	}
}

1722 
	$nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *
ù¾
)

1724 
	`k»f_put
(&
ù¾
->
»f
, 
nvme_fc_ù¾_ä“
);

1725 
	}
}

1728 
	$nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *
ù¾
)

1730  
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
»f
);

1731 
	}
}

1738 
	$nvme_fc_nvme_ù¾_ä“d
(
nvme_ù¾
 *
nù¾
)

1740 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

1742 
	`WARN_ON
(
nù¾
 !ğ&
ù¾
->ctrl);

1744 
	`nvme_fc_ù¾_put
(
ù¾
);

1745 
	}
}

1748 
	$nvme_fc_”rÜ_»cov”y
(
nvme_fc_ù¾
 *
ù¾
, *
”rmsg
)

1751 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_LIVE
)

1754 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1756 
ù¾
->
úum
, 
”rmsg
);

1757 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1758 "NVME-FC{%d}:„e£‰šg cÚŒŞËr\n", 
ù¾
->
úum
);

1760 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
)) {

1761 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1763 "tØRECONNECTING\n", 
ù¾
->
úum
);

1767 
	`nvme_»£t_ù¾
(&
ù¾
->ctrl);

1768 
	}
}

1770 
blk_eh_tim”_»tuº


1771 
	$nvme_fc_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

1773 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1774 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

1775 
»t
;

1777 ià(
»£rved
)

1778  
BLK_EH_RESET_TIMER
;

1780 
»t
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
İ
);

1781 ià(
»t
)

1783  
BLK_EH_HANDLED
;

1792 
	`nvme_fc_”rÜ_»cov”y
(
ù¾
, "ioimeoutƒrror");

1794  
BLK_EH_HANDLED
;

1795 
	}
}

1798 
	$nvme_fc_m­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

1799 
nvme_fc_fı_İ
 *
İ
)

1801 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1802 
dma_d©a_dœeùiÚ
 
dœ
;

1803 
»t
;

1805 
äeq
->
sg_út
 = 0;

1807 ià(!
	`blk_rq_·ylßd_by‹s
(
rq
))

1810 
äeq
->
sg_bË
.
sgl
 = f»q->
fœ¡_sgl
;

1811 
»t
 = 
	`sg_®loc_bË_chašed
(&
äeq
->
sg_bË
,

1812 
	`blk_rq_Ä_phys_£gm’ts
(
rq
), 
äeq
->
sg_bË
.
sgl
);

1813 ià(
»t
)

1814  -
ENOMEM
;

1816 
İ
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q, 
äeq
->
sg_bË
.
sgl
);

1817 
	`WARN_ON
(
İ
->
ÃÁs
 > 
	`blk_rq_Ä_phys_£gm’ts
(
rq
));

1818 
dœ
 = (
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

1819 
äeq
->
sg_út
 = 
	`fc_dma_m­_sg
(
ù¾
->
ÍÜt
->
dev
, f»q->
sg_bË
.
sgl
,

1820 
İ
->
ÃÁs
, 
dœ
);

1821 ià(
	`uÆik–y
(
äeq
->
sg_út
 <= 0)) {

1822 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

1823 
äeq
->
sg_út
 = 0;

1824  -
EFAULT
;

1831 
	}
}

1834 
	$nvme_fc_unm­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

1835 
nvme_fc_fı_İ
 *
İ
)

1837 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1839 ià(!
äeq
->
sg_út
)

1842 
	`fc_dma_unm­_sg
(
ù¾
->
ÍÜt
->
dev
, 
äeq
->
sg_bË
.
sgl
, 
İ
->
ÃÁs
,

1843 ((
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
) ?

1844 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
));

1846 
	`nvme_ş—nup_cmd
(
rq
);

1848 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

1850 
äeq
->
sg_út
 = 0;

1851 
	}
}

1876 
blk_¡©us_t


1877 
	$nvme_fc_¡¬t_fı_İ
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

1878 
nvme_fc_fı_İ
 *
İ
, 
u32
 
d©a_Ën
,

1879 
nvmefc_fı_d©adœ
 
io_dœ
)

1881 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1882 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

1883 
u32
 
c¢
;

1884 
»t
;

1890 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
)

1891 
busy
;

1893 ià(!
	`nvme_fc_ù¾_g‘
(
ù¾
))

1894  
BLK_STS_IOERR
;

1897 
cmdiu
->
cÚÃùiÚ_id
 = 
	`ıu_to_be64
(
queue
->connection_id);

1898 
c¢
 = 
	`©omic_šc_»tuº
(&
queue
->csn);

1899 
cmdiu
->
c¢
 = 
	`ıu_to_be32
(csn);

1900 
cmdiu
->
d©a_Ën
 = 
	`ıu_to_be32
(data_len);

1901 
io_dœ
) {

1902 
NVMEFC_FCP_WRITE
:

1903 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_WRITE
;

1905 
NVMEFC_FCP_READ
:

1906 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_READ
;

1908 
NVMEFC_FCP_NODATA
:

1909 
cmdiu
->
æags
 = 0;

1912 
İ
->
fı_»q
.
·ylßd_Ëngth
 = 
d©a_Ën
;

1913 
İ
->
fı_»q
.
io_dœ
 = io_dir;

1914 
İ
->
fı_»q
.
Œªsã¼ed_Ëngth
 = 0;

1915 
İ
->
fı_»q
.
rcv_r¥Ën
 = 0;

1916 
İ
->
fı_»q
.
¡©us
 = 
NVME_SC_SUCCESS
;

1917 
İ
->
fı_»q
.
sqid
 = 
	`ıu_to_Ë16
(
queue
->
qnum
);

1923 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
m‘ad©a
);

1924 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
d±r
.
´p1
);

1925 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
d±r
.
´p2
);

1926 
sqe
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1933 
sqe
->
rw
.
d±r
.
sgl
.
ty³
 = 
NVME_SGL_FMT_OFFSET
;

1934 
sqe
->
rw
.
d±r
.
sgl
.
Ëngth
 = 
	`ıu_to_Ë32
(
d©a_Ën
);

1935 
sqe
->
rw
.
d±r
.
sgl
.
addr
 = 0;

1937 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
)) {

1938 
»t
 = 
	`nvme_fc_m­_d©a
(
ù¾
, 
İ
->
rq
, op);

1939 ià(
»t
 < 0) {

1940 
	`nvme_ş—nup_cmd
(
İ
->
rq
);

1941 
	`nvme_fc_ù¾_put
(
ù¾
);

1942 ià(
»t
 =ğ-
ENOMEM
 ||„‘ =ğ-
EAGAIN
)

1943  
BLK_STS_RESOURCE
;

1944  
BLK_STS_IOERR
;

1948 
	`fc_dma_sync_sšgË_fÜ_deviû
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
,

1949 (
İ
->
cmd_iu
), 
DMA_TO_DEVICE
);

1951 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_ACTIVE
);

1953 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
))

1954 
	`blk_mq_¡¬t_»que¡
(
İ
->
rq
);

1956 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`fı_io
(&ù¾->ÍÜt->
loÿÍÜt
,

1957 &
ù¾
->
½Üt
->
»mÙ•Üt
,

1958 
queue
->
Îdd_hªdË
, &
İ
->
fı_»q
);

1960 ià(
»t
) {

1961 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
))

1962 
	`nvme_fc_unm­_d©a
(
ù¾
, 
İ
->
rq
, op);

1964 
	`nvme_fc_ù¾_put
(
ù¾
);

1966 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ğ
FC_OBJSTATE_ONLINE
 &&

1967 
»t
 !ğ-
EBUSY
)

1968  
BLK_STS_IOERR
;

1970 
busy
;

1973  
BLK_STS_OK
;

1975 
busy
:

1976 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
è&& 
queue
->
hùx
)

1977 
	`blk_mq_d–ay_run_hw_queue
(
queue
->
hùx
, 
NVMEFC_QUEUE_DELAY
);

1979  
BLK_STS_RESOURCE
;

1980 
	}
}

1982 
blk_¡©us_t


1983 
	$nvme_fc_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1984 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1986 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1987 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1988 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

1989 
»que¡
 *
rq
 = 
bd
->rq;

1990 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1991 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1992 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

1993 
nvmefc_fı_d©adœ
 
io_dœ
;

1994 
u32
 
d©a_Ën
;

1995 
blk_¡©us_t
 
»t
;

1997 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
sqe
);

1998 ià(
»t
)

1999  
»t
;

2001 
d©a_Ën
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

2002 ià(
d©a_Ën
)

2003 
io_dœ
 = ((
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
) ?

2004 
NVMEFC_FCP_WRITE
 : 
NVMEFC_FCP_READ
);

2006 
io_dœ
 = 
NVMEFC_FCP_NODATA
;

2008  
	`nvme_fc_¡¬t_fı_İ
(
ù¾
, 
queue
, 
İ
, 
d©a_Ën
, 
io_dœ
);

2009 
	}
}

2011 
blk_mq_gs
 *

2012 
	$nvme_fc_g£t
(
nvme_fc_queue
 *
queue
)

2014 ià(
queue
->
qnum
 == 0)

2015  
queue
->
ù¾
->
admš_g_£t
.
gs
[queue->
qnum
];

2017  
queue
->
ù¾
->
g_£t
.
gs
[queue->
qnum
 - 1];

2018 
	}
}

2021 
	$nvme_fc_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

2024 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

2025 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

2026 
»que¡
 *
»q
;

2027 
nvme_fc_fı_İ
 *
İ
;

2029 
»q
 = 
	`blk_mq_g_to_rq
(
	`nvme_fc_g£t
(
queue
), 
g
);

2030 ià(!
»q
)

2033 
İ
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2035 ià((
	`©omic_»ad
(&
İ
->
¡©e
è=ğ
FCPOP_STATE_ACTIVE
) &&

2036 (
ù¾
->
ÍÜt
->
İs
->
pŞl_queue
))

2037 
ù¾
->
ÍÜt
->
İs
->
	`pŞl_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

2038 
queue
->
Îdd_hªdË
);

2040  ((
	`©omic_»ad
(&
İ
->
¡©e
è!ğ
FCPOP_STATE_ACTIVE
));

2041 
	}
}

2044 
	$nvme_fc_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
, 
«r_idx
)

2046 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
¬g
);

2047 
nvme_fc_fı_İ
 *
«n_İ
;

2048 
æags
;

2049 
boŞ
 
‹rmš©šg
 = 
çl£
;

2050 
blk_¡©us_t
 
»t
;

2052 ià(
«r_idx
 > 
NVME_FC_NR_AEN_COMMANDS
)

2055 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2056 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

2057 
‹rmš©šg
 = 
Œue
;

2058 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2060 ià(
‹rmš©šg
)

2063 
«n_İ
 = &
ù¾
->
«n_İs
[
«r_idx
];

2065 
»t
 = 
	`nvme_fc_¡¬t_fı_İ
(
ù¾
, 
«n_İ
->
queue
,‡en_op, 0,

2066 
NVMEFC_FCP_NODATA
);

2067 ià(
»t
)

2068 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2069 "çed‡synøev’ˆwÜk [%d]\n", 
«r_idx
);

2070 
	}
}

2073 
	$__nvme_fc_fš®_İ_ş—nup
(
»que¡
 *
rq
)

2075 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2076 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

2078 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

2079 
İ
->
æags
 &ğ~(
FCOP_FLAGS_TERMIO
 | 
FCOP_FLAGS_RELEASED
 |

2080 
FCOP_FLAGS_COMPLETE
);

2082 
	`nvme_fc_unm­_d©a
(
ù¾
, 
rq
, 
İ
);

2083 
	`nvme_com¶‘e_rq
(
rq
);

2084 
	`nvme_fc_ù¾_put
(
ù¾
);

2086 
	}
}

2089 
	$nvme_fc_com¶‘e_rq
(
»que¡
 *
rq
)

2091 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2092 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

2093 
æags
;

2094 
boŞ
 
com¶‘ed
 = 
çl£
;

2104 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2105 ià(
İ
->
æags
 & 
FCOP_FLAGS_COMPLETE
)

2106 
com¶‘ed
 = 
Œue
;

2108 
İ
->
æags
 |ğ
FCOP_FLAGS_RELEASED
;

2109 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2111 ià(
com¶‘ed
)

2112 
	`__nvme_fc_fš®_İ_ş—nup
(
rq
);

2113 
	}
}

2129 
	$nvme_fc_‹rmš©e_exchªge
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

2131 
nvme_ù¾
 *
nù¾
 = 
d©a
;

2132 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2133 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2134 
æags
;

2135 
¡©us
;

2137 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

2140 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2141 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

2142 
ù¾
->
ioút
++;

2143 
İ
->
æags
 |ğ
FCOP_FLAGS_TERMIO
;

2145 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2147 
¡©us
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
İ
);

2148 ià(
¡©us
) {

2156 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2157 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

2158 
ù¾
->
ioút
--;

2159 
İ
->
æags
 &ğ~
FCOP_FLAGS_TERMIO
;

2160 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2163 
	}
}

2166 cÚ¡ 
blk_mq_İs
 
	gnvme_fc_mq_İs
 = {

2167 .
queue_rq
 = 
nvme_fc_queue_rq
,

2168 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

2169 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

2170 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

2171 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

2172 .
	gš™_hùx
 = 
nvme_fc_š™_hùx
,

2173 .
	gpŞl
 = 
nvme_fc_pŞl
,

2174 .
	gtimeout
 = 
nvme_fc_timeout
,

2178 
	$nvme_fc_ü—‹_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2180 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2181 
Ä_io_queues
;

2182 
»t
;

2184 
Ä_io_queues
 = 
	`mš
(mš(
İts
->Ä_io_queues, 
	`num_Úlše_ıus
()),

2185 
ù¾
->
ÍÜt
->
İs
->
max_hw_queues
);

2186 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

2187 ià(
»t
) {

2188 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2189 "£t_queue_couÁ faed: %d\n", 
»t
);

2190  
»t
;

2193 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

2194 ià(!
Ä_io_queues
)

2197 
	`nvme_fc_š™_io_queues
(
ù¾
);

2199 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

2200 
ù¾
->
g_£t
.
İs
 = &
nvme_fc_mq_İs
;

2201 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
İts
->
queue_size
;

2202 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

2203 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

2204 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2205 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_fc_fı_İ
) +

2206 (
SG_CHUNK_SIZE
 *

2207 (
sÿ‰”li¡
)) +

2208 
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
;

2209 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

2210 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->ù¾.
queue_couÁ
 - 1;

2211 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2213 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

2214 ià(
»t
)

2215  
»t
;

2217 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

2219 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

2220 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

2221 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

2222 
out_ä“_g_£t
;

2225 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2226 ià(
»t
)

2227 
out_ş—nup_blk_queue
;

2229 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2230 ià(
»t
)

2231 
out_d–‘e_hw_queues
;

2235 
out_d–‘e_hw_queues
:

2236 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2237 
out_ş—nup_blk_queue
:

2238 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

2239 
out_ä“_g_£t
:

2240 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

2241 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2244 
ù¾
->ù¾.
g£t
 = 
NULL
;

2246  
»t
;

2247 
	}
}

2250 
	$nvme_fc_»š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2252 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2253 
Ä_io_queues
;

2254 
»t
;

2256 
Ä_io_queues
 = 
	`mš
(mš(
İts
->Ä_io_queues, 
	`num_Úlše_ıus
()),

2257 
ù¾
->
ÍÜt
->
İs
->
max_hw_queues
);

2258 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

2259 ià(
»t
) {

2260 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2261 "£t_queue_couÁ faed: %d\n", 
»t
);

2262  
»t
;

2265 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

2267 ià(
ù¾
->ù¾.
queue_couÁ
 == 1)

2270 
	`nvme_fc_š™_io_queues
(
ù¾
);

2272 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

2273 ià(
»t
)

2274 
out_ä“_io_queues
;

2276 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2277 ià(
»t
)

2278 
out_ä“_io_queues
;

2280 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2281 ià(
»t
)

2282 
out_d–‘e_hw_queues
;

2284 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
, 
Ä_io_queues
);

2288 
out_d–‘e_hw_queues
:

2289 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2290 
out_ä“_io_queues
:

2291 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2292  
»t
;

2293 
	}
}

2300 
	$nvme_fc_ü—‹_assocŸtiÚ
(
nvme_fc_ù¾
 *
ù¾
)

2302 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2303 
u32
 
£gs
;

2304 
»t
;

2305 
boŞ
 
chªged
;

2307 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

2313 
	`nvme_fc_š™_queue
(
ù¾
, 0, 
NVME_FC_AQ_BLKMQ_DEPTH
);

2315 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0,

2316 
NVME_FC_AQ_BLKMQ_DEPTH
);

2317 ià(
»t
)

2318 
out_ä“_queue
;

2320 
»t
 = 
	`nvme_fc_cÚÃù_admš_queue
(
ù¾
, &ù¾->
queues
[0],

2321 
NVME_FC_AQ_BLKMQ_DEPTH
,

2322 (
NVME_FC_AQ_BLKMQ_DEPTH
 / 4));

2323 ià(
»t
)

2324 
out_d–‘e_hw_queue
;

2326 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_NEW
)

2327 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2329 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

2330 ià(
»t
)

2331 
out_discÚÃù_admš_queue
;

2340 
»t
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
, &ù¾->ù¾.
ÿp
);

2341 ià(
»t
) {

2342 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2344 
out_discÚÃù_admš_queue
;

2347 
ù¾
->ù¾.
sqsize
 =

2348 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->ù¾.
ÿp
è+ 1, cŒl->ù¾.
sqsize
);

2350 
»t
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

2351 ià(
»t
)

2352 
out_discÚÃù_admš_queue
;

2354 
£gs
 = 
	`mš_t
(
u32
, 
NVME_FC_MAX_SEGMENTS
,

2355 
ù¾
->
ÍÜt
->
İs
->
max_sgl_£gm’ts
);

2356 
ù¾
->ù¾.
max_hw_£ùÜs
 = (
£gs
 - 1è<< (
PAGE_SHIFT
 - 9);

2358 
»t
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

2359 ià(
»t
)

2360 
out_discÚÃù_admš_queue
;

2365 ià(
ù¾
->ù¾.
icdoff
) {

2366 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff %d is‚ot supported!\n",

2367 
ù¾
->ù¾.
icdoff
);

2368 
out_discÚÃù_admš_queue
;

2373 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

2375 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2378 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

2379 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

2382 
»t
 = 
	`nvme_fc_š™_«n_İs
(
ù¾
);

2383 ià(
»t
)

2384 
out_‹rm_«n_İs
;

2390 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

2391 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
)

2392 
»t
 = 
	`nvme_fc_ü—‹_io_queues
(
ù¾
);

2394 
»t
 = 
	`nvme_fc_»š™_io_queues
(
ù¾
);

2395 ià(
»t
)

2396 
out_‹rm_«n_İs
;

2399 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

2400 
	`WARN_ON_ONCE
(!
chªged
);

2402 
ù¾
->ù¾.
Ä_»cÚÃùs
 = 0;

2404 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

2408 
out_‹rm_«n_İs
:

2409 
	`nvme_fc_‹rm_«n_İs
(
ù¾
);

2410 
out_discÚÃù_admš_queue
:

2412 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2413 
out_d–‘e_hw_queue
:

2414 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2415 
out_ä“_queue
:

2416 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2418  
»t
;

2419 
	}
}

2428 
	$nvme_fc_d–‘e_assocŸtiÚ
(
nvme_fc_ù¾
 *
ù¾
)

2430 
æags
;

2432 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2433 
ù¾
->
æags
 |ğ
FCCTRL_TERMIO
;

2434 
ù¾
->
ioút
 = 0;

2435 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2449 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

2450 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

2451 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

2452 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2472 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2473 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

2474 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2477 
	`nvme_fc_abÜt_«n_İs
(
ù¾
);

2480 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2481 
	`wa™_ev’t_lock_œq
(
ù¾
->
ißbÜt_wa™
, cŒl->
ioút
 =ğ0, cŒl->
lock
);

2482 
ù¾
->
æags
 &ğ~
FCCTRL_TERMIO
;

2483 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2485 
	`nvme_fc_‹rm_«n_İs
(
ù¾
);

2493 ià(
ù¾
->
assocŸtiÚ_id
)

2494 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2496 ià(
ù¾
->ù¾.
g£t
) {

2497 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2498 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2501 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2502 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2503 
	}
}

2506 
	$nvme_fc_d–‘e_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2508 
nvme_fc_ù¾
 *
ù¾
 =

2509 
	`cÚš”_of
(
wÜk
, 
nvme_fc_ù¾
, 
d–‘e_wÜk
);

2511 
	`ÿnûl_wÜk_sync
(&
ù¾
->ù¾.
»£t_wÜk
);

2512 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
cÚÃù_wÜk
);

2513 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

2514 
	`nvme_»move_Çme¥aûs
(&
ù¾
->ctrl);

2519 
	`nvme_fc_d–‘e_assocŸtiÚ
(
ù¾
);

2528 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

2530 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2531 
	}
}

2533 
boŞ


2534 
	$__nvme_fc_scheduË_d–‘e_wÜk
(
nvme_fc_ù¾
 *
ù¾
)

2536 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_DELETING
))

2537  
Œue
;

2539 ià(!
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
d–‘e_wÜk
))

2540  
Œue
;

2542  
çl£
;

2543 
	}
}

2546 
	$__nvme_fc_d–_ù¾
(
nvme_fc_ù¾
 *
ù¾
)

2548  
	`__nvme_fc_scheduË_d–‘e_wÜk
(
ù¾
è? -
EBUSY
 : 0;

2549 
	}
}

2555 
	$nvme_fc_d–_nvme_ù¾
(
nvme_ù¾
 *
nù¾
)

2557 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2558 
»t
;

2560 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->ù¾.
k»f
))

2561  -
EBUSY
;

2563 
»t
 = 
	`__nvme_fc_d–_ù¾
(
ù¾
);

2565 ià(!
»t
)

2566 
	`æush_wÜkqueue
(
nvme_wq
);

2568 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2570  
»t
;

2571 
	}
}

2574 
	$nvme_fc_»cÚÃù_Ü_d–‘e
(
nvme_fc_ù¾
 *
ù¾
, 
¡©us
)

2577 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_RECONNECTING
) {

2578 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
 ||

2579 
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
);

2583 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2585 
ù¾
->
úum
, 
¡©us
);

2587 ià(
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

2588 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2590 
ù¾
->
úum
, cŒl->ù¾.
İts
->
»cÚÃù_d–ay
);

2591 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
cÚÃù_wÜk
,

2592 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
 * 
HZ
);

2594 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2597 
ù¾
->
úum
, cŒl->ù¾.
Ä_»cÚÃùs
);

2598 
	`WARN_ON
(
	`__nvme_fc_scheduË_d–‘e_wÜk
(
ù¾
));

2600 
	}
}

2603 
	$nvme_fc_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2605 
nvme_fc_ù¾
 *
ù¾
 =

2606 
	`cÚš”_of
(
wÜk
, 
nvme_fc_ù¾
, 
ù¾
.
»£t_wÜk
);

2607 
»t
;

2609 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

2611 
	`nvme_fc_d–‘e_assocŸtiÚ
(
ù¾
);

2613 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

2614 ià(
»t
)

2615 
	`nvme_fc_»cÚÃù_Ü_d–‘e
(
ù¾
, 
»t
);

2617 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2618 "NVME-FC{%d}: cÚŒŞË¸»£ˆcom¶‘e\n", 
ù¾
->
úum
);

2619 
	}
}

2621 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_fc_ù¾_İs
 = {

2622 .
Çme
 = "fc",

2623 .
	gmoduË
 = 
THIS_MODULE
,

2624 .
	gæags
 = 
NVME_F_FABRICS
,

2625 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

2626 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

2627 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

2628 .
	gä“_ù¾
 = 
nvme_fc_nvme_ù¾_ä“d
,

2629 .
	gsubm™_async_ev’t
 = 
nvme_fc_subm™_async_ev’t
,

2630 .
	gd–‘e_ù¾
 = 
nvme_fc_d–_nvme_ù¾
,

2631 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

2635 
	$nvme_fc_cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2637 
»t
;

2639 
nvme_fc_ù¾
 *
ù¾
 =

2640 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

2641 
nvme_fc_ù¾
, 
cÚÃù_wÜk
);

2643 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

2644 ià(
»t
)

2645 
	`nvme_fc_»cÚÃù_Ü_d–‘e
(
ù¾
, 
»t
);

2647 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2649 
ù¾
->
úum
);

2650 
	}
}

2653 cÚ¡ 
blk_mq_İs
 
	gnvme_fc_admš_mq_İs
 = {

2654 .
queue_rq
 = 
nvme_fc_queue_rq
,

2655 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

2656 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

2657 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

2658 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

2659 .
	gš™_hùx
 = 
nvme_fc_š™_admš_hùx
,

2660 .
	gtimeout
 = 
nvme_fc_timeout
,

2664 
nvme_ù¾
 *

2665 
	$nvme_fc_š™_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_İtiÚs
 *
İts
,

2666 
nvme_fc_ÍÜt
 *
ÍÜt
, 
nvme_fc_½Üt
 *
½Üt
)

2668 
nvme_fc_ù¾
 *
ù¾
;

2669 
æags
;

2670 
»t
, 
idx
;

2672 ià(!(
½Üt
->
»mÙ•Üt
.
pÜt_rŞe
 &

2673 (
FC_PORT_ROLE_NVME_DISCOVERY
 | 
FC_PORT_ROLE_NVME_TARGET
))) {

2674 
»t
 = -
EBADR
;

2675 
out_ç
;

2678 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

2679 ià(!
ù¾
) {

2680 
»t
 = -
ENOMEM
;

2681 
out_ç
;

2684 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_ù¾_út
, 0, 0, 
GFP_KERNEL
);

2685 ià(
idx
 < 0) {

2686 
»t
 = -
ENOSPC
;

2687 
out_ä“_ù¾
;

2690 
ù¾
->ù¾.
İts
 = opts;

2691 
	`INIT_LIST_HEAD
(&
ù¾
->
ù¾_li¡
);

2692 
ù¾
->
ÍÜt
 =†port;

2693 
ù¾
->
½Üt
 =„port;

2694 
ù¾
->
dev
 = 
ÍÜt
->dev;

2695 
ù¾
->
úum
 = 
idx
;

2696 
	`š™_wa™queue_h—d
(&
ù¾
->
ißbÜt_wa™
);

2698 
	`g‘_deviû
(
ù¾
->
dev
);

2699 
	`k»f_š™
(&
ù¾
->
»f
);

2701 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_fc_d–‘e_ù¾_wÜk
);

2702 
	`INIT_WORK
(&
ù¾
->ù¾.
»£t_wÜk
, 
nvme_fc_»£t_ù¾_wÜk
);

2703 
	`INIT_DELAYED_WORK
(&
ù¾
->
cÚÃù_wÜk
, 
nvme_fc_cÚÃù_ù¾_wÜk
);

2704 
	`¥š_lock_š™
(&
ù¾
->
lock
);

2707 
ù¾
->ù¾.
queue_couÁ
 = 
	`mš_t
(,

2708 
İts
->
Ä_io_queues
,

2709 
ÍÜt
->
İs
->
max_hw_queues
);

2710 
ù¾
->ù¾.
queue_couÁ
++;

2712 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

2713 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

2715 
»t
 = -
ENOMEM
;

2716 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->ù¾.
queue_couÁ
,

2717 (
nvme_fc_queue
), 
GFP_KERNEL
);

2718 ià(!
ù¾
->
queues
)

2719 
out_ä“_ida
;

2721 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

2722 
ù¾
->
admš_g_£t
.
İs
 = &
nvme_fc_admš_mq_İs
;

2723 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_FC_AQ_BLKMQ_DEPTH
;

2724 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

2725 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

2726 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_fc_fı_İ
) +

2727 (
SG_CHUNK_SIZE
 *

2728 (
sÿ‰”li¡
)) +

2729 
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
;

2730 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

2731 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

2732 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

2734 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

2735 ià(
»t
)

2736 
out_ä“_queues
;

2738 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

2739 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

2740 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

2741 
out_ä“_admš_g_£t
;

2751 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_fc_ù¾_İs
, 0);

2752 ià(
»t
)

2753 
out_ş—nup_admš_q
;

2757 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

2758 
	`li¡_add_
(&
ù¾
->
ù¾_li¡
, &
½Üt
->ctrl_list);

2759 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

2761 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

2762 ià(
»t
) {

2763 
ù¾
->ù¾.
İts
 = 
NULL
;

2765 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

2766 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2769 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2778 
	`nvme_fc_½Üt_g‘
(
½Üt
);

2780 ià(
»t
 > 0)

2781 
»t
 = -
EIO
;

2782  
	`ERR_PTR
(
»t
);

2785 
	`k»f_g‘
(&
ù¾
->ù¾.
k»f
);

2787 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2789 
ù¾
->
úum
, cŒl->ù¾.
İts
->
subsy¢qn
);

2791  &
ù¾
->ctrl;

2793 
out_ş—nup_admš_q
:

2794 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

2795 
out_ä“_admš_g_£t
:

2796 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

2797 
out_ä“_queues
:

2798 
	`kä“
(
ù¾
->
queues
);

2799 
out_ä“_ida
:

2800 
	`put_deviû
(
ù¾
->
dev
);

2801 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

2802 
out_ä“_ù¾
:

2803 
	`kä“
(
ù¾
);

2804 
out_ç
:

2806  
	`ERR_PTR
(
»t
);

2807 
	}
}

2810 
	snvm‘_fc_Œaddr
 {

2811 
u64
 
	mÂ
;

2812 
u64
 
	m²
;

2816 
	$__nvme_fc_·r£_u64
(
sub¡ršg_t
 *
s¡r
, 
u64
 *
v®
)

2818 
u64
 
tok’64
;

2820 ià(
	`m©ch_u64
(
s¡r
, &
tok’64
))

2821  -
EINVAL
;

2822 *
v®
 = 
tok’64
;

2825 
	}
}

2833 
	$nvme_fc_·r£_Œaddr
(
nvm‘_fc_Œaddr
 *
Œaddr
, *
buf
, 
size_t
 
bËn
)

2835 
Çme
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
 + 1];

2836 
sub¡ršg_t
 
wwn
 = { 
Çme
, &name[(name)-1] };

2837 
Âoff£t
, 
²off£t
;

2840 ià(
	`¡ºËn
(
buf
, 
bËn
è=ğ
NVME_FC_TRADDR_MAXLENGTH
 &&

2841 !
	`¡ºcmp
(
buf
, "Â-0x", 
NVME_FC_TRADDR_OXNNLEN
) &&

2842 !
	`¡ºcmp
(&
buf
[
NVME_FC_TRADDR_MAX_PN_OFFSET
],

2843 "²-0x", 
NVME_FC_TRADDR_OXNNLEN
)) {

2844 
Âoff£t
 = 
NVME_FC_TRADDR_OXNNLEN
;

2845 
²off£t
 = 
NVME_FC_TRADDR_MAX_PN_OFFSET
 +

2846 
NVME_FC_TRADDR_OXNNLEN
;

2847 } ià((
	`¡ºËn
(
buf
, 
bËn
è=ğ
NVME_FC_TRADDR_MINLENGTH
 &&

2848 !
	`¡ºcmp
(
buf
, "Â-", 
NVME_FC_TRADDR_NNLEN
) &&

2849 !
	`¡ºcmp
(&
buf
[
NVME_FC_TRADDR_MIN_PN_OFFSET
],

2850 "²-", 
NVME_FC_TRADDR_NNLEN
))) {

2851 
Âoff£t
 = 
NVME_FC_TRADDR_NNLEN
;

2852 
²off£t
 = 
NVME_FC_TRADDR_MIN_PN_OFFSET
 + 
NVME_FC_TRADDR_NNLEN
;

2854 
out_ešv®
;

2856 
Çme
[0] = '0';

2857 
Çme
[1] = 'x';

2858 
Çme
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
] = 0;

2860 
	`memıy
(&
Çme
[2], &
buf
[
Âoff£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

2861 ià(
	`__nvme_fc_·r£_u64
(&
wwn
, &
Œaddr
->
Â
))

2862 
out_ešv®
;

2864 
	`memıy
(&
Çme
[2], &
buf
[
²off£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

2865 ià(
	`__nvme_fc_·r£_u64
(&
wwn
, &
Œaddr
->
²
))

2866 
out_ešv®
;

2870 
out_ešv®
:

2871 
	`´_w¬n
("%s: bad¿dd¸¡ršg\n", 
__func__
);

2872  -
EINVAL
;

2873 
	}
}

2875 
nvme_ù¾
 *

2876 
	$nvme_fc_ü—‹_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_İtiÚs
 *
İts
)

2878 
nvme_fc_ÍÜt
 *
ÍÜt
;

2879 
nvme_fc_½Üt
 *
½Üt
;

2880 
nvme_ù¾
 *
ù¾
;

2881 
nvm‘_fc_Œaddr
 
Ïddr
 = { 0L, 0L };

2882 
nvm‘_fc_Œaddr
 
¿ddr
 = { 0L, 0L };

2883 
æags
;

2884 
»t
;

2886 
»t
 = 
	`nvme_fc_·r£_Œaddr
(&
¿ddr
, 
İts
->
Œaddr
, 
NVMF_TRADDR_SIZE
);

2887 ià(
»t
 || !
¿ddr
.
Â
 || !¿ddr.
²
)

2888  
	`ERR_PTR
(-
EINVAL
);

2890 
»t
 = 
	`nvme_fc_·r£_Œaddr
(&
Ïddr
, 
İts
->
ho¡_Œaddr
, 
NVMF_TRADDR_SIZE
);

2891 ià(
»t
 || !
Ïddr
.
Â
 || !Ïddr.
²
)

2892  
	`ERR_PTR
(-
EINVAL
);

2895 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

2896 
	`li¡_fÜ_—ch_’Œy
(
ÍÜt
, &
nvme_fc_ÍÜt_li¡
, 
pÜt_li¡
) {

2897 ià(
ÍÜt
->
loÿÍÜt
.
node_Çme
 !ğ
Ïddr
.
Â
 ||

2898 
ÍÜt
->
loÿÍÜt
.
pÜt_Çme
 !ğ
Ïddr
.
²
)

2901 
	`li¡_fÜ_—ch_’Œy
(
½Üt
, &
ÍÜt
->
’dp_li¡
,ƒndp_list) {

2902 ià(
½Üt
->
»mÙ•Üt
.
node_Çme
 !ğ
¿ddr
.
Â
 ||

2903 
½Üt
->
»mÙ•Üt
.
pÜt_Çme
 !ğ
¿ddr
.
²
)

2907 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

2910 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

2912 
ù¾
 = 
	`nvme_fc_š™_ù¾
(
dev
, 
İts
, 
ÍÜt
, 
½Üt
);

2913 ià(
	`IS_ERR
(
ù¾
))

2914 
	`nvme_fc_½Üt_put
(
½Üt
);

2915  
ù¾
;

2918 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

2920  
	`ERR_PTR
(-
ENOENT
);

2921 
	}
}

2924 
nvmf_Œª¥Üt_İs
 
	gnvme_fc_Œª¥Üt
 = {

2925 .
Çme
 = "fc",

2926 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
 | 
NVMF_OPT_HOST_TRADDR
,

2927 .
	g®lowed_İts
 = 
NVMF_OPT_RECONNECT_DELAY
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

2928 .
	gü—‹_ù¾
 = 
nvme_fc_ü—‹_ù¾
,

2931 
__š™
 
	$nvme_fc_š™_moduË
()

2933  
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

2934 
	}
}

2936 
__ex™
 
	$nvme_fc_ex™_moduË
()

2939 ià(!
	`li¡_em±y
(&
nvme_fc_ÍÜt_li¡
))

2940 
	`´_w¬n
("%s:†oÿÍÜˆli¡‚Ùƒm±y\n", 
__func__
);

2942 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

2944 
	`ida_de¡roy
(&
nvme_fc_loÿl_pÜt_út
);

2945 
	`ida_de¡roy
(&
nvme_fc_ù¾_út
);

2946 
	}
}

2948 
moduË_š™
(
nvme_fc_š™_moduË
);

2949 
moduË_ex™
(
nvme_fc_ex™_moduË
);

2951 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/lightnvm.c

23 
	~"nvme.h
"

25 
	~"lšux_nvme.h
"

26 
	~<lšux/b™İs.h
>

27 
	~<lšux/lighŠvm.h
>

28 
	~<lšux/vm®loc.h
>

29 
	~<lšux/sched/sysùl.h
>

30 
	~<u­i/lšux/lighŠvm.h
>

32 
	envme_nvm_admš_İcode
 {

33 
	mnvme_nvm_admš_id’t™y
 = 0xe2,

34 
	mnvme_nvm_admš_g‘_l2p_tbl
 = 0xea,

35 
	mnvme_nvm_admš_g‘_bb_tbl
 = 0xf2,

36 
	mnvme_nvm_admš_£t_bb_tbl
 = 0xf1,

39 
	snvme_nvm_hb_rw
 {

40 
__u8
 
	mİcode
;

41 
__u8
 
	mæags
;

42 
__u16
 
	mcommªd_id
;

43 
__Ë32
 
	mnsid
;

44 
__u64
 
	mrsvd2
;

45 
__Ë64
 
	mm‘ad©a
;

46 
__Ë64
 
	m´p1
;

47 
__Ë64
 
	m´p2
;

48 
__Ë64
 
	m¥ba
;

49 
__Ë16
 
	mËngth
;

50 
__Ë16
 
	mcÚŒŞ
;

51 
__Ë32
 
	mdsmgmt
;

52 
__Ë64
 
	m¦ba
;

55 
	snvme_nvm_ph_rw
 {

56 
__u8
 
	mİcode
;

57 
__u8
 
	mæags
;

58 
__u16
 
	mcommªd_id
;

59 
__Ë32
 
	mnsid
;

60 
__u64
 
	mrsvd2
;

61 
__Ë64
 
	mm‘ad©a
;

62 
__Ë64
 
	m´p1
;

63 
__Ë64
 
	m´p2
;

64 
__Ë64
 
	m¥ba
;

65 
__Ë16
 
	mËngth
;

66 
__Ë16
 
	mcÚŒŞ
;

67 
__Ë32
 
	mdsmgmt
;

68 
__Ë64
 
	m»sv
;

71 
	snvme_nvm_id’t™y
 {

72 
__u8
 
	mİcode
;

73 
__u8
 
	mæags
;

74 
__u16
 
	mcommªd_id
;

75 
__Ë32
 
	mnsid
;

76 
__u64
 
	mrsvd
[2];

77 
__Ë64
 
	m´p1
;

78 
__Ë64
 
	m´p2
;

79 
__Ë32
 
	mchÆ_off
;

80 
__u32
 
	mrsvd11
[5];

83 
	snvme_nvm_l2±bl
 {

84 
__u8
 
	mİcode
;

85 
__u8
 
	mæags
;

86 
__u16
 
	mcommªd_id
;

87 
__Ë32
 
	mnsid
;

88 
__Ë32
 
	mcdw2
[4];

89 
__Ë64
 
	m´p1
;

90 
__Ë64
 
	m´p2
;

91 
__Ë64
 
	m¦ba
;

92 
__Ë32
 
	mÆb
;

93 
__Ë16
 
	mcdw14
[6];

96 
	snvme_nvm_g‘bbtbl
 {

97 
__u8
 
	mİcode
;

98 
__u8
 
	mæags
;

99 
__u16
 
	mcommªd_id
;

100 
__Ë32
 
	mnsid
;

101 
__u64
 
	mrsvd
[2];

102 
__Ë64
 
	m´p1
;

103 
__Ë64
 
	m´p2
;

104 
__Ë64
 
	m¥ba
;

105 
__u32
 
	mrsvd4
[4];

108 
	snvme_nvm_£tbbtbl
 {

109 
__u8
 
	mİcode
;

110 
__u8
 
	mæags
;

111 
__u16
 
	mcommªd_id
;

112 
__Ë32
 
	mnsid
;

113 
__Ë64
 
	mrsvd
[2];

114 
__Ë64
 
	m´p1
;

115 
__Ë64
 
	m´p2
;

116 
__Ë64
 
	m¥ba
;

117 
__Ë16
 
	mÆb
;

118 
__u8
 
	mv®ue
;

119 
__u8
 
	mrsvd3
;

120 
__u32
 
	mrsvd4
[3];

123 
	snvme_nvm_”a£_blk
 {

124 
__u8
 
	mİcode
;

125 
__u8
 
	mæags
;

126 
__u16
 
	mcommªd_id
;

127 
__Ë32
 
	mnsid
;

128 
__u64
 
	mrsvd
[2];

129 
__Ë64
 
	m´p1
;

130 
__Ë64
 
	m´p2
;

131 
__Ë64
 
	m¥ba
;

132 
__Ë16
 
	mËngth
;

133 
__Ë16
 
	mcÚŒŞ
;

134 
__Ë32
 
	mdsmgmt
;

135 
__Ë64
 
	m»sv
;

138 
	snvme_nvm_commªd
 {

140 
nvme_commÚ_commªd
 
	mcommÚ
;

141 
nvme_nvm_id’t™y
 
	mid’t™y
;

142 
nvme_nvm_hb_rw
 
	mhb_rw
;

143 
nvme_nvm_ph_rw
 
	mph_rw
;

144 
nvme_nvm_l2±bl
 
	ml2p
;

145 
nvme_nvm_g‘bbtbl
 
	mg‘_bb
;

146 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

147 
nvme_nvm_”a£_blk
 
	m”a£
;

151 
	#NVME_NVM_LP_MLC_PAIRS
 886

	)

152 
	snvme_nvm_Í_mlc
 {

153 
__Ë16
 
	mnum_·œs
;

154 
__u8
 
	m·œs
[
NVME_NVM_LP_MLC_PAIRS
];

157 
	snvme_nvm_Í_tbl
 {

158 
__u8
 
	mid
[8];

159 
nvme_nvm_Í_mlc
 
	mmlc
;

162 
	snvme_nvm_id_group
 {

163 
__u8
 
	mmty³
;

164 
__u8
 
	mfmty³
;

165 
__Ë16
 
	m»s16
;

166 
__u8
 
	mnum_ch
;

167 
__u8
 
	mnum_lun
;

168 
__u8
 
	mnum_¶n
;

169 
__u8
 
	mrsvd1
;

170 
__Ë16
 
	mnum_blk
;

171 
__Ë16
 
	mnum_pg
;

172 
__Ë16
 
	måg_sz
;

173 
__Ë16
 
	mc£cs
;

174 
__Ë16
 
	msos
;

175 
__Ë16
 
	mrsvd2
;

176 
__Ë32
 
	mŒdt
;

177 
__Ë32
 
	mŒdm
;

178 
__Ë32
 
	m¹
;

179 
__Ë32
 
	mrm
;

180 
__Ë32
 
	mtb‘
;

181 
__Ë32
 
	mtbem
;

182 
__Ë32
 
	mmpos
;

183 
__Ë32
 
	mmcÿp
;

184 
__Ë16
 
	mı¬
;

185 
__u8
 
	m»£rved
[10];

186 
nvme_nvm_Í_tbl
 
	mÍtbl
;

187 } 
	g__·cked
;

189 
	snvme_nvm_addr_fÜm©
 {

190 
__u8
 
	mch_off£t
;

191 
__u8
 
	mch_Ën
;

192 
__u8
 
	mlun_off£t
;

193 
__u8
 
	mlun_Ën
;

194 
__u8
 
	m¶n_off£t
;

195 
__u8
 
	m¶n_Ën
;

196 
__u8
 
	mblk_off£t
;

197 
__u8
 
	mblk_Ën
;

198 
__u8
 
	mpg_off£t
;

199 
__u8
 
	mpg_Ën
;

200 
__u8
 
	m£ù_off£t
;

201 
__u8
 
	m£ù_Ën
;

202 
__u8
 
	m»s
[4];

203 } 
	g__·cked
;

205 
	snvme_nvm_id
 {

206 
__u8
 
	mv”_id
;

207 
__u8
 
	mvmÁ
;

208 
__u8
 
	mcg½s
;

209 
__u8
 
	m»s
;

210 
__Ë32
 
	mÿp
;

211 
__Ë32
 
	mdom
;

212 
nvme_nvm_addr_fÜm©
 
	mµaf
;

213 
__u8
 
	m»sv
[228];

214 
nvme_nvm_id_group
 
	mgroups
[4];

215 } 
	g__·cked
;

217 
	snvme_nvm_bb_tbl
 {

218 
__u8
 
	mtblid
[4];

219 
__Ë16
 
	mv”id
;

220 
__Ë16
 
	m»vid
;

221 
__Ë32
 
	mrvsd1
;

222 
__Ë32
 
	mtblks
;

223 
__Ë32
 
	mtçù
;

224 
__Ë32
 
	mtgrown
;

225 
__Ë32
 
	mtd»sv
;

226 
__Ë32
 
	mth»sv
;

227 
__Ë32
 
	mrsvd2
[8];

228 
__u8
 
	mblk
[0];

234 
šlše
 
	$_nvme_nvm_check_size
()

236 
	`BUILD_BUG_ON
((
nvme_nvm_id’t™y
) != 64);

237 
	`BUILD_BUG_ON
((
nvme_nvm_hb_rw
) != 64);

238 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

239 
	`BUILD_BUG_ON
((
nvme_nvm_g‘bbtbl
) != 64);

240 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

241 
	`BUILD_BUG_ON
((
nvme_nvm_l2±bl
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_nvm_”a£_blk
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_nvm_id_group
) != 960);

244 
	`BUILD_BUG_ON
((
nvme_nvm_addr_fÜm©
) != 16);

245 
	`BUILD_BUG_ON
((
nvme_nvm_id
è!ğ
NVME_IDENTIFY_DATA_SIZE
);

246 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 64);

247 
	}
}

249 
	$š™_g½s
(
nvm_id
 *nvm_id, 
nvme_nvm_id
 *nvme_nvm_id)

251 
nvme_nvm_id_group
 *
¤c
;

252 
nvm_id_group
 *
d¡
;

254 ià(
nvme_nvm_id
->
cg½s
 != 1)

255  -
EINVAL
;

257 
¤c
 = &
nvme_nvm_id
->
groups
[0];

258 
d¡
 = &
nvm_id
->
g½
;

260 
d¡
->
mty³
 = 
¤c
->mtype;

261 
d¡
->
fmty³
 = 
¤c
->fmtype;

262 
d¡
->
num_ch
 = 
¤c
->num_ch;

263 
d¡
->
num_lun
 = 
¤c
->num_lun;

264 
d¡
->
num_¶n
 = 
¤c
->num_pln;

266 
d¡
->
num_pg
 = 
	`Ë16_to_ıu
(
¤c
->num_pg);

267 
d¡
->
num_blk
 = 
	`Ë16_to_ıu
(
¤c
->num_blk);

268 
d¡
->
åg_sz
 = 
	`Ë16_to_ıu
(
¤c
->fpg_sz);

269 
d¡
->
c£cs
 = 
	`Ë16_to_ıu
(
¤c
->csecs);

270 
d¡
->
sos
 = 
	`Ë16_to_ıu
(
¤c
->sos);

272 
d¡
->
Œdt
 = 
	`Ë32_to_ıu
(
¤c
->trdt);

273 
d¡
->
Œdm
 = 
	`Ë32_to_ıu
(
¤c
->trdm);

274 
d¡
->
¹
 = 
	`Ë32_to_ıu
(
¤c
->tprt);

275 
d¡
->
rm
 = 
	`Ë32_to_ıu
(
¤c
->tprm);

276 
d¡
->
tb‘
 = 
	`Ë32_to_ıu
(
¤c
->tbet);

277 
d¡
->
tbem
 = 
	`Ë32_to_ıu
(
¤c
->tbem);

278 
d¡
->
mpos
 = 
	`Ë32_to_ıu
(
¤c
->mpos);

279 
d¡
->
mcÿp
 = 
	`Ë32_to_ıu
(
¤c
->mccap);

281 
d¡
->
ı¬
 = 
	`Ë16_to_ıu
(
¤c
->cpar);

283 ià(
d¡
->
fmty³
 =ğ
NVM_ID_FMTYPE_MLC
) {

284 
	`memıy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

285 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

286 
	`Ë16_to_ıu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

288 ià(
d¡
->
Ítbl
.
mlc
.
num_·œs
 > 
NVME_NVM_LP_MLC_PAIRS
) {

289 
	`´_”r
("nvm:‚umber of MLC…airs‚ot supported\n");

290  -
EINVAL
;

293 
	`memıy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

294 
d¡
->
Ítbl
.
mlc
.
num_·œs
);

298 
	}
}

300 
	$nvme_nvm_id’t™y
(
nvm_dev
 *
nvmdev
, 
nvm_id
 *nvm_id)

302 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

303 
nvme_nvm_id
 *nvme_nvm_id;

304 
nvme_nvm_commªd
 
c
 = {};

305 
»t
;

307 
c
.
id’t™y
.
İcode
 = 
nvme_nvm_admš_id’t™y
;

308 
c
.
id’t™y
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

309 
c
.
id’t™y
.
chÆ_off
 = 0;

311 
nvme_nvm_id
 = 
	`km®loc
((nvme_nvm_id), 
GFP_KERNEL
);

312 ià(!
nvme_nvm_id
)

313  -
ENOMEM
;

315 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

316 
nvme_nvm_id
, (nvme_nvm_id));

317 ià(
»t
) {

318 
»t
 = -
EIO
;

319 
out
;

322 
nvm_id
->
v”_id
 = 
nvme_nvm_id
->ver_id;

323 
nvm_id
->
vmÁ
 = 
nvme_nvm_id
->vmnt;

324 
nvm_id
->
ÿp
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->cap);

325 
nvm_id
->
dom
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->dom);

326 
	`memıy
(&
nvm_id
->
µaf
, &
nvme_nvm_id
->ppaf,

327 (
nvm_addr_fÜm©
));

329 
»t
 = 
	`š™_g½s
(
nvm_id
, 
nvme_nvm_id
);

330 
out
:

331 
	`kä“
(
nvme_nvm_id
);

332  
»t
;

333 
	}
}

335 
	$nvme_nvm_g‘_l2p_tbl
(
nvm_dev
 *
nvmdev
, 
u64
 
¦ba
, 
u32
 
Æb
,

336 
nvm_l2p_upd©e_â
 *
upd©e_l2p
, *
´iv
)

338 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

339 
nvme_nvm_commªd
 
c
 = {};

340 
u32
 
Ën
 = 
	`queue_max_hw_£ùÜs
(
ns
->
ù¾
->
admš_q
) << 9;

341 
u32
 
Æb_´_rq
 = 
Ën
 / (
u64
);

342 
u64
 
cmd_¦ba
 = 
¦ba
;

343 *
’Œ›s
;

344 
»t
 = 0;

346 
c
.
l2p
.
İcode
 = 
nvme_nvm_admš_g‘_l2p_tbl
;

347 
c
.
l2p
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

348 
’Œ›s
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

349 ià(!
’Œ›s
)

350  -
ENOMEM
;

352 
Æb
) {

353 
u32
 
cmd_Æb
 = 
	`mš
(
Æb_´_rq
, 
Æb
);

354 
u64
 
–ba
 = 
¦ba
 + 
cmd_Æb
;

356 
c
.
l2p
.
¦ba
 = 
	`ıu_to_Ë64
(
cmd_¦ba
);

357 
c
.
l2p
.
Æb
 = 
	`ıu_to_Ë32
(
cmd_Æb
);

359 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
,

360 (
nvme_commªd
 *)&
c
, 
’Œ›s
, 
Ën
);

361 ià(
»t
) {

362 
	`dev_”r
(
ns
->
ù¾
->
deviû
,

363 "L2PabË¿nsã¸çed (%d)\n", 
»t
);

364 
»t
 = -
EIO
;

365 
out
;

368 ià(
	`uÆik–y
(
–ba
 > 
nvmdev
->
tÙ®_£cs
)) {

369 
	`´_”r
("nvm: L2P data from device is out of bounds!\n");

370 
»t
 = -
EINVAL
;

371 
out
;

375 
	`nvm_·¹_to_tgt
(
nvmdev
, 
’Œ›s
, 
cmd_Æb
);

377 ià(
	`upd©e_l2p
(
cmd_¦ba
, 
cmd_Æb
, 
’Œ›s
, 
´iv
)) {

378 
»t
 = -
EINTR
;

379 
out
;

382 
cmd_¦ba
 +ğ
cmd_Æb
;

383 
Æb
 -ğ
cmd_Æb
;

386 
out
:

387 
	`kä“
(
’Œ›s
);

388  
»t
;

389 
	}
}

391 
	$nvme_nvm_g‘_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

392 
u8
 *
blks
)

394 
»que¡_queue
 *
q
 = 
nvmdev
->q;

395 
nvm_geo
 *
geo
 = &
nvmdev
->geo;

396 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

397 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

398 
nvme_nvm_commªd
 
c
 = {};

399 
nvme_nvm_bb_tbl
 *
bb_tbl
;

400 
Ä_blks
 = 
geo
->
blks_³r_lun
 * geo->
¶ªe_mode
;

401 
tblsz
 = (
nvme_nvm_bb_tbl
è+ 
Ä_blks
;

402 
»t
 = 0;

404 
c
.
g‘_bb
.
İcode
 = 
nvme_nvm_admš_g‘_bb_tbl
;

405 
c
.
g‘_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

406 
c
.
g‘_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µa
.ppa);

408 
bb_tbl
 = 
	`kz®loc
(
tblsz
, 
GFP_KERNEL
);

409 ià(!
bb_tbl
)

410  -
ENOMEM
;

412 
»t
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

413 
bb_tbl
, 
tblsz
);

414 ià(
»t
) {

415 
	`dev_”r
(
ù¾
->
deviû
, "g‘ bad blockabË faed (%d)\n", 
»t
);

416 
»t
 = -
EIO
;

417 
out
;

420 ià(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

421 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

422 
	`dev_”r
(
ù¾
->
deviû
, "bbt format mismatch\n");

423 
»t
 = -
EINVAL
;

424 
out
;

427 ià(
	`Ë16_to_ıu
(
bb_tbl
->
v”id
) != 1) {

428 
»t
 = -
EINVAL
;

429 
	`dev_”r
(
ù¾
->
deviû
, "bbt version‚ot supported\n");

430 
out
;

433 ià(
	`Ë32_to_ıu
(
bb_tbl
->
tblks
è!ğ
Ä_blks
) {

434 
»t
 = -
EINVAL
;

435 
	`dev_”r
(
ù¾
->
deviû
,

437 
	`Ë32_to_ıu
(
bb_tbl
->
tblks
), 
Ä_blks
);

438 
out
;

441 
	`memıy
(
blks
, 
bb_tbl
->
blk
, 
geo
->
blks_³r_lun
 * geo->
¶ªe_mode
);

442 
out
:

443 
	`kä“
(
bb_tbl
);

444  
»t
;

445 
	}
}

447 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 *
µas
,

448 
Ä_µas
, 
ty³
)

450 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

451 
nvme_nvm_commªd
 
c
 = {};

452 
»t
 = 0;

454 
c
.
£t_bb
.
İcode
 = 
nvme_nvm_admš_£t_bb_tbl
;

455 
c
.
£t_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

456 
c
.
£t_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µas
->
µa
);

457 
c
.
£t_bb
.
Æb
 = 
	`ıu_to_Ë16
(
Ä_µas
 - 1);

458 
c
.
£t_bb
.
v®ue
 = 
ty³
;

460 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

461 
NULL
, 0);

462 ià(
»t
)

463 
	`dev_”r
(
ns
->
ù¾
->
deviû
, "set bad blockable failed (%d)\n",

464 
»t
);

465  
»t
;

466 
	}
}

468 
šlše
 
	$nvme_nvm_rqtocmd
(
nvm_rq
 *
rqd
, 
nvme_ns
 *
ns
,

469 
nvme_nvm_commªd
 *
c
)

471 
c
->
ph_rw
.
İcode
 = 
rqd
->opcode;

472 
c
->
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

473 
c
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

474 
c
->
ph_rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
rqd
->
dma_m‘a_li¡
);

475 
c
->
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
rqd
->
æags
);

476 
c
->
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_µas
 - 1);

478 ià(
rqd
->
İcode
 =ğ
NVM_OP_HBWRITE
 ||„qd->İcod=ğ
NVM_OP_HBREAD
)

479 
c
->
hb_rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
,

480 
rqd
->
bio
->
bi_™”
.
bi_£ùÜ
));

481 
	}
}

483 
	$nvme_nvm_’d_io
(
»que¡
 *
rq
, 
blk_¡©us_t
 
¡©us
)

485 
nvm_rq
 *
rqd
 = 
rq
->
’d_io_d©a
;

487 
rqd
->
µa_¡©us
 = 
	`Ë64_to_ıu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

488 
rqd
->
”rÜ
 = 
	`nvme_»q
(
rq
)->
¡©us
;

489 
	`nvm_’d_io
(
rqd
);

491 
	`kä“
(
	`nvme_»q
(
rq
)->
cmd
);

492 
	`blk_mq_ä“_»que¡
(
rq
);

493 
	}
}

495 
	$nvme_nvm_subm™_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

497 
»que¡_queue
 *
q
 = 
dev
->q;

498 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

499 
»que¡
 *
rq
;

500 
bio
 *biØğ
rqd
->bio;

501 
nvme_nvm_commªd
 *
cmd
;

503 
cmd
 = 
	`kz®loc
((
nvme_nvm_commªd
), 
GFP_KERNEL
);

504 ià(!
cmd
)

505  -
ENOMEM
;

507 
	`nvme_nvm_rqtocmd
(
rqd
, 
ns
, 
cmd
);

509 
rq
 = 
	`nvme_®loc_»que¡
(
q
, (
nvme_commªd
 *)
cmd
, 0, 
NVME_QID_ANY
);

510 ià(
	`IS_ERR
(
rq
)) {

511 
	`kä“
(
cmd
);

512  
	`PTR_ERR
(
rq
);

514 
rq
->
cmd_æags
 &ğ~
REQ_FAILFAST_DRIVER
;

516 ià(
bio
) {

517 
	`blk_š™_»que¡_äom_bio
(
rq
, 
bio
);

519 
rq
->
iİrio
 = 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
IOPRIO_NORM
);

520 
rq
->
__d©a_Ën
 = 0;

523 
rq
->
’d_io_d©a
 = 
rqd
;

525 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_’d_io
);

528 
	}
}

530 *
	$nvme_nvm_ü—‹_dma_poŞ
(
nvm_dev
 *
nvmdev
, *
Çme
)

532 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

534  
	`dma_poŞ_ü—‹
(
Çme
, 
ns
->
ù¾
->
dev
, 
PAGE_SIZE
, PAGE_SIZE, 0);

535 
	}
}

537 
	$nvme_nvm_de¡roy_dma_poŞ
(*
poŞ
)

539 
dma_poŞ
 *dma_poŞ = 
poŞ
;

541 
	`dma_poŞ_de¡roy
(
dma_poŞ
);

542 
	}
}

544 *
	$nvme_nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, *
poŞ
,

545 
gå_t
 
mem_æags
, 
dma_addr_t
 *
dma_hªdËr
)

547  
	`dma_poŞ_®loc
(
poŞ
, 
mem_æags
, 
dma_hªdËr
);

548 
	}
}

550 
	$nvme_nvm_dev_dma_ä“
(*
poŞ
, *
addr
,

551 
dma_addr_t
 
dma_hªdËr
)

553 
	`dma_poŞ_ä“
(
poŞ
, 
addr
, 
dma_hªdËr
);

554 
	}
}

556 
nvm_dev_İs
 
	gnvme_nvm_dev_İs
 = {

557 .
id’t™y
 = 
nvme_nvm_id’t™y
,

559 .
	gg‘_l2p_tbl
 = 
nvme_nvm_g‘_l2p_tbl
,

561 .
	gg‘_bb_tbl
 = 
nvme_nvm_g‘_bb_tbl
,

562 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

564 .
	gsubm™_io
 = 
nvme_nvm_subm™_io
,

566 .
	gü—‹_dma_poŞ
 = 
nvme_nvm_ü—‹_dma_poŞ
,

567 .
	gde¡roy_dma_poŞ
 = 
nvme_nvm_de¡roy_dma_poŞ
,

568 .
	gdev_dma_®loc
 = 
nvme_nvm_dev_dma_®loc
,

569 .
	gdev_dma_ä“
 = 
nvme_nvm_dev_dma_ä“
,

571 .
	gmax_phys_£ù
 = 64,

574 
	$nvme_nvm_subm™_u£r_cmd
(
»que¡_queue
 *
q
,

575 
nvme_ns
 *
ns
,

576 
nvme_nvm_commªd
 *
vcmd
,

577 
__u£r
 *
ubuf
, 
bufæ’
,

578 
__u£r
 *
m‘a_buf
, 
m‘a_Ën
,

579 
__u£r
 *
µa_buf
, 
µa_Ën
,

580 
u32
 *
»suÉ
, 
u64
 *
¡©us
, 
timeout
)

582 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
((
nvme_commªd
 *)
vcmd
);

583 
nvm_dev
 *
dev
 = 
ns
->
ndev
;

584 
g’disk
 *
disk
 = 
ns
->disk;

585 
»que¡
 *
rq
;

586 
bio
 *biØğ
NULL
;

587 
__Ë64
 *
µa_li¡
 = 
NULL
;

588 
dma_addr_t
 
µa_dma
;

589 
__Ë64
 *
m‘ad©a
 = 
NULL
;

590 
dma_addr_t
 
m‘ad©a_dma
;

591 
	`DECLARE_COMPLETION_ONSTACK
(
wa™
);

592 
»t
 = 0;

594 
rq
 = 
	`nvme_®loc_»que¡
(
q
, (
nvme_commªd
 *)
vcmd
, 0,

595 
NVME_QID_ANY
);

596 ià(
	`IS_ERR
(
rq
)) {

597 
»t
 = -
ENOMEM
;

598 
”r_cmd
;

601 
rq
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

603 
rq
->
cmd_æags
 &ğ~
REQ_FAILFAST_DRIVER
;

605 ià(
µa_buf
 && 
µa_Ën
) {

606 
µa_li¡
 = 
	`dma_poŞ_®loc
(
dev
->
dma_poŞ
, 
GFP_KERNEL
, &
µa_dma
);

607 ià(!
µa_li¡
) {

608 
»t
 = -
ENOMEM
;

609 
”r_rq
;

611 ià(
	`cİy_äom_u£r
(
µa_li¡
, (
__u£r
 *)
µa_buf
,

612 (
u64
è* (
µa_Ën
 + 1))) {

613 
»t
 = -
EFAULT
;

614 
”r_µa
;

616 
vcmd
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
µa_dma
);

618 
vcmd
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
((
ušŒ_t
)
µa_buf
);

621 ià(
ubuf
 && 
bufæ’
) {

622 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
rq
, 
NULL
, 
ubuf
, 
bufæ’
, 
GFP_KERNEL
);

623 ià(
»t
)

624 
”r_µa
;

625 
bio
 = 
rq
->bio;

627 ià(
m‘a_buf
 && 
m‘a_Ën
) {

628 
m‘ad©a
 = 
	`dma_poŞ_®loc
(
dev
->
dma_poŞ
, 
GFP_KERNEL
,

629 &
m‘ad©a_dma
);

630 ià(!
m‘ad©a
) {

631 
»t
 = -
ENOMEM
;

632 
”r_m­
;

635 ià(
wr™e
) {

636 ià(
	`cİy_äom_u£r
(
m‘ad©a
,

637 (
__u£r
 *)
m‘a_buf
,

638 
m‘a_Ën
)) {

639 
»t
 = -
EFAULT
;

640 
”r_m‘a
;

643 
vcmd
->
ph_rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
m‘ad©a_dma
);

646 ià(!
disk
)

647 
subm™
;

649 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

650 ià(!
bio
->
bi_bdev
) {

651 
»t
 = -
ENODEV
;

652 
”r_m‘a
;

656 
subm™
:

657 
	`blk_execu‹_rq
(
q
, 
NULL
, 
rq
, 0);

659 ià(
	`nvme_»q
(
rq
)->
æags
 & 
NVME_REQ_CANCELLED
)

660 
»t
 = -
EINTR
;

661 ià(
	`nvme_»q
(
rq
)->
¡©us
 & 0x7ff)

662 
»t
 = -
EIO
;

663 ià(
»suÉ
)

664 *
»suÉ
 = 
	`nvme_»q
(
rq
)->
¡©us
 & 0x7ff;

665 ià(
¡©us
)

666 *
¡©us
 = 
	`Ë64_to_ıu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

668 ià(
m‘ad©a
 && !
»t
 && !
wr™e
) {

669 ià(
	`cİy_to_u£r
(
m‘a_buf
, (*)
m‘ad©a
, 
m‘a_Ën
))

670 
»t
 = -
EFAULT
;

672 
”r_m‘a
:

673 ià(
m‘a_buf
 && 
m‘a_Ën
)

674 
	`dma_poŞ_ä“
(
dev
->
dma_poŞ
, 
m‘ad©a
, 
m‘ad©a_dma
);

675 
”r_m­
:

676 ià(
bio
) {

677 ià(
disk
 && 
bio
->
bi_bdev
)

678 
	`bdput
(
bio
->
bi_bdev
);

679 
	`blk_rq_unm­_u£r
(
bio
);

681 
”r_µa
:

682 ià(
µa_buf
 && 
µa_Ën
)

683 
	`dma_poŞ_ä“
(
dev
->
dma_poŞ
, 
µa_li¡
, 
µa_dma
);

684 
”r_rq
:

685 
	`blk_mq_ä“_»que¡
(
rq
);

686 
”r_cmd
:

687  
»t
;

688 
	}
}

690 
	$nvme_nvm_subm™_vio
(
nvme_ns
 *
ns
,

691 
nvm_u£r_vio
 
__u£r
 *
uvio
)

693 
nvm_u£r_vio
 
vio
;

694 
nvme_nvm_commªd
 
c
;

695 
Ëngth
;

696 
»t
;

698 ià(
	`cİy_äom_u£r
(&
vio
, 
uvio
, (vio)))

699  -
EFAULT
;

700 ià(
vio
.
æags
)

701  -
EINVAL
;

703 
	`mem£t
(&
c
, 0, (c));

704 
c
.
ph_rw
.
İcode
 = 
vio
.opcode;

705 
c
.
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

706 
c
.
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
vio
.control);

707 
c
.
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
vio
.
Å·s
);

709 
Ëngth
 = (
vio
.
Å·s
 + 1è<< 
ns
->
lba_shiá
;

711 
»t
 = 
	`nvme_nvm_subm™_u£r_cmd
(
ns
->
queue
,‚s, &
c
,

712 (
__u£r
 *)(
ušŒ_t
)
vio
.
addr
, 
Ëngth
,

713 (
__u£r
 *)(
ušŒ_t
)
vio
.
m‘ad©a
,

714 
vio
.
m‘ad©a_Ën
,

715 (
__u£r
 *)(
ušŒ_t
)
vio
.
µa_li¡
, vio.
Å·s
,

716 &
vio
.
»suÉ
, &vio.
¡©us
, 0);

718 ià(
»t
 && 
	`cİy_to_u£r
(
uvio
, &
vio
, (vio)))

719  -
EFAULT
;

721  
»t
;

722 
	}
}

724 
	$nvme_nvm_u£r_vcmd
(
nvme_ns
 *
ns
, 
admš
,

725 
nvm_·s¡hru_vio
 
__u£r
 *
uvcmd
)

727 
nvm_·s¡hru_vio
 
vcmd
;

728 
nvme_nvm_commªd
 
c
;

729 
»que¡_queue
 *
q
;

730 
timeout
 = 0;

731 
»t
;

733 ià(
	`cİy_äom_u£r
(&
vcmd
, 
uvcmd
, (vcmd)))

734  -
EFAULT
;

735 ià((
vcmd
.
İcode
 !ğ0xF2è&& (!
	`ÿ·bË
(
CAP_SYS_ADMIN
)))

736  -
EACCES
;

737 ià(
vcmd
.
æags
)

738  -
EINVAL
;

740 
	`mem£t
(&
c
, 0, (c));

741 
c
.
commÚ
.
İcode
 = 
vcmd
.opcode;

742 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

743 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
vcmd
.cdw2);

744 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
vcmd
.
cdw3
);

746 
c
.
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
vcmd
.
Å·s
);

747 
c
.
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
vcmd
.control);

748 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
vcmd
.
cdw13
);

749 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
vcmd
.
cdw14
);

750 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
vcmd
.
cdw15
);

752 ià(
vcmd
.
timeout_ms
)

753 
timeout
 = 
	`m£cs_to_jiff›s
(
vcmd
.
timeout_ms
);

755 
q
 = 
admš
 ? 
ns
->
ù¾
->
admš_q
 :‚s->
queue
;

757 
»t
 = 
	`nvme_nvm_subm™_u£r_cmd
(
q
, 
ns
,

758 (
nvme_nvm_commªd
 *)&
c
,

759 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
addr
, vcmd.
d©a_Ën
,

760 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
m‘ad©a
,

761 
vcmd
.
m‘ad©a_Ën
,

762 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
µa_li¡
, vcmd.
Å·s
,

763 &
vcmd
.
»suÉ
, &vcmd.
¡©us
, 
timeout
);

765 ià(
»t
 && 
	`cİy_to_u£r
(
uvcmd
, &
vcmd
, (vcmd)))

766  -
EFAULT
;

768  
»t
;

769 
	}
}

771 
	$nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
)

773 
cmd
) {

774 
NVME_NVM_IOCTL_ADMIN_VIO
:

775  
	`nvme_nvm_u£r_vcmd
(
ns
, 1, (
__u£r
 *)
¬g
);

776 
NVME_NVM_IOCTL_IO_VIO
:

777  
	`nvme_nvm_u£r_vcmd
(
ns
, 0, (
__u£r
 *)
¬g
);

778 
NVME_NVM_IOCTL_SUBMIT_VIO
:

779  
	`nvme_nvm_subm™_vio
(
ns
, (
__u£r
 *)
¬g
);

781  -
ENOTTY
;

783 
	}
}

785 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
)

787 
»que¡_queue
 *
q
 = 
ns
->
queue
;

788 
nvm_dev
 *
dev
;

790 
	`_nvme_nvm_check_size
();

792 
dev
 = 
	`nvm_®loc_dev
(
node
);

793 ià(!
dev
)

794  -
ENOMEM
;

796 
dev
->
q
 = q;

797 
	`memıy
(
dev
->
Çme
, 
disk_Çme
, 
DISK_NAME_LEN
);

798 
dev
->
İs
 = &
nvme_nvm_dev_İs
;

799 
dev
->
´iv©e_d©a
 = 
ns
;

800 
ns
->
ndev
 = 
dev
;

802  
	`nvm_»gi¡”
(
dev
);

803 
	}
}

805 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
)

807 
	`nvm_uÄegi¡”
(
ns
->
ndev
);

808 
	}
}

810 
ssize_t
 
	$nvm_dev_©Œ_show
(
deviû
 *
dev
,

811 
deviû_©Œibu‹
 *
d©Œ
, *
·ge
)

813 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

814 
nvm_dev
 *
ndev
 = 
ns
->ndev;

815 
nvm_id
 *
id
;

816 
nvm_id_group
 *
g½
;

817 
©Œibu‹
 *
©Œ
;

819 ià(!
ndev
)

822 
id
 = &
ndev
->
id’t™y
;

823 
g½
 = &
id
->grp;

824 
©Œ
 = &
d©Œ
->attr;

826 ià(
	`¡rcmp
(
©Œ
->
Çme
, "version") == 0) {

827  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
v”_id
);

828 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "vendor_opcode") == 0) {

829  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
vmÁ
);

830 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "capabilities") == 0) {

831  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
ÿp
);

832 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "device_mode") == 0) {

833  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
dom
);

835 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_manager") == 0) {

836  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%s\n", "gennvm");

837 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "ppa_format") == 0) {

838  
	`sú´štf
(
·ge
, 
PAGE_SIZE
,

840 
id
->
µaf
.
ch_off£t
, id->µaf.
ch_Ën
,

841 
id
->
µaf
.
lun_off£t
, id->µaf.
lun_Ën
,

842 
id
->
µaf
.
¶n_off£t
, id->µaf.
¶n_Ën
,

843 
id
->
µaf
.
blk_off£t
, id->µaf.
blk_Ën
,

844 
id
->
µaf
.
pg_off£t
, id->µaf.
pg_Ën
,

845 
id
->
µaf
.
£ù_off£t
, id->µaf.
£ù_Ën
);

846 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_type") == 0) {

847  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
mty³
);

848 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "flash_media_type") == 0) {

849  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
fmty³
);

850 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_channels") == 0) {

851  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_ch
);

852 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_luns") == 0) {

853  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_lun
);

854 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_planes") == 0) {

855  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_¶n
);

856 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_blocks") == 0) {

857  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_blk
);

858 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_pages") == 0) {

859  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_pg
);

860 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "page_size") == 0) {

861  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
åg_sz
);

862 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "hw_sector_size") == 0) {

863  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
c£cs
);

864 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "oob_sector_size") == 0) {

865  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
sos
);

866 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "read_typ") == 0) {

867  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
Œdt
);

868 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "read_max") == 0) {

869  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
Œdm
);

870 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "prog_typ") == 0) {

871  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
¹
);

872 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "prog_max") == 0) {

873  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
rm
);

874 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "erase_typ") == 0) {

875  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
tb‘
);

876 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "erase_max") == 0) {

877  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
tbem
);

878 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "multiplane_modes") == 0) {

879  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "0x%08x\n", 
g½
->
mpos
);

880 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_capabilities") == 0) {

881  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "0x%08x\n", 
g½
->
mcÿp
);

882 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "max_phys_secs") == 0) {

883  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n",

884 
ndev
->
İs
->
max_phys_£ù
);

886  
	`sú´štf
(
·ge
,

887 
PAGE_SIZE
,

889 
©Œ
->
Çme
);

891 
	}
}

893 
	#NVM_DEV_ATTR_RO
(
_Çme
) \

894 
	`DEVICE_ATTR
(
_Çme
, 
S_IRUGO
, 
nvm_dev_©Œ_show
, 
NULL
)

	)

896 
NVM_DEV_ATTR_RO
(
v”siÚ
);

897 
NVM_DEV_ATTR_RO
(
v’dÜ_İcode
);

898 
NVM_DEV_ATTR_RO
(
ÿ·b™›s
);

899 
NVM_DEV_ATTR_RO
(
deviû_mode
);

900 
NVM_DEV_ATTR_RO
(
µa_fÜm©
);

901 
NVM_DEV_ATTR_RO
(
medŸ_mªag”
);

903 
NVM_DEV_ATTR_RO
(
medŸ_ty³
);

904 
NVM_DEV_ATTR_RO
(
æash_medŸ_ty³
);

905 
NVM_DEV_ATTR_RO
(
num_chªÃls
);

906 
NVM_DEV_ATTR_RO
(
num_luns
);

907 
NVM_DEV_ATTR_RO
(
num_¶ªes
);

908 
NVM_DEV_ATTR_RO
(
num_blocks
);

909 
NVM_DEV_ATTR_RO
(
num_·ges
);

910 
NVM_DEV_ATTR_RO
(
·ge_size
);

911 
NVM_DEV_ATTR_RO
(
hw_£ùÜ_size
);

912 
NVM_DEV_ATTR_RO
(
oob_£ùÜ_size
);

913 
NVM_DEV_ATTR_RO
(
»ad_typ
);

914 
NVM_DEV_ATTR_RO
(
»ad_max
);

915 
NVM_DEV_ATTR_RO
(
´og_typ
);

916 
NVM_DEV_ATTR_RO
(
´og_max
);

917 
NVM_DEV_ATTR_RO
(
”a£_typ
);

918 
NVM_DEV_ATTR_RO
(
”a£_max
);

919 
NVM_DEV_ATTR_RO
(
muÉÏÃ_modes
);

920 
NVM_DEV_ATTR_RO
(
medŸ_ÿ·b™›s
);

921 
NVM_DEV_ATTR_RO
(
max_phys_£cs
);

923 
©Œibu‹
 *
	gnvm_dev_©Œs
[] = {

924 &
dev_©Œ_v”siÚ
.
©Œ
,

925 &
dev_©Œ_v’dÜ_İcode
.
©Œ
,

926 &
dev_©Œ_ÿ·b™›s
.
©Œ
,

927 &
dev_©Œ_deviû_mode
.
©Œ
,

928 &
dev_©Œ_medŸ_mªag”
.
©Œ
,

930 &
dev_©Œ_µa_fÜm©
.
©Œ
,

931 &
dev_©Œ_medŸ_ty³
.
©Œ
,

932 &
dev_©Œ_æash_medŸ_ty³
.
©Œ
,

933 &
dev_©Œ_num_chªÃls
.
©Œ
,

934 &
dev_©Œ_num_luns
.
©Œ
,

935 &
dev_©Œ_num_¶ªes
.
©Œ
,

936 &
dev_©Œ_num_blocks
.
©Œ
,

937 &
dev_©Œ_num_·ges
.
©Œ
,

938 &
dev_©Œ_·ge_size
.
©Œ
,

939 &
dev_©Œ_hw_£ùÜ_size
.
©Œ
,

940 &
dev_©Œ_oob_£ùÜ_size
.
©Œ
,

941 &
dev_©Œ_»ad_typ
.
©Œ
,

942 &
dev_©Œ_»ad_max
.
©Œ
,

943 &
dev_©Œ_´og_typ
.
©Œ
,

944 &
dev_©Œ_´og_max
.
©Œ
,

945 &
dev_©Œ_”a£_typ
.
©Œ
,

946 &
dev_©Œ_”a£_max
.
©Œ
,

947 &
dev_©Œ_muÉÏÃ_modes
.
©Œ
,

948 &
dev_©Œ_medŸ_ÿ·b™›s
.
©Œ
,

949 &
dev_©Œ_max_phys_£cs
.
©Œ
,

950 
NULL
,

953 cÚ¡ 
©Œibu‹_group
 
	gnvm_dev_©Œ_group
 = {

954 .
Çme
 = "lightnvm",

955 .
	g©Œs
 = 
nvm_dev_©Œs
,

958 
	$nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
)

960  
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

961 &
nvm_dev_©Œ_group
);

962 
	}
}

964 
	$nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
)

966 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

967 &
nvm_dev_©Œ_group
);

968 
	}
}

971 
	#PCI_VENDOR_ID_CNEX
 0x1d1d

	)

972 
	#PCI_DEVICE_ID_CNEX_WL
 0x2807

	)

973 
	#PCI_DEVICE_ID_CNEX_QEMU
 0x1f1f

	)

975 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

977 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

979 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
ù¾
->
dev
);

982 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

983 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_QEMU
 &&

984 
id
->
vs
[0] == 0x1)

988 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

989 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_WL
 &&

990 
id
->
vs
[0] == 0x1)

994 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/linux_nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/uuid.h
>

22 
	#NVMF_NQN_FIELD_LEN
 256

	)

25 
	#NVMF_NQN_SIZE
 223

	)

27 
	#NVMF_TRSVCID_SIZE
 32

	)

28 
	#NVMF_TRADDR_SIZE
 256

	)

29 
	#NVMF_TSAS_SIZE
 256

	)

31 
	#NVME_DISC_SUBSYS_NAME
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

33 
	#NVME_RDMA_IP_PORT
 4420

	)

35 
	envme_subsys_ty³
 {

36 
	mNVME_NQN_DISC
 = 1,

37 
	mNVME_NQN_NVME
 = 2,

42 
	mNVMF_ADDR_FAMILY_PCI
 = 0,

43 
	mNVMF_ADDR_FAMILY_IP4
 = 1,

44 
	mNVMF_ADDR_FAMILY_IP6
 = 2,

45 
	mNVMF_ADDR_FAMILY_IB
 = 3,

46 
	mNVMF_ADDR_FAMILY_FC
 = 4,

51 
	mNVMF_TRTYPE_RDMA
 = 1,

52 
	mNVMF_TRTYPE_FC
 = 2,

53 
	mNVMF_TRTYPE_LOOP
 = 254,

54 
	mNVMF_TRTYPE_MAX
,

59 
	mNVMF_TREQ_NOT_SPECIFIED
 = 0,

60 
	mNVMF_TREQ_REQUIRED
 = 1,

61 
	mNVMF_TREQ_NOT_REQUIRED
 = 2,

68 
	mNVMF_RDMA_QPTYPE_CONNECTED
 = 1,

69 
	mNVMF_RDMA_QPTYPE_DATAGRAM
 = 2,

76 
	mNVMF_RDMA_PRTYPE_NOT_SPECIFIED
 = 1,

77 
	mNVMF_RDMA_PRTYPE_IB
 = 2,

78 
	mNVMF_RDMA_PRTYPE_ROCE
 = 3,

79 
	mNVMF_RDMA_PRTYPE_ROCEV2
 = 4,

80 
	mNVMF_RDMA_PRTYPE_IWARP
 = 5,

87 
	mNVMF_RDMA_CMS_RDMA_CM
 = 1,

90 
	#NVME_AQ_DEPTH
 32

	)

93 
	mNVME_REG_CAP
 = 0x0000,

94 
	mNVME_REG_VS
 = 0x0008,

95 
	mNVME_REG_INTMS
 = 0x000c,

96 
	mNVME_REG_INTMC
 = 0x0010,

97 
	mNVME_REG_CC
 = 0x0014,

98 
	mNVME_REG_CSTS
 = 0x001c,

99 
	mNVME_REG_NSSR
 = 0x0020,

100 
	mNVME_REG_AQA
 = 0x0024,

101 
	mNVME_REG_ASQ
 = 0x0028,

102 
	mNVME_REG_ACQ
 = 0x0030,

103 
	mNVME_REG_CMBLOC
 = 0x0038,

104 
	mNVME_REG_CMBSZ
 = 0x003c,

105 
	mNVME_REG_DBS
 = 0x1000,

108 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

109 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

110 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

111 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

112 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

113 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

115 
	#NVME_CMB_BIR
(
cmbloc
è((cmblocè& 0x7)

	)

116 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

117 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

118 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

120 
	#NVME_CMB_WDS
(
cmbsz
è((cmbszè& 0x10)

	)

121 
	#NVME_CMB_RDS
(
cmbsz
è((cmbszè& 0x8)

	)

122 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbszè& 0x4)

	)

123 
	#NVME_CMB_CQS
(
cmbsz
è((cmbszè& 0x2)

	)

124 
	#NVME_CMB_SQS
(
cmbsz
è((cmbszè& 0x1)

	)

130 
	#NVME_NVM_IOSQES
 6

	)

131 
	#NVME_NVM_IOCQES
 4

	)

134 
	mNVME_CC_ENABLE
 = 1 << 0,

135 
	mNVME_CC_CSS_NVM
 = 0 << 4,

136 
	mNVME_CC_MPS_SHIFT
 = 7,

137 
	mNVME_CC_ARB_RR
 = 0 << 11,

138 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

139 
	mNVME_CC_ARB_VS
 = 7 << 11,

140 
	mNVME_CC_SHN_NONE
 = 0 << 14,

141 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

142 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

143 
	mNVME_CC_SHN_MASK
 = 3 << 14,

144 
	mNVME_CC_IOSQES
 = 
NVME_NVM_IOSQES
 << 16,

145 
	mNVME_CC_IOCQES
 = 
NVME_NVM_IOCQES
 << 20,

146 
	mNVME_CSTS_RDY
 = 1 << 0,

147 
	mNVME_CSTS_CFS
 = 1 << 1,

148 
	mNVME_CSTS_NSSRO
 = 1 << 4,

149 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

150 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

151 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

152 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

155 
	snvme_id_pow”_¡©e
 {

156 
__Ë16
 
	mmax_pow”
;

157 
__u8
 
	mrsvd2
;

158 
__u8
 
	mæags
;

159 
__Ë32
 
	m’Œy_Ït
;

160 
__Ë32
 
	mex™_Ït
;

161 
__u8
 
	m»ad_ut
;

162 
__u8
 
	m»ad_Ït
;

163 
__u8
 
	mwr™e_ut
;

164 
__u8
 
	mwr™e_Ït
;

165 
__Ë16
 
	midË_pow”
;

166 
__u8
 
	midË_sÿË
;

167 
__u8
 
	mrsvd19
;

168 
__Ë16
 
	maùive_pow”
;

169 
__u8
 
	maùive_wÜk_sÿË
;

170 
__u8
 
	mrsvd23
[9];

174 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

175 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

178 
	snvme_id_ù¾
 {

179 
__Ë16
 
	mvid
;

180 
__Ë16
 
	mssvid
;

181 
	m¢
[20];

182 
	mmn
[40];

183 
	mä
[8];

184 
__u8
 
	m¿b
;

185 
__u8
 
	m›“
[3];

186 
__u8
 
	mcmic
;

187 
__u8
 
	mmdts
;

188 
__Ë16
 
	múid
;

189 
__Ë32
 
	mv”
;

190 
__Ë32
 
	m¹d3r
;

191 
__Ë32
 
	m¹d3e
;

192 
__Ë32
 
	mßes
;

193 
__Ë32
 
	mù¿‰
;

194 
__u8
 
	mrsvd100
[156];

195 
__Ë16
 
	mßcs
;

196 
__u8
 
	maş
;

197 
__u8
 
	m«¾
;

198 
__u8
 
	mämw
;

199 
__u8
 
	mÍa
;

200 
__u8
 
	m–³
;

201 
__u8
 
	mÅss
;

202 
__u8
 
	mavscc
;

203 
__u8
 
	m­¡a
;

204 
__Ë16
 
	mwùemp
;

205 
__Ë16
 
	mcùemp
;

206 
__Ë16
 
	mmtç
;

207 
__Ë32
 
	mhm´e
;

208 
__Ë32
 
	mhmmš
;

209 
__u8
 
	mŠvmÿp
[16];

210 
__u8
 
	munvmÿp
[16];

211 
__Ë32
 
	m½mbs
;

212 
__Ë16
 
	med¡t
;

213 
__u8
 
	md¡o
;

214 
__u8
 
	mfwug
;

215 
__Ë16
 
	mkas
;

216 
__Ë16
 
	mhùma
;

217 
__Ë16
 
	mmÁmt
;

218 
__Ë16
 
	mmxtmt
;

219 
__Ë32
 
	m§niÿp
;

220 
__u8
 
	mrsvd332
[180];

221 
__u8
 
	msqes
;

222 
__u8
 
	mcqes
;

223 
__Ë16
 
	mmaxcmd
;

224 
__Ë32
 
	mÂ
;

225 
__Ë16
 
	mÚcs
;

226 
__Ë16
 
	mfu£s
;

227 
__u8
 
	mâa
;

228 
__u8
 
	mvwc
;

229 
__Ë16
 
	mawun
;

230 
__Ë16
 
	mawupf
;

231 
__u8
 
	mnvscc
;

232 
__u8
 
	mrsvd531
;

233 
__Ë16
 
	macwu
;

234 
__u8
 
	mrsvd534
[2];

235 
__Ë32
 
	msgls
;

236 
__u8
 
	mrsvd540
[228];

237 
	msubnqn
[256];

238 
__u8
 
	mrsvd1024
[768];

239 
__Ë32
 
	mioccsz
;

240 
__Ë32
 
	miÜcsz
;

241 
__Ë16
 
	micdoff
;

242 
__u8
 
	mù¿‰r
;

243 
__u8
 
	mmsdbd
;

244 
__u8
 
	mrsvd1804
[244];

245 
nvme_id_pow”_¡©e
 
	mpsd
[32];

246 
__u8
 
	mvs
[1024];

250 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

251 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

252 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

253 
	mNVME_CTRL_ONCS_WRITE_ZEROES
 = 1 << 3,

254 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

255 
	mNVME_CTRL_OACS_SEC_SUPP
 = 1 << 0,

256 
	mNVME_CTRL_OACS_DIRECTIVES
 = 1 << 5,

257 
	mNVME_CTRL_OACS_DBBUF_SUPP
 = 1 << 8,

260 
	snvme_lbaf
 {

261 
__Ë16
 
	mms
;

262 
__u8
 
	mds
;

263 
__u8
 
	m½
;

266 
	snvme_id_ns
 {

267 
__Ë64
 
	mnsze
;

268 
__Ë64
 
	mnÿp
;

269 
__Ë64
 
	mnu£
;

270 
__u8
 
	mnsã©
;

271 
__u8
 
	mÆbaf
;

272 
__u8
 
	mæbas
;

273 
__u8
 
	mmc
;

274 
__u8
 
	mdpc
;

275 
__u8
 
	mdps
;

276 
__u8
 
	mnmic
;

277 
__u8
 
	m»sÿp
;

278 
__u8
 
	måi
;

279 
__u8
 
	mrsvd33
;

280 
__Ë16
 
	mÇwun
;

281 
__Ë16
 
	mÇwupf
;

282 
__Ë16
 
	mÇcwu
;

283 
__Ë16
 
	mÇb¢
;

284 
__Ë16
 
	mÇbo
;

285 
__Ë16
 
	mÇb¥f
;

286 
__Ë16
 
	mnoiob
;

287 
__u8
 
	mnvmÿp
[16];

288 
__u8
 
	mrsvd64
[40];

289 
__u8
 
	mnguid
[16];

290 
__u8
 
	meui64
[8];

291 
nvme_lbaf
 
	mlbaf
[16];

292 
__u8
 
	mrsvd192
[192];

293 
__u8
 
	mvs
[3712];

297 
	mNVME_ID_CNS_NS
 = 0x00,

298 
	mNVME_ID_CNS_CTRL
 = 0x01,

299 
	mNVME_ID_CNS_NS_ACTIVE_LIST
 = 0x02,

300 
	mNVME_ID_CNS_NS_DESC_LIST
 = 0x03,

301 
	mNVME_ID_CNS_NS_PRESENT_LIST
 = 0x10,

302 
	mNVME_ID_CNS_NS_PRESENT
 = 0x11,

303 
	mNVME_ID_CNS_CTRL_NS_LIST
 = 0x12,

304 
	mNVME_ID_CNS_CTRL_LIST
 = 0x13,

308 
	mNVME_DIR_IDENTIFY
 = 0x00,

309 
	mNVME_DIR_STREAMS
 = 0x01,

310 
	mNVME_DIR_SND_ID_OP_ENABLE
 = 0x01,

311 
	mNVME_DIR_SND_ST_OP_REL_ID
 = 0x01,

312 
	mNVME_DIR_SND_ST_OP_REL_RSC
 = 0x02,

313 
	mNVME_DIR_RCV_ID_OP_PARAM
 = 0x01,

314 
	mNVME_DIR_RCV_ST_OP_PARAM
 = 0x01,

315 
	mNVME_DIR_RCV_ST_OP_STATUS
 = 0x02,

316 
	mNVME_DIR_RCV_ST_OP_RESOURCE
 = 0x03,

317 
	mNVME_DIR_ENDIR
 = 0x01,

321 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

322 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

323 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

324 
	mNVME_LBAF_RP_BEST
 = 0,

325 
	mNVME_LBAF_RP_BETTER
 = 1,

326 
	mNVME_LBAF_RP_GOOD
 = 2,

327 
	mNVME_LBAF_RP_DEGRADED
 = 3,

328 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

329 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

330 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

331 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

332 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

333 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

334 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

335 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

336 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

337 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

340 
	snvme_ns_id_desc
 {

341 
__u8
 
	mnidt
;

342 
__u8
 
	mnidl
;

343 
__Ë16
 
	m»£rved
;

346 
	#NVME_NIDT_EUI64_LEN
 8

	)

347 
	#NVME_NIDT_NGUID_LEN
 16

	)

348 
	#NVME_NIDT_UUID_LEN
 16

	)

351 
	mNVME_NIDT_EUI64
 = 0x01,

352 
	mNVME_NIDT_NGUID
 = 0x02,

353 
	mNVME_NIDT_UUID
 = 0x03,

356 
	snvme_sm¬t_log
 {

357 
__u8
 
	mü™iÿl_w¬nšg
;

358 
__u8
 
	m‹m³¿tu»
[2];

359 
__u8
 
	mava_¥¬e
;

360 
__u8
 
	m¥¬e_th»sh
;

361 
__u8
 
	m³rûÁ_u£d
;

362 
__u8
 
	mrsvd6
[26];

363 
__u8
 
	md©a_un™s_»ad
[16];

364 
__u8
 
	md©a_un™s_wr™‹n
[16];

365 
__u8
 
	mho¡_»ads
[16];

366 
__u8
 
	mho¡_wr™es
[16];

367 
__u8
 
	mù¾_busy_time
[16];

368 
__u8
 
	mpow”_cyşes
[16];

369 
__u8
 
	mpow”_Ú_hours
[16];

370 
__u8
 
	mun§ã_shutdowns
[16];

371 
__u8
 
	mmedŸ_”rÜs
[16];

372 
__u8
 
	mnum_”r_log_’Œ›s
[16];

373 
__Ë32
 
	mw¬nšg_‹mp_time
;

374 
__Ë32
 
	mü™iÿl_comp_time
;

375 
__Ë16
 
	m‹mp_£nsÜ
[8];

376 
__u8
 
	mrsvd216
[296];

380 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

381 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

382 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

383 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

384 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

388 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

391 
	snvme_lba_¿nge_ty³
 {

392 
__u8
 
	mty³
;

393 
__u8
 
	m©Œibu‹s
;

394 
__u8
 
	mrsvd2
[14];

395 
__u64
 
	m¦ba
;

396 
__u64
 
	mÆb
;

397 
__u8
 
	mguid
[16];

398 
__u8
 
	mrsvd48
[16];

402 
	mNVME_LBART_TYPE_FS
 = 0x01,

403 
	mNVME_LBART_TYPE_RAID
 = 0x02,

404 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

405 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

407 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

408 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

411 
	snvme_»£rv©iÚ_¡©us
 {

412 
__Ë32
 
	mg’
;

413 
__u8
 
	m¹y³
;

414 
__u8
 
	m»gùl
[2];

415 
__u8
 
	m»sv5
[2];

416 
__u8
 
	m±¶s
;

417 
__u8
 
	m»sv10
[13];

419 
__Ë16
 
	múid
;

420 
__u8
 
	mrc¡s
;

421 
__u8
 
	m»sv3
[5];

422 
__Ë64
 
	mho¡id
;

423 
__Ë64
 
	mrkey
;

424 } 
	m»gùl_ds
[];

427 
	envme_async_ev’t_ty³
 {

428 
	mNVME_AER_TYPE_ERROR
 = 0,

429 
	mNVME_AER_TYPE_SMART
 = 1,

430 
	mNVME_AER_TYPE_NOTICE
 = 2,

435 
	envme_İcode
 {

436 
	mnvme_cmd_æush
 = 0x00,

437 
	mnvme_cmd_wr™e
 = 0x01,

438 
	mnvme_cmd_»ad
 = 0x02,

439 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

440 
	mnvme_cmd_com·»
 = 0x05,

441 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

442 
	mnvme_cmd_dsm
 = 0x09,

443 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

444 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

445 
	mnvme_cmd_»sv_acquœe
 = 0x11,

446 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

448 
	mnvme_cmd_kv_¡Üe
 = 0x81,

449 
	mnvme_cmd_kv_­³nd
 = 0x83,

450 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

451 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

452 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

453 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

454 
	mnvme_cmd_kv_exi¡
 = 0xB3,

458 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

459 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

460 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

472 
	mNVME_SGL_FMT_ADDRESS
 = 0x00,

473 
	mNVME_SGL_FMT_OFFSET
 = 0x01,

474 
	mNVME_SGL_FMT_INVALIDATE
 = 0x0f,

489 
	mNVME_SGL_FMT_DATA_DESC
 = 0x00,

490 
	mNVME_SGL_FMT_SEG_DESC
 = 0x02,

491 
	mNVME_SGL_FMT_LAST_SEG_DESC
 = 0x03,

492 
	mNVME_KEY_SGL_FMT_DATA_DESC
 = 0x04,

495 
	snvme_sgl_desc
 {

496 
__Ë64
 
	maddr
;

497 
__Ë32
 
	mËngth
;

498 
__u8
 
	mrsvd
[3];

499 
__u8
 
	mty³
;

502 
	snvme_keyed_sgl_desc
 {

503 
__Ë64
 
	maddr
;

504 
__u8
 
	mËngth
[3];

505 
__u8
 
	mkey
[4];

506 
__u8
 
	mty³
;

509 
	unvme_d©a_±r
 {

511 
__Ë64
 
	m´p1
;

512 
__Ë64
 
	m´p2
;

514 
nvme_sgl_desc
 
	msgl
;

515 
nvme_keyed_sgl_desc
 
	mksgl
;

533 
	mNVME_CMD_FUSE_FIRST
 = (1 << 0),

534 
	mNVME_CMD_FUSE_SECOND
 = (1 << 1),

536 
	mNVME_CMD_SGL_METABUF
 = (1 << 6),

537 
	mNVME_CMD_SGL_METASEG
 = (1 << 7),

538 
	mNVME_CMD_SGL_ALL
 = 
NVME_CMD_SGL_METABUF
 | 
NVME_CMD_SGL_METASEG
,

541 
	snvme_commÚ_commªd
 {

542 
__u8
 
	mİcode
;

543 
__u8
 
	mæags
;

544 
__u16
 
	mcommªd_id
;

545 
__Ë32
 
	mnsid
;

546 
__Ë32
 
	mcdw2
[2];

547 
__Ë64
 
	mm‘ad©a
;

548 
nvme_d©a_±r
 
	md±r
;

549 
__Ë32
 
	mcdw10
[6];

552 
	snvme_rw_commªd
 {

553 
__u8
 
	mİcode
;

554 
__u8
 
	mæags
;

555 
__u16
 
	mcommªd_id
;

556 
__Ë32
 
	mnsid
;

557 
__u64
 
	mrsvd2
;

558 
__Ë64
 
	mm‘ad©a
;

559 
nvme_d©a_±r
 
	md±r
;

560 
__Ë64
 
	m¦ba
;

561 
__Ë16
 
	mËngth
;

562 
__Ë16
 
	mcÚŒŞ
;

563 
__Ë32
 
	mdsmgmt
;

564 
__Ë32
 
	m»áag
;

565 
__Ë16
 
	m­±ag
;

566 
__Ë16
 
	m­pmask
;

570 
	mNVME_RW_LR
 = 1 << 15,

571 
	mNVME_RW_FUA
 = 1 << 14,

572 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

573 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

574 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

575 
	mNVME_RW_DSM_FREQ_READS
 = 3,

576 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

577 
	mNVME_RW_DSM_FREQ_RW
 = 5,

578 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

579 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

580 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

581 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

582 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

583 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

584 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

585 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

586 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

587 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

588 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

589 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

590 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

591 
	mNVME_RW_DTYPE_STREAMS
 = 1 << 4,

594 
	snvme_dsm_cmd
 {

595 
__u8
 
	mİcode
;

596 
__u8
 
	mæags
;

597 
__u16
 
	mcommªd_id
;

598 
__Ë32
 
	mnsid
;

599 
__u64
 
	mrsvd2
[2];

600 
nvme_d©a_±r
 
	md±r
;

601 
__Ë32
 
	mÄ
;

602 
__Ë32
 
	m©Œibu‹s
;

603 
__u32
 
	mrsvd12
[4];

607 
	mNVME_DSMGMT_IDR
 = 1 << 0,

608 
	mNVME_DSMGMT_IDW
 = 1 << 1,

609 
	mNVME_DSMGMT_AD
 = 1 << 2,

612 
	#NVME_DSM_MAX_RANGES
 256

	)

614 
	snvme_dsm_¿nge
 {

615 
__Ë32
 
	mÿ‰r
;

616 
__Ë32
 
	mÆb
;

617 
__Ë64
 
	m¦ba
;

620 
	snvme_wr™e_z”Ûs_cmd
 {

621 
__u8
 
	mİcode
;

622 
__u8
 
	mæags
;

623 
__u16
 
	mcommªd_id
;

624 
__Ë32
 
	mnsid
;

625 
__u64
 
	mrsvd2
;

626 
__Ë64
 
	mm‘ad©a
;

627 
nvme_d©a_±r
 
	md±r
;

628 
__Ë64
 
	m¦ba
;

629 
__Ë16
 
	mËngth
;

630 
__Ë16
 
	mcÚŒŞ
;

631 
__Ë32
 
	mdsmgmt
;

632 
__Ë32
 
	m»áag
;

633 
__Ë16
 
	m­±ag
;

634 
__Ë16
 
	m­pmask
;

639 
	snvme_ã©_auto_p¡
 {

640 
__Ë64
 
	m’Œ›s
[32];

644 
	mNVME_HOST_MEM_ENABLE
 = (1 << 0),

645 
	mNVME_HOST_MEM_RETURN
 = (1 << 1),

650 
	snvme_kv_¡Üe_commªd
 {

651 
__u8
 
	mİcode
;

652 
__u8
 
	mæags
;

653 
__u16
 
	mcommªd_id
;

654 
__Ë32
 
	mnsid
;

655 
__u64
 
	mrsvd
;

656 
__Ë32
 
	moff£t
;

657 
__u32
 
	mrsvd2
;

658 
nvme_d©a_±r
 
	md±r
;

659 
__Ë32
 
	mv®ue_Ën
;

660 
__u8
 
	mkey_Ën
;

661 
__u8
 
	mİtiÚ
;

662 
__u8
 
	mšv®id_by‹
:2;

663 
__u8
 
	mrsvd3
:6;

664 
__u8
 
	mrsvd4
;

667 
	mkey
[16];

670 
__Ë64
 
	mkey_´p
;

671 
__Ë64
 
	mkey_´p2
;

676 
	snvme_kv_­³nd_commªd
 {

677 
__u8
 
	mİcode
;

678 
__u8
 
	mæags
;

679 
__u16
 
	mcommªd_id
;

680 
__Ë32
 
	mnsid
;

681 
__u64
 
	mrsvd
;

682 
__Ë32
 
	moff£t
;

683 
__u32
 
	mrsvd2
;

684 
nvme_d©a_±r
 
	md±r
;

685 
__Ë32
 
	mv®ue_Ën
;

686 
__u8
 
	mkey_Ën
;

687 
__u8
 
	mİtiÚ
;

688 
__u8
 
	mšv®id_by‹
:2;

689 
__u8
 
	mrsvd3
:6;

690 
__u8
 
	mrsvd4
;

693 
	mkey
[16];

696 
__Ë64
 
	mkey_´p
;

697 
__Ë64
 
	mkey_´p2
;

702 
	snvme_kv_»Œ›ve_commªd
 {

703 
__u8
 
	mİcode
;

704 
__u8
 
	mæags
;

705 
__u16
 
	mcommªd_id
;

706 
__Ë32
 
	mnsid
;

707 
__u64
 
	mrsvd
;

708 
__Ë32
 
	moff£t
;

709 
__u32
 
	mrsvd2
;

710 
nvme_d©a_±r
 
	md±r
;

711 
__Ë32
 
	mv®ue_Ën
;

712 
__u8
 
	mkey_Ën
;

713 
__u8
 
	mİtiÚ
;

714 
__u16
 
	mrsvd3
;

717 
	mkey
[16];

720 
__Ë64
 
	mkey_´p
;

721 
__Ë64
 
	mkey_´p2
;

726 
	snvme_kv_d–‘e_commªd
 {

727 
__u8
 
	mİcode
;

728 
__u8
 
	mæags
;

729 
__u16
 
	mcommªd_id
;

730 
__Ë32
 
	mnsid
;

731 
__u64
 
	mrsvd
;

732 
__Ë32
 
	moff£t
;

733 
__u32
 
	mrsvd2
;

734 
__u64
 
	mrsvd3
[2];

735 
__Ë32
 
	mv®ue_Ën
;

736 
__u8
 
	mkey_Ën
;

737 
__u8
 
	mİtiÚ
;

738 
__u16
 
	mrsvd4
;

741 
	mkey
[16];

744 
__Ë64
 
	mkey_´p
;

745 
__Ë64
 
	mkey_´p2
;

750 
	snvme_kv_™”_»q_commªd
 {

751 
__u8
 
	mİcode
;

752 
__u8
 
	mæags
;

753 
__u16
 
	mcommªd_id
;

754 
__Ë32
 
	mnsid
;

755 
__u64
 
	mrsvd
[4];

756 
__Ë32
 
	mz”o
;

757 
__u8
 
	m™”_hªdË
;

758 
__u8
 
	mİtiÚ
;

759 
__u16
 
	mrsvd2
;

760 
__Ë32
 
	m™”_v®
;

761 
__Ë32
 
	m™”_b™mask
;

762 
__u64
 
	mrsvd3
;

766 
	snvme_kv_™”_»ad_commªd
 {

767 
__u8
 
	mİcode
;

768 
__u8
 
	mæags
;

769 
__u16
 
	mcommªd_id
;

770 
__Ë32
 
	mnsid
;

771 
__u64
 
	mrsvd
[2];

772 
nvme_d©a_±r
 
	md±r
;

773 
__Ë32
 
	mv®ue_Ën
;

774 
__u8
 
	m™”_hªdË
;

775 
__u8
 
	mİtiÚ
;

776 
__u16
 
	mrsvd2
;

777 
__u64
 
	mrsvd3
[2];

779 
	snvme_kv_exi¡_commªd
 {

780 
__u8
 
	mİcode
;

781 
__u8
 
	mæags
;

782 
__u16
 
	mcommªd_id
;

783 
__Ë32
 
	mnsid
;

784 
__u64
 
	mrsvd
;

785 
__Ë32
 
	moff£t
;

786 
__u32
 
	mrsvd2
;

787 
__u64
 
	mrsvd3
[2];

788 
__Ë32
 
	mv®ue_Ën
;

789 
__u8
 
	mkey_Ën
;

790 
__u8
 
	mİtiÚ
;

791 
__u16
 
	mrsvd4
;

794 
	mkey
[16];

797 
__Ë64
 
	mkey_´p
;

798 
__Ë64
 
	mkey_´p2
;

808 
	envme_admš_İcode
 {

809 
	mnvme_admš_d–‘e_sq
 = 0x00,

810 
	mnvme_admš_ü—‹_sq
 = 0x01,

811 
	mnvme_admš_g‘_log_·ge
 = 0x02,

812 
	mnvme_admš_d–‘e_cq
 = 0x04,

813 
	mnvme_admš_ü—‹_cq
 = 0x05,

814 
	mnvme_admš_id’tify
 = 0x06,

815 
	mnvme_admš_abÜt_cmd
 = 0x08,

816 
	mnvme_admš_£t_ã©u»s
 = 0x09,

817 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

818 
	mnvme_admš_async_ev’t
 = 0x0c,

819 
	mnvme_admš_ns_mgmt
 = 0x0d,

820 
	mnvme_admš_aùiv©e_fw
 = 0x10,

821 
	mnvme_admš_dowÆßd_fw
 = 0x11,

822 
	mnvme_admš_ns_©ch
 = 0x15,

823 
	mnvme_admš_k“p_®ive
 = 0x18,

824 
	mnvme_admš_dœeùive_£nd
 = 0x19,

825 
	mnvme_admš_dœeùive_»cv
 = 0x1a,

826 
	mnvme_admš_dbbuf
 = 0x7C,

827 
	mnvme_admš_fÜm©_nvm
 = 0x80,

828 
	mnvme_admš_£cur™y_£nd
 = 0x81,

829 
	mnvme_admš_£cur™y_»cv
 = 0x82,

833 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

834 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

835 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

836 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

837 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

838 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

839 
	mNVME_FEAT_ARBITRATION
 = 0x01,

840 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

841 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

842 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

843 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

844 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

845 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

846 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

847 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

848 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

849 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

850 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

851 
	mNVME_FEAT_HOST_MEM_BUF
 = 0x0d,

852 
	mNVME_FEAT_KATO
 = 0x0f,

853 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

854 
	mNVME_FEAT_HOST_ID
 = 0x81,

855 
	mNVME_FEAT_RESV_MASK
 = 0x82,

856 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

857 
	mNVME_LOG_ERROR
 = 0x01,

858 
	mNVME_LOG_SMART
 = 0x02,

859 
	mNVME_LOG_FW_SLOT
 = 0x03,

860 
	mNVME_LOG_DISC
 = 0x70,

861 
	mNVME_LOG_RESERVATION
 = 0x80,

862 
	mNVME_FWACT_REPL
 = (0 << 3),

863 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

864 
	mNVME_FWACT_ACTV
 = (2 << 3),

867 
	snvme_id’tify
 {

868 
__u8
 
	mİcode
;

869 
__u8
 
	mæags
;

870 
__u16
 
	mcommªd_id
;

871 
__Ë32
 
	mnsid
;

872 
__u64
 
	mrsvd2
[2];

873 
nvme_d©a_±r
 
	md±r
;

874 
__u8
 
	mús
;

875 
__u8
 
	mrsvd3
;

876 
__Ë16
 
	mù¾id
;

877 
__u32
 
	mrsvd11
[5];

880 
	#NVME_IDENTIFY_DATA_SIZE
 4096

	)

882 
	snvme_ã©u»s
 {

883 
__u8
 
	mİcode
;

884 
__u8
 
	mæags
;

885 
__u16
 
	mcommªd_id
;

886 
__Ë32
 
	mnsid
;

887 
__u64
 
	mrsvd2
[2];

888 
nvme_d©a_±r
 
	md±r
;

889 
__Ë32
 
	mfid
;

890 
__Ë32
 
	mdwÜd11
;

891 
__Ë32
 
	mdwÜd12
;

892 
__Ë32
 
	mdwÜd13
;

893 
__Ë32
 
	mdwÜd14
;

894 
__Ë32
 
	mdwÜd15
;

897 
	snvme_ho¡_mem_buf_desc
 {

898 
__Ë64
 
	maddr
;

899 
__Ë32
 
	msize
;

900 
__u32
 
	mrsvd
;

903 
	snvme_ü—‹_cq
 {

904 
__u8
 
	mİcode
;

905 
__u8
 
	mæags
;

906 
__u16
 
	mcommªd_id
;

907 
__u32
 
	mrsvd1
[5];

908 
__Ë64
 
	m´p1
;

909 
__u64
 
	mrsvd8
;

910 
__Ë16
 
	mcqid
;

911 
__Ë16
 
	mqsize
;

912 
__Ë16
 
	mcq_æags
;

913 
__Ë16
 
	mœq_veùÜ
;

914 
__u32
 
	mrsvd12
[4];

917 
	snvme_ü—‹_sq
 {

918 
__u8
 
	mİcode
;

919 
__u8
 
	mæags
;

920 
__u16
 
	mcommªd_id
;

921 
__u32
 
	mrsvd1
[5];

922 
__Ë64
 
	m´p1
;

923 
__u64
 
	mrsvd8
;

924 
__Ë16
 
	msqid
;

925 
__Ë16
 
	mqsize
;

926 
__Ë16
 
	msq_æags
;

927 
__Ë16
 
	mcqid
;

928 
__u32
 
	mrsvd12
[4];

931 
	snvme_d–‘e_queue
 {

932 
__u8
 
	mİcode
;

933 
__u8
 
	mæags
;

934 
__u16
 
	mcommªd_id
;

935 
__u32
 
	mrsvd1
[9];

936 
__Ë16
 
	mqid
;

937 
__u16
 
	mrsvd10
;

938 
__u32
 
	mrsvd11
[5];

941 
	snvme_abÜt_cmd
 {

942 
__u8
 
	mİcode
;

943 
__u8
 
	mæags
;

944 
__u16
 
	mcommªd_id
;

945 
__u32
 
	mrsvd1
[9];

946 
__Ë16
 
	msqid
;

947 
__u16
 
	mcid
;

948 
__u32
 
	mrsvd11
[5];

951 
	snvme_dowÆßd_fœmw¬e
 {

952 
__u8
 
	mİcode
;

953 
__u8
 
	mæags
;

954 
__u16
 
	mcommªd_id
;

955 
__u32
 
	mrsvd1
[5];

956 
nvme_d©a_±r
 
	md±r
;

957 
__Ë32
 
	mnumd
;

958 
__Ë32
 
	moff£t
;

959 
__u32
 
	mrsvd12
[4];

962 
	snvme_fÜm©_cmd
 {

963 
__u8
 
	mİcode
;

964 
__u8
 
	mæags
;

965 
__u16
 
	mcommªd_id
;

966 
__Ë32
 
	mnsid
;

967 
__u64
 
	mrsvd2
[4];

968 
__Ë32
 
	mcdw10
;

969 
__u32
 
	mrsvd11
[5];

972 
	snvme_g‘_log_·ge_commªd
 {

973 
__u8
 
	mİcode
;

974 
__u8
 
	mæags
;

975 
__u16
 
	mcommªd_id
;

976 
__Ë32
 
	mnsid
;

977 
__u64
 
	mrsvd2
[2];

978 
nvme_d©a_±r
 
	md±r
;

979 
__u8
 
	mlid
;

980 
__u8
 
	mrsvd10
;

981 
__Ë16
 
	mnumdl
;

982 
__Ë16
 
	mnumdu
;

983 
__u16
 
	mrsvd11
;

984 
__Ë32
 
	mÍŞ
;

985 
__Ë32
 
	mÍou
;

986 
__u32
 
	mrsvd14
[2];

989 
	snvme_dœeùive_cmd
 {

990 
__u8
 
	mİcode
;

991 
__u8
 
	mæags
;

992 
__u16
 
	mcommªd_id
;

993 
__Ë32
 
	mnsid
;

994 
__u64
 
	mrsvd2
[2];

995 
nvme_d©a_±r
 
	md±r
;

996 
__Ë32
 
	mnumd
;

997 
__u8
 
	mdİ”
;

998 
__u8
 
	mdty³
;

999 
__Ë16
 
	md¥ec
;

1000 
__u8
 
	m’dœ
;

1001 
__u8
 
	mtdty³
;

1002 
__u16
 
	mrsvd15
;

1004 
__u32
 
	mrsvd16
[3];

1010 
	envmf_çbrics_İcode
 {

1011 
	mnvme_çbrics_commªd
 = 0x7f,

1014 
	envmf_ÿpsuË_commªd
 {

1015 
	mnvme_çbrics_ty³_´İ”ty_£t
 = 0x00,

1016 
	mnvme_çbrics_ty³_cÚÃù
 = 0x01,

1017 
	mnvme_çbrics_ty³_´İ”ty_g‘
 = 0x04,

1020 
	snvmf_commÚ_commªd
 {

1021 
__u8
 
	mİcode
;

1022 
__u8
 
	m»sv1
;

1023 
__u16
 
	mcommªd_id
;

1024 
__u8
 
	mfùy³
;

1025 
__u8
 
	m»sv2
[35];

1026 
__u8
 
	mts
[24];

1035 
	#NVME_CNTLID_MIN
 1

	)

1036 
	#NVME_CNTLID_MAX
 0xfãf

	)

1037 
	#NVME_CNTLID_DYNAMIC
 0xffff

	)

1039 
	#MAX_DISC_LOGS
 255

	)

1042 
	snvmf_disc_r¥_·ge_’Œy
 {

1043 
__u8
 
	mŒty³
;

1044 
__u8
 
	madrçm
;

1045 
__u8
 
	msubty³
;

1046 
__u8
 
	mŒeq
;

1047 
__Ë16
 
	mpÜtid
;

1048 
__Ë16
 
	múid
;

1049 
__Ë16
 
	masqsz
;

1050 
__u8
 
	m»sv8
[22];

1051 
	mŒsvcid
[
NVMF_TRSVCID_SIZE
];

1052 
__u8
 
	m»sv64
[192];

1053 
	msubnqn
[
NVMF_NQN_FIELD_LEN
];

1054 
	mŒaddr
[
NVMF_TRADDR_SIZE
];

1055 
	ut§s
 {

1056 
	mcommÚ
[
NVMF_TSAS_SIZE
];

1057 
	srdma
 {

1058 
__u8
 
	mq±y³
;

1059 
__u8
 
	m´ty³
;

1060 
__u8
 
	mcms
;

1061 
__u8
 
	m»sv3
[5];

1062 
__u16
 
	mpkey
;

1063 
__u8
 
	m»sv10
[246];

1064 } 
	mrdma
;

1065 } 
	mt§s
;

1069 
	snvmf_disc_r¥_·ge_hdr
 {

1070 
__Ë64
 
	mg’ùr
;

1071 
__Ë64
 
	mnum»c
;

1072 
__Ë16
 
	m»cfmt
;

1073 
__u8
 
	m»sv14
[1006];

1074 
nvmf_disc_r¥_·ge_’Œy
 
	m’Œ›s
[0];

1077 
	snvmf_cÚÃù_commªd
 {

1078 
__u8
 
	mİcode
;

1079 
__u8
 
	m»sv1
;

1080 
__u16
 
	mcommªd_id
;

1081 
__u8
 
	mfùy³
;

1082 
__u8
 
	m»sv2
[19];

1083 
nvme_d©a_±r
 
	md±r
;

1084 
__Ë16
 
	m»cfmt
;

1085 
__Ë16
 
	mqid
;

1086 
__Ë16
 
	msqsize
;

1087 
__u8
 
	mÿ‰r
;

1088 
__u8
 
	m»sv3
;

1089 
__Ë32
 
	mk©o
;

1090 
__u8
 
	m»sv4
[12];

1093 
	snvmf_cÚÃù_d©a
 {

1094 
uuid_t
 
	mho¡id
;

1095 
__Ë16
 
	múid
;

1096 
	m»sv4
[238];

1097 
	msubsy¢qn
[
NVMF_NQN_FIELD_LEN
];

1098 
	mho¡nqn
[
NVMF_NQN_FIELD_LEN
];

1099 
	m»sv5
[256];

1102 
	snvmf_´İ”ty_£t_commªd
 {

1103 
__u8
 
	mİcode
;

1104 
__u8
 
	m»sv1
;

1105 
__u16
 
	mcommªd_id
;

1106 
__u8
 
	mfùy³
;

1107 
__u8
 
	m»sv2
[35];

1108 
__u8
 
	m©Œib
;

1109 
__u8
 
	m»sv3
[3];

1110 
__Ë32
 
	moff£t
;

1111 
__Ë64
 
	mv®ue
;

1112 
__u8
 
	m»sv4
[8];

1115 
	snvmf_´İ”ty_g‘_commªd
 {

1116 
__u8
 
	mİcode
;

1117 
__u8
 
	m»sv1
;

1118 
__u16
 
	mcommªd_id
;

1119 
__u8
 
	mfùy³
;

1120 
__u8
 
	m»sv2
[35];

1121 
__u8
 
	m©Œib
;

1122 
__u8
 
	m»sv3
[3];

1123 
__Ë32
 
	moff£t
;

1124 
__u8
 
	m»sv4
[16];

1127 
	snvme_dbbuf
 {

1128 
__u8
 
	mİcode
;

1129 
__u8
 
	mæags
;

1130 
__u16
 
	mcommªd_id
;

1131 
__u32
 
	mrsvd1
[5];

1132 
__Ë64
 
	m´p1
;

1133 
__Ë64
 
	m´p2
;

1134 
__u32
 
	mrsvd12
[6];

1137 
	s¡»ams_dœeùive_·¿ms
 {

1138 
__Ë16
 
	mm¦
;

1139 
__Ë16
 
	mns§
;

1140 
__Ë16
 
	mnsso
;

1141 
__u8
 
	mrsvd
[10];

1142 
__Ë32
 
	msws
;

1143 
__Ë16
 
	msgs
;

1144 
__Ë16
 
	mn§
;

1145 
__Ë16
 
	mnso
;

1146 
__u8
 
	mrsvd2
[6];

1149 
	snvme_commªd
 {

1151 
nvme_commÚ_commªd
 
	mcommÚ
;

1152 
nvme_rw_commªd
 
	mrw
;

1153 
nvme_id’tify
 
	mid’tify
;

1154 
nvme_ã©u»s
 
	mã©u»s
;

1155 
nvme_ü—‹_cq
 
	mü—‹_cq
;

1156 
nvme_ü—‹_sq
 
	mü—‹_sq
;

1157 
nvme_d–‘e_queue
 
	md–‘e_queue
;

1158 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

1159 
nvme_fÜm©_cmd
 
	mfÜm©
;

1160 
nvme_dsm_cmd
 
	mdsm
;

1161 
nvme_wr™e_z”Ûs_cmd
 
	mwr™e_z”Ûs
;

1162 
nvme_abÜt_cmd
 
	mabÜt
;

1163 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

1164 
nvmf_commÚ_commªd
 
	mçbrics
;

1165 
nvmf_cÚÃù_commªd
 
	mcÚÃù
;

1166 
nvmf_´İ”ty_£t_commªd
 
	m´İ_£t
;

1167 
nvmf_´İ”ty_g‘_commªd
 
	m´İ_g‘
;

1168 
nvme_dbbuf
 
	mdbbuf
;

1169 
nvme_dœeùive_cmd
 
	mdœeùive
;

1171 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

1172 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

1173 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

1174 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

1175 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

1176 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

1177 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

1182 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1190 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_¡Üe
 || cmd->commÚ.İcod=ğ
nvme_cmd_kv_­³nd
)

1192 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_»Œ›ve
 ||

1193 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_d–‘e
 ||

1194 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»q
 ||

1195 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
 ||

1196 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_exi¡
 )

1199 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1200  
cmd
->
çbrics
.
fùy³
 & 1;

1201  
cmd
->
commÚ
.
İcode
 & 1;

1202 
	}
}

1205 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1212 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1213  
cmd
->
çbrics
.
fùy³
 & 1;

1214  
cmd
->
commÚ
.
İcode
 & 1;

1215 
	}
}

1221 
	mNVME_SC_SUCCESS
 = 0x0,

1222 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

1223 
	mNVME_SC_INVALID_FIELD
 = 0x2,

1224 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

1225 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

1226 
	mNVME_SC_POWER_LOSS
 = 0x5,

1227 
	mNVME_SC_INTERNAL
 = 0x6,

1228 
	mNVME_SC_ABORT_REQ
 = 0x7,

1229 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

1230 
	mNVME_SC_FUSED_FAIL
 = 0x9,

1231 
	mNVME_SC_FUSED_MISSING
 = 0xa,

1232 
	mNVME_SC_INVALID_NS
 = 0xb,

1233 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

1234 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

1235 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

1236 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

1237 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

1238 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

1240 
	mNVME_SC_SGL_INVALID_OFFSET
 = 0x16,

1241 
	mNVME_SC_SGL_INVALID_SUBTYPE
 = 0x17,

1243 
	mNVME_SC_LBA_RANGE
 = 0x80,

1244 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

1245 
	mNVME_SC_NS_NOT_READY
 = 0x82,

1246 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

1251 
	mNVME_SC_CQ_INVALID
 = 0x100,

1252 
	mNVME_SC_QID_INVALID
 = 0x101,

1253 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

1254 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

1255 
	mNVME_SC_ABORT_MISSING
 = 0x104,

1256 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

1257 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

1258 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

1259 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

1260 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

1261 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

1262 
	mNVME_SC_FW_NEEDS_CONV_RESET
 = 0x10b,

1263 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

1264 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

1265 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

1266 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

1267 
	mNVME_SC_FW_NEEDS_SUBSYS_RESET
 = 0x110,

1268 
	mNVME_SC_FW_NEEDS_RESET
 = 0x111,

1269 
	mNVME_SC_FW_NEEDS_MAX_TIME
 = 0x112,

1270 
	mNVME_SC_FW_ACIVATE_PROHIBITED
 = 0x113,

1271 
	mNVME_SC_OVERLAPPING_RANGE
 = 0x114,

1272 
	mNVME_SC_NS_INSUFFICENT_CAP
 = 0x115,

1273 
	mNVME_SC_NS_ID_UNAVAILABLE
 = 0x116,

1274 
	mNVME_SC_NS_ALREADY_ATTACHED
 = 0x118,

1275 
	mNVME_SC_NS_IS_PRIVATE
 = 0x119,

1276 
	mNVME_SC_NS_NOT_ATTACHED
 = 0x11a,

1277 
	mNVME_SC_THIN_PROV_NOT_SUPP
 = 0x11b,

1278 
	mNVME_SC_CTRL_LIST_INVALID
 = 0x11c,

1283 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

1284 
	mNVME_SC_INVALID_PI
 = 0x181,

1285 
	mNVME_SC_READ_ONLY
 = 0x182,

1286 
	mNVME_SC_ONCS_NOT_SUPPORTED
 = 0x183,

1291 
	mNVME_SC_CONNECT_FORMAT
 = 0x180,

1292 
	mNVME_SC_CONNECT_CTRL_BUSY
 = 0x181,

1293 
	mNVME_SC_CONNECT_INVALID_PARAM
 = 0x182,

1294 
	mNVME_SC_CONNECT_RESTART_DISC
 = 0x183,

1295 
	mNVME_SC_CONNECT_INVALID_HOST
 = 0x184,

1297 
	mNVME_SC_DISCOVERY_RESTART
 = 0x190,

1298 
	mNVME_SC_AUTH_REQUIRED
 = 0x191,

1303 
	mNVME_SC_WRITE_FAULT
 = 0x280,

1304 
	mNVME_SC_READ_ERROR
 = 0x281,

1305 
	mNVME_SC_GUARD_CHECK
 = 0x282,

1306 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

1307 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

1308 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

1309 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

1310 
	mNVME_SC_UNWRITTEN_BLOCK
 = 0x287,

1312 
	mNVME_SC_DNR
 = 0x4000,

1322 
	mNVME_SC_FC_TRANSPORT_ERROR
 = 0x00B0,

1325 
	mNVME_SC_FC_TRANSPORT_ABORTED
 = 0x00B1,

1328 
	snvme_com¶‘iÚ
 {

1332 
	unvme_»suÉ
 {

1333 
__Ë16
 
	mu16
;

1334 
__Ë32
 
	mu32
;

1335 
__Ë64
 
	mu64
;

1336 } 
	m»suÉ
;

1337 
__Ë16
 
	msq_h—d
;

1338 
__Ë16
 
	msq_id
;

1339 
__u16
 
	mcommªd_id
;

1340 
__Ë16
 
	m¡©us
;

1343 
	#NVME_VS
(
majÜ
, 
mšÜ
, 
‹¹Ÿry
) \

1344 (((
majÜ
è<< 16è| ((
mšÜ
è<< 8è| (
‹¹Ÿry
))

	)

1346 
	#NVME_MAJOR
(
v”
è((v”è>> 16)

	)

1347 
	#NVME_MINOR
(
v”
è(((v”è>> 8è& 0xff)

	)

1348 
	#NVME_TERTIARY
(
v”
è((v”è& 0xff)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


16 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	mİcode
;

22 
__u8
 
	mæags
;

23 
__u16
 
	mcÚŒŞ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mm‘ad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¦ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	m»áag
;

31 
__u16
 
	m­±ag
;

32 
__u16
 
	m­pmask
;

35 
	snvme_·s¡hru_cmd
 {

36 
__u8
 
	mİcode
;

37 
__u8
 
	mæags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mm‘ad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mm‘ad©a_Ën
;

45 
__u32
 
	md©a_Ën
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	m»suÉ
;

56 
	#KVS_SUCCESS
 0

	)

57 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

58 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

59 
	#KVS_ERR_CLOSE
 (-3)

	)

60 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

61 
	#KVS_ERR_CONT_NAME
 (-5)

	)

62 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

63 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

64 
	#KVS_ERR_GROUP
 (-8)

	)

65 
	#KVS_ERR_INDEX
 (-9)

	)

66 
	#KVS_ERR_IO
 (-10)

	)

67 
	#KVS_ERR_KEY
 (-11)

	)

68 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

69 
	#KVS_ERR_MEMORY
 (-13)

	)

70 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

71 
	#KVS_ERR_OFFSET
 (-15)

	)

72 
	#KVS_ERR_OPEN
 (-16)

	)

73 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

74 
	#KVS_ERR_PERMISSION
 (-18)

	)

75 
	#KVS_ERR_SPACE
 (-19)

	)

76 
	#KVS_ERR_TIMEOUT
 (-20)

	)

77 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

78 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

79 
	#KVS_ERR_VALUE
 (-23)

	)

82 
	snvme_·s¡hru_kv_cmd
 {

83 
__u8
 
	mİcode
;

84 
__u8
 
	mæags
;

85 
__u16
 
	mrsvd1
;

86 
__u32
 
	mnsid
;

87 
__u32
 
	mcdw2
;

88 
__u32
 
	mcdw3
;

89 
__u32
 
	mcdw4
;

90 
__u32
 
	mcdw5
;

91 
__u64
 
	md©a_addr
;

92 
__u32
 
	md©a_Ëngth
;

93 
__u32
 
	mkey_Ëngth
;

94 
__u32
 
	mcdw10
;

95 
__u32
 
	mcdw11
;

98 
__u64
 
	mkey_addr
;

99 
__u32
 
	mrsvd5
;

100 
__u32
 
	mrsvd6
;

102 
__u8
 
	mkey
[16];

104 
__u32
 
	mcdw12
;

105 
__u32
 
	mcdw13
;

106 
__u32
 
	mcdw14
;

107 
__u32
 
	mcdw15
;

110 
__u32
 
	mtimeout_ms
;

111 
__u32
 
	m»suÉ
;

112 
__u32
 
	m¡©us
;

113 
__u32
 
	mùxid
;

114 
__u64
 
	m»qid
;

117 
	snvme_aioùx
 {

118 
__u32
 
	mùxid
;

119 
__u32
 
	mev’tfd
;

123 
	snvme_aiÛv’t
 {

124 
__u64
 
	m»qid
;

125 
__u32
 
	mùxid
;

126 
__u32
 
	m»suÉ
;

127 
__u16
 
	m¡©us
;

130 
	#MAX_AIO_EVENTS
 128

	)

131 
	snvme_aiÛv’ts
 {

132 
__u16
 
	mÄ
;

133 
__u32
 
	mùxid
;

134 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

138 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

140 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

141 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

142 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

143 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

144 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

145 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

146 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

148 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

149 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

150 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

151 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

152 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/nvme.h

13 #iâdeà
_NVME_H


14 
	#_NVME_H


	)

19 
	#KSID_SUPPORT


	)

22 
	~"lšux_nvme.h
"

23 
	~<lšux/pci.h
>

24 
	~<lšux/k»f.h
>

25 
	~<lšux/blk-mq.h
>

26 
	~<lšux/lighŠvm.h
>

27 
	~<lšux/£d-İ®.h
>

30 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

31 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

32 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

33 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

34 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

35 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

36 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

37 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

38 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

39 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

40 
	`is_kv_exi¡_cmd
(
İcode
))

	)

44 
nvme_io_timeout
;

45 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

47 
admš_timeout
;

48 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

50 
	#NVME_DEFAULT_KATO
 5

	)

51 
	#NVME_KATO_GRACE
 10

	)

53 
wÜkqueue_¡ruù
 *
nvme_wq
;

56 
	mNVME_NS_LBA
 = 0,

57 
	mNVME_NS_LIGHTNVM
 = 1,

64 
	envme_quœks
 {

69 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

75 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

81 
	mNVME_QUIRK_DEALLOCATE_ZEROES
 = (1 << 2),

87 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

92 
	mNVME_QUIRK_NO_APST
 = (1 << 4),

97 
	mNVME_QUIRK_NO_DEEPEST_PS
 = (1 << 5),

104 
	snvme_»que¡
 {

105 
nvme_commªd
 *
	mcmd
;

106 
nvme_»suÉ
 
	m»suÉ
;

107 
u8
 
	m»Œ›s
;

108 
u8
 
	mæags
;

109 
u16
 
	m¡©us
;

113 
	snvme_io_·¿m
 {

114 
nvme_»que¡
 
	m»q
;

115 
sÿ‰”li¡
* 
	mkv_d©a_sg_±r
;

116 
sÿ‰”li¡
* 
	mkv_m‘a_sg_±r
;

117 
	mkv_d©a_ÃÁs
;

118 
	mkv_d©a_Ën
;

121 
šlše
 
nvme_io_·¿m
 *
	$nvme_io_·¿m
(
»que¡
 *
»q
)

123  
	`blk_mq_rq_to_pdu
(
»q
);

124 
	}
}

128 
	mNVME_REQ_CANCELLED
 = (1 << 0),

131 
šlše
 
nvme_»que¡
 *
	$nvme_»q
(
»que¡
 *
»q
)

133  
	`blk_mq_rq_to_pdu
(
»q
);

134 
	}
}

141 
	#NVME_QUIRK_DELAY_AMOUNT
 2000

	)

143 
	envme_ù¾_¡©e
 {

144 
	mNVME_CTRL_NEW
,

145 
	mNVME_CTRL_LIVE
,

146 
	mNVME_CTRL_RESETTING
,

147 
	mNVME_CTRL_RECONNECTING
,

148 
	mNVME_CTRL_DELETING
,

149 
	mNVME_CTRL_DEAD
,

152 
	snvme_ù¾
 {

153 
nvme_ù¾_¡©e
 
	m¡©e
;

154 
boŞ
 
	mid’tif›d
;

155 
¥šlock_t
 
	mlock
;

156 cÚ¡ 
nvme_ù¾_İs
 *
	mİs
;

157 
»que¡_queue
 *
	madmš_q
;

158 
»que¡_queue
 *
	mcÚÃù_q
;

159 
deviû
 *
	mdev
;

160 
k»f
 
	mk»f
;

161 
	mš¡ªû
;

162 
blk_mq_g_£t
 *
	mg£t
;

163 
li¡_h—d
 
	mÇme¥aûs
;

164 
mu‹x
 
	mÇme¥aûs_mu‹x
;

165 
deviû
 *
	mdeviû
;

166 
li¡_h—d
 
	mnode
;

167 
ida
 
	mns_ida
;

168 
wÜk_¡ruù
 
	m»£t_wÜk
;

170 
İ®_dev
 *
	mİ®_dev
;

172 
	mÇme
[12];

173 
	m£rŸl
[20];

174 
	mmod–
[40];

175 
	mfœmw¬e_»v
[8];

176 
	msubnqn
[
NVMF_NQN_SIZE
];

177 
u16
 
	múid
;

179 
u32
 
	mù¾_cÚfig
;

180 
u32
 
	mqueue_couÁ
;

182 
u64
 
	mÿp
;

183 
u32
 
	m·ge_size
;

184 
u32
 
	mmax_hw_£ùÜs
;

185 
u16
 
	mÚcs
;

186 
u16
 
	mvid
;

187 
u16
 
	mßcs
;

188 
u16
 
	mns§
;

189 
u16
 
	mÄ_¡»ams
;

190 
©omic_t
 
	mabÜt_lim™
;

191 
u8
 
	mev’t_lim™
;

192 
u8
 
	mvwc
;

193 
u32
 
	mvs
;

194 
u32
 
	msgls
;

195 
u16
 
	mkas
;

196 
u8
 
	mÅss
;

197 
u8
 
	m­¡a
;

198 
	mk©o
;

199 
boŞ
 
	msubsy¡em
;

200 
	mquœks
;

201 
nvme_id_pow”_¡©e
 
	mpsd
[32];

202 
wÜk_¡ruù
 
	msÿn_wÜk
;

203 
wÜk_¡ruù
 
	masync_ev’t_wÜk
;

204 
d–ayed_wÜk
 
	mka_wÜk
;

207 
u64
 
	mps_max_Ï‹ncy_us
;

208 
boŞ
 
	m­¡_’abËd
;

210 
u32
 
	mhm´e
;

211 
u32
 
	mhmmš
;

214 
u16
 
	msqsize
;

215 
u32
 
	mioccsz
;

216 
u32
 
	miÜcsz
;

217 
u16
 
	micdoff
;

218 
u16
 
	mmaxcmd
;

219 
	mÄ_»cÚÃùs
;

220 
nvmf_ù¾_İtiÚs
 *
	mİts
;

223 
	snvme_ns
 {

224 
li¡_h—d
 
	mli¡
;

226 
nvme_ù¾
 *
	mù¾
;

227 
»que¡_queue
 *
	mqueue
;

228 
g’disk
 *
	mdisk
;

229 
nvm_dev
 *
	mndev
;

230 
k»f
 
	mk»f
;

231 
	mš¡ªû
;

233 
u8
 
	meui
[8];

234 
u8
 
	mnguid
[16];

235 
uuid_t
 
	muuid
;

237 
	mns_id
;

238 
	mlba_shiá
;

239 
u16
 
	mms
;

240 
u16
 
	msgs
;

241 
u32
 
	msws
;

242 
boŞ
 
	mext
;

243 
u8
 
	mpi_ty³
;

244 
	mæags
;

245 
u16
 
	mnoiob
;

247 
	#NVME_NS_REMOVING
 0

	)

248 
	#NVME_NS_DEAD
 1

	)

250 
u64
 
	mmode_£Ëù_num_blocks
;

251 
u32
 
	mmode_£Ëù_block_Ën
;

254 
	snvme_ù¾_İs
 {

255 cÚ¡ *
	mÇme
;

256 
moduË
 *
	mmoduË
;

257 
	mæags
;

258 
	#NVME_F_FABRICS
 (1 << 0)

	)

259 
	#NVME_F_METADATA_SUPPORTED
 (1 << 1)

	)

260 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

261 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

262 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

263 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

264 (*
	msubm™_async_ev’t
)(
nvme_ù¾
 *
	mù¾
, 
	m«r_idx
);

265 (*
	md–‘e_ù¾
)(
nvme_ù¾
 *
	mù¾
);

266 (*
	mg‘_add»ss
)(
nvme_ù¾
 *
	mù¾
, *
	mbuf
, 
	msize
);

269 
šlše
 
boŞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

271 
u32
 
v®
 = 0;

273 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

274  
çl£
;

275  
v®
 & 
NVME_CSTS_RDY
;

276 
	}
}

278 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

280 ià(!
ù¾
->
subsy¡em
)

281  -
ENOTTY
;

282  
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

283 
	}
}

285 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

287  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

288 
	}
}

290 
šlše
 
	$nvme_ş—nup_cmd
(
»que¡
 *
»q
)

292 ià(
»q
->
rq_æags
 & 
RQF_SPECIAL_PAYLOAD
) {

293 
	`kä“
(
	`·ge_add»ss
(
»q
->
¥ecŸl_vec
.
bv_·ge
) +

294 
»q
->
¥ecŸl_vec
.
bv_off£t
);

296 
	}
}

298 
šlše
 
	$nvme_’d_»que¡
(
»que¡
 *
»q
, 
__Ë16
 
¡©us
,

299 
nvme_»suÉ
 
»suÉ
)

301 
nvme_»que¡
 *
rq
 = 
	`nvme_»q
(
»q
);

303 
rq
->
¡©us
 = 
	`Ë16_to_ıu
(status) >> 1;

304 
rq
->
»suÉ
 =„esult;

305 
	`blk_mq_com¶‘e_»que¡
(
»q
);

306 
	}
}

308 
nvme_com¶‘e_rq
(
»que¡
 *
»q
);

309 
nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
);

310 
boŞ
 
nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

311 
nvme_ù¾_¡©e
 
Ãw_¡©e
);

312 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

313 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

314 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

315 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

316 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
);

317 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

318 
nvme_¡¬t_ù¾
(
nvme_ù¾
 *
ù¾
);

319 
nvme_¡İ_ù¾
(
nvme_ù¾
 *
ù¾
);

320 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

321 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

323 
nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
);

324 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

326 
nvme_£c_subm™
(*
d©a
, 
u16
 
¥¥
, 
u8
 
£ı
, *
bufãr
, 
size_t
 
Ën
,

327 
boŞ
 
£nd
);

329 
	#NVME_NR_AERS
 1

	)

330 
nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

331 
nvme_»suÉ
 *
»s
);

332 
nvme_queue_async_ev’ts
(
nvme_ù¾
 *
ù¾
);

334 
nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
);

335 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

336 
nvme_kl_queues
(
nvme_ù¾
 *
ù¾
);

337 
nvme_unä“ze
(
nvme_ù¾
 *
ù¾
);

338 
nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
);

339 
nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
);

340 
nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
);

342 
	#NVME_QID_ANY
 -1

	)

343 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

344 
nvme_commªd
 *
cmd
, 
æags
, 
qid
);

345 
blk_¡©us_t
 
nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

346 
nvme_commªd
 *
cmd
);

347 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

348 *
buf
, 
bufæ’
);

349 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

350 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

351 
timeout
, 
qid
, 
©_h—d
, 
æags
);

352 
nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

353 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

354 
timeout
);

355 
__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

356 
__u£r
 *
ubufãr
, 
bufæ’
,

357 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

358 
u32
 *
»suÉ
, 
timeout
);

359 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

360 
nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

361 
nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

362 
nvme_»£t_ù¾
(
nvme_ù¾
 *
ù¾
);

364 #ifdeà
CONFIG_NVM


365 
nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
);

366 
nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
);

367 
nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
);

368 
nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
);

369 
nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
);

370 
nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
);

372 
šlše
 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
,

373 
node
)

376 
	}
}

378 
šlše
 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
è{
	}
};

379 
šlše
 
	$nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
)

382 
	}
}

383 
šlše
 
	$nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
è{
	}
};

384 
šlše
 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

387 
	}
}

388 
šlše
 
	$nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
,

389 
¬g
)

391  -
ENOTTY
;

392 
	}
}

395 
šlše
 
nvme_ns
 *
	$nvme_g‘_ns_äom_dev
(
deviû
 *
dev
)

397  
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

398 
	}
}

400 
__š™
 
nvme_cÜe_š™
();

401 
nvme_cÜe_ex™
();

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/b™İs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/blk-mq.h
>

19 
	~<lšux/blk-mq-pci.h
>

20 
	~<lšux/dmi.h
>

21 
	~<lšux/š™.h
>

22 
	~<lšux/š‹¼u±.h
>

23 
	~<lšux/io.h
>

24 
	~<lšux/mm.h
>

25 
	~<lšux/moduË.h
>

26 
	~<lšux/mu‹x.h
>

27 
	~<lšux/pci.h
>

28 
	~<lšux/poisÚ.h
>

29 
	~<lšux/t10-pi.h
>

30 
	~<lšux/tim”.h
>

31 
	~<lšux/ty³s.h
>

32 
	~<lšux/io-64-nÚ©omic-lo-hi.h
>

33 
	~<asm/uÇligÃd.h
>

34 
	~<lšux/£d-İ®.h
>

36 
	~"nvme.h
"

38 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

39 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

45 
	#NVME_AQ_BLKMQ_DEPTH
 (
NVME_AQ_DEPTH
 - 
NVME_NR_AERS
)

	)

47 
	gu£_th»aded_š‹¼u±s
;

48 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

50 
boŞ
 
	gu£_cmb_sqes
 = 
Œue
;

51 
moduË_·¿m
(
u£_cmb_sqes
, 
boŞ
, 0644);

52 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

54 
	gmax_ho¡_mem_size_mb
 = 128;

55 
moduË_·¿m
(
max_ho¡_mem_size_mb
, 
ušt
, 0444);

56 
MODULE_PARM_DESC
(
max_ho¡_mem_size_mb
,

59 
io_queue_d•th_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
);

60 cÚ¡ 
k”Ãl_·¿m_İs
 
	gio_queue_d•th_İs
 = {

61 .
£t
 = 
io_queue_d•th_£t
,

62 .
	gg‘
 = 
·¿m_g‘_št
,

65 
	gio_queue_d•th
 = 1024;

66 
moduË_·¿m_cb
(
io_queue_d•th
, &
io_queue_d•th_İs
, &io_queue_depth, 0644);

67 
MODULE_PARM_DESC
(
io_queue_d•th
, "set io queue depth, should >= 2");

69 
	gnvme_dev
;

70 
	gnvme_queue
;

72 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

73 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
);

78 
	snvme_dev
 {

79 
nvme_queue
 **
	mqueues
;

80 
blk_mq_g_£t
 
	mg£t
;

81 
blk_mq_g_£t
 
	madmš_g£t
;

82 
u32
 
__iomem
 *
	mdbs
;

83 
deviû
 *
	mdev
;

84 
dma_poŞ
 *
	m´p_·ge_poŞ
;

85 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

86 
	mÚlše_queues
;

87 
	mmax_qid
;

88 
	mq_d•th
;

89 
u32
 
	mdb_¡ride
;

90 
__iomem
 *
	mb¬
;

91 
	mb¬_m­³d_size
;

92 
wÜk_¡ruù
 
	m»move_wÜk
;

93 
mu‹x
 
	mshutdown_lock
;

94 
boŞ
 
	msubsy¡em
;

95 
__iomem
 *
	mcmb
;

96 
pci_bus_addr_t
 
	mcmb_bus_addr
;

97 
u64
 
	mcmb_size
;

98 
u32
 
	mcmbsz
;

99 
u32
 
	mcmbloc
;

100 
nvme_ù¾
 
	mù¾
;

101 
com¶‘iÚ
 
	mioq_wa™
;

104 
u32
 *
	mdbbuf_dbs
;

105 
dma_addr_t
 
	mdbbuf_dbs_dma_addr
;

106 
u32
 *
	mdbbuf_eis
;

107 
dma_addr_t
 
	mdbbuf_eis_dma_addr
;

110 
u64
 
	mho¡_mem_size
;

111 
u32
 
	mÄ_ho¡_mem_descs
;

112 
dma_addr_t
 
	mho¡_mem_descs_dma
;

113 
nvme_ho¡_mem_buf_desc
 *
	mho¡_mem_descs
;

114 **
	mho¡_mem_desc_bufs
;

117 
	$io_queue_d•th_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

119 
n
 = 0, 
»t
;

121 
»t
 = 
	`k¡¹ošt
(
v®
, 10, &
n
);

122 ià(
»t
 !ğ0 || 
n
 < 2)

123  -
EINVAL
;

125  
	`·¿m_£t_št
(
v®
, 
kp
);

126 
	}
}

128 
šlše
 
	$sq_idx
(
qid
, 
u32
 
¡ride
)

130  
qid
 * 2 * 
¡ride
;

131 
	}
}

133 
šlše
 
	$cq_idx
(
qid
, 
u32
 
¡ride
)

135  (
qid
 * 2 + 1è* 
¡ride
;

136 
	}
}

138 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

140  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

141 
	}
}

147 
	snvme_queue
 {

148 
deviû
 *
	mq_dmadev
;

149 
nvme_dev
 *
	mdev
;

150 
¥šlock_t
 
	mq_lock
;

151 
nvme_commªd
 *
	msq_cmds
;

152 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

153 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

154 
blk_mq_gs
 **
	mgs
;

155 
dma_addr_t
 
	msq_dma_addr
;

156 
dma_addr_t
 
	mcq_dma_addr
;

157 
u32
 
__iomem
 *
	mq_db
;

158 
u16
 
	mq_d•th
;

159 
s16
 
	mcq_veùÜ
;

160 
u16
 
	msq_
;

161 
u16
 
	mcq_h—d
;

162 
u16
 
	mqid
;

163 
u8
 
	mcq_pha£
;

164 
u8
 
	mcqe_£’
;

165 
u32
 *
	mdbbuf_sq_db
;

166 
u32
 *
	mdbbuf_cq_db
;

167 
u32
 *
	mdbbuf_sq_ei
;

168 
u32
 *
	mdbbuf_cq_ei
;

177 
	snvme_iod
 {

179 
nvme_io_·¿m
 
	m·¿m
;

181 
nvme_»que¡
 
	m»q
;

183 
nvme_queue
 *
	mnvmeq
;

185 
	mkv_cmd
;

186 
	mr£rv
;

188 
	mabÜ‹d
;

189 
	mÅages
;

190 
	mÃÁs
;

191 
	mËngth
;

192 
dma_addr_t
 
	mfœ¡_dma
;

193 
sÿ‰”li¡
 
	mm‘a_sg
;

194 
sÿ‰”li¡
 *
	msg
;

195 
sÿ‰”li¡
 
	mšlše_sg
[0];

201 
šlše
 
	$_nvme_check_size
()

203 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

204 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

205 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

206 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

207 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

208 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

209 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

210 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

211 
	`BUILD_BUG_ON
((
nvme_id_ù¾
è!ğ
NVME_IDENTIFY_DATA_SIZE
);

212 
	`BUILD_BUG_ON
((
nvme_id_ns
è!ğ
NVME_IDENTIFY_DATA_SIZE
);

213 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

214 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

215 
	`BUILD_BUG_ON
((
nvme_dbbuf
) != 64);

216 
	}
}

218 
šlše
 
	$nvme_dbbuf_size
(
u32
 
¡ride
)

220  ((
	`num_possibË_ıus
(è+ 1è* 8 * 
¡ride
);

221 
	}
}

223 
	$nvme_dbbuf_dma_®loc
(
nvme_dev
 *
dev
)

225 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_¡ride
);

227 ià(
dev
->
dbbuf_dbs
)

230 
dev
->
dbbuf_dbs
 = 
	`dma_®loc_coh”’t
(dev->dev, 
mem_size
,

231 &
dev
->
dbbuf_dbs_dma_addr
,

232 
GFP_KERNEL
);

233 ià(!
dev
->
dbbuf_dbs
)

234  -
ENOMEM
;

235 
dev
->
dbbuf_eis
 = 
	`dma_®loc_coh”’t
(dev->dev, 
mem_size
,

236 &
dev
->
dbbuf_eis_dma_addr
,

237 
GFP_KERNEL
);

238 ià(!
dev
->
dbbuf_eis
) {

239 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

240 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

241 
dev
->
dbbuf_dbs
 = 
NULL
;

242  -
ENOMEM
;

246 
	}
}

248 
	$nvme_dbbuf_dma_ä“
(
nvme_dev
 *
dev
)

250 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_¡ride
);

252 ià(
dev
->
dbbuf_dbs
) {

253 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

254 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

255 
dev
->
dbbuf_dbs
 = 
NULL
;

257 ià(
dev
->
dbbuf_eis
) {

258 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

259 
dev
->
dbbuf_eis
, dev->
dbbuf_eis_dma_addr
);

260 
dev
->
dbbuf_eis
 = 
NULL
;

262 
	}
}

264 
	$nvme_dbbuf_š™
(
nvme_dev
 *
dev
,

265 
nvme_queue
 *
nvmeq
, 
qid
)

267 ià(!
dev
->
dbbuf_dbs
 || !
qid
)

270 
nvmeq
->
dbbuf_sq_db
 = &
dev
->
dbbuf_dbs
[
	`sq_idx
(
qid
, dev->
db_¡ride
)];

271 
nvmeq
->
dbbuf_cq_db
 = &
dev
->
dbbuf_dbs
[
	`cq_idx
(
qid
, dev->
db_¡ride
)];

272 
nvmeq
->
dbbuf_sq_ei
 = &
dev
->
dbbuf_eis
[
	`sq_idx
(
qid
, dev->
db_¡ride
)];

273 
nvmeq
->
dbbuf_cq_ei
 = &
dev
->
dbbuf_eis
[
	`cq_idx
(
qid
, dev->
db_¡ride
)];

274 
	}
}

276 
	$nvme_dbbuf_£t
(
nvme_dev
 *
dev
)

278 
nvme_commªd
 
c
;

280 ià(!
dev
->
dbbuf_dbs
)

283 
	`mem£t
(&
c
, 0, (c));

284 
c
.
dbbuf
.
İcode
 = 
nvme_admš_dbbuf
;

285 
c
.
dbbuf
.
´p1
 = 
	`ıu_to_Ë64
(
dev
->
dbbuf_dbs_dma_addr
);

286 
c
.
dbbuf
.
´p2
 = 
	`ıu_to_Ë64
(
dev
->
dbbuf_eis_dma_addr
);

288 ià(
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0)) {

289 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "unableo set dbbuf\n");

291 
	`nvme_dbbuf_dma_ä“
(
dev
);

293 
	}
}

295 
šlše
 
	$nvme_dbbuf_Ãed_ev’t
(
u16
 
ev’t_idx
, u16 
Ãw_idx
, u16 
Şd
)

297  (
u16
)(
Ãw_idx
 - 
ev’t_idx
 - 1è< (u16)Òew_idx - 
Şd
);

298 
	}
}

301 
boŞ
 
	$nvme_dbbuf_upd©e_ªd_check_ev’t
(
u16
 
v®ue
, 
u32
 *
dbbuf_db
,

302 vŞ©
u32
 *
dbbuf_ei
)

304 ià(
dbbuf_db
) {

305 
u16
 
Şd_v®ue
;

311 
	`wmb
();

313 
Şd_v®ue
 = *
dbbuf_db
;

314 *
dbbuf_db
 = 
v®ue
;

316 ià(!
	`nvme_dbbuf_Ãed_ev’t
(*
dbbuf_ei
, 
v®ue
, 
Şd_v®ue
))

317  
çl£
;

320  
Œue
;

321 
	}
}

326 
	#NVME_INT_PAGES
 2

	)

327 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

334 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

336 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

337 
dev
->
ù¾
.
·ge_size
);

338  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

339 
	}
}

341 
	$nvme_iod_®loc_size
(
nvme_dev
 *
dev
,

342 
size
, 
n£g
)

344  (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
) +

345 (
sÿ‰”li¡
è* 
n£g
;

346 
	}
}

348 
	$nvme_cmd_size
(
nvme_dev
 *
dev
)

350  (
nvme_iod
) +

351 
	`nvme_iod_®loc_size
(
dev
, 
	`NVME_INT_BYTES
(dev), 
NVME_INT_PAGES
);

352 
	}
}

354 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

355 
hùx_idx
)

357 
nvme_dev
 *
dev
 = 
d©a
;

358 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

360 
	`WARN_ON
(
hùx_idx
 != 0);

361 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

362 
	`WARN_ON
(
nvmeq
->
gs
);

364 
hùx
->
driv”_d©a
 = 
nvmeq
;

365 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

367 
	}
}

369 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

371 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

373 
nvmeq
->
gs
 = 
NULL
;

374 
	}
}

376 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

377 
hùx_idx
)

379 
nvme_dev
 *
dev
 = 
d©a
;

380 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

382 ià(!
nvmeq
->
gs
)

383 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

385 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

386 
hùx
->
driv”_d©a
 = 
nvmeq
;

388 
	}
}

390 
	$nvme_š™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
»q
,

391 
hùx_idx
, 
numa_node
)

393 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

394 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

395 
queue_idx
 = (
£t
 =ğ&
dev
->
g£t
è? 
hùx_idx
 + 1 : 0;

396 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
queue_idx
];

398 
	`BUG_ON
(!
nvmeq
);

399 
iod
->
nvmeq
 =‚vmeq;

401 
	}
}

403 
	$nvme_pci_m­_queues
(
blk_mq_g_£t
 *
£t
)

405 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

407  
	`blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev));

408 
	}
}

417 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
,

418 
nvme_commªd
 *
cmd
)

420 
u16
 

 = 
nvmeq
->
sq_
;

422 ià(
nvmeq
->
sq_cmds_io
)

423 
	`memıy_toio
(&
nvmeq
->
sq_cmds_io
[

], 
cmd
, (*cmd));

425 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

427 ià(++

 =ğ
nvmeq
->
q_d•th
)

428 

 = 0;

429 ià(
	`nvme_dbbuf_upd©e_ªd_check_ev’t
(

, 
nvmeq
->
dbbuf_sq_db
,

430 
nvmeq
->
dbbuf_sq_ei
))

431 
	`wr™–
(

, 
nvmeq
->
q_db
);

432 
nvmeq
->
sq_
 = 

;

433 
	}
}

435 
__Ë64
 **
	$iod_li¡
(
»que¡
 *
»q
)

437 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

438  (
__Ë64
 **)(
iod
->
sg
 + 
	`blk_rq_Ä_phys_£gm’ts
(
»q
));

439 
	}
}

442 
blk_¡©us_t
 
	$__nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
, 
boŞ
 
kv_cmd
)

444 
blk_¡©us_t
 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

447 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

449 
n£g
;

450 
size
;

452 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
rq
);

453 
size
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

457 ià(
kv_cmd
) {

458 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

459 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

460 
size
 = 
·¿m
->
kv_d©a_Ën
;

462 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
rq
);

463 
size
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

467 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

468 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

469 ià(!
iod
->
sg
)

470  
BLK_STS_RESOURCE
;

472 
iod
->
sg
 = iod->
šlše_sg
;

475 
iod
->
kv_cmd
 = 0;

477 
iod
->
abÜ‹d
 = 0;

478 
iod
->
Åages
 = -1;

479 
iod
->
ÃÁs
 = 0;

480 
iod
->
Ëngth
 = 
size
;

482  
BLK_STS_OK
;

483 
	}
}

487 
blk_¡©us_t
 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

489  
	`__nvme_š™_iod
(
rq
, 
dev
, 
çl£
);

490 
	}
}

492 
blk_¡©us_t
 
	$nvme_š™_iod_fÜ_kv
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

494  
	`__nvme_š™_iod
(
rq
, 
dev
, 
Œue
);

495 
	}
}

499 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

501 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

502 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / 8 - 1;

503 
i
;

504 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

505 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

507 ià(
iod
->
Åages
 == 0)

508 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

509 
i
 = 0; i < 
iod
->
Åages
; i++) {

510 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

511 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

512 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

513 
´p_dma
 = 
Ãxt_´p_dma
;

516 ià(
iod
->
sg
 !ğiod->
šlše_sg
)

517 
	`kä“
(
iod
->
sg
);

518 
	}
}

520 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


521 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

523 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
v
)

524 
pi
->
»f_g
 = 
	`ıu_to_be32
(
p
);

525 
	}
}

527 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

529 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
p
)

530 
pi
->
»f_g
 = 
	`ıu_to_be32
(
v
);

531 
	}
}

543 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

544 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

546 
nvme_ns
 *
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

547 
bio_š‹gr™y_·ylßd
 *
b
;

548 
t10_pi_tu¶e
 *
pi
;

549 *
p
, *
pm­
;

550 
u32
 
i
, 
Æb
, 
ts
, 
phys
, 
vœt
;

552 ià(!
ns
->
pi_ty³
 ||‚s->pi_ty³ =ğ
NVME_NS_DPS_PI_TYPE3
)

555 
b
 = 
	`bio_š‹gr™y
(
»q
->
bio
);

556 ià(!
b
)

559 
pm­
 = 
	`km­_©omic
(
b
->
b_vec
->
bv_·ge
è+ b->b_vec->
bv_off£t
;

561 
p
 = 
pm­
;

562 
vœt
 = 
	`b_g‘_£ed
(
b
);

563 
phys
 = 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
));

564 
Æb
 = (
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

565 
ts
 = 
ns
->
disk
->
queue
->
š‹gr™y
.
tu¶e_size
;

567 
i
 = 0; i < 
Æb
; i++, 
vœt
++, 
phys
++) {

568 
pi
 = (
t10_pi_tu¶e
 *)
p
;

569 
	`dif_sw­
(
phys
, 
vœt
, 
pi
);

570 
p
 +ğ
ts
;

572 
	`kunm­_©omic
(
pm­
);

573 
	}
}

575 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

576 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

578 
	}
}

579 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

581 
	}
}

582 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

584 
	}
}

588 
blk_¡©us_t
 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

590 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

591 
dma_poŞ
 *
poŞ
;

593 
Ëngth
;

595 
Ëngth
 = 
	`blk_rq_·ylßd_by‹s
(
»q
);

597 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

598 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

599 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

600 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

601 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

602 
__Ë64
 *
´p_li¡
;

603 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

604 
dma_addr_t
 
´p_dma
;

605 
Å½s
, 
i
;

608 ià(
iod
->
kv_cmd
) {

609 
Ëngth
 = 
iod
->
·¿m
.
kv_d©a_Ën
;

611 
Ëngth
 = 
	`blk_rq_·ylßd_by‹s
(
»q
);

615 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

616 ià(
Ëngth
 <= 0)

617  
BLK_STS_OK
;

619 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

620 ià(
dma_Ën
) {

621 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

623 
sg
 = 
	`sg_Ãxt
(sg);

624 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

625 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

628 ià(
Ëngth
 <ğ
·ge_size
) {

629 
iod
->
fœ¡_dma
 = 
dma_addr
;

630  
BLK_STS_OK
;

633 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

634 ià(
Å½s
 <= (256 / 8)) {

635 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

636 
iod
->
Åages
 = 0;

638 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

639 
iod
->
Åages
 = 1;

642 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

643 ià(!
´p_li¡
) {

644 
iod
->
fœ¡_dma
 = 
dma_addr
;

645 
iod
->
Åages
 = -1;

646  
BLK_STS_RESOURCE
;

648 
li¡
[0] = 
´p_li¡
;

649 
iod
->
fœ¡_dma
 = 
´p_dma
;

650 
i
 = 0;

652 ià(
i
 =ğ
·ge_size
 >> 3) {

653 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

654 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

655 ià(!
´p_li¡
)

656  
BLK_STS_RESOURCE
;

657 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

658 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

659 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

660 
i
 = 1;

662 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

663 
dma_Ën
 -ğ
·ge_size
;

664 
dma_addr
 +ğ
·ge_size
;

665 
Ëngth
 -ğ
·ge_size
;

666 ià(
Ëngth
 <= 0)

668 ià(
dma_Ën
 > 0)

670 ià(
	`uÆik–y
(
dma_Ën
 < 0))

671 
bad_sgl
;

672 
sg
 = 
	`sg_Ãxt
(sg);

673 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

674 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

677  
BLK_STS_OK
;

679 
bad_sgl
:

680 ià(
	`WARN_ONCE
(1, "Invalid SGL for…ayload:%d‚ents:%d\n",

681 
	`blk_rq_·ylßd_by‹s
(
»q
), 
iod
->
ÃÁs
)) {

682 
	`fÜ_—ch_sg
(
iod
->
sg
, sg, iod->
ÃÁs
, 
i
) {

683 
dma_addr_t
 
phys
 = 
	`sg_phys
(
sg
);

684 
	`´_w¬n
("sg[%d]…hys_addr:%pad offset:%d†ength:%d "

685 "dma_add»ss:%·d dma_Ëngth:%d\n", 
i
, &
phys
,

686 
sg
->
off£t
, sg->
Ëngth
,

687 &
	`sg_dma_add»ss
(
sg
),

688 
	`sg_dma_Ën
(
sg
));

691  
BLK_STS_IOERR
;

693 
	}
}

696 
blk_¡©us_t
 
	$nvme_kv_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

697 
nvme_commªd
 *
cmnd
)

699 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

700 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

701 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

702 
blk_¡©us_t
 
»t
 = 
BLK_STS_IOERR
;

704 ià(
·¿m
->
kv_d©a_sg_±r
) {

705 
sÿ‰”li¡
* 
sg
;

706 
i
;

708 
	`fÜ_—ch_sg
(
·¿m
->
kv_d©a_sg_±r
, 
sg
,…¬am->
kv_d©a_ÃÁs
, 
i
) {

709 
iod
->
sg
[
i
] = *sg;

711 
iod
->
ÃÁs
 = 
·¿m
->
kv_d©a_ÃÁs
;

712 
»t
 = 
BLK_STS_RESOURCE
;

713 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

714 
DMA_ATTR_NO_WARN
))

715 
out
;

717 
»t
 = 
	`nvme_£tup_´ps
(
dev
, 
»q
);

718 ià(
»t
 !ğ
BLK_STS_OK
)

719 
out_unm­
;

721 
cmnd
->
kv_¡Üe
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

722 
cmnd
->
kv_¡Üe
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

724 
»t
 = 
BLK_STS_IOERR
;

726 ià(
·¿m
->
kv_m‘a_sg_±r
)

728 ià(!
	`dma_m­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
))

729 
out_unm­
;

730 
cmnd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
·¿m
->
kv_m‘a_sg_±r
));

732  
BLK_STS_OK
;

734 
out_unm­
:

735 ià(
·¿m
->
kv_d©a_sg_±r
)

736 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

737 
out
:

738  
»t
;

739 
	}
}

742 
	$nvme_kv_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

744 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

745 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

746 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

748 ià(
·¿m
->
kv_d©a_sg_±r
) {

749 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

751 ià(
·¿m
->
kv_m‘a_sg_±r
)

753 
	`dma_unm­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
);

755 
	`nvme_ş—nup_cmd
(
»q
);

756 
	`nvme_ä“_iod
(
dev
, 
»q
);

757 
	}
}

761 
blk_¡©us_t
 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

762 
nvme_commªd
 *
cmnd
)

764 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

765 
»que¡_queue
 *
q
 = 
»q
->q;

766 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

767 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

768 
blk_¡©us_t
 
»t
 = 
BLK_STS_IOERR
;

770 ià(
	`is_kv_cmd
(
cmnd
->
commÚ
.
İcode
)) {

771  
	`nvme_kv_m­_d©a
(
dev
, 
»q
, 
cmnd
);

774 
	`sg_š™_bË
(
iod
->
sg
, 
	`blk_rq_Ä_phys_£gm’ts
(
»q
));

775 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

776 ià(!
iod
->
ÃÁs
)

777 
out
;

779 
»t
 = 
BLK_STS_RESOURCE
;

780 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

781 
DMA_ATTR_NO_WARN
))

782 
out
;

784 
»t
 = 
	`nvme_£tup_´ps
(
dev
, 
»q
);

785 ià(
»t
 !ğ
BLK_STS_OK
)

786 
out_unm­
;

788 
»t
 = 
BLK_STS_IOERR
;

789 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

790 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

791 
out_unm­
;

793 
	`sg_š™_bË
(&
iod
->
m‘a_sg
, 1);

794 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, &
iod
->
m‘a_sg
) != 1)

795 
out_unm­
;

797 ià(
	`rq_d©a_dœ
(
»q
))

798 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_´•
);

800 ià(!
	`dma_m­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
))

801 
out_unm­
;

804 
cmnd
->
rw
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

805 
cmnd
->
rw
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

806 ià(
	`blk_š‹gr™y_rq
(
»q
))

807 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(&
iod
->
m‘a_sg
));

808  
BLK_STS_OK
;

810 
out_unm­
:

811 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

812 
out
:

813  
»t
;

814 
	}
}

816 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

818 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

819 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

820 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

822 ià(
iod
->
kv_cmd
) {

823  
	`nvme_kv_unm­_d©a
(
dev
, 
»q
);

826 ià(
iod
->
ÃÁs
) {

827 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

828 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

829 ià(!
	`rq_d©a_dœ
(
»q
))

830 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_com¶‘e
);

831 
	`dma_unm­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
);

835 
	`nvme_ş—nup_cmd
(
»q
);

836 
	`nvme_ä“_iod
(
dev
, 
»q
);

837 
	}
}

842 
blk_¡©us_t
 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

843 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

845 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

846 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

847 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

848 
»que¡
 *
»q
 = 
bd
->
rq
;

849 
nvme_commªd
 
cmnd
;

850 
blk_¡©us_t
 
»t
;

852 
boŞ
 
b_kv_cmd
 = 
çl£
;

854 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
»q
, &
cmnd
);

855 ià(
»t
)

856  
»t
;

859 
b_kv_cmd
 = 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
);

860 ià(
b_kv_cmd
) {

861 
»t
 = 
	`nvme_š™_iod_fÜ_kv
(
»q
, 
dev
);

862 ià(
»t
)

863 
out_ä“_cmd
;

865 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

866 ià(
»t
)

867 
out_ä“_cmd
;

870 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

871 ià(
»t
)

872 
out_ä“_cmd
;

876 ià(
b_kv_cmd
) {

877 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

878 
iod
->
kv_cmd
 = 1;

882 ià(
	`blk_rq_Ä_phys_£gm’ts
(
»q
) ||

883 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

884 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

885 ià(
»t
)

886 
out_ş—nup_iod
;

889 
	`blk_mq_¡¬t_»que¡
(
»q
);

892 #ifdeà
KV_NVME_DUMMY_OP


893 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

894 #ifdeà
KV_NVME_DUMMY_OP_REPORT


895 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

896 
	`´_”r
("[dump‚vme kv comand]\n");

897 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

898 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

899 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

900 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

901 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

902 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

903 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

904 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

905 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

906 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

907 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

908 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

909 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

910 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

911 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

912 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

913 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

914 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

916 
	`nvme_»q
(
»q
)->
¡©us
 = 
NVME_SC_SUCCESS
;

917 
	`nvme_»q
(
»q
)->
»suÉ
.
u32
 = 
NVME_SC_SUCCESS
;

918 ià(
	`is_kv_»Œ›ve_cmd
(
cmnd
.
commÚ
.
İcode
)) {

919 
	`nvme_»q
(
»q
)->
»suÉ
.
u32
 = 
cmnd
.
commÚ
.
cdw10
[5];

921 
	`blk_mq_com¶‘e_»que¡
(
»q
);

922  
BLK_STS_OK
;

926 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

927 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

928 
	`´_”r
("[dump‚vme kv comand]\n");

929 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

930 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

931 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

932 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

933 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

934 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

935 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

936 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

937 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

938 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

939 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

940 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

941 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

942 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

943 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

944 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

945 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

946 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

951 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

952 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0)) {

953 
»t
 = 
BLK_STS_IOERR
;

954 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

955 
out_ş—nup_iod
;

957 
	`__nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

958 
	`nvme_´oûss_cq
(
nvmeq
);

959 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

960  
BLK_STS_OK
;

961 
out_ş—nup_iod
:

962 
	`nvme_ä“_iod
(
dev
, 
»q
);

963 
out_ä“_cmd
:

964 
	`nvme_ş—nup_cmd
(
»q
);

965  
»t
;

966 
	}
}

968 
	$nvme_pci_com¶‘e_rq
(
»que¡
 *
»q
)

970 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

972 
	`nvme_unm­_d©a
(
iod
->
nvmeq
->
dev
, 
»q
);

973 
	`nvme_com¶‘e_rq
(
»q
);

974 
	}
}

977 
šlše
 
boŞ
 
	$nvme_cqe_v®id
(
nvme_queue
 *
nvmeq
, 
u16
 
h—d
,

978 
u16
 
pha£
)

980  (
	`Ë16_to_ıu
(
nvmeq
->
cqes
[
h—d
].
¡©us
è& 1è=ğ
pha£
;

981 
	}
}

983 
šlše
 
	$nvme_ršg_cq_doÜb–l
(
nvme_queue
 *
nvmeq
)

985 
u16
 
h—d
 = 
nvmeq
->
cq_h—d
;

987 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0)) {

988 ià(
	`nvme_dbbuf_upd©e_ªd_check_ev’t
(
h—d
, 
nvmeq
->
dbbuf_cq_db
,

989 
nvmeq
->
dbbuf_cq_ei
))

990 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

992 
	}
}

994 
šlše
 
	$nvme_hªdË_cqe
(
nvme_queue
 *
nvmeq
,

995 
nvme_com¶‘iÚ
 *
cqe
)

997 
»que¡
 *
»q
;

999 ià(
	`uÆik–y
(
cqe
->
commªd_id
 >ğ
nvmeq
->
q_d•th
)) {

1000 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1002 
cqe
->
commªd_id
, 
	`Ë16_to_ıu
(cqe->
sq_id
));

1012 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

1013 
cqe
->
commªd_id
 >ğ
NVME_AQ_BLKMQ_DEPTH
)) {

1014 
	`nvme_com¶‘e_async_ev’t
(&
nvmeq
->
dev
->
ù¾
,

1015 
cqe
->
¡©us
, &cqe->
»suÉ
);

1019 
nvmeq
->
cqe_£’
 = 1;

1020 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
->
commªd_id
);

1021 
	`nvme_’d_»que¡
(
»q
, 
cqe
->
¡©us
, cqe->
»suÉ
);

1022 
	}
}

1024 
šlše
 
boŞ
 
	$nvme_»ad_cqe
(
nvme_queue
 *
nvmeq
,

1025 
nvme_com¶‘iÚ
 *
cqe
)

1027 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
)) {

1028 *
cqe
 = 
nvmeq
->
cqes
[nvmeq->
cq_h—d
];

1030 ià(++
nvmeq
->
cq_h—d
 =ğnvmeq->
q_d•th
) {

1031 
nvmeq
->
cq_h—d
 = 0;

1032 
nvmeq
->
cq_pha£
 = !nvmeq->cq_phase;

1034  
Œue
;

1036  
çl£
;

1037 
	}
}

1039 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

1041 
nvme_com¶‘iÚ
 
cqe
;

1042 
cÚsumed
 = 0;

1044 
	`nvme_»ad_cqe
(
nvmeq
, &
cqe
)) {

1045 
	`nvme_hªdË_cqe
(
nvmeq
, &
cqe
);

1046 
cÚsumed
++;

1049 ià(
cÚsumed
)

1050 
	`nvme_ršg_cq_doÜb–l
(
nvmeq
);

1051 
	}
}

1053 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1055 
œq»tuº_t
 
»suÉ
;

1056 
nvme_queue
 *
nvmeq
 = 
d©a
;

1057 
	`¥š_lock
(&
nvmeq
->
q_lock
);

1058 
	`nvme_´oûss_cq
(
nvmeq
);

1059 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

1060 
nvmeq
->
cqe_£’
 = 0;

1061 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

1062  
»suÉ
;

1063 
	}
}

1065 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1067 
nvme_queue
 *
nvmeq
 = 
d©a
;

1068 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

1069  
IRQ_WAKE_THREAD
;

1070  
IRQ_NONE
;

1071 
	}
}

1073 
	$__nvme_pŞl
(
nvme_queue
 *
nvmeq
, 
g
)

1075 
nvme_com¶‘iÚ
 
cqe
;

1076 
found
 = 0, 
cÚsumed
 = 0;

1078 ià(!
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

1081 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1082 
	`nvme_»ad_cqe
(
nvmeq
, &
cqe
)) {

1083 
	`nvme_hªdË_cqe
(
nvmeq
, &
cqe
);

1084 
cÚsumed
++;

1086 ià(
g
 =ğ
cqe
.
commªd_id
) {

1087 
found
 = 1;

1092 ià(
cÚsumed
)

1093 
	`nvme_ršg_cq_doÜb–l
(
nvmeq
);

1094 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1096  
found
;

1097 
	}
}

1099 
	$nvme_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1101 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1103  
	`__nvme_pŞl
(
nvmeq
, 
g
);

1104 
	}
}

1106 
	$nvme_pci_subm™_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
«r_idx
)

1108 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

1109 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1110 
nvme_commªd
 
c
;

1112 
	`mem£t
(&
c
, 0, (c));

1113 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1114 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLKMQ_DEPTH
 + 
«r_idx
;

1116 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1117 
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

1118 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1119 
	}
}

1121 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1123 
nvme_commªd
 
c
;

1125 
	`mem£t
(&
c
, 0, (c));

1126 
c
.
d–‘e_queue
.
İcode
 = opcode;

1127 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1129  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1130 
	}
}

1132 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1133 
nvme_queue
 *
nvmeq
)

1135 
nvme_commªd
 
c
;

1136 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1142 
	`mem£t
(&
c
, 0, (c));

1143 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1144 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1145 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1146 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1147 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1148 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1150  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1151 
	}
}

1153 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1154 
nvme_queue
 *
nvmeq
)

1156 
nvme_commªd
 
c
;

1157 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
;

1163 
	`mem£t
(&
c
, 0, (c));

1164 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1165 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1166 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1167 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1168 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1169 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1171  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1172 
	}
}

1174 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1176  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1177 
	}
}

1179 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1181  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1182 
	}
}

1184 
	$abÜt_’dio
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

1186 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1187 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1189 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1190 "AbÜˆ¡©us: 0x%x", 
	`nvme_»q
(
»q
)->
¡©us
);

1191 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

1192 
	`blk_mq_ä“_»que¡
(
»q
);

1193 
	}
}

1195 
boŞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1201 
boŞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1204 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
)

1205  
çl£
;

1210 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1211  
çl£
;

1216 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1217  
çl£
;

1219  
Œue
;

1220 
	}
}

1222 
	$nvme_w¬n_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1225 
u16
 
pci_¡©us
;

1226 
»suÉ
;

1228 
»suÉ
 = 
	`pci_»ad_cÚfig_wÜd
(
	`to_pci_dev
(
dev
->dev), 
PCI_STATUS
,

1229 &
pci_¡©us
);

1230 ià(
»suÉ
 =ğ
PCIBIOS_SUCCESSFUL
)

1231 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1233 
c¡s
, 
pci_¡©us
);

1235 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1237 
c¡s
, 
»suÉ
);

1238 
	}
}

1240 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

1242 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1243 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1244 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1245 
»que¡
 *
abÜt_»q
;

1246 
nvme_commªd
 
cmd
;

1247 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1252 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1253 
	`nvme_w¬n_»£t
(
dev
, 
c¡s
);

1254 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1255 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

1256  
BLK_EH_HANDLED
;

1262 ià(
	`__nvme_pŞl
(
nvmeq
, 
»q
->
g
)) {

1263 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1265 
»q
->
g
, 
nvmeq
->
qid
);

1266  
BLK_EH_HANDLED
;

1275 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
) {

1276 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1278 
»q
->
g
, 
nvmeq
->
qid
);

1279 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1280 
	`nvme_»q
(
»q
)->
æags
 |ğ
NVME_REQ_CANCELLED
;

1281  
BLK_EH_HANDLED
;

1289 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

1290 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1292 
»q
->
g
, 
nvmeq
->
qid
);

1293 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1294 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

1300 
	`nvme_»q
(
»q
)->
æags
 |ğ
NVME_REQ_CANCELLED
;

1301  
BLK_EH_HANDLED
;

1304 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1305 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1306  
BLK_EH_RESET_TIMER
;

1308 
iod
->
abÜ‹d
 = 1;

1310 
	`mem£t
(&
cmd
, 0, (cmd));

1311 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1312 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1313 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1315 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1317 
»q
->
g
, 
nvmeq
->
qid
);

1319 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1320 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1321 ià(
	`IS_ERR
(
abÜt_»q
)) {

1322 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1323  
BLK_EH_RESET_TIMER
;

1326 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1327 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1328 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1335  
BLK_EH_RESET_TIMER
;

1336 
	}
}

1338 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1340 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1341 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1342 ià(
nvmeq
->
sq_cmds
)

1343 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1344 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1345 
	`kä“
(
nvmeq
);

1346 
	}
}

1348 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1350 
i
;

1352 
i
 = 
dev
->
ù¾
.
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1353 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1354 
dev
->
ù¾
.
queue_couÁ
--;

1355 
dev
->
queues
[
i
] = 
NULL
;

1356 
	`nvme_ä“_queue
(
nvmeq
);

1358 
	}
}

1364 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1366 
veùÜ
;

1368 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1369 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1370 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1373 
veùÜ
 = 
nvmeq
->
cq_veùÜ
;

1374 
nvmeq
->
dev
->
Úlše_queues
--;

1375 
nvmeq
->
cq_veùÜ
 = -1;

1376 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1378 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1379 
	`blk_mq_qu›sû_queue
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1381 
	`pci_ä“_œq
(
	`to_pci_dev
(
nvmeq
->
dev
->dev), 
veùÜ
,‚vmeq);

1384 
	}
}

1386 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1388 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1390 ià(!
nvmeq
)

1392 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1395 ià(
shutdown
)

1396 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1398 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1400 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1401 
	`nvme_´oûss_cq
(
nvmeq
);

1402 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1403 
	}
}

1405 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1406 
’Œy_size
)

1408 
q_d•th
 = 
dev
->q_depth;

1409 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1410 
dev
->
ù¾
.
·ge_size
);

1412 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1413 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1414 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1415 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1422 ià(
q_d•th
 < 64)

1423  -
ENOMEM
;

1426  
q_d•th
;

1427 
	}
}

1429 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1430 
qid
, 
d•th
)

1432 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1433 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
d•th
),

1434 
dev
->
ù¾
.
·ge_size
);

1435 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_bus_addr
 + 
off£t
;

1436 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1438 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1439 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1440 ià(!
nvmeq
->
sq_cmds
)

1441  -
ENOMEM
;

1445 
	}
}

1447 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1448 
d•th
, 
node
)

1450 
nvme_queue
 *
nvmeq
 = 
	`kz®loc_node
((*nvmeq), 
GFP_KERNEL
,

1451 
node
);

1452 ià(!
nvmeq
)

1453  
NULL
;

1455 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1456 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1457 ià(!
nvmeq
->
cqes
)

1458 
ä“_nvmeq
;

1460 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1461 
ä“_cqdma
;

1463 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1464 
nvmeq
->
dev
 = dev;

1465 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1466 
nvmeq
->
cq_h—d
 = 0;

1467 
nvmeq
->
cq_pha£
 = 1;

1468 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1469 
nvmeq
->
q_d•th
 = 
d•th
;

1470 
nvmeq
->
qid
 = qid;

1471 
nvmeq
->
cq_veùÜ
 = -1;

1472 
dev
->
queues
[
qid
] = 
nvmeq
;

1473 
dev
->
ù¾
.
queue_couÁ
++;

1475  
nvmeq
;

1477 
ä“_cqdma
:

1478 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1479 
nvmeq
->
cq_dma_addr
);

1480 
ä“_nvmeq
:

1481 
	`kä“
(
nvmeq
);

1482  
NULL
;

1483 
	}
}

1485 
	$queue_»que¡_œq
(
nvme_queue
 *
nvmeq
)

1487 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
nvmeq
->
dev
->dev);

1488 
Ä
 = 
nvmeq
->
dev
->
ù¾
.
š¡ªû
;

1490 ià(
u£_th»aded_š‹¼u±s
) {

1491  
	`pci_»que¡_œq
(
pdev
, 
nvmeq
->
cq_veùÜ
, 
nvme_œq_check
,

1492 
nvme_œq
, 
nvmeq
, "nvme%dq%d", 
Ä
,‚vmeq->
qid
);

1494  
	`pci_»que¡_œq
(
pdev
, 
nvmeq
->
cq_veùÜ
, 
nvme_œq
,

1495 
NULL
, 
nvmeq
, "nvme%dq%d", 
Ä
,‚vmeq->
qid
);

1497 
	}
}

1499 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1501 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1503 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1504 
nvmeq
->
sq_
 = 0;

1505 
nvmeq
->
cq_h—d
 = 0;

1506 
nvmeq
->
cq_pha£
 = 1;

1507 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1508 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1509 
	`nvme_dbbuf_š™
(
dev
, 
nvmeq
, 
qid
);

1510 
dev
->
Úlše_queues
++;

1511 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1512 
	}
}

1514 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1516 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1517 
»suÉ
;

1519 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1520 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1521 ià(
»suÉ
 < 0)

1522  
»suÉ
;

1524 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1525 ià(
»suÉ
 < 0)

1526 
»Ëa£_cq
;

1528 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1529 ià(
»suÉ
 < 0)

1530 
»Ëa£_sq
;

1532 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1533  
»suÉ
;

1535 
»Ëa£_sq
:

1536 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1537 
»Ëa£_cq
:

1538 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1539  
»suÉ
;

1540 
	}
}

1542 cÚ¡ 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1543 .
queue_rq
 = 
nvme_queue_rq
,

1544 .
	gcom¶‘e
 = 
nvme_pci_com¶‘e_rq
,

1545 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1546 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1547 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1548 .
	gtimeout
 = 
nvme_timeout
,

1551 cÚ¡ 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1552 .
queue_rq
 = 
nvme_queue_rq
,

1553 .
	gcom¶‘e
 = 
nvme_pci_com¶‘e_rq
,

1554 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1555 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1556 .
	gm­_queues
 = 
nvme_pci_m­_queues
,

1557 .
	gtimeout
 = 
nvme_timeout
,

1558 .
	gpŞl
 = 
nvme_pŞl
,

1561 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1563 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1569 
	`blk_mq_unqu›sû_queue
(
dev
->
ù¾
.
admš_q
);

1570 
	`blk_ş—nup_queue
(
dev
->
ù¾
.
admš_q
);

1571 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1573 
	}
}

1575 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1577 ià(!
dev
->
ù¾
.
admš_q
) {

1578 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1579 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1585 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_BLKMQ_DEPTH
 - 1;

1586 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1587 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1588 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1589 
dev
->
admš_g£t
.
æags
 = 
BLK_MQ_F_NO_SCHED
;

1590 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1592 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1593  -
ENOMEM
;

1595 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1596 ià(
	`IS_ERR
(
dev
->
ù¾
.
admš_q
)) {

1597 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1598  -
ENOMEM
;

1600 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1601 
	`nvme_dev_»move_admš
(
dev
);

1602 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1603  -
ENODEV
;

1606 
	`blk_mq_unqu›sû_queue
(
dev
->
ù¾
.
admš_q
);

1609 
	}
}

1611 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1613  
NVME_REG_DBS
 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1614 
	}
}

1616 
	$nvme_»m­_b¬
(
nvme_dev
 *
dev
, 
size
)

1618 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1620 ià(
size
 <ğ
dev
->
b¬_m­³d_size
)

1622 ià(
size
 > 
	`pci_»sourû_Ën
(
pdev
, 0))

1623  -
ENOMEM
;

1624 ià(
dev
->
b¬
)

1625 
	`iounm­
(
dev
->
b¬
);

1626 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1627 ià(!
dev
->
b¬
) {

1628 
dev
->
b¬_m­³d_size
 = 0;

1629  -
ENOMEM
;

1631 
dev
->
b¬_m­³d_size
 = 
size
;

1632 
dev
->
dbs
 = dev->
b¬
 + 
NVME_REG_DBS
;

1635 
	}
}

1637 
	$nvme_pci_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1639 
»suÉ
;

1640 
u32
 
aqa
;

1641 
nvme_queue
 *
nvmeq
;

1643 
»suÉ
 = 
	`nvme_»m­_b¬
(
dev
, 
	`db_b¬_size
(dev, 0));

1644 ià(
»suÉ
 < 0)

1645  
»suÉ
;

1647 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 1, 0) ?

1648 
	`NVME_CAP_NSSRC
(
dev
->
ù¾
.
ÿp
) : 0;

1650 ià(
dev
->
subsy¡em
 &&

1651 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1652 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1654 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1655 ià(
»suÉ
 < 0)

1656  
»suÉ
;

1658 
nvmeq
 = 
dev
->
queues
[0];

1659 ià(!
nvmeq
) {

1660 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
,

1661 
	`dev_to_node
(
dev
->dev));

1662 ià(!
nvmeq
)

1663  -
ENOMEM
;

1666 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1667 
aqa
 |=‡qa << 16;

1669 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1670 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1671 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

1673 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1674 ià(
»suÉ
)

1675  
»suÉ
;

1677 
nvmeq
->
cq_veùÜ
 = 0;

1678 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1679 ià(
»suÉ
) {

1680 
nvmeq
->
cq_veùÜ
 = -1;

1681  
»suÉ
;

1684  
»suÉ
;

1685 
	}
}

1687 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

1689 
i
, 
max
;

1690 
»t
 = 0;

1692 
i
 = 
dev
->
ù¾
.
queue_couÁ
; i <ğdev->
max_qid
; i++) {

1694 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
,

1695 
	`pci_œq_g‘_node
(
	`to_pci_dev
(
dev
->dev), 
i
 - 1))) {

1696 
»t
 = -
ENOMEM
;

1701 
max
 = 
	`mš
(
dev
->
max_qid
, dev->
ù¾
.
queue_couÁ
 - 1);

1702 
i
 = 
dev
->
Úlše_queues
; i <ğ
max
; i++) {

1703 
»t
 = 
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i);

1704 ià(
»t
)

1714  
»t
 >= 0 ? 0 :„et;

1715 
	}
}

1717 
ssize_t
 
	$nvme_cmb_show
(
deviû
 *
dev
,

1718 
deviû_©Œibu‹
 *
©Œ
,

1719 *
buf
)

1721 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_g‘_drvd©a
(
dev
));

1723  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "cmbloc : x%08x\ncmbsz : x%08x\n",

1724 
ndev
->
cmbloc
,‚dev->
cmbsz
);

1725 
	}
}

1726 
DEVICE_ATTR
(
cmb
, 
S_IRUGO
, 
nvme_cmb_show
, 
NULL
);

1728 
__iomem
 *
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

1730 
u64
 
szu
, 
size
, 
off£t
;

1731 
»sourû_size_t
 
b¬_size
;

1732 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1733 
__iomem
 *
cmb
;

1734 
b¬
;

1736 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

1737 ià(!(
	`NVME_CMB_SZ
(
dev
->
cmbsz
)))

1738  
NULL
;

1739 
dev
->
cmbloc
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBLOC
);

1741 ià(!
u£_cmb_sqes
)

1742  
NULL
;

1744 
szu
 = (
u64
)1 << (12 + 4 * 
	`NVME_CMB_SZU
(
dev
->
cmbsz
));

1745 
size
 = 
szu
 * 
	`NVME_CMB_SZ
(
dev
->
cmbsz
);

1746 
off£t
 = 
szu
 * 
	`NVME_CMB_OFST
(
dev
->
cmbloc
);

1747 
b¬
 = 
	`NVME_CMB_BIR
(
dev
->
cmbloc
);

1748 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
b¬
);

1750 ià(
off£t
 > 
b¬_size
)

1751  
NULL
;

1758 ià(
size
 > 
b¬_size
 - 
off£t
)

1759 
size
 = 
b¬_size
 - 
off£t
;

1761 
cmb
 = 
	`iÜem­_wc
(
	`pci_»sourû_¡¬t
(
pdev
, 
b¬
è+ 
off£t
, 
size
);

1762 ià(!
cmb
)

1763  
NULL
;

1765 
dev
->
cmb_bus_addr
 = 
	`pci_bus_add»ss
(
pdev
, 
b¬
è+ 
off£t
;

1766 
dev
->
cmb_size
 = 
size
;

1767  
cmb
;

1768 
	}
}

1770 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

1772 ià(
dev
->
cmb
) {

1773 
	`iounm­
(
dev
->
cmb
);

1774 
dev
->
cmb
 = 
NULL
;

1775 
	`sysfs_»move_fe_äom_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

1776 &
dev_©Œ_cmb
.
©Œ
, 
NULL
);

1777 
dev
->
cmbsz
 = 0;

1779 
	}
}

1781 
	$nvme_£t_ho¡_mem
(
nvme_dev
 *
dev
, 
u32
 
b™s
)

1783 
u64
 
dma_addr
 = 
dev
->
ho¡_mem_descs_dma
;

1784 
nvme_commªd
 
c
;

1785 
»t
;

1787 
	`mem£t
(&
c
, 0, (c));

1788 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1789 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(
NVME_FEAT_HOST_MEM_BUF
);

1790 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(
b™s
);

1791 
c
.
ã©u»s
.
dwÜd12
 = 
	`ıu_to_Ë32
(
dev
->
ho¡_mem_size
 >>

1792 
	`og2
(
dev
->
ù¾
.
·ge_size
));

1793 
c
.
ã©u»s
.
dwÜd13
 = 
	`ıu_to_Ë32
(
	`low”_32_b™s
(
dma_addr
));

1794 
c
.
ã©u»s
.
dwÜd14
 = 
	`ıu_to_Ë32
(
	`uµ”_32_b™s
(
dma_addr
));

1795 
c
.
ã©u»s
.
dwÜd15
 = 
	`ıu_to_Ë32
(
dev
->
Ä_ho¡_mem_descs
);

1797 
»t
 = 
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1798 ià(
»t
) {

1799 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1801 
»t
, 
b™s
);

1803  
»t
;

1804 
	}
}

1806 
	$nvme_ä“_ho¡_mem
(
nvme_dev
 *
dev
)

1808 
i
;

1810 
i
 = 0; i < 
dev
->
Ä_ho¡_mem_descs
; i++) {

1811 
nvme_ho¡_mem_buf_desc
 *
desc
 = &
dev
->
ho¡_mem_descs
[
i
];

1812 
size_t
 
size
 = 
	`Ë32_to_ıu
(
desc
->sizeè* 
dev
->
ù¾
.
·ge_size
;

1814 
	`dma_ä“_coh”’t
(
dev
->dev, 
size
, dev->
ho¡_mem_desc_bufs
[
i
],

1815 
	`Ë64_to_ıu
(
desc
->
addr
));

1818 
	`kä“
(
dev
->
ho¡_mem_desc_bufs
);

1819 
dev
->
ho¡_mem_desc_bufs
 = 
NULL
;

1820 
	`dma_ä“_coh”’t
(
dev
->dev,

1821 
dev
->
Ä_ho¡_mem_descs
 * (*dev->
ho¡_mem_descs
),

1822 
dev
->
ho¡_mem_descs
, dev->
ho¡_mem_descs_dma
);

1823 
dev
->
ho¡_mem_descs
 = 
NULL
;

1824 
	}
}

1826 
	$__nvme_®loc_ho¡_mem
(
nvme_dev
 *
dev
, 
u64
 
´eã¼ed
,

1827 
u32
 
chunk_size
)

1829 
nvme_ho¡_mem_buf_desc
 *
descs
;

1830 
u32
 
max_’Œ›s
, 
Ën
;

1831 
dma_addr_t
 
descs_dma
;

1832 
i
 = 0;

1833 **
bufs
;

1834 
u64
 
size
 = 0, 
tmp
;

1836 
tmp
 = (
´eã¼ed
 + 
chunk_size
 - 1);

1837 
	`do_div
(
tmp
, 
chunk_size
);

1838 
max_’Œ›s
 = 
tmp
;

1839 
descs
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
max_’Œ›s
 * (*descs),

1840 &
descs_dma
, 
GFP_KERNEL
);

1841 ià(!
descs
)

1842 
out
;

1844 
bufs
 = 
	`kÿÎoc
(
max_’Œ›s
, (*bufs), 
GFP_KERNEL
);

1845 ià(!
bufs
)

1846 
out_ä“_descs
;

1848 
size
 = 0; siz< 
´eã¼ed
; siz+ğ
Ën
) {

1849 
dma_addr_t
 
dma_addr
;

1851 
Ën
 = 
	`mš_t
(
u64
, 
chunk_size
, 
´eã¼ed
 - 
size
);

1852 
bufs
[
i
] = 
	`dma_®loc_©Œs
(
dev
->dev, 
Ën
, &
dma_addr
, 
GFP_KERNEL
,

1853 
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
);

1854 ià(!
bufs
[
i
])

1857 
descs
[
i
].
addr
 = 
	`ıu_to_Ë64
(
dma_addr
);

1858 
descs
[
i
].
size
 = 
	`ıu_to_Ë32
(
Ën
 / 
dev
->
ù¾
.
·ge_size
);

1859 
i
++;

1862 ià(!
size
)

1863 
out_ä“_bufs
;

1865 
dev
->
Ä_ho¡_mem_descs
 = 
i
;

1866 
dev
->
ho¡_mem_size
 = 
size
;

1867 
dev
->
ho¡_mem_descs
 = 
descs
;

1868 
dev
->
ho¡_mem_descs_dma
 = 
descs_dma
;

1869 
dev
->
ho¡_mem_desc_bufs
 = 
bufs
;

1872 
out_ä“_bufs
:

1873 --
i
 >= 0) {

1874 
size_t
 
size
 = 
	`Ë32_to_ıu
(
descs
[
i
].sizeè* 
dev
->
ù¾
.
·ge_size
;

1876 
	`dma_ä“_coh”’t
(
dev
->dev, 
size
, 
bufs
[
i
],

1877 
	`Ë64_to_ıu
(
descs
[
i
].
addr
));

1880 
	`kä“
(
bufs
);

1881 
out_ä“_descs
:

1882 
	`dma_ä“_coh”’t
(
dev
->dev, 
max_’Œ›s
 * (*
descs
), descs,

1883 
descs_dma
);

1884 
out
:

1885 
dev
->
ho¡_mem_descs
 = 
NULL
;

1886  -
ENOMEM
;

1887 
	}
}

1889 
	$nvme_®loc_ho¡_mem
(
nvme_dev
 *
dev
, 
u64
 
mš
, u64 
´eã¼ed
)

1891 
u32
 
chunk_size
;

1894 
chunk_size
 = 
	`mš_t
(
u64
, 
´eã¼ed
, 
PAGE_SIZE
 * 
MAX_ORDER_NR_PAGES
);

1895 
chunk_size
 >ğ
PAGE_SIZE
 * 2;

1896 
chunk_size
 /= 2) {

1897 ià(!
	`__nvme_®loc_ho¡_mem
(
dev
, 
´eã¼ed
, 
chunk_size
)) {

1898 ià(!
mš
 || 
dev
->
ho¡_mem_size
 >= min)

1900 
	`nvme_ä“_ho¡_mem
(
dev
);

1904  -
ENOMEM
;

1905 
	}
}

1907 
	$nvme_£tup_ho¡_mem
(
nvme_dev
 *
dev
)

1909 
u64
 
max
 = (u64)
max_ho¡_mem_size_mb
 * 
SZ_1M
;

1910 
u64
 
´eã¼ed
 = (u64)
dev
->
ù¾
.
hm´e
 * 4096;

1911 
u64
 
mš
 = (u64)
dev
->
ù¾
.
hmmš
 * 4096;

1912 
u32
 
’abË_b™s
 = 
NVME_HOST_MEM_ENABLE
;

1913 
»t
 = 0;

1915 
´eã¼ed
 = 
	`mš
Õ»ã¼ed, 
max
);

1916 ià(
mš
 > 
max
) {

1917 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1919 
mš
 >> 
	`og2
(
SZ_1M
), 
max_ho¡_mem_size_mb
);

1920 
	`nvme_ä“_ho¡_mem
(
dev
);

1927 ià(
dev
->
ho¡_mem_descs
) {

1928 ià(
dev
->
ho¡_mem_size
 >ğ
mš
)

1929 
’abË_b™s
 |ğ
NVME_HOST_MEM_RETURN
;

1931 
	`nvme_ä“_ho¡_mem
(
dev
);

1934 ià(!
dev
->
ho¡_mem_descs
) {

1935 ià(
	`nvme_®loc_ho¡_mem
(
dev
, 
mš
, 
´eã¼ed
)) {

1936 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1941 
	`dev_šfo
(
dev
->
ù¾
.
deviû
,

1943 
dev
->
ho¡_mem_size
 >> 
	`og2
(
SZ_1M
));

1946 
»t
 = 
	`nvme_£t_ho¡_mem
(
dev
, 
’abË_b™s
);

1947 ià(
»t
)

1948 
	`nvme_ä“_ho¡_mem
(
dev
);

1949  
»t
;

1950 
	}
}

1952 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

1954 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

1955 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1956 
»suÉ
, 
Ä_io_queues
;

1957 
size
;

1959 
Ä_io_queues
 = 
	`num_´e£Á_ıus
();

1960 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

1961 ià(
»suÉ
 < 0)

1962  
»suÉ
;

1964 ià(
Ä_io_queues
 == 0)

1967 ià(
dev
->
cmb
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1968 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

1969 (
nvme_commªd
));

1970 ià(
»suÉ
 > 0)

1971 
dev
->
q_d•th
 = 
»suÉ
;

1973 
	`nvme_»Ëa£_cmb
(
dev
);

1977 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1978 
»suÉ
 = 
	`nvme_»m­_b¬
(
dev
, 
size
);

1979 ià(!
»suÉ
)

1981 ià(!--
Ä_io_queues
)

1982  -
ENOMEM
;

1984 
admšq
->
q_db
 = 
dev
->
dbs
;

1987 
	`pci_ä“_œq
(
pdev
, 0, 
admšq
);

1993 
	`pci_ä“_œq_veùÜs
(
pdev
);

1994 
Ä_io_queues
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1,‚r_io_queues,

1995 
PCI_IRQ_ALL_TYPES
 | 
PCI_IRQ_AFFINITY
);

1996 ià(
Ä_io_queues
 <= 0)

1997  -
EIO
;

1998 
dev
->
max_qid
 = 
Ä_io_queues
;

2007 
»suÉ
 = 
	`queue_»que¡_œq
(
admšq
);

2008 ià(
»suÉ
) {

2009 
admšq
->
cq_veùÜ
 = -1;

2010  
»suÉ
;

2012  
	`nvme_ü—‹_io_queues
(
dev
);

2013 
	}
}

2015 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

2017 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2019 
	`blk_mq_ä“_»que¡
(
»q
);

2020 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

2021 
	}
}

2023 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

2025 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2027 ià(!
”rÜ
) {

2028 
æags
;

2035 
	`¥š_lock_œq§ve_Ã¡ed
(&
nvmeq
->
q_lock
, 
æags
,

2036 
SINGLE_DEPTH_NESTING
);

2037 
	`nvme_´oûss_cq
(
nvmeq
);

2038 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

2041 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

2042 
	}
}

2044 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
)

2046 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

2047 
»que¡
 *
»q
;

2048 
nvme_commªd
 
cmd
;

2050 
	`mem£t
(&
cmd
, 0, (cmd));

2051 
cmd
.
d–‘e_queue
.
İcode
 = opcode;

2052 
cmd
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

2054 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

2055 ià(
	`IS_ERR
(
»q
))

2056  
	`PTR_ERR
(
»q
);

2058 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

2059 
»q
->
’d_io_d©a
 = 
nvmeq
;

2061 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

2062 
İcode
 =ğ
nvme_admš_d–‘e_cq
 ?

2063 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

2065 
	}
}

2067 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
, 
queues
)

2069 
·ss
;

2070 
timeout
;

2071 
u8
 
İcode
 = 
nvme_admš_d–‘e_sq
;

2073 
·ss
 = 0;…ass < 2;…ass++) {

2074 
£Á
 = 0, 
i
 = 
queues
;

2076 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2077 
»Œy
:

2078 
timeout
 = 
ADMIN_TIMEOUT
;

2079 ; 
i
 > 0; i--, 
£Á
++)

2080 ià(
	`nvme_d–‘e_queue
(
dev
->
queues
[
i
], 
İcode
))

2083 
£Á
--) {

2084 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

2085 ià(
timeout
 == 0)

2087 ià(
i
)

2088 
»Œy
;

2090 
İcode
 = 
nvme_admš_d–‘e_cq
;

2092 
	}
}

2100 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2102 ià(!
dev
->
ù¾
.
g£t
) {

2103 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

2104 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

2105 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2106 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

2107 
dev
->
g£t
.
queue_d•th
 =

2108 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

2109 
dev
->
g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

2110 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2111 
dev
->
g£t
.
driv”_d©a
 = dev;

2113 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

2115 
dev
->
ù¾
.
g£t
 = &dev->tagset;

2117 
	`nvme_dbbuf_£t
(
dev
);

2119 
	`blk_mq_upd©e_Ä_hw_queues
(&
dev
->
g£t
, dev->
Úlše_queues
 - 1);

2122 
	`nvme_ä“_queues
(
dev
, dev->
Úlše_queues
);

2126 
	}
}

2128 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

2130 
»suÉ
 = -
ENOMEM
;

2131 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2133 ià(
	`pci_’abË_deviû_mem
(
pdev
))

2134  
»suÉ
;

2136 
	`pci_£t_ma¡”
(
pdev
);

2138 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

2139 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

2140 
di§bË
;

2142 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

2143 
»suÉ
 = -
ENODEV
;

2144 
di§bË
;

2152 
»suÉ
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1, 1, 
PCI_IRQ_ALL_TYPES
);

2153 ià(
»suÉ
 < 0)

2154  
»suÉ
;

2156 
dev
->
ù¾
.
ÿp
 = 
	`lo_hi_»adq
(dev->
b¬
 + 
NVME_REG_CAP
);

2158 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(dev->
ù¾
.
ÿp
) + 1,

2159 
io_queue_d•th
);

2160 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(dev->
ù¾
.
ÿp
);

2161 
dev
->
dbs
 = dev->
b¬
 + 4096;

2167 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_APPLE
 &&…dev->
deviû
 == 0x2001) {

2168 
dev
->
q_d•th
 = 2;

2169 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "detected Apple NVMe controller, "

2171 
dev
->
q_d•th
);

2172 } ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_SAMSUNG
 &&

2173 (
pdev
->
deviû
 == 0xa821 ||…dev->device == 0xa822) &&

2174 
	`NVME_CAP_MQES
(
dev
->
ù¾
.
ÿp
) == 0) {

2175 
dev
->
q_d•th
 = 64;

2176 
	`dev_”r
(
dev
->
ù¾
.
deviû
, "detected PM1725 NVMe controller, "

2177 "£ˆqueud•th=%u\n", 
dev
->
q_d•th
);

2187 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 2, 0)) {

2188 
dev
->
cmb
 = 
	`nvme_m­_cmb
(dev);

2189 ià(
dev
->
cmb
) {

2190 ià(
	`sysfs_add_fe_to_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

2191 &
dev_©Œ_cmb
.
©Œ
, 
NULL
))

2192 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2197 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

2198 
	`pci_§ve_¡©e
(
pdev
);

2201 
di§bË
:

2202 
	`pci_di§bË_deviû
(
pdev
);

2203  
»suÉ
;

2204 
	}
}

2206 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

2208 ià(
dev
->
b¬
)

2209 
	`iounm­
(
dev
->
b¬
);

2210 
	`pci_»Ëa£_mem_»giÚs
(
	`to_pci_dev
(
dev
->dev));

2211 
	}
}

2213 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

2215 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2217 
	`nvme_»Ëa£_cmb
(
dev
);

2218 
	`pci_ä“_œq_veùÜs
(
pdev
);

2220 ià(
	`pci_is_’abËd
(
pdev
)) {

2221 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

2222 
	`pci_di§bË_deviû
(
pdev
);

2224 
	}
}

2226 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

2228 
i
, 
queues
;

2229 
boŞ
 
d—d
 = 
Œue
;

2230 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2232 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

2233 ià(
	`pci_is_’abËd
(
pdev
)) {

2234 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

2236 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_LIVE
 ||

2237 
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
)

2238 
	`nvme_¡¬t_ä“ze
(&
dev
->
ù¾
);

2239 
d—d
 = !!((
c¡s
 & 
NVME_CSTS_CFS
è|| !(c¡ & 
NVME_CSTS_RDY
) ||

2240 
pdev
->
”rÜ_¡©e
 !ğ
pci_chªÃl_io_nÜm®
);

2247 ià(!
d—d
) {

2248 ià(
shutdown
)

2249 
	`nvme_wa™_ä“ze_timeout
(&
dev
->
ù¾
, 
NVME_IO_TIMEOUT
);

2257 ià(
dev
->
ho¡_mem_descs
)

2258 
	`nvme_£t_ho¡_mem
(
dev
, 0);

2261 
	`nvme_¡İ_queues
(&
dev
->
ù¾
);

2263 
queues
 = 
dev
->
Úlše_queues
 - 1;

2264 
i
 = 
dev
->
ù¾
.
queue_couÁ
 - 1; i > 0; i--)

2265 
	`nvme_su¥’d_queue
(
dev
->
queues
[
i
]);

2267 ià(
d—d
) {

2272 ià(
dev
->
ù¾
.
queue_couÁ
)

2273 
	`nvme_su¥’d_queue
(
dev
->
queues
[0]);

2275 
	`nvme_di§bË_io_queues
(
dev
, 
queues
);

2276 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

2278 
	`nvme_pci_di§bË
(
dev
);

2280 
	`blk_mq_g£t_busy_™”
(&
dev
->
g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

2281 
	`blk_mq_g£t_busy_™”
(&
dev
->
admš_g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

2288 ià(
shutdown
)

2289 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2290 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

2291 
	}
}

2293 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

2295 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist…age", dev->dev,

2296 
PAGE_SIZE
, PAGE_SIZE, 0);

2297 ià(!
dev
->
´p_·ge_poŞ
)

2298  -
ENOMEM
;

2301 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist 256", dev->dev,

2303 ià(!
dev
->
´p_sm®l_poŞ
) {

2304 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2305  -
ENOMEM
;

2308 
	}
}

2310 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

2312 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2313 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

2314 
	}
}

2316 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

2318 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2320 
	`nvme_dbbuf_dma_ä“
(
dev
);

2321 
	`put_deviû
(
dev
->dev);

2322 ià(
dev
->
g£t
.
gs
)

2323 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

2324 ià(
dev
->
ù¾
.
admš_q
)

2325 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2326 
	`kä“
(
dev
->
queues
);

2327 
	`ä“_İ®_dev
(
dev
->
ù¾
.
İ®_dev
);

2328 
	`kä“
(
dev
);

2329 
	}
}

2331 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
, 
¡©us
)

2333 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "Removšg‡á”…robçu» stus: %d\n", 
¡©us
);

2335 
	`k»f_g‘
(&
dev
->
ù¾
.
k»f
);

2336 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2337 ià(!
	`scheduË_wÜk
(&
dev
->
»move_wÜk
))

2338 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2339 
	}
}

2341 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2343 
nvme_dev
 *
dev
 =

2344 
	`cÚš”_of
(
wÜk
, 
nvme_dev
, 
ù¾
.
»£t_wÜk
);

2345 
boŞ
 
was_su¥’d
 = !!(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_SHN_NORMAL
);

2346 
»suÉ
 = -
ENODEV
;

2348 ià(
	`WARN_ON
(
dev
->
ù¾
.
¡©e
 !ğ
NVME_CTRL_RESETTING
))

2349 
out
;

2355 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

2356 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2358 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

2359 ià(
»suÉ
)

2360 
out
;

2362 
»suÉ
 = 
	`nvme_pci_cÚfigu»_admš_queue
(
dev
);

2363 ià(
»suÉ
)

2364 
out
;

2366 
	`nvme_š™_queue
(
dev
->
queues
[0], 0);

2367 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2368 ià(
»suÉ
)

2369 
out
;

2371 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2372 ià(
»suÉ
)

2373 
out
;

2375 ià(
dev
->
ù¾
.
ßcs
 & 
NVME_CTRL_OACS_SEC_SUPP
) {

2376 ià(!
dev
->
ù¾
.
İ®_dev
)

2377 
dev
->
ù¾
.
İ®_dev
 =

2378 
	`š™_İ®_dev
(&
dev
->
ù¾
, &
nvme_£c_subm™
);

2379 ià(
was_su¥’d
)

2380 
	`İ®_uÆock_äom_su¥’d
(
dev
->
ù¾
.
İ®_dev
);

2382 
	`ä“_İ®_dev
(
dev
->
ù¾
.
İ®_dev
);

2383 
dev
->
ù¾
.
İ®_dev
 = 
NULL
;

2386 ià(
dev
->
ù¾
.
ßcs
 & 
NVME_CTRL_OACS_DBBUF_SUPP
) {

2387 
»suÉ
 = 
	`nvme_dbbuf_dma_®loc
(
dev
);

2388 ià(
»suÉ
)

2389 
	`dev_w¬n
(
dev
->dev,

2393 ià(
dev
->
ù¾
.
hm´e
) {

2394 
»suÉ
 = 
	`nvme_£tup_ho¡_mem
(
dev
);

2395 ià(
»suÉ
 < 0)

2396 
out
;

2399 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2400 ià(
»suÉ
)

2401 
out
;

2407 ià(
dev
->
Úlše_queues
 < 2) {

2408 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "IO queues‚ot created\n");

2409 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2410 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2412 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2413 
	`nvme_wa™_ä“ze
(&
dev
->
ù¾
);

2414 
	`nvme_dev_add
(
dev
);

2415 
	`nvme_unä“ze
(&
dev
->
ù¾
);

2418 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_LIVE
)) {

2419 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "failedo mark controller†ive\n");

2420 
out
;

2423 
	`nvme_¡¬t_ù¾
(&
dev
->
ù¾
);

2426 
out
:

2427 
	`nvme_»move_d—d_ù¾
(
dev
, 
»suÉ
);

2428 
	}
}

2430 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2432 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2433 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2435 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2436 ià(
	`pci_g‘_drvd©a
(
pdev
))

2437 
	`deviû_»Ëa£_driv”
(&
pdev
->
dev
);

2438 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2439 
	}
}

2441 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2443 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2445 
	}
}

2447 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2449 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2451 
	}
}

2453 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2455 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2457 
	}
}

2459 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_pci_ù¾_İs
 = {

2460 .
Çme
 = "pcie",

2461 .
	gmoduË
 = 
THIS_MODULE
,

2462 .
	gæags
 = 
NVME_F_METADATA_SUPPORTED
,

2463 .
	g»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2464 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2465 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2466 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2467 .
	gsubm™_async_ev’t
 = 
nvme_pci_subm™_async_ev’t
,

2470 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2472 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2474 ià(
	`pci_»que¡_mem_»giÚs
(
pdev
, "nvme"))

2475  -
ENODEV
;

2477 ià(
	`nvme_»m­_b¬
(
dev
, 
NVME_REG_DBS
 + 4096))

2478 
»Ëa£
;

2481 
»Ëa£
:

2482 
	`pci_»Ëa£_mem_»giÚs
(
pdev
);

2483  -
ENODEV
;

2484 
	}
}

2486 
	$check_d–l_§msung_bug
(
pci_dev
 *
pdev
)

2488 ià(
pdev
->
v’dÜ
 =ğ0x144d &&…dev->
deviû
 == 0xa802) {

2497 ià(
	`dmi_m©ch
(
DMI_SYS_VENDOR
, "Dell Inc.") &&

2498 (
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "XPS 15 9550") ||

2499 
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "Precision 5510")))

2500  
NVME_QUIRK_NO_DEEPEST_PS
;

2504 
	}
}

2506 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2508 
node
, 
»suÉ
 = -
ENOMEM
;

2509 
nvme_dev
 *
dev
;

2510 
quœks
 = 
id
->
driv”_d©a
;

2512 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2513 ià(
node
 =ğ
NUMA_NO_NODE
)

2514 
	`£t_dev_node
(&
pdev
->
dev
, 
fœ¡_memÜy_node
);

2516 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

2517 ià(!
dev
)

2518  -
ENOMEM
;

2519 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

2520 
GFP_KERNEL
, 
node
);

2521 ià(!
dev
->
queues
)

2522 
ä“
;

2524 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

2525 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2527 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

2528 ià(
»suÉ
)

2529 
put_pci
;

2531 
	`INIT_WORK
(&
dev
->
ù¾
.
»£t_wÜk
, 
nvme_»£t_wÜk
);

2532 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

2533 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

2534 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2536 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2537 ià(
»suÉ
)

2538 
unm­
;

2540 
quœks
 |ğ
	`check_d–l_§msung_bug
(
pdev
);

2542 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_İs
,

2543 
quœks
);

2544 ià(
»suÉ
)

2545 
»Ëa£_poŞs
;

2547 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_RESETTING
);

2548 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "pc˜funùiÚ %s\n", 
	`dev_Çme
(&
pdev
->dev));

2550 
	`queue_wÜk
(
nvme_wq
, &
dev
->
ù¾
.
»£t_wÜk
);

2553 
»Ëa£_poŞs
:

2554 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2555 
unm­
:

2556 
	`nvme_dev_unm­
(
dev
);

2557 
put_pci
:

2558 
	`put_deviû
(
dev
->dev);

2559 
ä“
:

2560 
	`kä“
(
dev
->
queues
);

2561 
	`kä“
(
dev
);

2562  
»suÉ
;

2563 
	}
}

2565 
	$nvme_»£t_´•¬e
(
pci_dev
 *
pdev
)

2567 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2568 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2569 
	}
}

2571 
	$nvme_»£t_dÚe
(
pci_dev
 *
pdev
)

2573 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2574 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

2575 
	}
}

2577 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2579 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2580 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2581 
	}
}

2588 
	$nvme_»move
(
pci_dev
 *
pdev
)

2590 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2592 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DELETING
);

2594 
	`ÿnûl_wÜk_sync
(&
dev
->
ù¾
.
»£t_wÜk
);

2595 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2597 ià(!
	`pci_deviû_is_´e£Á
(
pdev
)) {

2598 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DEAD
);

2599 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2602 
	`æush_wÜk
(&
dev
->
ù¾
.
»£t_wÜk
);

2603 
	`nvme_¡İ_ù¾
(&
dev
->
ù¾
);

2604 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2605 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2606 
	`nvme_ä“_ho¡_mem
(
dev
);

2607 
	`nvme_dev_»move_admš
(
dev
);

2608 
	`nvme_ä“_queues
(
dev
, 0);

2609 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

2610 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2611 
	`nvme_dev_unm­
(
dev
);

2612 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2613 
	}
}

2615 
	$nvme_pci_¤iov_cÚfigu»
(
pci_dev
 *
pdev
, 
numvfs
)

2617 
»t
 = 0;

2619 ià(
numvfs
 == 0) {

2620 ià(
	`pci_vfs_assigÃd
(
pdev
)) {

2621 
	`dev_w¬n
(&
pdev
->
dev
,

2623  -
EPERM
;

2625 
	`pci_di§bË_¤iov
(
pdev
);

2629 
»t
 = 
	`pci_’abË_¤iov
(
pdev
, 
numvfs
);

2630  
»t
 ?„‘ : 
numvfs
;

2631 
	}
}

2633 #ifdeà
CONFIG_PM_SLEEP


2634 
	$nvme_su¥’d
(
deviû
 *
dev
)

2636 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2637 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2639 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

2641 
	}
}

2643 
	$nvme_»sume
(
deviû
 *
dev
)

2645 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2646 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2648 
	`nvme_»£t_ù¾
(&
ndev
->
ù¾
);

2650 
	}
}

2653 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

2655 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

2656 
pci_chªÃl_¡©e_t
 
¡©e
)

2658 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2665 
¡©e
) {

2666 
pci_chªÃl_io_nÜm®
:

2667  
PCI_ERS_RESULT_CAN_RECOVER
;

2668 
pci_chªÃl_io_äoz’
:

2669 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2671 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2672  
PCI_ERS_RESULT_NEED_RESET
;

2673 
pci_chªÃl_io_³rm_çu»
:

2674 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2676  
PCI_ERS_RESULT_DISCONNECT
;

2678  
PCI_ERS_RESULT_NEED_RESET
;

2679 
	}
}

2681 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

2683 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2685 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "restart‡fter slot„eset\n");

2686 
	`pci_»¡Üe_¡©e
(
pdev
);

2687 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

2688  
PCI_ERS_RESULT_RECOVERED
;

2689 
	}
}

2691 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

2693 
	`pci_ş—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

2694 
	}
}

2696 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2697 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2698 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2699 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2700 .
	g»£t_´•¬e
 = 
nvme_»£t_´•¬e
,

2701 .
	g»£t_dÚe
 = 
nvme_»£t_dÚe
,

2704 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

2705 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2706 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2707 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2708 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

2709 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2710 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2711 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

2712 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2713 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2714 { 
PCI_VDEVICE
(
INTEL
, 0x0a55),

2715 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2716 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2717 { 
PCI_VDEVICE
(
INTEL
, 0xf1a5),

2718 .
	gdriv”_d©a
 = 
NVME_QUIRK_NO_DEEPEST_PS
 },

2719 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2720 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

2721 { 
PCI_DEVICE
(0x1c58, 0x0003),

2722 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2723 { 
PCI_DEVICE
(0x1c5f, 0x0540),

2724 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2725 { 
PCI_DEVICE
(0x144d, 0xa821),

2726 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2727 { 
PCI_DEVICE
(0x144d, 0xa822),

2728 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2729 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2730 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

2731 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2003) },

2734 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2736 
pci_driv”
 
	gnvme_driv”
 = {

2737 .
Çme
 = "nvme",

2738 .
	gid_bË
 = 
nvme_id_bË
,

2739 .
	g´obe
 = 
nvme_´obe
,

2740 .
	g»move
 = 
nvme_»move
,

2741 .
	gshutdown
 = 
nvme_shutdown
,

2742 .
	gdriv”
 = {

2743 .
pm
 = &
nvme_dev_pm_İs
,

2745 .
	g¤iov_cÚfigu»
 = 
nvme_pci_¤iov_cÚfigu»
,

2746 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2749 
__š™
 
	$nvme_š™
()

2751  
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2752 
	}
}

2754 
__ex™
 
	$nvme_ex™
()

2756 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2757 
	`_nvme_check_size
();

2758 
	}
}

2760 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

2761 
MODULE_LICENSE
("GPL");

2762 
MODULE_VERSION
("1.0");

2763 
moduË_š™
(
nvme_š™
);

2764 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/rdma.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/moduË.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/”r.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/©omic.h
>

21 
	~<lšux/blk-mq.h
>

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/li¡.h
>

24 
	~<lšux/mu‹x.h
>

25 
	~<lšux/sÿ‰”li¡.h
>

26 
	~"lšux_nvme.h
"

27 
	~<asm/uÇligÃd.h
>

29 
	~<rdma/ib_v”bs.h
>

30 
	~<rdma/rdma_cm.h
>

31 
	~<lšux/nvme-rdma.h
>

33 
	~"nvme.h
"

34 
	~"çbrics.h
"

37 
	#NVME_RDMA_CONNECT_TIMEOUT_MS
 3000

	)

39 
	#NVME_RDMA_MAX_SEGMENT_SIZE
 0xfffffà

	)

41 
	#NVME_RDMA_MAX_SEGMENTS
 256

	)

43 
	#NVME_RDMA_MAX_INLINE_SEGMENTS
 1

	)

49 
	#NVME_RDMA_NR_AEN_COMMANDS
 1

	)

50 
	#NVME_RDMA_AQ_BLKMQ_DEPTH
 \

51 (
NVME_AQ_DEPTH
 - 
NVME_RDMA_NR_AEN_COMMANDS
)

	)

53 
	snvme_rdma_deviû
 {

54 
ib_deviû
 *
	mdev
;

55 
ib_pd
 *
	mpd
;

56 
k»f
 
	m»f
;

57 
li¡_h—d
 
	m’Œy
;

60 
	snvme_rdma_qe
 {

61 
ib_cqe
 
	mcqe
;

62 *
	md©a
;

63 
u64
 
	mdma
;

66 
	gnvme_rdma_queue
;

67 
	snvme_rdma_»que¡
 {

68 
nvme_»que¡
 
	m»q
;

69 
ib_mr
 *
	mmr
;

70 
nvme_rdma_qe
 
	msqe
;

71 
ib_sge
 
	msge
[1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
];

72 
u32
 
	mnum_sge
;

73 
	mÃÁs
;

74 
boŞ
 
	mšlše_d©a
;

75 
ib_»g_wr
 
	m»g_wr
;

76 
ib_cqe
 
	m»g_cqe
;

77 
nvme_rdma_queue
 *
	mqueue
;

78 
sg_bË
 
	msg_bË
;

79 
sÿ‰”li¡
 
	mfœ¡_sgl
[];

82 
	envme_rdma_queue_æags
 {

83 
	mNVME_RDMA_Q_LIVE
 = 0,

84 
	mNVME_RDMA_Q_DELETING
 = 1,

87 
	snvme_rdma_queue
 {

88 
nvme_rdma_qe
 *
	mr¥_ršg
;

89 
©omic_t
 
	msig_couÁ
;

90 
	mqueue_size
;

91 
size_t
 
	mcmnd_ÿpsuË_Ën
;

92 
nvme_rdma_ù¾
 *
	mù¾
;

93 
nvme_rdma_deviû
 *
	mdeviû
;

94 
ib_cq
 *
	mib_cq
;

95 
ib_qp
 *
	mqp
;

97 
	mæags
;

98 
rdma_cm_id
 *
	mcm_id
;

99 
	mcm_”rÜ
;

100 
com¶‘iÚ
 
	mcm_dÚe
;

103 
	snvme_rdma_ù¾
 {

105 
nvme_rdma_queue
 *
	mqueues
;

108 
blk_mq_g_£t
 
	mg_£t
;

109 
wÜk_¡ruù
 
	md–‘e_wÜk
;

110 
wÜk_¡ruù
 
	m”r_wÜk
;

112 
nvme_rdma_qe
 
	masync_ev’t_sqe
;

114 
d–ayed_wÜk
 
	m»cÚÃù_wÜk
;

116 
li¡_h—d
 
	mli¡
;

118 
blk_mq_g_£t
 
	madmš_g_£t
;

119 
nvme_rdma_deviû
 *
	mdeviû
;

121 
u32
 
	mmax_ä_·ges
;

123 
sockaddr_¡Üage
 
	maddr
;

124 
sockaddr_¡Üage
 
	m¤c_addr
;

126 
nvme_ù¾
 
	mù¾
;

129 
šlše
 
nvme_rdma_ù¾
 *
	$to_rdma_ù¾
(
nvme_ù¾
 *
ù¾
)

131  
	`cÚš”_of
(
ù¾
, 
nvme_rdma_ù¾
, ctrl);

132 
	}
}

134 
LIST_HEAD
(
deviû_li¡
);

135 
DEFINE_MUTEX
(
deviû_li¡_mu‹x
);

137 
LIST_HEAD
(
nvme_rdma_ù¾_li¡
);

138 
DEFINE_MUTEX
(
nvme_rdma_ù¾_mu‹x
);

145 
boŞ
 
	g»gi¡”_®ways
 = 
Œue
;

146 
moduË_·¿m
(
»gi¡”_®ways
, 
boŞ
, 0444);

147 
MODULE_PARM_DESC
(
»gi¡”_®ways
,

150 
nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

151 
rdma_cm_ev’t
 *
ev’t
);

152 
nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
);

155 
šlše
 
	$put_uÇligÃd_Ë24
(
u32
 
v®
, 
u8
 *
p
)

157 *
p
++ = 
v®
;

158 *
p
++ = 
v®
 >> 8;

159 *
p
++ = 
v®
 >> 16;

160 
	}
}

162 
šlše
 
	$nvme_rdma_queue_idx
(
nvme_rdma_queue
 *
queue
)

164  
queue
 - queue->
ù¾
->
queues
;

165 
	}
}

167 
šlše
 
size_t
 
	$nvme_rdma_šlše_d©a_size
(
nvme_rdma_queue
 *
queue
)

169  
queue
->
cmnd_ÿpsuË_Ën
 - (
nvme_commªd
);

170 
	}
}

172 
	$nvme_rdma_ä“_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

173 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

175 
	`ib_dma_unm­_sšgË
(
ibdev
, 
qe
->
dma
, 
ÿpsuË_size
, 
dœ
);

176 
	`kä“
(
qe
->
d©a
);

177 
	}
}

179 
	$nvme_rdma_®loc_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

180 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

182 
qe
->
d©a
 = 
	`kz®loc
(
ÿpsuË_size
, 
GFP_KERNEL
);

183 ià(!
qe
->
d©a
)

184  -
ENOMEM
;

186 
qe
->
dma
 = 
	`ib_dma_m­_sšgË
(
ibdev
, qe->
d©a
, 
ÿpsuË_size
, 
dœ
);

187 ià(
	`ib_dma_m­pšg_”rÜ
(
ibdev
, 
qe
->
dma
)) {

188 
	`kä“
(
qe
->
d©a
);

189  -
ENOMEM
;

193 
	}
}

195 
	$nvme_rdma_ä“_ršg
(
ib_deviû
 *
ibdev
,

196 
nvme_rdma_qe
 *
ršg
, 
size_t
 
ib_queue_size
,

197 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

199 
i
;

201 
i
 = 0; i < 
ib_queue_size
; i++)

202 
	`nvme_rdma_ä“_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
);

203 
	`kä“
(
ršg
);

204 
	}
}

206 
nvme_rdma_qe
 *
	$nvme_rdma_®loc_ršg
(
ib_deviû
 *
ibdev
,

207 
size_t
 
ib_queue_size
, size_ˆ
ÿpsuË_size
,

208 
dma_d©a_dœeùiÚ
 
dœ
)

210 
nvme_rdma_qe
 *
ršg
;

211 
i
;

213 
ršg
 = 
	`kÿÎoc
(
ib_queue_size
, (
nvme_rdma_qe
), 
GFP_KERNEL
);

214 ià(!
ršg
)

215  
NULL
;

217 
i
 = 0; i < 
ib_queue_size
; i++) {

218 ià(
	`nvme_rdma_®loc_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
))

219 
out_ä“_ršg
;

222  
ršg
;

224 
out_ä“_ršg
:

225 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
ršg
, 
i
, 
ÿpsuË_size
, 
dœ
);

226  
NULL
;

227 
	}
}

229 
	$nvme_rdma_qp_ev’t
(
ib_ev’t
 *
ev’t
, *
cÚ‹xt
)

231 
	`´_debug
("QPƒvent %s (%d)\n",

232 
	`ib_ev’t_msg
(
ev’t
->event),ƒvent->event);

234 
	}
}

236 
	$nvme_rdma_wa™_fÜ_cm
(
nvme_rdma_queue
 *
queue
)

238 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(&
queue
->
cm_dÚe
,

239 
	`m£cs_to_jiff›s
(
NVME_RDMA_CONNECT_TIMEOUT_MS
) + 1);

240  
queue
->
cm_”rÜ
;

241 
	}
}

243 
	$nvme_rdma_ü—‹_qp
(
nvme_rdma_queue
 *
queue
, cÚ¡ 
çùÜ
)

245 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

246 
ib_qp_š™_©Œ
 
š™_©Œ
;

247 
»t
;

249 
	`mem£t
(&
š™_©Œ
, 0, (init_attr));

250 
š™_©Œ
.
ev’t_hªdËr
 = 
nvme_rdma_qp_ev’t
;

252 
š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
çùÜ
 * 
queue
->
queue_size
 + 1;

254 
š™_©Œ
.
ÿp
.
max_»cv_wr
 = 
queue
->
queue_size
 + 1;

255 
š™_©Œ
.
ÿp
.
max_»cv_sge
 = 1;

256 
š™_©Œ
.
ÿp
.
max_£nd_sge
 = 1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
;

257 
š™_©Œ
.
sq_sig_ty³
 = 
IB_SIGNAL_REQ_WR
;

258 
š™_©Œ
.
qp_ty³
 = 
IB_QPT_RC
;

259 
š™_©Œ
.
£nd_cq
 = 
queue
->
ib_cq
;

260 
š™_©Œ
.
»cv_cq
 = 
queue
->
ib_cq
;

262 
»t
 = 
	`rdma_ü—‹_qp
(
queue
->
cm_id
, 
dev
->
pd
, &
š™_©Œ
);

264 
queue
->
qp
 = queue->
cm_id
->qp;

265  
»t
;

266 
	}
}

268 
	$nvme_rdma_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

270 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

271 
nvme_rdma_deviû
 *
dev
 = 
ù¾
->
deviû
;

272 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

273 
»t
 = 0;

275 
	`ib_d”eg_mr
(
»q
->
mr
);

277 
»q
->
mr
 = 
	`ib_®loc_mr
(
dev
->
pd
, 
IB_MR_TYPE_MEM_REG
,

278 
ù¾
->
max_ä_·ges
);

279 ià(
	`IS_ERR
(
»q
->
mr
)) {

280 
»t
 = 
	`PTR_ERR
(
»q
->
mr
);

281 
»q
->
mr
 = 
NULL
;

282 
out
;

285 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

287 
out
:

288  
»t
;

289 
	}
}

291 
	$nvme_rdma_ex™_»que¡
(
blk_mq_g_£t
 *
£t
,

292 
»que¡
 *
rq
, 
hùx_idx
)

294 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

295 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

296 
queue_idx
 = (
£t
 =ğ&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

297 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

298 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

300 ià(
»q
->
mr
)

301 
	`ib_d”eg_mr
(
»q
->
mr
);

303 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

304 
DMA_TO_DEVICE
);

305 
	}
}

307 
	$nvme_rdma_š™_»que¡
(
blk_mq_g_£t
 *
£t
,

308 
»que¡
 *
rq
, 
hùx_idx
,

309 
numa_node
)

311 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

312 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

313 
queue_idx
 = (
£t
 =ğ&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

314 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

315 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

316 
ib_deviû
 *
ibdev
 = 
dev
->dev;

317 
»t
;

319 
»t
 = 
	`nvme_rdma_®loc_qe
(
ibdev
, &
»q
->
sqe
, (
nvme_commªd
),

320 
DMA_TO_DEVICE
);

321 ià(
»t
)

322  
»t
;

324 
»q
->
mr
 = 
	`ib_®loc_mr
(
dev
->
pd
, 
IB_MR_TYPE_MEM_REG
,

325 
ù¾
->
max_ä_·ges
);

326 ià(
	`IS_ERR
(
»q
->
mr
)) {

327 
»t
 = 
	`PTR_ERR
(
»q
->
mr
);

328 
out_ä“_qe
;

331 
»q
->
queue
 = queue;

335 
out_ä“_qe
:

336 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

337 
DMA_TO_DEVICE
);

338  -
ENOMEM
;

339 
	}
}

341 
	$nvme_rdma_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

342 
hùx_idx
)

344 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

345 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
 + 1];

347 
	`BUG_ON
(
hùx_idx
 >ğ
ù¾
->ù¾.
queue_couÁ
);

349 
hùx
->
driv”_d©a
 = 
queue
;

351 
	}
}

353 
	$nvme_rdma_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

354 
hùx_idx
)

356 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

357 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

359 
	`BUG_ON
(
hùx_idx
 != 0);

361 
hùx
->
driv”_d©a
 = 
queue
;

363 
	}
}

365 
	$nvme_rdma_ä“_dev
(
k»f
 *
»f
)

367 
nvme_rdma_deviû
 *
ndev
 =

368 
	`cÚš”_of
(
»f
, 
nvme_rdma_deviû
,„ef);

370 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

371 
	`li¡_d–
(&
ndev
->
’Œy
);

372 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

374 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

375 
	`kä“
(
ndev
);

376 
	}
}

378 
	$nvme_rdma_dev_put
(
nvme_rdma_deviû
 *
dev
)

380 
	`k»f_put
(&
dev
->
»f
, 
nvme_rdma_ä“_dev
);

381 
	}
}

383 
	$nvme_rdma_dev_g‘
(
nvme_rdma_deviû
 *
dev
)

385  
	`k»f_g‘_uÆess_z”o
(&
dev
->
»f
);

386 
	}
}

388 
nvme_rdma_deviû
 *

389 
	$nvme_rdma_fšd_g‘_deviû
(
rdma_cm_id
 *
cm_id
)

391 
nvme_rdma_deviû
 *
ndev
;

393 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

394 
	`li¡_fÜ_—ch_’Œy
(
ndev
, &
deviû_li¡
, 
’Œy
) {

395 ià(
ndev
->
dev
->
node_guid
 =ğ
cm_id
->
deviû
->node_guid &&

396 
	`nvme_rdma_dev_g‘
(
ndev
))

397 
out_uÆock
;

400 
ndev
 = 
	`kz®loc
((*ndev), 
GFP_KERNEL
);

401 ià(!
ndev
)

402 
out_”r
;

404 
ndev
->
dev
 = 
cm_id
->
deviû
;

405 
	`k»f_š™
(&
ndev
->
»f
);

407 
ndev
->
pd
 = 
	`ib_®loc_pd
Òdev->
dev
,

408 
»gi¡”_®ways
 ? 0 : 
IB_PD_UNSAFE_GLOBAL_RKEY
);

409 ià(
	`IS_ERR
(
ndev
->
pd
))

410 
out_ä“_dev
;

412 ià(!(
ndev
->
dev
->
©Œs
.
deviû_ÿp_æags
 &

413 
IB_DEVICE_MEM_MGT_EXTENSIONS
)) {

414 
	`dev_”r
(&
ndev
->
dev
->dev,

416 
out_ä“_pd
;

419 
	`li¡_add
(&
ndev
->
’Œy
, &
deviû_li¡
);

420 
out_uÆock
:

421 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

422  
ndev
;

424 
out_ä“_pd
:

425 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

426 
out_ä“_dev
:

427 
	`kä“
(
ndev
);

428 
out_”r
:

429 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

430  
NULL
;

431 
	}
}

433 
	$nvme_rdma_de¡roy_queue_ib
(
nvme_rdma_queue
 *
queue
)

435 
nvme_rdma_deviû
 *
dev
;

436 
ib_deviû
 *
ibdev
;

438 
dev
 = 
queue
->
deviû
;

439 
ibdev
 = 
dev
->dev;

440 
	`rdma_de¡roy_qp
(
queue
->
cm_id
);

441 
	`ib_ä“_cq
(
queue
->
ib_cq
);

443 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

444 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

446 
	`nvme_rdma_dev_put
(
dev
);

447 
	}
}

449 
	$nvme_rdma_ü—‹_queue_ib
(
nvme_rdma_queue
 *
queue
)

451 
ib_deviû
 *
ibdev
;

452 cÚ¡ 
£nd_wr_çùÜ
 = 3;

453 cÚ¡ 
cq_çùÜ
 = 
£nd_wr_çùÜ
 + 1;

454 
comp_veùÜ
, 
idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

455 
»t
;

457 
queue
->
deviû
 = 
	`nvme_rdma_fšd_g‘_deviû
(queue->
cm_id
);

458 ià(!
queue
->
deviû
) {

459 
	`dev_”r
(
queue
->
cm_id
->
deviû
->
dev
.
·»Á
,

461  -
ECONNREFUSED
;

463 
ibdev
 = 
queue
->
deviû
->
dev
;

469 ià(
idx
 == 0)

470 
comp_veùÜ
 = 0;

472 
comp_veùÜ
 = 
idx
 % 
ibdev
->
num_comp_veùÜs
;

476 
queue
->
ib_cq
 = 
	`ib_®loc_cq
(
ibdev
, queue,

477 
cq_çùÜ
 * 
queue
->
queue_size
 + 1,

478 
comp_veùÜ
, 
IB_POLL_SOFTIRQ
);

479 ià(
	`IS_ERR
(
queue
->
ib_cq
)) {

480 
»t
 = 
	`PTR_ERR
(
queue
->
ib_cq
);

481 
out_put_dev
;

484 
»t
 = 
	`nvme_rdma_ü—‹_qp
(
queue
, 
£nd_wr_çùÜ
);

485 ià(
»t
)

486 
out_de¡roy_ib_cq
;

488 
queue
->
r¥_ršg
 = 
	`nvme_rdma_®loc_ršg
(
ibdev
, queue->
queue_size
,

489 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

490 ià(!
queue
->
r¥_ršg
) {

491 
»t
 = -
ENOMEM
;

492 
out_de¡roy_qp
;

497 
out_de¡roy_qp
:

498 
	`ib_de¡roy_qp
(
queue
->
qp
);

499 
out_de¡roy_ib_cq
:

500 
	`ib_ä“_cq
(
queue
->
ib_cq
);

501 
out_put_dev
:

502 
	`nvme_rdma_dev_put
(
queue
->
deviû
);

503  
»t
;

504 
	}
}

506 
	$nvme_rdma_š™_queue
(
nvme_rdma_ù¾
 *
ù¾
,

507 
idx
, 
size_t
 
queue_size
)

509 
nvme_rdma_queue
 *
queue
;

510 
sockaddr
 *
¤c_addr
 = 
NULL
;

511 
»t
;

513 
queue
 = &
ù¾
->
queues
[
idx
];

514 
queue
->
ù¾
 = ctrl;

515 
	`š™_com¶‘iÚ
(&
queue
->
cm_dÚe
);

517 ià(
idx
 > 0)

518 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

520 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

522 
queue
->
queue_size
 = queue_size;

523 
	`©omic_£t
(&
queue
->
sig_couÁ
, 0);

525 
queue
->
cm_id
 = 
	`rdma_ü—‹_id
(&
š™_Ãt
, 
nvme_rdma_cm_hªdËr
, queue,

526 
RDMA_PS_TCP
, 
IB_QPT_RC
);

527 ià(
	`IS_ERR
(
queue
->
cm_id
)) {

528 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

529 "çedØü—‹ CM ID: %ld\n", 
	`PTR_ERR
(
queue
->
cm_id
));

530  
	`PTR_ERR
(
queue
->
cm_id
);

533 ià(
ù¾
->ù¾.
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

534 
¤c_addr
 = (
sockaddr
 *)&
ù¾
->src_addr;

536 
queue
->
cm_”rÜ
 = -
ETIMEDOUT
;

537 
»t
 = 
	`rdma_»sŞve_addr
(
queue
->
cm_id
, 
¤c_addr
,

538 (
sockaddr
 *)&
ù¾
->
addr
,

539 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

540 ià(
»t
) {

541 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

542 "rdma_»sŞve_add¸çed (%d).\n", 
»t
);

543 
out_de¡roy_cm_id
;

546 
»t
 = 
	`nvme_rdma_wa™_fÜ_cm
(
queue
);

547 ià(
»t
) {

548 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

549 "rdma_»sŞve_add¸wa™ faed (%d).\n", 
»t
);

550 
out_de¡roy_cm_id
;

553 
	`ş—r_b™
(
NVME_RDMA_Q_DELETING
, &
queue
->
æags
);

557 
out_de¡roy_cm_id
:

558 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

559  
»t
;

560 
	}
}

562 
	$nvme_rdma_¡İ_queue
(
nvme_rdma_queue
 *
queue
)

564 
	`rdma_discÚÃù
(
queue
->
cm_id
);

565 
	`ib_d¿š_qp
(
queue
->
qp
);

566 
	}
}

568 
	$nvme_rdma_ä“_queue
(
nvme_rdma_queue
 *
queue
)

570 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

571 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

572 
	}
}

574 
	$nvme_rdma_¡İ_ªd_ä“_queue
(
nvme_rdma_queue
 *
queue
)

576 ià(
	`‹¡_ªd_£t_b™
(
NVME_RDMA_Q_DELETING
, &
queue
->
æags
))

578 
	`nvme_rdma_¡İ_queue
(
queue
);

579 
	`nvme_rdma_ä“_queue
(
queue
);

580 
	}
}

582 
	$nvme_rdma_ä“_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

584 
i
;

586 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

587 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[
i
]);

588 
	}
}

590 
	$nvme_rdma_cÚÃù_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

592 
i
, 
»t
 = 0;

594 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

595 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

596 ià(
»t
) {

597 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

598 "çedØcÚÃù i/Øqueue: %d\n", 
»t
);

599 
out_ä“_queues
;

601 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

606 
out_ä“_queues
:

607 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

608  
»t
;

609 
	}
}

611 
	$nvme_rdma_š™_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

613 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

614 
Ä_io_queues
;

615 
i
, 
»t
;

617 
Ä_io_queues
 = 
	`mš
(
İts
->Ä_io_queues, 
	`num_Úlše_ıus
());

618 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

619 ià(
»t
)

620  
»t
;

622 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

623 ià(
ù¾
->ù¾.
queue_couÁ
 < 2)

626 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

627 "ü—tšg %d I/O queues.\n", 
Ä_io_queues
);

629 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

630 
»t
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 
i
,

631 
ù¾
->ù¾.
İts
->
queue_size
);

632 ià(
»t
) {

633 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

634 "çedØš™Ÿlizi/Øqueue: %d\n", 
»t
);

635 
out_ä“_queues
;

641 
out_ä“_queues
:

642 
i
--; i >= 1; i--)

643 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[
i
]);

645  
»t
;

646 
	}
}

648 
	$nvme_rdma_de¡roy_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
)

650 
	`nvme_rdma_ä“_qe
(
ù¾
->
queues
[0].
deviû
->
dev
, &ù¾->
async_ev’t_sqe
,

651 (
nvme_commªd
), 
DMA_TO_DEVICE
);

652 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[0]);

653 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

654 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

655 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

656 
	}
}

658 
	$nvme_rdma_ä“_ù¾
(
nvme_ù¾
 *
nù¾
)

660 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

662 ià(
	`li¡_em±y
(&
ù¾
->
li¡
))

663 
ä“_ù¾
;

665 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

666 
	`li¡_d–
(&
ù¾
->
li¡
);

667 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

669 
	`kä“
(
ù¾
->
queues
);

670 
	`nvmf_ä“_İtiÚs
(
nù¾
->
İts
);

671 
ä“_ù¾
:

672 
	`kä“
(
ù¾
);

673 
	}
}

675 
	$nvme_rdma_»cÚÃù_Ü_»move
(
nvme_rdma_ù¾
 *
ù¾
)

678 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_RECONNECTING
) {

679 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
 ||

680 
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
);

684 ià(
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

685 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Reconnecting in %d seconds...\n",

686 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
);

687 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
»cÚÃù_wÜk
,

688 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
 * 
HZ
);

690 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Removing controller...\n");

691 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
d–‘e_wÜk
);

693 
	}
}

695 
	$nvme_rdma_»cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

697 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

698 
nvme_rdma_ù¾
, 
»cÚÃù_wÜk
);

699 
boŞ
 
chªged
;

700 
»t
;

702 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

704 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

705 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

707 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

708 ià(
»t
)

709 
»queue
;

712 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[0]);

714 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
admš_g_£t
);

715 ià(
»t
)

716 
»queue
;

718 
»t
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 0, 
NVME_AQ_DEPTH
);

719 ià(
»t
)

720 
»queue
;

722 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

723 ià(
»t
)

724 
»queue
;

726 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

728 
»t
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

729 ià(
»t
)

730 
»queue
;

732 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

733 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

734 ià(
»t
)

735 
»queue
;

737 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

738 ià(
»t
)

739 
»queue
;

741 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
,

742 
ù¾
->ù¾.
queue_couÁ
 - 1);

745 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

746 
	`WARN_ON_ONCE
(!
chªged
);

747 
ù¾
->ù¾.
Ä_»cÚÃùs
 = 0;

749 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

751 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Successfully„econnected\n");

755 
»queue
:

756 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Failed„econnect‡ttempt %d\n",

757 
ù¾
->ù¾.
Ä_»cÚÃùs
);

758 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

759 
	}
}

761 
	$nvme_rdma_”rÜ_»cov”y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

763 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

764 
nvme_rdma_ù¾
, 
”r_wÜk
);

765 
i
;

767 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

769 
i
 = 0; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

770 
	`ş—r_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

772 ià(
ù¾
->ù¾.
queue_couÁ
 > 1)

773 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

774 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

777 ià(
ù¾
->ù¾.
queue_couÁ
 > 1)

778 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

779 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

780 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

781 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

787 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

788 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

790 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

791 
	}
}

793 
	$nvme_rdma_”rÜ_»cov”y
(
nvme_rdma_ù¾
 *
ù¾
)

795 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
))

798 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
”r_wÜk
);

799 
	}
}

801 
	$nvme_rdma_wr_”rÜ
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
,

802 cÚ¡ *
İ
)

804 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

805 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

807 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
)

808 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

810 
İ
, 
wc
->
wr_cqe
,

811 
	`ib_wc_¡©us_msg
(
wc
->
¡©us
), wc->status);

812 
	`nvme_rdma_”rÜ_»cov”y
(
ù¾
);

813 
	}
}

815 
	$nvme_rdma_mem»g_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

817 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

818 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "MEMREG");

819 
	}
}

821 
	$nvme_rdma_šv_rkey_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

823 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

824 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "LOCAL_INV");

825 
	}
}

827 
	$nvme_rdma_šv_rkey
(
nvme_rdma_queue
 *
queue
,

828 
nvme_rdma_»que¡
 *
»q
)

830 
ib_£nd_wr
 *
bad_wr
;

831 
ib_£nd_wr
 
wr
 = {

832 .
İcode
 = 
IB_WR_LOCAL_INV
,

833 .
Ãxt
 = 
NULL
,

834 .
num_sge
 = 0,

835 .
£nd_æags
 = 0,

836 .
ex
.
šv®id©e_rkey
 = 
»q
->
mr
->
rkey
,

839 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_šv_rkey_dÚe
;

840 
wr
.
wr_cqe
 = &
»q
->
»g_cqe
;

842  
	`ib_po¡_£nd
(
queue
->
qp
, &
wr
, &
bad_wr
);

843 
	}
}

845 
	$nvme_rdma_unm­_d©a
(
nvme_rdma_queue
 *
queue
,

846 
»que¡
 *
rq
)

848 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

849 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

850 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

851 
ib_deviû
 *
ibdev
 = 
dev
->dev;

852 
»s
;

854 ià(!
	`blk_rq_by‹s
(
rq
))

857 ià(
»q
->
mr
->
Ãed_šv®
) {

858 
»s
 = 
	`nvme_rdma_šv_rkey
(
queue
, 
»q
);

859 ià(
»s
 < 0) {

860 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

862 
»q
->
mr
->
rkey
, 
»s
);

863 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

867 
	`ib_dma_unm­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,

868 
»q
->
ÃÁs
, 
	`rq_d©a_dœ
(
rq
) ==

869 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

871 
	`nvme_ş—nup_cmd
(
rq
);

872 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

873 
	}
}

875 
	$nvme_rdma_£t_sg_nuÎ
(
nvme_commªd
 *
c
)

877 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

879 
sg
->
addr
 = 0;

880 
	`put_uÇligÃd_Ë24
(0, 
sg
->
Ëngth
);

881 
	`put_uÇligÃd_Ë32
(0, 
sg
->
key
);

882 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

884 
	}
}

886 
	$nvme_rdma_m­_sg_šlše
(
nvme_rdma_queue
 *
queue
,

887 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

889 
nvme_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
sgl
;

891 
»q
->
sge
[1].
addr
 = 
	`sg_dma_add»ss
Ôeq->
sg_bË
.
sgl
);

892 
»q
->
sge
[1].
Ëngth
 = 
	`sg_dma_Ën
Ôeq->
sg_bË
.
sgl
);

893 
»q
->
sge
[1].
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

895 
sg
->
addr
 = 
	`ıu_to_Ë64
(
queue
->
ù¾
->ù¾.
icdoff
);

896 
sg
->
Ëngth
 = 
	`ıu_to_Ë32
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
));

897 
sg
->
ty³
 = (
NVME_SGL_FMT_DATA_DESC
 << 4è| 
NVME_SGL_FMT_OFFSET
;

899 
»q
->
šlše_d©a
 = 
Œue
;

900 
»q
->
num_sge
++;

902 
	}
}

904 
	$nvme_rdma_m­_sg_sšgË
(
nvme_rdma_queue
 *
queue
,

905 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

907 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

909 
sg
->
addr
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
»q
->
sg_bË
.
sgl
));

910 
	`put_uÇligÃd_Ë24
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
), 
sg
->
Ëngth
);

911 
	`put_uÇligÃd_Ë32
(
queue
->
deviû
->
pd
->
un§ã_glob®_rkey
, 
sg
->
key
);

912 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

914 
	}
}

916 
	$nvme_rdma_m­_sg_ä
(
nvme_rdma_queue
 *
queue
,

917 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
,

918 
couÁ
)

920 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

921 
Ä
;

927 
Ä
 = 
	`ib_m­_mr_sg
(
»q
->
mr
,„eq->
sg_bË
.
sgl
, 
couÁ
, 
NULL
, 
SZ_4K
);

928 ià(
Ä
 < 
couÁ
) {

929 ià(
Ä
 < 0)

930  
Ä
;

931  -
EINVAL
;

934 
	`ib_upd©e_ç¡_»g_key
(
»q
->
mr
, 
	`ib_šc_rkey
Ôeq->mr->
rkey
));

936 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_mem»g_dÚe
;

937 
	`mem£t
(&
»q
->
»g_wr
, 0, (req->reg_wr));

938 
»q
->
»g_wr
.
wr
.
İcode
 = 
IB_WR_REG_MR
;

939 
»q
->
»g_wr
.
wr
.
wr_cqe
 = &»q->
»g_cqe
;

940 
»q
->
»g_wr
.
wr
.
num_sge
 = 0;

941 
»q
->
»g_wr
.
mr
 =„eq->mr;

942 
»q
->
»g_wr
.
key
 =„eq->
mr
->
rkey
;

943 
»q
->
»g_wr
.
acûss
 = 
IB_ACCESS_LOCAL_WRITE
 |

944 
IB_ACCESS_REMOTE_READ
 |

945 
IB_ACCESS_REMOTE_WRITE
;

947 
»q
->
mr
->
Ãed_šv®
 = 
Œue
;

949 
sg
->
addr
 = 
	`ıu_to_Ë64
(
»q
->
mr
->
iova
);

950 
	`put_uÇligÃd_Ë24
(
»q
->
mr
->
Ëngth
, 
sg
->length);

951 
	`put_uÇligÃd_Ë32
(
»q
->
mr
->
rkey
, 
sg
->
key
);

952 
sg
->
ty³
 = (
NVME_KEY_SGL_FMT_DATA_DESC
 << 4) |

953 
NVME_SGL_FMT_INVALIDATE
;

956 
	}
}

958 
	$nvme_rdma_m­_d©a
(
nvme_rdma_queue
 *
queue
,

959 
»que¡
 *
rq
, 
nvme_commªd
 *
c
)

961 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

962 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

963 
ib_deviû
 *
ibdev
 = 
dev
->dev;

964 
couÁ
, 
»t
;

966 
»q
->
num_sge
 = 1;

967 
»q
->
šlše_d©a
 = 
çl£
;

968 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

970 
c
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

972 ià(!
	`blk_rq_by‹s
(
rq
))

973  
	`nvme_rdma_£t_sg_nuÎ
(
c
);

975 
»q
->
sg_bË
.
sgl
 =„eq->
fœ¡_sgl
;

976 
»t
 = 
	`sg_®loc_bË_chašed
(&
»q
->
sg_bË
,

977 
	`blk_rq_Ä_phys_£gm’ts
(
rq
), 
»q
->
sg_bË
.
sgl
);

978 ià(
»t
)

979  -
ENOMEM
;

981 
»q
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q,„eq->
sg_bË
.
sgl
);

983 
couÁ
 = 
	`ib_dma_m­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,„eq->
ÃÁs
,

984 
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

985 ià(
	`uÆik–y
(
couÁ
 <= 0)) {

986 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

987  -
EIO
;

990 ià(
couÁ
 == 1) {

991 ià(
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 && 
	`nvme_rdma_queue_idx
(
queue
) &&

992 
	`blk_rq_·ylßd_by‹s
(
rq
) <=

993 
	`nvme_rdma_šlše_d©a_size
(
queue
))

994  
	`nvme_rdma_m­_sg_šlše
(
queue
, 
»q
, 
c
);

996 ià(
dev
->
pd
->
æags
 & 
IB_PD_UNSAFE_GLOBAL_RKEY
)

997  
	`nvme_rdma_m­_sg_sšgË
(
queue
, 
»q
, 
c
);

1000  
	`nvme_rdma_m­_sg_ä
(
queue
, 
»q
, 
c
, 
couÁ
);

1001 
	}
}

1003 
	$nvme_rdma_£nd_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1005 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

1006 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "SEND");

1007 
	}
}

1014 
šlše
 
boŞ
 
	$nvme_rdma_queue_sig_lim™
(
nvme_rdma_queue
 *
queue
)

1016 
lim™
 = 1 << 
	`og2
((
queue
->
queue_size
 + 1) / 2);

1018  (
	`©omic_šc_»tuº
(&
queue
->
sig_couÁ
è& (
lim™
 - 1)) == 0;

1019 
	}
}

1021 
	$nvme_rdma_po¡_£nd
(
nvme_rdma_queue
 *
queue
,

1022 
nvme_rdma_qe
 *
qe
, 
ib_sge
 *
sge
, 
u32
 
num_sge
,

1023 
ib_£nd_wr
 *
fœ¡
, 
boŞ
 
æush
)

1025 
ib_£nd_wr
 
wr
, *
bad_wr
;

1026 
»t
;

1028 
sge
->
addr
 = 
qe
->
dma
;

1029 
sge
->
Ëngth
 = (
nvme_commªd
),

1030 
sge
->
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1032 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_£nd_dÚe
;

1034 
wr
.
Ãxt
 = 
NULL
;

1035 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1036 
wr
.
sg_li¡
 = 
sge
;

1037 
wr
.
num_sge
 =‚um_sge;

1038 
wr
.
İcode
 = 
IB_WR_SEND
;

1039 
wr
.
£nd_æags
 = 0;

1055 ià(
	`nvme_rdma_queue_sig_lim™
(
queue
è|| 
æush
)

1056 
wr
.
£nd_æags
 |ğ
IB_SEND_SIGNALED
;

1058 ià(
fœ¡
)

1059 
fœ¡
->
Ãxt
 = &
wr
;

1061 
fœ¡
 = &
wr
;

1063 
»t
 = 
	`ib_po¡_£nd
(
queue
->
qp
, 
fœ¡
, &
bad_wr
);

1064 ià(
»t
) {

1065 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1066 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1068  
»t
;

1069 
	}
}

1071 
	$nvme_rdma_po¡_»cv
(
nvme_rdma_queue
 *
queue
,

1072 
nvme_rdma_qe
 *
qe
)

1074 
ib_»cv_wr
 
wr
, *
bad_wr
;

1075 
ib_sge
 
li¡
;

1076 
»t
;

1078 
li¡
.
addr
 = 
qe
->
dma
;

1079 
li¡
.
Ëngth
 = (
nvme_com¶‘iÚ
);

1080 
li¡
.
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1082 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_»cv_dÚe
;

1084 
wr
.
Ãxt
 = 
NULL
;

1085 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1086 
wr
.
sg_li¡
 = &
li¡
;

1087 
wr
.
num_sge
 = 1;

1089 
»t
 = 
	`ib_po¡_»cv
(
queue
->
qp
, &
wr
, &
bad_wr
);

1090 ià(
»t
) {

1091 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1092 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1094  
»t
;

1095 
	}
}

1097 
blk_mq_gs
 *
	$nvme_rdma_g£t
(
nvme_rdma_queue
 *
queue
)

1099 
u32
 
queue_idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

1101 ià(
queue_idx
 == 0)

1102  
queue
->
ù¾
->
admš_g_£t
.
gs
[
queue_idx
];

1103  
queue
->
ù¾
->
g_£t
.
gs
[
queue_idx
 - 1];

1104 
	}
}

1106 
	$nvme_rdma_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
, 
«r_idx
)

1108 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
¬g
);

1109 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

1110 
ib_deviû
 *
dev
 = 
queue
->
deviû
->dev;

1111 
nvme_rdma_qe
 *
sqe
 = &
ù¾
->
async_ev’t_sqe
;

1112 
nvme_commªd
 *
cmd
 = 
sqe
->
d©a
;

1113 
ib_sge
 
sge
;

1114 
»t
;

1116 ià(
	`WARN_ON_ONCE
(
«r_idx
 != 0))

1119 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
, (*
cmd
), 
DMA_TO_DEVICE
);

1121 
	`mem£t
(
cmd
, 0, (*cmd));

1122 
cmd
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1123 
cmd
->
commÚ
.
commªd_id
 = 
NVME_RDMA_AQ_BLKMQ_DEPTH
;

1124 
cmd
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1125 
	`nvme_rdma_£t_sg_nuÎ
(
cmd
);

1127 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
, (*
cmd
),

1128 
DMA_TO_DEVICE
);

1130 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, &
sge
, 1, 
NULL
, 
çl£
);

1131 
	`WARN_ON_ONCE
(
»t
);

1132 
	}
}

1134 
	$nvme_rdma_´oûss_nvme_r¥
(
nvme_rdma_queue
 *
queue
,

1135 
nvme_com¶‘iÚ
 *
cqe
, 
ib_wc
 *
wc
, 
g
)

1137 
»que¡
 *
rq
;

1138 
nvme_rdma_»que¡
 *
»q
;

1139 
»t
 = 0;

1141 
rq
 = 
	`blk_mq_g_to_rq
(
	`nvme_rdma_g£t
(
queue
), 
cqe
->
commªd_id
);

1142 ià(!
rq
) {

1143 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1145 
cqe
->
commªd_id
, 
queue
->
qp
->
qp_num
);

1146 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1147  
»t
;

1149 
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1151 ià(
rq
->
g
 ==ag)

1152 
»t
 = 1;

1154 ià((
wc
->
wc_æags
 & 
IB_WC_WITH_INVALIDATE
) &&

1155 
wc
->
ex
.
šv®id©e_rkey
 =ğ
»q
->
mr
->
rkey
)

1156 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

1158 
	`nvme_’d_»que¡
(
rq
, 
cqe
->
¡©us
, cqe->
»suÉ
);

1159  
»t
;

1160 
	}
}

1162 
	$__nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
, 
g
)

1164 
nvme_rdma_qe
 *
qe
 =

1165 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1166 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

1167 
ib_deviû
 *
ibdev
 = 
queue
->
deviû
->
dev
;

1168 
nvme_com¶‘iÚ
 *
cqe
 = 
qe
->
d©a
;

1169 cÚ¡ 
size_t
 
Ën
 = (
nvme_com¶‘iÚ
);

1170 
»t
 = 0;

1172 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
)) {

1173 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "RECV");

1177 
	`ib_dma_sync_sšgË_fÜ_ıu
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1184 ià(
	`uÆik–y
(
	`nvme_rdma_queue_idx
(
queue
) == 0 &&

1185 
cqe
->
commªd_id
 >ğ
NVME_RDMA_AQ_BLKMQ_DEPTH
))

1186 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
cqe
->
¡©us
,

1187 &
cqe
->
»suÉ
);

1189 
»t
 = 
	`nvme_rdma_´oûss_nvme_r¥
(
queue
, 
cqe
, 
wc
, 
g
);

1190 
	`ib_dma_sync_sšgË_fÜ_deviû
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1192 
	`nvme_rdma_po¡_»cv
(
queue
, 
qe
);

1193  
»t
;

1194 
	}
}

1196 
	$nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1198 
	`__nvme_rdma_»cv_dÚe
(
cq
, 
wc
, -1);

1199 
	}
}

1201 
	$nvme_rdma_cÚn_e¡ablished
(
nvme_rdma_queue
 *
queue
)

1203 
»t
, 
i
;

1205 
i
 = 0; i < 
queue
->
queue_size
; i++) {

1206 
»t
 = 
	`nvme_rdma_po¡_»cv
(
queue
, &queue->
r¥_ršg
[
i
]);

1207 ià(
»t
)

1208 
out_de¡roy_queue_ib
;

1213 
out_de¡roy_queue_ib
:

1214 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1215  
»t
;

1216 
	}
}

1218 
	$nvme_rdma_cÚn_»jeùed
(
nvme_rdma_queue
 *
queue
,

1219 
rdma_cm_ev’t
 *
ev
)

1221 
rdma_cm_id
 *
cm_id
 = 
queue
->cm_id;

1222 
¡©us
 = 
ev
->status;

1223 cÚ¡ *
»j_msg
;

1224 cÚ¡ 
nvme_rdma_cm_»j
 *
»j_d©a
;

1225 
u8
 
»j_d©a_Ën
;

1227 
»j_msg
 = 
	`rdma_»jeù_msg
(
cm_id
, 
¡©us
);

1228 
»j_d©a
 = 
	`rdma_cÚsum”_»jeù_d©a
(
cm_id
, 
ev
, &
»j_d©a_Ën
);

1230 ià(
»j_d©a
 && 
»j_d©a_Ën
 >ğ(
u16
)) {

1231 
u16
 
¡s
 = 
	`Ë16_to_ıu
(
»j_d©a
->sts);

1233 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1235 
¡©us
, 
»j_msg
, 
¡s
, 
	`nvme_rdma_cm_msg
(sts));

1237 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1238 "CÚÃù„ejeùed: stu %d (%s).\n", 
¡©us
, 
»j_msg
);

1241  -
ECONNRESET
;

1242 
	}
}

1244 
	$nvme_rdma_addr_»sŞved
(
nvme_rdma_queue
 *
queue
)

1246 
»t
;

1248 
»t
 = 
	`nvme_rdma_ü—‹_queue_ib
(
queue
);

1249 ià(
»t
)

1250  
»t
;

1252 
»t
 = 
	`rdma_»sŞve_rou‹
(
queue
->
cm_id
, 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

1253 ià(
»t
) {

1254 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1256 
queue
->
cm_”rÜ
);

1257 
out_de¡roy_queue
;

1262 
out_de¡roy_queue
:

1263 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1264  
»t
;

1265 
	}
}

1267 
	$nvme_rdma_rou‹_»sŞved
(
nvme_rdma_queue
 *
queue
)

1269 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1270 
rdma_cÚn_·¿m
 
·¿m
 = { };

1271 
nvme_rdma_cm_»q
 
´iv
 = { };

1272 
»t
;

1274 
·¿m
.
qp_num
 = 
queue
->
qp
->qp_num;

1275 
·¿m
.
æow_cÚŒŞ
 = 1;

1277 
·¿m
.
»¥Úd”_»sourûs
 = 
queue
->
deviû
->
dev
->
©Œs
.
max_qp_rd_©om
;

1279 
·¿m
.
»Œy_couÁ
 = 7;

1280 
·¿m
.
ºr_»Œy_couÁ
 = 7;

1281 
·¿m
.
´iv©e_d©a
 = &
´iv
;

1282 
·¿m
.
´iv©e_d©a_Ën
 = (
´iv
);

1284 
´iv
.
»cfmt
 = 
	`ıu_to_Ë16
(
NVME_RDMA_CM_FMT_1_0
);

1285 
´iv
.
qid
 = 
	`ıu_to_Ë16
(
	`nvme_rdma_queue_idx
(
queue
));

1290 ià(
´iv
.
qid
 == 0) {

1291 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
NVME_AQ_DEPTH
);

1292 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
NVME_AQ_DEPTH
 - 1);

1299 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
queue
->
queue_size
);

1300 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
queue
->
ù¾
->ù¾.
sqsize
);

1303 
»t
 = 
	`rdma_cÚÃù
(
queue
->
cm_id
, &
·¿m
);

1304 ià(
»t
) {

1305 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1306 "rdma_cÚÃù faed (%d).\n", 
»t
);

1307 
out_de¡roy_queue_ib
;

1312 
out_de¡roy_queue_ib
:

1313 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1314  
»t
;

1315 
	}
}

1317 
	$nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

1318 
rdma_cm_ev’t
 *
ev
)

1320 
nvme_rdma_queue
 *
queue
 = 
cm_id
->
cÚ‹xt
;

1321 
cm_”rÜ
 = 0;

1323 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
, "%s (%d): status %d id %p\n",

1324 
	`rdma_ev’t_msg
(
ev
->
ev’t
),ƒv->event,

1325 
ev
->
¡©us
, 
cm_id
);

1327 
ev
->
ev’t
) {

1328 
RDMA_CM_EVENT_ADDR_RESOLVED
:

1329 
cm_”rÜ
 = 
	`nvme_rdma_addr_»sŞved
(
queue
);

1331 
RDMA_CM_EVENT_ROUTE_RESOLVED
:

1332 
cm_”rÜ
 = 
	`nvme_rdma_rou‹_»sŞved
(
queue
);

1334 
RDMA_CM_EVENT_ESTABLISHED
:

1335 
queue
->
cm_”rÜ
 = 
	`nvme_rdma_cÚn_e¡ablished
(queue);

1337 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1339 
RDMA_CM_EVENT_REJECTED
:

1340 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1341 
cm_”rÜ
 = 
	`nvme_rdma_cÚn_»jeùed
(
queue
, 
ev
);

1343 
RDMA_CM_EVENT_ROUTE_ERROR
:

1344 
RDMA_CM_EVENT_CONNECT_ERROR
:

1345 
RDMA_CM_EVENT_UNREACHABLE
:

1346 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1347 
RDMA_CM_EVENT_ADDR_ERROR
:

1348 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1349 "CMƒ¼Üƒv’ˆ%d\n", 
ev
->
ev’t
);

1350 
cm_”rÜ
 = -
ECONNRESET
;

1352 
RDMA_CM_EVENT_DISCONNECTED
:

1353 
RDMA_CM_EVENT_ADDR_CHANGE
:

1354 
RDMA_CM_EVENT_TIMEWAIT_EXIT
:

1355 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1357 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1359 
RDMA_CM_EVENT_DEVICE_REMOVAL
:

1363 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1364 "UÃx³ùed RDMA CMƒv’ˆ(%d)\n", 
ev
->
ev’t
);

1365 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1369 ià(
cm_”rÜ
) {

1370 
queue
->
cm_”rÜ
 = cm_error;

1371 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1375 
	}
}

1377 
blk_eh_tim”_»tuº


1378 
	$nvme_rdma_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

1380 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1383 
	`nvme_rdma_”rÜ_»cov”y
(
»q
->
queue
->
ù¾
);

1386 
	`nvme_»q
(
rq
)->
¡©us
 = 
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
;

1388  
BLK_EH_HANDLED
;

1389 
	}
}

1394 
šlše
 
blk_¡©us_t


1395 
	$nvme_rdma_queue_is_»ady
(
nvme_rdma_queue
 *
queue
, 
»que¡
 *
rq
)

1397 ià(
	`uÆik–y
(!
	`‹¡_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
))) {

1398 
nvme_commªd
 *
cmd
 = 
	`nvme_»q
(
rq
)->cmd;

1400 ià(!
	`blk_rq_is_·s¡hrough
(
rq
) ||

1401 
cmd
->
commÚ
.
İcode
 !ğ
nvme_çbrics_commªd
 ||

1402 
cmd
->
çbrics
.
fùy³
 !ğ
nvme_çbrics_ty³_cÚÃù
) {

1410 ià(
queue
->
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_RECONNECTING
)

1411  
BLK_STS_IOERR
;

1412  
BLK_STS_RESOURCE
;

1417 
	}
}

1419 
blk_¡©us_t
 
	$nvme_rdma_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1420 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1422 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1423 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1424 
»que¡
 *
rq
 = 
bd
->rq;

1425 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1426 
nvme_rdma_qe
 *
sqe
 = &
»q
->sqe;

1427 
nvme_commªd
 *
c
 = 
sqe
->
d©a
;

1428 
boŞ
 
æush
 = 
çl£
;

1429 
ib_deviû
 *
dev
;

1430 
blk_¡©us_t
 
»t
;

1431 
”r
;

1433 
	`WARN_ON_ONCE
(
rq
->
g
 < 0);

1435 
»t
 = 
	`nvme_rdma_queue_is_»ady
(
queue
, 
rq
);

1436 ià(
	`uÆik–y
(
»t
))

1437  
»t
;

1439 
dev
 = 
queue
->
deviû
->dev;

1440 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
,

1441 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1443 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
c
);

1444 ià(
»t
)

1445  
»t
;

1447 
	`blk_mq_¡¬t_»que¡
(
rq
);

1449 
”r
 = 
	`nvme_rdma_m­_d©a
(
queue
, 
rq
, 
c
);

1450 ià(
”r
 < 0) {

1451 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1452 "FaedØm­ d©¨(%d)\n", 
”r
);

1453 
	`nvme_ş—nup_cmd
(
rq
);

1454 
”r
;

1457 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
,

1458 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1460 ià(
	`»q_İ
(
rq
è=ğ
REQ_OP_FLUSH
)

1461 
æush
 = 
Œue
;

1462 
”r
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, 
»q
->
sge
,„eq->
num_sge
,

1463 
»q
->
mr
->
Ãed_šv®
 ? &»q->
»g_wr
.
wr
 : 
NULL
, 
æush
);

1464 ià(
”r
) {

1465 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1466 
”r
;

1469  
BLK_STS_OK
;

1470 
”r
:

1471 ià(
”r
 =ğ-
ENOMEM
 ||ƒ¼ =ğ-
EAGAIN
)

1472  
BLK_STS_RESOURCE
;

1473  
BLK_STS_IOERR
;

1474 
	}
}

1476 
	$nvme_rdma_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1478 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1479 
ib_cq
 *
cq
 = 
queue
->ib_cq;

1480 
ib_wc
 
wc
;

1481 
found
 = 0;

1483 
	`ib_pŞl_cq
(
cq
, 1, &
wc
) > 0) {

1484 
ib_cqe
 *
cqe
 = 
wc
.
wr_cqe
;

1486 ià(
cqe
) {

1487 ià(
cqe
->
dÚe
 =ğ
nvme_rdma_»cv_dÚe
)

1488 
found
 |ğ
	`__nvme_rdma_»cv_dÚe
(
cq
, &
wc
, 
g
);

1490 
cqe
->
	`dÚe
(
cq
, &
wc
);

1494  
found
;

1495 
	}
}

1497 
	$nvme_rdma_com¶‘e_rq
(
»que¡
 *
rq
)

1499 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1501 
	`nvme_rdma_unm­_d©a
(
»q
->
queue
, 
rq
);

1502 
	`nvme_com¶‘e_rq
(
rq
);

1503 
	}
}

1505 cÚ¡ 
blk_mq_İs
 
	gnvme_rdma_mq_İs
 = {

1506 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1507 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1508 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1509 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1510 .
	g»š™_»que¡
 = 
nvme_rdma_»š™_»que¡
,

1511 .
	gš™_hùx
 = 
nvme_rdma_š™_hùx
,

1512 .
	gpŞl
 = 
nvme_rdma_pŞl
,

1513 .
	gtimeout
 = 
nvme_rdma_timeout
,

1516 cÚ¡ 
blk_mq_İs
 
	gnvme_rdma_admš_mq_İs
 = {

1517 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1518 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1519 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1520 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1521 .
	g»š™_»que¡
 = 
nvme_rdma_»š™_»que¡
,

1522 .
	gš™_hùx
 = 
nvme_rdma_š™_admš_hùx
,

1523 .
	gtimeout
 = 
nvme_rdma_timeout
,

1526 
	$nvme_rdma_cÚfigu»_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
)

1528 
”rÜ
;

1530 
”rÜ
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 0, 
NVME_AQ_DEPTH
);

1531 ià(
”rÜ
)

1532  
”rÜ
;

1534 
ù¾
->
deviû
 = cŒl->
queues
[0].device;

1540 
”rÜ
 = -
EINVAL
;

1541 ià(!
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
))

1542 
out_ä“_queue
;

1544 
ù¾
->
max_ä_·ges
 = 
	`mš_t
(
u32
, 
NVME_RDMA_MAX_SEGMENTS
,

1545 
ù¾
->
deviû
->
dev
->
©Œs
.
max_ç¡_»g_·ge_li¡_Ën
);

1547 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

1548 
ù¾
->
admš_g_£t
.
İs
 = &
nvme_rdma_admš_mq_İs
;

1549 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_RDMA_AQ_BLKMQ_DEPTH
;

1550 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

1551 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1552 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_rdma_»que¡
) +

1553 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

1554 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

1555 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

1556 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1558 
”rÜ
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

1559 ià(
”rÜ
)

1560 
out_put_dev
;

1562 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

1563 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

1564 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

1565 
out_ä“_g£t
;

1568 
”rÜ
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

1569 ià(
”rÜ
)

1570 
out_ş—nup_queue
;

1572 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

1574 
”rÜ
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
,

1575 &
ù¾
->ù¾.
ÿp
);

1576 ià(
”rÜ
) {

1577 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1579 
out_ş—nup_queue
;

1582 
ù¾
->ù¾.
sqsize
 =

1583 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->ù¾.
ÿp
), cŒl->ù¾.
sqsize
);

1585 
”rÜ
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

1586 ià(
”rÜ
)

1587 
out_ş—nup_queue
;

1589 
ù¾
->ù¾.
max_hw_£ùÜs
 =

1590 (
ù¾
->
max_ä_·ges
 - 1è<< (
	`og2
(
SZ_4K
) - 9);

1592 
”rÜ
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

1593 ià(
”rÜ
)

1594 
out_ş—nup_queue
;

1596 
”rÜ
 = 
	`nvme_rdma_®loc_qe
(
ù¾
->
queues
[0].
deviû
->
dev
,

1597 &
ù¾
->
async_ev’t_sqe
, (
nvme_commªd
),

1598 
DMA_TO_DEVICE
);

1599 ià(
”rÜ
)

1600 
out_ş—nup_queue
;

1604 
out_ş—nup_queue
:

1605 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

1606 
out_ä“_g£t
:

1608 
	`nvme_rdma_¡İ_queue
(&
ù¾
->
queues
[0]);

1609 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

1610 
out_put_dev
:

1611 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1612 
out_ä“_queue
:

1613 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

1614  
”rÜ
;

1615 
	}
}

1617 
	$nvme_rdma_shutdown_ù¾
(
nvme_rdma_ù¾
 *
ù¾
)

1619 
	`ÿnûl_wÜk_sync
(&
ù¾
->
”r_wÜk
);

1620 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
»cÚÃù_wÜk
);

1622 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1623 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

1624 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

1625 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1626 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

1629 ià(
	`‹¡_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
))

1630 
	`nvme_shutdown_ù¾
(&
ù¾
->ctrl);

1632 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1633 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

1634 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1635 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1636 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
);

1637 
	}
}

1639 
	$__nvme_rdma_»move_ù¾
(
nvme_rdma_ù¾
 *
ù¾
, 
boŞ
 
shutdown
)

1641 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

1642 
	`nvme_»move_Çme¥aûs
(&
ù¾
->ctrl);

1643 ià(
shutdown
)

1644 
	`nvme_rdma_shutdown_ù¾
(
ù¾
);

1646 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1647 ià(
ù¾
->ù¾.
g£t
) {

1648 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1649 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1650 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1653 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1654 
	}
}

1656 
	$nvme_rdma_d–_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1658 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1659 
nvme_rdma_ù¾
, 
d–‘e_wÜk
);

1661 
	`__nvme_rdma_»move_ù¾
(
ù¾
, 
Œue
);

1662 
	}
}

1664 
	$__nvme_rdma_d–_ù¾
(
nvme_rdma_ù¾
 *
ù¾
)

1666 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_DELETING
))

1667  -
EBUSY
;

1669 ià(!
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
d–‘e_wÜk
))

1670  -
EBUSY
;

1673 
	}
}

1675 
	$nvme_rdma_d–_ù¾
(
nvme_ù¾
 *
nù¾
)

1677 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

1678 
»t
 = 0;

1684 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->ù¾.
k»f
))

1685  -
EBUSY
;

1686 
»t
 = 
	`__nvme_rdma_d–_ù¾
(
ù¾
);

1687 ià(!
»t
)

1688 
	`æush_wÜk
(&
ù¾
->
d–‘e_wÜk
);

1689 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1690  
»t
;

1691 
	}
}

1693 
	$nvme_rdma_»move_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1695 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1696 
nvme_rdma_ù¾
, 
d–‘e_wÜk
);

1698 
	`__nvme_rdma_»move_ù¾
(
ù¾
, 
çl£
);

1699 
	}
}

1701 
	$nvme_rdma_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1703 
nvme_rdma_ù¾
 *
ù¾
 =

1704 
	`cÚš”_of
(
wÜk
, 
nvme_rdma_ù¾
, 
ù¾
.
»£t_wÜk
);

1705 
»t
;

1706 
boŞ
 
chªged
;

1708 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

1709 
	`nvme_rdma_shutdown_ù¾
(
ù¾
);

1711 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
);

1712 ià(
»t
) {

1714 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_rdma_»move_ù¾_wÜk
);

1715 
d–_d—d_ù¾
;

1718 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1719 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

1720 ià(
»t
)

1721 
d–_d—d_ù¾
;

1723 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

1724 ià(
»t
)

1725 
d–_d—d_ù¾
;

1727 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

1728 ià(
»t
)

1729 
d–_d—d_ù¾
;

1731 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
,

1732 
ù¾
->ù¾.
queue_couÁ
 - 1);

1735 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1736 
	`WARN_ON_ONCE
(!
chªged
);

1738 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

1742 
d–_d—d_ù¾
:

1744 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
, "Removing‡fter„eset failure\n");

1745 
	`WARN_ON
(!
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
d–‘e_wÜk
));

1746 
	}
}

1748 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_rdma_ù¾_İs
 = {

1749 .
Çme
 = "rdma",

1750 .
	gmoduË
 = 
THIS_MODULE
,

1751 .
	gæags
 = 
NVME_F_FABRICS
,

1752 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

1753 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

1754 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

1755 .
	gä“_ù¾
 = 
nvme_rdma_ä“_ù¾
,

1756 .
	gsubm™_async_ev’t
 = 
nvme_rdma_subm™_async_ev’t
,

1757 .
	gd–‘e_ù¾
 = 
nvme_rdma_d–_ù¾
,

1758 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

1761 
	$nvme_rdma_ü—‹_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

1763 
»t
;

1765 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

1766 ià(
»t
)

1767  
»t
;

1773 
»t
 = -
EINVAL
;

1774 ià(!
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
))

1775 
out_ä“_io_queues
;

1777 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

1778 
ù¾
->
g_£t
.
İs
 = &
nvme_rdma_mq_İs
;

1779 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
İts
->
queue_size
;

1780 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

1781 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1782 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

1783 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_rdma_»que¡
) +

1784 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

1785 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

1786 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->ù¾.
queue_couÁ
 - 1;

1787 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

1789 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

1790 ià(
»t
)

1791 
out_put_dev
;

1792 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

1794 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

1795 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

1796 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

1797 
out_ä“_g_£t
;

1800 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

1801 ià(
»t
)

1802 
out_ş—nup_cÚÃù_q
;

1806 
out_ş—nup_cÚÃù_q
:

1807 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1808 
out_ä“_g_£t
:

1809 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1810 
out_put_dev
:

1811 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1812 
out_ä“_io_queues
:

1813 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

1814  
»t
;

1815 
	}
}

1817 
nvme_ù¾
 *
	$nvme_rdma_ü—‹_ù¾
(
deviû
 *
dev
,

1818 
nvmf_ù¾_İtiÚs
 *
İts
)

1820 
nvme_rdma_ù¾
 *
ù¾
;

1821 
»t
;

1822 
boŞ
 
chªged
;

1823 *
pÜt
;

1825 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

1826 ià(!
ù¾
)

1827  
	`ERR_PTR
(-
ENOMEM
);

1828 
ù¾
->ù¾.
İts
 = opts;

1829 
	`INIT_LIST_HEAD
(&
ù¾
->
li¡
);

1831 ià(
İts
->
mask
 & 
NVMF_OPT_TRSVCID
)

1832 
pÜt
 = 
İts
->
Œsvcid
;

1834 
pÜt
 = 
	`__¡ršgify
(
NVME_RDMA_IP_PORT
);

1836 
»t
 = 
	`š‘_±Ú_w™h_scİe
(&
š™_Ãt
, 
AF_UNSPEC
,

1837 
İts
->
Œaddr
, 
pÜt
, &
ù¾
->
addr
);

1838 ià(
»t
) {

1839 
	`´_”r
("m®fÜmed‡dd»s ·s£d: %s:%s\n", 
İts
->
Œaddr
, 
pÜt
);

1840 
out_ä“_ù¾
;

1843 ià(
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

1844 
»t
 = 
	`š‘_±Ú_w™h_scİe
(&
š™_Ãt
, 
AF_UNSPEC
,

1845 
İts
->
ho¡_Œaddr
, 
NULL
, &
ù¾
->
¤c_addr
);

1846 ià(
»t
) {

1847 
	`´_”r
("malformed src‡ddress…assed: %s\n",

1848 
İts
->
ho¡_Œaddr
);

1849 
out_ä“_ù¾
;

1853 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_rdma_ù¾_İs
,

1855 ià(
»t
)

1856 
out_ä“_ù¾
;

1858 
	`INIT_DELAYED_WORK
(&
ù¾
->
»cÚÃù_wÜk
,

1859 
nvme_rdma_»cÚÃù_ù¾_wÜk
);

1860 
	`INIT_WORK
(&
ù¾
->
”r_wÜk
, 
nvme_rdma_”rÜ_»cov”y_wÜk
);

1861 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_rdma_d–_ù¾_wÜk
);

1862 
	`INIT_WORK
(&
ù¾
->ù¾.
»£t_wÜk
, 
nvme_rdma_»£t_ù¾_wÜk
);

1864 
ù¾
->ù¾.
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

1865 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

1866 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

1868 
»t
 = -
ENOMEM
;

1869 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->ù¾.
queue_couÁ
, (*ctrl->queues),

1870 
GFP_KERNEL
);

1871 ià(!
ù¾
->
queues
)

1872 
out_unš™_ù¾
;

1874 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
);

1875 ià(
»t
)

1876 
out_kä“_queues
;

1879 ià(
ù¾
->ù¾.
icdoff
) {

1880 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff is‚ot supported!\n");

1881 
»t
 = -
EINVAL
;

1882 
out_»move_admš_queue
;

1886 ià(!(
ù¾
->ù¾.
sgls
 & (1 << 20))) {

1887 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "Mandatory keyed sgls‡re‚ot support\n");

1888 
»t
 = -
EINVAL
;

1889 
out_»move_admš_queue
;

1892 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

1894 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1896 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

1897 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

1900 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
sqsize
 + 1) {

1902 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1904 
İts
->
queue_size
, 
ù¾
->ù¾.
sqsize
 + 1);

1905 
İts
->
queue_size
 = 
ù¾
->ù¾.
sqsize
 + 1;

1908 ià(
İts
->
Ä_io_queues
) {

1909 
»t
 = 
	`nvme_rdma_ü—‹_io_queues
(
ù¾
);

1910 ià(
»t
)

1911 
out_»move_admš_queue
;

1914 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1915 
	`WARN_ON_ONCE
(!
chªged
);

1917 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "new ctrl: NQN \"%s\",‡ddr %pISpcs\n",

1918 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

1920 
	`k»f_g‘
(&
ù¾
->ù¾.
k»f
);

1922 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

1923 
	`li¡_add_
(&
ù¾
->
li¡
, &
nvme_rdma_ù¾_li¡
);

1924 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

1926 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

1928  &
ù¾
->ctrl;

1930 
out_»move_admš_queue
:

1931 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
);

1932 
out_kä“_queues
:

1933 
	`kä“
(
ù¾
->
queues
);

1934 
out_unš™_ù¾
:

1935 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1936 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1937 ià(
»t
 > 0)

1938 
»t
 = -
EIO
;

1939  
	`ERR_PTR
(
»t
);

1940 
out_ä“_ù¾
:

1941 
	`kä“
(
ù¾
);

1942  
	`ERR_PTR
(
»t
);

1943 
	}
}

1945 
nvmf_Œª¥Üt_İs
 
	gnvme_rdma_Œª¥Üt
 = {

1946 .
Çme
 = "rdma",

1947 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
,

1948 .
	g®lowed_İts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
 |

1949 
NVMF_OPT_HOST_TRADDR
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

1950 .
	gü—‹_ù¾
 = 
nvme_rdma_ü—‹_ù¾
,

1953 
	$nvme_rdma_add_Úe
(
ib_deviû
 *ib_device)

1955 
	}
}

1957 
	$nvme_rdma_»move_Úe
(
ib_deviû
 *ib_deviû, *
ş›Á_d©a
)

1959 
nvme_rdma_ù¾
 *
ù¾
;

1962 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

1963 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

1964 ià(
ù¾
->
deviû
->
dev
 !ğ
ib_deviû
)

1966 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

1968 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

1969 
	`__nvme_rdma_d–_ù¾
(
ù¾
);

1971 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

1973 
	`æush_wÜkqueue
(
nvme_wq
);

1974 
	}
}

1976 
ib_ş›Á
 
	gnvme_rdma_ib_ş›Á
 = {

1977 .
Çme
 = "nvme_rdma",

1978 .
	gadd
 = 
nvme_rdma_add_Úe
,

1979 .
	g»move
 = 
nvme_rdma_»move_Úe


1982 
__š™
 
	$nvme_rdma_š™_moduË
()

1984 
»t
;

1986 
»t
 = 
	`ib_»gi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

1987 ià(
»t
)

1988  
»t
;

1990 
»t
 = 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

1991 ià(
»t
)

1992 
”r_uÄeg_ş›Á
;

1996 
”r_uÄeg_ş›Á
:

1997 
	`ib_uÄegi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

1998  
»t
;

1999 
	}
}

2001 
__ex™
 
	$nvme_rdma_ş—nup_moduË
()

2003 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2004 
	`ib_uÄegi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2005 
	}
}

2007 
moduË_š™
(
nvme_rdma_š™_moduË
);

2008 
moduË_ex™
(
nvme_rdma_ş—nup_moduË
);

2010 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/´.h
>

26 
	~<lšux/±¿û.h
>

27 
	~"lšux_nvme_ioùl.h
"

28 
	~<lšux/t10-pi.h
>

29 
	~<lšux/pm_qos.h
>

30 
	~<asm/uÇligÃd.h
>

32 
	~"nvme.h
"

33 
	~"çbrics.h
"

36 
	~<lšux/fe.h
>

37 
	~<lšux/fdbË.h
>

38 
	~<lšux/ev’tfd.h
>

39 
	~<lšux/k»f.h
>

40 
	~<lšux/bio.h
>

41 
	~<lšux/ä“z”.h
>

42 
	~<lšux/wa™.h
>

43 
	~<lšux/kth»ad.h
>

44 
	~<lšux/sk_io_accouÁšg_İs.h
>

49 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

51 
	gadmš_timeout
 = 60;

52 
moduË_·¿m
(
admš_timeout
, 
ušt
, 0644);

53 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

54 
EXPORT_SYMBOL_GPL
(
admš_timeout
);

56 
	gnvme_io_timeout
 = 30;

57 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
ušt
, 0644);

58 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

59 
EXPORT_SYMBOL_GPL
(
nvme_io_timeout
);

61 
	gshutdown_timeout
 = 5;

62 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

63 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

65 
u8
 
	gnvme_max_»Œ›s
 = 5;

66 
moduË_·¿m_Çmed
(
max_»Œ›s
, 
nvme_max_»Œ›s
, 
by‹
, 0644);

67 
MODULE_PARM_DESC
(
max_»Œ›s
, "max‚umber of„etries‡ command may have");

69 
	gdeçuÉ_ps_max_Ï‹ncy_us
 = 100000;

70 
moduË_·¿m
(
deçuÉ_ps_max_Ï‹ncy_us
, 
ulÚg
, 0644);

71 
MODULE_PARM_DESC
(
deçuÉ_ps_max_Ï‹ncy_us
,

74 
boŞ
 
	gfÜû_­¡
;

75 
moduË_·¿m
(
fÜû_­¡
, 
boŞ
, 0644);

76 
MODULE_PARM_DESC
(
fÜû_­¡
, "allow APST for‚ewlyƒnumerated devicesƒven if quirked off");

78 
boŞ
 
	g¡»ams
;

79 
moduË_·¿m
(
¡»ams
, 
boŞ
, 0644);

80 
MODULE_PARM_DESC
(
¡»ams
, "turn on support for Streams write directives");

82 
wÜkqueue_¡ruù
 *
	gnvme_wq
;

83 
EXPORT_SYMBOL_GPL
(
nvme_wq
);

85 
DEFINE_IDA
(
nvme_subsy¡ems_ida
);

86 
LIST_HEAD
(
nvme_subsy¡ems
);

87 
DEFINE_MUTEX
(
nvme_subsy¡ems_lock
);

89 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

90 
dev_t
 
	gnvme_chr_devt
;

91 
şass
 *
	gnvme_şass
;

92 
şass
 *
	gnvme_subsys_şass
;

94 
nvme_ns_»move
(
nvme_ns
 *
ns
);

95 
nvme_»v®id©e_disk
(
g’disk
 *
disk
);

103 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

104 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

105 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

106 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

108 
__u32
 
	gaio_cÚ‹xt_id
;

110 
	#AIOCTX_MAX
 1024

	)

111 
	#AIOCB_MAX
 (1024*64)

	)

113 
__u64
 
	gdebug_com¶‘ed
 =0;

114 
	gdebug_out¡ªdšg
 =0;

116 
	snvme_kaioùx


118 
nvme_aioùx
 
	muùx
;

119 
ev’tfd_ùx
 *
	mev’tùx
;

120 
li¡_h—d
 
	mkaiocb_li¡
;

121 
¥šlock_t
 
	mkaioùx_¥šlock
;

122 
k»f
 
	m»f
;

125 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

126 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

128 
	saio_u£r_ùx
 {

129 
	mÃÁs
;

130 
	mËn
;

131 
·ge
 ** 
	m·ges
;

132 
sÿ‰”li¡
 *
	msg
;

133 
	md©a
[1];

136 
	snvme_kaiocb


138 
li¡_h—d
 
	maiocb_li¡
;

139 
nvme_aiÛv’t
 
	mev’t
;

140 
	mİcode
;

141 
nvme_commªd
 
	mcmd
;

142 
g’disk
 *
	mdisk
;

143 
	m¡¬t_time
;

144 
sÿ‰”li¡
 
	mm‘a_sg
;

145 
boŞ
 
	mÃed_to_cİy
;

146 
boŞ
 
	mu£_m‘a
;

147 *
	mkv_d©a
;

148 *
	mm‘a
;

149 
aio_u£r_ùx
 *
	mu£r_ùx
;

150 
aio_u£r_ùx
 *
	mk”Ãl_ùx
;

151 
»que¡
 *
	m»q
;

155 
	saio_wÜk”_ùx
{

156 
	mıu
;

157 
¥šlock_t
 
	mkaiocb_¥šlock
;

158 
li¡_h—d
 
	mkaiocb_li¡
;

159 
wa™_queue_h—d_t
 
	maio_wa™queue
;

163 
aio_wÜk”_ùx
 * 
__³rıu
 
	gaio_w_ùx
;

165 
sk_¡ruù
 ** 
__³rıu
 
	gaio_wÜk”
;

169 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

171 
nvme_kaiocb
 *
tmpcb
;

172 
li¡_h—d
 *
pos
, *
q
;

173 
æags
;

174 ià(
ùx
) {

175 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

176 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

177 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

178 
	`li¡_d–
(
pos
);

179 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

181 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

182 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

183 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

185 
	}
}

187 
	$ş—nup_kaioùx
(
k»f
 *kref) {

188 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

189 
	`»move_kaioùx
(
ùx
);

190 
	}
}

192 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

193 
	`k»f_g‘
(&
ùx
->
»f
);

194 
	}
}

196 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

197 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

198 
	}
}

203 
	$de¡roy_aio_mempoŞ
()

205 
i
 = 0;

206 ià(
g_kaioùx_tb
) {

207 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

208 ià(
g_kaioùx_tb
[
i
]) {

209 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

210 
g_kaioùx_tb
[
i
] = 
NULL
;

213 
	`kä“
(
g_kaioùx_tb
);

214 
g_kaioùx_tb
 = 
NULL
;

216 ià(
kaiocb_mempoŞ
)

217 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

218 ià(
kaioùx_mempoŞ
)

219 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

220 ià(
kaioùx_ÿch•
)

221 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

222 ià(
kaiocb_ÿch•
)

223 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

224 
	}
}

229 
	$aio_£rviû_š™
()

231 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

232 ià(!
g_kaioùx_tb
)

233 
ç
;

234 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

237 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

238 ià(!
kaioùx_ÿch•
)

239 
ç
;

241 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

242 ià(!
kaiocb_ÿch•
)

243 
ç
;

245 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

246 ià(!
kaiocb_mempoŞ
)

247 
ç
;

249 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

250 ià(!
kaioùx_mempoŞ
)

251 
ç
;

255 
aio_cÚ‹xt_id
 = 1;

256 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

257 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

260 
ç
:

261 
	`de¡roy_aio_mempoŞ
();

262  -
ENOMEM
;

263 
	}
}

268 
	$aio_£rviû_ex™
()

270 
	`de¡roy_aio_mempoŞ
();

271 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

273 
	}
}

275 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

276 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

279 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

280 ià(
tmp
è
	`»f_kaioùx
(tmp);

282  
tmp
;

283 
	}
}

289 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

291 
nvme_kaioùx
 *
tmp
;

292 
æags
;

293 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

294 ià(
tmp
) {

295 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

296 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

297 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

298 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

300 
	`´_”r
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

302 
	`d”ef_kaioùx
(
tmp
);

306 
	`´_”r
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

311 
	}
}

317 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

319 
nvme_kaioùx
 
ùx
;

320 
æags
;

321 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

322  -
EFAULT
;

324 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

325 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

326 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

327 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

329 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

331 
	}
}

337 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

339 
nvme_kaioùx
 *
ùx
;

340 
fd
 
efe
;

341 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

342 
æags
;

343 
»t
 = 0;

344 
i
 = 0;

345 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

346  -
EACCES
;

348 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

349 ià(!
ùx
)

350  -
ENOMEM
;

352 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

353  -
EFAULT
;

355 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

356 ià(!
efe
.
fe
) {

357 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

358 
»t
 = -
EBADF
;

359 
ex™
;

362 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

363 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

364 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

365 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

366 
put_efe
;

369 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

370 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

371 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

372 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

373 
aio_cÚ‹xt_id
 = 
i
;

377 ià(
i
 >ğ
AIOCTX_MAX
) {

378 
	`´_”r
("nvme_set_aioctx:oo many‡ioctx open.\n");

379 
»t
 = -
EMFILE
;

380 
put_ev’t_fd
;

383 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

384 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

385 
aio_cÚ‹xt_id
 = 0;

386 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

387 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

388 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

389 
	`k»f_š™
(&
ùx
->
»f
);

390 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

391 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

393 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

395 
	`´_”r
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

396 
»t
 = -
EINVAL
;

397 
ş—nup
;

399 
ev’tfd_ùx
 = 
NULL
;

400 
debug_out¡ªdšg
 = 0;

401 
debug_com¶‘ed
 = 0;

402 
	`fdput
(
efe
);

404 
ş—nup
:

405 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

406 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

407 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

408 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

409 
put_ev’t_fd
:

410 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

411 
put_efe
:

412 
	`fdput
(
efe
);

413 
ex™
:

414  
»t
;

415 
	}
}

419 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

420 
nvme_kaiocb
 *
»q
;

421 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

422 ià(!
»q
)  0;

424 
	`mem£t
(
»q
, 0, (*req));

426 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

428 
»q
->
ev’t
.
»qid
 =„eqid;

430  
»q
;

431 
	}
}

435 
	$nvme_g‘_iÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

437 
li¡_h—d
 *
pos
, *
q
;

438 
nvme_kaiocb
 *
tmp
;

439 
nvme_kaioùx
 *
tmp_ùx
;

440 
æags
;

441 
	`LIST_HEAD
(
tmp_h—d
);

442 
__u16
 
couÁ
 =0;

443 
__u16
 
Ä
 = 0;

444 
__u32
 
ùxid
 = 0;

446 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

447  -
EACCES
;

449 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

451 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

453 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

455 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

456 ià(
tmp_ùx
) {

457 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

458 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

459 
	`li¡_d–_š™
(
pos
);

460 
	`li¡_add
(
pos
, &
tmp_h—d
);

461 
couÁ
++;

462 ià(
Ä
 =ğ
couÁ
) ;

464 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

465 
	`d”ef_kaioùx
(
tmp_ùx
);

466 
couÁ
 = 0;

467 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

468 
	`li¡_d–
(
pos
);

469 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

470 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

471 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

472 
couÁ
++;

475 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

478 
	}
}

480 
	$kv_com¶‘e_aio_â
(
nvme_kaiocb
 *
cmdšfo
) {

481 
»que¡
 *
»q
 = 
cmdšfo
->req;

482 
i
 = 0;

483 ià(
cmdšfo
->
Ãed_to_cİy
) {

484 ià((
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è&& !cmdšfo->
ev’t
.
¡©us
) ||

485 (
	`is_kv_™”_»ad_cmd
(
cmdšfo
->
İcode
è&& (!cmdšfo->
ev’t
.
¡©us
 || ((cmdinfo->event.status & 0x00ff) == 0x0093)))) {

490 *
d©a
 = 
cmdšfo
->
kv_d©a
;

491 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

493 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

494 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

496 
i
 = 0; i < 
cmdšfo
->
k”Ãl_ùx
->
ÃÁs
; i++) {

497 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
k”Ãl_ùx
->
sg
[
i
]));

500 ià(
cmdšfo
->
u£r_ùx
) {

501 ià(
	`is_kv_¡Üe_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_­³nd_cmd
(cmdinfo->opcode)) {

502 
	`g’”ic_’d_io_acù
(
»q
->
q
, 
WRITE
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

504 
	`g’”ic_’d_io_acù
(
»q
->
q
, 
READ
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

506 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++) {

507 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

510 
	`blk_mq_ä“_»que¡
(
»q
);

512 ià(
cmdšfo
->
u£_m‘a
) {

513 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

516 ià(
cmdšfo
->
Ãed_to_cİy
) {

517 
	`kä“
(
cmdšfo
->
k”Ãl_ùx
);

518 
	`kä“
(
cmdšfo
->
kv_d©a
);

520 ià(
cmdšfo
->
u£r_ùx
è
	`kä“
(cmdinfo->user_ctx);

521 ià(
cmdšfo
->
m‘a
è
	`kä“
(cmdinfo->meta);

524 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

525 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

527 
	}
}

530 
	$wake_up_aio_wÜk”
(
aio_wÜk”_ùx
 *
aio_ùx
) {

531 
	`wake_up
(&
aio_ùx
->
aio_wa™queue
);

532 
	}
}

534 
	$š£¹_aiocb_to_wÜk”
(
nvme_kaiocb
 *
aiocb
) {

535 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

536 
æags
;

537 
ıu
 = 
	`smp_´oûssÜ_id
();

538 
	`INIT_LIST_HEAD
(&
aiocb
->
aiocb_li¡
);

540 
	`´_”r
("š£¹‡iocb(%pètØaio_wÜk”(%d)!\n", 
aiocb
, 
ıu
);

542 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
ıu
);

543 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

544 
	`li¡_add_
(&
aiocb
->
aiocb_li¡
, &
ùx
->
kaiocb_li¡
);

545 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

546 
	`wake_up_aio_wÜk”
(
ùx
);

548 
	}
}

550 
	$kv_async_com¶‘iÚ
(
»que¡
 *
»q
, 
blk_¡©us_t
 
¡©us
){

551 
nvme_kaiocb
 *
aiocb
 = 
»q
->
’d_io_d©a
;

553 
	`´_”r
("com¶™iÚ hªdË¸fÜ‡iocb(%p)!\n", 
aiocb
);

555 
aiocb
->
»q
 =„eq;

556 
aiocb
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

557 
aiocb
->
ev’t
.
¡©us
 = 
	`Ë16_to_ıu
(
	`nvme_»q
(
»q
)->status);

559 
	`´_”r
("»suÉ‡iocb %°¡©u %x„esuÉ %x\n", 
aiocb
,‡iocb->
ev’t
.
¡©us
,‡iocb->ev’t.
»suÉ
);

561 
	`š£¹_aiocb_to_wÜk”
(
aiocb
);

563 
	}
}

565 
	$kvaio_³rıu_wÜk”_â
(*
¬g
) {

566 
aio_wÜk”_ùx
 *
ùx
 = (aio_wÜk”_ùx *)
¬g
;

567 
li¡_h—d
 *
pos
, *
Ãxt
;

568 
æags
;

569 
	`LIST_HEAD
(
tmp_li¡
);

570 
	`´_”r
("¡¬ˆaiØwÜk” %u\n", 
ùx
->
ıu
);

571 !
	`kth»ad_should_¡İ
(è|| !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

572 ià(
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

573 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
ùx
->
aio_wa™queue
,

574 !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
), 
HZ
/10);

577 
	`INIT_LIST_HEAD
(&
tmp_li¡
);

578 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

579 
	`li¡_¥liû
(&
ùx
->
kaiocb_li¡
, &
tmp_li¡
);

580 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

581 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

582 ià(!
	`li¡_em±y
(&
tmp_li¡
)) {

583 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, &
tmp_li¡
) {

584 
nvme_kaiocb
 *
aiocb
 = 
	`li¡_’Œy
(
pos
, nvme_kaiocb, 
aiocb_li¡
);

585 
	`li¡_d–_š™
(
pos
);

587 
	`´_”r
("´oûs com¶‘iÚ %p\n",
aiocb
);

589 
	`kv_com¶‘e_aio_â
(
aiocb
);

594 
	}
}

596 
	$aio_wÜk”_š™
() {

597 
sk_¡ruù
 **
p
 = 
NULL
;

598 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

599 
i
 = 0;

601 
aio_wÜk”
 = 
	`®loc_³rıu
(
sk_¡ruù
 *);

602 ià(!
aio_wÜk”
) {

603 
	`´_”r
("failo‡lloc…ercpu workerask_struct!\n");

604  -
ENOMEM
;

606 
aio_w_ùx
 = 
	`®loc_³rıu
(
aio_wÜk”_ùx
);

607 ià(!
aio_w_ùx
) {

608 
	`´_”r
("failo‡lloc…ercpu‡io context!\n");

609 
out_ä“
;

612 
	`fÜ_—ch_Úlše_ıu
(
i
) {

613 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
i
);

614 
ùx
->
ıu
 = 
i
;

615 
	`¥š_lock_š™
(&
ùx
->
kaiocb_¥šlock
);

616 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

617 
	`š™_wa™queue_h—d
(&
ùx
->
aio_wa™queue
);

618 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

619 *
p
 = 
	`kth»ad_ü—‹_Ú_node
(
kvaio_³rıu_wÜk”_â
, 
ùx
, 
	`ıu_to_node
(
i
), "aio_completion_worker/%u", i);

620 ià(!(*
p
))

621 
»£t_±h»ad
;

622 
	`kth»ad_bšd
(*
p
, 
i
);

623 
	`wake_up_´oûss
(*
p
);

627 
»£t_±h»ad
:

628 
	`fÜ_—ch_Úlše_ıu
(
i
) {

629 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

630 ià(*
p
è
	`kth»ad_¡İ
(*p);

632 
out_ä“
:

633 ià(
aio_wÜk”
)

634 
	`ä“_³rıu
(
aio_wÜk”
);

635  -
ENOMEM
;

636 
	}
}

638 
	$aio_wÜk”_ex™
() {

639 
sk_¡ruù
 **
p
 = 
NULL
;

640 
i
 = 0;

641 
	`fÜ_—ch_Úlše_ıu
(
i
) {

642 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

643 ià(*
p
è
	`kth»ad_¡İ
(*p);

645 
	`ä“_³rıu
(
aio_wÜk”
);

646 
	`ä“_³rıu
(
aio_w_ùx
);

648 
	}
}

651 
__Ë32
 
	$nvme_g‘_log_dw10
(
u8
 
lid
, 
size_t
 
size
)

653  
	`ıu_to_Ë32
((((
size
 / 4è- 1è<< 16è| 
lid
);

654 
	}
}

656 
	$nvme_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

658 ià(!
	`nvme_chªge_ù¾_¡©e
(
ù¾
, 
NVME_CTRL_RESETTING
))

659  -
EBUSY
;

660 ià(!
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
»£t_wÜk
))

661  -
EBUSY
;

663 
	}
}

664 
EXPORT_SYMBOL_GPL
(
nvme_»£t_ù¾
);

666 
	$nvme_»£t_ù¾_sync
(
nvme_ù¾
 *
ù¾
)

668 
»t
;

670 
»t
 = 
	`nvme_»£t_ù¾
(
ù¾
);

671 ià(!
»t
)

672 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

673  
»t
;

674 
	}
}

676 
	$nvme_d–‘e_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

678 
nvme_ù¾
 *
ù¾
 =

679 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
d–‘e_wÜk
);

681 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

682 
	`nvme_¡İ_ù¾
(
ù¾
);

683 
	`nvme_»move_Çme¥aûs
(
ù¾
);

684 
ù¾
->
İs
->
	`d–‘e_ù¾
(ctrl);

685 
	`nvme_unš™_ù¾
(
ù¾
);

686 
	`nvme_put_ù¾
(
ù¾
);

687 
	}
}

689 
	$nvme_d–‘e_ù¾
(
nvme_ù¾
 *
ù¾
)

691 ià(!
	`nvme_chªge_ù¾_¡©e
(
ù¾
, 
NVME_CTRL_DELETING
))

692  -
EBUSY
;

693 ià(!
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
d–‘e_wÜk
))

694  -
EBUSY
;

696 
	}
}

697 
EXPORT_SYMBOL_GPL
(
nvme_d–‘e_ù¾
);

699 
	$nvme_d–‘e_ù¾_sync
(
nvme_ù¾
 *
ù¾
)

701 
»t
 = 0;

707 
	`nvme_g‘_ù¾
(
ù¾
);

708 
»t
 = 
	`nvme_d–‘e_ù¾
(
ù¾
);

709 ià(!
»t
)

710 
	`æush_wÜk
(&
ù¾
->
d–‘e_wÜk
);

711 
	`nvme_put_ù¾
(
ù¾
);

712  
»t
;

713 
	}
}

714 
EXPORT_SYMBOL_GPL
(
nvme_d–‘e_ù¾_sync
);

716 
šlše
 
boŞ
 
	$nvme_ns_has_pi
(
nvme_ns
 *
ns
)

718  
ns
->
pi_ty³
 &&‚s->
ms
 =ğ(
t10_pi_tu¶e
);

719 
	}
}

721 
blk_¡©us_t
 
	$nvme_”rÜ_¡©us
(
»que¡
 *
»q
)

723 
	`nvme_»q
(
»q
)->
¡©us
 & 0x7ff) {

724 
NVME_SC_SUCCESS
:

725  
BLK_STS_OK
;

726 
NVME_SC_CAP_EXCEEDED
:

727  
BLK_STS_NOSPC
;

728 
NVME_SC_ONCS_NOT_SUPPORTED
:

729  
BLK_STS_NOTSUPP
;

730 
NVME_SC_WRITE_FAULT
:

731 
NVME_SC_READ_ERROR
:

732 
NVME_SC_UNWRITTEN_BLOCK
:

733 
NVME_SC_ACCESS_DENIED
:

734 
NVME_SC_READ_ONLY
:

735  
BLK_STS_MEDIUM
;

736 
NVME_SC_GUARD_CHECK
:

737 
NVME_SC_APPTAG_CHECK
:

738 
NVME_SC_REFTAG_CHECK
:

739 
NVME_SC_INVALID_PI
:

740  
BLK_STS_PROTECTION
;

741 
NVME_SC_RESERVATION_CONFLICT
:

742  
BLK_STS_NEXUS
;

744  
BLK_STS_IOERR
;

746 
	}
}

748 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
)

750 ià(
	`blk_nÜ‘ry_»que¡
(
»q
))

751  
çl£
;

752 ià(
	`nvme_»q
(
»q
)->
¡©us
 & 
NVME_SC_DNR
)

753  
çl£
;

754 ià(
	`nvme_»q
(
»q
)->
»Œ›s
 >ğ
nvme_max_»Œ›s
)

755  
çl£
;

756  
Œue
;

757 
	}
}

759 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

761 ià(
	`uÆik–y
(
	`nvme_»q
(
»q
)->
¡©us
 && 
	`nvme_»q_Ãeds_»Œy
(req))) {

762 ià(
	`nvme_»q_Ãeds_çov”
(
»q
)) {

763 
	`nvme_çov”_»q
(
»q
);

767 ià(!
	`blk_queue_dyšg
(
»q
->
q
)) {

768 
	`nvme_»q
(
»q
)->
»Œ›s
++;

769 
	`blk_mq_»queue_»que¡
(
»q
, 
Œue
);

774 
	`blk_mq_’d_»que¡
(
»q
, 
	`nvme_”rÜ_¡©us
(req));

775 
	}
}

776 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_rq
);

778 
	$nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

780 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

783 
	`dev_dbg_¿‹lim™ed
(((
nvme_ù¾
 *è
d©a
)->
deviû
,

784 "CªûÎšg I/O %d", 
»q
->
g
);

786 
	`nvme_»q
(
»q
)->
¡©us
 = 
NVME_SC_ABORT_REQ
;

787 
	`blk_mq_com¶‘e_»que¡
(
»q
);

789 
	}
}

790 
EXPORT_SYMBOL_GPL
(
nvme_ÿnûl_»que¡
);

792 
boŞ
 
	$nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

793 
nvme_ù¾_¡©e
 
Ãw_¡©e
)

795 
nvme_ù¾_¡©e
 
Şd_¡©e
;

796 
æags
;

797 
boŞ
 
chªged
 = 
çl£
;

799 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

801 
Şd_¡©e
 = 
ù¾
->
¡©e
;

802 
Ãw_¡©e
) {

803 
NVME_CTRL_LIVE
:

804 
Şd_¡©e
) {

805 
NVME_CTRL_NEW
:

806 
NVME_CTRL_RESETTING
:

807 
NVME_CTRL_RECONNECTING
:

808 
chªged
 = 
Œue
;

814 
NVME_CTRL_RESETTING
:

815 
Şd_¡©e
) {

816 
NVME_CTRL_NEW
:

817 
NVME_CTRL_LIVE
:

818 
chªged
 = 
Œue
;

824 
NVME_CTRL_RECONNECTING
:

825 
Şd_¡©e
) {

826 
NVME_CTRL_LIVE
:

827 
NVME_CTRL_RESETTING
:

828 
chªged
 = 
Œue
;

834 
NVME_CTRL_DELETING
:

835 
Şd_¡©e
) {

836 
NVME_CTRL_LIVE
:

837 
NVME_CTRL_RESETTING
:

838 
NVME_CTRL_RECONNECTING
:

839 
chªged
 = 
Œue
;

845 
NVME_CTRL_DEAD
:

846 
Şd_¡©e
) {

847 
NVME_CTRL_DELETING
:

848 
chªged
 = 
Œue
;

858 ià(
chªged
)

859 
ù¾
->
¡©e
 = 
Ãw_¡©e
;

861 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

862 ià(
chªged
 && 
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
)

863 
	`nvme_kick_»queue_li¡s
(
ù¾
);

864  
chªged
;

865 
	}
}

866 
EXPORT_SYMBOL_GPL
(
nvme_chªge_ù¾_¡©e
);

868 
	$nvme_ä“_ns_h—d
(
k»f
 *
»f
)

870 
nvme_ns_h—d
 *
h—d
 =

871 
	`cÚš”_of
(
»f
, 
nvme_ns_h—d
,„ef);

873 
	`nvme_m·th_»move_disk
(
h—d
);

874 
	`ida_sim¶e_»move
(&
h—d
->
subsys
->
ns_ida
, h—d->
š¡ªû
);

875 
	`li¡_d–_š™
(&
h—d
->
’Œy
);

876 
	`ş—nup_¤cu_¡ruù
(&
h—d
->
¤cu
);

877 
	`kä“
(
h—d
);

878 
	}
}

880 
	$nvme_put_ns_h—d
(
nvme_ns_h—d
 *
h—d
)

882 
	`k»f_put
(&
h—d
->
»f
, 
nvme_ä“_ns_h—d
);

883 
	}
}

885 
	$nvme_ä“_ns
(
k»f
 *kref)

887 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

889 ià(
ns
->
ndev
)

890 
	`nvme_nvm_uÄegi¡”
(
ns
);

892 
	`put_disk
(
ns
->
disk
);

893 
	`nvme_put_ns_h—d
(
ns
->
h—d
);

894 
	`nvme_put_ù¾
(
ns
->
ù¾
);

895 
	`kä“
(
ns
);

896 
	}
}

898 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

900 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

901 
	}
}

903 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

904 
nvme_commªd
 *
cmd
, 
blk_mq_»q_æags_t
 
æags
, 
qid
)

906 
İ
 = 
	`nvme_is_wr™e
(
cmd
è? 
REQ_OP_DRV_OUT
 : 
REQ_OP_DRV_IN
;

907 
»que¡
 *
»q
;

909 ià(
qid
 =ğ
NVME_QID_ANY
) {

910 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
İ
, 
æags
);

912 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
İ
, 
æags
,

913 
qid
 ? qid - 1 : 0);

915 ià(
	`IS_ERR
(
»q
))

916  
»q
;

918 
»q
->
cmd_æags
 |ğ
REQ_FAILFAST_DRIVER
;

919 
	`nvme_»q
(
»q
)->
cmd
 = cmd;

921  
»q
;

922 
	}
}

923 
EXPORT_SYMBOL_GPL
(
nvme_®loc_»que¡
);

925 
	$nvme_toggË_¡»ams
(
nvme_ù¾
 *
ù¾
, 
boŞ
 
’abË
)

927 
nvme_commªd
 
c
;

929 
	`mem£t
(&
c
, 0, (c));

931 
c
.
dœeùive
.
İcode
 = 
nvme_admš_dœeùive_£nd
;

932 
c
.
dœeùive
.
nsid
 = 
	`ıu_to_Ë32
(
NVME_NSID_ALL
);

933 
c
.
dœeùive
.
dİ”
 = 
NVME_DIR_SND_ID_OP_ENABLE
;

934 
c
.
dœeùive
.
dty³
 = 
NVME_DIR_IDENTIFY
;

935 
c
.
dœeùive
.
tdty³
 = 
NVME_DIR_STREAMS
;

936 
c
.
dœeùive
.
’dœ
 = 
’abË
 ? 
NVME_DIR_ENDIR
 : 0;

938  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

939 
	}
}

941 
	$nvme_di§bË_¡»ams
(
nvme_ù¾
 *
ù¾
)

943  
	`nvme_toggË_¡»ams
(
ù¾
, 
çl£
);

944 
	}
}

946 
	$nvme_’abË_¡»ams
(
nvme_ù¾
 *
ù¾
)

948  
	`nvme_toggË_¡»ams
(
ù¾
, 
Œue
);

949 
	}
}

951 
	$nvme_g‘_¡»am_·¿ms
(
nvme_ù¾
 *
ù¾
,

952 
¡»ams_dœeùive_·¿ms
 *
s
, 
u32
 
nsid
)

954 
nvme_commªd
 
c
;

956 
	`mem£t
(&
c
, 0, (c));

957 
	`mem£t
(
s
, 0, (*s));

959 
c
.
dœeùive
.
İcode
 = 
nvme_admš_dœeùive_»cv
;

960 
c
.
dœeùive
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

961 
c
.
dœeùive
.
numd
 = 
	`ıu_to_Ë32
(((*
s
) >> 2) - 1);

962 
c
.
dœeùive
.
dİ”
 = 
NVME_DIR_RCV_ST_OP_PARAM
;

963 
c
.
dœeùive
.
dty³
 = 
NVME_DIR_STREAMS
;

965  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
s
, (*s));

966 
	}
}

968 
	$nvme_cÚfigu»_dœeùives
(
nvme_ù¾
 *
ù¾
)

970 
¡»ams_dœeùive_·¿ms
 
s
;

971 
»t
;

973 ià(!(
ù¾
->
ßcs
 & 
NVME_CTRL_OACS_DIRECTIVES
))

975 ià(!
¡»ams
)

978 
»t
 = 
	`nvme_’abË_¡»ams
(
ù¾
);

979 ià(
»t
)

980  
»t
;

982 
»t
 = 
	`nvme_g‘_¡»am_·¿ms
(
ù¾
, &
s
, 
NVME_NSID_ALL
);

983 ià(
»t
)

984  
»t
;

986 
ù¾
->
ns§
 = 
	`Ë16_to_ıu
(
s
.nssa);

987 ià(
ù¾
->
ns§
 < 
BLK_MAX_WRITE_HINTS
 - 1) {

988 
	`dev_šfo
(
ù¾
->
deviû
, "too few streams (%u)‡vailable\n",

989 
ù¾
->
ns§
);

990 
	`nvme_di§bË_¡»ams
(
ù¾
);

994 
ù¾
->
Ä_¡»ams
 = 
	`mš_t
(, cŒl->
ns§
, 
BLK_MAX_WRITE_HINTS
 - 1);

995 
	`dev_šfo
(
ù¾
->
deviû
, "Usšg %u sŒ—ms\n", cŒl->
Ä_¡»ams
);

997 
	}
}

1003 
	$nvme_assign_wr™e_¡»am
(
nvme_ù¾
 *
ù¾
,

1004 
»que¡
 *
»q
, 
u16
 *
cÚŒŞ
,

1005 
u32
 *
dsmgmt
)

1007 
rw_hšt
 
¡»amid
 = 
»q
->
wr™e_hšt
;

1009 ià(
¡»amid
 =ğ
WRITE_LIFE_NOT_SET
 || sŒ—mid =ğ
WRITE_LIFE_NONE
)

1010 
¡»amid
 = 0;

1012 
¡»amid
--;

1013 ià(
	`WARN_ON_ONCE
(
¡»amid
 > 
ù¾
->
Ä_¡»ams
))

1016 *
cÚŒŞ
 |ğ
NVME_RW_DTYPE_STREAMS
;

1017 *
dsmgmt
 |ğ
¡»amid
 << 16;

1020 ià(
¡»amid
 < 
	`ARRAY_SIZE
(
»q
->
q
->
wr™e_hšts
))

1021 
»q
->
q
->
wr™e_hšts
[
¡»amid
] +ğ
	`blk_rq_by‹s
(req) >> 9;

1022 
	}
}

1024 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

1025 
nvme_commªd
 *
cmnd
)

1027 
	`mem£t
(
cmnd
, 0, (*cmnd));

1028 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1029 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

1030 
	}
}

1032 
blk_¡©us_t
 
	$nvme_£tup_disÿrd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

1033 
nvme_commªd
 *
cmnd
)

1035 
£gm’ts
 = 
	`blk_rq_Ä_disÿrd_£gm’ts
(
»q
), 
n
 = 0;

1036 
nvme_dsm_¿nge
 *
¿nge
;

1037 
bio
 *bio;

1039 
¿nge
 = 
	`km®loc_¬¿y
(
£gm’ts
, (*¿nge), 
GFP_ATOMIC
);

1040 ià(!
¿nge
)

1041  
BLK_STS_RESOURCE
;

1043 
	`__rq_fÜ_—ch_bio
(
bio
, 
»q
) {

1044 
u64
 
¦ba
 = 
	`nvme_block_Ä
(
ns
, 
bio
->
bi_™”
.
bi_£ùÜ
);

1045 
u32
 
Æb
 = 
bio
->
bi_™”
.
bi_size
 >> 
ns
->
lba_shiá
;

1047 
¿nge
[
n
].
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

1048 
¿nge
[
n
].
Æb
 = 
	`ıu_to_Ë32
(nlb);

1049 
¿nge
[
n
].
¦ba
 = 
	`ıu_to_Ë64
(slba);

1050 
n
++;

1053 ià(
	`WARN_ON_ONCE
(
n
 !ğ
£gm’ts
)) {

1054 
	`kä“
(
¿nge
);

1055  
BLK_STS_IOERR
;

1058 
	`mem£t
(
cmnd
, 0, (*cmnd));

1059 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

1060 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

1061 
cmnd
->
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
£gm’ts
 - 1);

1062 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

1064 
»q
->
¥ecŸl_vec
.
bv_·ge
 = 
	`vœt_to_·ge
(
¿nge
);

1065 
»q
->
¥ecŸl_vec
.
bv_off£t
 = 
	`off£t_š_·ge
(
¿nge
);

1066 
»q
->
¥ecŸl_vec
.
bv_Ën
 = (*
¿nge
è* 
£gm’ts
;

1067 
»q
->
rq_æags
 |ğ
RQF_SPECIAL_PAYLOAD
;

1069  
BLK_STS_OK
;

1070 
	}
}

1072 
šlše
 
blk_¡©us_t
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
,

1073 
»que¡
 *
»q
, 
nvme_commªd
 *
cmnd
)

1075 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1076 
u16
 
cÚŒŞ
 = 0;

1077 
u32
 
dsmgmt
 = 0;

1079 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

1080 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1081 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

1082 
cÚŒŞ
 |ğ
NVME_RW_LR
;

1084 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

1085 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

1087 
	`mem£t
(
cmnd
, 0, (*cmnd));

1088 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1089 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

1090 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

1091 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

1093 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_WRITE
 && 
ù¾
->
Ä_¡»ams
)

1094 
	`nvme_assign_wr™e_¡»am
(
ù¾
, 
»q
, &
cÚŒŞ
, &
dsmgmt
);

1096 ià(
ns
->
ms
) {

1103 ià(!
	`blk_š‹gr™y_rq
(
»q
)) {

1104 ià(
	`WARN_ON_ONCE
(!
	`nvme_ns_has_pi
(
ns
)))

1105  
BLK_STS_NOTSUPP
;

1106 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

1109 
ns
->
pi_ty³
) {

1110 
NVME_NS_DPS_PI_TYPE3
:

1111 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
;

1113 
NVME_NS_DPS_PI_TYPE1
:

1114 
NVME_NS_DPS_PI_TYPE2
:

1115 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
 |

1116 
NVME_RW_PRINFO_PRCHK_REF
;

1117 
cmnd
->
rw
.
»áag
 = 
	`ıu_to_Ë32
(

1118 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

1123 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1124 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

1126 
	}
}

1128 
blk_¡©us_t
 
	$nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

1129 
nvme_commªd
 *
cmd
)

1131 
blk_¡©us_t
 
»t
 = 
BLK_STS_OK
;

1133 ià(!(
»q
->
rq_æags
 & 
RQF_DONTPREP
)) {

1134 
	`nvme_»q
(
»q
)->
»Œ›s
 = 0;

1135 
	`nvme_»q
(
»q
)->
æags
 = 0;

1136 
»q
->
rq_æags
 |ğ
RQF_DONTPREP
;

1139 
	`»q_İ
(
»q
)) {

1140 
REQ_OP_DRV_IN
:

1141 
REQ_OP_DRV_OUT
:

1142 
	`memıy
(
cmd
, 
	`nvme_»q
(
»q
)->cmd, (*cmd));

1144 
REQ_OP_FLUSH
:

1145 
	`nvme_£tup_æush
(
ns
, 
cmd
);

1147 
REQ_OP_WRITE_ZEROES
:

1149 
REQ_OP_DISCARD
:

1150 
»t
 = 
	`nvme_£tup_disÿrd
(
ns
, 
»q
, 
cmd
);

1152 
REQ_OP_READ
:

1153 
REQ_OP_WRITE
:

1154 
»t
 = 
	`nvme_£tup_rw
(
ns
, 
»q
, 
cmd
);

1157 
	`WARN_ON_ONCE
(1);

1158  
BLK_STS_IOERR
;

1161 
cmd
->
commÚ
.
commªd_id
 = 
»q
->
g
;

1162  
»t
;

1163 
	}
}

1164 
EXPORT_SYMBOL_GPL
(
nvme_£tup_cmd
);

1175 
boŞ
 
	$check_add_fÜ_sšgË_cÚt_phyadd»ss
(
__u£r
 *
add»ss
, 
Ëngth
, 
»que¡_queue
 *
q
)

1177 
off£t
 = 0;

1178 
couÁ
 = 0;

1180 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

1181 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

1182 ià((
couÁ
 > 1è|| (()
add»ss
 & 
	`queue_dma_®ignm’t
(
q
))) {

1184  
çl£
;

1186  
Œue
;

1187 
	}
}

1189 
	$u£r_addr_Åages
(
off£t
, 
size
)

1191 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

1192  
couÁ
;

1193 
	}
}

1195 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
, 
boŞ
 
b_k”Ãl
)

1197 
off£t
 = 
	`off£t_š_·ge
(
addr
);

1198 
d©®’
 = 
Ën
;

1199 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
, 
Ën
);

1200 
size
 = 0;

1201 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1202 
m­³d_·ges
 = 0;

1203 
i
 = 0;

1204 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


1205 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

1207 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

1208 ià(!
u£r_ùx
) {

1209  
NULL
;

1212 
u£r_ùx
->
ÃÁs
 = 0;

1213 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

1214 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

1215 ià(
b_k”Ãl
) {

1216 
·ge
 *·gğ
NULL
;

1217 *
¤c_d©a
 = 
addr
;

1218 
i
 = 0; i < 
num_·ge
; i++) {

1219 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

1220 
	`g‘_·ge
(
·ge
);

1221 
u£r_ùx
->
·ges
[
i
] = 
·ge
;

1222 
¤c_d©a
 +ğ
PAGE_SIZE
;

1226 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

1227 0, 
u£r_ùx
->
·ges
);

1228 ià(
m­³d_·ges
 !ğ
num_·ge
) {

1229 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

1230 
ex™
;

1233 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

1234 
u£r_ùx
->
Ën
 = 
d©®’
;

1235 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

1236 
i
 = 0; i < 
num_·ge
; i++) {

1237 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

1238 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

1239 
off£t
);

1240 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

1241 
off£t
 = 0;

1243 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

1244  
u£r_ùx
;

1245 
ex™
:

1246 ià(
u£r_ùx
) {

1247 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

1248 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

1249 
	`kä“
(
u£r_ùx
);

1251  
NULL
;

1252 
	}
}

1254 
	$__nvme_subm™_kv_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1255 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

1256 
__u£r
 *
ubufãr
, 
bufæ’
,

1257 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1258 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

1260 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1261 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1262 
»que¡
 *
»q
;

1263 
»t
 = 0;

1264 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

1265 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1266 
aio_u£r_ùx
 *
k”Ãl_ùx
 = 
NULL
;

1267 
sÿ‰”li¡
* 
m‘a_sg_±r
;

1268 
sÿ‰”li¡
 
m‘a_sg
;

1269 
·ge
* 
p_·ge
 = 
NULL
;

1270 
nvme_io_·¿m
* 
·¿m
 = 
NULL
;

1271 *
kv_d©a
 = 
NULL
;

1272 *
kv_m‘a
 = 
NULL
;

1273 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

1274 
i
 = 0, 
off£t
 = 0;

1275 
Ën
 = 0;

1276 
¡¬t_time
 = 
jiff›s
;

1278 ià(!
disk
)

1279  -
EFAULT
;

1281 ià(
aio
) {

1282 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

1283 ià(!
aiocb
) {

1284 
»t
 = -
ENOMEM
;

1285 
out_’d
;

1287 
aiocb
->
cmd
 = *cmd;

1288 
aiocb
->
disk
 = disk;

1289 
cmd
 = &
aiocb
->cmd;

1291 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1292 ià(
	`IS_ERR
(
»q
)) {

1293 ià(
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1294  
	`PTR_ERR
(
»q
);

1297 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1298 
·¿m
 = 
	`nvme_io_·¿m
(
»q
);

1300 
·¿m
->
kv_d©a_sg_±r
 = 
NULL
;

1301 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1302 
·¿m
->
kv_d©a_ÃÁs
 = 0;

1303 
·¿m
->
kv_d©a_Ën
 = 0;

1305 ià(
ubufãr
 && 
bufæ’
) {

1306 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
q
)) {

1307 
Ãed_to_cİy
 = 
Œue
;

1308 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

1309 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1310 ià(
kv_d©a
 =ğ
NULL
) {

1311 
»t
 = -
ENOMEM
;

1312 
out_»q_’d
;

1315 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
, 
çl£
);

1316 ià(
Ãed_to_cİy
) {

1317 
k”Ãl_ùx
 = 
	`g‘_aio_u£r_ùx
(
kv_d©a
, 
bufæ’
, 
Œue
);

1318 ià(
k”Ãl_ùx
) {

1319 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1320 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1321 
kv_d©a
, 
u£r_ùx
->
Ën
);

1323 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

1324 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

1325 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

1331 
k”Ãl_ùx
 = 
u£r_ùx
;

1333 ià(
u£r_ùx
 =ğ
NULL
 || 
k”Ãl_ùx
 == NULL) {

1334 
»t
 = -
ENOMEM
;

1335 
out_unm­
;

1337 
·¿m
->
kv_d©a_sg_±r
 = 
k”Ãl_ùx
->
sg
;

1338 
·¿m
->
kv_d©a_ÃÁs
 = 
k”Ãl_ùx
->
ÃÁs
;

1339 
·¿m
->
kv_d©a_Ën
 = 
k”Ãl_ùx
->
Ën
;

1340 ià(
aio
) {

1341 
aiocb
->
Ãed_to_cİy
 =‚eed_to_copy;

1342 
aiocb
->
kv_d©a
 = kv_data;

1343 
aiocb
->
k”Ãl_ùx
 = kernel_ctx;

1344 
aiocb
->
u£r_ùx
 = user_ctx;

1345 
aiocb
->
¡¬t_time
 = start_time;

1347 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1348 
	`g’”ic_¡¬t_io_acù
(
»q
->
q
, 
WRITE
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1350 
	`g’”ic_¡¬t_io_acù
(
»q
->
q
, 
READ
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1354 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1355 ià(
	`check_add_fÜ_sšgË_cÚt_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
, 
q
)) {

1356 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 0, &
p_·ge
);

1357 ià(
»t
 != 1) {

1358 
»t
 = -
ENOMEM
;

1359 
out_unm­
;

1361 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

1363 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256) * 256;

1364 
kv_m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1365 ià(!
kv_m‘a
) {

1366 
»t
 = -
ENOMEM
;

1367 
out_unm­
;

1369 ià(
	`cİy_äom_u£r
(
kv_m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

1370 
»t
 = -
EFAULT
;

1371 
out_ä“_m‘a
;

1373 
off£t
 = 
	`off£t_š_·ge
(
kv_m‘a
);

1374 
p_·ge
 = 
	`vœt_to_·ge
(
kv_m‘a
);

1375 
	`g‘_·ge
(
p_·ge
);

1377 ià(
aio
) {

1378 
aiocb
->
u£_m‘a
 = 
Œue
;

1379 
aiocb
->
m‘a
 = 
kv_m‘a
;

1380 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

1382 
m‘a_sg_±r
 = &
m‘a_sg
;

1384 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

1385 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

1386 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

1387 
·¿m
->
kv_m‘a_sg_±r
 = 
m‘a_sg_±r
;

1389 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1392 ià(
aio
) {

1393 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

1394 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

1395 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

1396 
»q
->
’d_io_d©a
 = 
aiocb
;

1397 
	`blk_execu‹_rq_nowa™
(
»q
->
q
, 
disk
,„eq, 0, 
kv_async_com¶‘iÚ
);

1401 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1402 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

1403 
»t
 = 
EINTR
;

1405 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

1407 ià(
»suÉ
)

1408 *
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

1409 ià(
¡©us
)

1410 *
¡©us
 = 
	`Ë16_to_ıu
(
	`nvme_»q
(
»q
)->status);

1411 ià(
»t
 && !
	`is_kv_™”_»q_cmd
(
cmd
->
commÚ
.
İcode
è&& !
	`is_kv_™”_»ad_cmd
(cmd->common.opcode)) {

1413 
	`´_”r
("__nvme_subm™_u£r_cmd faed!!!!!: opcode(%02x)\n", 
cmd
->
commÚ
.
İcode
);

1417 ià(
Ãed_to_cİy
) {

1418 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

1419 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || ((
	`Ë16_to_ıu
(
	`nvme_»q
(
»q
)->
¡©us
) & 0x00ff) == 0x0093)))) {

1421 *
d©a
 = 
kv_d©a
;

1422 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

1424 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1425 
kv_d©a
, 
u£r_ùx
->
Ën
);

1428 
out_ä“_m‘a
:

1429 ià(
p_·ge
è
	`put_·ge
(p_page);

1430 ià(
kv_m‘a
è
	`kä“
(kv_meta);

1431 
out_unm­
:

1432 ià(
u£r_ùx
) {

1433 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++) {

1434 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

1436 
	`kä“
(
u£r_ùx
);

1438 ià(
Ãed_to_cİy
) {

1439 ià(
k”Ãl_ùx
) {

1440 
i
 = 0; i < 
k”Ãl_ùx
->
ÃÁs
; i++) {

1441 
	`put_·ge
(
	`sg_·ge
(&
k”Ãl_ùx
->
sg
[
i
]));

1443 
	`kä“
(
k”Ãl_ùx
);

1445 ià(
kv_d©a
è
	`kä“
(kv_data);

1447 
out_»q_’d
:

1448 ià(
aio
 && 
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1450 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1451 
	`g’”ic_’d_io_acù
(
»q
->
q
, 
WRITE
, &
disk
->
·¹0
, 
¡¬t_time
);

1453 
	`g’”ic_’d_io_acù
(
»q
->
q
, 
READ
, &
disk
->
·¹0
, 
¡¬t_time
);

1455 
	`blk_mq_ä“_»que¡
(
»q
);

1456 
out_’d
:

1457  
»t
;

1458 
	}
}

1460 
	$nvme_u£r_kv_cmd
(
nvme_ù¾
 *
ù¾
,

1461 
nvme_ns
 *
ns
,

1462 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

1464 
nvme_·s¡hru_kv_cmd
 
cmd
;

1465 
nvme_commªd
 
c
;

1466 
timeout
 = 0;

1467 
¡©us
;

1468 
__u£r
 *
m‘ad©a
 = 
NULL
;

1469 
m‘a_Ën
 = 0;

1470 
İtiÚ
 = 0;

1471 
™”_hªdË
 = 0;

1472 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1473  -
EACCES
;

1474 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1475  -
EFAULT
;

1476 ià(
cmd
.
æags
)

1477  -
EINVAL
;

1481 ià(!
	`is_kv_cmd
(
cmd
.
İcode
)) {

1482  -
EINVAL
;

1484 
	`mem£t
(&
c
, 0, (c));

1485 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1486 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1487 #ifdeà
KSID_SUPPORT


1488 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

1490 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1492 ià(
cmd
.
timeout_ms
)

1493 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1500 
cmd
.
İcode
) {

1501 
nvme_cmd_kv_¡Üe
:

1502 
nvme_cmd_kv_­³nd
:

1503 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1504 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1506 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1507 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1508 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1509 
¡©us
 = -
EINVAL
;

1510 
ex™
;

1512 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1513 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

1515 ià(
cmd
.
d©a_Ëngth
 % 4) {

1516 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

1517 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

1519 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1522 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1523 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1524 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1526 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1529 
nvme_cmd_kv_»Œ›ve
:

1530 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1531 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1533 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1534 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1535 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1536 
¡©us
 = -
EINVAL
;

1537 
ex™
;

1539 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1540 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

1541 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1543 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1544 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1545 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1547 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1550 
nvme_cmd_kv_d–‘e
:

1551 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1553 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1554 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1555 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1556 
¡©us
 = -
EINVAL
;

1557 
ex™
;

1559 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1560 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

1561 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1562 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1563 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1565 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1568 
nvme_cmd_kv_exi¡
:

1569 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1571 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1572 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1573 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1574 
¡©us
 = -
EINVAL
;

1575 
ex™
;

1577 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1578 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

1579 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1580 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1581 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1583 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1586 
nvme_cmd_kv_™”_»q
:

1587 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1588 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1589 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

1590 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

1591 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1592 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1594 
nvme_cmd_kv_™”_»ad
:

1595 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1596 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1597 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

1598 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

1599 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1602 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

1603 
¡©us
 = -
EINVAL
;

1604 
ex™
;

1613 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
, &
cmd
,

1614 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
, 0,

1615 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

1616 
ex™
:

1617 ià(!
aio
) {

1618 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1619  -
EFAULT
;

1620 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

1621  -
EFAULT
;

1623  
¡©us
;

1625 
	}
}

1633 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1634 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

1635 
timeout
, 
qid
, 
©_h—d
,

1636 
blk_mq_»q_æags_t
 
æags
)

1638 
»que¡
 *
»q
;

1639 
»t
;

1641 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
æags
, 
qid
);

1642 ià(
	`IS_ERR
(
»q
))

1643  
	`PTR_ERR
(
»q
);

1645 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1647 ià(
bufãr
 && 
bufæ’
) {

1648 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
GFP_KERNEL
);

1649 ià(
»t
)

1650 
out
;

1653 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 
©_h—d
);

1654 ià(
»suÉ
)

1655 *
»suÉ
 = 
	`nvme_»q
(
»q
)->result;

1656 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

1657 
»t
 = -
EINTR
;

1659 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

1660 
out
:

1661 
	`blk_mq_ä“_»que¡
(
»q
);

1662  
»t
;

1663 
	}
}

1664 
EXPORT_SYMBOL_GPL
(
__nvme_subm™_sync_cmd
);

1666 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1667 *
bufãr
, 
bufæ’
)

1669  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

1670 
NVME_QID_ANY
, 0, 0);

1671 
	}
}

1672 
EXPORT_SYMBOL_GPL
(
nvme_subm™_sync_cmd
);

1674 *
	$nvme_add_u£r_m‘ad©a
(
bio
 *bio, 
__u£r
 *
ubuf
,

1675 
Ën
, 
u32
 
£ed
, 
boŞ
 
wr™e
)

1677 
bio_š‹gr™y_·ylßd
 *
b
;

1678 
»t
 = -
ENOMEM
;

1679 *
buf
;

1681 
buf
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1682 ià(!
buf
)

1683 
out
;

1685 
»t
 = -
EFAULT
;

1686 ià(
wr™e
 && 
	`cİy_äom_u£r
(
buf
, 
ubuf
, 
Ën
))

1687 
out_ä“_m‘a
;

1689 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

1690 ià(
	`IS_ERR
(
b
)) {

1691 
»t
 = 
	`PTR_ERR
(
b
);

1692 
out_ä“_m‘a
;

1695 
b
->
b_™”
.
bi_size
 = 
Ën
;

1696 
b
->
b_™”
.
bi_£ùÜ
 = 
£ed
;

1697 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
buf
), 
Ën
,

1698 
	`off£t_š_·ge
(
buf
));

1699 ià(
»t
 =ğ
Ën
)

1700  
buf
;

1701 
»t
 = -
ENOMEM
;

1702 
out_ä“_m‘a
:

1703 
	`kä“
(
buf
);

1704 
out
:

1705  
	`ERR_PTR
(
»t
);

1706 
	}
}

1708 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
,

1709 
nvme_commªd
 *
cmd
, 
__u£r
 *
ubufãr
,

1710 
bufæ’
, 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
,

1711 
u32
 
m‘a_£ed
, u32 *
»suÉ
, 
timeout
)

1713 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
(
cmd
);

1714 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1715 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1716 
»que¡
 *
»q
;

1717 
bio
 *biØğ
NULL
;

1718 *
m‘a
 = 
NULL
;

1719 
»t
;

1721 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1722 ià(
	`IS_ERR
(
»q
))

1723  
	`PTR_ERR
(
»q
);

1725 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1727 ià(
ubufãr
 && 
bufæ’
) {

1728 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
,

1729 
GFP_KERNEL
);

1730 ià(
»t
)

1731 
out
;

1732 
bio
 = 
»q
->bio;

1733 
bio
->
bi_disk
 = 
disk
;

1734 ià(
disk
 && 
m‘a_bufãr
 && 
m‘a_Ën
) {

1735 
m‘a
 = 
	`nvme_add_u£r_m‘ad©a
(
bio
, 
m‘a_bufãr
, 
m‘a_Ën
,

1736 
m‘a_£ed
, 
wr™e
);

1737 ià(
	`IS_ERR
(
m‘a
)) {

1738 
»t
 = 
	`PTR_ERR
(
m‘a
);

1739 
out_unm­
;

1744 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1745 ià(
	`nvme_»q
(
»q
)->
æags
 & 
NVME_REQ_CANCELLED
)

1746 
»t
 = -
EINTR
;

1748 
»t
 = 
	`nvme_»q
(
»q
)->
¡©us
;

1749 ià(
»suÉ
)

1750 *
»suÉ
 = 
	`Ë32_to_ıu
(
	`nvme_»q
(
»q
)->»suÉ.
u32
);

1751 ià(
m‘a
 && !
»t
 && !
wr™e
) {

1752 ià(
	`cİy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

1753 
»t
 = -
EFAULT
;

1755 
	`kä“
(
m‘a
);

1756 
out_unm­
:

1757 ià(
bio
)

1758 
	`blk_rq_unm­_u£r
(
bio
);

1759 
out
:

1760 
	`blk_mq_ä“_»que¡
(
»q
);

1761  
»t
;

1762 
	}
}

1764 
	$nvme_k“p_®ive_’d_io
(
»que¡
 *
rq
, 
blk_¡©us_t
 
¡©us
)

1766 
nvme_ù¾
 *
ù¾
 = 
rq
->
’d_io_d©a
;

1768 
	`blk_mq_ä“_»que¡
(
rq
);

1770 ià(
¡©us
) {

1771 
	`dev_”r
(
ù¾
->
deviû
,

1773 
¡©us
);

1777 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1778 
	}
}

1780 
	$nvme_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1782 
nvme_commªd
 
c
;

1783 
»que¡
 *
rq
;

1785 
	`mem£t
(&
c
, 0, (c));

1786 
c
.
commÚ
.
İcode
 = 
nvme_admš_k“p_®ive
;

1788 
rq
 = 
	`nvme_®loc_»que¡
(
ù¾
->
admš_q
, &
c
, 
BLK_MQ_REQ_RESERVED
,

1789 
NVME_QID_ANY
);

1790 ià(
	`IS_ERR
(
rq
))

1791  
	`PTR_ERR
(
rq
);

1793 
rq
->
timeout
 = 
ù¾
->
k©o
 * 
HZ
;

1794 
rq
->
’d_io_d©a
 = 
ù¾
;

1796 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q, 0, 
nvme_k“p_®ive_’d_io
);

1799 
	}
}

1801 
	$nvme_k“p_®ive_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1803 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

1804 
nvme_ù¾
, 
ka_wÜk
);

1806 ià(
	`nvme_k“p_®ive
(
ù¾
)) {

1808 
	`dev_”r
(
ù¾
->
deviû
, "keep-alive failed\n");

1809 
	`nvme_»£t_ù¾
(
ù¾
);

1812 
	}
}

1814 
	$nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1816 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1819 
	`INIT_DELAYED_WORK
(&
ù¾
->
ka_wÜk
, 
nvme_k“p_®ive_wÜk
);

1820 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1821 
	}
}

1822 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_k“p_®ive
);

1824 
	$nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1826 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1829 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
ka_wÜk
);

1830 
	}
}

1831 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_k“p_®ive
);

1833 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1835 
nvme_commªd
 
c
 = { };

1836 
”rÜ
;

1839 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1840 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_CTRL
;

1842 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1843 ià(!*
id
)

1844  -
ENOMEM
;

1846 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1847 (
nvme_id_ù¾
));

1848 ià(
”rÜ
)

1849 
	`kä“
(*
id
);

1850  
”rÜ
;

1851 
	}
}

1853 
	$nvme_id’tify_ns_descs
(
nvme_ù¾
 *
ù¾
, 
nsid
,

1854 
nvme_ns_ids
 *
ids
)

1856 
nvme_commªd
 
c
 = { };

1857 
¡©us
;

1858 *
d©a
;

1859 
pos
;

1860 
Ën
;

1862 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1863 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1864 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS_DESC_LIST
;

1866 
d©a
 = 
	`kz®loc
(
NVME_IDENTIFY_DATA_SIZE
, 
GFP_KERNEL
);

1867 ià(!
d©a
)

1868  -
ENOMEM
;

1870 
¡©us
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
d©a
,

1871 
NVME_IDENTIFY_DATA_SIZE
);

1872 ià(
¡©us
)

1873 
ä“_d©a
;

1875 
pos
 = 0;…o < 
NVME_IDENTIFY_DATA_SIZE
;…o +ğ
Ën
) {

1876 
nvme_ns_id_desc
 *
cur
 = 
d©a
 + 
pos
;

1878 ià(
cur
->
nidl
 == 0)

1881 
cur
->
nidt
) {

1882 
NVME_NIDT_EUI64
:

1883 ià(
cur
->
nidl
 !ğ
NVME_NIDT_EUI64_LEN
) {

1884 
	`dev_w¬n
(
ù¾
->
deviû
,

1886 
cur
->
nidl
);

1887 
ä“_d©a
;

1889 
Ën
 = 
NVME_NIDT_EUI64_LEN
;

1890 
	`memıy
(
ids
->
eui64
, 
d©a
 + 
pos
 + (*
cur
), 
Ën
);

1892 
NVME_NIDT_NGUID
:

1893 ià(
cur
->
nidl
 !ğ
NVME_NIDT_NGUID_LEN
) {

1894 
	`dev_w¬n
(
ù¾
->
deviû
,

1896 
cur
->
nidl
);

1897 
ä“_d©a
;

1899 
Ën
 = 
NVME_NIDT_NGUID_LEN
;

1900 
	`memıy
(
ids
->
nguid
, 
d©a
 + 
pos
 + (*
cur
), 
Ën
);

1902 
NVME_NIDT_UUID
:

1903 ià(
cur
->
nidl
 !ğ
NVME_NIDT_UUID_LEN
) {

1904 
	`dev_w¬n
(
ù¾
->
deviû
,

1906 
cur
->
nidl
);

1907 
ä“_d©a
;

1909 
Ën
 = 
NVME_NIDT_UUID_LEN
;

1910 
	`uuid_cİy
(&
ids
->
uuid
, 
d©a
 + 
pos
 + (*
cur
));

1914 
Ën
 = 
cur
->
nidl
;

1918 
Ën
 +ğ(*
cur
);

1920 
ä“_d©a
:

1921 
	`kä“
(
d©a
);

1922  
¡©us
;

1923 
	}
}

1925 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1927 
nvme_commªd
 
c
 = { };

1929 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1930 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS_ACTIVE_LIST
;

1931 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1932  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
, 0x1000);

1933 
	}
}

1935 
nvme_id_ns
 *
	$nvme_id’tify_ns
(
nvme_ù¾
 *
ù¾
,

1936 
nsid
)

1938 
nvme_id_ns
 *
id
;

1939 
nvme_commªd
 
c
 = { };

1940 
”rÜ
;

1943 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1944 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1945 
c
.
id’tify
.
ús
 = 
NVME_ID_CNS_NS
;

1947 
id
 = 
	`km®loc
((*id), 
GFP_KERNEL
);

1948 ià(!
id
)

1949  
NULL
;

1951 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
id
, (*id));

1952 ià(
”rÜ
) {

1953 
	`dev_w¬n
(
ù¾
->
deviû
, "Identify‚amespace failed\n");

1954 
	`kä“
(
id
);

1955  
NULL
;

1958  
id
;

1959 
	}
}

1961 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1962 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1964 
nvme_commªd
 
c
;

1965 
nvme_»suÉ
 
»s
;

1966 
»t
;

1968 
	`mem£t
(&
c
, 0, (c));

1969 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1970 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1971 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1973 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
»s
,

1974 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 0);

1975 ià(
»t
 >ğ0 && 
»suÉ
)

1976 *
»suÉ
 = 
	`Ë32_to_ıu
(
»s
.
u32
);

1977  
»t
;

1978 
	}
}

1980 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1982 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1983 
u32
 
»suÉ
;

1984 
¡©us
, 
Ä_io_queues
;

1986 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 
NULL
, 0,

1987 &
»suÉ
);

1988 ià(
¡©us
 < 0)

1989  
¡©us
;

1996 ià(
¡©us
 > 0) {

1997 
	`dev_”r
(
ù¾
->
deviû
, "Could‚Ù s‘ queucouÁ (%d)\n", 
¡©us
);

1998 *
couÁ
 = 0;

2000 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

2001 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

2005 
	}
}

2006 
EXPORT_SYMBOL_GPL
(
nvme_£t_queue_couÁ
);

2008 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

2010 
nvme_u£r_io
 
io
;

2011 
nvme_commªd
 
c
;

2012 
Ëngth
, 
m‘a_Ën
;

2013 
__u£r
 *
m‘ad©a
;

2015 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

2016  -
EFAULT
;

2017 ià(
io
.
æags
)

2018  -
EINVAL
;

2020 
io
.
İcode
) {

2021 
nvme_cmd_wr™e
:

2022 
nvme_cmd_»ad
:

2023 
nvme_cmd_com·»
:

2026  -
EINVAL
;

2029 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

2030 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

2031 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

2033 ià(
ns
->
ext
) {

2034 
Ëngth
 +ğ
m‘a_Ën
;

2035 
m‘a_Ën
 = 0;

2036 } ià(
m‘a_Ën
) {

2037 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

2038  -
EINVAL
;

2041 
	`mem£t
(&
c
, 0, (c));

2042 
c
.
rw
.
İcode
 = 
io
.opcode;

2043 
c
.
rw
.
æags
 = 
io
.flags;

2044 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

2045 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

2046 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

2047 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

2048 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

2049 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

2050 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

2051 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

2053  
	`nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

2054 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

2055 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

2056 
	}
}

2058 
u32
 
	$nvme_known_admš_efãùs
(
u8
 
İcode
)

2060 
İcode
) {

2061 
nvme_admš_fÜm©_nvm
:

2062  
NVME_CMD_EFFECTS_CSUPP
 | 
NVME_CMD_EFFECTS_LBCC
 |

2063 
NVME_CMD_EFFECTS_CSE_MASK
;

2064 
nvme_admš_§n™ize_nvm
:

2065  
NVME_CMD_EFFECTS_CSE_MASK
;

2070 
	}
}

2072 
u32
 
	$nvme_·s¡hru_¡¬t
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

2073 
u8
 
İcode
)

2075 
u32
 
efãùs
 = 0;

2077 ià(
ns
) {

2078 ià(
ù¾
->
efãùs
)

2079 
efãùs
 = 
	`Ë32_to_ıu
(
ù¾
->efãùs->
iocs
[
İcode
]);

2080 ià(
efãùs
 & ~
NVME_CMD_EFFECTS_CSUPP
)

2081 
	`dev_w¬n
(
ù¾
->
deviû
,

2083 
İcode
, 
efãùs
);

2087 ià(
ù¾
->
efãùs
)

2088 
efãùs
 = 
	`Ë32_to_ıu
(
ù¾
->efãùs->
iocs
[
İcode
]);

2090 
efãùs
 = 
	`nvme_known_admš_efãùs
(
İcode
);

2096 ià(
efãùs
 & (
NVME_CMD_EFFECTS_LBCC
 | 
NVME_CMD_EFFECTS_CSE_MASK
)) {

2097 
	`nvme_¡¬t_ä“ze
(
ù¾
);

2098 
	`nvme_wa™_ä“ze
(
ù¾
);

2100  
efãùs
;

2101 
	}
}

2103 
	$nvme_upd©e_fÜm©s
(
nvme_ù¾
 *
ù¾
)

2105 
nvme_ns
 *
ns
;

2107 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2108 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2109 ià(
ns
->
disk
 && 
	`nvme_»v®id©e_disk
(ns->disk))

2110 
	`nvme_ns_»move
(
ns
);

2112 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2113 
	}
}

2115 
	$nvme_·s¡hru_’d
(
nvme_ù¾
 *
ù¾
, 
u32
 
efãùs
)

2122 ià(
efãùs
 & 
NVME_CMD_EFFECTS_LBCC
)

2123 
	`nvme_upd©e_fÜm©s
(
ù¾
);

2124 ià(
efãùs
 & (
NVME_CMD_EFFECTS_LBCC
 | 
NVME_CMD_EFFECTS_CSE_MASK
))

2125 
	`nvme_unä“ze
(
ù¾
);

2126 ià(
efãùs
 & 
NVME_CMD_EFFECTS_CCC
)

2127 
	`nvme_š™_id’tify
(
ù¾
);

2128 ià(
efãùs
 & (
NVME_CMD_EFFECTS_NIC
 | 
NVME_CMD_EFFECTS_NCC
))

2129 
	`nvme_queue_sÿn
(
ù¾
);

2130 
	}
}

2132 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

2133 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

2135 
nvme_·s¡hru_cmd
 
cmd
;

2136 
nvme_commªd
 
c
;

2137 
timeout
 = 0;

2138 
u32
 
efãùs
;

2139 
¡©us
;

2141 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2142  -
EACCES
;

2143 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

2144  -
EFAULT
;

2145 ià(
cmd
.
æags
)

2146  -
EINVAL
;

2148 
	`mem£t
(&
c
, 0, (c));

2149 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

2150 
c
.
commÚ
.
æags
 = 
cmd
.flags;

2151 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

2152 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

2153 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

2154 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

2155 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

2156 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

2157 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

2158 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

2159 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

2161 ià(
cmd
.
timeout_ms
)

2162 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

2164 
efãùs
 = 
	`nvme_·s¡hru_¡¬t
(
ù¾
, 
ns
, 
cmd
.
İcode
);

2165 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

2166 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

2167 (
__u£r
 *)(
ušŒ_t
)
cmd
.
m‘ad©a
, cmd.metadata,

2168 0, &
cmd
.
»suÉ
, 
timeout
);

2169 
	`nvme_·s¡hru_’d
(
ù¾
, 
efãùs
);

2171 ià(
¡©us
 >= 0) {

2172 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

2173  -
EFAULT
;

2176  
¡©us
;

2177 
	}
}

2183 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
,

2184 
nvme_ns_h—d
 **
h—d
, *
¤cu_idx
)

2186 #ifdeà
CONFIG_NVME_MULTIPATH


2187 ià(
disk
->
fİs
 =ğ&
nvme_ns_h—d_İs
) {

2188 *
h—d
 = 
disk
->
´iv©e_d©a
;

2189 *
¤cu_idx
 = 
	`¤cu_»ad_lock
(&(*
h—d
)->
¤cu
);

2190  
	`nvme_fšd_·th
(*
h—d
);

2193 *
h—d
 = 
NULL
;

2194 *
¤cu_idx
 = -1;

2195  
disk
->
´iv©e_d©a
;

2196 
	}
}

2198 
	$nvme_put_ns_äom_disk
(
nvme_ns_h—d
 *
h—d
, 
idx
)

2200 ià(
h—d
)

2201 
	`¤cu_»ad_uÆock
(&
h—d
->
¤cu
, 
idx
);

2202 
	}
}

2204 
	$nvme_ns_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
)

2206 
cmd
) {

2207 
NVME_IOCTL_ID
:

2208 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

2209  
ns
->
h—d
->
ns_id
;

2210 
NVME_IOCTL_ADMIN_CMD
:

2211  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

2212 
NVME_IOCTL_IO_CMD
:

2213  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

2214 
NVME_IOCTL_SUBMIT_IO
:

2215  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

2217 
NVME_IOCTL_IO_KV_CMD
:

2218  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
çl£
);

2219 
NVME_IOCTL_AIO_CMD
:

2220  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
Œue
);

2221 
NVME_IOCTL_SET_AIOCTX
:

2222  
	`nvme_£t_aioùx
((
__u£r
*)
¬g
);

2223 
NVME_IOCTL_DEL_AIOCTX
:

2224  
	`nvme_d–_aioùx
((
__u£r
*)
¬g
);

2225 
NVME_IOCTL_GET_AIOEVENT
:

2226  
	`nvme_g‘_iÛv’ts
((
__u£r
*)
¬g
);

2229 #ifdeà
CONFIG_NVM


2230 ià(
ns
->
ndev
)

2231  
	`nvme_nvm_ioùl
(
ns
, 
cmd
, 
¬g
);

2233 ià(
	`is_£d_ioùl
(
cmd
))

2234  
	`£d_ioùl
(
ns
->
ù¾
->
İ®_dev
, 
cmd
,

2235 (
__u£r
 *è
¬g
);

2236  -
ENOTTY
;

2238 
	}
}

2240 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

2241 
cmd
, 
¬g
)

2243 
nvme_ns_h—d
 *
h—d
 = 
NULL
;

2244 
nvme_ns
 *
ns
;

2245 
¤cu_idx
, 
»t
;

2247 
ns
 = 
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
, &
h—d
, &
¤cu_idx
);

2248 ià(
	`uÆik–y
(!
ns
))

2249 
»t
 = -
EWOULDBLOCK
;

2251 
»t
 = 
	`nvme_ns_ioùl
(
ns
, 
cmd
, 
¬g
);

2252 
	`nvme_put_ns_äom_disk
(
h—d
, 
¤cu_idx
);

2253  
»t
;

2254 
	}
}

2256 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

2258 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2260 #ifdeà
CONFIG_NVME_MULTIPATH


2262 ià(
	`WARN_ON_ONCE
(
ns
->
h—d
->
disk
))

2263  -
ENXIO
;

2265 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

2266  -
ENXIO
;

2268 
	}
}

2270 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

2272 
	`nvme_put_ns
(
disk
->
´iv©e_d©a
);

2273 
	}
}

2275 
	$nvme_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

2278 
geo
->
h—ds
 = 1 << 6;

2279 
geo
->
£ùÜs
 = 1 << 5;

2280 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bdev
->
bd_disk
) >> 11;

2282 
	}
}

2284 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


2285 
	$nvme_š™_š‹gr™y
(
g’disk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty³
)

2287 
blk_š‹gr™y
 
š‹gr™y
;

2289 
	`mem£t
(&
š‹gr™y
, 0, (integrity));

2290 
pi_ty³
) {

2291 
NVME_NS_DPS_PI_TYPE3
:

2292 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³3_üc
;

2293 
š‹gr™y
.
g_size
 = (
u16
è+ (
u32
);

2294 
š‹gr™y
.
æags
 |ğ
BLK_INTEGRITY_DEVICE_CAPABLE
;

2296 
NVME_NS_DPS_PI_TYPE1
:

2297 
NVME_NS_DPS_PI_TYPE2
:

2298 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³1_üc
;

2299 
š‹gr™y
.
g_size
 = (
u16
);

2300 
š‹gr™y
.
æags
 |ğ
BLK_INTEGRITY_DEVICE_CAPABLE
;

2303 
š‹gr™y
.
´ofe
 = 
NULL
;

2306 
š‹gr™y
.
tu¶e_size
 = 
ms
;

2307 
	`blk_š‹gr™y_»gi¡”
(
disk
, &
š‹gr™y
);

2308 
	`blk_queue_max_š‹gr™y_£gm’ts
(
disk
->
queue
, 1);

2309 
	}
}

2311 
	$nvme_š™_š‹gr™y
(
g’disk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty³
)

2313 
	}
}

2316 
	$nvme_£t_chunk_size
(
nvme_ns
 *
ns
)

2318 
u32
 
chunk_size
 = (((u32)
ns
->
noiob
è<< (ns->
lba_shiá
 - 9));

2319 
	`blk_queue_chunk_£ùÜs
(
ns
->
queue
, 
	`rounddown_pow_of_two
(
chunk_size
));

2320 
	}
}

2322 
	$nvme_cÚfig_disÿrd
(
nvme_ù¾
 *
ù¾
,

2323 
¡»am_®ignm’t
, 
»que¡_queue
 *
queue
)

2325 
u32
 
size
 = 
	`queue_logiÿl_block_size
(
queue
);

2327 ià(
¡»am_®ignm’t
)

2328 
size
 *ğ
¡»am_®ignm’t
;

2330 
	`BUILD_BUG_ON
(
PAGE_SIZE
 / (
nvme_dsm_¿nge
) <

2331 
NVME_DSM_MAX_RANGES
);

2333 
queue
->
lim™s
.
disÿrd_®ignm’t
 = 0;

2334 
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
size
;

2336 
	`blk_queue_max_disÿrd_£ùÜs
(
queue
, 
UINT_MAX
);

2337 
	`blk_queue_max_disÿrd_£gm’ts
(
queue
, 
NVME_DSM_MAX_RANGES
);

2338 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
queue
);

2340 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DEALLOCATE_ZEROES
)

2341 
	`blk_queue_max_wr™e_z”Ûs_£ùÜs
(
queue
, 
UINT_MAX
);

2342 
	}
}

2344 
	$nvme_»pÜt_ns_ids
(
nvme_ù¾
 *
ù¾
, 
nsid
,

2345 
nvme_id_ns
 *
id
, 
nvme_ns_ids
 *
ids
)

2347 
	`mem£t
(
ids
, 0, (*ids));

2349 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

2350 
	`memıy
(
ids
->
eui64
, 
id
->eui64, (id->eui64));

2351 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 0))

2352 
	`memıy
(
ids
->
nguid
, 
id
->nguid, (id->nguid));

2353 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 3, 0)) {

2357 ià(
	`nvme_id’tify_ns_descs
(
ù¾
, 
nsid
, 
ids
))

2358 
	`dev_w¬n
(
ù¾
->
deviû
,

2359 "%s: Id’tify DesütÜ çed\n", 
__func__
);

2361 
	}
}

2363 
boŞ
 
	$nvme_ns_ids_v®id
(
nvme_ns_ids
 *
ids
)

2365  !
	`uuid_is_nuÎ
(&
ids
->
uuid
) ||

2366 
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)) ||

2367 
	`memchr_šv
(
ids
->
eui64
, 0, (ids->eui64));

2368 
	}
}

2370 
boŞ
 
	$nvme_ns_ids_equ®
(
nvme_ns_ids
 *
a
, nvme_ns_id *
b
)

2372  
	`uuid_equ®
(&
a
->
uuid
, &
b
->uuid) &&

2373 
	`memcmp
(&
a
->
nguid
, &
b
->nguid, (a->nguid)) == 0 &&

2374 
	`memcmp
(&
a
->
eui64
, &
b
->eui64, (a->eui64)) == 0;

2375 
	}
}

2377 
	$nvme_upd©e_disk_šfo
(
g’disk
 *
disk
,

2378 
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

2380 
£ùÜ_t
 
ÿ·c™y
 = 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9);

2381 
bs
 = 1 << 
ns
->
lba_shiá
;

2382 
¡»am_®ignm’t
 = 0;

2384 ià(
ns
->
ù¾
->
Ä_¡»ams
 &&‚s->
sws
 &&‚s->
sgs
)

2385 
¡»am_®ignm’t
 = 
ns
->
sws
 *‚s->
sgs
;

2387 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

2388 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

2390 
	`blk_queue_logiÿl_block_size
(
disk
->
queue
, 
bs
);

2391 
	`blk_queue_physiÿl_block_size
(
disk
->
queue
, 
bs
);

2392 
	`blk_queue_io_mš
(
disk
->
queue
, 
bs
);

2394 ià(
ns
->
ms
 && !ns->
ext
 &&

2395 (
ns
->
ù¾
->
İs
->
æags
 & 
NVME_F_METADATA_SUPPORTED
))

2396 
	`nvme_š™_š‹gr™y
(
disk
, 
ns
->
ms
,‚s->
pi_ty³
);

2397 ià(
ns
->
ms
 && !
	`nvme_ns_has_pi
Òsè&& !
	`blk_g‘_š‹gr™y
(
disk
))

2398 
ÿ·c™y
 = 0;

2399 
	`£t_ÿ·c™y
(
disk
, 
ÿ·c™y
);

2401 ià(
ns
->
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

2402 
	`nvme_cÚfig_disÿrd
(
ns
->
ù¾
, 
¡»am_®ignm’t
, 
disk
->
queue
);

2403 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

2404 
	}
}

2406 
	$__nvme_»v®id©e_disk
(
g’disk
 *
disk
, 
nvme_id_ns
 *
id
)

2408 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2414 
ns
->
lba_shiá
 = 
id
->
lbaf
[id->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
].
ds
;

2415 ià(
ns
->
lba_shiá
 == 0)

2416 
ns
->
lba_shiá
 = 9;

2417 
ns
->
noiob
 = 
	`Ë16_to_ıu
(
id
->noiob);

2418 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

2419 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[id->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
].ms);

2421 ià(
ns
->
ms
 =ğ(
t10_pi_tu¶e
))

2422 
ns
->
pi_ty³
 = 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
;

2424 
ns
->
pi_ty³
 = 0;

2426 ià(
ns
->
noiob
)

2427 
	`nvme_£t_chunk_size
(
ns
);

2428 
	`nvme_upd©e_disk_šfo
(
disk
, 
ns
, 
id
);

2429 #ifdeà
CONFIG_NVME_MULTIPATH


2430 ià(
ns
->
h—d
->
disk
)

2431 
	`nvme_upd©e_disk_šfo
(
ns
->
h—d
->
disk
,‚s, 
id
);

2433 
	}
}

2435 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

2437 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

2438 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

2439 
nvme_id_ns
 *
id
;

2440 
nvme_ns_ids
 
ids
;

2441 
»t
 = 0;

2443 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

2444 
	`£t_ÿ·c™y
(
disk
, 0);

2445  -
ENODEV
;

2448 
id
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
h—d
->
ns_id
);

2449 ià(!
id
)

2450  -
ENODEV
;

2452 ià(
id
->
nÿp
 == 0) {

2453 
»t
 = -
ENODEV
;

2454 
out
;

2457 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

2458 
	`nvme_»pÜt_ns_ids
(
ù¾
, 
ns
->
h—d
->
ns_id
, 
id
, &
ids
);

2459 ià(!
	`nvme_ns_ids_equ®
(&
ns
->
h—d
->
ids
, &ids)) {

2460 
	`dev_”r
(
ù¾
->
deviû
,

2461 "id’tif›r chªged fÜ‚sid %d\n", 
ns
->
h—d
->
ns_id
);

2462 
»t
 = -
ENODEV
;

2465 
out
:

2466 
	`kä“
(
id
);

2467  
»t
;

2468 
	}
}

2470 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

2472 
ty³
) {

2473 
PR_WRITE_EXCLUSIVE
:

2475 
PR_EXCLUSIVE_ACCESS
:

2477 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

2479 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

2481 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

2483 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

2488 
	}
};

2490 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

2491 
u64
 
key
, u64 
§_key
, 
u8
 
İ
)

2493 
nvme_ns_h—d
 *
h—d
 = 
NULL
;

2494 
nvme_ns
 *
ns
;

2495 
nvme_commªd
 
c
;

2496 
¤cu_idx
, 
»t
;

2497 
u8
 
d©a
[16] = { 0, };

2499 
ns
 = 
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
, &
h—d
, &
¤cu_idx
);

2500 ià(
	`uÆik–y
(!
ns
))

2501  -
EWOULDBLOCK
;

2503 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

2504 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

2506 
	`mem£t
(&
c
, 0, (c));

2507 
c
.
commÚ
.
İcode
 = 
İ
;

2508 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

2509 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

2511 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

2512 
	`nvme_put_ns_äom_disk
(
h—d
, 
¤cu_idx
);

2513  
»t
;

2514 
	}
}

2516 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Şd
,

2517 
u64
 
Ãw
, 
æags
)

2519 
u32
 
cdw10
;

2521 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2522  -
EOPNOTSUPP
;

2524 
cdw10
 = 
Şd
 ? 2 : 0;

2525 
cdw10
 |ğ(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

2526 
cdw10
 |= (1 << 30) | (1 << 31);

2527  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

2528 
	}
}

2530 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

2531 
´_ty³
 
ty³
, 
æags
)

2533 
u32
 
cdw10
;

2535 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2536  -
EOPNOTSUPP
;

2538 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

2539 
cdw10
 |ğ((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

2540  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

2541 
	}
}

2543 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Şd
, u64 
Ãw
,

2544 
´_ty³
 
ty³
, 
boŞ
 
abÜt
)

2546 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
abÜt
 ? 2 : 1;

2547  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

2548 
	}
}

2550 
	$nvme_´_ş—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

2552 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

2553  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

2554 
	}
}

2556 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

2558 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
key
 ? 1 << 3 : 0;

2559  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

2560 
	}
}

2562 cÚ¡ 
´_İs
 
	gnvme_´_İs
 = {

2563 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

2564 .
	g´_»£rve
 = 
nvme_´_»£rve
,

2565 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

2566 .
	g´_´“m±
 = 
nvme_´_´“m±
,

2567 .
	g´_ş—r
 = 
nvme_´_ş—r
,

2570 #ifdeà
CONFIG_BLK_SED_OPAL


2571 
	$nvme_£c_subm™
(*
d©a
, 
u16
 
¥¥
, 
u8
 
£ı
, *
bufãr
, 
size_t
 
Ën
,

2572 
boŞ
 
£nd
)

2574 
nvme_ù¾
 *
ù¾
 = 
d©a
;

2575 
nvme_commªd
 
cmd
;

2577 
	`mem£t
(&
cmd
, 0, (cmd));

2578 ià(
£nd
)

2579 
cmd
.
commÚ
.
İcode
 = 
nvme_admš_£cur™y_£nd
;

2581 
cmd
.
commÚ
.
İcode
 = 
nvme_admš_£cur™y_»cv
;

2582 
cmd
.
commÚ
.
nsid
 = 0;

2583 
cmd
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(((
u32
)
£ı
è<< 24 | ((u32)
¥¥
) << 8);

2584 
cmd
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
Ën
);

2586  
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, 
bufãr
, 
Ën
,

2587 
ADMIN_TIMEOUT
, 
NVME_QID_ANY
, 1, 0);

2588 
	}
}

2589 
EXPORT_SYMBOL_GPL
(
nvme_£c_subm™
);

2592 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

2593 .
owÃr
 = 
THIS_MODULE
,

2594 .
	gioùl
 = 
nvme_ioùl
,

2595 .
	gcom·t_ioùl
 = 
nvme_ioùl
,

2596 .
	gİ’
 = 
nvme_İ’
,

2597 .
	g»Ëa£
 = 
nvme_»Ëa£
,

2598 .
	gg‘geo
 = 
nvme_g‘geo
,

2599 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

2600 .
	g´_İs
 = &
nvme_´_İs
,

2603 #ifdeà
CONFIG_NVME_MULTIPATH


2604 
	$nvme_ns_h—d_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

2606 
nvme_ns_h—d
 *
h—d
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2608 ià(!
	`k»f_g‘_uÆess_z”o
(&
h—d
->
»f
))

2609  -
ENXIO
;

2611 
	}
}

2613 
	$nvme_ns_h—d_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

2615 
	`nvme_put_ns_h—d
(
disk
->
´iv©e_d©a
);

2616 
	}
}

2618 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_ns_h—d_İs
 = {

2619 .
owÃr
 = 
THIS_MODULE
,

2620 .
	gİ’
 = 
nvme_ns_h—d_İ’
,

2621 .
	g»Ëa£
 = 
nvme_ns_h—d_»Ëa£
,

2622 .
	gioùl
 = 
nvme_ioùl
,

2623 .
	gcom·t_ioùl
 = 
nvme_ioùl
,

2624 .
	gg‘geo
 = 
nvme_g‘geo
,

2625 .
	g´_İs
 = &
nvme_´_İs
,

2629 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

2631 
timeout
 =

2632 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

2633 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

2634 
»t
;

2636 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2637 ià(
c¡s
 == ~0)

2638  -
ENODEV
;

2639 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ğ
b™
)

2642 
	`m¦“p
(100);

2643 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2644  -
EINTR
;

2645 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2646 
	`dev_”r
(
ù¾
->
deviû
,

2647 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

2649  -
ENODEV
;

2653  
»t
;

2654 
	}
}

2662 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2664 
»t
;

2666 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2667 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

2669 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2670 ià(
»t
)

2671  
»t
;

2673 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

2674 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

2676  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

2677 
	}
}

2678 
EXPORT_SYMBOL_GPL
(
nvme_di§bË_ù¾
);

2680 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2687 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

2688 
»t
;

2690 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

2691 
	`dev_”r
(
ù¾
->
deviû
,

2693 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

2694  -
ENODEV
;

2697 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

2699 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

2700 
ù¾
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

2701 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_AMS_RR
 | 
NVME_CC_SHN_NONE
;

2702 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

2703 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

2705 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2706 ià(
»t
)

2707  
»t
;

2708  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

2709 
	}
}

2710 
EXPORT_SYMBOL_GPL
(
nvme_’abË_ù¾
);

2712 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

2714 
timeout
 = 
jiff›s
 + (
ù¾
->
shutdown_timeout
 * 
HZ
);

2715 
u32
 
c¡s
;

2716 
»t
;

2718 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2719 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

2721 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2722 ià(
»t
)

2723  
»t
;

2725 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2726 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ğ
NVME_CSTS_SHST_CMPLT
)

2729 
	`m¦“p
(100);

2730 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2731  -
EINTR
;

2732 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2733 
	`dev_”r
(
ù¾
->
deviû
,

2735  -
ENODEV
;

2739  
»t
;

2740 
	}
}

2741 
EXPORT_SYMBOL_GPL
(
nvme_shutdown_ù¾
);

2743 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

2744 
»que¡_queue
 *
q
)

2746 
boŞ
 
vwc
 = 
çl£
;

2748 ià(
ù¾
->
max_hw_£ùÜs
) {

2749 
u32
 
max_£gm’ts
 =

2750 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

2752 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2753 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

2755 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
) &&

2756 
	`is_pow”_of_2
(
ù¾
->
max_hw_£ùÜs
))

2757 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2758 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

2759 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2760 
vwc
 = 
Œue
;

2761 
	`blk_queue_wr™e_ÿche
(
q
, 
vwc
, vwc);

2762 
	}
}

2764 
	$nvme_cÚfigu»_time¡amp
(
nvme_ù¾
 *
ù¾
)

2766 
__Ë64
 
ts
;

2767 
»t
;

2769 ià(!(
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_TIMESTAMP
))

2772 
ts
 = 
	`ıu_to_Ë64
(
	`ktime_to_ms
(
	`ktime_g‘_»®
()));

2773 
»t
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_TIMESTAMP
, 0, &
ts
, (ts),

2774 
NULL
);

2775 ià(
»t
)

2776 
	`dev_w¬n_Úû
(
ù¾
->
deviû
,

2777 "could‚Ù s‘ime¡am°(%d)\n", 
»t
);

2778  
»t
;

2779 
	}
}

2781 
	$nvme_cÚfigu»_­¡
(
nvme_ù¾
 *
ù¾
)

2799 
­¡e
;

2800 
nvme_ã©_auto_p¡
 *
bË
;

2801 
u64
 
max_Ït_us
 = 0;

2802 
max_ps
 = -1;

2803 
»t
;

2809 ià(!
ù¾
->
­¡a
)

2812 ià(
ù¾
->
Åss
 > 31) {

2813 
	`dev_w¬n
(
ù¾
->
deviû
, "NPSS is invalid;‚ot using APST\n");

2817 
bË
 = 
	`kz®loc
((*bË), 
GFP_KERNEL
);

2818 ià(!
bË
)

2821 ià(!
ù¾
->
­¡_’abËd
 || cŒl->
ps_max_Ï‹ncy_us
 == 0) {

2823 
­¡e
 = 0;

2824 
	`dev_dbg
(
ù¾
->
deviû
, "APST disabled\n");

2826 
__Ë64
 
rg‘
 = 
	`ıu_to_Ë64
(0);

2827 
¡©e
;

2835 
¡©e
 = ()
ù¾
->
Åss
; state >= 0; state--) {

2836 
u64
 
tÙ®_Ï‹ncy_us
, 
ex™_Ï‹ncy_us
, 
Œªs™iÚ_ms
;

2838 ià(
rg‘
)

2839 
bË
->
’Œ›s
[
¡©e
] = 
rg‘
;

2845 ià(
¡©e
 =ğ
ù¾
->
Åss
 &&

2846 (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
))

2853 ià(!(
ù¾
->
psd
[
¡©e
].
æags
 &

2854 
NVME_PS_FLAGS_NON_OP_STATE
))

2857 
ex™_Ï‹ncy_us
 =

2858 (
u64
)
	`Ë32_to_ıu
(
ù¾
->
psd
[
¡©e
].
ex™_Ït
);

2859 ià(
ex™_Ï‹ncy_us
 > 
ù¾
->
ps_max_Ï‹ncy_us
)

2862 
tÙ®_Ï‹ncy_us
 =

2863 
ex™_Ï‹ncy_us
 +

2864 
	`Ë32_to_ıu
(
ù¾
->
psd
[
¡©e
].
’Œy_Ït
);

2870 
Œªs™iÚ_ms
 = 
tÙ®_Ï‹ncy_us
 + 19;

2871 
	`do_div
(
Œªs™iÚ_ms
, 20);

2872 ià(
Œªs™iÚ_ms
 > (1 << 24) - 1)

2873 
Œªs™iÚ_ms
 = (1 << 24) - 1;

2875 
rg‘
 = 
	`ıu_to_Ë64
((
¡©e
 << 3) |

2876 (
Œªs™iÚ_ms
 << 8));

2878 ià(
max_ps
 == -1)

2879 
max_ps
 = 
¡©e
;

2881 ià(
tÙ®_Ï‹ncy_us
 > 
max_Ït_us
)

2882 
max_Ït_us
 = 
tÙ®_Ï‹ncy_us
;

2885 
­¡e
 = 1;

2887 ià(
max_ps
 == -1) {

2888 
	`dev_dbg
(
ù¾
->
deviû
, "APSTƒnabled but‚o‚on-operational states‡re‡vailable\n");

2890 
	`dev_dbg
(
ù¾
->
deviû
, "APSTƒnabled: max PS = %d, max„ound-trip†atency = %lluus,able = %*phN\n",

2891 
max_ps
, 
max_Ït_us
, ()(*
bË
),able);

2895 
»t
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_AUTO_PST
, 
­¡e
,

2896 
bË
, (*bË), 
NULL
);

2897 ià(
»t
)

2898 
	`dev_”r
(
ù¾
->
deviû
, "çedØ£ˆAPST f—tu» (%d)\n", 
»t
);

2900 
	`kä“
(
bË
);

2901  
»t
;

2902 
	}
}

2904 
	$nvme_£t_Ï‹ncy_tŞ”ªû
(
deviû
 *
dev
, 
s32
 
v®
)

2906 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2907 
u64
 
Ï‹ncy
;

2909 
v®
) {

2910 
PM_QOS_LATENCY_TOLERANCE_NO_CONSTRAINT
:

2911 
PM_QOS_LATENCY_ANY
:

2912 
Ï‹ncy
 = 
U64_MAX
;

2916 
Ï‹ncy
 = 
v®
;

2919 ià(
ù¾
->
ps_max_Ï‹ncy_us
 !ğ
Ï‹ncy
) {

2920 
ù¾
->
ps_max_Ï‹ncy_us
 = 
Ï‹ncy
;

2921 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2923 
	}
}

2925 
	snvme_cÜe_quœk_’Œy
 {

2931 
u16
 
	mvid
;

2932 cÚ¡ *
	mmn
;

2933 cÚ¡ *
	mä
;

2934 
	mquœks
;

2937 cÚ¡ 
nvme_cÜe_quœk_’Œy
 
	gcÜe_quœks
[] = {

2943 .
vid
 = 0x1179,

2944 .
	gmn
 = "THNSF5256GPUK TOSHIBA",

2945 .
	gquœks
 = 
NVME_QUIRK_NO_APST
,

2950 
boŞ
 
	$¡ršg_m©ches
(cÚ¡ *
id¡r
, cÚ¡ *
m©ch
, 
size_t
 
Ën
)

2952 
size_t
 
m©chËn
;

2954 ià(!
m©ch
)

2955  
Œue
;

2957 
m©chËn
 = 
	`¡¾’
(
m©ch
);

2958 
	`WARN_ON_ONCE
(
m©chËn
 > 
Ën
);

2960 ià(
	`memcmp
(
id¡r
, 
m©ch
, 
m©chËn
))

2961  
çl£
;

2963 ; 
m©chËn
 < 
Ën
; matchlen++)

2964 ià(
id¡r
[
m©chËn
] != ' ')

2965  
çl£
;

2967  
Œue
;

2968 
	}
}

2970 
boŞ
 
	$quœk_m©ches
(cÚ¡ 
nvme_id_ù¾
 *
id
,

2971 cÚ¡ 
nvme_cÜe_quœk_’Œy
 *
q
)

2973  
q
->
vid
 =ğ
	`Ë16_to_ıu
(
id
->vid) &&

2974 
	`¡ršg_m©ches
(
id
->
mn
, 
q
->mn, (id->mn)) &&

2975 
	`¡ršg_m©ches
(
id
->
ä
, 
q
->fr, (id->fr));

2976 
	}
}

2978 
	$nvme_š™_subnqn
(
nvme_subsy¡em
 *
subsys
, 
nvme_ù¾
 *
ù¾
,

2979 
nvme_id_ù¾
 *
id
)

2981 
size_t
 
nqÆ’
;

2982 
off
;

2984 
nqÆ’
 = 
	`¡ºËn
(
id
->
subnqn
, 
NVMF_NQN_SIZE
);

2985 ià(
nqÆ’
 > 0 &&‚qÆ’ < 
NVMF_NQN_SIZE
) {

2986 
	`¡ºıy
(
subsys
->
subnqn
, 
id
->subnqn, 
NVMF_NQN_SIZE
);

2990 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 1))

2991 
	`dev_w¬n
(
ù¾
->
deviû
, "missing or invalid SUBNQN field.\n");

2994 
off
 = 
	`¢´štf
(
subsys
->
subnqn
, 
NVMF_NQN_SIZE
,

2996 
	`Ë16_to_ıu
(
id
->
vid
),†e16_to_ıu(id->
ssvid
));

2997 
	`memıy
(
subsys
->
subnqn
 + 
off
, 
id
->
¢
, (id->sn));

2998 
off
 +ğ(
id
->
¢
);

2999 
	`memıy
(
subsys
->
subnqn
 + 
off
, 
id
->
mn
, (id->mn));

3000 
off
 +ğ(
id
->
mn
);

3001 
	`mem£t
(
subsys
->
subnqn
 + 
off
, 0, (subsys->subnqn) - off);

3002 
	}
}

3004 
	$__nvme_»Ëa£_subsy¡em
(
nvme_subsy¡em
 *
subsys
)

3006 
	`ida_sim¶e_»move
(&
nvme_subsy¡ems_ida
, 
subsys
->
š¡ªû
);

3007 
	`kä“
(
subsys
);

3008 
	}
}

3010 
	$nvme_»Ëa£_subsy¡em
(
deviû
 *
dev
)

3012 
	`__nvme_»Ëa£_subsy¡em
(
	`cÚš”_of
(
dev
, 
nvme_subsy¡em
, dev));

3013 
	}
}

3015 
	$nvme_de¡roy_subsy¡em
(
k»f
 *
»f
)

3017 
nvme_subsy¡em
 *
subsys
 =

3018 
	`cÚš”_of
(
»f
, 
nvme_subsy¡em
,„ef);

3020 
	`mu‹x_lock
(&
nvme_subsy¡ems_lock
);

3021 
	`li¡_d–
(&
subsys
->
’Œy
);

3022 
	`mu‹x_uÆock
(&
nvme_subsy¡ems_lock
);

3024 
	`ida_de¡roy
(&
subsys
->
ns_ida
);

3025 
	`deviû_d–
(&
subsys
->
dev
);

3026 
	`put_deviû
(&
subsys
->
dev
);

3027 
	}
}

3029 
	$nvme_put_subsy¡em
(
nvme_subsy¡em
 *
subsys
)

3031 
	`k»f_put
(&
subsys
->
»f
, 
nvme_de¡roy_subsy¡em
);

3032 
	}
}

3034 
nvme_subsy¡em
 *
	$__nvme_fšd_g‘_subsy¡em
(cÚ¡ *
subsy¢qn
)

3036 
nvme_subsy¡em
 *
subsys
;

3038 
	`lockd•_as£¹_h–d
(&
nvme_subsy¡ems_lock
);

3040 
	`li¡_fÜ_—ch_’Œy
(
subsys
, &
nvme_subsy¡ems
, 
’Œy
) {

3041 ià(
	`¡rcmp
(
subsys
->
subnqn
, 
subsy¢qn
))

3043 ià(!
	`k»f_g‘_uÆess_z”o
(&
subsys
->
»f
))

3045  
subsys
;

3048  
NULL
;

3049 
	}
}

3051 
	#SUBSYS_ATTR_RO
(
_Çme
, 
_mode
, 
_show
) \

3052 
deviû_©Œibu‹
 
subsys_©Œ_
##
_Çme
 = \

3053 
	`__ATTR
(
_Çme
, 
_mode
, 
_show
, 
NULL
)

	)

3055 
ssize_t
 
	$nvme_subsys_show_nqn
(
deviû
 *
dev
,

3056 
deviû_©Œibu‹
 *
©Œ
,

3057 *
buf
)

3059 
nvme_subsy¡em
 *
subsys
 =

3060 
	`cÚš”_of
(
dev
, 
nvme_subsy¡em
, dev);

3062  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
subsys
->
subnqn
);

3063 
	}
}

3064 
SUBSYS_ATTR_RO
(
subsy¢qn
, 
S_IRUGO
, 
nvme_subsys_show_nqn
);

3066 
	#nvme_subsys_show_¡r_funùiÚ
(
f›ld
) \

3067 
ssize_t
 
subsys_
##
f›ld
##
	`_show
(
deviû
 *
dev
, \

3068 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

3070 
nvme_subsy¡em
 *
subsys
 = \

3071 
	`cÚš”_of
(
dev
, 
nvme_subsy¡em
, dev); \

3072  
	`¥rštf
(
buf
, "%.*s\n", \

3073 ()(
subsys
->
f›ld
), subsys->field); \

3075 
	`SUBSYS_ATTR_RO
(
f›ld
, 
S_IRUGO
, 
subsys_
##f›ld##
_show
);

	)

3077 
nvme_subsys_show_¡r_funùiÚ
(
mod–
);

3078 
nvme_subsys_show_¡r_funùiÚ
(
£rŸl
);

3079 
nvme_subsys_show_¡r_funùiÚ
(
fœmw¬e_»v
);

3081 
©Œibu‹
 *
	gnvme_subsys_©Œs
[] = {

3082 &
subsys_©Œ_mod–
.
©Œ
,

3083 &
subsys_©Œ_£rŸl
.
©Œ
,

3084 &
subsys_©Œ_fœmw¬e_»v
.
©Œ
,

3085 &
subsys_©Œ_subsy¢qn
.
©Œ
,

3086 
NULL
,

3089 
©Œibu‹_group
 
	gnvme_subsys_©Œs_group
 = {

3090 .
©Œs
 = 
nvme_subsys_©Œs
,

3093 cÚ¡ 
©Œibu‹_group
 *
	gnvme_subsys_©Œs_groups
[] = {

3094 &
nvme_subsys_©Œs_group
,

3095 
NULL
,

3098 
	$nvme_aùive_ù¾s
(
nvme_subsy¡em
 *
subsys
)

3100 
couÁ
 = 0;

3101 
nvme_ù¾
 *
ù¾
;

3103 
	`mu‹x_lock
(&
subsys
->
lock
);

3104 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
subsys
->
ù¾s
, 
subsys_’Œy
) {

3105 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_DELETING
 &&

3106 
ù¾
->
¡©e
 !ğ
NVME_CTRL_DEAD
)

3107 
couÁ
++;

3109 
	`mu‹x_uÆock
(&
subsys
->
lock
);

3111  
couÁ
;

3112 
	}
}

3114 
	$nvme_š™_subsy¡em
(
nvme_ù¾
 *
ù¾
, 
nvme_id_ù¾
 *
id
)

3116 
nvme_subsy¡em
 *
subsys
, *
found
;

3117 
»t
;

3119 
subsys
 = 
	`kz®loc
((*subsys), 
GFP_KERNEL
);

3120 ià(!
subsys
)

3121  -
ENOMEM
;

3122 
»t
 = 
	`ida_sim¶e_g‘
(&
nvme_subsy¡ems_ida
, 0, 0, 
GFP_KERNEL
);

3123 ià(
»t
 < 0) {

3124 
	`kä“
(
subsys
);

3125  
»t
;

3127 
subsys
->
š¡ªû
 = 
»t
;

3128 
	`mu‹x_š™
(&
subsys
->
lock
);

3129 
	`k»f_š™
(&
subsys
->
»f
);

3130 
	`INIT_LIST_HEAD
(&
subsys
->
ù¾s
);

3131 
	`INIT_LIST_HEAD
(&
subsys
->
nsh—ds
);

3132 
	`nvme_š™_subnqn
(
subsys
, 
ù¾
, 
id
);

3133 
	`memıy
(
subsys
->
£rŸl
, 
id
->
¢
, (subsys->serial));

3134 
	`memıy
(
subsys
->
mod–
, 
id
->
mn
, (subsys->model));

3135 
	`memıy
(
subsys
->
fœmw¬e_»v
, 
id
->
ä
, (subsys->firmware_rev));

3136 
subsys
->
v’dÜ_id
 = 
	`Ë16_to_ıu
(
id
->
vid
);

3137 
subsys
->
cmic
 = 
id
->cmic;

3139 
subsys
->
dev
.
şass
 = 
nvme_subsys_şass
;

3140 
subsys
->
dev
.
»Ëa£
 = 
nvme_»Ëa£_subsy¡em
;

3141 
subsys
->
dev
.
groups
 = 
nvme_subsys_©Œs_groups
;

3142 
	`dev_£t_Çme
(&
subsys
->
dev
, "nvme-subsys%d", subsys->
š¡ªû
);

3143 
	`deviû_š™Ÿlize
(&
subsys
->
dev
);

3145 
	`mu‹x_lock
(&
nvme_subsy¡ems_lock
);

3146 
found
 = 
	`__nvme_fšd_g‘_subsy¡em
(
subsys
->
subnqn
);

3147 ià(
found
) {

3152 ià(
	`nvme_aùive_ù¾s
(
found
è&& !(
id
->
cmic
 & (1 << 1))) {

3153 
	`dev_”r
(
ù¾
->
deviû
,

3155 
found
->
subnqn
);

3156 
	`nvme_put_subsy¡em
(
found
);

3157 
»t
 = -
EINVAL
;

3158 
out_uÆock
;

3161 
	`__nvme_»Ëa£_subsy¡em
(
subsys
);

3162 
subsys
 = 
found
;

3164 
»t
 = 
	`deviû_add
(&
subsys
->
dev
);

3165 ià(
»t
) {

3166 
	`dev_”r
(
ù¾
->
deviû
,

3168 
out_uÆock
;

3170 
	`ida_š™
(&
subsys
->
ns_ida
);

3171 
	`li¡_add_
(&
subsys
->
’Œy
, &
nvme_subsy¡ems
);

3174 
ù¾
->
subsys
 = subsys;

3175 
	`mu‹x_uÆock
(&
nvme_subsy¡ems_lock
);

3177 ià(
	`sysfs_ü—‹_lšk
(&
subsys
->
dev
.
kobj
, &
ù¾
->
deviû
->kobj,

3178 
	`dev_Çme
(
ù¾
->
deviû
))) {

3179 
	`dev_”r
(
ù¾
->
deviû
,

3182  -
EINVAL
;

3185 
	`mu‹x_lock
(&
subsys
->
lock
);

3186 
	`li¡_add_
(&
ù¾
->
subsys_’Œy
, &
subsys
->
ù¾s
);

3187 
	`mu‹x_uÆock
(&
subsys
->
lock
);

3191 
out_uÆock
:

3192 
	`mu‹x_uÆock
(&
nvme_subsy¡ems_lock
);

3193 
	`put_deviû
(&
subsys
->
dev
);

3194  
»t
;

3195 
	}
}

3197 
	$nvme_g‘_log
(
nvme_ù¾
 *
ù¾
, 
u8
 
log_·ge
, *
log
,

3198 
size_t
 
size
)

3200 
nvme_commªd
 
c
 = { };

3202 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
;

3203 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
NVME_NSID_ALL
);

3204 
c
.
commÚ
.
cdw10
[0] = 
	`nvme_g‘_log_dw10
(
log_·ge
, 
size
);

3206  
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
c
, 
log
, 
size
);

3207 
	}
}

3209 
	$nvme_g‘_efãùs_log
(
nvme_ù¾
 *
ù¾
)

3211 
»t
;

3213 ià(!
ù¾
->
efãùs
)

3214 
ù¾
->
efãùs
 = 
	`kz®loc
((*ù¾->efãùs), 
GFP_KERNEL
);

3216 ià(!
ù¾
->
efãùs
)

3219 
»t
 = 
	`nvme_g‘_log
(
ù¾
, 
NVME_LOG_CMD_EFFECTS
, cŒl->
efãùs
,

3220 (*
ù¾
->
efãùs
));

3221 ià(
»t
) {

3222 
	`kä“
(
ù¾
->
efãùs
);

3223 
ù¾
->
efãùs
 = 
NULL
;

3225  
»t
;

3226 
	}
}

3233 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

3235 
nvme_id_ù¾
 *
id
;

3236 
u64
 
ÿp
;

3237 
»t
, 
·ge_shiá
;

3238 
u32
 
max_hw_£ùÜs
;

3239 
boŞ
 
´ev_­¡_’abËd
;

3241 
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

3242 ià(
»t
) {

3243 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg VS faed (%d)\n", 
»t
);

3244  
»t
;

3247 
»t
 = 
ù¾
->
İs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

3248 ià(
»t
) {

3249 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg CAP faed (%d)\n", 
»t
);

3250  
»t
;

3252 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

3254 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

3255 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

3257 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

3258 ià(
»t
) {

3259 
	`dev_”r
(
ù¾
->
deviû
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»t
);

3260  -
EIO
;

3263 ià(
id
->
Ía
 & 
NVME_CTRL_LPA_CMD_EFFECTS_LOG
) {

3264 
»t
 = 
	`nvme_g‘_efãùs_log
(
ù¾
);

3265 ià(
»t
 < 0)

3266  
»t
;

3269 ià(!
ù¾
->
id’tif›d
) {

3270 
i
;

3272 
»t
 = 
	`nvme_š™_subsy¡em
(
ù¾
, 
id
);

3273 ià(
»t
)

3274 
out_ä“
;

3284 
i
 = 0; i < 
	`ARRAY_SIZE
(
cÜe_quœks
); i++) {

3285 ià(
	`quœk_m©ches
(
id
, &
cÜe_quœks
[
i
]))

3286 
ù¾
->
quœks
 |ğ
cÜe_quœks
[
i
].quirks;

3290 ià(
fÜû_­¡
 && (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
)) {

3291 
	`dev_w¬n
(
ù¾
->
deviû
, "forcibly‡llowing‡ll…ower states dueo‚vme_core.force_apst -- use‡t your own„isk\n");

3292 
ù¾
->
quœks
 &ğ~
NVME_QUIRK_NO_DEEPEST_PS
;

3295 
ù¾
->
ßcs
 = 
	`Ë16_to_ıu
(
id
->oacs);

3296 
ù¾
->
Úcs
 = 
	`Ë16_to_ıup
(&
id
->oncs);

3297 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aş
 + 1);

3298 
ù¾
->
vwc
 = 
id
->vwc;

3299 
ù¾
->
úid
 = 
	`Ë16_to_ıup
(&
id
->cntlid);

3300 ià(
id
->
mdts
)

3301 
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

3303 
max_hw_£ùÜs
 = 
UINT_MAX
;

3304 
ù¾
->
max_hw_£ùÜs
 =

3305 
	`mš_nÙ_z”o
(
ù¾
->
max_hw_£ùÜs
, max_hw_sectors);

3307 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

3308 
ù¾
->
sgls
 = 
	`Ë32_to_ıu
(
id
->sgls);

3309 
ù¾
->
kas
 = 
	`Ë16_to_ıu
(
id
->kas);

3311 ià(
id
->
¹d3e
) {

3313 
u32
 
Œªs™iÚ_time
 = 
	`Ë32_to_ıu
(
id
->
¹d3e
) / 1000000;

3315 
ù¾
->
shutdown_timeout
 = 
	`şamp_t
(, 
Œªs™iÚ_time
,

3316 
shutdown_timeout
, 60);

3318 ià(
ù¾
->
shutdown_timeout
 != shutdown_timeout)

3319 
	`dev_w¬n
(
ù¾
->
deviû
,

3321 
ù¾
->
shutdown_timeout
);

3323 
ù¾
->
shutdown_timeout
 = shutdown_timeout;

3325 
ù¾
->
Åss
 = 
id
->npss;

3326 
ù¾
->
­¡a
 = 
id
->apsta;

3327 
´ev_­¡_’abËd
 = 
ù¾
->
­¡_’abËd
;

3328 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_NO_APST
) {

3329 ià(
fÜû_­¡
 && 
id
->
­¡a
) {

3330 
	`dev_w¬n
(
ù¾
->
deviû
, "forcibly‡llowing APST dueo‚vme_core.force_apst -- use‡t your own„isk\n");

3331 
ù¾
->
­¡_’abËd
 = 
Œue
;

3333 
ù¾
->
­¡_’abËd
 = 
çl£
;

3336 
ù¾
->
­¡_’abËd
 = 
id
->
­¡a
;

3338 
	`memıy
(
ù¾
->
psd
, 
id
->psd, (ctrl->psd));

3340 ià(
ù¾
->
İs
->
æags
 & 
NVME_F_FABRICS
) {

3341 
ù¾
->
icdoff
 = 
	`Ë16_to_ıu
(
id
->icdoff);

3342 
ù¾
->
ioccsz
 = 
	`Ë32_to_ıu
(
id
->ioccsz);

3343 
ù¾
->
iÜcsz
 = 
	`Ë32_to_ıu
(
id
->iorcsz);

3344 
ù¾
->
maxcmd
 = 
	`Ë16_to_ıu
(
id
->maxcmd);

3350 ià(
ù¾
->
úid
 !ğ
	`Ë16_to_ıu
(
id
->cntlid)) {

3351 
»t
 = -
EINVAL
;

3352 
out_ä“
;

3355 ià(!
ù¾
->
İts
->
discov”y_nqn
 && !ù¾->
kas
) {

3356 
	`dev_”r
(
ù¾
->
deviû
,

3358 
»t
 = -
EINVAL
;

3359 
out_ä“
;

3362 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
id
->cntlid);

3363 
ù¾
->
hm´e
 = 
	`Ë32_to_ıu
(
id
->hmpre);

3364 
ù¾
->
hmmš
 = 
	`Ë32_to_ıu
(
id
->hmmin);

3365 
ù¾
->
hmmšds
 = 
	`Ë32_to_ıu
(
id
->hmminds);

3366 
ù¾
->
hmmaxd
 = 
	`Ë16_to_ıu
(
id
->hmmaxd);

3369 
	`kä“
(
id
);

3371 ià(
ù¾
->
­¡_’abËd
 && !
´ev_­¡_’abËd
)

3372 
	`dev_pm_qos_expo£_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
);

3373 ià(!
ù¾
->
­¡_’abËd
 && 
´ev_­¡_’abËd
)

3374 
	`dev_pm_qos_hide_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
);

3376 
»t
 = 
	`nvme_cÚfigu»_­¡
(
ù¾
);

3377 ià(
»t
 < 0)

3378  
»t
;

3380 
»t
 = 
	`nvme_cÚfigu»_time¡amp
(
ù¾
);

3381 ià(
»t
 < 0)

3382  
»t
;

3384 
»t
 = 
	`nvme_cÚfigu»_dœeùives
(
ù¾
);

3385 ià(
»t
 < 0)

3386  
»t
;

3388 
ù¾
->
id’tif›d
 = 
Œue
;

3392 
out_ä“
:

3393 
	`kä“
(
id
);

3394  
»t
;

3395 
	}
}

3396 
EXPORT_SYMBOL_GPL
(
nvme_š™_id’tify
);

3398 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *file)

3400 
nvme_ù¾
 *
ù¾
 =

3401 
	`cÚš”_of
(
šode
->
i_cdev
, 
nvme_ù¾
, 
cdev
);

3403 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
)

3404  -
EWOULDBLOCK
;

3405 
fe
->
´iv©e_d©a
 = 
ù¾
;

3407 
	}
}

3409 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

3411 
nvme_ns
 *
ns
;

3412 
»t
;

3414 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3415 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

3416 
»t
 = -
ENOTTY
;

3417 
out_uÆock
;

3420 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

3421 ià(
ns
 !ğ
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

3422 
	`dev_w¬n
(
ù¾
->
deviû
,

3424 
»t
 = -
EINVAL
;

3425 
out_uÆock
;

3428 
	`dev_w¬n
(
ù¾
->
deviû
,

3430 
	`k»f_g‘
(&
ns
->
k»f
);

3431 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3433 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

3434 
	`nvme_put_ns
(
ns
);

3435  
»t
;

3437 
out_uÆock
:

3438 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3439  
»t
;

3440 
	}
}

3442 
	$nvme_dev_ioùl
(
fe
 *fe, 
cmd
,

3443 
¬g
)

3445 
nvme_ù¾
 *
ù¾
 = 
fe
->
´iv©e_d©a
;

3446 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

3448 
cmd
) {

3449 
NVME_IOCTL_ADMIN_CMD
:

3450  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

3451 
NVME_IOCTL_IO_CMD
:

3452  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

3453 
NVME_IOCTL_RESET
:

3454 
	`dev_w¬n
(
ù¾
->
deviû
, "resetting controller\n");

3455  
	`nvme_»£t_ù¾_sync
(
ù¾
);

3456 
NVME_IOCTL_SUBSYS_RESET
:

3457  
	`nvme_»£t_subsy¡em
(
ù¾
);

3458 
NVME_IOCTL_RESCAN
:

3459 
	`nvme_queue_sÿn
(
ù¾
);

3462  -
ENOTTY
;

3464 
	}
}

3466 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

3467 .
owÃr
 = 
THIS_MODULE
,

3468 .
	gİ’
 = 
nvme_dev_İ’
,

3469 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

3470 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

3473 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

3474 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3475 
size_t
 
couÁ
)

3477 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3478 
»t
;

3480 
»t
 = 
	`nvme_»£t_ù¾_sync
(
ù¾
);

3481 ià(
»t
 < 0)

3482  
»t
;

3483  
couÁ
;

3484 
	}
}

3485 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

3487 
ssize_t
 
	$nvme_sysfs_»sÿn
(
deviû
 *
dev
,

3488 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3489 
size_t
 
couÁ
)

3491 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3493 
	`nvme_queue_sÿn
(
ù¾
);

3494  
couÁ
;

3495 
	}
}

3496 
DEVICE_ATTR
(
»sÿn_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»sÿn
);

3498 
šlše
 
nvme_ns_h—d
 *
	$dev_to_ns_h—d
(
deviû
 *
dev
)

3500 
g’disk
 *
disk
 = 
	`dev_to_disk
(
dev
);

3502 ià(
disk
->
fİs
 =ğ&
nvme_fİs
)

3503  
	`nvme_g‘_ns_äom_dev
(
dev
)->
h—d
;

3505  
disk
->
´iv©e_d©a
;

3506 
	}
}

3508 
ssize_t
 
	$wwid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3509 *
buf
)

3511 
nvme_ns_h—d
 *
h—d
 = 
	`dev_to_ns_h—d
(
dev
);

3512 
nvme_ns_ids
 *
ids
 = &
h—d
->ids;

3513 
nvme_subsy¡em
 *
subsys
 = 
h—d
->subsys;

3514 
£rŸl_Ën
 = (
subsys
->
£rŸl
);

3515 
mod–_Ën
 = (
subsys
->
mod–
);

3517 ià(!
	`uuid_is_nuÎ
(&
ids
->
uuid
))

3518  
	`¥rštf
(
buf
, "uuid.%pU\n", &
ids
->
uuid
);

3520 ià(
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)))

3521  
	`¥rštf
(
buf
, "eui.%16phN\n", 
ids
->
nguid
);

3523 ià(
	`memchr_šv
(
ids
->
eui64
, 0, (ids->eui64)))

3524  
	`¥rštf
(
buf
, "eui.%8phN\n", 
ids
->
eui64
);

3526 
£rŸl_Ën
 > 0 && (
subsys
->
£rŸl
[serial_len - 1] == ' ' ||

3527 
subsys
->
£rŸl
[
£rŸl_Ën
 - 1] == '\0'))

3528 
£rŸl_Ën
--;

3529 
mod–_Ën
 > 0 && (
subsys
->
mod–
[model_len - 1] == ' ' ||

3530 
subsys
->
mod–
[
mod–_Ën
 - 1] == '\0'))

3531 
mod–_Ën
--;

3533  
	`¥rštf
(
buf
, "nvme.%04x-%*phN-%*phN-%08x\n", 
subsys
->
v’dÜ_id
,

3534 
£rŸl_Ën
, 
subsys
->
£rŸl
, 
mod–_Ën
, subsys->
mod–
,

3535 
h—d
->
ns_id
);

3536 
	}
}

3537 
DEVICE_ATTR
(
wwid
, 
S_IRUGO
, 
wwid_show
, 
NULL
);

3539 
ssize_t
 
	$nguid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3540 *
buf
)

3542  
	`¥rštf
(
buf
, "%pU\n", 
	`dev_to_ns_h—d
(
dev
)->
ids
.
nguid
);

3543 
	}
}

3544 
DEVICE_ATTR
(
nguid
, 
S_IRUGO
, 
nguid_show
, 
NULL
);

3546 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3547 *
buf
)

3549 
nvme_ns_ids
 *
ids
 = &
	`dev_to_ns_h—d
(
dev
)->ids;

3554 ià(
	`uuid_is_nuÎ
(&
ids
->
uuid
)) {

3555 
	`´štk_¿‹lim™ed
(
KERN_WARNING


3557  
	`¥rštf
(
buf
, "%pU\n", 
ids
->
nguid
);

3559  
	`¥rštf
(
buf
, "%pU\n", &
ids
->
uuid
);

3560 
	}
}

3561 
DEVICE_ATTR
(
uuid
, 
S_IRUGO
, 
uuid_show
, 
NULL
);

3563 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3564 *
buf
)

3566  
	`¥rštf
(
buf
, "%8ph\n", 
	`dev_to_ns_h—d
(
dev
)->
ids
.
eui64
);

3567 
	}
}

3568 
DEVICE_ATTR
(
eui
, 
S_IRUGO
, 
eui_show
, 
NULL
);

3570 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

3571 *
buf
)

3573  
	`¥rštf
(
buf
, "%d\n", 
	`dev_to_ns_h—d
(
dev
)->
ns_id
);

3574 
	}
}

3575 
DEVICE_ATTR
(
nsid
, 
S_IRUGO
, 
nsid_show
, 
NULL
);

3577 
©Œibu‹
 *
	gnvme_ns_id_©Œs
[] = {

3578 &
dev_©Œ_wwid
.
©Œ
,

3579 &
dev_©Œ_uuid
.
©Œ
,

3580 &
dev_©Œ_nguid
.
©Œ
,

3581 &
dev_©Œ_eui
.
©Œ
,

3582 &
dev_©Œ_nsid
.
©Œ
,

3583 
NULL
,

3586 
umode_t
 
	$nvme_ns_id_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

3587 
©Œibu‹
 *
a
, 
n
)

3589 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

3590 
nvme_ns_ids
 *
ids
 = &
	`dev_to_ns_h—d
(
dev
)->ids;

3592 ià(
a
 =ğ&
dev_©Œ_uuid
.
©Œ
) {

3593 ià(
	`uuid_is_nuÎ
(&
ids
->
uuid
) &&

3594 !
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)))

3597 ià(
a
 =ğ&
dev_©Œ_nguid
.
©Œ
) {

3598 ià(!
	`memchr_šv
(
ids
->
nguid
, 0, (ids->nguid)))

3601 ià(
a
 =ğ&
dev_©Œ_eui
.
©Œ
) {

3602 ià(!
	`memchr_šv
(
ids
->
eui64
, 0, (ids->eui64)))

3605  
a
->
mode
;

3606 
	}
}

3608 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_id_©Œ_group
 = {

3609 .
©Œs
 = 
nvme_ns_id_©Œs
,

3610 .
	gis_visibË
 = 
nvme_ns_id_©Œs_¬e_visibË
,

3613 
	#nvme_show_¡r_funùiÚ
(
f›ld
) \

3614 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

3615 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

3617 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

3618  
	`¥rštf
(
buf
, "%.*s\n", \

3619 ()(
ù¾
->
subsys
->
f›ld
), ctrl->subsys->field); \

3621 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

3623 
nvme_show_¡r_funùiÚ
(
mod–
);

3624 
nvme_show_¡r_funùiÚ
(
£rŸl
);

3625 
nvme_show_¡r_funùiÚ
(
fœmw¬e_»v
);

3627 
	#nvme_show_št_funùiÚ
(
f›ld
) \

3628 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

3629 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

3631 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

3632  
	`¥rštf
(
buf
, "%d\n", 
ù¾
->
f›ld
); \

3634 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

3636 
nvme_show_št_funùiÚ
(
úid
);

3638 
ssize_t
 
	$nvme_sysfs_d–‘e
(
deviû
 *
dev
,

3639 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

3640 
size_t
 
couÁ
)

3642 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3644 ià(
	`deviû_»move_fe_£lf
(
dev
, 
©Œ
))

3645 
	`nvme_d–‘e_ù¾_sync
(
ù¾
);

3646  
couÁ
;

3647 
	}
}

3648 
DEVICE_ATTR
(
d–‘e_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_d–‘e
);

3650 
ssize_t
 
	$nvme_sysfs_show_Œª¥Üt
(
deviû
 *
dev
,

3651 
deviû_©Œibu‹
 *
©Œ
,

3652 *
buf
)

3654 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3656  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
İs
->
Çme
);

3657 
	}
}

3658 
DEVICE_ATTR
(
Œª¥Üt
, 
S_IRUGO
, 
nvme_sysfs_show_Œª¥Üt
, 
NULL
);

3660 
ssize_t
 
	$nvme_sysfs_show_¡©e
(
deviû
 *
dev
,

3661 
deviû_©Œibu‹
 *
©Œ
,

3662 *
buf
)

3664 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3665 cÚ¡ *cÚ¡ 
¡©e_Çme
[] = {

3666 [
NVME_CTRL_NEW
] = "new",

3667 [
NVME_CTRL_LIVE
] = "live",

3668 [
NVME_CTRL_RESETTING
] = "resetting",

3669 [
NVME_CTRL_RECONNECTING
]= "reconnecting",

3670 [
NVME_CTRL_DELETING
] = "deleting",

3671 [
NVME_CTRL_DEAD
] = "dead",

3674 ià(()
ù¾
->
¡©e
 < 
	`ARRAY_SIZE
(
¡©e_Çme
) &&

3675 
¡©e_Çme
[
ù¾
->
¡©e
])

3676  
	`¥rštf
(
buf
, "%s\n", 
¡©e_Çme
[
ù¾
->
¡©e
]);

3678  
	`¥rštf
(
buf
, "unknown state\n");

3679 
	}
}

3681 
DEVICE_ATTR
(
¡©e
, 
S_IRUGO
, 
nvme_sysfs_show_¡©e
, 
NULL
);

3683 
ssize_t
 
	$nvme_sysfs_show_subsy¢qn
(
deviû
 *
dev
,

3684 
deviû_©Œibu‹
 *
©Œ
,

3685 *
buf
)

3687 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3689  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
subsys
->
subnqn
);

3690 
	}
}

3691 
DEVICE_ATTR
(
subsy¢qn
, 
S_IRUGO
, 
nvme_sysfs_show_subsy¢qn
, 
NULL
);

3693 
ssize_t
 
	$nvme_sysfs_show_add»ss
(
deviû
 *
dev
,

3694 
deviû_©Œibu‹
 *
©Œ
,

3695 *
buf
)

3697 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3699  
ù¾
->
İs
->
	`g‘_add»ss
(ù¾, 
buf
, 
PAGE_SIZE
);

3700 
	}
}

3701 
DEVICE_ATTR
(
add»ss
, 
S_IRUGO
, 
nvme_sysfs_show_add»ss
, 
NULL
);

3703 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

3704 &
dev_©Œ_»£t_cÚŒŞËr
.
©Œ
,

3705 &
dev_©Œ_»sÿn_cÚŒŞËr
.
©Œ
,

3706 &
dev_©Œ_mod–
.
©Œ
,

3707 &
dev_©Œ_£rŸl
.
©Œ
,

3708 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

3709 &
dev_©Œ_úid
.
©Œ
,

3710 &
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
,

3711 &
dev_©Œ_Œª¥Üt
.
©Œ
,

3712 &
dev_©Œ_subsy¢qn
.
©Œ
,

3713 &
dev_©Œ_add»ss
.
©Œ
,

3714 &
dev_©Œ_¡©e
.
©Œ
,

3715 
NULL


3718 
umode_t
 
	$nvme_dev_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

3719 
©Œibu‹
 *
a
, 
n
)

3721 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

3722 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

3724 ià(
a
 =ğ&
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
 && !
ù¾
->
İs
->
d–‘e_ù¾
)

3726 ià(
a
 =ğ&
dev_©Œ_add»ss
.
©Œ
 && !
ù¾
->
İs
->
g‘_add»ss
)

3729  
a
->
mode
;

3730 
	}
}

3732 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

3733 .
©Œs
 = 
nvme_dev_©Œs
,

3734 .
	gis_visibË
 = 
nvme_dev_©Œs_¬e_visibË
,

3737 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

3738 &
nvme_dev_©Œs_group
,

3739 
NULL
,

3742 
nvme_ns_h—d
 *
	$__nvme_fšd_ns_h—d
(
nvme_subsy¡em
 *
subsys
,

3743 
nsid
)

3745 
nvme_ns_h—d
 *
h
;

3747 
	`lockd•_as£¹_h–d
(&
subsys
->
lock
);

3749 
	`li¡_fÜ_—ch_’Œy
(
h
, &
subsys
->
nsh—ds
, 
’Œy
) {

3750 ià(
h
->
ns_id
 =ğ
nsid
 && 
	`k»f_g‘_uÆess_z”o
(&h->
»f
))

3751  
h
;

3754  
NULL
;

3755 
	}
}

3757 
	$__nvme_check_ids
(
nvme_subsy¡em
 *
subsys
,

3758 
nvme_ns_h—d
 *
Ãw
)

3760 
nvme_ns_h—d
 *
h
;

3762 
	`lockd•_as£¹_h–d
(&
subsys
->
lock
);

3764 
	`li¡_fÜ_—ch_’Œy
(
h
, &
subsys
->
nsh—ds
, 
’Œy
) {

3765 ià(
	`nvme_ns_ids_v®id
(&
Ãw
->
ids
) &&

3766 !
	`li¡_em±y
(&
h
->
li¡
) &&

3767 
	`nvme_ns_ids_equ®
(&
Ãw
->
ids
, &
h
->ids))

3768  -
EINVAL
;

3772 
	}
}

3774 
nvme_ns_h—d
 *
	$nvme_®loc_ns_h—d
(
nvme_ù¾
 *
ù¾
,

3775 
nsid
, 
nvme_id_ns
 *
id
)

3777 
nvme_ns_h—d
 *
h—d
;

3778 
»t
 = -
ENOMEM
;

3780 
h—d
 = 
	`kz®loc
((*h—d), 
GFP_KERNEL
);

3781 ià(!
h—d
)

3782 
out
;

3783 
»t
 = 
	`ida_sim¶e_g‘
(&
ù¾
->
subsys
->
ns_ida
, 1, 0, 
GFP_KERNEL
);

3784 ià(
»t
 < 0)

3785 
out_ä“_h—d
;

3786 
h—d
->
š¡ªû
 = 
»t
;

3787 
	`INIT_LIST_HEAD
(&
h—d
->
li¡
);

3788 
	`š™_¤cu_¡ruù
(&
h—d
->
¤cu
);

3789 
h—d
->
subsys
 = 
ù¾
->subsys;

3790 
h—d
->
ns_id
 = 
nsid
;

3791 
	`k»f_š™
(&
h—d
->
»f
);

3793 
	`nvme_»pÜt_ns_ids
(
ù¾
, 
nsid
, 
id
, &
h—d
->
ids
);

3795 
»t
 = 
	`__nvme_check_ids
(
ù¾
->
subsys
, 
h—d
);

3796 ià(
»t
) {

3797 
	`dev_”r
(
ù¾
->
deviû
,

3798 "du¶iÿ‹ ID fÜ‚sid %d\n", 
nsid
);

3799 
out_ş—nup_¤cu
;

3802 
»t
 = 
	`nvme_m·th_®loc_disk
(
ù¾
, 
h—d
);

3803 ià(
»t
)

3804 
out_ş—nup_¤cu
;

3806 
	`li¡_add_
(&
h—d
->
’Œy
, &
ù¾
->
subsys
->
nsh—ds
);

3807  
h—d
;

3808 
out_ş—nup_¤cu
:

3809 
	`ş—nup_¤cu_¡ruù
(&
h—d
->
¤cu
);

3810 
	`ida_sim¶e_»move
(&
ù¾
->
subsys
->
ns_ida
, 
h—d
->
š¡ªû
);

3811 
out_ä“_h—d
:

3812 
	`kä“
(
h—d
);

3813 
out
:

3814  
	`ERR_PTR
(
»t
);

3815 
	}
}

3817 
	$nvme_š™_ns_h—d
(
nvme_ns
 *
ns
, 
nsid
,

3818 
nvme_id_ns
 *
id
, 
boŞ
 *
Ãw
)

3820 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

3821 
boŞ
 
is_sh¬ed
 = 
id
->
nmic
 & (1 << 0);

3822 
nvme_ns_h—d
 *
h—d
 = 
NULL
;

3823 
»t
 = 0;

3825 
	`mu‹x_lock
(&
ù¾
->
subsys
->
lock
);

3826 ià(
is_sh¬ed
)

3827 
h—d
 = 
	`__nvme_fšd_ns_h—d
(
ù¾
->
subsys
, 
nsid
);

3828 ià(!
h—d
) {

3829 
h—d
 = 
	`nvme_®loc_ns_h—d
(
ù¾
, 
nsid
, 
id
);

3830 ià(
	`IS_ERR
(
h—d
)) {

3831 
»t
 = 
	`PTR_ERR
(
h—d
);

3832 
out_uÆock
;

3835 *
Ãw
 = 
Œue
;

3837 
nvme_ns_ids
 
ids
;

3839 
	`nvme_»pÜt_ns_ids
(
ù¾
, 
nsid
, 
id
, &
ids
);

3840 ià(!
	`nvme_ns_ids_equ®
(&
h—d
->
ids
, &ids)) {

3841 
	`dev_”r
(
ù¾
->
deviû
,

3843 
nsid
);

3844 
»t
 = -
EINVAL
;

3845 
out_uÆock
;

3848 *
Ãw
 = 
çl£
;

3851 
	`li¡_add_
(&
ns
->
siblšgs
, &
h—d
->
li¡
);

3852 
ns
->
h—d
 = head;

3854 
out_uÆock
:

3855 
	`mu‹x_uÆock
(&
ù¾
->
subsys
->
lock
);

3856  
»t
;

3857 
	}
}

3859 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

3861 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

3862 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

3864  
n§
->
h—d
->
ns_id
 - 
nsb
->head->ns_id;

3865 
	}
}

3867 
nvme_ns
 *
	$nvme_fšd_g‘_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3869 
nvme_ns
 *
ns
, *
»t
 = 
NULL
;

3871 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3872 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3873 ià(
ns
->
h—d
->
ns_id
 =ğ
nsid
) {

3874 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

3876 
»t
 = 
ns
;

3879 ià(
ns
->
h—d
->
ns_id
 > 
nsid
)

3882 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3883  
»t
;

3884 
	}
}

3886 
	$nvme_£tup_¡»ams_ns
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
)

3888 
¡»ams_dœeùive_·¿ms
 
s
;

3889 
»t
;

3891 ià(!
ù¾
->
Ä_¡»ams
)

3894 
»t
 = 
	`nvme_g‘_¡»am_·¿ms
(
ù¾
, &
s
, 
ns
->
h—d
->
ns_id
);

3895 ià(
»t
)

3896  
»t
;

3898 
ns
->
sws
 = 
	`Ë32_to_ıu
(
s
.sws);

3899 
ns
->
sgs
 = 
	`Ë16_to_ıu
(
s
.sgs);

3901 ià(
ns
->
sws
) {

3902 
bs
 = 1 << 
ns
->
lba_shiá
;

3904 
	`blk_queue_io_mš
(
ns
->
queue
, 
bs
 *‚s->
sws
);

3905 ià(
ns
->
sgs
)

3906 
	`blk_queue_io_İt
(
ns
->
queue
, 
bs
 *‚s->
sws
 *‚s->
sgs
);

3910 
	}
}

3912 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

3914 
nvme_ns
 *
ns
;

3915 
g’disk
 *
disk
;

3916 
nvme_id_ns
 *
id
;

3917 
disk_Çme
[
DISK_NAME_LEN
];

3918 
node
 = 
	`dev_to_node
(
ù¾
->
dev
), 
æags
 = 
GENHD_FL_EXT_DEVT
;

3919 
boŞ
 
Ãw
 = 
Œue
;

3921 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

3922 ià(!
ns
)

3925 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

3926 ià(
	`IS_ERR
(
ns
->
queue
))

3927 
out_ä“_ns
;

3928 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

3929 
ns
->
queue
->
queued©a
 =‚s;

3930 
ns
->
ù¾
 = ctrl;

3932 
	`k»f_š™
(&
ns
->
k»f
);

3933 
ns
->
lba_shiá
 = 9;

3935 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

3936 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

3938 
id
 = 
	`nvme_id’tify_ns
(
ù¾
, 
nsid
);

3939 ià(!
id
)

3940 
out_ä“_queue
;

3942 ià(
id
->
nÿp
 == 0)

3943 
out_ä“_id
;

3945 ià(
	`nvme_š™_ns_h—d
(
ns
, 
nsid
, 
id
, &
Ãw
))

3946 
out_ä“_id
;

3947 
	`nvme_£tup_¡»ams_ns
(
ù¾
, 
ns
);

3949 #ifdeà
CONFIG_NVME_MULTIPATH


3957 ià(
ns
->
h—d
->
disk
) {

3958 
	`¥rštf
(
disk_Çme
, "nvme%dc%dn%d", 
ù¾
->
subsys
->
š¡ªû
,

3959 
ù¾
->
úid
, 
ns
->
h—d
->
š¡ªû
);

3960 
æags
 = 
GENHD_FL_HIDDEN
;

3962 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
subsys
->
š¡ªû
,

3963 
ns
->
h—d
->
š¡ªû
);

3971 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
ns
->
h—d
->instance);

3974 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_LIGHTNVM
è&& 
id
->
vs
[0] == 0x1) {

3975 ià(
	`nvme_nvm_»gi¡”
(
ns
, 
disk_Çme
, 
node
)) {

3976 
	`dev_w¬n
(
ù¾
->
deviû
, "LightNVM init failure\n");

3977 
out_uÆšk_ns
;

3981 
disk
 = 
	`®loc_disk_node
(0, 
node
);

3982 ià(!
disk
)

3983 
out_uÆšk_ns
;

3985 
disk
->
fİs
 = &
nvme_fİs
;

3986 
disk
->
´iv©e_d©a
 = 
ns
;

3987 
disk
->
queue
 = 
ns
->queue;

3988 
disk
->
æags
 = flags;

3989 
	`memıy
(
disk
->
disk_Çme
, disk_Çme, 
DISK_NAME_LEN
);

3990 
ns
->
disk
 = disk;

3992 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

3994 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3995 
	`li¡_add_
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

3996 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3998 
	`nvme_g‘_ù¾
(
ù¾
);

4000 
	`kä“
(
id
);

4002 
	`deviû_add_disk
(
ù¾
->
deviû
, 
ns
->
disk
);

4003 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

4004 &
nvme_ns_id_©Œ_group
))

4005 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

4006 
ns
->
disk
->
disk_Çme
);

4007 ià(
ns
->
ndev
 && 
	`nvme_nvm_»gi¡”_sysfs
(ns))

4008 
	`´_w¬n
("%s: failedo„egister†ightnvm sysfs group for identification\n",

4009 
ns
->
disk
->
disk_Çme
);

4011 ià(
Ãw
)

4012 
	`nvme_m·th_add_disk
(
ns
->
h—d
);

4014 
out_uÆšk_ns
:

4015 
	`mu‹x_lock
(&
ù¾
->
subsys
->
lock
);

4016 
	`li¡_d–_rcu
(&
ns
->
siblšgs
);

4017 
	`mu‹x_uÆock
(&
ù¾
->
subsys
->
lock
);

4018 
out_ä“_id
:

4019 
	`kä“
(
id
);

4020 
out_ä“_queue
:

4021 
	`blk_ş—nup_queue
(
ns
->
queue
);

4022 
out_ä“_ns
:

4023 
	`kä“
(
ns
);

4024 
	}
}

4026 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

4028 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

4031 ià(
ns
->
disk
 &&‚s->disk->
æags
 & 
GENHD_FL_UP
) {

4032 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

4033 &
nvme_ns_id_©Œ_group
);

4034 ià(
ns
->
ndev
)

4035 
	`nvme_nvm_uÄegi¡”_sysfs
(
ns
);

4036 
	`d–_g’disk
(
ns
->
disk
);

4037 
	`blk_ş—nup_queue
(
ns
->
queue
);

4038 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

4039 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

4042 
	`mu‹x_lock
(&
ns
->
ù¾
->
subsys
->
lock
);

4043 
	`nvme_m·th_ş—r_cu¼’t_·th
(
ns
);

4044 
	`li¡_d–_rcu
(&
ns
->
siblšgs
);

4045 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
subsys
->
lock
);

4047 
	`mu‹x_lock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

4048 
	`li¡_d–_š™
(&
ns
->
li¡
);

4049 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

4051 
	`synchrÚize_¤cu
(&
ns
->
h—d
->
¤cu
);

4052 
	`nvme_m·th_check_Ï¡_·th
(
ns
);

4053 
	`nvme_put_ns
(
ns
);

4054 
	}
}

4056 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

4058 
nvme_ns
 *
ns
;

4060 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
nsid
);

4061 ià(
ns
) {

4062 ià(
ns
->
disk
 && 
	`»v®id©e_disk
(ns->disk))

4063 
	`nvme_ns_»move
(
ns
);

4064 
	`nvme_put_ns
(
ns
);

4066 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

4067 
	}
}

4069 
	$nvme_»move_šv®id_Çme¥aûs
(
nvme_ù¾
 *
ù¾
,

4070 
nsid
)

4072 
nvme_ns
 *
ns
, *
Ãxt
;

4074 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

4075 ià(
ns
->
h—d
->
ns_id
 > 
nsid
)

4076 
	`nvme_ns_»move
(
ns
);

4078 
	}
}

4080 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

4082 
nvme_ns
 *
ns
;

4083 
__Ë32
 *
ns_li¡
;

4084 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

4085 
»t
 = 0;

4087 
ns_li¡
 = 
	`kz®loc
(0x1000, 
GFP_KERNEL
);

4088 ià(!
ns_li¡
)

4089  -
ENOMEM
;

4091 
i
 = 0; i < 
num_li¡s
; i++) {

4092 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

4093 ià(
»t
)

4094 
ä“
;

4096 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

4097 
nsid
 = 
	`Ë32_to_ıu
(
ns_li¡
[
j
]);

4098 ià(!
nsid
)

4099 
out
;

4101 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

4103 ++
´ev
 < 
nsid
) {

4104 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
´ev
);

4105 ià(
ns
) {

4106 
	`nvme_ns_»move
(
ns
);

4107 
	`nvme_put_ns
(
ns
);

4111 
Â
 -ğ
j
;

4113 
out
:

4114 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
´ev
);

4115 
ä“
:

4116 
	`kä“
(
ns_li¡
);

4117  
»t
;

4118 
	}
}

4120 
	$nvme_sÿn_ns_£qu’tŸl
(
nvme_ù¾
 *
ù¾
, 
Â
)

4122 
i
;

4124 
i
 = 1; i <ğ
Â
; i++)

4125 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

4127 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
Â
);

4128 
	}
}

4130 
	$nvme_sÿn_wÜk
(
wÜk_¡ruù
 *
wÜk
)

4132 
nvme_ù¾
 *
ù¾
 =

4133 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
sÿn_wÜk
);

4134 
nvme_id_ù¾
 *
id
;

4135 
Â
;

4137 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
)

4140 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

4143 
Â
 = 
	`Ë32_to_ıu
(
id
->nn);

4144 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0) &&

4145 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

4146 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

4147 
dÚe
;

4149 
	`nvme_sÿn_ns_£qu’tŸl
(
ù¾
, 
Â
);

4150 
dÚe
:

4151 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4152 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

4153 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4154 
	`kä“
(
id
);

4155 
	}
}

4157 
	$nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
)

4163 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
)

4164 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
sÿn_wÜk
);

4165 
	}
}

4166 
EXPORT_SYMBOL_GPL
(
nvme_queue_sÿn
);

4173 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

4175 
nvme_ns
 *
ns
, *
Ãxt
;

4183 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_DEAD
)

4184 
	`nvme_kl_queues
(
ù¾
);

4186 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
)

4187 
	`nvme_ns_»move
(
ns
);

4188 
	}
}

4189 
EXPORT_SYMBOL_GPL
(
nvme_»move_Çme¥aûs
);

4191 
	$nvme_«n_uev’t
(
nvme_ù¾
 *
ù¾
)

4193 *
’vp
[2] = { 
NULL
, NULL };

4194 
u32
 
«n_»suÉ
 = 
ù¾
->aen_result;

4196 
ù¾
->
«n_»suÉ
 = 0;

4197 ià(!
«n_»suÉ
)

4200 
’vp
[0] = 
	`ka¥rštf
(
GFP_KERNEL
, "NVME_AEN=%#08x", 
«n_»suÉ
);

4201 ià(!
’vp
[0])

4203 
	`kobjeù_uev’t_’v
(&
ù¾
->
deviû
->
kobj
, 
KOBJ_CHANGE
, 
’vp
);

4204 
	`kä“
(
’vp
[0]);

4205 
	}
}

4207 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

4209 
nvme_ù¾
 *
ù¾
 =

4210 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
async_ev’t_wÜk
);

4212 
	`nvme_«n_uev’t
(
ù¾
);

4213 
ù¾
->
İs
->
	`subm™_async_ev’t
(ctrl);

4214 
	}
}

4216 
boŞ
 
	$nvme_ù¾_µ_¡©us
(
nvme_ù¾
 *
ù¾
)

4219 
u32
 
c¡s
;

4221 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
))

4222  
çl£
;

4224 ià(
c¡s
 == ~0)

4225  
çl£
;

4227  ((
ù¾
->
ù¾_cÚfig
 & 
NVME_CC_ENABLE
è&& (
c¡s
 & 
NVME_CSTS_PP
));

4228 
	}
}

4230 
	$nvme_g‘_fw_¦Ù_šfo
(
nvme_ù¾
 *
ù¾
)

4232 
nvme_fw_¦Ù_šfo_log
 *
log
;

4234 
log
 = 
	`km®loc
((*log), 
GFP_KERNEL
);

4235 ià(!
log
)

4238 ià(
	`nvme_g‘_log
(
ù¾
, 
NVME_LOG_FW_SLOT
, 
log
, (*log)))

4239 
	`dev_w¬n
(
ù¾
->
deviû
,

4241 
	`kä“
(
log
);

4242 
	}
}

4244 
	$nvme_fw_aù_wÜk
(
wÜk_¡ruù
 *
wÜk
)

4246 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

4247 
nvme_ù¾
, 
fw_aù_wÜk
);

4248 
fw_aù_timeout
;

4250 ià(
ù¾
->
mtç
)

4251 
fw_aù_timeout
 = 
jiff›s
 +

4252 
	`m£cs_to_jiff›s
(
ù¾
->
mtç
 * 100);

4254 
fw_aù_timeout
 = 
jiff›s
 +

4255 
	`m£cs_to_jiff›s
(
admš_timeout
 * 1000);

4257 
	`nvme_¡İ_queues
(
ù¾
);

4258 
	`nvme_ù¾_µ_¡©us
(
ù¾
)) {

4259 ià(
	`time_aá”
(
jiff›s
, 
fw_aù_timeout
)) {

4260 
	`dev_w¬n
(
ù¾
->
deviû
,

4262 
	`nvme_»£t_ù¾
(
ù¾
);

4265 
	`m¦“p
(100);

4268 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
)

4271 
	`nvme_¡¬t_queues
(
ù¾
);

4273 
	`nvme_g‘_fw_¦Ù_šfo
(
ù¾
);

4274 
	}
}

4276 
	$nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

4277 
nvme_»suÉ
 *
»s
)

4279 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
»s
->u32);

4281 ià(
	`Ë16_to_ıu
(
¡©us
è>> 1 !ğ
NVME_SC_SUCCESS
)

4284 
»suÉ
 & 0x7) {

4285 
NVME_AER_ERROR
:

4286 
NVME_AER_SMART
:

4287 
NVME_AER_CSS
:

4288 
NVME_AER_VS
:

4289 
ù¾
->
«n_»suÉ
 = 
»suÉ
;

4295 
»suÉ
 & 0xff07) {

4296 
NVME_AER_NOTICE_NS_CHANGED
:

4297 
	`dev_šfo
(
ù¾
->
deviû
, "rescanning\n");

4298 
	`nvme_queue_sÿn
(
ù¾
);

4300 
NVME_AER_NOTICE_FW_ACT_STARTING
:

4301 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
fw_aù_wÜk
);

4304 
	`dev_w¬n
(
ù¾
->
deviû
, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

4306 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
async_ev’t_wÜk
);

4307 
	}
}

4308 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_async_ev’t
);

4310 
	$nvme_¡İ_ù¾
(
nvme_ù¾
 *
ù¾
)

4312 
	`nvme_¡İ_k“p_®ive
(
ù¾
);

4313 
	`æush_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

4314 
	`æush_wÜk
(&
ù¾
->
sÿn_wÜk
);

4315 
	`ÿnûl_wÜk_sync
(&
ù¾
->
fw_aù_wÜk
);

4316 
	}
}

4317 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_ù¾
);

4319 
	$nvme_¡¬t_ù¾
(
nvme_ù¾
 *
ù¾
)

4321 ià(
ù¾
->
k©o
)

4322 
	`nvme_¡¬t_k“p_®ive
(
ù¾
);

4324 ià(
ù¾
->
queue_couÁ
 > 1) {

4325 
	`nvme_queue_sÿn
(
ù¾
);

4326 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
async_ev’t_wÜk
);

4327 
	`nvme_¡¬t_queues
(
ù¾
);

4329 
	}
}

4330 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ù¾
);

4332 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

4334 
	`cdev_deviû_d–
(&
ù¾
->
cdev
, cŒl->
deviû
);

4335 
	}
}

4336 
EXPORT_SYMBOL_GPL
(
nvme_unš™_ù¾
);

4338 
	$nvme_ä“_ù¾
(
deviû
 *
dev
)

4340 
nvme_ù¾
 *
ù¾
 =

4341 
	`cÚš”_of
(
dev
, 
nvme_ù¾
, 
ù¾_deviû
);

4342 
nvme_subsy¡em
 *
subsys
 = 
ù¾
->subsys;

4344 
	`ida_sim¶e_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

4345 
	`kä“
(
ù¾
->
efãùs
);

4347 ià(
subsys
) {

4348 
	`mu‹x_lock
(&
subsys
->
lock
);

4349 
	`li¡_d–
(&
ù¾
->
subsys_’Œy
);

4350 
	`mu‹x_uÆock
(&
subsys
->
lock
);

4351 
	`sysfs_»move_lšk
(&
subsys
->
dev
.
kobj
, 
	`dev_Çme
(
ù¾
->
deviû
));

4354 
ù¾
->
İs
->
	`ä“_ù¾
(ctrl);

4356 ià(
subsys
)

4357 
	`nvme_put_subsy¡em
(
subsys
);

4358 
	}
}

4365 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

4366 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
)

4368 
»t
;

4370 
ù¾
->
¡©e
 = 
NVME_CTRL_NEW
;

4371 
	`¥š_lock_š™
(&
ù¾
->
lock
);

4372 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

4373 
	`mu‹x_š™
(&
ù¾
->
Çme¥aûs_mu‹x
);

4374 
ù¾
->
dev
 = dev;

4375 
ù¾
->
İs
 = ops;

4376 
ù¾
->
quœks
 = quirks;

4377 
	`INIT_WORK
(&
ù¾
->
sÿn_wÜk
, 
nvme_sÿn_wÜk
);

4378 
	`INIT_WORK
(&
ù¾
->
async_ev’t_wÜk
, 
nvme_async_ev’t_wÜk
);

4379 
	`INIT_WORK
(&
ù¾
->
fw_aù_wÜk
, 
nvme_fw_aù_wÜk
);

4380 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_d–‘e_ù¾_wÜk
);

4382 
»t
 = 
	`ida_sim¶e_g‘
(&
nvme_š¡ªû_ida
, 0, 0, 
GFP_KERNEL
);

4383 ià(
»t
 < 0)

4384 
out
;

4385 
ù¾
->
š¡ªû
 = 
»t
;

4387 
	`deviû_š™Ÿlize
(&
ù¾
->
ù¾_deviû
);

4388 
ù¾
->
deviû
 = &ù¾->
ù¾_deviû
;

4389 
ù¾
->
deviû
->
devt
 = 
	`MKDEV
(
	`MAJOR
(
nvme_chr_devt
), cŒl->
š¡ªû
);

4390 
ù¾
->
deviû
->
şass
 = 
nvme_şass
;

4391 
ù¾
->
deviû
->
·»Á
 = cŒl->
dev
;

4392 
ù¾
->
deviû
->
groups
 = 
nvme_dev_©Œ_groups
;

4393 
ù¾
->
deviû
->
»Ëa£
 = 
nvme_ä“_ù¾
;

4394 
	`dev_£t_drvd©a
(
ù¾
->
deviû
, ctrl);

4395 
»t
 = 
	`dev_£t_Çme
(
ù¾
->
deviû
, "nvme%d", cŒl->
š¡ªû
);

4396 ià(
»t
)

4397 
out_»Ëa£_š¡ªû
;

4399 
	`cdev_š™
(&
ù¾
->
cdev
, &
nvme_dev_fİs
);

4400 
ù¾
->
cdev
.
owÃr
 = 
İs
->
moduË
;

4401 
»t
 = 
	`cdev_deviû_add
(&
ù¾
->
cdev
, cŒl->
deviû
);

4402 ià(
»t
)

4403 
out_ä“_Çme
;

4409 
ù¾
->
deviû
->
pow”
.
£t_Ï‹ncy_tŞ”ªû
 = 
nvme_£t_Ï‹ncy_tŞ”ªû
;

4410 
	`dev_pm_qos_upd©e_u£r_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
,

4411 
	`mš
(
deçuÉ_ps_max_Ï‹ncy_us
, ()
S32_MAX
));

4414 
out_ä“_Çme
:

4415 
	`kä“_cÚ¡
(
dev
->
kobj
.
Çme
);

4416 
out_»Ëa£_š¡ªû
:

4417 
	`ida_sim¶e_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

4418 
out
:

4419  
»t
;

4420 
	}
}

4421 
EXPORT_SYMBOL_GPL
(
nvme_š™_ù¾
);

4430 
	$nvme_kl_queues
(
nvme_ù¾
 *
ù¾
)

4432 
nvme_ns
 *
ns
;

4434 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4437 ià(
ù¾
->
admš_q
)

4438 
	`blk_mq_unqu›sû_queue
(
ù¾
->
admš_q
);

4440 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

4445 ià(!
ns
->
disk
 || 
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &ns->
æags
))

4447 
	`»v®id©e_disk
(
ns
->
disk
);

4448 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

4451 
	`blk_mq_unqu›sû_queue
(
ns
->
queue
);

4453 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4454 
	}
}

4455 
EXPORT_SYMBOL_GPL
(
nvme_kl_queues
);

4457 
	$nvme_unä“ze
(
nvme_ù¾
 *
ù¾
)

4459 
nvme_ns
 *
ns
;

4461 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4462 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

4463 
	`blk_mq_unä“ze_queue
(
ns
->
queue
);

4464 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4465 
	}
}

4466 
EXPORT_SYMBOL_GPL
(
nvme_unä“ze
);

4468 
	$nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
)

4470 
nvme_ns
 *
ns
;

4472 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4473 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

4474 
timeout
 = 
	`blk_mq_ä“ze_queue_wa™_timeout
(
ns
->
queue
,imeout);

4475 ià(
timeout
 <= 0)

4478 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4479 
	}
}

4480 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze_timeout
);

4482 
	$nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
)

4484 
nvme_ns
 *
ns
;

4486 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4487 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

4488 
	`blk_mq_ä“ze_queue_wa™
(
ns
->
queue
);

4489 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4490 
	}
}

4491 
EXPORT_SYMBOL_GPL
(
nvme_wa™_ä“ze
);

4493 
	$nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
)

4495 
nvme_ns
 *
ns
;

4497 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4498 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

4499 
	`blk_ä“ze_queue_¡¬t
(
ns
->
queue
);

4500 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4501 
	}
}

4502 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_ä“ze
);

4504 
	$nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
)

4506 
nvme_ns
 *
ns
;

4508 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4509 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

4510 
	`blk_mq_qu›sû_queue
(
ns
->
queue
);

4511 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4512 
	}
}

4513 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_queues
);

4515 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

4517 
nvme_ns
 *
ns
;

4519 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4520 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
)

4521 
	`blk_mq_unqu›sû_queue
(
ns
->
queue
);

4522 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

4523 
	}
}

4524 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_queues
);

4526 
	$nvme_»š™_g£t
(
nvme_ù¾
 *
ù¾
, 
blk_mq_g_£t
 *
£t
)

4528 ià(!
ù¾
->
İs
->
»š™_»que¡
)

4531  
	`blk_mq_g£t_™”
(
£t
, s‘->
driv”_d©a
,

4532 
ù¾
->
İs
->
»š™_»que¡
);

4533 
	}
}

4534 
EXPORT_SYMBOL_GPL
(
nvme_»š™_g£t
);

4536 
__š™
 
	$nvme_cÜe_š™
()

4538 
»suÉ
;

4540 
nvme_wq
 = 
	`®loc_wÜkqueue
("nvme-wq",

4541 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

4542 ià(!
nvme_wq
)

4543  -
ENOMEM
;

4545 
»suÉ
 = 
	`®loc_chrdev_»giÚ
(&
nvme_chr_devt
, 0, 
NVME_MINORS
, "nvme");

4546 ià(
»suÉ
 < 0)

4547 
de¡roy_wq
;

4549 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

4550 ià(
	`IS_ERR
(
nvme_şass
)) {

4551 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

4552 
uÄegi¡”_chrdev
;

4555 
nvme_subsys_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme-subsystem");

4556 ià(
	`IS_ERR
(
nvme_subsys_şass
)) {

4557 
»suÉ
 = 
	`PTR_ERR
(
nvme_subsys_şass
);

4558 
de¡roy_şass
;

4561 
»suÉ
 = 
	`aio_£rviû_š™
();

4562 ià(
»suÉ
)

4563 
de¡roy_şass
;

4565 
»suÉ
 = 
	`aio_wÜk”_š™
();

4566 ià(
»suÉ
)

4567 
de¡roy_aio_£rviû
;

4570 
de¡roy_aio_£rviû
:

4571 
	`aio_£rviû_ex™
();

4572 
de¡roy_şass
:

4573 
	`şass_de¡roy
(
nvme_şass
);

4574 
uÄegi¡”_chrdev
:

4575 
	`uÄegi¡”_chrdev_»giÚ
(
nvme_chr_devt
, 
NVME_MINORS
);

4576 
de¡roy_wq
:

4577 
	`de¡roy_wÜkqueue
(
nvme_wq
);

4578  
»suÉ
;

4579 
	}
}

4581 
	$nvme_cÜe_ex™
()

4583 
	`ida_de¡roy
(&
nvme_subsy¡ems_ida
);

4584 
	`şass_de¡roy
(
nvme_subsys_şass
);

4585 
	`şass_de¡roy
(
nvme_şass
);

4586 
	`uÄegi¡”_chrdev_»giÚ
(
nvme_chr_devt
, 
NVME_MINORS
);

4587 
	`de¡roy_wÜkqueue
(
nvme_wq
);

4589 
	`aio_wÜk”_ex™
();

4590 
	`aio_£rviû_ex™
();

4592 
	}
}

4594 
MODULE_LICENSE
("GPL");

4595 
MODULE_VERSION
("1.0");

4596 
moduË_š™
(
nvme_cÜe_š™
);

4597 
moduË_ex™
(
nvme_cÜe_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/fabrics.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/š™.h
>

16 
	~<lšux/miscdeviû.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/mu‹x.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~"nvme.h
"

22 
	~"çbrics.h
"

24 
LIST_HEAD
(
nvmf_Œª¥Üts
);

25 
DECLARE_RWSEM
(
nvmf_Œª¥Üts_rw£m
);

27 
LIST_HEAD
(
nvmf_ho¡s
);

28 
DEFINE_MUTEX
(
nvmf_ho¡s_mu‹x
);

30 
nvmf_ho¡
 *
	gnvmf_deçuÉ_ho¡
;

32 
nvmf_ho¡
 *
	$__nvmf_ho¡_fšd
(cÚ¡ *
ho¡nqn
)

34 
nvmf_ho¡
 *
ho¡
;

36 
	`li¡_fÜ_—ch_’Œy
(
ho¡
, &
nvmf_ho¡s
, 
li¡
) {

37 ià(!
	`¡rcmp
(
ho¡
->
nqn
, 
ho¡nqn
))

38  
ho¡
;

41  
NULL
;

42 
	}
}

44 
nvmf_ho¡
 *
	$nvmf_ho¡_add
(cÚ¡ *
ho¡nqn
)

46 
nvmf_ho¡
 *
ho¡
;

48 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

49 
ho¡
 = 
	`__nvmf_ho¡_fšd
(
ho¡nqn
);

50 ià(
ho¡
) {

51 
	`k»f_g‘
(&
ho¡
->
»f
);

52 
out_uÆock
;

55 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

56 ià(!
ho¡
)

57 
out_uÆock
;

59 
	`k»f_š™
(&
ho¡
->
»f
);

60 
	`memıy
(
ho¡
->
nqn
, 
ho¡nqn
, 
NVMF_NQN_SIZE
);

62 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

63 
out_uÆock
:

64 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

65  
ho¡
;

66 
	}
}

68 
nvmf_ho¡
 *
	$nvmf_ho¡_deçuÉ
()

70 
nvmf_ho¡
 *
ho¡
;

72 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

73 ià(!
ho¡
)

74  
NULL
;

76 
	`k»f_š™
(&
ho¡
->
»f
);

77 
	`uuid_g’
(&
ho¡
->
id
);

78 
	`¢´štf
(
ho¡
->
nqn
, 
NVMF_NQN_SIZE
,

79 "nqn.2014-08.Üg.nvmex´ess:uuid:%pUb", &
ho¡
->
id
);

81 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

82 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

83 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

85  
ho¡
;

86 
	}
}

88 
	$nvmf_ho¡_de¡roy
(
k»f
 *
»f
)

90 
nvmf_ho¡
 *
ho¡
 = 
	`cÚš”_of
(
»f
, nvmf_host,„ef);

92 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

93 
	`li¡_d–
(&
ho¡
->
li¡
);

94 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

96 
	`kä“
(
ho¡
);

97 
	}
}

99 
	$nvmf_ho¡_put
(
nvmf_ho¡
 *
ho¡
)

101 ià(
ho¡
)

102 
	`k»f_put
(&
ho¡
->
»f
, 
nvmf_ho¡_de¡roy
);

103 
	}
}

111 
	$nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
)

113 
Ën
 = 0;

115 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRADDR
)

116 
Ën
 +ğ
	`¢´štf
(
buf
, 
size
, "Œaddr=%s", 
ù¾
->
İts
->
Œaddr
);

117 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRSVCID
)

118 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%strsvcid=%s",

119 (
Ën
è? "," : "", 
ù¾
->
İts
->
Œsvcid
);

120 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

121 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%shost_traddr=%s",

122 (
Ën
è? "," : "", 
ù¾
->
İts
->
ho¡_Œaddr
);

123 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "\n");

125  
Ën
;

126 
	}
}

127 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_add»ss
);

150 
	$nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

152 
nvme_commªd
 
cmd
;

153 
nvme_»suÉ
 
»s
;

154 
»t
;

156 
	`mem£t
(&
cmd
, 0, (cmd));

157 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

158 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

159 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

161 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

162 
NVME_QID_ANY
, 0, 0);

164 ià(
»t
 >= 0)

165 *
v®
 = 
	`Ë64_to_ıu
(
»s
.
u64
);

166 ià(
	`uÆik–y
(
»t
 != 0))

167 
	`dev_”r
(
ù¾
->
deviû
,

169 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

171  
»t
;

172 
	}
}

173 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad32
);

196 
	$nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

198 
nvme_commªd
 
cmd
;

199 
nvme_»suÉ
 
»s
;

200 
»t
;

202 
	`mem£t
(&
cmd
, 0, (cmd));

203 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

204 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

205 
cmd
.
´İ_g‘
.
©Œib
 = 1;

206 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

208 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
, 
NULL
, 0, 0,

209 
NVME_QID_ANY
, 0, 0);

211 ià(
»t
 >= 0)

212 *
v®
 = 
	`Ë64_to_ıu
(
»s
.
u64
);

213 ià(
	`uÆik–y
(
»t
 != 0))

214 
	`dev_”r
(
ù¾
->
deviû
,

216 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

217  
»t
;

218 
	}
}

219 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad64
);

242 
	$nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

244 
nvme_commªd
 
cmd
;

245 
»t
;

247 
	`mem£t
(&
cmd
, 0, (cmd));

248 
cmd
.
´İ_£t
.
İcode
 = 
nvme_çbrics_commªd
;

249 
cmd
.
´İ_£t
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_£t
;

250 
cmd
.
´İ_£t
.
©Œib
 = 0;

251 
cmd
.
´İ_£t
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

252 
cmd
.
´İ_£t
.
v®ue
 = 
	`ıu_to_Ë64
(
v®
);

254 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, NULL, 0, 0,

255 
NVME_QID_ANY
, 0, 0);

256 ià(
	`uÆik–y
(
»t
))

257 
	`dev_”r
(
ù¾
->
deviû
,

259 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

260  
»t
;

261 
	}
}

262 
EXPORT_SYMBOL_GPL
(
nvmf_»g_wr™e32
);

279 
	$nvmf_log_cÚÃù_”rÜ
(
nvme_ù¾
 *
ù¾
,

280 
”rv®
, 
off£t
, 
nvme_commªd
 *
cmd
,

281 
nvmf_cÚÃù_d©a
 *
d©a
)

283 
”r_sùy³
 = 
”rv®
 & (~
NVME_SC_DNR
);

285 
”r_sùy³
) {

287 (
NVME_SC_CONNECT_INVALID_PARAM
):

288 ià(
off£t
 >> 16) {

289 *
šv_d©a
 = "Connect Invalid Data Parameter";

291 
off£t
 & 0xffff) {

292 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
úid
)):

293 
	`dev_”r
(
ù¾
->
deviû
,

295 
šv_d©a
, 
d©a
->
úid
);

297 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
ho¡nqn
)):

298 
	`dev_”r
(
ù¾
->
deviû
,

300 
šv_d©a
, 
d©a
->
ho¡nqn
);

302 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
subsy¢qn
)):

303 
	`dev_”r
(
ù¾
->
deviû
,

305 
šv_d©a
, 
d©a
->
subsy¢qn
);

308 
	`dev_”r
(
ù¾
->
deviû
,

310 
šv_d©a
, 
off£t
 & 0xffff);

314 *
šv_sqe
 = "Connect Invalid SQE Parameter";

316 
off£t
) {

317 (
	`off£tof
(
nvmf_cÚÃù_commªd
, 
qid
)):

318 
	`dev_”r
(
ù¾
->
deviû
,

320 
šv_sqe
, 
cmd
->
cÚÃù
.
qid
);

323 
	`dev_”r
(
ù¾
->
deviû
,

325 
šv_sqe
, 
off£t
);

330 
NVME_SC_CONNECT_INVALID_HOST
:

331 
	`dev_”r
(
ù¾
->
deviû
,

333 
d©a
->
subsy¢qn
, d©a->
ho¡nqn
);

336 
NVME_SC_CONNECT_CTRL_BUSY
:

337 
	`dev_”r
(
ù¾
->
deviû
,

341 
NVME_SC_CONNECT_FORMAT
:

342 
	`dev_”r
(
ù¾
->
deviû
,

344 
cmd
->
cÚÃù
.
»cfmt
);

348 
	`dev_”r
(
ù¾
->
deviû
,

350 
”r_sùy³
);

353 
	}
}

375 
	$nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
)

377 
nvme_commªd
 
cmd
;

378 
nvme_»suÉ
 
»s
;

379 
nvmf_cÚÃù_d©a
 *
d©a
;

380 
»t
;

382 
	`mem£t
(&
cmd
, 0, (cmd));

383 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

384 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

385 
cmd
.
cÚÃù
.
qid
 = 0;

386 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
NVME_AQ_DEPTH
 - 1);

392 
cmd
.
cÚÃù
.
k©o
 = 
ù¾
->
İts
->
discov”y_nqn
 ? 0 :

393 
	`ıu_to_Ë32
((
ù¾
->
k©o
 + 
NVME_KATO_GRACE
) * 1000);

395 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

396 ià(!
d©a
)

397  -
ENOMEM
;

399 
	`uuid_cİy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
);

400 
d©a
->
úid
 = 
	`ıu_to_Ë16
(0xffff);

401 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

402 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

404 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
»s
,

405 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

406 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

407 ià(
»t
) {

408 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
»s
.
u32
),

409 &
cmd
, 
d©a
);

410 
out_ä“_d©a
;

413 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
»s
.
u16
);

415 
out_ä“_d©a
:

416 
	`kä“
(
d©a
);

417  
»t
;

418 
	}
}

419 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_admš_queue
);

441 
	$nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
)

443 
nvme_commªd
 
cmd
;

444 
nvmf_cÚÃù_d©a
 *
d©a
;

445 
nvme_»suÉ
 
»s
;

446 
»t
;

448 
	`mem£t
(&
cmd
, 0, (cmd));

449 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

450 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

451 
cmd
.
cÚÃù
.
qid
 = 
	`ıu_to_Ë16
(qid);

452 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
ù¾
->sqsize);

454 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

455 ià(!
d©a
)

456  -
ENOMEM
;

458 
	`uuid_cİy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
);

459 
d©a
->
úid
 = 
	`ıu_to_Ë16
(
ù¾
->cntlid);

460 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

461 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

463 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
cÚÃù_q
, &
cmd
, &
»s
,

464 
d©a
, (*d©a), 0, 
qid
, 1,

465 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

466 ià(
»t
) {

467 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
»s
.
u32
),

468 &
cmd
, 
d©a
);

470 
	`kä“
(
d©a
);

471  
»t
;

472 
	}
}

473 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_io_queue
);

475 
boŞ
 
	$nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
)

477 ià(
ù¾
->
İts
->
max_»cÚÃùs
 != -1 &&

478 
ù¾
->
Ä_»cÚÃùs
 < cŒl->
İts
->
max_»cÚÃùs
)

479  
Œue
;

481  
çl£
;

482 
	}
}

483 
EXPORT_SYMBOL_GPL
(
nvmf_should_»cÚÃù
);

494 
	$nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

496 ià(!
İs
->
ü—‹_ù¾
)

497  -
EINVAL
;

499 
	`down_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

500 
	`li¡_add_
(&
İs
->
’Œy
, &
nvmf_Œª¥Üts
);

501 
	`up_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

504 
	}
}

505 
EXPORT_SYMBOL_GPL
(
nvmf_»gi¡”_Œª¥Üt
);

516 
	$nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

518 
	`down_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

519 
	`li¡_d–
(&
İs
->
’Œy
);

520 
	`up_wr™e
(&
nvmf_Œª¥Üts_rw£m
);

521 
	}
}

522 
EXPORT_SYMBOL_GPL
(
nvmf_uÄegi¡”_Œª¥Üt
);

524 
nvmf_Œª¥Üt_İs
 *
	$nvmf_lookup_Œª¥Üt
(

525 
nvmf_ù¾_İtiÚs
 *
İts
)

527 
nvmf_Œª¥Üt_İs
 *
İs
;

529 
	`lockd•_as£¹_h–d
(&
nvmf_Œª¥Üts_rw£m
);

531 
	`li¡_fÜ_—ch_’Œy
(
İs
, &
nvmf_Œª¥Üts
, 
’Œy
) {

532 ià(
	`¡rcmp
(
İs
->
Çme
, 
İts
->
Œª¥Üt
) == 0)

533  
İs
;

536  
NULL
;

537 
	}
}

539 cÚ¡ 
m©ch_bË_t
 
	gİt_tok’s
 = {

540 { 
NVMF_OPT_TRANSPORT
, "transport=%s" },

541 { 
NVMF_OPT_TRADDR
, "traddr=%s" },

542 { 
NVMF_OPT_TRSVCID
, "trsvcid=%s" },

543 { 
NVMF_OPT_NQN
, "nqn=%s" },

544 { 
NVMF_OPT_QUEUE_SIZE
, "queue_size=%d" },

545 { 
NVMF_OPT_NR_IO_QUEUES
, "nr_io_queues=%d" },

546 { 
NVMF_OPT_RECONNECT_DELAY
, "reconnect_delay=%d" },

547 { 
NVMF_OPT_CTRL_LOSS_TMO
, "ctrl_loss_tmo=%d" },

548 { 
NVMF_OPT_KATO
, "keep_alive_tmo=%d" },

549 { 
NVMF_OPT_HOSTNQN
, "hostnqn=%s" },

550 { 
NVMF_OPT_HOST_TRADDR
, "host_traddr=%s" },

551 { 
NVMF_OPT_HOST_ID
, "hostid=%s" },

552 { 
NVMF_OPT_DUP_CONNECT
, "duplicate_connect" },

553 { 
NVMF_OPT_ERR
, 
NULL
 }

556 
	$nvmf_·r£_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
,

557 cÚ¡ *
buf
)

559 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

560 *
İtiÚs
, *
o
, *
p
;

561 
tok’
, 
»t
 = 0;

562 
size_t
 
nqÆ’
 = 0;

563 
ù¾_loss_tmo
 = 
NVMF_DEF_CTRL_LOSS_TMO
;

564 
uuid_t
 
ho¡id
;

567 
İts
->
queue_size
 = 
NVMF_DEF_QUEUE_SIZE
;

568 
İts
->
Ä_io_queues
 = 
	`num_Úlše_ıus
();

569 
İts
->
»cÚÃù_d–ay
 = 
NVMF_DEF_RECONNECT_DELAY
;

570 
İts
->
k©o
 = 
NVME_DEFAULT_KATO
;

571 
İts
->
du¶iÿ‹_cÚÃù
 = 
çl£
;

573 
İtiÚs
 = 
o
 = 
	`k¡rdup
(
buf
, 
GFP_KERNEL
);

574 ià(!
İtiÚs
)

575  -
ENOMEM
;

577 
	`uuid_g’
(&
ho¡id
);

579 (
p
 = 
	`¡r£p
(&
o
, ",\n")è!ğ
NULL
) {

580 ià(!*
p
)

583 
tok’
 = 
	`m©ch_tok’
(
p
, 
İt_tok’s
, 
¬gs
);

584 
İts
->
mask
 |ğ
tok’
;

585 
tok’
) {

586 
NVMF_OPT_TRANSPORT
:

587 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

588 ià(!
p
) {

589 
»t
 = -
ENOMEM
;

590 
out
;

592 
İts
->
Œª¥Üt
 = 
p
;

594 
NVMF_OPT_NQN
:

595 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

596 ià(!
p
) {

597 
»t
 = -
ENOMEM
;

598 
out
;

600 
İts
->
subsy¢qn
 = 
p
;

601 
nqÆ’
 = 
	`¡¾’
(
İts
->
subsy¢qn
);

602 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

603 
	`´_”r
("%s‚eedso be < %d bytes\n",

604 
İts
->
subsy¢qn
, 
NVMF_NQN_SIZE
);

605 
»t
 = -
EINVAL
;

606 
out
;

608 
İts
->
discov”y_nqn
 =

609 !(
	`¡rcmp
(
İts
->
subsy¢qn
,

610 
NVME_DISC_SUBSYS_NAME
));

611 ià(
İts
->
discov”y_nqn
)

612 
İts
->
Ä_io_queues
 = 0;

614 
NVMF_OPT_TRADDR
:

615 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

616 ià(!
p
) {

617 
»t
 = -
ENOMEM
;

618 
out
;

620 
İts
->
Œaddr
 = 
p
;

622 
NVMF_OPT_TRSVCID
:

623 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

624 ià(!
p
) {

625 
»t
 = -
ENOMEM
;

626 
out
;

628 
İts
->
Œsvcid
 = 
p
;

630 
NVMF_OPT_QUEUE_SIZE
:

631 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

632 
»t
 = -
EINVAL
;

633 
out
;

635 ià(
tok’
 < 
NVMF_MIN_QUEUE_SIZE
 ||

636 
tok’
 > 
NVMF_MAX_QUEUE_SIZE
) {

637 
	`´_”r
("Inv®id queue_siz%d\n", 
tok’
);

638 
»t
 = -
EINVAL
;

639 
out
;

641 
İts
->
queue_size
 = 
tok’
;

643 
NVMF_OPT_NR_IO_QUEUES
:

644 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

645 
»t
 = -
EINVAL
;

646 
out
;

648 ià(
tok’
 <= 0) {

649 
	`´_”r
("Inv®id‚umb” oàIOQ %d\n", 
tok’
);

650 
»t
 = -
EINVAL
;

651 
out
;

653 
İts
->
Ä_io_queues
 = 
	`mš_t
(,

654 
	`num_Úlše_ıus
(), 
tok’
);

656 
NVMF_OPT_KATO
:

657 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

658 
»t
 = -
EINVAL
;

659 
out
;

662 ià(
tok’
 < 0) {

663 
	`´_”r
("Inv®id k“p_®ive_tmØ%d\n", 
tok’
);

664 
»t
 = -
EINVAL
;

665 
out
;

666 } ià(
tok’
 =ğ0 && !
İts
->
discov”y_nqn
) {

668 
	`´_w¬n
("keep_alive_tmo 0 won'tƒxecute keep‡lives!!!\n");

670 
İts
->
k©o
 = 
tok’
;

672 ià(
İts
->
discov”y_nqn
 && o±s->
k©o
) {

673 
	`´_”r
("Discovery controllers cannot‡ccept KATO != 0\n");

674 
»t
 = -
EINVAL
;

675 
out
;

679 
NVMF_OPT_CTRL_LOSS_TMO
:

680 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

681 
»t
 = -
EINVAL
;

682 
out
;

685 ià(
tok’
 < 0)

686 
	`´_w¬n
("ctrl_loss_tmo < 0 will„econnect forever\n");

687 
ù¾_loss_tmo
 = 
tok’
;

689 
NVMF_OPT_HOSTNQN
:

690 ià(
İts
->
ho¡
) {

691 
	`´_”r
("hostnqn‡lready user-assigned: %s\n",

692 
İts
->
ho¡
->
nqn
);

693 
»t
 = -
EADDRINUSE
;

694 
out
;

696 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

697 ià(!
p
) {

698 
»t
 = -
ENOMEM
;

699 
out
;

701 
nqÆ’
 = 
	`¡¾’
(
p
);

702 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

703 
	`´_”r
("%s‚eedso be < %d bytes\n",

704 
p
, 
NVMF_NQN_SIZE
);

705 
	`kä“
(
p
);

706 
»t
 = -
EINVAL
;

707 
out
;

709 
İts
->
ho¡
 = 
	`nvmf_ho¡_add
(
p
);

710 
	`kä“
(
p
);

711 ià(!
İts
->
ho¡
) {

712 
»t
 = -
ENOMEM
;

713 
out
;

716 
NVMF_OPT_RECONNECT_DELAY
:

717 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

718 
»t
 = -
EINVAL
;

719 
out
;

721 ià(
tok’
 <= 0) {

722 
	`´_”r
("Inv®id„ecÚÃù_d–ay %d\n", 
tok’
);

723 
»t
 = -
EINVAL
;

724 
out
;

726 
İts
->
»cÚÃù_d–ay
 = 
tok’
;

728 
NVMF_OPT_HOST_TRADDR
:

729 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

730 ià(!
p
) {

731 
»t
 = -
ENOMEM
;

732 
out
;

734 
İts
->
ho¡_Œaddr
 = 
p
;

736 
NVMF_OPT_HOST_ID
:

737 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

738 ià(!
p
) {

739 
»t
 = -
ENOMEM
;

740 
out
;

742 ià(
	`uuid_·r£
(
p
, &
ho¡id
)) {

743 
	`´_”r
("Inv®id ho¡id %s\n", 
p
);

744 
»t
 = -
EINVAL
;

745 
out
;

748 
NVMF_OPT_DUP_CONNECT
:

749 
İts
->
du¶iÿ‹_cÚÃù
 = 
Œue
;

752 
	`´_w¬n
("unknown…arameter or missing value '%s' in ctrl creation„equest\n",

753 
p
);

754 
»t
 = -
EINVAL
;

755 
out
;

759 ià(
ù¾_loss_tmo
 < 0)

760 
İts
->
max_»cÚÃùs
 = -1;

762 
İts
->
max_»cÚÃùs
 = 
	`DIV_ROUND_UP
(
ù¾_loss_tmo
,

763 
İts
->
»cÚÃù_d–ay
);

765 ià(!
İts
->
ho¡
) {

766 
	`k»f_g‘
(&
nvmf_deçuÉ_ho¡
->
»f
);

767 
İts
->
ho¡
 = 
nvmf_deçuÉ_ho¡
;

770 
	`uuid_cİy
(&
İts
->
ho¡
->
id
, &
ho¡id
);

772 
out
:

773 
	`kä“
(
İtiÚs
);

774  
»t
;

775 
	}
}

777 
	$nvmf_check_»quœed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

778 
»quœed_İts
)

780 ià((
İts
->
mask
 & 
»quœed_İts
) !=„equired_opts) {

781 
i
;

783 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

784 ià((
İt_tok’s
[
i
].
tok’
 & 
»quœed_İts
) &&

785 !(
İt_tok’s
[
i
].
tok’
 & 
İts
->
mask
)) {

786 
	`´_w¬n
("missing…arameter '%s'\n",

787 
İt_tok’s
[
i
].
·‰”n
);

791  -
EINVAL
;

795 
	}
}

797 
	$nvmf_check_®lowed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

798 
®lowed_İts
)

800 ià(
İts
->
mask
 & ~
®lowed_İts
) {

801 
i
;

803 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

804 ià((
İt_tok’s
[
i
].
tok’
 & 
İts
->
mask
) &&

805 (
İt_tok’s
[
i
].
tok’
 & ~
®lowed_İts
)) {

806 
	`´_w¬n
("invalid…arameter '%s'\n",

807 
İt_tok’s
[
i
].
·‰”n
);

811  -
EINVAL
;

815 
	}
}

817 
	$nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
)

819 
	`nvmf_ho¡_put
(
İts
->
ho¡
);

820 
	`kä“
(
İts
->
Œª¥Üt
);

821 
	`kä“
(
İts
->
Œaddr
);

822 
	`kä“
(
İts
->
Œsvcid
);

823 
	`kä“
(
İts
->
subsy¢qn
);

824 
	`kä“
(
İts
->
ho¡_Œaddr
);

825 
	`kä“
(
İts
);

826 
	}
}

827 
EXPORT_SYMBOL_GPL
(
nvmf_ä“_İtiÚs
);

829 
	#NVMF_REQUIRED_OPTS
 (
NVMF_OPT_TRANSPORT
 | 
NVMF_OPT_NQN
)

	)

830 
	#NVMF_ALLOWED_OPTS
 (
NVMF_OPT_QUEUE_SIZE
 | 
NVMF_OPT_NR_IO_QUEUES
 | \

831 
NVMF_OPT_KATO
 | 
NVMF_OPT_HOSTNQN
 | \

832 
NVMF_OPT_HOST_ID
 | 
NVMF_OPT_DUP_CONNECT
)

	)

834 
nvme_ù¾
 *

835 
	$nvmf_ü—‹_ù¾
(
deviû
 *
dev
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

837 
nvmf_ù¾_İtiÚs
 *
İts
;

838 
nvmf_Œª¥Üt_İs
 *
İs
;

839 
nvme_ù¾
 *
ù¾
;

840 
»t
;

842 
İts
 = 
	`kz®loc
((*İts), 
GFP_KERNEL
);

843 ià(!
İts
)

844  
	`ERR_PTR
(-
ENOMEM
);

846 
»t
 = 
	`nvmf_·r£_İtiÚs
(
İts
, 
buf
);

847 ià(
»t
)

848 
out_ä“_İts
;

851 
	`»que¡_moduË
("nvme-%s", 
İts
->
Œª¥Üt
);

858 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
NVMF_REQUIRED_OPTS
);

859 ià(
»t
)

860 
out_ä“_İts
;

861 
İts
->
mask
 &ğ~
NVMF_REQUIRED_OPTS
;

863 
	`down_»ad
(&
nvmf_Œª¥Üts_rw£m
);

864 
İs
 = 
	`nvmf_lookup_Œª¥Üt
(
İts
);

865 ià(!
İs
) {

866 
	`´_šfo
("no handler found forransport %s.\n",

867 
İts
->
Œª¥Üt
);

868 
»t
 = -
EINVAL
;

869 
out_uÆock
;

872 ià(!
	`Œy_moduË_g‘
(
İs
->
moduË
)) {

873 
»t
 = -
EBUSY
;

874 
out_uÆock
;

877 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
İs
->
»quœed_İts
);

878 ià(
»t
)

879 
out_moduË_put
;

880 
»t
 = 
	`nvmf_check_®lowed_İts
(
İts
, 
NVMF_ALLOWED_OPTS
 |

881 
İs
->
®lowed_İts
 | ops->
»quœed_İts
);

882 ià(
»t
)

883 
out_moduË_put
;

885 
ù¾
 = 
İs
->
	`ü—‹_ù¾
(
dev
, 
İts
);

886 ià(
	`IS_ERR
(
ù¾
)) {

887 
»t
 = 
	`PTR_ERR
(
ù¾
);

888 
out_moduË_put
;

891 ià(
	`¡rcmp
(
ù¾
->
subsys
->
subnqn
, 
İts
->
subsy¢qn
)) {

892 
	`dev_w¬n
(
ù¾
->
deviû
,

894 
ù¾
->
subsys
->
subnqn
);

895 
	`moduË_put
(
İs
->
moduË
);

896 
	`up_»ad
(&
nvmf_Œª¥Üts_rw£m
);

897 
	`nvme_d–‘e_ù¾_sync
(
ù¾
);

898  
	`ERR_PTR
(-
EINVAL
);

901 
	`moduË_put
(
İs
->
moduË
);

902 
	`up_»ad
(&
nvmf_Œª¥Üts_rw£m
);

903  
ù¾
;

905 
out_moduË_put
:

906 
	`moduË_put
(
İs
->
moduË
);

907 
out_uÆock
:

908 
	`up_»ad
(&
nvmf_Œª¥Üts_rw£m
);

909 
out_ä“_İts
:

910 
	`nvmf_ä“_İtiÚs
(
İts
);

911  
	`ERR_PTR
(
»t
);

912 
	}
}

914 
şass
 *
	gnvmf_şass
;

915 
deviû
 *
	gnvmf_deviû
;

916 
DEFINE_MUTEX
(
nvmf_dev_mu‹x
);

918 
ssize_t
 
	$nvmf_dev_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
ubuf
,

919 
size_t
 
couÁ
, 
loff_t
 *
pos
)

921 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

922 
nvme_ù¾
 *
ù¾
;

923 cÚ¡ *
buf
;

924 
»t
 = 0;

926 ià(
couÁ
 > 
PAGE_SIZE
)

927  -
ENOMEM
;

929 
buf
 = 
	`memdup_u£r_nul
(
ubuf
, 
couÁ
);

930 ià(
	`IS_ERR
(
buf
))

931  
	`PTR_ERR
(
buf
);

933 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

934 ià(
£q_fe
->
´iv©e
) {

935 
»t
 = -
EINVAL
;

936 
out_uÆock
;

939 
ù¾
 = 
	`nvmf_ü—‹_ù¾
(
nvmf_deviû
, 
buf
, 
couÁ
);

940 ià(
	`IS_ERR
(
ù¾
)) {

941 
»t
 = 
	`PTR_ERR
(
ù¾
);

942 
out_uÆock
;

945 
£q_fe
->
´iv©e
 = 
ù¾
;

947 
out_uÆock
:

948 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

949 
	`kä“
(
buf
);

950  
»t
 ?„‘ : 
couÁ
;

951 
	}
}

953 
	$nvmf_dev_show
(
£q_fe
 *£q_fe, *
´iv©e
)

955 
nvme_ù¾
 *
ù¾
;

956 
»t
 = 0;

958 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

959 
ù¾
 = 
£q_fe
->
´iv©e
;

960 ià(!
ù¾
) {

961 
»t
 = -
EINVAL
;

962 
out_uÆock
;

965 
	`£q_´štf
(
£q_fe
, "instance=%d,cntlid=%d\n",

966 
ù¾
->
š¡ªû
, cŒl->
úid
);

968 
out_uÆock
:

969 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

970  
»t
;

971 
	}
}

973 
	$nvmf_dev_İ’
(
šode
 *šode, 
fe
 *file)

979 
fe
->
´iv©e_d©a
 = 
NULL
;

980  
	`sšgË_İ’
(
fe
, 
nvmf_dev_show
, 
NULL
);

981 
	}
}

983 
	$nvmf_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

985 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

986 
nvme_ù¾
 *
ù¾
 = 
£q_fe
->
´iv©e
;

988 ià(
ù¾
)

989 
	`nvme_put_ù¾
(
ù¾
);

990  
	`sšgË_»Ëa£
(
šode
, 
fe
);

991 
	}
}

993 cÚ¡ 
fe_İ”©iÚs
 
	gnvmf_dev_fİs
 = {

994 .
owÃr
 = 
THIS_MODULE
,

995 .
	gwr™e
 = 
nvmf_dev_wr™e
,

996 .
	g»ad
 = 
£q_»ad
,

997 .
	gİ’
 = 
nvmf_dev_İ’
,

998 .
	g»Ëa£
 = 
nvmf_dev_»Ëa£
,

1001 
miscdeviû
 
	gnvmf_misc
 = {

1002 .
mšÜ
 = 
MISC_DYNAMIC_MINOR
,

1003 .
	gÇme
 = "nvme-fabrics",

1004 .
	gfİs
 = &
nvmf_dev_fİs
,

1007 
__š™
 
	$nvmf_š™
()

1009 
»t
;

1011 
nvmf_deçuÉ_ho¡
 = 
	`nvmf_ho¡_deçuÉ
();

1012 ià(!
nvmf_deçuÉ_ho¡
)

1013  -
ENOMEM
;

1015 
nvmf_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme-fabrics");

1016 ià(
	`IS_ERR
(
nvmf_şass
)) {

1017 
	`´_”r
("couldn't„egister class‚vme-fabrics\n");

1018 
»t
 = 
	`PTR_ERR
(
nvmf_şass
);

1019 
out_ä“_ho¡
;

1022 
nvmf_deviû
 =

1023 
	`deviû_ü—‹
(
nvmf_şass
, 
NULL
, 
	`MKDEV
(0, 0), NULL, "ctl");

1024 ià(
	`IS_ERR
(
nvmf_deviû
)) {

1025 
	`´_”r
("couldn't create‚vme-fabris device!\n");

1026 
»t
 = 
	`PTR_ERR
(
nvmf_deviû
);

1027 
out_de¡roy_şass
;

1030 
»t
 = 
	`misc_»gi¡”
(&
nvmf_misc
);

1031 ià(
»t
) {

1032 
	`´_”r
("couldn'ˆ»gi¡” misødeviû: %d\n", 
»t
);

1033 
out_de¡roy_deviû
;

1038 
out_de¡roy_deviû
:

1039 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

1040 
out_de¡roy_şass
:

1041 
	`şass_de¡roy
(
nvmf_şass
);

1042 
out_ä“_ho¡
:

1043 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1044  
»t
;

1045 
	}
}

1047 
__ex™
 
	$nvmf_ex™
()

1049 
	`misc_d”egi¡”
(&
nvmf_misc
);

1050 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

1051 
	`şass_de¡roy
(
nvmf_şass
);

1052 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

1054 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_commªd
) != 64);

1055 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_g‘_commªd
) != 64);

1056 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_£t_commªd
) != 64);

1057 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_d©a
) != 1024);

1058 
	}
}

1060 
MODULE_LICENSE
("GPL v2");

1062 
moduË_š™
(
nvmf_š™
);

1063 
moduË_ex™
(
nvmf_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/fabrics.h

14 #iâdeà
_NVME_FABRICS_H


15 
	#_NVME_FABRICS_H
 1

	)

17 
	~<lšux/š.h
>

18 
	~<lšux/š‘.h
>

20 
	#NVMF_MIN_QUEUE_SIZE
 16

	)

21 
	#NVMF_MAX_QUEUE_SIZE
 1024

	)

22 
	#NVMF_DEF_QUEUE_SIZE
 128

	)

23 
	#NVMF_DEF_RECONNECT_DELAY
 10

	)

25 
	#NVMF_DEF_CTRL_LOSS_TMO
 600

	)

35 
	snvmf_ho¡
 {

36 
k»f
 
	m»f
;

37 
li¡_h—d
 
	mli¡
;

38 
	mnqn
[
NVMF_NQN_SIZE
];

39 
uuid_t
 
	mid
;

46 
	mNVMF_OPT_ERR
 = 0,

47 
	mNVMF_OPT_TRANSPORT
 = 1 << 0,

48 
	mNVMF_OPT_NQN
 = 1 << 1,

49 
	mNVMF_OPT_TRADDR
 = 1 << 2,

50 
	mNVMF_OPT_TRSVCID
 = 1 << 3,

51 
	mNVMF_OPT_QUEUE_SIZE
 = 1 << 4,

52 
	mNVMF_OPT_NR_IO_QUEUES
 = 1 << 5,

53 
	mNVMF_OPT_TL_RETRY_COUNT
 = 1 << 6,

54 
	mNVMF_OPT_KATO
 = 1 << 7,

55 
	mNVMF_OPT_HOSTNQN
 = 1 << 8,

56 
	mNVMF_OPT_RECONNECT_DELAY
 = 1 << 9,

57 
	mNVMF_OPT_HOST_TRADDR
 = 1 << 10,

58 
	mNVMF_OPT_CTRL_LOSS_TMO
 = 1 << 11,

59 
	mNVMF_OPT_HOST_ID
 = 1 << 12,

60 
	mNVMF_OPT_DUP_CONNECT
 = 1 << 13,

89 
	snvmf_ù¾_İtiÚs
 {

90 
	mmask
;

91 *
	mŒª¥Üt
;

92 *
	msubsy¢qn
;

93 *
	mŒaddr
;

94 *
	mŒsvcid
;

95 *
	mho¡_Œaddr
;

96 
size_t
 
	mqueue_size
;

97 
	mÄ_io_queues
;

98 
	m»cÚÃù_d–ay
;

99 
boŞ
 
	mdiscov”y_nqn
;

100 
boŞ
 
	mdu¶iÿ‹_cÚÃù
;

101 
	mk©o
;

102 
nvmf_ho¡
 *
	mho¡
;

103 
	mmax_»cÚÃùs
;

128 
	snvmf_Œª¥Üt_İs
 {

129 
li¡_h—d
 
	m’Œy
;

130 
moduË
 *
	mmoduË
;

131 cÚ¡ *
	mÇme
;

132 
	m»quœed_İts
;

133 
	m®lowed_İts
;

134 
	mnvme_ù¾
 *(*
	mü—‹_ù¾
)(
deviû
 *
	mdev
,

135 
nvmf_ù¾_İtiÚs
 *
	mİts
);

138 
šlše
 
boŞ


139 
	$nvmf_ùÌ_m©ches_ba£İts
(
nvme_ù¾
 *
ù¾
,

140 
nvmf_ù¾_İtiÚs
 *
İts
)

142 ià(
	`¡rcmp
(
İts
->
subsy¢qn
, 
ù¾
->opts->subsysnqn) ||

143 
	`¡rcmp
(
İts
->
ho¡
->
nqn
, 
ù¾
->opts->host->nqn) ||

144 
	`memcmp
(&
İts
->
ho¡
->
id
, &
ù¾
->İts->ho¡->id, (
uuid_t
)))

145  
çl£
;

147  
Œue
;

148 
	}
}

150 
nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
);

151 
nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
);

152 
nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
);

153 
nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
);

154 
nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
);

155 
nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

156 
nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

157 
nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
);

158 
nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
);

159 
boŞ
 
nvmf_should_»cÚÃù
(
nvme_ù¾
 *
ù¾
);

161 
šlše
 
blk_¡©us_t
 
	$nvmf_check_š™_»q
(
nvme_ù¾
 *
ù¾
,

162 
»que¡
 *
rq
)

164 
nvme_commªd
 *
cmd
 = 
	`nvme_»q
(
rq
)->cmd;

170 ià(!
	`blk_rq_is_·s¡hrough
(
rq
) ||

171 
cmd
->
commÚ
.
İcode
 !ğ
nvme_çbrics_commªd
 ||

172 
cmd
->
çbrics
.
fùy³
 !ğ
nvme_çbrics_ty³_cÚÃù
) {

180 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_RECONNECTING
 ||

181 
ù¾
->
¡©e
 =ğ
NVME_CTRL_DELETING
) {

182 
	`nvme_»q
(
rq
)->
¡©us
 = 
NVME_SC_ABORT_REQ
;

183  
BLK_STS_IOERR
;

185  
BLK_STS_RESOURCE
;

188  
BLK_STS_OK
;

189 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/fc.c

17 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

18 
	~<lšux/moduË.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<u­i/scsi/fc/fc_fs.h
>

21 
	~<u­i/scsi/fc/fc_–s.h
>

22 
	~<lšux/d–ay.h
>

24 
	~"nvme.h
"

25 
	~"çbrics.h
"

26 
	~<lšux/nvme-fc-driv”.h
>

27 
	~<lšux/nvme-fc.h
>

33 
	envme_fc_queue_æags
 {

34 
	mNVME_FC_Q_CONNECTED
 = 0,

35 
	mNVME_FC_Q_LIVE
,

38 
	#NVMEFC_QUEUE_DELAY
 3

	)

40 
	#NVME_FC_DEFAULT_DEV_LOSS_TMO
 60

	)

42 
	snvme_fc_queue
 {

43 
nvme_fc_ù¾
 *
	mù¾
;

44 
deviû
 *
	mdev
;

45 
blk_mq_hw_ùx
 *
	mhùx
;

46 *
	mÎdd_hªdË
;

47 
size_t
 
	mcmnd_ÿpsuË_Ën
;

48 
u32
 
	mqnum
;

49 
u32
 
	mrqút
;

50 
u32
 
	m£qno
;

52 
u64
 
	mcÚÃùiÚ_id
;

53 
©omic_t
 
	mc¢
;

55 
	mæags
;

56 } 
__®igÃd
((
u64
));

58 
	envme_fcİ_æags
 {

59 
	mFCOP_FLAGS_TERMIO
 = (1 << 0),

60 
	mFCOP_FLAGS_RELEASED
 = (1 << 1),

61 
	mFCOP_FLAGS_COMPLETE
 = (1 << 2),

62 
	mFCOP_FLAGS_AEN
 = (1 << 3),

65 
	snvmefc_ls_»q_İ
 {

66 
nvmefc_ls_»q
 
	mls_»q
;

68 
nvme_fc_½Üt
 *
	m½Üt
;

69 
nvme_fc_queue
 *
	mqueue
;

70 
»que¡
 *
	mrq
;

71 
u32
 
	mæags
;

73 
	mls_”rÜ
;

74 
com¶‘iÚ
 
	mls_dÚe
;

75 
li¡_h—d
 
	ml¤eq_li¡
;

76 
boŞ
 
	m»q_queued
;

79 
	envme_fıİ_¡©e
 {

80 
	mFCPOP_STATE_UNINIT
 = 0,

81 
	mFCPOP_STATE_IDLE
 = 1,

82 
	mFCPOP_STATE_ACTIVE
 = 2,

83 
	mFCPOP_STATE_ABORTED
 = 3,

84 
	mFCPOP_STATE_COMPLETE
 = 4,

87 
	snvme_fc_fı_İ
 {

88 
nvme_»que¡
 
	mÄeq
;

96 
nvmefc_fı_»q
 
	mfı_»q
;

98 
nvme_fc_ù¾
 *
	mù¾
;

99 
nvme_fc_queue
 *
	mqueue
;

100 
»que¡
 *
	mrq
;

102 
©omic_t
 
	m¡©e
;

103 
u32
 
	mæags
;

104 
u32
 
	mrqno
;

105 
u32
 
	mÃÁs
;

107 
nvme_fc_cmd_iu
 
	mcmd_iu
;

108 
nvme_fc_”¥_iu
 
	mr¥_iu
;

111 
	snvme_fc_ÍÜt
 {

112 
nvme_fc_loÿl_pÜt
 
	mloÿÍÜt
;

114 
ida
 
	m’dp_út
;

115 
li¡_h—d
 
	mpÜt_li¡
;

116 
li¡_h—d
 
	m’dp_li¡
;

117 
deviû
 *
	mdev
;

118 
nvme_fc_pÜt_‹m¶©e
 *
	mİs
;

119 
k»f
 
	m»f
;

120 
©omic_t
 
	maù_½Üt_út
;

121 } 
__®igÃd
((
u64
));

123 
	snvme_fc_½Üt
 {

124 
nvme_fc_»mÙe_pÜt
 
	m»mÙ•Üt
;

126 
li¡_h—d
 
	m’dp_li¡
;

127 
li¡_h—d
 
	mù¾_li¡
;

128 
li¡_h—d
 
	mls_»q_li¡
;

129 
deviû
 *
	mdev
;

130 
nvme_fc_ÍÜt
 *
	mÍÜt
;

131 
¥šlock_t
 
	mlock
;

132 
k»f
 
	m»f
;

133 
©omic_t
 
	maù_ù¾_út
;

134 
	mdev_loss_’d
;

135 } 
__®igÃd
((
u64
));

137 
	envme_fcù¾_æags
 {

138 
	mFCCTRL_TERMIO
 = (1 << 0),

141 
	snvme_fc_ù¾
 {

142 
¥šlock_t
 
	mlock
;

143 
nvme_fc_queue
 *
	mqueues
;

144 
deviû
 *
	mdev
;

145 
nvme_fc_ÍÜt
 *
	mÍÜt
;

146 
nvme_fc_½Üt
 *
	m½Üt
;

147 
u32
 
	múum
;

149 
boŞ
 
	massoc_aùive
;

150 
u64
 
	massocŸtiÚ_id
;

152 
li¡_h—d
 
	mù¾_li¡
;

154 
blk_mq_g_£t
 
	madmš_g_£t
;

155 
blk_mq_g_£t
 
	mg_£t
;

157 
d–ayed_wÜk
 
	mcÚÃù_wÜk
;

159 
k»f
 
	m»f
;

160 
u32
 
	mæags
;

161 
u32
 
	mioút
;

162 
wa™_queue_h—d_t
 
	mißbÜt_wa™
;

164 
nvme_fc_fı_İ
 
	m«n_İs
[
NVME_NR_AEN_COMMANDS
];

166 
nvme_ù¾
 
	mù¾
;

169 
šlše
 
nvme_fc_ù¾
 *

170 
	$to_fc_ù¾
(
nvme_ù¾
 *
ù¾
)

172  
	`cÚš”_of
(
ù¾
, 
nvme_fc_ù¾
, ctrl);

173 
	}
}

175 
šlše
 
nvme_fc_ÍÜt
 *

176 
	$loÿÍÜt_to_ÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

178  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_ÍÜt
, 
loÿÍÜt
);

179 
	}
}

181 
šlše
 
nvme_fc_½Üt
 *

182 
	$»mÙ•Üt_to_½Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

184  
	`cÚš”_of
(
pÜŒ
, 
nvme_fc_½Üt
, 
»mÙ•Üt
);

185 
	}
}

187 
šlše
 
nvmefc_ls_»q_İ
 *

188 
	$ls_»q_to_lsİ
(
nvmefc_ls_»q
 *
l¤eq
)

190  
	`cÚš”_of
(
l¤eq
, 
nvmefc_ls_»q_İ
, 
ls_»q
);

191 
	}
}

193 
šlše
 
nvme_fc_fı_İ
 *

194 
	$fı_»q_to_fı_İ
(
nvmefc_fı_»q
 *
fı»q
)

196  
	`cÚš”_of
(
fı»q
, 
nvme_fc_fı_İ
, 
fı_»q
);

197 
	}
}

204 
DEFINE_SPINLOCK
(
nvme_fc_lock
);

206 
LIST_HEAD
(
nvme_fc_ÍÜt_li¡
);

207 
DEFINE_IDA
(
nvme_fc_loÿl_pÜt_út
);

208 
DEFINE_IDA
(
nvme_fc_ù¾_út
);

216 
şass
 *
	gfc_şass
;

217 
deviû
 *
	gfc_udev_deviû
;

222 
__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *,

223 
nvme_fc_queue
 *, );

226 
	$nvme_fc_ä“_ÍÜt
(
k»f
 *
»f
)

228 
nvme_fc_ÍÜt
 *
ÍÜt
 =

229 
	`cÚš”_of
(
»f
, 
nvme_fc_ÍÜt
,„ef);

230 
æags
;

232 
	`WARN_ON
(
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
);

233 
	`WARN_ON
(!
	`li¡_em±y
(&
ÍÜt
->
’dp_li¡
));

236 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

237 
	`li¡_d–
(&
ÍÜt
->
pÜt_li¡
);

238 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

240 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
ÍÜt
->
loÿÍÜt
.
pÜt_num
);

241 
	`ida_de¡roy
(&
ÍÜt
->
’dp_út
);

243 
	`put_deviû
(
ÍÜt
->
dev
);

245 
	`kä“
(
ÍÜt
);

246 
	}
}

249 
	$nvme_fc_ÍÜt_put
(
nvme_fc_ÍÜt
 *
ÍÜt
)

251 
	`k»f_put
(&
ÍÜt
->
»f
, 
nvme_fc_ä“_ÍÜt
);

252 
	}
}

255 
	$nvme_fc_ÍÜt_g‘
(
nvme_fc_ÍÜt
 *
ÍÜt
)

257  
	`k»f_g‘_uÆess_z”o
(&
ÍÜt
->
»f
);

258 
	}
}

261 
nvme_fc_ÍÜt
 *

262 
	$nvme_fc_©ch_to_uÄeg_ÍÜt
(
nvme_fc_pÜt_šfo
 *
pšfo
,

263 
nvme_fc_pÜt_‹m¶©e
 *
İs
,

264 
deviû
 *
dev
)

266 
nvme_fc_ÍÜt
 *
ÍÜt
;

267 
æags
;

269 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

271 
	`li¡_fÜ_—ch_’Œy
(
ÍÜt
, &
nvme_fc_ÍÜt_li¡
, 
pÜt_li¡
) {

272 ià(
ÍÜt
->
loÿÍÜt
.
node_Çme
 !ğ
pšfo
->node_name ||

273 
ÍÜt
->
loÿÍÜt
.
pÜt_Çme
 !ğ
pšfo
->port_name)

276 ià(
ÍÜt
->
dev
 != dev) {

277 
ÍÜt
 = 
	`ERR_PTR
(-
EXDEV
);

278 
out_dÚe
;

281 ià(
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
) {

282 
ÍÜt
 = 
	`ERR_PTR
(-
EEXIST
);

283 
out_dÚe
;

286 ià(!
	`nvme_fc_ÍÜt_g‘
(
ÍÜt
)) {

291 
ÍÜt
 = 
NULL
;

292 
out_dÚe
;

297 
ÍÜt
->
İs
 = ops;

298 
ÍÜt
->
loÿÍÜt
.
pÜt_rŞe
 = 
pšfo
->port_role;

299 
ÍÜt
->
loÿÍÜt
.
pÜt_id
 = 
pšfo
->port_id;

300 
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

302 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

304  
ÍÜt
;

307 
ÍÜt
 = 
NULL
;

309 
out_dÚe
:

310 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

312  
ÍÜt
;

313 
	}
}

333 
	$nvme_fc_»gi¡”_loÿÍÜt
(
nvme_fc_pÜt_šfo
 *
pšfo
,

334 
nvme_fc_pÜt_‹m¶©e
 *
‹m¶©e
,

335 
deviû
 *
dev
,

336 
nvme_fc_loÿl_pÜt
 **
pÜŒ
)

338 
nvme_fc_ÍÜt
 *
Ãw»c
;

339 
æags
;

340 
»t
, 
idx
;

342 ià(!
‹m¶©e
->
loÿÍÜt_d–‘e
 || !‹m¶©e->
»mÙ•Üt_d–‘e
 ||

343 !
‹m¶©e
->
ls_»q
 || !‹m¶©e->
fı_io
 ||

344 !
‹m¶©e
->
ls_abÜt
 || !‹m¶©e->
fı_abÜt
 ||

345 !
‹m¶©e
->
max_hw_queues
 || !‹m¶©e->
max_sgl_£gm’ts
 ||

346 !
‹m¶©e
->
max_dif_sgl_£gm’ts
 || !‹m¶©e->
dma_bound¬y
) {

347 
»t
 = -
EINVAL
;

348 
out_»gho¡_çed
;

358 
Ãw»c
 = 
	`nvme_fc_©ch_to_uÄeg_ÍÜt
(
pšfo
, 
‹m¶©e
, 
dev
);

361 ià(
	`IS_ERR
(
Ãw»c
)) {

362 
»t
 = 
	`PTR_ERR
(
Ãw»c
);

363 
out_»gho¡_çed
;

366 } ià(
Ãw»c
) {

367 *
pÜŒ
 = &
Ãw»c
->
loÿÍÜt
;

373 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
‹m¶©e
->
loÿl_´iv_sz
),

374 
GFP_KERNEL
);

375 ià(!
Ãw»c
) {

376 
»t
 = -
ENOMEM
;

377 
out_»gho¡_çed
;

380 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_loÿl_pÜt_út
, 0, 0, 
GFP_KERNEL
);

381 ià(
idx
 < 0) {

382 
»t
 = -
ENOSPC
;

383 
out_ç_kä“
;

386 ià(!
	`g‘_deviû
(
dev
) && dev) {

387 
»t
 = -
ENODEV
;

388 
out_ida_put
;

391 
	`INIT_LIST_HEAD
(&
Ãw»c
->
pÜt_li¡
);

392 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

393 
	`k»f_š™
(&
Ãw»c
->
»f
);

394 
	`©omic_£t
(&
Ãw»c
->
aù_½Üt_út
, 0);

395 
Ãw»c
->
İs
 = 
‹m¶©e
;

396 
Ãw»c
->
dev
 = dev;

397 
	`ida_š™
(&
Ãw»c
->
’dp_út
);

398 
Ãw»c
->
loÿÍÜt
.
´iv©e
 = &newrec[1];

399 
Ãw»c
->
loÿÍÜt
.
node_Çme
 = 
pšfo
->node_name;

400 
Ãw»c
->
loÿÍÜt
.
pÜt_Çme
 = 
pšfo
->port_name;

401 
Ãw»c
->
loÿÍÜt
.
pÜt_rŞe
 = 
pšfo
->port_role;

402 
Ãw»c
->
loÿÍÜt
.
pÜt_id
 = 
pšfo
->port_id;

403 
Ãw»c
->
loÿÍÜt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

404 
Ãw»c
->
loÿÍÜt
.
pÜt_num
 = 
idx
;

406 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

407 
	`li¡_add_
(&
Ãw»c
->
pÜt_li¡
, &
nvme_fc_ÍÜt_li¡
);

408 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

410 ià(
dev
)

411 
	`dma_£t_£g_bound¬y
(
dev
, 
‹m¶©e
->
dma_bound¬y
);

413 *
pÜŒ
 = &
Ãw»c
->
loÿÍÜt
;

416 
out_ida_put
:

417 
	`ida_sim¶e_»move
(&
nvme_fc_loÿl_pÜt_út
, 
idx
);

418 
out_ç_kä“
:

419 
	`kä“
(
Ãw»c
);

420 
out_»gho¡_çed
:

421 *
pÜŒ
 = 
NULL
;

423  
»t
;

424 
	}
}

425 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_loÿÍÜt
);

439 
	$nvme_fc_uÄegi¡”_loÿÍÜt
(
nvme_fc_loÿl_pÜt
 *
pÜŒ
)

441 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
pÜŒ
);

442 
æags
;

444 ià(!
pÜŒ
)

445  -
EINVAL
;

447 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

449 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

450 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

451  -
EINVAL
;

453 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

455 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

457 ià(
	`©omic_»ad
(&
ÍÜt
->
aù_½Üt_út
) == 0)

458 
ÍÜt
->
İs
->
	`loÿÍÜt_d–‘e
(&ÍÜt->
loÿÍÜt
);

460 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

463 
	}
}

464 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_loÿÍÜt
);

474 
	#FCNVME_TRADDR_LENGTH
 64

	)

477 
	$nvme_fc_sigÇl_discov”y_sÿn
(
nvme_fc_ÍÜt
 *
ÍÜt
,

478 
nvme_fc_½Üt
 *
½Üt
)

480 
ho¡addr
[
FCNVME_TRADDR_LENGTH
];

481 
tgddr
[
FCNVME_TRADDR_LENGTH
];

482 *
’vp
[4] = { "FC_EVENTòvmediscov”y", 
ho¡addr
, 
tgddr
, 
NULL
 };

484 ià(!(
½Üt
->
»mÙ•Üt
.
pÜt_rŞe
 & 
FC_PORT_ROLE_NVME_DISCOVERY
))

487 
	`¢´štf
(
ho¡addr
, (hostaddr),

489 
ÍÜt
->
loÿÍÜt
.
node_Çme
,†pÜt->loÿÍÜt.
pÜt_Çme
);

490 
	`¢´štf
(
tgddr
, (tgtaddr),

492 
½Üt
->
»mÙ•Üt
.
node_Çme
,„pÜt->»mÙ•Üt.
pÜt_Çme
);

493 
	`kobjeù_uev’t_’v
(&
fc_udev_deviû
->
kobj
, 
KOBJ_CHANGE
, 
’vp
);

494 
	}
}

497 
	$nvme_fc_ä“_½Üt
(
k»f
 *
»f
)

499 
nvme_fc_½Üt
 *
½Üt
 =

500 
	`cÚš”_of
(
»f
, 
nvme_fc_½Üt
,„ef);

501 
nvme_fc_ÍÜt
 *
ÍÜt
 =

502 
	`loÿÍÜt_to_ÍÜt
(
½Üt
->
»mÙ•Üt
.
loÿÍÜt
);

503 
æags
;

505 
	`WARN_ON
(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
);

506 
	`WARN_ON
(!
	`li¡_em±y
(&
½Üt
->
ù¾_li¡
));

509 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

510 
	`li¡_d–
(&
½Üt
->
’dp_li¡
);

511 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

513 
	`ida_sim¶e_»move
(&
ÍÜt
->
’dp_út
, 
½Üt
->
»mÙ•Üt
.
pÜt_num
);

515 
	`kä“
(
½Üt
);

517 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

518 
	}
}

521 
	$nvme_fc_½Üt_put
(
nvme_fc_½Üt
 *
½Üt
)

523 
	`k»f_put
(&
½Üt
->
»f
, 
nvme_fc_ä“_½Üt
);

524 
	}
}

527 
	$nvme_fc_½Üt_g‘
(
nvme_fc_½Üt
 *
½Üt
)

529  
	`k»f_g‘_uÆess_z”o
(&
½Üt
->
»f
);

530 
	}
}

533 
	$nvme_fc_»sume_cÚŒŞËr
(
nvme_fc_ù¾
 *
ù¾
)

535 
ù¾
->ù¾.
¡©e
) {

536 
NVME_CTRL_NEW
:

537 
NVME_CTRL_RECONNECTING
:

542 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

544 "A‰em±šg„ecÚÃù\n", 
ù¾
->
úum
);

546 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
cÚÃù_wÜk
, 0);

549 
NVME_CTRL_RESETTING
:

561 
	}
}

563 
nvme_fc_½Üt
 *

564 
	$nvme_fc_©ch_to_su¥’ded_½Üt
(
nvme_fc_ÍÜt
 *
ÍÜt
,

565 
nvme_fc_pÜt_šfo
 *
pšfo
)

567 
nvme_fc_½Üt
 *
½Üt
;

568 
nvme_fc_ù¾
 *
ù¾
;

569 
æags
;

571 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

573 
	`li¡_fÜ_—ch_’Œy
(
½Üt
, &
ÍÜt
->
’dp_li¡
,ƒndp_list) {

574 ià(
½Üt
->
»mÙ•Üt
.
node_Çme
 !ğ
pšfo
->node_name ||

575 
½Üt
->
»mÙ•Üt
.
pÜt_Çme
 !ğ
pšfo
->port_name)

578 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
)) {

579 
½Üt
 = 
	`ERR_PTR
(-
ENOLCK
);

580 
out_dÚe
;

583 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

585 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

588 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_DELETED
) {

590 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

591 
	`nvme_fc_½Üt_put
(
½Üt
);

592  
	`ERR_PTR
(-
ESTALE
);

595 
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

596 
½Üt
->
dev_loss_’d
 = 0;

602 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list)

603 
	`nvme_fc_»sume_cÚŒŞËr
(
ù¾
);

605 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

607  
½Üt
;

610 
½Üt
 = 
NULL
;

612 
out_dÚe
:

613 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

615  
½Üt
;

616 
	}
}

618 
šlše
 

619 
	$__nvme_fc_£t_dev_loss_tmo
(
nvme_fc_½Üt
 *
½Üt
,

620 
nvme_fc_pÜt_šfo
 *
pšfo
)

622 ià(
pšfo
->
dev_loss_tmo
)

623 
½Üt
->
»mÙ•Üt
.
dev_loss_tmo
 = 
pšfo
->dev_loss_tmo;

625 
½Üt
->
»mÙ•Üt
.
dev_loss_tmo
 = 
NVME_FC_DEFAULT_DEV_LOSS_TMO
;

626 
	}
}

645 
	$nvme_fc_»gi¡”_»mÙ•Üt
(
nvme_fc_loÿl_pÜt
 *
loÿÍÜt
,

646 
nvme_fc_pÜt_šfo
 *
pšfo
,

647 
nvme_fc_»mÙe_pÜt
 **
pÜŒ
)

649 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
	`loÿÍÜt_to_ÍÜt
(
loÿÍÜt
);

650 
nvme_fc_½Üt
 *
Ãw»c
;

651 
æags
;

652 
»t
, 
idx
;

654 ià(!
	`nvme_fc_ÍÜt_g‘
(
ÍÜt
)) {

655 
»t
 = -
ESHUTDOWN
;

656 
out_»gho¡_çed
;

664 
Ãw»c
 = 
	`nvme_fc_©ch_to_su¥’ded_½Üt
(
ÍÜt
, 
pšfo
);

667 ià(
	`IS_ERR
(
Ãw»c
)) {

668 
»t
 = 
	`PTR_ERR
(
Ãw»c
);

669 
out_ÍÜt_put
;

672 } ià(
Ãw»c
) {

673 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

674 
	`__nvme_fc_£t_dev_loss_tmo
(
Ãw»c
, 
pšfo
);

675 
	`nvme_fc_sigÇl_discov”y_sÿn
(
ÍÜt
, 
Ãw»c
);

676 *
pÜŒ
 = &
Ãw»c
->
»mÙ•Üt
;

682 
Ãw»c
 = 
	`km®loc
(((*Ãw»cè+ 
ÍÜt
->
İs
->
»mÙe_´iv_sz
),

683 
GFP_KERNEL
);

684 ià(!
Ãw»c
) {

685 
»t
 = -
ENOMEM
;

686 
out_ÍÜt_put
;

689 
idx
 = 
	`ida_sim¶e_g‘
(&
ÍÜt
->
’dp_út
, 0, 0, 
GFP_KERNEL
);

690 ià(
idx
 < 0) {

691 
»t
 = -
ENOSPC
;

692 
out_kä“_½Üt
;

695 
	`INIT_LIST_HEAD
(&
Ãw»c
->
’dp_li¡
);

696 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ù¾_li¡
);

697 
	`INIT_LIST_HEAD
(&
Ãw»c
->
ls_»q_li¡
);

698 
	`k»f_š™
(&
Ãw»c
->
»f
);

699 
	`©omic_£t
(&
Ãw»c
->
aù_ù¾_út
, 0);

700 
	`¥š_lock_š™
(&
Ãw»c
->
lock
);

701 
Ãw»c
->
»mÙ•Üt
.
loÿÍÜt
 = &
ÍÜt
->localport;

702 
Ãw»c
->
dev
 = 
ÍÜt
->dev;

703 
Ãw»c
->
ÍÜt
 =†port;

704 
Ãw»c
->
»mÙ•Üt
.
´iv©e
 = &newrec[1];

705 
Ãw»c
->
»mÙ•Üt
.
pÜt_rŞe
 = 
pšfo
->port_role;

706 
Ãw»c
->
»mÙ•Üt
.
node_Çme
 = 
pšfo
->node_name;

707 
Ãw»c
->
»mÙ•Üt
.
pÜt_Çme
 = 
pšfo
->port_name;

708 
Ãw»c
->
»mÙ•Üt
.
pÜt_id
 = 
pšfo
->port_id;

709 
Ãw»c
->
»mÙ•Üt
.
pÜt_¡©e
 = 
FC_OBJSTATE_ONLINE
;

710 
Ãw»c
->
»mÙ•Üt
.
pÜt_num
 = 
idx
;

711 
	`__nvme_fc_£t_dev_loss_tmo
(
Ãw»c
, 
pšfo
);

713 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

714 
	`li¡_add_
(&
Ãw»c
->
’dp_li¡
, &
ÍÜt
->endp_list);

715 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

717 
	`nvme_fc_sigÇl_discov”y_sÿn
(
ÍÜt
, 
Ãw»c
);

719 *
pÜŒ
 = &
Ãw»c
->
»mÙ•Üt
;

722 
out_kä“_½Üt
:

723 
	`kä“
(
Ãw»c
);

724 
out_ÍÜt_put
:

725 
	`nvme_fc_ÍÜt_put
(
ÍÜt
);

726 
out_»gho¡_çed
:

727 *
pÜŒ
 = 
NULL
;

728  
»t
;

729 
	}
}

730 
EXPORT_SYMBOL_GPL
(
nvme_fc_»gi¡”_»mÙ•Üt
);

733 
	$nvme_fc_abÜt_lsİs
(
nvme_fc_½Üt
 *
½Üt
)

735 
nvmefc_ls_»q_İ
 *
lsİ
;

736 
æags
;

738 
»¡¬t
:

739 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

741 
	`li¡_fÜ_—ch_’Œy
(
lsİ
, &
½Üt
->
ls_»q_li¡
, 
l¤eq_li¡
) {

742 ià(!(
lsİ
->
æags
 & 
FCOP_FLAGS_TERMIO
)) {

743 
lsİ
->
æags
 |ğ
FCOP_FLAGS_TERMIO
;

744 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

745 
½Üt
->
ÍÜt
->
İs
->
	`ls_abÜt
(&½Üt->ÍÜt->
loÿÍÜt
,

746 &
½Üt
->
»mÙ•Üt
,

747 &
lsİ
->
ls_»q
);

748 
»¡¬t
;

751 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

754 
	}
}

757 
	$nvme_fc_ù¾_cÚÃùiv™y_loss
(
nvme_fc_ù¾
 *
ù¾
)

759 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

761 "RecÚÃù", 
ù¾
->
úum
);

763 
ù¾
->ù¾.
¡©e
) {

764 
NVME_CTRL_NEW
:

765 
NVME_CTRL_LIVE
:

773 ià(
	`nvme_»£t_ù¾
(&
ù¾
->ctrl)) {

774 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

777 
ù¾
->
úum
);

778 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

782 
NVME_CTRL_RECONNECTING
:

792 
NVME_CTRL_RESETTING
:

801 
NVME_CTRL_DELETING
:

806 
	}
}

820 
	$nvme_fc_uÄegi¡”_»mÙ•Üt
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
)

822 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
pÜŒ
);

823 
nvme_fc_ù¾
 *
ù¾
;

824 
æags
;

826 ià(!
pÜŒ
)

827  -
EINVAL
;

829 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

831 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

832 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

833  -
EINVAL
;

835 
pÜŒ
->
pÜt_¡©e
 = 
FC_OBJSTATE_DELETED
;

837 
½Üt
->
dev_loss_’d
 = 
jiff›s
 + (
pÜŒ
->
dev_loss_tmo
 * 
HZ
);

839 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list) {

841 ià(!
pÜŒ
->
dev_loss_tmo
) {

842 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

845 
ù¾
->
úum
);

846 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

848 
	`nvme_fc_ù¾_cÚÃùiv™y_loss
(
ù¾
);

851 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

853 
	`nvme_fc_abÜt_lsİs
(
½Üt
);

855 ià(
	`©omic_»ad
(&
½Üt
->
aù_ù¾_út
) == 0)

856 
½Üt
->
ÍÜt
->
İs
->
	`»mÙ•Üt_d–‘e
(
pÜŒ
);

863 
	`nvme_fc_½Üt_put
(
½Üt
);

866 
	}
}

867 
EXPORT_SYMBOL_GPL
(
nvme_fc_uÄegi¡”_»mÙ•Üt
);

878 
	$nvme_fc_»sÿn_»mÙ•Üt
(
nvme_fc_»mÙe_pÜt
 *
»mÙ•Üt
)

880 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
»mÙ•Üt
);

882 
	`nvme_fc_sigÇl_discov”y_sÿn
(
½Üt
->
ÍÜt
,„port);

883 
	}
}

884 
EXPORT_SYMBOL_GPL
(
nvme_fc_»sÿn_»mÙ•Üt
);

887 
	$nvme_fc_£t_»mÙ•Üt_devloss
(
nvme_fc_»mÙe_pÜt
 *
pÜŒ
,

888 
u32
 
dev_loss_tmo
)

890 
nvme_fc_½Üt
 *
½Üt
 = 
	`»mÙ•Üt_to_½Üt
(
pÜŒ
);

891 
æags
;

893 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

895 ià(
pÜŒ
->
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
) {

896 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

897  -
EINVAL
;

901 
½Üt
->
»mÙ•Üt
.
dev_loss_tmo
 = dev_loss_tmo;

903 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

906 
	}
}

907 
EXPORT_SYMBOL_GPL
(
nvme_fc_£t_»mÙ•Üt_devloss
);

928 
šlše
 
dma_addr_t


929 
	$fc_dma_m­_sšgË
(
deviû
 *
dev
, *
±r
, 
size_t
 
size
,

930 
dma_d©a_dœeùiÚ
 
dœ
)

932  
dev
 ? 
	`dma_m­_sšgË
(dev, 
±r
, 
size
, 
dœ
è: (
dma_addr_t
)0L;

933 
	}
}

935 
šlše
 

936 
	$fc_dma_m­pšg_”rÜ
(
deviû
 *
dev
, 
dma_addr_t
 
dma_addr
)

938  
dev
 ? 
	`dma_m­pšg_”rÜ
(dev, 
dma_addr
) : 0;

939 
	}
}

941 
šlše
 

942 
	$fc_dma_unm­_sšgË
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

943 
dma_d©a_dœeùiÚ
 
dœ
)

945 ià(
dev
)

946 
	`dma_unm­_sšgË
(
dev
, 
addr
, 
size
, 
dœ
);

947 
	}
}

949 
šlše
 

950 
	$fc_dma_sync_sšgË_fÜ_ıu
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

951 
dma_d©a_dœeùiÚ
 
dœ
)

953 ià(
dev
)

954 
	`dma_sync_sšgË_fÜ_ıu
(
dev
, 
addr
, 
size
, 
dœ
);

955 
	}
}

957 
šlše
 

958 
	$fc_dma_sync_sšgË_fÜ_deviû
(
deviû
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

959 
dma_d©a_dœeùiÚ
 
dœ
)

961 ià(
dev
)

962 
	`dma_sync_sšgË_fÜ_deviû
(
dev
, 
addr
, 
size
, 
dœ
);

963 
	}
}

967 
	$fc_m­_sg
(
sÿ‰”li¡
 *
sg
, 
ÃÁs
)

969 
sÿ‰”li¡
 *
s
;

970 
i
;

972 
	`WARN_ON
(
ÃÁs
 =ğ0 || 
sg
[0].
Ëngth
 == 0);

974 
	`fÜ_—ch_sg
(
sg
, 
s
, 
ÃÁs
, 
i
) {

975 
s
->
dma_add»ss
 = 0L;

976 #ifdeà
CONFIG_NEED_SG_DMA_LENGTH


977 
s
->
dma_Ëngth
 = s->
Ëngth
;

980  
ÃÁs
;

981 
	}
}

983 
šlše
 

984 
	$fc_dma_m­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

985 
dma_d©a_dœeùiÚ
 
dœ
)

987  
dev
 ? 
	`dma_m­_sg
(dev, 
sg
, 
ÃÁs
, 
dœ
è: 
	`fc_m­_sg
(sg,‚ents);

988 
	}
}

990 
šlše
 

991 
	$fc_dma_unm­_sg
(
deviû
 *
dev
, 
sÿ‰”li¡
 *
sg
, 
ÃÁs
,

992 
dma_d©a_dœeùiÚ
 
dœ
)

994 ià(
dev
)

995 
	`dma_unm­_sg
(
dev
, 
sg
, 
ÃÁs
, 
dœ
);

996 
	}
}

1000 
nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *);

1001 
nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *);

1005 
	$__nvme_fc_fšish_ls_»q
(
nvmefc_ls_»q_İ
 *
lsİ
)

1007 
nvme_fc_½Üt
 *
½Üt
 = 
lsİ
->rport;

1008 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

1009 
æags
;

1011 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

1013 ià(!
lsİ
->
»q_queued
) {

1014 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1018 
	`li¡_d–
(&
lsİ
->
l¤eq_li¡
);

1020 
lsİ
->
»q_queued
 = 
çl£
;

1022 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1024 
	`fc_dma_unm­_sšgË
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
,

1025 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

1026 
DMA_BIDIRECTIONAL
);

1028 
	`nvme_fc_½Üt_put
(
½Üt
);

1029 
	}
}

1032 
	$__nvme_fc_£nd_ls_»q
(
nvme_fc_½Üt
 *
½Üt
,

1033 
nvmefc_ls_»q_İ
 *
lsİ
,

1034 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

1036 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

1037 
æags
;

1038 
»t
 = 0;

1040 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
)

1041  -
ECONNREFUSED
;

1043 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

1044  -
ESHUTDOWN
;

1046 
l¤eq
->
dÚe
 = done;

1047 
lsİ
->
½Üt
 =„port;

1048 
lsİ
->
»q_queued
 = 
çl£
;

1049 
	`INIT_LIST_HEAD
(&
lsİ
->
l¤eq_li¡
);

1050 
	`š™_com¶‘iÚ
(&
lsİ
->
ls_dÚe
);

1052 
l¤eq
->
rq¡dma
 = 
	`fc_dma_m­_sšgË
(
½Üt
->
dev
,†¤eq->
rq¡addr
,

1053 
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
,

1054 
DMA_BIDIRECTIONAL
);

1055 ià(
	`fc_dma_m­pšg_”rÜ
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
)) {

1056 
»t
 = -
EFAULT
;

1057 
out_puŒpÜt
;

1059 
l¤eq
->
r¥dma
 =†¤eq->
rq¡dma
 +†¤eq->
rq¡Ën
;

1061 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

1063 
	`li¡_add_
(&
lsİ
->
l¤eq_li¡
, &
½Üt
->
ls_»q_li¡
);

1065 
lsİ
->
»q_queued
 = 
Œue
;

1067 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1069 
»t
 = 
½Üt
->
ÍÜt
->
İs
->
	`ls_»q
(&½Üt->ÍÜt->
loÿÍÜt
,

1070 &
½Üt
->
»mÙ•Üt
, 
l¤eq
);

1071 ià(
»t
)

1072 
out_uÆšk
;

1076 
out_uÆšk
:

1077 
lsİ
->
ls_”rÜ
 = 
»t
;

1078 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

1079 
lsİ
->
»q_queued
 = 
çl£
;

1080 
	`li¡_d–
(&
lsİ
->
l¤eq_li¡
);

1081 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

1082 
	`fc_dma_unm­_sšgË
(
½Üt
->
dev
, 
l¤eq
->
rq¡dma
,

1083 (
l¤eq
->
rq¡Ën
 +†¤eq->
r¥Ën
),

1084 
DMA_BIDIRECTIONAL
);

1085 
out_puŒpÜt
:

1086 
	`nvme_fc_½Üt_put
(
½Üt
);

1088  
»t
;

1089 
	}
}

1092 
	$nvme_fc_£nd_ls_»q_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

1094 
nvmefc_ls_»q_İ
 *
lsİ
 = 
	`ls_»q_to_lsİ
(
l¤eq
);

1096 
lsİ
->
ls_”rÜ
 = 
¡©us
;

1097 
	`com¶‘e
(&
lsİ
->
ls_dÚe
);

1098 
	}
}

1101 
	$nvme_fc_£nd_ls_»q
(
nvme_fc_½Üt
 *
½Üt
, 
nvmefc_ls_»q_İ
 *
lsİ
)

1103 
nvmefc_ls_»q
 *
l¤eq
 = &
lsİ
->
ls_»q
;

1104 
fúvme_ls_rjt
 *
rjt
 = 
l¤eq
->
r¥addr
;

1105 
»t
;

1107 
»t
 = 
	`__nvme_fc_£nd_ls_»q
(
½Üt
, 
lsİ
, 
nvme_fc_£nd_ls_»q_dÚe
);

1109 ià(!
»t
) {

1116 
	`wa™_fÜ_com¶‘iÚ
(&
lsİ
->
ls_dÚe
);

1118 
	`__nvme_fc_fšish_ls_»q
(
lsİ
);

1120 
»t
 = 
lsİ
->
ls_”rÜ
;

1123 ià(
»t
)

1124  
»t
;

1127 ià(
rjt
->
w0
.
ls_cmd
 =ğ
FCNVME_LS_RJT
)

1128  -
ENXIO
;

1131 
	}
}

1134 
	$nvme_fc_£nd_ls_»q_async
(
nvme_fc_½Üt
 *
½Üt
,

1135 
nvmefc_ls_»q_İ
 *
lsİ
,

1136 (*
dÚe
)(
nvmefc_ls_»q
 *
»q
, 
¡©us
))

1140  
	`__nvme_fc_£nd_ls_»q
(
½Üt
, 
lsİ
, 
dÚe
);

1141 
	}
}

1145 
	mVERR_NO_ERROR
 = 0,

1146 
	mVERR_LSACC
 = 1,

1147 
	mVERR_LSDESC_RQST
 = 2,

1148 
	mVERR_LSDESC_RQST_LEN
 = 3,

1149 
	mVERR_ASSOC_ID
 = 4,

1150 
	mVERR_ASSOC_ID_LEN
 = 5,

1151 
	mVERR_CONN_ID
 = 6,

1152 
	mVERR_CONN_ID_LEN
 = 7,

1153 
	mVERR_CR_ASSOC
 = 8,

1154 
	mVERR_CR_ASSOC_ACC_LEN
 = 9,

1155 
	mVERR_CR_CONN
 = 10,

1156 
	mVERR_CR_CONN_ACC_LEN
 = 11,

1157 
	mVERR_DISCONN
 = 12,

1158 
	mVERR_DISCONN_ACC_LEN
 = 13,

1161 *
	gv®id©iÚ_”rÜs
[] = {

1179 
	$nvme_fc_cÚÃù_admš_queue
(
nvme_fc_ù¾
 *
ù¾
,

1180 
nvme_fc_queue
 *
queue
, 
u16
 
qsize
, u16 
”¥_¿tio
)

1182 
nvmefc_ls_»q_İ
 *
lsİ
;

1183 
nvmefc_ls_»q
 *
l¤eq
;

1184 
fúvme_ls_ü_assoc_rq¡
 *
assoc_rq¡
;

1185 
fúvme_ls_ü_assoc_acc
 *
assoc_acc
;

1186 
»t
, 
fü‘
 = 0;

1188 
lsİ
 = 
	`kz®loc
(((*lsop) +

1189 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

1190 (*
assoc_rq¡
è+ (*
assoc_acc
)), 
GFP_KERNEL
);

1191 ià(!
lsİ
) {

1192 
»t
 = -
ENOMEM
;

1193 
out_no_memÜy
;

1195 
l¤eq
 = &
lsİ
->
ls_»q
;

1197 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

1198 
assoc_rq¡
 = (
fúvme_ls_ü_assoc_rq¡
 *)

1199 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

1200 
assoc_acc
 = (
fúvme_ls_ü_assoc_acc
 *)&
assoc_rq¡
[1];

1202 
assoc_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_ASSOCIATION
;

1203 
assoc_rq¡
->
desc_li¡_Ën
 =

1204 
	`ıu_to_be32
((
fúvme_lsdesc_ü_assoc_cmd
));

1206 
assoc_rq¡
->
assoc_cmd
.
desc_g
 =

1207 
	`ıu_to_be32
(
FCNVME_LSDESC_CREATE_ASSOC_CMD
);

1208 
assoc_rq¡
->
assoc_cmd
.
desc_Ën
 =

1209 
	`fúvme_lsdesc_Ën
(

1210 (
fúvme_lsdesc_ü_assoc_cmd
));

1212 
assoc_rq¡
->
assoc_cmd
.
”¥_¿tio
 = 
	`ıu_to_be16
(ersp_ratio);

1213 
assoc_rq¡
->
assoc_cmd
.
sqsize
 = 
	`ıu_to_be16
(
qsize
);

1215 
assoc_rq¡
->
assoc_cmd
.
úid
 = 
	`ıu_to_be16
(0xffff);

1216 
	`uuid_cİy
(&
assoc_rq¡
->
assoc_cmd
.
ho¡id
, &
ù¾
->ù¾.
İts
->
ho¡
->
id
);

1217 
	`¡ºıy
(
assoc_rq¡
->
assoc_cmd
.
ho¡nqn
, 
ù¾
->ù¾.
İts
->
ho¡
->
nqn
,

1218 
	`mš
(
FCNVME_ASSOC_HOSTNQN_LEN
, 
NVMF_NQN_SIZE
));

1219 
	`¡ºıy
(
assoc_rq¡
->
assoc_cmd
.
subnqn
, 
ù¾
->ù¾.
İts
->
subsy¢qn
,

1220 
	`mš
(
FCNVME_ASSOC_SUBNQN_LEN
, 
NVMF_NQN_SIZE
));

1222 
lsİ
->
queue
 = queue;

1223 
l¤eq
->
rq¡addr
 = 
assoc_rq¡
;

1224 
l¤eq
->
rq¡Ën
 = (*
assoc_rq¡
);

1225 
l¤eq
->
r¥addr
 = 
assoc_acc
;

1226 
l¤eq
->
r¥Ën
 = (*
assoc_acc
);

1227 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1229 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
->
½Üt
, 
lsİ
);

1230 ià(
»t
)

1231 
out_ä“_bufãr
;

1236 ià(
assoc_acc
->
hdr
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_ACC
)

1237 
fü‘
 = 
VERR_LSACC
;

1238 ià(
assoc_acc
->
hdr
.
desc_li¡_Ën
 !=

1239 
	`fúvme_lsdesc_Ën
(

1240 (
fúvme_ls_ü_assoc_acc
)))

1241 
fü‘
 = 
VERR_CR_ASSOC_ACC_LEN
;

1242 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_g
 !=

1243 
	`ıu_to_be32
(
FCNVME_LSDESC_RQST
))

1244 
fü‘
 = 
VERR_LSDESC_RQST
;

1245 ià(
assoc_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

1246 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

1247 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

1248 ià(
assoc_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_CREATE_ASSOCIATION
)

1249 
fü‘
 = 
VERR_CR_ASSOC
;

1250 ià(
assoc_acc
->
associd
.
desc_g
 !=

1251 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
))

1252 
fü‘
 = 
VERR_ASSOC_ID
;

1253 ià(
assoc_acc
->
associd
.
desc_Ën
 !=

1254 
	`fúvme_lsdesc_Ën
(

1255 (
fúvme_lsdesc_assoc_id
)))

1256 
fü‘
 = 
VERR_ASSOC_ID_LEN
;

1257 ià(
assoc_acc
->
cÚÃùid
.
desc_g
 !=

1258 
	`ıu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1259 
fü‘
 = 
VERR_CONN_ID
;

1260 ià(
assoc_acc
->
cÚÃùid
.
desc_Ën
 !=

1261 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

1262 
fü‘
 = 
VERR_CONN_ID_LEN
;

1264 ià(
fü‘
) {

1265 
»t
 = -
EBADF
;

1266 
	`dev_”r
(
ù¾
->
dev
,

1268 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

1270 
ù¾
->
assocŸtiÚ_id
 =

1271 
	`be64_to_ıu
(
assoc_acc
->
associd
.
assocŸtiÚ_id
);

1272 
queue
->
cÚÃùiÚ_id
 =

1273 
	`be64_to_ıu
(
assoc_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

1274 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1277 
out_ä“_bufãr
:

1278 
	`kä“
(
lsİ
);

1279 
out_no_memÜy
:

1280 ià(
»t
)

1281 
	`dev_”r
(
ù¾
->
dev
,

1283 
queue
->
qnum
, 
»t
);

1284  
»t
;

1285 
	}
}

1288 
	$nvme_fc_cÚÃù_queue
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

1289 
u16
 
qsize
, u16 
”¥_¿tio
)

1291 
nvmefc_ls_»q_İ
 *
lsİ
;

1292 
nvmefc_ls_»q
 *
l¤eq
;

1293 
fúvme_ls_ü_cÚn_rq¡
 *
cÚn_rq¡
;

1294 
fúvme_ls_ü_cÚn_acc
 *
cÚn_acc
;

1295 
»t
, 
fü‘
 = 0;

1297 
lsİ
 = 
	`kz®loc
(((*lsop) +

1298 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

1299 (*
cÚn_rq¡
è+ (*
cÚn_acc
)), 
GFP_KERNEL
);

1300 ià(!
lsİ
) {

1301 
»t
 = -
ENOMEM
;

1302 
out_no_memÜy
;

1304 
l¤eq
 = &
lsİ
->
ls_»q
;

1306 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

1307 
cÚn_rq¡
 = (
fúvme_ls_ü_cÚn_rq¡
 *)

1308 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

1309 
cÚn_acc
 = (
fúvme_ls_ü_cÚn_acc
 *)&
cÚn_rq¡
[1];

1311 
cÚn_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_CONNECTION
;

1312 
cÚn_rq¡
->
desc_li¡_Ën
 = 
	`ıu_to_be32
(

1313 (
fúvme_lsdesc_assoc_id
) +

1314 (
fúvme_lsdesc_ü_cÚn_cmd
));

1316 
cÚn_rq¡
->
associd
.
desc_g
 = 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1317 
cÚn_rq¡
->
associd
.
desc_Ën
 =

1318 
	`fúvme_lsdesc_Ën
(

1319 (
fúvme_lsdesc_assoc_id
));

1320 
cÚn_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ıu_to_be64
(
ù¾
->association_id);

1321 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_g
 =

1322 
	`ıu_to_be32
(
FCNVME_LSDESC_CREATE_CONN_CMD
);

1323 
cÚn_rq¡
->
cÚÃù_cmd
.
desc_Ën
 =

1324 
	`fúvme_lsdesc_Ën
(

1325 (
fúvme_lsdesc_ü_cÚn_cmd
));

1326 
cÚn_rq¡
->
cÚÃù_cmd
.
”¥_¿tio
 = 
	`ıu_to_be16
(ersp_ratio);

1327 
cÚn_rq¡
->
cÚÃù_cmd
.
qid
 = 
	`ıu_to_be16
(
queue
->
qnum
);

1328 
cÚn_rq¡
->
cÚÃù_cmd
.
sqsize
 = 
	`ıu_to_be16
(
qsize
);

1330 
lsİ
->
queue
 = queue;

1331 
l¤eq
->
rq¡addr
 = 
cÚn_rq¡
;

1332 
l¤eq
->
rq¡Ën
 = (*
cÚn_rq¡
);

1333 
l¤eq
->
r¥addr
 = 
cÚn_acc
;

1334 
l¤eq
->
r¥Ën
 = (*
cÚn_acc
);

1335 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1337 
»t
 = 
	`nvme_fc_£nd_ls_»q
(
ù¾
->
½Üt
, 
lsİ
);

1338 ià(
»t
)

1339 
out_ä“_bufãr
;

1344 ià(
cÚn_acc
->
hdr
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_ACC
)

1345 
fü‘
 = 
VERR_LSACC
;

1346 ià(
cÚn_acc
->
hdr
.
desc_li¡_Ën
 !=

1347 
	`fúvme_lsdesc_Ën
((
fúvme_ls_ü_cÚn_acc
)))

1348 
fü‘
 = 
VERR_CR_CONN_ACC_LEN
;

1349 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_g
 !ğ
	`ıu_to_be32
(
FCNVME_LSDESC_RQST
))

1350 
fü‘
 = 
VERR_LSDESC_RQST
;

1351 ià(
cÚn_acc
->
hdr
.
rq¡
.
desc_Ën
 !=

1352 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_rq¡
)))

1353 
fü‘
 = 
VERR_LSDESC_RQST_LEN
;

1354 ià(
cÚn_acc
->
hdr
.
rq¡
.
w0
.
ls_cmd
 !ğ
FCNVME_LS_CREATE_CONNECTION
)

1355 
fü‘
 = 
VERR_CR_CONN
;

1356 ià(
cÚn_acc
->
cÚÃùid
.
desc_g
 !=

1357 
	`ıu_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1358 
fü‘
 = 
VERR_CONN_ID
;

1359 ià(
cÚn_acc
->
cÚÃùid
.
desc_Ën
 !=

1360 
	`fúvme_lsdesc_Ën
((
fúvme_lsdesc_cÚn_id
)))

1361 
fü‘
 = 
VERR_CONN_ID_LEN
;

1363 ià(
fü‘
) {

1364 
»t
 = -
EBADF
;

1365 
	`dev_”r
(
ù¾
->
dev
,

1367 
queue
->
qnum
, 
v®id©iÚ_”rÜs
[
fü‘
]);

1369 
queue
->
cÚÃùiÚ_id
 =

1370 
	`be64_to_ıu
(
cÚn_acc
->
cÚÃùid
.
cÚÃùiÚ_id
);

1371 
	`£t_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
);

1374 
out_ä“_bufãr
:

1375 
	`kä“
(
lsİ
);

1376 
out_no_memÜy
:

1377 ià(
»t
)

1378 
	`dev_”r
(
ù¾
->
dev
,

1380 
queue
->
qnum
, 
»t
);

1381  
»t
;

1382 
	}
}

1385 
	$nvme_fc_discÚÃù_assoc_dÚe
(
nvmefc_ls_»q
 *
l¤eq
, 
¡©us
)

1387 
nvmefc_ls_»q_İ
 *
lsİ
 = 
	`ls_»q_to_lsİ
(
l¤eq
);

1389 
	`__nvme_fc_fšish_ls_»q
(
lsİ
);

1393 
	`kä“
(
lsİ
);

1394 
	}
}

1414 
	$nvme_fc_xmt_discÚÃù_assoc
(
nvme_fc_ù¾
 *
ù¾
)

1416 
fúvme_ls_discÚÃù_rq¡
 *
discÚ_rq¡
;

1417 
fúvme_ls_discÚÃù_acc
 *
discÚ_acc
;

1418 
nvmefc_ls_»q_İ
 *
lsİ
;

1419 
nvmefc_ls_»q
 *
l¤eq
;

1420 
»t
;

1422 
lsİ
 = 
	`kz®loc
(((*lsop) +

1423 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
 +

1424 (*
discÚ_rq¡
è+ (*
discÚ_acc
)),

1425 
GFP_KERNEL
);

1426 ià(!
lsİ
)

1430 
l¤eq
 = &
lsİ
->
ls_»q
;

1432 
l¤eq
->
´iv©e
 = (*)&
lsİ
[1];

1433 
discÚ_rq¡
 = (
fúvme_ls_discÚÃù_rq¡
 *)

1434 (
l¤eq
->
´iv©e
 + 
ù¾
->
ÍÜt
->
İs
->
l¤q¡_´iv_sz
);

1435 
discÚ_acc
 = (
fúvme_ls_discÚÃù_acc
 *)&
discÚ_rq¡
[1];

1437 
discÚ_rq¡
->
w0
.
ls_cmd
 = 
FCNVME_LS_DISCONNECT
;

1438 
discÚ_rq¡
->
desc_li¡_Ën
 = 
	`ıu_to_be32
(

1439 (
fúvme_lsdesc_assoc_id
) +

1440 (
fúvme_lsdesc_discÚn_cmd
));

1442 
discÚ_rq¡
->
associd
.
desc_g
 = 
	`ıu_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1443 
discÚ_rq¡
->
associd
.
desc_Ën
 =

1444 
	`fúvme_lsdesc_Ën
(

1445 (
fúvme_lsdesc_assoc_id
));

1447 
discÚ_rq¡
->
associd
.
assocŸtiÚ_id
 = 
	`ıu_to_be64
(
ù¾
->association_id);

1449 
discÚ_rq¡
->
discÚ_cmd
.
desc_g
 = 
	`ıu_to_be32
(

1450 
FCNVME_LSDESC_DISCONN_CMD
);

1451 
discÚ_rq¡
->
discÚ_cmd
.
desc_Ën
 =

1452 
	`fúvme_lsdesc_Ën
(

1453 (
fúvme_lsdesc_discÚn_cmd
));

1454 
discÚ_rq¡
->
discÚ_cmd
.
scİe
 = 
FCNVME_DISCONN_ASSOCIATION
;

1455 
discÚ_rq¡
->
discÚ_cmd
.
id
 = 
	`ıu_to_be64
(
ù¾
->
assocŸtiÚ_id
);

1457 
l¤eq
->
rq¡addr
 = 
discÚ_rq¡
;

1458 
l¤eq
->
rq¡Ën
 = (*
discÚ_rq¡
);

1459 
l¤eq
->
r¥addr
 = 
discÚ_acc
;

1460 
l¤eq
->
r¥Ën
 = (*
discÚ_acc
);

1461 
l¤eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1463 
»t
 = 
	`nvme_fc_£nd_ls_»q_async
(
ù¾
->
½Üt
, 
lsİ
,

1464 
nvme_fc_discÚÃù_assoc_dÚe
);

1465 ià(
»t
)

1466 
	`kä“
(
lsİ
);

1469 
ù¾
->
assocŸtiÚ_id
 = 0;

1470 
	}
}

1475 
__nvme_fc_fš®_İ_ş—nup
(
»que¡
 *
rq
);

1476 
nvme_fc_”rÜ_»cov”y
(
nvme_fc_ù¾
 *
ù¾
, *
”rmsg
);

1479 
	$nvme_fc_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

1481 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1482 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1484 
	`mem£t
(
cmdiu
, 0, (*cmdiu));

1485 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1486 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1487 
cmdiu
->
iu_Ën
 = 
	`ıu_to_be16
((*cmdiuè/ (
u32
));

1488 
	`mem£t
(&
İ
->
r¥_iu
, 0, (op->rsp_iu));

1491 
	}
}

1494 
	$__nvme_fc_ex™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1495 
nvme_fc_fı_İ
 *
İ
)

1497 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
,

1498 (
İ
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1499 
	`fc_dma_unm­_sšgË
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
,

1500 (
İ
->
cmd_iu
), 
DMA_TO_DEVICE
);

1502 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_UNINIT
);

1503 
	}
}

1506 
	$nvme_fc_ex™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
rq
,

1507 
hùx_idx
)

1509 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1511  
	`__nvme_fc_ex™_»que¡
(
£t
->
driv”_d©a
, 
İ
);

1512 
	}
}

1515 
	$__nvme_fc_abÜt_İ
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_fı_İ
 *
İ
)

1517 
¡©e
;

1519 
¡©e
 = 
	`©omic_xchg
(&
İ
->¡©e, 
FCPOP_STATE_ABORTED
);

1520 ià(
¡©e
 !ğ
FCPOP_STATE_ACTIVE
) {

1521 
	`©omic_£t
(&
İ
->
¡©e
, state);

1522  -
ECANCELED
;

1525 
ù¾
->
ÍÜt
->
İs
->
	`fı_abÜt
(&ù¾->ÍÜt->
loÿÍÜt
,

1526 &
ù¾
->
½Üt
->
»mÙ•Üt
,

1527 
İ
->
queue
->
Îdd_hªdË
,

1528 &
İ
->
fı_»q
);

1531 
	}
}

1534 
	$nvme_fc_abÜt_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1536 
nvme_fc_fı_İ
 *
«n_İ
 = 
ù¾
->
«n_İs
;

1537 
æags
;

1538 
i
, 
»t
;

1540 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1541 ià(
	`©omic_»ad
(&
«n_İ
->
¡©e
è!ğ
FCPOP_STATE_ACTIVE
)

1544 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1545 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

1546 
ù¾
->
ioút
++;

1547 
«n_İ
->
æags
 |ğ
FCOP_FLAGS_TERMIO
;

1549 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1551 
»t
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
«n_İ
);

1552 ià(
»t
) {

1560 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1561 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

1562 
ù¾
->
ioút
--;

1563 
«n_İ
->
æags
 &ğ~
FCOP_FLAGS_TERMIO
;

1564 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1568 
	}
}

1570 
šlše
 

1571 
	$__nvme_fc_fıİ_chk_‹¬downs
(
nvme_fc_ù¾
 *
ù¾
,

1572 
nvme_fc_fı_İ
 *
İ
)

1574 
æags
;

1575 
boŞ
 
com¶‘e_rq
 = 
çl£
;

1577 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

1578 ià(
	`uÆik–y
(
İ
->
æags
 & 
FCOP_FLAGS_TERMIO
)) {

1579 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

1580 ià(!--
ù¾
->
ioút
)

1581 
	`wake_up
(&
ù¾
->
ißbÜt_wa™
);

1584 ià(
İ
->
æags
 & 
FCOP_FLAGS_RELEASED
)

1585 
com¶‘e_rq
 = 
Œue
;

1587 
İ
->
æags
 |ğ
FCOP_FLAGS_COMPLETE
;

1588 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

1590  
com¶‘e_rq
;

1591 
	}
}

1594 
	$nvme_fc_fıio_dÚe
(
nvmefc_fı_»q
 *
»q
)

1596 
nvme_fc_fı_İ
 *
İ
 = 
	`fı_»q_to_fı_İ
(
»q
);

1597 
»que¡
 *
rq
 = 
İ
->rq;

1598 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

1599 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

1600 
nvme_fc_queue
 *
queue
 = 
İ
->queue;

1601 
nvme_com¶‘iÚ
 *
cqe
 = &
İ
->
r¥_iu
.cqe;

1602 
nvme_commªd
 *
sqe
 = &
İ
->
cmd_iu
.sqe;

1603 
__Ë16
 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_SUCCESS
 << 1);

1604 
nvme_»suÉ
 
»suÉ
;

1605 
boŞ
 
‹rmš©e_assoc
 = 
Œue
;

1644 
	`fc_dma_sync_sšgË_fÜ_ıu
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
,

1645 (
İ
->
r¥_iu
), 
DMA_FROM_DEVICE
);

1647 ià(
	`©omic_»ad
(&
İ
->
¡©e
è=ğ
FCPOP_STATE_ABORTED
 ||

1648 
İ
->
æags
 & 
FCOP_FLAGS_TERMIO
)

1649 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_ABORT_REQ
 << 1);

1650 ià(
äeq
->
¡©us
)

1651 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1658 ià(
¡©us
)

1659 
dÚe
;

1668 
äeq
->
rcv_r¥Ën
) {

1671 
NVME_FC_SIZEOF_ZEROS_RSP
:

1677 ià(
äeq
->
Œªsã¼ed_Ëngth
 !=

1678 
	`be32_to_ıu
(
İ
->
cmd_iu
.
d©a_Ën
)) {

1679 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1680 
dÚe
;

1682 
»suÉ
.
u64
 = 0;

1685 (
nvme_fc_”¥_iu
):

1690 ià(
	`uÆik–y
(
	`be16_to_ıu
(
İ
->
r¥_iu
.
iu_Ën
) !=

1691 (
äeq
->
rcv_r¥Ën
 / 4) ||

1692 
	`be32_to_ıu
(
İ
->
r¥_iu
.
xäd_Ën
) !=

1693 
äeq
->
Œªsã¼ed_Ëngth
 ||

1694 
İ
->
r¥_iu
.
¡©us_code
 ||

1695 
sqe
->
commÚ
.
commªd_id
 !ğ
cqe
->command_id)) {

1696 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1697 
dÚe
;

1699 
»suÉ
 = 
cqe
->result;

1700 
¡©us
 = 
cqe
->status;

1704 
¡©us
 = 
	`ıu_to_Ë16
(
NVME_SC_INTERNAL
 << 1);

1705 
dÚe
;

1708 
‹rmš©e_assoc
 = 
çl£
;

1710 
dÚe
:

1711 ià(
İ
->
æags
 & 
FCOP_FLAGS_AEN
) {

1712 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
¡©us
, &
»suÉ
);

1713 
	`__nvme_fc_fıİ_chk_‹¬downs
(
ù¾
, 
İ
);

1714 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

1715 
İ
->
æags
 = 
FCOP_FLAGS_AEN
;

1716 
	`nvme_fc_ù¾_put
(
ù¾
);

1717 
check_”rÜ
;

1724 ià(
¡©us
 &&

1725 (
	`blk_queue_dyšg
(
rq
->
q
) ||

1726 
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
 ||

1727 
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_RECONNECTING
))

1728 
¡©us
 |ğ
	`ıu_to_Ë16
(
NVME_SC_DNR
 << 1);

1730 ià(
	`__nvme_fc_fıİ_chk_‹¬downs
(
ù¾
, 
İ
))

1731 
	`__nvme_fc_fš®_İ_ş—nup
(
rq
);

1733 
	`nvme_’d_»que¡
(
rq
, 
¡©us
, 
»suÉ
);

1735 
check_”rÜ
:

1736 ià(
‹rmš©e_assoc
)

1737 
	`nvme_fc_”rÜ_»cov”y
(
ù¾
, "transport detected ioƒrror");

1738 
	}
}

1741 
	$__nvme_fc_š™_»que¡
(
nvme_fc_ù¾
 *
ù¾
,

1742 
nvme_fc_queue
 *
queue
, 
nvme_fc_fı_İ
 *
İ
,

1743 
»que¡
 *
rq
, 
u32
 
rqno
)

1745 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

1746 
»t
 = 0;

1748 
	`mem£t
(
İ
, 0, (*op));

1749 
İ
->
fı_»q
.
cmdaddr
 = &İ->
cmd_iu
;

1750 
İ
->
fı_»q
.
cmdËn
 = (İ->
cmd_iu
);

1751 
İ
->
fı_»q
.
r¥addr
 = &İ->
r¥_iu
;

1752 
İ
->
fı_»q
.
r¥Ën
 = (İ->
r¥_iu
);

1753 
İ
->
fı_»q
.
dÚe
 = 
nvme_fc_fıio_dÚe
;

1754 
İ
->
fı_»q
.
fœ¡_sgl
 = (
sÿ‰”li¡
 *)&op[1];

1755 
İ
->
fı_»q
.
´iv©e
 = &İ->fı_»q.
fœ¡_sgl
[
SG_CHUNK_SIZE
];

1756 
İ
->
ù¾
 = ctrl;

1757 
İ
->
queue
 = queue;

1758 
İ
->
rq
 =„q;

1759 
İ
->
rqno
 =„qno;

1761 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1762 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1763 
cmdiu
->
iu_Ën
 = 
	`ıu_to_be16
((*cmdiuè/ (
u32
));

1765 
İ
->
fı_»q
.
cmddma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1766 &
İ
->
cmd_iu
, (İ->cmd_iu), 
DMA_TO_DEVICE
);

1767 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
)) {

1768 
	`dev_”r
(
ù¾
->
dev
,

1770 
»t
 = 
EFAULT
;

1771 
out_Ú_”rÜ
;

1774 
İ
->
fı_»q
.
r¥dma
 = 
	`fc_dma_m­_sšgË
(
ù¾
->
ÍÜt
->
dev
,

1775 &
İ
->
r¥_iu
, (op->rsp_iu),

1776 
DMA_FROM_DEVICE
);

1777 ià(
	`fc_dma_m­pšg_”rÜ
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
r¥dma
)) {

1778 
	`dev_”r
(
ù¾
->
dev
,

1780 
»t
 = 
EFAULT
;

1783 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

1784 
out_Ú_”rÜ
:

1785  
»t
;

1786 
	}
}

1789 
	$nvme_fc_š™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
rq
,

1790 
hùx_idx
, 
numa_node
)

1792 
nvme_fc_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

1793 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1794 
queue_idx
 = (
£t
 =ğ&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

1795 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

1797  
	`__nvme_fc_š™_»que¡
(
ù¾
, 
queue
, 
İ
, 
rq
, queue->
rqút
++);

1798 
	}
}

1801 
	$nvme_fc_š™_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1803 
nvme_fc_fı_İ
 *
«n_İ
;

1804 
nvme_fc_cmd_iu
 *
cmdiu
;

1805 
nvme_commªd
 *
sqe
;

1806 *
´iv©e
;

1807 
i
, 
»t
;

1809 
«n_İ
 = 
ù¾
->
«n_İs
;

1810 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1811 
´iv©e
 = 
	`kz®loc
(
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
,

1812 
GFP_KERNEL
);

1813 ià(!
´iv©e
)

1814  -
ENOMEM
;

1816 
cmdiu
 = &
«n_İ
->
cmd_iu
;

1817 
sqe
 = &
cmdiu
->sqe;

1818 
»t
 = 
	`__nvme_fc_š™_»que¡
(
ù¾
, &ù¾->
queues
[0],

1819 
«n_İ
, (
»que¡
 *)
NULL
,

1820 (
NVME_AQ_BLK_MQ_DEPTH
 + 
i
));

1821 ià(
»t
) {

1822 
	`kä“
(
´iv©e
);

1823  
»t
;

1826 
«n_İ
->
æags
 = 
FCOP_FLAGS_AEN
;

1827 
«n_İ
->
fı_»q
.
fœ¡_sgl
 = 
NULL
;

1828 
«n_İ
->
fı_»q
.
´iv©e
 =…rivate;

1830 
	`mem£t
(
sqe
, 0, (*sqe));

1831 
sqe
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1833 
sqe
->
commÚ
.
commªd_id
 = 
NVME_AQ_BLK_MQ_DEPTH
 + 
i
;

1836 
	}
}

1839 
	$nvme_fc_‹rm_«n_İs
(
nvme_fc_ù¾
 *
ù¾
)

1841 
nvme_fc_fı_İ
 *
«n_İ
;

1842 
i
;

1844 
«n_İ
 = 
ù¾
->
«n_İs
;

1845 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
«n_İ
++) {

1846 ià(!
«n_İ
->
fı_»q
.
´iv©e
)

1849 
	`__nvme_fc_ex™_»que¡
(
ù¾
, 
«n_İ
);

1851 
	`kä“
(
«n_İ
->
fı_»q
.
´iv©e
);

1852 
«n_İ
->
fı_»q
.
´iv©e
 = 
NULL
;

1854 
	}
}

1856 
šlše
 

1857 
	$__nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
nvme_fc_ù¾
 *
ù¾
,

1858 
qidx
)

1860 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[
qidx
];

1862 
hùx
->
driv”_d©a
 = 
queue
;

1863 
queue
->
hùx
 = hctx;

1864 
	}
}

1867 
	$nvme_fc_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1868 
hùx_idx
)

1870 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1872 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
 + 1);

1875 
	}
}

1878 
	$nvme_fc_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

1879 
hùx_idx
)

1881 
nvme_fc_ù¾
 *
ù¾
 = 
d©a
;

1883 
	`__nvme_fc_š™_hùx
(
hùx
, 
ù¾
, 
hùx_idx
);

1886 
	}
}

1889 
	$nvme_fc_š™_queue
(
nvme_fc_ù¾
 *
ù¾
, 
idx
)

1891 
nvme_fc_queue
 *
queue
;

1893 
queue
 = &
ù¾
->
queues
[
idx
];

1894 
	`mem£t
(
queue
, 0, (*queue));

1895 
queue
->
ù¾
 = ctrl;

1896 
queue
->
qnum
 = 
idx
;

1897 
	`©omic_£t
(&
queue
->
c¢
, 1);

1898 
queue
->
dev
 = 
ù¾
->dev;

1900 ià(
idx
 > 0)

1901 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

1903 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

1915 
	}
}

1926 
	$nvme_fc_ä“_queue
(
nvme_fc_queue
 *
queue
)

1928 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_FC_Q_CONNECTED
, &
queue
->
æags
))

1931 
	`ş—r_b™
(
NVME_FC_Q_LIVE
, &
queue
->
æags
);

1938 
queue
->
cÚÃùiÚ_id
 = 0;

1939 
	}
}

1942 
	$__nvme_fc_d–‘e_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1943 
nvme_fc_queue
 *
queue
, 
qidx
)

1945 ià(
ù¾
->
ÍÜt
->
İs
->
d–‘e_queue
)

1946 
ù¾
->
ÍÜt
->
İs
->
	`d–‘e_queue
(&ù¾->ÍÜt->
loÿÍÜt
, 
qidx
,

1947 
queue
->
Îdd_hªdË
);

1948 
queue
->
Îdd_hªdË
 = 
NULL
;

1949 
	}
}

1952 
	$nvme_fc_ä“_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1954 
i
;

1956 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

1957 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[
i
]);

1958 
	}
}

1961 
	$__nvme_fc_ü—‹_hw_queue
(
nvme_fc_ù¾
 *
ù¾
,

1962 
nvme_fc_queue
 *
queue
, 
qidx
, 
u16
 
qsize
)

1964 
»t
 = 0;

1966 
queue
->
Îdd_hªdË
 = 
NULL
;

1967 ià(
ù¾
->
ÍÜt
->
İs
->
ü—‹_queue
)

1968 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`ü—‹_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

1969 
qidx
, 
qsize
, &
queue
->
Îdd_hªdË
);

1971  
»t
;

1972 
	}
}

1975 
	$nvme_fc_d–‘e_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

1977 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[ù¾->ù¾.
queue_couÁ
 - 1];

1978 
i
;

1980 
i
 = 
ù¾
->ù¾.
queue_couÁ
 - 1; i >ğ1; i--, 
queue
--)

1981 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, 
queue
, 
i
);

1982 
	}
}

1985 
	$nvme_fc_ü—‹_hw_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

1987 
nvme_fc_queue
 *
queue
 = &
ù¾
->
queues
[1];

1988 
i
, 
»t
;

1990 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++, 
queue
++) {

1991 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, 
queue
, 
i
, 
qsize
);

1992 ià(
»t
)

1993 
d–‘e_queues
;

1998 
d–‘e_queues
:

1999 ; 
i
 >= 0; i--)

2000 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[
i
], i);

2001  
»t
;

2002 
	}
}

2005 
	$nvme_fc_cÚÃù_io_queues
(
nvme_fc_ù¾
 *
ù¾
, 
u16
 
qsize
)

2007 
i
, 
»t
 = 0;

2009 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

2010 
»t
 = 
	`nvme_fc_cÚÃù_queue
(
ù¾
, &ù¾->
queues
[
i
], 
qsize
,

2011 (
qsize
 / 5));

2012 ià(
»t
)

2014 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

2015 ià(
»t
)

2018 
	`£t_b™
(
NVME_FC_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

2021  
»t
;

2022 
	}
}

2025 
	$nvme_fc_š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2027 
i
;

2029 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

2030 
	`nvme_fc_š™_queue
(
ù¾
, 
i
);

2031 
	}
}

2034 
	$nvme_fc_ù¾_ä“
(
k»f
 *
»f
)

2036 
nvme_fc_ù¾
 *
ù¾
 =

2037 
	`cÚš”_of
(
»f
, 
nvme_fc_ù¾
,„ef);

2038 
æags
;

2040 ià(
ù¾
->ù¾.
g£t
) {

2041 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

2042 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

2046 
	`¥š_lock_œq§ve
(&
ù¾
->
½Üt
->
lock
, 
æags
);

2047 
	`li¡_d–
(&
ù¾
->
ù¾_li¡
);

2048 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
½Üt
->
lock
, 
æags
);

2050 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2051 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

2052 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

2054 
	`kä“
(
ù¾
->
queues
);

2056 
	`put_deviû
(
ù¾
->
dev
);

2057 
	`nvme_fc_½Üt_put
(
ù¾
->
½Üt
);

2059 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

2060 ià(
ù¾
->ù¾.
İts
)

2061 
	`nvmf_ä“_İtiÚs
(
ù¾
->ù¾.
İts
);

2062 
	`kä“
(
ù¾
);

2063 
	}
}

2066 
	$nvme_fc_ù¾_put
(
nvme_fc_ù¾
 *
ù¾
)

2068 
	`k»f_put
(&
ù¾
->
»f
, 
nvme_fc_ù¾_ä“
);

2069 
	}
}

2072 
	$nvme_fc_ù¾_g‘
(
nvme_fc_ù¾
 *
ù¾
)

2074  
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
»f
);

2075 
	}
}

2082 
	$nvme_fc_nvme_ù¾_ä“d
(
nvme_ù¾
 *
nù¾
)

2084 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2086 
	`WARN_ON
(
nù¾
 !ğ&
ù¾
->ctrl);

2088 
	`nvme_fc_ù¾_put
(
ù¾
);

2089 
	}
}

2092 
	$nvme_fc_”rÜ_»cov”y
(
nvme_fc_ù¾
 *
ù¾
, *
”rmsg
)

2095 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_LIVE
)

2098 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2100 
ù¾
->
úum
, 
”rmsg
);

2101 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2102 "NVME-FC{%d}:„e£‰šg cÚŒŞËr\n", 
ù¾
->
úum
);

2104 
	`nvme_»£t_ù¾
(&
ù¾
->ctrl);

2105 
	}
}

2107 
blk_eh_tim”_»tuº


2108 
	$nvme_fc_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

2110 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2111 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

2112 
»t
;

2114 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
 ||

2115 
	`©omic_»ad
(&
İ
->
¡©e
è=ğ
FCPOP_STATE_ABORTED
)

2116  
BLK_EH_RESET_TIMER
;

2118 
»t
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
İ
);

2119 ià(
»t
)

2121  
BLK_EH_NOT_HANDLED
;

2130 
	`nvme_fc_”rÜ_»cov”y
(
ù¾
, "ioimeoutƒrror");

2137  
BLK_EH_RESET_TIMER
;

2138 
	}
}

2141 
	$nvme_fc_m­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

2142 
nvme_fc_fı_İ
 *
İ
)

2144 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

2145 
dma_d©a_dœeùiÚ
 
dœ
;

2146 
»t
;

2148 
äeq
->
sg_út
 = 0;

2150 ià(!
	`blk_rq_·ylßd_by‹s
(
rq
))

2153 
äeq
->
sg_bË
.
sgl
 = f»q->
fœ¡_sgl
;

2154 
»t
 = 
	`sg_®loc_bË_chašed
(&
äeq
->
sg_bË
,

2155 
	`blk_rq_Ä_phys_£gm’ts
(
rq
), 
äeq
->
sg_bË
.
sgl
);

2156 ià(
»t
)

2157  -
ENOMEM
;

2159 
İ
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q, 
äeq
->
sg_bË
.
sgl
);

2160 
	`WARN_ON
(
İ
->
ÃÁs
 > 
	`blk_rq_Ä_phys_£gm’ts
(
rq
));

2161 
dœ
 = (
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
è? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

2162 
äeq
->
sg_út
 = 
	`fc_dma_m­_sg
(
ù¾
->
ÍÜt
->
dev
, f»q->
sg_bË
.
sgl
,

2163 
İ
->
ÃÁs
, 
dœ
);

2164 ià(
	`uÆik–y
(
äeq
->
sg_út
 <= 0)) {

2165 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

2166 
äeq
->
sg_út
 = 0;

2167  -
EFAULT
;

2174 
	}
}

2177 
	$nvme_fc_unm­_d©a
(
nvme_fc_ù¾
 *
ù¾
, 
»que¡
 *
rq
,

2178 
nvme_fc_fı_İ
 *
İ
)

2180 
nvmefc_fı_»q
 *
äeq
 = &
İ
->
fı_»q
;

2182 ià(!
äeq
->
sg_út
)

2185 
	`fc_dma_unm­_sg
(
ù¾
->
ÍÜt
->
dev
, 
äeq
->
sg_bË
.
sgl
, 
İ
->
ÃÁs
,

2186 ((
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
) ?

2187 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
));

2189 
	`nvme_ş—nup_cmd
(
rq
);

2191 
	`sg_ä“_bË_chašed
(&
äeq
->
sg_bË
, 
Œue
);

2193 
äeq
->
sg_út
 = 0;

2194 
	}
}

2219 
blk_¡©us_t


2220 
	$nvme_fc_¡¬t_fı_İ
(
nvme_fc_ù¾
 *
ù¾
, 
nvme_fc_queue
 *
queue
,

2221 
nvme_fc_fı_İ
 *
İ
, 
u32
 
d©a_Ën
,

2222 
nvmefc_fı_d©adœ
 
io_dœ
)

2224 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

2225 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

2226 
u32
 
c¢
;

2227 
»t
;

2233 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
)

2234 
busy
;

2236 ià(!
	`nvme_fc_ù¾_g‘
(
ù¾
))

2237  
BLK_STS_IOERR
;

2240 
cmdiu
->
cÚÃùiÚ_id
 = 
	`ıu_to_be64
(
queue
->connection_id);

2241 
c¢
 = 
	`©omic_šc_»tuº
(&
queue
->csn);

2242 
cmdiu
->
c¢
 = 
	`ıu_to_be32
(csn);

2243 
cmdiu
->
d©a_Ën
 = 
	`ıu_to_be32
(data_len);

2244 
io_dœ
) {

2245 
NVMEFC_FCP_WRITE
:

2246 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_WRITE
;

2248 
NVMEFC_FCP_READ
:

2249 
cmdiu
->
æags
 = 
FCNVME_CMD_FLAGS_READ
;

2251 
NVMEFC_FCP_NODATA
:

2252 
cmdiu
->
æags
 = 0;

2255 
İ
->
fı_»q
.
·ylßd_Ëngth
 = 
d©a_Ën
;

2256 
İ
->
fı_»q
.
io_dœ
 = io_dir;

2257 
İ
->
fı_»q
.
Œªsã¼ed_Ëngth
 = 0;

2258 
İ
->
fı_»q
.
rcv_r¥Ën
 = 0;

2259 
İ
->
fı_»q
.
¡©us
 = 
NVME_SC_SUCCESS
;

2260 
İ
->
fı_»q
.
sqid
 = 
	`ıu_to_Ë16
(
queue
->
qnum
);

2266 
	`WARN_ON_ONCE
(
sqe
->
commÚ
.
m‘ad©a
);

2267 
sqe
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

2276 
sqe
->
rw
.
d±r
.
sgl
.
ty³
 = (
NVME_TRANSPORT_SGL_DATA_DESC
 << 4) |

2277 
NVME_SGL_FMT_TRANSPORT_A
;

2278 
sqe
->
rw
.
d±r
.
sgl
.
Ëngth
 = 
	`ıu_to_Ë32
(
d©a_Ën
);

2279 
sqe
->
rw
.
d±r
.
sgl
.
addr
 = 0;

2281 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
)) {

2282 
»t
 = 
	`nvme_fc_m­_d©a
(
ù¾
, 
İ
->
rq
, op);

2283 ià(
»t
 < 0) {

2284 
	`nvme_ş—nup_cmd
(
İ
->
rq
);

2285 
	`nvme_fc_ù¾_put
(
ù¾
);

2286 ià(
»t
 =ğ-
ENOMEM
 ||„‘ =ğ-
EAGAIN
)

2287  
BLK_STS_RESOURCE
;

2288  
BLK_STS_IOERR
;

2292 
	`fc_dma_sync_sšgË_fÜ_deviû
(
ù¾
->
ÍÜt
->
dev
, 
İ
->
fı_»q
.
cmddma
,

2293 (
İ
->
cmd_iu
), 
DMA_TO_DEVICE
);

2295 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_ACTIVE
);

2297 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
))

2298 
	`blk_mq_¡¬t_»que¡
(
İ
->
rq
);

2300 
»t
 = 
ù¾
->
ÍÜt
->
İs
->
	`fı_io
(&ù¾->ÍÜt->
loÿÍÜt
,

2301 &
ù¾
->
½Üt
->
»mÙ•Üt
,

2302 
queue
->
Îdd_hªdË
, &
İ
->
fı_»q
);

2304 ià(
»t
) {

2305 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
))

2306 
	`nvme_fc_unm­_d©a
(
ù¾
, 
İ
->
rq
, op);

2308 
	`nvme_fc_ù¾_put
(
ù¾
);

2310 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ğ
FC_OBJSTATE_ONLINE
 &&

2311 
»t
 !ğ-
EBUSY
)

2312  
BLK_STS_IOERR
;

2314 
busy
;

2317  
BLK_STS_OK
;

2319 
busy
:

2320 ià(!(
İ
->
æags
 & 
FCOP_FLAGS_AEN
è&& 
queue
->
hùx
)

2321 
	`blk_mq_d–ay_run_hw_queue
(
queue
->
hùx
, 
NVMEFC_QUEUE_DELAY
);

2323  
BLK_STS_RESOURCE
;

2324 
	}
}

2326 
šlše
 
blk_¡©us_t
 
	$nvme_fc_is_»ady
(
nvme_fc_queue
 *
queue
,

2327 
»que¡
 *
rq
)

2329 ià(
	`uÆik–y
(!
	`‹¡_b™
(
NVME_FC_Q_LIVE
, &
queue
->
æags
)))

2330  
	`nvmf_check_š™_»q
(&
queue
->
ù¾
->ù¾, 
rq
);

2331  
BLK_STS_OK
;

2332 
	}
}

2334 
blk_¡©us_t


2335 
	$nvme_fc_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

2336 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

2338 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

2339 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

2340 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

2341 
»que¡
 *
rq
 = 
bd
->rq;

2342 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2343 
nvme_fc_cmd_iu
 *
cmdiu
 = &
İ
->
cmd_iu
;

2344 
nvme_commªd
 *
sqe
 = &
cmdiu
->sqe;

2345 
nvmefc_fı_d©adœ
 
io_dœ
;

2346 
u32
 
d©a_Ën
;

2347 
blk_¡©us_t
 
»t
;

2349 
»t
 = 
	`nvme_fc_is_»ady
(
queue
, 
rq
);

2350 ià(
	`uÆik–y
(
»t
))

2351  
»t
;

2353 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
sqe
);

2354 ià(
»t
)

2355  
»t
;

2357 
d©a_Ën
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

2358 ià(
d©a_Ën
)

2359 
io_dœ
 = ((
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
) ?

2360 
NVMEFC_FCP_WRITE
 : 
NVMEFC_FCP_READ
);

2362 
io_dœ
 = 
NVMEFC_FCP_NODATA
;

2364  
	`nvme_fc_¡¬t_fı_İ
(
ù¾
, 
queue
, 
İ
, 
d©a_Ën
, 
io_dœ
);

2365 
	}
}

2367 
blk_mq_gs
 *

2368 
	$nvme_fc_g£t
(
nvme_fc_queue
 *
queue
)

2370 ià(
queue
->
qnum
 == 0)

2371  
queue
->
ù¾
->
admš_g_£t
.
gs
[queue->
qnum
];

2373  
queue
->
ù¾
->
g_£t
.
gs
[queue->
qnum
 - 1];

2374 
	}
}

2377 
	$nvme_fc_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

2380 
nvme_fc_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

2381 
nvme_fc_ù¾
 *
ù¾
 = 
queue
->ctrl;

2382 
»que¡
 *
»q
;

2383 
nvme_fc_fı_İ
 *
İ
;

2385 
»q
 = 
	`blk_mq_g_to_rq
(
	`nvme_fc_g£t
(
queue
), 
g
);

2386 ià(!
»q
)

2389 
İ
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2391 ià((
	`©omic_»ad
(&
İ
->
¡©e
è=ğ
FCPOP_STATE_ACTIVE
) &&

2392 (
ù¾
->
ÍÜt
->
İs
->
pŞl_queue
))

2393 
ù¾
->
ÍÜt
->
İs
->
	`pŞl_queue
(&ù¾->ÍÜt->
loÿÍÜt
,

2394 
queue
->
Îdd_hªdË
);

2396  ((
	`©omic_»ad
(&
İ
->
¡©e
è!ğ
FCPOP_STATE_ACTIVE
));

2397 
	}
}

2400 
	$nvme_fc_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
)

2402 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
¬g
);

2403 
nvme_fc_fı_İ
 *
«n_İ
;

2404 
æags
;

2405 
boŞ
 
‹rmš©šg
 = 
çl£
;

2406 
blk_¡©us_t
 
»t
;

2408 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2409 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

2410 
‹rmš©šg
 = 
Œue
;

2411 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2413 ià(
‹rmš©šg
)

2416 
«n_İ
 = &
ù¾
->
«n_İs
[0];

2418 
»t
 = 
	`nvme_fc_¡¬t_fı_İ
(
ù¾
, 
«n_İ
->
queue
,‡en_op, 0,

2419 
NVMEFC_FCP_NODATA
);

2420 ià(
»t
)

2421 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2423 
	}
}

2426 
	$__nvme_fc_fš®_İ_ş—nup
(
»que¡
 *
rq
)

2428 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2429 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

2431 
	`©omic_£t
(&
İ
->
¡©e
, 
FCPOP_STATE_IDLE
);

2432 
İ
->
æags
 &ğ~(
FCOP_FLAGS_TERMIO
 | 
FCOP_FLAGS_RELEASED
 |

2433 
FCOP_FLAGS_COMPLETE
);

2435 
	`nvme_fc_unm­_d©a
(
ù¾
, 
rq
, 
İ
);

2436 
	`nvme_com¶‘e_rq
(
rq
);

2437 
	`nvme_fc_ù¾_put
(
ù¾
);

2439 
	}
}

2442 
	$nvme_fc_com¶‘e_rq
(
»que¡
 *
rq
)

2444 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2445 
nvme_fc_ù¾
 *
ù¾
 = 
İ
->ctrl;

2446 
æags
;

2447 
boŞ
 
com¶‘ed
 = 
çl£
;

2457 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2458 ià(
İ
->
æags
 & 
FCOP_FLAGS_COMPLETE
)

2459 
com¶‘ed
 = 
Œue
;

2461 
İ
->
æags
 |ğ
FCOP_FLAGS_RELEASED
;

2462 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2464 ià(
com¶‘ed
)

2465 
	`__nvme_fc_fš®_İ_ş—nup
(
rq
);

2466 
	}
}

2482 
	$nvme_fc_‹rmš©e_exchªge
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

2484 
nvme_ù¾
 *
nù¾
 = 
d©a
;

2485 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2486 
nvme_fc_fı_İ
 *
İ
 = 
	`blk_mq_rq_to_pdu
(
»q
);

2487 
æags
;

2488 
¡©us
;

2490 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

2493 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2494 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
) {

2495 
ù¾
->
ioút
++;

2496 
İ
->
æags
 |ğ
FCOP_FLAGS_TERMIO
;

2498 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2500 
¡©us
 = 
	`__nvme_fc_abÜt_İ
(
ù¾
, 
İ
);

2501 ià(
¡©us
) {

2509 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2510 ià(
ù¾
->
æags
 & 
FCCTRL_TERMIO
)

2511 
ù¾
->
ioút
--;

2512 
İ
->
æags
 &ğ~
FCOP_FLAGS_TERMIO
;

2513 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2516 
	}
}

2519 cÚ¡ 
blk_mq_İs
 
	gnvme_fc_mq_İs
 = {

2520 .
queue_rq
 = 
nvme_fc_queue_rq
,

2521 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

2522 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

2523 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

2524 .
	gš™_hùx
 = 
nvme_fc_š™_hùx
,

2525 .
	gpŞl
 = 
nvme_fc_pŞl
,

2526 .
	gtimeout
 = 
nvme_fc_timeout
,

2530 
	$nvme_fc_ü—‹_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2532 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2533 
Ä_io_queues
;

2534 
»t
;

2536 
Ä_io_queues
 = 
	`mš
(mš(
İts
->Ä_io_queues, 
	`num_Úlše_ıus
()),

2537 
ù¾
->
ÍÜt
->
İs
->
max_hw_queues
);

2538 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

2539 ià(
»t
) {

2540 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2541 "£t_queue_couÁ faed: %d\n", 
»t
);

2542  
»t
;

2545 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

2546 ià(!
Ä_io_queues
)

2549 
	`nvme_fc_š™_io_queues
(
ù¾
);

2551 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

2552 
ù¾
->
g_£t
.
İs
 = &
nvme_fc_mq_İs
;

2553 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
İts
->
queue_size
;

2554 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

2555 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

2556 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2557 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_fc_fı_İ
) +

2558 (
SG_CHUNK_SIZE
 *

2559 (
sÿ‰”li¡
)) +

2560 
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
;

2561 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

2562 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->ù¾.
queue_couÁ
 - 1;

2563 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2565 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

2566 ià(
»t
)

2567  
»t
;

2569 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

2571 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

2572 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

2573 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

2574 
out_ä“_g_£t
;

2577 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2578 ià(
»t
)

2579 
out_ş—nup_blk_queue
;

2581 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2582 ià(
»t
)

2583 
out_d–‘e_hw_queues
;

2587 
out_d–‘e_hw_queues
:

2588 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2589 
out_ş—nup_blk_queue
:

2590 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

2591 
out_ä“_g_£t
:

2592 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

2593 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2596 
ù¾
->ù¾.
g£t
 = 
NULL
;

2598  
»t
;

2599 
	}
}

2602 
	$nvme_fc_»š™_io_queues
(
nvme_fc_ù¾
 *
ù¾
)

2604 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2605 
Ä_io_queues
;

2606 
»t
;

2608 
Ä_io_queues
 = 
	`mš
(mš(
İts
->Ä_io_queues, 
	`num_Úlše_ıus
()),

2609 
ù¾
->
ÍÜt
->
İs
->
max_hw_queues
);

2610 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

2611 ià(
»t
) {

2612 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2613 "£t_queue_couÁ faed: %d\n", 
»t
);

2614  
»t
;

2617 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

2619 ià(
ù¾
->ù¾.
queue_couÁ
 == 1)

2622 
	`nvme_fc_š™_io_queues
(
ù¾
);

2624 
»t
 = 
	`nvme_»š™_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
g£t
);

2625 ià(
»t
)

2626 
out_ä“_io_queues
;

2628 
»t
 = 
	`nvme_fc_ü—‹_hw_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2629 ià(
»t
)

2630 
out_ä“_io_queues
;

2632 
»t
 = 
	`nvme_fc_cÚÃù_io_queues
(
ù¾
, cŒl->ù¾.
İts
->
queue_size
);

2633 ià(
»t
)

2634 
out_d–‘e_hw_queues
;

2636 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
, 
Ä_io_queues
);

2640 
out_d–‘e_hw_queues
:

2641 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2642 
out_ä“_io_queues
:

2643 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2644  
»t
;

2645 
	}
}

2648 
	$nvme_fc_½Üt_aùive_Ú_ÍÜt
(
nvme_fc_½Üt
 *
½Üt
)

2650 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
½Üt
->lport;

2652 
	`©omic_šc
(&
ÍÜt
->
aù_½Üt_út
);

2653 
	}
}

2656 
	$nvme_fc_½Üt_šaùive_Ú_ÍÜt
(
nvme_fc_½Üt
 *
½Üt
)

2658 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
½Üt
->lport;

2659 
u32
 
út
;

2661 
út
 = 
	`©omic_dec_»tuº
(&
ÍÜt
->
aù_½Üt_út
);

2662 ià(
út
 =ğ0 && 
ÍÜt
->
loÿÍÜt
.
pÜt_¡©e
 =ğ
FC_OBJSTATE_DELETED
)

2663 
ÍÜt
->
İs
->
	`loÿÍÜt_d–‘e
(&ÍÜt->
loÿÍÜt
);

2664 
	}
}

2667 
	$nvme_fc_ùÌ_aùive_Ú_½Üt
(
nvme_fc_ù¾
 *
ù¾
)

2669 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2670 
u32
 
út
;

2672 ià(
ù¾
->
assoc_aùive
)

2675 
ù¾
->
assoc_aùive
 = 
Œue
;

2676 
út
 = 
	`©omic_šc_»tuº
(&
½Üt
->
aù_ù¾_út
);

2677 ià(
út
 == 1)

2678 
	`nvme_fc_½Üt_aùive_Ú_ÍÜt
(
½Üt
);

2681 
	}
}

2684 
	$nvme_fc_ùÌ_šaùive_Ú_½Üt
(
nvme_fc_ù¾
 *
ù¾
)

2686 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2687 
nvme_fc_ÍÜt
 *
ÍÜt
 = 
½Üt
->lport;

2688 
u32
 
út
;

2692 
út
 = 
	`©omic_dec_»tuº
(&
½Üt
->
aù_ù¾_út
);

2693 ià(
út
 == 0) {

2694 ià(
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ğ
FC_OBJSTATE_DELETED
)

2695 
ÍÜt
->
İs
->
	`»mÙ•Üt_d–‘e
(&
½Üt
->
»mÙ•Üt
);

2696 
	`nvme_fc_½Üt_šaùive_Ú_ÍÜt
(
½Üt
);

2700 
	}
}

2707 
	$nvme_fc_ü—‹_assocŸtiÚ
(
nvme_fc_ù¾
 *
ù¾
)

2709 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

2710 
»t
;

2711 
boŞ
 
chªged
;

2713 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

2715 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 !ğ
FC_OBJSTATE_ONLINE
)

2716  -
ENODEV
;

2718 ià(
	`nvme_fc_ùÌ_aùive_Ú_½Üt
(
ù¾
))

2719  -
ENOTUNIQ
;

2725 
	`nvme_fc_š™_queue
(
ù¾
, 0);

2727 
»t
 = 
	`__nvme_fc_ü—‹_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0,

2728 
NVME_AQ_BLK_MQ_DEPTH
);

2729 ià(
»t
)

2730 
out_ä“_queue
;

2732 
»t
 = 
	`nvme_fc_cÚÃù_admš_queue
(
ù¾
, &ù¾->
queues
[0],

2733 
NVME_AQ_BLK_MQ_DEPTH
,

2734 (
NVME_AQ_BLK_MQ_DEPTH
 / 4));

2735 ià(
»t
)

2736 
out_d–‘e_hw_queue
;

2738 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_NEW
)

2739 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2741 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

2742 ià(
»t
)

2743 
out_discÚÃù_admš_queue
;

2745 
	`£t_b™
(
NVME_FC_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

2754 
»t
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
, &ù¾->ù¾.
ÿp
);

2755 ià(
»t
) {

2756 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2758 
out_discÚÃù_admš_queue
;

2761 
ù¾
->ù¾.
sqsize
 =

2762 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->ù¾.
ÿp
è+ 1, cŒl->ù¾.
sqsize
);

2764 
»t
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

2765 ià(
»t
)

2766 
out_discÚÃù_admš_queue
;

2768 
ù¾
->ù¾.
max_hw_£ùÜs
 =

2769 (
ù¾
->
ÍÜt
->
İs
->
max_sgl_£gm’ts
 - 1è<< (
PAGE_SHIFT
 - 9);

2771 
»t
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

2772 ià(
»t
)

2773 
out_discÚÃù_admš_queue
;

2778 ià(
ù¾
->ù¾.
icdoff
) {

2779 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff %d is‚ot supported!\n",

2780 
ù¾
->ù¾.
icdoff
);

2781 
out_discÚÃù_admš_queue
;

2786 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

2788 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2791 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

2792 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

2795 
»t
 = 
	`nvme_fc_š™_«n_İs
(
ù¾
);

2796 ià(
»t
)

2797 
out_‹rm_«n_İs
;

2803 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

2804 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
)

2805 
»t
 = 
	`nvme_fc_ü—‹_io_queues
(
ù¾
);

2807 
»t
 = 
	`nvme_fc_»š™_io_queues
(
ù¾
);

2808 ià(
»t
)

2809 
out_‹rm_«n_İs
;

2812 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

2814 
ù¾
->ù¾.
Ä_»cÚÃùs
 = 0;

2816 ià(
chªged
)

2817 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

2821 
out_‹rm_«n_İs
:

2822 
	`nvme_fc_‹rm_«n_İs
(
ù¾
);

2823 
out_discÚÃù_admš_queue
:

2825 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2826 
out_d–‘e_hw_queue
:

2827 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2828 
out_ä“_queue
:

2829 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2830 
ù¾
->
assoc_aùive
 = 
çl£
;

2831 
	`nvme_fc_ùÌ_šaùive_Ú_½Üt
(
ù¾
);

2833  
»t
;

2834 
	}
}

2843 
	$nvme_fc_d–‘e_assocŸtiÚ
(
nvme_fc_ù¾
 *
ù¾
)

2845 
æags
;

2847 ià(!
ù¾
->
assoc_aùive
)

2849 
ù¾
->
assoc_aùive
 = 
çl£
;

2851 
	`¥š_lock_œq§ve
(&
ù¾
->
lock
, 
æags
);

2852 
ù¾
->
æags
 |ğ
FCCTRL_TERMIO
;

2853 
ù¾
->
ioút
 = 0;

2854 
	`¥š_uÆock_œq»¡Üe
(&
ù¾
->
lock
, 
æags
);

2868 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

2869 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

2870 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

2871 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2891 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_NEW
)

2892 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

2893 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

2894 
nvme_fc_‹rmš©e_exchªge
, &
ù¾
->ctrl);

2897 
	`nvme_fc_abÜt_«n_İs
(
ù¾
);

2900 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2901 
	`wa™_ev’t_lock_œq
(
ù¾
->
ißbÜt_wa™
, cŒl->
ioút
 =ğ0, cŒl->
lock
);

2902 
ù¾
->
æags
 &ğ~
FCCTRL_TERMIO
;

2903 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2905 
	`nvme_fc_‹rm_«n_İs
(
ù¾
);

2913 ià(
ù¾
->
assocŸtiÚ_id
)

2914 
	`nvme_fc_xmt_discÚÃù_assoc
(
ù¾
);

2916 ià(
ù¾
->ù¾.
g£t
) {

2917 
	`nvme_fc_d–‘e_hw_io_queues
(
ù¾
);

2918 
	`nvme_fc_ä“_io_queues
(
ù¾
);

2921 
	`__nvme_fc_d–‘e_hw_queue
(
ù¾
, &ù¾->
queues
[0], 0);

2922 
	`nvme_fc_ä“_queue
(&
ù¾
->
queues
[0]);

2924 
	`nvme_fc_ùÌ_šaùive_Ú_½Üt
(
ù¾
);

2925 
	}
}

2928 
	$nvme_fc_d–‘e_ù¾
(
nvme_ù¾
 *
nù¾
)

2930 
nvme_fc_ù¾
 *
ù¾
 = 
	`to_fc_ù¾
(
nù¾
);

2932 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
cÚÃù_wÜk
);

2937 
	`nvme_fc_d–‘e_assocŸtiÚ
(
ù¾
);

2938 
	}
}

2941 
	$nvme_fc_»cÚÃù_Ü_d–‘e
(
nvme_fc_ù¾
 *
ù¾
, 
¡©us
)

2943 
nvme_fc_½Üt
 *
½Üt
 = 
ù¾
->rport;

2944 
nvme_fc_»mÙe_pÜt
 *
pÜŒ
 = &
½Üt
->
»mÙ•Üt
;

2945 
»cÚ_d–ay
 = 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
 * 
HZ
;

2946 
boŞ
 
»cÚ
 = 
Œue
;

2948 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_RECONNECTING
)

2951 ià(
pÜŒ
->
pÜt_¡©e
 =ğ
FC_OBJSTATE_ONLINE
)

2952 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2954 
ù¾
->
úum
, 
¡©us
);

2955 ià(
	`time_aá”_eq
(
jiff›s
, 
½Üt
->
dev_loss_’d
))

2956 
»cÚ
 = 
çl£
;

2958 ià(
»cÚ
 && 
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

2959 ià(
pÜŒ
->
pÜt_¡©e
 =ğ
FC_OBJSTATE_ONLINE
)

2960 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2963 
ù¾
->
úum
, 
»cÚ_d–ay
 / 
HZ
);

2964 ià(
	`time_aá”
(
jiff›s
 + 
»cÚ_d–ay
, 
½Üt
->
dev_loss_’d
))

2965 
»cÚ_d–ay
 = 
½Üt
->
dev_loss_’d
 - 
jiff›s
;

2967 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
cÚÃù_wÜk
, 
»cÚ_d–ay
);

2969 ià(
pÜŒ
->
pÜt_¡©e
 =ğ
FC_OBJSTATE_ONLINE
)

2970 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2973 
ù¾
->
úum
, cŒl->ù¾.
Ä_»cÚÃùs
);

2975 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

2978 "Removšg cÚŒŞËr\n", 
ù¾
->
úum
,

2979 
pÜŒ
->
dev_loss_tmo
);

2980 
	`WARN_ON
(
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl));

2982 
	}
}

2985 
	$nvme_fc_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2987 
nvme_fc_ù¾
 *
ù¾
 =

2988 
	`cÚš”_of
(
wÜk
, 
nvme_fc_ù¾
, 
ù¾
.
»£t_wÜk
);

2989 
»t
;

2991 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

2994 
	`nvme_fc_d–‘e_assocŸtiÚ
(
ù¾
);

2996 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
)) {

2997 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

2999 "tØRECONNECTING\n", 
ù¾
->
úum
);

3003 ià(
ù¾
->
½Üt
->
»mÙ•Üt
.
pÜt_¡©e
 =ğ
FC_OBJSTATE_ONLINE
)

3004 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

3006 
»t
 = -
ENOTCONN
;

3008 ià(
»t
)

3009 
	`nvme_fc_»cÚÃù_Ü_d–‘e
(
ù¾
, 
»t
);

3011 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

3013 
ù¾
->
úum
);

3014 
	}
}

3016 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_fc_ù¾_İs
 = {

3017 .
Çme
 = "fc",

3018 .
	gmoduË
 = 
THIS_MODULE
,

3019 .
	gæags
 = 
NVME_F_FABRICS
,

3020 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

3021 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

3022 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

3023 .
	gä“_ù¾
 = 
nvme_fc_nvme_ù¾_ä“d
,

3024 .
	gsubm™_async_ev’t
 = 
nvme_fc_subm™_async_ev’t
,

3025 .
	gd–‘e_ù¾
 = 
nvme_fc_d–‘e_ù¾
,

3026 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

3027 .
	g»š™_»que¡
 = 
nvme_fc_»š™_»que¡
,

3031 
	$nvme_fc_cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

3033 
»t
;

3035 
nvme_fc_ù¾
 *
ù¾
 =

3036 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

3037 
nvme_fc_ù¾
, 
cÚÃù_wÜk
);

3039 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

3040 ià(
»t
)

3041 
	`nvme_fc_»cÚÃù_Ü_d–‘e
(
ù¾
, 
»t
);

3043 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

3045 
ù¾
->
úum
);

3046 
	}
}

3049 cÚ¡ 
blk_mq_İs
 
	gnvme_fc_admš_mq_İs
 = {

3050 .
queue_rq
 = 
nvme_fc_queue_rq
,

3051 .
	gcom¶‘e
 = 
nvme_fc_com¶‘e_rq
,

3052 .
	gš™_»que¡
 = 
nvme_fc_š™_»que¡
,

3053 .
	gex™_»que¡
 = 
nvme_fc_ex™_»que¡
,

3054 .
	gš™_hùx
 = 
nvme_fc_š™_admš_hùx
,

3055 .
	gtimeout
 = 
nvme_fc_timeout
,

3067 
boŞ


3068 
	$nvme_fc_exi¡šg_cÚŒŞËr
(
nvme_fc_½Üt
 *
½Üt
,

3069 
nvmf_ù¾_İtiÚs
 *
İts
)

3071 
nvme_fc_ù¾
 *
ù¾
;

3072 
æags
;

3073 
boŞ
 
found
 = 
çl£
;

3075 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

3076 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
½Üt
->
ù¾_li¡
, ctrl_list) {

3077 
found
 = 
	`nvmf_ùÌ_m©ches_ba£İts
(&
ù¾
->ù¾, 
İts
);

3078 ià(
found
)

3081 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

3083  
found
;

3084 
	}
}

3086 
nvme_ù¾
 *

3087 
	$nvme_fc_š™_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_İtiÚs
 *
İts
,

3088 
nvme_fc_ÍÜt
 *
ÍÜt
, 
nvme_fc_½Üt
 *
½Üt
)

3090 
nvme_fc_ù¾
 *
ù¾
;

3091 
æags
;

3092 
»t
, 
idx
, 
»Œy
;

3094 ià(!(
½Üt
->
»mÙ•Üt
.
pÜt_rŞe
 &

3095 (
FC_PORT_ROLE_NVME_DISCOVERY
 | 
FC_PORT_ROLE_NVME_TARGET
))) {

3096 
»t
 = -
EBADR
;

3097 
out_ç
;

3100 ià(!
İts
->
du¶iÿ‹_cÚÃù
 &&

3101 
	`nvme_fc_exi¡šg_cÚŒŞËr
(
½Üt
, 
İts
)) {

3102 
»t
 = -
EALREADY
;

3103 
out_ç
;

3106 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

3107 ià(!
ù¾
) {

3108 
»t
 = -
ENOMEM
;

3109 
out_ç
;

3112 
idx
 = 
	`ida_sim¶e_g‘
(&
nvme_fc_ù¾_út
, 0, 0, 
GFP_KERNEL
);

3113 ià(
idx
 < 0) {

3114 
»t
 = -
ENOSPC
;

3115 
out_ä“_ù¾
;

3118 
ù¾
->ù¾.
İts
 = opts;

3119 
	`INIT_LIST_HEAD
(&
ù¾
->
ù¾_li¡
);

3120 
ù¾
->
ÍÜt
 =†port;

3121 
ù¾
->
½Üt
 =„port;

3122 
ù¾
->
dev
 = 
ÍÜt
->dev;

3123 
ù¾
->
úum
 = 
idx
;

3124 
ù¾
->
assoc_aùive
 = 
çl£
;

3125 
	`š™_wa™queue_h—d
(&
ù¾
->
ißbÜt_wa™
);

3127 
	`g‘_deviû
(
ù¾
->
dev
);

3128 
	`k»f_š™
(&
ù¾
->
»f
);

3130 
	`INIT_WORK
(&
ù¾
->ù¾.
»£t_wÜk
, 
nvme_fc_»£t_ù¾_wÜk
);

3131 
	`INIT_DELAYED_WORK
(&
ù¾
->
cÚÃù_wÜk
, 
nvme_fc_cÚÃù_ù¾_wÜk
);

3132 
	`¥š_lock_š™
(&
ù¾
->
lock
);

3135 
ù¾
->ù¾.
queue_couÁ
 = 
	`mš_t
(,

3136 
İts
->
Ä_io_queues
,

3137 
ÍÜt
->
İs
->
max_hw_queues
);

3138 
ù¾
->ù¾.
queue_couÁ
++;

3140 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

3141 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

3143 
»t
 = -
ENOMEM
;

3144 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->ù¾.
queue_couÁ
,

3145 (
nvme_fc_queue
), 
GFP_KERNEL
);

3146 ià(!
ù¾
->
queues
)

3147 
out_ä“_ida
;

3149 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

3150 
ù¾
->
admš_g_£t
.
İs
 = &
nvme_fc_admš_mq_İs
;

3151 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_AQ_MQ_TAG_DEPTH
;

3152 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

3153 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

3154 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_fc_fı_İ
) +

3155 (
SG_CHUNK_SIZE
 *

3156 (
sÿ‰”li¡
)) +

3157 
ù¾
->
ÍÜt
->
İs
->
fırq¡_´iv_sz
;

3158 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

3159 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

3160 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

3161 
ù¾
->
admš_g_£t
.
æags
 = 
BLK_MQ_F_NO_SCHED
;

3163 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

3164 ià(
»t
)

3165 
out_ä“_queues
;

3166 
ù¾
->ù¾.
admš_g£t
 = &ù¾->
admš_g_£t
;

3168 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

3169 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

3170 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

3171 
out_ä“_admš_g_£t
;

3181 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_fc_ù¾_İs
, 0);

3182 ià(
»t
)

3183 
out_ş—nup_admš_q
;

3187 
	`¥š_lock_œq§ve
(&
½Üt
->
lock
, 
æags
);

3188 
	`li¡_add_
(&
ù¾
->
ù¾_li¡
, &
½Üt
->ctrl_list);

3189 
	`¥š_uÆock_œq»¡Üe
(&
½Üt
->
lock
, 
æags
);

3209 
»Œy
 = 0;„etry < 3;„etry++) {

3210 
»t
 = 
	`nvme_fc_ü—‹_assocŸtiÚ
(
ù¾
);

3211 ià(!
»t
)

3215 ià(
»t
) {

3217 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

3218 "NVME-FC{%d}: CÚÃù„‘ry faed\n", 
ù¾
->
úum
);

3220 
ù¾
->ù¾.
İts
 = 
NULL
;

3223 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

3226 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

3235 
	`nvme_fc_½Üt_g‘
(
½Üt
);

3237 ià(
»t
 > 0)

3238 
»t
 = -
EIO
;

3239  
	`ERR_PTR
(
»t
);

3242 
	`nvme_g‘_ù¾
(&
ù¾
->ctrl);

3244 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

3246 
ù¾
->
úum
, cŒl->ù¾.
İts
->
subsy¢qn
);

3248  &
ù¾
->ctrl;

3250 
out_ş—nup_admš_q
:

3251 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

3252 
out_ä“_admš_g_£t
:

3253 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

3254 
out_ä“_queues
:

3255 
	`kä“
(
ù¾
->
queues
);

3256 
out_ä“_ida
:

3257 
	`put_deviû
(
ù¾
->
dev
);

3258 
	`ida_sim¶e_»move
(&
nvme_fc_ù¾_út
, 
ù¾
->
úum
);

3259 
out_ä“_ù¾
:

3260 
	`kä“
(
ù¾
);

3261 
out_ç
:

3263  
	`ERR_PTR
(
»t
);

3264 
	}
}

3267 
	snvm‘_fc_Œaddr
 {

3268 
u64
 
	mÂ
;

3269 
u64
 
	m²
;

3273 
	$__nvme_fc_·r£_u64
(
sub¡ršg_t
 *
s¡r
, 
u64
 *
v®
)

3275 
u64
 
tok’64
;

3277 ià(
	`m©ch_u64
(
s¡r
, &
tok’64
))

3278  -
EINVAL
;

3279 *
v®
 = 
tok’64
;

3282 
	}
}

3290 
	$nvme_fc_·r£_Œaddr
(
nvm‘_fc_Œaddr
 *
Œaddr
, *
buf
, 
size_t
 
bËn
)

3292 
Çme
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
 + 1];

3293 
sub¡ršg_t
 
wwn
 = { 
Çme
, &name[(name)-1] };

3294 
Âoff£t
, 
²off£t
;

3297 ià(
	`¡ºËn
(
buf
, 
bËn
è=ğ
NVME_FC_TRADDR_MAXLENGTH
 &&

3298 !
	`¡ºcmp
(
buf
, "Â-0x", 
NVME_FC_TRADDR_OXNNLEN
) &&

3299 !
	`¡ºcmp
(&
buf
[
NVME_FC_TRADDR_MAX_PN_OFFSET
],

3300 "²-0x", 
NVME_FC_TRADDR_OXNNLEN
)) {

3301 
Âoff£t
 = 
NVME_FC_TRADDR_OXNNLEN
;

3302 
²off£t
 = 
NVME_FC_TRADDR_MAX_PN_OFFSET
 +

3303 
NVME_FC_TRADDR_OXNNLEN
;

3304 } ià((
	`¡ºËn
(
buf
, 
bËn
è=ğ
NVME_FC_TRADDR_MINLENGTH
 &&

3305 !
	`¡ºcmp
(
buf
, "Â-", 
NVME_FC_TRADDR_NNLEN
) &&

3306 !
	`¡ºcmp
(&
buf
[
NVME_FC_TRADDR_MIN_PN_OFFSET
],

3307 "²-", 
NVME_FC_TRADDR_NNLEN
))) {

3308 
Âoff£t
 = 
NVME_FC_TRADDR_NNLEN
;

3309 
²off£t
 = 
NVME_FC_TRADDR_MIN_PN_OFFSET
 + 
NVME_FC_TRADDR_NNLEN
;

3311 
out_ešv®
;

3313 
Çme
[0] = '0';

3314 
Çme
[1] = 'x';

3315 
Çme
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
] = 0;

3317 
	`memıy
(&
Çme
[2], &
buf
[
Âoff£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

3318 ià(
	`__nvme_fc_·r£_u64
(&
wwn
, &
Œaddr
->
Â
))

3319 
out_ešv®
;

3321 
	`memıy
(&
Çme
[2], &
buf
[
²off£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

3322 ià(
	`__nvme_fc_·r£_u64
(&
wwn
, &
Œaddr
->
²
))

3323 
out_ešv®
;

3327 
out_ešv®
:

3328 
	`´_w¬n
("%s: bad¿dd¸¡ršg\n", 
__func__
);

3329  -
EINVAL
;

3330 
	}
}

3332 
nvme_ù¾
 *

3333 
	$nvme_fc_ü—‹_ù¾
(
deviû
 *
dev
, 
nvmf_ù¾_İtiÚs
 *
İts
)

3335 
nvme_fc_ÍÜt
 *
ÍÜt
;

3336 
nvme_fc_½Üt
 *
½Üt
;

3337 
nvme_ù¾
 *
ù¾
;

3338 
nvm‘_fc_Œaddr
 
Ïddr
 = { 0L, 0L };

3339 
nvm‘_fc_Œaddr
 
¿ddr
 = { 0L, 0L };

3340 
æags
;

3341 
»t
;

3343 
»t
 = 
	`nvme_fc_·r£_Œaddr
(&
¿ddr
, 
İts
->
Œaddr
, 
NVMF_TRADDR_SIZE
);

3344 ià(
»t
 || !
¿ddr
.
Â
 || !¿ddr.
²
)

3345  
	`ERR_PTR
(-
EINVAL
);

3347 
»t
 = 
	`nvme_fc_·r£_Œaddr
(&
Ïddr
, 
İts
->
ho¡_Œaddr
, 
NVMF_TRADDR_SIZE
);

3348 ià(
»t
 || !
Ïddr
.
Â
 || !Ïddr.
²
)

3349  
	`ERR_PTR
(-
EINVAL
);

3352 
	`¥š_lock_œq§ve
(&
nvme_fc_lock
, 
æags
);

3353 
	`li¡_fÜ_—ch_’Œy
(
ÍÜt
, &
nvme_fc_ÍÜt_li¡
, 
pÜt_li¡
) {

3354 ià(
ÍÜt
->
loÿÍÜt
.
node_Çme
 !ğ
Ïddr
.
Â
 ||

3355 
ÍÜt
->
loÿÍÜt
.
pÜt_Çme
 !ğ
Ïddr
.
²
)

3358 
	`li¡_fÜ_—ch_’Œy
(
½Üt
, &
ÍÜt
->
’dp_li¡
,ƒndp_list) {

3359 ià(
½Üt
->
»mÙ•Üt
.
node_Çme
 !ğ
¿ddr
.
Â
 ||

3360 
½Üt
->
»mÙ•Üt
.
pÜt_Çme
 !ğ
¿ddr
.
²
)

3364 ià(!
	`nvme_fc_½Üt_g‘
(
½Üt
))

3367 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

3369 
ù¾
 = 
	`nvme_fc_š™_ù¾
(
dev
, 
İts
, 
ÍÜt
, 
½Üt
);

3370 ià(
	`IS_ERR
(
ù¾
))

3371 
	`nvme_fc_½Üt_put
(
½Üt
);

3372  
ù¾
;

3375 
	`¥š_uÆock_œq»¡Üe
(&
nvme_fc_lock
, 
æags
);

3377  
	`ERR_PTR
(-
ENOENT
);

3378 
	}
}

3381 
nvmf_Œª¥Üt_İs
 
	gnvme_fc_Œª¥Üt
 = {

3382 .
Çme
 = "fc",

3383 .
	gmoduË
 = 
THIS_MODULE
,

3384 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
 | 
NVMF_OPT_HOST_TRADDR
,

3385 .
	g®lowed_İts
 = 
NVMF_OPT_RECONNECT_DELAY
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

3386 .
	gü—‹_ù¾
 = 
nvme_fc_ü—‹_ù¾
,

3389 
__š™
 
	$nvme_fc_š™_moduË
()

3391 
»t
;

3407 
fc_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "fc");

3408 ià(
	`IS_ERR
(
fc_şass
)) {

3409 
	`´_”r
("couldn't„egister class fc\n");

3410  
	`PTR_ERR
(
fc_şass
);

3416 
fc_udev_deviû
 = 
	`deviû_ü—‹
(
fc_şass
, 
NULL
, 
	`MKDEV
(0, 0), NULL,

3418 ià(
	`IS_ERR
(
fc_udev_deviû
)) {

3419 
	`´_”r
("couldn't create fc_udev device!\n");

3420 
»t
 = 
	`PTR_ERR
(
fc_udev_deviû
);

3421 
out_de¡roy_şass
;

3424 
»t
 = 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

3425 ià(
»t
)

3426 
out_de¡roy_deviû
;

3430 
out_de¡roy_deviû
:

3431 
	`deviû_de¡roy
(
fc_şass
, 
	`MKDEV
(0, 0));

3432 
out_de¡roy_şass
:

3433 
	`şass_de¡roy
(
fc_şass
);

3434  
»t
;

3435 
	}
}

3437 
__ex™
 
	$nvme_fc_ex™_moduË
()

3440 ià(!
	`li¡_em±y
(&
nvme_fc_ÍÜt_li¡
))

3441 
	`´_w¬n
("%s:†oÿÍÜˆli¡‚Ùƒm±y\n", 
__func__
);

3443 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_fc_Œª¥Üt
);

3445 
	`ida_de¡roy
(&
nvme_fc_loÿl_pÜt_út
);

3446 
	`ida_de¡roy
(&
nvme_fc_ù¾_út
);

3448 
	`deviû_de¡roy
(
fc_şass
, 
	`MKDEV
(0, 0));

3449 
	`şass_de¡roy
(
fc_şass
);

3450 
	}
}

3452 
moduË_š™
(
nvme_fc_š™_moduË
);

3453 
moduË_ex™
(
nvme_fc_ex™_moduË
);

3455 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/lightnvm.c

23 
	~"nvme.h
"

25 
	~"lšux_nvme.h
"

26 
	~<lšux/b™İs.h
>

27 
	~<lšux/lighŠvm.h
>

28 
	~<lšux/vm®loc.h
>

29 
	~<lšux/sched/sysùl.h
>

30 
	~<u­i/lšux/lighŠvm.h
>

32 
	envme_nvm_admš_İcode
 {

33 
	mnvme_nvm_admš_id’t™y
 = 0xe2,

34 
	mnvme_nvm_admš_g‘_l2p_tbl
 = 0xea,

35 
	mnvme_nvm_admš_g‘_bb_tbl
 = 0xf2,

36 
	mnvme_nvm_admš_£t_bb_tbl
 = 0xf1,

39 
	snvme_nvm_hb_rw
 {

40 
__u8
 
	mİcode
;

41 
__u8
 
	mæags
;

42 
__u16
 
	mcommªd_id
;

43 
__Ë32
 
	mnsid
;

44 
__u64
 
	mrsvd2
;

45 
__Ë64
 
	mm‘ad©a
;

46 
__Ë64
 
	m´p1
;

47 
__Ë64
 
	m´p2
;

48 
__Ë64
 
	m¥ba
;

49 
__Ë16
 
	mËngth
;

50 
__Ë16
 
	mcÚŒŞ
;

51 
__Ë32
 
	mdsmgmt
;

52 
__Ë64
 
	m¦ba
;

55 
	snvme_nvm_ph_rw
 {

56 
__u8
 
	mİcode
;

57 
__u8
 
	mæags
;

58 
__u16
 
	mcommªd_id
;

59 
__Ë32
 
	mnsid
;

60 
__u64
 
	mrsvd2
;

61 
__Ë64
 
	mm‘ad©a
;

62 
__Ë64
 
	m´p1
;

63 
__Ë64
 
	m´p2
;

64 
__Ë64
 
	m¥ba
;

65 
__Ë16
 
	mËngth
;

66 
__Ë16
 
	mcÚŒŞ
;

67 
__Ë32
 
	mdsmgmt
;

68 
__Ë64
 
	m»sv
;

71 
	snvme_nvm_id’t™y
 {

72 
__u8
 
	mİcode
;

73 
__u8
 
	mæags
;

74 
__u16
 
	mcommªd_id
;

75 
__Ë32
 
	mnsid
;

76 
__u64
 
	mrsvd
[2];

77 
__Ë64
 
	m´p1
;

78 
__Ë64
 
	m´p2
;

79 
__Ë32
 
	mchÆ_off
;

80 
__u32
 
	mrsvd11
[5];

83 
	snvme_nvm_l2±bl
 {

84 
__u8
 
	mİcode
;

85 
__u8
 
	mæags
;

86 
__u16
 
	mcommªd_id
;

87 
__Ë32
 
	mnsid
;

88 
__Ë32
 
	mcdw2
[4];

89 
__Ë64
 
	m´p1
;

90 
__Ë64
 
	m´p2
;

91 
__Ë64
 
	m¦ba
;

92 
__Ë32
 
	mÆb
;

93 
__Ë16
 
	mcdw14
[6];

96 
	snvme_nvm_g‘bbtbl
 {

97 
__u8
 
	mİcode
;

98 
__u8
 
	mæags
;

99 
__u16
 
	mcommªd_id
;

100 
__Ë32
 
	mnsid
;

101 
__u64
 
	mrsvd
[2];

102 
__Ë64
 
	m´p1
;

103 
__Ë64
 
	m´p2
;

104 
__Ë64
 
	m¥ba
;

105 
__u32
 
	mrsvd4
[4];

108 
	snvme_nvm_£tbbtbl
 {

109 
__u8
 
	mİcode
;

110 
__u8
 
	mæags
;

111 
__u16
 
	mcommªd_id
;

112 
__Ë32
 
	mnsid
;

113 
__Ë64
 
	mrsvd
[2];

114 
__Ë64
 
	m´p1
;

115 
__Ë64
 
	m´p2
;

116 
__Ë64
 
	m¥ba
;

117 
__Ë16
 
	mÆb
;

118 
__u8
 
	mv®ue
;

119 
__u8
 
	mrsvd3
;

120 
__u32
 
	mrsvd4
[3];

123 
	snvme_nvm_”a£_blk
 {

124 
__u8
 
	mİcode
;

125 
__u8
 
	mæags
;

126 
__u16
 
	mcommªd_id
;

127 
__Ë32
 
	mnsid
;

128 
__u64
 
	mrsvd
[2];

129 
__Ë64
 
	m´p1
;

130 
__Ë64
 
	m´p2
;

131 
__Ë64
 
	m¥ba
;

132 
__Ë16
 
	mËngth
;

133 
__Ë16
 
	mcÚŒŞ
;

134 
__Ë32
 
	mdsmgmt
;

135 
__Ë64
 
	m»sv
;

138 
	snvme_nvm_commªd
 {

140 
nvme_commÚ_commªd
 
	mcommÚ
;

141 
nvme_nvm_id’t™y
 
	mid’t™y
;

142 
nvme_nvm_hb_rw
 
	mhb_rw
;

143 
nvme_nvm_ph_rw
 
	mph_rw
;

144 
nvme_nvm_l2±bl
 
	ml2p
;

145 
nvme_nvm_g‘bbtbl
 
	mg‘_bb
;

146 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

147 
nvme_nvm_”a£_blk
 
	m”a£
;

151 
	#NVME_NVM_LP_MLC_PAIRS
 886

	)

152 
	snvme_nvm_Í_mlc
 {

153 
__Ë16
 
	mnum_·œs
;

154 
__u8
 
	m·œs
[
NVME_NVM_LP_MLC_PAIRS
];

157 
	snvme_nvm_Í_tbl
 {

158 
__u8
 
	mid
[8];

159 
nvme_nvm_Í_mlc
 
	mmlc
;

162 
	snvme_nvm_id_group
 {

163 
__u8
 
	mmty³
;

164 
__u8
 
	mfmty³
;

165 
__Ë16
 
	m»s16
;

166 
__u8
 
	mnum_ch
;

167 
__u8
 
	mnum_lun
;

168 
__u8
 
	mnum_¶n
;

169 
__u8
 
	mrsvd1
;

170 
__Ë16
 
	mnum_blk
;

171 
__Ë16
 
	mnum_pg
;

172 
__Ë16
 
	måg_sz
;

173 
__Ë16
 
	mc£cs
;

174 
__Ë16
 
	msos
;

175 
__Ë16
 
	mrsvd2
;

176 
__Ë32
 
	mŒdt
;

177 
__Ë32
 
	mŒdm
;

178 
__Ë32
 
	m¹
;

179 
__Ë32
 
	mrm
;

180 
__Ë32
 
	mtb‘
;

181 
__Ë32
 
	mtbem
;

182 
__Ë32
 
	mmpos
;

183 
__Ë32
 
	mmcÿp
;

184 
__Ë16
 
	mı¬
;

185 
__u8
 
	m»£rved
[10];

186 
nvme_nvm_Í_tbl
 
	mÍtbl
;

187 } 
	g__·cked
;

189 
	snvme_nvm_addr_fÜm©
 {

190 
__u8
 
	mch_off£t
;

191 
__u8
 
	mch_Ën
;

192 
__u8
 
	mlun_off£t
;

193 
__u8
 
	mlun_Ën
;

194 
__u8
 
	m¶n_off£t
;

195 
__u8
 
	m¶n_Ën
;

196 
__u8
 
	mblk_off£t
;

197 
__u8
 
	mblk_Ën
;

198 
__u8
 
	mpg_off£t
;

199 
__u8
 
	mpg_Ën
;

200 
__u8
 
	m£ù_off£t
;

201 
__u8
 
	m£ù_Ën
;

202 
__u8
 
	m»s
[4];

203 } 
	g__·cked
;

205 
	snvme_nvm_id
 {

206 
__u8
 
	mv”_id
;

207 
__u8
 
	mvmÁ
;

208 
__u8
 
	mcg½s
;

209 
__u8
 
	m»s
;

210 
__Ë32
 
	mÿp
;

211 
__Ë32
 
	mdom
;

212 
nvme_nvm_addr_fÜm©
 
	mµaf
;

213 
__u8
 
	m»sv
[228];

214 
nvme_nvm_id_group
 
	mgroups
[4];

215 } 
	g__·cked
;

217 
	snvme_nvm_bb_tbl
 {

218 
__u8
 
	mtblid
[4];

219 
__Ë16
 
	mv”id
;

220 
__Ë16
 
	m»vid
;

221 
__Ë32
 
	mrvsd1
;

222 
__Ë32
 
	mtblks
;

223 
__Ë32
 
	mtçù
;

224 
__Ë32
 
	mtgrown
;

225 
__Ë32
 
	mtd»sv
;

226 
__Ë32
 
	mth»sv
;

227 
__Ë32
 
	mrsvd2
[8];

228 
__u8
 
	mblk
[0];

234 
šlše
 
	$_nvme_nvm_check_size
()

236 
	`BUILD_BUG_ON
((
nvme_nvm_id’t™y
) != 64);

237 
	`BUILD_BUG_ON
((
nvme_nvm_hb_rw
) != 64);

238 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

239 
	`BUILD_BUG_ON
((
nvme_nvm_g‘bbtbl
) != 64);

240 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

241 
	`BUILD_BUG_ON
((
nvme_nvm_l2±bl
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_nvm_”a£_blk
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_nvm_id_group
) != 960);

244 
	`BUILD_BUG_ON
((
nvme_nvm_addr_fÜm©
) != 16);

245 
	`BUILD_BUG_ON
((
nvme_nvm_id
è!ğ
NVME_IDENTIFY_DATA_SIZE
);

246 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 64);

247 
	}
}

249 
	$š™_g½s
(
nvm_id
 *nvm_id, 
nvme_nvm_id
 *nvme_nvm_id)

251 
nvme_nvm_id_group
 *
¤c
;

252 
nvm_id_group
 *
d¡
;

254 ià(
nvme_nvm_id
->
cg½s
 != 1)

255  -
EINVAL
;

257 
¤c
 = &
nvme_nvm_id
->
groups
[0];

258 
d¡
 = &
nvm_id
->
g½
;

260 
d¡
->
mty³
 = 
¤c
->mtype;

261 
d¡
->
fmty³
 = 
¤c
->fmtype;

262 
d¡
->
num_ch
 = 
¤c
->num_ch;

263 
d¡
->
num_lun
 = 
¤c
->num_lun;

264 
d¡
->
num_¶n
 = 
¤c
->num_pln;

266 
d¡
->
num_pg
 = 
	`Ë16_to_ıu
(
¤c
->num_pg);

267 
d¡
->
num_blk
 = 
	`Ë16_to_ıu
(
¤c
->num_blk);

268 
d¡
->
åg_sz
 = 
	`Ë16_to_ıu
(
¤c
->fpg_sz);

269 
d¡
->
c£cs
 = 
	`Ë16_to_ıu
(
¤c
->csecs);

270 
d¡
->
sos
 = 
	`Ë16_to_ıu
(
¤c
->sos);

272 
d¡
->
Œdt
 = 
	`Ë32_to_ıu
(
¤c
->trdt);

273 
d¡
->
Œdm
 = 
	`Ë32_to_ıu
(
¤c
->trdm);

274 
d¡
->
¹
 = 
	`Ë32_to_ıu
(
¤c
->tprt);

275 
d¡
->
rm
 = 
	`Ë32_to_ıu
(
¤c
->tprm);

276 
d¡
->
tb‘
 = 
	`Ë32_to_ıu
(
¤c
->tbet);

277 
d¡
->
tbem
 = 
	`Ë32_to_ıu
(
¤c
->tbem);

278 
d¡
->
mpos
 = 
	`Ë32_to_ıu
(
¤c
->mpos);

279 
d¡
->
mcÿp
 = 
	`Ë32_to_ıu
(
¤c
->mccap);

281 
d¡
->
ı¬
 = 
	`Ë16_to_ıu
(
¤c
->cpar);

283 ià(
d¡
->
fmty³
 =ğ
NVM_ID_FMTYPE_MLC
) {

284 
	`memıy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

285 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

286 
	`Ë16_to_ıu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

288 ià(
d¡
->
Ítbl
.
mlc
.
num_·œs
 > 
NVME_NVM_LP_MLC_PAIRS
) {

289 
	`´_”r
("nvm:‚umber of MLC…airs‚ot supported\n");

290  -
EINVAL
;

293 
	`memıy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

294 
d¡
->
Ítbl
.
mlc
.
num_·œs
);

298 
	}
}

300 
	$nvme_nvm_id’t™y
(
nvm_dev
 *
nvmdev
, 
nvm_id
 *nvm_id)

302 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

303 
nvme_nvm_id
 *nvme_nvm_id;

304 
nvme_nvm_commªd
 
c
 = {};

305 
»t
;

307 
c
.
id’t™y
.
İcode
 = 
nvme_nvm_admš_id’t™y
;

308 
c
.
id’t™y
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

309 
c
.
id’t™y
.
chÆ_off
 = 0;

311 
nvme_nvm_id
 = 
	`km®loc
((nvme_nvm_id), 
GFP_KERNEL
);

312 ià(!
nvme_nvm_id
)

313  -
ENOMEM
;

315 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

316 
nvme_nvm_id
, (nvme_nvm_id));

317 ià(
»t
) {

318 
»t
 = -
EIO
;

319 
out
;

322 
nvm_id
->
v”_id
 = 
nvme_nvm_id
->ver_id;

323 
nvm_id
->
vmÁ
 = 
nvme_nvm_id
->vmnt;

324 
nvm_id
->
ÿp
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->cap);

325 
nvm_id
->
dom
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->dom);

326 
	`memıy
(&
nvm_id
->
µaf
, &
nvme_nvm_id
->ppaf,

327 (
nvm_addr_fÜm©
));

329 
»t
 = 
	`š™_g½s
(
nvm_id
, 
nvme_nvm_id
);

330 
out
:

331 
	`kä“
(
nvme_nvm_id
);

332  
»t
;

333 
	}
}

335 
	$nvme_nvm_g‘_l2p_tbl
(
nvm_dev
 *
nvmdev
, 
u64
 
¦ba
, 
u32
 
Æb
,

336 
nvm_l2p_upd©e_â
 *
upd©e_l2p
, *
´iv
)

338 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

339 
nvme_nvm_commªd
 
c
 = {};

340 
u32
 
Ën
 = 
	`queue_max_hw_£ùÜs
(
ns
->
ù¾
->
admš_q
) << 9;

341 
u32
 
Æb_´_rq
 = 
Ën
 / (
u64
);

342 
u64
 
cmd_¦ba
 = 
¦ba
;

343 *
’Œ›s
;

344 
»t
 = 0;

346 
c
.
l2p
.
İcode
 = 
nvme_nvm_admš_g‘_l2p_tbl
;

347 
c
.
l2p
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

348 
’Œ›s
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

349 ià(!
’Œ›s
)

350  -
ENOMEM
;

352 
Æb
) {

353 
u32
 
cmd_Æb
 = 
	`mš
(
Æb_´_rq
, 
Æb
);

354 
u64
 
–ba
 = 
¦ba
 + 
cmd_Æb
;

356 
c
.
l2p
.
¦ba
 = 
	`ıu_to_Ë64
(
cmd_¦ba
);

357 
c
.
l2p
.
Æb
 = 
	`ıu_to_Ë32
(
cmd_Æb
);

359 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
,

360 (
nvme_commªd
 *)&
c
, 
’Œ›s
, 
Ën
);

361 ià(
»t
) {

362 
	`dev_”r
(
ns
->
ù¾
->
deviû
,

363 "L2PabË¿nsã¸çed (%d)\n", 
»t
);

364 
»t
 = -
EIO
;

365 
out
;

368 ià(
	`uÆik–y
(
–ba
 > 
nvmdev
->
tÙ®_£cs
)) {

369 
	`´_”r
("nvm: L2P data from device is out of bounds!\n");

370 
»t
 = -
EINVAL
;

371 
out
;

375 
	`nvm_·¹_to_tgt
(
nvmdev
, 
’Œ›s
, 
cmd_Æb
);

377 ià(
	`upd©e_l2p
(
cmd_¦ba
, 
cmd_Æb
, 
’Œ›s
, 
´iv
)) {

378 
»t
 = -
EINTR
;

379 
out
;

382 
cmd_¦ba
 +ğ
cmd_Æb
;

383 
Æb
 -ğ
cmd_Æb
;

386 
out
:

387 
	`kä“
(
’Œ›s
);

388  
»t
;

389 
	}
}

391 
	$nvme_nvm_g‘_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

392 
u8
 *
blks
)

394 
»que¡_queue
 *
q
 = 
nvmdev
->q;

395 
nvm_geo
 *
geo
 = &
nvmdev
->geo;

396 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

397 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

398 
nvme_nvm_commªd
 
c
 = {};

399 
nvme_nvm_bb_tbl
 *
bb_tbl
;

400 
Ä_blks
 = 
geo
->
blks_³r_lun
 * geo->
¶ªe_mode
;

401 
tblsz
 = (
nvme_nvm_bb_tbl
è+ 
Ä_blks
;

402 
»t
 = 0;

404 
c
.
g‘_bb
.
İcode
 = 
nvme_nvm_admš_g‘_bb_tbl
;

405 
c
.
g‘_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

406 
c
.
g‘_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µa
.ppa);

408 
bb_tbl
 = 
	`kz®loc
(
tblsz
, 
GFP_KERNEL
);

409 ià(!
bb_tbl
)

410  -
ENOMEM
;

412 
»t
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

413 
bb_tbl
, 
tblsz
);

414 ià(
»t
) {

415 
	`dev_”r
(
ù¾
->
deviû
, "g‘ bad blockabË faed (%d)\n", 
»t
);

416 
»t
 = -
EIO
;

417 
out
;

420 ià(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

421 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

422 
	`dev_”r
(
ù¾
->
deviû
, "bbt format mismatch\n");

423 
»t
 = -
EINVAL
;

424 
out
;

427 ià(
	`Ë16_to_ıu
(
bb_tbl
->
v”id
) != 1) {

428 
»t
 = -
EINVAL
;

429 
	`dev_”r
(
ù¾
->
deviû
, "bbt version‚ot supported\n");

430 
out
;

433 ià(
	`Ë32_to_ıu
(
bb_tbl
->
tblks
è!ğ
Ä_blks
) {

434 
»t
 = -
EINVAL
;

435 
	`dev_”r
(
ù¾
->
deviû
,

437 
	`Ë32_to_ıu
(
bb_tbl
->
tblks
), 
Ä_blks
);

438 
out
;

441 
	`memıy
(
blks
, 
bb_tbl
->
blk
, 
geo
->
blks_³r_lun
 * geo->
¶ªe_mode
);

442 
out
:

443 
	`kä“
(
bb_tbl
);

444  
»t
;

445 
	}
}

447 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 *
µas
,

448 
Ä_µas
, 
ty³
)

450 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

451 
nvme_nvm_commªd
 
c
 = {};

452 
»t
 = 0;

454 
c
.
£t_bb
.
İcode
 = 
nvme_nvm_admš_£t_bb_tbl
;

455 
c
.
£t_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

456 
c
.
£t_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µas
->
µa
);

457 
c
.
£t_bb
.
Æb
 = 
	`ıu_to_Ë16
(
Ä_µas
 - 1);

458 
c
.
£t_bb
.
v®ue
 = 
ty³
;

460 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

461 
NULL
, 0);

462 ià(
»t
)

463 
	`dev_”r
(
ns
->
ù¾
->
deviû
, "set bad blockable failed (%d)\n",

464 
»t
);

465  
»t
;

466 
	}
}

468 
šlše
 
	$nvme_nvm_rqtocmd
(
nvm_rq
 *
rqd
, 
nvme_ns
 *
ns
,

469 
nvme_nvm_commªd
 *
c
)

471 
c
->
ph_rw
.
İcode
 = 
rqd
->opcode;

472 
c
->
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

473 
c
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

474 
c
->
ph_rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
rqd
->
dma_m‘a_li¡
);

475 
c
->
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
rqd
->
æags
);

476 
c
->
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_µas
 - 1);

478 ià(
rqd
->
İcode
 =ğ
NVM_OP_HBWRITE
 ||„qd->İcod=ğ
NVM_OP_HBREAD
)

479 
c
->
hb_rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
,

480 
rqd
->
bio
->
bi_™”
.
bi_£ùÜ
));

481 
	}
}

483 
	$nvme_nvm_’d_io
(
»que¡
 *
rq
, 
blk_¡©us_t
 
¡©us
)

485 
nvm_rq
 *
rqd
 = 
rq
->
’d_io_d©a
;

487 
rqd
->
µa_¡©us
 = 
	`Ë64_to_ıu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

488 
rqd
->
”rÜ
 = 
	`nvme_»q
(
rq
)->
¡©us
;

489 
	`nvm_’d_io
(
rqd
);

491 
	`kä“
(
	`nvme_»q
(
rq
)->
cmd
);

492 
	`blk_mq_ä“_»que¡
(
rq
);

493 
	}
}

495 
»que¡
 *
	$nvme_nvm_®loc_»que¡
(
»que¡_queue
 *
q
,

496 
nvm_rq
 *
rqd
,

497 
nvme_nvm_commªd
 *
cmd
)

499 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

500 
»que¡
 *
rq
;

502 
	`nvme_nvm_rqtocmd
(
rqd
, 
ns
, 
cmd
);

504 
rq
 = 
	`nvme_®loc_»que¡
(
q
, (
nvme_commªd
 *)
cmd
, 0, 
NVME_QID_ANY
);

505 ià(
	`IS_ERR
(
rq
))

506  
rq
;

508 
rq
->
cmd_æags
 &ğ~
REQ_FAILFAST_DRIVER
;

510 ià(
rqd
->
bio
) {

511 
	`blk_š™_»que¡_äom_bio
(
rq
, 
rqd
->
bio
);

513 
rq
->
iİrio
 = 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
IOPRIO_NORM
);

514 
rq
->
__d©a_Ën
 = 0;

517  
rq
;

518 
	}
}

520 
	$nvme_nvm_subm™_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

522 
»que¡_queue
 *
q
 = 
dev
->q;

523 
nvme_nvm_commªd
 *
cmd
;

524 
»que¡
 *
rq
;

526 
cmd
 = 
	`kz®loc
((
nvme_nvm_commªd
), 
GFP_KERNEL
);

527 ià(!
cmd
)

528  -
ENOMEM
;

530 
rq
 = 
	`nvme_nvm_®loc_»que¡
(
q
, 
rqd
, 
cmd
);

531 ià(
	`IS_ERR
(
rq
)) {

532 
	`kä“
(
cmd
);

533  
	`PTR_ERR
(
rq
);

536 
rq
->
’d_io_d©a
 = 
rqd
;

538 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_’d_io
);

541 
	}
}

543 
	$nvme_nvm_subm™_io_sync
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

545 
»que¡_queue
 *
q
 = 
dev
->q;

546 
»que¡
 *
rq
;

547 
nvme_nvm_commªd
 
cmd
;

548 
»t
 = 0;

550 
	`mem£t
(&
cmd
, 0, (
nvme_nvm_commªd
));

552 
rq
 = 
	`nvme_nvm_®loc_»que¡
(
q
, 
rqd
, &
cmd
);

553 ià(
	`IS_ERR
(
rq
))

554  
	`PTR_ERR
(
rq
);

559 
	`blk_execu‹_rq
(
q
, 
NULL
, 
rq
, 0);

560 ià(
	`nvme_»q
(
rq
)->
æags
 & 
NVME_REQ_CANCELLED
)

561 
»t
 = -
EINTR
;

563 
rqd
->
µa_¡©us
 = 
	`Ë64_to_ıu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

564 
rqd
->
”rÜ
 = 
	`nvme_»q
(
rq
)->
¡©us
;

566 
	`blk_mq_ä“_»que¡
(
rq
);

568  
»t
;

569 
	}
}

571 *
	$nvme_nvm_ü—‹_dma_poŞ
(
nvm_dev
 *
nvmdev
, *
Çme
)

573 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

575  
	`dma_poŞ_ü—‹
(
Çme
, 
ns
->
ù¾
->
dev
, 
PAGE_SIZE
, PAGE_SIZE, 0);

576 
	}
}

578 
	$nvme_nvm_de¡roy_dma_poŞ
(*
poŞ
)

580 
dma_poŞ
 *dma_poŞ = 
poŞ
;

582 
	`dma_poŞ_de¡roy
(
dma_poŞ
);

583 
	}
}

585 *
	$nvme_nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, *
poŞ
,

586 
gå_t
 
mem_æags
, 
dma_addr_t
 *
dma_hªdËr
)

588  
	`dma_poŞ_®loc
(
poŞ
, 
mem_æags
, 
dma_hªdËr
);

589 
	}
}

591 
	$nvme_nvm_dev_dma_ä“
(*
poŞ
, *
addr
,

592 
dma_addr_t
 
dma_hªdËr
)

594 
	`dma_poŞ_ä“
(
poŞ
, 
addr
, 
dma_hªdËr
);

595 
	}
}

597 
nvm_dev_İs
 
	gnvme_nvm_dev_İs
 = {

598 .
id’t™y
 = 
nvme_nvm_id’t™y
,

600 .
	gg‘_l2p_tbl
 = 
nvme_nvm_g‘_l2p_tbl
,

602 .
	gg‘_bb_tbl
 = 
nvme_nvm_g‘_bb_tbl
,

603 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

605 .
	gsubm™_io
 = 
nvme_nvm_subm™_io
,

606 .
	gsubm™_io_sync
 = 
nvme_nvm_subm™_io_sync
,

608 .
	gü—‹_dma_poŞ
 = 
nvme_nvm_ü—‹_dma_poŞ
,

609 .
	gde¡roy_dma_poŞ
 = 
nvme_nvm_de¡roy_dma_poŞ
,

610 .
	gdev_dma_®loc
 = 
nvme_nvm_dev_dma_®loc
,

611 .
	gdev_dma_ä“
 = 
nvme_nvm_dev_dma_ä“
,

613 .
	gmax_phys_£ù
 = 64,

616 
	$nvme_nvm_subm™_u£r_cmd
(
»que¡_queue
 *
q
,

617 
nvme_ns
 *
ns
,

618 
nvme_nvm_commªd
 *
vcmd
,

619 
__u£r
 *
ubuf
, 
bufæ’
,

620 
__u£r
 *
m‘a_buf
, 
m‘a_Ën
,

621 
__u£r
 *
µa_buf
, 
µa_Ën
,

622 
u32
 *
»suÉ
, 
u64
 *
¡©us
, 
timeout
)

624 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
((
nvme_commªd
 *)
vcmd
);

625 
nvm_dev
 *
dev
 = 
ns
->
ndev
;

626 
g’disk
 *
disk
 = 
ns
->disk;

627 
»que¡
 *
rq
;

628 
bio
 *biØğ
NULL
;

629 
__Ë64
 *
µa_li¡
 = 
NULL
;

630 
dma_addr_t
 
µa_dma
;

631 
__Ë64
 *
m‘ad©a
 = 
NULL
;

632 
dma_addr_t
 
m‘ad©a_dma
;

633 
	`DECLARE_COMPLETION_ONSTACK
(
wa™
);

634 
»t
 = 0;

636 
rq
 = 
	`nvme_®loc_»que¡
(
q
, (
nvme_commªd
 *)
vcmd
, 0,

637 
NVME_QID_ANY
);

638 ià(
	`IS_ERR
(
rq
)) {

639 
»t
 = -
ENOMEM
;

640 
”r_cmd
;

643 
rq
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

645 ià(
µa_buf
 && 
µa_Ën
) {

646 
µa_li¡
 = 
	`dma_poŞ_®loc
(
dev
->
dma_poŞ
, 
GFP_KERNEL
, &
µa_dma
);

647 ià(!
µa_li¡
) {

648 
»t
 = -
ENOMEM
;

649 
”r_rq
;

651 ià(
	`cİy_äom_u£r
(
µa_li¡
, (
__u£r
 *)
µa_buf
,

652 (
u64
è* (
µa_Ën
 + 1))) {

653 
»t
 = -
EFAULT
;

654 
”r_µa
;

656 
vcmd
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
µa_dma
);

658 
vcmd
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
((
ušŒ_t
)
µa_buf
);

661 ià(
ubuf
 && 
bufæ’
) {

662 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
rq
, 
NULL
, 
ubuf
, 
bufæ’
, 
GFP_KERNEL
);

663 ià(
»t
)

664 
”r_µa
;

665 
bio
 = 
rq
->bio;

667 ià(
m‘a_buf
 && 
m‘a_Ën
) {

668 
m‘ad©a
 = 
	`dma_poŞ_®loc
(
dev
->
dma_poŞ
, 
GFP_KERNEL
,

669 &
m‘ad©a_dma
);

670 ià(!
m‘ad©a
) {

671 
»t
 = -
ENOMEM
;

672 
”r_m­
;

675 ià(
wr™e
) {

676 ià(
	`cİy_äom_u£r
(
m‘ad©a
,

677 (
__u£r
 *)
m‘a_buf
,

678 
m‘a_Ën
)) {

679 
»t
 = -
EFAULT
;

680 
”r_m‘a
;

683 
vcmd
->
ph_rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
m‘ad©a_dma
);

686 
bio
->
bi_disk
 = 
disk
;

689 
	`blk_execu‹_rq
(
q
, 
NULL
, 
rq
, 0);

691 ià(
	`nvme_»q
(
rq
)->
æags
 & 
NVME_REQ_CANCELLED
)

692 
»t
 = -
EINTR
;

693 ià(
	`nvme_»q
(
rq
)->
¡©us
 & 0x7ff)

694 
»t
 = -
EIO
;

695 ià(
»suÉ
)

696 *
»suÉ
 = 
	`nvme_»q
(
rq
)->
¡©us
 & 0x7ff;

697 ià(
¡©us
)

698 *
¡©us
 = 
	`Ë64_to_ıu
(
	`nvme_»q
(
rq
)->
»suÉ
.
u64
);

700 ià(
m‘ad©a
 && !
»t
 && !
wr™e
) {

701 ià(
	`cİy_to_u£r
(
m‘a_buf
, (*)
m‘ad©a
, 
m‘a_Ën
))

702 
»t
 = -
EFAULT
;

704 
”r_m‘a
:

705 ià(
m‘a_buf
 && 
m‘a_Ën
)

706 
	`dma_poŞ_ä“
(
dev
->
dma_poŞ
, 
m‘ad©a
, 
m‘ad©a_dma
);

707 
”r_m­
:

708 ià(
bio
)

709 
	`blk_rq_unm­_u£r
(
bio
);

710 
”r_µa
:

711 ià(
µa_buf
 && 
µa_Ën
)

712 
	`dma_poŞ_ä“
(
dev
->
dma_poŞ
, 
µa_li¡
, 
µa_dma
);

713 
”r_rq
:

714 
	`blk_mq_ä“_»que¡
(
rq
);

715 
”r_cmd
:

716  
»t
;

717 
	}
}

719 
	$nvme_nvm_subm™_vio
(
nvme_ns
 *
ns
,

720 
nvm_u£r_vio
 
__u£r
 *
uvio
)

722 
nvm_u£r_vio
 
vio
;

723 
nvme_nvm_commªd
 
c
;

724 
Ëngth
;

725 
»t
;

727 ià(
	`cİy_äom_u£r
(&
vio
, 
uvio
, (vio)))

728  -
EFAULT
;

729 ià(
vio
.
æags
)

730  -
EINVAL
;

732 
	`mem£t
(&
c
, 0, (c));

733 
c
.
ph_rw
.
İcode
 = 
vio
.opcode;

734 
c
.
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

735 
c
.
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
vio
.control);

736 
c
.
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
vio
.
Å·s
);

738 
Ëngth
 = (
vio
.
Å·s
 + 1è<< 
ns
->
lba_shiá
;

740 
»t
 = 
	`nvme_nvm_subm™_u£r_cmd
(
ns
->
queue
,‚s, &
c
,

741 (
__u£r
 *)(
ušŒ_t
)
vio
.
addr
, 
Ëngth
,

742 (
__u£r
 *)(
ušŒ_t
)
vio
.
m‘ad©a
,

743 
vio
.
m‘ad©a_Ën
,

744 (
__u£r
 *)(
ušŒ_t
)
vio
.
µa_li¡
, vio.
Å·s
,

745 &
vio
.
»suÉ
, &vio.
¡©us
, 0);

747 ià(
»t
 && 
	`cİy_to_u£r
(
uvio
, &
vio
, (vio)))

748  -
EFAULT
;

750  
»t
;

751 
	}
}

753 
	$nvme_nvm_u£r_vcmd
(
nvme_ns
 *
ns
, 
admš
,

754 
nvm_·s¡hru_vio
 
__u£r
 *
uvcmd
)

756 
nvm_·s¡hru_vio
 
vcmd
;

757 
nvme_nvm_commªd
 
c
;

758 
»que¡_queue
 *
q
;

759 
timeout
 = 0;

760 
»t
;

762 ià(
	`cİy_äom_u£r
(&
vcmd
, 
uvcmd
, (vcmd)))

763  -
EFAULT
;

764 ià((
vcmd
.
İcode
 !ğ0xF2è&& (!
	`ÿ·bË
(
CAP_SYS_ADMIN
)))

765  -
EACCES
;

766 ià(
vcmd
.
æags
)

767  -
EINVAL
;

769 
	`mem£t
(&
c
, 0, (c));

770 
c
.
commÚ
.
İcode
 = 
vcmd
.opcode;

771 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
h—d
->
ns_id
);

772 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
vcmd
.cdw2);

773 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
vcmd
.
cdw3
);

775 
c
.
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
vcmd
.
Å·s
);

776 
c
.
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
vcmd
.control);

777 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
vcmd
.
cdw13
);

778 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
vcmd
.
cdw14
);

779 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
vcmd
.
cdw15
);

781 ià(
vcmd
.
timeout_ms
)

782 
timeout
 = 
	`m£cs_to_jiff›s
(
vcmd
.
timeout_ms
);

784 
q
 = 
admš
 ? 
ns
->
ù¾
->
admš_q
 :‚s->
queue
;

786 
»t
 = 
	`nvme_nvm_subm™_u£r_cmd
(
q
, 
ns
,

787 (
nvme_nvm_commªd
 *)&
c
,

788 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
addr
, vcmd.
d©a_Ën
,

789 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
m‘ad©a
,

790 
vcmd
.
m‘ad©a_Ën
,

791 (
__u£r
 *)(
ušŒ_t
)
vcmd
.
µa_li¡
, vcmd.
Å·s
,

792 &
vcmd
.
»suÉ
, &vcmd.
¡©us
, 
timeout
);

794 ià(
»t
 && 
	`cİy_to_u£r
(
uvcmd
, &
vcmd
, (vcmd)))

795  -
EFAULT
;

797  
»t
;

798 
	}
}

800 
	$nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
)

802 
cmd
) {

803 
NVME_NVM_IOCTL_ADMIN_VIO
:

804  
	`nvme_nvm_u£r_vcmd
(
ns
, 1, (
__u£r
 *)
¬g
);

805 
NVME_NVM_IOCTL_IO_VIO
:

806  
	`nvme_nvm_u£r_vcmd
(
ns
, 0, (
__u£r
 *)
¬g
);

807 
NVME_NVM_IOCTL_SUBMIT_VIO
:

808  
	`nvme_nvm_subm™_vio
(
ns
, (
__u£r
 *)
¬g
);

810  -
ENOTTY
;

812 
	}
}

814 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
)

816 
»que¡_queue
 *
q
 = 
ns
->
queue
;

817 
nvm_dev
 *
dev
;

819 
	`_nvme_nvm_check_size
();

821 
dev
 = 
	`nvm_®loc_dev
(
node
);

822 ià(!
dev
)

823  -
ENOMEM
;

825 
dev
->
q
 = q;

826 
	`memıy
(
dev
->
Çme
, 
disk_Çme
, 
DISK_NAME_LEN
);

827 
dev
->
İs
 = &
nvme_nvm_dev_İs
;

828 
dev
->
´iv©e_d©a
 = 
ns
;

829 
ns
->
ndev
 = 
dev
;

831  
	`nvm_»gi¡”
(
dev
);

832 
	}
}

834 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
)

836 
	`nvm_uÄegi¡”
(
ns
->
ndev
);

837 
	}
}

839 
ssize_t
 
	$nvm_dev_©Œ_show
(
deviû
 *
dev
,

840 
deviû_©Œibu‹
 *
d©Œ
, *
·ge
)

842 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

843 
nvm_dev
 *
ndev
 = 
ns
->ndev;

844 
nvm_id
 *
id
;

845 
nvm_id_group
 *
g½
;

846 
©Œibu‹
 *
©Œ
;

848 ià(!
ndev
)

851 
id
 = &
ndev
->
id’t™y
;

852 
g½
 = &
id
->grp;

853 
©Œ
 = &
d©Œ
->attr;

855 ià(
	`¡rcmp
(
©Œ
->
Çme
, "version") == 0) {

856  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
v”_id
);

857 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "vendor_opcode") == 0) {

858  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
vmÁ
);

859 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "capabilities") == 0) {

860  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
ÿp
);

861 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "device_mode") == 0) {

862  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
id
->
dom
);

864 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_manager") == 0) {

865  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%s\n", "gennvm");

866 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "ppa_format") == 0) {

867  
	`sú´štf
(
·ge
, 
PAGE_SIZE
,

869 
id
->
µaf
.
ch_off£t
, id->µaf.
ch_Ën
,

870 
id
->
µaf
.
lun_off£t
, id->µaf.
lun_Ën
,

871 
id
->
µaf
.
¶n_off£t
, id->µaf.
¶n_Ën
,

872 
id
->
µaf
.
blk_off£t
, id->µaf.
blk_Ën
,

873 
id
->
µaf
.
pg_off£t
, id->µaf.
pg_Ën
,

874 
id
->
µaf
.
£ù_off£t
, id->µaf.
£ù_Ën
);

875 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_type") == 0) {

876  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
mty³
);

877 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "flash_media_type") == 0) {

878  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
fmty³
);

879 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_channels") == 0) {

880  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_ch
);

881 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_luns") == 0) {

882  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_lun
);

883 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_planes") == 0) {

884  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_¶n
);

885 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_blocks") == 0) {

886  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_blk
);

887 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "num_pages") == 0) {

888  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
num_pg
);

889 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "page_size") == 0) {

890  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
åg_sz
);

891 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "hw_sector_size") == 0) {

892  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
c£cs
);

893 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "oob_sector_size") == 0) {

894  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
sos
);

895 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "read_typ") == 0) {

896  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
Œdt
);

897 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "read_max") == 0) {

898  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
Œdm
);

899 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "prog_typ") == 0) {

900  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
¹
);

901 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "prog_max") == 0) {

902  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
rm
);

903 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "erase_typ") == 0) {

904  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
tb‘
);

905 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "erase_max") == 0) {

906  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n", 
g½
->
tbem
);

907 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "multiplane_modes") == 0) {

908  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "0x%08x\n", 
g½
->
mpos
);

909 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "media_capabilities") == 0) {

910  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "0x%08x\n", 
g½
->
mcÿp
);

911 } ià(
	`¡rcmp
(
©Œ
->
Çme
, "max_phys_secs") == 0) {

912  
	`sú´štf
(
·ge
, 
PAGE_SIZE
, "%u\n",

913 
ndev
->
İs
->
max_phys_£ù
);

915  
	`sú´štf
(
·ge
,

916 
PAGE_SIZE
,

918 
©Œ
->
Çme
);

920 
	}
}

922 
	#NVM_DEV_ATTR_RO
(
_Çme
) \

923 
	`DEVICE_ATTR
(
_Çme
, 
S_IRUGO
, 
nvm_dev_©Œ_show
, 
NULL
)

	)

925 
NVM_DEV_ATTR_RO
(
v”siÚ
);

926 
NVM_DEV_ATTR_RO
(
v’dÜ_İcode
);

927 
NVM_DEV_ATTR_RO
(
ÿ·b™›s
);

928 
NVM_DEV_ATTR_RO
(
deviû_mode
);

929 
NVM_DEV_ATTR_RO
(
µa_fÜm©
);

930 
NVM_DEV_ATTR_RO
(
medŸ_mªag”
);

932 
NVM_DEV_ATTR_RO
(
medŸ_ty³
);

933 
NVM_DEV_ATTR_RO
(
æash_medŸ_ty³
);

934 
NVM_DEV_ATTR_RO
(
num_chªÃls
);

935 
NVM_DEV_ATTR_RO
(
num_luns
);

936 
NVM_DEV_ATTR_RO
(
num_¶ªes
);

937 
NVM_DEV_ATTR_RO
(
num_blocks
);

938 
NVM_DEV_ATTR_RO
(
num_·ges
);

939 
NVM_DEV_ATTR_RO
(
·ge_size
);

940 
NVM_DEV_ATTR_RO
(
hw_£ùÜ_size
);

941 
NVM_DEV_ATTR_RO
(
oob_£ùÜ_size
);

942 
NVM_DEV_ATTR_RO
(
»ad_typ
);

943 
NVM_DEV_ATTR_RO
(
»ad_max
);

944 
NVM_DEV_ATTR_RO
(
´og_typ
);

945 
NVM_DEV_ATTR_RO
(
´og_max
);

946 
NVM_DEV_ATTR_RO
(
”a£_typ
);

947 
NVM_DEV_ATTR_RO
(
”a£_max
);

948 
NVM_DEV_ATTR_RO
(
muÉÏÃ_modes
);

949 
NVM_DEV_ATTR_RO
(
medŸ_ÿ·b™›s
);

950 
NVM_DEV_ATTR_RO
(
max_phys_£cs
);

952 
©Œibu‹
 *
	gnvm_dev_©Œs
[] = {

953 &
dev_©Œ_v”siÚ
.
©Œ
,

954 &
dev_©Œ_v’dÜ_İcode
.
©Œ
,

955 &
dev_©Œ_ÿ·b™›s
.
©Œ
,

956 &
dev_©Œ_deviû_mode
.
©Œ
,

957 &
dev_©Œ_medŸ_mªag”
.
©Œ
,

959 &
dev_©Œ_µa_fÜm©
.
©Œ
,

960 &
dev_©Œ_medŸ_ty³
.
©Œ
,

961 &
dev_©Œ_æash_medŸ_ty³
.
©Œ
,

962 &
dev_©Œ_num_chªÃls
.
©Œ
,

963 &
dev_©Œ_num_luns
.
©Œ
,

964 &
dev_©Œ_num_¶ªes
.
©Œ
,

965 &
dev_©Œ_num_blocks
.
©Œ
,

966 &
dev_©Œ_num_·ges
.
©Œ
,

967 &
dev_©Œ_·ge_size
.
©Œ
,

968 &
dev_©Œ_hw_£ùÜ_size
.
©Œ
,

969 &
dev_©Œ_oob_£ùÜ_size
.
©Œ
,

970 &
dev_©Œ_»ad_typ
.
©Œ
,

971 &
dev_©Œ_»ad_max
.
©Œ
,

972 &
dev_©Œ_´og_typ
.
©Œ
,

973 &
dev_©Œ_´og_max
.
©Œ
,

974 &
dev_©Œ_”a£_typ
.
©Œ
,

975 &
dev_©Œ_”a£_max
.
©Œ
,

976 &
dev_©Œ_muÉÏÃ_modes
.
©Œ
,

977 &
dev_©Œ_medŸ_ÿ·b™›s
.
©Œ
,

978 &
dev_©Œ_max_phys_£cs
.
©Œ
,

979 
NULL
,

982 cÚ¡ 
©Œibu‹_group
 
	gnvm_dev_©Œ_group
 = {

983 .
Çme
 = "lightnvm",

984 .
	g©Œs
 = 
nvm_dev_©Œs
,

987 
	$nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
)

989  
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

990 &
nvm_dev_©Œ_group
);

991 
	}
}

993 
	$nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
)

995 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

996 &
nvm_dev_©Œ_group
);

997 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/linux_nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/uuid.h
>

22 
	#NVMF_NQN_FIELD_LEN
 256

	)

25 
	#NVMF_NQN_SIZE
 223

	)

27 
	#NVMF_TRSVCID_SIZE
 32

	)

28 
	#NVMF_TRADDR_SIZE
 256

	)

29 
	#NVMF_TSAS_SIZE
 256

	)

31 
	#NVME_DISC_SUBSYS_NAME
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

33 
	#NVME_RDMA_IP_PORT
 4420

	)

35 
	#NVME_NSID_ALL
 0xffffffff

	)

37 
	envme_subsys_ty³
 {

38 
	mNVME_NQN_DISC
 = 1,

39 
	mNVME_NQN_NVME
 = 2,

44 
	mNVMF_ADDR_FAMILY_PCI
 = 0,

45 
	mNVMF_ADDR_FAMILY_IP4
 = 1,

46 
	mNVMF_ADDR_FAMILY_IP6
 = 2,

47 
	mNVMF_ADDR_FAMILY_IB
 = 3,

48 
	mNVMF_ADDR_FAMILY_FC
 = 4,

53 
	mNVMF_TRTYPE_RDMA
 = 1,

54 
	mNVMF_TRTYPE_FC
 = 2,

55 
	mNVMF_TRTYPE_LOOP
 = 254,

56 
	mNVMF_TRTYPE_MAX
,

61 
	mNVMF_TREQ_NOT_SPECIFIED
 = 0,

62 
	mNVMF_TREQ_REQUIRED
 = 1,

63 
	mNVMF_TREQ_NOT_REQUIRED
 = 2,

70 
	mNVMF_RDMA_QPTYPE_CONNECTED
 = 1,

71 
	mNVMF_RDMA_QPTYPE_DATAGRAM
 = 2,

78 
	mNVMF_RDMA_PRTYPE_NOT_SPECIFIED
 = 1,

79 
	mNVMF_RDMA_PRTYPE_IB
 = 2,

80 
	mNVMF_RDMA_PRTYPE_ROCE
 = 3,

81 
	mNVMF_RDMA_PRTYPE_ROCEV2
 = 4,

82 
	mNVMF_RDMA_PRTYPE_IWARP
 = 5,

89 
	mNVMF_RDMA_CMS_RDMA_CM
 = 1,

92 
	#NVME_AQ_DEPTH
 32

	)

93 
	#NVME_NR_AEN_COMMANDS
 1

	)

94 
	#NVME_AQ_BLK_MQ_DEPTH
 (
NVME_AQ_DEPTH
 - 
NVME_NR_AEN_COMMANDS
)

	)

100 
	#NVME_AQ_MQ_TAG_DEPTH
 (
NVME_AQ_BLK_MQ_DEPTH
 - 1)

	)

103 
	mNVME_REG_CAP
 = 0x0000,

104 
	mNVME_REG_VS
 = 0x0008,

105 
	mNVME_REG_INTMS
 = 0x000c,

106 
	mNVME_REG_INTMC
 = 0x0010,

107 
	mNVME_REG_CC
 = 0x0014,

108 
	mNVME_REG_CSTS
 = 0x001c,

109 
	mNVME_REG_NSSR
 = 0x0020,

110 
	mNVME_REG_AQA
 = 0x0024,

111 
	mNVME_REG_ASQ
 = 0x0028,

112 
	mNVME_REG_ACQ
 = 0x0030,

113 
	mNVME_REG_CMBLOC
 = 0x0038,

114 
	mNVME_REG_CMBSZ
 = 0x003c,

115 
	mNVME_REG_DBS
 = 0x1000,

118 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

119 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

120 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

121 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

122 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

123 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

125 
	#NVME_CMB_BIR
(
cmbloc
è((cmblocè& 0x7)

	)

126 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

127 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

128 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

130 
	#NVME_CMB_WDS
(
cmbsz
è((cmbszè& 0x10)

	)

131 
	#NVME_CMB_RDS
(
cmbsz
è((cmbszè& 0x8)

	)

132 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbszè& 0x4)

	)

133 
	#NVME_CMB_CQS
(
cmbsz
è((cmbszè& 0x2)

	)

134 
	#NVME_CMB_SQS
(
cmbsz
è((cmbszè& 0x1)

	)

140 
	#NVME_NVM_IOSQES
 6

	)

141 
	#NVME_NVM_IOCQES
 4

	)

144 
	mNVME_CC_ENABLE
 = 1 << 0,

145 
	mNVME_CC_CSS_NVM
 = 0 << 4,

146 
	mNVME_CC_EN_SHIFT
 = 0,

147 
	mNVME_CC_CSS_SHIFT
 = 4,

148 
	mNVME_CC_MPS_SHIFT
 = 7,

149 
	mNVME_CC_AMS_SHIFT
 = 11,

150 
	mNVME_CC_SHN_SHIFT
 = 14,

151 
	mNVME_CC_IOSQES_SHIFT
 = 16,

152 
	mNVME_CC_IOCQES_SHIFT
 = 20,

153 
	mNVME_CC_AMS_RR
 = 0 << 
NVME_CC_AMS_SHIFT
,

154 
	mNVME_CC_AMS_WRRU
 = 1 << 
NVME_CC_AMS_SHIFT
,

155 
	mNVME_CC_AMS_VS
 = 7 << 
NVME_CC_AMS_SHIFT
,

156 
	mNVME_CC_SHN_NONE
 = 0 << 
NVME_CC_SHN_SHIFT
,

157 
	mNVME_CC_SHN_NORMAL
 = 1 << 
NVME_CC_SHN_SHIFT
,

158 
	mNVME_CC_SHN_ABRUPT
 = 2 << 
NVME_CC_SHN_SHIFT
,

159 
	mNVME_CC_SHN_MASK
 = 3 << 
NVME_CC_SHN_SHIFT
,

160 
	mNVME_CC_IOSQES
 = 
NVME_NVM_IOSQES
 << 
NVME_CC_IOSQES_SHIFT
,

161 
	mNVME_CC_IOCQES
 = 
NVME_NVM_IOCQES
 << 
NVME_CC_IOCQES_SHIFT
,

162 
	mNVME_CSTS_RDY
 = 1 << 0,

163 
	mNVME_CSTS_CFS
 = 1 << 1,

164 
	mNVME_CSTS_NSSRO
 = 1 << 4,

165 
	mNVME_CSTS_PP
 = 1 << 5,

166 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

167 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

168 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

169 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

172 
	snvme_id_pow”_¡©e
 {

173 
__Ë16
 
	mmax_pow”
;

174 
__u8
 
	mrsvd2
;

175 
__u8
 
	mæags
;

176 
__Ë32
 
	m’Œy_Ït
;

177 
__Ë32
 
	mex™_Ït
;

178 
__u8
 
	m»ad_ut
;

179 
__u8
 
	m»ad_Ït
;

180 
__u8
 
	mwr™e_ut
;

181 
__u8
 
	mwr™e_Ït
;

182 
__Ë16
 
	midË_pow”
;

183 
__u8
 
	midË_sÿË
;

184 
__u8
 
	mrsvd19
;

185 
__Ë16
 
	maùive_pow”
;

186 
__u8
 
	maùive_wÜk_sÿË
;

187 
__u8
 
	mrsvd23
[9];

191 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

192 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

195 
	snvme_id_ù¾
 {

196 
__Ë16
 
	mvid
;

197 
__Ë16
 
	mssvid
;

198 
	m¢
[20];

199 
	mmn
[40];

200 
	mä
[8];

201 
__u8
 
	m¿b
;

202 
__u8
 
	m›“
[3];

203 
__u8
 
	mcmic
;

204 
__u8
 
	mmdts
;

205 
__Ë16
 
	múid
;

206 
__Ë32
 
	mv”
;

207 
__Ë32
 
	m¹d3r
;

208 
__Ë32
 
	m¹d3e
;

209 
__Ë32
 
	mßes
;

210 
__Ë32
 
	mù¿‰
;

211 
__u8
 
	mrsvd100
[156];

212 
__Ë16
 
	mßcs
;

213 
__u8
 
	maş
;

214 
__u8
 
	m«¾
;

215 
__u8
 
	mämw
;

216 
__u8
 
	mÍa
;

217 
__u8
 
	m–³
;

218 
__u8
 
	mÅss
;

219 
__u8
 
	mavscc
;

220 
__u8
 
	m­¡a
;

221 
__Ë16
 
	mwùemp
;

222 
__Ë16
 
	mcùemp
;

223 
__Ë16
 
	mmtç
;

224 
__Ë32
 
	mhm´e
;

225 
__Ë32
 
	mhmmš
;

226 
__u8
 
	mŠvmÿp
[16];

227 
__u8
 
	munvmÿp
[16];

228 
__Ë32
 
	m½mbs
;

229 
__Ë16
 
	med¡t
;

230 
__u8
 
	md¡o
;

231 
__u8
 
	mfwug
;

232 
__Ë16
 
	mkas
;

233 
__Ë16
 
	mhùma
;

234 
__Ë16
 
	mmÁmt
;

235 
__Ë16
 
	mmxtmt
;

236 
__Ë32
 
	m§niÿp
;

237 
__Ë32
 
	mhmmšds
;

238 
__Ë16
 
	mhmmaxd
;

239 
__u8
 
	mrsvd338
[174];

240 
__u8
 
	msqes
;

241 
__u8
 
	mcqes
;

242 
__Ë16
 
	mmaxcmd
;

243 
__Ë32
 
	mÂ
;

244 
__Ë16
 
	mÚcs
;

245 
__Ë16
 
	mfu£s
;

246 
__u8
 
	mâa
;

247 
__u8
 
	mvwc
;

248 
__Ë16
 
	mawun
;

249 
__Ë16
 
	mawupf
;

250 
__u8
 
	mnvscc
;

251 
__u8
 
	mrsvd531
;

252 
__Ë16
 
	macwu
;

253 
__u8
 
	mrsvd534
[2];

254 
__Ë32
 
	msgls
;

255 
__u8
 
	mrsvd540
[228];

256 
	msubnqn
[256];

257 
__u8
 
	mrsvd1024
[768];

258 
__Ë32
 
	mioccsz
;

259 
__Ë32
 
	miÜcsz
;

260 
__Ë16
 
	micdoff
;

261 
__u8
 
	mù¿‰r
;

262 
__u8
 
	mmsdbd
;

263 
__u8
 
	mrsvd1804
[244];

264 
nvme_id_pow”_¡©e
 
	mpsd
[32];

265 
__u8
 
	mvs
[1024];

269 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

270 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

271 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

272 
	mNVME_CTRL_ONCS_WRITE_ZEROES
 = 1 << 3,

273 
	mNVME_CTRL_ONCS_TIMESTAMP
 = 1 << 6,

274 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

275 
	mNVME_CTRL_OACS_SEC_SUPP
 = 1 << 0,

276 
	mNVME_CTRL_OACS_DIRECTIVES
 = 1 << 5,

277 
	mNVME_CTRL_OACS_DBBUF_SUPP
 = 1 << 8,

278 
	mNVME_CTRL_LPA_CMD_EFFECTS_LOG
 = 1 << 1,

281 
	snvme_lbaf
 {

282 
__Ë16
 
	mms
;

283 
__u8
 
	mds
;

284 
__u8
 
	m½
;

287 
	snvme_id_ns
 {

288 
__Ë64
 
	mnsze
;

289 
__Ë64
 
	mnÿp
;

290 
__Ë64
 
	mnu£
;

291 
__u8
 
	mnsã©
;

292 
__u8
 
	mÆbaf
;

293 
__u8
 
	mæbas
;

294 
__u8
 
	mmc
;

295 
__u8
 
	mdpc
;

296 
__u8
 
	mdps
;

297 
__u8
 
	mnmic
;

298 
__u8
 
	m»sÿp
;

299 
__u8
 
	måi
;

300 
__u8
 
	mrsvd33
;

301 
__Ë16
 
	mÇwun
;

302 
__Ë16
 
	mÇwupf
;

303 
__Ë16
 
	mÇcwu
;

304 
__Ë16
 
	mÇb¢
;

305 
__Ë16
 
	mÇbo
;

306 
__Ë16
 
	mÇb¥f
;

307 
__Ë16
 
	mnoiob
;

308 
__u8
 
	mnvmÿp
[16];

309 
__u8
 
	mrsvd64
[40];

310 
__u8
 
	mnguid
[16];

311 
__u8
 
	meui64
[8];

312 
nvme_lbaf
 
	mlbaf
[16];

313 
__u8
 
	mrsvd192
[192];

314 
__u8
 
	mvs
[3712];

318 
	mNVME_ID_CNS_NS
 = 0x00,

319 
	mNVME_ID_CNS_CTRL
 = 0x01,

320 
	mNVME_ID_CNS_NS_ACTIVE_LIST
 = 0x02,

321 
	mNVME_ID_CNS_NS_DESC_LIST
 = 0x03,

322 
	mNVME_ID_CNS_NS_PRESENT_LIST
 = 0x10,

323 
	mNVME_ID_CNS_NS_PRESENT
 = 0x11,

324 
	mNVME_ID_CNS_CTRL_NS_LIST
 = 0x12,

325 
	mNVME_ID_CNS_CTRL_LIST
 = 0x13,

329 
	mNVME_DIR_IDENTIFY
 = 0x00,

330 
	mNVME_DIR_STREAMS
 = 0x01,

331 
	mNVME_DIR_SND_ID_OP_ENABLE
 = 0x01,

332 
	mNVME_DIR_SND_ST_OP_REL_ID
 = 0x01,

333 
	mNVME_DIR_SND_ST_OP_REL_RSC
 = 0x02,

334 
	mNVME_DIR_RCV_ID_OP_PARAM
 = 0x01,

335 
	mNVME_DIR_RCV_ST_OP_PARAM
 = 0x01,

336 
	mNVME_DIR_RCV_ST_OP_STATUS
 = 0x02,

337 
	mNVME_DIR_RCV_ST_OP_RESOURCE
 = 0x03,

338 
	mNVME_DIR_ENDIR
 = 0x01,

342 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

343 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

344 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

345 
	mNVME_LBAF_RP_BEST
 = 0,

346 
	mNVME_LBAF_RP_BETTER
 = 1,

347 
	mNVME_LBAF_RP_GOOD
 = 2,

348 
	mNVME_LBAF_RP_DEGRADED
 = 3,

349 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

350 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

351 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

352 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

353 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

354 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

355 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

356 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

357 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

358 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

361 
	snvme_ns_id_desc
 {

362 
__u8
 
	mnidt
;

363 
__u8
 
	mnidl
;

364 
__Ë16
 
	m»£rved
;

367 
	#NVME_NIDT_EUI64_LEN
 8

	)

368 
	#NVME_NIDT_NGUID_LEN
 16

	)

369 
	#NVME_NIDT_UUID_LEN
 16

	)

372 
	mNVME_NIDT_EUI64
 = 0x01,

373 
	mNVME_NIDT_NGUID
 = 0x02,

374 
	mNVME_NIDT_UUID
 = 0x03,

377 
	snvme_sm¬t_log
 {

378 
__u8
 
	mü™iÿl_w¬nšg
;

379 
__u8
 
	m‹m³¿tu»
[2];

380 
__u8
 
	mava_¥¬e
;

381 
__u8
 
	m¥¬e_th»sh
;

382 
__u8
 
	m³rûÁ_u£d
;

383 
__u8
 
	mrsvd6
[26];

384 
__u8
 
	md©a_un™s_»ad
[16];

385 
__u8
 
	md©a_un™s_wr™‹n
[16];

386 
__u8
 
	mho¡_»ads
[16];

387 
__u8
 
	mho¡_wr™es
[16];

388 
__u8
 
	mù¾_busy_time
[16];

389 
__u8
 
	mpow”_cyşes
[16];

390 
__u8
 
	mpow”_Ú_hours
[16];

391 
__u8
 
	mun§ã_shutdowns
[16];

392 
__u8
 
	mmedŸ_”rÜs
[16];

393 
__u8
 
	mnum_”r_log_’Œ›s
[16];

394 
__Ë32
 
	mw¬nšg_‹mp_time
;

395 
__Ë32
 
	mü™iÿl_comp_time
;

396 
__Ë16
 
	m‹mp_£nsÜ
[8];

397 
__u8
 
	mrsvd216
[296];

400 
	snvme_fw_¦Ù_šfo_log
 {

401 
__u8
 
	mafi
;

402 
__u8
 
	mrsvd1
[7];

403 
__Ë64
 
	mäs
[7];

404 
__u8
 
	mrsvd64
[448];

408 
	mNVME_CMD_EFFECTS_CSUPP
 = 1 << 0,

409 
	mNVME_CMD_EFFECTS_LBCC
 = 1 << 1,

410 
	mNVME_CMD_EFFECTS_NCC
 = 1 << 2,

411 
	mNVME_CMD_EFFECTS_NIC
 = 1 << 3,

412 
	mNVME_CMD_EFFECTS_CCC
 = 1 << 4,

413 
	mNVME_CMD_EFFECTS_CSE_MASK
 = 3 << 16,

416 
	snvme_efãùs_log
 {

417 
__Ë32
 
	macs
[256];

418 
__Ë32
 
	miocs
[256];

419 
__u8
 
	m»sv
[2048];

423 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

424 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

425 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

426 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

427 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

431 
	mNVME_AER_ERROR
 = 0,

432 
	mNVME_AER_SMART
 = 1,

433 
	mNVME_AER_CSS
 = 6,

434 
	mNVME_AER_VS
 = 7,

435 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

436 
	mNVME_AER_NOTICE_FW_ACT_STARTING
 = 0x0102,

439 
	snvme_lba_¿nge_ty³
 {

440 
__u8
 
	mty³
;

441 
__u8
 
	m©Œibu‹s
;

442 
__u8
 
	mrsvd2
[14];

443 
__u64
 
	m¦ba
;

444 
__u64
 
	mÆb
;

445 
__u8
 
	mguid
[16];

446 
__u8
 
	mrsvd48
[16];

450 
	mNVME_LBART_TYPE_FS
 = 0x01,

451 
	mNVME_LBART_TYPE_RAID
 = 0x02,

452 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

453 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

455 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

456 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

459 
	snvme_»£rv©iÚ_¡©us
 {

460 
__Ë32
 
	mg’
;

461 
__u8
 
	m¹y³
;

462 
__u8
 
	m»gùl
[2];

463 
__u8
 
	m»sv5
[2];

464 
__u8
 
	m±¶s
;

465 
__u8
 
	m»sv10
[13];

467 
__Ë16
 
	múid
;

468 
__u8
 
	mrc¡s
;

469 
__u8
 
	m»sv3
[5];

470 
__Ë64
 
	mho¡id
;

471 
__Ë64
 
	mrkey
;

472 } 
	m»gùl_ds
[];

475 
	envme_async_ev’t_ty³
 {

476 
	mNVME_AER_TYPE_ERROR
 = 0,

477 
	mNVME_AER_TYPE_SMART
 = 1,

478 
	mNVME_AER_TYPE_NOTICE
 = 2,

483 
	envme_İcode
 {

484 
	mnvme_cmd_æush
 = 0x00,

485 
	mnvme_cmd_wr™e
 = 0x01,

486 
	mnvme_cmd_»ad
 = 0x02,

487 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

488 
	mnvme_cmd_com·»
 = 0x05,

489 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

490 
	mnvme_cmd_dsm
 = 0x09,

491 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

492 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

493 
	mnvme_cmd_»sv_acquœe
 = 0x11,

494 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

496 
	mnvme_cmd_kv_¡Üe
 = 0x81,

497 
	mnvme_cmd_kv_­³nd
 = 0x83,

498 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

499 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

500 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

501 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

502 
	mnvme_cmd_kv_exi¡
 = 0xB3,

507 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

508 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

509 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

522 
	mNVME_SGL_FMT_ADDRESS
 = 0x00,

523 
	mNVME_SGL_FMT_OFFSET
 = 0x01,

524 
	mNVME_SGL_FMT_TRANSPORT_A
 = 0x0A,

525 
	mNVME_SGL_FMT_INVALIDATE
 = 0x0f,

543 
	mNVME_SGL_FMT_DATA_DESC
 = 0x00,

544 
	mNVME_SGL_FMT_SEG_DESC
 = 0x02,

545 
	mNVME_SGL_FMT_LAST_SEG_DESC
 = 0x03,

546 
	mNVME_KEY_SGL_FMT_DATA_DESC
 = 0x04,

547 
	mNVME_TRANSPORT_SGL_DATA_DESC
 = 0x05,

550 
	snvme_sgl_desc
 {

551 
__Ë64
 
	maddr
;

552 
__Ë32
 
	mËngth
;

553 
__u8
 
	mrsvd
[3];

554 
__u8
 
	mty³
;

557 
	snvme_keyed_sgl_desc
 {

558 
__Ë64
 
	maddr
;

559 
__u8
 
	mËngth
[3];

560 
__u8
 
	mkey
[4];

561 
__u8
 
	mty³
;

564 
	unvme_d©a_±r
 {

566 
__Ë64
 
	m´p1
;

567 
__Ë64
 
	m´p2
;

569 
nvme_sgl_desc
 
	msgl
;

570 
nvme_keyed_sgl_desc
 
	mksgl
;

588 
	mNVME_CMD_FUSE_FIRST
 = (1 << 0),

589 
	mNVME_CMD_FUSE_SECOND
 = (1 << 1),

591 
	mNVME_CMD_SGL_METABUF
 = (1 << 6),

592 
	mNVME_CMD_SGL_METASEG
 = (1 << 7),

593 
	mNVME_CMD_SGL_ALL
 = 
NVME_CMD_SGL_METABUF
 | 
NVME_CMD_SGL_METASEG
,

596 
	snvme_commÚ_commªd
 {

597 
__u8
 
	mİcode
;

598 
__u8
 
	mæags
;

599 
__u16
 
	mcommªd_id
;

600 
__Ë32
 
	mnsid
;

601 
__Ë32
 
	mcdw2
[2];

602 
__Ë64
 
	mm‘ad©a
;

603 
nvme_d©a_±r
 
	md±r
;

604 
__Ë32
 
	mcdw10
[6];

607 
	snvme_rw_commªd
 {

608 
__u8
 
	mİcode
;

609 
__u8
 
	mæags
;

610 
__u16
 
	mcommªd_id
;

611 
__Ë32
 
	mnsid
;

612 
__u64
 
	mrsvd2
;

613 
__Ë64
 
	mm‘ad©a
;

614 
nvme_d©a_±r
 
	md±r
;

615 
__Ë64
 
	m¦ba
;

616 
__Ë16
 
	mËngth
;

617 
__Ë16
 
	mcÚŒŞ
;

618 
__Ë32
 
	mdsmgmt
;

619 
__Ë32
 
	m»áag
;

620 
__Ë16
 
	m­±ag
;

621 
__Ë16
 
	m­pmask
;

625 
	mNVME_RW_LR
 = 1 << 15,

626 
	mNVME_RW_FUA
 = 1 << 14,

627 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

628 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

629 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

630 
	mNVME_RW_DSM_FREQ_READS
 = 3,

631 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

632 
	mNVME_RW_DSM_FREQ_RW
 = 5,

633 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

634 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

635 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

636 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

637 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

638 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

639 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

640 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

641 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

642 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

643 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

644 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

645 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

646 
	mNVME_RW_DTYPE_STREAMS
 = 1 << 4,

649 
	snvme_dsm_cmd
 {

650 
__u8
 
	mİcode
;

651 
__u8
 
	mæags
;

652 
__u16
 
	mcommªd_id
;

653 
__Ë32
 
	mnsid
;

654 
__u64
 
	mrsvd2
[2];

655 
nvme_d©a_±r
 
	md±r
;

656 
__Ë32
 
	mÄ
;

657 
__Ë32
 
	m©Œibu‹s
;

658 
__u32
 
	mrsvd12
[4];

662 
	mNVME_DSMGMT_IDR
 = 1 << 0,

663 
	mNVME_DSMGMT_IDW
 = 1 << 1,

664 
	mNVME_DSMGMT_AD
 = 1 << 2,

667 
	#NVME_DSM_MAX_RANGES
 256

	)

669 
	snvme_dsm_¿nge
 {

670 
__Ë32
 
	mÿ‰r
;

671 
__Ë32
 
	mÆb
;

672 
__Ë64
 
	m¦ba
;

675 
	snvme_wr™e_z”Ûs_cmd
 {

676 
__u8
 
	mİcode
;

677 
__u8
 
	mæags
;

678 
__u16
 
	mcommªd_id
;

679 
__Ë32
 
	mnsid
;

680 
__u64
 
	mrsvd2
;

681 
__Ë64
 
	mm‘ad©a
;

682 
nvme_d©a_±r
 
	md±r
;

683 
__Ë64
 
	m¦ba
;

684 
__Ë16
 
	mËngth
;

685 
__Ë16
 
	mcÚŒŞ
;

686 
__Ë32
 
	mdsmgmt
;

687 
__Ë32
 
	m»áag
;

688 
__Ë16
 
	m­±ag
;

689 
__Ë16
 
	m­pmask
;

694 
	snvme_ã©_auto_p¡
 {

695 
__Ë64
 
	m’Œ›s
[32];

699 
	mNVME_HOST_MEM_ENABLE
 = (1 << 0),

700 
	mNVME_HOST_MEM_RETURN
 = (1 << 1),

705 
	snvme_kv_¡Üe_commªd
 {

706 
__u8
 
	mİcode
;

707 
__u8
 
	mæags
;

708 
__u16
 
	mcommªd_id
;

709 
__Ë32
 
	mnsid
;

710 
__u64
 
	mrsvd
;

711 
__Ë32
 
	moff£t
;

712 
__u32
 
	mrsvd2
;

713 
nvme_d©a_±r
 
	md±r
;

714 
__Ë32
 
	mv®ue_Ën
;

715 
__u8
 
	mkey_Ën
;

716 
__u8
 
	mİtiÚ
;

717 
__u8
 
	mšv®id_by‹
:2;

718 
__u8
 
	mrsvd3
:6;

719 
__u8
 
	mrsvd4
;

722 
	mkey
[16];

725 
__Ë64
 
	mkey_´p
;

726 
__Ë64
 
	mkey_´p2
;

731 
	snvme_kv_­³nd_commªd
 {

732 
__u8
 
	mİcode
;

733 
__u8
 
	mæags
;

734 
__u16
 
	mcommªd_id
;

735 
__Ë32
 
	mnsid
;

736 
__u64
 
	mrsvd
;

737 
__Ë32
 
	moff£t
;

738 
__u32
 
	mrsvd2
;

739 
nvme_d©a_±r
 
	md±r
;

740 
__Ë32
 
	mv®ue_Ën
;

741 
__u8
 
	mkey_Ën
;

742 
__u8
 
	mİtiÚ
;

743 
__u8
 
	mšv®id_by‹
:2;

744 
__u8
 
	mrsvd3
:6;

745 
__u8
 
	mrsvd4
;

748 
	mkey
[16];

751 
__Ë64
 
	mkey_´p
;

752 
__Ë64
 
	mkey_´p2
;

757 
	snvme_kv_»Œ›ve_commªd
 {

758 
__u8
 
	mİcode
;

759 
__u8
 
	mæags
;

760 
__u16
 
	mcommªd_id
;

761 
__Ë32
 
	mnsid
;

762 
__u64
 
	mrsvd
;

763 
__Ë32
 
	moff£t
;

764 
__u32
 
	mrsvd2
;

765 
nvme_d©a_±r
 
	md±r
;

766 
__Ë32
 
	mv®ue_Ën
;

767 
__u8
 
	mkey_Ën
;

768 
__u8
 
	mİtiÚ
;

769 
__u16
 
	mrsvd3
;

772 
	mkey
[16];

775 
__Ë64
 
	mkey_´p
;

776 
__Ë64
 
	mkey_´p2
;

781 
	snvme_kv_d–‘e_commªd
 {

782 
__u8
 
	mİcode
;

783 
__u8
 
	mæags
;

784 
__u16
 
	mcommªd_id
;

785 
__Ë32
 
	mnsid
;

786 
__u64
 
	mrsvd
;

787 
__Ë32
 
	moff£t
;

788 
__u32
 
	mrsvd2
;

789 
__u64
 
	mrsvd3
[2];

790 
__Ë32
 
	mv®ue_Ën
;

791 
__u8
 
	mkey_Ën
;

792 
__u8
 
	mİtiÚ
;

793 
__u16
 
	mrsvd4
;

796 
	mkey
[16];

799 
__Ë64
 
	mkey_´p
;

800 
__Ë64
 
	mkey_´p2
;

805 
	snvme_kv_™”_»q_commªd
 {

806 
__u8
 
	mİcode
;

807 
__u8
 
	mæags
;

808 
__u16
 
	mcommªd_id
;

809 
__Ë32
 
	mnsid
;

810 
__u64
 
	mrsvd
[4];

811 
__Ë32
 
	mz”o
;

812 
__u8
 
	m™”_hªdË
;

813 
__u8
 
	mİtiÚ
;

814 
__u16
 
	mrsvd2
;

815 
__Ë32
 
	m™”_v®
;

816 
__Ë32
 
	m™”_b™mask
;

817 
__u64
 
	mrsvd3
;

821 
	snvme_kv_™”_»ad_commªd
 {

822 
__u8
 
	mİcode
;

823 
__u8
 
	mæags
;

824 
__u16
 
	mcommªd_id
;

825 
__Ë32
 
	mnsid
;

826 
__u64
 
	mrsvd
[2];

827 
nvme_d©a_±r
 
	md±r
;

828 
__Ë32
 
	mv®ue_Ën
;

829 
__u8
 
	m™”_hªdË
;

830 
__u8
 
	mİtiÚ
;

831 
__u16
 
	mrsvd2
;

832 
__u64
 
	mrsvd3
[2];

834 
	snvme_kv_exi¡_commªd
 {

835 
__u8
 
	mİcode
;

836 
__u8
 
	mæags
;

837 
__u16
 
	mcommªd_id
;

838 
__Ë32
 
	mnsid
;

839 
__u64
 
	mrsvd
;

840 
__Ë32
 
	moff£t
;

841 
__u32
 
	mrsvd2
;

842 
__u64
 
	mrsvd3
[2];

843 
__Ë32
 
	mv®ue_Ën
;

844 
__u8
 
	mkey_Ën
;

845 
__u8
 
	mİtiÚ
;

846 
__u16
 
	mrsvd4
;

849 
	mkey
[16];

852 
__Ë64
 
	mkey_´p
;

853 
__Ë64
 
	mkey_´p2
;

863 
	envme_admš_İcode
 {

864 
	mnvme_admš_d–‘e_sq
 = 0x00,

865 
	mnvme_admš_ü—‹_sq
 = 0x01,

866 
	mnvme_admš_g‘_log_·ge
 = 0x02,

867 
	mnvme_admš_d–‘e_cq
 = 0x04,

868 
	mnvme_admš_ü—‹_cq
 = 0x05,

869 
	mnvme_admš_id’tify
 = 0x06,

870 
	mnvme_admš_abÜt_cmd
 = 0x08,

871 
	mnvme_admš_£t_ã©u»s
 = 0x09,

872 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

873 
	mnvme_admš_async_ev’t
 = 0x0c,

874 
	mnvme_admš_ns_mgmt
 = 0x0d,

875 
	mnvme_admš_aùiv©e_fw
 = 0x10,

876 
	mnvme_admš_dowÆßd_fw
 = 0x11,

877 
	mnvme_admš_ns_©ch
 = 0x15,

878 
	mnvme_admš_k“p_®ive
 = 0x18,

879 
	mnvme_admš_dœeùive_£nd
 = 0x19,

880 
	mnvme_admš_dœeùive_»cv
 = 0x1a,

881 
	mnvme_admš_dbbuf
 = 0x7C,

882 
	mnvme_admš_fÜm©_nvm
 = 0x80,

883 
	mnvme_admš_£cur™y_£nd
 = 0x81,

884 
	mnvme_admš_£cur™y_»cv
 = 0x82,

885 
	mnvme_admš_§n™ize_nvm
 = 0x84,

889 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

890 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

891 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

892 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

893 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

894 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

895 
	mNVME_FEAT_ARBITRATION
 = 0x01,

896 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

897 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

898 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

899 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

900 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

901 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

902 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

903 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

904 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

905 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

906 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

907 
	mNVME_FEAT_HOST_MEM_BUF
 = 0x0d,

908 
	mNVME_FEAT_TIMESTAMP
 = 0x0e,

909 
	mNVME_FEAT_KATO
 = 0x0f,

910 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

911 
	mNVME_FEAT_HOST_ID
 = 0x81,

912 
	mNVME_FEAT_RESV_MASK
 = 0x82,

913 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

914 
	mNVME_LOG_ERROR
 = 0x01,

915 
	mNVME_LOG_SMART
 = 0x02,

916 
	mNVME_LOG_FW_SLOT
 = 0x03,

917 
	mNVME_LOG_CMD_EFFECTS
 = 0x05,

918 
	mNVME_LOG_DISC
 = 0x70,

919 
	mNVME_LOG_RESERVATION
 = 0x80,

920 
	mNVME_FWACT_REPL
 = (0 << 3),

921 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

922 
	mNVME_FWACT_ACTV
 = (2 << 3),

925 
	snvme_id’tify
 {

926 
__u8
 
	mİcode
;

927 
__u8
 
	mæags
;

928 
__u16
 
	mcommªd_id
;

929 
__Ë32
 
	mnsid
;

930 
__u64
 
	mrsvd2
[2];

931 
nvme_d©a_±r
 
	md±r
;

932 
__u8
 
	mús
;

933 
__u8
 
	mrsvd3
;

934 
__Ë16
 
	mù¾id
;

935 
__u32
 
	mrsvd11
[5];

938 
	#NVME_IDENTIFY_DATA_SIZE
 4096

	)

940 
	snvme_ã©u»s
 {

941 
__u8
 
	mİcode
;

942 
__u8
 
	mæags
;

943 
__u16
 
	mcommªd_id
;

944 
__Ë32
 
	mnsid
;

945 
__u64
 
	mrsvd2
[2];

946 
nvme_d©a_±r
 
	md±r
;

947 
__Ë32
 
	mfid
;

948 
__Ë32
 
	mdwÜd11
;

949 
__Ë32
 
	mdwÜd12
;

950 
__Ë32
 
	mdwÜd13
;

951 
__Ë32
 
	mdwÜd14
;

952 
__Ë32
 
	mdwÜd15
;

955 
	snvme_ho¡_mem_buf_desc
 {

956 
__Ë64
 
	maddr
;

957 
__Ë32
 
	msize
;

958 
__u32
 
	mrsvd
;

961 
	snvme_ü—‹_cq
 {

962 
__u8
 
	mİcode
;

963 
__u8
 
	mæags
;

964 
__u16
 
	mcommªd_id
;

965 
__u32
 
	mrsvd1
[5];

966 
__Ë64
 
	m´p1
;

967 
__u64
 
	mrsvd8
;

968 
__Ë16
 
	mcqid
;

969 
__Ë16
 
	mqsize
;

970 
__Ë16
 
	mcq_æags
;

971 
__Ë16
 
	mœq_veùÜ
;

972 
__u32
 
	mrsvd12
[4];

975 
	snvme_ü—‹_sq
 {

976 
__u8
 
	mİcode
;

977 
__u8
 
	mæags
;

978 
__u16
 
	mcommªd_id
;

979 
__u32
 
	mrsvd1
[5];

980 
__Ë64
 
	m´p1
;

981 
__u64
 
	mrsvd8
;

982 
__Ë16
 
	msqid
;

983 
__Ë16
 
	mqsize
;

984 
__Ë16
 
	msq_æags
;

985 
__Ë16
 
	mcqid
;

986 
__u32
 
	mrsvd12
[4];

989 
	snvme_d–‘e_queue
 {

990 
__u8
 
	mİcode
;

991 
__u8
 
	mæags
;

992 
__u16
 
	mcommªd_id
;

993 
__u32
 
	mrsvd1
[9];

994 
__Ë16
 
	mqid
;

995 
__u16
 
	mrsvd10
;

996 
__u32
 
	mrsvd11
[5];

999 
	snvme_abÜt_cmd
 {

1000 
__u8
 
	mİcode
;

1001 
__u8
 
	mæags
;

1002 
__u16
 
	mcommªd_id
;

1003 
__u32
 
	mrsvd1
[9];

1004 
__Ë16
 
	msqid
;

1005 
__u16
 
	mcid
;

1006 
__u32
 
	mrsvd11
[5];

1009 
	snvme_dowÆßd_fœmw¬e
 {

1010 
__u8
 
	mİcode
;

1011 
__u8
 
	mæags
;

1012 
__u16
 
	mcommªd_id
;

1013 
__u32
 
	mrsvd1
[5];

1014 
nvme_d©a_±r
 
	md±r
;

1015 
__Ë32
 
	mnumd
;

1016 
__Ë32
 
	moff£t
;

1017 
__u32
 
	mrsvd12
[4];

1020 
	snvme_fÜm©_cmd
 {

1021 
__u8
 
	mİcode
;

1022 
__u8
 
	mæags
;

1023 
__u16
 
	mcommªd_id
;

1024 
__Ë32
 
	mnsid
;

1025 
__u64
 
	mrsvd2
[4];

1026 
__Ë32
 
	mcdw10
;

1027 
__u32
 
	mrsvd11
[5];

1030 
	snvme_g‘_log_·ge_commªd
 {

1031 
__u8
 
	mİcode
;

1032 
__u8
 
	mæags
;

1033 
__u16
 
	mcommªd_id
;

1034 
__Ë32
 
	mnsid
;

1035 
__u64
 
	mrsvd2
[2];

1036 
nvme_d©a_±r
 
	md±r
;

1037 
__u8
 
	mlid
;

1038 
__u8
 
	mrsvd10
;

1039 
__Ë16
 
	mnumdl
;

1040 
__Ë16
 
	mnumdu
;

1041 
__u16
 
	mrsvd11
;

1042 
__Ë32
 
	mÍŞ
;

1043 
__Ë32
 
	mÍou
;

1044 
__u32
 
	mrsvd14
[2];

1047 
	snvme_dœeùive_cmd
 {

1048 
__u8
 
	mİcode
;

1049 
__u8
 
	mæags
;

1050 
__u16
 
	mcommªd_id
;

1051 
__Ë32
 
	mnsid
;

1052 
__u64
 
	mrsvd2
[2];

1053 
nvme_d©a_±r
 
	md±r
;

1054 
__Ë32
 
	mnumd
;

1055 
__u8
 
	mdİ”
;

1056 
__u8
 
	mdty³
;

1057 
__Ë16
 
	md¥ec
;

1058 
__u8
 
	m’dœ
;

1059 
__u8
 
	mtdty³
;

1060 
__u16
 
	mrsvd15
;

1062 
__u32
 
	mrsvd16
[3];

1068 
	envmf_çbrics_İcode
 {

1069 
	mnvme_çbrics_commªd
 = 0x7f,

1072 
	envmf_ÿpsuË_commªd
 {

1073 
	mnvme_çbrics_ty³_´İ”ty_£t
 = 0x00,

1074 
	mnvme_çbrics_ty³_cÚÃù
 = 0x01,

1075 
	mnvme_çbrics_ty³_´İ”ty_g‘
 = 0x04,

1078 
	snvmf_commÚ_commªd
 {

1079 
__u8
 
	mİcode
;

1080 
__u8
 
	m»sv1
;

1081 
__u16
 
	mcommªd_id
;

1082 
__u8
 
	mfùy³
;

1083 
__u8
 
	m»sv2
[35];

1084 
__u8
 
	mts
[24];

1093 
	#NVME_CNTLID_MIN
 1

	)

1094 
	#NVME_CNTLID_MAX
 0xfãf

	)

1095 
	#NVME_CNTLID_DYNAMIC
 0xffff

	)

1097 
	#MAX_DISC_LOGS
 255

	)

1100 
	snvmf_disc_r¥_·ge_’Œy
 {

1101 
__u8
 
	mŒty³
;

1102 
__u8
 
	madrçm
;

1103 
__u8
 
	msubty³
;

1104 
__u8
 
	mŒeq
;

1105 
__Ë16
 
	mpÜtid
;

1106 
__Ë16
 
	múid
;

1107 
__Ë16
 
	masqsz
;

1108 
__u8
 
	m»sv8
[22];

1109 
	mŒsvcid
[
NVMF_TRSVCID_SIZE
];

1110 
__u8
 
	m»sv64
[192];

1111 
	msubnqn
[
NVMF_NQN_FIELD_LEN
];

1112 
	mŒaddr
[
NVMF_TRADDR_SIZE
];

1113 
	ut§s
 {

1114 
	mcommÚ
[
NVMF_TSAS_SIZE
];

1115 
	srdma
 {

1116 
__u8
 
	mq±y³
;

1117 
__u8
 
	m´ty³
;

1118 
__u8
 
	mcms
;

1119 
__u8
 
	m»sv3
[5];

1120 
__u16
 
	mpkey
;

1121 
__u8
 
	m»sv10
[246];

1122 } 
	mrdma
;

1123 } 
	mt§s
;

1127 
	snvmf_disc_r¥_·ge_hdr
 {

1128 
__Ë64
 
	mg’ùr
;

1129 
__Ë64
 
	mnum»c
;

1130 
__Ë16
 
	m»cfmt
;

1131 
__u8
 
	m»sv14
[1006];

1132 
nvmf_disc_r¥_·ge_’Œy
 
	m’Œ›s
[0];

1135 
	snvmf_cÚÃù_commªd
 {

1136 
__u8
 
	mİcode
;

1137 
__u8
 
	m»sv1
;

1138 
__u16
 
	mcommªd_id
;

1139 
__u8
 
	mfùy³
;

1140 
__u8
 
	m»sv2
[19];

1141 
nvme_d©a_±r
 
	md±r
;

1142 
__Ë16
 
	m»cfmt
;

1143 
__Ë16
 
	mqid
;

1144 
__Ë16
 
	msqsize
;

1145 
__u8
 
	mÿ‰r
;

1146 
__u8
 
	m»sv3
;

1147 
__Ë32
 
	mk©o
;

1148 
__u8
 
	m»sv4
[12];

1151 
	snvmf_cÚÃù_d©a
 {

1152 
uuid_t
 
	mho¡id
;

1153 
__Ë16
 
	múid
;

1154 
	m»sv4
[238];

1155 
	msubsy¢qn
[
NVMF_NQN_FIELD_LEN
];

1156 
	mho¡nqn
[
NVMF_NQN_FIELD_LEN
];

1157 
	m»sv5
[256];

1160 
	snvmf_´İ”ty_£t_commªd
 {

1161 
__u8
 
	mİcode
;

1162 
__u8
 
	m»sv1
;

1163 
__u16
 
	mcommªd_id
;

1164 
__u8
 
	mfùy³
;

1165 
__u8
 
	m»sv2
[35];

1166 
__u8
 
	m©Œib
;

1167 
__u8
 
	m»sv3
[3];

1168 
__Ë32
 
	moff£t
;

1169 
__Ë64
 
	mv®ue
;

1170 
__u8
 
	m»sv4
[8];

1173 
	snvmf_´İ”ty_g‘_commªd
 {

1174 
__u8
 
	mİcode
;

1175 
__u8
 
	m»sv1
;

1176 
__u16
 
	mcommªd_id
;

1177 
__u8
 
	mfùy³
;

1178 
__u8
 
	m»sv2
[35];

1179 
__u8
 
	m©Œib
;

1180 
__u8
 
	m»sv3
[3];

1181 
__Ë32
 
	moff£t
;

1182 
__u8
 
	m»sv4
[16];

1185 
	snvme_dbbuf
 {

1186 
__u8
 
	mİcode
;

1187 
__u8
 
	mæags
;

1188 
__u16
 
	mcommªd_id
;

1189 
__u32
 
	mrsvd1
[5];

1190 
__Ë64
 
	m´p1
;

1191 
__Ë64
 
	m´p2
;

1192 
__u32
 
	mrsvd12
[6];

1195 
	s¡»ams_dœeùive_·¿ms
 {

1196 
__Ë16
 
	mm¦
;

1197 
__Ë16
 
	mns§
;

1198 
__Ë16
 
	mnsso
;

1199 
__u8
 
	mrsvd
[10];

1200 
__Ë32
 
	msws
;

1201 
__Ë16
 
	msgs
;

1202 
__Ë16
 
	mn§
;

1203 
__Ë16
 
	mnso
;

1204 
__u8
 
	mrsvd2
[6];

1207 
	snvme_commªd
 {

1209 
nvme_commÚ_commªd
 
	mcommÚ
;

1210 
nvme_rw_commªd
 
	mrw
;

1211 
nvme_id’tify
 
	mid’tify
;

1212 
nvme_ã©u»s
 
	mã©u»s
;

1213 
nvme_ü—‹_cq
 
	mü—‹_cq
;

1214 
nvme_ü—‹_sq
 
	mü—‹_sq
;

1215 
nvme_d–‘e_queue
 
	md–‘e_queue
;

1216 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

1217 
nvme_fÜm©_cmd
 
	mfÜm©
;

1218 
nvme_dsm_cmd
 
	mdsm
;

1219 
nvme_wr™e_z”Ûs_cmd
 
	mwr™e_z”Ûs
;

1220 
nvme_abÜt_cmd
 
	mabÜt
;

1221 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

1222 
nvmf_commÚ_commªd
 
	mçbrics
;

1223 
nvmf_cÚÃù_commªd
 
	mcÚÃù
;

1224 
nvmf_´İ”ty_£t_commªd
 
	m´İ_£t
;

1225 
nvmf_´İ”ty_g‘_commªd
 
	m´İ_g‘
;

1226 
nvme_dbbuf
 
	mdbbuf
;

1227 
nvme_dœeùive_cmd
 
	mdœeùive
;

1229 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

1230 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

1231 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

1232 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

1233 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

1234 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

1235 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

1240 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1248 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_¡Üe
 || cmd->commÚ.İcod=ğ
nvme_cmd_kv_­³nd
)

1250 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_»Œ›ve
 ||

1251 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_d–‘e
 ||

1252 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»q
 ||

1253 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
 ||

1254 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_exi¡
 )

1257 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1258  
cmd
->
çbrics
.
fùy³
 & 1;

1259  
cmd
->
commÚ
.
İcode
 & 1;

1260 
	}
}

1266 
	mNVME_SC_SUCCESS
 = 0x0,

1267 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

1268 
	mNVME_SC_INVALID_FIELD
 = 0x2,

1269 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

1270 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

1271 
	mNVME_SC_POWER_LOSS
 = 0x5,

1272 
	mNVME_SC_INTERNAL
 = 0x6,

1273 
	mNVME_SC_ABORT_REQ
 = 0x7,

1274 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

1275 
	mNVME_SC_FUSED_FAIL
 = 0x9,

1276 
	mNVME_SC_FUSED_MISSING
 = 0xa,

1277 
	mNVME_SC_INVALID_NS
 = 0xb,

1278 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

1279 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

1280 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

1281 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

1282 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

1283 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

1285 
	mNVME_SC_SGL_INVALID_OFFSET
 = 0x16,

1286 
	mNVME_SC_SGL_INVALID_SUBTYPE
 = 0x17,

1288 
	mNVME_SC_LBA_RANGE
 = 0x80,

1289 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

1290 
	mNVME_SC_NS_NOT_READY
 = 0x82,

1291 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

1296 
	mNVME_SC_CQ_INVALID
 = 0x100,

1297 
	mNVME_SC_QID_INVALID
 = 0x101,

1298 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

1299 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

1300 
	mNVME_SC_ABORT_MISSING
 = 0x104,

1301 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

1302 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

1303 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

1304 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

1305 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

1306 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

1307 
	mNVME_SC_FW_NEEDS_CONV_RESET
 = 0x10b,

1308 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

1309 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

1310 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

1311 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

1312 
	mNVME_SC_FW_NEEDS_SUBSYS_RESET
 = 0x110,

1313 
	mNVME_SC_FW_NEEDS_RESET
 = 0x111,

1314 
	mNVME_SC_FW_NEEDS_MAX_TIME
 = 0x112,

1315 
	mNVME_SC_FW_ACIVATE_PROHIBITED
 = 0x113,

1316 
	mNVME_SC_OVERLAPPING_RANGE
 = 0x114,

1317 
	mNVME_SC_NS_INSUFFICENT_CAP
 = 0x115,

1318 
	mNVME_SC_NS_ID_UNAVAILABLE
 = 0x116,

1319 
	mNVME_SC_NS_ALREADY_ATTACHED
 = 0x118,

1320 
	mNVME_SC_NS_IS_PRIVATE
 = 0x119,

1321 
	mNVME_SC_NS_NOT_ATTACHED
 = 0x11a,

1322 
	mNVME_SC_THIN_PROV_NOT_SUPP
 = 0x11b,

1323 
	mNVME_SC_CTRL_LIST_INVALID
 = 0x11c,

1328 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

1329 
	mNVME_SC_INVALID_PI
 = 0x181,

1330 
	mNVME_SC_READ_ONLY
 = 0x182,

1331 
	mNVME_SC_ONCS_NOT_SUPPORTED
 = 0x183,

1336 
	mNVME_SC_CONNECT_FORMAT
 = 0x180,

1337 
	mNVME_SC_CONNECT_CTRL_BUSY
 = 0x181,

1338 
	mNVME_SC_CONNECT_INVALID_PARAM
 = 0x182,

1339 
	mNVME_SC_CONNECT_RESTART_DISC
 = 0x183,

1340 
	mNVME_SC_CONNECT_INVALID_HOST
 = 0x184,

1342 
	mNVME_SC_DISCOVERY_RESTART
 = 0x190,

1343 
	mNVME_SC_AUTH_REQUIRED
 = 0x191,

1348 
	mNVME_SC_WRITE_FAULT
 = 0x280,

1349 
	mNVME_SC_READ_ERROR
 = 0x281,

1350 
	mNVME_SC_GUARD_CHECK
 = 0x282,

1351 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

1352 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

1353 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

1354 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

1355 
	mNVME_SC_UNWRITTEN_BLOCK
 = 0x287,

1357 
	mNVME_SC_DNR
 = 0x4000,

1360 
	snvme_com¶‘iÚ
 {

1364 
	unvme_»suÉ
 {

1365 
__Ë16
 
	mu16
;

1366 
__Ë32
 
	mu32
;

1367 
__Ë64
 
	mu64
;

1368 } 
	m»suÉ
;

1369 
__Ë16
 
	msq_h—d
;

1370 
__Ë16
 
	msq_id
;

1371 
__u16
 
	mcommªd_id
;

1372 
__Ë16
 
	m¡©us
;

1375 
	#NVME_VS
(
majÜ
, 
mšÜ
, 
‹¹Ÿry
) \

1376 (((
majÜ
è<< 16è| ((
mšÜ
è<< 8è| (
‹¹Ÿry
))

	)

1378 
	#NVME_MAJOR
(
v”
è((v”è>> 16)

	)

1379 
	#NVME_MINOR
(
v”
è(((v”è>> 8è& 0xff)

	)

1380 
	#NVME_TERTIARY
(
v”
è((v”è& 0xff)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/linux_nvme_ioctl.h

16 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


17 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

19 
	~<lšux/ty³s.h
>

21 
	snvme_u£r_io
 {

22 
__u8
 
	mİcode
;

23 
__u8
 
	mæags
;

24 
__u16
 
	mcÚŒŞ
;

25 
__u16
 
	mnblocks
;

26 
__u16
 
	mrsvd
;

27 
__u64
 
	mm‘ad©a
;

28 
__u64
 
	maddr
;

29 
__u64
 
	m¦ba
;

30 
__u32
 
	mdsmgmt
;

31 
__u32
 
	m»áag
;

32 
__u16
 
	m­±ag
;

33 
__u16
 
	m­pmask
;

36 
	snvme_·s¡hru_cmd
 {

37 
__u8
 
	mİcode
;

38 
__u8
 
	mæags
;

39 
__u16
 
	mrsvd1
;

40 
__u32
 
	mnsid
;

41 
__u32
 
	mcdw2
;

42 
__u32
 
	mcdw3
;

43 
__u64
 
	mm‘ad©a
;

44 
__u64
 
	maddr
;

45 
__u32
 
	mm‘ad©a_Ën
;

46 
__u32
 
	md©a_Ën
;

47 
__u32
 
	mcdw10
;

48 
__u32
 
	mcdw11
;

49 
__u32
 
	mcdw12
;

50 
__u32
 
	mcdw13
;

51 
__u32
 
	mcdw14
;

52 
__u32
 
	mcdw15
;

53 
__u32
 
	mtimeout_ms
;

54 
__u32
 
	m»suÉ
;

57 
	#KVS_SUCCESS
 0

	)

58 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

59 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

60 
	#KVS_ERR_CLOSE
 (-3)

	)

61 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

62 
	#KVS_ERR_CONT_NAME
 (-5)

	)

63 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

64 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

65 
	#KVS_ERR_GROUP
 (-8)

	)

66 
	#KVS_ERR_INDEX
 (-9)

	)

67 
	#KVS_ERR_IO
 (-10)

	)

68 
	#KVS_ERR_KEY
 (-11)

	)

69 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

70 
	#KVS_ERR_MEMORY
 (-13)

	)

71 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

72 
	#KVS_ERR_OFFSET
 (-15)

	)

73 
	#KVS_ERR_OPEN
 (-16)

	)

74 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

75 
	#KVS_ERR_PERMISSION
 (-18)

	)

76 
	#KVS_ERR_SPACE
 (-19)

	)

77 
	#KVS_ERR_TIMEOUT
 (-20)

	)

78 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

79 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

80 
	#KVS_ERR_VALUE
 (-23)

	)

83 
	snvme_·s¡hru_kv_cmd
 {

84 
__u8
 
	mİcode
;

85 
__u8
 
	mæags
;

86 
__u16
 
	mrsvd1
;

87 
__u32
 
	mnsid
;

88 
__u32
 
	mcdw2
;

89 
__u32
 
	mcdw3
;

90 
__u32
 
	mcdw4
;

91 
__u32
 
	mcdw5
;

92 
__u64
 
	md©a_addr
;

93 
__u32
 
	md©a_Ëngth
;

94 
__u32
 
	mkey_Ëngth
;

95 
__u32
 
	mcdw10
;

96 
__u32
 
	mcdw11
;

99 
__u64
 
	mkey_addr
;

100 
__u32
 
	mrsvd5
;

101 
__u32
 
	mrsvd6
;

103 
__u8
 
	mkey
[16];

105 
__u32
 
	mcdw12
;

106 
__u32
 
	mcdw13
;

107 
__u32
 
	mcdw14
;

108 
__u32
 
	mcdw15
;

111 
__u32
 
	mtimeout_ms
;

112 
__u32
 
	m»suÉ
;

113 
__u32
 
	m¡©us
;

114 
__u32
 
	mùxid
;

115 
__u64
 
	m»qid
;

118 
	snvme_aioùx
 {

119 
__u32
 
	mùxid
;

120 
__u32
 
	mev’tfd
;

124 
	snvme_aiÛv’t
 {

125 
__u64
 
	m»qid
;

126 
__u32
 
	mùxid
;

127 
__u32
 
	m»suÉ
;

128 
__u16
 
	m¡©us
;

131 
	#MAX_AIO_EVENTS
 128

	)

132 
	snvme_aiÛv’ts
 {

133 
__u16
 
	mÄ
;

134 
__u32
 
	mùxid
;

135 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

139 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

141 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

142 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

143 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

144 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

145 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

146 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

147 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

149 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

150 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

151 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

152 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

153 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/multipath.c

14 
	~<lšux/moduË·¿m.h
>

15 
	~"nvme.h
"

17 
boŞ
 
	gmuÉ©h
 = 
Œue
;

18 
moduË_·¿m
(
muÉ©h
, 
boŞ
, 0644);

19 
MODULE_PARM_DESC
(
muÉ©h
,

22 
	$nvme_çov”_»q
(
»que¡
 *
»q
)

24 
nvme_ns
 *
ns
 = 
»q
->
q
->
queued©a
;

25 
æags
;

27 
	`¥š_lock_œq§ve
(&
ns
->
h—d
->
»queue_lock
, 
æags
);

28 
	`blk_¡—l_bios
(&
ns
->
h—d
->
»queue_li¡
, 
»q
);

29 
	`¥š_uÆock_œq»¡Üe
(&
ns
->
h—d
->
»queue_lock
, 
æags
);

30 
	`blk_mq_’d_»que¡
(
»q
, 0);

32 
	`nvme_»£t_ù¾
(
ns
->
ù¾
);

33 
	`kblockd_scheduË_wÜk
(&
ns
->
h—d
->
»queue_wÜk
);

34 
	}
}

36 
boŞ
 
	$nvme_»q_Ãeds_çov”
(
»que¡
 *
»q
)

38 ià(!(
»q
->
cmd_æags
 & 
REQ_NVME_MPATH
))

39  
çl£
;

41 
	`nvme_»q
(
»q
)->
¡©us
 & 0x7ff) {

45 
NVME_SC_INVALID_OPCODE
:

46 
NVME_SC_INVALID_FIELD
:

47 
NVME_SC_INVALID_NS
:

48 
NVME_SC_LBA_RANGE
:

49 
NVME_SC_CAP_EXCEEDED
:

50 
NVME_SC_RESERVATION_CONFLICT
:

51  
çl£
;

57 
NVME_SC_BAD_ATTRIBUTES
:

58 
NVME_SC_INVALID_PI
:

59 
NVME_SC_READ_ONLY
:

60 
NVME_SC_ONCS_NOT_SUPPORTED
:

61 
	`WARN_ON_ONCE
(
	`nvme_»q
(
»q
)->
cmd
->
commÚ
.
İcode
 ==

62 
nvme_çbrics_commªd
);

63  
çl£
;

68 
NVME_SC_WRITE_FAULT
:

69 
NVME_SC_READ_ERROR
:

70 
NVME_SC_GUARD_CHECK
:

71 
NVME_SC_APPTAG_CHECK
:

72 
NVME_SC_REFTAG_CHECK
:

73 
NVME_SC_COMPARE_FAILED
:

74 
NVME_SC_ACCESS_DENIED
:

75 
NVME_SC_UNWRITTEN_BLOCK
:

76  
çl£
;

80  
Œue
;

81 
	}
}

83 
	$nvme_kick_»queue_li¡s
(
nvme_ù¾
 *
ù¾
)

85 
nvme_ns
 *
ns
;

87 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

88 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

89 ià(
ns
->
h—d
->
disk
)

90 
	`kblockd_scheduË_wÜk
(&
ns
->
h—d
->
»queue_wÜk
);

92 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

93 
	}
}

95 
nvme_ns
 *
	$__nvme_fšd_·th
(
nvme_ns_h—d
 *
h—d
)

97 
nvme_ns
 *
ns
;

99 
	`li¡_fÜ_—ch_’Œy_rcu
(
ns
, &
h—d
->
li¡
, 
siblšgs
) {

100 ià(
ns
->
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
) {

101 
	`rcu_assign_poš‹r
(
h—d
->
cu¼’t_·th
, 
ns
);

102  
ns
;

106  
NULL
;

107 
	}
}

109 
šlše
 
nvme_ns
 *
	$nvme_fšd_·th
(
nvme_ns_h—d
 *
h—d
)

111 
nvme_ns
 *
ns
 = 
	`¤cu_d”eã»nû
(
h—d
->
cu¼’t_·th
, &h—d->
¤cu
);

113 ià(
	`uÆik–y
(!
ns
 ||‚s->
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
))

114 
ns
 = 
	`__nvme_fšd_·th
(
h—d
);

115  
ns
;

116 
	}
}

118 
blk_qc_t
 
	$nvme_ns_h—d_make_»que¡
(
»que¡_queue
 *
q
,

119 
bio
 *bio)

121 
nvme_ns_h—d
 *
h—d
 = 
q
->
queued©a
;

122 
deviû
 *
dev
 = 
	`disk_to_dev
(
h—d
->
disk
);

123 
nvme_ns
 *
ns
;

124 
blk_qc_t
 
»t
 = 
BLK_QC_T_NONE
;

125 
¤cu_idx
;

127 
¤cu_idx
 = 
	`¤cu_»ad_lock
(&
h—d
->
¤cu
);

128 
ns
 = 
	`nvme_fšd_·th
(
h—d
);

129 ià(
	`lik–y
(
ns
)) {

130 
bio
->
bi_disk
 = 
ns
->
disk
;

131 
bio
->
bi_İf
 |ğ
REQ_NVME_MPATH
;

132 
»t
 = 
	`dœeù_make_»que¡
(
bio
);

133 } ià(!
	`li¡_em±y_ÿ»ful
(&
h—d
->
li¡
)) {

134 
	`dev_w¬n_¿‹lim™ed
(
dev
, "no…ath‡vailable -„equeuing I/O\n");

136 
	`¥š_lock_œq
(&
h—d
->
»queue_lock
);

137 
	`bio_li¡_add
(&
h—d
->
»queue_li¡
, 
bio
);

138 
	`¥š_uÆock_œq
(&
h—d
->
»queue_lock
);

140 
	`dev_w¬n_¿‹lim™ed
(
dev
, "no…ath - failing I/O\n");

142 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

143 
	`bio_’dio
(
bio
);

146 
	`¤cu_»ad_uÆock
(&
h—d
->
¤cu
, 
¤cu_idx
);

147  
»t
;

148 
	}
}

150 
boŞ
 
	$nvme_ns_h—d_pŞl
(
»que¡_queue
 *
q
, 
blk_qc_t
 
qc
)

152 
nvme_ns_h—d
 *
h—d
 = 
q
->
queued©a
;

153 
nvme_ns
 *
ns
;

154 
boŞ
 
found
 = 
çl£
;

155 
¤cu_idx
;

157 
¤cu_idx
 = 
	`¤cu_»ad_lock
(&
h—d
->
¤cu
);

158 
ns
 = 
	`¤cu_d”eã»nû
(
h—d
->
cu¼’t_·th
, &h—d->
¤cu
);

159 ià(
	`lik–y
(
ns
 &&‚s->
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
))

160 
found
 = 
ns
->
queue
->
	`pŞl_â
(
q
, 
qc
);

161 
	`¤cu_»ad_uÆock
(&
h—d
->
¤cu
, 
¤cu_idx
);

162  
found
;

163 
	}
}

165 
	$nvme_»queue_wÜk
(
wÜk_¡ruù
 *
wÜk
)

167 
nvme_ns_h—d
 *
h—d
 =

168 
	`cÚš”_of
(
wÜk
, 
nvme_ns_h—d
, 
»queue_wÜk
);

169 
bio
 *bio, *
Ãxt
;

171 
	`¥š_lock_œq
(&
h—d
->
»queue_lock
);

172 
Ãxt
 = 
	`bio_li¡_g‘
(&
h—d
->
»queue_li¡
);

173 
	`¥š_uÆock_œq
(&
h—d
->
»queue_lock
);

175 (
bio
 = 
Ãxt
è!ğ
NULL
) {

176 
Ãxt
 = 
bio
->
bi_Ãxt
;

177 
bio
->
bi_Ãxt
 = 
NULL
;

183 
bio
->
bi_disk
 = 
h—d
->
disk
;

184 
	`g’”ic_make_»que¡
(
bio
);

186 
	}
}

188 
	$nvme_m·th_®loc_disk
(
nvme_ù¾
 *
ù¾
, 
nvme_ns_h—d
 *
h—d
)

190 
»que¡_queue
 *
q
;

191 
boŞ
 
vwc
 = 
çl£
;

193 
	`bio_li¡_š™
(&
h—d
->
»queue_li¡
);

194 
	`¥š_lock_š™
(&
h—d
->
»queue_lock
);

195 
	`INIT_WORK
(&
h—d
->
»queue_wÜk
, 
nvme_»queue_wÜk
);

202 ià(!(
ù¾
->
subsys
->
cmic
 & (1 << 1)è|| !
muÉ©h
)

205 
q
 = 
	`blk_®loc_queue_node
(
GFP_KERNEL
, 
NUMA_NO_NODE
);

206 ià(!
q
)

207 
out
;

208 
q
->
queued©a
 = 
h—d
;

209 
	`blk_queue_make_»que¡
(
q
, 
nvme_ns_h—d_make_»que¡
);

210 
q
->
pŞl_â
 = 
nvme_ns_h—d_pŞl
;

211 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
q
);

213 
	`blk_queue_logiÿl_block_size
(
q
, 512);

216 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

217 
vwc
 = 
Œue
;

218 
	`blk_queue_wr™e_ÿche
(
q
, 
vwc
, vwc);

220 
h—d
->
disk
 = 
	`®loc_disk
(0);

221 ià(!
h—d
->
disk
)

222 
out_ş—nup_queue
;

223 
h—d
->
disk
->
fİs
 = &
nvme_ns_h—d_İs
;

224 
h—d
->
disk
->
´iv©e_d©a
 = head;

225 
h—d
->
disk
->
queue
 = 
q
;

226 
h—d
->
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

227 
	`¥rštf
(
h—d
->
disk
->
disk_Çme
, "nvme%dn%d",

228 
ù¾
->
subsys
->
š¡ªû
, 
h—d
->instance);

231 
out_ş—nup_queue
:

232 
	`blk_ş—nup_queue
(
q
);

233 
out
:

234  -
ENOMEM
;

235 
	}
}

237 
	$nvme_m·th_add_disk
(
nvme_ns_h—d
 *
h—d
)

239 ià(!
h—d
->
disk
)

241 
	`deviû_add_disk
(&
h—d
->
subsys
->
dev
, h—d->
disk
);

242 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
h—d
->
disk
)->
kobj
,

243 &
nvme_ns_id_©Œ_group
))

244 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

245 
h—d
->
disk
->
disk_Çme
);

246 
	}
}

248 
	$nvme_m·th_»move_disk
(
nvme_ns_h—d
 *
h—d
)

250 ià(!
h—d
->
disk
)

252 
	`sysfs_»move_group
(&
	`disk_to_dev
(
h—d
->
disk
)->
kobj
,

253 &
nvme_ns_id_©Œ_group
);

254 
	`d–_g’disk
(
h—d
->
disk
);

255 
	`blk_£t_queue_dyšg
(
h—d
->
disk
->
queue
);

257 
	`kblockd_scheduË_wÜk
(&
h—d
->
»queue_wÜk
);

258 
	`æush_wÜk
(&
h—d
->
»queue_wÜk
);

259 
	`blk_ş—nup_queue
(
h—d
->
disk
->
queue
);

260 
	`put_disk
(
h—d
->
disk
);

261 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/nvme.h

14 #iâdeà
_NVME_H


15 
	#_NVME_H


	)

20 
	#KSID_SUPPORT


	)

23 
	~"lšux_nvme.h
"

24 
	~<lšux/cdev.h
>

25 
	~<lšux/pci.h
>

26 
	~<lšux/k»f.h
>

27 
	~<lšux/blk-mq.h
>

28 
	~<lšux/lighŠvm.h
>

29 
	~<lšux/£d-İ®.h
>

32 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

33 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

34 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

35 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

36 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

37 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

38 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

39 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

40 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

41 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

42 
	`is_kv_exi¡_cmd
(
İcode
))

	)

46 
nvme_io_timeout
;

47 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

49 
admš_timeout
;

50 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

52 
	#NVME_DEFAULT_KATO
 5

	)

53 
	#NVME_KATO_GRACE
 10

	)

55 
wÜkqueue_¡ruù
 *
nvme_wq
;

58 
	mNVME_NS_LBA
 = 0,

59 
	mNVME_NS_LIGHTNVM
 = 1,

66 
	envme_quœks
 {

71 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

77 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

83 
	mNVME_QUIRK_DEALLOCATE_ZEROES
 = (1 << 2),

89 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

94 
	mNVME_QUIRK_NO_APST
 = (1 << 4),

99 
	mNVME_QUIRK_NO_DEEPEST_PS
 = (1 << 5),

104 
	mNVME_QUIRK_LIGHTNVM
 = (1 << 6),

111 
	snvme_»que¡
 {

112 
nvme_commªd
 *
	mcmd
;

113 
nvme_»suÉ
 
	m»suÉ
;

114 
u8
 
	m»Œ›s
;

115 
u8
 
	mæags
;

116 
u16
 
	m¡©us
;

120 
	snvme_io_·¿m
 {

121 
nvme_»que¡
 
	m»q
;

122 
sÿ‰”li¡
* 
	mkv_d©a_sg_±r
;

123 
sÿ‰”li¡
* 
	mkv_m‘a_sg_±r
;

124 
	mkv_d©a_ÃÁs
;

125 
	mkv_d©a_Ën
;

128 
šlše
 
nvme_io_·¿m
 *
	$nvme_io_·¿m
(
»que¡
 *
»q
)

130  
	`blk_mq_rq_to_pdu
(
»q
);

131 
	}
}

138 
	#REQ_NVME_MPATH
 
REQ_DRV


	)

141 
	mNVME_REQ_CANCELLED
 = (1 << 0),

144 
šlše
 
nvme_»que¡
 *
	$nvme_»q
(
»que¡
 *
»q
)

146  
	`blk_mq_rq_to_pdu
(
»q
);

147 
	}
}

154 
	#NVME_QUIRK_DELAY_AMOUNT
 2300

	)

156 
	envme_ù¾_¡©e
 {

157 
	mNVME_CTRL_NEW
,

158 
	mNVME_CTRL_LIVE
,

159 
	mNVME_CTRL_RESETTING
,

160 
	mNVME_CTRL_RECONNECTING
,

161 
	mNVME_CTRL_DELETING
,

162 
	mNVME_CTRL_DEAD
,

165 
	snvme_ù¾
 {

166 
nvme_ù¾_¡©e
 
	m¡©e
;

167 
boŞ
 
	mid’tif›d
;

168 
¥šlock_t
 
	mlock
;

169 cÚ¡ 
nvme_ù¾_İs
 *
	mİs
;

170 
»que¡_queue
 *
	madmš_q
;

171 
»que¡_queue
 *
	mcÚÃù_q
;

172 
deviû
 *
	mdev
;

173 
	mš¡ªû
;

174 
blk_mq_g_£t
 *
	mg£t
;

175 
blk_mq_g_£t
 *
	madmš_g£t
;

176 
li¡_h—d
 
	mÇme¥aûs
;

177 
mu‹x
 
	mÇme¥aûs_mu‹x
;

178 
deviû
 
	mù¾_deviû
;

179 
deviû
 *
	mdeviû
;

180 
cdev
 
	mcdev
;

181 
wÜk_¡ruù
 
	m»£t_wÜk
;

182 
wÜk_¡ruù
 
	md–‘e_wÜk
;

184 
nvme_subsy¡em
 *
	msubsys
;

185 
li¡_h—d
 
	msubsys_’Œy
;

187 
İ®_dev
 *
	mİ®_dev
;

189 
	mÇme
[12];

190 
u16
 
	múid
;

192 
u32
 
	mù¾_cÚfig
;

193 
u16
 
	mmtç
;

194 
u32
 
	mqueue_couÁ
;

196 
u64
 
	mÿp
;

197 
u32
 
	m·ge_size
;

198 
u32
 
	mmax_hw_£ùÜs
;

199 
u16
 
	mÚcs
;

200 
u16
 
	mßcs
;

201 
u16
 
	mns§
;

202 
u16
 
	mÄ_¡»ams
;

203 
©omic_t
 
	mabÜt_lim™
;

204 
u8
 
	mvwc
;

205 
u32
 
	mvs
;

206 
u32
 
	msgls
;

207 
u16
 
	mkas
;

208 
u8
 
	mÅss
;

209 
u8
 
	m­¡a
;

210 
u32
 
	m«n_»suÉ
;

211 
	mshutdown_timeout
;

212 
	mk©o
;

213 
boŞ
 
	msubsy¡em
;

214 
	mquœks
;

215 
nvme_id_pow”_¡©e
 
	mpsd
[32];

216 
nvme_efãùs_log
 *
	mefãùs
;

217 
wÜk_¡ruù
 
	msÿn_wÜk
;

218 
wÜk_¡ruù
 
	masync_ev’t_wÜk
;

219 
d–ayed_wÜk
 
	mka_wÜk
;

220 
wÜk_¡ruù
 
	mfw_aù_wÜk
;

223 
u64
 
	mps_max_Ï‹ncy_us
;

224 
boŞ
 
	m­¡_’abËd
;

227 
u32
 
	mhm´e
;

228 
u32
 
	mhmmš
;

229 
u32
 
	mhmmšds
;

230 
u16
 
	mhmmaxd
;

233 
u16
 
	msqsize
;

234 
u32
 
	mioccsz
;

235 
u32
 
	miÜcsz
;

236 
u16
 
	micdoff
;

237 
u16
 
	mmaxcmd
;

238 
	mÄ_»cÚÃùs
;

239 
nvmf_ù¾_İtiÚs
 *
	mİts
;

242 
	snvme_subsy¡em
 {

243 
	mš¡ªû
;

244 
deviû
 
	mdev
;

249 
k»f
 
	m»f
;

250 
li¡_h—d
 
	m’Œy
;

251 
mu‹x
 
	mlock
;

252 
li¡_h—d
 
	mù¾s
;

253 
li¡_h—d
 
	mnsh—ds
;

254 
	msubnqn
[
NVMF_NQN_SIZE
];

255 
	m£rŸl
[20];

256 
	mmod–
[40];

257 
	mfœmw¬e_»v
[8];

258 
u8
 
	mcmic
;

259 
u16
 
	mv’dÜ_id
;

260 
ida
 
	mns_ida
;

266 
	snvme_ns_ids
 {

267 
u8
 
	meui64
[8];

268 
u8
 
	mnguid
[16];

269 
uuid_t
 
	muuid
;

279 
	snvme_ns_h—d
 {

280 #ifdeà
CONFIG_NVME_MULTIPATH


281 
g’disk
 *
	mdisk
;

282 
nvme_ns
 
__rcu
 *
	mcu¼’t_·th
;

283 
bio_li¡
 
	m»queue_li¡
;

284 
¥šlock_t
 
	m»queue_lock
;

285 
wÜk_¡ruù
 
	m»queue_wÜk
;

287 
li¡_h—d
 
	mli¡
;

288 
¤cu_¡ruù
 
	m¤cu
;

289 
nvme_subsy¡em
 *
	msubsys
;

290 
	mns_id
;

291 
nvme_ns_ids
 
	mids
;

292 
li¡_h—d
 
	m’Œy
;

293 
k»f
 
	m»f
;

294 
	mš¡ªû
;

297 
	snvme_ns
 {

298 
li¡_h—d
 
	mli¡
;

300 
nvme_ù¾
 *
	mù¾
;

301 
»que¡_queue
 *
	mqueue
;

302 
g’disk
 *
	mdisk
;

303 
li¡_h—d
 
	msiblšgs
;

304 
nvm_dev
 *
	mndev
;

305 
k»f
 
	mk»f
;

306 
nvme_ns_h—d
 *
	mh—d
;

308 
	mlba_shiá
;

309 
u16
 
	mms
;

310 
u16
 
	msgs
;

311 
u32
 
	msws
;

312 
boŞ
 
	mext
;

313 
u8
 
	mpi_ty³
;

314 
	mæags
;

315 
	#NVME_NS_REMOVING
 0

	)

316 
	#NVME_NS_DEAD
 1

	)

317 
u16
 
	mnoiob
;

320 
	snvme_ù¾_İs
 {

321 cÚ¡ *
	mÇme
;

322 
moduË
 *
	mmoduË
;

323 
	mæags
;

324 
	#NVME_F_FABRICS
 (1 << 0)

	)

325 
	#NVME_F_METADATA_SUPPORTED
 (1 << 1)

	)

326 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

327 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

328 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

329 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

330 (*
	msubm™_async_ev’t
)(
nvme_ù¾
 *
	mù¾
);

331 (*
	md–‘e_ù¾
)(
nvme_ù¾
 *
	mù¾
);

332 (*
	mg‘_add»ss
)(
nvme_ù¾
 *
	mù¾
, *
	mbuf
, 
	msize
);

333 (*
	m»š™_»que¡
)(*
	md©a
, 
»que¡
 *
	mrq
);

336 
šlše
 
boŞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

338 
u32
 
v®
 = 0;

340 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

341  
çl£
;

342  
v®
 & 
NVME_CSTS_RDY
;

343 
	}
}

345 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

347 ià(!
ù¾
->
subsy¡em
)

348  -
ENOTTY
;

349  
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

350 
	}
}

352 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

354  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

355 
	}
}

357 
šlše
 
	$nvme_ş—nup_cmd
(
»que¡
 *
»q
)

359 ià(
»q
->
rq_æags
 & 
RQF_SPECIAL_PAYLOAD
) {

360 
	`kä“
(
	`·ge_add»ss
(
»q
->
¥ecŸl_vec
.
bv_·ge
) +

361 
»q
->
¥ecŸl_vec
.
bv_off£t
);

363 
	}
}

365 
šlše
 
	$nvme_’d_»que¡
(
»que¡
 *
»q
, 
__Ë16
 
¡©us
,

366 
nvme_»suÉ
 
»suÉ
)

368 
nvme_»que¡
 *
rq
 = 
	`nvme_»q
(
»q
);

370 
rq
->
¡©us
 = 
	`Ë16_to_ıu
(status) >> 1;

371 
rq
->
»suÉ
 =„esult;

372 
	`blk_mq_com¶‘e_»que¡
(
»q
);

373 
	}
}

375 
šlše
 
	$nvme_g‘_ù¾
(
nvme_ù¾
 *
ù¾
)

377 
	`g‘_deviû
(
ù¾
->
deviû
);

378 
	}
}

380 
šlše
 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

382 
	`put_deviû
(
ù¾
->
deviû
);

383 
	}
}

385 
nvme_com¶‘e_rq
(
»que¡
 *
»q
);

386 
nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
);

387 
boŞ
 
nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

388 
nvme_ù¾_¡©e
 
Ãw_¡©e
);

389 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

390 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

391 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

392 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

393 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
);

394 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

395 
nvme_¡¬t_ù¾
(
nvme_ù¾
 *
ù¾
);

396 
nvme_¡İ_ù¾
(
nvme_ù¾
 *
ù¾
);

397 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

398 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

400 
nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
);

401 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

403 
nvme_£c_subm™
(*
d©a
, 
u16
 
¥¥
, 
u8
 
£ı
, *
bufãr
, 
size_t
 
Ën
,

404 
boŞ
 
£nd
);

406 
nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
__Ë16
 
¡©us
,

407 
nvme_»suÉ
 *
»s
);

409 
nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
);

410 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

411 
nvme_kl_queues
(
nvme_ù¾
 *
ù¾
);

412 
nvme_unä“ze
(
nvme_ù¾
 *
ù¾
);

413 
nvme_wa™_ä“ze
(
nvme_ù¾
 *
ù¾
);

414 
nvme_wa™_ä“ze_timeout
(
nvme_ù¾
 *
ù¾
, 
timeout
);

415 
nvme_¡¬t_ä“ze
(
nvme_ù¾
 *
ù¾
);

416 
nvme_»š™_g£t
(
nvme_ù¾
 *
ù¾
, 
blk_mq_g_£t
 *
£t
);

418 
	#NVME_QID_ANY
 -1

	)

419 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

420 
nvme_commªd
 *
cmd
, 
blk_mq_»q_æags_t
 
æags
, 
qid
);

421 
blk_¡©us_t
 
nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

422 
nvme_commªd
 *
cmd
);

423 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

424 *
buf
, 
bufæ’
);

425 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

426 
nvme_»suÉ
 *
»suÉ
, *
bufãr
, 
bufæ’
,

427 
timeout
, 
qid
, 
©_h—d
,

428 
blk_mq_»q_æags_t
 
æags
);

429 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

430 
nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

431 
nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

432 
nvme_»£t_ù¾
(
nvme_ù¾
 *
ù¾
);

433 
nvme_d–‘e_ù¾
(
nvme_ù¾
 *
ù¾
);

434 
nvme_d–‘e_ù¾_sync
(
nvme_ù¾
 *
ù¾
);

436 cÚ¡ 
©Œibu‹_group
 
nvme_ns_id_©Œ_group
;

437 cÚ¡ 
block_deviû_İ”©iÚs
 
nvme_ns_h—d_İs
;

439 #ifdeà
CONFIG_NVME_MULTIPATH


440 
nvme_çov”_»q
(
»que¡
 *
»q
);

441 
boŞ
 
nvme_»q_Ãeds_çov”
(
»que¡
 *
»q
);

442 
nvme_kick_»queue_li¡s
(
nvme_ù¾
 *
ù¾
);

443 
nvme_m·th_®loc_disk
(
nvme_ù¾
 *
ù¾
,
nvme_ns_h—d
 *
h—d
);

444 
nvme_m·th_add_disk
(
nvme_ns_h—d
 *
h—d
);

445 
nvme_m·th_»move_disk
(
nvme_ns_h—d
 *
h—d
);

447 
šlše
 
	$nvme_m·th_ş—r_cu¼’t_·th
(
nvme_ns
 *
ns
)

449 
nvme_ns_h—d
 *
h—d
 = 
ns
->head;

451 ià(
h—d
 && 
ns
 =ğ
	`¤cu_d”eã»nû
(h—d->
cu¼’t_·th
, &h—d->
¤cu
))

452 
	`rcu_assign_poš‹r
(
h—d
->
cu¼’t_·th
, 
NULL
);

453 
	}
}

454 
nvme_ns
 *
nvme_fšd_·th
(
nvme_ns_h—d
 *
h—d
);

456 
šlše
 
	$nvme_m·th_check_Ï¡_·th
(
nvme_ns
 *
ns
)

458 
nvme_ns_h—d
 *
h—d
 = 
ns
->head;

460 ià(
h—d
->
disk
 && 
	`li¡_em±y
(&h—d->
li¡
))

461 
	`kblockd_scheduË_wÜk
(&
h—d
->
»queue_wÜk
);

462 
	}
}

465 
šlše
 
	$nvme_çov”_»q
(
»que¡
 *
»q
)

467 
	}
}

468 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_çov”
(
»que¡
 *
»q
)

470  
çl£
;

471 
	}
}

472 
šlše
 
	$nvme_kick_»queue_li¡s
(
nvme_ù¾
 *
ù¾
)

474 
	}
}

475 
šlše
 
	$nvme_m·th_®loc_disk
(
nvme_ù¾
 *
ù¾
,

476 
nvme_ns_h—d
 *
h—d
)

479 
	}
}

480 
šlše
 
	$nvme_m·th_add_disk
(
nvme_ns_h—d
 *
h—d
)

482 
	}
}

483 
šlše
 
	$nvme_m·th_»move_disk
(
nvme_ns_h—d
 *
h—d
)

485 
	}
}

486 
šlše
 
	$nvme_m·th_ş—r_cu¼’t_·th
(
nvme_ns
 *
ns
)

488 
	}
}

489 
šlše
 
	$nvme_m·th_check_Ï¡_·th
(
nvme_ns
 *
ns
)

491 
	}
}

494 #ifdeà
CONFIG_NVM


495 
nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
);

496 
nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
);

497 
nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
);

498 
nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
);

499 
nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
, 
¬g
);

501 
šlše
 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
,

502 
node
)

505 
	}
}

507 
šlše
 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
è{
	}
};

508 
šlše
 
	$nvme_nvm_»gi¡”_sysfs
(
nvme_ns
 *
ns
)

511 
	}
}

512 
šlše
 
	$nvme_nvm_uÄegi¡”_sysfs
(
nvme_ns
 *
ns
è{
	}
};

513 
šlše
 
	$nvme_nvm_ioùl
(
nvme_ns
 *
ns
, 
cmd
,

514 
¬g
)

516  -
ENOTTY
;

517 
	}
}

520 
šlše
 
nvme_ns
 *
	$nvme_g‘_ns_äom_dev
(
deviû
 *
dev
)

522  
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

523 
	}
}

525 
__š™
 
nvme_cÜe_š™
();

526 
nvme_cÜe_ex™
();

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/blkdev.h
>

17 
	~<lšux/blk-mq.h
>

18 
	~<lšux/blk-mq-pci.h
>

19 
	~<lšux/dmi.h
>

20 
	~<lšux/š™.h
>

21 
	~<lšux/š‹¼u±.h
>

22 
	~<lšux/io.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/moduË.h
>

25 
	~<lšux/mu‹x.h
>

26 
	~<lšux/Úû.h
>

27 
	~<lšux/pci.h
>

28 
	~<lšux/t10-pi.h
>

29 
	~<lšux/ty³s.h
>

30 
	~<lšux/io-64-nÚ©omic-lo-hi.h
>

31 
	~<lšux/£d-İ®.h
>

33 
	~"nvme.h
"

35 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

36 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

38 
	#SGES_PER_PAGE
 (
PAGE_SIZE
 / (
nvme_sgl_desc
))

	)

40 
	gu£_th»aded_š‹¼u±s
;

41 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

43 
boŞ
 
	gu£_cmb_sqes
 = 
Œue
;

44 
moduË_·¿m
(
u£_cmb_sqes
, 
boŞ
, 0644);

45 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

47 
	gmax_ho¡_mem_size_mb
 = 128;

48 
moduË_·¿m
(
max_ho¡_mem_size_mb
, 
ušt
, 0444);

49 
MODULE_PARM_DESC
(
max_ho¡_mem_size_mb
,

52 
	gsgl_th»shŞd
 = 
SZ_32K
;

53 
moduË_·¿m
(
sgl_th»shŞd
, 
ušt
, 0644);

54 
MODULE_PARM_DESC
(
sgl_th»shŞd
,

58 
io_queue_d•th_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
);

59 cÚ¡ 
k”Ãl_·¿m_İs
 
	gio_queue_d•th_İs
 = {

60 .
£t
 = 
io_queue_d•th_£t
,

61 .
	gg‘
 = 
·¿m_g‘_št
,

64 
	gio_queue_d•th
 = 1024;

65 
moduË_·¿m_cb
(
io_queue_d•th
, &
io_queue_d•th_İs
, &io_queue_depth, 0644);

66 
MODULE_PARM_DESC
(
io_queue_d•th
, "set io queue depth, should >= 2");

68 
	gnvme_dev
;

69 
	gnvme_queue
;

71 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

72 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
);

77 
	snvme_dev
 {

78 
nvme_queue
 **
	mqueues
;

79 
blk_mq_g_£t
 
	mg£t
;

80 
blk_mq_g_£t
 
	madmš_g£t
;

81 
u32
 
__iomem
 *
	mdbs
;

82 
deviû
 *
	mdev
;

83 
dma_poŞ
 *
	m´p_·ge_poŞ
;

84 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

85 
	mÚlše_queues
;

86 
	mmax_qid
;

87 
	mq_d•th
;

88 
u32
 
	mdb_¡ride
;

89 
__iomem
 *
	mb¬
;

90 
	mb¬_m­³d_size
;

91 
wÜk_¡ruù
 
	m»move_wÜk
;

92 
mu‹x
 
	mshutdown_lock
;

93 
boŞ
 
	msubsy¡em
;

94 
__iomem
 *
	mcmb
;

95 
pci_bus_addr_t
 
	mcmb_bus_addr
;

96 
u64
 
	mcmb_size
;

97 
u32
 
	mcmbsz
;

98 
u32
 
	mcmbloc
;

99 
nvme_ù¾
 
	mù¾
;

100 
com¶‘iÚ
 
	mioq_wa™
;

103 
u32
 *
	mdbbuf_dbs
;

104 
dma_addr_t
 
	mdbbuf_dbs_dma_addr
;

105 
u32
 *
	mdbbuf_eis
;

106 
dma_addr_t
 
	mdbbuf_eis_dma_addr
;

109 
u64
 
	mho¡_mem_size
;

110 
u32
 
	mÄ_ho¡_mem_descs
;

111 
dma_addr_t
 
	mho¡_mem_descs_dma
;

112 
nvme_ho¡_mem_buf_desc
 *
	mho¡_mem_descs
;

113 **
	mho¡_mem_desc_bufs
;

116 
	$io_queue_d•th_£t
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

118 
n
 = 0, 
»t
;

120 
»t
 = 
	`k¡¹ošt
(
v®
, 10, &
n
);

121 ià(
»t
 !ğ0 || 
n
 < 2)

122  -
EINVAL
;

124  
	`·¿m_£t_št
(
v®
, 
kp
);

125 
	}
}

127 
šlše
 
	$sq_idx
(
qid
, 
u32
 
¡ride
)

129  
qid
 * 2 * 
¡ride
;

130 
	}
}

132 
šlše
 
	$cq_idx
(
qid
, 
u32
 
¡ride
)

134  (
qid
 * 2 + 1è* 
¡ride
;

135 
	}
}

137 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

139  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

140 
	}
}

146 
	snvme_queue
 {

147 
deviû
 *
	mq_dmadev
;

148 
nvme_dev
 *
	mdev
;

149 
¥šlock_t
 
	mq_lock
;

150 
nvme_commªd
 *
	msq_cmds
;

151 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

152 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

153 
blk_mq_gs
 **
	mgs
;

154 
dma_addr_t
 
	msq_dma_addr
;

155 
dma_addr_t
 
	mcq_dma_addr
;

156 
u32
 
__iomem
 *
	mq_db
;

157 
u16
 
	mq_d•th
;

158 
s16
 
	mcq_veùÜ
;

159 
u16
 
	msq_
;

160 
u16
 
	mcq_h—d
;

161 
u16
 
	mqid
;

162 
u8
 
	mcq_pha£
;

163 
u8
 
	mcqe_£’
;

164 
u32
 *
	mdbbuf_sq_db
;

165 
u32
 *
	mdbbuf_cq_db
;

166 
u32
 *
	mdbbuf_sq_ei
;

167 
u32
 *
	mdbbuf_cq_ei
;

176 
	snvme_iod
 {

178 
nvme_io_·¿m
 
	m·¿m
;

180 
nvme_»que¡
 
	m»q
;

182 
nvme_queue
 *
	mnvmeq
;

184 
	mkv_cmd
;

185 
	mr£rv
;

187 
boŞ
 
	mu£_sgl
;

188 
	mabÜ‹d
;

189 
	mÅages
;

190 
	mÃÁs
;

191 
	mËngth
;

192 
dma_addr_t
 
	mfœ¡_dma
;

193 
sÿ‰”li¡
 
	mm‘a_sg
;

194 
sÿ‰”li¡
 *
	msg
;

195 
sÿ‰”li¡
 
	mšlše_sg
[0];

201 
šlše
 
	$_nvme_check_size
()

203 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

204 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

205 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

206 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

207 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

208 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

209 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

210 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

211 
	`BUILD_BUG_ON
((
nvme_id_ù¾
è!ğ
NVME_IDENTIFY_DATA_SIZE
);

212 
	`BUILD_BUG_ON
((
nvme_id_ns
è!ğ
NVME_IDENTIFY_DATA_SIZE
);

213 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

214 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

215 
	`BUILD_BUG_ON
((
nvme_dbbuf
) != 64);

216 
	}
}

218 
šlše
 
	$nvme_dbbuf_size
(
u32
 
¡ride
)

220  ((
	`num_possibË_ıus
(è+ 1è* 8 * 
¡ride
);

221 
	}
}

223 
	$nvme_dbbuf_dma_®loc
(
nvme_dev
 *
dev
)

225 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_¡ride
);

227 ià(
dev
->
dbbuf_dbs
)

230 
dev
->
dbbuf_dbs
 = 
	`dma_®loc_coh”’t
(dev->dev, 
mem_size
,

231 &
dev
->
dbbuf_dbs_dma_addr
,

232 
GFP_KERNEL
);

233 ià(!
dev
->
dbbuf_dbs
)

234  -
ENOMEM
;

235 
dev
->
dbbuf_eis
 = 
	`dma_®loc_coh”’t
(dev->dev, 
mem_size
,

236 &
dev
->
dbbuf_eis_dma_addr
,

237 
GFP_KERNEL
);

238 ià(!
dev
->
dbbuf_eis
) {

239 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

240 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

241 
dev
->
dbbuf_dbs
 = 
NULL
;

242  -
ENOMEM
;

246 
	}
}

248 
	$nvme_dbbuf_dma_ä“
(
nvme_dev
 *
dev
)

250 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_¡ride
);

252 ià(
dev
->
dbbuf_dbs
) {

253 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

254 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

255 
dev
->
dbbuf_dbs
 = 
NULL
;

257 ià(
dev
->
dbbuf_eis
) {

258 
	`dma_ä“_coh”’t
(
dev
->dev, 
mem_size
,

259 
dev
->
dbbuf_eis
, dev->
dbbuf_eis_dma_addr
);

260 
dev
->
dbbuf_eis
 = 
NULL
;

262 
	}
}

264 
	$nvme_dbbuf_š™
(
nvme_dev
 *
dev
,

265 
nvme_queue
 *
nvmeq
, 
qid
)

267 ià(!
dev
->
dbbuf_dbs
 || !
qid
)

270 
nvmeq
->
dbbuf_sq_db
 = &
dev
->
dbbuf_dbs
[
	`sq_idx
(
qid
, dev->
db_¡ride
)];

271 
nvmeq
->
dbbuf_cq_db
 = &
dev
->
dbbuf_dbs
[
	`cq_idx
(
qid
, dev->
db_¡ride
)];

272 
nvmeq
->
dbbuf_sq_ei
 = &
dev
->
dbbuf_eis
[
	`sq_idx
(
qid
, dev->
db_¡ride
)];

273 
nvmeq
->
dbbuf_cq_ei
 = &
dev
->
dbbuf_eis
[
	`cq_idx
(
qid
, dev->
db_¡ride
)];

274 
	}
}

276 
	$nvme_dbbuf_£t
(
nvme_dev
 *
dev
)

278 
nvme_commªd
 
c
;

280 ià(!
dev
->
dbbuf_dbs
)

283 
	`mem£t
(&
c
, 0, (c));

284 
c
.
dbbuf
.
İcode
 = 
nvme_admš_dbbuf
;

285 
c
.
dbbuf
.
´p1
 = 
	`ıu_to_Ë64
(
dev
->
dbbuf_dbs_dma_addr
);

286 
c
.
dbbuf
.
´p2
 = 
	`ıu_to_Ë64
(
dev
->
dbbuf_eis_dma_addr
);

288 ià(
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0)) {

289 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "unableo set dbbuf\n");

291 
	`nvme_dbbuf_dma_ä“
(
dev
);

293 
	}
}

295 
šlše
 
	$nvme_dbbuf_Ãed_ev’t
(
u16
 
ev’t_idx
, u16 
Ãw_idx
, u16 
Şd
)

297  (
u16
)(
Ãw_idx
 - 
ev’t_idx
 - 1è< (u16)Òew_idx - 
Şd
);

298 
	}
}

301 
boŞ
 
	$nvme_dbbuf_upd©e_ªd_check_ev’t
(
u16
 
v®ue
, 
u32
 *
dbbuf_db
,

302 vŞ©
u32
 *
dbbuf_ei
)

304 ià(
dbbuf_db
) {

305 
u16
 
Şd_v®ue
;

311 
	`wmb
();

313 
Şd_v®ue
 = *
dbbuf_db
;

314 *
dbbuf_db
 = 
v®ue
;

316 ià(!
	`nvme_dbbuf_Ãed_ev’t
(*
dbbuf_ei
, 
v®ue
, 
Şd_v®ue
))

317  
çl£
;

320  
Œue
;

321 
	}
}

326 
	#NVME_INT_PAGES
 2

	)

327 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

334 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

336 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

337 
dev
->
ù¾
.
·ge_size
);

338  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

339 
	}
}

345 
	$nvme_pci_Åages_sgl
(
num_£g
)

347  
	`DIV_ROUND_UP
(
num_£g
 * (
nvme_sgl_desc
), 
PAGE_SIZE
);

348 
	}
}

350 
	$nvme_pci_iod_®loc_size
(
nvme_dev
 *
dev
,

351 
size
, 
n£g
, 
boŞ
 
u£_sgl
)

353 
size_t
 
®loc_size
;

355 ià(
u£_sgl
)

356 
®loc_size
 = (
__Ë64
 *è* 
	`nvme_pci_Åages_sgl
(
n£g
);

358 
®loc_size
 = (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
);

360  
®loc_size
 + (
sÿ‰”li¡
è* 
n£g
;

361 
	}
}

363 
	$nvme_pci_cmd_size
(
nvme_dev
 *
dev
, 
boŞ
 
u£_sgl
)

365 
®loc_size
 = 
	`nvme_pci_iod_®loc_size
(
dev
,

366 
	`NVME_INT_BYTES
(
dev
), 
NVME_INT_PAGES
,

367 
u£_sgl
);

369  (
nvme_iod
è+ 
®loc_size
;

370 
	}
}

372 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

373 
hùx_idx
)

375 
nvme_dev
 *
dev
 = 
d©a
;

376 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

378 
	`WARN_ON
(
hùx_idx
 != 0);

379 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

380 
	`WARN_ON
(
nvmeq
->
gs
);

382 
hùx
->
driv”_d©a
 = 
nvmeq
;

383 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

385 
	}
}

387 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

389 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

391 
nvmeq
->
gs
 = 
NULL
;

392 
	}
}

394 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

395 
hùx_idx
)

397 
nvme_dev
 *
dev
 = 
d©a
;

398 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

400 ià(!
nvmeq
->
gs
)

401 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

403 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

404 
hùx
->
driv”_d©a
 = 
nvmeq
;

406 
	}
}

408 
	$nvme_š™_»que¡
(
blk_mq_g_£t
 *
£t
, 
»que¡
 *
»q
,

409 
hùx_idx
, 
numa_node
)

411 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

412 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

413 
queue_idx
 = (
£t
 =ğ&
dev
->
g£t
è? 
hùx_idx
 + 1 : 0;

414 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
queue_idx
];

416 
	`BUG_ON
(!
nvmeq
);

417 
iod
->
nvmeq
 =‚vmeq;

419 
	}
}

421 
	$nvme_pci_m­_queues
(
blk_mq_g_£t
 *
£t
)

423 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

425  
	`blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev));

426 
	}
}

435 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
,

436 
nvme_commªd
 *
cmd
)

438 
u16
 

 = 
nvmeq
->
sq_
;

440 ià(
nvmeq
->
sq_cmds_io
)

441 
	`memıy_toio
(&
nvmeq
->
sq_cmds_io
[

], 
cmd
, (*cmd));

443 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

445 ià(++

 =ğ
nvmeq
->
q_d•th
)

446 

 = 0;

447 ià(
	`nvme_dbbuf_upd©e_ªd_check_ev’t
(

, 
nvmeq
->
dbbuf_sq_db
,

448 
nvmeq
->
dbbuf_sq_ei
))

449 
	`wr™–
(

, 
nvmeq
->
q_db
);

450 
nvmeq
->
sq_
 = 

;

451 
	}
}

453 **
	$nvme_pci_iod_li¡
(
»que¡
 *
»q
)

455 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

456  (**)(
iod
->
sg
 + 
	`blk_rq_Ä_phys_£gm’ts
(
»q
));

457 
	}
}

459 
šlše
 
boŞ
 
	$__nvme_pci_u£_sgls
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
, 
boŞ
 
kv_cmd
)

461 
šlše
 
boŞ
 
	$nvme_pci_u£_sgls
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

464 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

466 
n£g
;

468 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
»q
);

470 
avg_£g_size
;

472 ià(
kv_cmd
) {

473 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

474 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

475 ià(
n£g
 == 0)

476  
çl£
;

477 
avg_£g_size
 = 
	`DIV_ROUND_UP
(
·¿m
->
kv_d©a_Ën
, 
n£g
);

479 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
»q
);

480 ià(
n£g
 == 0)

481  
çl£
;

482 
avg_£g_size
 = 
	`DIV_ROUND_UP
(
	`blk_rq_·ylßd_by‹s
(
»q
), 
n£g
);

485 ià(
n£g
 == 0)

486  
çl£
;

487 
avg_£g_size
 = 
	`DIV_ROUND_UP
(
	`blk_rq_·ylßd_by‹s
(
»q
), 
n£g
);

489 ià(!(
dev
->
ù¾
.
sgls
 & ((1 << 0) | (1 << 1))))

490  
çl£
;

491 ià(!
iod
->
nvmeq
->
qid
)

492  
çl£
;

493 ià(!
sgl_th»shŞd
 || 
avg_£g_size
 < sgl_threshold)

494  
çl£
;

495  
Œue
;

496 
	}
}

499 
šlše
 
boŞ
 
	$nvme_pci_u£_sgls
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

501  
	`__nvme_pci_u£_sgls
(
dev
, 
»q
, 
çl£
);

502 
	}
}

504 
šlše
 
boŞ
 
	$nvme_pci_u£_sgls_fÜ_kv
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

506  
	`__nvme_pci_u£_sgls
(
dev
, 
»q
, 
Œue
);

507 
	}
}

513 
blk_¡©us_t
 
	$__nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
, 
boŞ
 
kv_cmd
)

515 
blk_¡©us_t
 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

518 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

520 
n£g
;

521 
size
;

523 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
rq
);

524 
size
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

527 ià(
kv_cmd
) {

528 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

529 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

530 
size
 = 
·¿m
->
kv_d©a_Ën
;

531 
iod
->
u£_sgl
 = 
	`nvme_pci_u£_sgls_fÜ_kv
(
dev
, 
rq
);

533 
n£g
 = 
	`blk_rq_Ä_phys_£gm’ts
(
rq
);

534 
size
 = 
	`blk_rq_·ylßd_by‹s
(
rq
);

535 
iod
->
u£_sgl
 = 
	`nvme_pci_u£_sgls
(
dev
, 
rq
);

538 
iod
->
u£_sgl
 = 
	`nvme_pci_u£_sgls
(
dev
, 
rq
);

540 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

541 
size_t
 
®loc_size
 = 
	`nvme_pci_iod_®loc_size
(
dev
, 
size
, 
n£g
,

542 
iod
->
u£_sgl
);

544 
iod
->
sg
 = 
	`km®loc
(
®loc_size
, 
GFP_ATOMIC
);

545 ià(!
iod
->
sg
)

546  
BLK_STS_RESOURCE
;

548 
iod
->
sg
 = iod->
šlše_sg
;

551 
iod
->
kv_cmd
 = 0;

553 
iod
->
abÜ‹d
 = 0;

554 
iod
->
Åages
 = -1;

555 
iod
->
ÃÁs
 = 0;

556 
iod
->
Ëngth
 = 
size
;

558  
BLK_STS_OK
;

559 
	}
}

563 
blk_¡©us_t
 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

565  
	`__nvme_š™_iod
(
rq
, 
dev
, 
çl£
);

566 
	}
}

568 
blk_¡©us_t
 
	$nvme_š™_iod_fÜ_kv
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

570  
	`__nvme_š™_iod
(
rq
, 
dev
, 
Œue
);

571 
	}
}

576 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

578 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

579 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / (
__Ë64
) - 1;

580 
dma_addr_t
 
dma_addr
 = 
iod
->
fœ¡_dma
, 
Ãxt_dma_addr
;

582 
i
;

584 ià(
iod
->
Åages
 == 0)

585 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
	`nvme_pci_iod_li¡
(
»q
)[0],

586 
dma_addr
);

588 
i
 = 0; i < 
iod
->
Åages
; i++) {

589 *
addr
 = 
	`nvme_pci_iod_li¡
(
»q
)[
i
];

591 ià(
iod
->
u£_sgl
) {

592 
nvme_sgl_desc
 *
sg_li¡
 = 
addr
;

594 
Ãxt_dma_addr
 =

595 
	`Ë64_to_ıu
((
sg_li¡
[
SGES_PER_PAGE
 - 1]).
addr
);

597 
__Ë64
 *
´p_li¡
 = 
addr
;

599 
Ãxt_dma_addr
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

602 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
addr
, 
dma_addr
);

603 
dma_addr
 = 
Ãxt_dma_addr
;

606 ià(
iod
->
sg
 !ğiod->
šlše_sg
)

607 
	`kä“
(
iod
->
sg
);

608 
	}
}

610 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


611 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

613 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
v
)

614 
pi
->
»f_g
 = 
	`ıu_to_be32
(
p
);

615 
	}
}

617 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

619 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
p
)

620 
pi
->
»f_g
 = 
	`ıu_to_be32
(
v
);

621 
	}
}

633 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

634 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

636 
nvme_ns
 *
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

637 
bio_š‹gr™y_·ylßd
 *
b
;

638 
t10_pi_tu¶e
 *
pi
;

639 *
p
, *
pm­
;

640 
u32
 
i
, 
Æb
, 
ts
, 
phys
, 
vœt
;

642 ià(!
ns
->
pi_ty³
 ||‚s->pi_ty³ =ğ
NVME_NS_DPS_PI_TYPE3
)

645 
b
 = 
	`bio_š‹gr™y
(
»q
->
bio
);

646 ià(!
b
)

649 
pm­
 = 
	`km­_©omic
(
b
->
b_vec
->
bv_·ge
è+ b->b_vec->
bv_off£t
;

651 
p
 = 
pm­
;

652 
vœt
 = 
	`b_g‘_£ed
(
b
);

653 
phys
 = 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
));

654 
Æb
 = (
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

655 
ts
 = 
ns
->
disk
->
queue
->
š‹gr™y
.
tu¶e_size
;

657 
i
 = 0; i < 
Æb
; i++, 
vœt
++, 
phys
++) {

658 
pi
 = (
t10_pi_tu¶e
 *)
p
;

659 
	`dif_sw­
(
phys
, 
vœt
, 
pi
);

660 
p
 +ğ
ts
;

662 
	`kunm­_©omic
(
pm­
);

663 
	}
}

665 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

666 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

668 
	}
}

669 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

671 
	}
}

672 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

674 
	}
}

677 
	$nvme_´št_sgl
(
sÿ‰”li¡
 *
sgl
, 
ÃÁs
)

679 
i
;

680 
sÿ‰”li¡
 *
sg
;

682 
	`fÜ_—ch_sg
(
sgl
, 
sg
, 
ÃÁs
, 
i
) {

683 
dma_addr_t
 
phys
 = 
	`sg_phys
(
sg
);

684 
	`´_w¬n
("sg[%d]…hys_addr:%pad offset:%d†ength:%d "

686 
i
, &
phys
, 
sg
->
off£t
, sg->
Ëngth
, &
	`sg_dma_add»ss
(sg),

687 
	`sg_dma_Ën
(
sg
));

689 
	}
}

691 
blk_¡©us_t
 
	$nvme_pci_£tup_´ps
(
nvme_dev
 *
dev
,

692 
»que¡
 *
»q
, 
nvme_rw_commªd
 *
cmnd
)

694 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

695 
dma_poŞ
 *
poŞ
;

697 
Ëngth
;

699 
Ëngth
 = 
	`blk_rq_·ylßd_by‹s
(
»q
);

701 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

702 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

703 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

704 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

705 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

706 
__Ë64
 *
´p_li¡
;

707 **
li¡
 = 
	`nvme_pci_iod_li¡
(
»q
);

708 
dma_addr_t
 
´p_dma
;

709 
Å½s
, 
i
;

712 ià(
iod
->
kv_cmd
) {

713 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

714 
Ëngth
 = 
·¿m
->
kv_d©a_Ën
;

716 
Ëngth
 = 
	`blk_rq_·ylßd_by‹s
(
»q
);

720 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

721 ià(
Ëngth
 <= 0) {

722 
iod
->
fœ¡_dma
 = 0;

723 
dÚe
;

726 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

727 ià(
dma_Ën
) {

728 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

730 
sg
 = 
	`sg_Ãxt
(sg);

731 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

732 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

735 ià(
Ëngth
 <ğ
·ge_size
) {

736 
iod
->
fœ¡_dma
 = 
dma_addr
;

737 
dÚe
;

740 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

741 ià(
Å½s
 <= (256 / 8)) {

742 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

743 
iod
->
Åages
 = 0;

745 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

746 
iod
->
Åages
 = 1;

749 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

750 ià(!
´p_li¡
) {

751 
iod
->
fœ¡_dma
 = 
dma_addr
;

752 
iod
->
Åages
 = -1;

753  
BLK_STS_RESOURCE
;

755 
li¡
[0] = 
´p_li¡
;

756 
iod
->
fœ¡_dma
 = 
´p_dma
;

757 
i
 = 0;

759 ià(
i
 =ğ
·ge_size
 >> 3) {

760 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

761 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

762 ià(!
´p_li¡
)

763  
BLK_STS_RESOURCE
;

764 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

765 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

766 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

767 
i
 = 1;

769 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

770 
dma_Ën
 -ğ
·ge_size
;

771 
dma_addr
 +ğ
·ge_size
;

772 
Ëngth
 -ğ
·ge_size
;

773 ià(
Ëngth
 <= 0)

775 ià(
dma_Ën
 > 0)

777 ià(
	`uÆik–y
(
dma_Ën
 < 0))

778 
bad_sgl
;

779 
sg
 = 
	`sg_Ãxt
(sg);

780 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

781 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

784 
dÚe
:

785 
cmnd
->
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

786 
cmnd
->
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

788  
BLK_STS_OK
;

790 
bad_sgl
:

791 
	`WARN
(
	`DO_ONCE
(
nvme_´št_sgl
, 
iod
->
sg
, iod->
ÃÁs
),

793 
	`blk_rq_·ylßd_by‹s
(
»q
), 
iod
->
ÃÁs
);

794  
BLK_STS_IOERR
;

795 
	}
}

797 
	$nvme_pci_sgl_£t_d©a
(
nvme_sgl_desc
 *
sge
,

798 
sÿ‰”li¡
 *
sg
)

800 
sge
->
addr
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
sg
));

801 
sge
->
Ëngth
 = 
	`ıu_to_Ë32
(
	`sg_dma_Ën
(
sg
));

802 
sge
->
ty³
 = 
NVME_SGL_FMT_DATA_DESC
 << 4;

803 
	}
}

805 
	$nvme_pci_sgl_£t_£g
(
nvme_sgl_desc
 *
sge
,

806 
dma_addr_t
 
dma_addr
, 
’Œ›s
)

808 
sge
->
addr
 = 
	`ıu_to_Ë64
(
dma_addr
);

809 ià(
’Œ›s
 < 
SGES_PER_PAGE
) {

810 
sge
->
Ëngth
 = 
	`ıu_to_Ë32
(
’Œ›s
 * (*sge));

811 
sge
->
ty³
 = 
NVME_SGL_FMT_LAST_SEG_DESC
 << 4;

813 
sge
->
Ëngth
 = 
	`ıu_to_Ë32
(
PAGE_SIZE
);

814 
sge
->
ty³
 = 
NVME_SGL_FMT_SEG_DESC
 << 4;

816 
	}
}

818 
blk_¡©us_t
 
	$nvme_pci_£tup_sgls
(
nvme_dev
 *
dev
,

819 
»que¡
 *
»q
, 
nvme_rw_commªd
 *
cmd
, 
’Œ›s
)

821 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

822 
dma_poŞ
 *
poŞ
;

823 
nvme_sgl_desc
 *
sg_li¡
;

824 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

825 
dma_addr_t
 
sgl_dma
;

826 
i
 = 0;

829 
cmd
->
æags
 = 
NVME_CMD_SGL_METABUF
;

831 ià(
’Œ›s
 == 1) {

832 
	`nvme_pci_sgl_£t_d©a
(&
cmd
->
d±r
.
sgl
, 
sg
);

833  
BLK_STS_OK
;

836 ià(
’Œ›s
 <ğ(256 / (
nvme_sgl_desc
))) {

837 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

838 
iod
->
Åages
 = 0;

840 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

841 
iod
->
Åages
 = 1;

844 
sg_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
sgl_dma
);

845 ià(!
sg_li¡
) {

846 
iod
->
Åages
 = -1;

847  
BLK_STS_RESOURCE
;

850 
	`nvme_pci_iod_li¡
(
»q
)[0] = 
sg_li¡
;

851 
iod
->
fœ¡_dma
 = 
sgl_dma
;

853 
	`nvme_pci_sgl_£t_£g
(&
cmd
->
d±r
.
sgl
, 
sgl_dma
, 
’Œ›s
);

856 ià(
i
 =ğ
SGES_PER_PAGE
) {

857 
nvme_sgl_desc
 *
Şd_sg_desc
 = 
sg_li¡
;

858 
nvme_sgl_desc
 *
lšk
 = &
Şd_sg_desc
[
i
 - 1];

860 
sg_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
sgl_dma
);

861 ià(!
sg_li¡
)

862  
BLK_STS_RESOURCE
;

864 
i
 = 0;

865 
	`nvme_pci_iod_li¡
(
»q
)[
iod
->
Åages
++] = 
sg_li¡
;

866 
sg_li¡
[
i
++] = *
lšk
;

867 
	`nvme_pci_sgl_£t_£g
(
lšk
, 
sgl_dma
, 
’Œ›s
);

870 
	`nvme_pci_sgl_£t_d©a
(&
sg_li¡
[
i
++], 
sg
);

871 
sg
 = 
	`sg_Ãxt
(sg);

872 } --
’Œ›s
 > 0);

874  
BLK_STS_OK
;

875 
	}
}

878 
blk_¡©us_t
 
	$nvme_kv_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

879 
nvme_commªd
 *
cmnd
)

881 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

882 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

883 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

884 
blk_¡©us_t
 
»t
 = 
BLK_STS_IOERR
;

885 
Ä_m­³d
;

887 ià(
·¿m
->
kv_d©a_sg_±r
) {

888 
sÿ‰”li¡
* 
sg
;

889 
i
;

891 
	`fÜ_—ch_sg
(
·¿m
->
kv_d©a_sg_±r
, 
sg
,…¬am->
kv_d©a_ÃÁs
, 
i
) {

892 
iod
->
sg
[
i
] = *sg;

894 
iod
->
ÃÁs
 = 
·¿m
->
kv_d©a_ÃÁs
;

895 
»t
 = 
BLK_STS_RESOURCE
;

896 
Ä_m­³d
 = 
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

897 
DMA_ATTR_NO_WARN
);

898 ià(!
Ä_m­³d
)

899 
out
;

901 ià(
iod
->
u£_sgl
)

902 
»t
 = 
	`nvme_pci_£tup_sgls
(
dev
, 
»q
, &
cmnd
->
rw
, 
Ä_m­³d
);

904 
»t
 = 
	`nvme_pci_£tup_´ps
(
dev
, 
»q
, &
cmnd
->
rw
);

905 ià(
»t
 !ğ
BLK_STS_OK
)

906 
out_unm­
;

908 
cmnd
->
kv_¡Üe
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

909 
cmnd
->
kv_¡Üe
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

911 
»t
 = 
BLK_STS_IOERR
;

913 ià(
·¿m
->
kv_m‘a_sg_±r
)

915 ià(!
	`dma_m­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
))

916 
out_unm­
;

917 
cmnd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
·¿m
->
kv_m‘a_sg_±r
));

919  
BLK_STS_OK
;

921 
out_unm­
:

922 ià(
·¿m
->
kv_d©a_sg_±r
)

923 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

924 
out
:

925  
»t
;

926 
	}
}

929 
	$nvme_kv_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

931 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

932 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

933 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

935 ià(
·¿m
->
kv_m‘a_sg_±r
) {

936 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

938 ià(
iod
->
·¿m
.
kv_m‘a_sg_±r
)

940 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
·¿m
.
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
);

942 
	`nvme_ş—nup_cmd
(
»q
);

943 
	`nvme_ä“_iod
(
dev
, 
»q
);

944 
	}
}

949 
blk_¡©us_t
 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

950 
nvme_commªd
 *
cmnd
)

952 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

953 
»que¡_queue
 *
q
 = 
»q
->q;

954 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

955 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

956 
blk_¡©us_t
 
»t
 = 
BLK_STS_IOERR
;

957 
Ä_m­³d
;

959 ià(
	`is_kv_cmd
(
cmnd
->
commÚ
.
İcode
)) {

960  
	`nvme_kv_m­_d©a
(
dev
, 
»q
, 
cmnd
);

963 
	`sg_š™_bË
(
iod
->
sg
, 
	`blk_rq_Ä_phys_£gm’ts
(
»q
));

964 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

965 ià(!
iod
->
ÃÁs
)

966 
out
;

968 
»t
 = 
BLK_STS_RESOURCE
;

969 
Ä_m­³d
 = 
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

970 
DMA_ATTR_NO_WARN
);

971 ià(!
Ä_m­³d
)

972 
out
;

974 ià(
iod
->
u£_sgl
)

975 
»t
 = 
	`nvme_pci_£tup_sgls
(
dev
, 
»q
, &
cmnd
->
rw
, 
Ä_m­³d
);

977 
»t
 = 
	`nvme_pci_£tup_´ps
(
dev
, 
»q
, &
cmnd
->
rw
);

979 ià(
»t
 !ğ
BLK_STS_OK
)

980 
out_unm­
;

982 
»t
 = 
BLK_STS_IOERR
;

983 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

984 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

985 
out_unm­
;

987 
	`sg_š™_bË
(&
iod
->
m‘a_sg
, 1);

988 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, &
iod
->
m‘a_sg
) != 1)

989 
out_unm­
;

991 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_WRITE
)

992 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_´•
);

994 ià(!
	`dma_m­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
))

995 
out_unm­
;

998 ià(
	`blk_š‹gr™y_rq
(
»q
))

999 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(&
iod
->
m‘a_sg
));

1000  
BLK_STS_OK
;

1002 
out_unm­
:

1003 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

1004 
out
:

1005  
»t
;

1006 
	}
}

1008 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

1010 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1011 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

1012 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

1014 ià(
iod
->
kv_cmd
) {

1015  
	`nvme_kv_unm­_d©a
(
dev
, 
»q
);

1018 ià(
iod
->
ÃÁs
) {

1019 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

1020 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

1021 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_READ
)

1022 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_com¶‘e
);

1023 
	`dma_unm­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
);

1027 
	`nvme_ş—nup_cmd
(
»q
);

1028 
	`nvme_ä“_iod
(
dev
, 
»q
);

1029 
	}
}

1034 
blk_¡©us_t
 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1035 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1037 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1038 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1039 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1040 
»que¡
 *
»q
 = 
bd
->
rq
;

1041 
nvme_commªd
 
cmnd
;

1042 
blk_¡©us_t
 
»t
;

1044 
boŞ
 
b_kv_cmd
 = 
çl£
;

1046 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
»q
, &
cmnd
);

1047 ià(
»t
)

1048  
»t
;

1050 
b_kv_cmd
 = 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
);

1051 ià(
b_kv_cmd
) {

1052 
»t
 = 
	`nvme_š™_iod_fÜ_kv
(
»q
, 
dev
);

1053 ià(
»t
)

1054 
out_ä“_cmd
;

1056 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

1057 ià(
»t
)

1058 
out_ä“_cmd
;

1061 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

1062 ià(
»t
)

1063 
out_ä“_cmd
;

1066 ià(
b_kv_cmd
) {

1067 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1068 
iod
->
kv_cmd
 = 1;

1071 ià(
	`blk_rq_Ä_phys_£gm’ts
(
»q
) ||

1072 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

1073 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

1074 ià(
»t
)

1075 
out_ş—nup_iod
;

1078 
	`blk_mq_¡¬t_»que¡
(
»q
);

1080 #ifdeà
KV_NVME_DUMMY_OP


1081 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

1082 #ifdeà
KV_NVME_DUMMY_OP_REPORT


1083 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

1084 
	`´_”r
("[dump‚vme kv comand]\n");

1085 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

1086 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

1087 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

1088 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

1089 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

1090 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

1091 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

1092 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

1093 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

1094 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

1095 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

1096 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

1097 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

1098 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

1099 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

1100 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

1101 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

1102 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

1104 
	`nvme_»q
(
»q
)->
¡©us
 = 
NVME_SC_SUCCESS
;

1105 
	`nvme_»q
(
»q
)->
»suÉ
.
u32
 = 
NVME_SC_SUCCESS
;

1106 ià(
	`is_kv_»Œ›ve_cmd
(
cmnd
.
commÚ
.
İcode
)) {

1107 
	`nvme_»q
(
»q
)->
»suÉ
.
u32
 = 
cmnd
.
commÚ
.
cdw10
[5];

1109 
	`blk_mq_com¶‘e_»que¡
(
»q
);

1110  
BLK_STS_OK
;

1114 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

1115 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

1116 
	`´_”r
("[dump‚vme kv comand]\n");

1117 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

1118 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

1119 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

1120 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

1121 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

1122 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

1123 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

1124 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

1125 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

1126 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

1127 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

1128 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

1129 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

1130 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

1131 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

1132 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

1133 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

1134 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

1138 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1139 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0)) {

1140 
»t
 = 
BLK_STS_IOERR
;

1141 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1142 
out_ş—nup_iod
;

1144 
	`__nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

1145 
	`nvme_´oûss_cq
(
nvmeq
);

1146 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1147  
BLK_STS_OK
;

1148 
out_ş—nup_iod
:

1149 
	`nvme_ä“_iod
(
dev
, 
»q
);

1150 
out_ä“_cmd
:

1151 
	`nvme_ş—nup_cmd
(
»q
);

1152  
»t
;

1153 
	}
}

1155 
	$nvme_pci_com¶‘e_rq
(
»que¡
 *
»q
)

1157 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1159 
	`nvme_unm­_d©a
(
iod
->
nvmeq
->
dev
, 
»q
);

1160 
	`nvme_com¶‘e_rq
(
»q
);

1161 
	}
}

1164 
šlše
 
boŞ
 
	$nvme_cqe_v®id
(
nvme_queue
 *
nvmeq
, 
u16
 
h—d
,

1165 
u16
 
pha£
)

1167  (
	`Ë16_to_ıu
(
nvmeq
->
cqes
[
h—d
].
¡©us
è& 1è=ğ
pha£
;

1168 
	}
}

1170 
šlše
 
	$nvme_ršg_cq_doÜb–l
(
nvme_queue
 *
nvmeq
)

1172 
u16
 
h—d
 = 
nvmeq
->
cq_h—d
;

1174 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0)) {

1175 ià(
	`nvme_dbbuf_upd©e_ªd_check_ev’t
(
h—d
, 
nvmeq
->
dbbuf_cq_db
,

1176 
nvmeq
->
dbbuf_cq_ei
))

1177 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

1179 
	}
}

1181 
šlše
 
	$nvme_hªdË_cqe
(
nvme_queue
 *
nvmeq
,

1182 
nvme_com¶‘iÚ
 *
cqe
)

1184 
»que¡
 *
»q
;

1186 ià(
	`uÆik–y
(
cqe
->
commªd_id
 >ğ
nvmeq
->
q_d•th
)) {

1187 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1189 
cqe
->
commªd_id
, 
	`Ë16_to_ıu
(cqe->
sq_id
));

1199 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

1200 
cqe
->
commªd_id
 >ğ
NVME_AQ_BLK_MQ_DEPTH
)) {

1201 
	`nvme_com¶‘e_async_ev’t
(&
nvmeq
->
dev
->
ù¾
,

1202 
cqe
->
¡©us
, &cqe->
»suÉ
);

1206 
nvmeq
->
cqe_£’
 = 1;

1207 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
->
commªd_id
);

1208 
	`nvme_’d_»que¡
(
»q
, 
cqe
->
¡©us
, cqe->
»suÉ
);

1209 
	}
}

1211 
šlše
 
boŞ
 
	$nvme_»ad_cqe
(
nvme_queue
 *
nvmeq
,

1212 
nvme_com¶‘iÚ
 *
cqe
)

1214 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
)) {

1215 *
cqe
 = 
nvmeq
->
cqes
[nvmeq->
cq_h—d
];

1217 ià(++
nvmeq
->
cq_h—d
 =ğnvmeq->
q_d•th
) {

1218 
nvmeq
->
cq_h—d
 = 0;

1219 
nvmeq
->
cq_pha£
 = !nvmeq->cq_phase;

1221  
Œue
;

1223  
çl£
;

1224 
	}
}

1226 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

1228 
nvme_com¶‘iÚ
 
cqe
;

1229 
cÚsumed
 = 0;

1231 
	`nvme_»ad_cqe
(
nvmeq
, &
cqe
)) {

1232 
	`nvme_hªdË_cqe
(
nvmeq
, &
cqe
);

1233 
cÚsumed
++;

1236 ià(
cÚsumed
)

1237 
	`nvme_ršg_cq_doÜb–l
(
nvmeq
);

1238 
	}
}

1240 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1242 
œq»tuº_t
 
»suÉ
;

1243 
nvme_queue
 *
nvmeq
 = 
d©a
;

1244 
	`¥š_lock
(&
nvmeq
->
q_lock
);

1245 
	`nvme_´oûss_cq
(
nvmeq
);

1246 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

1247 
nvmeq
->
cqe_£’
 = 0;

1248 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

1249  
»suÉ
;

1250 
	}
}

1252 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1254 
nvme_queue
 *
nvmeq
 = 
d©a
;

1255 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

1256  
IRQ_WAKE_THREAD
;

1257  
IRQ_NONE
;

1258 
	}
}

1260 
	$__nvme_pŞl
(
nvme_queue
 *
nvmeq
, 
g
)

1262 
nvme_com¶‘iÚ
 
cqe
;

1263 
found
 = 0, 
cÚsumed
 = 0;

1265 ià(!
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

1268 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1269 
	`nvme_»ad_cqe
(
nvmeq
, &
cqe
)) {

1270 
	`nvme_hªdË_cqe
(
nvmeq
, &
cqe
);

1271 
cÚsumed
++;

1273 ià(
g
 =ğ
cqe
.
commªd_id
) {

1274 
found
 = 1;

1279 ià(
cÚsumed
)

1280 
	`nvme_ršg_cq_doÜb–l
(
nvmeq
);

1281 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1283  
found
;

1284 
	}
}

1286 
	$nvme_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1288 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1290  
	`__nvme_pŞl
(
nvmeq
, 
g
);

1291 
	}
}

1293 
	$nvme_pci_subm™_async_ev’t
(
nvme_ù¾
 *
ù¾
)

1295 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

1296 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1297 
nvme_commªd
 
c
;

1299 
	`mem£t
(&
c
, 0, (c));

1300 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1301 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1303 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1304 
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

1305 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1306 
	}
}

1308 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1310 
nvme_commªd
 
c
;

1312 
	`mem£t
(&
c
, 0, (c));

1313 
c
.
d–‘e_queue
.
İcode
 = opcode;

1314 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1316  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1317 
	}
}

1319 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1320 
nvme_queue
 *
nvmeq
)

1322 
nvme_commªd
 
c
;

1323 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1329 
	`mem£t
(&
c
, 0, (c));

1330 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1331 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1332 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1333 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1334 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1335 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1337  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1338 
	}
}

1340 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1341 
nvme_queue
 *
nvmeq
)

1343 
nvme_commªd
 
c
;

1344 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
;

1350 
	`mem£t
(&
c
, 0, (c));

1351 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1352 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1353 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1354 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1355 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1356 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1358  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1359 
	}
}

1361 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1363  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1364 
	}
}

1366 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1368  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1369 
	}
}

1371 
	$abÜt_’dio
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

1373 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1374 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1376 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1377 "AbÜˆ¡©us: 0x%x", 
	`nvme_»q
(
»q
)->
¡©us
);

1378 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

1379 
	`blk_mq_ä“_»que¡
(
»q
);

1380 
	}
}

1382 
boŞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1388 
boŞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1391 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
)

1392  
çl£
;

1397 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1398  
çl£
;

1403 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1404  
çl£
;

1406  
Œue
;

1407 
	}
}

1409 
	$nvme_w¬n_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1412 
u16
 
pci_¡©us
;

1413 
»suÉ
;

1415 
»suÉ
 = 
	`pci_»ad_cÚfig_wÜd
(
	`to_pci_dev
(
dev
->dev), 
PCI_STATUS
,

1416 &
pci_¡©us
);

1417 ià(
»suÉ
 =ğ
PCIBIOS_SUCCESSFUL
)

1418 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1420 
c¡s
, 
pci_¡©us
);

1422 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1424 
c¡s
, 
»suÉ
);

1425 
	}
}

1427 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

1429 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1430 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1431 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1432 
»que¡
 *
abÜt_»q
;

1433 
nvme_commªd
 
cmd
;

1434 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1439 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1440 
	`nvme_w¬n_»£t
(
dev
, 
c¡s
);

1441 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1442 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

1443  
BLK_EH_HANDLED
;

1449 ià(
	`__nvme_pŞl
(
nvmeq
, 
»q
->
g
)) {

1450 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1452 
»q
->
g
, 
nvmeq
->
qid
);

1453  
BLK_EH_HANDLED
;

1462 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
) {

1463 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1465 
»q
->
g
, 
nvmeq
->
qid
);

1466 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1467 
	`nvme_»q
(
»q
)->
æags
 |ğ
NVME_REQ_CANCELLED
;

1468  
BLK_EH_HANDLED
;

1476 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

1477 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1479 
»q
->
g
, 
nvmeq
->
qid
);

1480 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1481 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

1487 
	`nvme_»q
(
»q
)->
æags
 |ğ
NVME_REQ_CANCELLED
;

1488  
BLK_EH_HANDLED
;

1491 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1492 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1493  
BLK_EH_RESET_TIMER
;

1495 
iod
->
abÜ‹d
 = 1;

1497 
	`mem£t
(&
cmd
, 0, (cmd));

1498 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1499 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1500 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1502 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1504 
»q
->
g
, 
nvmeq
->
qid
);

1506 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1507 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1508 ià(
	`IS_ERR
(
abÜt_»q
)) {

1509 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1510  
BLK_EH_RESET_TIMER
;

1513 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1514 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1515 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1522  
BLK_EH_RESET_TIMER
;

1523 
	}
}

1525 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1527 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1528 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1529 ià(
nvmeq
->
sq_cmds
)

1530 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1531 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1532 
	`kä“
(
nvmeq
);

1533 
	}
}

1535 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1537 
i
;

1539 
i
 = 
dev
->
ù¾
.
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1540 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1541 
dev
->
ù¾
.
queue_couÁ
--;

1542 
dev
->
queues
[
i
] = 
NULL
;

1543 
	`nvme_ä“_queue
(
nvmeq
);

1545 
	}
}

1551 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1553 
veùÜ
;

1555 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1556 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1557 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1560 
veùÜ
 = 
nvmeq
->
cq_veùÜ
;

1561 
nvmeq
->
dev
->
Úlše_queues
--;

1562 
nvmeq
->
cq_veùÜ
 = -1;

1563 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1565 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1566 
	`blk_mq_qu›sû_queue
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1568 
	`pci_ä“_œq
(
	`to_pci_dev
(
nvmeq
->
dev
->dev), 
veùÜ
,‚vmeq);

1571 
	}
}

1573 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1575 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1577 ià(!
nvmeq
)

1579 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1582 ià(
shutdown
)

1583 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1585 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1587 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1588 
	`nvme_´oûss_cq
(
nvmeq
);

1589 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1590 
	}
}

1592 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1593 
’Œy_size
)

1595 
q_d•th
 = 
dev
->q_depth;

1596 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1597 
dev
->
ù¾
.
·ge_size
);

1599 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1600 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1601 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1602 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1609 ià(
q_d•th
 < 64)

1610  -
ENOMEM
;

1613  
q_d•th
;

1614 
	}
}

1616 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1617 
qid
, 
d•th
)

1619 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1620 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
d•th
),

1621 
dev
->
ù¾
.
·ge_size
);

1622 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_bus_addr
 + 
off£t
;

1623 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1625 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1626 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1627 ià(!
nvmeq
->
sq_cmds
)

1628  -
ENOMEM
;

1632 
	}
}

1634 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1635 
d•th
, 
node
)

1637 
nvme_queue
 *
nvmeq
 = 
	`kz®loc_node
((*nvmeq), 
GFP_KERNEL
,

1638 
node
);

1639 ià(!
nvmeq
)

1640  
NULL
;

1642 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1643 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1644 ià(!
nvmeq
->
cqes
)

1645 
ä“_nvmeq
;

1647 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1648 
ä“_cqdma
;

1650 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1651 
nvmeq
->
dev
 = dev;

1652 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1653 
nvmeq
->
cq_h—d
 = 0;

1654 
nvmeq
->
cq_pha£
 = 1;

1655 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1656 
nvmeq
->
q_d•th
 = 
d•th
;

1657 
nvmeq
->
qid
 = qid;

1658 
nvmeq
->
cq_veùÜ
 = -1;

1659 
dev
->
queues
[
qid
] = 
nvmeq
;

1660 
dev
->
ù¾
.
queue_couÁ
++;

1662  
nvmeq
;

1664 
ä“_cqdma
:

1665 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1666 
nvmeq
->
cq_dma_addr
);

1667 
ä“_nvmeq
:

1668 
	`kä“
(
nvmeq
);

1669  
NULL
;

1670 
	}
}

1672 
	$queue_»que¡_œq
(
nvme_queue
 *
nvmeq
)

1674 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
nvmeq
->
dev
->dev);

1675 
Ä
 = 
nvmeq
->
dev
->
ù¾
.
š¡ªû
;

1677 ià(
u£_th»aded_š‹¼u±s
) {

1678  
	`pci_»que¡_œq
(
pdev
, 
nvmeq
->
cq_veùÜ
, 
nvme_œq_check
,

1679 
nvme_œq
, 
nvmeq
, "nvme%dq%d", 
Ä
,‚vmeq->
qid
);

1681  
	`pci_»que¡_œq
(
pdev
, 
nvmeq
->
cq_veùÜ
, 
nvme_œq
,

1682 
NULL
, 
nvmeq
, "nvme%dq%d", 
Ä
,‚vmeq->
qid
);

1684 
	}
}

1686 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1688 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1690 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1691 
nvmeq
->
sq_
 = 0;

1692 
nvmeq
->
cq_h—d
 = 0;

1693 
nvmeq
->
cq_pha£
 = 1;

1694 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1695 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1696 
	`nvme_dbbuf_š™
(
dev
, 
nvmeq
, 
qid
);

1697 
dev
->
Úlše_queues
++;

1698 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1699 
	}
}

1701 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1703 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1704 
»suÉ
;

1706 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1707 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1708 ià(
»suÉ
 < 0)

1709  
»suÉ
;

1711 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1712 ià(
»suÉ
 < 0)

1713 
»Ëa£_cq
;

1715 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1716 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1717 ià(
»suÉ
 < 0)

1718 
»Ëa£_sq
;

1720  
»suÉ
;

1722 
»Ëa£_sq
:

1723 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1724 
»Ëa£_cq
:

1725 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1726  
»suÉ
;

1727 
	}
}

1729 cÚ¡ 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1730 .
queue_rq
 = 
nvme_queue_rq
,

1731 .
	gcom¶‘e
 = 
nvme_pci_com¶‘e_rq
,

1732 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1733 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1734 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1735 .
	gtimeout
 = 
nvme_timeout
,

1738 cÚ¡ 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1739 .
queue_rq
 = 
nvme_queue_rq
,

1740 .
	gcom¶‘e
 = 
nvme_pci_com¶‘e_rq
,

1741 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1742 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1743 .
	gm­_queues
 = 
nvme_pci_m­_queues
,

1744 .
	gtimeout
 = 
nvme_timeout
,

1745 .
	gpŞl
 = 
nvme_pŞl
,

1748 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1750 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1756 
	`blk_mq_unqu›sû_queue
(
dev
->
ù¾
.
admš_q
);

1757 
	`blk_ş—nup_queue
(
dev
->
ù¾
.
admš_q
);

1758 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1760 
	}
}

1762 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1764 ià(!
dev
->
ù¾
.
admš_q
) {

1765 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1766 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1768 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_MQ_TAG_DEPTH
;

1769 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1770 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1771 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_pci_cmd_size
(dev, 
çl£
);

1772 
dev
->
admš_g£t
.
æags
 = 
BLK_MQ_F_NO_SCHED
;

1773 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1775 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1776  -
ENOMEM
;

1777 
dev
->
ù¾
.
admš_g£t
 = &dev->admin_tagset;

1779 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1780 ià(
	`IS_ERR
(
dev
->
ù¾
.
admš_q
)) {

1781 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1782  -
ENOMEM
;

1784 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1785 
	`nvme_dev_»move_admš
(
dev
);

1786 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1787  -
ENODEV
;

1790 
	`blk_mq_unqu›sû_queue
(
dev
->
ù¾
.
admš_q
);

1793 
	}
}

1795 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1797  
NVME_REG_DBS
 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1798 
	}
}

1800 
	$nvme_»m­_b¬
(
nvme_dev
 *
dev
, 
size
)

1802 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1804 ià(
size
 <ğ
dev
->
b¬_m­³d_size
)

1806 ià(
size
 > 
	`pci_»sourû_Ën
(
pdev
, 0))

1807  -
ENOMEM
;

1808 ià(
dev
->
b¬
)

1809 
	`iounm­
(
dev
->
b¬
);

1810 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1811 ià(!
dev
->
b¬
) {

1812 
dev
->
b¬_m­³d_size
 = 0;

1813  -
ENOMEM
;

1815 
dev
->
b¬_m­³d_size
 = 
size
;

1816 
dev
->
dbs
 = dev->
b¬
 + 
NVME_REG_DBS
;

1819 
	}
}

1821 
	$nvme_pci_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1823 
»suÉ
;

1824 
u32
 
aqa
;

1825 
nvme_queue
 *
nvmeq
;

1827 
»suÉ
 = 
	`nvme_»m­_b¬
(
dev
, 
	`db_b¬_size
(dev, 0));

1828 ià(
»suÉ
 < 0)

1829  
»suÉ
;

1831 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 1, 0) ?

1832 
	`NVME_CAP_NSSRC
(
dev
->
ù¾
.
ÿp
) : 0;

1834 ià(
dev
->
subsy¡em
 &&

1835 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1836 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1838 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1839 ià(
»suÉ
 < 0)

1840  
»suÉ
;

1842 
nvmeq
 = 
dev
->
queues
[0];

1843 ià(!
nvmeq
) {

1844 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
,

1845 
	`dev_to_node
(
dev
->dev));

1846 ià(!
nvmeq
)

1847  -
ENOMEM
;

1850 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1851 
aqa
 |=‡qa << 16;

1853 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1854 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1855 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

1857 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, dev->ù¾.
ÿp
);

1858 ià(
»suÉ
)

1859  
»suÉ
;

1861 
nvmeq
->
cq_veùÜ
 = 0;

1862 
	`nvme_š™_queue
(
nvmeq
, 0);

1863 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1864 ià(
»suÉ
) {

1865 
nvmeq
->
cq_veùÜ
 = -1;

1866  
»suÉ
;

1869  
»suÉ
;

1870 
	}
}

1872 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

1874 
i
, 
max
;

1875 
»t
 = 0;

1877 
i
 = 
dev
->
ù¾
.
queue_couÁ
; i <ğdev->
max_qid
; i++) {

1879 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
,

1880 
	`pci_œq_g‘_node
(
	`to_pci_dev
(
dev
->dev), 
i
 - 1))) {

1881 
»t
 = -
ENOMEM
;

1886 
max
 = 
	`mš
(
dev
->
max_qid
, dev->
ù¾
.
queue_couÁ
 - 1);

1887 
i
 = 
dev
->
Úlše_queues
; i <ğ
max
; i++) {

1888 
»t
 = 
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i);

1889 ià(
»t
)

1899  
»t
 >= 0 ? 0 :„et;

1900 
	}
}

1902 
ssize_t
 
	$nvme_cmb_show
(
deviû
 *
dev
,

1903 
deviû_©Œibu‹
 *
©Œ
,

1904 *
buf
)

1906 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_g‘_drvd©a
(
dev
));

1908  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "cmbloc : x%08x\ncmbsz : x%08x\n",

1909 
ndev
->
cmbloc
,‚dev->
cmbsz
);

1910 
	}
}

1911 
DEVICE_ATTR
(
cmb
, 
S_IRUGO
, 
nvme_cmb_show
, 
NULL
);

1913 
__iomem
 *
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

1915 
u64
 
szu
, 
size
, 
off£t
;

1916 
»sourû_size_t
 
b¬_size
;

1917 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1918 
__iomem
 *
cmb
;

1919 
b¬
;

1921 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

1922 ià(!(
	`NVME_CMB_SZ
(
dev
->
cmbsz
)))

1923  
NULL
;

1924 
dev
->
cmbloc
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBLOC
);

1926 ià(!
u£_cmb_sqes
)

1927  
NULL
;

1929 
szu
 = (
u64
)1 << (12 + 4 * 
	`NVME_CMB_SZU
(
dev
->
cmbsz
));

1930 
size
 = 
szu
 * 
	`NVME_CMB_SZ
(
dev
->
cmbsz
);

1931 
off£t
 = 
szu
 * 
	`NVME_CMB_OFST
(
dev
->
cmbloc
);

1932 
b¬
 = 
	`NVME_CMB_BIR
(
dev
->
cmbloc
);

1933 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
b¬
);

1935 ià(
off£t
 > 
b¬_size
)

1936  
NULL
;

1943 ià(
size
 > 
b¬_size
 - 
off£t
)

1944 
size
 = 
b¬_size
 - 
off£t
;

1946 
cmb
 = 
	`iÜem­_wc
(
	`pci_»sourû_¡¬t
(
pdev
, 
b¬
è+ 
off£t
, 
size
);

1947 ià(!
cmb
)

1948  
NULL
;

1950 
dev
->
cmb_bus_addr
 = 
	`pci_bus_add»ss
(
pdev
, 
b¬
è+ 
off£t
;

1951 
dev
->
cmb_size
 = 
size
;

1952  
cmb
;

1953 
	}
}

1955 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

1957 ià(
dev
->
cmb
) {

1958 
	`iounm­
(
dev
->
cmb
);

1959 
dev
->
cmb
 = 
NULL
;

1960 
	`sysfs_»move_fe_äom_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

1961 &
dev_©Œ_cmb
.
©Œ
, 
NULL
);

1962 
dev
->
cmbsz
 = 0;

1964 
	}
}

1966 
	$nvme_£t_ho¡_mem
(
nvme_dev
 *
dev
, 
u32
 
b™s
)

1968 
u64
 
dma_addr
 = 
dev
->
ho¡_mem_descs_dma
;

1969 
nvme_commªd
 
c
;

1970 
»t
;

1972 
	`mem£t
(&
c
, 0, (c));

1973 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1974 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(
NVME_FEAT_HOST_MEM_BUF
);

1975 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(
b™s
);

1976 
c
.
ã©u»s
.
dwÜd12
 = 
	`ıu_to_Ë32
(
dev
->
ho¡_mem_size
 >>

1977 
	`og2
(
dev
->
ù¾
.
·ge_size
));

1978 
c
.
ã©u»s
.
dwÜd13
 = 
	`ıu_to_Ë32
(
	`low”_32_b™s
(
dma_addr
));

1979 
c
.
ã©u»s
.
dwÜd14
 = 
	`ıu_to_Ë32
(
	`uµ”_32_b™s
(
dma_addr
));

1980 
c
.
ã©u»s
.
dwÜd15
 = 
	`ıu_to_Ë32
(
dev
->
Ä_ho¡_mem_descs
);

1982 
»t
 = 
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1983 ià(
»t
) {

1984 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1986 
»t
, 
b™s
);

1988  
»t
;

1989 
	}
}

1991 
	$nvme_ä“_ho¡_mem
(
nvme_dev
 *
dev
)

1993 
i
;

1995 
i
 = 0; i < 
dev
->
Ä_ho¡_mem_descs
; i++) {

1996 
nvme_ho¡_mem_buf_desc
 *
desc
 = &
dev
->
ho¡_mem_descs
[
i
];

1997 
size_t
 
size
 = 
	`Ë32_to_ıu
(
desc
->sizeè* 
dev
->
ù¾
.
·ge_size
;

1999 
	`dma_ä“_coh”’t
(
dev
->dev, 
size
, dev->
ho¡_mem_desc_bufs
[
i
],

2000 
	`Ë64_to_ıu
(
desc
->
addr
));

2003 
	`kä“
(
dev
->
ho¡_mem_desc_bufs
);

2004 
dev
->
ho¡_mem_desc_bufs
 = 
NULL
;

2005 
	`dma_ä“_coh”’t
(
dev
->dev,

2006 
dev
->
Ä_ho¡_mem_descs
 * (*dev->
ho¡_mem_descs
),

2007 
dev
->
ho¡_mem_descs
, dev->
ho¡_mem_descs_dma
);

2008 
dev
->
ho¡_mem_descs
 = 
NULL
;

2009 
dev
->
Ä_ho¡_mem_descs
 = 0;

2010 
	}
}

2012 
	$__nvme_®loc_ho¡_mem
(
nvme_dev
 *
dev
, 
u64
 
´eã¼ed
,

2013 
u32
 
chunk_size
)

2015 
nvme_ho¡_mem_buf_desc
 *
descs
;

2016 
u32
 
max_’Œ›s
, 
Ën
;

2017 
dma_addr_t
 
descs_dma
;

2018 
i
 = 0;

2019 **
bufs
;

2020 
u64
 
size
 = 0, 
tmp
;

2022 
tmp
 = (
´eã¼ed
 + 
chunk_size
 - 1);

2023 
	`do_div
(
tmp
, 
chunk_size
);

2024 
max_’Œ›s
 = 
tmp
;

2026 ià(
dev
->
ù¾
.
hmmaxd
 && dev->ù¾.hmmaxd < 
max_’Œ›s
)

2027 
max_’Œ›s
 = 
dev
->
ù¾
.
hmmaxd
;

2029 
descs
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
max_’Œ›s
 * (*descs),

2030 &
descs_dma
, 
GFP_KERNEL
);

2031 ià(!
descs
)

2032 
out
;

2034 
bufs
 = 
	`kÿÎoc
(
max_’Œ›s
, (*bufs), 
GFP_KERNEL
);

2035 ià(!
bufs
)

2036 
out_ä“_descs
;

2038 
size
 = 0; siz< 
´eã¼ed
 && 
i
 < 
max_’Œ›s
; siz+ğ
Ën
) {

2039 
dma_addr_t
 
dma_addr
;

2041 
Ën
 = 
	`mš_t
(
u64
, 
chunk_size
, 
´eã¼ed
 - 
size
);

2042 
bufs
[
i
] = 
	`dma_®loc_©Œs
(
dev
->dev, 
Ën
, &
dma_addr
, 
GFP_KERNEL
,

2043 
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
);

2044 ià(!
bufs
[
i
])

2047 
descs
[
i
].
addr
 = 
	`ıu_to_Ë64
(
dma_addr
);

2048 
descs
[
i
].
size
 = 
	`ıu_to_Ë32
(
Ën
 / 
dev
->
ù¾
.
·ge_size
);

2049 
i
++;

2052 ià(!
size
)

2053 
out_ä“_bufs
;

2055 
dev
->
Ä_ho¡_mem_descs
 = 
i
;

2056 
dev
->
ho¡_mem_size
 = 
size
;

2057 
dev
->
ho¡_mem_descs
 = 
descs
;

2058 
dev
->
ho¡_mem_descs_dma
 = 
descs_dma
;

2059 
dev
->
ho¡_mem_desc_bufs
 = 
bufs
;

2062 
out_ä“_bufs
:

2063 --
i
 >= 0) {

2064 
size_t
 
size
 = 
	`Ë32_to_ıu
(
descs
[
i
].sizeè* 
dev
->
ù¾
.
·ge_size
;

2066 
	`dma_ä“_coh”’t
(
dev
->dev, 
size
, 
bufs
[
i
],

2067 
	`Ë64_to_ıu
(
descs
[
i
].
addr
));

2070 
	`kä“
(
bufs
);

2071 
out_ä“_descs
:

2072 
	`dma_ä“_coh”’t
(
dev
->dev, 
max_’Œ›s
 * (*
descs
), descs,

2073 
descs_dma
);

2074 
out
:

2075 
dev
->
ho¡_mem_descs
 = 
NULL
;

2076  -
ENOMEM
;

2077 
	}
}

2079 
	$nvme_®loc_ho¡_mem
(
nvme_dev
 *
dev
, 
u64
 
mš
, u64 
´eã¼ed
)

2081 
u32
 
chunk_size
;

2084 
chunk_size
 = 
	`mš_t
(
u64
, 
´eã¼ed
, 
PAGE_SIZE
 * 
MAX_ORDER_NR_PAGES
);

2085 
chunk_size
 >ğ
	`max_t
(
u32
, 
dev
->
ù¾
.
hmmšds
 * 4096, 
PAGE_SIZE
 * 2);

2086 
chunk_size
 /= 2) {

2087 ià(!
	`__nvme_®loc_ho¡_mem
(
dev
, 
´eã¼ed
, 
chunk_size
)) {

2088 ià(!
mš
 || 
dev
->
ho¡_mem_size
 >= min)

2090 
	`nvme_ä“_ho¡_mem
(
dev
);

2094  -
ENOMEM
;

2095 
	}
}

2097 
	$nvme_£tup_ho¡_mem
(
nvme_dev
 *
dev
)

2099 
u64
 
max
 = (u64)
max_ho¡_mem_size_mb
 * 
SZ_1M
;

2100 
u64
 
´eã¼ed
 = (u64)
dev
->
ù¾
.
hm´e
 * 4096;

2101 
u64
 
mš
 = (u64)
dev
->
ù¾
.
hmmš
 * 4096;

2102 
u32
 
’abË_b™s
 = 
NVME_HOST_MEM_ENABLE
;

2103 
»t
 = 0;

2105 
´eã¼ed
 = 
	`mš
Õ»ã¼ed, 
max
);

2106 ià(
mš
 > 
max
) {

2107 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2109 
mš
 >> 
	`og2
(
SZ_1M
), 
max_ho¡_mem_size_mb
);

2110 
	`nvme_ä“_ho¡_mem
(
dev
);

2117 ià(
dev
->
ho¡_mem_descs
) {

2118 ià(
dev
->
ho¡_mem_size
 >ğ
mš
)

2119 
’abË_b™s
 |ğ
NVME_HOST_MEM_RETURN
;

2121 
	`nvme_ä“_ho¡_mem
(
dev
);

2124 ià(!
dev
->
ho¡_mem_descs
) {

2125 ià(
	`nvme_®loc_ho¡_mem
(
dev
, 
mš
, 
´eã¼ed
)) {

2126 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2131 
	`dev_šfo
(
dev
->
ù¾
.
deviû
,

2133 
dev
->
ho¡_mem_size
 >> 
	`og2
(
SZ_1M
));

2136 
»t
 = 
	`nvme_£t_ho¡_mem
(
dev
, 
’abË_b™s
);

2137 ià(
»t
)

2138 
	`nvme_ä“_ho¡_mem
(
dev
);

2139  
»t
;

2140 
	}
}

2142 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

2144 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

2145 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2146 
»suÉ
, 
Ä_io_queues
;

2147 
size
;

2149 
Ä_io_queues
 = 
	`num_´e£Á_ıus
();

2150 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

2151 ià(
»suÉ
 < 0)

2152  
»suÉ
;

2154 ià(
Ä_io_queues
 == 0)

2157 ià(
dev
->
cmb
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

2158 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

2159 (
nvme_commªd
));

2160 ià(
»suÉ
 > 0)

2161 
dev
->
q_d•th
 = 
»suÉ
;

2163 
	`nvme_»Ëa£_cmb
(
dev
);

2167 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

2168 
»suÉ
 = 
	`nvme_»m­_b¬
(
dev
, 
size
);

2169 ià(!
»suÉ
)

2171 ià(!--
Ä_io_queues
)

2172  -
ENOMEM
;

2174 
admšq
->
q_db
 = 
dev
->
dbs
;

2177 
	`pci_ä“_œq
(
pdev
, 0, 
admšq
);

2183 
	`pci_ä“_œq_veùÜs
(
pdev
);

2184 
Ä_io_queues
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1,‚r_io_queues,

2185 
PCI_IRQ_ALL_TYPES
 | 
PCI_IRQ_AFFINITY
);

2186 ià(
Ä_io_queues
 <= 0)

2187  -
EIO
;

2188 
dev
->
max_qid
 = 
Ä_io_queues
;

2197 
»suÉ
 = 
	`queue_»que¡_œq
(
admšq
);

2198 ià(
»suÉ
) {

2199 
admšq
->
cq_veùÜ
 = -1;

2200  
»suÉ
;

2202  
	`nvme_ü—‹_io_queues
(
dev
);

2203 
	}
}

2205 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

2207 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2209 
	`blk_mq_ä“_»que¡
(
»q
);

2210 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

2211 
	}
}

2213 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
blk_¡©us_t
 
”rÜ
)

2215 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2217 ià(!
”rÜ
) {

2218 
æags
;

2225 
	`¥š_lock_œq§ve_Ã¡ed
(&
nvmeq
->
q_lock
, 
æags
,

2226 
SINGLE_DEPTH_NESTING
);

2227 
	`nvme_´oûss_cq
(
nvmeq
);

2228 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

2231 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

2232 
	}
}

2234 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
)

2236 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

2237 
»que¡
 *
»q
;

2238 
nvme_commªd
 
cmd
;

2240 
	`mem£t
(&
cmd
, 0, (cmd));

2241 
cmd
.
d–‘e_queue
.
İcode
 = opcode;

2242 
cmd
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

2244 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

2245 ià(
	`IS_ERR
(
»q
))

2246  
	`PTR_ERR
(
»q
);

2248 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

2249 
»q
->
’d_io_d©a
 = 
nvmeq
;

2251 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

2252 
İcode
 =ğ
nvme_admš_d–‘e_cq
 ?

2253 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

2255 
	}
}

2257 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
, 
queues
)

2259 
·ss
;

2260 
timeout
;

2261 
u8
 
İcode
 = 
nvme_admš_d–‘e_sq
;

2263 
·ss
 = 0;…ass < 2;…ass++) {

2264 
£Á
 = 0, 
i
 = 
queues
;

2266 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2267 
»Œy
:

2268 
timeout
 = 
ADMIN_TIMEOUT
;

2269 ; 
i
 > 0; i--, 
£Á
++)

2270 ià(
	`nvme_d–‘e_queue
(
dev
->
queues
[
i
], 
İcode
))

2273 
£Á
--) {

2274 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

2275 ià(
timeout
 == 0)

2277 ià(
i
)

2278 
»Œy
;

2280 
İcode
 = 
nvme_admš_d–‘e_cq
;

2282 
	}
}

2290 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2292 ià(!
dev
->
ù¾
.
g£t
) {

2293 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

2294 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

2295 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2296 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

2297 
dev
->
g£t
.
queue_d•th
 =

2298 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

2299 
dev
->
g£t
.
cmd_size
 = 
	`nvme_pci_cmd_size
(dev, 
çl£
);

2300 ià((
dev
->
ù¾
.
sgls
 & ((1 << 0è| (1 << 1))è&& 
sgl_th»shŞd
) {

2301 
dev
->
g£t
.
cmd_size
 = 
	`max
(dev->tagset.cmd_size,

2302 
	`nvme_pci_cmd_size
(
dev
, 
Œue
));

2304 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2305 
dev
->
g£t
.
driv”_d©a
 = dev;

2307 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

2309 
dev
->
ù¾
.
g£t
 = &dev->tagset;

2311 
	`nvme_dbbuf_£t
(
dev
);

2313 
	`blk_mq_upd©e_Ä_hw_queues
(&
dev
->
g£t
, dev->
Úlše_queues
 - 1);

2316 
	`nvme_ä“_queues
(
dev
, dev->
Úlše_queues
);

2320 
	}
}

2322 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

2324 
»suÉ
 = -
ENOMEM
;

2325 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2327 ià(
	`pci_’abË_deviû_mem
(
pdev
))

2328  
»suÉ
;

2330 
	`pci_£t_ma¡”
(
pdev
);

2332 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

2333 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

2334 
di§bË
;

2336 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

2337 
»suÉ
 = -
ENODEV
;

2338 
di§bË
;

2346 
»suÉ
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1, 1, 
PCI_IRQ_ALL_TYPES
);

2347 ià(
»suÉ
 < 0)

2348  
»suÉ
;

2350 
dev
->
ù¾
.
ÿp
 = 
	`lo_hi_»adq
(dev->
b¬
 + 
NVME_REG_CAP
);

2352 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(dev->
ù¾
.
ÿp
) + 1,

2353 
io_queue_d•th
);

2354 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(dev->
ù¾
.
ÿp
);

2355 
dev
->
dbs
 = dev->
b¬
 + 4096;

2361 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_APPLE
 &&…dev->
deviû
 == 0x2001) {

2362 
dev
->
q_d•th
 = 2;

2363 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "detected Apple NVMe controller, "

2365 
dev
->
q_d•th
);

2366 } ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_SAMSUNG
 &&

2367 (
pdev
->
deviû
 == 0xa821 ||…dev->device == 0xa822) &&

2368 
	`NVME_CAP_MQES
(
dev
->
ù¾
.
ÿp
) == 0) {

2369 
dev
->
q_d•th
 = 64;

2370 
	`dev_”r
(
dev
->
ù¾
.
deviû
, "detected PM1725 NVMe controller, "

2371 "£ˆqueud•th=%u\n", 
dev
->
q_d•th
);

2381 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 2, 0)) {

2382 
dev
->
cmb
 = 
	`nvme_m­_cmb
(dev);

2383 ià(
dev
->
cmb
) {

2384 ià(
	`sysfs_add_fe_to_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

2385 &
dev_©Œ_cmb
.
©Œ
, 
NULL
))

2386 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2391 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

2392 
	`pci_§ve_¡©e
(
pdev
);

2395 
di§bË
:

2396 
	`pci_di§bË_deviû
(
pdev
);

2397  
»suÉ
;

2398 
	}
}

2400 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

2402 ià(
dev
->
b¬
)

2403 
	`iounm­
(
dev
->
b¬
);

2404 
	`pci_»Ëa£_mem_»giÚs
(
	`to_pci_dev
(
dev
->dev));

2405 
	}
}

2407 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

2409 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2411 
	`nvme_»Ëa£_cmb
(
dev
);

2412 
	`pci_ä“_œq_veùÜs
(
pdev
);

2414 ià(
	`pci_is_’abËd
(
pdev
)) {

2415 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

2416 
	`pci_di§bË_deviû
(
pdev
);

2418 
	}
}

2420 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

2422 
i
, 
queues
;

2423 
boŞ
 
d—d
 = 
Œue
;

2424 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2426 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

2427 ià(
	`pci_is_’abËd
(
pdev
)) {

2428 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

2430 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_LIVE
 ||

2431 
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
)

2432 
	`nvme_¡¬t_ä“ze
(&
dev
->
ù¾
);

2433 
d—d
 = !!((
c¡s
 & 
NVME_CSTS_CFS
è|| !(c¡ & 
NVME_CSTS_RDY
) ||

2434 
pdev
->
”rÜ_¡©e
 !ğ
pci_chªÃl_io_nÜm®
);

2441 ià(!
d—d
) {

2442 ià(
shutdown
)

2443 
	`nvme_wa™_ä“ze_timeout
(&
dev
->
ù¾
, 
NVME_IO_TIMEOUT
);

2451 ià(
dev
->
ho¡_mem_descs
)

2452 
	`nvme_£t_ho¡_mem
(
dev
, 0);

2455 
	`nvme_¡İ_queues
(&
dev
->
ù¾
);

2457 
queues
 = 
dev
->
Úlše_queues
 - 1;

2458 
i
 = 
dev
->
ù¾
.
queue_couÁ
 - 1; i > 0; i--)

2459 
	`nvme_su¥’d_queue
(
dev
->
queues
[
i
]);

2461 ià(
d—d
) {

2466 ià(
dev
->
ù¾
.
queue_couÁ
)

2467 
	`nvme_su¥’d_queue
(
dev
->
queues
[0]);

2469 
	`nvme_di§bË_io_queues
(
dev
, 
queues
);

2470 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

2472 
	`nvme_pci_di§bË
(
dev
);

2474 
	`blk_mq_g£t_busy_™”
(&
dev
->
g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

2475 
	`blk_mq_g£t_busy_™”
(&
dev
->
admš_g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

2482 ià(
shutdown
)

2483 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2484 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

2485 
	}
}

2487 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

2489 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist…age", dev->dev,

2490 
PAGE_SIZE
, PAGE_SIZE, 0);

2491 ià(!
dev
->
´p_·ge_poŞ
)

2492  -
ENOMEM
;

2495 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist 256", dev->dev,

2497 ià(!
dev
->
´p_sm®l_poŞ
) {

2498 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2499  -
ENOMEM
;

2502 
	}
}

2504 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

2506 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2507 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

2508 
	}
}

2510 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

2512 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2514 
	`nvme_dbbuf_dma_ä“
(
dev
);

2515 
	`put_deviû
(
dev
->dev);

2516 ià(
dev
->
g£t
.
gs
)

2517 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

2518 ià(
dev
->
ù¾
.
admš_q
)

2519 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2520 
	`kä“
(
dev
->
queues
);

2521 
	`ä“_İ®_dev
(
dev
->
ù¾
.
İ®_dev
);

2522 
	`kä“
(
dev
);

2523 
	}
}

2525 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
, 
¡©us
)

2527 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "Removšg‡á”…robçu» stus: %d\n", 
¡©us
);

2529 
	`nvme_g‘_ù¾
(&
dev
->
ù¾
);

2530 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2531 ià(!
	`queue_wÜk
(
nvme_wq
, &
dev
->
»move_wÜk
))

2532 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2533 
	}
}

2535 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2537 
nvme_dev
 *
dev
 =

2538 
	`cÚš”_of
(
wÜk
, 
nvme_dev
, 
ù¾
.
»£t_wÜk
);

2539 
boŞ
 
was_su¥’d
 = !!(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_SHN_NORMAL
);

2540 
»suÉ
 = -
ENODEV
;

2542 ià(
	`WARN_ON
(
dev
->
ù¾
.
¡©e
 !ğ
NVME_CTRL_RESETTING
))

2543 
out
;

2549 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

2550 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2552 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

2553 ià(
»suÉ
)

2554 
out
;

2556 
»suÉ
 = 
	`nvme_pci_cÚfigu»_admš_queue
(
dev
);

2557 ià(
»suÉ
)

2558 
out
;

2560 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2561 ià(
»suÉ
)

2562 
out
;

2564 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2565 ià(
»suÉ
)

2566 
out
;

2568 ià(
dev
->
ù¾
.
ßcs
 & 
NVME_CTRL_OACS_SEC_SUPP
) {

2569 ià(!
dev
->
ù¾
.
İ®_dev
)

2570 
dev
->
ù¾
.
İ®_dev
 =

2571 
	`š™_İ®_dev
(&
dev
->
ù¾
, &
nvme_£c_subm™
);

2572 ià(
was_su¥’d
)

2573 
	`İ®_uÆock_äom_su¥’d
(
dev
->
ù¾
.
İ®_dev
);

2575 
	`ä“_İ®_dev
(
dev
->
ù¾
.
İ®_dev
);

2576 
dev
->
ù¾
.
İ®_dev
 = 
NULL
;

2579 ià(
dev
->
ù¾
.
ßcs
 & 
NVME_CTRL_OACS_DBBUF_SUPP
) {

2580 
»suÉ
 = 
	`nvme_dbbuf_dma_®loc
(
dev
);

2581 ià(
»suÉ
)

2582 
	`dev_w¬n
(
dev
->dev,

2586 ià(
dev
->
ù¾
.
hm´e
) {

2587 
»suÉ
 = 
	`nvme_£tup_ho¡_mem
(
dev
);

2588 ià(
»suÉ
 < 0)

2589 
out
;

2592 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2593 ià(
»suÉ
)

2594 
out
;

2600 ià(
dev
->
Úlše_queues
 < 2) {

2601 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "IO queues‚ot created\n");

2602 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2603 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2605 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2606 
	`nvme_wa™_ä“ze
(&
dev
->
ù¾
);

2607 
	`nvme_dev_add
(
dev
);

2608 
	`nvme_unä“ze
(&
dev
->
ù¾
);

2611 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_LIVE
)) {

2612 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "failedo mark controller†ive\n");

2613 
out
;

2616 
	`nvme_¡¬t_ù¾
(&
dev
->
ù¾
);

2619 
out
:

2620 
	`nvme_»move_d—d_ù¾
(
dev
, 
»suÉ
);

2621 
	}
}

2623 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2625 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2626 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2628 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2629 ià(
	`pci_g‘_drvd©a
(
pdev
))

2630 
	`deviû_»Ëa£_driv”
(&
pdev
->
dev
);

2631 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2632 
	}
}

2634 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2636 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2638 
	}
}

2640 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2642 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2644 
	}
}

2646 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2648 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2650 
	}
}

2652 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_pci_ù¾_İs
 = {

2653 .
Çme
 = "pcie",

2654 .
	gmoduË
 = 
THIS_MODULE
,

2655 .
	gæags
 = 
NVME_F_METADATA_SUPPORTED
,

2656 .
	g»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2657 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2658 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2659 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2660 .
	gsubm™_async_ev’t
 = 
nvme_pci_subm™_async_ev’t
,

2663 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2665 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2667 ià(
	`pci_»que¡_mem_»giÚs
(
pdev
, "nvme"))

2668  -
ENODEV
;

2670 ià(
	`nvme_»m­_b¬
(
dev
, 
NVME_REG_DBS
 + 4096))

2671 
»Ëa£
;

2674 
»Ëa£
:

2675 
	`pci_»Ëa£_mem_»giÚs
(
pdev
);

2676  -
ENODEV
;

2677 
	}
}

2679 
	$check_v’dÜ_combš©iÚ_bug
(
pci_dev
 *
pdev
)

2681 ià(
pdev
->
v’dÜ
 =ğ0x144d &&…dev->
deviû
 == 0xa802) {

2690 ià(
	`dmi_m©ch
(
DMI_SYS_VENDOR
, "Dell Inc.") &&

2691 (
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "XPS 15 9550") ||

2692 
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "Precision 5510")))

2693  
NVME_QUIRK_NO_DEEPEST_PS
;

2694 } ià(
pdev
->
v’dÜ
 =ğ0x144d &&…dev->
deviû
 == 0xa804) {

2699 ià(
	`dmi_m©ch
(
DMI_BOARD_VENDOR
, "ASUSTeK COMPUTER INC.") &&

2700 
	`dmi_m©ch
(
DMI_BOARD_NAME
, "PRIME B350M-A"))

2701  
NVME_QUIRK_NO_APST
;

2705 
	}
}

2707 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2709 
node
, 
»suÉ
 = -
ENOMEM
;

2710 
nvme_dev
 *
dev
;

2711 
quœks
 = 
id
->
driv”_d©a
;

2713 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2714 ià(
node
 =ğ
NUMA_NO_NODE
)

2715 
	`£t_dev_node
(&
pdev
->
dev
, 
fœ¡_memÜy_node
);

2717 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

2718 ià(!
dev
)

2719  -
ENOMEM
;

2720 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

2721 
GFP_KERNEL
, 
node
);

2722 ià(!
dev
->
queues
)

2723 
ä“
;

2725 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

2726 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2728 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

2729 ià(
»suÉ
)

2730 
put_pci
;

2732 
	`INIT_WORK
(&
dev
->
ù¾
.
»£t_wÜk
, 
nvme_»£t_wÜk
);

2733 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

2734 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

2735 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2737 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2738 ià(
»suÉ
)

2739 
unm­
;

2741 
quœks
 |ğ
	`check_v’dÜ_combš©iÚ_bug
(
pdev
);

2743 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_İs
,

2744 
quœks
);

2745 ià(
»suÉ
)

2746 
»Ëa£_poŞs
;

2748 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_RESETTING
);

2749 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "pc˜funùiÚ %s\n", 
	`dev_Çme
(&
pdev
->dev));

2751 
	`queue_wÜk
(
nvme_wq
, &
dev
->
ù¾
.
»£t_wÜk
);

2754 
»Ëa£_poŞs
:

2755 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2756 
unm­
:

2757 
	`nvme_dev_unm­
(
dev
);

2758 
put_pci
:

2759 
	`put_deviû
(
dev
->dev);

2760 
ä“
:

2761 
	`kä“
(
dev
->
queues
);

2762 
	`kä“
(
dev
);

2763  
»suÉ
;

2764 
	}
}

2766 
	$nvme_»£t_´•¬e
(
pci_dev
 *
pdev
)

2768 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2769 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2770 
	}
}

2772 
	$nvme_»£t_dÚe
(
pci_dev
 *
pdev
)

2774 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2775 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

2776 
	}
}

2778 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2780 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2781 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2782 
	}
}

2789 
	$nvme_»move
(
pci_dev
 *
pdev
)

2791 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2793 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DELETING
);

2795 
	`ÿnûl_wÜk_sync
(&
dev
->
ù¾
.
»£t_wÜk
);

2796 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2798 ià(!
	`pci_deviû_is_´e£Á
(
pdev
)) {

2799 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DEAD
);

2800 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2803 
	`æush_wÜk
(&
dev
->
ù¾
.
»£t_wÜk
);

2804 
	`nvme_¡İ_ù¾
(&
dev
->
ù¾
);

2805 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2806 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2807 
	`nvme_ä“_ho¡_mem
(
dev
);

2808 
	`nvme_dev_»move_admš
(
dev
);

2809 
	`nvme_ä“_queues
(
dev
, 0);

2810 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

2811 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2812 
	`nvme_dev_unm­
(
dev
);

2813 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2814 
	}
}

2816 
	$nvme_pci_¤iov_cÚfigu»
(
pci_dev
 *
pdev
, 
numvfs
)

2818 
»t
 = 0;

2820 ià(
numvfs
 == 0) {

2821 ià(
	`pci_vfs_assigÃd
(
pdev
)) {

2822 
	`dev_w¬n
(&
pdev
->
dev
,

2824  -
EPERM
;

2826 
	`pci_di§bË_¤iov
(
pdev
);

2830 
»t
 = 
	`pci_’abË_¤iov
(
pdev
, 
numvfs
);

2831  
»t
 ?„‘ : 
numvfs
;

2832 
	}
}

2834 #ifdeà
CONFIG_PM_SLEEP


2835 
	$nvme_su¥’d
(
deviû
 *
dev
)

2837 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2838 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2840 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

2842 
	}
}

2844 
	$nvme_»sume
(
deviû
 *
dev
)

2846 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2847 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2849 
	`nvme_»£t_ù¾
(&
ndev
->
ù¾
);

2851 
	}
}

2854 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

2856 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

2857 
pci_chªÃl_¡©e_t
 
¡©e
)

2859 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2866 
¡©e
) {

2867 
pci_chªÃl_io_nÜm®
:

2868  
PCI_ERS_RESULT_CAN_RECOVER
;

2869 
pci_chªÃl_io_äoz’
:

2870 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2872 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2873  
PCI_ERS_RESULT_NEED_RESET
;

2874 
pci_chªÃl_io_³rm_çu»
:

2875 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2877  
PCI_ERS_RESULT_DISCONNECT
;

2879  
PCI_ERS_RESULT_NEED_RESET
;

2880 
	}
}

2882 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

2884 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2886 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "restart‡fter slot„eset\n");

2887 
	`pci_»¡Üe_¡©e
(
pdev
);

2888 
	`nvme_»£t_ù¾
(&
dev
->
ù¾
);

2889  
PCI_ERS_RESULT_RECOVERED
;

2890 
	}
}

2892 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

2894 
	`pci_ş—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

2895 
	}
}

2897 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2898 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2899 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2900 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2901 .
	g»£t_´•¬e
 = 
nvme_»£t_´•¬e
,

2902 .
	g»£t_dÚe
 = 
nvme_»£t_dÚe
,

2905 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

2906 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2907 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2908 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2909 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

2910 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2911 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2912 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

2913 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2914 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2915 { 
PCI_VDEVICE
(
INTEL
, 0x0a55),

2916 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2917 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2918 { 
PCI_VDEVICE
(
INTEL
, 0xf1a5),

2919 .
	gdriv”_d©a
 = 
NVME_QUIRK_NO_DEEPEST_PS
 },

2920 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2921 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

2922 { 
PCI_DEVICE
(0x1c58, 0x0003),

2923 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2924 { 
PCI_DEVICE
(0x1c58, 0x0023),

2925 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2926 { 
PCI_DEVICE
(0x1c5f, 0x0540),

2927 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2928 { 
PCI_DEVICE
(0x144d, 0xa821),

2929 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2930 { 
PCI_DEVICE
(0x144d, 0xa822),

2931 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2932 { 
PCI_DEVICE
(0x1d1d, 0x1f1f),

2933 .
	gdriv”_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

2934 { 
PCI_DEVICE
(0x1d1d, 0x2807),

2935 .
	gdriv”_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

2936 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2937 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

2938 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2003) },

2941 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2943 
pci_driv”
 
	gnvme_driv”
 = {

2944 .
Çme
 = "nvme",

2945 .
	gid_bË
 = 
nvme_id_bË
,

2946 .
	g´obe
 = 
nvme_´obe
,

2947 .
	g»move
 = 
nvme_»move
,

2948 .
	gshutdown
 = 
nvme_shutdown
,

2949 .
	gdriv”
 = {

2950 .
pm
 = &
nvme_dev_pm_İs
,

2952 .
	g¤iov_cÚfigu»
 = 
nvme_pci_¤iov_cÚfigu»
,

2953 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2956 
__š™
 
	$nvme_š™
()

2958  
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2959 
	}
}

2961 
__ex™
 
	$nvme_ex™
()

2963 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2964 
	`æush_wÜkqueue
(
nvme_wq
);

2965 
	`_nvme_check_size
();

2966 
	}
}

2968 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

2969 
MODULE_LICENSE
("GPL");

2970 
MODULE_VERSION
("1.0");

2971 
moduË_š™
(
nvme_š™
);

2972 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/rdma.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/moduË.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<rdma/mr_poŞ.h
>

19 
	~<lšux/”r.h
>

20 
	~<lšux/¡ršg.h
>

21 
	~<lšux/©omic.h
>

22 
	~<lšux/blk-mq.h
>

23 
	~<lšux/blk-mq-rdma.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/li¡.h
>

26 
	~<lšux/mu‹x.h
>

27 
	~<lšux/sÿ‰”li¡.h
>

28 
	~"lšux_nvme.h
"

29 
	~<asm/uÇligÃd.h
>

31 
	~<rdma/ib_v”bs.h
>

32 
	~<rdma/rdma_cm.h
>

33 
	~<lšux/nvme-rdma.h
>

35 
	~"nvme.h
"

36 
	~"çbrics.h
"

39 
	#NVME_RDMA_CONNECT_TIMEOUT_MS
 3000

	)

41 
	#NVME_RDMA_MAX_SEGMENTS
 256

	)

43 
	#NVME_RDMA_MAX_INLINE_SEGMENTS
 1

	)

45 
	snvme_rdma_deviû
 {

46 
ib_deviû
 *
	mdev
;

47 
ib_pd
 *
	mpd
;

48 
k»f
 
	m»f
;

49 
li¡_h—d
 
	m’Œy
;

52 
	snvme_rdma_qe
 {

53 
ib_cqe
 
	mcqe
;

54 *
	md©a
;

55 
u64
 
	mdma
;

58 
	gnvme_rdma_queue
;

59 
	snvme_rdma_»que¡
 {

60 
nvme_»que¡
 
	m»q
;

61 
ib_mr
 *
	mmr
;

62 
nvme_rdma_qe
 
	msqe
;

63 
nvme_»suÉ
 
	m»suÉ
;

64 
__Ë16
 
	m¡©us
;

65 
»fcouÁ_t
 
	m»f
;

66 
ib_sge
 
	msge
[1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
];

67 
u32
 
	mnum_sge
;

68 
	mÃÁs
;

69 
boŞ
 
	mšlše_d©a
;

70 
ib_»g_wr
 
	m»g_wr
;

71 
ib_cqe
 
	m»g_cqe
;

72 
nvme_rdma_queue
 *
	mqueue
;

73 
sg_bË
 
	msg_bË
;

74 
sÿ‰”li¡
 
	mfœ¡_sgl
[];

77 
	envme_rdma_queue_æags
 {

78 
	mNVME_RDMA_Q_ALLOCATED
 = 0,

79 
	mNVME_RDMA_Q_LIVE
 = 1,

80 
	mNVME_RDMA_Q_TR_READY
 = 2,

83 
	snvme_rdma_queue
 {

84 
nvme_rdma_qe
 *
	mr¥_ršg
;

85 
	mqueue_size
;

86 
size_t
 
	mcmnd_ÿpsuË_Ën
;

87 
nvme_rdma_ù¾
 *
	mù¾
;

88 
nvme_rdma_deviû
 *
	mdeviû
;

89 
ib_cq
 *
	mib_cq
;

90 
ib_qp
 *
	mqp
;

92 
	mæags
;

93 
rdma_cm_id
 *
	mcm_id
;

94 
	mcm_”rÜ
;

95 
com¶‘iÚ
 
	mcm_dÚe
;

98 
	snvme_rdma_ù¾
 {

100 
nvme_rdma_queue
 *
	mqueues
;

103 
blk_mq_g_£t
 
	mg_£t
;

104 
wÜk_¡ruù
 
	m”r_wÜk
;

106 
nvme_rdma_qe
 
	masync_ev’t_sqe
;

108 
d–ayed_wÜk
 
	m»cÚÃù_wÜk
;

110 
li¡_h—d
 
	mli¡
;

112 
blk_mq_g_£t
 
	madmš_g_£t
;

113 
nvme_rdma_deviû
 *
	mdeviû
;

115 
u32
 
	mmax_ä_·ges
;

117 
sockaddr_¡Üage
 
	maddr
;

118 
sockaddr_¡Üage
 
	m¤c_addr
;

120 
nvme_ù¾
 
	mù¾
;

123 
šlše
 
nvme_rdma_ù¾
 *
	$to_rdma_ù¾
(
nvme_ù¾
 *
ù¾
)

125  
	`cÚš”_of
(
ù¾
, 
nvme_rdma_ù¾
, ctrl);

126 
	}
}

128 
LIST_HEAD
(
deviû_li¡
);

129 
DEFINE_MUTEX
(
deviû_li¡_mu‹x
);

131 
LIST_HEAD
(
nvme_rdma_ù¾_li¡
);

132 
DEFINE_MUTEX
(
nvme_rdma_ù¾_mu‹x
);

139 
boŞ
 
	g»gi¡”_®ways
 = 
Œue
;

140 
moduË_·¿m
(
»gi¡”_®ways
, 
boŞ
, 0444);

141 
MODULE_PARM_DESC
(
»gi¡”_®ways
,

144 
nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

145 
rdma_cm_ev’t
 *
ev’t
);

146 
nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
);

148 cÚ¡ 
blk_mq_İs
 
	gnvme_rdma_mq_İs
;

149 cÚ¡ 
blk_mq_İs
 
	gnvme_rdma_admš_mq_İs
;

152 
šlše
 
	$put_uÇligÃd_Ë24
(
u32
 
v®
, 
u8
 *
p
)

154 *
p
++ = 
v®
;

155 *
p
++ = 
v®
 >> 8;

156 *
p
++ = 
v®
 >> 16;

157 
	}
}

159 
šlše
 
	$nvme_rdma_queue_idx
(
nvme_rdma_queue
 *
queue
)

161  
queue
 - queue->
ù¾
->
queues
;

162 
	}
}

164 
šlše
 
size_t
 
	$nvme_rdma_šlše_d©a_size
(
nvme_rdma_queue
 *
queue
)

166  
queue
->
cmnd_ÿpsuË_Ën
 - (
nvme_commªd
);

167 
	}
}

169 
	$nvme_rdma_ä“_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

170 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

172 
	`ib_dma_unm­_sšgË
(
ibdev
, 
qe
->
dma
, 
ÿpsuË_size
, 
dœ
);

173 
	`kä“
(
qe
->
d©a
);

174 
	}
}

176 
	$nvme_rdma_®loc_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

177 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

179 
qe
->
d©a
 = 
	`kz®loc
(
ÿpsuË_size
, 
GFP_KERNEL
);

180 ià(!
qe
->
d©a
)

181  -
ENOMEM
;

183 
qe
->
dma
 = 
	`ib_dma_m­_sšgË
(
ibdev
, qe->
d©a
, 
ÿpsuË_size
, 
dœ
);

184 ià(
	`ib_dma_m­pšg_”rÜ
(
ibdev
, 
qe
->
dma
)) {

185 
	`kä“
(
qe
->
d©a
);

186  -
ENOMEM
;

190 
	}
}

192 
	$nvme_rdma_ä“_ršg
(
ib_deviû
 *
ibdev
,

193 
nvme_rdma_qe
 *
ršg
, 
size_t
 
ib_queue_size
,

194 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

196 
i
;

198 
i
 = 0; i < 
ib_queue_size
; i++)

199 
	`nvme_rdma_ä“_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
);

200 
	`kä“
(
ršg
);

201 
	}
}

203 
nvme_rdma_qe
 *
	$nvme_rdma_®loc_ršg
(
ib_deviû
 *
ibdev
,

204 
size_t
 
ib_queue_size
, size_ˆ
ÿpsuË_size
,

205 
dma_d©a_dœeùiÚ
 
dœ
)

207 
nvme_rdma_qe
 *
ršg
;

208 
i
;

210 
ršg
 = 
	`kÿÎoc
(
ib_queue_size
, (
nvme_rdma_qe
), 
GFP_KERNEL
);

211 ià(!
ršg
)

212  
NULL
;

214 
i
 = 0; i < 
ib_queue_size
; i++) {

215 ià(
	`nvme_rdma_®loc_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
))

216 
out_ä“_ršg
;

219  
ršg
;

221 
out_ä“_ršg
:

222 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
ršg
, 
i
, 
ÿpsuË_size
, 
dœ
);

223  
NULL
;

224 
	}
}

226 
	$nvme_rdma_qp_ev’t
(
ib_ev’t
 *
ev’t
, *
cÚ‹xt
)

228 
	`´_debug
("QPƒvent %s (%d)\n",

229 
	`ib_ev’t_msg
(
ev’t
->event),ƒvent->event);

231 
	}
}

233 
	$nvme_rdma_wa™_fÜ_cm
(
nvme_rdma_queue
 *
queue
)

235 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(&
queue
->
cm_dÚe
,

236 
	`m£cs_to_jiff›s
(
NVME_RDMA_CONNECT_TIMEOUT_MS
) + 1);

237  
queue
->
cm_”rÜ
;

238 
	}
}

240 
	$nvme_rdma_ü—‹_qp
(
nvme_rdma_queue
 *
queue
, cÚ¡ 
çùÜ
)

242 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

243 
ib_qp_š™_©Œ
 
š™_©Œ
;

244 
»t
;

246 
	`mem£t
(&
š™_©Œ
, 0, (init_attr));

247 
š™_©Œ
.
ev’t_hªdËr
 = 
nvme_rdma_qp_ev’t
;

249 
š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
çùÜ
 * 
queue
->
queue_size
 + 1;

251 
š™_©Œ
.
ÿp
.
max_»cv_wr
 = 
queue
->
queue_size
 + 1;

252 
š™_©Œ
.
ÿp
.
max_»cv_sge
 = 1;

253 
š™_©Œ
.
ÿp
.
max_£nd_sge
 = 1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
;

254 
š™_©Œ
.
sq_sig_ty³
 = 
IB_SIGNAL_REQ_WR
;

255 
š™_©Œ
.
qp_ty³
 = 
IB_QPT_RC
;

256 
š™_©Œ
.
£nd_cq
 = 
queue
->
ib_cq
;

257 
š™_©Œ
.
»cv_cq
 = 
queue
->
ib_cq
;

259 
»t
 = 
	`rdma_ü—‹_qp
(
queue
->
cm_id
, 
dev
->
pd
, &
š™_©Œ
);

261 
queue
->
qp
 = queue->
cm_id
->qp;

262  
»t
;

263 
	}
}

265 
	$nvme_rdma_ex™_»que¡
(
blk_mq_g_£t
 *
£t
,

266 
»que¡
 *
rq
, 
hùx_idx
)

268 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

269 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

270 
queue_idx
 = (
£t
 =ğ&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

271 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

272 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

274 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

275 
DMA_TO_DEVICE
);

276 
	}
}

278 
	$nvme_rdma_š™_»que¡
(
blk_mq_g_£t
 *
£t
,

279 
»que¡
 *
rq
, 
hùx_idx
,

280 
numa_node
)

282 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

283 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

284 
queue_idx
 = (
£t
 =ğ&
ù¾
->
g_£t
è? 
hùx_idx
 + 1 : 0;

285 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

286 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

287 
ib_deviû
 *
ibdev
 = 
dev
->dev;

288 
»t
;

290 
»t
 = 
	`nvme_rdma_®loc_qe
(
ibdev
, &
»q
->
sqe
, (
nvme_commªd
),

291 
DMA_TO_DEVICE
);

292 ià(
»t
)

293  
»t
;

295 
»q
->
queue
 = queue;

298 
	}
}

300 
	$nvme_rdma_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

301 
hùx_idx
)

303 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

304 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
 + 1];

306 
	`BUG_ON
(
hùx_idx
 >ğ
ù¾
->ù¾.
queue_couÁ
);

308 
hùx
->
driv”_d©a
 = 
queue
;

310 
	}
}

312 
	$nvme_rdma_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

313 
hùx_idx
)

315 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

316 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

318 
	`BUG_ON
(
hùx_idx
 != 0);

320 
hùx
->
driv”_d©a
 = 
queue
;

322 
	}
}

324 
	$nvme_rdma_ä“_dev
(
k»f
 *
»f
)

326 
nvme_rdma_deviû
 *
ndev
 =

327 
	`cÚš”_of
(
»f
, 
nvme_rdma_deviû
,„ef);

329 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

330 
	`li¡_d–
(&
ndev
->
’Œy
);

331 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

333 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

334 
	`kä“
(
ndev
);

335 
	}
}

337 
	$nvme_rdma_dev_put
(
nvme_rdma_deviû
 *
dev
)

339 
	`k»f_put
(&
dev
->
»f
, 
nvme_rdma_ä“_dev
);

340 
	}
}

342 
	$nvme_rdma_dev_g‘
(
nvme_rdma_deviû
 *
dev
)

344  
	`k»f_g‘_uÆess_z”o
(&
dev
->
»f
);

345 
	}
}

347 
nvme_rdma_deviû
 *

348 
	$nvme_rdma_fšd_g‘_deviû
(
rdma_cm_id
 *
cm_id
)

350 
nvme_rdma_deviû
 *
ndev
;

352 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

353 
	`li¡_fÜ_—ch_’Œy
(
ndev
, &
deviû_li¡
, 
’Œy
) {

354 ià(
ndev
->
dev
->
node_guid
 =ğ
cm_id
->
deviû
->node_guid &&

355 
	`nvme_rdma_dev_g‘
(
ndev
))

356 
out_uÆock
;

359 
ndev
 = 
	`kz®loc
((*ndev), 
GFP_KERNEL
);

360 ià(!
ndev
)

361 
out_”r
;

363 
ndev
->
dev
 = 
cm_id
->
deviû
;

364 
	`k»f_š™
(&
ndev
->
»f
);

366 
ndev
->
pd
 = 
	`ib_®loc_pd
Òdev->
dev
,

367 
»gi¡”_®ways
 ? 0 : 
IB_PD_UNSAFE_GLOBAL_RKEY
);

368 ià(
	`IS_ERR
(
ndev
->
pd
))

369 
out_ä“_dev
;

371 ià(!(
ndev
->
dev
->
©Œs
.
deviû_ÿp_æags
 &

372 
IB_DEVICE_MEM_MGT_EXTENSIONS
)) {

373 
	`dev_”r
(&
ndev
->
dev
->dev,

375 
out_ä“_pd
;

378 
	`li¡_add
(&
ndev
->
’Œy
, &
deviû_li¡
);

379 
out_uÆock
:

380 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

381  
ndev
;

383 
out_ä“_pd
:

384 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

385 
out_ä“_dev
:

386 
	`kä“
(
ndev
);

387 
out_”r
:

388 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

389  
NULL
;

390 
	}
}

392 
	$nvme_rdma_de¡roy_queue_ib
(
nvme_rdma_queue
 *
queue
)

394 
nvme_rdma_deviû
 *
dev
;

395 
ib_deviû
 *
ibdev
;

397 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_RDMA_Q_TR_READY
, &
queue
->
æags
))

400 
dev
 = 
queue
->
deviû
;

401 
ibdev
 = 
dev
->dev;

403 
	`ib_mr_poŞ_de¡roy
(
queue
->
qp
, &queue->qp->
rdma_mrs
);

410 
	`ib_de¡roy_qp
(
queue
->
qp
);

411 
	`ib_ä“_cq
(
queue
->
ib_cq
);

413 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

414 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

416 
	`nvme_rdma_dev_put
(
dev
);

417 
	}
}

419 
	$nvme_rdma_g‘_max_ä_·ges
(
ib_deviû
 *
ibdev
)

421  
	`mš_t
(
u32
, 
NVME_RDMA_MAX_SEGMENTS
,

422 
ibdev
->
©Œs
.
max_ç¡_»g_·ge_li¡_Ën
);

423 
	}
}

425 
	$nvme_rdma_ü—‹_queue_ib
(
nvme_rdma_queue
 *
queue
)

427 
ib_deviû
 *
ibdev
;

428 cÚ¡ 
£nd_wr_çùÜ
 = 3;

429 cÚ¡ 
cq_çùÜ
 = 
£nd_wr_çùÜ
 + 1;

430 
comp_veùÜ
, 
idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

431 
»t
;

433 
queue
->
deviû
 = 
	`nvme_rdma_fšd_g‘_deviû
(queue->
cm_id
);

434 ià(!
queue
->
deviû
) {

435 
	`dev_”r
(
queue
->
cm_id
->
deviû
->
dev
.
·»Á
,

437  -
ECONNREFUSED
;

439 
ibdev
 = 
queue
->
deviû
->
dev
;

445 
comp_veùÜ
 = 
idx
 == 0 ? idx : idx - 1;

448 
queue
->
ib_cq
 = 
	`ib_®loc_cq
(
ibdev
, queue,

449 
cq_çùÜ
 * 
queue
->
queue_size
 + 1,

450 
comp_veùÜ
, 
IB_POLL_SOFTIRQ
);

451 ià(
	`IS_ERR
(
queue
->
ib_cq
)) {

452 
»t
 = 
	`PTR_ERR
(
queue
->
ib_cq
);

453 
out_put_dev
;

456 
»t
 = 
	`nvme_rdma_ü—‹_qp
(
queue
, 
£nd_wr_çùÜ
);

457 ià(
»t
)

458 
out_de¡roy_ib_cq
;

460 
queue
->
r¥_ršg
 = 
	`nvme_rdma_®loc_ršg
(
ibdev
, queue->
queue_size
,

461 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

462 ià(!
queue
->
r¥_ršg
) {

463 
»t
 = -
ENOMEM
;

464 
out_de¡roy_qp
;

467 
»t
 = 
	`ib_mr_poŞ_š™
(
queue
->
qp
, &queue->qp->
rdma_mrs
,

468 
queue
->
queue_size
,

469 
IB_MR_TYPE_MEM_REG
,

470 
	`nvme_rdma_g‘_max_ä_·ges
(
ibdev
));

471 ià(
»t
) {

472 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

474 
queue
->
queue_size
, 
idx
);

475 
out_de¡roy_ršg
;

478 
	`£t_b™
(
NVME_RDMA_Q_TR_READY
, &
queue
->
æags
);

482 
out_de¡roy_ršg
:

483 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

484 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

485 
out_de¡roy_qp
:

486 
	`rdma_de¡roy_qp
(
queue
->
cm_id
);

487 
out_de¡roy_ib_cq
:

488 
	`ib_ä“_cq
(
queue
->
ib_cq
);

489 
out_put_dev
:

490 
	`nvme_rdma_dev_put
(
queue
->
deviû
);

491  
»t
;

492 
	}
}

494 
	$nvme_rdma_®loc_queue
(
nvme_rdma_ù¾
 *
ù¾
,

495 
idx
, 
size_t
 
queue_size
)

497 
nvme_rdma_queue
 *
queue
;

498 
sockaddr
 *
¤c_addr
 = 
NULL
;

499 
»t
;

501 
queue
 = &
ù¾
->
queues
[
idx
];

502 
queue
->
ù¾
 = ctrl;

503 
	`š™_com¶‘iÚ
(&
queue
->
cm_dÚe
);

505 ià(
idx
 > 0)

506 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

508 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

510 
queue
->
queue_size
 = queue_size;

512 
queue
->
cm_id
 = 
	`rdma_ü—‹_id
(&
š™_Ãt
, 
nvme_rdma_cm_hªdËr
, queue,

513 
RDMA_PS_TCP
, 
IB_QPT_RC
);

514 ià(
	`IS_ERR
(
queue
->
cm_id
)) {

515 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

516 "çedØü—‹ CM ID: %ld\n", 
	`PTR_ERR
(
queue
->
cm_id
));

517  
	`PTR_ERR
(
queue
->
cm_id
);

520 ià(
ù¾
->ù¾.
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

521 
¤c_addr
 = (
sockaddr
 *)&
ù¾
->src_addr;

523 
queue
->
cm_”rÜ
 = -
ETIMEDOUT
;

524 
»t
 = 
	`rdma_»sŞve_addr
(
queue
->
cm_id
, 
¤c_addr
,

525 (
sockaddr
 *)&
ù¾
->
addr
,

526 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

527 ià(
»t
) {

528 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

529 "rdma_»sŞve_add¸çed (%d).\n", 
»t
);

530 
out_de¡roy_cm_id
;

533 
»t
 = 
	`nvme_rdma_wa™_fÜ_cm
(
queue
);

534 ià(
»t
) {

535 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

536 "rdm¨cÚÃùiÚƒ¡ablishm’ˆçed (%d)\n", 
»t
);

537 
out_de¡roy_cm_id
;

540 
	`£t_b™
(
NVME_RDMA_Q_ALLOCATED
, &
queue
->
æags
);

544 
out_de¡roy_cm_id
:

545 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

546 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

547  
»t
;

548 
	}
}

550 
	$nvme_rdma_¡İ_queue
(
nvme_rdma_queue
 *
queue
)

552 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
))

555 
	`rdma_discÚÃù
(
queue
->
cm_id
);

556 
	`ib_d¿š_qp
(
queue
->
qp
);

557 
	}
}

559 
	$nvme_rdma_ä“_queue
(
nvme_rdma_queue
 *
queue
)

561 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_RDMA_Q_ALLOCATED
, &
queue
->
æags
))

564 ià(
	`nvme_rdma_queue_idx
(
queue
) == 0) {

565 
	`nvme_rdma_ä“_qe
(
queue
->
deviû
->
dev
,

566 &
queue
->
ù¾
->
async_ev’t_sqe
,

567 (
nvme_commªd
), 
DMA_TO_DEVICE
);

570 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

571 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

572 
	}
}

574 
	$nvme_rdma_ä“_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

576 
i
;

578 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

579 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[
i
]);

580 
	}
}

582 
	$nvme_rdma_¡İ_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

584 
i
;

586 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++)

587 
	`nvme_rdma_¡İ_queue
(&
ù¾
->
queues
[
i
]);

588 
	}
}

590 
	$nvme_rdma_¡¬t_queue
(
nvme_rdma_ù¾
 *
ù¾
, 
idx
)

592 
»t
;

594 ià(
idx
)

595 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
idx
);

597 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

599 ià(!
»t
)

600 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
idx
].
æags
);

602 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

603 "çedØcÚÃù queue: %d„‘=%d\n", 
idx
, 
»t
);

604  
»t
;

605 
	}
}

607 
	$nvme_rdma_¡¬t_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

609 
i
, 
»t
 = 0;

611 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

612 
»t
 = 
	`nvme_rdma_¡¬t_queue
(
ù¾
, 
i
);

613 ià(
»t
)

614 
out_¡İ_queues
;

619 
out_¡İ_queues
:

620 
i
--; i >= 1; i--)

621 
	`nvme_rdma_¡İ_queue
(&
ù¾
->
queues
[
i
]);

622  
»t
;

623 
	}
}

625 
	$nvme_rdma_®loc_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

627 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

628 
ib_deviû
 *
ibdev
 = 
ù¾
->
deviû
->
dev
;

629 
Ä_io_queues
;

630 
i
, 
»t
;

632 
Ä_io_queues
 = 
	`mš
(
İts
->Ä_io_queues, 
	`num_Úlše_ıus
());

639 
Ä_io_queues
 = 
	`mš_t
(,‚r_io_queues,

640 
ibdev
->
num_comp_veùÜs
);

642 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
Ä_io_queues
);

643 ià(
»t
)

644  
»t
;

646 
ù¾
->ù¾.
queue_couÁ
 = 
Ä_io_queues
 + 1;

647 ià(
ù¾
->ù¾.
queue_couÁ
 < 2)

650 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

651 "ü—tšg %d I/O queues.\n", 
Ä_io_queues
);

653 
i
 = 1; i < 
ù¾
->ù¾.
queue_couÁ
; i++) {

654 
»t
 = 
	`nvme_rdma_®loc_queue
(
ù¾
, 
i
,

655 
ù¾
->ù¾.
sqsize
 + 1);

656 ià(
»t
)

657 
out_ä“_queues
;

662 
out_ä“_queues
:

663 
i
--; i >= 1; i--)

664 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[
i
]);

666  
»t
;

667 
	}
}

669 
	$nvme_rdma_ä“_g£t
(
nvme_ù¾
 *
nù¾
,

670 
blk_mq_g_£t
 *
£t
)

672 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

674 
	`blk_mq_ä“_g_£t
(
£t
);

675 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

676 
	}
}

678 
blk_mq_g_£t
 *
	$nvme_rdma_®loc_g£t
(
nvme_ù¾
 *
nù¾
,

679 
boŞ
 
admš
)

681 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

682 
blk_mq_g_£t
 *
£t
;

683 
»t
;

685 ià(
admš
) {

686 
£t
 = &
ù¾
->
admš_g_£t
;

687 
	`mem£t
(
£t
, 0, (*set));

688 
£t
->
İs
 = &
nvme_rdma_admš_mq_İs
;

689 
£t
->
queue_d•th
 = 
NVME_AQ_MQ_TAG_DEPTH
;

690 
£t
->
»£rved_gs
 = 2;

691 
£t
->
numa_node
 = 
NUMA_NO_NODE
;

692 
£t
->
cmd_size
 = (
nvme_rdma_»que¡
) +

693 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

694 
£t
->
driv”_d©a
 = 
ù¾
;

695 
£t
->
Ä_hw_queues
 = 1;

696 
£t
->
timeout
 = 
ADMIN_TIMEOUT
;

697 
£t
->
æags
 = 
BLK_MQ_F_NO_SCHED
;

699 
£t
 = &
ù¾
->
g_£t
;

700 
	`mem£t
(
£t
, 0, (*set));

701 
£t
->
İs
 = &
nvme_rdma_mq_İs
;

702 
£t
->
queue_d•th
 = 
nù¾
->
İts
->
queue_size
;

703 
£t
->
»£rved_gs
 = 1;

704 
£t
->
numa_node
 = 
NUMA_NO_NODE
;

705 
£t
->
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

706 
£t
->
cmd_size
 = (
nvme_rdma_»que¡
) +

707 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

708 
£t
->
driv”_d©a
 = 
ù¾
;

709 
£t
->
Ä_hw_queues
 = 
nù¾
->
queue_couÁ
 - 1;

710 
£t
->
timeout
 = 
NVME_IO_TIMEOUT
;

713 
»t
 = 
	`blk_mq_®loc_g_£t
(
£t
);

714 ià(
»t
)

715 
out
;

721 
»t
 = 
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
);

722 ià(!
»t
) {

723 
»t
 = -
EINVAL
;

724 
out_ä“_g£t
;

727  
£t
;

729 
out_ä“_g£t
:

730 
	`blk_mq_ä“_g_£t
(
£t
);

731 
out
:

732  
	`ERR_PTR
(
»t
);

733 
	}
}

735 
	$nvme_rdma_de¡roy_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
,

736 
boŞ
 
»move
)

738 
	`nvme_rdma_¡İ_queue
(&
ù¾
->
queues
[0]);

739 ià(
»move
) {

740 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

741 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
admš_g£t
);

743 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

744 
	}
}

746 
	$nvme_rdma_cÚfigu»_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
,

747 
boŞ
 
Ãw
)

749 
”rÜ
;

751 
”rÜ
 = 
	`nvme_rdma_®loc_queue
(
ù¾
, 0, 
NVME_AQ_DEPTH
);

752 ià(
”rÜ
)

753  
”rÜ
;

755 
ù¾
->
deviû
 = cŒl->
queues
[0].device;

757 
ù¾
->
max_ä_·ges
 = 
	`nvme_rdma_g‘_max_ä_·ges
(ù¾->
deviû
->
dev
);

759 ià(
Ãw
) {

760 
ù¾
->ù¾.
admš_g£t
 = 
	`nvme_rdma_®loc_g£t
(&ù¾->ù¾, 
Œue
);

761 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_g£t
)) {

762 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_g£t
);

763 
out_ä“_queue
;

766 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

767 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

768 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

769 
out_ä“_g£t
;

773 
”rÜ
 = 
	`nvme_rdma_¡¬t_queue
(
ù¾
, 0);

774 ià(
”rÜ
)

775 
out_ş—nup_queue
;

777 
”rÜ
 = 
ù¾
->ù¾.
İs
->
	`»g_»ad64
(&ù¾->ù¾, 
NVME_REG_CAP
,

778 &
ù¾
->ù¾.
ÿp
);

779 ià(
”rÜ
) {

780 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

782 
out_ş—nup_queue
;

785 
ù¾
->ù¾.
sqsize
 =

786 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->ù¾.
ÿp
), cŒl->ù¾.
sqsize
);

788 
”rÜ
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

789 ià(
”rÜ
)

790 
out_ş—nup_queue
;

792 
ù¾
->ù¾.
max_hw_£ùÜs
 =

793 (
ù¾
->
max_ä_·ges
 - 1è<< (
	`og2
(
SZ_4K
) - 9);

795 
”rÜ
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

796 ià(
”rÜ
)

797 
out_ş—nup_queue
;

799 
”rÜ
 = 
	`nvme_rdma_®loc_qe
(
ù¾
->
queues
[0].
deviû
->
dev
,

800 &
ù¾
->
async_ev’t_sqe
, (
nvme_commªd
),

801 
DMA_TO_DEVICE
);

802 ià(
”rÜ
)

803 
out_ş—nup_queue
;

807 
out_ş—nup_queue
:

808 ià(
Ãw
)

809 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

810 
out_ä“_g£t
:

811 ià(
Ãw
)

812 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
admš_g£t
);

813 
out_ä“_queue
:

814 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

815  
”rÜ
;

816 
	}
}

818 
	$nvme_rdma_de¡roy_io_queues
(
nvme_rdma_ù¾
 *
ù¾
,

819 
boŞ
 
»move
)

821 
	`nvme_rdma_¡İ_io_queues
(
ù¾
);

822 ià(
»move
) {

823 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

824 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
g£t
);

826 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

827 
	}
}

829 
	$nvme_rdma_cÚfigu»_io_queues
(
nvme_rdma_ù¾
 *
ù¾
, 
boŞ
 
Ãw
)

831 
»t
;

833 
»t
 = 
	`nvme_rdma_®loc_io_queues
(
ù¾
);

834 ià(
»t
)

835  
»t
;

837 ià(
Ãw
) {

838 
ù¾
->ù¾.
g£t
 = 
	`nvme_rdma_®loc_g£t
(&ù¾->ù¾, 
çl£
);

839 ià(
	`IS_ERR
(
ù¾
->ù¾.
g£t
)) {

840 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
g£t
);

841 
out_ä“_io_queues
;

844 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

845 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

846 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

847 
out_ä“_g_£t
;

850 
	`blk_mq_upd©e_Ä_hw_queues
(&
ù¾
->
g_£t
,

851 
ù¾
->ù¾.
queue_couÁ
 - 1);

854 
»t
 = 
	`nvme_rdma_¡¬t_io_queues
(
ù¾
);

855 ià(
»t
)

856 
out_ş—nup_cÚÃù_q
;

860 
out_ş—nup_cÚÃù_q
:

861 ià(
Ãw
)

862 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

863 
out_ä“_g_£t
:

864 ià(
Ãw
)

865 
	`nvme_rdma_ä“_g£t
(&
ù¾
->ù¾, cŒl->ù¾.
g£t
);

866 
out_ä“_io_queues
:

867 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

868  
»t
;

869 
	}
}

871 
	$nvme_rdma_ä“_ù¾
(
nvme_ù¾
 *
nù¾
)

873 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

875 ià(
	`li¡_em±y
(&
ù¾
->
li¡
))

876 
ä“_ù¾
;

878 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

879 
	`li¡_d–
(&
ù¾
->
li¡
);

880 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

882 
	`kä“
(
ù¾
->
queues
);

883 
	`nvmf_ä“_İtiÚs
(
nù¾
->
İts
);

884 
ä“_ù¾
:

885 
	`kä“
(
ù¾
);

886 
	}
}

888 
	$nvme_rdma_»cÚÃù_Ü_»move
(
nvme_rdma_ù¾
 *
ù¾
)

891 ià(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_RECONNECTING
) {

892 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_NEW
 ||

893 
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
);

897 ià(
	`nvmf_should_»cÚÃù
(&
ù¾
->ctrl)) {

898 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Reconnecting in %d seconds...\n",

899 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
);

900 
	`queue_d–ayed_wÜk
(
nvme_wq
, &
ù¾
->
»cÚÃù_wÜk
,

901 
ù¾
->ù¾.
İts
->
»cÚÃù_d–ay
 * 
HZ
);

903 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Removing controller...\n");

904 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

906 
	}
}

908 
	$nvme_rdma_»cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

910 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

911 
nvme_rdma_ù¾
, 
»cÚÃù_wÜk
);

912 
boŞ
 
chªged
;

913 
»t
;

915 ++
ù¾
->ù¾.
Ä_»cÚÃùs
;

917 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
, 
çl£
);

918 ià(
»t
)

919 
»queue
;

921 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

922 
»t
 = 
	`nvme_rdma_cÚfigu»_io_queues
(
ù¾
, 
çl£
);

923 ià(
»t
)

924 
de¡roy_admš
;

927 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

928 ià(!
chªged
) {

930 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_DELETING
);

934 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

936 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Successfully„econnected (%d‡ttempts)\n",

937 
ù¾
->ù¾.
Ä_»cÚÃùs
);

939 
ù¾
->ù¾.
Ä_»cÚÃùs
 = 0;

943 
de¡roy_admš
:

944 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
çl£
);

945 
»queue
:

946 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Failed„econnect‡ttempt %d\n",

947 
ù¾
->ù¾.
Ä_»cÚÃùs
);

948 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

949 
	}
}

951 
	$nvme_rdma_”rÜ_»cov”y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

953 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

954 
nvme_rdma_ù¾
, 
”r_wÜk
);

956 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

958 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

959 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

960 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

961 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

962 
	`nvme_rdma_de¡roy_io_queues
(
ù¾
, 
çl£
);

965 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

966 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

967 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

968 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
çl£
);

974 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

975 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

977 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
)) {

979 
	`WARN_ON_ONCE
(1);

983 
	`nvme_rdma_»cÚÃù_Ü_»move
(
ù¾
);

984 
	}
}

986 
	$nvme_rdma_”rÜ_»cov”y
(
nvme_rdma_ù¾
 *
ù¾
)

988 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RESETTING
))

991 
	`queue_wÜk
(
nvme_wq
, &
ù¾
->
”r_wÜk
);

992 
	}
}

994 
	$nvme_rdma_wr_”rÜ
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
,

995 cÚ¡ *
İ
)

997 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

998 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1000 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
)

1001 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

1003 
İ
, 
wc
->
wr_cqe
,

1004 
	`ib_wc_¡©us_msg
(
wc
->
¡©us
), wc->status);

1005 
	`nvme_rdma_”rÜ_»cov”y
(
ù¾
);

1006 
	}
}

1008 
	$nvme_rdma_mem»g_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1010 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

1011 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "MEMREG");

1012 
	}
}

1014 
	$nvme_rdma_šv_rkey_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1016 
nvme_rdma_»que¡
 *
»q
 =

1017 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_»que¡
, 
»g_cqe
);

1018 
»que¡
 *
rq
 = 
	`blk_mq_rq_äom_pdu
(
»q
);

1020 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
)) {

1021 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "LOCAL_INV");

1025 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»q
->
»f
))

1026 
	`nvme_’d_»que¡
(
rq
, 
»q
->
¡©us
,„eq->
»suÉ
);

1028 
	}
}

1030 
	$nvme_rdma_šv_rkey
(
nvme_rdma_queue
 *
queue
,

1031 
nvme_rdma_»que¡
 *
»q
)

1033 
ib_£nd_wr
 *
bad_wr
;

1034 
ib_£nd_wr
 
wr
 = {

1035 .
İcode
 = 
IB_WR_LOCAL_INV
,

1036 .
Ãxt
 = 
NULL
,

1037 .
num_sge
 = 0,

1038 .
£nd_æags
 = 
IB_SEND_SIGNALED
,

1039 .
ex
.
šv®id©e_rkey
 = 
»q
->
mr
->
rkey
,

1042 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_šv_rkey_dÚe
;

1043 
wr
.
wr_cqe
 = &
»q
->
»g_cqe
;

1045  
	`ib_po¡_£nd
(
queue
->
qp
, &
wr
, &
bad_wr
);

1046 
	}
}

1048 
	$nvme_rdma_unm­_d©a
(
nvme_rdma_queue
 *
queue
,

1049 
»que¡
 *
rq
)

1051 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1052 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

1053 
ib_deviû
 *
ibdev
 = 
dev
->dev;

1055 ià(!
	`blk_rq_by‹s
(
rq
))

1058 ià(
»q
->
mr
) {

1059 
	`ib_mr_poŞ_put
(
queue
->
qp
, &queue->qp->
rdma_mrs
, 
»q
->
mr
);

1060 
»q
->
mr
 = 
NULL
;

1063 
	`ib_dma_unm­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,

1064 
»q
->
ÃÁs
, 
	`rq_d©a_dœ
(
rq
) ==

1065 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1067 
	`nvme_ş—nup_cmd
(
rq
);

1068 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

1069 
	}
}

1071 
	$nvme_rdma_£t_sg_nuÎ
(
nvme_commªd
 *
c
)

1073 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

1075 
sg
->
addr
 = 0;

1076 
	`put_uÇligÃd_Ë24
(0, 
sg
->
Ëngth
);

1077 
	`put_uÇligÃd_Ë32
(0, 
sg
->
key
);

1078 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

1080 
	}
}

1082 
	$nvme_rdma_m­_sg_šlše
(
nvme_rdma_queue
 *
queue
,

1083 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

1085 
nvme_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
sgl
;

1087 
»q
->
sge
[1].
addr
 = 
	`sg_dma_add»ss
Ôeq->
sg_bË
.
sgl
);

1088 
»q
->
sge
[1].
Ëngth
 = 
	`sg_dma_Ën
Ôeq->
sg_bË
.
sgl
);

1089 
»q
->
sge
[1].
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1091 
sg
->
addr
 = 
	`ıu_to_Ë64
(
queue
->
ù¾
->ù¾.
icdoff
);

1092 
sg
->
Ëngth
 = 
	`ıu_to_Ë32
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
));

1093 
sg
->
ty³
 = (
NVME_SGL_FMT_DATA_DESC
 << 4è| 
NVME_SGL_FMT_OFFSET
;

1095 
»q
->
šlše_d©a
 = 
Œue
;

1096 
»q
->
num_sge
++;

1098 
	}
}

1100 
	$nvme_rdma_m­_sg_sšgË
(
nvme_rdma_queue
 *
queue
,

1101 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

1103 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

1105 
sg
->
addr
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
»q
->
sg_bË
.
sgl
));

1106 
	`put_uÇligÃd_Ë24
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
), 
sg
->
Ëngth
);

1107 
	`put_uÇligÃd_Ë32
(
queue
->
deviû
->
pd
->
un§ã_glob®_rkey
, 
sg
->
key
);

1108 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

1110 
	}
}

1112 
	$nvme_rdma_m­_sg_ä
(
nvme_rdma_queue
 *
queue
,

1113 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
,

1114 
couÁ
)

1116 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

1117 
Ä
;

1119 
»q
->
mr
 = 
	`ib_mr_poŞ_g‘
(
queue
->
qp
, &queue->qp->
rdma_mrs
);

1120 ià(
	`WARN_ON_ONCE
(!
»q
->
mr
))

1121  -
EAGAIN
;

1127 
Ä
 = 
	`ib_m­_mr_sg
(
»q
->
mr
,„eq->
sg_bË
.
sgl
, 
couÁ
, 
NULL
, 
SZ_4K
);

1128 ià(
	`uÆik–y
(
Ä
 < 
couÁ
)) {

1129 
	`ib_mr_poŞ_put
(
queue
->
qp
, &queue->qp->
rdma_mrs
, 
»q
->
mr
);

1130 
»q
->
mr
 = 
NULL
;

1131 ià(
Ä
 < 0)

1132  
Ä
;

1133  -
EINVAL
;

1136 
	`ib_upd©e_ç¡_»g_key
(
»q
->
mr
, 
	`ib_šc_rkey
Ôeq->mr->
rkey
));

1138 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_mem»g_dÚe
;

1139 
	`mem£t
(&
»q
->
»g_wr
, 0, (req->reg_wr));

1140 
»q
->
»g_wr
.
wr
.
İcode
 = 
IB_WR_REG_MR
;

1141 
»q
->
»g_wr
.
wr
.
wr_cqe
 = &»q->
»g_cqe
;

1142 
»q
->
»g_wr
.
wr
.
num_sge
 = 0;

1143 
»q
->
»g_wr
.
mr
 =„eq->mr;

1144 
»q
->
»g_wr
.
key
 =„eq->
mr
->
rkey
;

1145 
»q
->
»g_wr
.
acûss
 = 
IB_ACCESS_LOCAL_WRITE
 |

1146 
IB_ACCESS_REMOTE_READ
 |

1147 
IB_ACCESS_REMOTE_WRITE
;

1149 
sg
->
addr
 = 
	`ıu_to_Ë64
(
»q
->
mr
->
iova
);

1150 
	`put_uÇligÃd_Ë24
(
»q
->
mr
->
Ëngth
, 
sg
->length);

1151 
	`put_uÇligÃd_Ë32
(
»q
->
mr
->
rkey
, 
sg
->
key
);

1152 
sg
->
ty³
 = (
NVME_KEY_SGL_FMT_DATA_DESC
 << 4) |

1153 
NVME_SGL_FMT_INVALIDATE
;

1156 
	}
}

1158 
	$nvme_rdma_m­_d©a
(
nvme_rdma_queue
 *
queue
,

1159 
»que¡
 *
rq
, 
nvme_commªd
 *
c
)

1161 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1162 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

1163 
ib_deviû
 *
ibdev
 = 
dev
->dev;

1164 
couÁ
, 
»t
;

1166 
»q
->
num_sge
 = 1;

1167 
»q
->
šlše_d©a
 = 
çl£
;

1168 
	`»fcouÁ_£t
(&
»q
->
»f
, 2);

1170 
c
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1172 ià(!
	`blk_rq_by‹s
(
rq
))

1173  
	`nvme_rdma_£t_sg_nuÎ
(
c
);

1175 
»q
->
sg_bË
.
sgl
 =„eq->
fœ¡_sgl
;

1176 
»t
 = 
	`sg_®loc_bË_chašed
(&
»q
->
sg_bË
,

1177 
	`blk_rq_Ä_phys_£gm’ts
(
rq
), 
»q
->
sg_bË
.
sgl
);

1178 ià(
»t
)

1179  -
ENOMEM
;

1181 
»q
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q,„eq->
sg_bË
.
sgl
);

1183 
couÁ
 = 
	`ib_dma_m­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,„eq->
ÃÁs
,

1184 
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1185 ià(
	`uÆik–y
(
couÁ
 <= 0)) {

1186 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

1187  -
EIO
;

1190 ià(
couÁ
 == 1) {

1191 ià(
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 && 
	`nvme_rdma_queue_idx
(
queue
) &&

1192 
	`blk_rq_·ylßd_by‹s
(
rq
) <=

1193 
	`nvme_rdma_šlše_d©a_size
(
queue
))

1194  
	`nvme_rdma_m­_sg_šlše
(
queue
, 
»q
, 
c
);

1196 ià(
dev
->
pd
->
æags
 & 
IB_PD_UNSAFE_GLOBAL_RKEY
)

1197  
	`nvme_rdma_m­_sg_sšgË
(
queue
, 
»q
, 
c
);

1200  
	`nvme_rdma_m­_sg_ä
(
queue
, 
»q
, 
c
, 
couÁ
);

1201 
	}
}

1203 
	$nvme_rdma_£nd_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1205 
nvme_rdma_qe
 *
qe
 =

1206 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1207 
nvme_rdma_»que¡
 *
»q
 =

1208 
	`cÚš”_of
(
qe
, 
nvme_rdma_»que¡
, 
sqe
);

1209 
»que¡
 *
rq
 = 
	`blk_mq_rq_äom_pdu
(
»q
);

1211 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
)) {

1212 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "SEND");

1216 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»q
->
»f
))

1217 
	`nvme_’d_»que¡
(
rq
, 
»q
->
¡©us
,„eq->
»suÉ
);

1218 
	}
}

1220 
	$nvme_rdma_po¡_£nd
(
nvme_rdma_queue
 *
queue
,

1221 
nvme_rdma_qe
 *
qe
, 
ib_sge
 *
sge
, 
u32
 
num_sge
,

1222 
ib_£nd_wr
 *
fœ¡
)

1224 
ib_£nd_wr
 
wr
, *
bad_wr
;

1225 
»t
;

1227 
sge
->
addr
 = 
qe
->
dma
;

1228 
sge
->
Ëngth
 = (
nvme_commªd
),

1229 
sge
->
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1231 
wr
.
Ãxt
 = 
NULL
;

1232 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1233 
wr
.
sg_li¡
 = 
sge
;

1234 
wr
.
num_sge
 =‚um_sge;

1235 
wr
.
İcode
 = 
IB_WR_SEND
;

1236 
wr
.
£nd_æags
 = 
IB_SEND_SIGNALED
;

1238 ià(
fœ¡
)

1239 
fœ¡
->
Ãxt
 = &
wr
;

1241 
fœ¡
 = &
wr
;

1243 
»t
 = 
	`ib_po¡_£nd
(
queue
->
qp
, 
fœ¡
, &
bad_wr
);

1244 ià(
	`uÆik–y
(
»t
)) {

1245 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1246 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1248  
»t
;

1249 
	}
}

1251 
	$nvme_rdma_po¡_»cv
(
nvme_rdma_queue
 *
queue
,

1252 
nvme_rdma_qe
 *
qe
)

1254 
ib_»cv_wr
 
wr
, *
bad_wr
;

1255 
ib_sge
 
li¡
;

1256 
»t
;

1258 
li¡
.
addr
 = 
qe
->
dma
;

1259 
li¡
.
Ëngth
 = (
nvme_com¶‘iÚ
);

1260 
li¡
.
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1262 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_»cv_dÚe
;

1264 
wr
.
Ãxt
 = 
NULL
;

1265 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1266 
wr
.
sg_li¡
 = &
li¡
;

1267 
wr
.
num_sge
 = 1;

1269 
»t
 = 
	`ib_po¡_»cv
(
queue
->
qp
, &
wr
, &
bad_wr
);

1270 ià(
	`uÆik–y
(
»t
)) {

1271 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1272 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1274  
»t
;

1275 
	}
}

1277 
blk_mq_gs
 *
	$nvme_rdma_g£t
(
nvme_rdma_queue
 *
queue
)

1279 
u32
 
queue_idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

1281 ià(
queue_idx
 == 0)

1282  
queue
->
ù¾
->
admš_g_£t
.
gs
[
queue_idx
];

1283  
queue
->
ù¾
->
g_£t
.
gs
[
queue_idx
 - 1];

1284 
	}
}

1286 
	$nvme_rdma_async_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1288 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

1289 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "ASYNC");

1290 
	}
}

1292 
	$nvme_rdma_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
)

1294 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
¬g
);

1295 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

1296 
ib_deviû
 *
dev
 = 
queue
->
deviû
->dev;

1297 
nvme_rdma_qe
 *
sqe
 = &
ù¾
->
async_ev’t_sqe
;

1298 
nvme_commªd
 *
cmd
 = 
sqe
->
d©a
;

1299 
ib_sge
 
sge
;

1300 
»t
;

1302 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
, (*
cmd
), 
DMA_TO_DEVICE
);

1304 
	`mem£t
(
cmd
, 0, (*cmd));

1305 
cmd
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1306 
cmd
->
commÚ
.
commªd_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1307 
cmd
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1308 
	`nvme_rdma_£t_sg_nuÎ
(
cmd
);

1310 
sqe
->
cqe
.
dÚe
 = 
nvme_rdma_async_dÚe
;

1312 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
, (*
cmd
),

1313 
DMA_TO_DEVICE
);

1315 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, &
sge
, 1, 
NULL
);

1316 
	`WARN_ON_ONCE
(
»t
);

1317 
	}
}

1319 
	$nvme_rdma_´oûss_nvme_r¥
(
nvme_rdma_queue
 *
queue
,

1320 
nvme_com¶‘iÚ
 *
cqe
, 
ib_wc
 *
wc
, 
g
)

1322 
»que¡
 *
rq
;

1323 
nvme_rdma_»que¡
 *
»q
;

1324 
»t
 = 0;

1326 
rq
 = 
	`blk_mq_g_to_rq
(
	`nvme_rdma_g£t
(
queue
), 
cqe
->
commªd_id
);

1327 ià(!
rq
) {

1328 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1330 
cqe
->
commªd_id
, 
queue
->
qp
->
qp_num
);

1331 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1332  
»t
;

1334 
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1336 
»q
->
¡©us
 = 
cqe
->status;

1337 
»q
->
»suÉ
 = 
cqe
->result;

1339 ià(
wc
->
wc_æags
 & 
IB_WC_WITH_INVALIDATE
) {

1340 ià(
	`uÆik–y
(
wc
->
ex
.
šv®id©e_rkey
 !ğ
»q
->
mr
->
rkey
)) {

1341 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1343 
»q
->
mr
->
rkey
);

1344 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1346 } ià(
»q
->
mr
) {

1347 
»t
 = 
	`nvme_rdma_šv_rkey
(
queue
, 
»q
);

1348 ià(
	`uÆik–y
(
»t
 < 0)) {

1349 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1351 
»q
->
mr
->
rkey
, 
»t
);

1352 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1358 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»q
->
»f
)) {

1359 ià(
rq
->
g
 ==ag)

1360 
»t
 = 1;

1361 
	`nvme_’d_»que¡
(
rq
, 
»q
->
¡©us
,„eq->
»suÉ
);

1364  
»t
;

1365 
	}
}

1367 
	$__nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
, 
g
)

1369 
nvme_rdma_qe
 *
qe
 =

1370 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1371 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

1372 
ib_deviû
 *
ibdev
 = 
queue
->
deviû
->
dev
;

1373 
nvme_com¶‘iÚ
 *
cqe
 = 
qe
->
d©a
;

1374 cÚ¡ 
size_t
 
Ën
 = (
nvme_com¶‘iÚ
);

1375 
»t
 = 0;

1377 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
)) {

1378 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "RECV");

1382 
	`ib_dma_sync_sšgË_fÜ_ıu
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1389 ià(
	`uÆik–y
(
	`nvme_rdma_queue_idx
(
queue
) == 0 &&

1390 
cqe
->
commªd_id
 >ğ
NVME_AQ_BLK_MQ_DEPTH
))

1391 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
cqe
->
¡©us
,

1392 &
cqe
->
»suÉ
);

1394 
»t
 = 
	`nvme_rdma_´oûss_nvme_r¥
(
queue
, 
cqe
, 
wc
, 
g
);

1395 
	`ib_dma_sync_sšgË_fÜ_deviû
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1397 
	`nvme_rdma_po¡_»cv
(
queue
, 
qe
);

1398  
»t
;

1399 
	}
}

1401 
	$nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1403 
	`__nvme_rdma_»cv_dÚe
(
cq
, 
wc
, -1);

1404 
	}
}

1406 
	$nvme_rdma_cÚn_e¡ablished
(
nvme_rdma_queue
 *
queue
)

1408 
»t
, 
i
;

1410 
i
 = 0; i < 
queue
->
queue_size
; i++) {

1411 
»t
 = 
	`nvme_rdma_po¡_»cv
(
queue
, &queue->
r¥_ršg
[
i
]);

1412 ià(
»t
)

1413 
out_de¡roy_queue_ib
;

1418 
out_de¡roy_queue_ib
:

1419 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1420  
»t
;

1421 
	}
}

1423 
	$nvme_rdma_cÚn_»jeùed
(
nvme_rdma_queue
 *
queue
,

1424 
rdma_cm_ev’t
 *
ev
)

1426 
rdma_cm_id
 *
cm_id
 = 
queue
->cm_id;

1427 
¡©us
 = 
ev
->status;

1428 cÚ¡ *
»j_msg
;

1429 cÚ¡ 
nvme_rdma_cm_»j
 *
»j_d©a
;

1430 
u8
 
»j_d©a_Ën
;

1432 
»j_msg
 = 
	`rdma_»jeù_msg
(
cm_id
, 
¡©us
);

1433 
»j_d©a
 = 
	`rdma_cÚsum”_»jeù_d©a
(
cm_id
, 
ev
, &
»j_d©a_Ën
);

1435 ià(
»j_d©a
 && 
»j_d©a_Ën
 >ğ(
u16
)) {

1436 
u16
 
¡s
 = 
	`Ë16_to_ıu
(
»j_d©a
->sts);

1438 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1440 
¡©us
, 
»j_msg
, 
¡s
, 
	`nvme_rdma_cm_msg
(sts));

1442 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1443 "CÚÃù„ejeùed: stu %d (%s).\n", 
¡©us
, 
»j_msg
);

1446  -
ECONNRESET
;

1447 
	}
}

1449 
	$nvme_rdma_addr_»sŞved
(
nvme_rdma_queue
 *
queue
)

1451 
»t
;

1453 
»t
 = 
	`nvme_rdma_ü—‹_queue_ib
(
queue
);

1454 ià(
»t
)

1455  
»t
;

1457 
»t
 = 
	`rdma_»sŞve_rou‹
(
queue
->
cm_id
, 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

1458 ià(
»t
) {

1459 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1461 
queue
->
cm_”rÜ
);

1462 
out_de¡roy_queue
;

1467 
out_de¡roy_queue
:

1468 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1469  
»t
;

1470 
	}
}

1472 
	$nvme_rdma_rou‹_»sŞved
(
nvme_rdma_queue
 *
queue
)

1474 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1475 
rdma_cÚn_·¿m
 
·¿m
 = { };

1476 
nvme_rdma_cm_»q
 
´iv
 = { };

1477 
»t
;

1479 
·¿m
.
qp_num
 = 
queue
->
qp
->qp_num;

1480 
·¿m
.
æow_cÚŒŞ
 = 1;

1482 
·¿m
.
»¥Úd”_»sourûs
 = 
queue
->
deviû
->
dev
->
©Œs
.
max_qp_rd_©om
;

1484 
·¿m
.
»Œy_couÁ
 = 7;

1485 
·¿m
.
ºr_»Œy_couÁ
 = 7;

1486 
·¿m
.
´iv©e_d©a
 = &
´iv
;

1487 
·¿m
.
´iv©e_d©a_Ën
 = (
´iv
);

1489 
´iv
.
»cfmt
 = 
	`ıu_to_Ë16
(
NVME_RDMA_CM_FMT_1_0
);

1490 
´iv
.
qid
 = 
	`ıu_to_Ë16
(
	`nvme_rdma_queue_idx
(
queue
));

1495 ià(
´iv
.
qid
 == 0) {

1496 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
NVME_AQ_DEPTH
);

1497 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
NVME_AQ_DEPTH
 - 1);

1504 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
queue
->
queue_size
);

1505 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
queue
->
ù¾
->ù¾.
sqsize
);

1508 
»t
 = 
	`rdma_cÚÃù
(
queue
->
cm_id
, &
·¿m
);

1509 ià(
»t
) {

1510 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1511 "rdma_cÚÃù faed (%d).\n", 
»t
);

1512 
out_de¡roy_queue_ib
;

1517 
out_de¡roy_queue_ib
:

1518 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1519  
»t
;

1520 
	}
}

1522 
	$nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

1523 
rdma_cm_ev’t
 *
ev
)

1525 
nvme_rdma_queue
 *
queue
 = 
cm_id
->
cÚ‹xt
;

1526 
cm_”rÜ
 = 0;

1528 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
, "%s (%d): status %d id %p\n",

1529 
	`rdma_ev’t_msg
(
ev
->
ev’t
),ƒv->event,

1530 
ev
->
¡©us
, 
cm_id
);

1532 
ev
->
ev’t
) {

1533 
RDMA_CM_EVENT_ADDR_RESOLVED
:

1534 
cm_”rÜ
 = 
	`nvme_rdma_addr_»sŞved
(
queue
);

1536 
RDMA_CM_EVENT_ROUTE_RESOLVED
:

1537 
cm_”rÜ
 = 
	`nvme_rdma_rou‹_»sŞved
(
queue
);

1539 
RDMA_CM_EVENT_ESTABLISHED
:

1540 
queue
->
cm_”rÜ
 = 
	`nvme_rdma_cÚn_e¡ablished
(queue);

1542 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1544 
RDMA_CM_EVENT_REJECTED
:

1545 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1546 
cm_”rÜ
 = 
	`nvme_rdma_cÚn_»jeùed
(
queue
, 
ev
);

1548 
RDMA_CM_EVENT_ROUTE_ERROR
:

1549 
RDMA_CM_EVENT_CONNECT_ERROR
:

1550 
RDMA_CM_EVENT_UNREACHABLE
:

1551 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1552 
RDMA_CM_EVENT_ADDR_ERROR
:

1553 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1554 "CMƒ¼Üƒv’ˆ%d\n", 
ev
->
ev’t
);

1555 
cm_”rÜ
 = -
ECONNRESET
;

1557 
RDMA_CM_EVENT_DISCONNECTED
:

1558 
RDMA_CM_EVENT_ADDR_CHANGE
:

1559 
RDMA_CM_EVENT_TIMEWAIT_EXIT
:

1560 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1562 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1564 
RDMA_CM_EVENT_DEVICE_REMOVAL
:

1568 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1569 "UÃx³ùed RDMA CMƒv’ˆ(%d)\n", 
ev
->
ev’t
);

1570 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1574 ià(
cm_”rÜ
) {

1575 
queue
->
cm_”rÜ
 = cm_error;

1576 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1580 
	}
}

1582 
blk_eh_tim”_»tuº


1583 
	$nvme_rdma_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

1585 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1587 
	`dev_w¬n
(
»q
->
queue
->
ù¾
->ù¾.
deviû
,

1589 
rq
->
g
, 
	`nvme_rdma_queue_idx
(
»q
->
queue
));

1592 
	`nvme_rdma_”rÜ_»cov”y
(
»q
->
queue
->
ù¾
);

1595 
	`nvme_»q
(
rq
)->
¡©us
 = 
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
;

1597  
BLK_EH_HANDLED
;

1598 
	}
}

1603 
šlše
 
blk_¡©us_t


1604 
	$nvme_rdma_is_»ady
(
nvme_rdma_queue
 *
queue
, 
»que¡
 *
rq
)

1606 ià(
	`uÆik–y
(!
	`‹¡_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
)))

1607  
	`nvmf_check_š™_»q
(&
queue
->
ù¾
->ù¾, 
rq
);

1608  
BLK_STS_OK
;

1609 
	}
}

1611 
blk_¡©us_t
 
	$nvme_rdma_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1612 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1614 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1615 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1616 
»que¡
 *
rq
 = 
bd
->rq;

1617 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1618 
nvme_rdma_qe
 *
sqe
 = &
»q
->sqe;

1619 
nvme_commªd
 *
c
 = 
sqe
->
d©a
;

1620 
ib_deviû
 *
dev
;

1621 
blk_¡©us_t
 
»t
;

1622 
”r
;

1624 
	`WARN_ON_ONCE
(
rq
->
g
 < 0);

1626 
»t
 = 
	`nvme_rdma_is_»ady
(
queue
, 
rq
);

1627 ià(
	`uÆik–y
(
»t
))

1628  
»t
;

1630 
dev
 = 
queue
->
deviû
->dev;

1631 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
,

1632 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1634 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
c
);

1635 ià(
»t
)

1636  
»t
;

1638 
	`blk_mq_¡¬t_»que¡
(
rq
);

1640 
”r
 = 
	`nvme_rdma_m­_d©a
(
queue
, 
rq
, 
c
);

1641 ià(
	`uÆik–y
(
”r
 < 0)) {

1642 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1643 "FaedØm­ d©¨(%d)\n", 
”r
);

1644 
	`nvme_ş—nup_cmd
(
rq
);

1645 
”r
;

1648 
sqe
->
cqe
.
dÚe
 = 
nvme_rdma_£nd_dÚe
;

1650 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
,

1651 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1653 
”r
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, 
»q
->
sge
,„eq->
num_sge
,

1654 
»q
->
mr
 ? &»q->
»g_wr
.
wr
 : 
NULL
);

1655 ià(
	`uÆik–y
(
”r
)) {

1656 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1657 
”r
;

1660  
BLK_STS_OK
;

1661 
”r
:

1662 ià(
”r
 =ğ-
ENOMEM
 ||ƒ¼ =ğ-
EAGAIN
)

1663  
BLK_STS_RESOURCE
;

1664  
BLK_STS_IOERR
;

1665 
	}
}

1667 
	$nvme_rdma_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1669 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1670 
ib_cq
 *
cq
 = 
queue
->ib_cq;

1671 
ib_wc
 
wc
;

1672 
found
 = 0;

1674 
	`ib_pŞl_cq
(
cq
, 1, &
wc
) > 0) {

1675 
ib_cqe
 *
cqe
 = 
wc
.
wr_cqe
;

1677 ià(
cqe
) {

1678 ià(
cqe
->
dÚe
 =ğ
nvme_rdma_»cv_dÚe
)

1679 
found
 |ğ
	`__nvme_rdma_»cv_dÚe
(
cq
, &
wc
, 
g
);

1681 
cqe
->
	`dÚe
(
cq
, &
wc
);

1685  
found
;

1686 
	}
}

1688 
	$nvme_rdma_com¶‘e_rq
(
»que¡
 *
rq
)

1690 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1692 
	`nvme_rdma_unm­_d©a
(
»q
->
queue
, 
rq
);

1693 
	`nvme_com¶‘e_rq
(
rq
);

1694 
	}
}

1696 
	$nvme_rdma_m­_queues
(
blk_mq_g_£t
 *
£t
)

1698 
nvme_rdma_ù¾
 *
ù¾
 = 
£t
->
driv”_d©a
;

1700  
	`blk_mq_rdma_m­_queues
(
£t
, 
ù¾
->
deviû
->
dev
, 0);

1701 
	}
}

1703 cÚ¡ 
blk_mq_İs
 
	gnvme_rdma_mq_İs
 = {

1704 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1705 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1706 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1707 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1708 .
	gš™_hùx
 = 
nvme_rdma_š™_hùx
,

1709 .
	gpŞl
 = 
nvme_rdma_pŞl
,

1710 .
	gtimeout
 = 
nvme_rdma_timeout
,

1711 .
	gm­_queues
 = 
nvme_rdma_m­_queues
,

1714 cÚ¡ 
blk_mq_İs
 
	gnvme_rdma_admš_mq_İs
 = {

1715 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1716 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1717 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1718 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1719 .
	gš™_hùx
 = 
nvme_rdma_š™_admš_hùx
,

1720 .
	gtimeout
 = 
nvme_rdma_timeout
,

1723 
	$nvme_rdma_shutdown_ù¾
(
nvme_rdma_ù¾
 *
ù¾
, 
boŞ
 
shutdown
)

1725 
	`ÿnûl_wÜk_sync
(&
ù¾
->
”r_wÜk
);

1726 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
»cÚÃù_wÜk
);

1728 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1729 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

1730 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

1731 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1732 
	`nvme_rdma_de¡roy_io_queues
(
ù¾
, 
shutdown
);

1735 ià(
shutdown
)

1736 
	`nvme_shutdown_ù¾
(&
ù¾
->ctrl);

1738 
	`nvme_di§bË_ù¾
(&
ù¾
->ù¾, cŒl->ù¾.
ÿp
);

1740 
	`blk_mq_qu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1741 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

1742 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1743 
	`blk_mq_unqu›sû_queue
(
ù¾
->ù¾.
admš_q
);

1744 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
shutdown
);

1745 
	}
}

1747 
	$nvme_rdma_d–‘e_ù¾
(
nvme_ù¾
 *
ù¾
)

1749 
	`nvme_rdma_shutdown_ù¾
(
	`to_rdma_ù¾
(
ù¾
), 
Œue
);

1750 
	}
}

1752 
	$nvme_rdma_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1754 
nvme_rdma_ù¾
 *
ù¾
 =

1755 
	`cÚš”_of
(
wÜk
, 
nvme_rdma_ù¾
, 
ù¾
.
»£t_wÜk
);

1756 
»t
;

1757 
boŞ
 
chªged
;

1759 
	`nvme_¡İ_ù¾
(&
ù¾
->ctrl);

1760 
	`nvme_rdma_shutdown_ù¾
(
ù¾
, 
çl£
);

1762 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
)) {

1764 
	`WARN_ON_ONCE
(1);

1768 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
, 
çl£
);

1769 ià(
»t
)

1770 
out_ç
;

1772 ià(
ù¾
->ù¾.
queue_couÁ
 > 1) {

1773 
»t
 = 
	`nvme_rdma_cÚfigu»_io_queues
(
ù¾
, 
çl£
);

1774 ià(
»t
)

1775 
out_ç
;

1778 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1779 ià(!
chªged
) {

1781 
	`WARN_ON_ONCE
(
ù¾
->ù¾.
¡©e
 !ğ
NVME_CTRL_DELETING
);

1785 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

1789 
out_ç
:

1790 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
, "Removing‡fter„eset failure\n");

1791 
	`nvme_»move_Çme¥aûs
(&
ù¾
->ctrl);

1792 
	`nvme_rdma_shutdown_ù¾
(
ù¾
, 
Œue
);

1793 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1794 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1795 
	}
}

1797 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_rdma_ù¾_İs
 = {

1798 .
Çme
 = "rdma",

1799 .
	gmoduË
 = 
THIS_MODULE
,

1800 .
	gæags
 = 
NVME_F_FABRICS
,

1801 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

1802 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

1803 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

1804 .
	gä“_ù¾
 = 
nvme_rdma_ä“_ù¾
,

1805 .
	gsubm™_async_ev’t
 = 
nvme_rdma_subm™_async_ev’t
,

1806 .
	gd–‘e_ù¾
 = 
nvme_rdma_d–‘e_ù¾
,

1807 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

1810 
šlše
 
boŞ


1811 
	$__nvme_rdma_İtiÚs_m©ch
(
nvme_rdma_ù¾
 *
ù¾
,

1812 
nvmf_ù¾_İtiÚs
 *
İts
)

1814 *
¡dpÜt
 = 
	`__¡ršgify
(
NVME_RDMA_IP_PORT
);

1817 ià(!
	`nvmf_ùÌ_m©ches_ba£İts
(&
ù¾
->ù¾, 
İts
) ||

1818 
	`¡rcmp
(
İts
->
Œaddr
, 
ù¾
->ctrl.opts->traddr))

1819  
çl£
;

1821 ià(
İts
->
mask
 & 
NVMF_OPT_TRSVCID
 &&

1822 
ù¾
->ù¾.
İts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

1823 ià(
	`¡rcmp
(
İts
->
Œsvcid
, 
ù¾
->ctrl.opts->trsvcid))

1824  
çl£
;

1825 } ià(
İts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

1826 ià(
	`¡rcmp
(
İts
->
Œsvcid
, 
¡dpÜt
))

1827  
çl£
;

1828 } ià(
ù¾
->ù¾.
İts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

1829 ià(
	`¡rcmp
(
¡dpÜt
, 
ù¾
->ù¾.
İts
->
Œsvcid
))

1830  
çl£
;

1843 ià(
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
 &&

1844 
ù¾
->ù¾.
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

1845 ià(
	`¡rcmp
(
İts
->
ho¡_Œaddr
, 
ù¾
->ctrl.opts->host_traddr))

1846  
çl£
;

1847 } ià(
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
 ||

1848 
ù¾
->ù¾.
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

1849  
çl£
;

1855  
Œue
;

1856 
	}
}

1870 
boŞ


1871 
	$nvme_rdma_exi¡šg_cÚŒŞËr
(
nvmf_ù¾_İtiÚs
 *
İts
)

1873 
nvme_rdma_ù¾
 *
ù¾
;

1874 
boŞ
 
found
 = 
çl£
;

1876 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

1877 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

1878 
found
 = 
	`__nvme_rdma_İtiÚs_m©ch
(
ù¾
, 
İts
);

1879 ià(
found
)

1882 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

1884  
found
;

1885 
	}
}

1887 
nvme_ù¾
 *
	$nvme_rdma_ü—‹_ù¾
(
deviû
 *
dev
,

1888 
nvmf_ù¾_İtiÚs
 *
İts
)

1890 
nvme_rdma_ù¾
 *
ù¾
;

1891 
»t
;

1892 
boŞ
 
chªged
;

1893 *
pÜt
;

1895 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

1896 ià(!
ù¾
)

1897  
	`ERR_PTR
(-
ENOMEM
);

1898 
ù¾
->ù¾.
İts
 = opts;

1899 
	`INIT_LIST_HEAD
(&
ù¾
->
li¡
);

1901 ià(
İts
->
mask
 & 
NVMF_OPT_TRSVCID
)

1902 
pÜt
 = 
İts
->
Œsvcid
;

1904 
pÜt
 = 
	`__¡ršgify
(
NVME_RDMA_IP_PORT
);

1906 
»t
 = 
	`š‘_±Ú_w™h_scİe
(&
š™_Ãt
, 
AF_UNSPEC
,

1907 
İts
->
Œaddr
, 
pÜt
, &
ù¾
->
addr
);

1908 ià(
»t
) {

1909 
	`´_”r
("m®fÜmed‡dd»s ·s£d: %s:%s\n", 
İts
->
Œaddr
, 
pÜt
);

1910 
out_ä“_ù¾
;

1913 ià(
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

1914 
»t
 = 
	`š‘_±Ú_w™h_scİe
(&
š™_Ãt
, 
AF_UNSPEC
,

1915 
İts
->
ho¡_Œaddr
, 
NULL
, &
ù¾
->
¤c_addr
);

1916 ià(
»t
) {

1917 
	`´_”r
("malformed src‡ddress…assed: %s\n",

1918 
İts
->
ho¡_Œaddr
);

1919 
out_ä“_ù¾
;

1923 ià(!
İts
->
du¶iÿ‹_cÚÃù
 && 
	`nvme_rdma_exi¡šg_cÚŒŞËr
(opts)) {

1924 
»t
 = -
EALREADY
;

1925 
out_ä“_ù¾
;

1928 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_rdma_ù¾_İs
,

1930 ià(
»t
)

1931 
out_ä“_ù¾
;

1933 
	`INIT_DELAYED_WORK
(&
ù¾
->
»cÚÃù_wÜk
,

1934 
nvme_rdma_»cÚÃù_ù¾_wÜk
);

1935 
	`INIT_WORK
(&
ù¾
->
”r_wÜk
, 
nvme_rdma_”rÜ_»cov”y_wÜk
);

1936 
	`INIT_WORK
(&
ù¾
->ù¾.
»£t_wÜk
, 
nvme_rdma_»£t_ù¾_wÜk
);

1938 
ù¾
->ù¾.
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

1939 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

1940 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

1942 
»t
 = -
ENOMEM
;

1943 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->ù¾.
queue_couÁ
, (*ctrl->queues),

1944 
GFP_KERNEL
);

1945 ià(!
ù¾
->
queues
)

1946 
out_unš™_ù¾
;

1948 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
, 
Œue
);

1949 ià(
»t
)

1950 
out_kä“_queues
;

1953 ià(
ù¾
->ù¾.
icdoff
) {

1954 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff is‚ot supported!\n");

1955 
»t
 = -
EINVAL
;

1956 
out_»move_admš_queue
;

1960 ià(!(
ù¾
->ù¾.
sgls
 & (1 << 20))) {

1961 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "Mandatory keyed sgls‡re‚ot support\n");

1962 
»t
 = -
EINVAL
;

1963 
out_»move_admš_queue
;

1966 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

1968 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1970 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

1971 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

1974 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
sqsize
 + 1) {

1976 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1978 
İts
->
queue_size
, 
ù¾
->ù¾.
sqsize
 + 1);

1979 
İts
->
queue_size
 = 
ù¾
->ù¾.
sqsize
 + 1;

1982 ià(
İts
->
Ä_io_queues
) {

1983 
»t
 = 
	`nvme_rdma_cÚfigu»_io_queues
(
ù¾
, 
Œue
);

1984 ià(
»t
)

1985 
out_»move_admš_queue
;

1988 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1989 
	`WARN_ON_ONCE
(!
chªged
);

1991 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "new ctrl: NQN \"%s\",‡ddr %pISpcs\n",

1992 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

1994 
	`nvme_g‘_ù¾
(&
ù¾
->ctrl);

1996 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

1997 
	`li¡_add_
(&
ù¾
->
li¡
, &
nvme_rdma_ù¾_li¡
);

1998 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2000 
	`nvme_¡¬t_ù¾
(&
ù¾
->ctrl);

2002  &
ù¾
->ctrl;

2004 
out_»move_admš_queue
:

2005 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
, 
Œue
);

2006 
out_kä“_queues
:

2007 
	`kä“
(
ù¾
->
queues
);

2008 
out_unš™_ù¾
:

2009 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

2010 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

2011 ià(
»t
 > 0)

2012 
»t
 = -
EIO
;

2013  
	`ERR_PTR
(
»t
);

2014 
out_ä“_ù¾
:

2015 
	`kä“
(
ù¾
);

2016  
	`ERR_PTR
(
»t
);

2017 
	}
}

2019 
nvmf_Œª¥Üt_İs
 
	gnvme_rdma_Œª¥Üt
 = {

2020 .
Çme
 = "rdma",

2021 .
	gmoduË
 = 
THIS_MODULE
,

2022 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
,

2023 .
	g®lowed_İts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
 |

2024 
NVMF_OPT_HOST_TRADDR
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

2025 .
	gü—‹_ù¾
 = 
nvme_rdma_ü—‹_ù¾
,

2028 
	$nvme_rdma_»move_Úe
(
ib_deviû
 *ib_deviû, *
ş›Á_d©a
)

2030 
nvme_rdma_ù¾
 *
ù¾
;

2033 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

2034 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

2035 ià(
ù¾
->
deviû
->
dev
 !ğ
ib_deviû
)

2037 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2039 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

2040 
	`nvme_d–‘e_ù¾
(&
ù¾
->ctrl);

2042 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2044 
	`æush_wÜkqueue
(
nvme_wq
);

2045 
	}
}

2047 
ib_ş›Á
 
	gnvme_rdma_ib_ş›Á
 = {

2048 .
Çme
 = "nvme_rdma",

2049 .
	g»move
 = 
nvme_rdma_»move_Úe


2052 
__š™
 
	$nvme_rdma_š™_moduË
()

2054 
»t
;

2056 
»t
 = 
	`ib_»gi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2057 ià(
»t
)

2058  
»t
;

2060 
»t
 = 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2061 ià(
»t
)

2062 
”r_uÄeg_ş›Á
;

2066 
”r_uÄeg_ş›Á
:

2067 
	`ib_uÄegi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2068  
»t
;

2069 
	}
}

2071 
__ex™
 
	$nvme_rdma_ş—nup_moduË
()

2073 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2074 
	`ib_uÄegi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2075 
	}
}

2077 
moduË_š™
(
nvme_rdma_š™_moduË
);

2078 
moduË_ex™
(
nvme_rdma_ş—nup_moduË
);

2080 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/´.h
>

26 
	~<lšux/±¿û.h
>

28 
	~<lšux/nvme_ioùl.h
>

31 
	~<lšux/t10-pi.h
>

32 
	~<lšux/pm_qos.h
>

33 
	~<scsi/sg.h
>

34 
	~<asm/uÇligÃd.h
>

36 
	~"nvme.h
"

39 
	~<lšux/fe.h
>

40 
	~<lšux/fdbË.h
>

41 
	~<lšux/ev’tfd.h
>

42 
	~<lšux/k»f.h
>

43 
	~<lšux/ä“z”.h
>

44 
	~<lšux/wa™.h
>

45 
	~<lšux/kth»ad.h
>

46 
	~<lšux/sk_io_accouÁšg_İs.h
>

47 
	~"lšux_nvme_ioùl.h
"

51 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

53 
	gnvme_majÜ
;

54 
moduË_·¿m
(
nvme_majÜ
, , 0);

56 
	gnvme_ch¬_majÜ
;

57 
moduË_·¿m
(
nvme_ch¬_majÜ
, , 0);

59 
	gdeçuÉ_ps_max_Ï‹ncy_us
 = 100000;

60 
moduË_·¿m
(
deçuÉ_ps_max_Ï‹ncy_us
, 
ulÚg
, 0644);

61 
MODULE_PARM_DESC
(
deçuÉ_ps_max_Ï‹ncy_us
,

64 
LIST_HEAD
(
nvme_ù¾_li¡
);

65 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

67 
şass
 *
	gnvme_şass
;

75 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

76 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

77 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

78 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

80 
__u32
 
	gaio_cÚ‹xt_id
;

82 
	#AIOCTX_MAX
 1024

	)

83 
	#AIOCB_MAX
 (1024*64)

	)

85 
__u64
 
	gdebug_com¶‘ed
 =0;

86 
	gdebug_out¡ªdšg
 =0;

88 
	snvme_kaioùx


90 
nvme_aioùx
 
	muùx
;

91 
ev’tfd_ùx
 *
	mev’tùx
;

92 
li¡_h—d
 
	mkaiocb_li¡
;

93 
¥šlock_t
 
	mkaioùx_¥šlock
;

94 
k»f
 
	m»f
;

97 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

98 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

100 
	saio_u£r_ùx
 {

101 
	mÃÁs
;

102 
	mËn
;

103 
·ge
 ** 
	m·ges
;

104 
sÿ‰”li¡
 *
	msg
;

105 
	md©a
[1];

108 
	snvme_kaiocb


110 
li¡_h—d
 
	maiocb_li¡
;

111 
nvme_aiÛv’t
 
	mev’t
;

112 
nvme_com¶‘iÚ
 
	mcqe
;

113 
	mİcode
;

114 
nvme_commªd
 
	mcmd
;

115 
g’disk
 *
	mdisk
;

116 
sÿ‰”li¡
 
	mm‘a_sg
;

117 
boŞ
 
	mÃed_to_cİy
;

118 
	m¡¬t_time
;

119 
boŞ
 
	mu£_m‘a
;

120 *
	mkv_d©a
;

121 *
	mm‘a
;

122 
aio_u£r_ùx
 *
	mu£r_ùx
;

123 
aio_u£r_ùx
 *
	mk”Ãl_ùx
;

124 
»que¡
 *
	m»q
;

128 
	saio_wÜk”_ùx
{

129 
	mıu
;

130 
¥šlock_t
 
	mkaiocb_¥šlock
;

131 
li¡_h—d
 
	mkaiocb_li¡
;

132 
wa™_queue_h—d_t
 
	maio_wa™queue
;

136 
aio_wÜk”_ùx
 * 
__³rıu
 
	gaio_w_ùx
;

138 
sk_¡ruù
 ** 
__³rıu
 
	gaio_wÜk”
;

142 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

144 
nvme_kaiocb
 *
tmpcb
;

145 
li¡_h—d
 *
pos
, *
q
;

146 
æags
;

147 ià(
ùx
) {

148 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

149 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

150 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

151 
	`li¡_d–
(
pos
);

152 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

154 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

155 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

156 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

158 
	}
}

160 
	$ş—nup_kaioùx
(
k»f
 *kref) {

161 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

162 
	`»move_kaioùx
(
ùx
);

163 
	}
}

165 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

166 
	`k»f_g‘
(&
ùx
->
»f
);

167 
	}
}

169 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

170 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

171 
	}
}

176 
	$de¡roy_aio_mempoŞ
()

178 
i
 = 0;

179 ià(
g_kaioùx_tb
) {

180 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

181 ià(
g_kaioùx_tb
[
i
]) {

182 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

183 
g_kaioùx_tb
[
i
] = 
NULL
;

186 
	`kä“
(
g_kaioùx_tb
);

187 
g_kaioùx_tb
 = 
NULL
;

189 ià(
kaiocb_mempoŞ
)

190 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

191 ià(
kaioùx_mempoŞ
)

192 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

193 ià(
kaioùx_ÿch•
)

194 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

195 ià(
kaiocb_ÿch•
)

196 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

197 
	}
}

202 
	$aio_£rviû_š™
()

204 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

205 ià(!
g_kaioùx_tb
)

206 
ç
;

207 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

210 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

211 ià(!
kaioùx_ÿch•
)

212 
ç
;

214 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

215 ià(!
kaiocb_ÿch•
)

216 
ç
;

218 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

219 ià(!
kaiocb_mempoŞ
)

220 
ç
;

222 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

223 ià(!
kaioùx_mempoŞ
)

224 
ç
;

228 
aio_cÚ‹xt_id
 = 1;

229 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

230 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

233 
ç
:

234 
	`de¡roy_aio_mempoŞ
();

235  -
ENOMEM
;

236 
	}
}

241 
	$aio_£rviû_ex™
()

243 
	`de¡roy_aio_mempoŞ
();

244 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

246 
	}
}

248 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

249 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

252 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

253 ià(
tmp
è
	`»f_kaioùx
(tmp);

255  
tmp
;

256 
	}
}

262 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

264 
nvme_kaioùx
 *
tmp
;

265 
æags
;

266 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

267 ià(
tmp
) {

268 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

269 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

270 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

272 
	`´_”r
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

274 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

275 
	`d”ef_kaioùx
(
tmp
);

279 
	`´_”r
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

284 
	}
}

290 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

292 
nvme_kaioùx
 
ùx
;

293 
æags
;

294 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

295  -
EFAULT
;

297 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

298 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

299 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

300 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

302 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

304 
	}
}

310 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

312 
nvme_kaioùx
 *
ùx
;

313 
fd
 
efe
;

314 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

315 
æags
;

316 
»t
 = 0;

317 
i
 = 0;

318 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

319  -
EACCES
;

321 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

322 ià(!
ùx
)

323  -
ENOMEM
;

325 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

326  -
EFAULT
;

328 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

329 ià(!
efe
.
fe
) {

330 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

331 
»t
 = -
EBADF
;

332 
ex™
;

335 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

336 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

337 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

338 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

339 
put_efe
;

342 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

343 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

344 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

345 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

346 
aio_cÚ‹xt_id
 = 
i
;

350 ià(
i
 >ğ
AIOCTX_MAX
) {

351 
	`´_”r
("nvme_set_aioctx:oo many‡ioctx open.\n");

352 
»t
 = -
EMFILE
;

353 
put_ev’t_fd
;

356 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

357 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

358 
aio_cÚ‹xt_id
 = 0;

359 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

360 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

361 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

362 
	`k»f_š™
(&
ùx
->
»f
);

363 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

364 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

366 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

368 
	`´_”r
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

369 
»t
 = -
EINVAL
;

370 
ş—nup
;

372 
ev’tfd_ùx
 = 
NULL
;

373 
debug_out¡ªdšg
 = 0;

374 
debug_com¶‘ed
 = 0;

375 
	`fdput
(
efe
);

377 
ş—nup
:

378 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

379 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

380 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

381 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

382 
put_ev’t_fd
:

383 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

384 
put_efe
:

385 
	`fdput
(
efe
);

386 
ex™
:

387  
»t
;

388 
	}
}

392 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

393 
nvme_kaiocb
 *
»q
;

394 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

395 ià(!
»q
)  0;

397 
	`mem£t
(
»q
, 0, (*req));

399 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

401 
»q
->
ev’t
.
»qid
 =„eqid;

403  
»q
;

404 
	}
}

408 
	$nvme_g‘_iÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

410 
li¡_h—d
 *
pos
, *
q
;

411 
nvme_kaiocb
 *
tmp
;

412 
nvme_kaioùx
 *
tmp_ùx
;

413 
æags
;

414 
	`LIST_HEAD
(
tmp_h—d
);

415 
__u16
 
couÁ
 =0;

416 
__u16
 
Ä
 = 0;

417 
__u32
 
ùxid
 = 0;

419 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

420  -
EACCES
;

422 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

424 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

426 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

428 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

429 ià(
tmp_ùx
) {

430 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

431 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

432 
	`li¡_d–_š™
(
pos
);

433 
	`li¡_add
(
pos
, &
tmp_h—d
);

434 
couÁ
++;

435 ià(
Ä
 =ğ
couÁ
) ;

437 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

438 
	`d”ef_kaioùx
(
tmp_ùx
);

439 
couÁ
 = 0;

440 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

441 
	`li¡_d–
(
pos
);

442 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

443 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

444 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

445 
couÁ
++;

448 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

451 
	}
}

453 
	$kv_com¶‘e_aio_â
(
nvme_kaiocb
 *
cmdšfo
) {

454 
»que¡
 *
»q
 = 
cmdšfo
->req;

455 
i
 = 0;

457 ià(
cmdšfo
->
Ãed_to_cİy
) {

461 ià(
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_™”_»ad_cmd
(cmdinfo->opcode)) {

463 *
d©a
 = 
cmdšfo
->
kv_d©a
;

464 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

466 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

467 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

469 
i
 = 0; i < 
cmdšfo
->
k”Ãl_ùx
->
ÃÁs
; i++) {

470 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
k”Ãl_ùx
->
sg
[
i
]));

473 ià(
cmdšfo
->
u£r_ùx
) {

474 ià(
	`is_kv_¡Üe_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_­³nd_cmd
(cmdinfo->opcode)) {

475 
	`g’”ic_’d_io_acù
(
WRITE
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

477 
	`g’”ic_’d_io_acù
(
READ
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

479 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++) {

480 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

483 
	`blk_mq_ä“_»que¡
(
»q
);

485 ià(
cmdšfo
->
u£_m‘a
) {

486 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

489 ià(
cmdšfo
->
Ãed_to_cİy
) {

490 
	`kä“
(
cmdšfo
->
k”Ãl_ùx
);

491 
	`kä“
(
cmdšfo
->
kv_d©a
);

493 ià(
cmdšfo
->
u£r_ùx
è
	`kä“
(cmdinfo->user_ctx);

494 ià(
cmdšfo
->
m‘a
è
	`kä“
(cmdinfo->meta);

496 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

497 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

499 
	}
}

501 
	$wake_up_aio_wÜk”
(
aio_wÜk”_ùx
 *
aio_ùx
) {

502 
	`wake_up
(&
aio_ùx
->
aio_wa™queue
);

503 
	}
}

505 
	$š£¹_aiocb_to_wÜk”
(
nvme_kaiocb
 *
aiocb
) {

506 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

507 
æags
;

508 
ıu
 = 
	`smp_´oûssÜ_id
();

509 
	`INIT_LIST_HEAD
(&
aiocb
->
aiocb_li¡
);

511 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
ıu
);

512 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

513 
	`li¡_add_
(&
aiocb
->
aiocb_li¡
, &
ùx
->
kaiocb_li¡
);

514 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

515 
	`wake_up_aio_wÜk”
(
ùx
);

517 
	}
}

519 
	$kv_async_com¶‘iÚ
(
»que¡
 *
»q
, 
”rÜ
){

520 
nvme_kaiocb
 *
aiocb
 = 
»q
->
’d_io_d©a
;

521 
nvme_com¶‘iÚ
 *
cqe
 = 
»q
->
¥ecŸl
;

523 
aiocb
->
»q
 =„eq;

524 
aiocb
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

525 
aiocb
->
ev’t
.
¡©us
 = 
	`Ë32_to_ıu
(
cqe
->status) >> 1;

526 
	`š£¹_aiocb_to_wÜk”
(
aiocb
);

528 
	}
}

530 
	$kvaio_³rıu_wÜk”_â
(*
¬g
) {

531 
aio_wÜk”_ùx
 *
ùx
 = (aio_wÜk”_ùx *)
¬g
;

532 
li¡_h—d
 *
pos
, *
Ãxt
;

533 
æags
;

534 
	`LIST_HEAD
(
tmp_li¡
);

535 
	`´_”r
("¡¬ˆaiØwÜk” %u\n", 
ùx
->
ıu
);

536 !
	`kth»ad_should_¡İ
(è|| !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

537 ià(
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

538 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
ùx
->
aio_wa™queue
,

539 !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
), 
HZ
/10);

542 
	`INIT_LIST_HEAD
(&
tmp_li¡
);

543 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

544 
	`li¡_¥liû
(&
ùx
->
kaiocb_li¡
, &
tmp_li¡
);

545 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

546 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

547 ià(!
	`li¡_em±y
(&
tmp_li¡
)) {

548 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, &
tmp_li¡
) {

549 
nvme_kaiocb
 *
aiocb
 = 
	`li¡_’Œy
(
pos
, nvme_kaiocb, 
aiocb_li¡
);

550 
	`li¡_d–_š™
(
pos
);

551 
	`kv_com¶‘e_aio_â
(
aiocb
);

556 
	}
}

558 
	$aio_wÜk”_š™
() {

559 
sk_¡ruù
 **
p
 = 
NULL
;

560 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

561 
i
 = 0;

563 
aio_wÜk”
 = 
	`®loc_³rıu
(
sk_¡ruù
 *);

564 ià(!
aio_wÜk”
) {

565 
	`´_”r
("failo‡lloc…ercpu workerask_struct!\n");

566  -
ENOMEM
;

568 
aio_w_ùx
 = 
	`®loc_³rıu
(
aio_wÜk”_ùx
);

569 ià(!
aio_w_ùx
) {

570 
	`´_”r
("failo‡lloc…ercpu‡io context!\n");

571 
out_ä“
;

574 
	`fÜ_—ch_Úlše_ıu
(
i
) {

575 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
i
);

576 
ùx
->
ıu
 = 
i
;

577 
	`¥š_lock_š™
(&
ùx
->
kaiocb_¥šlock
);

578 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

579 
	`š™_wa™queue_h—d
(&
ùx
->
aio_wa™queue
);

580 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

581 *
p
 = 
	`kth»ad_ü—‹_Ú_node
(
kvaio_³rıu_wÜk”_â
, 
ùx
, 
	`ıu_to_node
(
i
), "aio_completion_worker/%u", i);

582 ià(!(*
p
))

583 
»£t_±h»ad
;

584 
	`kth»ad_bšd
(*
p
, 
i
);

585 
	`wake_up_´oûss
(*
p
);

589 
»£t_±h»ad
:

590 
	`fÜ_—ch_Úlše_ıu
(
i
) {

591 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

592 ià(*
p
è
	`kth»ad_¡İ
(*p);

594 
out_ä“
:

595 ià(
aio_wÜk”
)

596 
	`ä“_³rıu
(
aio_wÜk”
);

597  -
ENOMEM
;

598 
	}
}

600 
	$aio_wÜk”_ex™
() {

601 
sk_¡ruù
 **
p
 = 
NULL
;

602 
i
 = 0;

603 
	`fÜ_—ch_Úlše_ıu
(
i
) {

604 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

605 ià(*
p
è
	`kth»ad_¡İ
(*p);

607 
	`ä“_³rıu
(
aio_wÜk”
);

608 
	`ä“_³rıu
(
aio_w_ùx
);

610 
	}
}

617 
	$nvme_ä“_ns
(
k»f
 *kref)

619 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

621 ià(
ns
->
ty³
 =ğ
NVME_NS_LIGHTNVM
)

622 
	`nvme_nvm_uÄegi¡”
(
ns
->
queue
,‚s->
disk
->
disk_Çme
);

624 
	`¥š_lock
(&
dev_li¡_lock
);

625 
ns
->
disk
->
´iv©e_d©a
 = 
NULL
;

626 
	`¥š_uÆock
(&
dev_li¡_lock
);

628 
	`nvme_put_ù¾
(
ns
->
ù¾
);

629 
	`put_disk
(
ns
->
disk
);

630 
	`kä“
(
ns
);

631 
	}
}

633 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

635 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

636 
	}
}

638 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
)

640 
nvme_ns
 *
ns
;

642 
	`¥š_lock
(&
dev_li¡_lock
);

643 
ns
 = 
disk
->
´iv©e_d©a
;

644 ià(
ns
 && !
	`k»f_g‘_uÆess_z”o
(&ns->
k»f
))

645 
ns
 = 
NULL
;

646 
	`¥š_uÆock
(&
dev_li¡_lock
);

648  
ns
;

649 
	}
}

651 
	$nvme_»queue_»q
(
»que¡
 *
»q
)

653 
æags
;

655 
	`blk_mq_»queue_»que¡
(
»q
);

656 
	`¥š_lock_œq§ve
(
»q
->
q
->
queue_lock
, 
æags
);

657 ià(!
	`blk_queue_¡İ³d
(
»q
->
q
))

658 
	`blk_mq_kick_»queue_li¡
(
»q
->
q
);

659 
	`¥š_uÆock_œq»¡Üe
(
»q
->
q
->
queue_lock
, 
æags
);

660 
	}
}

662 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

663 
nvme_commªd
 *
cmd
, 
æags
, 
qid
)

665 
»que¡
 *
»q
;

667 ià(
qid
 =ğ
NVME_QID_ANY
) {

668 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
);

670 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
,

671 
qid
 ? qid - 1 : 0);

673 ià(
	`IS_ERR
(
»q
))

674  
»q
;

676 
»q
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

677 
»q
->
cmd_æags
 |ğ
REQ_FAILFAST_DRIVER
;

678 
»q
->
__d©a_Ën
 = 0;

679 
»q
->
__£ùÜ
 = (
£ùÜ_t
) -1;

680 
»q
->
bio
 =„eq->
biÙa
 = 
NULL
;

682 
»q
->
cmd
 = (*)cmd;

683 
»q
->
cmd_Ën
 = (
nvme_commªd
);

685  
»q
;

686 
	}
}

692 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

693 
nvme_com¶‘iÚ
 *
cqe
, *
bufãr
, 
bufæ’
,

694 
timeout
, 
qid
, 
©_h—d
, 
æags
)

696 
»que¡
 *
»q
;

697 
»t
;

699 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
æags
, 
qid
);

700 ià(
	`IS_ERR
(
»q
))

701  
	`PTR_ERR
(
»q
);

703 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

704 
»q
->
¥ecŸl
 = 
cqe
;

706 ià(
bufãr
 && 
bufæ’
) {

707 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
GFP_KERNEL
);

708 ià(
»t
)

709 
out
;

712 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 
©_h—d
);

713 
»t
 = 
»q
->
”rÜs
;

714 
out
:

715 
	`blk_mq_ä“_»que¡
(
»q
);

716  
»t
;

717 
	}
}

718 
EXPORT_SYMBOL_GPL
(
__nvme_subm™_sync_cmd
);

720 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

721 *
bufãr
, 
bufæ’
)

723  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

724 
NVME_QID_ANY
, 0, 0);

725 
	}
}

734 
boŞ
 
	$check_add_fÜ_sšgË_cÚt_phyadd»ss
(
__u£r
 *
add»ss
, 
Ëngth
, 
»que¡_queue
 *
q
)

736 
off£t
 = 0;

737 
couÁ
 = 0;

739 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

740 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

741 ià((
couÁ
 > 1è|| (()
add»ss
 & 
	`queue_dma_®ignm’t
(
q
))) {

743  
çl£
;

745  
Œue
;

746 
	}
}

748 
	$u£r_addr_Åages
(
off£t
, 
size
)

750 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

751  
couÁ
;

752 
	}
}

754 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
, 
boŞ
 
b_k”Ãl
)

756 
off£t
 = 
	`off£t_š_·ge
(
addr
);

757 
d©®’
 = 
Ën
;

758 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
,
Ën
);

759 
size
 = 0;

760 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

761 
m­³d_·ges
 = 0;

762 
i
 = 0;

764 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


765 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

767 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

768 ià(!
u£r_ùx
) {

769  
NULL
;

772 
u£r_ùx
->
ÃÁs
 = 0;

773 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

774 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

775 ià(
b_k”Ãl
) {

776 
·ge
 *·gğ
NULL
;

777 *
¤c_d©a
 = 
addr
;

778 
i
 = 0; i < 
num_·ge
; i++) {

779 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

780 
	`g‘_·ge
(
·ge
);

781 
u£r_ùx
->
·ges
[
i
] = 
·ge
;

782 
¤c_d©a
 +ğ
PAGE_SIZE
;

786 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

787 0, 
u£r_ùx
->
·ges
);

788 ià(
m­³d_·ges
 !ğ
num_·ge
) {

789 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

790 
ex™
;

793 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

794 
u£r_ùx
->
Ën
 = 
d©®’
;

795 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

796 
i
 = 0; i < 
num_·ge
; i++) {

797 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

798 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

799 
off£t
);

800 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

801 
off£t
 = 0;

803 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

804  
u£r_ùx
;

805 
ex™
:

806 ià(
u£r_ùx
) {

807 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

808 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

809 
	`kä“
(
u£r_ùx
);

811  
NULL
;

812 
	}
}

813 
	$__nvme_subm™_kv_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

814 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

815 
__u£r
 *
ubufãr
, 
bufæ’
,

816 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

817 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

819 
nvme_com¶‘iÚ
 
cqe
;

820 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

821 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

822 
»que¡
 *
»q
;

823 
»t
 = 0;

824 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

825 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

826 
aio_u£r_ùx
 *
k”Ãl_ùx
 = 
NULL
;

827 
sÿ‰”li¡
* 
m‘a_sg_±r
;

828 
sÿ‰”li¡
 
m‘a_sg
;

829 
·ge
* 
p_·ge
 = 
NULL
;

830 
nvme_io_·¿m
* 
·¿m
 = 
NULL
;

831 *
kv_d©a
 = 
NULL
;

832 *
kv_m‘a
 = 
NULL
;

833 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

834 
i
 = 0, 
off£t
 = 0;

835 
Ën
 = 0;

836 
¡¬t_time
 = 
jiff›s
;

837 ià(!
disk
)

838  -
EFAULT
;

840 ià(
aio
) {

841 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

842 ià(!
aiocb
) {

843 
»t
 = -
ENOMEM
;

844 
out_’d
;

846 
aiocb
->
cmd
 = *cmd;

847 
aiocb
->
disk
 = disk;

848 
cmd
 = &
aiocb
->cmd;

850 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

851 ià(
	`IS_ERR
(
»q
)) {

852 ià(
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

853  
	`PTR_ERR
(
»q
);

856 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

857 ià(!
aio
)

858 
»q
->
¥ecŸl
 = &
cqe
;

859 
·¿m
 = 
	`nvme_io_·¿m
(
»q
);

860 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

861 
·¿m
->
kv_d©a_sg_±r
 = 
NULL
;

862 
·¿m
->
kv_d©a_ÃÁs
 = 0;

863 
·¿m
->
kv_d©a_Ën
 = 0;

865 ià(
ubufãr
 && 
bufæ’
) {

866 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
q
)) {

867 
Ãed_to_cİy
 = 
Œue
;

868 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

869 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

870 ià(
kv_d©a
 =ğ
NULL
) {

871 
»t
 = -
ENOMEM
;

872 
out_»q_’d
;

875 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
, 
çl£
);

876 ià(
Ãed_to_cİy
) {

877 
k”Ãl_ùx
 = 
	`g‘_aio_u£r_ùx
(
kv_d©a
, 
bufæ’
, 
Œue
);

878 ià(
k”Ãl_ùx
) {

879 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

880 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

881 
kv_d©a
, 
u£r_ùx
->
Ën
);

883 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

884 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

885 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

891 
k”Ãl_ùx
 = 
u£r_ùx
;

893 ià(
u£r_ùx
 =ğ
NULL
 || 
k”Ãl_ùx
 == NULL) {

894 
»t
 = -
ENOMEM
;

895 
out_unm­
;

897 
·¿m
->
kv_d©a_sg_±r
 = 
k”Ãl_ùx
->
sg
;

898 
·¿m
->
kv_d©a_ÃÁs
 = 
k”Ãl_ùx
->
ÃÁs
;

899 
·¿m
->
kv_d©a_Ën
 = 
k”Ãl_ùx
->
Ën
;

900 ià(
aio
) {

901 
aiocb
->
Ãed_to_cİy
 =‚eed_to_copy;

902 
aiocb
->
kv_d©a
 = kv_data;

903 
aiocb
->
k”Ãl_ùx
 = kernel_ctx;

904 
aiocb
->
u£r_ùx
 = user_ctx;

905 
aiocb
->
¡¬t_time
 = 
jiff›s
;

907 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

908 
	`g’”ic_¡¬t_io_acù
(
WRITE
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

910 
	`g’”ic_¡¬t_io_acù
(
READ
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

914 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

915 ià(
	`check_add_fÜ_sšgË_cÚt_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
, 
q
)) {

916 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 0, &
p_·ge
);

917 ià(
»t
 != 1) {

918 
»t
 = -
ENOMEM
;

919 
out_unm­
;

921 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

923 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256) * 256;

924 
kv_m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

925 ià(!
kv_m‘a
) {

926 
»t
 = -
ENOMEM
;

927 
out_unm­
;

929 ià(
	`cİy_äom_u£r
(
kv_m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

930 
»t
 = -
EFAULT
;

931 
out_ä“_m‘a
;

933 
off£t
 = 
	`off£t_š_·ge
(
kv_m‘a
);

934 
p_·ge
 = 
	`vœt_to_·ge
(
kv_m‘a
);

935 
	`g‘_·ge
(
p_·ge
);

937 ià(
aio
) {

938 
aiocb
->
u£_m‘a
 = 
Œue
;

939 
aiocb
->
m‘a
 = 
kv_m‘a
;

940 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

942 
m‘a_sg_±r
 = &
m‘a_sg
;

944 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

945 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

946 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

947 
·¿m
->
kv_m‘a_sg_±r
 = 
m‘a_sg_±r
;

949 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

952 ià(
aio
) {

953 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

954 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

955 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

956 
»q
->
’d_io_d©a
 = 
aiocb
;

957 
»q
->
¥ecŸl
 = &
aiocb
->
cqe
;

958 
	`blk_execu‹_rq_nowa™
(
»q
->
q
, 
disk
,„eq, 0, 
kv_async_com¶‘iÚ
);

961 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

962 
»t
 = 
»q
->
”rÜs
;

963 ià(
»suÉ
)

964 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

965 ià(
¡©us
)

966 *
¡©us
 = 
	`Ë32_to_ıu
(
cqe
.status) >> 1;

967 ià(
»t
 && !
	`is_kv_™”_»q_cmd
(
cmd
->
commÚ
.
İcode
è&& !
	`is_kv_™”_»ad_cmd
(cmd->common.opcode)) {

969 
	`´_”r
("__nvme_subm™_u£r_cmd faed!!!!!: opcode(%02x)\n", 
cmd
->
commÚ
.
İcode
);

973 ià(
Ãed_to_cİy
) {

974 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

975 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || (((
	`Ë16_to_ıu
(
cqe
.
¡©us
) >>1) & 0x00ff) == 0x0093)))) {

977 *
d©a
 = 
kv_d©a
;

978 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

979 
d©a
[0], data[1], data[2], data[3],

980 
d©a
[4], data[5], data[6], data[7]);

982 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

983 
kv_d©a
, 
u£r_ùx
->
Ën
);

987 
out_ä“_m‘a
:

988 ià(
p_·ge
è
	`put_·ge
(p_page);

989 ià(
kv_m‘a
è
	`kä“
(kv_meta);

990 
out_unm­
:

991 ià(
u£r_ùx
) {

992 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++) {

993 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

995 
	`kä“
(
u£r_ùx
);

997 ià(
Ãed_to_cİy
) {

998 ià(
k”Ãl_ùx
) {

999 
i
 = 0; i < 
k”Ãl_ùx
->
ÃÁs
; i++) {

1000 
	`put_·ge
(
	`sg_·ge
(&
k”Ãl_ùx
->
sg
[
i
]));

1002 
	`kä“
(
k”Ãl_ùx
);

1004 ià(
kv_d©a
è
	`kä“
(kv_data);

1006 
out_»q_’d
:

1007 ià(
aio
 && 
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1008 
	`blk_mq_ä“_»que¡
(
»q
);

1010 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1011 
	`g’”ic_’d_io_acù
(
WRITE
, &
disk
->
·¹0
, 
¡¬t_time
);

1013 
	`g’”ic_’d_io_acù
(
READ
, &
disk
->
·¹0
, 
¡¬t_time
);

1015 
out_’d
:

1016  
»t
;

1017 
	}
}

1019 
	$nvme_u£r_kv_cmd
(
nvme_ù¾
 *
ù¾
,

1020 
nvme_ns
 *
ns
,

1021 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

1023 
nvme_·s¡hru_kv_cmd
 
cmd
;

1024 
nvme_commªd
 
c
;

1025 
timeout
 = 0;

1026 
¡©us
;

1027 
__u£r
 *
m‘ad©a
 = 
NULL
;

1028 
m‘a_Ën
 = 0;

1029 
İtiÚ
 = 0;

1030 
™”_hªdË
 = 0;

1031 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1032  -
EACCES
;

1033 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1034  -
EFAULT
;

1035 ià(
cmd
.
æags
)

1036  -
EINVAL
;

1040 ià(!
	`is_kv_cmd
(
cmd
.
İcode
)) {

1041  -
EINVAL
;

1043 
	`mem£t
(&
c
, 0, (c));

1044 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1045 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1046 #ifdeà
KSID_SUPPORT


1047 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

1049 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1051 ià(
cmd
.
timeout_ms
)

1052 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1059 
cmd
.
İcode
) {

1060 
nvme_cmd_kv_¡Üe
:

1061 
nvme_cmd_kv_­³nd
:

1062 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1063 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1065 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1066 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1067 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1068 
¡©us
 = -
EINVAL
;

1069 
ex™
;

1071 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1072 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

1074 ià(
cmd
.
d©a_Ëngth
 % 4) {

1075 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

1076 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

1078 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1080 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1081 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1082 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1084 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1087 
nvme_cmd_kv_»Œ›ve
:

1088 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1089 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1091 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1092 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1093 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1094 
¡©us
 = -
EINVAL
;

1095 
ex™
;

1097 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1098 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

1099 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1101 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1102 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1103 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1105 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1108 ià(
aio
 && 
	`off£t_š_·ge
(
cmd
.
d©a_addr
)) {

1110 
¡©us
 = -
EINVAL
;

1111 
ex™
;

1115 
nvme_cmd_kv_d–‘e
:

1116 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1117 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1118 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1119 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1120 
¡©us
 = -
EINVAL
;

1121 
ex™
;

1123 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1124 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

1125 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1126 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1127 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1129 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1132 
nvme_cmd_kv_exi¡
:

1133 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1134 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1135 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1136 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1137 
¡©us
 = -
EINVAL
;

1138 
ex™
;

1140 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1141 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

1142 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1143 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1144 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1146 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1150 
nvme_cmd_kv_™”_»q
:

1151 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1152 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1153 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

1154 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

1155 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1156 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1158 
nvme_cmd_kv_™”_»ad
:

1159 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1160 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1161 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

1162 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

1163 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1166 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

1167 
¡©us
 = -
EINVAL
;

1168 
ex™
;

1177 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
, &
cmd
,

1178 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
, 0,

1179 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

1180 
ex™
:

1181 ià(!
aio
) {

1182 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1183  -
EFAULT
;

1184 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

1185  -
EFAULT
;

1187  
¡©us
;

1189 
	}
}

1191 
	$nvme_u£r_kv_aio_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1192 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
)

1194  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, 
ucmd
, 
Œue
);

1195 
	}
}

1199 
	$__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1200 
__u£r
 *
ubufãr
, 
bufæ’
,

1201 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1202 
u32
 *
»suÉ
, 
timeout
)

1204 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
(
cmd
);

1205 
nvme_com¶‘iÚ
 
cqe
;

1206 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1207 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1208 
»que¡
 *
»q
;

1209 
bio
 *biØğ
NULL
;

1210 *
m‘a
 = 
NULL
;

1211 
»t
;

1213 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1214 ià(
	`IS_ERR
(
»q
))

1215  
	`PTR_ERR
(
»q
);

1217 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1218 
»q
->
¥ecŸl
 = &
cqe
;

1220 ià(
ubufãr
 && 
bufæ’
) {

1221 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
,

1222 
GFP_KERNEL
);

1223 ià(
»t
)

1224 
out
;

1225 
bio
 = 
»q
->bio;

1227 ià(!
disk
)

1228 
subm™
;

1229 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

1230 ià(!
bio
->
bi_bdev
) {

1231 
»t
 = -
ENODEV
;

1232 
out_unm­
;

1235 ià(
m‘a_bufãr
) {

1236 
bio_š‹gr™y_·ylßd
 *
b
;

1238 
m‘a
 = 
	`km®loc
(
m‘a_Ën
, 
GFP_KERNEL
);

1239 ià(!
m‘a
) {

1240 
»t
 = -
ENOMEM
;

1241 
out_unm­
;

1244 ià(
wr™e
) {

1245 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
,

1246 
m‘a_Ën
)) {

1247 
»t
 = -
EFAULT
;

1248 
out_ä“_m‘a
;

1252 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

1253 ià(
	`IS_ERR
(
b
)) {

1254 
»t
 = 
	`PTR_ERR
(
b
);

1255 
out_ä“_m‘a
;

1258 
b
->
b_™”
.
bi_size
 = 
m‘a_Ën
;

1259 
b
->
b_™”
.
bi_£ùÜ
 = 
m‘a_£ed
;

1261 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
m‘a
),

1262 
m‘a_Ën
, 
	`off£t_š_·ge
(
m‘a
));

1263 ià(
»t
 !ğ
m‘a_Ën
) {

1264 
»t
 = -
ENOMEM
;

1265 
out_ä“_m‘a
;

1269 
subm™
:

1270 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1271 
»t
 = 
»q
->
”rÜs
;

1272 ià(
»suÉ
)

1273 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1274 ià(
m‘a
 && !
»t
 && !
wr™e
) {

1275 ià(
	`cİy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

1276 
»t
 = -
EFAULT
;

1278 
out_ä“_m‘a
:

1279 
	`kä“
(
m‘a
);

1280 
out_unm­
:

1281 ià(
bio
) {

1282 ià(
disk
 && 
bio
->
bi_bdev
)

1283 
	`bdput
(
bio
->
bi_bdev
);

1284 
	`blk_rq_unm­_u£r
(
bio
);

1286 
out
:

1287 
	`blk_mq_ä“_»que¡
(
»q
);

1288  
»t
;

1289 
	}
}

1291 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1292 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

1293 
timeout
)

1295  
	`__nvme_subm™_u£r_cmd
(
q
, 
cmd
, 
ubufãr
, 
bufæ’
, 
NULL
, 0, 0,

1296 
»suÉ
, 
timeout
);

1297 
	}
}

1299 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1301 
nvme_commªd
 
c
 = { };

1302 
”rÜ
;

1305 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1306 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(1);

1308 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1309 ià(!*
id
)

1310  -
ENOMEM
;

1312 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1313 (
nvme_id_ù¾
));

1314 ià(
”rÜ
)

1315 
	`kä“
(*
id
);

1316  
”rÜ
;

1317 
	}
}

1319 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1321 
nvme_commªd
 
c
 = { };

1323 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1324 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(2);

1325 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1326  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
, 0x1000);

1327 
	}
}

1329 
	$nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

1330 
nvme_id_ns
 **
id
)

1332 
nvme_commªd
 
c
 = { };

1333 
”rÜ
;

1336 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
,

1337 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid),

1339 *
id
 = 
	`km®loc
((
nvme_id_ns
), 
GFP_KERNEL
);

1340 ià(!*
id
)

1341  -
ENOMEM
;

1343 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1344 (
nvme_id_ns
));

1345 ià(
”rÜ
)

1346 
	`kä“
(*
id
);

1347  
”rÜ
;

1348 
	}
}

1350 
	$nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

1351 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1353 
nvme_commªd
 
c
;

1354 
nvme_com¶‘iÚ
 
cqe
;

1355 
»t
;

1357 
	`mem£t
(&
c
, 0, (c));

1358 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_g‘_ã©u»s
;

1359 
c
.
ã©u»s
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1360 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1362 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
cqe
, 
bufãr
, 
buæ’
, 0,

1363 
NVME_QID_ANY
, 0, 0);

1364 ià(
»t
 >ğ0 && 
»suÉ
)

1365 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1366  
»t
;

1367 
	}
}

1369 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1370 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1372 
nvme_commªd
 
c
;

1373 
nvme_com¶‘iÚ
 
cqe
;

1374 
»t
;

1376 
	`mem£t
(&
c
, 0, (c));

1377 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1378 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1379 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1381 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
cqe
,

1382 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 0);

1383 ià(
»t
 >ğ0 && 
»suÉ
)

1384 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1385  
»t
;

1386 
	}
}

1388 
	$nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
)

1390 
nvme_commªd
 
c
 = { };

1391 
”rÜ
;

1393 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
,

1394 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF),

1395 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(

1396 ((((
nvme_sm¬t_log
) / 4) - 1) << 16) |

1397 
NVME_LOG_SMART
),

1399 *
log
 = 
	`km®loc
((
nvme_sm¬t_log
), 
GFP_KERNEL
);

1400 ià(!*
log
)

1401  -
ENOMEM
;

1403 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
log
,

1404 (
nvme_sm¬t_log
));

1405 ià(
”rÜ
)

1406 
	`kä“
(*
log
);

1407  
”rÜ
;

1408 
	}
}

1410 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1412 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1413 
u32
 
»suÉ
;

1414 
¡©us
, 
Ä_io_queues
;

1416 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 
NULL
, 0,

1417 &
»suÉ
);

1418 ià(
¡©us
)

1419  
¡©us
;

1421 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

1422 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

1424 
	}
}

1426 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1428 
nvme_u£r_io
 
io
;

1429 
nvme_commªd
 
c
;

1430 
Ëngth
, 
m‘a_Ën
;

1431 
__u£r
 *
m‘ad©a
;

1433 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

1434  -
EFAULT
;

1436 
io
.
İcode
) {

1437 
nvme_cmd_wr™e
:

1438 
nvme_cmd_»ad
:

1439 
nvme_cmd_com·»
:

1442  -
EINVAL
;

1445 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1446 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1447 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

1449 ià(
ns
->
ext
) {

1450 
Ëngth
 +ğ
m‘a_Ën
;

1451 
m‘a_Ën
 = 0;

1452 } ià(
m‘a_Ën
) {

1453 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

1454  -
EINVAL
;

1457 
	`mem£t
(&
c
, 0, (c));

1458 
c
.
rw
.
İcode
 = 
io
.opcode;

1459 
c
.
rw
.
æags
 = 
io
.flags;

1460 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1461 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

1462 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

1463 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

1464 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

1465 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

1466 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

1467 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

1469  
	`__nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1470 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

1471 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

1472 
	}
}

1474 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1475 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

1477 
nvme_·s¡hru_cmd
 
cmd
;

1478 
nvme_commªd
 
c
;

1479 
timeout
 = 0;

1480 
¡©us
;

1482 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1483  -
EACCES
;

1484 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1485  -
EFAULT
;

1487 ià(
	`is_kv_cmd
(
cmd
.
İcode
))

1488  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, (
nvme_·s¡hru_kv_cmd
 
__u£r
 *)
ucmd
, 
çl£
);

1490 
	`mem£t
(&
c
, 0, (c));

1491 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1492 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1493 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1494 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

1495 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

1496 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

1497 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

1498 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1499 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1500 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

1501 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

1503 ià(
cmd
.
timeout_ms
)

1504 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1506 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

1507 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

1508 &
cmd
.
»suÉ
, 
timeout
);

1509 ià(
¡©us
 >= 0) {

1510 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1511  -
EFAULT
;

1514  
¡©us
;

1515 
	}
}

1517 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1518 
cmd
, 
¬g
)

1520 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1522 
cmd
) {

1523 
NVME_IOCTL_ID
:

1524 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

1525  
ns
->
ns_id
;

1526 
NVME_IOCTL_ADMIN_CMD
:

1527  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

1528 
NVME_IOCTL_IO_CMD
:

1529  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1530 
NVME_IOCTL_SUBMIT_IO
:

1531  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

1533 
NVME_IOCTL_IO_KV_CMD
:

1534  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
çl£
);

1535 
NVME_IOCTL_AIO_CMD
:

1536  
	`nvme_u£r_kv_aio_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1537 
NVME_IOCTL_SET_AIOCTX
:

1538  
	`nvme_£t_aioùx
((
__u£r
*)
¬g
);

1539 
NVME_IOCTL_DEL_AIOCTX
:

1540  
	`nvme_d–_aioùx
((
__u£r
*)
¬g
);

1541 
NVME_IOCTL_GET_AIOEVENT
:

1542  
	`nvme_g‘_iÛv’ts
((
__u£r
*)
¬g
);

1544 #ifdeà
CONFIG_BLK_DEV_NVME_SCSI


1545 
SG_GET_VERSION_NUM
:

1546  
	`nvme_sg_g‘_v”siÚ_num
((
__u£r
 *)
¬g
);

1547 
SG_IO
:

1548  
	`nvme_sg_io
(
ns
, (
__u£r
 *)
¬g
);

1551  -
ENOTTY
;

1553 
	}
}

1555 #ifdeà
CONFIG_COMPAT


1556 
	$nvme_com·t_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1557 
cmd
, 
¬g
)

1559 
cmd
) {

1560 
SG_IO
:

1561  -
ENOIOCTLCMD
;

1563  
	`nvme_ioùl
(
bdev
, 
mode
, 
cmd
, 
¬g
);

1564 
	}
}

1566 
	#nvme_com·t_ioùl
 
NULL


	)

1569 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

1571  
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
è? 0 : -
ENXIO
;

1572 
	}
}

1574 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

1576 
	`nvme_put_ns
(
disk
->
´iv©e_d©a
);

1577 
	}
}

1579 
	$nvme_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

1582 
geo
->
h—ds
 = 1 << 6;

1583 
geo
->
£ùÜs
 = 1 << 5;

1584 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bdev
->
bd_disk
) >> 11;

1586 
	}
}

1588 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


1589 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1591 
blk_š‹gr™y
 
š‹gr™y
;

1593 
ns
->
pi_ty³
) {

1594 
NVME_NS_DPS_PI_TYPE3
:

1595 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³3_üc
;

1597 
NVME_NS_DPS_PI_TYPE1
:

1598 
NVME_NS_DPS_PI_TYPE2
:

1599 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³1_üc
;

1602 
š‹gr™y
.
´ofe
 = 
NULL
;

1605 
š‹gr™y
.
tu¶e_size
 = 
ns
->
ms
;

1606 
	`blk_š‹gr™y_»gi¡”
(
ns
->
disk
, &
š‹gr™y
);

1607 
	`blk_queue_max_š‹gr™y_£gm’ts
(
ns
->
queue
, 1);

1608 
	}
}

1610 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1612 
	}
}

1615 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

1617 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1618 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

1620 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DISCARD_ZEROES
)

1621 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 1;

1623 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

1625 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

1626 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

1627 
	`blk_queue_max_disÿrd_£ùÜs
(
ns
->
queue
, 0xffffffff);

1628 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

1629 
	}
}

1631 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

1633 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1634 
nvme_id_ns
 *
id
;

1635 
u8
 
lbaf
, 
pi_ty³
;

1636 
u16
 
Şd_ms
;

1637 
bs
;

1639 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

1640 
	`£t_ÿ·c™y
(
disk
, 0);

1641  -
ENODEV
;

1643 ià(
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id
)) {

1644 
	`dev_w¬n
(
ns
->
ù¾
->
dev
, "%s: Identify failure‚vme%dn%d\n",

1645 
__func__
, 
ns
->
ù¾
->
š¡ªû
,‚s->
ns_id
);

1646  -
ENODEV
;

1648 ià(
id
->
nÿp
 == 0) {

1649 
	`kä“
(
id
);

1650  -
ENODEV
;

1653 ià(
	`nvme_nvm_ns_suµÜ‹d
(
ns
, 
id
è&&‚s->
ty³
 !ğ
NVME_NS_LIGHTNVM
) {

1654 ià(
	`nvme_nvm_»gi¡”
(
ns
->
queue
, 
disk
->
disk_Çme
)) {

1655 
	`dev_w¬n
(
ns
->
ù¾
->
dev
,

1656 "%s: LightNVM in™ fau»\n", 
__func__
);

1657 
	`kä“
(
id
);

1658  -
ENODEV
;

1660 
ns
->
ty³
 = 
NVME_NS_LIGHTNVM
;

1663 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1))

1664 
	`memıy
(
ns
->
eui
, 
id
->
eui64
, (ns->eui));

1665 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2))

1666 
	`memıy
(
ns
->
uuid
, 
id
->
nguid
, (ns->uuid));

1668 
Şd_ms
 = 
ns
->
ms
;

1669 
lbaf
 = 
id
->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
;

1670 
ns
->
lba_shiá
 = 
id
->
lbaf
[lbaf].
ds
;

1671 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[lbaf].ms);

1672 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

1678 ià(
ns
->
lba_shiá
 == 0)

1679 
ns
->
lba_shiá
 = 9;

1680 
bs
 = 1 << 
ns
->
lba_shiá
;

1682 
pi_ty³
 = 
ns
->
ms
 =ğ(
t10_pi_tu¶e
) ?

1683 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
 : 0;

1685 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

1686 ià(
	`blk_g‘_š‹gr™y
(
disk
è&& (
ns
->
pi_ty³
 !=…i_type ||

1687 
ns
->
ms
 !ğ
Şd_ms
 ||

1688 
bs
 !ğ
	`queue_logiÿl_block_size
(
disk
->
queue
) ||

1689 (
ns
->
ms
 &&‚s->
ext
)))

1690 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

1692 
ns
->
pi_ty³
 =…i_type;

1693 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 
bs
);

1695 ià(
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
è&& !ns->
ext
)

1696 
	`nvme_š™_š‹gr™y
(
ns
);

1697 ià(
ns
->
ms
 && !Òs->m =ğ8 &&‚s->
pi_ty³
è&& !
	`blk_g‘_š‹gr™y
(
disk
))

1698 
	`£t_ÿ·c™y
(
disk
, 0);

1700 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

1702 ià(
ns
->
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

1703 
	`nvme_cÚfig_disÿrd
(
ns
);

1704 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

1706 
	`kä“
(
id
);

1708 
	}
}

1710 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

1712 
ty³
) {

1713 
PR_WRITE_EXCLUSIVE
:

1715 
PR_EXCLUSIVE_ACCESS
:

1717 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

1719 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

1721 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

1723 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

1728 
	}
};

1730 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

1731 
u64
 
key
, u64 
§_key
, 
u8
 
İ
)

1733 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1734 
nvme_commªd
 
c
;

1735 
u8
 
d©a
[16] = { 0, };

1737 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

1738 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

1740 
	`mem£t
(&
c
, 0, (c));

1741 
c
.
commÚ
.
İcode
 = 
İ
;

1742 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1743 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

1745  
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

1746 
	}
}

1748 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Şd
,

1749 
u64
 
Ãw
, 
æags
)

1751 
u32
 
cdw10
;

1753 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

1754  -
EOPNOTSUPP
;

1756 
cdw10
 = 
Şd
 ? 2 : 0;

1757 
cdw10
 |ğ(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

1758 
cdw10
 |= (1 << 30) | (1 << 31);

1759  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

1760 
	}
}

1762 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

1763 
´_ty³
 
ty³
, 
æags
)

1765 
u32
 
cdw10
;

1767 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

1768  -
EOPNOTSUPP
;

1770 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

1771 
cdw10
 |ğ((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

1772  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

1773 
	}
}

1775 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Şd
, u64 
Ãw
,

1776 
´_ty³
 
ty³
, 
boŞ
 
abÜt
)

1778 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
abÜt
 ? 2 : 1;

1779  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

1780 
	}
}

1782 
	$nvme_´_ş—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

1784 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

1785  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

1786 
	}
}

1788 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

1790 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
key
 ? 1 << 3 : 0;

1791  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

1792 
	}
}

1794 cÚ¡ 
´_İs
 
	gnvme_´_İs
 = {

1795 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

1796 .
	g´_»£rve
 = 
nvme_´_»£rve
,

1797 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

1798 .
	g´_´“m±
 = 
nvme_´_´“m±
,

1799 .
	g´_ş—r
 = 
nvme_´_ş—r
,

1802 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

1803 .
owÃr
 = 
THIS_MODULE
,

1804 .
	gioùl
 = 
nvme_ioùl
,

1805 .
	gcom·t_ioùl
 = 
nvme_com·t_ioùl
,

1806 .
	gİ’
 = 
nvme_İ’
,

1807 .
	g»Ëa£
 = 
nvme_»Ëa£
,

1808 .
	gg‘geo
 = 
nvme_g‘geo
,

1809 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

1810 .
	g´_İs
 = &
nvme_´_İs
,

1813 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

1815 
timeout
 =

1816 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

1817 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

1818 
»t
;

1820 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

1821 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ğ
b™
)

1824 
	`m¦“p
(100);

1825 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1826  -
EINTR
;

1827 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1828 
	`dev_”r
(
ù¾
->
dev
,

1829 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

1831  -
ENODEV
;

1835  
»t
;

1836 
	}
}

1844 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

1846 
»t
;

1848 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1849 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

1851 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1852 ià(
»t
)

1853  
»t
;

1855 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

1856 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

1858  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

1859 
	}
}

1861 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

1868 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

1869 
»t
;

1871 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

1872 
	`dev_”r
(
ù¾
->
dev
,

1874 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

1875  -
ENODEV
;

1878 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

1880 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

1881 
ù¾
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

1882 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

1883 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

1884 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

1886 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1887 ià(
»t
)

1888  
»t
;

1889  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

1890 
	}
}

1892 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

1894 
timeout
 = 
SHUTDOWN_TIMEOUT
 + 
jiff›s
;

1895 
u32
 
c¡s
;

1896 
»t
;

1898 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1899 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

1901 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1902 ià(
»t
)

1903  
»t
;

1905 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

1906 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ğ
NVME_CSTS_SHST_CMPLT
)

1909 
	`m¦“p
(100);

1910 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1911  -
EINTR
;

1912 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1913 
	`dev_”r
(
ù¾
->
dev
,

1915  -
ENODEV
;

1919  
»t
;

1920 
	}
}

1922 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

1923 
»que¡_queue
 *
q
)

1925 ià(
ù¾
->
max_hw_£ùÜs
) {

1926 
u32
 
max_£gm’ts
 =

1927 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

1929 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

1930 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

1932 ià(
ù¾
->
¡re_size
)

1933 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
¡re_size
 >> 9);

1934 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

1935 
	`blk_queue_æush
(
q
, 
REQ_FLUSH
 | 
REQ_FUA
);

1936 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

1937 
	}
}

1939 
	$nvme_cÚfigu»_­¡
(
nvme_ù¾
 *
ù¾
)

1957 
­¡e
;

1958 
nvme_ã©_auto_p¡
 *
bË
;

1959 
»t
;

1965 ià(!
ù¾
->
­¡a
)

1968 ià(
ù¾
->
Åss
 > 31) {

1969 
	`dev_w¬n
(
ù¾
->
deviû
, "NPSS is invalid;‚ot using APST\n");

1973 
bË
 = 
	`kz®loc
((*bË), 
GFP_KERNEL
);

1974 ià(!
bË
)

1977 ià(
ù¾
->
ps_max_Ï‹ncy_us
 == 0) {

1979 
­¡e
 = 0;

1981 
__Ë64
 
rg‘
 = 
	`ıu_to_Ë64
(0);

1982 
¡©e
;

1990 
¡©e
 = ()
ù¾
->
Åss
; state >= 0; state--) {

1991 
u64
 
tÙ®_Ï‹ncy_us
, 
ex™_Ï‹ncy_us
, 
Œªs™iÚ_ms
;

1993 ià(
rg‘
)

1994 
bË
->
’Œ›s
[
¡©e
] = 
rg‘
;

2000 ià(
¡©e
 =ğ
ù¾
->
Åss
 &&

2001 (
ù¾
->
quœks
 & 
NVME_QUIRK_NO_DEEPEST_PS
))

2008 ià(!(
ù¾
->
psd
[
¡©e
].
æags
 &

2009 
NVME_PS_FLAGS_NON_OP_STATE
))

2012 
ex™_Ï‹ncy_us
 =

2013 (
u64
)
	`Ë32_to_ıu
(
ù¾
->
psd
[
¡©e
].
ex™_Ït
);

2014 ià(
ex™_Ï‹ncy_us
 > 
ù¾
->
ps_max_Ï‹ncy_us
)

2017 
tÙ®_Ï‹ncy_us
 =

2018 
ex™_Ï‹ncy_us
 +

2019 
	`Ë32_to_ıu
(
ù¾
->
psd
[
¡©e
].
’Œy_Ït
);

2025 
Œªs™iÚ_ms
 = 
tÙ®_Ï‹ncy_us
 + 19;

2026 
	`do_div
(
Œªs™iÚ_ms
, 20);

2027 ià(
Œªs™iÚ_ms
 > (1 << 24) - 1)

2028 
Œªs™iÚ_ms
 = (1 << 24) - 1;

2030 
rg‘
 = 
	`ıu_to_Ë64
((
¡©e
 << 3) |

2031 (
Œªs™iÚ_ms
 << 8));

2034 
­¡e
 = 1;

2037 
»t
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_AUTO_PST
, 
­¡e
,

2038 
bË
, (*bË), 
NULL
);

2039 ià(
»t
)

2040 
	`dev_”r
(
ù¾
->
deviû
, "çedØ£ˆAPST f—tu» (%d)\n", 
»t
);

2042 
	`kä“
(
bË
);

2043 
	}
}

2045 
	$nvme_£t_Ï‹ncy_tŞ”ªû
(
deviû
 *
dev
, 
s32
 
v®
)

2047 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2048 
u64
 
Ï‹ncy
;

2050 
v®
) {

2051 
PM_QOS_LATENCY_TOLERANCE_NO_CONSTRAINT
:

2052 
PM_QOS_LATENCY_ANY
:

2053 
Ï‹ncy
 = 
U64_MAX
;

2057 
Ï‹ncy
 = 
v®
;

2060 ià(
ù¾
->
ps_max_Ï‹ncy_us
 !ğ
Ï‹ncy
) {

2061 
ù¾
->
ps_max_Ï‹ncy_us
 = 
Ï‹ncy
;

2062 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2064 
	}
}

2066 
	snvme_cÜe_quœk_’Œy
 {

2072 
u16
 
	mvid
;

2073 cÚ¡ *
	mmn
;

2074 cÚ¡ *
	mä
;

2075 
	mquœks
;

2078 cÚ¡ 
nvme_cÜe_quœk_’Œy
 
	gcÜe_quœks
[] = {

2084 .
vid
 = 0x1179,

2085 .
	gmn
 = "THNSF5256GPUK TOSHIBA",

2086 .
	gquœks
 = 
NVME_QUIRK_NO_APST
,

2091 
boŞ
 
	$¡ršg_m©ches
(cÚ¡ *
id¡r
, cÚ¡ *
m©ch
, 
size_t
 
Ën
)

2093 
size_t
 
m©chËn
;

2095 ià(!
m©ch
)

2096  
Œue
;

2098 
m©chËn
 = 
	`¡¾’
(
m©ch
);

2099 
	`WARN_ON_ONCE
(
m©chËn
 > 
Ën
);

2101 ià(
	`memcmp
(
id¡r
, 
m©ch
, 
m©chËn
))

2102  
çl£
;

2104 ; 
m©chËn
 < 
Ën
; matchlen++)

2105 ià(
id¡r
[
m©chËn
] != ' ')

2106  
çl£
;

2108  
Œue
;

2109 
	}
}

2111 
boŞ
 
	$quœk_m©ches
(cÚ¡ 
nvme_id_ù¾
 *
id
,

2112 cÚ¡ 
nvme_cÜe_quœk_’Œy
 *
q
)

2114  
q
->
vid
 =ğ
	`Ë16_to_ıu
(
id
->vid) &&

2115 
	`¡ršg_m©ches
(
id
->
mn
, 
q
->mn, (id->mn)) &&

2116 
	`¡ršg_m©ches
(
id
->
ä
, 
q
->fr, (id->fr));

2117 
	}
}

2124 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

2126 
nvme_id_ù¾
 *
id
;

2127 
u64
 
ÿp
;

2128 
»t
, 
·ge_shiá
;

2129 
u8
 
´ev_­¡a
;

2131 
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

2132 ià(
»t
) {

2133 
	`dev_”r
(
ù¾
->
dev
, "R—dšg VS faed (%d)\n", 
»t
);

2134  
»t
;

2137 
»t
 = 
ù¾
->
İs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

2138 ià(
»t
) {

2139 
	`dev_”r
(
ù¾
->
dev
, "R—dšg CAP faed (%d)\n", 
»t
);

2140  
»t
;

2142 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

2144 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1))

2145 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

2147 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

2148 ià(
»t
) {

2149 
	`dev_”r
(
ù¾
->
dev
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»t
);

2150  -
EIO
;

2153 ià(!
ù¾
->
id’tif›d
) {

2163 
i
;

2165 
i
 = 0; i < 
	`ARRAY_SIZE
(
cÜe_quœks
); i++) {

2166 ià(
	`quœk_m©ches
(
id
, &
cÜe_quœks
[
i
]))

2167 
ù¾
->
quœks
 |ğ
cÜe_quœks
[
i
].quirks;

2171 
ù¾
->
Úcs
 = 
	`Ë16_to_ıup
(&
id
->oncs);

2172 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aş
 + 1);

2173 
ù¾
->
vwc
 = 
id
->vwc;

2174 
	`memıy
(
ù¾
->
£rŸl
, 
id
->
¢
, (id->sn));

2175 
	`memıy
(
ù¾
->
mod–
, 
id
->
mn
, (id->mn));

2176 
	`memıy
(
ù¾
->
fœmw¬e_»v
, 
id
->
ä
, (id->fr));

2177 ià(
id
->
mdts
)

2178 
ù¾
->
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

2180 
ù¾
->
max_hw_£ùÜs
 = 
UINT_MAX
;

2182 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
è&& 
id
->
vs
[3]) {

2183 
max_hw_£ùÜs
;

2185 
ù¾
->
¡re_size
 = 1 << (
id
->
vs
[3] + 
·ge_shiá
);

2186 
max_hw_£ùÜs
 = 
ù¾
->
¡re_size
 >> (
·ge_shiá
 - 9);

2187 ià(
ù¾
->
max_hw_£ùÜs
) {

2188 
ù¾
->
max_hw_£ùÜs
 = 
	`mš
(max_hw_sectors,

2189 
ù¾
->
max_hw_£ùÜs
);

2191 
ù¾
->
max_hw_£ùÜs
 = max_hw_sectors;

2195 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

2197 
ù¾
->
Åss
 = 
id
->npss;

2198 
´ev_­¡a
 = 
ù¾
->
­¡a
;

2199 
ù¾
->
­¡a
 = (ù¾->
quœks
 & 
NVME_QUIRK_NO_APST
è? 0 : 
id
->apsta;

2200 
	`memıy
(
ù¾
->
psd
, 
id
->psd, (ctrl->psd));

2202 
	`kä“
(
id
);

2204 ià(
ù¾
->
­¡a
 && !
´ev_­¡a
)

2205 
	`dev_pm_qos_expo£_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
);

2206 ià(!
ù¾
->
­¡a
 && 
´ev_­¡a
)

2207 
	`dev_pm_qos_hide_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
);

2209 
	`nvme_cÚfigu»_­¡
(
ù¾
);

2211 
ù¾
->
id’tif›d
 = 
Œue
;

2213  
»t
;

2214 
	}
}

2216 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *file)

2218 
nvme_ù¾
 *
ù¾
;

2219 
š¡ªû
 = 
	`imšÜ
(
šode
);

2220 
»t
 = -
ENODEV
;

2222 
	`¥š_lock
(&
dev_li¡_lock
);

2223 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_ù¾_li¡
, 
node
) {

2224 ià(
ù¾
->
š¡ªû
 != instance)

2227 ià(!
ù¾
->
admš_q
) {

2228 
»t
 = -
EWOULDBLOCK
;

2231 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
k»f
))

2233 
fe
->
´iv©e_d©a
 = 
ù¾
;

2234 
»t
 = 0;

2237 
	`¥š_uÆock
(&
dev_li¡_lock
);

2239  
»t
;

2240 
	}
}

2242 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

2244 
	`nvme_put_ù¾
(
fe
->
´iv©e_d©a
);

2246 
	}
}

2248 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

2250 
nvme_ns
 *
ns
;

2251 
»t
;

2253 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2254 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

2255 
»t
 = -
ENOTTY
;

2256 
out_uÆock
;

2259 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

2260 ià(
ns
 !ğ
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

2261 
	`dev_w¬n
(
ù¾
->
dev
,

2263 
»t
 = -
EINVAL
;

2264 
out_uÆock
;

2267 
	`dev_w¬n
(
ù¾
->
dev
,

2269 
	`k»f_g‘
(&
ns
->
k»f
);

2270 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2272 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

2273 
	`nvme_put_ns
(
ns
);

2274  
»t
;

2276 
out_uÆock
:

2277 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2278  
»t
;

2279 
	}
}

2281 
	$nvme_dev_ioùl
(
fe
 *fe, 
cmd
,

2282 
¬g
)

2284 
nvme_ù¾
 *
ù¾
 = 
fe
->
´iv©e_d©a
;

2285 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

2287 
cmd
) {

2288 
NVME_IOCTL_ADMIN_CMD
:

2289  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

2290 
NVME_IOCTL_IO_CMD
:

2291  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

2292 
NVME_IOCTL_RESET
:

2293 
	`dev_w¬n
(
ù¾
->
dev
, "resetting controller\n");

2294  
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2295 
NVME_IOCTL_SUBSYS_RESET
:

2296  
	`nvme_»£t_subsy¡em
(
ù¾
);

2298  -
ENOTTY
;

2300 
	}
}

2302 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

2303 .
owÃr
 = 
THIS_MODULE
,

2304 .
	gİ’
 = 
nvme_dev_İ’
,

2305 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

2306 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

2307 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

2310 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

2311 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2312 
size_t
 
couÁ
)

2314 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2315 
»t
;

2317 
»t
 = 
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2318 ià(
»t
 < 0)

2319  
»t
;

2320  
couÁ
;

2321 
	}
}

2322 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

2324 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2325 *
buf
)

2327 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2328  
	`¥rštf
(
buf
, "%pU\n", 
ns
->
uuid
);

2329 
	}
}

2330 
DEVICE_ATTR
(
uuid
, 
S_IRUGO
, 
uuid_show
, 
NULL
);

2332 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2333 *
buf
)

2335 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2336  
	`¥rštf
(
buf
, "%8phd\n", 
ns
->
eui
);

2337 
	}
}

2338 
DEVICE_ATTR
(
eui
, 
S_IRUGO
, 
eui_show
, 
NULL
);

2340 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2341 *
buf
)

2343 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2344  
	`¥rštf
(
buf
, "%d\n", 
ns
->
ns_id
);

2345 
	}
}

2346 
DEVICE_ATTR
(
nsid
, 
S_IRUGO
, 
nsid_show
, 
NULL
);

2348 
©Œibu‹
 *
	gnvme_ns_©Œs
[] = {

2349 &
dev_©Œ_uuid
.
©Œ
,

2350 &
dev_©Œ_eui
.
©Œ
,

2351 &
dev_©Œ_nsid
.
©Œ
,

2352 
NULL
,

2355 
umode_t
 
	$nvme_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2356 
©Œibu‹
 *
a
, 
n
)

2358 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2359 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2361 ià(
a
 =ğ&
dev_©Œ_uuid
.
©Œ
) {

2362 ià(!
	`memchr_šv
(
ns
->
uuid
, 0, (ns->uuid)))

2365 ià(
a
 =ğ&
dev_©Œ_eui
.
©Œ
) {

2366 ià(!
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

2369  
a
->
mode
;

2370 
	}
}

2372 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_©Œ_group
 = {

2373 .
©Œs
 = 
nvme_ns_©Œs
,

2374 .
	gis_visibË
 = 
nvme_©Œs_¬e_visibË
,

2377 
	#nvme_show_funùiÚ
(
f›ld
) \

2378 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2379 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2381 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2382  
	`¥rštf
(
buf
, "%.*s\n", ()(
ù¾
->
f›ld
), ctrl->field); \

2384 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2386 
nvme_show_funùiÚ
(
mod–
);

2387 
nvme_show_funùiÚ
(
£rŸl
);

2388 
nvme_show_funùiÚ
(
fœmw¬e_»v
);

2390 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

2391 &
dev_©Œ_»£t_cÚŒŞËr
.
©Œ
,

2392 &
dev_©Œ_mod–
.
©Œ
,

2393 &
dev_©Œ_£rŸl
.
©Œ
,

2394 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

2395 
NULL


2398 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

2399 .
©Œs
 = 
nvme_dev_©Œs
,

2402 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

2403 &
nvme_dev_©Œs_group
,

2404 
NULL
,

2407 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

2409 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

2410 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

2412  
n§
->
ns_id
 - 
nsb
->ns_id;

2413 
	}
}

2415 
nvme_ns
 *
	$nvme_fšd_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2417 
nvme_ns
 *
ns
;

2419 
	`lockd•_as£¹_h–d
(&
ù¾
->
Çme¥aûs_mu‹x
);

2421 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2422 ià(
ns
->
ns_id
 =ğ
nsid
)

2423  
ns
;

2424 ià(
ns
->
ns_id
 > 
nsid
)

2427  
NULL
;

2428 
	}
}

2430 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2432 
nvme_ns
 *
ns
;

2433 
g’disk
 *
disk
;

2434 
node
 = 
	`dev_to_node
(
ù¾
->
dev
);

2436 
	`lockd•_as£¹_h–d
(&
ù¾
->
Çme¥aûs_mu‹x
);

2438 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

2439 ià(!
ns
)

2442 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

2443 ià(
	`IS_ERR
(
ns
->
queue
))

2444 
out_ä“_ns
;

2445 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NOMERGES
, 
ns
->
queue
);

2446 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

2447 
ns
->
queue
->
queued©a
 =‚s;

2448 
ns
->
ù¾
 = ctrl;

2450 
disk
 = 
	`®loc_disk_node
(0, 
node
);

2451 ià(!
disk
)

2452 
out_ä“_queue
;

2454 
	`k»f_š™
(&
ns
->
k»f
);

2455 
ns
->
ns_id
 = 
nsid
;

2456 
ns
->
disk
 = disk;

2457 
ns
->
lba_shiá
 = 9;

2460 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

2461 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

2463 
disk
->
majÜ
 = 
nvme_majÜ
;

2464 
disk
->
fœ¡_mšÜ
 = 0;

2465 
disk
->
fİs
 = &
nvme_fİs
;

2466 
disk
->
´iv©e_d©a
 = 
ns
;

2467 
disk
->
queue
 = 
ns
->queue;

2468 
disk
->
driv”fs_dev
 = 
ù¾
->
deviû
;

2469 
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

2470 
	`¥rštf
(
disk
->
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
nsid
);

2472 ià(
	`nvme_»v®id©e_disk
(
ns
->
disk
))

2473 
out_ä“_disk
;

2475 
	`li¡_add_
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

2476 
	`k»f_g‘
(&
ù¾
->
k»f
);

2477 ià(
ns
->
ty³
 =ğ
NVME_NS_LIGHTNVM
)

2480 
	`add_disk
(
ns
->
disk
);

2481 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2482 &
nvme_ns_©Œ_group
))

2483 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

2484 
ns
->
disk
->
disk_Çme
);

2486 
out_ä“_disk
:

2487 
	`kä“
(
disk
);

2488 
out_ä“_queue
:

2489 
	`blk_ş—nup_queue
(
ns
->
queue
);

2490 
out_ä“_ns
:

2491 
	`kä“
(
ns
);

2492 
	}
}

2494 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

2496 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

2499 ià(
ns
->
disk
->
æags
 & 
GENHD_FL_UP
) {

2500 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

2501 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

2502 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2503 &
nvme_ns_©Œ_group
);

2504 
	`d–_g’disk
(
ns
->
disk
);

2505 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

2506 
	`blk_ş—nup_queue
(
ns
->
queue
);

2508 
	`mu‹x_lock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2509 
	`li¡_d–_š™
(&
ns
->
li¡
);

2510 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2511 
	`nvme_put_ns
(
ns
);

2512 
	}
}

2514 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2516 
nvme_ns
 *
ns
;

2518 
ns
 = 
	`nvme_fšd_ns
(
ù¾
, 
nsid
);

2519 ià(
ns
) {

2520 ià(
	`»v®id©e_disk
(
ns
->
disk
))

2521 
	`nvme_ns_»move
(
ns
);

2523 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

2524 
	}
}

2526 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

2528 
nvme_ns
 *
ns
;

2529 
__Ë32
 *
ns_li¡
;

2530 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

2531 
»t
 = 0;

2533 
ns_li¡
 = 
	`kz®loc
(0x1000, 
GFP_KERNEL
);

2534 ià(!
ns_li¡
)

2535  -
ENOMEM
;

2537 
i
 = 0; i < 
num_li¡s
; i++) {

2538 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

2539 ià(
»t
)

2540 
out
;

2542 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

2543 
nsid
 = 
	`Ë32_to_ıu
(
ns_li¡
[
j
]);

2544 ià(!
nsid
)

2545 
out
;

2547 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

2549 ++
´ev
 < 
nsid
) {

2550 
ns
 = 
	`nvme_fšd_ns
(
ù¾
, 
´ev
);

2551 ià(
ns
)

2552 
	`nvme_ns_»move
(
ns
);

2555 
Â
 -ğ
j
;

2557 
out
:

2558 
	`kä“
(
ns_li¡
);

2559  
»t
;

2560 
	}
}

2562 
	$__nvme_sÿn_Çme¥aûs
(
nvme_ù¾
 *
ù¾
, 
Â
)

2564 
nvme_ns
 *
ns
, *
Ãxt
;

2565 
i
;

2567 
	`lockd•_as£¹_h–d
(&
ù¾
->
Çme¥aûs_mu‹x
);

2569 
i
 = 1; i <ğ
Â
; i++)

2570 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

2572 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2573 ià(
ns
->
ns_id
 > 
Â
)

2574 
	`nvme_ns_»move
(
ns
);

2576 
	}
}

2578 
	$nvme_sÿn_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

2580 
nvme_id_ù¾
 *
id
;

2581 
Â
;

2583 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

2586 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2587 
Â
 = 
	`Ë32_to_ıu
(
id
->nn);

2588 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1) &&

2589 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

2590 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

2591 
dÚe
;

2593 
	`__nvme_sÿn_Çme¥aûs
(
ù¾
, 
	`Ë32_to_ıup
(&
id
->
Â
));

2594 
dÚe
:

2595 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

2596 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2597 
	`kä“
(
id
);

2598 
	}
}

2600 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

2602 
nvme_ns
 *
ns
, *
Ãxt
;

2604 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
)

2605 
	`nvme_ns_»move
(
ns
);

2606 
	}
}

2608 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

2610 
	$nvme_£t_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2612 
š¡ªû
, 
”rÜ
;

2615 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

2616  -
ENODEV
;

2618 
	`¥š_lock
(&
dev_li¡_lock
);

2619 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

2620 
	`¥š_uÆock
(&
dev_li¡_lock
);

2621 } 
”rÜ
 =ğ-
EAGAIN
);

2623 ià(
”rÜ
)

2624  -
ENODEV
;

2626 
ù¾
->
š¡ªû
 = instance;

2628 
	}
}

2630 
	$nvme_»Ëa£_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2632 
	`¥š_lock
(&
dev_li¡_lock
);

2633 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

2634 
	`¥š_uÆock
(&
dev_li¡_lock
);

2635 
	}
}

2637 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

2639 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
));

2641 
	`¥š_lock
(&
dev_li¡_lock
);

2642 
	`li¡_d–
(&
ù¾
->
node
);

2643 
	`¥š_uÆock
(&
dev_li¡_lock
);

2644 
	}
}

2646 
	$nvme_ä“_ù¾
(
k»f
 *kref)

2648 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
k»f
, nvme_ctrl, kref);

2650 
	`put_deviû
(
ù¾
->
deviû
);

2651 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

2653 
ù¾
->
İs
->
	`ä“_ù¾
(ctrl);

2654 
	}
}

2656 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

2658 
	`k»f_put
(&
ù¾
->
k»f
, 
nvme_ä“_ù¾
);

2659 
	}
}

2666 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

2667 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
)

2669 
»t
;

2671 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

2672 
	`mu‹x_š™
(&
ù¾
->
Çme¥aûs_mu‹x
);

2673 
	`k»f_š™
(&
ù¾
->
k»f
);

2674 
ù¾
->
dev
 = dev;

2675 
ù¾
->
İs
 = ops;

2676 
ù¾
->
quœks
 = quirks;

2678 
»t
 = 
	`nvme_£t_š¡ªû
(
ù¾
);

2679 ià(
»t
)

2680 
out
;

2682 
ù¾
->
deviû
 = 
	`deviû_ü—‹_w™h_groups
(
nvme_şass
, cŒl->
dev
,

2683 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
),

2684 
dev
, 
nvme_dev_©Œ_groups
,

2685 "nvme%d", 
ù¾
->
š¡ªû
);

2686 ià(
	`IS_ERR
(
ù¾
->
deviû
)) {

2687 
»t
 = 
	`PTR_ERR
(
ù¾
->
deviû
);

2688 
out_»Ëa£_š¡ªû
;

2690 
	`g‘_deviû
(
ù¾
->
deviû
);

2691 
	`dev_£t_drvd©a
(
ù¾
->
deviû
, ctrl);

2693 
	`¥š_lock
(&
dev_li¡_lock
);

2694 
	`li¡_add_
(&
ù¾
->
node
, &
nvme_ù¾_li¡
);

2695 
	`¥š_uÆock
(&
dev_li¡_lock
);

2701 
ù¾
->
deviû
->
pow”
.
£t_Ï‹ncy_tŞ”ªû
 = 
nvme_£t_Ï‹ncy_tŞ”ªû
;

2702 
	`dev_pm_qos_upd©e_u£r_Ï‹ncy_tŞ”ªû
(
ù¾
->
deviû
,

2703 
	`mš
(
deçuÉ_ps_max_Ï‹ncy_us
, ()
S32_MAX
));

2706 
out_»Ëa£_š¡ªû
:

2707 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

2708 
out
:

2709  
»t
;

2710 
	}
}

2719 
	$nvme_kl_queues
(
nvme_ù¾
 *
ù¾
)

2721 
nvme_ns
 *
ns
;

2723 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2724 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2725 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

2732 ià(!
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &
ns
->
æags
))

2733 
	`»v®id©e_disk
(
ns
->
disk
);

2735 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

2736 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

2737 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

2739 
	`nvme_put_ns
(
ns
);

2741 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2742 
	}
}

2744 
	$nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
)

2746 
nvme_ns
 *
ns
;

2748 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2749 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2750 
	`¥š_lock_œq
(
ns
->
queue
->
queue_lock
);

2751 
	`queue_æag_£t
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

2752 
	`¥š_uÆock_œq
(
ns
->
queue
->
queue_lock
);

2754 
	`blk_mq_ÿnûl_»queue_wÜk
(
ns
->
queue
);

2755 
	`blk_mq_¡İ_hw_queues
(
ns
->
queue
);

2757 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2758 
	}
}

2760 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

2762 
nvme_ns
 *
ns
;

2764 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2765 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2766 
	`queue_æag_ş—r_uÆocked
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

2767 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

2768 
	`blk_mq_kick_»queue_li¡
(
ns
->
queue
);

2770 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2771 
	}
}

2773 
__š™
 
	$nvme_cÜe_š™
()

2775 
»suÉ
;

2777 
»suÉ
 = 
	`»gi¡”_blkdev
(
nvme_majÜ
, "nvme");

2778 ià(
»suÉ
 < 0)

2779  
»suÉ
;

2780 ià(
»suÉ
 > 0)

2781 
nvme_majÜ
 = 
»suÉ
;

2783 
»suÉ
 = 
	`__»gi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme",

2784 &
nvme_dev_fİs
);

2785 ià(
»suÉ
 < 0)

2786 
uÄegi¡”_blkdev
;

2787 ià(
»suÉ
 > 0)

2788 
nvme_ch¬_majÜ
 = 
»suÉ
;

2790 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

2791 ià(
	`IS_ERR
(
nvme_şass
)) {

2792 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

2793 
uÄegi¡”_chrdev
;

2796 
»suÉ
 = 
	`aio_£rviû_š™
();

2797 ià(
»suÉ
)

2798 
uÄegi¡”_chrdev
;

2800 
»suÉ
 = 
	`aio_wÜk”_š™
();

2801 ià(
»suÉ
)

2802 
uÄegi¡”_aio_£rviû
;

2806 
uÄegi¡”_aio_£rviû
:

2807 
	`aio_£rviû_ex™
();

2809 
uÄegi¡”_chrdev
:

2810 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

2811 
uÄegi¡”_blkdev
:

2812 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

2813  
»suÉ
;

2814 
	}
}

2816 
	$nvme_cÜe_ex™
()

2818 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

2819 
	`şass_de¡roy
(
nvme_şass
);

2820 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

2822 
	`aio_wÜk”_ex™
();

2823 
	`aio_£rviû_ex™
();

2825 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/lightnvm.c

23 
	~"nvme.h
"

25 
	~"lšux_nvme.h
"

27 
	~<lšux/nvme.h
>

29 
	~<lšux/b™İs.h
>

30 
	~<lšux/lighŠvm.h
>

31 
	~<lšux/vm®loc.h
>

33 
	envme_nvm_admš_İcode
 {

34 
	mnvme_nvm_admš_id’t™y
 = 0xe2,

35 
	mnvme_nvm_admš_g‘_l2p_tbl
 = 0xea,

36 
	mnvme_nvm_admš_g‘_bb_tbl
 = 0xf2,

37 
	mnvme_nvm_admš_£t_bb_tbl
 = 0xf1,

40 
	snvme_nvm_hb_rw
 {

41 
__u8
 
	mİcode
;

42 
__u8
 
	mæags
;

43 
__u16
 
	mcommªd_id
;

44 
__Ë32
 
	mnsid
;

45 
__u64
 
	mrsvd2
;

46 
__Ë64
 
	mm‘ad©a
;

47 
__Ë64
 
	m´p1
;

48 
__Ë64
 
	m´p2
;

49 
__Ë64
 
	m¥ba
;

50 
__Ë16
 
	mËngth
;

51 
__Ë16
 
	mcÚŒŞ
;

52 
__Ë32
 
	mdsmgmt
;

53 
__Ë64
 
	m¦ba
;

56 
	snvme_nvm_ph_rw
 {

57 
__u8
 
	mİcode
;

58 
__u8
 
	mæags
;

59 
__u16
 
	mcommªd_id
;

60 
__Ë32
 
	mnsid
;

61 
__u64
 
	mrsvd2
;

62 
__Ë64
 
	mm‘ad©a
;

63 
__Ë64
 
	m´p1
;

64 
__Ë64
 
	m´p2
;

65 
__Ë64
 
	m¥ba
;

66 
__Ë16
 
	mËngth
;

67 
__Ë16
 
	mcÚŒŞ
;

68 
__Ë32
 
	mdsmgmt
;

69 
__Ë64
 
	m»sv
;

72 
	snvme_nvm_id’t™y
 {

73 
__u8
 
	mİcode
;

74 
__u8
 
	mæags
;

75 
__u16
 
	mcommªd_id
;

76 
__Ë32
 
	mnsid
;

77 
__u64
 
	mrsvd
[2];

78 
__Ë64
 
	m´p1
;

79 
__Ë64
 
	m´p2
;

80 
__Ë32
 
	mchÆ_off
;

81 
__u32
 
	mrsvd11
[5];

84 
	snvme_nvm_l2±bl
 {

85 
__u8
 
	mİcode
;

86 
__u8
 
	mæags
;

87 
__u16
 
	mcommªd_id
;

88 
__Ë32
 
	mnsid
;

89 
__Ë32
 
	mcdw2
[4];

90 
__Ë64
 
	m´p1
;

91 
__Ë64
 
	m´p2
;

92 
__Ë64
 
	m¦ba
;

93 
__Ë32
 
	mÆb
;

94 
__Ë16
 
	mcdw14
[6];

97 
	snvme_nvm_g‘bbtbl
 {

98 
__u8
 
	mİcode
;

99 
__u8
 
	mæags
;

100 
__u16
 
	mcommªd_id
;

101 
__Ë32
 
	mnsid
;

102 
__u64
 
	mrsvd
[2];

103 
__Ë64
 
	m´p1
;

104 
__Ë64
 
	m´p2
;

105 
__Ë64
 
	m¥ba
;

106 
__u32
 
	mrsvd4
[4];

109 
	snvme_nvm_£tbbtbl
 {

110 
__u8
 
	mİcode
;

111 
__u8
 
	mæags
;

112 
__u16
 
	mcommªd_id
;

113 
__Ë32
 
	mnsid
;

114 
__Ë64
 
	mrsvd
[2];

115 
__Ë64
 
	m´p1
;

116 
__Ë64
 
	m´p2
;

117 
__Ë64
 
	m¥ba
;

118 
__Ë16
 
	mÆb
;

119 
__u8
 
	mv®ue
;

120 
__u8
 
	mrsvd3
;

121 
__u32
 
	mrsvd4
[3];

124 
	snvme_nvm_”a£_blk
 {

125 
__u8
 
	mİcode
;

126 
__u8
 
	mæags
;

127 
__u16
 
	mcommªd_id
;

128 
__Ë32
 
	mnsid
;

129 
__u64
 
	mrsvd
[2];

130 
__Ë64
 
	m´p1
;

131 
__Ë64
 
	m´p2
;

132 
__Ë64
 
	m¥ba
;

133 
__Ë16
 
	mËngth
;

134 
__Ë16
 
	mcÚŒŞ
;

135 
__Ë32
 
	mdsmgmt
;

136 
__Ë64
 
	m»sv
;

139 
	snvme_nvm_commªd
 {

141 
nvme_commÚ_commªd
 
	mcommÚ
;

142 
nvme_nvm_id’t™y
 
	mid’t™y
;

143 
nvme_nvm_hb_rw
 
	mhb_rw
;

144 
nvme_nvm_ph_rw
 
	mph_rw
;

145 
nvme_nvm_l2±bl
 
	ml2p
;

146 
nvme_nvm_g‘bbtbl
 
	mg‘_bb
;

147 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

148 
nvme_nvm_”a£_blk
 
	m”a£
;

152 
	snvme_nvm_Í_mlc
 {

153 
__u16
 
	mnum_·œs
;

154 
__u8
 
	m·œs
[886];

157 
	snvme_nvm_Í_tbl
 {

158 
__u8
 
	mid
[8];

159 
nvme_nvm_Í_mlc
 
	mmlc
;

162 
	snvme_nvm_id_group
 {

163 
__u8
 
	mmty³
;

164 
__u8
 
	mfmty³
;

165 
__Ë16
 
	m»s16
;

166 
__u8
 
	mnum_ch
;

167 
__u8
 
	mnum_lun
;

168 
__u8
 
	mnum_¶n
;

169 
__u8
 
	mrsvd1
;

170 
__Ë16
 
	mnum_blk
;

171 
__Ë16
 
	mnum_pg
;

172 
__Ë16
 
	måg_sz
;

173 
__Ë16
 
	mc£cs
;

174 
__Ë16
 
	msos
;

175 
__Ë16
 
	mrsvd2
;

176 
__Ë32
 
	mŒdt
;

177 
__Ë32
 
	mŒdm
;

178 
__Ë32
 
	m¹
;

179 
__Ë32
 
	mrm
;

180 
__Ë32
 
	mtb‘
;

181 
__Ë32
 
	mtbem
;

182 
__Ë32
 
	mmpos
;

183 
__Ë32
 
	mmcÿp
;

184 
__Ë16
 
	mı¬
;

185 
__u8
 
	m»£rved
[10];

186 
nvme_nvm_Í_tbl
 
	mÍtbl
;

187 } 
	g__·cked
;

189 
	snvme_nvm_addr_fÜm©
 {

190 
__u8
 
	mch_off£t
;

191 
__u8
 
	mch_Ën
;

192 
__u8
 
	mlun_off£t
;

193 
__u8
 
	mlun_Ën
;

194 
__u8
 
	m¶n_off£t
;

195 
__u8
 
	m¶n_Ën
;

196 
__u8
 
	mblk_off£t
;

197 
__u8
 
	mblk_Ën
;

198 
__u8
 
	mpg_off£t
;

199 
__u8
 
	mpg_Ën
;

200 
__u8
 
	m£ù_off£t
;

201 
__u8
 
	m£ù_Ën
;

202 
__u8
 
	m»s
[4];

203 } 
	g__·cked
;

205 
	snvme_nvm_id
 {

206 
__u8
 
	mv”_id
;

207 
__u8
 
	mvmÁ
;

208 
__u8
 
	mcg½s
;

209 
__u8
 
	m»s
;

210 
__Ë32
 
	mÿp
;

211 
__Ë32
 
	mdom
;

212 
nvme_nvm_addr_fÜm©
 
	mµaf
;

213 
__u8
 
	m»sv
[228];

214 
nvme_nvm_id_group
 
	mgroups
[4];

215 } 
	g__·cked
;

217 
	snvme_nvm_bb_tbl
 {

218 
__u8
 
	mtblid
[4];

219 
__Ë16
 
	mv”id
;

220 
__Ë16
 
	m»vid
;

221 
__Ë32
 
	mrvsd1
;

222 
__Ë32
 
	mtblks
;

223 
__Ë32
 
	mtçù
;

224 
__Ë32
 
	mtgrown
;

225 
__Ë32
 
	mtd»sv
;

226 
__Ë32
 
	mth»sv
;

227 
__Ë32
 
	mrsvd2
[8];

228 
__u8
 
	mblk
[0];

234 
šlše
 
	$_nvme_nvm_check_size
()

236 
	`BUILD_BUG_ON
((
nvme_nvm_id’t™y
) != 64);

237 
	`BUILD_BUG_ON
((
nvme_nvm_hb_rw
) != 64);

238 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

239 
	`BUILD_BUG_ON
((
nvme_nvm_g‘bbtbl
) != 64);

240 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

241 
	`BUILD_BUG_ON
((
nvme_nvm_l2±bl
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_nvm_”a£_blk
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_nvm_id_group
) != 960);

244 
	`BUILD_BUG_ON
((
nvme_nvm_addr_fÜm©
) != 128);

245 
	`BUILD_BUG_ON
((
nvme_nvm_id
) != 4096);

246 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 512);

247 
	}
}

249 
	$š™_g½s
(
nvm_id
 *nvm_id, 
nvme_nvm_id
 *nvme_nvm_id)

251 
nvme_nvm_id_group
 *
¤c
;

252 
nvm_id_group
 *
d¡
;

253 
i
, 
’d
;

255 
’d
 = 
	`mš_t
(
u32
, 4, 
nvm_id
->
cg½s
);

257 
i
 = 0; i < 
’d
; i++) {

258 
¤c
 = &
nvme_nvm_id
->
groups
[
i
];

259 
d¡
 = &
nvm_id
->
groups
[
i
];

261 
d¡
->
mty³
 = 
¤c
->mtype;

262 
d¡
->
fmty³
 = 
¤c
->fmtype;

263 
d¡
->
num_ch
 = 
¤c
->num_ch;

264 
d¡
->
num_lun
 = 
¤c
->num_lun;

265 
d¡
->
num_¶n
 = 
¤c
->num_pln;

267 
d¡
->
num_pg
 = 
	`Ë16_to_ıu
(
¤c
->num_pg);

268 
d¡
->
num_blk
 = 
	`Ë16_to_ıu
(
¤c
->num_blk);

269 
d¡
->
åg_sz
 = 
	`Ë16_to_ıu
(
¤c
->fpg_sz);

270 
d¡
->
c£cs
 = 
	`Ë16_to_ıu
(
¤c
->csecs);

271 
d¡
->
sos
 = 
	`Ë16_to_ıu
(
¤c
->sos);

273 
d¡
->
Œdt
 = 
	`Ë32_to_ıu
(
¤c
->trdt);

274 
d¡
->
Œdm
 = 
	`Ë32_to_ıu
(
¤c
->trdm);

275 
d¡
->
¹
 = 
	`Ë32_to_ıu
(
¤c
->tprt);

276 
d¡
->
rm
 = 
	`Ë32_to_ıu
(
¤c
->tprm);

277 
d¡
->
tb‘
 = 
	`Ë32_to_ıu
(
¤c
->tbet);

278 
d¡
->
tbem
 = 
	`Ë32_to_ıu
(
¤c
->tbem);

279 
d¡
->
mpos
 = 
	`Ë32_to_ıu
(
¤c
->mpos);

280 
d¡
->
mcÿp
 = 
	`Ë32_to_ıu
(
¤c
->mccap);

282 
d¡
->
ı¬
 = 
	`Ë16_to_ıu
(
¤c
->cpar);

284 ià(
d¡
->
fmty³
 =ğ
NVM_ID_FMTYPE_MLC
) {

285 
	`memıy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

286 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

287 
	`Ë16_to_ıu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

289 
	`memıy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

290 
d¡
->
Ítbl
.
mlc
.
num_·œs
 >> 1);

295 
	}
}

297 
	$nvme_nvm_id’t™y
(
nvm_dev
 *
nvmdev
, 
nvm_id
 *nvm_id)

299 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

300 
nvme_nvm_id
 *nvme_nvm_id;

301 
nvme_nvm_commªd
 
c
 = {};

302 
»t
;

304 
c
.
id’t™y
.
İcode
 = 
nvme_nvm_admš_id’t™y
;

305 
c
.
id’t™y
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

306 
c
.
id’t™y
.
chÆ_off
 = 0;

308 
nvme_nvm_id
 = 
	`km®loc
((nvme_nvm_id), 
GFP_KERNEL
);

309 ià(!
nvme_nvm_id
)

310  -
ENOMEM
;

312 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

313 
nvme_nvm_id
, (nvme_nvm_id));

314 ià(
»t
) {

315 
»t
 = -
EIO
;

316 
out
;

319 
nvm_id
->
v”_id
 = 
nvme_nvm_id
->ver_id;

320 
nvm_id
->
vmÁ
 = 
nvme_nvm_id
->vmnt;

321 
nvm_id
->
cg½s
 = 
nvme_nvm_id
->cgrps;

322 
nvm_id
->
ÿp
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->cap);

323 
nvm_id
->
dom
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->dom);

324 
	`memıy
(&
nvm_id
->
µaf
, &
nvme_nvm_id
->ppaf,

325 (
nvme_nvm_addr_fÜm©
));

327 
»t
 = 
	`š™_g½s
(
nvm_id
, 
nvme_nvm_id
);

328 
out
:

329 
	`kä“
(
nvme_nvm_id
);

330  
»t
;

331 
	}
}

333 
	$nvme_nvm_g‘_l2p_tbl
(
nvm_dev
 *
nvmdev
, 
u64
 
¦ba
, 
u32
 
Æb
,

334 
nvm_l2p_upd©e_â
 *
upd©e_l2p
, *
´iv
)

336 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

337 
nvme_nvm_commªd
 
c
 = {};

338 
u32
 
Ën
 = 
	`queue_max_hw_£ùÜs
(
ns
->
ù¾
->
admš_q
) << 9;

339 
u32
 
Æb_´_rq
 = 
Ën
 / (
u64
);

340 
u64
 
cmd_¦ba
 = 
¦ba
;

341 *
’Œ›s
;

342 
»t
 = 0;

344 
c
.
l2p
.
İcode
 = 
nvme_nvm_admš_g‘_l2p_tbl
;

345 
c
.
l2p
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

346 
’Œ›s
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

347 ià(!
’Œ›s
)

348  -
ENOMEM
;

350 
Æb
) {

351 
u32
 
cmd_Æb
 = 
	`mš
(
Æb_´_rq
, 
Æb
);

353 
c
.
l2p
.
¦ba
 = 
	`ıu_to_Ë64
(
cmd_¦ba
);

354 
c
.
l2p
.
Æb
 = 
	`ıu_to_Ë32
(
cmd_Æb
);

356 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
,

357 (
nvme_commªd
 *)&
c
, 
’Œ›s
, 
Ën
);

358 ià(
»t
) {

359 
	`dev_”r
(
ns
->
ù¾
->
dev
, "L2Pableransfer failed (%d)\n",

360 
»t
);

361 
»t
 = -
EIO
;

362 
out
;

365 ià(
	`upd©e_l2p
(
cmd_¦ba
, 
cmd_Æb
, 
’Œ›s
, 
´iv
)) {

366 
»t
 = -
EINTR
;

367 
out
;

370 
cmd_¦ba
 +ğ
cmd_Æb
;

371 
Æb
 -ğ
cmd_Æb
;

374 
out
:

375 
	`kä“
(
’Œ›s
);

376  
»t
;

377 
	}
}

379 
	$nvme_nvm_g‘_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

380 
Ä_blocks
, 
nvm_bb_upd©e_â
 *
upd©e_bbtbl
,

381 *
´iv
)

383 
»que¡_queue
 *
q
 = 
nvmdev
->q;

384 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

385 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

386 
nvme_nvm_commªd
 
c
 = {};

387 
nvme_nvm_bb_tbl
 *
bb_tbl
;

388 
tblsz
 = (
nvme_nvm_bb_tbl
è+ 
Ä_blocks
;

389 
»t
 = 0;

391 
c
.
g‘_bb
.
İcode
 = 
nvme_nvm_admš_g‘_bb_tbl
;

392 
c
.
g‘_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

393 
c
.
g‘_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µa
.ppa);

395 
bb_tbl
 = 
	`kz®loc
(
tblsz
, 
GFP_KERNEL
);

396 ià(!
bb_tbl
)

397  -
ENOMEM
;

399 
»t
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

400 
bb_tbl
, 
tblsz
);

401 ià(
»t
) {

402 
	`dev_”r
(
ù¾
->
dev
, "g‘ bad blockabË faed (%d)\n", 
»t
);

403 
»t
 = -
EIO
;

404 
out
;

407 ià(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

408 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

409 
	`dev_”r
(
ù¾
->
dev
, "bbt format mismatch\n");

410 
»t
 = -
EINVAL
;

411 
out
;

414 ià(
	`Ë16_to_ıu
(
bb_tbl
->
v”id
) != 1) {

415 
»t
 = -
EINVAL
;

416 
	`dev_”r
(
ù¾
->
dev
, "bbt version‚ot supported\n");

417 
out
;

420 ià(
	`Ë32_to_ıu
(
bb_tbl
->
tblks
è!ğ
Ä_blocks
) {

421 
»t
 = -
EINVAL
;

422 
	`dev_”r
(
ù¾
->
dev
, "bbt unsuspected blocks„eturned (%u!=%u)",

423 
	`Ë32_to_ıu
(
bb_tbl
->
tblks
), 
Ä_blocks
);

424 
out
;

427 
µa
 = 
	`dev_to_g’”ic_addr
(
nvmdev
,…pa);

428 
»t
 = 
	`upd©e_bbtbl
(
µa
, 
Ä_blocks
, 
bb_tbl
->
blk
, 
´iv
);

429 
out
:

430 
	`kä“
(
bb_tbl
);

431  
»t
;

432 
	}
}

434 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
nvm_rq
 *
rqd
,

435 
ty³
)

437 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

438 
nvme_nvm_commªd
 
c
 = {};

439 
»t
 = 0;

441 
c
.
£t_bb
.
İcode
 = 
nvme_nvm_admš_£t_bb_tbl
;

442 
c
.
£t_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

443 
c
.
£t_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

444 
c
.
£t_bb
.
Æb
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_·ges
 - 1);

445 
c
.
£t_bb
.
v®ue
 = 
ty³
;

447 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

448 
NULL
, 0);

449 ià(
»t
)

450 
	`dev_”r
(
ns
->
ù¾
->
dev
, "£ˆbad blockabË faed (%d)\n", 
»t
);

451  
»t
;

452 
	}
}

454 
šlše
 
	$nvme_nvm_rqtocmd
(
»que¡
 *
rq
, 
nvm_rq
 *
rqd
,

455 
nvme_ns
 *
ns
, 
nvme_nvm_commªd
 *
c
)

457 
c
->
ph_rw
.
İcode
 = 
rqd
->opcode;

458 
c
->
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

459 
c
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

460 
c
->
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
rqd
->
æags
);

461 
c
->
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_·ges
 - 1);

463 ià(
rqd
->
İcode
 =ğ
NVM_OP_HBWRITE
 ||„qd->İcod=ğ
NVM_OP_HBREAD
)

464 
c
->
hb_rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
,

465 
rqd
->
bio
->
bi_™”
.
bi_£ùÜ
));

466 
	}
}

468 
	$nvme_nvm_’d_io
(
»que¡
 *
rq
, 
”rÜ
)

470 
nvm_rq
 *
rqd
 = 
rq
->
’d_io_d©a
;

472 
	`nvm_’d_io
(
rqd
, 
”rÜ
);

474 
	`kä“
(
rq
->
cmd
);

475 
	`blk_mq_ä“_»que¡
(
rq
);

476 
	}
}

478 
	$nvme_nvm_subm™_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

480 
»que¡_queue
 *
q
 = 
dev
->q;

481 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

482 
»que¡
 *
rq
;

483 
bio
 *biØğ
rqd
->bio;

484 
nvme_nvm_commªd
 *
cmd
;

486 
rq
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`bio_rw
(
bio
), 0);

487 ià(
	`IS_ERR
(
rq
))

488  -
ENOMEM
;

490 
cmd
 = 
	`kz®loc
((
nvme_nvm_commªd
), 
GFP_KERNEL
);

491 ià(!
cmd
) {

492 
	`blk_mq_ä“_»que¡
(
rq
);

493  -
ENOMEM
;

496 
rq
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

497 
rq
->
iİrio
 = 
	`bio_´io
(
bio
);

499 ià(
	`bio_has_d©a
(
bio
))

500 
rq
->
Ä_phys_£gm’ts
 = 
	`bio_phys_£gm’ts
(
q
, 
bio
);

502 
rq
->
__d©a_Ën
 = 
bio
->
bi_™”
.
bi_size
;

503 
rq
->
bio
 =„q->
biÙa
 = bio;

505 
	`nvme_nvm_rqtocmd
(
rq
, 
rqd
, 
ns
, 
cmd
);

507 
rq
->
cmd
 = (*)cmd;

508 
rq
->
cmd_Ën
 = (
nvme_nvm_commªd
);

509 
rq
->
¥ecŸl
 = (*)0;

511 
rq
->
’d_io_d©a
 = 
rqd
;

513 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_’d_io
);

516 
	}
}

518 
	$nvme_nvm_”a£_block
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

520 
»que¡_queue
 *
q
 = 
dev
->q;

521 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

522 
nvme_nvm_commªd
 
c
 = {};

524 
c
.
”a£
.
İcode
 = 
NVM_OP_ERASE
;

525 
c
.
”a£
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

526 
c
.
”a£
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

527 
c
.
”a£
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_·ges
 - 1);

529  
	`nvme_subm™_sync_cmd
(
q
, (
nvme_commªd
 *)&
c
, 
NULL
, 0);

530 
	}
}

532 *
	$nvme_nvm_ü—‹_dma_poŞ
(
nvm_dev
 *
nvmdev
, *
Çme
)

534 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

536  
	`dma_poŞ_ü—‹
(
Çme
, 
ns
->
ù¾
->
dev
, 
PAGE_SIZE
, PAGE_SIZE, 0);

537 
	}
}

539 
	$nvme_nvm_de¡roy_dma_poŞ
(*
poŞ
)

541 
dma_poŞ
 *dma_poŞ = 
poŞ
;

543 
	`dma_poŞ_de¡roy
(
dma_poŞ
);

544 
	}
}

546 *
	$nvme_nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, *
poŞ
,

547 
gå_t
 
mem_æags
, 
dma_addr_t
 *
dma_hªdËr
)

549  
	`dma_poŞ_®loc
(
poŞ
, 
mem_æags
, 
dma_hªdËr
);

550 
	}
}

552 
	$nvme_nvm_dev_dma_ä“
(*
poŞ
, *
µa_li¡
,

553 
dma_addr_t
 
dma_hªdËr
)

555 
	`dma_poŞ_ä“
(
poŞ
, 
µa_li¡
, 
dma_hªdËr
);

556 
	}
}

558 
nvm_dev_İs
 
	gnvme_nvm_dev_İs
 = {

559 .
id’t™y
 = 
nvme_nvm_id’t™y
,

561 .
	gg‘_l2p_tbl
 = 
nvme_nvm_g‘_l2p_tbl
,

563 .
	gg‘_bb_tbl
 = 
nvme_nvm_g‘_bb_tbl
,

564 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

566 .
	gsubm™_io
 = 
nvme_nvm_subm™_io
,

567 .
	g”a£_block
 = 
nvme_nvm_”a£_block
,

569 .
	gü—‹_dma_poŞ
 = 
nvme_nvm_ü—‹_dma_poŞ
,

570 .
	gde¡roy_dma_poŞ
 = 
nvme_nvm_de¡roy_dma_poŞ
,

571 .
	gdev_dma_®loc
 = 
nvme_nvm_dev_dma_®loc
,

572 .
	gdev_dma_ä“
 = 
nvme_nvm_dev_dma_ä“
,

574 .
	gmax_phys_£ù
 = 64,

577 
	$nvme_nvm_»gi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
)

579  
	`nvm_»gi¡”
(
q
, 
disk_Çme
, &
nvme_nvm_dev_İs
);

580 
	}
}

582 
	$nvme_nvm_uÄegi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
)

584 
	`nvm_uÄegi¡”
(
disk_Çme
);

585 
	}
}

588 
	#PCI_VENDOR_ID_CNEX
 0x1d1d

	)

589 
	#PCI_DEVICE_ID_CNEX_WL
 0x2807

	)

590 
	#PCI_DEVICE_ID_CNEX_QEMU
 0x1f1f

	)

592 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

594 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

596 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
ù¾
->
dev
);

599 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

600 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_QEMU
 &&

601 
id
->
vs
[0] == 0x1)

605 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

606 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_WL
 &&

607 
id
->
vs
[0] == 0x1)

611 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/linux_nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/uuid.h
>

22 
	#NVMF_NQN_FIELD_LEN
 256

	)

25 
	#NVMF_NQN_SIZE
 223

	)

27 
	#NVMF_TRSVCID_SIZE
 32

	)

28 
	#NVMF_TRADDR_SIZE
 256

	)

29 
	#NVMF_TSAS_SIZE
 256

	)

31 
	#NVME_DISC_SUBSYS_NAME
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

33 
	#NVME_RDMA_IP_PORT
 4420

	)

35 
	envme_subsys_ty³
 {

36 
	mNVME_NQN_DISC
 = 1,

37 
	mNVME_NQN_NVME
 = 2,

42 
	mNVMF_ADDR_FAMILY_PCI
 = 0,

43 
	mNVMF_ADDR_FAMILY_IP4
 = 1,

44 
	mNVMF_ADDR_FAMILY_IP6
 = 2,

45 
	mNVMF_ADDR_FAMILY_IB
 = 3,

46 
	mNVMF_ADDR_FAMILY_FC
 = 4,

51 
	mNVMF_TRTYPE_RDMA
 = 1,

52 
	mNVMF_TRTYPE_FC
 = 2,

53 
	mNVMF_TRTYPE_LOOP
 = 254,

54 
	mNVMF_TRTYPE_MAX
,

59 
	mNVMF_TREQ_NOT_SPECIFIED
 = 0,

60 
	mNVMF_TREQ_REQUIRED
 = 1,

61 
	mNVMF_TREQ_NOT_REQUIRED
 = 2,

68 
	mNVMF_RDMA_QPTYPE_CONNECTED
 = 0,

69 
	mNVMF_RDMA_QPTYPE_DATAGRAM
 = 1,

76 
	mNVMF_RDMA_PRTYPE_NOT_SPECIFIED
 = 0,

77 
	mNVMF_RDMA_PRTYPE_IB
 = 1,

78 
	mNVMF_RDMA_PRTYPE_ROCE
 = 2,

79 
	mNVMF_RDMA_PRTYPE_ROCEV2
 = 3,

80 
	mNVMF_RDMA_PRTYPE_IWARP
 = 4,

87 
	mNVMF_RDMA_CMS_RDMA_CM
 = 0,

90 
	#NVMF_AQ_DEPTH
 32

	)

93 
	mNVME_REG_CAP
 = 0x0000,

94 
	mNVME_REG_VS
 = 0x0008,

95 
	mNVME_REG_INTMS
 = 0x000c,

96 
	mNVME_REG_INTMC
 = 0x0010,

97 
	mNVME_REG_CC
 = 0x0014,

98 
	mNVME_REG_CSTS
 = 0x001c,

99 
	mNVME_REG_NSSR
 = 0x0020,

100 
	mNVME_REG_AQA
 = 0x0024,

101 
	mNVME_REG_ASQ
 = 0x0028,

102 
	mNVME_REG_ACQ
 = 0x0030,

103 
	mNVME_REG_CMBLOC
 = 0x0038,

104 
	mNVME_REG_CMBSZ
 = 0x003c,

107 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

108 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

109 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

110 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

111 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

112 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

114 
	#NVME_CMB_BIR
(
cmbloc
è((cmblocè& 0x7)

	)

115 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

116 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

117 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

119 
	#NVME_CMB_WDS
(
cmbsz
è((cmbszè& 0x10)

	)

120 
	#NVME_CMB_RDS
(
cmbsz
è((cmbszè& 0x8)

	)

121 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbszè& 0x4)

	)

122 
	#NVME_CMB_CQS
(
cmbsz
è((cmbszè& 0x2)

	)

123 
	#NVME_CMB_SQS
(
cmbsz
è((cmbszè& 0x1)

	)

126 
	mNVME_CC_ENABLE
 = 1 << 0,

127 
	mNVME_CC_CSS_NVM
 = 0 << 4,

128 
	mNVME_CC_MPS_SHIFT
 = 7,

129 
	mNVME_CC_ARB_RR
 = 0 << 11,

130 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

131 
	mNVME_CC_ARB_VS
 = 7 << 11,

132 
	mNVME_CC_SHN_NONE
 = 0 << 14,

133 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

134 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

135 
	mNVME_CC_SHN_MASK
 = 3 << 14,

136 
	mNVME_CC_IOSQES
 = 6 << 16,

137 
	mNVME_CC_IOCQES
 = 4 << 20,

138 
	mNVME_CSTS_RDY
 = 1 << 0,

139 
	mNVME_CSTS_CFS
 = 1 << 1,

140 
	mNVME_CSTS_NSSRO
 = 1 << 4,

141 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

142 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

143 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

144 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

147 
	snvme_id_pow”_¡©e
 {

148 
__Ë16
 
	mmax_pow”
;

149 
__u8
 
	mrsvd2
;

150 
__u8
 
	mæags
;

151 
__Ë32
 
	m’Œy_Ït
;

152 
__Ë32
 
	mex™_Ït
;

153 
__u8
 
	m»ad_ut
;

154 
__u8
 
	m»ad_Ït
;

155 
__u8
 
	mwr™e_ut
;

156 
__u8
 
	mwr™e_Ït
;

157 
__Ë16
 
	midË_pow”
;

158 
__u8
 
	midË_sÿË
;

159 
__u8
 
	mrsvd19
;

160 
__Ë16
 
	maùive_pow”
;

161 
__u8
 
	maùive_wÜk_sÿË
;

162 
__u8
 
	mrsvd23
[9];

166 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

167 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

170 
	snvme_id_ù¾
 {

171 
__Ë16
 
	mvid
;

172 
__Ë16
 
	mssvid
;

173 
	m¢
[20];

174 
	mmn
[40];

175 
	mä
[8];

176 
__u8
 
	m¿b
;

177 
__u8
 
	m›“
[3];

178 
__u8
 
	mmic
;

179 
__u8
 
	mmdts
;

180 
__Ë16
 
	múid
;

181 
__Ë32
 
	mv”
;

182 
__Ë32
 
	m¹d3r
;

183 
__Ë32
 
	m¹d3e
;

184 
__Ë32
 
	mßes
;

185 
__Ë32
 
	mù¿‰
;

186 
__u8
 
	mrsvd100
[156];

187 
__Ë16
 
	mßcs
;

188 
__u8
 
	maş
;

189 
__u8
 
	m«¾
;

190 
__u8
 
	mämw
;

191 
__u8
 
	mÍa
;

192 
__u8
 
	m–³
;

193 
__u8
 
	mÅss
;

194 
__u8
 
	mavscc
;

195 
__u8
 
	m­¡a
;

196 
__Ë16
 
	mwùemp
;

197 
__Ë16
 
	mcùemp
;

198 
__u8
 
	mrsvd270
[242];

199 
__u8
 
	msqes
;

200 
__u8
 
	mcqes
;

201 
__Ë16
 
	mmaxcmd
;

202 
__Ë32
 
	mÂ
;

203 
__Ë16
 
	mÚcs
;

204 
__Ë16
 
	mfu£s
;

205 
__u8
 
	mâa
;

206 
__u8
 
	mvwc
;

207 
__Ë16
 
	mawun
;

208 
__Ë16
 
	mawupf
;

209 
__u8
 
	mnvscc
;

210 
__u8
 
	mrsvd531
;

211 
__Ë16
 
	macwu
;

212 
__u8
 
	mrsvd534
[2];

213 
__Ë32
 
	msgls
;

214 
__u8
 
	mrsvd540
[228];

215 
	msubnqn
[256];

216 
__u8
 
	mrsvd1024
[768];

217 
__Ë32
 
	mioccsz
;

218 
__Ë32
 
	miÜcsz
;

219 
__Ë16
 
	micdoff
;

220 
__u8
 
	mù¿‰r
;

221 
__u8
 
	mmsdbd
;

222 
__u8
 
	mrsvd1804
[244];

223 
nvme_id_pow”_¡©e
 
	mpsd
[32];

224 
__u8
 
	mvs
[1024];

228 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

229 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

230 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

231 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

234 
	snvme_lbaf
 {

235 
__Ë16
 
	mms
;

236 
__u8
 
	mds
;

237 
__u8
 
	m½
;

240 
	snvme_id_ns
 {

241 
__Ë64
 
	mnsze
;

242 
__Ë64
 
	mnÿp
;

243 
__Ë64
 
	mnu£
;

244 
__u8
 
	mnsã©
;

245 
__u8
 
	mÆbaf
;

246 
__u8
 
	mæbas
;

247 
__u8
 
	mmc
;

248 
__u8
 
	mdpc
;

249 
__u8
 
	mdps
;

250 
__u8
 
	mnmic
;

251 
__u8
 
	m»sÿp
;

252 
__u8
 
	måi
;

253 
__u8
 
	mrsvd33
;

254 
__Ë16
 
	mÇwun
;

255 
__Ë16
 
	mÇwupf
;

256 
__Ë16
 
	mÇcwu
;

257 
__Ë16
 
	mÇb¢
;

258 
__Ë16
 
	mÇbo
;

259 
__Ë16
 
	mÇb¥f
;

260 
__u16
 
	mrsvd46
;

261 
__Ë64
 
	mnvmÿp
[2];

262 
__u8
 
	mrsvd64
[40];

263 
__u8
 
	mnguid
[16];

264 
__u8
 
	meui64
[8];

265 
nvme_lbaf
 
	mlbaf
[16];

266 
__u8
 
	mrsvd192
[192];

267 
__u8
 
	mvs
[3712];

271 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

272 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

273 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

274 
	mNVME_LBAF_RP_BEST
 = 0,

275 
	mNVME_LBAF_RP_BETTER
 = 1,

276 
	mNVME_LBAF_RP_GOOD
 = 2,

277 
	mNVME_LBAF_RP_DEGRADED
 = 3,

278 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

279 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

280 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

281 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

282 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

283 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

284 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

285 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

286 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

287 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

290 
	snvme_sm¬t_log
 {

291 
__u8
 
	mü™iÿl_w¬nšg
;

292 
__u8
 
	m‹m³¿tu»
[2];

293 
__u8
 
	mava_¥¬e
;

294 
__u8
 
	m¥¬e_th»sh
;

295 
__u8
 
	m³rûÁ_u£d
;

296 
__u8
 
	mrsvd6
[26];

297 
__u8
 
	md©a_un™s_»ad
[16];

298 
__u8
 
	md©a_un™s_wr™‹n
[16];

299 
__u8
 
	mho¡_»ads
[16];

300 
__u8
 
	mho¡_wr™es
[16];

301 
__u8
 
	mù¾_busy_time
[16];

302 
__u8
 
	mpow”_cyşes
[16];

303 
__u8
 
	mpow”_Ú_hours
[16];

304 
__u8
 
	mun§ã_shutdowns
[16];

305 
__u8
 
	mmedŸ_”rÜs
[16];

306 
__u8
 
	mnum_”r_log_’Œ›s
[16];

307 
__Ë32
 
	mw¬nšg_‹mp_time
;

308 
__Ë32
 
	mü™iÿl_comp_time
;

309 
__Ë16
 
	m‹mp_£nsÜ
[8];

310 
__u8
 
	mrsvd216
[296];

314 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

315 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

316 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

317 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

318 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

322 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

325 
	snvme_lba_¿nge_ty³
 {

326 
__u8
 
	mty³
;

327 
__u8
 
	m©Œibu‹s
;

328 
__u8
 
	mrsvd2
[14];

329 
__u64
 
	m¦ba
;

330 
__u64
 
	mÆb
;

331 
__u8
 
	mguid
[16];

332 
__u8
 
	mrsvd48
[16];

336 
	mNVME_LBART_TYPE_FS
 = 0x01,

337 
	mNVME_LBART_TYPE_RAID
 = 0x02,

338 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

339 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

341 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

342 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

345 
	snvme_»£rv©iÚ_¡©us
 {

346 
__Ë32
 
	mg’
;

347 
__u8
 
	m¹y³
;

348 
__u8
 
	m»gùl
[2];

349 
__u8
 
	m»sv5
[2];

350 
__u8
 
	m±¶s
;

351 
__u8
 
	m»sv10
[13];

353 
__Ë16
 
	múid
;

354 
__u8
 
	mrc¡s
;

355 
__u8
 
	m»sv3
[5];

356 
__Ë64
 
	mho¡id
;

357 
__Ë64
 
	mrkey
;

358 } 
	m»gùl_ds
[];

363 
	envme_İcode
 {

364 
	mnvme_cmd_æush
 = 0x00,

365 
	mnvme_cmd_wr™e
 = 0x01,

366 
	mnvme_cmd_»ad
 = 0x02,

367 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

368 
	mnvme_cmd_com·»
 = 0x05,

369 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

370 
	mnvme_cmd_dsm
 = 0x09,

371 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

372 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

373 
	mnvme_cmd_»sv_acquœe
 = 0x11,

374 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

376 
	mnvme_cmd_kv_¡Üe
 = 0x81,

377 
	mnvme_cmd_kv_­³nd
 = 0x83,

378 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

379 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

380 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

381 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

382 
	mnvme_cmd_kv_exi¡
 = 0xB3,

386 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

387 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

388 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

400 
	mNVME_SGL_FMT_ADDRESS
 = 0x00,

401 
	mNVME_SGL_FMT_OFFSET
 = 0x01,

402 
	mNVME_SGL_FMT_INVALIDATE
 = 0x0f,

417 
	mNVME_SGL_FMT_DATA_DESC
 = 0x00,

418 
	mNVME_SGL_FMT_SEG_DESC
 = 0x02,

419 
	mNVME_SGL_FMT_LAST_SEG_DESC
 = 0x03,

420 
	mNVME_KEY_SGL_FMT_DATA_DESC
 = 0x04,

423 
	snvme_sgl_desc
 {

424 
__Ë64
 
	maddr
;

425 
__Ë32
 
	mËngth
;

426 
__u8
 
	mrsvd
[3];

427 
__u8
 
	mty³
;

430 
	snvme_keyed_sgl_desc
 {

431 
__Ë64
 
	maddr
;

432 
__u8
 
	mËngth
[3];

433 
__u8
 
	mkey
[4];

434 
__u8
 
	mty³
;

437 
	unvme_d©a_±r
 {

439 
__Ë64
 
	m´p1
;

440 
__Ë64
 
	m´p2
;

442 
nvme_sgl_desc
 
	msgl
;

443 
nvme_keyed_sgl_desc
 
	mksgl
;

461 
	mNVME_CMD_FUSE_FIRST
 = (1 << 0),

462 
	mNVME_CMD_FUSE_SECOND
 = (1 << 1),

464 
	mNVME_CMD_SGL_METABUF
 = (1 << 6),

465 
	mNVME_CMD_SGL_METASEG
 = (1 << 7),

466 
	mNVME_CMD_SGL_ALL
 = 
NVME_CMD_SGL_METABUF
 | 
NVME_CMD_SGL_METASEG
,

469 
	snvme_commÚ_commªd
 {

470 
__u8
 
	mİcode
;

471 
__u8
 
	mæags
;

472 
__u16
 
	mcommªd_id
;

473 
__Ë32
 
	mnsid
;

474 
__Ë32
 
	mcdw2
[2];

475 
__Ë64
 
	mm‘ad©a
;

476 
nvme_d©a_±r
 
	md±r
;

477 
__Ë32
 
	mcdw10
[6];

480 
	snvme_rw_commªd
 {

481 
__u8
 
	mİcode
;

482 
__u8
 
	mæags
;

483 
__u16
 
	mcommªd_id
;

484 
__Ë32
 
	mnsid
;

485 
__u64
 
	mrsvd2
;

486 
__Ë64
 
	mm‘ad©a
;

487 
nvme_d©a_±r
 
	md±r
;

488 
__Ë64
 
	m¦ba
;

489 
__Ë16
 
	mËngth
;

490 
__Ë16
 
	mcÚŒŞ
;

491 
__Ë32
 
	mdsmgmt
;

492 
__Ë32
 
	m»áag
;

493 
__Ë16
 
	m­±ag
;

494 
__Ë16
 
	m­pmask
;

498 
	mNVME_RW_LR
 = 1 << 15,

499 
	mNVME_RW_FUA
 = 1 << 14,

500 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

501 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

502 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

503 
	mNVME_RW_DSM_FREQ_READS
 = 3,

504 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

505 
	mNVME_RW_DSM_FREQ_RW
 = 5,

506 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

507 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

508 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

509 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

510 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

511 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

512 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

513 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

514 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

515 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

516 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

517 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

518 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

521 
	snvme_dsm_cmd
 {

522 
__u8
 
	mİcode
;

523 
__u8
 
	mæags
;

524 
__u16
 
	mcommªd_id
;

525 
__Ë32
 
	mnsid
;

526 
__u64
 
	mrsvd2
[2];

527 
nvme_d©a_±r
 
	md±r
;

528 
__Ë32
 
	mÄ
;

529 
__Ë32
 
	m©Œibu‹s
;

530 
__u32
 
	mrsvd12
[4];

534 
	mNVME_DSMGMT_IDR
 = 1 << 0,

535 
	mNVME_DSMGMT_IDW
 = 1 << 1,

536 
	mNVME_DSMGMT_AD
 = 1 << 2,

539 
	snvme_dsm_¿nge
 {

540 
__Ë32
 
	mÿ‰r
;

541 
__Ë32
 
	mÆb
;

542 
__Ë64
 
	m¦ba
;

547 
	snvme_ã©_auto_p¡
 {

548 
__Ë64
 
	m’Œ›s
[32];

552 
	snvme_kv_¡Üe_commªd
 {

553 
__u8
 
	mİcode
;

554 
__u8
 
	mæags
;

555 
__u16
 
	mcommªd_id
;

556 
__Ë32
 
	mnsid
;

557 
__u64
 
	mrsvd
;

558 
__Ë32
 
	moff£t
;

559 
__u32
 
	mrsvd2
;

560 
nvme_d©a_±r
 
	md±r
;

561 
__Ë32
 
	mv®ue_Ën
;

562 
__u8
 
	mkey_Ën
;

563 
__u8
 
	mİtiÚ
;

564 
__u8
 
	mšv®id_by‹
:2;

565 
__u8
 
	mrsvd3
:6;

566 
__u8
 
	mrsvd4
;

569 
	mkey
[16];

572 
__Ë64
 
	mkey_´p
;

573 
__Ë64
 
	mkey_´p2
;

578 
	snvme_kv_­³nd_commªd
 {

579 
__u8
 
	mİcode
;

580 
__u8
 
	mæags
;

581 
__u16
 
	mcommªd_id
;

582 
__Ë32
 
	mnsid
;

583 
__u64
 
	mrsvd
;

584 
__Ë32
 
	moff£t
;

585 
__u32
 
	mrsvd2
;

586 
nvme_d©a_±r
 
	md±r
;

587 
__Ë32
 
	mv®ue_Ën
;

588 
__u8
 
	mkey_Ën
;

589 
__u8
 
	mİtiÚ
;

590 
__u8
 
	mšv®id_by‹
:2;

591 
__u8
 
	mrsvd3
:6;

592 
__u8
 
	mrsvd4
;

595 
	mkey
[16];

598 
__Ë64
 
	mkey_´p
;

599 
__Ë64
 
	mkey_´p2
;

604 
	snvme_kv_»Œ›ve_commªd
 {

605 
__u8
 
	mİcode
;

606 
__u8
 
	mæags
;

607 
__u16
 
	mcommªd_id
;

608 
__Ë32
 
	mnsid
;

609 
__u64
 
	mrsvd
;

610 
__Ë32
 
	moff£t
;

611 
__u32
 
	mrsvd2
;

612 
nvme_d©a_±r
 
	md±r
;

613 
__Ë32
 
	mv®ue_Ën
;

614 
__u8
 
	mkey_Ën
;

615 
__u8
 
	mİtiÚ
;

616 
__u16
 
	mrsvd3
;

619 
	mkey
[16];

622 
__Ë64
 
	mkey_´p
;

623 
__Ë64
 
	mkey_´p2
;

628 
	snvme_kv_d–‘e_commªd
 {

629 
__u8
 
	mİcode
;

630 
__u8
 
	mæags
;

631 
__u16
 
	mcommªd_id
;

632 
__Ë32
 
	mnsid
;

633 
__u64
 
	mrsvd
;

634 
__Ë32
 
	moff£t
;

635 
__u32
 
	mrsvd2
;

636 
__u64
 
	mrsvd3
[2];

637 
__Ë32
 
	mv®ue_Ën
;

638 
__u8
 
	mkey_Ën
;

639 
__u8
 
	mİtiÚ
;

640 
__u16
 
	mrsvd4
;

643 
	mkey
[16];

646 
__Ë64
 
	mkey_´p
;

647 
__Ë64
 
	mkey_´p2
;

652 
	snvme_kv_™”_»q_commªd
 {

653 
__u8
 
	mİcode
;

654 
__u8
 
	mæags
;

655 
__u16
 
	mcommªd_id
;

656 
__Ë32
 
	mnsid
;

657 
__u64
 
	mrsvd
[4];

658 
__Ë32
 
	mz”o
;

659 
__u8
 
	m™”_hªdË
;

660 
__u8
 
	mİtiÚ
;

661 
__u16
 
	mrsvd2
;

662 
__Ë32
 
	m™”_v®
;

663 
__Ë32
 
	m™”_b™mask
;

664 
__u64
 
	mrsvd3
;

668 
	snvme_kv_™”_»ad_commªd
 {

669 
__u8
 
	mİcode
;

670 
__u8
 
	mæags
;

671 
__u16
 
	mcommªd_id
;

672 
__Ë32
 
	mnsid
;

673 
__u64
 
	mrsvd
[2];

674 
nvme_d©a_±r
 
	md±r
;

675 
__Ë32
 
	mv®ue_Ën
;

676 
__u8
 
	m™”_hªdË
;

677 
__u8
 
	mİtiÚ
;

678 
__u16
 
	mrsvd2
;

679 
__u64
 
	mrsvd3
[2];

681 
	snvme_kv_exi¡_commªd
 {

682 
__u8
 
	mİcode
;

683 
__u8
 
	mæags
;

684 
__u16
 
	mcommªd_id
;

685 
__Ë32
 
	mnsid
;

686 
__u64
 
	mrsvd
;

687 
__Ë32
 
	moff£t
;

688 
__u32
 
	mrsvd2
;

689 
__u64
 
	mrsvd3
[2];

690 
__Ë32
 
	mv®ue_Ën
;

691 
__u8
 
	mkey_Ën
;

692 
__u8
 
	mİtiÚ
;

693 
__u16
 
	mrsvd4
;

696 
	mkey
[16];

699 
__Ë64
 
	mkey_´p
;

700 
__Ë64
 
	mkey_´p2
;

708 
	envme_admš_İcode
 {

709 
	mnvme_admš_d–‘e_sq
 = 0x00,

710 
	mnvme_admš_ü—‹_sq
 = 0x01,

711 
	mnvme_admš_g‘_log_·ge
 = 0x02,

712 
	mnvme_admš_d–‘e_cq
 = 0x04,

713 
	mnvme_admš_ü—‹_cq
 = 0x05,

714 
	mnvme_admš_id’tify
 = 0x06,

715 
	mnvme_admš_abÜt_cmd
 = 0x08,

716 
	mnvme_admš_£t_ã©u»s
 = 0x09,

717 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

718 
	mnvme_admš_async_ev’t
 = 0x0c,

719 
	mnvme_admš_aùiv©e_fw
 = 0x10,

720 
	mnvme_admš_dowÆßd_fw
 = 0x11,

721 
	mnvme_admš_fÜm©_nvm
 = 0x80,

722 
	mnvme_admš_£cur™y_£nd
 = 0x81,

723 
	mnvme_admš_£cur™y_»cv
 = 0x82,

724 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


725 
	mnvme_admš_doÜb–l_memÜy
 = 0xC0,

730 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

731 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

732 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

733 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

734 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

735 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

736 
	mNVME_FEAT_ARBITRATION
 = 0x01,

737 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

738 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

739 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

740 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

741 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

742 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

743 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

744 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

745 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

746 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

747 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

748 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

749 
	mNVME_FEAT_HOST_ID
 = 0x81,

750 
	mNVME_FEAT_RESV_MASK
 = 0x82,

751 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

752 
	mNVME_LOG_ERROR
 = 0x01,

753 
	mNVME_LOG_SMART
 = 0x02,

754 
	mNVME_LOG_FW_SLOT
 = 0x03,

755 
	mNVME_LOG_DISC
 = 0x70,

756 
	mNVME_LOG_RESERVATION
 = 0x80,

757 
	mNVME_FWACT_REPL
 = (0 << 3),

758 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

759 
	mNVME_FWACT_ACTV
 = (2 << 3),

762 
	snvme_id’tify
 {

763 
__u8
 
	mİcode
;

764 
__u8
 
	mæags
;

765 
__u16
 
	mcommªd_id
;

766 
__Ë32
 
	mnsid
;

767 
__u64
 
	mrsvd2
[2];

768 
nvme_d©a_±r
 
	md±r
;

769 
__Ë32
 
	mús
;

770 
__u32
 
	mrsvd11
[5];

773 
	snvme_ã©u»s
 {

774 
__u8
 
	mİcode
;

775 
__u8
 
	mæags
;

776 
__u16
 
	mcommªd_id
;

777 
__Ë32
 
	mnsid
;

778 
__u64
 
	mrsvd2
[2];

779 
nvme_d©a_±r
 
	md±r
;

780 
__Ë32
 
	mfid
;

781 
__Ë32
 
	mdwÜd11
;

782 
__u32
 
	mrsvd12
[4];

785 
	snvme_ü—‹_cq
 {

786 
__u8
 
	mİcode
;

787 
__u8
 
	mæags
;

788 
__u16
 
	mcommªd_id
;

789 
__u32
 
	mrsvd1
[5];

790 
__Ë64
 
	m´p1
;

791 
__u64
 
	mrsvd8
;

792 
__Ë16
 
	mcqid
;

793 
__Ë16
 
	mqsize
;

794 
__Ë16
 
	mcq_æags
;

795 
__Ë16
 
	mœq_veùÜ
;

796 
__u32
 
	mrsvd12
[4];

799 
	snvme_ü—‹_sq
 {

800 
__u8
 
	mİcode
;

801 
__u8
 
	mæags
;

802 
__u16
 
	mcommªd_id
;

803 
__u32
 
	mrsvd1
[5];

804 
__Ë64
 
	m´p1
;

805 
__u64
 
	mrsvd8
;

806 
__Ë16
 
	msqid
;

807 
__Ë16
 
	mqsize
;

808 
__Ë16
 
	msq_æags
;

809 
__Ë16
 
	mcqid
;

810 
__u32
 
	mrsvd12
[4];

813 
	snvme_d–‘e_queue
 {

814 
__u8
 
	mİcode
;

815 
__u8
 
	mæags
;

816 
__u16
 
	mcommªd_id
;

817 
__u32
 
	mrsvd1
[9];

818 
__Ë16
 
	mqid
;

819 
__u16
 
	mrsvd10
;

820 
__u32
 
	mrsvd11
[5];

823 
	snvme_abÜt_cmd
 {

824 
__u8
 
	mİcode
;

825 
__u8
 
	mæags
;

826 
__u16
 
	mcommªd_id
;

827 
__u32
 
	mrsvd1
[9];

828 
__Ë16
 
	msqid
;

829 
__u16
 
	mcid
;

830 
__u32
 
	mrsvd11
[5];

833 
	snvme_dowÆßd_fœmw¬e
 {

834 
__u8
 
	mİcode
;

835 
__u8
 
	mæags
;

836 
__u16
 
	mcommªd_id
;

837 
__u32
 
	mrsvd1
[5];

838 
nvme_d©a_±r
 
	md±r
;

839 
__Ë32
 
	mnumd
;

840 
__Ë32
 
	moff£t
;

841 
__u32
 
	mrsvd12
[4];

844 
	snvme_fÜm©_cmd
 {

845 
__u8
 
	mİcode
;

846 
__u8
 
	mæags
;

847 
__u16
 
	mcommªd_id
;

848 
__Ë32
 
	mnsid
;

849 
__u64
 
	mrsvd2
[4];

850 
__Ë32
 
	mcdw10
;

851 
__u32
 
	mrsvd11
[5];

854 
	snvme_g‘_log_·ge_commªd
 {

855 
__u8
 
	mİcode
;

856 
__u8
 
	mæags
;

857 
__u16
 
	mcommªd_id
;

858 
__Ë32
 
	mnsid
;

859 
__u64
 
	mrsvd2
[2];

860 
nvme_d©a_±r
 
	md±r
;

861 
__u8
 
	mlid
;

862 
__u8
 
	mrsvd10
;

863 
__Ë16
 
	mnumdl
;

864 
__Ë16
 
	mnumdu
;

865 
__u16
 
	mrsvd11
;

866 
__Ë32
 
	mÍŞ
;

867 
__Ë32
 
	mÍou
;

868 
__u32
 
	mrsvd14
[2];

874 
	envmf_çbrics_İcode
 {

875 
	mnvme_çbrics_commªd
 = 0x7f,

878 
	envmf_ÿpsuË_commªd
 {

879 
	mnvme_çbrics_ty³_´İ”ty_£t
 = 0x00,

880 
	mnvme_çbrics_ty³_cÚÃù
 = 0x01,

881 
	mnvme_çbrics_ty³_´İ”ty_g‘
 = 0x04,

884 
	snvmf_commÚ_commªd
 {

885 
__u8
 
	mİcode
;

886 
__u8
 
	m»sv1
;

887 
__u16
 
	mcommªd_id
;

888 
__u8
 
	mfùy³
;

889 
__u8
 
	m»sv2
[35];

890 
__u8
 
	mts
[24];

899 
	#NVME_CNTLID_MIN
 1

	)

900 
	#NVME_CNTLID_MAX
 0xfãf

	)

901 
	#NVME_CNTLID_DYNAMIC
 0xffff

	)

903 
	#MAX_DISC_LOGS
 255

	)

906 
	snvmf_disc_r¥_·ge_’Œy
 {

907 
__u8
 
	mŒty³
;

908 
__u8
 
	madrçm
;

909 
__u8
 
	mnqÁy³
;

910 
__u8
 
	mŒeq
;

911 
__Ë16
 
	mpÜtid
;

912 
__Ë16
 
	múid
;

913 
__Ë16
 
	masqsz
;

914 
__u8
 
	m»sv8
[22];

915 
	mŒsvcid
[
NVMF_TRSVCID_SIZE
];

916 
__u8
 
	m»sv64
[192];

917 
	msubnqn
[
NVMF_NQN_FIELD_LEN
];

918 
	mŒaddr
[
NVMF_TRADDR_SIZE
];

919 
	ut§s
 {

920 
	mcommÚ
[
NVMF_TSAS_SIZE
];

921 
	srdma
 {

922 
__u8
 
	mq±y³
;

923 
__u8
 
	m´ty³
;

924 
__u8
 
	mcms
;

925 
__u8
 
	m»sv3
[5];

926 
__u16
 
	mpkey
;

927 
__u8
 
	m»sv10
[246];

928 } 
	mrdma
;

929 } 
	mt§s
;

933 
	snvmf_disc_r¥_·ge_hdr
 {

934 
__Ë64
 
	mg’ùr
;

935 
__Ë64
 
	mnum»c
;

936 
__Ë16
 
	m»cfmt
;

937 
__u8
 
	m»sv14
[1006];

938 
nvmf_disc_r¥_·ge_’Œy
 
	m’Œ›s
[0];

941 
	snvmf_cÚÃù_commªd
 {

942 
__u8
 
	mİcode
;

943 
__u8
 
	m»sv1
;

944 
__u16
 
	mcommªd_id
;

945 
__u8
 
	mfùy³
;

946 
__u8
 
	m»sv2
[19];

947 
nvme_d©a_±r
 
	md±r
;

948 
__Ë16
 
	m»cfmt
;

949 
__Ë16
 
	mqid
;

950 
__Ë16
 
	msqsize
;

951 
__u8
 
	mÿ‰r
;

952 
__u8
 
	m»sv3
;

953 
__Ë32
 
	mk©o
;

954 
__u8
 
	m»sv4
[12];

957 
	snvmf_cÚÃù_d©a
 {

958 
uuid_Ë
 
	mho¡id
;

959 
__Ë16
 
	múid
;

960 
	m»sv4
[238];

961 
	msubsy¢qn
[
NVMF_NQN_FIELD_LEN
];

962 
	mho¡nqn
[
NVMF_NQN_FIELD_LEN
];

963 
	m»sv5
[256];

966 
	snvmf_´İ”ty_£t_commªd
 {

967 
__u8
 
	mİcode
;

968 
__u8
 
	m»sv1
;

969 
__u16
 
	mcommªd_id
;

970 
__u8
 
	mfùy³
;

971 
__u8
 
	m»sv2
[35];

972 
__u8
 
	m©Œib
;

973 
__u8
 
	m»sv3
[3];

974 
__Ë32
 
	moff£t
;

975 
__Ë64
 
	mv®ue
;

976 
__u8
 
	m»sv4
[8];

979 
	snvmf_´İ”ty_g‘_commªd
 {

980 
__u8
 
	mİcode
;

981 
__u8
 
	m»sv1
;

982 
__u16
 
	mcommªd_id
;

983 
__u8
 
	mfùy³
;

984 
__u8
 
	m»sv2
[35];

985 
__u8
 
	m©Œib
;

986 
__u8
 
	m»sv3
[3];

987 
__Ë32
 
	moff£t
;

988 
__u8
 
	m»sv4
[16];

991 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


992 
	snvme_doÜb–l_memÜy
 {

993 
__u8
 
	mİcode
;

994 
__u8
 
	mæags
;

995 
__u16
 
	mcommªd_id
;

996 
__u32
 
	mrsvd1
[5];

997 
__Ë64
 
	m´p1
;

998 
__Ë64
 
	m´p2
;

999 
__u32
 
	mrsvd12
[6];

1003 
	snvme_commªd
 {

1005 
nvme_commÚ_commªd
 
	mcommÚ
;

1006 
nvme_rw_commªd
 
	mrw
;

1007 
nvme_id’tify
 
	mid’tify
;

1008 
nvme_ã©u»s
 
	mã©u»s
;

1009 
nvme_ü—‹_cq
 
	mü—‹_cq
;

1010 
nvme_ü—‹_sq
 
	mü—‹_sq
;

1011 
nvme_d–‘e_queue
 
	md–‘e_queue
;

1012 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

1013 
nvme_fÜm©_cmd
 
	mfÜm©
;

1014 
nvme_dsm_cmd
 
	mdsm
;

1015 
nvme_abÜt_cmd
 
	mabÜt
;

1016 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1017 
nvme_doÜb–l_memÜy
 
	mdoÜb–l_memÜy
;

1019 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

1020 
nvmf_commÚ_commªd
 
	mçbrics
;

1021 
nvmf_cÚÃù_commªd
 
	mcÚÃù
;

1022 
nvmf_´İ”ty_£t_commªd
 
	m´İ_£t
;

1023 
nvmf_´İ”ty_g‘_commªd
 
	m´İ_g‘
;

1025 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

1026 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

1027 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

1028 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

1029 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

1030 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

1031 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

1036 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1044 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_¡Üe
 || cmd->commÚ.İcod=ğ
nvme_cmd_kv_­³nd
)

1046 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_»Œ›ve
 ||

1047 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_d–‘e
 ||

1048 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»q
 ||

1049 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
 ||

1050 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_exi¡
 )

1053 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1054  
cmd
->
çbrics
.
İcode
 & 1;

1055  
cmd
->
commÚ
.
İcode
 & 1;

1056 
	}
}

1062 
	mNVME_SC_SUCCESS
 = 0x0,

1063 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

1064 
	mNVME_SC_INVALID_FIELD
 = 0x2,

1065 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

1066 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

1067 
	mNVME_SC_POWER_LOSS
 = 0x5,

1068 
	mNVME_SC_INTERNAL
 = 0x6,

1069 
	mNVME_SC_ABORT_REQ
 = 0x7,

1070 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

1071 
	mNVME_SC_FUSED_FAIL
 = 0x9,

1072 
	mNVME_SC_FUSED_MISSING
 = 0xa,

1073 
	mNVME_SC_INVALID_NS
 = 0xb,

1074 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

1075 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

1076 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

1077 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

1078 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

1079 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

1081 
	mNVME_SC_SGL_INVALID_OFFSET
 = 0x16,

1082 
	mNVME_SC_SGL_INVALID_SUBTYPE
 = 0x17,

1084 
	mNVME_SC_LBA_RANGE
 = 0x80,

1085 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

1086 
	mNVME_SC_NS_NOT_READY
 = 0x82,

1087 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

1092 
	mNVME_SC_CQ_INVALID
 = 0x100,

1093 
	mNVME_SC_QID_INVALID
 = 0x101,

1094 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

1095 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

1096 
	mNVME_SC_ABORT_MISSING
 = 0x104,

1097 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

1098 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

1099 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

1100 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

1101 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

1102 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

1103 
	mNVME_SC_FIRMWARE_NEEDS_RESET
 = 0x10b,

1104 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

1105 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

1106 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

1107 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

1108 
	mNVME_SC_FW_NEEDS_RESET_SUBSYS
 = 0x110,

1113 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

1114 
	mNVME_SC_INVALID_PI
 = 0x181,

1115 
	mNVME_SC_READ_ONLY
 = 0x182,

1116 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1117 
	mNVME_SC_DOORBELL_MEMORY_INVALID
 = 0x1C0,

1123 
	mNVME_SC_CONNECT_FORMAT
 = 0x180,

1124 
	mNVME_SC_CONNECT_CTRL_BUSY
 = 0x181,

1125 
	mNVME_SC_CONNECT_INVALID_PARAM
 = 0x182,

1126 
	mNVME_SC_CONNECT_RESTART_DISC
 = 0x183,

1127 
	mNVME_SC_CONNECT_INVALID_HOST
 = 0x184,

1129 
	mNVME_SC_DISCOVERY_RESTART
 = 0x190,

1130 
	mNVME_SC_AUTH_REQUIRED
 = 0x191,

1135 
	mNVME_SC_WRITE_FAULT
 = 0x280,

1136 
	mNVME_SC_READ_ERROR
 = 0x281,

1137 
	mNVME_SC_GUARD_CHECK
 = 0x282,

1138 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

1139 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

1140 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

1141 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

1143 
	mNVME_SC_DNR
 = 0x4000,

1146 
	snvme_com¶‘iÚ
 {

1151 
__Ë16
 
	m»suÉ16
;

1152 
__Ë32
 
	m»suÉ
;

1153 
__Ë64
 
	m»suÉ64
;

1155 
__Ë16
 
	msq_h—d
;

1156 
__Ë16
 
	msq_id
;

1157 
__u16
 
	mcommªd_id
;

1158 
__Ë16
 
	m¡©us
;

1161 
	#NVME_VS
(
majÜ
, 
mšÜ
è(((majÜè<< 16è| ((mšÜè<< 8))

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


16 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	mİcode
;

22 
__u8
 
	mæags
;

23 
__u16
 
	mcÚŒŞ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mm‘ad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¦ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	m»áag
;

31 
__u16
 
	m­±ag
;

32 
__u16
 
	m­pmask
;

35 
	snvme_·s¡hru_cmd
 {

36 
__u8
 
	mİcode
;

37 
__u8
 
	mæags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mm‘ad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mm‘ad©a_Ën
;

45 
__u32
 
	md©a_Ën
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	m»suÉ
;

56 
	#KVS_SUCCESS
 0

	)

57 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

58 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

59 
	#KVS_ERR_CLOSE
 (-3)

	)

60 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

61 
	#KVS_ERR_CONT_NAME
 (-5)

	)

62 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

63 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

64 
	#KVS_ERR_GROUP
 (-8)

	)

65 
	#KVS_ERR_INDEX
 (-9)

	)

66 
	#KVS_ERR_IO
 (-10)

	)

67 
	#KVS_ERR_KEY
 (-11)

	)

68 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

69 
	#KVS_ERR_MEMORY
 (-13)

	)

70 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

71 
	#KVS_ERR_OFFSET
 (-15)

	)

72 
	#KVS_ERR_OPEN
 (-16)

	)

73 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

74 
	#KVS_ERR_PERMISSION
 (-18)

	)

75 
	#KVS_ERR_SPACE
 (-19)

	)

76 
	#KVS_ERR_TIMEOUT
 (-20)

	)

77 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

78 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

79 
	#KVS_ERR_VALUE
 (-23)

	)

82 
	snvme_·s¡hru_kv_cmd
 {

83 
__u8
 
	mİcode
;

84 
__u8
 
	mæags
;

85 
__u16
 
	mrsvd1
;

86 
__u32
 
	mnsid
;

87 
__u32
 
	mcdw2
;

88 
__u32
 
	mcdw3
;

89 
__u32
 
	mcdw4
;

90 
__u32
 
	mcdw5
;

91 
__u64
 
	md©a_addr
;

92 
__u32
 
	md©a_Ëngth
;

93 
__u32
 
	mkey_Ëngth
;

94 
__u32
 
	mcdw10
;

95 
__u32
 
	mcdw11
;

98 
__u64
 
	mkey_addr
;

99 
__u32
 
	mrsvd5
;

100 
__u32
 
	mrsvd6
;

102 
__u8
 
	mkey
[16];

104 
__u32
 
	mcdw12
;

105 
__u32
 
	mcdw13
;

106 
__u32
 
	mcdw14
;

107 
__u32
 
	mcdw15
;

110 
__u32
 
	mtimeout_ms
;

111 
__u32
 
	m»suÉ
;

112 
__u32
 
	m¡©us
;

113 
__u32
 
	mùxid
;

114 
__u64
 
	m»qid
;

117 
	snvme_aioùx
 {

118 
__u32
 
	mùxid
;

119 
__u32
 
	mev’tfd
;

123 
	snvme_aiÛv’t
 {

124 
__u64
 
	m»qid
;

125 
__u32
 
	mùxid
;

126 
__u32
 
	m»suÉ
;

127 
__u16
 
	m¡©us
;

130 
	#MAX_AIO_EVENTS
 128

	)

131 
	snvme_aiÛv’ts
 {

132 
__u16
 
	mÄ
;

133 
__u32
 
	mùxid
;

134 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

138 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

140 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

141 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

142 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

143 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

144 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

145 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

146 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

148 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

149 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

150 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

151 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

152 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/nvme.h

14 #iâdeà
_NVME_H


15 
	#_NVME_H


	)

20 
	#KSID_SUPPORT


	)

24 
	~"lšux_nvme.h
"

26 
	~<lšux/nvme.h
>

28 
	~<lšux/pci.h
>

29 
	~<lšux/k»f.h
>

30 
	~<lšux/blk-mq.h
>

33 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

34 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

35 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

36 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

37 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

38 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

39 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

40 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

41 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

42 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

43 
	`is_kv_exi¡_cmd
(
İcode
))

	)

47 
	snvme_io_·¿m
 {

48 
sÿ‰”li¡
* 
	mkv_d©a_sg_±r
;

49 
sÿ‰”li¡
* 
	mkv_m‘a_sg_±r
;

50 
	mkv_d©a_ÃÁs
;

51 
	mkv_d©a_Ën
;

54 
šlše
 
nvme_io_·¿m
 *
	$nvme_io_·¿m
(
»que¡
 *
»q
)

56  
	`blk_mq_rq_to_pdu
(
»q
);

57 
	}
}

67 
	mNVME_SC_CANCELLED
 = -
EINTR
,

70 
nvme_io_timeout
;

71 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

73 
admš_timeout
;

74 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

76 
shutdown_timeout
;

77 
	#SHUTDOWN_TIMEOUT
 (
shutdown_timeout
 * 
HZ
)

	)

80 
	mNVME_NS_LBA
 = 0,

81 
	mNVME_NS_LIGHTNVM
 = 1,

88 
	envme_quœks
 {

93 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

99 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

105 
	mNVME_QUIRK_DISCARD_ZEROES
 = (1 << 2),

111 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

116 
	mNVME_QUIRK_NO_APST
 = (1 << 4),

121 
	mNVME_QUIRK_NO_DEEPEST_PS
 = (1 << 5),

129 
	#NVME_QUIRK_DELAY_AMOUNT
 2000

	)

131 
	snvme_ù¾
 {

132 
boŞ
 
	mid’tif›d
;

133 cÚ¡ 
nvme_ù¾_İs
 *
	mİs
;

134 
»que¡_queue
 *
	madmš_q
;

135 
deviû
 *
	mdev
;

136 
k»f
 
	mk»f
;

137 
	mš¡ªû
;

138 
blk_mq_g_£t
 *
	mg£t
;

139 
li¡_h—d
 
	mÇme¥aûs
;

140 
mu‹x
 
	mÇme¥aûs_mu‹x
;

141 
deviû
 *
	mdeviû
;

142 
li¡_h—d
 
	mnode
;

144 
	mÇme
[12];

145 
	m£rŸl
[20];

146 
	mmod–
[40];

147 
	mfœmw¬e_»v
[8];

149 
u32
 
	mù¾_cÚfig
;

151 
u32
 
	m·ge_size
;

152 
u32
 
	mmax_hw_£ùÜs
;

153 
u32
 
	m¡re_size
;

154 
u16
 
	mÚcs
;

155 
©omic_t
 
	mabÜt_lim™
;

156 
u8
 
	mev’t_lim™
;

157 
u8
 
	mvwc
;

158 
u32
 
	mvs
;

159 
u8
 
	mÅss
;

160 
u8
 
	m­¡a
;

161 
boŞ
 
	msubsy¡em
;

162 
	mquœks
;

163 
nvme_id_pow”_¡©e
 
	mpsd
[32];

166 
u64
 
	mps_max_Ï‹ncy_us
;

172 
	snvme_ns
 {

173 
li¡_h—d
 
	mli¡
;

175 
nvme_ù¾
 *
	mù¾
;

176 
»que¡_queue
 *
	mqueue
;

177 
g’disk
 *
	mdisk
;

178 
k»f
 
	mk»f
;

180 
u8
 
	meui
[8];

181 
u8
 
	muuid
[16];

183 
	mns_id
;

184 
	mlba_shiá
;

185 
u16
 
	mms
;

186 
boŞ
 
	mext
;

187 
u8
 
	mpi_ty³
;

188 
	mty³
;

189 
	mæags
;

191 
	#NVME_NS_REMOVING
 0

	)

192 
	#NVME_NS_DEAD
 1

	)

194 
u64
 
	mmode_£Ëù_num_blocks
;

195 
u32
 
	mmode_£Ëù_block_Ën
;

198 
	snvme_ù¾_İs
 {

199 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

200 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

201 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

202 
boŞ
 (*
io_šÿ·bË
)(
nvme_ù¾
 *
	mù¾
);

203 (*
	m»£t_ù¾
)(
nvme_ù¾
 *
	mù¾
);

204 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

207 
šlše
 
boŞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

209 
u32
 
v®
 = 0;

211 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

212  
çl£
;

213  
v®
 & 
NVME_CSTS_RDY
;

214 
	}
}

216 
šlše
 
boŞ
 
	$nvme_io_šÿ·bË
(
nvme_ù¾
 *
ù¾
)

218 
u32
 
v®
 = 0;

220 ià(
ù¾
->
İs
->
	`io_šÿ·bË
(ctrl))

221  
çl£
;

222 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

223  
çl£
;

224  
v®
 & 
NVME_CSTS_CFS
;

225 
	}
}

227 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

229 ià(!
ù¾
->
subsy¡em
)

230  -
ENOTTY
;

231  
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

232 
	}
}

234 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

236  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

237 
	}
}

239 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

240 
nvme_commªd
 *
cmnd
)

242 
	`mem£t
(
cmnd
, 0, (*cmnd));

243 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

244 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

245 
	}
}

247 
šlše
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

248 
nvme_commªd
 *
cmnd
)

250 
u16
 
cÚŒŞ
 = 0;

251 
u32
 
dsmgmt
 = 0;

253 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

254 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

255 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

256 
cÚŒŞ
 |ğ
NVME_RW_LR
;

258 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

259 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

261 
	`mem£t
(
cmnd
, 0, (*cmnd));

262 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

263 
cmnd
->
rw
.
commªd_id
 = 
»q
->
g
;

264 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

265 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

266 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

268 ià(
ns
->
ms
) {

269 
ns
->
pi_ty³
) {

270 
NVME_NS_DPS_PI_TYPE3
:

271 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
;

273 
NVME_NS_DPS_PI_TYPE1
:

274 
NVME_NS_DPS_PI_TYPE2
:

275 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
 |

276 
NVME_RW_PRINFO_PRCHK_REF
;

277 
cmnd
->
rw
.
»áag
 = 
	`ıu_to_Ë32
(

278 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

281 ià(!
	`blk_š‹gr™y_rq
(
»q
))

282 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

285 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

286 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

287 
	}
}

290 
šlše
 
	$nvme_”rÜ_¡©us
(
u16
 
¡©us
)

292 
¡©us
 & 0x7ff) {

293 
NVME_SC_SUCCESS
:

295 
NVME_SC_CAP_EXCEEDED
:

296  -
ENOSPC
;

298  -
EIO
;

300 
	}
}

302 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
, 
u16
 
¡©us
)

304  !(
¡©us
 & 
NVME_SC_DNR
 || 
	`blk_nÜ‘ry_»que¡
(
»q
)) &&

305 (
jiff›s
 - 
»q
->
¡¬t_time
è<„eq->
timeout
;

306 
	}
}

308 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

309 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

310 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

311 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

312 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
);

313 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

314 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

315 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

317 
nvme_sÿn_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

318 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

320 
nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
);

321 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

322 
nvme_kl_queues
(
nvme_ù¾
 *
ù¾
);

324 
	#NVME_QID_ANY
 -1

	)

325 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

326 
nvme_commªd
 *
cmd
, 
æags
, 
qid
);

327 
nvme_»queue_»q
(
»que¡
 *
»q
);

328 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

329 *
buf
, 
bufæ’
);

330 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

331 
nvme_com¶‘iÚ
 *
cqe
, *
bufãr
, 
bufæ’
,

332 
timeout
, 
qid
, 
©_h—d
, 
æags
);

333 
nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

334 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

335 
timeout
);

336 
__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

337 
__u£r
 *
ubufãr
, 
bufæ’
,

338 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

339 
u32
 *
»suÉ
, 
timeout
);

340 
nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
);

341 
nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

342 
nvme_id_ns
 **
id
);

343 
nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
);

344 
nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

345 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
);

346 
nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

347 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
);

348 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

350 
¥šlock_t
 
dev_li¡_lock
;

352 
	gsg_io_hdr
;

354 
nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
);

355 
nvme_sg_io32
(
nvme_ns
 *
ns
, 
¬g
);

356 
nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

);

358 #ifdeà
CONFIG_NVM


359 
nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
);

360 
nvme_nvm_»gi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
);

361 
nvme_nvm_uÄegi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
);

363 
šlše
 
	$nvme_nvm_»gi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
)

366 
	}
}

368 
šlše
 
	$nvme_nvm_uÄegi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
è{
	}
};

370 
šlše
 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

373 
	}
}

376 
__š™
 
nvme_cÜe_š™
();

377 
nvme_cÜe_ex™
();

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/b™İs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/blk-mq.h
>

19 
	~<lšux/ıu.h
>

20 
	~<lšux/d–ay.h
>

21 
	~<lšux/dma-©Œs.h
>

22 
	~<lšux/dmi.h
>

23 
	~<lšux/”ºo.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/g’hd.h
>

26 
	~<lšux/hd»g.h
>

27 
	~<lšux/idr.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/š‹¼u±.h
>

30 
	~<lšux/io.h
>

31 
	~<lšux/kdev_t.h
>

32 
	~<lšux/k”Ãl.h
>

33 
	~<lšux/mm.h
>

34 
	~<lšux/moduË.h
>

35 
	~<lšux/moduË·¿m.h
>

36 
	~<lšux/mu‹x.h
>

37 
	~<lšux/pci.h
>

38 
	~<lšux/poisÚ.h
>

39 
	~<lšux/±¿û.h
>

40 
	~<lšux/sched.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/t10-pi.h
>

43 
	~<lšux/tim”.h
>

44 
	~<lšux/ty³s.h
>

45 
	~<lšux/io-64-nÚ©omic-lo-hi.h
>

46 
	~<asm/uÇligÃd.h
>

48 
	~"nvme.h
"

50 
	#NVME_Q_DEPTH
 1024

	)

51 
	#NVME_AQ_DEPTH
 256

	)

52 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

53 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

56 
	#PCI_VENDOR_ID_GOOGLE
 0x1AE0

	)

62 
	#NVME_NR_AEN_COMMANDS
 1

	)

63 
	#NVME_AQ_BLKMQ_DEPTH
 (
NVME_AQ_DEPTH
 - 
NVME_NR_AEN_COMMANDS
)

	)

65 
	gadmš_timeout
 = 60;

66 
moduË_·¿m
(
admš_timeout
, 
ušt
, 0644);

67 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

69 
	gnvme_io_timeout
 = 30;

70 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
ušt
, 0644);

71 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

73 
	gshutdown_timeout
 = 5;

74 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

75 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

77 
	gu£_th»aded_š‹¼u±s
;

78 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

80 
boŞ
 
	gu£_cmb_sqes
 = 
Œue
;

81 
moduË_·¿m
(
u£_cmb_sqes
, 
boŞ
, 0644);

82 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

84 
wÜkqueue_¡ruù
 *
	gnvme_wÜkq
;

86 
DEFINE_DMA_ATTRS
(
nvme_dma_©Œs
);

88 
	gnvme_dev
;

89 
	gnvme_queue
;

91 
nvme_»£t
(
nvme_dev
 *
dev
);

92 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

93 
nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
);

94 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
);

99 
	snvme_dev
 {

100 
nvme_queue
 **
	mqueues
;

101 
blk_mq_g_£t
 
	mg£t
;

102 
blk_mq_g_£t
 
	madmš_g£t
;

103 
u32
 
__iomem
 *
	mdbs
;

104 
deviû
 *
	mdev
;

105 
dma_poŞ
 *
	m´p_·ge_poŞ
;

106 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

107 
	mqueue_couÁ
;

108 
	mÚlše_queues
;

109 
	mmax_qid
;

110 
	mq_d•th
;

111 
u32
 
	mdb_¡ride
;

112 
msix_’Œy
 *
	m’Œy
;

113 
__iomem
 *
	mb¬
;

114 
wÜk_¡ruù
 
	m»£t_wÜk
;

115 
wÜk_¡ruù
 
	msÿn_wÜk
;

116 
wÜk_¡ruù
 
	m»move_wÜk
;

117 
wÜk_¡ruù
 
	masync_wÜk
;

118 
tim”_li¡
 
	mw©chdog_tim”
;

119 
mu‹x
 
	mshutdown_lock
;

120 
boŞ
 
	msubsy¡em
;

121 
__iomem
 *
	mcmb
;

122 
dma_addr_t
 
	mcmb_dma_addr
;

123 
u64
 
	mcmb_size
;

124 
u32
 
	mcmbsz
;

125 
	mæags
;

127 
	#NVME_CTRL_RESETTING
 0

	)

128 
	#NVME_CTRL_REMOVING
 1

	)

130 
nvme_ù¾
 
	mù¾
;

131 
com¶‘iÚ
 
	mioq_wa™
;

132 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


133 
u32
 *
	mdb_mem
;

134 
dma_addr_t
 
	mdoÜb–l
;

135 
u32
 *
	mei_mem
;

136 
dma_addr_t
 
	mev’tidx
;

140 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

142  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

143 
	}
}

149 
	snvme_queue
 {

150 
deviû
 *
	mq_dmadev
;

151 
nvme_dev
 *
	mdev
;

152 
	mœqÇme
[24];

153 
¥šlock_t
 
	mq_lock
;

154 
nvme_commªd
 *
	msq_cmds
;

155 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

156 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

157 
blk_mq_gs
 **
	mgs
;

158 
dma_addr_t
 
	msq_dma_addr
;

159 
dma_addr_t
 
	mcq_dma_addr
;

160 
u32
 
__iomem
 *
	mq_db
;

161 
u16
 
	mq_d•th
;

162 
s16
 
	mcq_veùÜ
;

163 
u16
 
	msq_h—d
;

164 
u16
 
	msq_
;

165 
u16
 
	mcq_h—d
;

166 
u16
 
	mqid
;

167 
u8
 
	mcq_pha£
;

168 
u8
 
	mcqe_£’
;

169 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


170 
u32
 *
	msq_doÜb–l_addr
;

171 
u32
 *
	msq_ev’tidx_addr
;

172 
u32
 *
	mcq_doÜb–l_addr
;

173 
u32
 *
	mcq_ev’tidx_addr
;

183 
	snvme_iod
 {

185 
nvme_io_·¿m
 
	m·¿m
;

186 
	mkv_cmd
;

187 
	m»rv
;

189 
nvme_queue
 *
	mnvmeq
;

190 
	mabÜ‹d
;

191 
	mÅages
;

192 
	mÃÁs
;

193 
	mËngth
;

194 
dma_addr_t
 
	mfœ¡_dma
;

195 
sÿ‰”li¡
 
	mm‘a_sg
;

196 
sÿ‰”li¡
 *
	msg
;

197 
sÿ‰”li¡
 
	mšlše_sg
[0];

203 
šlše
 
	$_nvme_check_size
()

205 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

206 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

207 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

208 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

209 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

210 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

211 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

212 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

213 
	`BUILD_BUG_ON
((
nvme_id_ù¾
) != 4096);

214 
	`BUILD_BUG_ON
((
nvme_id_ns
) != 4096);

215 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

216 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

217 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


218 
	`BUILD_BUG_ON
((
nvme_doÜb–l_memÜy
) != 64);

220 
	}
}

225 
	#NVME_INT_PAGES
 2

	)

226 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

233 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

235 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

236 
dev
->
ù¾
.
·ge_size
);

237  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

238 
	}
}

240 
	$nvme_iod_®loc_size
(
nvme_dev
 *
dev
,

241 
size
, 
n£g
)

243  (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
) +

244 (
sÿ‰”li¡
è* 
n£g
;

245 
	}
}

247 
	$nvme_cmd_size
(
nvme_dev
 *
dev
)

249  (
nvme_iod
) +

250 
	`nvme_iod_®loc_size
(
dev
, 
	`NVME_INT_BYTES
(dev), 
NVME_INT_PAGES
);

251 
	}
}

253 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

254 
hùx_idx
)

256 
nvme_dev
 *
dev
 = 
d©a
;

257 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

259 
	`WARN_ON
(
hùx_idx
 != 0);

260 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

261 
	`WARN_ON
(
nvmeq
->
gs
);

263 
hùx
->
driv”_d©a
 = 
nvmeq
;

264 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

266 
	}
}

268 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

270 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

272 
nvmeq
->
gs
 = 
NULL
;

273 
	}
}

275 
	$nvme_admš_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

276 
hùx_idx
, 
rq_idx
,

277 
numa_node
)

279 
nvme_dev
 *
dev
 = 
d©a
;

280 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

281 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

283 
	`BUG_ON
(!
nvmeq
);

284 
iod
->
nvmeq
 =‚vmeq;

286 
	}
}

288 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

289 
hùx_idx
)

291 
nvme_dev
 *
dev
 = 
d©a
;

292 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

294 ià(!
nvmeq
->
gs
)

295 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

297 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

298 
hùx
->
driv”_d©a
 = 
nvmeq
;

300 
	}
}

302 
	$nvme_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

303 
hùx_idx
, 
rq_idx
,

304 
numa_node
)

306 
nvme_dev
 *
dev
 = 
d©a
;

307 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

308 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

310 
	`BUG_ON
(!
nvmeq
);

311 
iod
->
nvmeq
 =‚vmeq;

313 
	}
}

315 
	$nvme_queue_sÿn
(
nvme_dev
 *
dev
)

321 ià(
	`‹¡_b™
(
NVME_CTRL_REMOVING
, &
dev
->
æags
))

323 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
sÿn_wÜk
);

324 
	}
}

326 
	$nvme_com¶‘e_async_ev’t
(
nvme_dev
 *
dev
,

327 
nvme_com¶‘iÚ
 *
cqe
)

329 
u16
 
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

330 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

332 ià(
¡©us
 =ğ
NVME_SC_SUCCESS
 || stu =ğ
NVME_SC_ABORT_REQ
) {

333 ++
dev
->
ù¾
.
ev’t_lim™
;

334 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
async_wÜk
);

337 ià(
¡©us
 !ğ
NVME_SC_SUCCESS
)

340 
»suÉ
 & 0xff07) {

341 
NVME_AER_NOTICE_NS_CHANGED
:

342 
	`dev_šfo
(
dev
->dev, "rescanning\n");

343 
	`nvme_queue_sÿn
(
dev
);

345 
	`dev_w¬n
(
dev
->dev, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

347 
	}
}

349 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


350 
	$nvme_v’dÜ_memÜy_size
(
nvme_dev
 *
dev
)

352  ((
	`num_possibË_ıus
(è+ 1è* 8 * 
dev
->
db_¡ride
);

353 
	}
}

355 
	$nvme_£t_doÜb–l_memÜy
(
nvme_dev
 *
dev
)

357 
nvme_commªd
 
c
;

359 
	`mem£t
(&
c
, 0, (c));

360 
c
.
doÜb–l_memÜy
.
İcode
 = 
nvme_admš_doÜb–l_memÜy
;

361 
c
.
doÜb–l_memÜy
.
´p1
 = 
	`ıu_to_Ë64
(
dev
->
doÜb–l
);

362 
c
.
doÜb–l_memÜy
.
´p2
 = 
	`ıu_to_Ë64
(
dev
->
ev’tidx
);

364  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

365 
	}
}

367 
šlše
 
	$nvme_ext_Ãed_ev’t
(
u16
 
ev’t_idx
, u16 
Ãw_idx
, u16 
Şd
)

370  (
u16
)(
Ãw_idx
 - 
ev’t_idx
 - 1è< (u16)Òew_idx - 
Şd
);

371 
	}
}

373 
	$nvme_ext_wr™e_doÜb–l
(
u16
 
v®ue
, 
u32
 
__iomem
* 
q_db
,

374 
u32
* 
db_addr
, vŞ©u32* 
ev’t_idx
)

376 
u16
 
Şd_v®ue
;

377 ià(!
db_addr
)

378 
ršg_doÜb–l
;

380 
Şd_v®ue
 = *
db_addr
;

381 *
db_addr
 = 
v®ue
;

389 
	`mb
();

390 ià(!
	`nvme_ext_Ãed_ev’t
(*
ev’t_idx
, 
v®ue
, 
Şd_v®ue
))

391 
no_doÜb–l
;

393 
ršg_doÜb–l
:

394 
	`wr™–
(
v®ue
, 
q_db
);

395 
no_doÜb–l
:

397 
	}
}

407 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
,

408 
nvme_commªd
 *
cmd
)

410 
u16
 

 = 
nvmeq
->
sq_
;

412 ià(
nvmeq
->
sq_cmds_io
)

413 
	`memıy_toio
(&
nvmeq
->
sq_cmds_io
[

], 
cmd
, (*cmd));

415 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

417 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


418 ià(
nvmeq
->
sq_doÜb–l_addr
)

419 
	`wmb
();

422 ià(++

 =ğ
nvmeq
->
q_d•th
)

423 

 = 0;

424 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


425 
	`nvme_ext_wr™e_doÜb–l
(

, 
nvmeq
->
q_db
,

426 
nvmeq
->
sq_doÜb–l_addr
,‚vmeq->
sq_ev’tidx_addr
);

428 
	`wr™–
(

, 
nvmeq
->
q_db
);

430 
nvmeq
->
sq_
 = 

;

431 
	}
}

433 
__Ë64
 **
	$iod_li¡
(
»que¡
 *
»q
)

435 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

436  (
__Ë64
 **)(
iod
->
sg
 + 
»q
->
Ä_phys_£gm’ts
);

437 
	}
}

440 
	$__nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
, 
boŞ
 
kv
)

442 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

443 
n£g
;

444 
size
;

445 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

446 ià(
kv
) {

447 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

449 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

452 ià(
kv
) {

453 
size
 = 
·¿m
->
kv_d©a_Ën
;

455 ià(
rq
->
cmd_æags
 & 
REQ_DISCARD
)

456 
size
 = (
nvme_dsm_¿nge
);

458 
size
 = 
	`blk_rq_by‹s
(
rq
);

460 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

461 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

462 ià(!
iod
->
sg
)

463  
BLK_MQ_RQ_QUEUE_BUSY
;

465 
iod
->
sg
 = iod->
šlše_sg
;

468 
iod
->
abÜ‹d
 = 0;

469 
iod
->
Åages
 = -1;

470 
iod
->
ÃÁs
 = 0;

471 
iod
->
Ëngth
 = 
size
;

473 
	}
}

475 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

477  
	`__nvme_š™_iod
(
rq
, 
dev
, 
çl£
);

478 
	}
}

480 
	$nvme_š™_iod_fÜ_kv
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

482  
	`__nvme_š™_iod
(
rq
, 
dev
, 
Œue
);

483 
	}
}

486 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

488 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

489 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

490 
size
;

492 ià(
rq
->
cmd_æags
 & 
REQ_DISCARD
)

493 
size
 = (
nvme_dsm_¿nge
);

495 
size
 = 
	`blk_rq_by‹s
(
rq
);

497 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

498 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

499 ià(!
iod
->
sg
)

500  
BLK_MQ_RQ_QUEUE_BUSY
;

502 
iod
->
sg
 = iod->
šlše_sg
;

505 
iod
->
abÜ‹d
 = 0;

506 
iod
->
Åages
 = -1;

507 
iod
->
ÃÁs
 = 0;

508 
iod
->
Ëngth
 = 
size
;

510 
	}
}

513 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

515 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

516 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / 8 - 1;

517 
i
;

518 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

519 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

521 ià(
iod
->
Åages
 == 0)

522 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

523 
i
 = 0; i < 
iod
->
Åages
; i++) {

524 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

525 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

526 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

527 
´p_dma
 = 
Ãxt_´p_dma
;

530 ià(
iod
->
sg
 !ğiod->
šlše_sg
)

531 
	`kä“
(
iod
->
sg
);

532 
	}
}

534 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


535 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

537 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
v
)

538 
pi
->
»f_g
 = 
	`ıu_to_be32
(
p
);

539 
	}
}

541 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

543 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
p
)

544 
pi
->
»f_g
 = 
	`ıu_to_be32
(
v
);

545 
	}
}

557 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

558 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

560 
nvme_ns
 *
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

561 
bio_š‹gr™y_·ylßd
 *
b
;

562 
t10_pi_tu¶e
 *
pi
;

563 *
p
, *
pm­
;

564 
u32
 
i
, 
Æb
, 
ts
, 
phys
, 
vœt
;

566 ià(!
ns
->
pi_ty³
 ||‚s->pi_ty³ =ğ
NVME_NS_DPS_PI_TYPE3
)

569 
b
 = 
	`bio_š‹gr™y
(
»q
->
bio
);

570 ià(!
b
)

573 
pm­
 = 
	`km­_©omic
(
b
->
b_vec
->
bv_·ge
è+ b->b_vec->
bv_off£t
;

575 
p
 = 
pm­
;

576 
vœt
 = 
	`b_g‘_£ed
(
b
);

577 
phys
 = 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
));

578 
Æb
 = (
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

579 
ts
 = 
ns
->
disk
->
queue
->
š‹gr™y
.
tu¶e_size
;

581 
i
 = 0; i < 
Æb
; i++, 
vœt
++, 
phys
++) {

582 
pi
 = (
t10_pi_tu¶e
 *)
p
;

583 
	`dif_sw­
(
phys
, 
vœt
, 
pi
);

584 
p
 +ğ
ts
;

586 
	`kunm­_©omic
(
pm­
);

587 
	}
}

589 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

590 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

592 
	}
}

593 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

595 
	}
}

596 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

598 
	}
}

601 
boŞ
 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

602 
tÙ®_Ën
)

604 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

605 
dma_poŞ
 *
poŞ
;

606 
Ëngth
 = 
tÙ®_Ën
;

607 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

608 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

609 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

610 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

611 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

612 
__Ë64
 *
´p_li¡
;

613 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

614 
dma_addr_t
 
´p_dma
;

615 
Å½s
, 
i
;

617 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

618 ià(
Ëngth
 <= 0)

619  
Œue
;

621 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

622 ià(
dma_Ën
) {

623 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

625 
sg
 = 
	`sg_Ãxt
(sg);

626 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

627 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

630 ià(
Ëngth
 <ğ
·ge_size
) {

631 
iod
->
fœ¡_dma
 = 
dma_addr
;

632  
Œue
;

635 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

636 ià(
Å½s
 <= (256 / 8)) {

637 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

638 
iod
->
Åages
 = 0;

640 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

641 
iod
->
Åages
 = 1;

644 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

645 ià(!
´p_li¡
) {

646 
iod
->
fœ¡_dma
 = 
dma_addr
;

647 
iod
->
Åages
 = -1;

648  
çl£
;

650 
li¡
[0] = 
´p_li¡
;

651 
iod
->
fœ¡_dma
 = 
´p_dma
;

652 
i
 = 0;

654 ià(
i
 =ğ
·ge_size
 >> 3) {

655 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

656 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

657 ià(!
´p_li¡
)

658  
çl£
;

659 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

660 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

661 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

662 
i
 = 1;

664 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

665 
dma_Ën
 -ğ
·ge_size
;

666 
dma_addr
 +ğ
·ge_size
;

667 
Ëngth
 -ğ
·ge_size
;

668 ià(
Ëngth
 <= 0)

670 ià(
dma_Ën
 > 0)

672 
	`BUG_ON
(
dma_Ën
 < 0);

673 
sg
 = 
	`sg_Ãxt
(sg);

674 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

675 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

678  
Œue
;

679 
	}
}

682 
	$nvme_kv_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

683 
nvme_commªd
 *
cmnd
)

685 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

686 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

687 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

688 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

690 ià(
·¿m
->
kv_d©a_sg_±r
) {

691 
sÿ‰”li¡
* 
sg
;

692 
i
;

694 
	`fÜ_—ch_sg
(
·¿m
->
kv_d©a_sg_±r
, 
sg
,…¬am->
kv_d©a_ÃÁs
, 
i
) {

695 
iod
->
sg
[
i
] = *sg;

697 
iod
->
ÃÁs
 = 
·¿m
->
kv_d©a_ÃÁs
;

698 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

699 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

700 &
nvme_dma_©Œs
))

701 
out
;

703 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
·¿m
->
kv_d©a_Ën
))

704 
out_unm­
;

706 
cmnd
->
kv_¡Üe
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

707 
cmnd
->
kv_¡Üe
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

709 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

711 ià(
·¿m
->
kv_m‘a_sg_±r
)

713 ià(!
	`dma_m­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
))

714 
out_unm­
;

715 
cmnd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
·¿m
->
kv_m‘a_sg_±r
));

717  
BLK_MQ_RQ_QUEUE_OK
;

719 
out_unm­
:

720 ià(
·¿m
->
kv_d©a_sg_±r
)

721 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

722 
out
:

723  
»t
;

724 
	}
}

727 
	$nvme_kv_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

729 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

730 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

731 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

733 ià(
·¿m
->
kv_d©a_sg_±r
) {

734 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

736 ià(
·¿m
->
kv_m‘a_sg_±r
)

738 
	`dma_unm­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
);

740 
	`nvme_ä“_iod
(
dev
, 
»q
);

741 
	}
}

744 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

745 
nvme_commªd
 *
cmnd
)

747 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

748 
»que¡_queue
 *
q
 = 
»q
->q;

749 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

750 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

751 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

753 ià(
	`is_kv_cmd
(
cmnd
->
commÚ
.
İcode
)) {

754  
	`nvme_kv_m­_d©a
(
dev
, 
»q
, 
cmnd
);

757 
	`sg_š™_bË
(
iod
->
sg
, 
»q
->
Ä_phys_£gm’ts
);

758 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

759 ià(!
iod
->
ÃÁs
)

760 
out
;

762 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

763 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

764 &
nvme_dma_©Œs
))

765 
out
;

767 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
	`blk_rq_by‹s
(req)))

768 
out_unm­
;

770 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

771 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

772 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

773 
out_unm­
;

775 
	`sg_š™_bË
(&
iod
->
m‘a_sg
, 1);

776 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, &
iod
->
m‘a_sg
) != 1)

777 
out_unm­
;

779 ià(
	`rq_d©a_dœ
(
»q
))

780 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_´•
);

782 ià(!
	`dma_m­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
))

783 
out_unm­
;

786 
cmnd
->
rw
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

787 
cmnd
->
rw
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

788 ià(
	`blk_š‹gr™y_rq
(
»q
))

789 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(&
iod
->
m‘a_sg
));

790  
BLK_MQ_RQ_QUEUE_OK
;

792 
out_unm­
:

793 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

794 
out
:

795  
»t
;

796 
	}
}

798 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

800 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

801 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

802 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

804 ià(
iod
->
kv_cmd
) {

805  
	`nvme_kv_unm­_d©a
(
dev
, 
»q
);

808 ià(
iod
->
ÃÁs
) {

809 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

810 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

811 ià(!
	`rq_d©a_dœ
(
»q
))

812 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_com¶‘e
);

813 
	`dma_unm­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
);

817 
	`nvme_ä“_iod
(
dev
, 
»q
);

818 
	}
}

825 
	$nvme_£tup_disÿrd
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

826 
»que¡
 *
»q
, 
nvme_commªd
 *
cmnd
)

828 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

829 
nvme_dsm_¿nge
 *
¿nge
;

831 
¿nge
 = 
	`dma_poŞ_®loc
(
nvmeq
->
dev
->
´p_sm®l_poŞ
, 
GFP_ATOMIC
,

832 &
iod
->
fœ¡_dma
);

833 ià(!
¿nge
)

834  
BLK_MQ_RQ_QUEUE_BUSY
;

835 
	`iod_li¡
(
»q
)[0] = (
__Ë64
 *)
¿nge
;

836 
iod
->
Åages
 = 0;

838 
¿nge
->
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

839 
¿nge
->
Æb
 = 
	`ıu_to_Ë32
(
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

840 
¿nge
->
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

842 
	`mem£t
(
cmnd
, 0, (*cmnd));

843 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

844 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

845 
cmnd
->
dsm
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

846 
cmnd
->
dsm
.
Ä
 = 0;

847 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

848  
BLK_MQ_RQ_QUEUE_OK
;

849 
	}
}

854 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

855 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

857 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

858 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

859 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

860 
»que¡
 *
»q
 = 
bd
->
rq
;

861 
nvme_commªd
 
cmnd
;

862 
»t
 = 
BLK_MQ_RQ_QUEUE_OK
;

869 ià(
ns
 &&‚s->
ms
 && !
	`blk_š‹gr™y_rq
(
»q
)) {

870 ià(!(
ns
->
pi_ty³
 &&‚s->
ms
 == 8) &&

871 
»q
->
cmd_ty³
 !ğ
REQ_TYPE_DRV_PRIV
) {

872 
	`blk_mq_’d_»que¡
(
»q
, -
EFAULT
);

873  
BLK_MQ_RQ_QUEUE_OK
;

878 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
) {

879 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

880 ià(
»t
)

881  
»t
;

882 
»t
 = 
	`nvme_£tup_disÿrd
(
nvmeq
, 
ns
, 
»q
, &
cmnd
);

884 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

885 
	`memıy
(&
cmnd
, 
»q
->
cmd
, (cmnd));

886 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

887 
	`nvme_£tup_æush
(
ns
, &
cmnd
);

889 
	`nvme_£tup_rw
(
ns
, 
»q
, &
cmnd
);

891 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

892 
»t
 = 
	`nvme_š™_iod_fÜ_kv
(
»q
, 
dev
);

894 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

896 ià(
»t
)

897  
»t
;

899 ià(
»q
->
Ä_phys_£gm’ts
 || 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
))

900 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

904 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

905 ià(
»t
)

906  
»t
;

908 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
) {

909 
»t
 = 
	`nvme_£tup_disÿrd
(
nvmeq
, 
ns
, 
»q
, &
cmnd
);

911 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

912 
	`memıy
(&
cmnd
, 
»q
->
cmd
, (cmnd));

913 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

914 
	`nvme_£tup_æush
(
ns
, &
cmnd
);

916 
	`nvme_£tup_rw
(
ns
, 
»q
, &
cmnd
);

918 ià(
»q
->
Ä_phys_£gm’ts
)

919 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

922 ià(
»t
)

923 
out
;

925 
cmnd
.
commÚ
.
commªd_id
 = 
»q
->
g
;

926 
	`blk_mq_¡¬t_»que¡
(
»q
);

927 #ifdeà
KV_NVME_DUMMY_OP


928 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

929 #ifdeà
KV_NVME_DUMMY_OP_REPORT


930 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

931 
	`´_”r
("[dump‚vme kv comand]\n");

932 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

933 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

934 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

935 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

936 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

937 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

938 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

939 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

940 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

941 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

942 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

943 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

944 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

945 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

946 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

947 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

948 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

949 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

951 ià(
»q
->
¥ecŸl
) {

952 
nvme_com¶‘iÚ
 
cqe
;

953 
	`mem£t
(&
cqe
, 0, (cqe));

954 
cqe
.
commmªd_id
 = 
cmnd
.
commÚ
.
commªd_id
;

955 
cqe
.
¡©us
 = 0;

956 ià(
	`is_kv_»Œ›ve_cmd
(
cmnd
.
commÚ
.
İcode
)) {

957 
cqe
.
»suÉ
 = 
cmnd
.
commÚ
.
cdw
[10] << 2;

959 
	`memıy
(
»q
->
¥ecŸl
, &
cqe
, (cqe));

961 
	`blk_mq_com¶‘e_»que¡
(
»q
, 0);

962  
BLK_MQ_RQ_QUEUE_OK
;

965 #ifdeà
KV_NVME_OP_REPORT


966 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

967 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

968 
	`´_”r
("[dump‚vme kv comand]\n");

969 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

970 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

971 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

972 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

973 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

974 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

975 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

976 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

977 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

978 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

979 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

980 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

981 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

982 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

983 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

984 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

985 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

986 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

989 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

990 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0)) {

991 ià(
ns
 && !
	`‹¡_b™
(
NVME_NS_DEAD
, &ns->
æags
))

992 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

994 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

995 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

996 
out
;

998 
	`__nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

999 
	`nvme_´oûss_cq
(
nvmeq
);

1000 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1001  
BLK_MQ_RQ_QUEUE_OK
;

1002 
out
:

1003 
	`nvme_ä“_iod
(
dev
, 
»q
);

1004  
»t
;

1005 
	}
}

1007 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

1009 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1010 
nvme_dev
 *
dev
 = 
iod
->
nvmeq
->dev;

1011 
”rÜ
 = 0;

1013 
	`nvme_unm­_d©a
(
dev
, 
»q
);

1015 ià(
	`uÆik–y
(
»q
->
”rÜs
)) {

1016 ià(
	`nvme_»q_Ãeds_»Œy
(
»q
,„eq->
”rÜs
)) {

1017 
	`nvme_»queue_»q
(
»q
);

1021 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

1022 
”rÜ
 = 
»q
->
”rÜs
;

1024 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
»q
->
”rÜs
);

1027 ià(
	`uÆik–y
(
iod
->
abÜ‹d
)) {

1028 
	`dev_w¬n
(
dev
->dev,

1030 
»q
->
”rÜs
);

1033 
	`blk_mq_’d_»que¡
(
»q
, 
”rÜ
);

1034 
	}
}

1037 
šlše
 
boŞ
 
	$nvme_cqe_v®id
(
nvme_queue
 *
nvmeq
, 
u16
 
h—d
,

1038 
u16
 
pha£
)

1040  (
	`Ë16_to_ıu
(
nvmeq
->
cqes
[
h—d
].
¡©us
è& 1è=ğ
pha£
;

1041 
	}
}

1043 
	$__nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
, *
g
)

1045 
u16
 
h—d
, 
pha£
;

1047 
h—d
 = 
nvmeq
->
cq_h—d
;

1048 
pha£
 = 
nvmeq
->
cq_pha£
;

1050 
	`nvme_cqe_v®id
(
nvmeq
, 
h—d
, 
pha£
)) {

1051 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[
h—d
];

1052 
»que¡
 *
»q
;

1054 
nvmeq
->
sq_h—d
 = 
	`Ë16_to_ıu
(
cqe
.sq_head);

1056 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1057 ià(
	`to_pci_dev
(
nvmeq
->
dev
->dev)->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
)

1058 
	`rmb
();

1061 ià(++
h—d
 =ğ
nvmeq
->
q_d•th
) {

1062 
h—d
 = 0;

1063 
pha£
 = !phase;

1066 ià(
g
 && *g =ğ
cqe
.
commªd_id
)

1067 *
g
 = -1;

1069 ià(
	`uÆik–y
(
cqe
.
commªd_id
 >ğ
nvmeq
->
q_d•th
)) {

1070 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

1072 
cqe
.
commªd_id
, 
	`Ë16_to_ıu
(cqe.
sq_id
));

1082 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

1083 
cqe
.
commªd_id
 >ğ
NVME_AQ_BLKMQ_DEPTH
)) {

1084 
	`nvme_com¶‘e_async_ev’t
(
nvmeq
->
dev
, &
cqe
);

1088 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
.
commªd_id
);

1089 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
 &&„eq->
¥ecŸl
)

1090 
	`memıy
(
»q
->
¥ecŸl
, &
cqe
, (cqe));

1091 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
	`Ë16_to_ıu
(
cqe
.
¡©us
) >> 1);

1101 ià(
h—d
 =ğ
nvmeq
->
cq_h—d
 && 
pha£
 =ğnvmeq->
cq_pha£
)

1104 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0))

1105 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1106 
	`nvme_ext_wr™e_doÜb–l
(
h—d
,

1107 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
,

1108 
nvmeq
->
cq_doÜb–l_addr
,

1109 
nvmeq
->
cq_ev’tidx_addr
);

1111 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

1113 
nvmeq
->
cq_h—d
 = 
h—d
;

1114 
nvmeq
->
cq_pha£
 = 
pha£
;

1116 
nvmeq
->
cqe_£’
 = 1;

1117 
	}
}

1119 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

1121 
	`__nvme_´oûss_cq
(
nvmeq
, 
NULL
);

1122 
	}
}

1124 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1126 
œq»tuº_t
 
»suÉ
;

1127 
nvme_queue
 *
nvmeq
 = 
d©a
;

1128 
	`¥š_lock
(&
nvmeq
->
q_lock
);

1129 
	`nvme_´oûss_cq
(
nvmeq
);

1130 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

1131 
nvmeq
->
cqe_£’
 = 0;

1132 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

1133  
»suÉ
;

1134 
	}
}

1136 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1138 
nvme_queue
 *
nvmeq
 = 
d©a
;

1139 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

1140  
IRQ_WAKE_THREAD
;

1141  
IRQ_NONE
;

1142 
	}
}

1144 
	$nvme_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1146 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1148 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
)) {

1149 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1150 
	`__nvme_´oûss_cq
(
nvmeq
, &
g
);

1151 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1153 ià(
g
 == -1)

1158 
	}
}

1160 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1162 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
async_wÜk
);

1163 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1164 
nvme_commªd
 
c
;

1166 
	`mem£t
(&
c
, 0, (c));

1167 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1169 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1170 
dev
->
ù¾
.
ev’t_lim™
 > 0) {

1171 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLKMQ_DEPTH
 +

1172 --
dev
->
ù¾
.
ev’t_lim™
;

1173 
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

1175 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1176 
	}
}

1178 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1180 
nvme_commªd
 
c
;

1182 
	`mem£t
(&
c
, 0, (c));

1183 
c
.
d–‘e_queue
.
İcode
 = opcode;

1184 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1186  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1187 
	}
}

1189 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1190 
nvme_queue
 *
nvmeq
)

1192 
nvme_commªd
 
c
;

1193 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1199 
	`mem£t
(&
c
, 0, (c));

1200 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1201 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1202 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1203 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1204 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1205 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1207  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1208 
	}
}

1210 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1211 
nvme_queue
 *
nvmeq
)

1213 
nvme_commªd
 
c
;

1214 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_SQ_PRIO_MEDIUM
;

1220 
	`mem£t
(&
c
, 0, (c));

1221 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1222 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1223 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1224 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1225 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1226 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1228  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1229 
	}
}

1231 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1233  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1234 
	}
}

1236 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1238  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1239 
	}
}

1241 
	$abÜt_’dio
(
»que¡
 *
»q
, 
”rÜ
)

1243 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1244 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1245 
u16
 
¡©us
 = 
»q
->
”rÜs
;

1247 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
, "AbÜˆ¡©us: 0x%x", 
¡©us
);

1248 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

1249 
	`blk_mq_ä“_»que¡
(
»q
);

1250 
	}
}

1252 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

1254 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1255 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1256 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1257 
»que¡
 *
abÜt_»q
;

1258 
nvme_commªd
 
cmd
;

1266 ià(
	`‹¡_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
)) {

1267 
	`dev_w¬n
(
dev
->dev,

1269 
»q
->
g
, 
nvmeq
->
qid
);

1270 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1271 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1272  
BLK_EH_HANDLED
;

1280 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

1281 
	`dev_w¬n
(
dev
->dev,

1283 
»q
->
g
, 
nvmeq
->
qid
);

1284 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1285 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

1291 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1292  
BLK_EH_HANDLED
;

1294 #ifdeà
REPORT_TIMEOUT


1296 
nvme_ns
 *
ns
 = 
NULL
;

1297 
cmd
.
commÚ
.
nsid
 = 0;

1298 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

1299 
	`memıy
(&
cmd
, 
»q
->cmd,  (
nvme_commªd
));

1301 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
) {

1302 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1303 } ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
) {

1304 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_dsm
;

1306 
cmd
.
commÚ
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
: 
nvme_cmd_»ad
);

1308 ià(
»q
->
rq_disk
) {

1309 
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

1310 ià(
ns
è
cmd
.
commÚ
.
nsid
 =‚s->
ns_id
;

1313 ià(
iod
->
kv_cmd
)

1315 
__u32
 *
d©a
 = (__u32*è
cmd
.
commÚ
.
cdw2
;

1316 
	`´_”r
("nvme_timeout: opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1317 
	`´_”r
("[dump‚vme kv comand]\n");

1318 
	`´_”r
("\tİcode:(%02x)\n", 
cmd
.
commÚ
.
İcode
);

1319 
	`´_”r
("\tæags:(%02x)\n", 
cmd
.
commÚ
.
æags
);

1320 
	`´_”r
("\tcommªd id:(%04x)\n", 
»q
->
g
);

1321 
	`´_”r
("\Š id:(%08x)\n", 
cmd
.
commÚ
.
nsid
);

1322 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

1323 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

1324 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

1325 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

1326 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

1327 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

1328 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

1329 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

1330 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

1331 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

1332 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

1333 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

1334 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

1335 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

1337 
	`´_”r
("nvme_timeout:‚Ú kv opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1341 
iod
->
abÜ‹d
 = 1;

1343 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1344 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1345  
BLK_EH_RESET_TIMER
;

1348 
	`mem£t
(&
cmd
, 0, (cmd));

1349 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1350 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1351 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1353 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "I/O %d QID %dimeout,‡borting\n",

1354 
»q
->
g
, 
nvmeq
->
qid
);

1356 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1357 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1358 ià(
	`IS_ERR
(
abÜt_»q
)) {

1359 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1360  
BLK_EH_RESET_TIMER
;

1363 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1364 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1365 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1372  
BLK_EH_RESET_TIMER
;

1373 
	}
}

1375 
	$nvme_ÿnûl_queue_ios
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

1377 
nvme_queue
 *
nvmeq
 = 
d©a
;

1378 
¡©us
;

1380 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

1383 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

1384 "CªûÎšg I/O %d QID %d\n", 
»q
->
g
, 
nvmeq
->
qid
);

1386 
¡©us
 = 
NVME_SC_ABORT_REQ
;

1387 ià(
	`blk_queue_dyšg
(
»q
->
q
))

1388 
¡©us
 |ğ
NVME_SC_DNR
;

1389 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
¡©us
);

1390 
	}
}

1392 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1394 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1395 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1396 ià(
nvmeq
->
sq_cmds
)

1397 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1398 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1399 
	`kä“
(
nvmeq
);

1400 
	}
}

1402 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1404 
i
;

1406 
i
 = 
dev
->
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1407 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1408 
dev
->
queue_couÁ
--;

1409 
dev
->
queues
[
i
] = 
NULL
;

1410 
	`nvme_ä“_queue
(
nvmeq
);

1412 
	}
}

1418 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1420 
veùÜ
;

1422 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1423 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1424 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1427 
veùÜ
 = 
nvmeq
->
dev
->
’Œy
[nvmeq->
cq_veùÜ
].vector;

1428 
nvmeq
->
dev
->
Úlše_queues
--;

1429 
nvmeq
->
cq_veùÜ
 = -1;

1430 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1432 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1433 
	`blk_mq_¡İ_hw_queues
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1435 
	`œq_£t_affš™y_hšt
(
veùÜ
, 
NULL
);

1436 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1439 
	}
}

1441 
	$nvme_ş—r_queue
(
nvme_queue
 *
nvmeq
)

1443 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1444 ià(
nvmeq
->
gs
 && *nvmeq->tags)

1445 
	`blk_mq_®l_g_busy_™”
(*
nvmeq
->
gs
, 
nvme_ÿnûl_queue_ios
,‚vmeq);

1446 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1447 
	}
}

1449 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1451 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1453 ià(!
nvmeq
)

1455 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1458 ià(
shutdown
)

1459 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1461 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
	`lo_hi_»adq
(

1462 
dev
->
b¬
 + 
NVME_REG_CAP
));

1464 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1465 
	`nvme_´oûss_cq
(
nvmeq
);

1466 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1467 
	}
}

1469 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1470 
’Œy_size
)

1472 
q_d•th
 = 
dev
->q_depth;

1473 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1474 
dev
->
ù¾
.
·ge_size
);

1476 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1477 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1478 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1479 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1486 ià(
q_d•th
 < 64)

1487  -
ENOMEM
;

1490  
q_d•th
;

1491 
	}
}

1493 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1494 
qid
, 
d•th
)

1496 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1497 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
d•th
),

1498 
dev
->
ù¾
.
·ge_size
);

1499 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_dma_addr
 + 
off£t
;

1500 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1502 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1503 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1504 ià(!
nvmeq
->
sq_cmds
)

1505  -
ENOMEM
;

1509 
	}
}

1511 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1512 
d•th
)

1514 
nvme_queue
 *
nvmeq
 = 
	`kz®loc
((*nvmeq), 
GFP_KERNEL
);

1515 ià(!
nvmeq
)

1516  
NULL
;

1518 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1519 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1520 ià(!
nvmeq
->
cqes
)

1521 
ä“_nvmeq
;

1523 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1524 
ä“_cqdma
;

1526 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1527 
nvmeq
->
dev
 = dev;

1528 
	`¢´štf
(
nvmeq
->
œqÇme
, (nvmeq->irqname), "nvme%dq%d",

1529 
dev
->
ù¾
.
š¡ªû
, 
qid
);

1530 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1531 
nvmeq
->
cq_h—d
 = 0;

1532 
nvmeq
->
cq_pha£
 = 1;

1533 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1534 
nvmeq
->
q_d•th
 = 
d•th
;

1535 
nvmeq
->
qid
 = qid;

1536 
nvmeq
->
cq_veùÜ
 = -1;

1537 
dev
->
queues
[
qid
] = 
nvmeq
;

1538 
dev
->
queue_couÁ
++;

1540 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1541 ià(
dev
->
db_mem
 && dev->
ei_mem
 && 
qid
 != 0) {

1542 
nvmeq
->
sq_doÜb–l_addr
 = &
dev
->
db_mem
[
qid
 * 2 * dev->
db_¡ride
];

1543 
nvmeq
->
cq_doÜb–l_addr
 =

1544 &
dev
->
db_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1545 
nvmeq
->
sq_ev’tidx_addr
 = &
dev
->
ei_mem
[
qid
 * 2 * dev->
db_¡ride
];

1546 
nvmeq
->
cq_ev’tidx_addr
 =

1547 &
dev
->
ei_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1551  
nvmeq
;

1553 
ä“_cqdma
:

1554 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1555 
nvmeq
->
cq_dma_addr
);

1556 
ä“_nvmeq
:

1557 
	`kä“
(
nvmeq
);

1558  
NULL
;

1559 
	}
}

1561 
	$queue_»que¡_œq
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1562 cÚ¡ *
Çme
)

1564 ià(
u£_th»aded_š‹¼u±s
)

1565  
	`»que¡_th»aded_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1566 
nvme_œq_check
, 
nvme_œq
, 
IRQF_SHARED
,

1567 
Çme
, 
nvmeq
);

1568  
	`»que¡_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
, 
nvme_œq
,

1569 
IRQF_SHARED
, 
Çme
, 
nvmeq
);

1570 
	}
}

1572 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1574 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1576 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1577 
nvmeq
->
sq_
 = 0;

1578 
nvmeq
->
cq_h—d
 = 0;

1579 
nvmeq
->
cq_pha£
 = 1;

1580 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1581 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1582 ià(
	`to_pci_dev
(
dev
->dev)->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
 && 
qid
 != 0) {

1583 
nvmeq
->
sq_doÜb–l_addr
 = &
dev
->
db_mem
[
qid
 * 2 * dev->
db_¡ride
];

1584 
nvmeq
->
cq_doÜb–l_addr
 =

1585 &
dev
->
db_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1586 
nvmeq
->
sq_ev’tidx_addr
 = &
dev
->
ei_mem
[
qid
 * 2 * dev->
db_¡ride
];

1587 
nvmeq
->
cq_ev’tidx_addr
 =

1588 &
dev
->
ei_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1591 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1592 
dev
->
Úlše_queues
++;

1593 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1594 
	}
}

1596 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1598 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1599 
»suÉ
;

1601 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1602 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1603 ià(
»suÉ
 < 0)

1604 
»Ëa£_veùÜ
;

1606 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1607 ià(
»suÉ
 < 0)

1608 
»Ëa£_cq
;

1610 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1611 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1612 ià(
»suÉ
 < 0)

1613 
»Ëa£_sq
;

1615  
»suÉ
;

1617 
»Ëa£_sq
:

1618 
dev
->
Úlše_queues
--;

1619 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1620 
»Ëa£_cq
:

1621 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1622 
»Ëa£_veùÜ
:

1623 
nvmeq
->
cq_veùÜ
 = -1;

1624  
»suÉ
;

1625 
	}
}

1627 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1628 .
queue_rq
 = 
nvme_queue_rq
,

1629 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1630 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1631 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1632 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1633 .
	gš™_»que¡
 = 
nvme_admš_š™_»que¡
,

1634 .
	gtimeout
 = 
nvme_timeout
,

1637 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1638 .
queue_rq
 = 
nvme_queue_rq
,

1639 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1640 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1641 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1642 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1643 .
	gtimeout
 = 
nvme_timeout
,

1644 .
	gpŞl
 = 
nvme_pŞl
,

1647 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1649 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1655 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1656 
	`blk_ş—nup_queue
(
dev
->
ù¾
.
admš_q
);

1657 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1659 
	}
}

1661 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1663 ià(!
dev
->
ù¾
.
admš_q
) {

1664 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1665 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1671 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_BLKMQ_DEPTH
 - 1;

1672 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1673 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1674 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1675 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1677 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1678  -
ENOMEM
;

1680 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1681 ià(
	`IS_ERR
(
dev
->
ù¾
.
admš_q
)) {

1682 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1683  -
ENOMEM
;

1685 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1686 
	`nvme_dev_»move_admš
(
dev
);

1687 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1688  -
ENODEV
;

1691 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1694 
	}
}

1696 
	$nvme_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1698 
»suÉ
;

1699 
u32
 
aqa
;

1700 
u64
 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

1701 
nvme_queue
 *
nvmeq
;

1703 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 1) ?

1704 
	`NVME_CAP_NSSRC
(
ÿp
) : 0;

1706 ià(
dev
->
subsy¡em
 &&

1707 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1708 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1710 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1711 ià(
»suÉ
 < 0)

1712  
»suÉ
;

1714 
nvmeq
 = 
dev
->
queues
[0];

1715 ià(!
nvmeq
) {

1716 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1717 ià(!
nvmeq
)

1718  -
ENOMEM
;

1721 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1722 
aqa
 |=‡qa << 16;

1724 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1725 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1726 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

1728 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1729 ià(
»suÉ
)

1730 
ä“_nvmeq
;

1732 
nvmeq
->
cq_veùÜ
 = 0;

1733 
	`nvme_š™_queue
(
nvmeq
, 0);

1734 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1735 ià(
»suÉ
) {

1736 
nvmeq
->
cq_veùÜ
 = -1;

1737 
ä“_nvmeq
;

1740  
»suÉ
;

1742 
ä“_nvmeq
:

1743 
	`nvme_ä“_queues
(
dev
, 0);

1744  
»suÉ
;

1745 
	}
}

1747 
boŞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1753 
boŞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1756 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

1757  
çl£
;

1762 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1763  
çl£
;

1768 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1769  
çl£
;

1771  
Œue
;

1772 
	}
}

1774 
	$nvme_w©chdog_tim”
(
d©a
)

1776 
nvme_dev
 *
dev
 = (nvme_dev *)
d©a
;

1777 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1780 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1781 ià(
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
))

1782 
	`dev_w¬n
(
dev
->dev,

1784 
c¡s
);

1788 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

1789 
	}
}

1791 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

1793 
i
;

1794 
»t
 = 0;

1796 
i
 = 
dev
->
queue_couÁ
; i <ğdev->
max_qid
; i++) {

1797 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
)) {

1798 
»t
 = -
ENOMEM
;

1803 
i
 = 
dev
->
Úlše_queues
; i <ğdev->
queue_couÁ
 - 1; i++) {

1804 
»t
 = 
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i);

1805 ià(
»t
) {

1806 
	`nvme_ä“_queues
(
dev
, 
i
);

1817  
»t
 >= 0 ? 0 :„et;

1818 
	}
}

1820 
__iomem
 *
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

1822 
u64
 
szu
, 
size
, 
off£t
;

1823 
u32
 
cmbloc
;

1824 
»sourû_size_t
 
b¬_size
;

1825 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1826 
__iomem
 *
cmb
;

1827 
dma_addr_t
 
dma_addr
;

1829 ià(!
u£_cmb_sqes
)

1830  
NULL
;

1832 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

1833 ià(!(
	`NVME_CMB_SZ
(
dev
->
cmbsz
)))

1834  
NULL
;

1836 
cmbloc
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CMBLOC
);

1838 
szu
 = (
u64
)1 << (12 + 4 * 
	`NVME_CMB_SZU
(
dev
->
cmbsz
));

1839 
size
 = 
szu
 * 
	`NVME_CMB_SZ
(
dev
->
cmbsz
);

1840 
off£t
 = 
szu
 * 
	`NVME_CMB_OFST
(
cmbloc
);

1841 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
	`NVME_CMB_BIR
(
cmbloc
));

1843 ià(
off£t
 > 
b¬_size
)

1844  
NULL
;

1851 ià(
size
 > 
b¬_size
 - 
off£t
)

1852 
size
 = 
b¬_size
 - 
off£t
;

1854 
dma_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
	`NVME_CMB_BIR
(
cmbloc
)è+ 
off£t
;

1855 
cmb
 = 
	`iÜem­_wc
(
dma_addr
, 
size
);

1856 ià(!
cmb
)

1857  
NULL
;

1859 
dev
->
cmb_dma_addr
 = 
dma_addr
;

1860 
dev
->
cmb_size
 = 
size
;

1861  
cmb
;

1862 
	}
}

1864 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

1866 ià(
dev
->
cmb
) {

1867 
	`iounm­
(
dev
->
cmb
);

1868 
dev
->
cmb
 = 
NULL
;

1870 
	}
}

1872 
size_t
 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1874  4096 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1875 
	}
}

1877 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

1879 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

1880 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1881 
»suÉ
, 
i
, 
vecs
, 
Ä_io_queues
, 
size
;

1883 
Ä_io_queues
 = 
	`num_possibË_ıus
();

1884 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

1885 ià(
»suÉ
 < 0)

1886  
»suÉ
;

1893 ià(
»suÉ
 > 0) {

1894 
	`dev_”r
(
dev
->
ù¾
.
deviû
,

1895 "Could‚Ù s‘ queucouÁ (%d)\n", 
»suÉ
);

1899 ià(
dev
->
cmb
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1900 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

1901 (
nvme_commªd
));

1902 ià(
»suÉ
 > 0)

1903 
dev
->
q_d•th
 = 
»suÉ
;

1905 
	`nvme_»Ëa£_cmb
(
dev
);

1908 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1909 ià(
size
 > 8192) {

1910 
	`iounm­
(
dev
->
b¬
);

1912 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1913 ià(
dev
->
b¬
)

1915 ià(!--
Ä_io_queues
)

1916  -
ENOMEM
;

1917 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1919 
dev
->
dbs
 = dev->
b¬
 + 4096;

1920 
admšq
->
q_db
 = 
dev
->
dbs
;

1924 
	`ä“_œq
(
dev
->
’Œy
[0].
veùÜ
, 
admšq
);

1930 ià(
pdev
->
msi_’abËd
)

1931 
	`pci_di§bË_msi
(
pdev
);

1932 ià(
pdev
->
msix_’abËd
)

1933 
	`pci_di§bË_msix
(
pdev
);

1935 
i
 = 0; i < 
Ä_io_queues
; i++)

1936 
dev
->
’Œy
[
i
].entry = i;

1937 
vecs
 = 
	`pci_’abË_msix_¿nge
(
pdev
, 
dev
->
’Œy
, 1, 
Ä_io_queues
);

1938 ià(
vecs
 < 0) {

1939 
vecs
 = 
	`pci_’abË_msi_¿nge
(
pdev
, 1, 
	`mš
(
Ä_io_queues
, 32));

1940 ià(
vecs
 < 0) {

1941 
vecs
 = 1;

1943 
i
 = 0; i < 
vecs
; i++)

1944 
dev
->
’Œy
[
i
].
veùÜ
 = i + 
pdev
->
œq
;

1954 
Ä_io_queues
 = 
vecs
;

1955 
dev
->
max_qid
 = 
Ä_io_queues
;

1957 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
admšq
,‡dmšq->
œqÇme
);

1958 ià(
»suÉ
) {

1959 
admšq
->
cq_veùÜ
 = -1;

1960 
ä“_queues
;

1964 
	`nvme_ä“_queues
(
dev
, 
Ä_io_queues
 + 1);

1965  
	`nvme_ü—‹_io_queues
(
dev
);

1967 
ä“_queues
:

1968 
	`nvme_ä“_queues
(
dev
, 1);

1969  
»suÉ
;

1970 
	}
}

1972 
	$nvme_£t_œq_hšts
(
nvme_dev
 *
dev
)

1974 
nvme_queue
 *
nvmeq
;

1975 
i
;

1977 
i
 = 0; i < 
dev
->
Úlše_queues
; i++) {

1978 
nvmeq
 = 
dev
->
queues
[
i
];

1980 ià(!
nvmeq
->
gs
 || !(*nvmeq->tags))

1983 
	`œq_£t_affš™y_hšt
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1984 
	`blk_mq_gs_ıumask
(*
nvmeq
->
gs
));

1986 
	}
}

1988 
	$nvme_dev_sÿn
(
wÜk_¡ruù
 *
wÜk
)

1990 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
sÿn_wÜk
);

1992 ià(!
dev
->
g£t
.
gs
)

1994 
	`nvme_sÿn_Çme¥aûs
(&
dev
->
ù¾
);

1995 
	`nvme_£t_œq_hšts
(
dev
);

1996 
	}
}

1998 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
”rÜ
)

2000 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2002 
	`blk_mq_ä“_»que¡
(
»q
);

2003 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

2004 
	}
}

2006 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
”rÜ
)

2008 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

2010 ià(!
”rÜ
) {

2011 
æags
;

2013 
	`¥š_lock_œq§ve
(&
nvmeq
->
q_lock
, 
æags
);

2014 
	`nvme_´oûss_cq
(
nvmeq
);

2015 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

2018 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

2019 
	}
}

2021 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
)

2023 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

2024 
»que¡
 *
»q
;

2025 
nvme_commªd
 
cmd
;

2027 
	`mem£t
(&
cmd
, 0, (cmd));

2028 
cmd
.
d–‘e_queue
.
İcode
 = opcode;

2029 
cmd
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

2031 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

2032 ià(
	`IS_ERR
(
»q
))

2033  
	`PTR_ERR
(
»q
);

2035 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

2036 
»q
->
’d_io_d©a
 = 
nvmeq
;

2038 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

2039 
İcode
 =ğ
nvme_admš_d–‘e_cq
 ?

2040 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

2042 
	}
}

2044 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
)

2046 
·ss
;

2047 
timeout
;

2048 
u8
 
İcode
 = 
nvme_admš_d–‘e_sq
;

2050 
·ss
 = 0;…ass < 2;…ass++) {

2051 
£Á
 = 0, 
i
 = 
dev
->
queue_couÁ
 - 1;

2053 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2054 
»Œy
:

2055 
timeout
 = 
ADMIN_TIMEOUT
;

2056 ; 
i
 > 0; i--, 
£Á
++)

2057 ià(
	`nvme_d–‘e_queue
(
dev
->
queues
[
i
], 
İcode
))

2060 
£Á
--) {

2061 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

2062 ià(
timeout
 == 0)

2064 ià(
i
)

2065 
»Œy
;

2067 
İcode
 = 
nvme_admš_d–‘e_cq
;

2069 
	}
}

2077 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2079 ià(!
dev
->
ù¾
.
g£t
) {

2080 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

2081 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

2082 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2083 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

2084 
dev
->
g£t
.
queue_d•th
 =

2085 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

2086 
dev
->
g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

2087 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2088 
dev
->
g£t
.
driv”_d©a
 = dev;

2090 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

2092 
dev
->
ù¾
.
g£t
 = &dev->tagset;

2094 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2095 ià(
	`to_pci_dev
(
dev
->dev)->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
) {

2096 
»s
 = 
	`nvme_£t_doÜb–l_memÜy
(
dev
);

2097 ià(
»s
) {

2099 
	`dma_ä“_coh”’t
(
dev
->dev, 8192, dev->
db_mem
, dev->
doÜb–l
);

2100 
	`dma_ä“_coh”’t
(
dev
->dev, 8192, dev->
ei_mem
, dev->
doÜb–l
);

2101 
dev
->
db_mem
 = 0;

2102 
dev
->
ei_mem
 = 0;

2107 
	`nvme_queue_sÿn
(
dev
);

2109 
	}
}

2111 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

2113 
u64
 
ÿp
;

2114 
»suÉ
 = -
ENOMEM
;

2115 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2117 ià(
	`pci_’abË_deviû_mem
(
pdev
))

2118  
»suÉ
;

2120 
	`pci_£t_ma¡”
(
pdev
);

2122 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

2123 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

2124 
di§bË
;

2126 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

2127 
»suÉ
 = -
ENODEV
;

2128 
di§bË
;

2136 ià(
	`pci_’abË_msix
(
pdev
, 
dev
->
’Œy
, 1)) {

2137 
	`pci_’abË_msi
(
pdev
);

2138 
dev
->
’Œy
[0].
veùÜ
 = 
pdev
->
œq
;

2141 ià(!
dev
->
’Œy
[0].
veùÜ
) {

2142 
»suÉ
 = -
ENODEV
;

2143 
di§bË
;

2146 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

2148 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ÿp
è+ 1, 
NVME_Q_DEPTH
);

2149 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(
ÿp
);

2150 
dev
->
dbs
 = dev->
b¬
 + 4096;

2156 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_APPLE
 &&…dev->
deviû
 == 0x2001) {

2157 
dev
->
q_d•th
 = 2;

2158 
	`dev_w¬n
(
dev
->dev, "detected Apple NVMe controller, set "

2160 
dev
->
q_d•th
);

2161 } ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_SAMSUNG
 &&

2162 (
pdev
->
deviû
 == 0xa821 ||…dev->device == 0xa822) &&

2163 
	`NVME_CAP_MQES
(
ÿp
) == 0) {

2164 
dev
->
q_d•th
 = 64;

2165 
	`dev_”r
(
dev
->
ù¾
.
deviû
, "detected PM1725 NVMe controller, "

2166 "£ˆqueud•th=%u\n", 
dev
->
q_d•th
);

2169 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 2))

2170 
dev
->
cmb
 = 
	`nvme_m­_cmb
(dev);

2172 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

2173 
	`pci_§ve_¡©e
(
pdev
);

2175 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2176 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
) {

2177 
mem_size
 = 
	`nvme_v’dÜ_memÜy_size
(
dev
);

2178 
dev
->
db_mem
 = 
	`dma_®loc_coh”’t
(&
pdev
->dev, 
mem_size
, &dev->
doÜb–l
, 
GFP_KERNEL
);

2179 ià(!
dev
->
db_mem
) {

2180 
»suÉ
 = -
ENOMEM
;

2181 
di§bË
;

2183 
dev
->
ei_mem
 = 
	`dma_®loc_coh”’t
(&
pdev
->dev, 
mem_size
, &dev->
ev’tidx
, 
GFP_KERNEL
);

2184 ià(!
dev
->
ei_mem
) {

2185 
»suÉ
 = -
ENOMEM
;

2186 
dma_ä“
;

2193 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2194 
dma_ä“
:

2195 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
	`nvme_v’dÜ_memÜy_size
(dev), dev->
db_mem
, dev->
doÜb–l
);

2196 
dev
->
db_mem
 = 0;

2199 
di§bË
:

2200 
	`pci_di§bË_deviû
(
pdev
);

2202  
»suÉ
;

2203 
	}
}

2205 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

2207 ià(
dev
->
b¬
)

2208 
	`iounm­
(
dev
->
b¬
);

2209 
	`pci_»Ëa£_»giÚs
(
	`to_pci_dev
(
dev
->dev));

2210 
	}
}

2212 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

2214 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2215 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2216 
mem_size
 = 
	`nvme_v’dÜ_memÜy_size
(
dev
);

2218 ià(
dev
->
db_mem
)

2219 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
mem_size
, dev->
db_mem
, dev->
doÜb–l
);

2220 ià(
dev
->
ei_mem
)

2221 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
mem_size
, dev->
ei_mem
, dev->
ev’tidx
);

2224 ià(
pdev
->
msi_’abËd
)

2225 
	`pci_di§bË_msi
(
pdev
);

2226 ià(
pdev
->
msix_’abËd
)

2227 
	`pci_di§bË_msix
(
pdev
);

2229 ià(
	`pci_is_’abËd
(
pdev
)) {

2230 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

2231 
	`pci_di§bË_deviû
(
pdev
);

2233 
	}
}

2235 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

2237 
i
;

2238 
u32
 
c¡s
 = -1;

2240 
	`d–_tim”_sync
(&
dev
->
w©chdog_tim”
);

2242 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

2243 ià(
	`pci_is_’abËd
(
	`to_pci_dev
(
dev
->dev))) {

2244 
	`nvme_¡İ_queues
(&
dev
->
ù¾
);

2245 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

2248 
i
 = 
dev
->
queue_couÁ
 - 1; i > 0; i--)

2249 
	`nvme_su¥’d_queue
(
dev
->
queues
[
i
]);

2251 ià(
c¡s
 & 
NVME_CSTS_CFS
 || !(c¡ & 
NVME_CSTS_RDY
)) {

2256 ià(
dev
->
queue_couÁ
)

2257 
	`nvme_su¥’d_queue
(
dev
->
queues
[0]);

2259 
	`nvme_di§bË_io_queues
(
dev
);

2260 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

2262 
	`nvme_pci_di§bË
(
dev
);

2264 
i
 = 
dev
->
queue_couÁ
 - 1; i >= 0; i--)

2265 
	`nvme_ş—r_queue
(
dev
->
queues
[
i
]);

2266 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

2267 
	}
}

2269 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

2271 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist…age", dev->dev,

2272 
PAGE_SIZE
, PAGE_SIZE, 0);

2273 ià(!
dev
->
´p_·ge_poŞ
)

2274  -
ENOMEM
;

2277 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist 256", dev->dev,

2279 ià(!
dev
->
´p_sm®l_poŞ
) {

2280 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2281  -
ENOMEM
;

2284 
	}
}

2286 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

2288 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2289 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

2290 
	}
}

2292 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

2294 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2296 
	`put_deviû
(
dev
->dev);

2297 ià(
dev
->
g£t
.
gs
)

2298 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

2299 ià(
dev
->
ù¾
.
admš_q
)

2300 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2301 
	`kä“
(
dev
->
queues
);

2302 
	`kä“
(
dev
->
’Œy
);

2303 
	`kä“
(
dev
);

2304 
	}
}

2306 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2308 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»£t_wÜk
);

2309 
»suÉ
;

2311 ià(
	`WARN_ON
(
	`‹¡_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
)))

2312 
out
;

2318 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

2319 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2321 ià(
	`‹¡_b™
(
NVME_CTRL_REMOVING
, &
dev
->
æags
))

2322 
out
;

2324 
	`£t_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
);

2326 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

2327 ià(
»suÉ
)

2328 
out
;

2330 
»suÉ
 = 
	`nvme_cÚfigu»_admš_queue
(
dev
);

2331 ià(
»suÉ
)

2332 
unm­
;

2334 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2335 ià(
»suÉ
)

2336 
di§bË
;

2338 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2339 ià(
»suÉ
)

2340 
ä“_gs
;

2342 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2343 ià(
»suÉ
)

2344 
ä“_gs
;

2346 
dev
->
ù¾
.
ev’t_lim™
 = 
NVME_NR_AEN_COMMANDS
;

2347 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
async_wÜk
);

2349 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

2355 ià(
dev
->
Úlše_queues
 < 2) {

2356 
	`dev_w¬n
(
dev
->dev, "IO queues‚ot created\n");

2357 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2359 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2360 
	`nvme_dev_add
(
dev
);

2363 
	`ş—r_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
);

2366 
ä“_gs
:

2367 
	`nvme_dev_»move_admš
(
dev
);

2368 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2369 
dev
->
ù¾
.
admš_q
 = 
NULL
;

2370 
dev
->
queues
[0]->
gs
 = 
NULL
;

2371 
di§bË
:

2372 
	`nvme_di§bË_admš_queue
(
dev
, 
çl£
);

2373 
unm­
:

2374 
	`nvme_dev_unm­
(
dev
);

2375 
out
:

2376 
	`nvme_»move_d—d_ù¾
(
dev
);

2377 
	}
}

2379 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2381 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2382 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2384 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2385 ià(
	`pci_g‘_drvd©a
(
pdev
))

2386 
	`pci_¡İ_ªd_»move_bus_deviû_locked
(
pdev
);

2387 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2388 
	}
}

2390 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
)

2392 
	`dev_w¬n
(
dev
->dev, "Removing‡fter…robe failure\n");

2393 
	`k»f_g‘
(&
dev
->
ù¾
.
k»f
);

2394 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2395 ià(!
	`scheduË_wÜk
(&
dev
->
»move_wÜk
))

2396 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2397 
	}
}

2399 
	$nvme_»£t
(
nvme_dev
 *
dev
)

2401 ià(!
dev
->
ù¾
.
admš_q
 || 
	`blk_queue_dyšg
(dev->ctrl.admin_q))

2402  -
ENODEV
;

2404 ià(!
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
))

2405  -
EBUSY
;

2407 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2409 
	}
}

2411 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2413 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2415 
	}
}

2417 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2419 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2421 
	}
}

2423 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2425 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2427 
	}
}

2429 
boŞ
 
	$nvme_pci_io_šÿ·bË
(
nvme_ù¾
 *
ù¾
)

2431 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2433  !
dev
->
b¬
 || dev->
Úlše_queues
 < 2;

2434 
	}
}

2436 
	$nvme_pci_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

2438  
	`nvme_»£t
(
	`to_nvme_dev
(
ù¾
));

2439 
	}
}

2441 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_pci_ù¾_İs
 = {

2442 .
»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2443 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2444 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2445 .
	gio_šÿ·bË
 = 
nvme_pci_io_šÿ·bË
,

2446 .
	g»£t_ù¾
 = 
nvme_pci_»£t_ù¾
,

2447 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2450 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2452 
b¬s
;

2453 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2455 
b¬s
 = 
	`pci_£Ëù_b¬s
(
pdev
, 
IORESOURCE_MEM
);

2456 ià(!
b¬s
)

2457  -
ENODEV
;

2458 ià(
	`pci_»que¡_£Ëùed_»giÚs
(
pdev
, 
b¬s
, "nvme"))

2459  -
ENODEV
;

2461 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 8192);

2462 ià(!
dev
->
b¬
)

2463 
»Ëa£
;

2466 
»Ëa£
:

2467 
	`pci_»Ëa£_»giÚs
(
pdev
);

2468  -
ENODEV
;

2469 
	}
}

2471 
	$check_v’dÜ_combš©iÚ_bug
(
pci_dev
 *
pdev
)

2473 ià(
pdev
->
v’dÜ
 =ğ0x144d &&…dev->
deviû
 == 0xa802) {

2482 ià(
	`dmi_m©ch
(
DMI_SYS_VENDOR
, "Dell Inc.") &&

2483 (
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "XPS 15 9550") ||

2484 
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "Precision 5510")))

2485  
NVME_QUIRK_NO_DEEPEST_PS
;

2486 } ià(
pdev
->
v’dÜ
 =ğ0x144d &&…dev->
deviû
 == 0xa804) {

2491 ià(
	`dmi_m©ch
(
DMI_BOARD_VENDOR
, "ASUSTeK COMPUTER INC.") &&

2492 
	`dmi_m©ch
(
DMI_BOARD_NAME
, "PRIME B350M-A"))

2493  
NVME_QUIRK_NO_APST
;

2497 
	}
}

2499 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2501 
node
, 
»suÉ
 = -
ENOMEM
;

2502 
nvme_dev
 *
dev
;

2503 
quœks
 = 
id
->
driv”_d©a
;

2505 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2506 ià(
node
 =ğ
NUMA_NO_NODE
)

2507 
	`£t_dev_node
(&
pdev
->
dev
, 0);

2509 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

2510 ià(!
dev
)

2511  -
ENOMEM
;

2512 
dev
->
’Œy
 = 
	`kz®loc_node
(
	`num_possibË_ıus
() * (*dev->entry),

2513 
GFP_KERNEL
, 
node
);

2514 ià(!
dev
->
’Œy
)

2515 
ä“
;

2516 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

2517 
GFP_KERNEL
, 
node
);

2518 ià(!
dev
->
queues
)

2519 
ä“
;

2521 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

2522 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2524 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

2525 ià(
»suÉ
)

2526 
ä“
;

2528 
	`INIT_WORK
(&
dev
->
sÿn_wÜk
, 
nvme_dev_sÿn
);

2529 
	`INIT_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_wÜk
);

2530 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

2531 
	`INIT_WORK
(&
dev
->
async_wÜk
, 
nvme_async_ev’t_wÜk
);

2532 
	`£tup_tim”
(&
dev
->
w©chdog_tim”
, 
nvme_w©chdog_tim”
,

2533 ()
dev
);

2534 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

2535 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2537 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2538 ià(
»suÉ
)

2539 
put_pci
;

2541 
quœks
 |ğ
	`check_v’dÜ_combš©iÚ_bug
(
pdev
);

2543 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_İs
,

2544 
quœks
);

2545 ià(
»suÉ
)

2546 
»Ëa£_poŞs
;

2548 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2551 
»Ëa£_poŞs
:

2552 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2553 
put_pci
:

2554 
	`put_deviû
(
dev
->dev);

2555 
	`nvme_dev_unm­
(
dev
);

2556 
ä“
:

2557 
	`kä“
(
dev
->
queues
);

2558 
	`kä“
(
dev
->
’Œy
);

2559 
	`kä“
(
dev
);

2560  
»suÉ
;

2561 
	}
}

2563 
	$nvme_»£t_nÙify
(
pci_dev
 *
pdev
, 
boŞ
 
´•¬e
)

2565 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2567 ià(
´•¬e
)

2568 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2570 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2571 
	}
}

2573 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2575 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2576 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2577 
	}
}

2579 
	$nvme_»move
(
pci_dev
 *
pdev
)

2581 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2583 
	`£t_b™
(
NVME_CTRL_REMOVING
, &
dev
->
æags
);

2584 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2585 
	`æush_wÜk
(&
dev
->
async_wÜk
);

2586 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2587 
	`æush_wÜk
(&
dev
->
sÿn_wÜk
);

2588 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2589 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

2590 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2591 
	`nvme_dev_»move_admš
(
dev
);

2592 
	`nvme_ä“_queues
(
dev
, 0);

2593 
	`nvme_»Ëa£_cmb
(
dev
);

2594 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2595 
	`nvme_dev_unm­
(
dev
);

2596 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2597 
	}
}

2599 #ifdeà
CONFIG_PM_SLEEP


2600 
	$nvme_su¥’d
(
deviû
 *
dev
)

2602 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2603 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2605 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

2607 
	}
}

2609 
	$nvme_»sume
(
deviû
 *
dev
)

2611 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2612 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2614 
	`queue_wÜk
(
nvme_wÜkq
, &
ndev
->
»£t_wÜk
);

2616 
	}
}

2619 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

2621 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

2622 
pci_chªÃl_¡©e_t
 
¡©e
)

2624 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2631 
	`dev_w¬n
(&
pdev
->
dev
, "”rÜ d‘eùed: s‹:%d\n", 
¡©e
);

2632 
¡©e
) {

2633 
pci_chªÃl_io_nÜm®
:

2634  
PCI_ERS_RESULT_CAN_RECOVER
;

2635 
pci_chªÃl_io_äoz’
:

2636 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2637  
PCI_ERS_RESULT_NEED_RESET
;

2638 
pci_chªÃl_io_³rm_çu»
:

2639  
PCI_ERS_RESULT_DISCONNECT
;

2641  
PCI_ERS_RESULT_NEED_RESET
;

2642 
	}
}

2644 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

2646 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2648 
	`dev_šfo
(&
pdev
->
dev
, "restart‡fter slot„eset\n");

2649 
	`pci_»¡Üe_¡©e
(
pdev
);

2650 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2651  
PCI_ERS_RESULT_RECOVERED
;

2652 
	}
}

2654 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

2656 
	`pci_ş—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

2657 
	}
}

2659 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2660 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2661 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2662 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2663 .
	g»£t_nÙify
 = 
nvme_»£t_nÙify
,

2667 
	#PCI_CLASS_STORAGE_EXPRESS
 0x010802

	)

2669 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

2670 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2671 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2672 
NVME_QUIRK_DISCARD_ZEROES
, },

2673 { 
PCI_VDEVICE
(
INTEL
, 0xf1a5),

2674 .
	gdriv”_d©a
 = 
NVME_QUIRK_NO_DEEPEST_PS
 },

2675 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2676 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

2677 { 
PCI_DEVICE
(0x1c58, 0x0003),

2678 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2679 { 
PCI_DEVICE
(0x144d, 0xa821),

2680 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2681 { 
PCI_DEVICE
(0x144d, 0xa822),

2682 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2683 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2684 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

2687 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2689 
pci_driv”
 
	gnvme_driv”
 = {

2690 .
Çme
 = "nvme",

2691 .
	gid_bË
 = 
nvme_id_bË
,

2692 .
	g´obe
 = 
nvme_´obe
,

2693 .
	g»move
 = 
nvme_»move
,

2694 .
	gshutdown
 = 
nvme_shutdown
,

2695 .
	gdriv”
 = {

2696 .
pm
 = &
nvme_dev_pm_İs
,

2698 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2701 
__š™
 
	$nvme_š™
()

2703 
»suÉ
;

2705 
nvme_wÜkq
 = 
	`®loc_wÜkqueue
("nvme", 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
, 0);

2706 ià(!
nvme_wÜkq
)

2707  -
ENOMEM
;

2709 
»suÉ
 = 
	`nvme_cÜe_š™
();

2710 ià(
»suÉ
 < 0)

2711 
kl_wÜkq
;

2713 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2714 ià(
»suÉ
)

2715 
cÜe_ex™
;

2717 
	`dma_£t_©Œ
(
DMA_ATTR_NO_WARN
, &
nvme_dma_©Œs
);

2721 
cÜe_ex™
:

2722 
	`nvme_cÜe_ex™
();

2723 
kl_wÜkq
:

2724 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2725  
»suÉ
;

2726 
	}
}

2728 
__ex™
 
	$nvme_ex™
()

2730 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2731 
	`nvme_cÜe_ex™
();

2732 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2733 
	`_nvme_check_size
();

2734 
	}
}

2736 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

2737 
MODULE_LICENSE
("GPL");

2738 
MODULE_VERSION
("1.0");

2739 
moduË_š™
(
nvme_š™
);

2740 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/scsi.c

20 
	~<lšux/bio.h
>

21 
	~<lšux/b™İs.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/com·t.h
>

24 
	~<lšux/d–ay.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/g’hd.h
>

28 
	~<lšux/idr.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/š‹¼u±.h
>

31 
	~<lšux/io.h
>

32 
	~<lšux/kdev_t.h
>

33 
	~<lšux/kth»ad.h
>

34 
	~<lšux/k”Ãl.h
>

35 
	~<lšux/mm.h
>

36 
	~<lšux/moduË.h
>

37 
	~<lšux/moduË·¿m.h
>

38 
	~<lšux/pci.h
>

39 
	~<lšux/poisÚ.h
>

40 
	~<lšux/sched.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/ty³s.h
>

43 
	~<asm/uÇligÃd.h
>

44 
	~<scsi/sg.h
>

45 
	~<scsi/scsi.h
>

47 
	~"nvme.h
"

49 
	gsg_v”siÚ_num
 = 30534;

52 
	#VPD_SUPPORTED_PAGES
 0x00

	)

53 
	#VPD_SERIAL_NUMBER
 0x80

	)

54 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

55 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

56 
	#VPD_BLOCK_LIMITS
 0xB0

	)

57 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

60 
	#FORMAT_UNIT_SHORT_PARM_LIST_LEN
 4

	)

61 
	#FORMAT_UNIT_LONG_PARM_LIST_LEN
 8

	)

62 
	#FORMAT_UNIT_PROT_INT_OFFSET
 3

	)

63 
	#FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
 0

	)

64 
	#FORMAT_UNIT_PROT_FIELD_USAGE_MASK
 0x07

	)

67 
	#FIXED_SENSE_DATA
 0x70

	)

68 
	#DESC_FORMAT_SENSE_DATA
 0x72

	)

69 
	#FIXED_SENSE_DATA_ADD_LENGTH
 10

	)

70 
	#LUN_ENTRY_SIZE
 8

	)

71 
	#LUN_DATA_HEADER_SIZE
 8

	)

72 
	#ALL_LUNS_RETURNED
 0x02

	)

73 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

74 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

75 
	#DOWNLOAD_SAVE_ACTIVATE
 0x05

	)

76 
	#DOWNLOAD_SAVE_DEFER_ACTIVATE
 0x0E

	)

77 
	#ACTIVATE_DEFERRED_MICROCODE
 0x0F

	)

78 
	#FORMAT_UNIT_IMMED_MASK
 0x2

	)

79 
	#FORMAT_UNIT_IMMED_OFFSET
 1

	)

80 
	#KELVIN_TEMP_FACTOR
 273

	)

81 
	#FIXED_FMT_SENSE_DATA_SIZE
 18

	)

82 
	#DESC_FMT_SENSE_DATA_SIZE
 8

	)

85 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

86 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

87 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

88 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

89 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

90 
	#INQ_BDEV_LIMITS_PAGE
 0xB0

	)

91 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

92 
	#INQ_SERIAL_NUMBER_LENGTH
 0x14

	)

93 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 6

	)

94 
	#VERSION_SPC_4
 0x06

	)

95 
	#ACA_UNSUPPORTED
 0

	)

96 
	#STANDARD_INQUIRY_LENGTH
 36

	)

97 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

98 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

99 
	#RESERVED_FIELD
 0

	)

102 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

103 
	#MODE_PAGE_CACHING
 0x08

	)

104 
	#MODE_PAGE_CONTROL
 0x0A

	)

105 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

106 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

107 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

108 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

109 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

110 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

111 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

112 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

113 
	#MODE_PAGE_ALL_LEN
 0x54

	)

114 
	#MODE_SENSE6_MPH_SIZE
 4

	)

115 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

116 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

117 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

118 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

119 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

120 
	#MODE_SENSE_DBD_MASK
 8

	)

121 
	#MODE_SENSE_DBD_SHIFT
 3

	)

122 
	#MODE_SENSE10_MPH_SIZE
 8

	)

123 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

124 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

125 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

126 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

127 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

128 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

129 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

130 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

131 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

132 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

133 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

134 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

135 
	#SHORT_DESC_BLOCK
 8

	)

136 
	#LONG_DESC_BLOCK
 16

	)

137 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

138 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

139 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

140 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

141 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

144 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
 0x00

	)

145 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
 0x07

	)

146 
	#LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
 0x2F

	)

147 
	#LOG_PAGE_TEMPERATURE_PAGE
 0x0D

	)

148 
	#LOG_SENSE_CDB_SP_NOT_ENABLED
 0

	)

149 
	#LOG_SENSE_CDB_PC_MASK
 0xC0

	)

150 
	#LOG_SENSE_CDB_PC_SHIFT
 6

	)

151 
	#LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
 1

	)

152 
	#LOG_SENSE_CDB_PAGE_CODE_MASK
 0x3F

	)

153 
	#REMAINING_INFO_EXCP_PAGE_LENGTH
 0x8

	)

154 
	#LOG_INFO_EXCP_PAGE_LENGTH
 0xC

	)

155 
	#REMAINING_TEMP_PAGE_LENGTH
 0xC

	)

156 
	#LOG_TEMP_PAGE_LENGTH
 0x10

	)

157 
	#LOG_TEMP_UNKNOWN
 0xFF

	)

158 
	#SUPPORTED_LOG_PAGES_PAGE_LENGTH
 0x3

	)

161 
	#READ_CAP_10_RESP_SIZE
 8

	)

162 
	#READ_CAP_16_RESP_SIZE
 32

	)

165 
	#BYTES_TO_DWORDS
 4

	)

166 
	#NVME_MAX_FIRMWARE_SLOT
 7

	)

169 
	#REPORT_LUNS_FIRST_LUN_OFFSET
 8

	)

173 
	#SCSI_ASC_NO_SENSE
 0x00

	)

174 
	#SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

175 
	#SCSI_ASC_LUN_NOT_READY
 0x04

	)

176 
	#SCSI_ASC_WARNING
 0x0B

	)

177 
	#SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

178 
	#SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

179 
	#SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

180 
	#SCSI_ASC_UNRECOVERED_READ_ERROR
 0x11

	)

181 
	#SCSI_ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

182 
	#SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
 0x20

	)

183 
	#SCSI_ASC_ILLEGAL_COMMAND
 0x20

	)

184 
	#SCSI_ASC_ILLEGAL_BLOCK
 0x21

	)

185 
	#SCSI_ASC_INVALID_CDB
 0x24

	)

186 
	#SCSI_ASC_INVALID_LUN
 0x25

	)

187 
	#SCSI_ASC_INVALID_PARAMETER
 0x26

	)

188 
	#SCSI_ASC_FORMAT_COMMAND_FAILED
 0x31

	)

189 
	#SCSI_ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

193 
	#SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

194 
	#SCSI_ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

195 
	#SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

196 
	#SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

197 
	#SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

198 
	#SCSI_ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

199 
	#SCSI_ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

200 
	#SCSI_ASCQ_INVALID_LUN_ID
 0x09

	)

203 
šlše
 
u32
 
	$g‘_uÇligÃd_be24
(
u8
 *
buf
)

205  0xfffffà& (
u32
è
	`g‘_uÇligÃd_be32
(
buf
 - 1);

206 
	}
}

211 
	snvme_Œªs_io_cdb
 {

212 
u8
 
	mfua
;

213 
u8
 
	m´Ù_šfo
;

214 
u64
 
	mlba
;

215 
u32
 
	mxãr_Ën
;

224 
	$nvme_Œªs_cİy_to_u£r
(
sg_io_hdr
 *
hdr
, *
äom
,

225 
n
)

227 
i
;

228 *
šdex
 = 
äom
;

229 
size_t
 
»maššg
 = 
n
;

230 
size_t
 
xãr_Ën
;

232 ià(
hdr
->
iovec_couÁ
 > 0) {

233 
sg_iovec
 
sgl
;

235 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

236 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

237 
i
 * (
sg_iovec
),

238 (
sg_iovec
)))

239  -
EFAULT
;

240 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

241 ià(
	`cİy_to_u£r
(
sgl
.
iov_ba£
, 
šdex
, 
xãr_Ën
))

242  -
EFAULT
;

244 
šdex
 +ğ
xãr_Ën
;

245 
»maššg
 -ğ
xãr_Ën
;

246 ià(
»maššg
 == 0)

252 ià(
	`cİy_to_u£r
(
hdr
->
dxã½
, 
äom
, 
n
))

253  -
EFAULT
;

255 
	}
}

259 
	$nvme_Œªs_cİy_äom_u£r
(
sg_io_hdr
 *
hdr
, *
to
,

260 
n
)

262 
i
;

263 *
šdex
 = 
to
;

264 
size_t
 
»maššg
 = 
n
;

265 
size_t
 
xãr_Ën
;

267 ià(
hdr
->
iovec_couÁ
 > 0) {

268 
sg_iovec
 
sgl
;

270 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

271 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

272 
i
 * (
sg_iovec
),

273 (
sg_iovec
)))

274  -
EFAULT
;

275 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

276 ià(
	`cİy_äom_u£r
(
šdex
, 
sgl
.
iov_ba£
, 
xãr_Ën
))

277  -
EFAULT
;

278 
šdex
 +ğ
xãr_Ën
;

279 
»maššg
 -ğ
xãr_Ën
;

280 ià(
»maššg
 == 0)

286 ià(
	`cİy_äom_u£r
(
to
, 
hdr
->
dxã½
, 
n
))

287  -
EFAULT
;

289 
	}
}

293 
	$nvme_Œªs_com¶‘iÚ
(
sg_io_hdr
 *
hdr
, 
u8
 
¡©us
, u8 
£n£_key
,

294 
u8
 
asc
, u8 
ascq
)

296 
u8
 
xãr_Ën
;

297 
u8
 
»¥
[
DESC_FMT_SENSE_DATA_SIZE
];

299 ià(
	`scsi_¡©us_is_good
(
¡©us
)) {

300 
hdr
->
¡©us
 = 
SAM_STAT_GOOD
;

301 
hdr
->
masked_¡©us
 = 
GOOD
;

302 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

303 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

304 
hdr
->
sb_Ën_wr
 = 0;

306 
hdr
->
¡©us
 = status;

307 
hdr
->
masked_¡©us
 = 
¡©us
 >> 1;

308 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

309 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

311 
	`mem£t
(
»¥
, 0, 
DESC_FMT_SENSE_DATA_SIZE
);

312 
»¥
[0] = 
DESC_FORMAT_SENSE_DATA
;

313 
»¥
[1] = 
£n£_key
;

314 
»¥
[2] = 
asc
;

315 
»¥
[3] = 
ascq
;

317 
xãr_Ën
 = 
	`mš_t
(
u8
, 
hdr
->
mx_sb_Ën
, 
DESC_FMT_SENSE_DATA_SIZE
);

318 
hdr
->
sb_Ën_wr
 = 
xãr_Ën
;

319 ià(
	`cİy_to_u£r
(
hdr
->
sbp
, 
»¥
, 
xãr_Ën
) > 0)

320  -
EFAULT
;

324 
	}
}

332 
	$nvme_Œªs_¡©us_code
(
sg_io_hdr
 *
hdr
, 
nvme_sc
)

334 
u8
 
¡©us
, 
£n£_key
, 
asc
, 
ascq
;

335 
»s
;

338 ià(
nvme_sc
 < 0)

339  
nvme_sc
;

342 
nvme_sc
 & 0x7FF) {

344 
NVME_SC_SUCCESS
:

345 
¡©us
 = 
SAM_STAT_GOOD
;

346 
£n£_key
 = 
NO_SENSE
;

347 
asc
 = 
SCSI_ASC_NO_SENSE
;

348 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

350 
NVME_SC_INVALID_OPCODE
:

351 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

352 
£n£_key
 = 
ILLEGAL_REQUEST
;

353 
asc
 = 
SCSI_ASC_ILLEGAL_COMMAND
;

354 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

356 
NVME_SC_INVALID_FIELD
:

357 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

358 
£n£_key
 = 
ILLEGAL_REQUEST
;

359 
asc
 = 
SCSI_ASC_INVALID_CDB
;

360 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

362 
NVME_SC_DATA_XFER_ERROR
:

363 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

364 
£n£_key
 = 
MEDIUM_ERROR
;

365 
asc
 = 
SCSI_ASC_NO_SENSE
;

366 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

368 
NVME_SC_POWER_LOSS
:

369 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

370 
£n£_key
 = 
ABORTED_COMMAND
;

371 
asc
 = 
SCSI_ASC_WARNING
;

372 
ascq
 = 
SCSI_ASCQ_POWER_LOSS_EXPECTED
;

374 
NVME_SC_INTERNAL
:

375 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

376 
£n£_key
 = 
HARDWARE_ERROR
;

377 
asc
 = 
SCSI_ASC_INTERNAL_TARGET_FAILURE
;

378 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

380 
NVME_SC_ABORT_REQ
:

381 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

382 
£n£_key
 = 
ABORTED_COMMAND
;

383 
asc
 = 
SCSI_ASC_NO_SENSE
;

384 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

386 
NVME_SC_ABORT_QUEUE
:

387 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

388 
£n£_key
 = 
ABORTED_COMMAND
;

389 
asc
 = 
SCSI_ASC_NO_SENSE
;

390 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

392 
NVME_SC_FUSED_FAIL
:

393 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

394 
£n£_key
 = 
ABORTED_COMMAND
;

395 
asc
 = 
SCSI_ASC_NO_SENSE
;

396 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

398 
NVME_SC_FUSED_MISSING
:

399 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

400 
£n£_key
 = 
ABORTED_COMMAND
;

401 
asc
 = 
SCSI_ASC_NO_SENSE
;

402 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

404 
NVME_SC_INVALID_NS
:

405 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

406 
£n£_key
 = 
ILLEGAL_REQUEST
;

407 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

408 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

410 
NVME_SC_LBA_RANGE
:

411 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

412 
£n£_key
 = 
ILLEGAL_REQUEST
;

413 
asc
 = 
SCSI_ASC_ILLEGAL_BLOCK
;

414 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

416 
NVME_SC_CAP_EXCEEDED
:

417 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

418 
£n£_key
 = 
MEDIUM_ERROR
;

419 
asc
 = 
SCSI_ASC_NO_SENSE
;

420 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

422 
NVME_SC_NS_NOT_READY
:

423 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

424 
£n£_key
 = 
NOT_READY
;

425 
asc
 = 
SCSI_ASC_LUN_NOT_READY
;

426 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

430 
NVME_SC_INVALID_FORMAT
:

431 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

432 
£n£_key
 = 
ILLEGAL_REQUEST
;

433 
asc
 = 
SCSI_ASC_FORMAT_COMMAND_FAILED
;

434 
ascq
 = 
SCSI_ASCQ_FORMAT_COMMAND_FAILED
;

436 
NVME_SC_BAD_ATTRIBUTES
:

437 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

438 
£n£_key
 = 
ILLEGAL_REQUEST
;

439 
asc
 = 
SCSI_ASC_INVALID_CDB
;

440 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

444 
NVME_SC_WRITE_FAULT
:

445 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

446 
£n£_key
 = 
MEDIUM_ERROR
;

447 
asc
 = 
SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
;

448 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

450 
NVME_SC_READ_ERROR
:

451 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

452 
£n£_key
 = 
MEDIUM_ERROR
;

453 
asc
 = 
SCSI_ASC_UNRECOVERED_READ_ERROR
;

454 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

456 
NVME_SC_GUARD_CHECK
:

457 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

458 
£n£_key
 = 
MEDIUM_ERROR
;

459 
asc
 = 
SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
;

460 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
;

462 
NVME_SC_APPTAG_CHECK
:

463 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

464 
£n£_key
 = 
MEDIUM_ERROR
;

465 
asc
 = 
SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
;

466 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
;

468 
NVME_SC_REFTAG_CHECK
:

469 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

470 
£n£_key
 = 
MEDIUM_ERROR
;

471 
asc
 = 
SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
;

472 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
;

474 
NVME_SC_COMPARE_FAILED
:

475 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

476 
£n£_key
 = 
MISCOMPARE
;

477 
asc
 = 
SCSI_ASC_MISCOMPARE_DURING_VERIFY
;

478 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

480 
NVME_SC_ACCESS_DENIED
:

481 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

482 
£n£_key
 = 
ILLEGAL_REQUEST
;

483 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

484 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

488 
NVME_SC_CMDID_CONFLICT
:

489 
NVME_SC_CMD_SEQ_ERROR
:

490 
NVME_SC_CQ_INVALID
:

491 
NVME_SC_QID_INVALID
:

492 
NVME_SC_QUEUE_SIZE
:

493 
NVME_SC_ABORT_LIMIT
:

494 
NVME_SC_ABORT_MISSING
:

495 
NVME_SC_ASYNC_LIMIT
:

496 
NVME_SC_FIRMWARE_SLOT
:

497 
NVME_SC_FIRMWARE_IMAGE
:

498 
NVME_SC_INVALID_VECTOR
:

499 
NVME_SC_INVALID_LOG_PAGE
:

501 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

502 
£n£_key
 = 
ILLEGAL_REQUEST
;

503 
asc
 = 
SCSI_ASC_NO_SENSE
;

504 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

508 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
¡©us
, 
£n£_key
, 
asc
, 
ascq
);

509  
»s
 ?„e : 
nvme_sc
;

510 
	}
}

514 
	$nvme_Œªs_¡ªd¬d_šquœy_·ge
(
nvme_ns
 *
ns
,

515 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

516 
®loc_Ën
)

518 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

519 
nvme_id_ns
 *
id_ns
;

520 
»s
;

521 
nvme_sc
;

522 
xãr_Ën
;

523 
u8
 
»¥_d©a_fÜm©
 = 0x02;

524 
u8
 
´Ùeù
;

525 
u8
 
cmdque
 = 0x01 << 1;

526 
u8
 
fw_off£t
 = (
ù¾
->
fœmw¬e_»v
);

529 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

530 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

531 ià(
»s
)

532  
»s
;

534 ià(
id_ns
->
dps
)

535 
´Ùeù
 = 0x01;

537 
´Ùeù
 = 0;

538 
	`kä“
(
id_ns
);

540 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

541 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

542 
šq_»¥Ú£
[3] = 
»¥_d©a_fÜm©
;

543 
šq_»¥Ú£
[4] = 
ADDITIONAL_STD_INQ_LENGTH
;

544 
šq_»¥Ú£
[5] = 
´Ùeù
;

545 
šq_»¥Ú£
[7] = 
cmdque
;

546 
	`¡ºıy
(&
šq_»¥Ú£
[8], "NVMe ", 8);

547 
	`¡ºıy
(&
šq_»¥Ú£
[16], 
ù¾
->
mod–
, 16);

549 
ù¾
->
fœmw¬e_»v
[
fw_off£t
 - 1] == ' ' && fw_offset > 4)

550 
fw_off£t
--;

551 
fw_off£t
 -= 4;

552 
	`¡ºıy
(&
šq_»¥Ú£
[32], 
ù¾
->
fœmw¬e_»v
 + 
fw_off£t
, 4);

554 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

555  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

556 
	}
}

558 
	$nvme_Œªs_suµÜ‹d_vpd_·ges
(
nvme_ns
 *
ns
,

559 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

560 
®loc_Ën
)

562 
xãr_Ën
;

564 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

565 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

566 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

567 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

568 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

569 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

570 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

571 
šq_»¥Ú£
[8] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

572 
šq_»¥Ú£
[9] = 
INQ_BDEV_LIMITS_PAGE
;

574 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

575  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

576 
	}
}

578 
	$nvme_Œªs_un™_£rŸl_·ge
(
nvme_ns
 *
ns
,

579 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

580 
®loc_Ën
)

582 
xãr_Ën
;

584 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

585 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

586 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

587 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
ns
->
ù¾
->
£rŸl
, 
INQ_SERIAL_NUMBER_LENGTH
);

589 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

590  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

591 
	}
}

593 
	$nvme_fl_deviû_id_eui64
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

594 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

596 
nvme_id_ns
 *
id_ns
;

597 
nvme_sc
, 
»s
;

598 
size_t
 
Ën
;

599 *
eui
;

601 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

602 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

603 ià(
»s
)

604  
»s
;

606 
eui
 = 
id_ns
->
eui64
;

607 
Ën
 = (
id_ns
->
eui64
);

609 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2)) {

610 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

611 
eui
 = 
id_ns
->
nguid
;

612 
Ën
 = (
id_ns
->
nguid
);

616 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

617 
»s
 = -
EOPNOTSUPP
;

618 
out_ä“_id
;

621 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

622 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

623 
šq_»¥Ú£
[3] = 4 + 
Ën
;

626 
šq_»¥Ú£
[4] = 0x01;

627 
šq_»¥Ú£
[5] = 0x02;

628 
šq_»¥Ú£
[6] = 0x00;

629 
šq_»¥Ú£
[7] = 
Ën
;

630 
	`memıy
(&
šq_»¥Ú£
[8], 
eui
, 
Ën
);

632 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

633 
out_ä“_id
:

634 
	`kä“
(
id_ns
);

635  
»s
;

636 
	}
}

638 
	$nvme_fl_deviû_id_scsi_¡ršg
(
nvme_ns
 *
ns
,

639 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

641 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

642 
nvme_id_ù¾
 *
id_ù¾
;

643 
nvme_sc
, 
»s
;

645 ià(
®loc_Ën
 < 72) {

646  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

647 
SAM_STAT_CHECK_CONDITION
,

648 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

649 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

652 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

653 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

654 ià(
»s
)

655  
»s
;

657 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

658 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

659 
šq_»¥Ú£
[3] = 0x48;

662 
šq_»¥Ú£
[4] = 0x03;

663 
šq_»¥Ú£
[5] = 0x08;

664 
šq_»¥Ú£
[6] = 0x00;

665 
šq_»¥Ú£
[7] = 0x44;

667 
	`¥rštf
(&
šq_»¥Ú£
[8], "%04x", 
	`Ë16_to_ıu
(
id_ù¾
->
vid
));

668 
	`memıy
(&
šq_»¥Ú£
[12], 
ù¾
->
mod–
, (ctrl->model));

669 
	`¥rštf
(&
šq_»¥Ú£
[52], "%04x", 
	`ıu_to_be32
(
ns
->
ns_id
));

670 
	`memıy
(&
šq_»¥Ú£
[56], 
ù¾
->
£rŸl
, (ctrl->serial));

672 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

673 
	`kä“
(
id_ù¾
);

674  
»s
;

675 
	}
}

677 
	$nvme_Œªs_deviû_id_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

678 
u8
 *
»¥
, 
®loc_Ën
)

680 
»s
;

682 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1)) {

683 
»s
 = 
	`nvme_fl_deviû_id_eui64
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

684 ià(
»s
 !ğ-
EOPNOTSUPP
)

685  
»s
;

688  
	`nvme_fl_deviû_id_scsi_¡ršg
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

689 
	}
}

691 
	$nvme_Œªs_ext_šq_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

692 
®loc_Ën
)

694 
u8
 *
šq_»¥Ú£
;

695 
»s
;

696 
nvme_sc
;

697 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

698 
nvme_id_ù¾
 *
id_ù¾
;

699 
nvme_id_ns
 *
id_ns
;

700 
xãr_Ën
;

701 
u8
 
miüocode
 = 0x80;

702 
u8
 
¥t
;

703 
u8
 
¥t_lut
[8] = {0, 0, 2, 1, 4, 6, 5, 7};

704 
u8
 
grd_chk
, 
­p_chk
, 
»f_chk
, 
´Ùeù
;

705 
u8
 
uask_sup
 = 0x20;

706 
u8
 
v_sup
;

707 
u8
 
luişr
 = 0x01;

709 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

710 ià(
šq_»¥Ú£
 =ğ
NULL
)

711  -
ENOMEM
;

713 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

714 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

715 ià(
»s
)

716 
out_ä“_šq
;

718 
¥t
 = 
¥t_lut
[
id_ns
->
dpc
 & 0x07] << 3;

719 ià(
id_ns
->
dps
)

720 
´Ùeù
 = 0x01;

722 
´Ùeù
 = 0;

723 
	`kä“
(
id_ns
);

725 
grd_chk
 = 
´Ùeù
 << 2;

726 
­p_chk
 = 
´Ùeù
 << 1;

727 
»f_chk
 = 
´Ùeù
;

729 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

730 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

731 ià(
»s
)

732 
out_ä“_šq
;

734 
v_sup
 = 
id_ù¾
->
vwc
;

735 
	`kä“
(
id_ù¾
);

737 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

738 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

739 
šq_»¥Ú£
[2] = 0x00;

740 
šq_»¥Ú£
[3] = 0x3C;

741 
šq_»¥Ú£
[4] = 
miüocode
 | 
¥t
 | 
grd_chk
 | 
­p_chk
 | 
»f_chk
;

742 
šq_»¥Ú£
[5] = 
uask_sup
;

743 
šq_»¥Ú£
[6] = 
v_sup
;

744 
šq_»¥Ú£
[7] = 
luişr
;

745 
šq_»¥Ú£
[8] = 0;

746 
šq_»¥Ú£
[9] = 0;

748 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

749 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

751 
out_ä“_šq
:

752 
	`kä“
(
šq_»¥Ú£
);

753  
»s
;

754 
	}
}

756 
	$nvme_Œªs_bdev_lim™s_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

757 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

759 
__be32
 
max_£ùÜs
 = 
	`ıu_to_be32
(

760 
	`nvme_block_Ä
(
ns
, 
	`queue_max_hw_£ùÜs
Òs->
queue
)));

761 
__be32
 
max_disÿrd
 = 
	`ıu_to_be32
(
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
);

762 
__be32
 
disÿrd_desc_couÁ
 = 
	`ıu_to_be32
(0x100);

764 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

765 
šq_»¥Ú£
[1] = 
VPD_BLOCK_LIMITS
;

766 
šq_»¥Ú£
[3] = 0x3c;

767 
	`memıy
(&
šq_»¥Ú£
[8], &
max_£ùÜs
, (
u32
));

768 
	`memıy
(&
šq_»¥Ú£
[20], &
max_disÿrd
, (
u32
));

770 ià(
max_disÿrd
)

771 
	`memıy
(&
šq_»¥Ú£
[24], &
disÿrd_desc_couÁ
, (
u32
));

773  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 0x3c);

774 
	}
}

776 
	$nvme_Œªs_bdev_ch¬_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

777 
®loc_Ën
)

779 
u8
 *
šq_»¥Ú£
;

780 
»s
;

781 
xãr_Ën
;

783 
šq_»¥Ú£
 = 
	`kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

784 ià(
šq_»¥Ú£
 =ğ
NULL
) {

785 
»s
 = -
ENOMEM
;

786 
out_mem
;

789 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

790 
šq_»¥Ú£
[2] = 0x00;

791 
šq_»¥Ú£
[3] = 0x3C;

792 
šq_»¥Ú£
[4] = 0x00;

793 
šq_»¥Ú£
[5] = 0x01;

794 
šq_»¥Ú£
[6] = 0x00;

796 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

797 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

799 
	`kä“
(
šq_»¥Ú£
);

800 
out_mem
:

801  
»s
;

802 
	}
}

806 
	$nvme_Œªs_log_suµ_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

807 
®loc_Ën
)

809 
»s
;

810 
xãr_Ën
;

811 
u8
 *
log_»¥Ú£
;

813 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
, 
GFP_KERNEL
);

814 ià(
log_»¥Ú£
 =ğ
NULL
) {

815 
»s
 = -
ENOMEM
;

816 
out_mem
;

819 
log_»¥Ú£
[0] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

821 
log_»¥Ú£
[3] = 
SUPPORTED_LOG_PAGES_PAGE_LENGTH
;

822 
log_»¥Ú£
[4] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

823 
log_»¥Ú£
[5] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

824 
log_»¥Ú£
[6] = 
LOG_PAGE_TEMPERATURE_PAGE
;

826 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

827 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

829 
	`kä“
(
log_»¥Ú£
);

830 
out_mem
:

831  
»s
;

832 
	}
}

834 
	$nvme_Œªs_log_šfo_exû±iÚs
(
nvme_ns
 *
ns
,

835 
sg_io_hdr
 *
hdr
, 
®loc_Ën
)

837 
»s
;

838 
xãr_Ën
;

839 
u8
 *
log_»¥Ú£
;

840 
nvme_sm¬t_log
 *
sm¬t_log
;

841 
u8
 
‹mp_c
;

842 
u16
 
‹mp_k
;

844 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_INFO_EXCP_PAGE_LENGTH
, 
GFP_KERNEL
);

845 ià(
log_»¥Ú£
 =ğ
NULL
)

846  -
ENOMEM
;

848 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

849 ià(
»s
 < 0)

850 
out_ä“_»¥Ú£
;

852 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

853 
‹mp_c
 = 
LOG_TEMP_UNKNOWN
;

855 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

856 (
sm¬t_log
->
‹m³¿tu»
[0]);

857 
‹mp_c
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

859 
	`kä“
(
sm¬t_log
);

861 
log_»¥Ú£
[0] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

863 
log_»¥Ú£
[3] = 
REMAINING_INFO_EXCP_PAGE_LENGTH
;

866 
log_»¥Ú£
[6] = 0x23;

867 
log_»¥Ú£
[7] = 0x04;

870 
log_»¥Ú£
[10] = 
‹mp_c
;

872 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_INFO_EXCP_PAGE_LENGTH
);

873 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

875 
out_ä“_»¥Ú£
:

876 
	`kä“
(
log_»¥Ú£
);

877  
»s
;

878 
	}
}

880 
	$nvme_Œªs_log_‹m³¿tu»
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

881 
®loc_Ën
)

883 
»s
;

884 
xãr_Ën
;

885 
u8
 *
log_»¥Ú£
;

886 
nvme_sm¬t_log
 *
sm¬t_log
;

887 
u32
 
ã©u»_»¥
;

888 
u8
 
‹mp_c_cur
, 
‹mp_c_th»sh
;

889 
u16
 
‹mp_k
;

891 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_TEMP_PAGE_LENGTH
, 
GFP_KERNEL
);

892 ià(
log_»¥Ú£
 =ğ
NULL
)

893  -
ENOMEM
;

895 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

896 ià(
»s
 < 0)

897 
out_ä“_»¥Ú£
;

899 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

900 
‹mp_c_cur
 = 
LOG_TEMP_UNKNOWN
;

902 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

903 (
sm¬t_log
->
‹m³¿tu»
[0]);

904 
‹mp_c_cur
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

906 
	`kä“
(
sm¬t_log
);

909 
»s
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_TEMP_THRESH
, 0, 
NULL
, 0,

910 &
ã©u»_»¥
);

911 ià(
»s
 !ğ
NVME_SC_SUCCESS
)

912 
‹mp_c_th»sh
 = 
LOG_TEMP_UNKNOWN
;

914 
‹mp_c_th»sh
 = (
ã©u»_»¥
 & 0xFFFFè- 
KELVIN_TEMP_FACTOR
;

916 
log_»¥Ú£
[0] = 
LOG_PAGE_TEMPERATURE_PAGE
;

918 
log_»¥Ú£
[3] = 
REMAINING_TEMP_PAGE_LENGTH
;

921 
log_»¥Ú£
[6] = 0x01;

922 
log_»¥Ú£
[7] = 0x02;

924 
log_»¥Ú£
[9] = 
‹mp_c_cur
;

926 
log_»¥Ú£
[11] = 0x01;

927 
log_»¥Ú£
[12] = 0x01;

928 
log_»¥Ú£
[13] = 0x02;

930 
log_»¥Ú£
[15] = 
‹mp_c_th»sh
;

932 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_TEMP_PAGE_LENGTH
);

933 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

935 
out_ä“_»¥Ú£
:

936 
	`kä“
(
log_»¥Ú£
);

937  
»s
;

938 
	}
}

942 
	$nvme_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

943 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

946 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

947  -
EINVAL
;

949 ià(
cdb10
) {

950 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

951 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

952 
»¥
[3] = 0x10 ;

953 
»¥
[4] = 
Îb¯
;

954 
»¥
[5] = 
RESERVED_FIELD
;

955 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

956 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

958 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

959 
»¥
[2] = 0x10 ;

960 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

964 
	}
}

966 
	$nvme_Œªs_fl_blk_desc
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

967 
u8
 *
»¥
, 
Ën
, u8 
Îb¯
)

969 
»s
;

970 
nvme_sc
;

971 
nvme_id_ns
 *
id_ns
;

972 
u8
 
æbas
;

973 
u32
 
lba_Ëngth
;

975 ià(
Îb¯
 =ğ0 && 
Ën
 < 
MODE_PAGE_BLK_DES_LEN
)

976  -
EINVAL
;

977 ià(
Îb¯
 > 0 && 
Ën
 < 
MODE_PAGE_LLBAA_BLK_DES_LEN
)

978  -
EINVAL
;

980 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

981 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

982 ià(
»s
)

983  
»s
;

985 
æbas
 = (
id_ns
->flbas) & 0x0F;

986 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

988 ià(
Îb¯
 == 0) {

989 
__be32
 
tmp_ÿp
 = 
	`ıu_to_be32
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

991 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
 & 0x00FFFFFF);

993 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u32
));

994 
	`memıy
(&
»¥
[4], &
tmp_Ën
, (
u32
));

996 
__be64
 
tmp_ÿp
 = 
	`ıu_to_be64
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

997 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

999 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u64
));

1001 
	`memıy
(&
»¥
[12], &
tmp_Ën
, (
u32
));

1004 
	`kä“
(
id_ns
);

1005  
»s
;

1006 
	}
}

1008 
	$nvme_Œªs_fl_cÚŒŞ_·ge
(
nvme_ns
 *
ns
,

1009 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1010 
Ën
)

1012 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

1013  -
EINVAL
;

1015 
»¥
[0] = 
MODE_PAGE_CONTROL
;

1016 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

1017 
»¥
[2] = 0x0E;

1019 
»¥
[3] = 0x12;

1021 
»¥
[5] = 0x40;

1023 
»¥
[8] = 0xFF;

1024 
»¥
[9] = 0xFF;

1028 
	}
}

1030 
	$nvme_Œªs_fl_ÿchšg_·ge
(
nvme_ns
 *
ns
,

1031 
sg_io_hdr
 *
hdr
,

1032 
u8
 *
»¥
, 
Ën
)

1034 
»s
 = 0;

1035 
nvme_sc
;

1036 
u32
 
ã©u»_»¥
;

1037 
u8
 
vwc
;

1039 ià(
Ën
 < 
MODE_PAGE_CACHING_LEN
)

1040  -
EINVAL
;

1042 
nvme_sc
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
, 0, 
NULL
, 0,

1043 &
ã©u»_»¥
);

1044 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1045 ià(
»s
)

1046  
»s
;

1048 
vwc
 = 
ã©u»_»¥
 & 0x00000001;

1050 
»¥
[0] = 
MODE_PAGE_CACHING
;

1051 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

1052 
»¥
[2] = 
vwc
 << 2;

1054 
	}
}

1056 
	$nvme_Œªs_fl_pow_úd_·ge
(
nvme_ns
 *
ns
,

1057 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1058 
Ën
)

1060 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

1061  -
EINVAL
;

1063 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

1064 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

1068 
	}
}

1070 
	$nvme_Œªs_fl_šf_exc_·ge
(
nvme_ns
 *
ns
,

1071 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1072 
Ën
)

1074 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

1075  -
EINVAL
;

1077 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

1078 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

1079 
»¥
[2] = 0x88;

1083 
	}
}

1085 
	$nvme_Œªs_fl_®l_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1086 
u8
 *
»¥
, 
Ën
)

1088 
»s
;

1089 
u16
 
mode_·ges_off£t_1
 = 0;

1090 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

1092 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

1093 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

1094 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

1096 
»s
 = 
	`nvme_Œªs_fl_ÿchšg_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_1
],

1097 
MODE_PAGE_CACHING_LEN
);

1098 ià(
»s
)

1099  
»s
;

1100 
»s
 = 
	`nvme_Œªs_fl_cÚŒŞ_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_2
],

1101 
MODE_PAGE_CONTROL_LEN
);

1102 ià(
»s
)

1103  
»s
;

1104 
»s
 = 
	`nvme_Œªs_fl_pow_úd_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_3
],

1105 
MODE_PAGE_POW_CND_LEN
);

1106 ià(
»s
)

1107  
»s
;

1108  
	`nvme_Œªs_fl_šf_exc_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_4
],

1109 
MODE_PAGE_INF_EXC_LEN
);

1110 
	}
}

1112 
šlše
 
	$nvme_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

1114 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

1116  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

1120 
	}
}

1122 
nvme_Œªs_mode_·ge_ü—‹
(
nvme_ns
 *
ns
,

1123 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
,

1124 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

1125 (*
mode_·ge_fl_func
)

1126 (
nvme_ns
 *,

1127 
sg_io_hdr
 *
hdr
, 
u8
 *, ),

1128 
u16
 
mode_·ges_tÙ_Ën
)

1130 
»s
;

1131 
xãr_Ën
;

1132 
u8
 *
»¥Ú£
;

1133 
u8
 
dbd
, 
Îb¯
;

1134 
u16
 
»¥_size
;

1135 
mph_size
;

1136 
u16
 
mode_·ges_off£t_1
;

1137 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

1139 
dbd
 = (
cmd
[1] & 
MODE_SENSE_DBD_MASK
è>> 
MODE_SENSE_DBD_SHIFT
;

1140 
Îb¯
 = (
cmd
[1] & 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
;

1141 
mph_size
 = 
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
;

1143 
blk_desc_Ën
 = 
	`nvme_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

1145 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1147 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1149 
blk_desc_off£t
 = 
mph_size
;

1150 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

1152 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

1153 ià(
»¥Ú£
 =ğ
NULL
) {

1154 
»s
 = -
ENOMEM
;

1155 
out_mem
;

1158 
»s
 = 
	`nvme_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
,

1159 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

1160 ià(
»s
)

1161 
out_ä“
;

1162 ià(
blk_desc_Ën
 > 0) {

1163 
»s
 = 
	`nvme_Œªs_fl_blk_desc
(
ns
, 
hdr
,

1164 &
»¥Ú£
[
blk_desc_off£t
],

1165 
blk_desc_Ën
, 
Îb¯
);

1166 ià(
»s
)

1167 
out_ä“
;

1169 
»s
 = 
	`mode_·ge_fl_func
(
ns
, 
hdr
, &
»¥Ú£
[
mode_·ges_off£t_1
],

1170 
mode_·ges_tÙ_Ën
);

1171 ià(
»s
)

1172 
out_ä“
;

1174 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

1175 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

1177 
out_ä“
:

1178 
	`kä“
(
»¥Ú£
);

1179 
out_mem
:

1180  
»s
;

1181 
	}
}

1185 
	$nvme_Œªs_fl_»ad_ÿp
(
u8
 *
»¥Ú£
, 
nvme_id_ns
 *
id_ns
,

1186 
u8
 
cdb16
)

1188 
u8
 
æbas
;

1189 
u32
 
lba_Ëngth
;

1190 
u64
 
¾ba
;

1191 
u8
 
´Ù_’
;

1192 
u8
 
p_ty³_lut
[4] = {0, 0, 1, 2};

1193 
__be64
 
tmp_¾ba
;

1194 
__be32
 
tmp_¾ba_32
;

1195 
__be32
 
tmp_Ën
;

1197 
æbas
 = (
id_ns
->flbas) & 0x0F;

1198 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1199 
¾ba
 = 
	`Ë64_to_ıup
(&
id_ns
->
nsze
) - 1;

1200 (
id_ns
->
dps
è? (
´Ù_’
 = 0x01) : (prot_en = 0);

1202 ià(!
cdb16
) {

1203 ià(
¾ba
 > 0xFFFFFFFF)

1204 
¾ba
 = 0xFFFFFFFF;

1205 
tmp_¾ba_32
 = 
	`ıu_to_be32
(
¾ba
);

1206 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1207 
	`memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

1208 
	`memıy
(&
»¥Ú£
[4], &
tmp_Ën
, (
u32
));

1210 
tmp_¾ba
 = 
	`ıu_to_be64
(
¾ba
);

1211 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1212 
	`memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

1213 
	`memıy
(&
»¥Ú£
[8], &
tmp_Ën
, (
u32
));

1214 
»¥Ú£
[12] = (
p_ty³_lut
[
id_ns
->
dps
 & 0x3] << 1è| 
´Ù_’
;

1219 
	}
}

1223 
	$nvme_Œªs_£nd_aùiv©e_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1224 
u8
 
bufãr_id
)

1226 
nvme_commªd
 
c
;

1227 
nvme_sc
;

1229 
	`mem£t
(&
c
, 0, (c));

1230 
c
.
commÚ
.
İcode
 = 
nvme_admš_aùiv©e_fw
;

1231 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
bufãr_id
 | 
NVME_FWACT_REPL_ACTV
);

1233 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

1234  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1235 
	}
}

1237 
	$nvme_Œªs_£nd_dowÆßd_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1238 
u8
 
İcode
, 
u32
 
tÙ_Ën
, u32 
off£t
,

1239 
u8
 
bufãr_id
)

1241 
nvme_sc
;

1242 
nvme_commªd
 
c
;

1244 ià(
hdr
->
iovec_couÁ
 > 0) {

1246  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1247 
SAM_STAT_CHECK_CONDITION
,

1248 
ILLEGAL_REQUEST
,

1249 
SCSI_ASC_INVALID_CDB
,

1250 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1253 
	`mem£t
(&
c
, 0, (c));

1254 
c
.
commÚ
.
İcode
 = 
nvme_admš_dowÆßd_fw
;

1255 
c
.
dlfw
.
numd
 = 
	`ıu_to_Ë32
((
tÙ_Ën
/
BYTES_TO_DWORDS
) - 1);

1256 
c
.
dlfw
.
off£t
 = 
	`ıu_to_Ë32
(off£t/
BYTES_TO_DWORDS
);

1258 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
ù¾
->
admš_q
, &
c
,

1259 
hdr
->
dxã½
, 
tÙ_Ën
, 
NULL
, 0);

1260  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1261 
	}
}

1265 
šlše
 
	$nvme_Œªs_mode£l_g‘_bd_Ën
(
u8
 *
·rm_li¡
, u8 
cdb10
,

1266 
u16
 *
bd_Ën
, 
u8
 *
Îb¯
)

1268 ià(
cdb10
) {

1270 *
bd_Ën
 = (
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
] << 8) +

1271 
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
 + 1];

1272 *
Îb¯
 = 
·rm_li¡
[
MODE_SELECT_10_LLBAA_OFFSET
] &

1273 
MODE_SELECT_10_LLBAA_MASK
;

1276 *
bd_Ën
 = 
·rm_li¡
[
MODE_SELECT_6_BD_OFFSET
];

1278 
	}
}

1280 
	$nvme_Œªs_mode£l_§ve_bd
(
nvme_ns
 *
ns
, 
u8
 *
·rm_li¡
,

1281 
u16
 
idx
, u16 
bd_Ën
, 
u8
 
Îb¯
)

1283 
u16
 
bd_num
;

1285 
bd_num
 = 
bd_Ën
 / ((
Îb¯
 == 0) ?

1286 
SHORT_DESC_BLOCK
 : 
LONG_DESC_BLOCK
);

1289 ià(
Îb¯
 == 0) {

1291 
ns
->
mode_£Ëù_num_blocks
 =

1292 (
·rm_li¡
[
idx
 + 1] << 16) +

1293 (
·rm_li¡
[
idx
 + 2] << 8) +

1294 (
·rm_li¡
[
idx
 + 3]);

1296 
ns
->
mode_£Ëù_block_Ën
 =

1297 (
·rm_li¡
[
idx
 + 5] << 16) +

1298 (
·rm_li¡
[
idx
 + 6] << 8) +

1299 (
·rm_li¡
[
idx
 + 7]);

1302 
ns
->
mode_£Ëù_num_blocks
 =

1303 (((
u64
)
·rm_li¡
[
idx
 + 0]) << 56) +

1304 (((
u64
)
·rm_li¡
[
idx
 + 1]) << 48) +

1305 (((
u64
)
·rm_li¡
[
idx
 + 2]) << 40) +

1306 (((
u64
)
·rm_li¡
[
idx
 + 3]) << 32) +

1307 (((
u64
)
·rm_li¡
[
idx
 + 4]) << 24) +

1308 (((
u64
)
·rm_li¡
[
idx
 + 5]) << 16) +

1309 (((
u64
)
·rm_li¡
[
idx
 + 6]) << 8) +

1310 ((
u64
)
·rm_li¡
[
idx
 + 7]);

1312 
ns
->
mode_£Ëù_block_Ën
 =

1313 (
·rm_li¡
[
idx
 + 12] << 24) +

1314 (
·rm_li¡
[
idx
 + 13] << 16) +

1315 (
·rm_li¡
[
idx
 + 14] << 8) +

1316 (
·rm_li¡
[
idx
 + 15]);

1318 
	}
}

1320 
	$nvme_Œªs_mode£l_g‘_mp
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1321 
u8
 *
mode_·ge
, u8 
·ge_code
)

1323 
»s
 = 0;

1324 
nvme_sc
;

1325 
dwÜd11
;

1327 
·ge_code
) {

1328 
MODE_PAGE_CACHING
:

1329 
dwÜd11
 = ((
mode_·ge
[2] & 
CACHING_MODE_PAGE_WCE_MASK
) ? 1 : 0);

1330 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
,

1331 
dwÜd11
, 
NULL
, 0, NULL);

1332 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1334 
MODE_PAGE_CONTROL
:

1336 
MODE_PAGE_POWER_CONDITION
:

1338 ià((
mode_·ge
[2] & 0x01) != 0 || (mode_page[3] & 0x0F) != 0) {

1339 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1340 
SAM_STAT_CHECK_CONDITION
,

1341 
ILLEGAL_REQUEST
,

1342 
SCSI_ASC_INVALID_PARAMETER
,

1343 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1348 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1349 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1350 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1354  
»s
;

1355 
	}
}

1357 
	$nvme_Œªs_mode£l_d©a
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1358 
u8
 *
cmd
, 
u16
 
·rm_li¡_Ën
, u8 
pf
,

1359 
u8
 
¥
, u8 
cdb10
)

1361 
»s
;

1362 
u8
 *
·rm_li¡
;

1363 
u16
 
bd_Ën
;

1364 
u8
 
Îb¯
 = 0;

1365 
u16
 
šdex
, 
§ved_šdex
;

1366 
u8
 
·ge_code
;

1367 
u16
 
mp_size
;

1370 
·rm_li¡
 = 
	`km®loc
(
·rm_li¡_Ën
, 
GFP_KERNEL
);

1371 ià(
·rm_li¡
 =ğ
NULL
) {

1372 
»s
 = -
ENOMEM
;

1373 
out
;

1376 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
·rm_li¡_Ën
);

1377 ià(
»s
)

1378 
out_mem
;

1380 
	`nvme_Œªs_mode£l_g‘_bd_Ën
(
·rm_li¡
, 
cdb10
, &
bd_Ën
, &
Îb¯
);

1381 
šdex
 = (
cdb10
è? (
MODE_SELECT_10_MPH_SIZE
è: (
MODE_SELECT_6_MPH_SIZE
);

1383 ià(
bd_Ën
 != 0) {

1385 
	`nvme_Œªs_mode£l_§ve_bd
(
ns
, 
·rm_li¡
, 
šdex
, 
bd_Ën
, 
Îb¯
);

1386 
šdex
 +ğ
bd_Ën
;

1388 
§ved_šdex
 = 
šdex
;

1393 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1394 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1395 ià((
·ge_code
 !ğ
MODE_PAGE_CACHING
) &&

1396 (
·ge_code
 !ğ
MODE_PAGE_CONTROL
) &&

1397 (
·ge_code
 !ğ
MODE_PAGE_POWER_CONDITION
)) {

1398 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1399 
SAM_STAT_CHECK_CONDITION
,

1400 
ILLEGAL_REQUEST
,

1401 
SCSI_ASC_INVALID_CDB
,

1402 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1403 
out_mem
;

1405 
šdex
 +ğ
mp_size
;

1406 } 
šdex
 < 
·rm_li¡_Ën
);

1409 
šdex
 = 
§ved_šdex
;

1411 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1412 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1413 
»s
 = 
	`nvme_Œªs_mode£l_g‘_mp
(
ns
, 
hdr
, &
·rm_li¡
[
šdex
],

1414 
·ge_code
);

1415 ià(
»s
)

1417 
šdex
 +ğ
mp_size
;

1418 } 
šdex
 < 
·rm_li¡_Ën
);

1420 
out_mem
:

1421 
	`kä“
(
·rm_li¡
);

1422 
out
:

1423  
»s
;

1424 
	}
}

1428 
	$nvme_Œªs_fmt_£t_blk_size_couÁ
(
nvme_ns
 *
ns
,

1429 
sg_io_hdr
 *
hdr
)

1431 
»s
 = 0;

1432 
nvme_sc
;

1433 
u8
 
æbas
;

1442 ià(
ns
->
mode_£Ëù_num_blocks
 =ğ0 ||‚s->
mode_£Ëù_block_Ën
 == 0) {

1443 
nvme_id_ns
 *
id_ns
;

1445 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1446 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1447 ià(
»s
)

1448  
»s
;

1450 ià(
ns
->
mode_£Ëù_num_blocks
 == 0)

1451 
ns
->
mode_£Ëù_num_blocks
 = 
	`Ë64_to_ıu
(
id_ns
->
nÿp
);

1452 ià(
ns
->
mode_£Ëù_block_Ën
 == 0) {

1453 
æbas
 = (
id_ns
->flbas) & 0x0F;

1454 
ns
->
mode_£Ëù_block_Ën
 =

1455 (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1458 
	`kä“
(
id_ns
);

1462 
	}
}

1464 
	$nvme_Œªs_fmt_g‘_·rm_h—d”
(
sg_io_hdr
 *
hdr
, 
u8
 
Ën
,

1465 
u8
 
fÜm©_´Ù_šfo
, u8 *
nvme_pf_code
)

1467 
»s
;

1468 
u8
 *
·rm_li¡
;

1469 
u8
 
pf_u§ge
, 
pf_code
;

1471 
·rm_li¡
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1472 ià(
·rm_li¡
 =ğ
NULL
) {

1473 
»s
 = -
ENOMEM
;

1474 
out
;

1476 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
Ën
);

1477 ià(
»s
)

1478 
out_mem
;

1480 ià((
·rm_li¡
[
FORMAT_UNIT_IMMED_OFFSET
] &

1481 
FORMAT_UNIT_IMMED_MASK
) != 0) {

1482 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1483 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1484 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1485 
out_mem
;

1488 ià(
Ën
 =ğ
FORMAT_UNIT_LONG_PARM_LIST_LEN
 &&

1489 (
·rm_li¡
[
FORMAT_UNIT_PROT_INT_OFFSET
] & 0x0F) != 0) {

1490 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1491 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1492 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1493 
out_mem
;

1495 
pf_u§ge
 = 
·rm_li¡
[
FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
] &

1496 
FORMAT_UNIT_PROT_FIELD_USAGE_MASK
;

1497 
pf_code
 = (
pf_u§ge
 << 2è| 
fÜm©_´Ù_šfo
;

1498 
pf_code
) {

1500 *
nvme_pf_code
 = 0;

1503 *
nvme_pf_code
 = 1;

1506 *
nvme_pf_code
 = 2;

1509 *
nvme_pf_code
 = 3;

1512 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1513 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1514 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1518 
out_mem
:

1519 
	`kä“
(
·rm_li¡
);

1520 
out
:

1521  
»s
;

1522 
	}
}

1524 
	$nvme_Œªs_fmt_£nd_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1525 
u8
 
´Ù_šfo
)

1527 
»s
;

1528 
nvme_sc
;

1529 
nvme_id_ns
 *
id_ns
;

1530 
u8
 
i
;

1531 
u8
 
æbas
, 
Æbaf
;

1532 
u8
 
£Ëùed_lbaf
 = 0xFF;

1533 
u32
 
cdw10
 = 0;

1534 
nvme_commªd
 
c
;

1537 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1538 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1539 ià(
»s
)

1540  
»s
;

1542 
æbas
 = (
id_ns
->flbas) & 0x0F;

1543 
Æbaf
 = 
id_ns
->nlbaf;

1545 
i
 = 0; i < 
Æbaf
; i++) {

1546 ià(
ns
->
mode_£Ëù_block_Ën
 =ğ(1 << (
id_ns
->
lbaf
[
i
].
ds
))) {

1547 
£Ëùed_lbaf
 = 
i
;

1551 ià(
£Ëùed_lbaf
 > 0x0F) {

1552 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1553 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1554 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1556 ià(
ns
->
mode_£Ëù_num_blocks
 !ğ
	`Ë64_to_ıu
(
id_ns
->
nÿp
)) {

1557 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1558 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1559 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1562 
cdw10
 |ğ
´Ù_šfo
 << 5;

1563 
cdw10
 |ğ
£Ëùed_lbaf
 & 0x0F;

1564 
	`mem£t
(&
c
, 0, (c));

1565 
c
.
fÜm©
.
İcode
 = 
nvme_admš_fÜm©_nvm
;

1566 
c
.
fÜm©
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1567 
c
.
fÜm©
.
cdw10
 = 
	`ıu_to_Ë32
(cdw10);

1569 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

1570 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1572 
	`kä“
(
id_ns
);

1573  
»s
;

1574 
	}
}

1576 
šlše
 
u32
 
	$nvme_Œªs_io_g‘_num_cmds
(
sg_io_hdr
 *
hdr
,

1577 
nvme_Œªs_io_cdb
 *
cdb_šfo
,

1578 
u32
 
max_blocks
)

1581 ià(
hdr
->
iovec_couÁ
 > 0)

1582  
hdr
->
iovec_couÁ
;

1583 ià(
cdb_šfo
->
xãr_Ën
 > 
max_blocks
)

1584  ((
cdb_šfo
->
xãr_Ën
 - 1è/ 
max_blocks
) + 1;

1587 
	}
}

1589 
u16
 
	$nvme_Œªs_io_g‘_cÚŒŞ
(
nvme_ns
 *
ns
,

1590 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1592 
u16
 
cÚŒŞ
 = 0;

1596 ià(
cdb_šfo
->
fua
 > 0)

1597 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1599  
cÚŒŞ
;

1600 
	}
}

1602 
	$nvme_Œªs_do_nvme_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1603 
nvme_Œªs_io_cdb
 *
cdb_šfo
, 
u8
 
is_wr™e
)

1605 
nvme_sc
 = 
NVME_SC_SUCCESS
;

1606 
u32
 
num_cmds
;

1607 
u64
 
un™_Ën
;

1608 
u64
 
un™_num_blocks
;

1609 
u32
 
»tcode
;

1610 
u32
 
i
 = 0;

1611 
u64
 
nvme_off£t
 = 0;

1612 
__u£r
 *
Ãxt_m­pšg_addr
;

1613 
nvme_commªd
 
c
;

1614 
u8
 
İcode
 = (
is_wr™e
 ? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1615 
u16
 
cÚŒŞ
;

1616 
u32
 
max_blocks
 = 
	`queue_max_hw_£ùÜs
(
ns
->
queue
);

1618 
num_cmds
 = 
	`nvme_Œªs_io_g‘_num_cmds
(
hdr
, 
cdb_šfo
, 
max_blocks
);

1629 
i
 = 0; i < 
num_cmds
; i++) {

1630 
	`mem£t
(&
c
, 0, (c));

1631 ià(
hdr
->
iovec_couÁ
 > 0) {

1632 
sg_iovec
 
sgl
;

1634 
»tcode
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1635 
i
 * (
sg_iovec
),

1636 (
sg_iovec
));

1637 ià(
»tcode
)

1638  -
EFAULT
;

1639 
un™_Ën
 = 
sgl
.
iov_Ën
;

1640 
un™_num_blocks
 = 
un™_Ën
 >> 
ns
->
lba_shiá
;

1641 
Ãxt_m­pšg_addr
 = 
sgl
.
iov_ba£
;

1643 
un™_num_blocks
 = 
	`mš
((
u64
)
max_blocks
,

1644 (
cdb_šfo
->
xãr_Ën
 - 
nvme_off£t
));

1645 
un™_Ën
 = 
un™_num_blocks
 << 
ns
->
lba_shiá
;

1646 
Ãxt_m­pšg_addr
 = 
hdr
->
dxã½
 +

1647 ((1 << 
ns
->
lba_shiá
è* 
nvme_off£t
);

1650 
c
.
rw
.
İcode
 = opcode;

1651 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1652 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
cdb_šfo
->
lba
 + 
nvme_off£t
);

1653 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
un™_num_blocks
 - 1);

1654 
cÚŒŞ
 = 
	`nvme_Œªs_io_g‘_cÚŒŞ
(
ns
, 
cdb_šfo
);

1655 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1657 ià(
	`g‘_ÿ·c™y
(
ns
->
disk
è- 
un™_num_blocks
 <

1658 
cdb_šfo
->
lba
 + 
nvme_off£t
) {

1659 
nvme_sc
 = 
NVME_SC_LBA_RANGE
;

1662 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1663 
Ãxt_m­pšg_addr
, 
un™_Ën
, 
NULL
, 0);

1664 ià(
nvme_sc
)

1667 
nvme_off£t
 +ğ
un™_num_blocks
;

1670  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1671 
	}
}

1676 
	$nvme_Œªs_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
, 
u8
 
is_wr™e
,

1677 
u8
 *
cmd
)

1679 
»s
 = 0;

1680 
nvme_Œªs_io_cdb
 
cdb_šfo
 = { 0, };

1681 
u8
 
İcode
 = 
cmd
[0];

1682 
u64
 
xãr_by‹s
;

1683 
u64
 
sum_iov_Ën
 = 0;

1684 
sg_iovec
 
sgl
;

1685 
i
;

1686 
size_t
 
nÙ_cİ›d
;

1692 
İcode
) {

1693 
WRITE_6
:

1694 
READ_6
:

1697 
cdb_šfo
.
fua
 = 
cmd
[1] & 0x8;

1698 
cdb_šfo
.
´Ù_šfo
 = (
cmd
[1] & 0xe0) >> 5;

1699 ià(
cdb_šfo
.
´Ù_šfo
 && !
ns
->
pi_ty³
) {

1700  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1701 
SAM_STAT_CHECK_CONDITION
,

1702 
ILLEGAL_REQUEST
,

1703 
SCSI_ASC_INVALID_CDB
,

1704 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1708 
İcode
) {

1709 
WRITE_6
:

1710 
READ_6
:

1711 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[1]);

1712 
cdb_šfo
.
xãr_Ën
 = 
cmd
[4];

1713 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1714 
cdb_šfo
.
xãr_Ën
 = 256;

1716 
WRITE_10
:

1717 
READ_10
:

1718 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1719 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1721 
WRITE_12
:

1722 
READ_12
:

1723 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1724 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

1726 
WRITE_16
:

1727 
READ_16
:

1728 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be64
(&
cmd
[2]);

1729 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

1733 
»s
 = -
EIO
;

1734 
out
;

1738 ià(
hdr
->
iovec_couÁ
 > 0) {

1739 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

1740 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1741 
i
 * (
sg_iovec
),

1742 (
sg_iovec
));

1743 ià(
nÙ_cİ›d
)

1744  -
EFAULT
;

1745 
sum_iov_Ën
 +ğ
sgl
.
iov_Ën
;

1747 ià(
sgl
.
iov_Ën
 % (1 << 
ns
->
lba_shiá
) != 0) {

1748 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1749 
SAM_STAT_CHECK_CONDITION
,

1750 
ILLEGAL_REQUEST
,

1751 
SCSI_ASC_INVALID_PARAMETER
,

1752 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1753 
out
;

1757 
sum_iov_Ën
 = 
hdr
->
dxãr_Ën
;

1761 
xãr_by‹s
 = 
	`mš
(((
u64
)
hdr
->
dxãr_Ën
), 
sum_iov_Ën
);

1764 ià(
xãr_by‹s
 !ğ(
cdb_šfo
.
xãr_Ën
 << 
ns
->
lba_shiá
)) {

1765 
»s
 = -
EINVAL
;

1766 
out
;

1770 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1771 
out
;

1774 
»s
 = 
	`nvme_Œªs_do_nvme_io
(
ns
, 
hdr
, &
cdb_šfo
, 
is_wr™e
);

1775 ià(
»s
)

1776 
out
;

1778 
out
:

1779  
»s
;

1780 
	}
}

1782 
	$nvme_Œªs_šquœy
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1783 
u8
 *
cmd
)

1785 
»s
 = 0;

1786 
u8
 
evpd
;

1787 
u8
 
·ge_code
;

1788 
®loc_Ën
;

1789 
u8
 *
šq_»¥Ú£
;

1791 
evpd
 = 
cmd
[1] & 0x01;

1792 
·ge_code
 = 
cmd
[2];

1793 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[3]);

1795 
šq_»¥Ú£
 = 
	`km®loc
(
	`max
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
),

1796 
GFP_KERNEL
);

1797 ià(
šq_»¥Ú£
 =ğ
NULL
) {

1798 
»s
 = -
ENOMEM
;

1799 
out_mem
;

1802 ià(
evpd
 == 0) {

1803 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

1804 
»s
 = 
	`nvme_Œªs_¡ªd¬d_šquœy_·ge
(
ns
, 
hdr
,

1805 
šq_»¥Ú£
, 
®loc_Ën
);

1807 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1808 
SAM_STAT_CHECK_CONDITION
,

1809 
ILLEGAL_REQUEST
,

1810 
SCSI_ASC_INVALID_CDB
,

1811 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1814 
·ge_code
) {

1815 
VPD_SUPPORTED_PAGES
:

1816 
»s
 = 
	`nvme_Œªs_suµÜ‹d_vpd_·ges
(
ns
, 
hdr
,

1817 
šq_»¥Ú£
, 
®loc_Ën
);

1819 
VPD_SERIAL_NUMBER
:

1820 
»s
 = 
	`nvme_Œªs_un™_£rŸl_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1821 
®loc_Ën
);

1823 
VPD_DEVICE_IDENTIFIERS
:

1824 
»s
 = 
	`nvme_Œªs_deviû_id_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1825 
®loc_Ën
);

1827 
VPD_EXTENDED_INQUIRY
:

1828 
»s
 = 
	`nvme_Œªs_ext_šq_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1830 
VPD_BLOCK_LIMITS
:

1831 
»s
 = 
	`nvme_Œªs_bdev_lim™s_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1832 
®loc_Ën
);

1834 
VPD_BLOCK_DEV_CHARACTERISTICS
:

1835 
»s
 = 
	`nvme_Œªs_bdev_ch¬_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1838 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1839 
SAM_STAT_CHECK_CONDITION
,

1840 
ILLEGAL_REQUEST
,

1841 
SCSI_ASC_INVALID_CDB
,

1842 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1846 
	`kä“
(
šq_»¥Ú£
);

1847 
out_mem
:

1848  
»s
;

1849 
	}
}

1851 
	$nvme_Œªs_log_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1852 
u8
 *
cmd
)

1854 
»s
;

1855 
u16
 
®loc_Ën
;

1856 
u8
 
pc
;

1857 
u8
 
·ge_code
;

1859 ià(
cmd
[1] !ğ
LOG_SENSE_CDB_SP_NOT_ENABLED
) {

1860 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1861 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1862 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1863 
out
;

1866 
·ge_code
 = 
cmd
[2] & 
LOG_SENSE_CDB_PAGE_CODE_MASK
;

1867 
pc
 = (
cmd
[2] & 
LOG_SENSE_CDB_PC_MASK
è>> 
LOG_SENSE_CDB_PC_SHIFT
;

1868 ià(
pc
 !ğ
LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
) {

1869 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1870 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1871 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1872 
out
;

1874 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1875 
·ge_code
) {

1876 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
:

1877 
»s
 = 
	`nvme_Œªs_log_suµ_·ges
(
ns
, 
hdr
, 
®loc_Ën
);

1879 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
:

1880 
»s
 = 
	`nvme_Œªs_log_šfo_exû±iÚs
(
ns
, 
hdr
, 
®loc_Ën
);

1882 
LOG_PAGE_TEMPERATURE_PAGE
:

1883 
»s
 = 
	`nvme_Œªs_log_‹m³¿tu»
(
ns
, 
hdr
, 
®loc_Ën
);

1886 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1887 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1888 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1892 
out
:

1893  
»s
;

1894 
	}
}

1896 
	$nvme_Œªs_mode_£Ëù
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1897 
u8
 *
cmd
)

1899 
u8
 
cdb10
 = 0;

1900 
u16
 
·rm_li¡_Ën
;

1901 
u8
 
·ge_fÜm©
;

1902 
u8
 
§ve_·ges
;

1904 
·ge_fÜm©
 = 
cmd
[1] & 
MODE_SELECT_CDB_PAGE_FORMAT_MASK
;

1905 
§ve_·ges
 = 
cmd
[1] & 
MODE_SELECT_CDB_SAVE_PAGES_MASK
;

1907 ià(
cmd
[0] =ğ
MODE_SELECT
) {

1908 
·rm_li¡_Ën
 = 
cmd
[4];

1910 
·rm_li¡_Ën
 = 
cmd
[7];

1911 
cdb10
 = 1;

1914 ià(
·rm_li¡_Ën
 != 0) {

1919  
	`nvme_Œªs_mode£l_d©a
(
ns
, 
hdr
, 
cmd
, 
·rm_li¡_Ën
,

1920 
·ge_fÜm©
, 
§ve_·ges
, 
cdb10
);

1924 
	}
}

1926 
	$nvme_Œªs_mode_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1927 
u8
 *
cmd
)

1929 
»s
 = 0;

1930 
u16
 
®loc_Ën
;

1931 
u8
 
cdb10
 = 0;

1933 ià(
cmd
[0] =ğ
MODE_SENSE
) {

1934 
®loc_Ën
 = 
cmd
[4];

1936 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1937 
cdb10
 = 1;

1940 ià((
cmd
[2] & 
MODE_SENSE_PAGE_CONTROL_MASK
) !=

1941 
MODE_SENSE_PC_CURRENT_VALUES
) {

1942 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1943 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1944 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1945 
out
;

1948 
cmd
[2] & 
MODE_SENSE_PAGE_CODE_MASK
) {

1949 
MODE_PAGE_CACHING
:

1950 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1951 
cdb10
,

1952 &
nvme_Œªs_fl_ÿchšg_·ge
,

1953 
MODE_PAGE_CACHING_LEN
);

1955 
MODE_PAGE_CONTROL
:

1956 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1957 
cdb10
,

1958 &
nvme_Œªs_fl_cÚŒŞ_·ge
,

1959 
MODE_PAGE_CONTROL_LEN
);

1961 
MODE_PAGE_POWER_CONDITION
:

1962 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1963 
cdb10
,

1964 &
nvme_Œªs_fl_pow_úd_·ge
,

1965 
MODE_PAGE_POW_CND_LEN
);

1967 
MODE_PAGE_INFO_EXCEP
:

1968 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1969 
cdb10
,

1970 &
nvme_Œªs_fl_šf_exc_·ge
,

1971 
MODE_PAGE_INF_EXC_LEN
);

1973 
MODE_PAGE_RETURN_ALL
:

1974 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1975 
cdb10
,

1976 &
nvme_Œªs_fl_®l_·ges
,

1977 
MODE_PAGE_ALL_LEN
);

1980 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1981 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1982 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1986 
out
:

1987  
»s
;

1988 
	}
}

1990 
	$nvme_Œªs_»ad_ÿ·c™y
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1991 
u8
 *
cmd
, u8 
cdb16
)

1993 
»s
;

1994 
nvme_sc
;

1995 
u32
 
®loc_Ën
;

1996 
u32
 
»¥_size
;

1997 
u32
 
xãr_Ën
;

1998 
nvme_id_ns
 *
id_ns
;

1999 
u8
 *
»¥Ú£
;

2001 ià(
cdb16
) {

2002 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

2003 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

2005 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

2006 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

2009 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

2010 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2011 ià(
»s
)

2012  
»s
;

2014 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2015 ià(
»¥Ú£
 =ğ
NULL
) {

2016 
»s
 = -
ENOMEM
;

2017 
out_ä“_id
;

2019 
	`nvme_Œªs_fl_»ad_ÿp
(
»¥Ú£
, 
id_ns
, 
cdb16
);

2021 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2022 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2024 
	`kä“
(
»¥Ú£
);

2025 
out_ä“_id
:

2026 
	`kä“
(
id_ns
);

2027  
»s
;

2028 
	}
}

2030 
	$nvme_Œªs_»pÜt_luns
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2031 
u8
 *
cmd
)

2033 
»s
;

2034 
nvme_sc
;

2035 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2036 
u8
 *
»¥Ú£
;

2037 
nvme_id_ù¾
 *
id_ù¾
;

2038 
u32
 
Î_Ëngth
, 
lun_id
;

2039 
u8
 
lun_id_off£t
 = 
REPORT_LUNS_FIRST_LUN_OFFSET
;

2040 
__be32
 
tmp_Ën
;

2042 
cmd
[2]) {

2044  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2045 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2046 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2047 
ALL_LUNS_RETURNED
:

2048 
ALL_WELL_KNOWN_LUNS_RETURNED
:

2049 
RESTRICTED_LUNS_RETURNED
:

2050 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ns
->
ù¾
, &
id_ù¾
);

2051 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2052 ià(
»s
)

2053  
»s
;

2055 
Î_Ëngth
 = 
	`Ë32_to_ıu
(
id_ù¾
->
Â
è* 
LUN_ENTRY_SIZE
;

2056 
»¥_size
 = 
Î_Ëngth
 + 
LUN_DATA_HEADER_SIZE
;

2058 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

2059 ià(
®loc_Ën
 < 
»¥_size
) {

2060 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2061 
SAM_STAT_CHECK_CONDITION
,

2062 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2063 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2064 
out_ä“_id
;

2067 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2068 ià(
»¥Ú£
 =ğ
NULL
) {

2069 
»s
 = -
ENOMEM
;

2070 
out_ä“_id
;

2074 
lun_id
 = 0;†un_id < 
	`Ë32_to_ıu
(
id_ù¾
->
Â
);†un_id++) {

2079 
__be64
 
tmp_id
 = 
	`ıu_to_be64
(
lun_id
);

2080 
	`memıy
(&
»¥Ú£
[
lun_id_off£t
], &
tmp_id
, (
u64
));

2081 
lun_id_off£t
 +ğ
LUN_ENTRY_SIZE
;

2083 
tmp_Ën
 = 
	`ıu_to_be32
(
Î_Ëngth
);

2084 
	`memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

2087 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2088 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2090 
	`kä“
(
»¥Ú£
);

2091 
out_ä“_id
:

2092 
	`kä“
(
id_ù¾
);

2093  
»s
;

2094 
	}
}

2096 
	$nvme_Œªs_»que¡_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2097 
u8
 *
cmd
)

2099 
»s
;

2100 
u8
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2101 
u8
 
desc_fÜm©
;

2102 
u8
 *
»¥Ú£
;

2104 
desc_fÜm©
 = 
cmd
[1] & 0x01;

2105 
®loc_Ën
 = 
cmd
[4];

2107 
»¥_size
 = ((
desc_fÜm©
è? (
DESC_FMT_SENSE_DATA_SIZE
) :

2108 (
FIXED_FMT_SENSE_DATA_SIZE
));

2109 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2110 ià(
»¥Ú£
 =ğ
NULL
) {

2111 
»s
 = -
ENOMEM
;

2112 
out
;

2115 ià(
desc_fÜm©
) {

2117 
»¥Ú£
[0] = 
DESC_FORMAT_SENSE_DATA
;

2118 
»¥Ú£
[1] = 
NO_SENSE
;

2120 
»¥Ú£
[2] = 
SCSI_ASC_NO_SENSE
;

2121 
»¥Ú£
[3] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2125 
»¥Ú£
[0] = 
FIXED_SENSE_DATA
;

2127 
»¥Ú£
[2] = 
NO_SENSE
;

2129 
»¥Ú£
[7] = 
FIXED_SENSE_DATA_ADD_LENGTH
;

2131 
»¥Ú£
[12] = 
SCSI_ASC_NO_SENSE
;

2132 
»¥Ú£
[13] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2137 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2138 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2140 
	`kä“
(
»¥Ú£
);

2141 
out
:

2142  
»s
;

2143 
	}
}

2145 
	$nvme_Œªs_£cur™y_´ÙocŞ
(
nvme_ns
 *
ns
,

2146 
sg_io_hdr
 *
hdr
,

2147 
u8
 *
cmd
)

2149  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2150 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2151 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2152 
	}
}

2154 
	$nvme_Œªs_synchrÚize_ÿche
(
nvme_ns
 *
ns
,

2155 
sg_io_hdr
 *
hdr
)

2157 
nvme_sc
;

2158 
nvme_commªd
 
c
;

2160 
	`mem£t
(&
c
, 0, (c));

2161 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2162 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2164 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

2165  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2166 
	}
}

2168 
	$nvme_Œªs_¡¬t_¡İ
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2169 
u8
 *
cmd
)

2171 
u8
 
immed
, 
pcmod
, 
no_æush
, 
¡¬t
;

2173 
immed
 = 
cmd
[1] & 0x01;

2174 
pcmod
 = 
cmd
[3] & 0x0f;

2175 
no_æush
 = 
cmd
[4] & 0x04;

2176 
¡¬t
 = 
cmd
[4] & 0x01;

2178 ià(
immed
 != 0) {

2179  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2180 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2181 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2183 ià(
no_æush
 == 0) {

2185 
»s
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2186 ià(
»s
)

2187  
»s
;

2192 
	}
}

2194 
	$nvme_Œªs_fÜm©_un™
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2195 
u8
 *
cmd
)

2197 
»s
;

2198 
u8
 
·rm_hdr_Ën
 = 0;

2199 
u8
 
nvme_pf_code
 = 0;

2200 
u8
 
fÜm©_´Ù_šfo
, 
lÚg_li¡
, 
fÜm©_d©a
;

2202 
fÜm©_´Ù_šfo
 = (
cmd
[1] & 0xc0) >> 6;

2203 
lÚg_li¡
 = 
cmd
[1] & 0x20;

2204 
fÜm©_d©a
 = 
cmd
[1] & 0x10;

2206 ià(
fÜm©_d©a
 != 0) {

2207 ià(
fÜm©_´Ù_šfo
 != 0) {

2208 ià(
lÚg_li¡
 == 0)

2209 
·rm_hdr_Ën
 = 
FORMAT_UNIT_SHORT_PARM_LIST_LEN
;

2211 
·rm_hdr_Ën
 = 
FORMAT_UNIT_LONG_PARM_LIST_LEN
;

2213 } ià(
fÜm©_d©a
 =ğ0 && 
fÜm©_´Ù_šfo
 != 0) {

2214 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2215 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2216 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2217 
out
;

2225 ià(
·rm_hdr_Ën
 > 0) {

2226 
»s
 = 
	`nvme_Œªs_fmt_g‘_·rm_h—d”
(
hdr
, 
·rm_hdr_Ën
,

2227 
fÜm©_´Ù_šfo
, &
nvme_pf_code
);

2228 ià(
»s
)

2229 
out
;

2233 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 0);

2236 
»s
 = 
	`nvme_Œªs_fmt_£t_blk_size_couÁ
(
ns
, 
hdr
);

2237 ià(
»s
)

2238 
out
;

2240 
»s
 = 
	`nvme_Œªs_fmt_£nd_cmd
(
ns
, 
hdr
, 
nvme_pf_code
);

2242 
out
:

2243  
»s
;

2244 
	}
}

2246 
	$nvme_Œªs_‹¡_un™_»ady
(
nvme_ns
 *
ns
,

2247 
sg_io_hdr
 *
hdr
,

2248 
u8
 *
cmd
)

2250 ià(
	`nvme_ù¾_»ady
(
ns
->
ù¾
))

2251  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2252 
NOT_READY
, 
SCSI_ASC_LUN_NOT_READY
,

2253 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2255  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_GOOD
, 
NO_SENSE
, 0, 0);

2256 
	}
}

2258 
	$nvme_Œªs_wr™e_bufãr
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2259 
u8
 *
cmd
)

2261 
»s
 = 0;

2262 
u32
 
bufãr_off£t
, 
·rm_li¡_Ëngth
;

2263 
u8
 
bufãr_id
, 
mode
;

2265 
·rm_li¡_Ëngth
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[6]);

2266 ià(
·rm_li¡_Ëngth
 % 
BYTES_TO_DWORDS
 != 0) {

2268 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2269 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2270 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2271 
out
;

2273 
bufãr_id
 = 
cmd
[2];

2274 ià(
bufãr_id
 > 
NVME_MAX_FIRMWARE_SLOT
) {

2275 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2276 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2277 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2278 
out
;

2280 
mode
 = 
cmd
[1] & 0x1f;

2281 
bufãr_off£t
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[3]);

2283 
mode
) {

2284 
DOWNLOAD_SAVE_ACTIVATE
:

2285 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2286 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2287 
bufãr_id
);

2288 ià(
»s
)

2289 
out
;

2290 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2292 
DOWNLOAD_SAVE_DEFER_ACTIVATE
:

2293 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2294 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2295 
bufãr_id
);

2297 
ACTIVATE_DEFERRED_MICROCODE
:

2298 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2301 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2302 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2303 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2307 
out
:

2308  
»s
;

2309 
	}
}

2311 
	sscsi_unm­_blk_desc
 {

2312 
__be64
 
	m¦ba
;

2313 
__be32
 
	mÆb
;

2314 
u32
 
	m»sv
;

2317 
	sscsi_unm­_·rm_li¡
 {

2318 
__be16
 
	munm­_d©a_Ën
;

2319 
__be16
 
	munm­_blk_desc_d©a_Ën
;

2320 
u32
 
	m»sv
;

2321 
scsi_unm­_blk_desc
 
	mdesc
[0];

2324 
	$nvme_Œªs_unm­
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2325 
u8
 *
cmd
)

2327 
scsi_unm­_·rm_li¡
 *
¶i¡
;

2328 
nvme_dsm_¿nge
 *
¿nge
;

2329 
nvme_commªd
 
c
;

2330 
i
, 
nvme_sc
, 
»s
;

2331 
u16
 
ndesc
, 
li¡_Ën
;

2333 
li¡_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

2334 ià(!
li¡_Ën
)

2335  -
EINVAL
;

2337 
¶i¡
 = 
	`km®loc
(
li¡_Ën
, 
GFP_KERNEL
);

2338 ià(!
¶i¡
)

2339  -
ENOMEM
;

2341 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
¶i¡
, 
li¡_Ën
);

2342 ià(
»s
)

2343 
out
;

2345 
ndesc
 = 
	`be16_to_ıu
(
¶i¡
->
unm­_blk_desc_d©a_Ën
) >> 4;

2346 ià(!
ndesc
 ||‚desc > 256) {

2347 
»s
 = -
EINVAL
;

2348 
out
;

2351 
¿nge
 = 
	`kÿÎoc
(
ndesc
, (*¿nge), 
GFP_KERNEL
);

2352 ià(!
¿nge
) {

2353 
»s
 = -
ENOMEM
;

2354 
out
;

2357 
i
 = 0; i < 
ndesc
; i++) {

2358 
¿nge
[
i
].
Æb
 = 
	`ıu_to_Ë32
(
	`be32_to_ıu
(
¶i¡
->
desc
[i].nlb));

2359 
¿nge
[
i
].
¦ba
 = 
	`ıu_to_Ë64
(
	`be64_to_ıu
(
¶i¡
->
desc
[i].slba));

2360 
¿nge
[
i
].
ÿ‰r
 = 0;

2363 
	`mem£t
(&
c
, 0, (c));

2364 
c
.
dsm
.
İcode
 = 
nvme_cmd_dsm
;

2365 
c
.
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2366 
c
.
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
ndesc
 - 1);

2367 
c
.
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

2369 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
¿nge
,

2370 
ndesc
 * (*
¿nge
));

2371 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2373 
	`kä“
(
¿nge
);

2374 
out
:

2375 
	`kä“
(
¶i¡
);

2376  
»s
;

2377 
	}
}

2379 
	$nvme_scsi_Œª¦©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
)

2381 
u8
 
cmd
[
BLK_MAX_CDB
];

2382 
»tcode
;

2383 
İcode
;

2385 ià(
hdr
->
cmdp
 =ğ
NULL
)

2386  -
EMSGSIZE
;

2387 ià(
	`cİy_äom_u£r
(
cmd
, 
hdr
->
cmdp
, hdr->
cmd_Ën
))

2388  -
EFAULT
;

2394 
»tcode
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2395 ià(
»tcode
)

2396  
»tcode
;

2398 
İcode
 = 
cmd
[0];

2400 
İcode
) {

2401 
READ_6
:

2402 
READ_10
:

2403 
READ_12
:

2404 
READ_16
:

2405 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 0, 
cmd
);

2407 
WRITE_6
:

2408 
WRITE_10
:

2409 
WRITE_12
:

2410 
WRITE_16
:

2411 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 1, 
cmd
);

2413 
INQUIRY
:

2414 
»tcode
 = 
	`nvme_Œªs_šquœy
(
ns
, 
hdr
, 
cmd
);

2416 
LOG_SENSE
:

2417 
»tcode
 = 
	`nvme_Œªs_log_£n£
(
ns
, 
hdr
, 
cmd
);

2419 
MODE_SELECT
:

2420 
MODE_SELECT_10
:

2421 
»tcode
 = 
	`nvme_Œªs_mode_£Ëù
(
ns
, 
hdr
, 
cmd
);

2423 
MODE_SENSE
:

2424 
MODE_SENSE_10
:

2425 
»tcode
 = 
	`nvme_Œªs_mode_£n£
(
ns
, 
hdr
, 
cmd
);

2427 
READ_CAPACITY
:

2428 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 0);

2430 
SERVICE_ACTION_IN_16
:

2431 
cmd
[1]) {

2432 
SAI_READ_CAPACITY_16
:

2433 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 1);

2436 
out
;

2439 
REPORT_LUNS
:

2440 
»tcode
 = 
	`nvme_Œªs_»pÜt_luns
(
ns
, 
hdr
, 
cmd
);

2442 
REQUEST_SENSE
:

2443 
»tcode
 = 
	`nvme_Œªs_»que¡_£n£
(
ns
, 
hdr
, 
cmd
);

2445 
SECURITY_PROTOCOL_IN
:

2446 
SECURITY_PROTOCOL_OUT
:

2447 
»tcode
 = 
	`nvme_Œªs_£cur™y_´ÙocŞ
(
ns
, 
hdr
, 
cmd
);

2449 
START_STOP
:

2450 
»tcode
 = 
	`nvme_Œªs_¡¬t_¡İ
(
ns
, 
hdr
, 
cmd
);

2452 
SYNCHRONIZE_CACHE
:

2453 
»tcode
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2455 
FORMAT_UNIT
:

2456 
»tcode
 = 
	`nvme_Œªs_fÜm©_un™
(
ns
, 
hdr
, 
cmd
);

2458 
TEST_UNIT_READY
:

2459 
»tcode
 = 
	`nvme_Œªs_‹¡_un™_»ady
(
ns
, 
hdr
, 
cmd
);

2461 
WRITE_BUFFER
:

2462 
»tcode
 = 
	`nvme_Œªs_wr™e_bufãr
(
ns
, 
hdr
, 
cmd
);

2464 
UNMAP
:

2465 
»tcode
 = 
	`nvme_Œªs_unm­
(
ns
, 
hdr
, 
cmd
);

2468 
out
:

2469 
»tcode
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2470 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2471 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2474  
»tcode
;

2475 
	}
}

2477 
	$nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
)

2479 
sg_io_hdr
 
hdr
;

2480 
»tcode
;

2482 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2483  -
EACCES
;

2484 ià(
	`cİy_äom_u£r
(&
hdr
, 
u_hdr
, (hdr)))

2485  -
EFAULT
;

2486 ià(
hdr
.
š‹rçû_id
 != 'S')

2487  -
EINVAL
;

2488 ià(
hdr
.
cmd_Ën
 > 
BLK_MAX_CDB
)

2489  -
EINVAL
;

2495 
»tcode
 = 
	`nvme_scsi_Œª¦©e
(
ns
, &
hdr
);

2496 ià(
»tcode
 < 0)

2497  
»tcode
;

2498 ià(
	`cİy_to_u£r
(
u_hdr
, &
hdr
, (
sg_io_hdr_t
)) > 0)

2499  -
EFAULT
;

2501 
	}
}

2503 
	$nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

)

2505  
	`put_u£r
(
sg_v”siÚ_num
, 

);

2506 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/´.h
>

26 
	~<lšux/±¿û.h
>

28 
	~<lšux/nvme_ioùl.h
>

31 
	~<lšux/t10-pi.h
>

32 
	~<scsi/sg.h
>

33 
	~<asm/uÇligÃd.h
>

35 
	~"nvme.h
"

38 
	~<lšux/fe.h
>

39 
	~<lšux/fdbË.h
>

40 
	~<lšux/ev’tfd.h
>

41 
	~<lšux/k»f.h
>

42 
	~<lšux/ä“z”.h
>

43 
	~<lšux/wa™.h
>

44 
	~<lšux/kth»ad.h
>

45 
	~<lšux/sk_io_accouÁšg_İs.h
>

46 
	~"lšux_nvme_ioùl.h
"

50 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

52 
	gnvme_majÜ
;

53 
moduË_·¿m
(
nvme_majÜ
, , 0);

55 
	gnvme_ch¬_majÜ
;

56 
moduË_·¿m
(
nvme_ch¬_majÜ
, , 0);

58 
LIST_HEAD
(
nvme_ù¾_li¡
);

59 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

61 
şass
 *
	gnvme_şass
;

69 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

70 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

71 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

72 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

74 
__u32
 
	gaio_cÚ‹xt_id
;

76 
	#AIOCTX_MAX
 1024

	)

77 
	#AIOCB_MAX
 (1024*64)

	)

79 
__u64
 
	gdebug_com¶‘ed
 =0;

80 
	gdebug_out¡ªdšg
 =0;

82 
	snvme_kaioùx


84 
nvme_aioùx
 
	muùx
;

85 
ev’tfd_ùx
 *
	mev’tùx
;

86 
li¡_h—d
 
	mkaiocb_li¡
;

87 
¥šlock_t
 
	mkaioùx_¥šlock
;

88 
k»f
 
	m»f
;

91 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

92 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

94 
	saio_u£r_ùx
 {

95 
	mÃÁs
;

96 
	mËn
;

97 
·ge
 ** 
	m·ges
;

98 
sÿ‰”li¡
 *
	msg
;

99 
	md©a
[1];

102 
	snvme_kaiocb


104 
li¡_h—d
 
	maiocb_li¡
;

105 
nvme_aiÛv’t
 
	mev’t
;

106 
	mİcode
;

107 
nvme_commªd
 
	mcmd
;

108 
g’disk
 *
	mdisk
;

109 
sÿ‰”li¡
 
	mm‘a_sg
;

110 
boŞ
 
	mÃed_to_cİy
;

111 
	m¡¬t_time
;

112 
boŞ
 
	mu£_m‘a
;

113 *
	mkv_d©a
;

114 *
	mm‘a
;

115 
aio_u£r_ùx
 *
	mu£r_ùx
;

116 
aio_u£r_ùx
 *
	mk”Ãl_ùx
;

117 
»que¡
 *
	m»q
;

121 
	saio_wÜk”_ùx
{

122 
	mıu
;

123 
¥šlock_t
 
	mkaiocb_¥šlock
;

124 
li¡_h—d
 
	mkaiocb_li¡
;

125 
wa™_queue_h—d_t
 
	maio_wa™queue
;

129 
aio_wÜk”_ùx
 * 
__³rıu
 
	gaio_w_ùx
;

131 
sk_¡ruù
 ** 
__³rıu
 
	gaio_wÜk”
;

135 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

137 
nvme_kaiocb
 *
tmpcb
;

138 
li¡_h—d
 *
pos
, *
q
;

139 
æags
;

140 ià(
ùx
) {

141 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

142 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

143 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

144 
	`li¡_d–
(
pos
);

145 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

147 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

148 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

149 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

151 
	}
}

153 
	$ş—nup_kaioùx
(
k»f
 *kref) {

154 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

155 
	`»move_kaioùx
(
ùx
);

156 
	}
}

158 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

159 
	`k»f_g‘
(&
ùx
->
»f
);

160 
	}
}

162 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

163 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

164 
	}
}

169 
	$de¡roy_aio_mempoŞ
()

171 
i
 = 0;

172 ià(
g_kaioùx_tb
) {

173 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

174 ià(
g_kaioùx_tb
[
i
]) {

175 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

176 
g_kaioùx_tb
[
i
] = 
NULL
;

179 
	`kä“
(
g_kaioùx_tb
);

180 
g_kaioùx_tb
 = 
NULL
;

182 ià(
kaiocb_mempoŞ
)

183 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

184 ià(
kaioùx_mempoŞ
)

185 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

186 ià(
kaioùx_ÿch•
)

187 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

188 ià(
kaiocb_ÿch•
)

189 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

190 
	}
}

195 
	$aio_£rviû_š™
()

197 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

198 ià(!
g_kaioùx_tb
)

199 
ç
;

200 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

203 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

204 ià(!
kaioùx_ÿch•
)

205 
ç
;

207 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

208 ià(!
kaiocb_ÿch•
)

209 
ç
;

211 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

212 ià(!
kaiocb_mempoŞ
)

213 
ç
;

215 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

216 ià(!
kaioùx_mempoŞ
)

217 
ç
;

221 
aio_cÚ‹xt_id
 = 1;

222 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

223 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

226 
ç
:

227 
	`de¡roy_aio_mempoŞ
();

228  -
ENOMEM
;

229 
	}
}

234 
	$aio_£rviû_ex™
()

236 
	`de¡roy_aio_mempoŞ
();

237 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

239 
	}
}

241 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

242 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

245 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

246 ià(
tmp
è
	`»f_kaioùx
(tmp);

248  
tmp
;

249 
	}
}

255 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

257 
nvme_kaioùx
 *
tmp
;

258 
æags
;

259 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

260 ià(
tmp
) {

261 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

262 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

263 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

265 
	`´_”r
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

267 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

268 
	`d”ef_kaioùx
(
tmp
);

272 
	`´_”r
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

277 
	}
}

283 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

285 
nvme_kaioùx
 
ùx
;

286 
æags
;

287 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

288  -
EFAULT
;

290 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

291 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

292 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

293 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

295 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

297 
	}
}

303 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

305 
nvme_kaioùx
 *
ùx
;

306 
fd
 
efe
;

307 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

308 
æags
;

309 
»t
 = 0;

310 
i
 = 0;

311 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

312  -
EACCES
;

314 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

315 ià(!
ùx
)

316  -
ENOMEM
;

318 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

319  -
EFAULT
;

321 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

322 ià(!
efe
.
fe
) {

323 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

324 
»t
 = -
EBADF
;

325 
ex™
;

328 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

329 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

330 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

331 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

332 
put_efe
;

335 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

336 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

337 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

338 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

339 
aio_cÚ‹xt_id
 = 
i
;

343 ià(
i
 >ğ
AIOCTX_MAX
) {

344 
	`´_”r
("nvme_set_aioctx:oo many‡ioctx open.\n");

345 
»t
 = -
EMFILE
;

346 
put_ev’t_fd
;

349 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

350 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

351 
aio_cÚ‹xt_id
 = 0;

352 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

353 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

354 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

355 
	`k»f_š™
(&
ùx
->
»f
);

356 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

357 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

359 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

361 
	`´_”r
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

362 
»t
 = -
EINVAL
;

363 
ş—nup
;

365 
ev’tfd_ùx
 = 
NULL
;

366 
debug_out¡ªdšg
 = 0;

367 
debug_com¶‘ed
 = 0;

368 
	`fdput
(
efe
);

370 
ş—nup
:

371 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

372 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

373 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

374 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

375 
put_ev’t_fd
:

376 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

377 
put_efe
:

378 
	`fdput
(
efe
);

379 
ex™
:

380  
»t
;

381 
	}
}

385 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

386 
nvme_kaiocb
 *
»q
;

387 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

388 ià(!
»q
)  0;

390 
	`mem£t
(
»q
, 0, (*req));

392 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

394 
»q
->
ev’t
.
»qid
 =„eqid;

396  
»q
;

397 
	}
}

401 
	$nvme_g‘_iÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

403 
li¡_h—d
 *
pos
, *
q
;

404 
nvme_kaiocb
 *
tmp
;

405 
nvme_kaioùx
 *
tmp_ùx
;

406 
æags
;

407 
	`LIST_HEAD
(
tmp_h—d
);

408 
__u16
 
couÁ
 =0;

409 
__u16
 
Ä
 = 0;

410 
__u32
 
ùxid
 = 0;

412 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

413  -
EACCES
;

415 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

417 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

419 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

421 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

422 ià(
tmp_ùx
) {

423 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

424 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

425 
	`li¡_d–_š™
(
pos
);

426 
	`li¡_add
(
pos
, &
tmp_h—d
);

427 
couÁ
++;

428 ià(
Ä
 =ğ
couÁ
) ;

430 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

431 
	`d”ef_kaioùx
(
tmp_ùx
);

432 
couÁ
 = 0;

433 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

434 
	`li¡_d–
(
pos
);

435 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

436 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

437 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

438 
couÁ
++;

441 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

444 
	}
}

446 
	$kv_com¶‘e_aio_â
(
nvme_kaiocb
 *
cmdšfo
) {

447 
»que¡
 *
»q
 = 
cmdšfo
->req;

448 
i
 = 0;

450 ià(
cmdšfo
->
Ãed_to_cİy
) {

454 ià(
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_™”_»ad_cmd
(cmdinfo->opcode)) {

456 *
d©a
 = 
cmdšfo
->
kv_d©a
;

457 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

459 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

460 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

462 
i
 = 0; i < 
cmdšfo
->
k”Ãl_ùx
->
ÃÁs
; i++) {

463 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
k”Ãl_ùx
->
sg
[
i
]));

466 ià(
cmdšfo
->
u£r_ùx
) {

467 ià(
	`is_kv_¡Üe_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_­³nd_cmd
(cmdinfo->opcode)) {

468 
	`g’”ic_’d_io_acù
(
WRITE
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

470 
	`g’”ic_’d_io_acù
(
READ
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

472 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++) {

473 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

476 
	`blk_mq_ä“_»que¡
(
»q
);

478 ià(
cmdšfo
->
u£_m‘a
) {

479 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

482 ià(
cmdšfo
->
Ãed_to_cİy
) {

483 
	`kä“
(
cmdšfo
->
k”Ãl_ùx
);

484 
	`kä“
(
cmdšfo
->
kv_d©a
);

486 ià(
cmdšfo
->
u£r_ùx
è
	`kä“
(cmdinfo->user_ctx);

487 ià(
cmdšfo
->
m‘a
è
	`kä“
(cmdinfo->meta);

489 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

490 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

492 
	}
}

494 
	$wake_up_aio_wÜk”
(
aio_wÜk”_ùx
 *
aio_ùx
) {

495 
	`wake_up
(&
aio_ùx
->
aio_wa™queue
);

496 
	}
}

498 
	$š£¹_aiocb_to_wÜk”
(
nvme_kaiocb
 *
aiocb
) {

499 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

500 
æags
;

501 
ıu
 = 
	`smp_´oûssÜ_id
();

502 
	`INIT_LIST_HEAD
(&
aiocb
->
aiocb_li¡
);

504 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
ıu
);

505 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

506 
	`li¡_add_
(&
aiocb
->
aiocb_li¡
, &
ùx
->
kaiocb_li¡
);

507 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

508 
	`wake_up_aio_wÜk”
(
ùx
);

510 
	}
}

512 
	$kv_async_com¶‘iÚ
(
»que¡
 *
»q
, 
”rÜ
){

513 
nvme_kaiocb
 *
aiocb
 = 
»q
->
’d_io_d©a
;

515 
aiocb
->
»q
 =„eq;

516 
aiocb
->
ev’t
.
»suÉ
 = (
u32
)(
ušŒ_t
)
»q
->
¥ecŸl
;

517 
aiocb
->
ev’t
.
¡©us
 = 
»q
->
”rÜs
;

518 
	`š£¹_aiocb_to_wÜk”
(
aiocb
);

520 
	}
}

522 
	$kvaio_³rıu_wÜk”_â
(*
¬g
) {

523 
aio_wÜk”_ùx
 *
ùx
 = (aio_wÜk”_ùx *)
¬g
;

524 
li¡_h—d
 *
pos
, *
Ãxt
;

525 
æags
;

526 
	`LIST_HEAD
(
tmp_li¡
);

527 
	`´_”r
("¡¬ˆaiØwÜk” %u\n", 
ùx
->
ıu
);

528 !
	`kth»ad_should_¡İ
(è|| !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

529 ià(
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

530 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
ùx
->
aio_wa™queue
,

531 !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
), 
HZ
/10);

534 
	`INIT_LIST_HEAD
(&
tmp_li¡
);

535 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

536 
	`li¡_¥liû
(&
ùx
->
kaiocb_li¡
, &
tmp_li¡
);

537 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

538 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

539 ià(!
	`li¡_em±y
(&
tmp_li¡
)) {

540 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, &
tmp_li¡
) {

541 
nvme_kaiocb
 *
aiocb
 = 
	`li¡_’Œy
(
pos
, nvme_kaiocb, 
aiocb_li¡
);

542 
	`li¡_d–_š™
(
pos
);

543 
	`kv_com¶‘e_aio_â
(
aiocb
);

548 
	}
}

550 
	$aio_wÜk”_š™
() {

551 
sk_¡ruù
 **
p
 = 
NULL
;

552 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

553 
i
 = 0;

555 
aio_wÜk”
 = 
	`®loc_³rıu
(
sk_¡ruù
 *);

556 ià(!
aio_wÜk”
) {

557 
	`´_”r
("failo‡lloc…ercpu workerask_struct!\n");

558  -
ENOMEM
;

560 
aio_w_ùx
 = 
	`®loc_³rıu
(
aio_wÜk”_ùx
);

561 ià(!
aio_w_ùx
) {

562 
	`´_”r
("failo‡lloc…ercpu‡io context!\n");

563 
out_ä“
;

566 
	`fÜ_—ch_Úlše_ıu
(
i
) {

567 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
i
);

568 
ùx
->
ıu
 = 
i
;

569 
	`¥š_lock_š™
(&
ùx
->
kaiocb_¥šlock
);

570 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

571 
	`š™_wa™queue_h—d
(&
ùx
->
aio_wa™queue
);

572 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

573 *
p
 = 
	`kth»ad_ü—‹_Ú_node
(
kvaio_³rıu_wÜk”_â
, 
ùx
, 
	`ıu_to_node
(
i
), "aio_completion_worker/%u", i);

574 ià(!(*
p
))

575 
»£t_±h»ad
;

576 
	`kth»ad_bšd
(*
p
, 
i
);

577 
	`wake_up_´oûss
(*
p
);

581 
»£t_±h»ad
:

582 
	`fÜ_—ch_Úlše_ıu
(
i
) {

583 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

584 ià(*
p
è
	`kth»ad_¡İ
(*p);

586 
out_ä“
:

587 ià(
aio_wÜk”
)

588 
	`ä“_³rıu
(
aio_wÜk”
);

589  -
ENOMEM
;

590 
	}
}

592 
	$aio_wÜk”_ex™
() {

593 
sk_¡ruù
 **
p
 = 
NULL
;

594 
i
 = 0;

595 
	`fÜ_—ch_Úlše_ıu
(
i
) {

596 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

597 ià(*
p
è
	`kth»ad_¡İ
(*p);

599 
	`ä“_³rıu
(
aio_wÜk”
);

600 
	`ä“_³rıu
(
aio_w_ùx
);

602 
	}
}

609 
	$nvme_ä“_ns
(
k»f
 *kref)

611 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

613 ià(
ns
->
ty³
 =ğ
NVME_NS_LIGHTNVM
)

614 
	`nvme_nvm_uÄegi¡”
(
ns
->
queue
,‚s->
disk
->
disk_Çme
);

616 
	`¥š_lock
(&
dev_li¡_lock
);

617 
ns
->
disk
->
´iv©e_d©a
 = 
NULL
;

618 
	`¥š_uÆock
(&
dev_li¡_lock
);

620 
	`nvme_put_ù¾
(
ns
->
ù¾
);

621 
	`put_disk
(
ns
->
disk
);

622 
	`kä“
(
ns
);

623 
	}
}

625 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

627 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

628 
	}
}

630 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
)

632 
nvme_ns
 *
ns
;

634 
	`¥š_lock
(&
dev_li¡_lock
);

635 
ns
 = 
disk
->
´iv©e_d©a
;

636 ià(
ns
 && !
	`k»f_g‘_uÆess_z”o
(&ns->
k»f
))

637 
ns
 = 
NULL
;

638 
	`¥š_uÆock
(&
dev_li¡_lock
);

640  
ns
;

641 
	}
}

643 
	$nvme_»queue_»q
(
»que¡
 *
»q
)

645 
æags
;

647 
	`blk_mq_»queue_»que¡
(
»q
);

648 
	`¥š_lock_œq§ve
(
»q
->
q
->
queue_lock
, 
æags
);

649 ià(!
	`blk_queue_¡İ³d
(
»q
->
q
))

650 
	`blk_mq_kick_»queue_li¡
(
»q
->
q
);

651 
	`¥š_uÆock_œq»¡Üe
(
»q
->
q
->
queue_lock
, 
æags
);

652 
	}
}

654 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

655 
nvme_commªd
 *
cmd
, 
æags
)

657 
boŞ
 
wr™e
 = 
cmd
->
commÚ
.
İcode
 & 1;

658 
»que¡
 *
»q
;

660 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
wr™e
, 
æags
);

661 ià(
	`IS_ERR
(
»q
))

662  
»q
;

664 
»q
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

665 
»q
->
cmd_æags
 |ğ
REQ_FAILFAST_DRIVER
;

666 
»q
->
__d©a_Ën
 = 0;

667 
»q
->
__£ùÜ
 = (
£ùÜ_t
) -1;

668 
»q
->
bio
 =„eq->
biÙa
 = 
NULL
;

670 
»q
->
cmd
 = (*)cmd;

671 
»q
->
cmd_Ën
 = (
nvme_commªd
);

672 
»q
->
¥ecŸl
 = (*)0;

674  
»q
;

675 
	}
}

681 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

682 *
bufãr
, 
bufæ’
, 
u32
 *
»suÉ
, 
timeout
)

684 
»que¡
 *
»q
;

685 
»t
;

687 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0);

688 ià(
	`IS_ERR
(
»q
))

689  
	`PTR_ERR
(
»q
);

691 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

693 ià(
bufãr
 && 
bufæ’
) {

694 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
GFP_KERNEL
);

695 ià(
»t
)

696 
out
;

699 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 0);

700 ià(
»suÉ
)

701 *
»suÉ
 = (
u32
)(
ušŒ_t
)
»q
->
¥ecŸl
;

702 
»t
 = 
»q
->
”rÜs
;

703 
out
:

704 
	`blk_mq_ä“_»que¡
(
»q
);

705  
»t
;

706 
	}
}

708 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

709 *
bufãr
, 
bufæ’
)

711  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
bufãr
, 
bufæ’
, 
NULL
, 0);

712 
	}
}

722 
boŞ
 
	$check_add_fÜ_sšgË_cÚt_phyadd»ss
(
__u£r
 *
add»ss
, 
Ëngth
, 
»que¡_queue
 *
q
)

724 
off£t
 = 0;

725 
couÁ
 = 0;

727 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

728 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

729 ià((
couÁ
 > 1è|| (()
add»ss
 & 
	`queue_dma_®ignm’t
(
q
))) {

731  
çl£
;

733  
Œue
;

734 
	}
}

736 
	$u£r_addr_Åages
(
off£t
, 
size
)

738 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

739  
couÁ
;

740 
	}
}

742 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
, 
boŞ
 
b_k”Ãl
)

744 
off£t
 = 
	`off£t_š_·ge
(
addr
);

745 
d©®’
 = 
Ën
;

746 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
,
Ën
);

747 
size
 = 0;

748 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

749 
m­³d_·ges
 = 0;

750 
i
 = 0;

752 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


753 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

755 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

756 ià(!
u£r_ùx
) {

757  
NULL
;

760 
u£r_ùx
->
ÃÁs
 = 0;

761 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

762 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

763 ià(
b_k”Ãl
) {

764 
·ge
 *·gğ
NULL
;

765 *
¤c_d©a
 = 
addr
;

766 
i
 = 0; i < 
num_·ge
; i++) {

767 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

768 
	`g‘_·ge
(
·ge
);

769 
u£r_ùx
->
·ges
[
i
] = 
·ge
;

770 
¤c_d©a
 +ğ
PAGE_SIZE
;

774 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

775 0, 
u£r_ùx
->
·ges
);

776 ià(
m­³d_·ges
 !ğ
num_·ge
) {

777 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

778 
ex™
;

781 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

782 
u£r_ùx
->
Ën
 = 
d©®’
;

783 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

784 
i
 = 0; i < 
num_·ge
; i++) {

785 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

786 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

787 
off£t
);

788 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

789 
off£t
 = 0;

791 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

792  
u£r_ùx
;

793 
ex™
:

794 ià(
u£r_ùx
) {

795 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

796 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

797 
	`kä“
(
u£r_ùx
);

799  
NULL
;

800 
	}
}

801 
	$__nvme_subm™_kv_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

802 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

803 
__u£r
 *
ubufãr
, 
bufæ’
,

804 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

805 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

807 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

808 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

809 
»que¡
 *
»q
;

810 
»t
 = 0;

811 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

812 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

813 
aio_u£r_ùx
 *
k”Ãl_ùx
 = 
NULL
;

814 
sÿ‰”li¡
* 
m‘a_sg_±r
;

815 
sÿ‰”li¡
 
m‘a_sg
;

816 
·ge
* 
p_·ge
 = 
NULL
;

817 
nvme_io_·¿m
* 
·¿m
 = 
NULL
;

818 *
kv_d©a
 = 
NULL
;

819 *
kv_m‘a
 = 
NULL
;

820 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

821 
i
 = 0, 
off£t
 = 0;

822 
Ën
 = 0;

823 
¡¬t_time
 = 
jiff›s
;

824 ià(!
disk
)

825  -
EFAULT
;

827 ià(
aio
) {

828 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

829 ià(!
aiocb
) {

830 
»t
 = -
ENOMEM
;

831 
out_’d
;

833 
aiocb
->
cmd
 = *cmd;

834 
aiocb
->
disk
 = disk;

835 
cmd
 = &
aiocb
->cmd;

837 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0);

838 ià(
	`IS_ERR
(
»q
)) {

839 ià(
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

840  
	`PTR_ERR
(
»q
);

843 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

845 
·¿m
 = 
	`nvme_io_·¿m
(
»q
);

846 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

847 
·¿m
->
kv_d©a_sg_±r
 = 
NULL
;

848 
·¿m
->
kv_d©a_ÃÁs
 = 0;

849 
·¿m
->
kv_d©a_Ën
 = 0;

851 ià(
ubufãr
 && 
bufæ’
) {

852 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
q
)) {

853 
Ãed_to_cİy
 = 
Œue
;

854 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

855 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

856 ià(
kv_d©a
 =ğ
NULL
) {

857 
»t
 = -
ENOMEM
;

858 
out_»q_’d
;

861 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
, 
çl£
);

862 ià(
Ãed_to_cİy
) {

863 
k”Ãl_ùx
 = 
	`g‘_aio_u£r_ùx
(
kv_d©a
, 
bufæ’
, 
Œue
);

864 ià(
k”Ãl_ùx
) {

865 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

866 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

867 
kv_d©a
, 
u£r_ùx
->
Ën
);

869 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

870 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

871 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

877 
k”Ãl_ùx
 = 
u£r_ùx
;

879 ià(
u£r_ùx
 =ğ
NULL
 || 
k”Ãl_ùx
 == NULL) {

880 
»t
 = -
ENOMEM
;

881 
out_unm­
;

883 
·¿m
->
kv_d©a_sg_±r
 = 
k”Ãl_ùx
->
sg
;

884 
·¿m
->
kv_d©a_ÃÁs
 = 
k”Ãl_ùx
->
ÃÁs
;

885 
·¿m
->
kv_d©a_Ën
 = 
k”Ãl_ùx
->
Ën
;

886 ià(
aio
) {

887 
aiocb
->
Ãed_to_cİy
 =‚eed_to_copy;

888 
aiocb
->
kv_d©a
 = kv_data;

889 
aiocb
->
k”Ãl_ùx
 = kernel_ctx;

890 
aiocb
->
u£r_ùx
 = user_ctx;

891 
aiocb
->
¡¬t_time
 = 
jiff›s
;

893 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

894 
	`g’”ic_¡¬t_io_acù
(
WRITE
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

896 
	`g’”ic_¡¬t_io_acù
(
READ
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

900 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

901 ià(
	`check_add_fÜ_sšgË_cÚt_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
, 
q
)) {

902 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 0, &
p_·ge
);

903 ià(
»t
 != 1) {

904 
»t
 = -
ENOMEM
;

905 
out_unm­
;

907 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

909 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256) * 256;

910 
kv_m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

911 ià(!
kv_m‘a
) {

912 
»t
 = -
ENOMEM
;

913 
out_unm­
;

915 ià(
	`cİy_äom_u£r
(
kv_m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

916 
»t
 = -
EFAULT
;

917 
out_ä“_m‘a
;

919 
off£t
 = 
	`off£t_š_·ge
(
kv_m‘a
);

920 
p_·ge
 = 
	`vœt_to_·ge
(
kv_m‘a
);

921 
	`g‘_·ge
(
p_·ge
);

923 ià(
aio
) {

924 
aiocb
->
u£_m‘a
 = 
Œue
;

925 
aiocb
->
m‘a
 = 
kv_m‘a
;

926 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

928 
m‘a_sg_±r
 = &
m‘a_sg
;

930 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

931 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

932 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

933 
·¿m
->
kv_m‘a_sg_±r
 = 
m‘a_sg_±r
;

935 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

938 ià(
aio
) {

939 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

940 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

941 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

942 
»q
->
’d_io_d©a
 = 
aiocb
;

943 
	`blk_execu‹_rq_nowa™
(
»q
->
q
, 
disk
,„eq, 0, 
kv_async_com¶‘iÚ
);

946 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

947 
»t
 = 
»q
->
”rÜs
;

948 ià(
»suÉ
)

949 *
»suÉ
 = (
u32
)(
ušŒ_t
)
»q
->
¥ecŸl
;

950 ià(
¡©us
)

951 *
¡©us
 = 
»q
->
”rÜs
;

952 ià(
»t
 && !
	`is_kv_™”_»q_cmd
(
cmd
->
commÚ
.
İcode
è&& !
	`is_kv_™”_»ad_cmd
(cmd->common.opcode)) {

954 
	`´_”r
("__nvme_subm™_u£r_cmd faed!!!!!: opcode(%02x)\n", 
cmd
->
commÚ
.
İcode
);

959 ià(
Ãed_to_cİy
) {

960 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

961 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || ((ret & 0x00ff) == 0x0093)))) {

963 *
d©a
 = 
kv_d©a
;

964 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

965 
d©a
[0], data[1], data[2], data[3],

966 
d©a
[4], data[5], data[6], data[7]);

968 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

969 
kv_d©a
, 
u£r_ùx
->
Ën
);

973 
out_ä“_m‘a
:

974 ià(
p_·ge
è
	`put_·ge
(p_page);

975 ià(
kv_m‘a
è
	`kä“
(kv_meta);

976 
out_unm­
:

977 ià(
u£r_ùx
) {

978 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++) {

979 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

981 
	`kä“
(
u£r_ùx
);

983 ià(
Ãed_to_cİy
) {

984 ià(
k”Ãl_ùx
) {

985 
i
 = 0; i < 
k”Ãl_ùx
->
ÃÁs
; i++) {

986 
	`put_·ge
(
	`sg_·ge
(&
k”Ãl_ùx
->
sg
[
i
]));

988 
	`kä“
(
k”Ãl_ùx
);

990 ià(
kv_d©a
è
	`kä“
(kv_data);

992 
out_»q_’d
:

993 ià(
aio
 && 
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

994 
	`blk_mq_ä“_»que¡
(
»q
);

996 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

997 
	`g’”ic_’d_io_acù
(
WRITE
, &
disk
->
·¹0
, 
¡¬t_time
);

999 
	`g’”ic_’d_io_acù
(
READ
, &
disk
->
·¹0
, 
¡¬t_time
);

1001 
out_’d
:

1002  
»t
;

1003 
	}
}

1005 
	$nvme_u£r_kv_cmd
(
nvme_ù¾
 *
ù¾
,

1006 
nvme_ns
 *
ns
,

1007 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

1009 
nvme_·s¡hru_kv_cmd
 
cmd
;

1010 
nvme_commªd
 
c
;

1011 
timeout
 = 0;

1012 
¡©us
;

1013 
__u£r
 *
m‘ad©a
 = 
NULL
;

1014 
m‘a_Ën
 = 0;

1015 
İtiÚ
 = 0;

1016 
™”_hªdË
 = 0;

1017 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1018  -
EACCES
;

1019 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1020  -
EFAULT
;

1021 ià(
cmd
.
æags
)

1022  -
EINVAL
;

1026 ià(!
	`is_kv_cmd
(
cmd
.
İcode
)) {

1027  -
EINVAL
;

1029 
	`mem£t
(&
c
, 0, (c));

1030 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1031 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1032 #ifdeà
KSID_SUPPORT


1033 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

1035 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1037 ià(
cmd
.
timeout_ms
)

1038 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1045 
cmd
.
İcode
) {

1046 
nvme_cmd_kv_¡Üe
:

1047 
nvme_cmd_kv_­³nd
:

1048 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1049 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1051 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1052 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1053 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1054 
¡©us
 = -
EINVAL
;

1055 
ex™
;

1057 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1058 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

1060 ià(
cmd
.
d©a_Ëngth
 % 4) {

1061 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

1062 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

1064 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1066 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1067 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1068 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1070 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1073 
nvme_cmd_kv_»Œ›ve
:

1074 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1075 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1077 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1078 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1079 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1080 
¡©us
 = -
EINVAL
;

1081 
ex™
;

1083 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1084 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

1085 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1087 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1088 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1089 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1091 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1094 ià(
aio
 && 
	`off£t_š_·ge
(
cmd
.
d©a_addr
)) {

1096 
¡©us
 = -
EINVAL
;

1097 
ex™
;

1101 
nvme_cmd_kv_d–‘e
:

1102 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1103 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1104 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1105 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1106 
¡©us
 = -
EINVAL
;

1107 
ex™
;

1109 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1110 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

1111 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1112 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1113 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1115 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1118 
nvme_cmd_kv_exi¡
:

1119 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1120 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1121 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1122 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1123 
¡©us
 = -
EINVAL
;

1124 
ex™
;

1126 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1127 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

1128 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1129 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1130 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1132 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1136 
nvme_cmd_kv_™”_»q
:

1137 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1138 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1139 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

1140 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

1141 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1142 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1144 
nvme_cmd_kv_™”_»ad
:

1145 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1146 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1147 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

1148 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

1149 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1152 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

1153 
¡©us
 = -
EINVAL
;

1154 
ex™
;

1163 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
, &
cmd
,

1164 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
, 0,

1165 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

1166 
ex™
:

1167 ià(!
aio
) {

1168 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1169  -
EFAULT
;

1170 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

1171  -
EFAULT
;

1173  
¡©us
;

1175 
	}
}

1177 
	$nvme_u£r_kv_aio_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1178 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
)

1180  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, 
ucmd
, 
Œue
);

1181 
	}
}

1185 
	$__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1186 
__u£r
 *
ubufãr
, 
bufæ’
,

1187 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1188 
u32
 *
»suÉ
, 
timeout
)

1190 
boŞ
 
wr™e
 = 
cmd
->
commÚ
.
İcode
 & 1;

1191 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1192 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1193 
»que¡
 *
»q
;

1194 
bio
 *biØğ
NULL
;

1195 *
m‘a
 = 
NULL
;

1196 
»t
;

1198 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0);

1199 ià(
	`IS_ERR
(
»q
))

1200  
	`PTR_ERR
(
»q
);

1202 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1204 ià(
ubufãr
 && 
bufæ’
) {

1205 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
,

1206 
GFP_KERNEL
);

1207 ià(
»t
)

1208 
out
;

1209 
bio
 = 
»q
->bio;

1211 ià(!
disk
)

1212 
subm™
;

1213 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

1214 ià(!
bio
->
bi_bdev
) {

1215 
»t
 = -
ENODEV
;

1216 
out_unm­
;

1219 ià(
m‘a_bufãr
) {

1220 
bio_š‹gr™y_·ylßd
 *
b
;

1222 
m‘a
 = 
	`km®loc
(
m‘a_Ën
, 
GFP_KERNEL
);

1223 ià(!
m‘a
) {

1224 
»t
 = -
ENOMEM
;

1225 
out_unm­
;

1228 ià(
wr™e
) {

1229 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
,

1230 
m‘a_Ën
)) {

1231 
»t
 = -
EFAULT
;

1232 
out_ä“_m‘a
;

1236 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

1237 ià(
	`IS_ERR
(
b
)) {

1238 
»t
 = 
	`PTR_ERR
(
b
);

1239 
out_ä“_m‘a
;

1242 
b
->
b_™”
.
bi_size
 = 
m‘a_Ën
;

1243 
b
->
b_™”
.
bi_£ùÜ
 = 
m‘a_£ed
;

1245 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
m‘a
),

1246 
m‘a_Ën
, 
	`off£t_š_·ge
(
m‘a
));

1247 ià(
»t
 !ğ
m‘a_Ën
) {

1248 
»t
 = -
ENOMEM
;

1249 
out_ä“_m‘a
;

1253 
subm™
:

1254 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1255 
»t
 = 
»q
->
”rÜs
;

1256 ià(
»suÉ
)

1257 *
»suÉ
 = (
u32
)(
ušŒ_t
)
»q
->
¥ecŸl
;

1258 ià(
m‘a
 && !
»t
 && !
wr™e
) {

1259 ià(
	`cİy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

1260 
»t
 = -
EFAULT
;

1262 
out_ä“_m‘a
:

1263 
	`kä“
(
m‘a
);

1264 
out_unm­
:

1265 ià(
bio
) {

1266 ià(
disk
 && 
bio
->
bi_bdev
)

1267 
	`bdput
(
bio
->
bi_bdev
);

1268 
	`blk_rq_unm­_u£r
(
bio
);

1270 
out
:

1271 
	`blk_mq_ä“_»que¡
(
»q
);

1272  
»t
;

1273 
	}
}

1275 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1276 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

1277 
timeout
)

1279  
	`__nvme_subm™_u£r_cmd
(
q
, 
cmd
, 
ubufãr
, 
bufæ’
, 
NULL
, 0, 0,

1280 
»suÉ
, 
timeout
);

1281 
	}
}

1283 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1285 
nvme_commªd
 
c
 = { };

1286 
”rÜ
;

1289 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1290 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(1);

1292 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1293 ià(!*
id
)

1294  -
ENOMEM
;

1296 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1297 (
nvme_id_ù¾
));

1298 ià(
”rÜ
)

1299 
	`kä“
(*
id
);

1300  
”rÜ
;

1301 
	}
}

1303 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1305 
nvme_commªd
 
c
 = { };

1307 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1308 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(2);

1309 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1310  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
, 0x1000);

1311 
	}
}

1313 
	$nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

1314 
nvme_id_ns
 **
id
)

1316 
nvme_commªd
 
c
 = { };

1317 
”rÜ
;

1320 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
,

1321 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid),

1323 *
id
 = 
	`km®loc
((
nvme_id_ns
), 
GFP_KERNEL
);

1324 ià(!*
id
)

1325  -
ENOMEM
;

1327 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1328 (
nvme_id_ns
));

1329 ià(
”rÜ
)

1330 
	`kä“
(*
id
);

1331  
”rÜ
;

1332 
	}
}

1334 
	$nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

1335 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
)

1337 
nvme_commªd
 
c
;

1339 
	`mem£t
(&
c
, 0, (c));

1340 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_g‘_ã©u»s
;

1341 
c
.
ã©u»s
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1342 
c
.
ã©u»s
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1343 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1345  
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
NULL
, 0, 
»suÉ
, 0);

1346 
	}
}

1348 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1349 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
)

1351 
nvme_commªd
 
c
;

1353 
	`mem£t
(&
c
, 0, (c));

1354 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1355 
c
.
ã©u»s
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
dma_addr
);

1356 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1357 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1359  
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
NULL
, 0, 
»suÉ
, 0);

1360 
	}
}

1362 
	$nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
)

1364 
nvme_commªd
 
c
 = { };

1365 
”rÜ
;

1367 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
,

1368 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF),

1369 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(

1370 ((((
nvme_sm¬t_log
) / 4) - 1) << 16) |

1371 
NVME_LOG_SMART
),

1373 *
log
 = 
	`km®loc
((
nvme_sm¬t_log
), 
GFP_KERNEL
);

1374 ià(!*
log
)

1375  -
ENOMEM
;

1377 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
log
,

1378 (
nvme_sm¬t_log
));

1379 ià(
”rÜ
)

1380 
	`kä“
(*
log
);

1381  
”rÜ
;

1382 
	}
}

1384 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1386 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1387 
u32
 
»suÉ
;

1388 
¡©us
, 
Ä_io_queues
;

1390 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 0,

1391 &
»suÉ
);

1392 ià(
¡©us
)

1393  
¡©us
;

1395 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

1396 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

1398 
	}
}

1400 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1402 
nvme_u£r_io
 
io
;

1403 
nvme_commªd
 
c
;

1404 
Ëngth
, 
m‘a_Ën
;

1405 
__u£r
 *
m‘ad©a
;

1407 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

1408  -
EFAULT
;

1410 
io
.
İcode
) {

1411 
nvme_cmd_wr™e
:

1412 
nvme_cmd_»ad
:

1413 
nvme_cmd_com·»
:

1416  -
EINVAL
;

1419 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1420 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1421 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

1423 ià(
ns
->
ext
) {

1424 
Ëngth
 +ğ
m‘a_Ën
;

1425 
m‘a_Ën
 = 0;

1426 } ià(
m‘a_Ën
) {

1427 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

1428  -
EINVAL
;

1431 
	`mem£t
(&
c
, 0, (c));

1432 
c
.
rw
.
İcode
 = 
io
.opcode;

1433 
c
.
rw
.
æags
 = 
io
.flags;

1434 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1435 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

1436 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

1437 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

1438 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

1439 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

1440 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

1441 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

1443  
	`__nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1444 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

1445 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

1446 
	}
}

1448 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1449 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

1451 
nvme_·s¡hru_cmd
 
cmd
;

1452 
nvme_commªd
 
c
;

1453 
timeout
 = 0;

1454 
¡©us
;

1456 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1457  -
EACCES
;

1458 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1459  -
EFAULT
;

1461 ià(
	`is_kv_cmd
(
cmd
.
İcode
))

1462  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, (
nvme_·s¡hru_kv_cmd
 
__u£r
 *)
ucmd
, 
çl£
);

1464 
	`mem£t
(&
c
, 0, (c));

1465 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1466 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1467 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1468 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

1469 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

1470 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

1471 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

1472 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1473 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1474 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

1475 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

1477 ià(
cmd
.
timeout_ms
)

1478 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1480 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

1481 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

1482 &
cmd
.
»suÉ
, 
timeout
);

1483 ià(
¡©us
 >= 0) {

1484 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1485  -
EFAULT
;

1488  
¡©us
;

1489 
	}
}

1491 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1492 
cmd
, 
¬g
)

1494 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1496 
cmd
) {

1497 
NVME_IOCTL_ID
:

1498 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

1499  
ns
->
ns_id
;

1500 
NVME_IOCTL_ADMIN_CMD
:

1501  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

1502 
NVME_IOCTL_IO_CMD
:

1503  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1504 
NVME_IOCTL_SUBMIT_IO
:

1505  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

1507 
NVME_IOCTL_IO_KV_CMD
:

1508  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
çl£
);

1509 
NVME_IOCTL_AIO_CMD
:

1510  
	`nvme_u£r_kv_aio_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1511 
NVME_IOCTL_SET_AIOCTX
:

1512  
	`nvme_£t_aioùx
((
__u£r
*)
¬g
);

1513 
NVME_IOCTL_DEL_AIOCTX
:

1514  
	`nvme_d–_aioùx
((
__u£r
*)
¬g
);

1515 
NVME_IOCTL_GET_AIOEVENT
:

1516  
	`nvme_g‘_iÛv’ts
((
__u£r
*)
¬g
);

1518 #ifdeà
CONFIG_BLK_DEV_NVME_SCSI


1519 
SG_GET_VERSION_NUM
:

1520  
	`nvme_sg_g‘_v”siÚ_num
((
__u£r
 *)
¬g
);

1521 
SG_IO
:

1522  
	`nvme_sg_io
(
ns
, (
__u£r
 *)
¬g
);

1525  -
ENOTTY
;

1527 
	}
}

1529 #ifdeà
CONFIG_COMPAT


1530 
	$nvme_com·t_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1531 
cmd
, 
¬g
)

1533 
cmd
) {

1534 
SG_IO
:

1535  -
ENOIOCTLCMD
;

1537  
	`nvme_ioùl
(
bdev
, 
mode
, 
cmd
, 
¬g
);

1538 
	}
}

1540 
	#nvme_com·t_ioùl
 
NULL


	)

1543 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

1545  
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
è? 0 : -
ENXIO
;

1546 
	}
}

1548 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

1550 
	`nvme_put_ns
(
disk
->
´iv©e_d©a
);

1551 
	}
}

1553 
	$nvme_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

1556 
geo
->
h—ds
 = 1 << 6;

1557 
geo
->
£ùÜs
 = 1 << 5;

1558 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bdev
->
bd_disk
) >> 11;

1560 
	}
}

1562 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


1563 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1565 
blk_š‹gr™y
 
š‹gr™y
;

1567 
ns
->
pi_ty³
) {

1568 
NVME_NS_DPS_PI_TYPE3
:

1569 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³3_üc
;

1571 
NVME_NS_DPS_PI_TYPE1
:

1572 
NVME_NS_DPS_PI_TYPE2
:

1573 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³1_üc
;

1576 
š‹gr™y
.
´ofe
 = 
NULL
;

1579 
š‹gr™y
.
tu¶e_size
 = 
ns
->
ms
;

1580 
	`blk_š‹gr™y_»gi¡”
(
ns
->
disk
, &
š‹gr™y
);

1581 
	`blk_queue_max_š‹gr™y_£gm’ts
(
ns
->
queue
, 1);

1582 
	}
}

1584 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1586 
	}
}

1589 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

1591 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1592 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

1594 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DISCARD_ZEROES
)

1595 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 1;

1597 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

1599 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

1600 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

1601 
	`blk_queue_max_disÿrd_£ùÜs
(
ns
->
queue
, 0xffffffff);

1602 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

1603 
	}
}

1605 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

1607 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1608 
nvme_id_ns
 *
id
;

1609 
u8
 
lbaf
, 
pi_ty³
;

1610 
u16
 
Şd_ms
;

1611 
bs
;

1613 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

1614 
	`£t_ÿ·c™y
(
disk
, 0);

1615  -
ENODEV
;

1617 ià(
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id
)) {

1618 
	`dev_w¬n
(
ns
->
ù¾
->
dev
, "%s: Identify failure‚vme%dn%d\n",

1619 
__func__
, 
ns
->
ù¾
->
š¡ªû
,‚s->
ns_id
);

1620  -
ENODEV
;

1622 ià(
id
->
nÿp
 == 0) {

1623 
	`kä“
(
id
);

1624  -
ENODEV
;

1627 ià(
	`nvme_nvm_ns_suµÜ‹d
(
ns
, 
id
è&&‚s->
ty³
 !ğ
NVME_NS_LIGHTNVM
) {

1628 ià(
	`nvme_nvm_»gi¡”
(
ns
->
queue
, 
disk
->
disk_Çme
)) {

1629 
	`dev_w¬n
(
ns
->
ù¾
->
dev
,

1630 "%s: LightNVM in™ fau»\n", 
__func__
);

1631 
	`kä“
(
id
);

1632  -
ENODEV
;

1634 
ns
->
ty³
 = 
NVME_NS_LIGHTNVM
;

1637 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1))

1638 
	`memıy
(
ns
->
eui
, 
id
->
eui64
, (ns->eui));

1639 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2))

1640 
	`memıy
(
ns
->
uuid
, 
id
->
nguid
, (ns->uuid));

1642 
Şd_ms
 = 
ns
->
ms
;

1643 
lbaf
 = 
id
->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
;

1644 
ns
->
lba_shiá
 = 
id
->
lbaf
[lbaf].
ds
;

1645 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[lbaf].ms);

1646 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

1652 ià(
ns
->
lba_shiá
 == 0)

1653 
ns
->
lba_shiá
 = 9;

1654 
bs
 = 1 << 
ns
->
lba_shiá
;

1656 
pi_ty³
 = 
ns
->
ms
 =ğ(
t10_pi_tu¶e
) ?

1657 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
 : 0;

1659 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

1660 ià(
	`blk_g‘_š‹gr™y
(
disk
è&& (
ns
->
pi_ty³
 !=…i_type ||

1661 
ns
->
ms
 !ğ
Şd_ms
 ||

1662 
bs
 !ğ
	`queue_logiÿl_block_size
(
disk
->
queue
) ||

1663 (
ns
->
ms
 &&‚s->
ext
)))

1664 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

1666 
ns
->
pi_ty³
 =…i_type;

1667 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 
bs
);

1669 ià(
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
è&& !ns->
ext
)

1670 
	`nvme_š™_š‹gr™y
(
ns
);

1671 ià(
ns
->
ms
 && !Òs->m =ğ8 &&‚s->
pi_ty³
è&& !
	`blk_g‘_š‹gr™y
(
disk
))

1672 
	`£t_ÿ·c™y
(
disk
, 0);

1674 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

1676 ià(
ns
->
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

1677 
	`nvme_cÚfig_disÿrd
(
ns
);

1678 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

1680 
	`kä“
(
id
);

1682 
	}
}

1684 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

1686 
ty³
) {

1687 
PR_WRITE_EXCLUSIVE
:

1689 
PR_EXCLUSIVE_ACCESS
:

1691 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

1693 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

1695 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

1697 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

1702 
	}
};

1704 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

1705 
u64
 
key
, u64 
§_key
, 
u8
 
İ
)

1707 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1708 
nvme_commªd
 
c
;

1709 
u8
 
d©a
[16] = { 0, };

1711 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

1712 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

1714 
	`mem£t
(&
c
, 0, (c));

1715 
c
.
commÚ
.
İcode
 = 
İ
;

1716 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1717 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

1719  
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

1720 
	}
}

1722 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Şd
,

1723 
u64
 
Ãw
, 
æags
)

1725 
u32
 
cdw10
;

1727 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

1728  -
EOPNOTSUPP
;

1730 
cdw10
 = 
Şd
 ? 2 : 0;

1731 
cdw10
 |ğ(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

1732 
cdw10
 |= (1 << 30) | (1 << 31);

1733  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

1734 
	}
}

1736 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

1737 
´_ty³
 
ty³
, 
æags
)

1739 
u32
 
cdw10
;

1741 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

1742  -
EOPNOTSUPP
;

1744 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

1745 
cdw10
 |ğ((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

1746  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

1747 
	}
}

1749 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Şd
, u64 
Ãw
,

1750 
´_ty³
 
ty³
, 
boŞ
 
abÜt
)

1752 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
abÜt
 ? 2 : 1;

1753  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

1754 
	}
}

1756 
	$nvme_´_ş—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

1758 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

1759  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

1760 
	}
}

1762 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

1764 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
key
 ? 1 << 3 : 0;

1765  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

1766 
	}
}

1768 cÚ¡ 
´_İs
 
	gnvme_´_İs
 = {

1769 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

1770 .
	g´_»£rve
 = 
nvme_´_»£rve
,

1771 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

1772 .
	g´_´“m±
 = 
nvme_´_´“m±
,

1773 .
	g´_ş—r
 = 
nvme_´_ş—r
,

1776 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

1777 .
owÃr
 = 
THIS_MODULE
,

1778 .
	gioùl
 = 
nvme_ioùl
,

1779 .
	gcom·t_ioùl
 = 
nvme_com·t_ioùl
,

1780 .
	gİ’
 = 
nvme_İ’
,

1781 .
	g»Ëa£
 = 
nvme_»Ëa£
,

1782 .
	gg‘geo
 = 
nvme_g‘geo
,

1783 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

1784 .
	g´_İs
 = &
nvme_´_İs
,

1787 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

1789 
timeout
 =

1790 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

1791 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

1792 
»t
;

1794 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

1795 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ğ
b™
)

1798 
	`m¦“p
(100);

1799 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1800  -
EINTR
;

1801 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1802 
	`dev_”r
(
ù¾
->
dev
,

1803 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

1805  -
ENODEV
;

1809  
»t
;

1810 
	}
}

1818 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

1820 
»t
;

1822 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1823 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

1825 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1826 ià(
»t
)

1827  
»t
;

1834 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
è&& cŒl->
g£t
)

1835 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

1837  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

1838 
	}
}

1840 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

1847 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

1848 
»t
;

1850 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

1851 
	`dev_”r
(
ù¾
->
dev
,

1853 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

1854  -
ENODEV
;

1857 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

1859 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

1860 
ù¾
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

1861 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

1862 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

1863 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

1865 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1866 ià(
»t
)

1867  
»t
;

1868  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

1869 
	}
}

1871 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

1873 
timeout
 = 
SHUTDOWN_TIMEOUT
 + 
jiff›s
;

1874 
u32
 
c¡s
;

1875 
»t
;

1877 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

1878 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

1880 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

1881 ià(
»t
)

1882  
»t
;

1884 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

1885 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ğ
NVME_CSTS_SHST_CMPLT
)

1888 
	`m¦“p
(100);

1889 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

1890  -
EINTR
;

1891 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

1892 
	`dev_”r
(
ù¾
->
dev
,

1894  -
ENODEV
;

1898  
»t
;

1899 
	}
}

1901 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

1902 
»que¡_queue
 *
q
)

1904 ià(
ù¾
->
max_hw_£ùÜs
) {

1905 
u32
 
max_£gm’ts
 =

1906 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

1908 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

1909 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

1911 ià(
ù¾
->
¡re_size
)

1912 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
¡re_size
 >> 9);

1913 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

1914 
	`blk_queue_æush
(
q
, 
REQ_FLUSH
 | 
REQ_FUA
);

1915 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

1916 
	}
}

1923 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

1925 
nvme_id_ù¾
 *
id
;

1926 
u64
 
ÿp
;

1927 
»t
, 
·ge_shiá
;

1929 
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

1930 ià(
»t
) {

1931 
	`dev_”r
(
ù¾
->
dev
, "R—dšg VS faed (%d)\n", 
»t
);

1932  
»t
;

1935 
»t
 = 
ù¾
->
İs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

1936 ià(
»t
) {

1937 
	`dev_”r
(
ù¾
->
dev
, "R—dšg CAP faed (%d)\n", 
»t
);

1938  
»t
;

1940 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

1942 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1))

1943 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

1945 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

1946 ià(
»t
) {

1947 
	`dev_”r
(
ù¾
->
dev
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»t
);

1948  -
EIO
;

1951 
ù¾
->
Úcs
 = 
	`Ë16_to_ıup
(&
id
->oncs);

1952 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aş
 + 1);

1953 
ù¾
->
vwc
 = 
id
->vwc;

1954 
	`memıy
(
ù¾
->
£rŸl
, 
id
->
¢
, (id->sn));

1955 
	`memıy
(
ù¾
->
mod–
, 
id
->
mn
, (id->mn));

1956 
	`memıy
(
ù¾
->
fœmw¬e_»v
, 
id
->
ä
, (id->fr));

1957 ià(
id
->
mdts
)

1958 
ù¾
->
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

1960 
ù¾
->
max_hw_£ùÜs
 = 
UINT_MAX
;

1962 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
è&& 
id
->
vs
[3]) {

1963 
max_hw_£ùÜs
;

1965 
ù¾
->
¡re_size
 = 1 << (
id
->
vs
[3] + 
·ge_shiá
);

1966 
max_hw_£ùÜs
 = 
ù¾
->
¡re_size
 >> (
·ge_shiá
 - 9);

1967 ià(
ù¾
->
max_hw_£ùÜs
) {

1968 
ù¾
->
max_hw_£ùÜs
 = 
	`mš
(max_hw_sectors,

1969 
ù¾
->
max_hw_£ùÜs
);

1971 
ù¾
->
max_hw_£ùÜs
 = max_hw_sectors;

1975 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

1977 
	`kä“
(
id
);

1979 
	}
}

1981 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *file)

1983 
nvme_ù¾
 *
ù¾
;

1984 
š¡ªû
 = 
	`imšÜ
(
šode
);

1985 
»t
 = -
ENODEV
;

1987 
	`¥š_lock
(&
dev_li¡_lock
);

1988 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_ù¾_li¡
, 
node
) {

1989 ià(
ù¾
->
š¡ªû
 != instance)

1992 ià(!
ù¾
->
admš_q
) {

1993 
»t
 = -
EWOULDBLOCK
;

1996 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
k»f
))

1998 
fe
->
´iv©e_d©a
 = 
ù¾
;

1999 
»t
 = 0;

2002 
	`¥š_uÆock
(&
dev_li¡_lock
);

2004  
»t
;

2005 
	}
}

2007 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

2009 
	`nvme_put_ù¾
(
fe
->
´iv©e_d©a
);

2011 
	}
}

2013 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

2015 
nvme_ns
 *
ns
;

2016 
»t
;

2018 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2019 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

2020 
»t
 = -
ENOTTY
;

2021 
out_uÆock
;

2024 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

2025 ià(
ns
 !ğ
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

2026 
	`dev_w¬n
(
ù¾
->
dev
,

2028 
»t
 = -
EINVAL
;

2029 
out_uÆock
;

2032 
	`dev_w¬n
(
ù¾
->
dev
,

2034 
	`k»f_g‘
(&
ns
->
k»f
);

2035 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2037 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

2038 
	`nvme_put_ns
(
ns
);

2039  
»t
;

2041 
out_uÆock
:

2042 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2043  
»t
;

2044 
	}
}

2046 
	$nvme_dev_ioùl
(
fe
 *fe, 
cmd
,

2047 
¬g
)

2049 
nvme_ù¾
 *
ù¾
 = 
fe
->
´iv©e_d©a
;

2050 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

2052 
cmd
) {

2053 
NVME_IOCTL_ADMIN_CMD
:

2054  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

2055 
NVME_IOCTL_IO_CMD
:

2056  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

2057 
NVME_IOCTL_RESET
:

2058 
	`dev_w¬n
(
ù¾
->
dev
, "resetting controller\n");

2059  
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2060 
NVME_IOCTL_SUBSYS_RESET
:

2061  
	`nvme_»£t_subsy¡em
(
ù¾
);

2063  -
ENOTTY
;

2065 
	}
}

2067 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

2068 .
owÃr
 = 
THIS_MODULE
,

2069 .
	gİ’
 = 
nvme_dev_İ’
,

2070 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

2071 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

2072 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

2075 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

2076 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2077 
size_t
 
couÁ
)

2079 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2080 
»t
;

2082 
»t
 = 
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2083 ià(
»t
 < 0)

2084  
»t
;

2085  
couÁ
;

2086 
	}
}

2087 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

2089 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2090 *
buf
)

2092 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2093  
	`¥rštf
(
buf
, "%pU\n", 
ns
->
uuid
);

2094 
	}
}

2095 
DEVICE_ATTR
(
uuid
, 
S_IRUGO
, 
uuid_show
, 
NULL
);

2097 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2098 *
buf
)

2100 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2101  
	`¥rštf
(
buf
, "%8phd\n", 
ns
->
eui
);

2102 
	}
}

2103 
DEVICE_ATTR
(
eui
, 
S_IRUGO
, 
eui_show
, 
NULL
);

2105 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2106 *
buf
)

2108 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2109  
	`¥rštf
(
buf
, "%d\n", 
ns
->
ns_id
);

2110 
	}
}

2111 
DEVICE_ATTR
(
nsid
, 
S_IRUGO
, 
nsid_show
, 
NULL
);

2113 
©Œibu‹
 *
	gnvme_ns_©Œs
[] = {

2114 &
dev_©Œ_uuid
.
©Œ
,

2115 &
dev_©Œ_eui
.
©Œ
,

2116 &
dev_©Œ_nsid
.
©Œ
,

2117 
NULL
,

2120 
umode_t
 
	$nvme_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2121 
©Œibu‹
 *
a
, 
n
)

2123 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2124 
nvme_ns
 *
ns
 = 
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

2126 ià(
a
 =ğ&
dev_©Œ_uuid
.
©Œ
) {

2127 ià(!
	`memchr_šv
(
ns
->
uuid
, 0, (ns->uuid)))

2130 ià(
a
 =ğ&
dev_©Œ_eui
.
©Œ
) {

2131 ià(!
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

2134  
a
->
mode
;

2135 
	}
}

2137 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_©Œ_group
 = {

2138 .
©Œs
 = 
nvme_ns_©Œs
,

2139 .
	gis_visibË
 = 
nvme_©Œs_¬e_visibË
,

2142 
	#nvme_show_funùiÚ
(
f›ld
) \

2143 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2144 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2146 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2147  
	`¥rštf
(
buf
, "%.*s\n", ()(
ù¾
->
f›ld
), ctrl->field); \

2149 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2151 
nvme_show_funùiÚ
(
mod–
);

2152 
nvme_show_funùiÚ
(
£rŸl
);

2153 
nvme_show_funùiÚ
(
fœmw¬e_»v
);

2155 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

2156 &
dev_©Œ_»£t_cÚŒŞËr
.
©Œ
,

2157 &
dev_©Œ_mod–
.
©Œ
,

2158 &
dev_©Œ_£rŸl
.
©Œ
,

2159 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

2160 
NULL


2163 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

2164 .
©Œs
 = 
nvme_dev_©Œs
,

2167 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

2168 &
nvme_dev_©Œs_group
,

2169 
NULL
,

2172 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

2174 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

2175 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

2177  
n§
->
ns_id
 - 
nsb
->ns_id;

2178 
	}
}

2180 
nvme_ns
 *
	$nvme_fšd_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2182 
nvme_ns
 *
ns
;

2184 
	`lockd•_as£¹_h–d
(&
ù¾
->
Çme¥aûs_mu‹x
);

2186 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2187 ià(
ns
->
ns_id
 =ğ
nsid
)

2188  
ns
;

2189 ià(
ns
->
ns_id
 > 
nsid
)

2192  
NULL
;

2193 
	}
}

2195 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2197 
nvme_ns
 *
ns
;

2198 
g’disk
 *
disk
;

2199 
node
 = 
	`dev_to_node
(
ù¾
->
dev
);

2201 
	`lockd•_as£¹_h–d
(&
ù¾
->
Çme¥aûs_mu‹x
);

2203 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

2204 ià(!
ns
)

2207 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

2208 ià(
	`IS_ERR
(
ns
->
queue
))

2209 
out_ä“_ns
;

2210 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NOMERGES
, 
ns
->
queue
);

2211 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

2212 
ns
->
queue
->
queued©a
 =‚s;

2213 
ns
->
ù¾
 = ctrl;

2215 
disk
 = 
	`®loc_disk_node
(0, 
node
);

2216 ià(!
disk
)

2217 
out_ä“_queue
;

2219 
	`k»f_š™
(&
ns
->
k»f
);

2220 
ns
->
ns_id
 = 
nsid
;

2221 
ns
->
disk
 = disk;

2222 
ns
->
lba_shiá
 = 9;

2225 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

2226 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

2228 
disk
->
majÜ
 = 
nvme_majÜ
;

2229 
disk
->
fœ¡_mšÜ
 = 0;

2230 
disk
->
fİs
 = &
nvme_fİs
;

2231 
disk
->
´iv©e_d©a
 = 
ns
;

2232 
disk
->
queue
 = 
ns
->queue;

2233 
disk
->
driv”fs_dev
 = 
ù¾
->
deviû
;

2234 
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

2235 
	`¥rštf
(
disk
->
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
nsid
);

2237 ià(
	`nvme_»v®id©e_disk
(
ns
->
disk
))

2238 
out_ä“_disk
;

2240 
	`li¡_add_
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

2241 
	`k»f_g‘
(&
ù¾
->
k»f
);

2242 ià(
ns
->
ty³
 =ğ
NVME_NS_LIGHTNVM
)

2245 
	`add_disk
(
ns
->
disk
);

2246 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2247 &
nvme_ns_©Œ_group
))

2248 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

2249 
ns
->
disk
->
disk_Çme
);

2251 
out_ä“_disk
:

2252 
	`kä“
(
disk
);

2253 
out_ä“_queue
:

2254 
	`blk_ş—nup_queue
(
ns
->
queue
);

2255 
out_ä“_ns
:

2256 
	`kä“
(
ns
);

2257 
	}
}

2259 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

2261 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

2264 ià(
ns
->
disk
->
æags
 & 
GENHD_FL_UP
) {

2265 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

2266 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

2267 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2268 &
nvme_ns_©Œ_group
);

2269 
	`d–_g’disk
(
ns
->
disk
);

2270 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

2271 
	`blk_ş—nup_queue
(
ns
->
queue
);

2273 
	`mu‹x_lock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2274 
	`li¡_d–_š™
(&
ns
->
li¡
);

2275 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2276 
	`nvme_put_ns
(
ns
);

2277 
	}
}

2279 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2281 
nvme_ns
 *
ns
;

2283 
ns
 = 
	`nvme_fšd_ns
(
ù¾
, 
nsid
);

2284 ià(
ns
) {

2285 ià(
	`»v®id©e_disk
(
ns
->
disk
))

2286 
	`nvme_ns_»move
(
ns
);

2288 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

2289 
	}
}

2291 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

2293 
nvme_ns
 *
ns
;

2294 
__Ë32
 *
ns_li¡
;

2295 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

2296 
»t
 = 0;

2298 
ns_li¡
 = 
	`kz®loc
(0x1000, 
GFP_KERNEL
);

2299 ià(!
ns_li¡
)

2300  -
ENOMEM
;

2302 
i
 = 0; i < 
num_li¡s
; i++) {

2303 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

2304 ià(
»t
)

2305 
out
;

2307 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

2308 
nsid
 = 
	`Ë32_to_ıu
(
ns_li¡
[
j
]);

2309 ià(!
nsid
)

2310 
out
;

2312 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

2314 ++
´ev
 < 
nsid
) {

2315 
ns
 = 
	`nvme_fšd_ns
(
ù¾
, 
´ev
);

2316 ià(
ns
)

2317 
	`nvme_ns_»move
(
ns
);

2320 
Â
 -ğ
j
;

2322 
out
:

2323 
	`kä“
(
ns_li¡
);

2324  
»t
;

2325 
	}
}

2327 
	$__nvme_sÿn_Çme¥aûs
(
nvme_ù¾
 *
ù¾
, 
Â
)

2329 
nvme_ns
 *
ns
, *
Ãxt
;

2330 
i
;

2332 
	`lockd•_as£¹_h–d
(&
ù¾
->
Çme¥aûs_mu‹x
);

2334 
i
 = 1; i <ğ
Â
; i++)

2335 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

2337 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2338 ià(
ns
->
ns_id
 > 
Â
)

2339 
	`nvme_ns_»move
(
ns
);

2341 
	}
}

2343 
	$nvme_sÿn_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

2345 
nvme_id_ù¾
 *
id
;

2346 
Â
;

2348 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

2351 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2352 
Â
 = 
	`Ë32_to_ıu
(
id
->nn);

2353 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1) &&

2354 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

2355 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

2356 
dÚe
;

2358 
	`__nvme_sÿn_Çme¥aûs
(
ù¾
, 
	`Ë32_to_ıup
(&
id
->
Â
));

2359 
dÚe
:

2360 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

2361 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2362 
	`kä“
(
id
);

2363 
	}
}

2365 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

2367 
nvme_ns
 *
ns
, *
Ãxt
;

2369 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
)

2370 
	`nvme_ns_»move
(
ns
);

2371 
	}
}

2373 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

2375 
	$nvme_£t_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2377 
š¡ªû
, 
”rÜ
;

2380 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

2381  -
ENODEV
;

2383 
	`¥š_lock
(&
dev_li¡_lock
);

2384 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

2385 
	`¥š_uÆock
(&
dev_li¡_lock
);

2386 } 
”rÜ
 =ğ-
EAGAIN
);

2388 ià(
”rÜ
)

2389  -
ENODEV
;

2391 
ù¾
->
š¡ªû
 = instance;

2393 
	}
}

2395 
	$nvme_»Ëa£_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2397 
	`¥š_lock
(&
dev_li¡_lock
);

2398 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

2399 
	`¥š_uÆock
(&
dev_li¡_lock
);

2400 
	}
}

2402 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

2404 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
));

2406 
	`¥š_lock
(&
dev_li¡_lock
);

2407 
	`li¡_d–
(&
ù¾
->
node
);

2408 
	`¥š_uÆock
(&
dev_li¡_lock
);

2409 
	}
}

2411 
	$nvme_ä“_ù¾
(
k»f
 *kref)

2413 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
k»f
, nvme_ctrl, kref);

2415 
	`put_deviû
(
ù¾
->
deviû
);

2416 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

2418 
ù¾
->
İs
->
	`ä“_ù¾
(ctrl);

2419 
	}
}

2421 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

2423 
	`k»f_put
(&
ù¾
->
k»f
, 
nvme_ä“_ù¾
);

2424 
	}
}

2431 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

2432 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
)

2434 
»t
;

2436 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

2437 
	`mu‹x_š™
(&
ù¾
->
Çme¥aûs_mu‹x
);

2438 
	`k»f_š™
(&
ù¾
->
k»f
);

2439 
ù¾
->
dev
 = dev;

2440 
ù¾
->
İs
 = ops;

2441 
ù¾
->
quœks
 = quirks;

2443 
»t
 = 
	`nvme_£t_š¡ªû
(
ù¾
);

2444 ià(
»t
)

2445 
out
;

2447 
ù¾
->
deviû
 = 
	`deviû_ü—‹_w™h_groups
(
nvme_şass
, cŒl->
dev
,

2448 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
),

2449 
dev
, 
nvme_dev_©Œ_groups
,

2450 "nvme%d", 
ù¾
->
š¡ªû
);

2451 ià(
	`IS_ERR
(
ù¾
->
deviû
)) {

2452 
»t
 = 
	`PTR_ERR
(
ù¾
->
deviû
);

2453 
out_»Ëa£_š¡ªû
;

2455 
	`g‘_deviû
(
ù¾
->
deviû
);

2456 
	`dev_£t_drvd©a
(
ù¾
->
deviû
, ctrl);

2458 
	`¥š_lock
(&
dev_li¡_lock
);

2459 
	`li¡_add_
(&
ù¾
->
node
, &
nvme_ù¾_li¡
);

2460 
	`¥š_uÆock
(&
dev_li¡_lock
);

2463 
out_»Ëa£_š¡ªû
:

2464 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

2465 
out
:

2466  
»t
;

2467 
	}
}

2476 
	$nvme_kl_queues
(
nvme_ù¾
 *
ù¾
)

2478 
nvme_ns
 *
ns
;

2480 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2481 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2482 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

2489 ià(!
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &
ns
->
æags
))

2490 
	`»v®id©e_disk
(
ns
->
disk
);

2492 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

2493 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

2494 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

2496 
	`nvme_put_ns
(
ns
);

2498 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2499 
	}
}

2501 
	$nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
)

2503 
nvme_ns
 *
ns
;

2505 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2506 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2507 
	`¥š_lock_œq
(
ns
->
queue
->
queue_lock
);

2508 
	`queue_æag_£t
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

2509 
	`¥š_uÆock_œq
(
ns
->
queue
->
queue_lock
);

2511 
	`blk_mq_ÿnûl_»queue_wÜk
(
ns
->
queue
);

2512 
	`blk_mq_¡İ_hw_queues
(
ns
->
queue
);

2514 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2515 
	}
}

2517 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

2519 
nvme_ns
 *
ns
;

2521 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2522 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2523 
	`queue_æag_ş—r_uÆocked
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

2524 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

2525 
	`blk_mq_kick_»queue_li¡
(
ns
->
queue
);

2527 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2528 
	}
}

2530 
__š™
 
	$nvme_cÜe_š™
()

2532 
»suÉ
;

2534 
»suÉ
 = 
	`»gi¡”_blkdev
(
nvme_majÜ
, "nvme");

2535 ià(
»suÉ
 < 0)

2536  
»suÉ
;

2537 ià(
»suÉ
 > 0)

2538 
nvme_majÜ
 = 
»suÉ
;

2540 
»suÉ
 = 
	`__»gi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme",

2541 &
nvme_dev_fİs
);

2542 ià(
»suÉ
 < 0)

2543 
uÄegi¡”_blkdev
;

2544 ià(
»suÉ
 > 0)

2545 
nvme_ch¬_majÜ
 = 
»suÉ
;

2547 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

2548 ià(
	`IS_ERR
(
nvme_şass
)) {

2549 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

2550 
uÄegi¡”_chrdev
;

2553 
»suÉ
 = 
	`aio_£rviû_š™
();

2554 ià(
»suÉ
)

2555 
uÄegi¡”_chrdev
;

2557 
»suÉ
 = 
	`aio_wÜk”_š™
();

2558 ià(
»suÉ
)

2559 
uÄegi¡”_aio_£rviû
;

2563 
uÄegi¡”_aio_£rviû
:

2564 
	`aio_£rviû_ex™
();

2566 
uÄegi¡”_chrdev
:

2567 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

2568 
uÄegi¡”_blkdev
:

2569 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

2570  
»suÉ
;

2571 
	}
}

2573 
	$nvme_cÜe_ex™
()

2575 
	`uÄegi¡”_blkdev
(
nvme_majÜ
, "nvme");

2576 
	`şass_de¡roy
(
nvme_şass
);

2577 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

2579 
	`aio_wÜk”_ex™
();

2580 
	`aio_£rviû_ex™
();

2582 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/lightnvm.c

23 
	~"nvme.h
"

25 
	~"lšux_nvme.h
"

27 
	~<lšux/nvme.h
>

29 
	~<lšux/b™İs.h
>

30 
	~<lšux/lighŠvm.h
>

31 
	~<lšux/vm®loc.h
>

33 
	envme_nvm_admš_İcode
 {

34 
	mnvme_nvm_admš_id’t™y
 = 0xe2,

35 
	mnvme_nvm_admš_g‘_l2p_tbl
 = 0xea,

36 
	mnvme_nvm_admš_g‘_bb_tbl
 = 0xf2,

37 
	mnvme_nvm_admš_£t_bb_tbl
 = 0xf1,

40 
	snvme_nvm_hb_rw
 {

41 
__u8
 
	mİcode
;

42 
__u8
 
	mæags
;

43 
__u16
 
	mcommªd_id
;

44 
__Ë32
 
	mnsid
;

45 
__u64
 
	mrsvd2
;

46 
__Ë64
 
	mm‘ad©a
;

47 
__Ë64
 
	m´p1
;

48 
__Ë64
 
	m´p2
;

49 
__Ë64
 
	m¥ba
;

50 
__Ë16
 
	mËngth
;

51 
__Ë16
 
	mcÚŒŞ
;

52 
__Ë32
 
	mdsmgmt
;

53 
__Ë64
 
	m¦ba
;

56 
	snvme_nvm_ph_rw
 {

57 
__u8
 
	mİcode
;

58 
__u8
 
	mæags
;

59 
__u16
 
	mcommªd_id
;

60 
__Ë32
 
	mnsid
;

61 
__u64
 
	mrsvd2
;

62 
__Ë64
 
	mm‘ad©a
;

63 
__Ë64
 
	m´p1
;

64 
__Ë64
 
	m´p2
;

65 
__Ë64
 
	m¥ba
;

66 
__Ë16
 
	mËngth
;

67 
__Ë16
 
	mcÚŒŞ
;

68 
__Ë32
 
	mdsmgmt
;

69 
__Ë64
 
	m»sv
;

72 
	snvme_nvm_id’t™y
 {

73 
__u8
 
	mİcode
;

74 
__u8
 
	mæags
;

75 
__u16
 
	mcommªd_id
;

76 
__Ë32
 
	mnsid
;

77 
__u64
 
	mrsvd
[2];

78 
__Ë64
 
	m´p1
;

79 
__Ë64
 
	m´p2
;

80 
__Ë32
 
	mchÆ_off
;

81 
__u32
 
	mrsvd11
[5];

84 
	snvme_nvm_l2±bl
 {

85 
__u8
 
	mİcode
;

86 
__u8
 
	mæags
;

87 
__u16
 
	mcommªd_id
;

88 
__Ë32
 
	mnsid
;

89 
__Ë32
 
	mcdw2
[4];

90 
__Ë64
 
	m´p1
;

91 
__Ë64
 
	m´p2
;

92 
__Ë64
 
	m¦ba
;

93 
__Ë32
 
	mÆb
;

94 
__Ë16
 
	mcdw14
[6];

97 
	snvme_nvm_g‘bbtbl
 {

98 
__u8
 
	mİcode
;

99 
__u8
 
	mæags
;

100 
__u16
 
	mcommªd_id
;

101 
__Ë32
 
	mnsid
;

102 
__u64
 
	mrsvd
[2];

103 
__Ë64
 
	m´p1
;

104 
__Ë64
 
	m´p2
;

105 
__Ë64
 
	m¥ba
;

106 
__u32
 
	mrsvd4
[4];

109 
	snvme_nvm_£tbbtbl
 {

110 
__u8
 
	mİcode
;

111 
__u8
 
	mæags
;

112 
__u16
 
	mcommªd_id
;

113 
__Ë32
 
	mnsid
;

114 
__Ë64
 
	mrsvd
[2];

115 
__Ë64
 
	m´p1
;

116 
__Ë64
 
	m´p2
;

117 
__Ë64
 
	m¥ba
;

118 
__Ë16
 
	mÆb
;

119 
__u8
 
	mv®ue
;

120 
__u8
 
	mrsvd3
;

121 
__u32
 
	mrsvd4
[3];

124 
	snvme_nvm_”a£_blk
 {

125 
__u8
 
	mİcode
;

126 
__u8
 
	mæags
;

127 
__u16
 
	mcommªd_id
;

128 
__Ë32
 
	mnsid
;

129 
__u64
 
	mrsvd
[2];

130 
__Ë64
 
	m´p1
;

131 
__Ë64
 
	m´p2
;

132 
__Ë64
 
	m¥ba
;

133 
__Ë16
 
	mËngth
;

134 
__Ë16
 
	mcÚŒŞ
;

135 
__Ë32
 
	mdsmgmt
;

136 
__Ë64
 
	m»sv
;

139 
	snvme_nvm_commªd
 {

141 
nvme_commÚ_commªd
 
	mcommÚ
;

142 
nvme_nvm_id’t™y
 
	mid’t™y
;

143 
nvme_nvm_hb_rw
 
	mhb_rw
;

144 
nvme_nvm_ph_rw
 
	mph_rw
;

145 
nvme_nvm_l2±bl
 
	ml2p
;

146 
nvme_nvm_g‘bbtbl
 
	mg‘_bb
;

147 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

148 
nvme_nvm_”a£_blk
 
	m”a£
;

152 
	snvme_nvm_Í_mlc
 {

153 
__u16
 
	mnum_·œs
;

154 
__u8
 
	m·œs
[886];

157 
	snvme_nvm_Í_tbl
 {

158 
__u8
 
	mid
[8];

159 
nvme_nvm_Í_mlc
 
	mmlc
;

162 
	snvme_nvm_id_group
 {

163 
__u8
 
	mmty³
;

164 
__u8
 
	mfmty³
;

165 
__Ë16
 
	m»s16
;

166 
__u8
 
	mnum_ch
;

167 
__u8
 
	mnum_lun
;

168 
__u8
 
	mnum_¶n
;

169 
__u8
 
	mrsvd1
;

170 
__Ë16
 
	mnum_blk
;

171 
__Ë16
 
	mnum_pg
;

172 
__Ë16
 
	måg_sz
;

173 
__Ë16
 
	mc£cs
;

174 
__Ë16
 
	msos
;

175 
__Ë16
 
	mrsvd2
;

176 
__Ë32
 
	mŒdt
;

177 
__Ë32
 
	mŒdm
;

178 
__Ë32
 
	m¹
;

179 
__Ë32
 
	mrm
;

180 
__Ë32
 
	mtb‘
;

181 
__Ë32
 
	mtbem
;

182 
__Ë32
 
	mmpos
;

183 
__Ë32
 
	mmcÿp
;

184 
__Ë16
 
	mı¬
;

185 
__u8
 
	m»£rved
[10];

186 
nvme_nvm_Í_tbl
 
	mÍtbl
;

187 } 
	g__·cked
;

189 
	snvme_nvm_addr_fÜm©
 {

190 
__u8
 
	mch_off£t
;

191 
__u8
 
	mch_Ën
;

192 
__u8
 
	mlun_off£t
;

193 
__u8
 
	mlun_Ën
;

194 
__u8
 
	m¶n_off£t
;

195 
__u8
 
	m¶n_Ën
;

196 
__u8
 
	mblk_off£t
;

197 
__u8
 
	mblk_Ën
;

198 
__u8
 
	mpg_off£t
;

199 
__u8
 
	mpg_Ën
;

200 
__u8
 
	m£ù_off£t
;

201 
__u8
 
	m£ù_Ën
;

202 
__u8
 
	m»s
[4];

203 } 
	g__·cked
;

205 
	snvme_nvm_id
 {

206 
__u8
 
	mv”_id
;

207 
__u8
 
	mvmÁ
;

208 
__u8
 
	mcg½s
;

209 
__u8
 
	m»s
;

210 
__Ë32
 
	mÿp
;

211 
__Ë32
 
	mdom
;

212 
nvme_nvm_addr_fÜm©
 
	mµaf
;

213 
__u8
 
	m»sv
[228];

214 
nvme_nvm_id_group
 
	mgroups
[4];

215 } 
	g__·cked
;

217 
	snvme_nvm_bb_tbl
 {

218 
__u8
 
	mtblid
[4];

219 
__Ë16
 
	mv”id
;

220 
__Ë16
 
	m»vid
;

221 
__Ë32
 
	mrvsd1
;

222 
__Ë32
 
	mtblks
;

223 
__Ë32
 
	mtçù
;

224 
__Ë32
 
	mtgrown
;

225 
__Ë32
 
	mtd»sv
;

226 
__Ë32
 
	mth»sv
;

227 
__Ë32
 
	mrsvd2
[8];

228 
__u8
 
	mblk
[0];

234 
šlše
 
	$_nvme_nvm_check_size
()

236 
	`BUILD_BUG_ON
((
nvme_nvm_id’t™y
) != 64);

237 
	`BUILD_BUG_ON
((
nvme_nvm_hb_rw
) != 64);

238 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

239 
	`BUILD_BUG_ON
((
nvme_nvm_g‘bbtbl
) != 64);

240 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

241 
	`BUILD_BUG_ON
((
nvme_nvm_l2±bl
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_nvm_”a£_blk
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_nvm_id_group
) != 960);

244 
	`BUILD_BUG_ON
((
nvme_nvm_addr_fÜm©
) != 128);

245 
	`BUILD_BUG_ON
((
nvme_nvm_id
) != 4096);

246 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 512);

247 
	}
}

249 
	$š™_g½s
(
nvm_id
 *nvm_id, 
nvme_nvm_id
 *nvme_nvm_id)

251 
nvme_nvm_id_group
 *
¤c
;

252 
nvm_id_group
 *
d¡
;

253 
i
, 
’d
;

255 
’d
 = 
	`mš_t
(
u32
, 4, 
nvm_id
->
cg½s
);

257 
i
 = 0; i < 
’d
; i++) {

258 
¤c
 = &
nvme_nvm_id
->
groups
[
i
];

259 
d¡
 = &
nvm_id
->
groups
[
i
];

261 
d¡
->
mty³
 = 
¤c
->mtype;

262 
d¡
->
fmty³
 = 
¤c
->fmtype;

263 
d¡
->
num_ch
 = 
¤c
->num_ch;

264 
d¡
->
num_lun
 = 
¤c
->num_lun;

265 
d¡
->
num_¶n
 = 
¤c
->num_pln;

267 
d¡
->
num_pg
 = 
	`Ë16_to_ıu
(
¤c
->num_pg);

268 
d¡
->
num_blk
 = 
	`Ë16_to_ıu
(
¤c
->num_blk);

269 
d¡
->
åg_sz
 = 
	`Ë16_to_ıu
(
¤c
->fpg_sz);

270 
d¡
->
c£cs
 = 
	`Ë16_to_ıu
(
¤c
->csecs);

271 
d¡
->
sos
 = 
	`Ë16_to_ıu
(
¤c
->sos);

273 
d¡
->
Œdt
 = 
	`Ë32_to_ıu
(
¤c
->trdt);

274 
d¡
->
Œdm
 = 
	`Ë32_to_ıu
(
¤c
->trdm);

275 
d¡
->
¹
 = 
	`Ë32_to_ıu
(
¤c
->tprt);

276 
d¡
->
rm
 = 
	`Ë32_to_ıu
(
¤c
->tprm);

277 
d¡
->
tb‘
 = 
	`Ë32_to_ıu
(
¤c
->tbet);

278 
d¡
->
tbem
 = 
	`Ë32_to_ıu
(
¤c
->tbem);

279 
d¡
->
mpos
 = 
	`Ë32_to_ıu
(
¤c
->mpos);

280 
d¡
->
mcÿp
 = 
	`Ë32_to_ıu
(
¤c
->mccap);

282 
d¡
->
ı¬
 = 
	`Ë16_to_ıu
(
¤c
->cpar);

284 ià(
d¡
->
fmty³
 =ğ
NVM_ID_FMTYPE_MLC
) {

285 
	`memıy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

286 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

287 
	`Ë16_to_ıu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

289 
	`memıy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

290 
d¡
->
Ítbl
.
mlc
.
num_·œs
 >> 1);

295 
	}
}

297 
	$nvme_nvm_id’t™y
(
nvm_dev
 *
nvmdev
, 
nvm_id
 *nvm_id)

299 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

300 
nvme_nvm_id
 *nvme_nvm_id;

301 
nvme_nvm_commªd
 
c
 = {};

302 
»t
;

304 
c
.
id’t™y
.
İcode
 = 
nvme_nvm_admš_id’t™y
;

305 
c
.
id’t™y
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

306 
c
.
id’t™y
.
chÆ_off
 = 0;

308 
nvme_nvm_id
 = 
	`km®loc
((nvme_nvm_id), 
GFP_KERNEL
);

309 ià(!
nvme_nvm_id
)

310  -
ENOMEM
;

312 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

313 
nvme_nvm_id
, (nvme_nvm_id));

314 ià(
»t
) {

315 
»t
 = -
EIO
;

316 
out
;

319 
nvm_id
->
v”_id
 = 
nvme_nvm_id
->ver_id;

320 
nvm_id
->
vmÁ
 = 
nvme_nvm_id
->vmnt;

321 
nvm_id
->
cg½s
 = 
nvme_nvm_id
->cgrps;

322 
nvm_id
->
ÿp
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->cap);

323 
nvm_id
->
dom
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->dom);

324 
	`memıy
(&
nvm_id
->
µaf
, &
nvme_nvm_id
->ppaf,

325 (
nvme_nvm_addr_fÜm©
));

327 
»t
 = 
	`š™_g½s
(
nvm_id
, 
nvme_nvm_id
);

328 
out
:

329 
	`kä“
(
nvme_nvm_id
);

330  
»t
;

331 
	}
}

333 
	$nvme_nvm_g‘_l2p_tbl
(
nvm_dev
 *
nvmdev
, 
u64
 
¦ba
, 
u32
 
Æb
,

334 
nvm_l2p_upd©e_â
 *
upd©e_l2p
, *
´iv
)

336 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

337 
nvme_nvm_commªd
 
c
 = {};

338 
u32
 
Ën
 = 
	`queue_max_hw_£ùÜs
(
ns
->
ù¾
->
admš_q
) << 9;

339 
u32
 
Æb_´_rq
 = 
Ën
 / (
u64
);

340 
u64
 
cmd_¦ba
 = 
¦ba
;

341 *
’Œ›s
;

342 
»t
 = 0;

344 
c
.
l2p
.
İcode
 = 
nvme_nvm_admš_g‘_l2p_tbl
;

345 
c
.
l2p
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

346 
’Œ›s
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

347 ià(!
’Œ›s
)

348  -
ENOMEM
;

350 
Æb
) {

351 
u32
 
cmd_Æb
 = 
	`mš
(
Æb_´_rq
, 
Æb
);

353 
c
.
l2p
.
¦ba
 = 
	`ıu_to_Ë64
(
cmd_¦ba
);

354 
c
.
l2p
.
Æb
 = 
	`ıu_to_Ë32
(
cmd_Æb
);

356 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
,

357 (
nvme_commªd
 *)&
c
, 
’Œ›s
, 
Ën
);

358 ià(
»t
) {

359 
	`dev_”r
(
ns
->
ù¾
->
dev
, "L2Pableransfer failed (%d)\n",

360 
»t
);

361 
»t
 = -
EIO
;

362 
out
;

365 ià(
	`upd©e_l2p
(
cmd_¦ba
, 
cmd_Æb
, 
’Œ›s
, 
´iv
)) {

366 
»t
 = -
EINTR
;

367 
out
;

370 
cmd_¦ba
 +ğ
cmd_Æb
;

371 
Æb
 -ğ
cmd_Æb
;

374 
out
:

375 
	`kä“
(
’Œ›s
);

376  
»t
;

377 
	}
}

379 
	$nvme_nvm_g‘_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

380 
Ä_blocks
, 
nvm_bb_upd©e_â
 *
upd©e_bbtbl
,

381 *
´iv
)

383 
»que¡_queue
 *
q
 = 
nvmdev
->q;

384 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

385 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

386 
nvme_nvm_commªd
 
c
 = {};

387 
nvme_nvm_bb_tbl
 *
bb_tbl
;

388 
tblsz
 = (
nvme_nvm_bb_tbl
è+ 
Ä_blocks
;

389 
»t
 = 0;

391 
c
.
g‘_bb
.
İcode
 = 
nvme_nvm_admš_g‘_bb_tbl
;

392 
c
.
g‘_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

393 
c
.
g‘_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µa
.ppa);

395 
bb_tbl
 = 
	`kz®loc
(
tblsz
, 
GFP_KERNEL
);

396 ià(!
bb_tbl
)

397  -
ENOMEM
;

399 
»t
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

400 
bb_tbl
, 
tblsz
);

401 ià(
»t
) {

402 
	`dev_”r
(
ù¾
->
dev
, "g‘ bad blockabË faed (%d)\n", 
»t
);

403 
»t
 = -
EIO
;

404 
out
;

407 ià(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

408 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

409 
	`dev_”r
(
ù¾
->
dev
, "bbt format mismatch\n");

410 
»t
 = -
EINVAL
;

411 
out
;

414 ià(
	`Ë16_to_ıu
(
bb_tbl
->
v”id
) != 1) {

415 
»t
 = -
EINVAL
;

416 
	`dev_”r
(
ù¾
->
dev
, "bbt version‚ot supported\n");

417 
out
;

420 ià(
	`Ë32_to_ıu
(
bb_tbl
->
tblks
è!ğ
Ä_blocks
) {

421 
»t
 = -
EINVAL
;

422 
	`dev_”r
(
ù¾
->
dev
, "bbt unsuspected blocks„eturned (%u!=%u)",

423 
	`Ë32_to_ıu
(
bb_tbl
->
tblks
), 
Ä_blocks
);

424 
out
;

427 
µa
 = 
	`dev_to_g’”ic_addr
(
nvmdev
,…pa);

428 
»t
 = 
	`upd©e_bbtbl
(
µa
, 
Ä_blocks
, 
bb_tbl
->
blk
, 
´iv
);

429 
out
:

430 
	`kä“
(
bb_tbl
);

431  
»t
;

432 
	}
}

434 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
nvm_rq
 *
rqd
,

435 
ty³
)

437 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

438 
nvme_nvm_commªd
 
c
 = {};

439 
»t
 = 0;

441 
c
.
£t_bb
.
İcode
 = 
nvme_nvm_admš_£t_bb_tbl
;

442 
c
.
£t_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

443 
c
.
£t_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

444 
c
.
£t_bb
.
Æb
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_·ges
 - 1);

445 
c
.
£t_bb
.
v®ue
 = 
ty³
;

447 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

448 
NULL
, 0);

449 ià(
»t
)

450 
	`dev_”r
(
ns
->
ù¾
->
dev
, "£ˆbad blockabË faed (%d)\n", 
»t
);

451  
»t
;

452 
	}
}

454 
šlše
 
	$nvme_nvm_rqtocmd
(
»que¡
 *
rq
, 
nvm_rq
 *
rqd
,

455 
nvme_ns
 *
ns
, 
nvme_nvm_commªd
 *
c
)

457 
c
->
ph_rw
.
İcode
 = 
rqd
->opcode;

458 
c
->
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

459 
c
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

460 
c
->
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
rqd
->
æags
);

461 
c
->
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_·ges
 - 1);

463 ià(
rqd
->
İcode
 =ğ
NVM_OP_HBWRITE
 ||„qd->İcod=ğ
NVM_OP_HBREAD
)

464 
c
->
hb_rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
,

465 
rqd
->
bio
->
bi_™”
.
bi_£ùÜ
));

466 
	}
}

468 
	$nvme_nvm_’d_io
(
»que¡
 *
rq
, 
”rÜ
)

470 
nvm_rq
 *
rqd
 = 
rq
->
’d_io_d©a
;

472 
	`nvm_’d_io
(
rqd
, 
”rÜ
);

474 
	`kä“
(
rq
->
cmd
);

475 
	`blk_mq_ä“_»que¡
(
rq
);

476 
	}
}

478 
	$nvme_nvm_subm™_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

480 
»que¡_queue
 *
q
 = 
dev
->q;

481 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

482 
»que¡
 *
rq
;

483 
bio
 *biØğ
rqd
->bio;

484 
nvme_nvm_commªd
 *
cmd
;

486 
rq
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`bio_rw
(
bio
), 0);

487 ià(
	`IS_ERR
(
rq
))

488  -
ENOMEM
;

490 
cmd
 = 
	`kz®loc
((
nvme_nvm_commªd
), 
GFP_KERNEL
);

491 ià(!
cmd
) {

492 
	`blk_mq_ä“_»que¡
(
rq
);

493  -
ENOMEM
;

496 
rq
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

497 
rq
->
iİrio
 = 
	`bio_´io
(
bio
);

499 ià(
	`bio_has_d©a
(
bio
))

500 
rq
->
Ä_phys_£gm’ts
 = 
	`bio_phys_£gm’ts
(
q
, 
bio
);

502 
rq
->
__d©a_Ën
 = 
bio
->
bi_™”
.
bi_size
;

503 
rq
->
bio
 =„q->
biÙa
 = bio;

505 
	`nvme_nvm_rqtocmd
(
rq
, 
rqd
, 
ns
, 
cmd
);

507 
rq
->
cmd
 = (*)cmd;

508 
rq
->
cmd_Ën
 = (
nvme_nvm_commªd
);

509 
rq
->
¥ecŸl
 = (*)0;

511 
rq
->
’d_io_d©a
 = 
rqd
;

513 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_’d_io
);

516 
	}
}

518 
	$nvme_nvm_”a£_block
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

520 
»que¡_queue
 *
q
 = 
dev
->q;

521 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

522 
nvme_nvm_commªd
 
c
 = {};

524 
c
.
”a£
.
İcode
 = 
NVM_OP_ERASE
;

525 
c
.
”a£
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

526 
c
.
”a£
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

527 
c
.
”a£
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_·ges
 - 1);

529  
	`nvme_subm™_sync_cmd
(
q
, (
nvme_commªd
 *)&
c
, 
NULL
, 0);

530 
	}
}

532 *
	$nvme_nvm_ü—‹_dma_poŞ
(
nvm_dev
 *
nvmdev
, *
Çme
)

534 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

536  
	`dma_poŞ_ü—‹
(
Çme
, 
ns
->
ù¾
->
dev
, 
PAGE_SIZE
, PAGE_SIZE, 0);

537 
	}
}

539 
	$nvme_nvm_de¡roy_dma_poŞ
(*
poŞ
)

541 
dma_poŞ
 *dma_poŞ = 
poŞ
;

543 
	`dma_poŞ_de¡roy
(
dma_poŞ
);

544 
	}
}

546 *
	$nvme_nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, *
poŞ
,

547 
gå_t
 
mem_æags
, 
dma_addr_t
 *
dma_hªdËr
)

549  
	`dma_poŞ_®loc
(
poŞ
, 
mem_æags
, 
dma_hªdËr
);

550 
	}
}

552 
	$nvme_nvm_dev_dma_ä“
(*
poŞ
, *
µa_li¡
,

553 
dma_addr_t
 
dma_hªdËr
)

555 
	`dma_poŞ_ä“
(
poŞ
, 
µa_li¡
, 
dma_hªdËr
);

556 
	}
}

558 
nvm_dev_İs
 
	gnvme_nvm_dev_İs
 = {

559 .
id’t™y
 = 
nvme_nvm_id’t™y
,

561 .
	gg‘_l2p_tbl
 = 
nvme_nvm_g‘_l2p_tbl
,

563 .
	gg‘_bb_tbl
 = 
nvme_nvm_g‘_bb_tbl
,

564 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

566 .
	gsubm™_io
 = 
nvme_nvm_subm™_io
,

567 .
	g”a£_block
 = 
nvme_nvm_”a£_block
,

569 .
	gü—‹_dma_poŞ
 = 
nvme_nvm_ü—‹_dma_poŞ
,

570 .
	gde¡roy_dma_poŞ
 = 
nvme_nvm_de¡roy_dma_poŞ
,

571 .
	gdev_dma_®loc
 = 
nvme_nvm_dev_dma_®loc
,

572 .
	gdev_dma_ä“
 = 
nvme_nvm_dev_dma_ä“
,

574 .
	gmax_phys_£ù
 = 64,

577 
	$nvme_nvm_»gi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
)

579  
	`nvm_»gi¡”
(
q
, 
disk_Çme
, &
nvme_nvm_dev_İs
);

580 
	}
}

582 
	$nvme_nvm_uÄegi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
)

584 
	`nvm_uÄegi¡”
(
disk_Çme
);

585 
	}
}

588 
	#PCI_VENDOR_ID_CNEX
 0x1d1d

	)

589 
	#PCI_DEVICE_ID_CNEX_WL
 0x2807

	)

590 
	#PCI_DEVICE_ID_CNEX_QEMU
 0x1f1f

	)

592 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

594 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

596 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
ù¾
->
dev
);

599 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

600 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_QEMU
 &&

601 
id
->
vs
[0] == 0x1)

605 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

606 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_WL
 &&

607 
id
->
vs
[0] == 0x1)

611 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/linux_nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/uuid.h
>

22 
	#NVMF_NQN_FIELD_LEN
 256

	)

25 
	#NVMF_NQN_SIZE
 223

	)

27 
	#NVMF_TRSVCID_SIZE
 32

	)

28 
	#NVMF_TRADDR_SIZE
 256

	)

29 
	#NVMF_TSAS_SIZE
 256

	)

31 
	#NVME_DISC_SUBSYS_NAME
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

33 
	#NVME_RDMA_IP_PORT
 4420

	)

35 
	envme_subsys_ty³
 {

36 
	mNVME_NQN_DISC
 = 1,

37 
	mNVME_NQN_NVME
 = 2,

42 
	mNVMF_ADDR_FAMILY_PCI
 = 0,

43 
	mNVMF_ADDR_FAMILY_IP4
 = 1,

44 
	mNVMF_ADDR_FAMILY_IP6
 = 2,

45 
	mNVMF_ADDR_FAMILY_IB
 = 3,

46 
	mNVMF_ADDR_FAMILY_FC
 = 4,

51 
	mNVMF_TRTYPE_RDMA
 = 1,

52 
	mNVMF_TRTYPE_FC
 = 2,

53 
	mNVMF_TRTYPE_LOOP
 = 254,

54 
	mNVMF_TRTYPE_MAX
,

59 
	mNVMF_TREQ_NOT_SPECIFIED
 = 0,

60 
	mNVMF_TREQ_REQUIRED
 = 1,

61 
	mNVMF_TREQ_NOT_REQUIRED
 = 2,

68 
	mNVMF_RDMA_QPTYPE_CONNECTED
 = 0,

69 
	mNVMF_RDMA_QPTYPE_DATAGRAM
 = 1,

76 
	mNVMF_RDMA_PRTYPE_NOT_SPECIFIED
 = 0,

77 
	mNVMF_RDMA_PRTYPE_IB
 = 1,

78 
	mNVMF_RDMA_PRTYPE_ROCE
 = 2,

79 
	mNVMF_RDMA_PRTYPE_ROCEV2
 = 3,

80 
	mNVMF_RDMA_PRTYPE_IWARP
 = 4,

87 
	mNVMF_RDMA_CMS_RDMA_CM
 = 0,

90 
	#NVMF_AQ_DEPTH
 32

	)

93 
	mNVME_REG_CAP
 = 0x0000,

94 
	mNVME_REG_VS
 = 0x0008,

95 
	mNVME_REG_INTMS
 = 0x000c,

96 
	mNVME_REG_INTMC
 = 0x0010,

97 
	mNVME_REG_CC
 = 0x0014,

98 
	mNVME_REG_CSTS
 = 0x001c,

99 
	mNVME_REG_NSSR
 = 0x0020,

100 
	mNVME_REG_AQA
 = 0x0024,

101 
	mNVME_REG_ASQ
 = 0x0028,

102 
	mNVME_REG_ACQ
 = 0x0030,

103 
	mNVME_REG_CMBLOC
 = 0x0038,

104 
	mNVME_REG_CMBSZ
 = 0x003c,

107 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

108 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

109 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

110 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

111 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

112 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

114 
	#NVME_CMB_BIR
(
cmbloc
è((cmblocè& 0x7)

	)

115 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

116 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

117 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

119 
	#NVME_CMB_WDS
(
cmbsz
è((cmbszè& 0x10)

	)

120 
	#NVME_CMB_RDS
(
cmbsz
è((cmbszè& 0x8)

	)

121 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbszè& 0x4)

	)

122 
	#NVME_CMB_CQS
(
cmbsz
è((cmbszè& 0x2)

	)

123 
	#NVME_CMB_SQS
(
cmbsz
è((cmbszè& 0x1)

	)

126 
	mNVME_CC_ENABLE
 = 1 << 0,

127 
	mNVME_CC_CSS_NVM
 = 0 << 4,

128 
	mNVME_CC_MPS_SHIFT
 = 7,

129 
	mNVME_CC_ARB_RR
 = 0 << 11,

130 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

131 
	mNVME_CC_ARB_VS
 = 7 << 11,

132 
	mNVME_CC_SHN_NONE
 = 0 << 14,

133 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

134 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

135 
	mNVME_CC_SHN_MASK
 = 3 << 14,

136 
	mNVME_CC_IOSQES
 = 6 << 16,

137 
	mNVME_CC_IOCQES
 = 4 << 20,

138 
	mNVME_CSTS_RDY
 = 1 << 0,

139 
	mNVME_CSTS_CFS
 = 1 << 1,

140 
	mNVME_CSTS_NSSRO
 = 1 << 4,

141 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

142 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

143 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

144 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

147 
	snvme_id_pow”_¡©e
 {

148 
__Ë16
 
	mmax_pow”
;

149 
__u8
 
	mrsvd2
;

150 
__u8
 
	mæags
;

151 
__Ë32
 
	m’Œy_Ït
;

152 
__Ë32
 
	mex™_Ït
;

153 
__u8
 
	m»ad_ut
;

154 
__u8
 
	m»ad_Ït
;

155 
__u8
 
	mwr™e_ut
;

156 
__u8
 
	mwr™e_Ït
;

157 
__Ë16
 
	midË_pow”
;

158 
__u8
 
	midË_sÿË
;

159 
__u8
 
	mrsvd19
;

160 
__Ë16
 
	maùive_pow”
;

161 
__u8
 
	maùive_wÜk_sÿË
;

162 
__u8
 
	mrsvd23
[9];

166 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

167 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

170 
	snvme_id_ù¾
 {

171 
__Ë16
 
	mvid
;

172 
__Ë16
 
	mssvid
;

173 
	m¢
[20];

174 
	mmn
[40];

175 
	mä
[8];

176 
__u8
 
	m¿b
;

177 
__u8
 
	m›“
[3];

178 
__u8
 
	mmic
;

179 
__u8
 
	mmdts
;

180 
__Ë16
 
	múid
;

181 
__Ë32
 
	mv”
;

182 
__Ë32
 
	m¹d3r
;

183 
__Ë32
 
	m¹d3e
;

184 
__Ë32
 
	mßes
;

185 
__Ë32
 
	mù¿‰
;

186 
__u8
 
	mrsvd100
[156];

187 
__Ë16
 
	mßcs
;

188 
__u8
 
	maş
;

189 
__u8
 
	m«¾
;

190 
__u8
 
	mämw
;

191 
__u8
 
	mÍa
;

192 
__u8
 
	m–³
;

193 
__u8
 
	mÅss
;

194 
__u8
 
	mavscc
;

195 
__u8
 
	m­¡a
;

196 
__Ë16
 
	mwùemp
;

197 
__Ë16
 
	mcùemp
;

198 
__u8
 
	mrsvd270
[242];

199 
__u8
 
	msqes
;

200 
__u8
 
	mcqes
;

201 
__Ë16
 
	mmaxcmd
;

202 
__Ë32
 
	mÂ
;

203 
__Ë16
 
	mÚcs
;

204 
__Ë16
 
	mfu£s
;

205 
__u8
 
	mâa
;

206 
__u8
 
	mvwc
;

207 
__Ë16
 
	mawun
;

208 
__Ë16
 
	mawupf
;

209 
__u8
 
	mnvscc
;

210 
__u8
 
	mrsvd531
;

211 
__Ë16
 
	macwu
;

212 
__u8
 
	mrsvd534
[2];

213 
__Ë32
 
	msgls
;

214 
__u8
 
	mrsvd540
[228];

215 
	msubnqn
[256];

216 
__u8
 
	mrsvd1024
[768];

217 
__Ë32
 
	mioccsz
;

218 
__Ë32
 
	miÜcsz
;

219 
__Ë16
 
	micdoff
;

220 
__u8
 
	mù¿‰r
;

221 
__u8
 
	mmsdbd
;

222 
__u8
 
	mrsvd1804
[244];

223 
nvme_id_pow”_¡©e
 
	mpsd
[32];

224 
__u8
 
	mvs
[1024];

228 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

229 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

230 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

231 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

234 
	snvme_lbaf
 {

235 
__Ë16
 
	mms
;

236 
__u8
 
	mds
;

237 
__u8
 
	m½
;

240 
	snvme_id_ns
 {

241 
__Ë64
 
	mnsze
;

242 
__Ë64
 
	mnÿp
;

243 
__Ë64
 
	mnu£
;

244 
__u8
 
	mnsã©
;

245 
__u8
 
	mÆbaf
;

246 
__u8
 
	mæbas
;

247 
__u8
 
	mmc
;

248 
__u8
 
	mdpc
;

249 
__u8
 
	mdps
;

250 
__u8
 
	mnmic
;

251 
__u8
 
	m»sÿp
;

252 
__u8
 
	måi
;

253 
__u8
 
	mrsvd33
;

254 
__Ë16
 
	mÇwun
;

255 
__Ë16
 
	mÇwupf
;

256 
__Ë16
 
	mÇcwu
;

257 
__Ë16
 
	mÇb¢
;

258 
__Ë16
 
	mÇbo
;

259 
__Ë16
 
	mÇb¥f
;

260 
__u16
 
	mrsvd46
;

261 
__Ë64
 
	mnvmÿp
[2];

262 
__u8
 
	mrsvd64
[40];

263 
__u8
 
	mnguid
[16];

264 
__u8
 
	meui64
[8];

265 
nvme_lbaf
 
	mlbaf
[16];

266 
__u8
 
	mrsvd192
[192];

267 
__u8
 
	mvs
[3712];

271 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

272 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

273 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

274 
	mNVME_LBAF_RP_BEST
 = 0,

275 
	mNVME_LBAF_RP_BETTER
 = 1,

276 
	mNVME_LBAF_RP_GOOD
 = 2,

277 
	mNVME_LBAF_RP_DEGRADED
 = 3,

278 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

279 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

280 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

281 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

282 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

283 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

284 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

285 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

286 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

287 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

290 
	snvme_sm¬t_log
 {

291 
__u8
 
	mü™iÿl_w¬nšg
;

292 
__u8
 
	m‹m³¿tu»
[2];

293 
__u8
 
	mava_¥¬e
;

294 
__u8
 
	m¥¬e_th»sh
;

295 
__u8
 
	m³rûÁ_u£d
;

296 
__u8
 
	mrsvd6
[26];

297 
__u8
 
	md©a_un™s_»ad
[16];

298 
__u8
 
	md©a_un™s_wr™‹n
[16];

299 
__u8
 
	mho¡_»ads
[16];

300 
__u8
 
	mho¡_wr™es
[16];

301 
__u8
 
	mù¾_busy_time
[16];

302 
__u8
 
	mpow”_cyşes
[16];

303 
__u8
 
	mpow”_Ú_hours
[16];

304 
__u8
 
	mun§ã_shutdowns
[16];

305 
__u8
 
	mmedŸ_”rÜs
[16];

306 
__u8
 
	mnum_”r_log_’Œ›s
[16];

307 
__Ë32
 
	mw¬nšg_‹mp_time
;

308 
__Ë32
 
	mü™iÿl_comp_time
;

309 
__Ë16
 
	m‹mp_£nsÜ
[8];

310 
__u8
 
	mrsvd216
[296];

314 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

315 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

316 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

317 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

318 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

322 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

325 
	snvme_lba_¿nge_ty³
 {

326 
__u8
 
	mty³
;

327 
__u8
 
	m©Œibu‹s
;

328 
__u8
 
	mrsvd2
[14];

329 
__u64
 
	m¦ba
;

330 
__u64
 
	mÆb
;

331 
__u8
 
	mguid
[16];

332 
__u8
 
	mrsvd48
[16];

336 
	mNVME_LBART_TYPE_FS
 = 0x01,

337 
	mNVME_LBART_TYPE_RAID
 = 0x02,

338 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

339 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

341 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

342 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

345 
	snvme_»£rv©iÚ_¡©us
 {

346 
__Ë32
 
	mg’
;

347 
__u8
 
	m¹y³
;

348 
__u8
 
	m»gùl
[2];

349 
__u8
 
	m»sv5
[2];

350 
__u8
 
	m±¶s
;

351 
__u8
 
	m»sv10
[13];

353 
__Ë16
 
	múid
;

354 
__u8
 
	mrc¡s
;

355 
__u8
 
	m»sv3
[5];

356 
__Ë64
 
	mho¡id
;

357 
__Ë64
 
	mrkey
;

358 } 
	m»gùl_ds
[];

363 
	envme_İcode
 {

364 
	mnvme_cmd_æush
 = 0x00,

365 
	mnvme_cmd_wr™e
 = 0x01,

366 
	mnvme_cmd_»ad
 = 0x02,

367 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

368 
	mnvme_cmd_com·»
 = 0x05,

369 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

370 
	mnvme_cmd_dsm
 = 0x09,

371 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

372 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

373 
	mnvme_cmd_»sv_acquœe
 = 0x11,

374 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

376 
	mnvme_cmd_kv_¡Üe
 = 0x81,

377 
	mnvme_cmd_kv_­³nd
 = 0x83,

378 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

379 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

380 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

381 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

382 
	mnvme_cmd_kv_exi¡
 = 0xB3,

386 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

387 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

388 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

400 
	mNVME_SGL_FMT_ADDRESS
 = 0x00,

401 
	mNVME_SGL_FMT_OFFSET
 = 0x01,

402 
	mNVME_SGL_FMT_INVALIDATE
 = 0x0f,

417 
	mNVME_SGL_FMT_DATA_DESC
 = 0x00,

418 
	mNVME_SGL_FMT_SEG_DESC
 = 0x02,

419 
	mNVME_SGL_FMT_LAST_SEG_DESC
 = 0x03,

420 
	mNVME_KEY_SGL_FMT_DATA_DESC
 = 0x04,

423 
	snvme_sgl_desc
 {

424 
__Ë64
 
	maddr
;

425 
__Ë32
 
	mËngth
;

426 
__u8
 
	mrsvd
[3];

427 
__u8
 
	mty³
;

430 
	snvme_keyed_sgl_desc
 {

431 
__Ë64
 
	maddr
;

432 
__u8
 
	mËngth
[3];

433 
__u8
 
	mkey
[4];

434 
__u8
 
	mty³
;

437 
	unvme_d©a_±r
 {

439 
__Ë64
 
	m´p1
;

440 
__Ë64
 
	m´p2
;

442 
nvme_sgl_desc
 
	msgl
;

443 
nvme_keyed_sgl_desc
 
	mksgl
;

461 
	mNVME_CMD_FUSE_FIRST
 = (1 << 0),

462 
	mNVME_CMD_FUSE_SECOND
 = (1 << 1),

464 
	mNVME_CMD_SGL_METABUF
 = (1 << 6),

465 
	mNVME_CMD_SGL_METASEG
 = (1 << 7),

466 
	mNVME_CMD_SGL_ALL
 = 
NVME_CMD_SGL_METABUF
 | 
NVME_CMD_SGL_METASEG
,

469 
	snvme_commÚ_commªd
 {

470 
__u8
 
	mİcode
;

471 
__u8
 
	mæags
;

472 
__u16
 
	mcommªd_id
;

473 
__Ë32
 
	mnsid
;

474 
__Ë32
 
	mcdw2
[2];

475 
__Ë64
 
	mm‘ad©a
;

476 
nvme_d©a_±r
 
	md±r
;

477 
__Ë32
 
	mcdw10
[6];

480 
	snvme_rw_commªd
 {

481 
__u8
 
	mİcode
;

482 
__u8
 
	mæags
;

483 
__u16
 
	mcommªd_id
;

484 
__Ë32
 
	mnsid
;

485 
__u64
 
	mrsvd2
;

486 
__Ë64
 
	mm‘ad©a
;

487 
nvme_d©a_±r
 
	md±r
;

488 
__Ë64
 
	m¦ba
;

489 
__Ë16
 
	mËngth
;

490 
__Ë16
 
	mcÚŒŞ
;

491 
__Ë32
 
	mdsmgmt
;

492 
__Ë32
 
	m»áag
;

493 
__Ë16
 
	m­±ag
;

494 
__Ë16
 
	m­pmask
;

498 
	mNVME_RW_LR
 = 1 << 15,

499 
	mNVME_RW_FUA
 = 1 << 14,

500 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

501 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

502 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

503 
	mNVME_RW_DSM_FREQ_READS
 = 3,

504 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

505 
	mNVME_RW_DSM_FREQ_RW
 = 5,

506 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

507 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

508 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

509 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

510 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

511 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

512 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

513 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

514 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

515 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

516 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

517 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

518 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

521 
	snvme_dsm_cmd
 {

522 
__u8
 
	mİcode
;

523 
__u8
 
	mæags
;

524 
__u16
 
	mcommªd_id
;

525 
__Ë32
 
	mnsid
;

526 
__u64
 
	mrsvd2
[2];

527 
nvme_d©a_±r
 
	md±r
;

528 
__Ë32
 
	mÄ
;

529 
__Ë32
 
	m©Œibu‹s
;

530 
__u32
 
	mrsvd12
[4];

534 
	mNVME_DSMGMT_IDR
 = 1 << 0,

535 
	mNVME_DSMGMT_IDW
 = 1 << 1,

536 
	mNVME_DSMGMT_AD
 = 1 << 2,

539 
	snvme_dsm_¿nge
 {

540 
__Ë32
 
	mÿ‰r
;

541 
__Ë32
 
	mÆb
;

542 
__Ë64
 
	m¦ba
;

547 
	snvme_kv_¡Üe_commªd
 {

548 
__u8
 
	mİcode
;

549 
__u8
 
	mæags
;

550 
__u16
 
	mcommªd_id
;

551 
__Ë32
 
	mnsid
;

552 
__u64
 
	mrsvd
;

553 
__Ë32
 
	moff£t
;

554 
__u32
 
	mrsvd2
;

555 
nvme_d©a_±r
 
	md±r
;

556 
__Ë32
 
	mv®ue_Ën
;

557 
__u8
 
	mkey_Ën
;

558 
__u8
 
	mİtiÚ
;

559 
__u8
 
	mšv®id_by‹
:2;

560 
__u8
 
	mrsvd3
:6;

561 
__u8
 
	mrsvd4
;

564 
	mkey
[16];

567 
__Ë64
 
	mkey_´p
;

568 
__Ë64
 
	mkey_´p2
;

573 
	snvme_kv_­³nd_commªd
 {

574 
__u8
 
	mİcode
;

575 
__u8
 
	mæags
;

576 
__u16
 
	mcommªd_id
;

577 
__Ë32
 
	mnsid
;

578 
__u64
 
	mrsvd
;

579 
__Ë32
 
	moff£t
;

580 
__u32
 
	mrsvd2
;

581 
nvme_d©a_±r
 
	md±r
;

582 
__Ë32
 
	mv®ue_Ën
;

583 
__u8
 
	mkey_Ën
;

584 
__u8
 
	mİtiÚ
;

585 
__u8
 
	mšv®id_by‹
:2;

586 
__u8
 
	mrsvd3
:6;

587 
__u8
 
	mrsvd4
;

590 
	mkey
[16];

593 
__Ë64
 
	mkey_´p
;

594 
__Ë64
 
	mkey_´p2
;

599 
	snvme_kv_»Œ›ve_commªd
 {

600 
__u8
 
	mİcode
;

601 
__u8
 
	mæags
;

602 
__u16
 
	mcommªd_id
;

603 
__Ë32
 
	mnsid
;

604 
__u64
 
	mrsvd
;

605 
__Ë32
 
	moff£t
;

606 
__u32
 
	mrsvd2
;

607 
nvme_d©a_±r
 
	md±r
;

608 
__Ë32
 
	mv®ue_Ën
;

609 
__u8
 
	mkey_Ën
;

610 
__u8
 
	mİtiÚ
;

611 
__u16
 
	mrsvd3
;

614 
	mkey
[16];

617 
__Ë64
 
	mkey_´p
;

618 
__Ë64
 
	mkey_´p2
;

623 
	snvme_kv_d–‘e_commªd
 {

624 
__u8
 
	mİcode
;

625 
__u8
 
	mæags
;

626 
__u16
 
	mcommªd_id
;

627 
__Ë32
 
	mnsid
;

628 
__u64
 
	mrsvd
;

629 
__Ë32
 
	moff£t
;

630 
__u32
 
	mrsvd2
;

631 
__u64
 
	mrsvd3
[2];

632 
__Ë32
 
	mv®ue_Ën
;

633 
__u8
 
	mkey_Ën
;

634 
__u8
 
	mİtiÚ
;

635 
__u16
 
	mrsvd4
;

638 
	mkey
[16];

641 
__Ë64
 
	mkey_´p
;

642 
__Ë64
 
	mkey_´p2
;

647 
	snvme_kv_™”_»q_commªd
 {

648 
__u8
 
	mİcode
;

649 
__u8
 
	mæags
;

650 
__u16
 
	mcommªd_id
;

651 
__Ë32
 
	mnsid
;

652 
__u64
 
	mrsvd
[4];

653 
__Ë32
 
	mz”o
;

654 
__u8
 
	m™”_hªdË
;

655 
__u8
 
	mİtiÚ
;

656 
__u16
 
	mrsvd2
;

657 
__Ë32
 
	m™”_v®
;

658 
__Ë32
 
	m™”_b™mask
;

659 
__u64
 
	mrsvd3
;

663 
	snvme_kv_™”_»ad_commªd
 {

664 
__u8
 
	mİcode
;

665 
__u8
 
	mæags
;

666 
__u16
 
	mcommªd_id
;

667 
__Ë32
 
	mnsid
;

668 
__u64
 
	mrsvd
[2];

669 
nvme_d©a_±r
 
	md±r
;

670 
__Ë32
 
	mv®ue_Ën
;

671 
__u8
 
	m™”_hªdË
;

672 
__u8
 
	mİtiÚ
;

673 
__u16
 
	mrsvd2
;

674 
__u64
 
	mrsvd3
[2];

676 
	snvme_kv_exi¡_commªd
 {

677 
__u8
 
	mİcode
;

678 
__u8
 
	mæags
;

679 
__u16
 
	mcommªd_id
;

680 
__Ë32
 
	mnsid
;

681 
__u64
 
	mrsvd
;

682 
__Ë32
 
	moff£t
;

683 
__u32
 
	mrsvd2
;

684 
__u64
 
	mrsvd3
[2];

685 
__Ë32
 
	mv®ue_Ën
;

686 
__u8
 
	mkey_Ën
;

687 
__u8
 
	mİtiÚ
;

688 
__u16
 
	mrsvd4
;

691 
	mkey
[16];

694 
__Ë64
 
	mkey_´p
;

695 
__Ë64
 
	mkey_´p2
;

705 
	envme_admš_İcode
 {

706 
	mnvme_admš_d–‘e_sq
 = 0x00,

707 
	mnvme_admš_ü—‹_sq
 = 0x01,

708 
	mnvme_admš_g‘_log_·ge
 = 0x02,

709 
	mnvme_admš_d–‘e_cq
 = 0x04,

710 
	mnvme_admš_ü—‹_cq
 = 0x05,

711 
	mnvme_admš_id’tify
 = 0x06,

712 
	mnvme_admš_abÜt_cmd
 = 0x08,

713 
	mnvme_admš_£t_ã©u»s
 = 0x09,

714 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

715 
	mnvme_admš_async_ev’t
 = 0x0c,

716 
	mnvme_admš_aùiv©e_fw
 = 0x10,

717 
	mnvme_admš_dowÆßd_fw
 = 0x11,

718 
	mnvme_admš_fÜm©_nvm
 = 0x80,

719 
	mnvme_admš_£cur™y_£nd
 = 0x81,

720 
	mnvme_admš_£cur™y_»cv
 = 0x82,

721 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


722 
	mnvme_admš_doÜb–l_memÜy
 = 0xC0,

727 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

728 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

729 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

730 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

731 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

732 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

733 
	mNVME_FEAT_ARBITRATION
 = 0x01,

734 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

735 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

736 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

737 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

738 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

739 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

740 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

741 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

742 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

743 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

744 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

745 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

746 
	mNVME_FEAT_HOST_ID
 = 0x81,

747 
	mNVME_FEAT_RESV_MASK
 = 0x82,

748 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

749 
	mNVME_LOG_ERROR
 = 0x01,

750 
	mNVME_LOG_SMART
 = 0x02,

751 
	mNVME_LOG_FW_SLOT
 = 0x03,

752 
	mNVME_LOG_DISC
 = 0x70,

753 
	mNVME_LOG_RESERVATION
 = 0x80,

754 
	mNVME_FWACT_REPL
 = (0 << 3),

755 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

756 
	mNVME_FWACT_ACTV
 = (2 << 3),

759 
	snvme_id’tify
 {

760 
__u8
 
	mİcode
;

761 
__u8
 
	mæags
;

762 
__u16
 
	mcommªd_id
;

763 
__Ë32
 
	mnsid
;

764 
__u64
 
	mrsvd2
[2];

765 
nvme_d©a_±r
 
	md±r
;

766 
__Ë32
 
	mús
;

767 
__u32
 
	mrsvd11
[5];

770 
	snvme_ã©u»s
 {

771 
__u8
 
	mİcode
;

772 
__u8
 
	mæags
;

773 
__u16
 
	mcommªd_id
;

774 
__Ë32
 
	mnsid
;

775 
__u64
 
	mrsvd2
[2];

776 
nvme_d©a_±r
 
	md±r
;

777 
__Ë32
 
	mfid
;

778 
__Ë32
 
	mdwÜd11
;

779 
__u32
 
	mrsvd12
[4];

782 
	snvme_ü—‹_cq
 {

783 
__u8
 
	mİcode
;

784 
__u8
 
	mæags
;

785 
__u16
 
	mcommªd_id
;

786 
__u32
 
	mrsvd1
[5];

787 
__Ë64
 
	m´p1
;

788 
__u64
 
	mrsvd8
;

789 
__Ë16
 
	mcqid
;

790 
__Ë16
 
	mqsize
;

791 
__Ë16
 
	mcq_æags
;

792 
__Ë16
 
	mœq_veùÜ
;

793 
__u32
 
	mrsvd12
[4];

796 
	snvme_ü—‹_sq
 {

797 
__u8
 
	mİcode
;

798 
__u8
 
	mæags
;

799 
__u16
 
	mcommªd_id
;

800 
__u32
 
	mrsvd1
[5];

801 
__Ë64
 
	m´p1
;

802 
__u64
 
	mrsvd8
;

803 
__Ë16
 
	msqid
;

804 
__Ë16
 
	mqsize
;

805 
__Ë16
 
	msq_æags
;

806 
__Ë16
 
	mcqid
;

807 
__u32
 
	mrsvd12
[4];

810 
	snvme_d–‘e_queue
 {

811 
__u8
 
	mİcode
;

812 
__u8
 
	mæags
;

813 
__u16
 
	mcommªd_id
;

814 
__u32
 
	mrsvd1
[9];

815 
__Ë16
 
	mqid
;

816 
__u16
 
	mrsvd10
;

817 
__u32
 
	mrsvd11
[5];

820 
	snvme_abÜt_cmd
 {

821 
__u8
 
	mİcode
;

822 
__u8
 
	mæags
;

823 
__u16
 
	mcommªd_id
;

824 
__u32
 
	mrsvd1
[9];

825 
__Ë16
 
	msqid
;

826 
__u16
 
	mcid
;

827 
__u32
 
	mrsvd11
[5];

830 
	snvme_dowÆßd_fœmw¬e
 {

831 
__u8
 
	mİcode
;

832 
__u8
 
	mæags
;

833 
__u16
 
	mcommªd_id
;

834 
__u32
 
	mrsvd1
[5];

835 
nvme_d©a_±r
 
	md±r
;

836 
__Ë32
 
	mnumd
;

837 
__Ë32
 
	moff£t
;

838 
__u32
 
	mrsvd12
[4];

841 
	snvme_fÜm©_cmd
 {

842 
__u8
 
	mİcode
;

843 
__u8
 
	mæags
;

844 
__u16
 
	mcommªd_id
;

845 
__Ë32
 
	mnsid
;

846 
__u64
 
	mrsvd2
[4];

847 
__Ë32
 
	mcdw10
;

848 
__u32
 
	mrsvd11
[5];

851 
	snvme_g‘_log_·ge_commªd
 {

852 
__u8
 
	mİcode
;

853 
__u8
 
	mæags
;

854 
__u16
 
	mcommªd_id
;

855 
__Ë32
 
	mnsid
;

856 
__u64
 
	mrsvd2
[2];

857 
nvme_d©a_±r
 
	md±r
;

858 
__u8
 
	mlid
;

859 
__u8
 
	mrsvd10
;

860 
__Ë16
 
	mnumdl
;

861 
__Ë16
 
	mnumdu
;

862 
__u16
 
	mrsvd11
;

863 
__Ë32
 
	mÍŞ
;

864 
__Ë32
 
	mÍou
;

865 
__u32
 
	mrsvd14
[2];

871 
	envmf_çbrics_İcode
 {

872 
	mnvme_çbrics_commªd
 = 0x7f,

875 
	envmf_ÿpsuË_commªd
 {

876 
	mnvme_çbrics_ty³_´İ”ty_£t
 = 0x00,

877 
	mnvme_çbrics_ty³_cÚÃù
 = 0x01,

878 
	mnvme_çbrics_ty³_´İ”ty_g‘
 = 0x04,

881 
	snvmf_commÚ_commªd
 {

882 
__u8
 
	mİcode
;

883 
__u8
 
	m»sv1
;

884 
__u16
 
	mcommªd_id
;

885 
__u8
 
	mfùy³
;

886 
__u8
 
	m»sv2
[35];

887 
__u8
 
	mts
[24];

896 
	#NVME_CNTLID_MIN
 1

	)

897 
	#NVME_CNTLID_MAX
 0xfãf

	)

898 
	#NVME_CNTLID_DYNAMIC
 0xffff

	)

900 
	#MAX_DISC_LOGS
 255

	)

903 
	snvmf_disc_r¥_·ge_’Œy
 {

904 
__u8
 
	mŒty³
;

905 
__u8
 
	madrçm
;

906 
__u8
 
	mnqÁy³
;

907 
__u8
 
	mŒeq
;

908 
__Ë16
 
	mpÜtid
;

909 
__Ë16
 
	múid
;

910 
__Ë16
 
	masqsz
;

911 
__u8
 
	m»sv8
[22];

912 
	mŒsvcid
[
NVMF_TRSVCID_SIZE
];

913 
__u8
 
	m»sv64
[192];

914 
	msubnqn
[
NVMF_NQN_FIELD_LEN
];

915 
	mŒaddr
[
NVMF_TRADDR_SIZE
];

916 
	ut§s
 {

917 
	mcommÚ
[
NVMF_TSAS_SIZE
];

918 
	srdma
 {

919 
__u8
 
	mq±y³
;

920 
__u8
 
	m´ty³
;

921 
__u8
 
	mcms
;

922 
__u8
 
	m»sv3
[5];

923 
__u16
 
	mpkey
;

924 
__u8
 
	m»sv10
[246];

925 } 
	mrdma
;

926 } 
	mt§s
;

930 
	snvmf_disc_r¥_·ge_hdr
 {

931 
__Ë64
 
	mg’ùr
;

932 
__Ë64
 
	mnum»c
;

933 
__Ë16
 
	m»cfmt
;

934 
__u8
 
	m»sv14
[1006];

935 
nvmf_disc_r¥_·ge_’Œy
 
	m’Œ›s
[0];

938 
	snvmf_cÚÃù_commªd
 {

939 
__u8
 
	mİcode
;

940 
__u8
 
	m»sv1
;

941 
__u16
 
	mcommªd_id
;

942 
__u8
 
	mfùy³
;

943 
__u8
 
	m»sv2
[19];

944 
nvme_d©a_±r
 
	md±r
;

945 
__Ë16
 
	m»cfmt
;

946 
__Ë16
 
	mqid
;

947 
__Ë16
 
	msqsize
;

948 
__u8
 
	mÿ‰r
;

949 
__u8
 
	m»sv3
;

950 
__Ë32
 
	mk©o
;

951 
__u8
 
	m»sv4
[12];

954 
	snvmf_cÚÃù_d©a
 {

955 
uuid_Ë
 
	mho¡id
;

956 
__Ë16
 
	múid
;

957 
	m»sv4
[238];

958 
	msubsy¢qn
[
NVMF_NQN_FIELD_LEN
];

959 
	mho¡nqn
[
NVMF_NQN_FIELD_LEN
];

960 
	m»sv5
[256];

963 
	snvmf_´İ”ty_£t_commªd
 {

964 
__u8
 
	mİcode
;

965 
__u8
 
	m»sv1
;

966 
__u16
 
	mcommªd_id
;

967 
__u8
 
	mfùy³
;

968 
__u8
 
	m»sv2
[35];

969 
__u8
 
	m©Œib
;

970 
__u8
 
	m»sv3
[3];

971 
__Ë32
 
	moff£t
;

972 
__Ë64
 
	mv®ue
;

973 
__u8
 
	m»sv4
[8];

976 
	snvmf_´İ”ty_g‘_commªd
 {

977 
__u8
 
	mİcode
;

978 
__u8
 
	m»sv1
;

979 
__u16
 
	mcommªd_id
;

980 
__u8
 
	mfùy³
;

981 
__u8
 
	m»sv2
[35];

982 
__u8
 
	m©Œib
;

983 
__u8
 
	m»sv3
[3];

984 
__Ë32
 
	moff£t
;

985 
__u8
 
	m»sv4
[16];

988 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


989 
	snvme_doÜb–l_memÜy
 {

990 
__u8
 
	mİcode
;

991 
__u8
 
	mæags
;

992 
__u16
 
	mcommªd_id
;

993 
__u32
 
	mrsvd1
[5];

994 
__Ë64
 
	m´p1
;

995 
__Ë64
 
	m´p2
;

996 
__u32
 
	mrsvd12
[6];

1000 
	snvme_commªd
 {

1002 
nvme_commÚ_commªd
 
	mcommÚ
;

1003 
nvme_rw_commªd
 
	mrw
;

1004 
nvme_id’tify
 
	mid’tify
;

1005 
nvme_ã©u»s
 
	mã©u»s
;

1006 
nvme_ü—‹_cq
 
	mü—‹_cq
;

1007 
nvme_ü—‹_sq
 
	mü—‹_sq
;

1008 
nvme_d–‘e_queue
 
	md–‘e_queue
;

1009 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

1010 
nvme_fÜm©_cmd
 
	mfÜm©
;

1011 
nvme_dsm_cmd
 
	mdsm
;

1012 
nvme_abÜt_cmd
 
	mabÜt
;

1013 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1014 
nvme_doÜb–l_memÜy
 
	mdoÜb–l_memÜy
;

1016 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

1017 
nvmf_commÚ_commªd
 
	mçbrics
;

1018 
nvmf_cÚÃù_commªd
 
	mcÚÃù
;

1019 
nvmf_´İ”ty_£t_commªd
 
	m´İ_£t
;

1020 
nvmf_´İ”ty_g‘_commªd
 
	m´İ_g‘
;

1022 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

1023 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

1024 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

1025 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

1026 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

1027 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

1028 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

1033 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1041 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_¡Üe
 || cmd->commÚ.İcod=ğ
nvme_cmd_kv_­³nd
)

1043 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_»Œ›ve
 ||

1044 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_d–‘e
 ||

1045 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»q
 ||

1046 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
 ||

1047 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_exi¡
 )

1050 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1051  
cmd
->
çbrics
.
İcode
 & 1;

1052  
cmd
->
commÚ
.
İcode
 & 1;

1053 
	}
}

1059 
	mNVME_SC_SUCCESS
 = 0x0,

1060 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

1061 
	mNVME_SC_INVALID_FIELD
 = 0x2,

1062 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

1063 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

1064 
	mNVME_SC_POWER_LOSS
 = 0x5,

1065 
	mNVME_SC_INTERNAL
 = 0x6,

1066 
	mNVME_SC_ABORT_REQ
 = 0x7,

1067 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

1068 
	mNVME_SC_FUSED_FAIL
 = 0x9,

1069 
	mNVME_SC_FUSED_MISSING
 = 0xa,

1070 
	mNVME_SC_INVALID_NS
 = 0xb,

1071 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

1072 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

1073 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

1074 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

1075 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

1076 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

1078 
	mNVME_SC_SGL_INVALID_OFFSET
 = 0x16,

1079 
	mNVME_SC_SGL_INVALID_SUBTYPE
 = 0x17,

1081 
	mNVME_SC_LBA_RANGE
 = 0x80,

1082 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

1083 
	mNVME_SC_NS_NOT_READY
 = 0x82,

1084 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

1089 
	mNVME_SC_CQ_INVALID
 = 0x100,

1090 
	mNVME_SC_QID_INVALID
 = 0x101,

1091 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

1092 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

1093 
	mNVME_SC_ABORT_MISSING
 = 0x104,

1094 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

1095 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

1096 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

1097 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

1098 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

1099 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

1100 
	mNVME_SC_FIRMWARE_NEEDS_RESET
 = 0x10b,

1101 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

1102 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

1103 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

1104 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

1105 
	mNVME_SC_FW_NEEDS_RESET_SUBSYS
 = 0x110,

1110 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

1111 
	mNVME_SC_INVALID_PI
 = 0x181,

1112 
	mNVME_SC_READ_ONLY
 = 0x182,

1113 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1114 
	mNVME_SC_DOORBELL_MEMORY_INVALID
 = 0x1C0,

1120 
	mNVME_SC_CONNECT_FORMAT
 = 0x180,

1121 
	mNVME_SC_CONNECT_CTRL_BUSY
 = 0x181,

1122 
	mNVME_SC_CONNECT_INVALID_PARAM
 = 0x182,

1123 
	mNVME_SC_CONNECT_RESTART_DISC
 = 0x183,

1124 
	mNVME_SC_CONNECT_INVALID_HOST
 = 0x184,

1126 
	mNVME_SC_DISCOVERY_RESTART
 = 0x190,

1127 
	mNVME_SC_AUTH_REQUIRED
 = 0x191,

1132 
	mNVME_SC_WRITE_FAULT
 = 0x280,

1133 
	mNVME_SC_READ_ERROR
 = 0x281,

1134 
	mNVME_SC_GUARD_CHECK
 = 0x282,

1135 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

1136 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

1137 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

1138 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

1140 
	mNVME_SC_DNR
 = 0x4000,

1143 
	snvme_com¶‘iÚ
 {

1148 
__Ë16
 
	m»suÉ16
;

1149 
__Ë32
 
	m»suÉ
;

1150 
__Ë64
 
	m»suÉ64
;

1152 
__Ë16
 
	msq_h—d
;

1153 
__Ë16
 
	msq_id
;

1154 
__u16
 
	mcommªd_id
;

1155 
__Ë16
 
	m¡©us
;

1158 
	#NVME_VS
(
majÜ
, 
mšÜ
è(((majÜè<< 16è| ((mšÜè<< 8))

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


16 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	mİcode
;

22 
__u8
 
	mæags
;

23 
__u16
 
	mcÚŒŞ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mm‘ad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¦ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	m»áag
;

31 
__u16
 
	m­±ag
;

32 
__u16
 
	m­pmask
;

35 
	snvme_·s¡hru_cmd
 {

36 
__u8
 
	mİcode
;

37 
__u8
 
	mæags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mm‘ad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mm‘ad©a_Ën
;

45 
__u32
 
	md©a_Ën
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	m»suÉ
;

56 
	#KVS_SUCCESS
 0

	)

57 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

58 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

59 
	#KVS_ERR_CLOSE
 (-3)

	)

60 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

61 
	#KVS_ERR_CONT_NAME
 (-5)

	)

62 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

63 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

64 
	#KVS_ERR_GROUP
 (-8)

	)

65 
	#KVS_ERR_INDEX
 (-9)

	)

66 
	#KVS_ERR_IO
 (-10)

	)

67 
	#KVS_ERR_KEY
 (-11)

	)

68 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

69 
	#KVS_ERR_MEMORY
 (-13)

	)

70 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

71 
	#KVS_ERR_OFFSET
 (-15)

	)

72 
	#KVS_ERR_OPEN
 (-16)

	)

73 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

74 
	#KVS_ERR_PERMISSION
 (-18)

	)

75 
	#KVS_ERR_SPACE
 (-19)

	)

76 
	#KVS_ERR_TIMEOUT
 (-20)

	)

77 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

78 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

79 
	#KVS_ERR_VALUE
 (-23)

	)

82 
	snvme_·s¡hru_kv_cmd
 {

83 
__u8
 
	mİcode
;

84 
__u8
 
	mæags
;

85 
__u16
 
	mrsvd1
;

86 
__u32
 
	mnsid
;

87 
__u32
 
	mcdw2
;

88 
__u32
 
	mcdw3
;

89 
__u32
 
	mcdw4
;

90 
__u32
 
	mcdw5
;

91 
__u64
 
	md©a_addr
;

92 
__u32
 
	md©a_Ëngth
;

93 
__u32
 
	mkey_Ëngth
;

94 
__u32
 
	mcdw10
;

95 
__u32
 
	mcdw11
;

98 
__u64
 
	mkey_addr
;

99 
__u32
 
	mrsvd5
;

100 
__u32
 
	mrsvd6
;

102 
__u8
 
	mkey
[16];

104 
__u32
 
	mcdw12
;

105 
__u32
 
	mcdw13
;

106 
__u32
 
	mcdw14
;

107 
__u32
 
	mcdw15
;

110 
__u32
 
	mtimeout_ms
;

111 
__u32
 
	m»suÉ
;

112 
__u32
 
	m¡©us
;

113 
__u32
 
	mùxid
;

114 
__u64
 
	m»qid
;

117 
	snvme_aioùx
 {

118 
__u32
 
	mùxid
;

119 
__u32
 
	mev’tfd
;

123 
	snvme_aiÛv’t
 {

124 
__u64
 
	m»qid
;

125 
__u32
 
	mùxid
;

126 
__u32
 
	m»suÉ
;

127 
__u16
 
	m¡©us
;

130 
	#MAX_AIO_EVENTS
 128

	)

131 
	snvme_aiÛv’ts
 {

132 
__u16
 
	mÄ
;

133 
__u32
 
	mùxid
;

134 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

138 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

140 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

141 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

142 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

143 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

144 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

145 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

146 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

148 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

149 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

150 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

151 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

152 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/nvme.h

14 #iâdeà
_NVME_H


15 
	#_NVME_H


	)

20 
	#KSID_SUPPORT


	)

24 
	~"lšux_nvme.h
"

26 
	~<lšux/nvme.h
>

28 
	~<lšux/pci.h
>

29 
	~<lšux/k»f.h
>

30 
	~<lšux/blk-mq.h
>

33 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

34 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

35 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

36 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

37 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

38 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

39 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

40 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

41 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

42 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

43 
	`is_kv_exi¡_cmd
(
İcode
))

	)

47 
	snvme_io_·¿m
 {

48 
sÿ‰”li¡
* 
	mkv_d©a_sg_±r
;

49 
sÿ‰”li¡
* 
	mkv_m‘a_sg_±r
;

50 
	mkv_d©a_ÃÁs
;

51 
	mkv_d©a_Ën
;

54 
šlše
 
nvme_io_·¿m
 *
	$nvme_io_·¿m
(
»que¡
 *
»q
)

56  
	`blk_mq_rq_to_pdu
(
»q
);

57 
	}
}

67 
	mNVME_SC_CANCELLED
 = -
EINTR
,

70 
nvme_io_timeout
;

71 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

73 
admš_timeout
;

74 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

76 
shutdown_timeout
;

77 
	#SHUTDOWN_TIMEOUT
 (
shutdown_timeout
 * 
HZ
)

	)

80 
	mNVME_NS_LBA
 = 0,

81 
	mNVME_NS_LIGHTNVM
 = 1,

88 
	envme_quœks
 {

93 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

99 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

105 
	mNVME_QUIRK_DISCARD_ZEROES
 = (1 << 2),

111 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

119 
	#NVME_QUIRK_DELAY_AMOUNT
 2000

	)

121 
	snvme_ù¾
 {

122 cÚ¡ 
nvme_ù¾_İs
 *
	mİs
;

123 
»que¡_queue
 *
	madmš_q
;

124 
deviû
 *
	mdev
;

125 
k»f
 
	mk»f
;

126 
	mš¡ªû
;

127 
blk_mq_g_£t
 *
	mg£t
;

128 
li¡_h—d
 
	mÇme¥aûs
;

129 
mu‹x
 
	mÇme¥aûs_mu‹x
;

130 
deviû
 *
	mdeviû
;

131 
li¡_h—d
 
	mnode
;

133 
	mÇme
[12];

134 
	m£rŸl
[20];

135 
	mmod–
[40];

136 
	mfœmw¬e_»v
[8];

138 
u32
 
	mù¾_cÚfig
;

140 
u32
 
	m·ge_size
;

141 
u32
 
	mmax_hw_£ùÜs
;

142 
u32
 
	m¡re_size
;

143 
u16
 
	mÚcs
;

144 
©omic_t
 
	mabÜt_lim™
;

145 
u8
 
	mev’t_lim™
;

146 
u8
 
	mvwc
;

147 
u32
 
	mvs
;

148 
boŞ
 
	msubsy¡em
;

149 
	mquœks
;

155 
	snvme_ns
 {

156 
li¡_h—d
 
	mli¡
;

158 
nvme_ù¾
 *
	mù¾
;

159 
»que¡_queue
 *
	mqueue
;

160 
g’disk
 *
	mdisk
;

161 
k»f
 
	mk»f
;

163 
u8
 
	meui
[8];

164 
u8
 
	muuid
[16];

166 
	mns_id
;

167 
	mlba_shiá
;

168 
u16
 
	mms
;

169 
boŞ
 
	mext
;

170 
u8
 
	mpi_ty³
;

171 
	mty³
;

172 
	mæags
;

174 
	#NVME_NS_REMOVING
 0

	)

175 
	#NVME_NS_DEAD
 1

	)

177 
u64
 
	mmode_£Ëù_num_blocks
;

178 
u32
 
	mmode_£Ëù_block_Ën
;

181 
	snvme_ù¾_İs
 {

182 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

183 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

184 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

185 
boŞ
 (*
io_šÿ·bË
)(
nvme_ù¾
 *
	mù¾
);

186 (*
	m»£t_ù¾
)(
nvme_ù¾
 *
	mù¾
);

187 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

190 
šlše
 
boŞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

192 
u32
 
v®
 = 0;

194 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

195  
çl£
;

196  
v®
 & 
NVME_CSTS_RDY
;

197 
	}
}

199 
šlše
 
boŞ
 
	$nvme_io_šÿ·bË
(
nvme_ù¾
 *
ù¾
)

201 
u32
 
v®
 = 0;

203 ià(
ù¾
->
İs
->
	`io_šÿ·bË
(ctrl))

204  
çl£
;

205 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

206  
çl£
;

207  
v®
 & 
NVME_CSTS_CFS
;

208 
	}
}

210 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

212 ià(!
ù¾
->
subsy¡em
)

213  -
ENOTTY
;

214  
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

215 
	}
}

217 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

219  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

220 
	}
}

222 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

223 
nvme_commªd
 *
cmnd
)

225 
	`mem£t
(
cmnd
, 0, (*cmnd));

226 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

227 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

228 
	}
}

230 
šlše
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

231 
nvme_commªd
 *
cmnd
)

233 
u16
 
cÚŒŞ
 = 0;

234 
u32
 
dsmgmt
 = 0;

236 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

237 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

238 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

239 
cÚŒŞ
 |ğ
NVME_RW_LR
;

241 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

242 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

244 
	`mem£t
(
cmnd
, 0, (*cmnd));

245 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

246 
cmnd
->
rw
.
commªd_id
 = 
»q
->
g
;

247 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

248 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

249 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

251 ià(
ns
->
ms
) {

252 
ns
->
pi_ty³
) {

253 
NVME_NS_DPS_PI_TYPE3
:

254 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
;

256 
NVME_NS_DPS_PI_TYPE1
:

257 
NVME_NS_DPS_PI_TYPE2
:

258 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
 |

259 
NVME_RW_PRINFO_PRCHK_REF
;

260 
cmnd
->
rw
.
»áag
 = 
	`ıu_to_Ë32
(

261 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

264 ià(!
	`blk_š‹gr™y_rq
(
»q
))

265 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

268 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

269 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

270 
	}
}

273 
šlše
 
	$nvme_”rÜ_¡©us
(
u16
 
¡©us
)

275 
¡©us
 & 0x7ff) {

276 
NVME_SC_SUCCESS
:

278 
NVME_SC_CAP_EXCEEDED
:

279  -
ENOSPC
;

281  -
EIO
;

283 
	}
}

285 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
, 
u16
 
¡©us
)

287  !(
¡©us
 & 
NVME_SC_DNR
 || 
	`blk_nÜ‘ry_»que¡
(
»q
)) &&

288 (
jiff›s
 - 
»q
->
¡¬t_time
è<„eq->
timeout
;

289 
	}
}

291 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

292 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

293 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

294 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

295 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
);

296 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

297 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

298 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

300 
nvme_sÿn_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

301 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

303 
nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
);

304 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

305 
nvme_kl_queues
(
nvme_ù¾
 *
ù¾
);

307 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

308 
nvme_commªd
 *
cmd
, 
æags
);

309 
nvme_»queue_»q
(
»que¡
 *
»q
);

310 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

311 *
buf
, 
bufæ’
);

312 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

313 *
bufãr
, 
bufæ’
, 
u32
 *
»suÉ
, 
timeout
);

314 
nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

315 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

316 
timeout
);

317 
__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

318 
__u£r
 *
ubufãr
, 
bufæ’
,

319 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

320 
u32
 *
»suÉ
, 
timeout
);

321 
nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
);

322 
nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

323 
nvme_id_ns
 **
id
);

324 
nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
);

325 
nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

326 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
);

327 
nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

328 
dma_addr_t
 
dma_addr
, 
u32
 *
»suÉ
);

329 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

331 
¥šlock_t
 
dev_li¡_lock
;

333 
	gsg_io_hdr
;

335 
nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
);

336 
nvme_sg_io32
(
nvme_ns
 *
ns
, 
¬g
);

337 
nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

);

339 #ifdeà
CONFIG_NVM


340 
nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
);

341 
nvme_nvm_»gi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
);

342 
nvme_nvm_uÄegi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
);

344 
šlše
 
	$nvme_nvm_»gi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
)

347 
	}
}

349 
šlše
 
	$nvme_nvm_uÄegi¡”
(
»que¡_queue
 *
q
, *
disk_Çme
è{
	}
};

351 
šlše
 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

354 
	}
}

357 
__š™
 
nvme_cÜe_š™
();

358 
nvme_cÜe_ex™
();

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/b™İs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/blk-mq.h
>

19 
	~<lšux/ıu.h
>

20 
	~<lšux/d–ay.h
>

21 
	~<lšux/dma-©Œs.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/g’hd.h
>

25 
	~<lšux/hd»g.h
>

26 
	~<lšux/idr.h
>

27 
	~<lšux/š™.h
>

28 
	~<lšux/š‹¼u±.h
>

29 
	~<lšux/io.h
>

30 
	~<lšux/kdev_t.h
>

31 
	~<lšux/k”Ãl.h
>

32 
	~<lšux/mm.h
>

33 
	~<lšux/moduË.h
>

34 
	~<lšux/moduË·¿m.h
>

35 
	~<lšux/mu‹x.h
>

36 
	~<lšux/pci.h
>

37 
	~<lšux/poisÚ.h
>

38 
	~<lšux/±¿û.h
>

39 
	~<lšux/sched.h
>

40 
	~<lšux/¦ab.h
>

41 
	~<lšux/t10-pi.h
>

42 
	~<lšux/tim”.h
>

43 
	~<lšux/ty³s.h
>

44 
	~<lšux/io-64-nÚ©omic-lo-hi.h
>

45 
	~<asm/uÇligÃd.h
>

47 
	~"nvme.h
"

49 
	#NVME_Q_DEPTH
 1024

	)

50 
	#NVME_AQ_DEPTH
 256

	)

51 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

52 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

55 
	#PCI_VENDOR_ID_GOOGLE
 0x1AE0

	)

61 
	#NVME_NR_AEN_COMMANDS
 1

	)

62 
	#NVME_AQ_BLKMQ_DEPTH
 (
NVME_AQ_DEPTH
 - 
NVME_NR_AEN_COMMANDS
)

	)

64 
	gadmš_timeout
 = 60;

65 
moduË_·¿m
(
admš_timeout
, 
by‹
, 0644);

66 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

68 
	gnvme_io_timeout
 = 30;

69 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
by‹
, 0644);

70 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

72 
	gshutdown_timeout
 = 5;

73 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

74 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

76 
	gu£_th»aded_š‹¼u±s
;

77 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

79 
boŞ
 
	gu£_cmb_sqes
 = 
Œue
;

80 
moduË_·¿m
(
u£_cmb_sqes
, 
boŞ
, 0644);

81 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

83 
wÜkqueue_¡ruù
 *
	gnvme_wÜkq
;

85 
DEFINE_DMA_ATTRS
(
nvme_dma_©Œs
);

87 
	gnvme_dev
;

88 
	gnvme_queue
;

90 
nvme_»£t
(
nvme_dev
 *
dev
);

91 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

92 
nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
);

93 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
);

98 
	snvme_dev
 {

99 
nvme_queue
 **
	mqueues
;

100 
blk_mq_g_£t
 
	mg£t
;

101 
blk_mq_g_£t
 
	madmš_g£t
;

102 
u32
 
__iomem
 *
	mdbs
;

103 
deviû
 *
	mdev
;

104 
dma_poŞ
 *
	m´p_·ge_poŞ
;

105 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

106 
	mqueue_couÁ
;

107 
	mÚlše_queues
;

108 
	mmax_qid
;

109 
	mq_d•th
;

110 
u32
 
	mdb_¡ride
;

111 
msix_’Œy
 *
	m’Œy
;

112 
__iomem
 *
	mb¬
;

113 
wÜk_¡ruù
 
	m»£t_wÜk
;

114 
wÜk_¡ruù
 
	msÿn_wÜk
;

115 
wÜk_¡ruù
 
	m»move_wÜk
;

116 
wÜk_¡ruù
 
	masync_wÜk
;

117 
tim”_li¡
 
	mw©chdog_tim”
;

118 
mu‹x
 
	mshutdown_lock
;

119 
boŞ
 
	msubsy¡em
;

120 
__iomem
 *
	mcmb
;

121 
dma_addr_t
 
	mcmb_dma_addr
;

122 
u64
 
	mcmb_size
;

123 
u32
 
	mcmbsz
;

124 
	mæags
;

126 
	#NVME_CTRL_RESETTING
 0

	)

127 
	#NVME_CTRL_REMOVING
 1

	)

129 
nvme_ù¾
 
	mù¾
;

130 
com¶‘iÚ
 
	mioq_wa™
;

131 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


132 
u32
 *
	mdb_mem
;

133 
dma_addr_t
 
	mdoÜb–l
;

134 
u32
 *
	mei_mem
;

135 
dma_addr_t
 
	mev’tidx
;

139 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

141  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

142 
	}
}

148 
	snvme_queue
 {

149 
deviû
 *
	mq_dmadev
;

150 
nvme_dev
 *
	mdev
;

151 
	mœqÇme
[24];

152 
¥šlock_t
 
	mq_lock
;

153 
nvme_commªd
 *
	msq_cmds
;

154 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

155 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

156 
blk_mq_gs
 **
	mgs
;

157 
dma_addr_t
 
	msq_dma_addr
;

158 
dma_addr_t
 
	mcq_dma_addr
;

159 
u32
 
__iomem
 *
	mq_db
;

160 
u16
 
	mq_d•th
;

161 
s16
 
	mcq_veùÜ
;

162 
u16
 
	msq_h—d
;

163 
u16
 
	msq_
;

164 
u16
 
	mcq_h—d
;

165 
u16
 
	mqid
;

166 
u8
 
	mcq_pha£
;

167 
u8
 
	mcqe_£’
;

168 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


169 
u32
 *
	msq_doÜb–l_addr
;

170 
u32
 *
	msq_ev’tidx_addr
;

171 
u32
 *
	mcq_doÜb–l_addr
;

172 
u32
 *
	mcq_ev’tidx_addr
;

182 
	snvme_iod
 {

184 
nvme_io_·¿m
 
	m·¿m
;

185 
	mkv_cmd
;

186 
	m»rv
;

188 
nvme_queue
 *
	mnvmeq
;

189 
	mabÜ‹d
;

190 
	mÅages
;

191 
	mÃÁs
;

192 
	mËngth
;

193 
dma_addr_t
 
	mfœ¡_dma
;

194 
sÿ‰”li¡
 
	mm‘a_sg
;

195 
sÿ‰”li¡
 *
	msg
;

196 
sÿ‰”li¡
 
	mšlše_sg
[0];

202 
šlše
 
	$_nvme_check_size
()

204 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

205 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

206 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

207 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

208 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

209 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

210 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

211 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

212 
	`BUILD_BUG_ON
((
nvme_id_ù¾
) != 4096);

213 
	`BUILD_BUG_ON
((
nvme_id_ns
) != 4096);

214 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

215 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

216 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


217 
	`BUILD_BUG_ON
((
nvme_doÜb–l_memÜy
) != 64);

219 
	}
}

224 
	#NVME_INT_PAGES
 2

	)

225 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

232 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

234 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

235 
dev
->
ù¾
.
·ge_size
);

236  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

237 
	}
}

239 
	$nvme_iod_®loc_size
(
nvme_dev
 *
dev
,

240 
size
, 
n£g
)

242  (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
) +

243 (
sÿ‰”li¡
è* 
n£g
;

244 
	}
}

246 
	$nvme_cmd_size
(
nvme_dev
 *
dev
)

248  (
nvme_iod
) +

249 
	`nvme_iod_®loc_size
(
dev
, 
	`NVME_INT_BYTES
(dev), 
NVME_INT_PAGES
);

250 
	}
}

252 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

253 
hùx_idx
)

255 
nvme_dev
 *
dev
 = 
d©a
;

256 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

258 
	`WARN_ON
(
hùx_idx
 != 0);

259 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

260 
	`WARN_ON
(
nvmeq
->
gs
);

262 
hùx
->
driv”_d©a
 = 
nvmeq
;

263 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

265 
	}
}

267 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

269 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

271 
nvmeq
->
gs
 = 
NULL
;

272 
	}
}

274 
	$nvme_admš_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

275 
hùx_idx
, 
rq_idx
,

276 
numa_node
)

278 
nvme_dev
 *
dev
 = 
d©a
;

279 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

280 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

282 
	`BUG_ON
(!
nvmeq
);

283 
iod
->
nvmeq
 =‚vmeq;

285 
	}
}

287 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

288 
hùx_idx
)

290 
nvme_dev
 *
dev
 = 
d©a
;

291 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

293 ià(!
nvmeq
->
gs
)

294 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

296 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

297 
hùx
->
driv”_d©a
 = 
nvmeq
;

299 
	}
}

301 
	$nvme_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

302 
hùx_idx
, 
rq_idx
,

303 
numa_node
)

305 
nvme_dev
 *
dev
 = 
d©a
;

306 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

307 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

309 
	`BUG_ON
(!
nvmeq
);

310 
iod
->
nvmeq
 =‚vmeq;

312 
	}
}

314 
	$nvme_queue_sÿn
(
nvme_dev
 *
dev
)

320 ià(
	`‹¡_b™
(
NVME_CTRL_REMOVING
, &
dev
->
æags
))

322 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
sÿn_wÜk
);

323 
	}
}

325 
	$nvme_com¶‘e_async_ev’t
(
nvme_dev
 *
dev
,

326 
nvme_com¶‘iÚ
 *
cqe
)

328 
u16
 
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

329 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

331 ià(
¡©us
 =ğ
NVME_SC_SUCCESS
 || stu =ğ
NVME_SC_ABORT_REQ
) {

332 ++
dev
->
ù¾
.
ev’t_lim™
;

333 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
async_wÜk
);

336 ià(
¡©us
 !ğ
NVME_SC_SUCCESS
)

339 
»suÉ
 & 0xff07) {

340 
NVME_AER_NOTICE_NS_CHANGED
:

341 
	`dev_šfo
(
dev
->dev, "rescanning\n");

342 
	`nvme_queue_sÿn
(
dev
);

344 
	`dev_w¬n
(
dev
->dev, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

346 
	}
}

348 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


349 
	$nvme_v’dÜ_memÜy_size
(
nvme_dev
 *
dev
)

351  ((
	`num_possibË_ıus
(è+ 1è* 8 * 
dev
->
db_¡ride
);

352 
	}
}

354 
	$nvme_£t_doÜb–l_memÜy
(
nvme_dev
 *
dev
)

356 
nvme_commªd
 
c
;

358 
	`mem£t
(&
c
, 0, (c));

359 
c
.
doÜb–l_memÜy
.
İcode
 = 
nvme_admš_doÜb–l_memÜy
;

360 
c
.
doÜb–l_memÜy
.
´p1
 = 
	`ıu_to_Ë64
(
dev
->
doÜb–l
);

361 
c
.
doÜb–l_memÜy
.
´p2
 = 
	`ıu_to_Ë64
(
dev
->
ev’tidx
);

363  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

364 
	}
}

366 
šlše
 
	$nvme_ext_Ãed_ev’t
(
u16
 
ev’t_idx
, u16 
Ãw_idx
, u16 
Şd
)

369  (
u16
)(
Ãw_idx
 - 
ev’t_idx
 - 1è< (u16)Òew_idx - 
Şd
);

370 
	}
}

372 
	$nvme_ext_wr™e_doÜb–l
(
u16
 
v®ue
, 
u32
 
__iomem
* 
q_db
,

373 
u32
* 
db_addr
, vŞ©u32* 
ev’t_idx
)

375 
u16
 
Şd_v®ue
;

376 ià(!
db_addr
)

377 
ršg_doÜb–l
;

379 
Şd_v®ue
 = *
db_addr
;

380 *
db_addr
 = 
v®ue
;

382 
	`rmb
();

383 ià(!
	`nvme_ext_Ãed_ev’t
(*
ev’t_idx
, 
v®ue
, 
Şd_v®ue
))

384 
no_doÜb–l
;

386 
ršg_doÜb–l
:

387 
	`wr™–
(
v®ue
, 
q_db
);

388 
no_doÜb–l
:

390 
	}
}

400 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
,

401 
nvme_commªd
 *
cmd
)

403 
u16
 

 = 
nvmeq
->
sq_
;

405 ià(
nvmeq
->
sq_cmds_io
)

406 
	`memıy_toio
(&
nvmeq
->
sq_cmds_io
[

], 
cmd
, (*cmd));

408 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

410 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


411 ià(
nvmeq
->
sq_doÜb–l_addr
)

412 
	`wmb
();

415 ià(++

 =ğ
nvmeq
->
q_d•th
)

416 

 = 0;

417 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


418 
	`nvme_ext_wr™e_doÜb–l
(

, 
nvmeq
->
q_db
,

419 
nvmeq
->
sq_doÜb–l_addr
,‚vmeq->
sq_ev’tidx_addr
);

421 
	`wr™–
(

, 
nvmeq
->
q_db
);

423 
nvmeq
->
sq_
 = 

;

424 
	}
}

426 
__Ë64
 **
	$iod_li¡
(
»que¡
 *
»q
)

428 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

429  (
__Ë64
 **)(
iod
->
sg
 + 
»q
->
Ä_phys_£gm’ts
);

430 
	}
}

433 
	$__nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
, 
boŞ
 
kv
)

435 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

436 
n£g
;

437 
size
;

438 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

439 ià(
kv
) {

440 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

442 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

445 ià(
kv
) {

446 
size
 = 
·¿m
->
kv_d©a_Ën
;

448 ià(
rq
->
cmd_æags
 & 
REQ_DISCARD
)

449 
size
 = (
nvme_dsm_¿nge
);

451 
size
 = 
	`blk_rq_by‹s
(
rq
);

453 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

454 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

455 ià(!
iod
->
sg
)

456  
BLK_MQ_RQ_QUEUE_BUSY
;

458 
iod
->
sg
 = iod->
šlše_sg
;

461 
iod
->
abÜ‹d
 = 0;

462 
iod
->
Åages
 = -1;

463 
iod
->
ÃÁs
 = 0;

464 
iod
->
Ëngth
 = 
size
;

466 
	}
}

468 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

470  
	`__nvme_š™_iod
(
rq
, 
dev
, 
çl£
);

471 
	}
}

473 
	$nvme_š™_iod_fÜ_kv
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

475  
	`__nvme_š™_iod
(
rq
, 
dev
, 
Œue
);

476 
	}
}

479 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
nvme_dev
 *
dev
)

481 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

482 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

483 
size
;

485 ià(
rq
->
cmd_æags
 & 
REQ_DISCARD
)

486 
size
 = (
nvme_dsm_¿nge
);

488 
size
 = 
	`blk_rq_by‹s
(
rq
);

490 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

491 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

492 ià(!
iod
->
sg
)

493  
BLK_MQ_RQ_QUEUE_BUSY
;

495 
iod
->
sg
 = iod->
šlše_sg
;

498 
iod
->
abÜ‹d
 = 0;

499 
iod
->
Åages
 = -1;

500 
iod
->
ÃÁs
 = 0;

501 
iod
->
Ëngth
 = 
size
;

503 
	}
}

506 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

508 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

509 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / 8 - 1;

510 
i
;

511 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

512 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

514 ià(
iod
->
Åages
 == 0)

515 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

516 
i
 = 0; i < 
iod
->
Åages
; i++) {

517 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

518 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

519 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

520 
´p_dma
 = 
Ãxt_´p_dma
;

523 ià(
iod
->
sg
 !ğiod->
šlše_sg
)

524 
	`kä“
(
iod
->
sg
);

525 
	}
}

527 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


528 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

530 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
v
)

531 
pi
->
»f_g
 = 
	`ıu_to_be32
(
p
);

532 
	}
}

534 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

536 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
p
)

537 
pi
->
»f_g
 = 
	`ıu_to_be32
(
v
);

538 
	}
}

550 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

551 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

553 
nvme_ns
 *
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

554 
bio_š‹gr™y_·ylßd
 *
b
;

555 
t10_pi_tu¶e
 *
pi
;

556 *
p
, *
pm­
;

557 
u32
 
i
, 
Æb
, 
ts
, 
phys
, 
vœt
;

559 ià(!
ns
->
pi_ty³
 ||‚s->pi_ty³ =ğ
NVME_NS_DPS_PI_TYPE3
)

562 
b
 = 
	`bio_š‹gr™y
(
»q
->
bio
);

563 ià(!
b
)

566 
pm­
 = 
	`km­_©omic
(
b
->
b_vec
->
bv_·ge
è+ b->b_vec->
bv_off£t
;

568 
p
 = 
pm­
;

569 
vœt
 = 
	`b_g‘_£ed
(
b
);

570 
phys
 = 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
));

571 
Æb
 = (
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

572 
ts
 = 
ns
->
disk
->
queue
->
š‹gr™y
.
tu¶e_size
;

574 
i
 = 0; i < 
Æb
; i++, 
vœt
++, 
phys
++) {

575 
pi
 = (
t10_pi_tu¶e
 *)
p
;

576 
	`dif_sw­
(
phys
, 
vœt
, 
pi
);

577 
p
 +ğ
ts
;

579 
	`kunm­_©omic
(
pm­
);

580 
	}
}

582 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

583 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

585 
	}
}

586 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

588 
	}
}

589 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

591 
	}
}

594 
boŞ
 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

595 
tÙ®_Ën
)

597 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

598 
dma_poŞ
 *
poŞ
;

599 
Ëngth
 = 
tÙ®_Ën
;

600 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

601 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

602 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

603 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

604 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

605 
__Ë64
 *
´p_li¡
;

606 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

607 
dma_addr_t
 
´p_dma
;

608 
Å½s
, 
i
;

610 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

611 ià(
Ëngth
 <= 0)

612  
Œue
;

614 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

615 ià(
dma_Ën
) {

616 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

618 
sg
 = 
	`sg_Ãxt
(sg);

619 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

620 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

623 ià(
Ëngth
 <ğ
·ge_size
) {

624 
iod
->
fœ¡_dma
 = 
dma_addr
;

625  
Œue
;

628 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

629 ià(
Å½s
 <= (256 / 8)) {

630 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

631 
iod
->
Åages
 = 0;

633 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

634 
iod
->
Åages
 = 1;

637 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

638 ià(!
´p_li¡
) {

639 
iod
->
fœ¡_dma
 = 
dma_addr
;

640 
iod
->
Åages
 = -1;

641  
çl£
;

643 
li¡
[0] = 
´p_li¡
;

644 
iod
->
fœ¡_dma
 = 
´p_dma
;

645 
i
 = 0;

647 ià(
i
 =ğ
·ge_size
 >> 3) {

648 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

649 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

650 ià(!
´p_li¡
)

651  
çl£
;

652 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

653 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

654 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

655 
i
 = 1;

657 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

658 
dma_Ën
 -ğ
·ge_size
;

659 
dma_addr
 +ğ
·ge_size
;

660 
Ëngth
 -ğ
·ge_size
;

661 ià(
Ëngth
 <= 0)

663 ià(
dma_Ën
 > 0)

665 
	`BUG_ON
(
dma_Ën
 < 0);

666 
sg
 = 
	`sg_Ãxt
(sg);

667 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

668 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

671  
Œue
;

672 
	}
}

675 
	$nvme_kv_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

676 
nvme_commªd
 *
cmnd
)

678 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

679 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

680 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

681 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

683 ià(
·¿m
->
kv_d©a_sg_±r
) {

684 
sÿ‰”li¡
* 
sg
;

685 
i
;

687 
	`fÜ_—ch_sg
(
·¿m
->
kv_d©a_sg_±r
, 
sg
,…¬am->
kv_d©a_ÃÁs
, 
i
) {

688 
iod
->
sg
[
i
] = *sg;

690 
iod
->
ÃÁs
 = 
·¿m
->
kv_d©a_ÃÁs
;

691 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

692 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

693 &
nvme_dma_©Œs
))

694 
out
;

696 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
·¿m
->
kv_d©a_Ën
))

697 
out_unm­
;

699 
cmnd
->
kv_¡Üe
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

700 
cmnd
->
kv_¡Üe
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

702 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

704 ià(
·¿m
->
kv_m‘a_sg_±r
)

706 ià(!
	`dma_m­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
))

707 
out_unm­
;

708 
cmnd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
·¿m
->
kv_m‘a_sg_±r
));

710  
BLK_MQ_RQ_QUEUE_OK
;

712 
out_unm­
:

713 ià(
·¿m
->
kv_d©a_sg_±r
)

714 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

715 
out
:

716  
»t
;

717 
	}
}

720 
	$nvme_kv_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

722 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

723 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

724 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

726 ià(
·¿m
->
kv_d©a_sg_±r
) {

727 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

729 ià(
·¿m
->
kv_m‘a_sg_±r
)

731 
	`dma_unm­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
);

733 
	`nvme_ä“_iod
(
dev
, 
»q
);

734 
	}
}

737 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

738 
nvme_commªd
 *
cmnd
)

740 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

741 
»que¡_queue
 *
q
 = 
»q
->q;

742 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

743 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

744 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

746 ià(
	`is_kv_cmd
(
cmnd
->
commÚ
.
İcode
)) {

747  
	`nvme_kv_m­_d©a
(
dev
, 
»q
, 
cmnd
);

750 
	`sg_š™_bË
(
iod
->
sg
, 
»q
->
Ä_phys_£gm’ts
);

751 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

752 ià(!
iod
->
ÃÁs
)

753 
out
;

755 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

756 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

757 &
nvme_dma_©Œs
))

758 
out
;

760 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
	`blk_rq_by‹s
(req)))

761 
out_unm­
;

763 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

764 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

765 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

766 
out_unm­
;

768 
	`sg_š™_bË
(&
iod
->
m‘a_sg
, 1);

769 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, &
iod
->
m‘a_sg
) != 1)

770 
out_unm­
;

772 ià(
	`rq_d©a_dœ
(
»q
))

773 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_´•
);

775 ià(!
	`dma_m­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
))

776 
out_unm­
;

779 
cmnd
->
rw
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

780 
cmnd
->
rw
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

781 ià(
	`blk_š‹gr™y_rq
(
»q
))

782 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(&
iod
->
m‘a_sg
));

783  
BLK_MQ_RQ_QUEUE_OK
;

785 
out_unm­
:

786 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

787 
out
:

788  
»t
;

789 
	}
}

791 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

793 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

794 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

795 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

797 ià(
iod
->
kv_cmd
) {

798  
	`nvme_kv_unm­_d©a
(
dev
, 
»q
);

801 ià(
iod
->
ÃÁs
) {

802 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

803 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

804 ià(!
	`rq_d©a_dœ
(
»q
))

805 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_com¶‘e
);

806 
	`dma_unm­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
);

810 
	`nvme_ä“_iod
(
dev
, 
»q
);

811 
	}
}

818 
	$nvme_£tup_disÿrd
(
nvme_queue
 *
nvmeq
, 
nvme_ns
 *
ns
,

819 
»que¡
 *
»q
, 
nvme_commªd
 *
cmnd
)

821 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

822 
nvme_dsm_¿nge
 *
¿nge
;

824 
¿nge
 = 
	`dma_poŞ_®loc
(
nvmeq
->
dev
->
´p_sm®l_poŞ
, 
GFP_ATOMIC
,

825 &
iod
->
fœ¡_dma
);

826 ià(!
¿nge
)

827  
BLK_MQ_RQ_QUEUE_BUSY
;

828 
	`iod_li¡
(
»q
)[0] = (
__Ë64
 *)
¿nge
;

829 
iod
->
Åages
 = 0;

831 
¿nge
->
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

832 
¿nge
->
Æb
 = 
	`ıu_to_Ë32
(
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

833 
¿nge
->
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

835 
	`mem£t
(
cmnd
, 0, (*cmnd));

836 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

837 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

838 
cmnd
->
dsm
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

839 
cmnd
->
dsm
.
Ä
 = 0;

840 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

841  
BLK_MQ_RQ_QUEUE_OK
;

842 
	}
}

847 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

848 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

850 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

851 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

852 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

853 
»que¡
 *
»q
 = 
bd
->
rq
;

854 
nvme_commªd
 
cmnd
;

855 
»t
 = 
BLK_MQ_RQ_QUEUE_OK
;

862 ià(
ns
 &&‚s->
ms
 && !
	`blk_š‹gr™y_rq
(
»q
)) {

863 ià(!(
ns
->
pi_ty³
 &&‚s->
ms
 == 8) &&

864 
»q
->
cmd_ty³
 !ğ
REQ_TYPE_DRV_PRIV
) {

865 
	`blk_mq_’d_»que¡
(
»q
, -
EFAULT
);

866  
BLK_MQ_RQ_QUEUE_OK
;

871 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
) {

872 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

873 ià(
»t
)

874  
»t
;

875 
»t
 = 
	`nvme_£tup_disÿrd
(
nvmeq
, 
ns
, 
»q
, &
cmnd
);

877 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

878 
	`memıy
(&
cmnd
, 
»q
->
cmd
, (cmnd));

879 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

880 
	`nvme_£tup_æush
(
ns
, &
cmnd
);

882 
	`nvme_£tup_rw
(
ns
, 
»q
, &
cmnd
);

884 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

885 
»t
 = 
	`nvme_š™_iod_fÜ_kv
(
»q
, 
dev
);

887 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

889 ià(
»t
)

890  
»t
;

892 ià(
»q
->
Ä_phys_£gm’ts
 || 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
))

893 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

897 
»t
 = 
	`nvme_š™_iod
(
»q
, 
dev
);

898 ià(
»t
)

899  
»t
;

901 ià(
»q
->
cmd_æags
 & 
REQ_DISCARD
) {

902 
»t
 = 
	`nvme_£tup_disÿrd
(
nvmeq
, 
ns
, 
»q
, &
cmnd
);

904 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

905 
	`memıy
(&
cmnd
, 
»q
->
cmd
, (cmnd));

906 ià(
»q
->
cmd_æags
 & 
REQ_FLUSH
)

907 
	`nvme_£tup_æush
(
ns
, &
cmnd
);

909 
	`nvme_£tup_rw
(
ns
, 
»q
, &
cmnd
);

911 ià(
»q
->
Ä_phys_£gm’ts
)

912 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, &
cmnd
);

915 ià(
»t
)

916 
out
;

918 
cmnd
.
commÚ
.
commªd_id
 = 
»q
->
g
;

919 
	`blk_mq_¡¬t_»que¡
(
»q
);

920 #ifdeà
KV_NVME_DUMMY_OP


921 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

922 #ifdeà
KV_NVME_DUMMY_OP_REPORT


923 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

924 
	`´_”r
("[dump‚vme kv comand]\n");

925 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

926 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

927 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

928 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

929 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

930 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

931 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

932 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

933 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

934 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

935 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

936 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

937 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

938 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

939 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

940 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

941 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

942 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

944 ià(
	`is_kv_»Œ›ve_cmd
(
cmnd
.
commÚ
.
İcode
)) {

945 
»q
->
¥ecŸl
 = (*)(
ušŒ_t
)
cmnd
.
commÚ
.
cdw10
[5];

947 
	`blk_mq_com¶‘e_»que¡
(
»q
, 0);

948  
BLK_MQ_RQ_QUEUE_OK
;

951 #ifdeà
KV_NVME_OP_REPORT


952 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

953 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

954 
	`´_”r
("[dump‚vme kv comand]\n");

955 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

956 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

957 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

958 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

959 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

960 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

961 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

962 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

963 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

964 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

965 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

966 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

967 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

968 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

969 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

970 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

971 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

972 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

975 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

976 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0)) {

977 ià(
ns
 && !
	`‹¡_b™
(
NVME_NS_DEAD
, &ns->
æags
))

978 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

980 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

981 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

982 
out
;

984 
	`__nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

985 
	`nvme_´oûss_cq
(
nvmeq
);

986 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

987  
BLK_MQ_RQ_QUEUE_OK
;

988 
out
:

989 
	`nvme_ä“_iod
(
dev
, 
»q
);

990  
»t
;

991 
	}
}

993 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

995 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

996 
nvme_dev
 *
dev
 = 
iod
->
nvmeq
->dev;

997 
”rÜ
 = 0;

999 
	`nvme_unm­_d©a
(
dev
, 
»q
);

1001 ià(
	`uÆik–y
(
»q
->
”rÜs
)) {

1002 ià(
	`nvme_»q_Ãeds_»Œy
(
»q
,„eq->
”rÜs
)) {

1003 
	`nvme_»queue_»q
(
»q
);

1007 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

1008 
”rÜ
 = 
»q
->
”rÜs
;

1010 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
»q
->
”rÜs
);

1013 ià(
	`uÆik–y
(
iod
->
abÜ‹d
)) {

1014 
	`dev_w¬n
(
dev
->dev,

1016 
»q
->
”rÜs
);

1019 
	`blk_mq_’d_»que¡
(
»q
, 
”rÜ
);

1020 
	}
}

1022 
	$__nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
, *
g
)

1024 
u16
 
h—d
, 
pha£
;

1026 
h—d
 = 
nvmeq
->
cq_h—d
;

1027 
pha£
 = 
nvmeq
->
cq_pha£
;

1030 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[
h—d
];

1031 
u16
 
¡©us
 = 
	`Ë16_to_ıu
(
cqe
.status);

1032 
»que¡
 *
»q
;

1034 ià((
¡©us
 & 1è!ğ
pha£
)

1036 
nvmeq
->
sq_h—d
 = 
	`Ë16_to_ıu
(
cqe
.sq_head);

1038 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1039 ià(
	`to_pci_dev
(
nvmeq
->
dev
->dev)->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
)

1040 
	`rmb
();

1043 ià(++
h—d
 =ğ
nvmeq
->
q_d•th
) {

1044 
h—d
 = 0;

1045 
pha£
 = !phase;

1048 ià(
g
 && *g =ğ
cqe
.
commªd_id
)

1049 *
g
 = -1;

1051 ià(
	`uÆik–y
(
cqe
.
commªd_id
 >ğ
nvmeq
->
q_d•th
)) {

1052 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

1054 
cqe
.
commªd_id
, 
	`Ë16_to_ıu
(cqe.
sq_id
));

1064 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

1065 
cqe
.
commªd_id
 >ğ
NVME_AQ_BLKMQ_DEPTH
)) {

1066 
	`nvme_com¶‘e_async_ev’t
(
nvmeq
->
dev
, &
cqe
);

1070 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
.
commªd_id
);

1071 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

1072 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1073 
»q
->
¥ecŸl
 = (*)(
ušŒ_t
)
»suÉ
;

1075 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
¡©us
 >> 1);

1085 ià(
h—d
 =ğ
nvmeq
->
cq_h—d
 && 
pha£
 =ğnvmeq->
cq_pha£
)

1088 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0))

1089 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1090 
	`nvme_ext_wr™e_doÜb–l
(
h—d
,

1091 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
,

1092 
nvmeq
->
cq_doÜb–l_addr
,

1093 
nvmeq
->
cq_ev’tidx_addr
);

1095 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

1097 
nvmeq
->
cq_h—d
 = 
h—d
;

1098 
nvmeq
->
cq_pha£
 = 
pha£
;

1100 
nvmeq
->
cqe_£’
 = 1;

1101 
	}
}

1103 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

1105 
	`__nvme_´oûss_cq
(
nvmeq
, 
NULL
);

1106 
	}
}

1108 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

1110 
œq»tuº_t
 
»suÉ
;

1111 
nvme_queue
 *
nvmeq
 = 
d©a
;

1112 
	`¥š_lock
(&
nvmeq
->
q_lock
);

1113 
	`nvme_´oûss_cq
(
nvmeq
);

1114 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

1115 
nvmeq
->
cqe_£’
 = 0;

1116 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

1117  
»suÉ
;

1118 
	}
}

1120 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

1122 
nvme_queue
 *
nvmeq
 = 
d©a
;

1123 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[nvmeq->
cq_h—d
];

1124 ià((
	`Ë16_to_ıu
(
cqe
.
¡©us
è& 1è!ğ
nvmeq
->
cq_pha£
)

1125  
IRQ_NONE
;

1126  
IRQ_WAKE_THREAD
;

1127 
	}
}

1129 
	$nvme_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1131 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

1133 ià((
	`Ë16_to_ıu
(
nvmeq
->
cqes
[nvmeq->
cq_h—d
].
¡©us
) & 1) ==

1134 
nvmeq
->
cq_pha£
) {

1135 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1136 
	`__nvme_´oûss_cq
(
nvmeq
, &
g
);

1137 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1139 ià(
g
 == -1)

1144 
	}
}

1146 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1148 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
async_wÜk
);

1149 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1150 
nvme_commªd
 
c
;

1152 
	`mem£t
(&
c
, 0, (c));

1153 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1155 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1156 
dev
->
ù¾
.
ev’t_lim™
 > 0) {

1157 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLKMQ_DEPTH
 +

1158 --
dev
->
ù¾
.
ev’t_lim™
;

1159 
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

1161 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1162 
	}
}

1164 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1166 
nvme_commªd
 
c
;

1168 
	`mem£t
(&
c
, 0, (c));

1169 
c
.
d–‘e_queue
.
İcode
 = opcode;

1170 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1172  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1173 
	}
}

1175 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1176 
nvme_queue
 *
nvmeq
)

1178 
nvme_commªd
 
c
;

1179 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1185 
	`mem£t
(&
c
, 0, (c));

1186 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1187 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1188 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1189 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1190 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1191 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1193  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1194 
	}
}

1196 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1197 
nvme_queue
 *
nvmeq
)

1199 
nvme_commªd
 
c
;

1200 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_SQ_PRIO_MEDIUM
;

1206 
	`mem£t
(&
c
, 0, (c));

1207 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1208 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1209 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1210 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1211 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1212 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1214  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1215 
	}
}

1217 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1219  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1220 
	}
}

1222 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1224  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1225 
	}
}

1227 
	$abÜt_’dio
(
»que¡
 *
»q
, 
”rÜ
)

1229 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1230 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1231 
u32
 
»suÉ
 = (u32)(
ušŒ_t
)
»q
->
¥ecŸl
;

1232 
u16
 
¡©us
 = 
»q
->
”rÜs
;

1234 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "AbÜˆ¡©us:%x„esuÉ:%x", 
¡©us
, 
»suÉ
);

1235 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

1237 
	`blk_mq_ä“_»que¡
(
»q
);

1238 
	}
}

1240 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

1242 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1243 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1244 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1245 
»que¡
 *
abÜt_»q
;

1246 
nvme_commªd
 
cmd
;

1254 ià(
	`‹¡_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
)) {

1255 
	`dev_w¬n
(
dev
->dev,

1257 
»q
->
g
, 
nvmeq
->
qid
);

1258 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1259 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1260  
BLK_EH_HANDLED
;

1268 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

1269 
	`dev_w¬n
(
dev
->dev,

1271 
»q
->
g
, 
nvmeq
->
qid
);

1272 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1273 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

1279 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1280  
BLK_EH_HANDLED
;

1282 #ifdeà
REPORT_TIMEOUT


1284 
nvme_ns
 *
ns
 = 
NULL
;

1285 
cmd
.
commÚ
.
nsid
 = 0;

1286 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

1287 
	`memıy
(&
cmd
, 
»q
->cmd,  (
nvme_commªd
));

1289 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
) {

1290 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1291 } ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
) {

1292 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_dsm
;

1294 
cmd
.
commÚ
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
: 
nvme_cmd_»ad
);

1296 ià(
»q
->
rq_disk
) {

1297 
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

1298 ià(
ns
è
cmd
.
commÚ
.
nsid
 =‚s->
ns_id
;

1301 ià(
iod
->
kv_cmd
)

1303 
__u32
 *
d©a
 = (__u32*è
cmd
.
commÚ
.
cdw2
;

1304 
	`´_”r
("nvme_timeout: opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1305 
	`´_”r
("[dump‚vme kv comand]\n");

1306 
	`´_”r
("\tİcode:(%02x)\n", 
cmd
.
commÚ
.
İcode
);

1307 
	`´_”r
("\tæags:(%02x)\n", 
cmd
.
commÚ
.
æags
);

1308 
	`´_”r
("\tcommªd id:(%04x)\n", 
»q
->
g
);

1309 
	`´_”r
("\Š id:(%08x)\n", 
cmd
.
commÚ
.
nsid
);

1310 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

1311 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

1312 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

1313 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

1314 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

1315 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

1316 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

1317 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

1318 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

1319 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

1320 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

1321 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

1322 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

1323 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

1325 
	`´_”r
("nvme_timeout:‚Ú kv opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1329 
iod
->
abÜ‹d
 = 1;

1331 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1332 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1333  
BLK_EH_RESET_TIMER
;

1336 
	`mem£t
(&
cmd
, 0, (cmd));

1337 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1338 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1339 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1341 
	`dev_w¬n
(
nvmeq
->
q_dmadev
, "I/O %d QID %dimeout,‡borting\n",

1342 
»q
->
g
, 
nvmeq
->
qid
);

1344 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1345 
BLK_MQ_REQ_NOWAIT
);

1346 ià(
	`IS_ERR
(
abÜt_»q
)) {

1347 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1348  
BLK_EH_RESET_TIMER
;

1351 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1352 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1353 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1360  
BLK_EH_RESET_TIMER
;

1361 
	}
}

1363 
	$nvme_ÿnûl_queue_ios
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

1365 
nvme_queue
 *
nvmeq
 = 
d©a
;

1366 
¡©us
;

1368 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

1371 
	`dev_w¬n
(
nvmeq
->
q_dmadev
,

1372 "CªûÎšg I/O %d QID %d\n", 
»q
->
g
, 
nvmeq
->
qid
);

1374 
¡©us
 = 
NVME_SC_ABORT_REQ
;

1375 ià(
	`blk_queue_dyšg
(
»q
->
q
))

1376 
¡©us
 |ğ
NVME_SC_DNR
;

1377 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
¡©us
);

1378 
	}
}

1380 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1382 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1383 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1384 ià(
nvmeq
->
sq_cmds
)

1385 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1386 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1387 
	`kä“
(
nvmeq
);

1388 
	}
}

1390 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1392 
i
;

1394 
i
 = 
dev
->
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1395 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1396 
dev
->
queue_couÁ
--;

1397 
dev
->
queues
[
i
] = 
NULL
;

1398 
	`nvme_ä“_queue
(
nvmeq
);

1400 
	}
}

1406 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1408 
veùÜ
;

1410 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1411 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1412 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1415 
veùÜ
 = 
nvmeq
->
dev
->
’Œy
[nvmeq->
cq_veùÜ
].vector;

1416 
nvmeq
->
dev
->
Úlše_queues
--;

1417 
nvmeq
->
cq_veùÜ
 = -1;

1418 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1420 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1421 
	`blk_mq_¡İ_hw_queues
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1423 
	`œq_£t_affš™y_hšt
(
veùÜ
, 
NULL
);

1424 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1427 
	}
}

1429 
	$nvme_ş—r_queue
(
nvme_queue
 *
nvmeq
)

1431 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1432 ià(
nvmeq
->
gs
 && *nvmeq->tags)

1433 
	`blk_mq_®l_g_busy_™”
(*
nvmeq
->
gs
, 
nvme_ÿnûl_queue_ios
,‚vmeq);

1434 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1435 
	}
}

1437 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1439 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1441 ià(!
nvmeq
)

1443 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1446 ià(
shutdown
)

1447 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1449 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
	`lo_hi_»adq
(

1450 
dev
->
b¬
 + 
NVME_REG_CAP
));

1452 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1453 
	`nvme_´oûss_cq
(
nvmeq
);

1454 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1455 
	}
}

1457 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1458 
’Œy_size
)

1460 
q_d•th
 = 
dev
->q_depth;

1461 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1462 
dev
->
ù¾
.
·ge_size
);

1464 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1465 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1466 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1467 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1474 ià(
q_d•th
 < 64)

1475  -
ENOMEM
;

1478  
q_d•th
;

1479 
	}
}

1481 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1482 
qid
, 
d•th
)

1484 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1485 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
d•th
),

1486 
dev
->
ù¾
.
·ge_size
);

1487 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_dma_addr
 + 
off£t
;

1488 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1490 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1491 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1492 ià(!
nvmeq
->
sq_cmds
)

1493  -
ENOMEM
;

1497 
	}
}

1499 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1500 
d•th
)

1502 
nvme_queue
 *
nvmeq
 = 
	`kz®loc
((*nvmeq), 
GFP_KERNEL
);

1503 ià(!
nvmeq
)

1504  
NULL
;

1506 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1507 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1508 ià(!
nvmeq
->
cqes
)

1509 
ä“_nvmeq
;

1511 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1512 
ä“_cqdma
;

1514 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1515 
nvmeq
->
dev
 = dev;

1516 
	`¢´štf
(
nvmeq
->
œqÇme
, (nvmeq->irqname), "nvme%dq%d",

1517 
dev
->
ù¾
.
š¡ªû
, 
qid
);

1518 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1519 
nvmeq
->
cq_h—d
 = 0;

1520 
nvmeq
->
cq_pha£
 = 1;

1521 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1522 
nvmeq
->
q_d•th
 = 
d•th
;

1523 
nvmeq
->
qid
 = qid;

1524 
nvmeq
->
cq_veùÜ
 = -1;

1525 
dev
->
queues
[
qid
] = 
nvmeq
;

1526 
dev
->
queue_couÁ
++;

1528 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1529 ià(
dev
->
db_mem
 && dev->
ei_mem
 && 
qid
 != 0) {

1530 
nvmeq
->
sq_doÜb–l_addr
 = &
dev
->
db_mem
[
qid
 * 2 * dev->
db_¡ride
];

1531 
nvmeq
->
cq_doÜb–l_addr
 =

1532 &
dev
->
db_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1533 
nvmeq
->
sq_ev’tidx_addr
 = &
dev
->
ei_mem
[
qid
 * 2 * dev->
db_¡ride
];

1534 
nvmeq
->
cq_ev’tidx_addr
 =

1535 &
dev
->
ei_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1539  
nvmeq
;

1541 
ä“_cqdma
:

1542 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1543 
nvmeq
->
cq_dma_addr
);

1544 
ä“_nvmeq
:

1545 
	`kä“
(
nvmeq
);

1546  
NULL
;

1547 
	}
}

1549 
	$queue_»que¡_œq
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1550 cÚ¡ *
Çme
)

1552 ià(
u£_th»aded_š‹¼u±s
)

1553  
	`»que¡_th»aded_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1554 
nvme_œq_check
, 
nvme_œq
, 
IRQF_SHARED
,

1555 
Çme
, 
nvmeq
);

1556  
	`»que¡_œq
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
, 
nvme_œq
,

1557 
IRQF_SHARED
, 
Çme
, 
nvmeq
);

1558 
	}
}

1560 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1562 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1564 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1565 
nvmeq
->
sq_
 = 0;

1566 
nvmeq
->
cq_h—d
 = 0;

1567 
nvmeq
->
cq_pha£
 = 1;

1568 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1569 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


1570 ià(
	`to_pci_dev
(
dev
->dev)->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
 && 
qid
 != 0) {

1571 
nvmeq
->
sq_doÜb–l_addr
 = &
dev
->
db_mem
[
qid
 * 2 * dev->
db_¡ride
];

1572 
nvmeq
->
cq_doÜb–l_addr
 =

1573 &
dev
->
db_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1574 
nvmeq
->
sq_ev’tidx_addr
 = &
dev
->
ei_mem
[
qid
 * 2 * dev->
db_¡ride
];

1575 
nvmeq
->
cq_ev’tidx_addr
 =

1576 &
dev
->
ei_mem
[(
qid
 * 2 + 1è* dev->
db_¡ride
];

1579 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1580 
dev
->
Úlše_queues
++;

1581 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1582 
	}
}

1584 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1586 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1587 
»suÉ
;

1589 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1590 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1591 ià(
»suÉ
 < 0)

1592  
»suÉ
;

1594 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1595 ià(
»suÉ
 < 0)

1596 
»Ëa£_cq
;

1598 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1599 ià(
»suÉ
 < 0)

1600 
»Ëa£_sq
;

1602 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1603  
»suÉ
;

1605 
»Ëa£_sq
:

1606 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1607 
»Ëa£_cq
:

1608 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1609  
»suÉ
;

1610 
	}
}

1612 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1613 .
queue_rq
 = 
nvme_queue_rq
,

1614 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1615 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1616 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1617 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1618 .
	gš™_»que¡
 = 
nvme_admš_š™_»que¡
,

1619 .
	gtimeout
 = 
nvme_timeout
,

1622 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1623 .
queue_rq
 = 
nvme_queue_rq
,

1624 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1625 .
	gm­_queue
 = 
blk_mq_m­_queue
,

1626 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1627 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1628 .
	gtimeout
 = 
nvme_timeout
,

1629 .
	gpŞl
 = 
nvme_pŞl
,

1632 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1634 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1640 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1641 
	`blk_ş—nup_queue
(
dev
->
ù¾
.
admš_q
);

1642 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1644 
	}
}

1646 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1648 ià(!
dev
->
ù¾
.
admš_q
) {

1649 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1650 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1656 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_BLKMQ_DEPTH
 - 1;

1657 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1658 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1659 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1660 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1662 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1663  -
ENOMEM
;

1665 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1666 ià(
	`IS_ERR
(
dev
->
ù¾
.
admš_q
)) {

1667 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1668  -
ENOMEM
;

1670 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1671 
	`nvme_dev_»move_admš
(
dev
);

1672 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1673  -
ENODEV
;

1676 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1679 
	}
}

1681 
	$nvme_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1683 
»suÉ
;

1684 
u32
 
aqa
;

1685 
u64
 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

1686 
nvme_queue
 *
nvmeq
;

1688 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 1) ?

1689 
	`NVME_CAP_NSSRC
(
ÿp
) : 0;

1691 ià(
dev
->
subsy¡em
 &&

1692 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1693 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1695 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1696 ià(
»suÉ
 < 0)

1697  
»suÉ
;

1699 
nvmeq
 = 
dev
->
queues
[0];

1700 ià(!
nvmeq
) {

1701 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1702 ià(!
nvmeq
)

1703  -
ENOMEM
;

1706 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1707 
aqa
 |=‡qa << 16;

1709 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1710 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1711 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

1713 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1714 ià(
»suÉ
)

1715 
ä“_nvmeq
;

1717 
nvmeq
->
cq_veùÜ
 = 0;

1718 
»suÉ
 = 
	`queue_»que¡_œq
(
dev
, 
nvmeq
,‚vmeq->
œqÇme
);

1719 ià(
»suÉ
) {

1720 
nvmeq
->
cq_veùÜ
 = -1;

1721 
ä“_nvmeq
;

1724  
»suÉ
;

1726 
ä“_nvmeq
:

1727 
	`nvme_ä“_queues
(
dev
, 0);

1728  
»suÉ
;

1729 
	}
}

1731 
boŞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1737 
boŞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1740 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

1741  
çl£
;

1746 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1747  
çl£
;

1752 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1753  
çl£
;

1755  
Œue
;

1756 
	}
}

1758 
	$nvme_w©chdog_tim”
(
d©a
)

1760 
nvme_dev
 *
dev
 = (nvme_dev *)
d©a
;

1761 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1764 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1765 ià(
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
))

1766 
	`dev_w¬n
(
dev
->dev,

1768 
c¡s
);

1772 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

1773 
	}
}

1775 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

1777 
i
;

1778 
»t
 = 0;

1780 
i
 = 
dev
->
queue_couÁ
; i <ğdev->
max_qid
; i++) {

1781 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
)) {

1782 
»t
 = -
ENOMEM
;

1787 
i
 = 
dev
->
Úlše_queues
; i <ğdev->
queue_couÁ
 - 1; i++) {

1788 
»t
 = 
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i);

1789 ià(
»t
) {

1790 
	`nvme_ä“_queues
(
dev
, 
i
);

1801  
»t
 >= 0 ? 0 :„et;

1802 
	}
}

1804 
__iomem
 *
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

1806 
u64
 
szu
, 
size
, 
off£t
;

1807 
u32
 
cmbloc
;

1808 
»sourû_size_t
 
b¬_size
;

1809 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1810 
__iomem
 *
cmb
;

1811 
dma_addr_t
 
dma_addr
;

1813 ià(!
u£_cmb_sqes
)

1814  
NULL
;

1816 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

1817 ià(!(
	`NVME_CMB_SZ
(
dev
->
cmbsz
)))

1818  
NULL
;

1820 
cmbloc
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CMBLOC
);

1822 
szu
 = (
u64
)1 << (12 + 4 * 
	`NVME_CMB_SZU
(
dev
->
cmbsz
));

1823 
size
 = 
szu
 * 
	`NVME_CMB_SZ
(
dev
->
cmbsz
);

1824 
off£t
 = 
szu
 * 
	`NVME_CMB_OFST
(
cmbloc
);

1825 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
	`NVME_CMB_BIR
(
cmbloc
));

1827 ià(
off£t
 > 
b¬_size
)

1828  
NULL
;

1835 ià(
size
 > 
b¬_size
 - 
off£t
)

1836 
size
 = 
b¬_size
 - 
off£t
;

1838 
dma_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
	`NVME_CMB_BIR
(
cmbloc
)è+ 
off£t
;

1839 
cmb
 = 
	`iÜem­_wc
(
dma_addr
, 
size
);

1840 ià(!
cmb
)

1841  
NULL
;

1843 
dev
->
cmb_dma_addr
 = 
dma_addr
;

1844 
dev
->
cmb_size
 = 
size
;

1845  
cmb
;

1846 
	}
}

1848 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

1850 ià(
dev
->
cmb
) {

1851 
	`iounm­
(
dev
->
cmb
);

1852 
dev
->
cmb
 = 
NULL
;

1854 
	}
}

1856 
size_t
 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1858  4096 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1859 
	}
}

1861 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

1863 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

1864 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1865 
»suÉ
, 
Ä_io_queues
, 
size
;

1867 
Ä_io_queues
 = 
dev
->
max_qid
;

1868 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

1869 ià(
»suÉ
 < 0)

1870  
»suÉ
;

1877 ià(
»suÉ
 > 0) {

1878 
	`dev_”r
(
dev
->
ù¾
.
deviû
,

1879 "Could‚Ù s‘ queucouÁ (%d)\n", 
»suÉ
);

1883 ià(
dev
->
cmb
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1884 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

1885 (
nvme_commªd
));

1886 ià(
»suÉ
 > 0)

1887 
dev
->
q_d•th
 = 
»suÉ
;

1889 
	`nvme_»Ëa£_cmb
(
dev
);

1892 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1893 ià(
size
 > 8192) {

1894 
	`iounm­
(
dev
->
b¬
);

1896 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1897 ià(
dev
->
b¬
)

1899 ià(!--
Ä_io_queues
)

1900  -
ENOMEM
;

1901 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1903 
dev
->
dbs
 = dev->
b¬
 + 4096;

1904 
admšq
->
q_db
 = 
dev
->
dbs
;

1907 
dev
->
max_qid
 = 
Ä_io_queues
;

1910 
	`nvme_ä“_queues
(
dev
, 
Ä_io_queues
 + 1);

1911  
	`nvme_ü—‹_io_queues
(
dev
);

1912 
	}
}

1914 
	$nvme_£t_œq_hšts
(
nvme_dev
 *
dev
)

1916 
nvme_queue
 *
nvmeq
;

1917 
i
;

1919 
i
 = 0; i < 
dev
->
Úlše_queues
; i++) {

1920 
nvmeq
 = 
dev
->
queues
[
i
];

1922 ià(!
nvmeq
->
gs
 || !(*nvmeq->tags))

1925 
	`œq_£t_affš™y_hšt
(
dev
->
’Œy
[
nvmeq
->
cq_veùÜ
].
veùÜ
,

1926 
	`blk_mq_gs_ıumask
(*
nvmeq
->
gs
));

1928 
	}
}

1930 
	$nvme_dev_sÿn
(
wÜk_¡ruù
 *
wÜk
)

1932 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
sÿn_wÜk
);

1934 ià(!
dev
->
g£t
.
gs
)

1936 
	`nvme_sÿn_Çme¥aûs
(&
dev
->
ù¾
);

1937 
	`nvme_£t_œq_hšts
(
dev
);

1938 
	}
}

1940 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
”rÜ
)

1942 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

1944 
	`blk_mq_ä“_»que¡
(
»q
);

1945 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

1946 
	}
}

1948 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
”rÜ
)

1950 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

1952 ià(!
”rÜ
) {

1953 
æags
;

1955 
	`¥š_lock_œq§ve
(&
nvmeq
->
q_lock
, 
æags
);

1956 
	`nvme_´oûss_cq
(
nvmeq
);

1957 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

1960 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

1961 
	}
}

1963 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
)

1965 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

1966 
»que¡
 *
»q
;

1967 
nvme_commªd
 
cmd
;

1969 
	`mem£t
(&
cmd
, 0, (cmd));

1970 
cmd
.
d–‘e_queue
.
İcode
 = opcode;

1971 
cmd
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

1973 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
);

1974 ià(
	`IS_ERR
(
»q
))

1975  
	`PTR_ERR
(
»q
);

1977 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1978 
»q
->
’d_io_d©a
 = 
nvmeq
;

1980 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

1981 
İcode
 =ğ
nvme_admš_d–‘e_cq
 ?

1982 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

1984 
	}
}

1986 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
)

1988 
·ss
;

1989 
timeout
;

1990 
u8
 
İcode
 = 
nvme_admš_d–‘e_sq
;

1992 
·ss
 = 0;…ass < 2;…ass++) {

1993 
£Á
 = 0, 
i
 = 
dev
->
queue_couÁ
 - 1;

1995 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

1996 
»Œy
:

1997 
timeout
 = 
ADMIN_TIMEOUT
;

1998 ; 
i
 > 0; i--, 
£Á
++)

1999 ià(
	`nvme_d–‘e_queue
(
dev
->
queues
[
i
], 
İcode
))

2002 
£Á
--) {

2003 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

2004 ià(
timeout
 == 0)

2006 ià(
i
)

2007 
»Œy
;

2009 
İcode
 = 
nvme_admš_d–‘e_cq
;

2011 
	}
}

2019 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2021 ià(!
dev
->
ù¾
.
g£t
) {

2022 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

2023 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

2024 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2025 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

2026 
dev
->
g£t
.
queue_d•th
 =

2027 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

2028 
dev
->
g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

2029 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2030 
dev
->
g£t
.
driv”_d©a
 = dev;

2032 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

2034 
dev
->
ù¾
.
g£t
 = &dev->tagset;

2036 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2037 ià(
	`to_pci_dev
(
dev
->dev)->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
) {

2038 
»s
 = 
	`nvme_£t_doÜb–l_memÜy
(
dev
);

2039 ià(
»s
) {

2041 
	`dma_ä“_coh”’t
(
dev
->dev, 8192, dev->
db_mem
, dev->
doÜb–l
);

2042 
	`dma_ä“_coh”’t
(
dev
->dev, 8192, dev->
ei_mem
, dev->
doÜb–l
);

2043 
dev
->
db_mem
 = 0;

2044 
dev
->
ei_mem
 = 0;

2049 
	`nvme_queue_sÿn
(
dev
);

2051 
	}
}

2053 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

2055 
u64
 
ÿp
;

2056 
»suÉ
 = -
ENOMEM
, 
Ä_io_queues
, 
i
, 
vecs
;

2057 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2059 ià(
	`pci_’abË_deviû_mem
(
pdev
))

2060  
»suÉ
;

2062 
	`pci_£t_ma¡”
(
pdev
);

2064 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

2065 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

2066 
di§bË
;

2068 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

2069 
»suÉ
 = -
ENODEV
;

2070 
di§bË
;

2073 
Ä_io_queues
 = 
	`num_possibË_ıus
();

2075 
i
 = 0; i < 
Ä_io_queues
; i++)

2076 
dev
->
’Œy
[
i
].entry = i;

2077 
vecs
 = 
	`pci_’abË_msix_¿nge
(
pdev
, 
dev
->
’Œy
, 1, 
Ä_io_queues
);

2078 ià(
vecs
 < 0) {

2079 
vecs
 = 
	`pci_’abË_msi_¿nge
(
pdev
, 1, 
	`mš
(
Ä_io_queues
, 32));

2080 ià(
vecs
 < 0) {

2081 
»suÉ
 = 
vecs
;

2082 
di§bË
;

2084 
i
 = 0; i < 
vecs
; i++)

2085 
dev
->
’Œy
[
i
].
veùÜ
 = i + 
pdev
->
œq
;

2089 ià(
vecs
 < 1) {

2090 
	`dev_”r
(
dev
->
ù¾
.
deviû
, "Failedo get‡ny MSI/MSIX interrupts\n");

2091 
»suÉ
 = -
ENOSPC
;

2092 
di§bË
;

2095 
dev
->
max_qid
 = 
vecs
;

2097 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

2099 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ÿp
è+ 1, 
NVME_Q_DEPTH
);

2100 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(
ÿp
);

2101 
dev
->
dbs
 = dev->
b¬
 + 4096;

2107 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_APPLE
 &&…dev->
deviû
 == 0x2001) {

2108 
dev
->
q_d•th
 = 2;

2109 
	`dev_w¬n
(
dev
->dev, "detected Apple NVMe controller, set "

2111 
dev
->
q_d•th
);

2114 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 2))

2115 
dev
->
cmb
 = 
	`nvme_m­_cmb
(dev);

2117 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

2118 
	`pci_§ve_¡©e
(
pdev
);

2120 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2121 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_GOOGLE
) {

2122 
mem_size
 = 
	`nvme_v’dÜ_memÜy_size
(
dev
);

2123 
dev
->
db_mem
 = 
	`dma_®loc_coh”’t
(&
pdev
->dev, 
mem_size
, &dev->
doÜb–l
, 
GFP_KERNEL
);

2124 ià(!
dev
->
db_mem
) {

2125 
»suÉ
 = -
ENOMEM
;

2126 
di§bË
;

2128 
dev
->
ei_mem
 = 
	`dma_®loc_coh”’t
(&
pdev
->dev, 
mem_size
, &dev->
ev’tidx
, 
GFP_KERNEL
);

2129 ià(!
dev
->
ei_mem
) {

2130 
»suÉ
 = -
ENOMEM
;

2131 
dma_ä“
;

2138 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2139 
dma_ä“
:

2140 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
	`nvme_v’dÜ_memÜy_size
(dev), dev->
db_mem
, dev->
doÜb–l
);

2141 
dev
->
db_mem
 = 0;

2144 
di§bË
:

2145 
	`pci_di§bË_deviû
(
pdev
);

2147  
»suÉ
;

2148 
	}
}

2150 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

2152 ià(
dev
->
b¬
)

2153 
	`iounm­
(
dev
->
b¬
);

2154 
	`pci_»Ëa£_»giÚs
(
	`to_pci_dev
(
dev
->dev));

2155 
	}
}

2157 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

2159 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2160 #ifdeà
CONFIG_NVME_VENDOR_EXT_GOOGLE


2161 
mem_size
 = 
	`nvme_v’dÜ_memÜy_size
(
dev
);

2163 ià(
dev
->
db_mem
)

2164 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
mem_size
, dev->
db_mem
, dev->
doÜb–l
);

2165 ià(
dev
->
ei_mem
)

2166 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
mem_size
, dev->
ei_mem
, dev->
ev’tidx
);

2169 ià(
pdev
->
msi_’abËd
)

2170 
	`pci_di§bË_msi
(
pdev
);

2171 ià(
pdev
->
msix_’abËd
)

2172 
	`pci_di§bË_msix
(
pdev
);

2174 ià(
	`pci_is_’abËd
(
pdev
)) {

2175 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

2176 
	`pci_di§bË_deviû
(
pdev
);

2178 
	}
}

2180 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

2182 
i
;

2183 
u32
 
c¡s
 = -1;

2185 
	`d–_tim”_sync
(&
dev
->
w©chdog_tim”
);

2187 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

2188 ià(
	`pci_is_’abËd
(
	`to_pci_dev
(
dev
->dev))) {

2189 
	`nvme_¡İ_queues
(&
dev
->
ù¾
);

2190 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

2193 
i
 = 
dev
->
queue_couÁ
 - 1; i > 0; i--)

2194 
	`nvme_su¥’d_queue
(
dev
->
queues
[
i
]);

2196 ià(
c¡s
 & 
NVME_CSTS_CFS
 || !(c¡ & 
NVME_CSTS_RDY
)) {

2201 ià(
dev
->
queue_couÁ
)

2202 
	`nvme_su¥’d_queue
(
dev
->
queues
[0]);

2204 
	`nvme_di§bË_io_queues
(
dev
);

2205 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

2207 
	`nvme_pci_di§bË
(
dev
);

2209 
i
 = 
dev
->
queue_couÁ
 - 1; i >= 0; i--)

2210 
	`nvme_ş—r_queue
(
dev
->
queues
[
i
]);

2211 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

2212 
	}
}

2214 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

2216 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist…age", dev->dev,

2217 
PAGE_SIZE
, PAGE_SIZE, 0);

2218 ià(!
dev
->
´p_·ge_poŞ
)

2219  -
ENOMEM
;

2222 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist 256", dev->dev,

2224 ià(!
dev
->
´p_sm®l_poŞ
) {

2225 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2226  -
ENOMEM
;

2229 
	}
}

2231 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

2233 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

2234 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

2235 
	}
}

2237 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

2239 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2241 
	`put_deviû
(
dev
->dev);

2242 ià(
dev
->
g£t
.
gs
)

2243 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

2244 ià(
dev
->
ù¾
.
admš_q
)

2245 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2246 
	`kä“
(
dev
->
queues
);

2247 
	`kä“
(
dev
->
’Œy
);

2248 
	`kä“
(
dev
);

2249 
	}
}

2251 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2253 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»£t_wÜk
);

2254 
»suÉ
;

2256 ià(
	`WARN_ON
(
	`‹¡_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
)))

2257 
out
;

2263 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

2264 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2266 ià(
	`‹¡_b™
(
NVME_CTRL_REMOVING
, &
dev
->
æags
))

2267 
out
;

2269 
	`£t_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
);

2271 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

2272 ià(
»suÉ
)

2273 
out
;

2275 
»suÉ
 = 
	`nvme_cÚfigu»_admš_queue
(
dev
);

2276 ià(
»suÉ
)

2277 
unm­
;

2279 
	`nvme_š™_queue
(
dev
->
queues
[0], 0);

2280 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2281 ià(
»suÉ
)

2282 
di§bË
;

2284 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2285 ià(
»suÉ
)

2286 
ä“_gs
;

2288 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2289 ià(
»suÉ
)

2290 
ä“_gs
;

2292 
dev
->
ù¾
.
ev’t_lim™
 = 
NVME_NR_AEN_COMMANDS
;

2293 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
async_wÜk
);

2295 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

2301 ià(
dev
->
Úlše_queues
 < 2) {

2302 
	`dev_w¬n
(
dev
->dev, "IO queues‚ot created\n");

2303 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2305 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2306 
	`nvme_dev_add
(
dev
);

2309 
	`ş—r_b™
(
NVME_CTRL_RESETTING
, &
dev
->
æags
);

2312 
ä“_gs
:

2313 
	`nvme_dev_»move_admš
(
dev
);

2314 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2315 
dev
->
ù¾
.
admš_q
 = 
NULL
;

2316 
dev
->
queues
[0]->
gs
 = 
NULL
;

2317 
di§bË
:

2318 
	`nvme_di§bË_admš_queue
(
dev
, 
çl£
);

2319 
unm­
:

2320 
	`nvme_dev_unm­
(
dev
);

2321 
out
:

2322 
	`nvme_»move_d—d_ù¾
(
dev
);

2323 
	}
}

2325 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2327 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2328 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2330 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2331 ià(
	`pci_g‘_drvd©a
(
pdev
))

2332 
	`pci_¡İ_ªd_»move_bus_deviû_locked
(
pdev
);

2333 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2334 
	}
}

2336 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
)

2338 
	`dev_w¬n
(
dev
->dev, "Removing‡fter…robe failure\n");

2339 
	`k»f_g‘
(&
dev
->
ù¾
.
k»f
);

2340 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2341 ià(!
	`scheduË_wÜk
(&
dev
->
»move_wÜk
))

2342 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2343 
	}
}

2345 
	$nvme_»£t
(
nvme_dev
 *
dev
)

2347 ià(!
dev
->
ù¾
.
admš_q
 || 
	`blk_queue_dyšg
(dev->ctrl.admin_q))

2348  -
ENODEV
;

2350 ià(!
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
))

2351  -
EBUSY
;

2353 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2355 
	}
}

2357 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2359 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2361 
	}
}

2363 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2365 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2367 
	}
}

2369 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2371 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2373 
	}
}

2375 
boŞ
 
	$nvme_pci_io_šÿ·bË
(
nvme_ù¾
 *
ù¾
)

2377 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2379  !
dev
->
b¬
 || dev->
Úlše_queues
 < 2;

2380 
	}
}

2382 
	$nvme_pci_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

2384  
	`nvme_»£t
(
	`to_nvme_dev
(
ù¾
));

2385 
	}
}

2387 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_pci_ù¾_İs
 = {

2388 .
»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2389 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2390 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2391 .
	gio_šÿ·bË
 = 
nvme_pci_io_šÿ·bË
,

2392 .
	g»£t_ù¾
 = 
nvme_pci_»£t_ù¾
,

2393 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2396 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2398 
b¬s
;

2399 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2401 
b¬s
 = 
	`pci_£Ëù_b¬s
(
pdev
, 
IORESOURCE_MEM
);

2402 ià(!
b¬s
)

2403  -
ENODEV
;

2404 ià(
	`pci_»que¡_£Ëùed_»giÚs
(
pdev
, 
b¬s
, "nvme"))

2405  -
ENODEV
;

2407 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 8192);

2408 ià(!
dev
->
b¬
)

2409 
»Ëa£
;

2412 
»Ëa£
:

2413 
	`pci_»Ëa£_»giÚs
(
pdev
);

2414  -
ENODEV
;

2415 
	}
}

2417 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2419 
node
, 
»suÉ
 = -
ENOMEM
;

2420 
nvme_dev
 *
dev
;

2422 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2423 ià(
node
 =ğ
NUMA_NO_NODE
)

2424 
	`£t_dev_node
(&
pdev
->
dev
, 0);

2426 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

2427 ià(!
dev
)

2428  -
ENOMEM
;

2429 
dev
->
’Œy
 = 
	`kz®loc_node
(
	`num_possibË_ıus
() * (*dev->entry),

2430 
GFP_KERNEL
, 
node
);

2431 ià(!
dev
->
’Œy
)

2432 
ä“
;

2433 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

2434 
GFP_KERNEL
, 
node
);

2435 ià(!
dev
->
queues
)

2436 
ä“
;

2438 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

2439 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2441 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

2442 ià(
»suÉ
)

2443 
ä“
;

2445 
	`INIT_WORK
(&
dev
->
sÿn_wÜk
, 
nvme_dev_sÿn
);

2446 
	`INIT_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_wÜk
);

2447 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

2448 
	`INIT_WORK
(&
dev
->
async_wÜk
, 
nvme_async_ev’t_wÜk
);

2449 
	`£tup_tim”
(&
dev
->
w©chdog_tim”
, 
nvme_w©chdog_tim”
,

2450 ()
dev
);

2451 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

2452 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2454 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2455 ià(
»suÉ
)

2456 
put_pci
;

2458 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_İs
,

2459 
id
->
driv”_d©a
);

2460 ià(
»suÉ
)

2461 
»Ëa£_poŞs
;

2463 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2466 
»Ëa£_poŞs
:

2467 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2468 
put_pci
:

2469 
	`put_deviû
(
dev
->dev);

2470 
	`nvme_dev_unm­
(
dev
);

2471 
ä“
:

2472 
	`kä“
(
dev
->
queues
);

2473 
	`kä“
(
dev
->
’Œy
);

2474 
	`kä“
(
dev
);

2475  
»suÉ
;

2476 
	}
}

2478 
	$nvme_»£t_nÙify
(
pci_dev
 *
pdev
, 
boŞ
 
´•¬e
)

2480 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2482 ià(
´•¬e
)

2483 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2485 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2486 
	}
}

2488 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2490 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2491 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2492 
	}
}

2494 
	$nvme_»move
(
pci_dev
 *
pdev
)

2496 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2498 
	`£t_b™
(
NVME_CTRL_REMOVING
, &
dev
->
æags
);

2499 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2500 
	`æush_wÜk
(&
dev
->
async_wÜk
);

2501 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2502 
	`æush_wÜk
(&
dev
->
sÿn_wÜk
);

2503 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2504 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

2505 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2506 
	`nvme_dev_»move_admš
(
dev
);

2507 
	`nvme_ä“_queues
(
dev
, 0);

2508 
	`nvme_»Ëa£_cmb
(
dev
);

2509 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2510 
	`nvme_dev_unm­
(
dev
);

2511 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2512 
	}
}

2514 #ifdeà
CONFIG_PM_SLEEP


2515 
	$nvme_su¥’d
(
deviû
 *
dev
)

2517 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2518 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2520 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

2522 
	}
}

2524 
	$nvme_»sume
(
deviû
 *
dev
)

2526 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2527 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2529 
	`queue_wÜk
(
nvme_wÜkq
, &
ndev
->
»£t_wÜk
);

2531 
	}
}

2534 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

2536 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

2537 
pci_chªÃl_¡©e_t
 
¡©e
)

2539 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2546 
	`dev_w¬n
(&
pdev
->
dev
, "”rÜ d‘eùed: s‹:%d\n", 
¡©e
);

2547 
¡©e
) {

2548 
pci_chªÃl_io_nÜm®
:

2549  
PCI_ERS_RESULT_CAN_RECOVER
;

2550 
pci_chªÃl_io_äoz’
:

2551 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2552  
PCI_ERS_RESULT_NEED_RESET
;

2553 
pci_chªÃl_io_³rm_çu»
:

2554  
PCI_ERS_RESULT_DISCONNECT
;

2556  
PCI_ERS_RESULT_NEED_RESET
;

2557 
	}
}

2559 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

2561 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2563 
	`dev_šfo
(&
pdev
->
dev
, "restart‡fter slot„eset\n");

2564 
	`pci_»¡Üe_¡©e
(
pdev
);

2565 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2566  
PCI_ERS_RESULT_RECOVERED
;

2567 
	}
}

2569 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

2571 
	`pci_ş—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

2572 
	}
}

2574 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2575 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2576 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2577 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2578 .
	g»£t_nÙify
 = 
nvme_»£t_nÙify
,

2582 
	#PCI_CLASS_STORAGE_EXPRESS
 0x010802

	)

2584 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

2585 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2586 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2587 
NVME_QUIRK_DISCARD_ZEROES
, },

2588 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2589 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

2590 { 
PCI_DEVICE
(0x1c58, 0x0003),

2591 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2592 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2593 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

2596 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2598 
pci_driv”
 
	gnvme_driv”
 = {

2599 .
Çme
 = "nvme",

2600 .
	gid_bË
 = 
nvme_id_bË
,

2601 .
	g´obe
 = 
nvme_´obe
,

2602 .
	g»move
 = 
nvme_»move
,

2603 .
	gshutdown
 = 
nvme_shutdown
,

2604 .
	gdriv”
 = {

2605 .
pm
 = &
nvme_dev_pm_İs
,

2607 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2610 
__š™
 
	$nvme_š™
()

2612 
»suÉ
;

2614 
nvme_wÜkq
 = 
	`®loc_wÜkqueue
("nvme", 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
, 0);

2615 ià(!
nvme_wÜkq
)

2616  -
ENOMEM
;

2618 
»suÉ
 = 
	`nvme_cÜe_š™
();

2619 ià(
»suÉ
 < 0)

2620 
kl_wÜkq
;

2622 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2623 ià(
»suÉ
)

2624 
cÜe_ex™
;

2626 
	`dma_£t_©Œ
(
DMA_ATTR_NO_WARN
, &
nvme_dma_©Œs
);

2630 
cÜe_ex™
:

2631 
	`nvme_cÜe_ex™
();

2632 
kl_wÜkq
:

2633 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2634  
»suÉ
;

2635 
	}
}

2637 
__ex™
 
	$nvme_ex™
()

2639 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2640 
	`nvme_cÜe_ex™
();

2641 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2642 
	`_nvme_check_size
();

2643 
	}
}

2645 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

2646 
MODULE_LICENSE
("GPL");

2647 
MODULE_VERSION
("1.0");

2648 
moduË_š™
(
nvme_š™
);

2649 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/scsi.c

20 
	~<lšux/bio.h
>

21 
	~<lšux/b™İs.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/com·t.h
>

24 
	~<lšux/d–ay.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/g’hd.h
>

28 
	~<lšux/idr.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/š‹¼u±.h
>

31 
	~<lšux/io.h
>

32 
	~<lšux/kdev_t.h
>

33 
	~<lšux/kth»ad.h
>

34 
	~<lšux/k”Ãl.h
>

35 
	~<lšux/mm.h
>

36 
	~<lšux/moduË.h
>

37 
	~<lšux/moduË·¿m.h
>

38 
	~<lšux/pci.h
>

39 
	~<lšux/poisÚ.h
>

40 
	~<lšux/sched.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/ty³s.h
>

43 
	~<asm/uÇligÃd.h
>

44 
	~<scsi/sg.h
>

45 
	~<scsi/scsi.h
>

47 
	~"nvme.h
"

49 
	gsg_v”siÚ_num
 = 30534;

52 
	#VPD_SUPPORTED_PAGES
 0x00

	)

53 
	#VPD_SERIAL_NUMBER
 0x80

	)

54 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

55 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

56 
	#VPD_BLOCK_LIMITS
 0xB0

	)

57 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

60 
	#FORMAT_UNIT_SHORT_PARM_LIST_LEN
 4

	)

61 
	#FORMAT_UNIT_LONG_PARM_LIST_LEN
 8

	)

62 
	#FORMAT_UNIT_PROT_INT_OFFSET
 3

	)

63 
	#FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
 0

	)

64 
	#FORMAT_UNIT_PROT_FIELD_USAGE_MASK
 0x07

	)

67 
	#FIXED_SENSE_DATA
 0x70

	)

68 
	#DESC_FORMAT_SENSE_DATA
 0x72

	)

69 
	#FIXED_SENSE_DATA_ADD_LENGTH
 10

	)

70 
	#LUN_ENTRY_SIZE
 8

	)

71 
	#LUN_DATA_HEADER_SIZE
 8

	)

72 
	#ALL_LUNS_RETURNED
 0x02

	)

73 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

74 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

75 
	#NVME_POWER_STATE_START_VALID
 0x00

	)

76 
	#NVME_POWER_STATE_ACTIVE
 0x01

	)

77 
	#NVME_POWER_STATE_IDLE
 0x02

	)

78 
	#NVME_POWER_STATE_STANDBY
 0x03

	)

79 
	#NVME_POWER_STATE_LU_CONTROL
 0x07

	)

80 
	#POWER_STATE_0
 0

	)

81 
	#POWER_STATE_1
 1

	)

82 
	#POWER_STATE_2
 2

	)

83 
	#POWER_STATE_3
 3

	)

84 
	#DOWNLOAD_SAVE_ACTIVATE
 0x05

	)

85 
	#DOWNLOAD_SAVE_DEFER_ACTIVATE
 0x0E

	)

86 
	#ACTIVATE_DEFERRED_MICROCODE
 0x0F

	)

87 
	#FORMAT_UNIT_IMMED_MASK
 0x2

	)

88 
	#FORMAT_UNIT_IMMED_OFFSET
 1

	)

89 
	#KELVIN_TEMP_FACTOR
 273

	)

90 
	#FIXED_FMT_SENSE_DATA_SIZE
 18

	)

91 
	#DESC_FMT_SENSE_DATA_SIZE
 8

	)

94 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

95 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

96 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

97 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

98 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

99 
	#INQ_BDEV_LIMITS_PAGE
 0xB0

	)

100 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

101 
	#INQ_SERIAL_NUMBER_LENGTH
 0x14

	)

102 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 6

	)

103 
	#VERSION_SPC_4
 0x06

	)

104 
	#ACA_UNSUPPORTED
 0

	)

105 
	#STANDARD_INQUIRY_LENGTH
 36

	)

106 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

107 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

108 
	#RESERVED_FIELD
 0

	)

111 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

112 
	#MODE_PAGE_CACHING
 0x08

	)

113 
	#MODE_PAGE_CONTROL
 0x0A

	)

114 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

115 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

116 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

117 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

118 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

119 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

120 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

121 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

122 
	#MODE_PAGE_ALL_LEN
 0x54

	)

123 
	#MODE_SENSE6_MPH_SIZE
 4

	)

124 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

125 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

126 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

127 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

128 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

129 
	#MODE_SENSE_DBD_MASK
 8

	)

130 
	#MODE_SENSE_DBD_SHIFT
 3

	)

131 
	#MODE_SENSE10_MPH_SIZE
 8

	)

132 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

133 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

134 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

135 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

136 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

137 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

138 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

139 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

140 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

141 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

142 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

143 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

144 
	#SHORT_DESC_BLOCK
 8

	)

145 
	#LONG_DESC_BLOCK
 16

	)

146 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

147 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

148 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

149 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

150 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

153 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
 0x00

	)

154 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
 0x07

	)

155 
	#LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
 0x2F

	)

156 
	#LOG_PAGE_TEMPERATURE_PAGE
 0x0D

	)

157 
	#LOG_SENSE_CDB_SP_NOT_ENABLED
 0

	)

158 
	#LOG_SENSE_CDB_PC_MASK
 0xC0

	)

159 
	#LOG_SENSE_CDB_PC_SHIFT
 6

	)

160 
	#LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
 1

	)

161 
	#LOG_SENSE_CDB_PAGE_CODE_MASK
 0x3F

	)

162 
	#REMAINING_INFO_EXCP_PAGE_LENGTH
 0x8

	)

163 
	#LOG_INFO_EXCP_PAGE_LENGTH
 0xC

	)

164 
	#REMAINING_TEMP_PAGE_LENGTH
 0xC

	)

165 
	#LOG_TEMP_PAGE_LENGTH
 0x10

	)

166 
	#LOG_TEMP_UNKNOWN
 0xFF

	)

167 
	#SUPPORTED_LOG_PAGES_PAGE_LENGTH
 0x3

	)

170 
	#READ_CAP_10_RESP_SIZE
 8

	)

171 
	#READ_CAP_16_RESP_SIZE
 32

	)

174 
	#BYTES_TO_DWORDS
 4

	)

175 
	#NVME_MAX_FIRMWARE_SLOT
 7

	)

178 
	#REPORT_LUNS_FIRST_LUN_OFFSET
 8

	)

182 
	#SCSI_ASC_NO_SENSE
 0x00

	)

183 
	#SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

184 
	#SCSI_ASC_LUN_NOT_READY
 0x04

	)

185 
	#SCSI_ASC_WARNING
 0x0B

	)

186 
	#SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

187 
	#SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

188 
	#SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

189 
	#SCSI_ASC_UNRECOVERED_READ_ERROR
 0x11

	)

190 
	#SCSI_ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

191 
	#SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
 0x20

	)

192 
	#SCSI_ASC_ILLEGAL_COMMAND
 0x20

	)

193 
	#SCSI_ASC_ILLEGAL_BLOCK
 0x21

	)

194 
	#SCSI_ASC_INVALID_CDB
 0x24

	)

195 
	#SCSI_ASC_INVALID_LUN
 0x25

	)

196 
	#SCSI_ASC_INVALID_PARAMETER
 0x26

	)

197 
	#SCSI_ASC_FORMAT_COMMAND_FAILED
 0x31

	)

198 
	#SCSI_ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

202 
	#SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

203 
	#SCSI_ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

204 
	#SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

205 
	#SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

206 
	#SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

207 
	#SCSI_ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

208 
	#SCSI_ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

209 
	#SCSI_ASCQ_INVALID_LUN_ID
 0x09

	)

212 
šlše
 
u32
 
	$g‘_uÇligÃd_be24
(
u8
 *
buf
)

214  0xfffffà& (
u32
è
	`g‘_uÇligÃd_be32
(
buf
 - 1);

215 
	}
}

220 
	snvme_Œªs_io_cdb
 {

221 
u8
 
	mfua
;

222 
u8
 
	m´Ù_šfo
;

223 
u64
 
	mlba
;

224 
u32
 
	mxãr_Ën
;

233 
	$nvme_Œªs_cİy_to_u£r
(
sg_io_hdr
 *
hdr
, *
äom
,

234 
n
)

236 
i
;

237 *
šdex
 = 
äom
;

238 
size_t
 
»maššg
 = 
n
;

239 
size_t
 
xãr_Ën
;

241 ià(
hdr
->
iovec_couÁ
 > 0) {

242 
sg_iovec
 
sgl
;

244 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

245 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

246 
i
 * (
sg_iovec
),

247 (
sg_iovec
)))

248  -
EFAULT
;

249 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

250 ià(
	`cİy_to_u£r
(
sgl
.
iov_ba£
, 
šdex
, 
xãr_Ën
))

251  -
EFAULT
;

253 
šdex
 +ğ
xãr_Ën
;

254 
»maššg
 -ğ
xãr_Ën
;

255 ià(
»maššg
 == 0)

261 ià(
	`cİy_to_u£r
(
hdr
->
dxã½
, 
äom
, 
n
))

262  -
EFAULT
;

264 
	}
}

268 
	$nvme_Œªs_cİy_äom_u£r
(
sg_io_hdr
 *
hdr
, *
to
,

269 
n
)

271 
i
;

272 *
šdex
 = 
to
;

273 
size_t
 
»maššg
 = 
n
;

274 
size_t
 
xãr_Ën
;

276 ià(
hdr
->
iovec_couÁ
 > 0) {

277 
sg_iovec
 
sgl
;

279 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

280 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

281 
i
 * (
sg_iovec
),

282 (
sg_iovec
)))

283  -
EFAULT
;

284 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

285 ià(
	`cİy_äom_u£r
(
šdex
, 
sgl
.
iov_ba£
, 
xãr_Ën
))

286  -
EFAULT
;

287 
šdex
 +ğ
xãr_Ën
;

288 
»maššg
 -ğ
xãr_Ën
;

289 ià(
»maššg
 == 0)

295 ià(
	`cİy_äom_u£r
(
to
, 
hdr
->
dxã½
, 
n
))

296  -
EFAULT
;

298 
	}
}

302 
	$nvme_Œªs_com¶‘iÚ
(
sg_io_hdr
 *
hdr
, 
u8
 
¡©us
, u8 
£n£_key
,

303 
u8
 
asc
, u8 
ascq
)

305 
u8
 
xãr_Ën
;

306 
u8
 
»¥
[
DESC_FMT_SENSE_DATA_SIZE
];

308 ià(
	`scsi_¡©us_is_good
(
¡©us
)) {

309 
hdr
->
¡©us
 = 
SAM_STAT_GOOD
;

310 
hdr
->
masked_¡©us
 = 
GOOD
;

311 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

312 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

313 
hdr
->
sb_Ën_wr
 = 0;

315 
hdr
->
¡©us
 = status;

316 
hdr
->
masked_¡©us
 = 
¡©us
 >> 1;

317 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

318 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

320 
	`mem£t
(
»¥
, 0, 
DESC_FMT_SENSE_DATA_SIZE
);

321 
»¥
[0] = 
DESC_FORMAT_SENSE_DATA
;

322 
»¥
[1] = 
£n£_key
;

323 
»¥
[2] = 
asc
;

324 
»¥
[3] = 
ascq
;

326 
xãr_Ën
 = 
	`mš_t
(
u8
, 
hdr
->
mx_sb_Ën
, 
DESC_FMT_SENSE_DATA_SIZE
);

327 
hdr
->
sb_Ën_wr
 = 
xãr_Ën
;

328 ià(
	`cİy_to_u£r
(
hdr
->
sbp
, 
»¥
, 
xãr_Ën
) > 0)

329  -
EFAULT
;

333 
	}
}

341 
	$nvme_Œªs_¡©us_code
(
sg_io_hdr
 *
hdr
, 
nvme_sc
)

343 
u8
 
¡©us
, 
£n£_key
, 
asc
, 
ascq
;

344 
»s
;

347 ià(
nvme_sc
 < 0)

348  
nvme_sc
;

351 
nvme_sc
 & 0x7FF) {

353 
NVME_SC_SUCCESS
:

354 
¡©us
 = 
SAM_STAT_GOOD
;

355 
£n£_key
 = 
NO_SENSE
;

356 
asc
 = 
SCSI_ASC_NO_SENSE
;

357 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

359 
NVME_SC_INVALID_OPCODE
:

360 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

361 
£n£_key
 = 
ILLEGAL_REQUEST
;

362 
asc
 = 
SCSI_ASC_ILLEGAL_COMMAND
;

363 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

365 
NVME_SC_INVALID_FIELD
:

366 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

367 
£n£_key
 = 
ILLEGAL_REQUEST
;

368 
asc
 = 
SCSI_ASC_INVALID_CDB
;

369 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

371 
NVME_SC_DATA_XFER_ERROR
:

372 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

373 
£n£_key
 = 
MEDIUM_ERROR
;

374 
asc
 = 
SCSI_ASC_NO_SENSE
;

375 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

377 
NVME_SC_POWER_LOSS
:

378 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

379 
£n£_key
 = 
ABORTED_COMMAND
;

380 
asc
 = 
SCSI_ASC_WARNING
;

381 
ascq
 = 
SCSI_ASCQ_POWER_LOSS_EXPECTED
;

383 
NVME_SC_INTERNAL
:

384 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

385 
£n£_key
 = 
HARDWARE_ERROR
;

386 
asc
 = 
SCSI_ASC_INTERNAL_TARGET_FAILURE
;

387 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

389 
NVME_SC_ABORT_REQ
:

390 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

391 
£n£_key
 = 
ABORTED_COMMAND
;

392 
asc
 = 
SCSI_ASC_NO_SENSE
;

393 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

395 
NVME_SC_ABORT_QUEUE
:

396 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

397 
£n£_key
 = 
ABORTED_COMMAND
;

398 
asc
 = 
SCSI_ASC_NO_SENSE
;

399 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

401 
NVME_SC_FUSED_FAIL
:

402 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

403 
£n£_key
 = 
ABORTED_COMMAND
;

404 
asc
 = 
SCSI_ASC_NO_SENSE
;

405 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

407 
NVME_SC_FUSED_MISSING
:

408 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

409 
£n£_key
 = 
ABORTED_COMMAND
;

410 
asc
 = 
SCSI_ASC_NO_SENSE
;

411 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

413 
NVME_SC_INVALID_NS
:

414 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

415 
£n£_key
 = 
ILLEGAL_REQUEST
;

416 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

417 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

419 
NVME_SC_LBA_RANGE
:

420 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

421 
£n£_key
 = 
ILLEGAL_REQUEST
;

422 
asc
 = 
SCSI_ASC_ILLEGAL_BLOCK
;

423 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

425 
NVME_SC_CAP_EXCEEDED
:

426 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

427 
£n£_key
 = 
MEDIUM_ERROR
;

428 
asc
 = 
SCSI_ASC_NO_SENSE
;

429 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

431 
NVME_SC_NS_NOT_READY
:

432 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

433 
£n£_key
 = 
NOT_READY
;

434 
asc
 = 
SCSI_ASC_LUN_NOT_READY
;

435 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

439 
NVME_SC_INVALID_FORMAT
:

440 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

441 
£n£_key
 = 
ILLEGAL_REQUEST
;

442 
asc
 = 
SCSI_ASC_FORMAT_COMMAND_FAILED
;

443 
ascq
 = 
SCSI_ASCQ_FORMAT_COMMAND_FAILED
;

445 
NVME_SC_BAD_ATTRIBUTES
:

446 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

447 
£n£_key
 = 
ILLEGAL_REQUEST
;

448 
asc
 = 
SCSI_ASC_INVALID_CDB
;

449 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

453 
NVME_SC_WRITE_FAULT
:

454 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

455 
£n£_key
 = 
MEDIUM_ERROR
;

456 
asc
 = 
SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
;

457 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

459 
NVME_SC_READ_ERROR
:

460 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

461 
£n£_key
 = 
MEDIUM_ERROR
;

462 
asc
 = 
SCSI_ASC_UNRECOVERED_READ_ERROR
;

463 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

465 
NVME_SC_GUARD_CHECK
:

466 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

467 
£n£_key
 = 
MEDIUM_ERROR
;

468 
asc
 = 
SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
;

469 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
;

471 
NVME_SC_APPTAG_CHECK
:

472 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

473 
£n£_key
 = 
MEDIUM_ERROR
;

474 
asc
 = 
SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
;

475 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
;

477 
NVME_SC_REFTAG_CHECK
:

478 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

479 
£n£_key
 = 
MEDIUM_ERROR
;

480 
asc
 = 
SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
;

481 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
;

483 
NVME_SC_COMPARE_FAILED
:

484 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

485 
£n£_key
 = 
MISCOMPARE
;

486 
asc
 = 
SCSI_ASC_MISCOMPARE_DURING_VERIFY
;

487 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

489 
NVME_SC_ACCESS_DENIED
:

490 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

491 
£n£_key
 = 
ILLEGAL_REQUEST
;

492 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

493 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

497 
NVME_SC_CMDID_CONFLICT
:

498 
NVME_SC_CMD_SEQ_ERROR
:

499 
NVME_SC_CQ_INVALID
:

500 
NVME_SC_QID_INVALID
:

501 
NVME_SC_QUEUE_SIZE
:

502 
NVME_SC_ABORT_LIMIT
:

503 
NVME_SC_ABORT_MISSING
:

504 
NVME_SC_ASYNC_LIMIT
:

505 
NVME_SC_FIRMWARE_SLOT
:

506 
NVME_SC_FIRMWARE_IMAGE
:

507 
NVME_SC_INVALID_VECTOR
:

508 
NVME_SC_INVALID_LOG_PAGE
:

510 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

511 
£n£_key
 = 
ILLEGAL_REQUEST
;

512 
asc
 = 
SCSI_ASC_NO_SENSE
;

513 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

517 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
¡©us
, 
£n£_key
, 
asc
, 
ascq
);

518  
»s
 ?„e : 
nvme_sc
;

519 
	}
}

523 
	$nvme_Œªs_¡ªd¬d_šquœy_·ge
(
nvme_ns
 *
ns
,

524 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

525 
®loc_Ën
)

527 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

528 
nvme_id_ns
 *
id_ns
;

529 
»s
;

530 
nvme_sc
;

531 
xãr_Ën
;

532 
u8
 
»¥_d©a_fÜm©
 = 0x02;

533 
u8
 
´Ùeù
;

534 
u8
 
cmdque
 = 0x01 << 1;

535 
u8
 
fw_off£t
 = (
ù¾
->
fœmw¬e_»v
);

538 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

539 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

540 ià(
»s
)

541  
»s
;

543 ià(
id_ns
->
dps
)

544 
´Ùeù
 = 0x01;

546 
´Ùeù
 = 0;

547 
	`kä“
(
id_ns
);

549 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

550 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

551 
šq_»¥Ú£
[3] = 
»¥_d©a_fÜm©
;

552 
šq_»¥Ú£
[4] = 
ADDITIONAL_STD_INQ_LENGTH
;

553 
šq_»¥Ú£
[5] = 
´Ùeù
;

554 
šq_»¥Ú£
[7] = 
cmdque
;

555 
	`¡ºıy
(&
šq_»¥Ú£
[8], "NVMe ", 8);

556 
	`¡ºıy
(&
šq_»¥Ú£
[16], 
ù¾
->
mod–
, 16);

558 
ù¾
->
fœmw¬e_»v
[
fw_off£t
 - 1] == ' ' && fw_offset > 4)

559 
fw_off£t
--;

560 
fw_off£t
 -= 4;

561 
	`¡ºıy
(&
šq_»¥Ú£
[32], 
ù¾
->
fœmw¬e_»v
 + 
fw_off£t
, 4);

563 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

564  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

565 
	}
}

567 
	$nvme_Œªs_suµÜ‹d_vpd_·ges
(
nvme_ns
 *
ns
,

568 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

569 
®loc_Ën
)

571 
xãr_Ën
;

573 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

574 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

575 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

576 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

577 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

578 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

579 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

580 
šq_»¥Ú£
[8] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

581 
šq_»¥Ú£
[9] = 
INQ_BDEV_LIMITS_PAGE
;

583 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

584  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

585 
	}
}

587 
	$nvme_Œªs_un™_£rŸl_·ge
(
nvme_ns
 *
ns
,

588 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

589 
®loc_Ën
)

591 
xãr_Ën
;

593 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

594 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

595 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

596 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
ns
->
ù¾
->
£rŸl
, 
INQ_SERIAL_NUMBER_LENGTH
);

598 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

599  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

600 
	}
}

602 
	$nvme_fl_deviû_id_eui64
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

603 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

605 
nvme_id_ns
 *
id_ns
;

606 
nvme_sc
, 
»s
;

607 
size_t
 
Ën
;

608 *
eui
;

610 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

611 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

612 ià(
»s
)

613  
»s
;

615 
eui
 = 
id_ns
->
eui64
;

616 
Ën
 = (
id_ns
->
eui64
);

618 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2)) {

619 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

620 
eui
 = 
id_ns
->
nguid
;

621 
Ën
 = (
id_ns
->
nguid
);

625 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

626 
»s
 = -
EOPNOTSUPP
;

627 
out_ä“_id
;

630 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

631 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

632 
šq_»¥Ú£
[3] = 4 + 
Ën
;

635 
šq_»¥Ú£
[4] = 0x01;

636 
šq_»¥Ú£
[5] = 0x02;

637 
šq_»¥Ú£
[6] = 0x00;

638 
šq_»¥Ú£
[7] = 
Ën
;

639 
	`memıy
(&
šq_»¥Ú£
[8], 
eui
, 
Ën
);

641 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

642 
out_ä“_id
:

643 
	`kä“
(
id_ns
);

644  
»s
;

645 
	}
}

647 
	$nvme_fl_deviû_id_scsi_¡ršg
(
nvme_ns
 *
ns
,

648 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

650 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

651 
nvme_id_ù¾
 *
id_ù¾
;

652 
nvme_sc
, 
»s
;

654 ià(
®loc_Ën
 < 72) {

655  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

656 
SAM_STAT_CHECK_CONDITION
,

657 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

658 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

661 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

662 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

663 ià(
»s
)

664  
»s
;

666 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

667 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

668 
šq_»¥Ú£
[3] = 0x48;

671 
šq_»¥Ú£
[4] = 0x03;

672 
šq_»¥Ú£
[5] = 0x08;

673 
šq_»¥Ú£
[6] = 0x00;

674 
šq_»¥Ú£
[7] = 0x44;

676 
	`¥rštf
(&
šq_»¥Ú£
[8], "%04x", 
	`Ë16_to_ıu
(
id_ù¾
->
vid
));

677 
	`memıy
(&
šq_»¥Ú£
[12], 
ù¾
->
mod–
, (ctrl->model));

678 
	`¥rštf
(&
šq_»¥Ú£
[52], "%04x", 
	`ıu_to_be32
(
ns
->
ns_id
));

679 
	`memıy
(&
šq_»¥Ú£
[56], 
ù¾
->
£rŸl
, (ctrl->serial));

681 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

682 
	`kä“
(
id_ù¾
);

683  
»s
;

684 
	}
}

686 
	$nvme_Œªs_deviû_id_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

687 
u8
 *
»¥
, 
®loc_Ën
)

689 
»s
;

691 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1)) {

692 
»s
 = 
	`nvme_fl_deviû_id_eui64
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

693 ià(
»s
 !ğ-
EOPNOTSUPP
)

694  
»s
;

697  
	`nvme_fl_deviû_id_scsi_¡ršg
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

698 
	}
}

700 
	$nvme_Œªs_ext_šq_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

701 
®loc_Ën
)

703 
u8
 *
šq_»¥Ú£
;

704 
»s
;

705 
nvme_sc
;

706 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

707 
nvme_id_ù¾
 *
id_ù¾
;

708 
nvme_id_ns
 *
id_ns
;

709 
xãr_Ën
;

710 
u8
 
miüocode
 = 0x80;

711 
u8
 
¥t
;

712 
u8
 
¥t_lut
[8] = {0, 0, 2, 1, 4, 6, 5, 7};

713 
u8
 
grd_chk
, 
­p_chk
, 
»f_chk
, 
´Ùeù
;

714 
u8
 
uask_sup
 = 0x20;

715 
u8
 
v_sup
;

716 
u8
 
luişr
 = 0x01;

718 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

719 ià(
šq_»¥Ú£
 =ğ
NULL
)

720  -
ENOMEM
;

722 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

723 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

724 ià(
»s
)

725 
out_ä“_šq
;

727 
¥t
 = 
¥t_lut
[
id_ns
->
dpc
 & 0x07] << 3;

728 ià(
id_ns
->
dps
)

729 
´Ùeù
 = 0x01;

731 
´Ùeù
 = 0;

732 
	`kä“
(
id_ns
);

734 
grd_chk
 = 
´Ùeù
 << 2;

735 
­p_chk
 = 
´Ùeù
 << 1;

736 
»f_chk
 = 
´Ùeù
;

738 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

739 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

740 ià(
»s
)

741 
out_ä“_šq
;

743 
v_sup
 = 
id_ù¾
->
vwc
;

744 
	`kä“
(
id_ù¾
);

746 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

747 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

748 
šq_»¥Ú£
[2] = 0x00;

749 
šq_»¥Ú£
[3] = 0x3C;

750 
šq_»¥Ú£
[4] = 
miüocode
 | 
¥t
 | 
grd_chk
 | 
­p_chk
 | 
»f_chk
;

751 
šq_»¥Ú£
[5] = 
uask_sup
;

752 
šq_»¥Ú£
[6] = 
v_sup
;

753 
šq_»¥Ú£
[7] = 
luişr
;

754 
šq_»¥Ú£
[8] = 0;

755 
šq_»¥Ú£
[9] = 0;

757 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

758 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

760 
out_ä“_šq
:

761 
	`kä“
(
šq_»¥Ú£
);

762  
»s
;

763 
	}
}

765 
	$nvme_Œªs_bdev_lim™s_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

766 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

768 
__be32
 
max_£ùÜs
 = 
	`ıu_to_be32
(

769 
	`nvme_block_Ä
(
ns
, 
	`queue_max_hw_£ùÜs
Òs->
queue
)));

770 
__be32
 
max_disÿrd
 = 
	`ıu_to_be32
(
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
);

771 
__be32
 
disÿrd_desc_couÁ
 = 
	`ıu_to_be32
(0x100);

773 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

774 
šq_»¥Ú£
[1] = 
VPD_BLOCK_LIMITS
;

775 
šq_»¥Ú£
[3] = 0x3c;

776 
	`memıy
(&
šq_»¥Ú£
[8], &
max_£ùÜs
, (
u32
));

777 
	`memıy
(&
šq_»¥Ú£
[20], &
max_disÿrd
, (
u32
));

779 ià(
max_disÿrd
)

780 
	`memıy
(&
šq_»¥Ú£
[24], &
disÿrd_desc_couÁ
, (
u32
));

782  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 0x3c);

783 
	}
}

785 
	$nvme_Œªs_bdev_ch¬_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

786 
®loc_Ën
)

788 
u8
 *
šq_»¥Ú£
;

789 
»s
;

790 
xãr_Ën
;

792 
šq_»¥Ú£
 = 
	`kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

793 ià(
šq_»¥Ú£
 =ğ
NULL
) {

794 
»s
 = -
ENOMEM
;

795 
out_mem
;

798 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

799 
šq_»¥Ú£
[2] = 0x00;

800 
šq_»¥Ú£
[3] = 0x3C;

801 
šq_»¥Ú£
[4] = 0x00;

802 
šq_»¥Ú£
[5] = 0x01;

803 
šq_»¥Ú£
[6] = 0x00;

805 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

806 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

808 
	`kä“
(
šq_»¥Ú£
);

809 
out_mem
:

810  
»s
;

811 
	}
}

815 
	$nvme_Œªs_log_suµ_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

816 
®loc_Ën
)

818 
»s
;

819 
xãr_Ën
;

820 
u8
 *
log_»¥Ú£
;

822 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
, 
GFP_KERNEL
);

823 ià(
log_»¥Ú£
 =ğ
NULL
) {

824 
»s
 = -
ENOMEM
;

825 
out_mem
;

828 
log_»¥Ú£
[0] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

830 
log_»¥Ú£
[3] = 
SUPPORTED_LOG_PAGES_PAGE_LENGTH
;

831 
log_»¥Ú£
[4] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

832 
log_»¥Ú£
[5] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

833 
log_»¥Ú£
[6] = 
LOG_PAGE_TEMPERATURE_PAGE
;

835 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

836 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

838 
	`kä“
(
log_»¥Ú£
);

839 
out_mem
:

840  
»s
;

841 
	}
}

843 
	$nvme_Œªs_log_šfo_exû±iÚs
(
nvme_ns
 *
ns
,

844 
sg_io_hdr
 *
hdr
, 
®loc_Ën
)

846 
»s
;

847 
xãr_Ën
;

848 
u8
 *
log_»¥Ú£
;

849 
nvme_sm¬t_log
 *
sm¬t_log
;

850 
u8
 
‹mp_c
;

851 
u16
 
‹mp_k
;

853 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_INFO_EXCP_PAGE_LENGTH
, 
GFP_KERNEL
);

854 ià(
log_»¥Ú£
 =ğ
NULL
)

855  -
ENOMEM
;

857 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

858 ià(
»s
 < 0)

859 
out_ä“_»¥Ú£
;

861 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

862 
‹mp_c
 = 
LOG_TEMP_UNKNOWN
;

864 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

865 (
sm¬t_log
->
‹m³¿tu»
[0]);

866 
‹mp_c
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

868 
	`kä“
(
sm¬t_log
);

870 
log_»¥Ú£
[0] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

872 
log_»¥Ú£
[3] = 
REMAINING_INFO_EXCP_PAGE_LENGTH
;

875 
log_»¥Ú£
[6] = 0x23;

876 
log_»¥Ú£
[7] = 0x04;

879 
log_»¥Ú£
[10] = 
‹mp_c
;

881 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_INFO_EXCP_PAGE_LENGTH
);

882 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

884 
out_ä“_»¥Ú£
:

885 
	`kä“
(
log_»¥Ú£
);

886  
»s
;

887 
	}
}

889 
	$nvme_Œªs_log_‹m³¿tu»
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

890 
®loc_Ën
)

892 
»s
;

893 
xãr_Ën
;

894 
u8
 *
log_»¥Ú£
;

895 
nvme_sm¬t_log
 *
sm¬t_log
;

896 
u32
 
ã©u»_»¥
;

897 
u8
 
‹mp_c_cur
, 
‹mp_c_th»sh
;

898 
u16
 
‹mp_k
;

900 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_TEMP_PAGE_LENGTH
, 
GFP_KERNEL
);

901 ià(
log_»¥Ú£
 =ğ
NULL
)

902  -
ENOMEM
;

904 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

905 ià(
»s
 < 0)

906 
out_ä“_»¥Ú£
;

908 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

909 
‹mp_c_cur
 = 
LOG_TEMP_UNKNOWN
;

911 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

912 (
sm¬t_log
->
‹m³¿tu»
[0]);

913 
‹mp_c_cur
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

915 
	`kä“
(
sm¬t_log
);

918 
»s
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_TEMP_THRESH
, 0, 0,

919 &
ã©u»_»¥
);

920 ià(
»s
 !ğ
NVME_SC_SUCCESS
)

921 
‹mp_c_th»sh
 = 
LOG_TEMP_UNKNOWN
;

923 
‹mp_c_th»sh
 = (
ã©u»_»¥
 & 0xFFFFè- 
KELVIN_TEMP_FACTOR
;

925 
log_»¥Ú£
[0] = 
LOG_PAGE_TEMPERATURE_PAGE
;

927 
log_»¥Ú£
[3] = 
REMAINING_TEMP_PAGE_LENGTH
;

930 
log_»¥Ú£
[6] = 0x01;

931 
log_»¥Ú£
[7] = 0x02;

933 
log_»¥Ú£
[9] = 
‹mp_c_cur
;

935 
log_»¥Ú£
[11] = 0x01;

936 
log_»¥Ú£
[12] = 0x01;

937 
log_»¥Ú£
[13] = 0x02;

939 
log_»¥Ú£
[15] = 
‹mp_c_th»sh
;

941 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_TEMP_PAGE_LENGTH
);

942 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

944 
out_ä“_»¥Ú£
:

945 
	`kä“
(
log_»¥Ú£
);

946  
»s
;

947 
	}
}

951 
	$nvme_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

952 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

955 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

956  -
EINVAL
;

958 ià(
cdb10
) {

959 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

960 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

961 
»¥
[3] = 0x10 ;

962 
»¥
[4] = 
Îb¯
;

963 
»¥
[5] = 
RESERVED_FIELD
;

964 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

965 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

967 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

968 
»¥
[2] = 0x10 ;

969 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

973 
	}
}

975 
	$nvme_Œªs_fl_blk_desc
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

976 
u8
 *
»¥
, 
Ën
, u8 
Îb¯
)

978 
»s
;

979 
nvme_sc
;

980 
nvme_id_ns
 *
id_ns
;

981 
u8
 
æbas
;

982 
u32
 
lba_Ëngth
;

984 ià(
Îb¯
 =ğ0 && 
Ën
 < 
MODE_PAGE_BLK_DES_LEN
)

985  -
EINVAL
;

986 ià(
Îb¯
 > 0 && 
Ën
 < 
MODE_PAGE_LLBAA_BLK_DES_LEN
)

987  -
EINVAL
;

989 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

990 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

991 ià(
»s
)

992  
»s
;

994 
æbas
 = (
id_ns
->flbas) & 0x0F;

995 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

997 ià(
Îb¯
 == 0) {

998 
__be32
 
tmp_ÿp
 = 
	`ıu_to_be32
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

1000 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
 & 0x00FFFFFF);

1002 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u32
));

1003 
	`memıy
(&
»¥
[4], &
tmp_Ën
, (
u32
));

1005 
__be64
 
tmp_ÿp
 = 
	`ıu_to_be64
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

1006 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1008 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u64
));

1010 
	`memıy
(&
»¥
[12], &
tmp_Ën
, (
u32
));

1013 
	`kä“
(
id_ns
);

1014  
»s
;

1015 
	}
}

1017 
	$nvme_Œªs_fl_cÚŒŞ_·ge
(
nvme_ns
 *
ns
,

1018 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1019 
Ën
)

1021 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

1022  -
EINVAL
;

1024 
»¥
[0] = 
MODE_PAGE_CONTROL
;

1025 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

1026 
»¥
[2] = 0x0E;

1028 
»¥
[3] = 0x12;

1030 
»¥
[5] = 0x40;

1032 
»¥
[8] = 0xFF;

1033 
»¥
[9] = 0xFF;

1037 
	}
}

1039 
	$nvme_Œªs_fl_ÿchšg_·ge
(
nvme_ns
 *
ns
,

1040 
sg_io_hdr
 *
hdr
,

1041 
u8
 *
»¥
, 
Ën
)

1043 
»s
 = 0;

1044 
nvme_sc
;

1045 
u32
 
ã©u»_»¥
;

1046 
u8
 
vwc
;

1048 ià(
Ën
 < 
MODE_PAGE_CACHING_LEN
)

1049  -
EINVAL
;

1051 
nvme_sc
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
, 0, 0,

1052 &
ã©u»_»¥
);

1053 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1054 ià(
»s
)

1055  
»s
;

1057 
vwc
 = 
ã©u»_»¥
 & 0x00000001;

1059 
»¥
[0] = 
MODE_PAGE_CACHING
;

1060 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

1061 
»¥
[2] = 
vwc
 << 2;

1063 
	}
}

1065 
	$nvme_Œªs_fl_pow_úd_·ge
(
nvme_ns
 *
ns
,

1066 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1067 
Ën
)

1069 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

1070  -
EINVAL
;

1072 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

1073 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

1077 
	}
}

1079 
	$nvme_Œªs_fl_šf_exc_·ge
(
nvme_ns
 *
ns
,

1080 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1081 
Ën
)

1083 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

1084  -
EINVAL
;

1086 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

1087 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

1088 
»¥
[2] = 0x88;

1092 
	}
}

1094 
	$nvme_Œªs_fl_®l_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1095 
u8
 *
»¥
, 
Ën
)

1097 
»s
;

1098 
u16
 
mode_·ges_off£t_1
 = 0;

1099 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

1101 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

1102 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

1103 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

1105 
»s
 = 
	`nvme_Œªs_fl_ÿchšg_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_1
],

1106 
MODE_PAGE_CACHING_LEN
);

1107 ià(
»s
)

1108  
»s
;

1109 
»s
 = 
	`nvme_Œªs_fl_cÚŒŞ_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_2
],

1110 
MODE_PAGE_CONTROL_LEN
);

1111 ià(
»s
)

1112  
»s
;

1113 
»s
 = 
	`nvme_Œªs_fl_pow_úd_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_3
],

1114 
MODE_PAGE_POW_CND_LEN
);

1115 ià(
»s
)

1116  
»s
;

1117  
	`nvme_Œªs_fl_šf_exc_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_4
],

1118 
MODE_PAGE_INF_EXC_LEN
);

1119 
	}
}

1121 
šlše
 
	$nvme_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

1123 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

1125  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

1129 
	}
}

1131 
nvme_Œªs_mode_·ge_ü—‹
(
nvme_ns
 *
ns
,

1132 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
,

1133 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

1134 (*
mode_·ge_fl_func
)

1135 (
nvme_ns
 *,

1136 
sg_io_hdr
 *
hdr
, 
u8
 *, ),

1137 
u16
 
mode_·ges_tÙ_Ën
)

1139 
»s
;

1140 
xãr_Ën
;

1141 
u8
 *
»¥Ú£
;

1142 
u8
 
dbd
, 
Îb¯
;

1143 
u16
 
»¥_size
;

1144 
mph_size
;

1145 
u16
 
mode_·ges_off£t_1
;

1146 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

1148 
dbd
 = (
cmd
[1] & 
MODE_SENSE_DBD_MASK
è>> 
MODE_SENSE_DBD_SHIFT
;

1149 
Îb¯
 = (
cmd
[1] & 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
;

1150 
mph_size
 = 
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
;

1152 
blk_desc_Ën
 = 
	`nvme_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

1154 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1156 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1158 
blk_desc_off£t
 = 
mph_size
;

1159 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

1161 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

1162 ià(
»¥Ú£
 =ğ
NULL
) {

1163 
»s
 = -
ENOMEM
;

1164 
out_mem
;

1167 
»s
 = 
	`nvme_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
,

1168 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

1169 ià(
»s
)

1170 
out_ä“
;

1171 ià(
blk_desc_Ën
 > 0) {

1172 
»s
 = 
	`nvme_Œªs_fl_blk_desc
(
ns
, 
hdr
,

1173 &
»¥Ú£
[
blk_desc_off£t
],

1174 
blk_desc_Ën
, 
Îb¯
);

1175 ià(
»s
)

1176 
out_ä“
;

1178 
»s
 = 
	`mode_·ge_fl_func
(
ns
, 
hdr
, &
»¥Ú£
[
mode_·ges_off£t_1
],

1179 
mode_·ges_tÙ_Ën
);

1180 ià(
»s
)

1181 
out_ä“
;

1183 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

1184 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

1186 
out_ä“
:

1187 
	`kä“
(
»¥Ú£
);

1188 
out_mem
:

1189  
»s
;

1190 
	}
}

1194 
	$nvme_Œªs_fl_»ad_ÿp
(
u8
 *
»¥Ú£
, 
nvme_id_ns
 *
id_ns
,

1195 
u8
 
cdb16
)

1197 
u8
 
æbas
;

1198 
u32
 
lba_Ëngth
;

1199 
u64
 
¾ba
;

1200 
u8
 
´Ù_’
;

1201 
u8
 
p_ty³_lut
[4] = {0, 0, 1, 2};

1202 
__be64
 
tmp_¾ba
;

1203 
__be32
 
tmp_¾ba_32
;

1204 
__be32
 
tmp_Ën
;

1206 
æbas
 = (
id_ns
->flbas) & 0x0F;

1207 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1208 
¾ba
 = 
	`Ë64_to_ıup
(&
id_ns
->
nsze
) - 1;

1209 (
id_ns
->
dps
è? (
´Ù_’
 = 0x01) : (prot_en = 0);

1211 ià(!
cdb16
) {

1212 ià(
¾ba
 > 0xFFFFFFFF)

1213 
¾ba
 = 0xFFFFFFFF;

1214 
tmp_¾ba_32
 = 
	`ıu_to_be32
(
¾ba
);

1215 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1216 
	`memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

1217 
	`memıy
(&
»¥Ú£
[4], &
tmp_Ën
, (
u32
));

1219 
tmp_¾ba
 = 
	`ıu_to_be64
(
¾ba
);

1220 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1221 
	`memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

1222 
	`memıy
(&
»¥Ú£
[8], &
tmp_Ën
, (
u32
));

1223 
»¥Ú£
[12] = (
p_ty³_lut
[
id_ns
->
dps
 & 0x3] << 1è| 
´Ù_’
;

1228 
	}
}

1232 
	$nvme_Œªs_pow”_¡©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1233 
u8
 
pc
, u8 
pcmod
, u8 
¡¬t
)

1235 
»s
;

1236 
nvme_sc
;

1237 
nvme_id_ù¾
 *
id_ù¾
;

1238 
lowe¡_pow_¡
;

1239 
ps_desœed
 = 0;

1241 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ns
->
ù¾
, &
id_ù¾
);

1242 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1243 ià(
»s
)

1244  
»s
;

1246 
lowe¡_pow_¡
 = 
	`max
(
POWER_STATE_0
, ()(
id_ù¾
->
Åss
 - 1));

1247 
	`kä“
(
id_ù¾
);

1249 
pc
) {

1250 
NVME_POWER_STATE_START_VALID
:

1252 ià(
pcmod
 =ğ0 && 
¡¬t
 == 0x1)

1253 
ps_desœed
 = 
POWER_STATE_0
;

1254 ià(
pcmod
 =ğ0 && 
¡¬t
 == 0x0)

1255 
ps_desœed
 = 
lowe¡_pow_¡
;

1257 
NVME_POWER_STATE_ACTIVE
:

1259 ià(
pcmod
 == 0)

1260 
ps_desœed
 = 
POWER_STATE_0
;

1262 
NVME_POWER_STATE_IDLE
:

1264 ià(
pcmod
 == 0x0)

1265 
ps_desœed
 = 
POWER_STATE_1
;

1266 ià(
pcmod
 == 0x1)

1267 
ps_desœed
 = 
POWER_STATE_2
;

1268 ià(
pcmod
 == 0x2)

1269 
ps_desœed
 = 
POWER_STATE_3
;

1271 
NVME_POWER_STATE_STANDBY
:

1273 ià(
pcmod
 == 0x0)

1274 
ps_desœed
 = 
	`max
(
POWER_STATE_0
, (
lowe¡_pow_¡
 - 2));

1275 ià(
pcmod
 == 0x1)

1276 
ps_desœed
 = 
	`max
(
POWER_STATE_0
, (
lowe¡_pow_¡
 - 1));

1278 
NVME_POWER_STATE_LU_CONTROL
:

1280 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1281 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1282 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1285 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_POWER_MGMT
, 
ps_desœed
, 0,

1286 
NULL
);

1287  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1288 
	}
}

1290 
	$nvme_Œªs_£nd_aùiv©e_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1291 
u8
 
bufãr_id
)

1293 
nvme_commªd
 
c
;

1294 
nvme_sc
;

1296 
	`mem£t
(&
c
, 0, (c));

1297 
c
.
commÚ
.
İcode
 = 
nvme_admš_aùiv©e_fw
;

1298 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
bufãr_id
 | 
NVME_FWACT_REPL_ACTV
);

1300 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

1301  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1302 
	}
}

1304 
	$nvme_Œªs_£nd_dowÆßd_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1305 
u8
 
İcode
, 
u32
 
tÙ_Ën
, u32 
off£t
,

1306 
u8
 
bufãr_id
)

1308 
nvme_sc
;

1309 
nvme_commªd
 
c
;

1311 ià(
hdr
->
iovec_couÁ
 > 0) {

1313  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1314 
SAM_STAT_CHECK_CONDITION
,

1315 
ILLEGAL_REQUEST
,

1316 
SCSI_ASC_INVALID_CDB
,

1317 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1320 
	`mem£t
(&
c
, 0, (c));

1321 
c
.
commÚ
.
İcode
 = 
nvme_admš_dowÆßd_fw
;

1322 
c
.
dlfw
.
numd
 = 
	`ıu_to_Ë32
((
tÙ_Ën
/
BYTES_TO_DWORDS
) - 1);

1323 
c
.
dlfw
.
off£t
 = 
	`ıu_to_Ë32
(off£t/
BYTES_TO_DWORDS
);

1325 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
ù¾
->
admš_q
, &
c
,

1326 
hdr
->
dxã½
, 
tÙ_Ën
, 
NULL
, 0);

1327  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1328 
	}
}

1332 
šlše
 
	$nvme_Œªs_mode£l_g‘_bd_Ën
(
u8
 *
·rm_li¡
, u8 
cdb10
,

1333 
u16
 *
bd_Ën
, 
u8
 *
Îb¯
)

1335 ià(
cdb10
) {

1337 *
bd_Ën
 = (
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
] << 8) +

1338 
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
 + 1];

1339 *
Îb¯
 = 
·rm_li¡
[
MODE_SELECT_10_LLBAA_OFFSET
] &

1340 
MODE_SELECT_10_LLBAA_MASK
;

1343 *
bd_Ën
 = 
·rm_li¡
[
MODE_SELECT_6_BD_OFFSET
];

1345 
	}
}

1347 
	$nvme_Œªs_mode£l_§ve_bd
(
nvme_ns
 *
ns
, 
u8
 *
·rm_li¡
,

1348 
u16
 
idx
, u16 
bd_Ën
, 
u8
 
Îb¯
)

1350 
u16
 
bd_num
;

1352 
bd_num
 = 
bd_Ën
 / ((
Îb¯
 == 0) ?

1353 
SHORT_DESC_BLOCK
 : 
LONG_DESC_BLOCK
);

1356 ià(
Îb¯
 == 0) {

1358 
ns
->
mode_£Ëù_num_blocks
 =

1359 (
·rm_li¡
[
idx
 + 1] << 16) +

1360 (
·rm_li¡
[
idx
 + 2] << 8) +

1361 (
·rm_li¡
[
idx
 + 3]);

1363 
ns
->
mode_£Ëù_block_Ën
 =

1364 (
·rm_li¡
[
idx
 + 5] << 16) +

1365 (
·rm_li¡
[
idx
 + 6] << 8) +

1366 (
·rm_li¡
[
idx
 + 7]);

1369 
ns
->
mode_£Ëù_num_blocks
 =

1370 (((
u64
)
·rm_li¡
[
idx
 + 0]) << 56) +

1371 (((
u64
)
·rm_li¡
[
idx
 + 1]) << 48) +

1372 (((
u64
)
·rm_li¡
[
idx
 + 2]) << 40) +

1373 (((
u64
)
·rm_li¡
[
idx
 + 3]) << 32) +

1374 (((
u64
)
·rm_li¡
[
idx
 + 4]) << 24) +

1375 (((
u64
)
·rm_li¡
[
idx
 + 5]) << 16) +

1376 (((
u64
)
·rm_li¡
[
idx
 + 6]) << 8) +

1377 ((
u64
)
·rm_li¡
[
idx
 + 7]);

1379 
ns
->
mode_£Ëù_block_Ën
 =

1380 (
·rm_li¡
[
idx
 + 12] << 24) +

1381 (
·rm_li¡
[
idx
 + 13] << 16) +

1382 (
·rm_li¡
[
idx
 + 14] << 8) +

1383 (
·rm_li¡
[
idx
 + 15]);

1385 
	}
}

1387 
	$nvme_Œªs_mode£l_g‘_mp
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1388 
u8
 *
mode_·ge
, u8 
·ge_code
)

1390 
»s
 = 0;

1391 
nvme_sc
;

1392 
dwÜd11
;

1394 
·ge_code
) {

1395 
MODE_PAGE_CACHING
:

1396 
dwÜd11
 = ((
mode_·ge
[2] & 
CACHING_MODE_PAGE_WCE_MASK
) ? 1 : 0);

1397 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
,

1398 
dwÜd11
, 0, 
NULL
);

1399 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1401 
MODE_PAGE_CONTROL
:

1403 
MODE_PAGE_POWER_CONDITION
:

1405 ià((
mode_·ge
[2] & 0x01) != 0 || (mode_page[3] & 0x0F) != 0) {

1406 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1407 
SAM_STAT_CHECK_CONDITION
,

1408 
ILLEGAL_REQUEST
,

1409 
SCSI_ASC_INVALID_PARAMETER
,

1410 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1415 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1416 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1417 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1421  
»s
;

1422 
	}
}

1424 
	$nvme_Œªs_mode£l_d©a
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1425 
u8
 *
cmd
, 
u16
 
·rm_li¡_Ën
, u8 
pf
,

1426 
u8
 
¥
, u8 
cdb10
)

1428 
»s
;

1429 
u8
 *
·rm_li¡
;

1430 
u16
 
bd_Ën
;

1431 
u8
 
Îb¯
 = 0;

1432 
u16
 
šdex
, 
§ved_šdex
;

1433 
u8
 
·ge_code
;

1434 
u16
 
mp_size
;

1437 
·rm_li¡
 = 
	`km®loc
(
·rm_li¡_Ën
, 
GFP_KERNEL
);

1438 ià(
·rm_li¡
 =ğ
NULL
) {

1439 
»s
 = -
ENOMEM
;

1440 
out
;

1443 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
·rm_li¡_Ën
);

1444 ià(
»s
)

1445 
out_mem
;

1447 
	`nvme_Œªs_mode£l_g‘_bd_Ën
(
·rm_li¡
, 
cdb10
, &
bd_Ën
, &
Îb¯
);

1448 
šdex
 = (
cdb10
è? (
MODE_SELECT_10_MPH_SIZE
è: (
MODE_SELECT_6_MPH_SIZE
);

1450 ià(
bd_Ën
 != 0) {

1452 
	`nvme_Œªs_mode£l_§ve_bd
(
ns
, 
·rm_li¡
, 
šdex
, 
bd_Ën
, 
Îb¯
);

1453 
šdex
 +ğ
bd_Ën
;

1455 
§ved_šdex
 = 
šdex
;

1460 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1461 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1462 ià((
·ge_code
 !ğ
MODE_PAGE_CACHING
) &&

1463 (
·ge_code
 !ğ
MODE_PAGE_CONTROL
) &&

1464 (
·ge_code
 !ğ
MODE_PAGE_POWER_CONDITION
)) {

1465 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1466 
SAM_STAT_CHECK_CONDITION
,

1467 
ILLEGAL_REQUEST
,

1468 
SCSI_ASC_INVALID_CDB
,

1469 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1470 
out_mem
;

1472 
šdex
 +ğ
mp_size
;

1473 } 
šdex
 < 
·rm_li¡_Ën
);

1476 
šdex
 = 
§ved_šdex
;

1478 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1479 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1480 
»s
 = 
	`nvme_Œªs_mode£l_g‘_mp
(
ns
, 
hdr
, &
·rm_li¡
[
šdex
],

1481 
·ge_code
);

1482 ià(
»s
)

1484 
šdex
 +ğ
mp_size
;

1485 } 
šdex
 < 
·rm_li¡_Ën
);

1487 
out_mem
:

1488 
	`kä“
(
·rm_li¡
);

1489 
out
:

1490  
»s
;

1491 
	}
}

1495 
	$nvme_Œªs_fmt_£t_blk_size_couÁ
(
nvme_ns
 *
ns
,

1496 
sg_io_hdr
 *
hdr
)

1498 
»s
 = 0;

1499 
nvme_sc
;

1500 
u8
 
æbas
;

1509 ià(
ns
->
mode_£Ëù_num_blocks
 =ğ0 ||‚s->
mode_£Ëù_block_Ën
 == 0) {

1510 
nvme_id_ns
 *
id_ns
;

1512 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1513 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1514 ià(
»s
)

1515  
»s
;

1517 ià(
ns
->
mode_£Ëù_num_blocks
 == 0)

1518 
ns
->
mode_£Ëù_num_blocks
 = 
	`Ë64_to_ıu
(
id_ns
->
nÿp
);

1519 ià(
ns
->
mode_£Ëù_block_Ën
 == 0) {

1520 
æbas
 = (
id_ns
->flbas) & 0x0F;

1521 
ns
->
mode_£Ëù_block_Ën
 =

1522 (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1525 
	`kä“
(
id_ns
);

1529 
	}
}

1531 
	$nvme_Œªs_fmt_g‘_·rm_h—d”
(
sg_io_hdr
 *
hdr
, 
u8
 
Ën
,

1532 
u8
 
fÜm©_´Ù_šfo
, u8 *
nvme_pf_code
)

1534 
»s
;

1535 
u8
 *
·rm_li¡
;

1536 
u8
 
pf_u§ge
, 
pf_code
;

1538 
·rm_li¡
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1539 ià(
·rm_li¡
 =ğ
NULL
) {

1540 
»s
 = -
ENOMEM
;

1541 
out
;

1543 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
Ën
);

1544 ià(
»s
)

1545 
out_mem
;

1547 ià((
·rm_li¡
[
FORMAT_UNIT_IMMED_OFFSET
] &

1548 
FORMAT_UNIT_IMMED_MASK
) != 0) {

1549 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1550 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1551 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1552 
out_mem
;

1555 ià(
Ën
 =ğ
FORMAT_UNIT_LONG_PARM_LIST_LEN
 &&

1556 (
·rm_li¡
[
FORMAT_UNIT_PROT_INT_OFFSET
] & 0x0F) != 0) {

1557 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1558 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1559 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1560 
out_mem
;

1562 
pf_u§ge
 = 
·rm_li¡
[
FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
] &

1563 
FORMAT_UNIT_PROT_FIELD_USAGE_MASK
;

1564 
pf_code
 = (
pf_u§ge
 << 2è| 
fÜm©_´Ù_šfo
;

1565 
pf_code
) {

1567 *
nvme_pf_code
 = 0;

1570 *
nvme_pf_code
 = 1;

1573 *
nvme_pf_code
 = 2;

1576 *
nvme_pf_code
 = 3;

1579 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1580 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1581 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1585 
out_mem
:

1586 
	`kä“
(
·rm_li¡
);

1587 
out
:

1588  
»s
;

1589 
	}
}

1591 
	$nvme_Œªs_fmt_£nd_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1592 
u8
 
´Ù_šfo
)

1594 
»s
;

1595 
nvme_sc
;

1596 
nvme_id_ns
 *
id_ns
;

1597 
u8
 
i
;

1598 
u8
 
æbas
, 
Æbaf
;

1599 
u8
 
£Ëùed_lbaf
 = 0xFF;

1600 
u32
 
cdw10
 = 0;

1601 
nvme_commªd
 
c
;

1604 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1605 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1606 ià(
»s
)

1607  
»s
;

1609 
æbas
 = (
id_ns
->flbas) & 0x0F;

1610 
Æbaf
 = 
id_ns
->nlbaf;

1612 
i
 = 0; i < 
Æbaf
; i++) {

1613 ià(
ns
->
mode_£Ëù_block_Ën
 =ğ(1 << (
id_ns
->
lbaf
[
i
].
ds
))) {

1614 
£Ëùed_lbaf
 = 
i
;

1618 ià(
£Ëùed_lbaf
 > 0x0F) {

1619 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1620 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1621 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1623 ià(
ns
->
mode_£Ëù_num_blocks
 !ğ
	`Ë64_to_ıu
(
id_ns
->
nÿp
)) {

1624 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1625 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1626 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1629 
cdw10
 |ğ
´Ù_šfo
 << 5;

1630 
cdw10
 |ğ
£Ëùed_lbaf
 & 0x0F;

1631 
	`mem£t
(&
c
, 0, (c));

1632 
c
.
fÜm©
.
İcode
 = 
nvme_admš_fÜm©_nvm
;

1633 
c
.
fÜm©
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1634 
c
.
fÜm©
.
cdw10
 = 
	`ıu_to_Ë32
(cdw10);

1636 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

1637 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1639 
	`kä“
(
id_ns
);

1640  
»s
;

1641 
	}
}

1643 
šlše
 
u32
 
	$nvme_Œªs_io_g‘_num_cmds
(
sg_io_hdr
 *
hdr
,

1644 
nvme_Œªs_io_cdb
 *
cdb_šfo
,

1645 
u32
 
max_blocks
)

1648 ià(
hdr
->
iovec_couÁ
 > 0)

1649  
hdr
->
iovec_couÁ
;

1650 ià(
cdb_šfo
->
xãr_Ën
 > 
max_blocks
)

1651  ((
cdb_šfo
->
xãr_Ën
 - 1è/ 
max_blocks
) + 1;

1654 
	}
}

1656 
u16
 
	$nvme_Œªs_io_g‘_cÚŒŞ
(
nvme_ns
 *
ns
,

1657 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1659 
u16
 
cÚŒŞ
 = 0;

1663 ià(
cdb_šfo
->
fua
 > 0)

1664 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1666  
cÚŒŞ
;

1667 
	}
}

1669 
	$nvme_Œªs_do_nvme_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1670 
nvme_Œªs_io_cdb
 *
cdb_šfo
, 
u8
 
is_wr™e
)

1672 
nvme_sc
 = 
NVME_SC_SUCCESS
;

1673 
u32
 
num_cmds
;

1674 
u64
 
un™_Ën
;

1675 
u64
 
un™_num_blocks
;

1676 
u32
 
»tcode
;

1677 
u32
 
i
 = 0;

1678 
u64
 
nvme_off£t
 = 0;

1679 
__u£r
 *
Ãxt_m­pšg_addr
;

1680 
nvme_commªd
 
c
;

1681 
u8
 
İcode
 = (
is_wr™e
 ? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1682 
u16
 
cÚŒŞ
;

1683 
u32
 
max_blocks
 = 
	`queue_max_hw_£ùÜs
(
ns
->
queue
);

1685 
num_cmds
 = 
	`nvme_Œªs_io_g‘_num_cmds
(
hdr
, 
cdb_šfo
, 
max_blocks
);

1696 
i
 = 0; i < 
num_cmds
; i++) {

1697 
	`mem£t
(&
c
, 0, (c));

1698 ià(
hdr
->
iovec_couÁ
 > 0) {

1699 
sg_iovec
 
sgl
;

1701 
»tcode
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1702 
i
 * (
sg_iovec
),

1703 (
sg_iovec
));

1704 ià(
»tcode
)

1705  -
EFAULT
;

1706 
un™_Ën
 = 
sgl
.
iov_Ën
;

1707 
un™_num_blocks
 = 
un™_Ën
 >> 
ns
->
lba_shiá
;

1708 
Ãxt_m­pšg_addr
 = 
sgl
.
iov_ba£
;

1710 
un™_num_blocks
 = 
	`mš
((
u64
)
max_blocks
,

1711 (
cdb_šfo
->
xãr_Ën
 - 
nvme_off£t
));

1712 
un™_Ën
 = 
un™_num_blocks
 << 
ns
->
lba_shiá
;

1713 
Ãxt_m­pšg_addr
 = 
hdr
->
dxã½
 +

1714 ((1 << 
ns
->
lba_shiá
è* 
nvme_off£t
);

1717 
c
.
rw
.
İcode
 = opcode;

1718 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1719 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
cdb_šfo
->
lba
 + 
nvme_off£t
);

1720 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
un™_num_blocks
 - 1);

1721 
cÚŒŞ
 = 
	`nvme_Œªs_io_g‘_cÚŒŞ
(
ns
, 
cdb_šfo
);

1722 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1724 ià(
	`g‘_ÿ·c™y
(
ns
->
disk
è- 
un™_num_blocks
 <

1725 
cdb_šfo
->
lba
 + 
nvme_off£t
) {

1726 
nvme_sc
 = 
NVME_SC_LBA_RANGE
;

1729 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1730 
Ãxt_m­pšg_addr
, 
un™_Ën
, 
NULL
, 0);

1731 ià(
nvme_sc
)

1734 
nvme_off£t
 +ğ
un™_num_blocks
;

1737  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1738 
	}
}

1743 
	$nvme_Œªs_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
, 
u8
 
is_wr™e
,

1744 
u8
 *
cmd
)

1746 
»s
 = 0;

1747 
nvme_Œªs_io_cdb
 
cdb_šfo
 = { 0, };

1748 
u8
 
İcode
 = 
cmd
[0];

1749 
u64
 
xãr_by‹s
;

1750 
u64
 
sum_iov_Ën
 = 0;

1751 
sg_iovec
 
sgl
;

1752 
i
;

1753 
size_t
 
nÙ_cİ›d
;

1759 
İcode
) {

1760 
WRITE_6
:

1761 
READ_6
:

1764 
cdb_šfo
.
fua
 = 
cmd
[1] & 0x8;

1765 
cdb_šfo
.
´Ù_šfo
 = (
cmd
[1] & 0xe0) >> 5;

1766 ià(
cdb_šfo
.
´Ù_šfo
 && !
ns
->
pi_ty³
) {

1767  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1768 
SAM_STAT_CHECK_CONDITION
,

1769 
ILLEGAL_REQUEST
,

1770 
SCSI_ASC_INVALID_CDB
,

1771 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1775 
İcode
) {

1776 
WRITE_6
:

1777 
READ_6
:

1778 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[1]);

1779 
cdb_šfo
.
xãr_Ën
 = 
cmd
[4];

1780 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1781 
cdb_šfo
.
xãr_Ën
 = 256;

1783 
WRITE_10
:

1784 
READ_10
:

1785 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1786 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1788 
WRITE_12
:

1789 
READ_12
:

1790 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1791 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

1793 
WRITE_16
:

1794 
READ_16
:

1795 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be64
(&
cmd
[2]);

1796 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

1800 
»s
 = -
EIO
;

1801 
out
;

1805 ià(
hdr
->
iovec_couÁ
 > 0) {

1806 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

1807 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1808 
i
 * (
sg_iovec
),

1809 (
sg_iovec
));

1810 ià(
nÙ_cİ›d
)

1811  -
EFAULT
;

1812 
sum_iov_Ën
 +ğ
sgl
.
iov_Ën
;

1814 ià(
sgl
.
iov_Ën
 % (1 << 
ns
->
lba_shiá
) != 0) {

1815 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1816 
SAM_STAT_CHECK_CONDITION
,

1817 
ILLEGAL_REQUEST
,

1818 
SCSI_ASC_INVALID_PARAMETER
,

1819 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1820 
out
;

1824 
sum_iov_Ën
 = 
hdr
->
dxãr_Ën
;

1828 
xãr_by‹s
 = 
	`mš
(((
u64
)
hdr
->
dxãr_Ën
), 
sum_iov_Ën
);

1831 ià(
xãr_by‹s
 !ğ(
cdb_šfo
.
xãr_Ën
 << 
ns
->
lba_shiá
)) {

1832 
»s
 = -
EINVAL
;

1833 
out
;

1837 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1838 
out
;

1841 
»s
 = 
	`nvme_Œªs_do_nvme_io
(
ns
, 
hdr
, &
cdb_šfo
, 
is_wr™e
);

1842 ià(
»s
)

1843 
out
;

1845 
out
:

1846  
»s
;

1847 
	}
}

1849 
	$nvme_Œªs_šquœy
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1850 
u8
 *
cmd
)

1852 
»s
 = 0;

1853 
u8
 
evpd
;

1854 
u8
 
·ge_code
;

1855 
®loc_Ën
;

1856 
u8
 *
šq_»¥Ú£
;

1858 
evpd
 = 
cmd
[1] & 0x01;

1859 
·ge_code
 = 
cmd
[2];

1860 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[3]);

1862 
šq_»¥Ú£
 = 
	`km®loc
(
	`max
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
),

1863 
GFP_KERNEL
);

1864 ià(
šq_»¥Ú£
 =ğ
NULL
) {

1865 
»s
 = -
ENOMEM
;

1866 
out_mem
;

1869 ià(
evpd
 == 0) {

1870 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

1871 
»s
 = 
	`nvme_Œªs_¡ªd¬d_šquœy_·ge
(
ns
, 
hdr
,

1872 
šq_»¥Ú£
, 
®loc_Ën
);

1874 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1875 
SAM_STAT_CHECK_CONDITION
,

1876 
ILLEGAL_REQUEST
,

1877 
SCSI_ASC_INVALID_CDB
,

1878 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1881 
·ge_code
) {

1882 
VPD_SUPPORTED_PAGES
:

1883 
»s
 = 
	`nvme_Œªs_suµÜ‹d_vpd_·ges
(
ns
, 
hdr
,

1884 
šq_»¥Ú£
, 
®loc_Ën
);

1886 
VPD_SERIAL_NUMBER
:

1887 
»s
 = 
	`nvme_Œªs_un™_£rŸl_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1888 
®loc_Ën
);

1890 
VPD_DEVICE_IDENTIFIERS
:

1891 
»s
 = 
	`nvme_Œªs_deviû_id_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1892 
®loc_Ën
);

1894 
VPD_EXTENDED_INQUIRY
:

1895 
»s
 = 
	`nvme_Œªs_ext_šq_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1897 
VPD_BLOCK_LIMITS
:

1898 
»s
 = 
	`nvme_Œªs_bdev_lim™s_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1899 
®loc_Ën
);

1901 
VPD_BLOCK_DEV_CHARACTERISTICS
:

1902 
»s
 = 
	`nvme_Œªs_bdev_ch¬_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1905 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1906 
SAM_STAT_CHECK_CONDITION
,

1907 
ILLEGAL_REQUEST
,

1908 
SCSI_ASC_INVALID_CDB
,

1909 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1913 
	`kä“
(
šq_»¥Ú£
);

1914 
out_mem
:

1915  
»s
;

1916 
	}
}

1918 
	$nvme_Œªs_log_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1919 
u8
 *
cmd
)

1921 
»s
;

1922 
u16
 
®loc_Ën
;

1923 
u8
 
pc
;

1924 
u8
 
·ge_code
;

1926 ià(
cmd
[1] !ğ
LOG_SENSE_CDB_SP_NOT_ENABLED
) {

1927 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1928 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1929 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1930 
out
;

1933 
·ge_code
 = 
cmd
[2] & 
LOG_SENSE_CDB_PAGE_CODE_MASK
;

1934 
pc
 = (
cmd
[2] & 
LOG_SENSE_CDB_PC_MASK
è>> 
LOG_SENSE_CDB_PC_SHIFT
;

1935 ià(
pc
 !ğ
LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
) {

1936 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1937 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1938 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1939 
out
;

1941 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1942 
·ge_code
) {

1943 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
:

1944 
»s
 = 
	`nvme_Œªs_log_suµ_·ges
(
ns
, 
hdr
, 
®loc_Ën
);

1946 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
:

1947 
»s
 = 
	`nvme_Œªs_log_šfo_exû±iÚs
(
ns
, 
hdr
, 
®loc_Ën
);

1949 
LOG_PAGE_TEMPERATURE_PAGE
:

1950 
»s
 = 
	`nvme_Œªs_log_‹m³¿tu»
(
ns
, 
hdr
, 
®loc_Ën
);

1953 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1954 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1955 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1959 
out
:

1960  
»s
;

1961 
	}
}

1963 
	$nvme_Œªs_mode_£Ëù
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1964 
u8
 *
cmd
)

1966 
u8
 
cdb10
 = 0;

1967 
u16
 
·rm_li¡_Ën
;

1968 
u8
 
·ge_fÜm©
;

1969 
u8
 
§ve_·ges
;

1971 
·ge_fÜm©
 = 
cmd
[1] & 
MODE_SELECT_CDB_PAGE_FORMAT_MASK
;

1972 
§ve_·ges
 = 
cmd
[1] & 
MODE_SELECT_CDB_SAVE_PAGES_MASK
;

1974 ià(
cmd
[0] =ğ
MODE_SELECT
) {

1975 
·rm_li¡_Ën
 = 
cmd
[4];

1977 
·rm_li¡_Ën
 = 
cmd
[7];

1978 
cdb10
 = 1;

1981 ià(
·rm_li¡_Ën
 != 0) {

1986  
	`nvme_Œªs_mode£l_d©a
(
ns
, 
hdr
, 
cmd
, 
·rm_li¡_Ën
,

1987 
·ge_fÜm©
, 
§ve_·ges
, 
cdb10
);

1991 
	}
}

1993 
	$nvme_Œªs_mode_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1994 
u8
 *
cmd
)

1996 
»s
 = 0;

1997 
u16
 
®loc_Ën
;

1998 
u8
 
cdb10
 = 0;

2000 ià(
cmd
[0] =ğ
MODE_SENSE
) {

2001 
®loc_Ën
 = 
cmd
[4];

2003 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

2004 
cdb10
 = 1;

2007 ià((
cmd
[2] & 
MODE_SENSE_PAGE_CONTROL_MASK
) !=

2008 
MODE_SENSE_PC_CURRENT_VALUES
) {

2009 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2010 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2011 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2012 
out
;

2015 
cmd
[2] & 
MODE_SENSE_PAGE_CODE_MASK
) {

2016 
MODE_PAGE_CACHING
:

2017 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2018 
cdb10
,

2019 &
nvme_Œªs_fl_ÿchšg_·ge
,

2020 
MODE_PAGE_CACHING_LEN
);

2022 
MODE_PAGE_CONTROL
:

2023 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2024 
cdb10
,

2025 &
nvme_Œªs_fl_cÚŒŞ_·ge
,

2026 
MODE_PAGE_CONTROL_LEN
);

2028 
MODE_PAGE_POWER_CONDITION
:

2029 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2030 
cdb10
,

2031 &
nvme_Œªs_fl_pow_úd_·ge
,

2032 
MODE_PAGE_POW_CND_LEN
);

2034 
MODE_PAGE_INFO_EXCEP
:

2035 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2036 
cdb10
,

2037 &
nvme_Œªs_fl_šf_exc_·ge
,

2038 
MODE_PAGE_INF_EXC_LEN
);

2040 
MODE_PAGE_RETURN_ALL
:

2041 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

2042 
cdb10
,

2043 &
nvme_Œªs_fl_®l_·ges
,

2044 
MODE_PAGE_ALL_LEN
);

2047 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2048 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2049 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2053 
out
:

2054  
»s
;

2055 
	}
}

2057 
	$nvme_Œªs_»ad_ÿ·c™y
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2058 
u8
 *
cmd
, u8 
cdb16
)

2060 
»s
;

2061 
nvme_sc
;

2062 
u32
 
®loc_Ën
;

2063 
u32
 
»¥_size
;

2064 
u32
 
xãr_Ën
;

2065 
nvme_id_ns
 *
id_ns
;

2066 
u8
 *
»¥Ú£
;

2068 ià(
cdb16
) {

2069 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

2070 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

2072 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

2073 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

2076 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

2077 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2078 ià(
»s
)

2079  
»s
;

2081 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2082 ià(
»¥Ú£
 =ğ
NULL
) {

2083 
»s
 = -
ENOMEM
;

2084 
out_ä“_id
;

2086 
	`nvme_Œªs_fl_»ad_ÿp
(
»¥Ú£
, 
id_ns
, 
cdb16
);

2088 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2089 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2091 
	`kä“
(
»¥Ú£
);

2092 
out_ä“_id
:

2093 
	`kä“
(
id_ns
);

2094  
»s
;

2095 
	}
}

2097 
	$nvme_Œªs_»pÜt_luns
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2098 
u8
 *
cmd
)

2100 
»s
;

2101 
nvme_sc
;

2102 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2103 
u8
 *
»¥Ú£
;

2104 
nvme_id_ù¾
 *
id_ù¾
;

2105 
u32
 
Î_Ëngth
, 
lun_id
;

2106 
u8
 
lun_id_off£t
 = 
REPORT_LUNS_FIRST_LUN_OFFSET
;

2107 
__be32
 
tmp_Ën
;

2109 
cmd
[2]) {

2111  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2112 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2113 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2114 
ALL_LUNS_RETURNED
:

2115 
ALL_WELL_KNOWN_LUNS_RETURNED
:

2116 
RESTRICTED_LUNS_RETURNED
:

2117 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ns
->
ù¾
, &
id_ù¾
);

2118 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2119 ià(
»s
)

2120  
»s
;

2122 
Î_Ëngth
 = 
	`Ë32_to_ıu
(
id_ù¾
->
Â
è* 
LUN_ENTRY_SIZE
;

2123 
»¥_size
 = 
Î_Ëngth
 + 
LUN_DATA_HEADER_SIZE
;

2125 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

2126 ià(
®loc_Ën
 < 
»¥_size
) {

2127 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2128 
SAM_STAT_CHECK_CONDITION
,

2129 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2130 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2131 
out_ä“_id
;

2134 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2135 ià(
»¥Ú£
 =ğ
NULL
) {

2136 
»s
 = -
ENOMEM
;

2137 
out_ä“_id
;

2141 
lun_id
 = 0;†un_id < 
	`Ë32_to_ıu
(
id_ù¾
->
Â
);†un_id++) {

2146 
__be64
 
tmp_id
 = 
	`ıu_to_be64
(
lun_id
);

2147 
	`memıy
(&
»¥Ú£
[
lun_id_off£t
], &
tmp_id
, (
u64
));

2148 
lun_id_off£t
 +ğ
LUN_ENTRY_SIZE
;

2150 
tmp_Ën
 = 
	`ıu_to_be32
(
Î_Ëngth
);

2151 
	`memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

2154 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2155 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2157 
	`kä“
(
»¥Ú£
);

2158 
out_ä“_id
:

2159 
	`kä“
(
id_ù¾
);

2160  
»s
;

2161 
	}
}

2163 
	$nvme_Œªs_»que¡_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2164 
u8
 *
cmd
)

2166 
»s
;

2167 
u8
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2168 
u8
 
desc_fÜm©
;

2169 
u8
 *
»¥Ú£
;

2171 
desc_fÜm©
 = 
cmd
[1] & 0x01;

2172 
®loc_Ën
 = 
cmd
[4];

2174 
»¥_size
 = ((
desc_fÜm©
è? (
DESC_FMT_SENSE_DATA_SIZE
) :

2175 (
FIXED_FMT_SENSE_DATA_SIZE
));

2176 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2177 ià(
»¥Ú£
 =ğ
NULL
) {

2178 
»s
 = -
ENOMEM
;

2179 
out
;

2182 ià(
desc_fÜm©
) {

2184 
»¥Ú£
[0] = 
DESC_FORMAT_SENSE_DATA
;

2185 
»¥Ú£
[1] = 
NO_SENSE
;

2187 
»¥Ú£
[2] = 
SCSI_ASC_NO_SENSE
;

2188 
»¥Ú£
[3] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2192 
»¥Ú£
[0] = 
FIXED_SENSE_DATA
;

2194 
»¥Ú£
[2] = 
NO_SENSE
;

2196 
»¥Ú£
[7] = 
FIXED_SENSE_DATA_ADD_LENGTH
;

2198 
»¥Ú£
[12] = 
SCSI_ASC_NO_SENSE
;

2199 
»¥Ú£
[13] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2204 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2205 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2207 
	`kä“
(
»¥Ú£
);

2208 
out
:

2209  
»s
;

2210 
	}
}

2212 
	$nvme_Œªs_£cur™y_´ÙocŞ
(
nvme_ns
 *
ns
,

2213 
sg_io_hdr
 *
hdr
,

2214 
u8
 *
cmd
)

2216  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2217 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2218 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2219 
	}
}

2221 
	$nvme_Œªs_synchrÚize_ÿche
(
nvme_ns
 *
ns
,

2222 
sg_io_hdr
 *
hdr
)

2224 
nvme_sc
;

2225 
nvme_commªd
 
c
;

2227 
	`mem£t
(&
c
, 0, (c));

2228 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2229 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2231 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

2232  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2233 
	}
}

2235 
	$nvme_Œªs_¡¬t_¡İ
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2236 
u8
 *
cmd
)

2238 
u8
 
immed
, 
pcmod
, 
pc
, 
no_æush
, 
¡¬t
;

2240 
immed
 = 
cmd
[1] & 0x01;

2241 
pcmod
 = 
cmd
[3] & 0x0f;

2242 
pc
 = (
cmd
[4] & 0xf0) >> 4;

2243 
no_æush
 = 
cmd
[4] & 0x04;

2244 
¡¬t
 = 
cmd
[4] & 0x01;

2246 ià(
immed
 != 0) {

2247  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2248 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2249 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2251 ià(
no_æush
 == 0) {

2253 
»s
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2254 ià(
»s
)

2255  
»s
;

2258  
	`nvme_Œªs_pow”_¡©e
(
ns
, 
hdr
, 
pc
, 
pcmod
, 
¡¬t
);

2260 
	}
}

2262 
	$nvme_Œªs_fÜm©_un™
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2263 
u8
 *
cmd
)

2265 
»s
;

2266 
u8
 
·rm_hdr_Ën
 = 0;

2267 
u8
 
nvme_pf_code
 = 0;

2268 
u8
 
fÜm©_´Ù_šfo
, 
lÚg_li¡
, 
fÜm©_d©a
;

2270 
fÜm©_´Ù_šfo
 = (
cmd
[1] & 0xc0) >> 6;

2271 
lÚg_li¡
 = 
cmd
[1] & 0x20;

2272 
fÜm©_d©a
 = 
cmd
[1] & 0x10;

2274 ià(
fÜm©_d©a
 != 0) {

2275 ià(
fÜm©_´Ù_šfo
 != 0) {

2276 ià(
lÚg_li¡
 == 0)

2277 
·rm_hdr_Ën
 = 
FORMAT_UNIT_SHORT_PARM_LIST_LEN
;

2279 
·rm_hdr_Ën
 = 
FORMAT_UNIT_LONG_PARM_LIST_LEN
;

2281 } ià(
fÜm©_d©a
 =ğ0 && 
fÜm©_´Ù_šfo
 != 0) {

2282 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2283 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2284 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2285 
out
;

2293 ià(
·rm_hdr_Ën
 > 0) {

2294 
»s
 = 
	`nvme_Œªs_fmt_g‘_·rm_h—d”
(
hdr
, 
·rm_hdr_Ën
,

2295 
fÜm©_´Ù_šfo
, &
nvme_pf_code
);

2296 ià(
»s
)

2297 
out
;

2301 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 0);

2304 
»s
 = 
	`nvme_Œªs_fmt_£t_blk_size_couÁ
(
ns
, 
hdr
);

2305 ià(
»s
)

2306 
out
;

2308 
»s
 = 
	`nvme_Œªs_fmt_£nd_cmd
(
ns
, 
hdr
, 
nvme_pf_code
);

2310 
out
:

2311  
»s
;

2312 
	}
}

2314 
	$nvme_Œªs_‹¡_un™_»ady
(
nvme_ns
 *
ns
,

2315 
sg_io_hdr
 *
hdr
,

2316 
u8
 *
cmd
)

2318 ià(
	`nvme_ù¾_»ady
(
ns
->
ù¾
))

2319  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2320 
NOT_READY
, 
SCSI_ASC_LUN_NOT_READY
,

2321 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2323  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_GOOD
, 
NO_SENSE
, 0, 0);

2324 
	}
}

2326 
	$nvme_Œªs_wr™e_bufãr
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2327 
u8
 *
cmd
)

2329 
»s
 = 0;

2330 
u32
 
bufãr_off£t
, 
·rm_li¡_Ëngth
;

2331 
u8
 
bufãr_id
, 
mode
;

2333 
·rm_li¡_Ëngth
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[6]);

2334 ià(
·rm_li¡_Ëngth
 % 
BYTES_TO_DWORDS
 != 0) {

2336 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2337 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2338 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2339 
out
;

2341 
bufãr_id
 = 
cmd
[2];

2342 ià(
bufãr_id
 > 
NVME_MAX_FIRMWARE_SLOT
) {

2343 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2344 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2345 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2346 
out
;

2348 
mode
 = 
cmd
[1] & 0x1f;

2349 
bufãr_off£t
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[3]);

2351 
mode
) {

2352 
DOWNLOAD_SAVE_ACTIVATE
:

2353 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2354 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2355 
bufãr_id
);

2356 ià(
»s
)

2357 
out
;

2358 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2360 
DOWNLOAD_SAVE_DEFER_ACTIVATE
:

2361 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2362 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2363 
bufãr_id
);

2365 
ACTIVATE_DEFERRED_MICROCODE
:

2366 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2369 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2370 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2371 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2375 
out
:

2376  
»s
;

2377 
	}
}

2379 
	sscsi_unm­_blk_desc
 {

2380 
__be64
 
	m¦ba
;

2381 
__be32
 
	mÆb
;

2382 
u32
 
	m»sv
;

2385 
	sscsi_unm­_·rm_li¡
 {

2386 
__be16
 
	munm­_d©a_Ën
;

2387 
__be16
 
	munm­_blk_desc_d©a_Ën
;

2388 
u32
 
	m»sv
;

2389 
scsi_unm­_blk_desc
 
	mdesc
[0];

2392 
	$nvme_Œªs_unm­
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2393 
u8
 *
cmd
)

2395 
scsi_unm­_·rm_li¡
 *
¶i¡
;

2396 
nvme_dsm_¿nge
 *
¿nge
;

2397 
nvme_commªd
 
c
;

2398 
i
, 
nvme_sc
, 
»s
;

2399 
u16
 
ndesc
, 
li¡_Ën
;

2401 
li¡_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

2402 ià(!
li¡_Ën
)

2403  -
EINVAL
;

2405 
¶i¡
 = 
	`km®loc
(
li¡_Ën
, 
GFP_KERNEL
);

2406 ià(!
¶i¡
)

2407  -
ENOMEM
;

2409 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
¶i¡
, 
li¡_Ën
);

2410 ià(
»s
)

2411 
out
;

2413 
ndesc
 = 
	`be16_to_ıu
(
¶i¡
->
unm­_blk_desc_d©a_Ën
) >> 4;

2414 ià(!
ndesc
 ||‚desc > 256) {

2415 
»s
 = -
EINVAL
;

2416 
out
;

2419 
¿nge
 = 
	`kÿÎoc
(
ndesc
, (*¿nge), 
GFP_KERNEL
);

2420 ià(!
¿nge
) {

2421 
»s
 = -
ENOMEM
;

2422 
out
;

2425 
i
 = 0; i < 
ndesc
; i++) {

2426 
¿nge
[
i
].
Æb
 = 
	`ıu_to_Ë32
(
	`be32_to_ıu
(
¶i¡
->
desc
[i].nlb));

2427 
¿nge
[
i
].
¦ba
 = 
	`ıu_to_Ë64
(
	`be64_to_ıu
(
¶i¡
->
desc
[i].slba));

2428 
¿nge
[
i
].
ÿ‰r
 = 0;

2431 
	`mem£t
(&
c
, 0, (c));

2432 
c
.
dsm
.
İcode
 = 
nvme_cmd_dsm
;

2433 
c
.
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2434 
c
.
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
ndesc
 - 1);

2435 
c
.
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

2437 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
¿nge
,

2438 
ndesc
 * (*
¿nge
));

2439 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2441 
	`kä“
(
¿nge
);

2442 
out
:

2443 
	`kä“
(
¶i¡
);

2444  
»s
;

2445 
	}
}

2447 
	$nvme_scsi_Œª¦©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
)

2449 
u8
 
cmd
[
BLK_MAX_CDB
];

2450 
»tcode
;

2451 
İcode
;

2453 ià(
hdr
->
cmdp
 =ğ
NULL
)

2454  -
EMSGSIZE
;

2455 ià(
	`cİy_äom_u£r
(
cmd
, 
hdr
->
cmdp
, hdr->
cmd_Ën
))

2456  -
EFAULT
;

2462 
»tcode
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2463 ià(
»tcode
)

2464  
»tcode
;

2466 
İcode
 = 
cmd
[0];

2468 
İcode
) {

2469 
READ_6
:

2470 
READ_10
:

2471 
READ_12
:

2472 
READ_16
:

2473 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 0, 
cmd
);

2475 
WRITE_6
:

2476 
WRITE_10
:

2477 
WRITE_12
:

2478 
WRITE_16
:

2479 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 1, 
cmd
);

2481 
INQUIRY
:

2482 
»tcode
 = 
	`nvme_Œªs_šquœy
(
ns
, 
hdr
, 
cmd
);

2484 
LOG_SENSE
:

2485 
»tcode
 = 
	`nvme_Œªs_log_£n£
(
ns
, 
hdr
, 
cmd
);

2487 
MODE_SELECT
:

2488 
MODE_SELECT_10
:

2489 
»tcode
 = 
	`nvme_Œªs_mode_£Ëù
(
ns
, 
hdr
, 
cmd
);

2491 
MODE_SENSE
:

2492 
MODE_SENSE_10
:

2493 
»tcode
 = 
	`nvme_Œªs_mode_£n£
(
ns
, 
hdr
, 
cmd
);

2495 
READ_CAPACITY
:

2496 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 0);

2498 
SERVICE_ACTION_IN_16
:

2499 
cmd
[1]) {

2500 
SAI_READ_CAPACITY_16
:

2501 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 1);

2504 
out
;

2507 
REPORT_LUNS
:

2508 
»tcode
 = 
	`nvme_Œªs_»pÜt_luns
(
ns
, 
hdr
, 
cmd
);

2510 
REQUEST_SENSE
:

2511 
»tcode
 = 
	`nvme_Œªs_»que¡_£n£
(
ns
, 
hdr
, 
cmd
);

2513 
SECURITY_PROTOCOL_IN
:

2514 
SECURITY_PROTOCOL_OUT
:

2515 
»tcode
 = 
	`nvme_Œªs_£cur™y_´ÙocŞ
(
ns
, 
hdr
, 
cmd
);

2517 
START_STOP
:

2518 
»tcode
 = 
	`nvme_Œªs_¡¬t_¡İ
(
ns
, 
hdr
, 
cmd
);

2520 
SYNCHRONIZE_CACHE
:

2521 
»tcode
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2523 
FORMAT_UNIT
:

2524 
»tcode
 = 
	`nvme_Œªs_fÜm©_un™
(
ns
, 
hdr
, 
cmd
);

2526 
TEST_UNIT_READY
:

2527 
»tcode
 = 
	`nvme_Œªs_‹¡_un™_»ady
(
ns
, 
hdr
, 
cmd
);

2529 
WRITE_BUFFER
:

2530 
»tcode
 = 
	`nvme_Œªs_wr™e_bufãr
(
ns
, 
hdr
, 
cmd
);

2532 
UNMAP
:

2533 
»tcode
 = 
	`nvme_Œªs_unm­
(
ns
, 
hdr
, 
cmd
);

2536 
out
:

2537 
»tcode
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2538 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2539 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2542  
»tcode
;

2543 
	}
}

2545 
	$nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
)

2547 
sg_io_hdr
 
hdr
;

2548 
»tcode
;

2550 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2551  -
EACCES
;

2552 ià(
	`cİy_äom_u£r
(&
hdr
, 
u_hdr
, (hdr)))

2553  -
EFAULT
;

2554 ià(
hdr
.
š‹rçû_id
 != 'S')

2555  -
EINVAL
;

2556 ià(
hdr
.
cmd_Ën
 > 
BLK_MAX_CDB
)

2557  -
EINVAL
;

2563 
»tcode
 = 
	`nvme_scsi_Œª¦©e
(
ns
, &
hdr
);

2564 ià(
»tcode
 < 0)

2565  
»tcode
;

2566 ià(
	`cİy_to_u£r
(
u_hdr
, &
hdr
, (
sg_io_hdr_t
)) > 0)

2567  -
EFAULT
;

2569 
	}
}

2571 
	$nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

)

2573  
	`put_u£r
(
sg_v”siÚ_num
, 

);

2574 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/core.c

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/blk-mq.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/hd»g.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/moduË.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/vm®loc.h
>

25 
	~<lšux/ty³s.h
>

26 
	~<lšux/´.h
>

27 
	~<lšux/±¿û.h
>

28 
	~<lšux/t10-pi.h
>

29 
	~<scsi/sg.h
>

30 
	~<asm/uÇligÃd.h
>

32 
	~"nvme.h
"

33 
	~<lšux/fe.h
>

34 
	~<lšux/fdbË.h
>

35 
	~<lšux/ev’tfd.h
>

36 
	~<lšux/k»f.h
>

37 
	~<lšux/ä“z”.h
>

38 
	~<lšux/wa™.h
>

39 
	~<lšux/kth»ad.h
>

40 
	~<lšux/sk_io_accouÁšg_İs.h
>

41 
	~"lšux_nvme_ioùl.h
"

42 
	~"çbrics.h
"

44 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

46 
	gadmš_timeout
 = 60;

47 
moduË_·¿m
(
admš_timeout
, 
by‹
, 0644);

48 
MODULE_PARM_DESC
(
admš_timeout
, "timeout in seconds for‡dmin commands");

49 
EXPORT_SYMBOL_GPL
(
admš_timeout
);

51 
	gnvme_io_timeout
 = 30;

52 
moduË_·¿m_Çmed
(
io_timeout
, 
nvme_io_timeout
, 
by‹
, 0644);

53 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

54 
EXPORT_SYMBOL_GPL
(
nvme_io_timeout
);

56 
	gshutdown_timeout
 = 5;

57 
moduË_·¿m
(
shutdown_timeout
, 
by‹
, 0644);

58 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

60 
	gnvme_max_»Œ›s
 = 5;

61 
moduË_·¿m_Çmed
(
max_»Œ›s
, 
nvme_max_»Œ›s
, 
ušt
, 0644);

62 
MODULE_PARM_DESC
(
max_»Œ›s
, "max‚umber of„etries‡ command may have");

63 
EXPORT_SYMBOL_GPL
(
nvme_max_»Œ›s
);

65 
	gnvme_ch¬_majÜ
;

66 
moduË_·¿m
(
nvme_ch¬_majÜ
, , 0);

68 
LIST_HEAD
(
nvme_ù¾_li¡
);

69 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

71 
şass
 *
	gnvme_şass
;

79 
kmem_ÿche
 *
	gkaioùx_ÿch•
 = 0;

80 
kmem_ÿche
 *
	gkaiocb_ÿch•
 = 0;

81 
mempoŞ_t
 *
	gkaiocb_mempoŞ
 = 0;

82 
mempoŞ_t
 *
	gkaioùx_mempoŞ
 = 0;

84 
__u32
 
	gaio_cÚ‹xt_id
;

86 
	#AIOCTX_MAX
 1024

	)

87 
	#AIOCB_MAX
 (1024*64)

	)

89 
__u64
 
	gdebug_com¶‘ed
 =0;

90 
	gdebug_out¡ªdšg
 =0;

92 
	snvme_kaioùx


94 
nvme_aioùx
 
	muùx
;

95 
ev’tfd_ùx
 *
	mev’tùx
;

96 
li¡_h—d
 
	mkaiocb_li¡
;

97 
¥šlock_t
 
	mkaioùx_¥šlock
;

98 
k»f
 
	m»f
;

101 
nvme_kaioùx
 **
	gg_kaioùx_tb
 = 
NULL
;

102 
¥šlock_t
 
	gg_kaioùx_tb_¥šlock
;

104 
	saio_u£r_ùx
 {

105 
	mÃÁs
;

106 
	mËn
;

107 
·ge
 ** 
	m·ges
;

108 
sÿ‰”li¡
 *
	msg
;

109 
	md©a
[1];

112 
	snvme_kaiocb


114 
li¡_h—d
 
	maiocb_li¡
;

115 
nvme_aiÛv’t
 
	mev’t
;

116 
nvme_com¶‘iÚ
 
	mcqe
;

117 
	mİcode
;

118 
nvme_commªd
 
	mcmd
;

119 
g’disk
 *
	mdisk
;

120 
sÿ‰”li¡
 
	mm‘a_sg
;

121 
boŞ
 
	mÃed_to_cİy
;

122 
	m¡¬t_time
;

123 
boŞ
 
	mu£_m‘a
;

124 *
	mkv_d©a
;

125 *
	mm‘a
;

126 
aio_u£r_ùx
 *
	mu£r_ùx
;

127 
aio_u£r_ùx
 *
	mk”Ãl_ùx
;

128 
»que¡
 *
	m»q
;

132 
	saio_wÜk”_ùx
{

133 
	mıu
;

134 
¥šlock_t
 
	mkaiocb_¥šlock
;

135 
li¡_h—d
 
	mkaiocb_li¡
;

136 
wa™_queue_h—d_t
 
	maio_wa™queue
;

140 
aio_wÜk”_ùx
 * 
__³rıu
 
	gaio_w_ùx
;

142 
sk_¡ruù
 ** 
__³rıu
 
	gaio_wÜk”
;

146 
	$»move_kaioùx
(
nvme_kaioùx
 * 
ùx
)

148 
nvme_kaiocb
 *
tmpcb
;

149 
li¡_h—d
 *
pos
, *
q
;

150 
æags
;

151 ià(
ùx
) {

152 
	`¥š_lock_œq§ve
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

153 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
ùx
->
kaiocb_li¡
){

154 
tmpcb
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

155 
	`li¡_d–
(
pos
);

156 
	`mempoŞ_ä“
(
tmpcb
, 
kaiocb_mempoŞ
);

158 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaioùx_¥šlock
, 
æags
);

159 
	`ev’tfd_ùx_put
(
ùx
->
ev’tùx
);

160 
	`mempoŞ_ä“
(
ùx
, 
kaioùx_mempoŞ
);

162 
	}
}

164 
	$ş—nup_kaioùx
(
k»f
 *kref) {

165 
nvme_kaioùx
 *
ùx
 = 
	`cÚš”_of
(
k»f
, nvme_kaioùx, 
»f
);

166 
	`»move_kaioùx
(
ùx
);

167 
	}
}

169 
	$»f_kaioùx
(
nvme_kaioùx
 *
ùx
) {

170 
	`k»f_g‘
(&
ùx
->
»f
);

171 
	}
}

173 
	$d”ef_kaioùx
(
nvme_kaioùx
 *
ùx
) {

174 
	`k»f_put
(&
ùx
->
»f
, 
ş—nup_kaioùx
);

175 
	}
}

180 
	$de¡roy_aio_mempoŞ
()

182 
i
 = 0;

183 ià(
g_kaioùx_tb
) {

184 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

185 ià(
g_kaioùx_tb
[
i
]) {

186 
	`»move_kaioùx
(
g_kaioùx_tb
[
i
]);

187 
g_kaioùx_tb
[
i
] = 
NULL
;

190 
	`kä“
(
g_kaioùx_tb
);

191 
g_kaioùx_tb
 = 
NULL
;

193 ià(
kaiocb_mempoŞ
)

194 
	`mempoŞ_de¡roy
(
kaiocb_mempoŞ
);

195 ià(
kaioùx_mempoŞ
)

196 
	`mempoŞ_de¡roy
(
kaioùx_mempoŞ
);

197 ià(
kaioùx_ÿch•
)

198 
	`kmem_ÿche_de¡roy
(
kaioùx_ÿch•
);

199 ià(
kaiocb_ÿch•
)

200 
	`kmem_ÿche_de¡roy
(
kaiocb_ÿch•
);

201 
	}
}

206 
	$aio_£rviû_š™
()

208 
g_kaioùx_tb
 = (
nvme_kaioùx
 **)
	`km®loc
((nvme_kaioùx *è* 
AIOCTX_MAX
, 
GFP_KERNEL
);

209 ià(!
g_kaioùx_tb
)

210 
ç
;

211 
	`mem£t
(
g_kaioùx_tb
, 0, (
nvme_kaioùx
 *è* 
AIOCTX_MAX
);

214 
kaioùx_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaioùx", (
nvme_kaioùx
), 0, 0, 
NULL
);

215 ià(!
kaioùx_ÿch•
)

216 
ç
;

218 
kaiocb_ÿch•
 = 
	`kmem_ÿche_ü—‹
("nvme_kaiocb", (
nvme_kaiocb
), 0, 0, 
NULL
);

219 ià(!
kaiocb_ÿch•
)

220 
ç
;

222 
kaiocb_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCB_MAX
, 
kaiocb_ÿch•
);

223 ià(!
kaiocb_mempoŞ
)

224 
ç
;

226 
kaioùx_mempoŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(
AIOCTX_MAX
, 
kaioùx_ÿch•
);

227 ià(!
kaioùx_mempoŞ
)

228 
ç
;

232 
aio_cÚ‹xt_id
 = 1;

233 
	`¥š_lock_š™
(&
g_kaioùx_tb_¥šlock
);

234 
	`´štk
(
KERN_DEBUG
"nvme-aio: initialized\n");

237 
ç
:

238 
	`de¡roy_aio_mempoŞ
();

239  -
ENOMEM
;

240 
	}
}

245 
	$aio_£rviû_ex™
()

247 
	`de¡roy_aio_mempoŞ
();

248 
	`´štk
(
KERN_DEBUG
"nvme-aio: unloaded\n");

250 
	}
}

252 
nvme_kaioùx
 * 
	$fšd_kaioùx
(
__u32
 
ùxid
) {

253 
nvme_kaioùx
 * 
tmp
 = 
NULL
;

256 
tmp
 = 
g_kaioùx_tb
[
ùxid
];

257 ià(
tmp
è
	`»f_kaioùx
(tmp);

259  
tmp
;

260 
	}
}

266 
	$£t_aioùx_ev’t
(
__u32
 
ùxid
, 
nvme_kaiocb
 * 
kaiocb
)

268 
nvme_kaioùx
 *
tmp
;

269 
æags
;

270 
tmp
 = 
	`fšd_kaioùx
(
ùxid
);

271 ià(
tmp
) {

272 
	`¥š_lock_œq§ve
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

273 
	`li¡_add_
(&
kaiocb
->
aiocb_li¡
, &
tmp
->
kaiocb_li¡
);

274 
	`ev’tfd_sigÇl
(
tmp
->
ev’tùx
, 1);

276 
	`´_”r
("nvme_£t_aioùx: sucûs tØsigÇÈev’ˆ%d %Îu\n", 
kaiocb
->
ev’t
.
ùxid
, kaiocb->ev’t.
»qid
);

278 
	`¥š_uÆock_œq»¡Üe
(&
tmp
->
kaioùx_¥šlock
, 
æags
);

279 
	`d”ef_kaioùx
(
tmp
);

283 
	`´_”r
("nvme_£t_aioùx: faedØsigÇÈev’ˆ%d.\n", 
ùxid
);

288 
	}
}

294 
	$nvme_d–_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

296 
nvme_kaioùx
 
ùx
;

297 
æags
;

298 ià(
	`cİy_äom_u£r
(&
ùx
, 
uùx
, (
nvme_aioùx
)))

299  -
EFAULT
;

301 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

302 ià(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]) {

303 
	`d”ef_kaioùx
(
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
]);

304 
g_kaioùx_tb
[
ùx
.
uùx
.
ùxid
] = 
NULL
;

306 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

308 
	}
}

314 
	$nvme_£t_aioùx
(
nvme_aioùx
 
__u£r
 *
uùx
 )

316 
nvme_kaioùx
 *
ùx
;

317 
fd
 
efe
;

318 
ev’tfd_ùx
 *ev’tfd_ùx = 
NULL
;

319 
æags
;

320 
»t
 = 0;

321 
i
 = 0;

322 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

323  -
EACCES
;

325 
ùx
 = 
	`mempoŞ_®loc
(
kaioùx_mempoŞ
, 
GFP_NOIO
);

326 ià(!
ùx
)

327  -
ENOMEM
;

329 ià(
	`cİy_äom_u£r
(
ùx
, 
uùx
, (
nvme_aioùx
)))

330  -
EFAULT
;

332 
efe
 = 
	`fdg‘
(
ùx
->
uùx
.
ev’tfd
);

333 ià(!
efe
.
fe
) {

334 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒffÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

335 
»t
 = -
EBADF
;

336 
ex™
;

339 
ev’tfd_ùx
 = 
	`ev’tfd_ùx_feg‘
(
efe
.
fe
);

340 ià(
	`IS_ERR
(
ev’tfd_ùx
)) {

341 
	`´_”r
("nvme_£t_aioùx: faedØg‘ƒv’tfd_ùx fÜƒfd %d.\n", 
ùx
->
uùx
.
ev’tfd
);

342 
»t
 = 
	`PTR_ERR
(
ev’tfd_ùx
);

343 
put_efe
;

346 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

347 if(
g_kaioùx_tb
[
aio_cÚ‹xt_id
]) {

348 
i
 = 0; i < 
AIOCTX_MAX
; i++) {

349 if(
g_kaioùx_tb
[
i
] =ğ
NULL
) {

350 
aio_cÚ‹xt_id
 = 
i
;

354 ià(
i
 >ğ
AIOCTX_MAX
) {

355 
	`´_”r
("nvme_set_aioctx:oo many‡ioctx open.\n");

356 
»t
 = -
EMFILE
;

357 
put_ev’t_fd
;

360 
ùx
->
uùx
.
ùxid
 = 
aio_cÚ‹xt_id
++;

361 ià(
aio_cÚ‹xt_id
 =ğ
AIOCTX_MAX
)

362 
aio_cÚ‹xt_id
 = 0;

363 
ùx
->
ev’tùx
 = 
ev’tfd_ùx
;

364 
	`¥š_lock_š™
(&
ùx
->
kaioùx_¥šlock
);

365 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

366 
	`k»f_š™
(&
ùx
->
»f
);

367 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
] = ctx;

368 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

370 ià(
	`cİy_to_u£r
(&
uùx
->
ùxid
, &
ùx
->uctx.ctxid, (ctx->uctx.ctxid)))

372 
	`´_”r
("nvme_£t_aioùx: faedØcİy cÚ‹xˆid %dØu£r.\n", 
ùx
->
uùx
.
ùxid
);

373 
»t
 = -
EINVAL
;

374 
ş—nup
;

376 
ev’tfd_ùx
 = 
NULL
;

377 
debug_out¡ªdšg
 = 0;

378 
debug_com¶‘ed
 = 0;

379 
	`fdput
(
efe
);

381 
ş—nup
:

382 
	`¥š_lock_œq§ve
(&
g_kaioùx_tb_¥šlock
, 
æags
);

383 
g_kaioùx_tb
[
ùx
->
uùx
.
ùxid
 - 1] = 
NULL
;

384 
	`¥š_uÆock_œq»¡Üe
(&
g_kaioùx_tb_¥šlock
, 
æags
);

385 
	`mempoŞ_ä“
(
ùx
, 
kaiocb_mempoŞ
);

386 
put_ev’t_fd
:

387 
	`ev’tfd_ùx_put
(
ev’tfd_ùx
);

388 
put_efe
:

389 
	`fdput
(
efe
);

390 
ex™
:

391  
»t
;

392 
	}
}

396 
nvme_kaiocb
 *
	$g‘_aiocb
(
__u64
 
»qid
) {

397 
nvme_kaiocb
 *
»q
;

398 
»q
 = 
	`mempoŞ_®loc
(
kaiocb_mempoŞ
, 
GFP_NOIO
);

399 ià(!
»q
)  0;

401 
	`mem£t
(
»q
, 0, (*req));

403 
	`INIT_LIST_HEAD
(&
»q
->
aiocb_li¡
);

405 
»q
->
ev’t
.
»qid
 =„eqid;

407  
»q
;

408 
	}
}

412 
	$nvme_g‘_iÛv’ts
(
nvme_aiÛv’ts
 
__u£r
 *
uev’ts
)

414 
li¡_h—d
 *
pos
, *
q
;

415 
nvme_kaiocb
 *
tmp
;

416 
nvme_kaioùx
 *
tmp_ùx
;

417 
æags
;

418 
	`LIST_HEAD
(
tmp_h—d
);

419 
__u16
 
couÁ
 =0;

420 
__u16
 
Ä
 = 0;

421 
__u32
 
ùxid
 = 0;

423 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

424  -
EACCES
;

426 ià(
	`g‘_u£r
(
Ä
, &
uev’ts
->Äè< 0è{  -
EINVAL
; }

428 ià(
Ä
 =ğ0 ||‚¸> 128è -
EINVAL
;

430 ià(
	`g‘_u£r
(
ùxid
, &
uev’ts
->ùxidè< 0è{  -
EINVAL
; }

432 
tmp_ùx
 = 
	`fšd_kaioùx
(
ùxid
);

433 ià(
tmp_ùx
) {

434 
	`¥š_lock_œq§ve
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

435 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_ùx
->
kaiocb_li¡
){

436 
	`li¡_d–_š™
(
pos
);

437 
	`li¡_add
(
pos
, &
tmp_h—d
);

438 
couÁ
++;

439 ià(
Ä
 =ğ
couÁ
) ;

441 
	`¥š_uÆock_œq»¡Üe
(&
tmp_ùx
->
kaioùx_¥šlock
, 
æags
);

442 
	`d”ef_kaioùx
(
tmp_ùx
);

443 
couÁ
 = 0;

444 
	`li¡_fÜ_—ch_§ã
(
pos
, 
q
, &
tmp_h—d
){

445 
	`li¡_d–
(
pos
);

446 
tmp
 = 
	`li¡_’Œy
(
pos
, 
nvme_kaiocb
, 
aiocb_li¡
);

447 
	`cİy_to_u£r
(&
uev’ts
->
ev’ts
[
couÁ
], &
tmp
->
ev’t
, (
nvme_aiÛv’t
));

448 
	`mempoŞ_ä“
(
tmp
, 
kaiocb_mempoŞ
);

449 
couÁ
++;

452 ià(
	`put_u£r
(
couÁ
, &
uev’ts
->
Ä
è< 0è{  -
EINVAL
; }

455 
	}
}

457 
	$kv_com¶‘e_aio_â
(
nvme_kaiocb
 *
cmdšfo
) {

458 
»que¡
 *
»q
 = 
cmdšfo
->req;

459 
i
 = 0;

461 ià(
cmdšfo
->
Ãed_to_cİy
) {

465 ià(
	`is_kv_»Œ›ve_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_™”_»ad_cmd
(cmdinfo->opcode)) {

467 *
d©a
 = 
cmdšfo
->
kv_d©a
;

468 
	`´_”r
("kv_async_com¶‘iÚ: d©¨%c%c%c%c.\n", 
d©a
[0], data[1], data[2], data[3]);

470 ()
	`sg_cİy_äom_bufãr
(
cmdšfo
->
u£r_ùx
->
sg
, cmdšfo->u£r_ùx->
ÃÁs
,

471 
cmdšfo
->
kv_d©a
, cmdšfo->
u£r_ùx
->
Ën
);

473 
i
 = 0; i < 
cmdšfo
->
k”Ãl_ùx
->
ÃÁs
; i++) {

474 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
k”Ãl_ùx
->
sg
[
i
]));

477 ià(
cmdšfo
->
u£r_ùx
) {

478 ià(
	`is_kv_¡Üe_cmd
(
cmdšfo
->
İcode
è|| 
	`is_kv_­³nd_cmd
(cmdinfo->opcode)) {

479 
	`g’”ic_’d_io_acù
(
WRITE
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

481 
	`g’”ic_’d_io_acù
(
READ
, &
cmdšfo
->
disk
->
·¹0
, cmdšfo->
¡¬t_time
);

483 
i
 = 0; i < 
cmdšfo
->
u£r_ùx
->
ÃÁs
; i++) {

484 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
u£r_ùx
->
sg
[
i
]));

487 
	`blk_mq_ä“_»que¡
(
»q
);

489 ià(
cmdšfo
->
u£_m‘a
) {

490 
	`put_·ge
(
	`sg_·ge
(&
cmdšfo
->
m‘a_sg
));

493 ià(
cmdšfo
->
Ãed_to_cİy
) {

494 
	`kä“
(
cmdšfo
->
k”Ãl_ùx
);

495 
	`kä“
(
cmdšfo
->
kv_d©a
);

497 ià(
cmdšfo
->
u£r_ùx
è
	`kä“
(cmdinfo->user_ctx);

498 ià(
cmdšfo
->
m‘a
è
	`kä“
(cmdinfo->meta);

500 ià(
	`£t_aioùx_ev’t
(
cmdšfo
->
ev’t
.
ùxid
, cmdinfo)) {

501 
	`mempoŞ_ä“
(
cmdšfo
, 
kaiocb_mempoŞ
);

503 
	}
}

505 
	$wake_up_aio_wÜk”
(
aio_wÜk”_ùx
 *
aio_ùx
) {

506 
	`wake_up
(&
aio_ùx
->
aio_wa™queue
);

507 
	}
}

509 
	$š£¹_aiocb_to_wÜk”
(
nvme_kaiocb
 *
aiocb
) {

510 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

511 
æags
;

512 
ıu
 = 
	`smp_´oûssÜ_id
();

513 
	`INIT_LIST_HEAD
(&
aiocb
->
aiocb_li¡
);

515 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
ıu
);

516 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

517 
	`li¡_add_
(&
aiocb
->
aiocb_li¡
, &
ùx
->
kaiocb_li¡
);

518 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

519 
	`wake_up_aio_wÜk”
(
ùx
);

521 
	}
}

523 
	$kv_async_com¶‘iÚ
(
»que¡
 *
»q
, 
”rÜ
){

524 
nvme_kaiocb
 *
aiocb
 = 
»q
->
’d_io_d©a
;

525 
nvme_com¶‘iÚ
 *
cqe
 = 
»q
->
¥ecŸl
;

527 
aiocb
->
»q
 =„eq;

528 
aiocb
->
ev’t
.
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

529 
aiocb
->
ev’t
.
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

530 
	`š£¹_aiocb_to_wÜk”
(
aiocb
);

532 
	}
}

534 
	$kvaio_³rıu_wÜk”_â
(*
¬g
) {

535 
aio_wÜk”_ùx
 *
ùx
 = (aio_wÜk”_ùx *)
¬g
;

536 
li¡_h—d
 *
pos
, *
Ãxt
;

537 
æags
;

538 
	`LIST_HEAD
(
tmp_li¡
);

539 
	`´_”r
("¡¬ˆaiØwÜk” %u\n", 
ùx
->
ıu
);

540 !
	`kth»ad_should_¡İ
(è|| !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

541 ià(
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
)) {

542 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
ùx
->
aio_wa™queue
,

543 !
	`li¡_em±y
(&
ùx
->
kaiocb_li¡
), 
HZ
/10);

546 
	`INIT_LIST_HEAD
(&
tmp_li¡
);

547 
	`¥š_lock_œq§ve
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

548 
	`li¡_¥liû
(&
ùx
->
kaiocb_li¡
, &
tmp_li¡
);

549 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

550 
	`¥š_uÆock_œq»¡Üe
(&
ùx
->
kaiocb_¥šlock
, 
æags
);

551 ià(!
	`li¡_em±y
(&
tmp_li¡
)) {

552 
	`li¡_fÜ_—ch_§ã
(
pos
, 
Ãxt
, &
tmp_li¡
) {

553 
nvme_kaiocb
 *
aiocb
 = 
	`li¡_’Œy
(
pos
, nvme_kaiocb, 
aiocb_li¡
);

554 
	`li¡_d–_š™
(
pos
);

555 
	`kv_com¶‘e_aio_â
(
aiocb
);

560 
	}
}

562 
	$aio_wÜk”_š™
() {

563 
sk_¡ruù
 **
p
 = 
NULL
;

564 
aio_wÜk”_ùx
 *
ùx
 = 
NULL
;

565 
i
 = 0;

567 
aio_wÜk”
 = 
	`®loc_³rıu
(
sk_¡ruù
 *);

568 ià(!
aio_wÜk”
) {

569 
	`´_”r
("failo‡lloc…ercpu workerask_struct!\n");

570  -
ENOMEM
;

572 
aio_w_ùx
 = 
	`®loc_³rıu
(
aio_wÜk”_ùx
);

573 ià(!
aio_w_ùx
) {

574 
	`´_”r
("failo‡lloc…ercpu‡io context!\n");

575 
out_ä“
;

578 
	`fÜ_—ch_Úlše_ıu
(
i
) {

579 
ùx
 = 
	`³r_ıu_±r
(
aio_w_ùx
, 
i
);

580 
ùx
->
ıu
 = 
i
;

581 
	`¥š_lock_š™
(&
ùx
->
kaiocb_¥šlock
);

582 
	`INIT_LIST_HEAD
(&
ùx
->
kaiocb_li¡
);

583 
	`š™_wa™queue_h—d
(&
ùx
->
aio_wa™queue
);

584 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

585 *
p
 = 
	`kth»ad_ü—‹_Ú_node
(
kvaio_³rıu_wÜk”_â
, 
ùx
, 
	`ıu_to_node
(
i
), "aio_completion_worker/%u", i);

586 ià(!(*
p
))

587 
»£t_±h»ad
;

588 
	`kth»ad_bšd
(*
p
, 
i
);

589 
	`wake_up_´oûss
(*
p
);

593 
»£t_±h»ad
:

594 
	`fÜ_—ch_Úlše_ıu
(
i
) {

595 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

596 ià(*
p
è
	`kth»ad_¡İ
(*p);

598 
out_ä“
:

599 ià(
aio_wÜk”
)

600 
	`ä“_³rıu
(
aio_wÜk”
);

601  -
ENOMEM
;

602 
	}
}

604 
	$aio_wÜk”_ex™
() {

605 
sk_¡ruù
 **
p
 = 
NULL
;

606 
i
 = 0;

607 
	`fÜ_—ch_Úlše_ıu
(
i
) {

608 
p
 = 
	`³r_ıu_±r
(
aio_wÜk”
, 
i
);

609 ià(*
p
è
	`kth»ad_¡İ
(*p);

611 
	`ä“_³rıu
(
aio_wÜk”
);

612 
	`ä“_³rıu
(
aio_w_ùx
);

614 
	}
}

617 
	$nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
)

619 
¡©us
;

621 ià(!
	`blk_mq_»que¡_¡¬‹d
(
»q
))

624 
	`dev_dbg_¿‹lim™ed
(((
nvme_ù¾
 *è
d©a
)->
deviû
,

625 "CªûÎšg I/O %d", 
»q
->
g
);

627 
¡©us
 = 
NVME_SC_ABORT_REQ
;

628 ià(
	`blk_queue_dyšg
(
»q
->
q
))

629 
¡©us
 |ğ
NVME_SC_DNR
;

630 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
¡©us
);

631 
	}
}

632 
EXPORT_SYMBOL_GPL
(
nvme_ÿnûl_»que¡
);

634 
boŞ
 
	$nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

635 
nvme_ù¾_¡©e
 
Ãw_¡©e
)

637 
nvme_ù¾_¡©e
 
Şd_¡©e
;

638 
boŞ
 
chªged
 = 
çl£
;

640 
	`¥š_lock_œq
(&
ù¾
->
lock
);

642 
Şd_¡©e
 = 
ù¾
->
¡©e
;

643 
Ãw_¡©e
) {

644 
NVME_CTRL_LIVE
:

645 
Şd_¡©e
) {

646 
NVME_CTRL_NEW
:

647 
NVME_CTRL_RESETTING
:

648 
NVME_CTRL_RECONNECTING
:

649 
chªged
 = 
Œue
;

655 
NVME_CTRL_RESETTING
:

656 
Şd_¡©e
) {

657 
NVME_CTRL_NEW
:

658 
NVME_CTRL_LIVE
:

659 
NVME_CTRL_RECONNECTING
:

660 
chªged
 = 
Œue
;

666 
NVME_CTRL_RECONNECTING
:

667 
Şd_¡©e
) {

668 
NVME_CTRL_LIVE
:

669 
chªged
 = 
Œue
;

675 
NVME_CTRL_DELETING
:

676 
Şd_¡©e
) {

677 
NVME_CTRL_LIVE
:

678 
NVME_CTRL_RESETTING
:

679 
NVME_CTRL_RECONNECTING
:

680 
chªged
 = 
Œue
;

686 
NVME_CTRL_DEAD
:

687 
Şd_¡©e
) {

688 
NVME_CTRL_DELETING
:

689 
chªged
 = 
Œue
;

699 ià(
chªged
)

700 
ù¾
->
¡©e
 = 
Ãw_¡©e
;

702 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

704  
chªged
;

705 
	}
}

706 
EXPORT_SYMBOL_GPL
(
nvme_chªge_ù¾_¡©e
);

708 
	$nvme_ä“_ns
(
k»f
 *kref)

710 
nvme_ns
 *
ns
 = 
	`cÚš”_of
(
k»f
, nvme_ns, kref);

712 ià(
ns
->
ndev
)

713 
	`nvme_nvm_uÄegi¡”
(
ns
);

715 ià(
ns
->
disk
) {

716 
	`¥š_lock
(&
dev_li¡_lock
);

717 
ns
->
disk
->
´iv©e_d©a
 = 
NULL
;

718 
	`¥š_uÆock
(&
dev_li¡_lock
);

721 
	`put_disk
(
ns
->
disk
);

722 
	`ida_sim¶e_»move
(&
ns
->
ù¾
->
ns_ida
,‚s->
š¡ªû
);

723 
	`nvme_put_ù¾
(
ns
->
ù¾
);

724 
	`kä“
(
ns
);

725 
	}
}

727 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

729 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

730 
	}
}

732 
nvme_ns
 *
	$nvme_g‘_ns_äom_disk
(
g’disk
 *
disk
)

734 
nvme_ns
 *
ns
;

736 
	`¥š_lock
(&
dev_li¡_lock
);

737 
ns
 = 
disk
->
´iv©e_d©a
;

738 ià(
ns
) {

739 ià(!
	`k»f_g‘_uÆess_z”o
(&
ns
->
k»f
))

740 
ç
;

741 ià(!
	`Œy_moduË_g‘
(
ns
->
ù¾
->
İs
->
moduË
))

742 
ç_put_ns
;

744 
	`¥š_uÆock
(&
dev_li¡_lock
);

746  
ns
;

748 
ç_put_ns
:

749 
	`k»f_put
(&
ns
->
k»f
, 
nvme_ä“_ns
);

750 
ç
:

751 
	`¥š_uÆock
(&
dev_li¡_lock
);

752  
NULL
;

753 
	}
}

755 
	$nvme_»queue_»q
(
»que¡
 *
»q
)

757 
æags
;

759 
	`blk_mq_»queue_»que¡
(
»q
);

760 
	`¥š_lock_œq§ve
(
»q
->
q
->
queue_lock
, 
æags
);

761 ià(!
	`blk_queue_¡İ³d
(
»q
->
q
))

762 
	`blk_mq_kick_»queue_li¡
(
»q
->
q
);

763 
	`¥š_uÆock_œq»¡Üe
(
»q
->
q
->
queue_lock
, 
æags
);

764 
	}
}

765 
EXPORT_SYMBOL_GPL
(
nvme_»queue_»q
);

767 
»que¡
 *
	$nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

768 
nvme_commªd
 *
cmd
, 
æags
, 
qid
)

770 
»que¡
 *
»q
;

772 ià(
qid
 =ğ
NVME_QID_ANY
) {

773 
»q
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
);

775 
»q
 = 
	`blk_mq_®loc_»que¡_hùx
(
q
, 
	`nvme_is_wr™e
(
cmd
), 
æags
,

776 
qid
 ? qid - 1 : 0);

778 ià(
	`IS_ERR
(
»q
))

779  
»q
;

781 
»q
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

782 
»q
->
cmd_æags
 |ğ
REQ_FAILFAST_DRIVER
;

783 
»q
->
cmd
 = (*)cmd;

784 
»q
->
cmd_Ën
 = (
nvme_commªd
);

786  
»q
;

787 
	}
}

788 
EXPORT_SYMBOL_GPL
(
nvme_®loc_»que¡
);

790 
šlše
 
	$nvme_£tup_æush
(
nvme_ns
 *
ns
,

791 
nvme_commªd
 *
cmnd
)

793 
	`mem£t
(
cmnd
, 0, (*cmnd));

794 
cmnd
->
commÚ
.
İcode
 = 
nvme_cmd_æush
;

795 
cmnd
->
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

796 
	}
}

798 
šlše
 
	$nvme_£tup_disÿrd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

799 
nvme_commªd
 *
cmnd
)

801 
nvme_dsm_¿nge
 *
¿nge
;

802 
·ge
 *page;

803 
off£t
;

804 
Ä_by‹s
 = 
	`blk_rq_by‹s
(
»q
);

806 
¿nge
 = 
	`km®loc
((*¿nge), 
GFP_ATOMIC
);

807 ià(!
¿nge
)

808  
BLK_MQ_RQ_QUEUE_BUSY
;

810 
¿nge
->
ÿ‰r
 = 
	`ıu_to_Ë32
(0);

811 
¿nge
->
Æb
 = 
	`ıu_to_Ë32
(
Ä_by‹s
 >> 
ns
->
lba_shiá
);

812 
¿nge
->
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

814 
	`mem£t
(
cmnd
, 0, (*cmnd));

815 
cmnd
->
dsm
.
İcode
 = 
nvme_cmd_dsm
;

816 
cmnd
->
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

817 
cmnd
->
dsm
.
Ä
 = 0;

818 
cmnd
->
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

820 
»q
->
com¶‘iÚ_d©a
 = 
¿nge
;

821 
·ge
 = 
	`vœt_to_·ge
(
¿nge
);

822 
off£t
 = 
	`off£t_š_·ge
(
¿nge
);

823 
	`blk_add_»que¡_·ylßd
(
»q
, 
·ge
, 
off£t
, (*
¿nge
));

830 
»q
->
__d©a_Ën
 = 
Ä_by‹s
;

833 
	}
}

835 
šlše
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

836 
nvme_commªd
 *
cmnd
)

838 
u16
 
cÚŒŞ
 = 0;

839 
u32
 
dsmgmt
 = 0;

841 ià(
»q
->
cmd_æags
 & 
REQ_FUA
)

842 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

843 ià(
»q
->
cmd_æags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

844 
cÚŒŞ
 |ğ
NVME_RW_LR
;

846 ià(
»q
->
cmd_æags
 & 
REQ_RAHEAD
)

847 
dsmgmt
 |ğ
NVME_RW_DSM_FREQ_PREFETCH
;

849 
	`mem£t
(
cmnd
, 0, (*cmnd));

850 
cmnd
->
rw
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

851 
cmnd
->
rw
.
commªd_id
 = 
»q
->
g
;

852 
cmnd
->
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

853 
cmnd
->
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

854 
cmnd
->
rw
.
Ëngth
 = 
	`ıu_to_Ë16
((
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
) - 1);

856 ià(
ns
->
ms
) {

857 
ns
->
pi_ty³
) {

858 
NVME_NS_DPS_PI_TYPE3
:

859 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
;

861 
NVME_NS_DPS_PI_TYPE1
:

862 
NVME_NS_DPS_PI_TYPE2
:

863 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRCHK_GUARD
 |

864 
NVME_RW_PRINFO_PRCHK_REF
;

865 
cmnd
->
rw
.
»áag
 = 
	`ıu_to_Ë32
(

866 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
)));

869 ià(!
	`blk_š‹gr™y_rq
(
»q
))

870 
cÚŒŞ
 |ğ
NVME_RW_PRINFO_PRACT
;

873 
cmnd
->
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

874 
cmnd
->
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(dsmgmt);

875 
	}
}

877 
	$nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

878 
nvme_commªd
 *
cmd
)

880 
»t
 = 0;

882 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

883 
	`memıy
(
cmd
, 
»q
->cmd, (*cmd));

884 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
)

885 
	`nvme_£tup_æush
(
ns
, 
cmd
);

886 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
)

887 
»t
 = 
	`nvme_£tup_disÿrd
(
ns
, 
»q
, 
cmd
);

889 
	`nvme_£tup_rw
(
ns
, 
»q
, 
cmd
);

891  
»t
;

892 
	}
}

893 
EXPORT_SYMBOL_GPL
(
nvme_£tup_cmd
);

899 
	$__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

900 
nvme_com¶‘iÚ
 *
cqe
, *
bufãr
, 
bufæ’
,

901 
timeout
, 
qid
, 
©_h—d
, 
æags
)

903 
»que¡
 *
»q
;

904 
»t
;

906 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 
æags
, 
qid
);

907 ià(
	`IS_ERR
(
»q
))

908  
	`PTR_ERR
(
»q
);

910 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

911 
»q
->
¥ecŸl
 = 
cqe
;

913 ià(
bufãr
 && 
bufæ’
) {

914 
»t
 = 
	`blk_rq_m­_k”n
(
q
, 
»q
, 
bufãr
, 
bufæ’
, 
GFP_KERNEL
);

915 ià(
»t
)

916 
out
;

919 
	`blk_execu‹_rq
(
»q
->
q
, 
NULL
,„eq, 
©_h—d
);

920 
»t
 = 
»q
->
”rÜs
;

921 
out
:

922 
	`blk_mq_ä“_»que¡
(
»q
);

923  
»t
;

924 
	}
}

925 
EXPORT_SYMBOL_GPL
(
__nvme_subm™_sync_cmd
);

927 
	$nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

928 *
bufãr
, 
bufæ’
)

930  
	`__nvme_subm™_sync_cmd
(
q
, 
cmd
, 
NULL
, 
bufãr
, 
bufæ’
, 0,

931 
NVME_QID_ANY
, 0, 0);

932 
	}
}

933 
EXPORT_SYMBOL_GPL
(
nvme_subm™_sync_cmd
);

943 
boŞ
 
	$check_add_fÜ_sšgË_cÚt_phyadd»ss
(
__u£r
 *
add»ss
, 
Ëngth
, 
»que¡_queue
 *
q
)

945 
off£t
 = 0;

946 
couÁ
 = 0;

948 
off£t
 = 
	`off£t_š_·ge
(
add»ss
);

949 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
Ëngth
, 
PAGE_SIZE
);

950 ià((
couÁ
 > 1è|| (()
add»ss
 & 
	`queue_dma_®ignm’t
(
q
))) {

952  
çl£
;

954  
Œue
;

955 
	}
}

957 
	$u£r_addr_Åages
(
off£t
, 
size
)

959 
couÁ
 = 
	`DIV_ROUND_UP
(
off£t
 + 
size
, 
PAGE_SIZE
);

960  
couÁ
;

961 
	}
}

963 
aio_u£r_ùx
 *
	$g‘_aio_u£r_ùx
(
__u£r
 *
addr
, 
Ën
, 
boŞ
 
b_k”Ãl
)

965 
off£t
 = 
	`off£t_š_·ge
(
addr
);

966 
d©®’
 = 
Ën
;

967 
num_·ge
 = 
	`u£r_addr_Åages
(
off£t
,
Ën
);

968 
size
 = 0;

969 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

970 
m­³d_·ges
 = 0;

971 
i
 = 0;

973 
size
 =  (
aio_u£r_ùx
è+ (
__Ë64
 *è* 
num_·ge


974 + (
sÿ‰”li¡
è* 
num_·ge
 -1;

976 
u£r_ùx
 = (
aio_u£r_ùx
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

977 ià(!
u£r_ùx
) {

978  
NULL
;

981 
u£r_ùx
->
ÃÁs
 = 0;

982 
u£r_ùx
->
·ges
 =(
·ge
 **)u£r_ùx->
d©a
;

983 
u£r_ùx
->
sg
 = (
sÿ‰”li¡
 *)(u£r_ùx->
d©a
 + (
__Ë64
 *è* 
num_·ge
);

984 ià(
b_k”Ãl
) {

985 
·ge
 *·gğ
NULL
;

986 *
¤c_d©a
 = 
addr
;

987 
i
 = 0; i < 
num_·ge
; i++) {

988 
·ge
 = 
	`vœt_to_·ge
(
¤c_d©a
);

989 
	`g‘_·ge
(
·ge
);

990 
u£r_ùx
->
·ges
[
i
] = 
·ge
;

991 
¤c_d©a
 +ğ
PAGE_SIZE
;

995 
m­³d_·ges
 = 
	`g‘_u£r_·ges_ç¡
(()
addr
, 
num_·ge
,

996 0, 
u£r_ùx
->
·ges
);

997 ià(
m­³d_·ges
 !ğ
num_·ge
) {

998 
u£r_ùx
->
ÃÁs
 = 
m­³d_·ges
;

999 
ex™
;

1002 
u£r_ùx
->
ÃÁs
 = 
num_·ge
;

1003 
u£r_ùx
->
Ën
 = 
d©®’
;

1004 
	`sg_š™_bË
(
u£r_ùx
->
sg
, 
num_·ge
);

1005 
i
 = 0; i < 
num_·ge
; i++) {

1006 
	`sg_£t_·ge
(&
u£r_ùx
->
sg
[
i
], u£r_ùx->
·ges
[i],

1007 
	`mš_t
(, 
d©®’
, 
PAGE_SIZE
 - 
off£t
),

1008 
off£t
);

1009 
d©®’
 -ğ(
PAGE_SIZE
 - 
off£t
);

1010 
off£t
 = 0;

1012 
	`sg_m¬k_’d
(&
u£r_ùx
->
sg
[
i
 -1]);

1013  
u£r_ùx
;

1014 
ex™
:

1015 ià(
u£r_ùx
) {

1016 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++)

1017 
	`put_·ge
(
u£r_ùx
->
·ges
[
i
]);

1018 
	`kä“
(
u£r_ùx
);

1020  
NULL
;

1021 
	}
}

1022 
	$__nvme_subm™_kv_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1023 
nvme_·s¡hru_kv_cmd
 *
±hr_cmd
,

1024 
__u£r
 *
ubufãr
, 
bufæ’
,

1025 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1026 
u32
 *
»suÉ
, u32 *
¡©us
, 
timeout
, 
boŞ
 
aio
)

1028 
nvme_com¶‘iÚ
 
cqe
;

1029 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1030 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1031 
»que¡
 *
»q
;

1032 
»t
 = 0;

1033 
nvme_kaiocb
 *
aiocb
 = 
NULL
;

1034 
aio_u£r_ùx
 *
u£r_ùx
 = 
NULL
;

1035 
aio_u£r_ùx
 *
k”Ãl_ùx
 = 
NULL
;

1036 
sÿ‰”li¡
* 
m‘a_sg_±r
;

1037 
sÿ‰”li¡
 
m‘a_sg
;

1038 
·ge
* 
p_·ge
 = 
NULL
;

1039 
nvme_io_·¿m
* 
·¿m
 = 
NULL
;

1040 *
kv_d©a
 = 
NULL
;

1041 *
kv_m‘a
 = 
NULL
;

1042 
boŞ
 
Ãed_to_cİy
 = 
çl£
;

1043 
i
 = 0, 
off£t
 = 0;

1044 
Ën
 = 0;

1045 
¡¬t_time
 = 
jiff›s
;

1046 ià(!
disk
)

1047  -
EFAULT
;

1049 ià(
aio
) {

1050 
aiocb
 = 
	`g‘_aiocb
(
±hr_cmd
->
»qid
);

1051 ià(!
aiocb
) {

1052 
»t
 = -
ENOMEM
;

1053 
out_’d
;

1055 
aiocb
->
cmd
 = *cmd;

1056 
aiocb
->
disk
 = disk;

1057 
cmd
 = &
aiocb
->cmd;

1059 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1060 ià(
	`IS_ERR
(
»q
)) {

1061 ià(
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1062  
	`PTR_ERR
(
»q
);

1065 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1066 ià(!
aio
)

1067 
»q
->
¥ecŸl
 = &
cqe
;

1069 
·¿m
 = 
	`nvme_io_·¿m
(
»q
);

1070 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1071 
·¿m
->
kv_d©a_sg_±r
 = 
NULL
;

1072 
·¿m
->
kv_d©a_ÃÁs
 = 0;

1073 
·¿m
->
kv_d©a_Ën
 = 0;

1075 ià(
ubufãr
 && 
bufæ’
) {

1076 ià(()
ubufãr
 & 
	`queue_dma_®ignm’t
(
q
)) {

1077 
Ãed_to_cİy
 = 
Œue
;

1078 
Ën
 = 
	`DIV_ROUND_UP
(
bufæ’
, 
PAGE_SIZE
)*PAGE_SIZE;

1079 
kv_d©a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1080 ià(
kv_d©a
 =ğ
NULL
) {

1081 
»t
 = -
ENOMEM
;

1082 
out_»q_’d
;

1085 
u£r_ùx
 = 
	`g‘_aio_u£r_ùx
(
ubufãr
, 
bufæ’
, 
çl£
);

1086 ià(
Ãed_to_cİy
) {

1087 
k”Ãl_ùx
 = 
	`g‘_aio_u£r_ùx
(
kv_d©a
, 
bufæ’
, 
Œue
);

1088 ià(
k”Ãl_ùx
) {

1089 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1090 ()
	`sg_cİy_to_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1091 
kv_d©a
, 
u£r_ùx
->
Ën
);

1093 
	`´_”r
("copied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

1094 
kv_d©a
[0], kv_data[1], kv_data[2], kv_data[3],

1095 
kv_d©a
[4], kv_data[5], kv_data[6], kv_data[7]);

1101 
k”Ãl_ùx
 = 
u£r_ùx
;

1103 ià(
u£r_ùx
 =ğ
NULL
 || 
k”Ãl_ùx
 == NULL) {

1104 
»t
 = -
ENOMEM
;

1105 
out_unm­
;

1107 
·¿m
->
kv_d©a_sg_±r
 = 
k”Ãl_ùx
->
sg
;

1108 
·¿m
->
kv_d©a_ÃÁs
 = 
k”Ãl_ùx
->
ÃÁs
;

1109 
·¿m
->
kv_d©a_Ën
 = 
k”Ãl_ùx
->
Ën
;

1110 ià(
aio
) {

1111 
aiocb
->
Ãed_to_cİy
 =‚eed_to_copy;

1112 
aiocb
->
kv_d©a
 = kv_data;

1113 
aiocb
->
k”Ãl_ùx
 = kernel_ctx;

1114 
aiocb
->
u£r_ùx
 = user_ctx;

1115 
aiocb
->
¡¬t_time
 = 
jiff›s
;

1117 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1118 
	`g’”ic_¡¬t_io_acù
(
WRITE
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1120 
	`g’”ic_¡¬t_io_acù
(
READ
, (
bufæ’
 >> 9 ? bufæ’ >>9 : 1), &
disk
->
·¹0
);

1124 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1125 ià(
	`check_add_fÜ_sšgË_cÚt_phyadd»ss
(
m‘a_bufãr
, 
m‘a_Ën
, 
q
)) {

1126 
»t
 = 
	`g‘_u£r_·ges_ç¡
(()
m‘a_bufãr
, 1, 0, &
p_·ge
);

1127 ià(
»t
 != 1) {

1128 
»t
 = -
ENOMEM
;

1129 
out_unm­
;

1131 
off£t
 = 
	`off£t_š_·ge
(
m‘a_bufãr
);

1133 
Ën
 = 
	`DIV_ROUND_UP
(
m‘a_Ën
, 256) * 256;

1134 
kv_m‘a
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1135 ià(!
kv_m‘a
) {

1136 
»t
 = -
ENOMEM
;

1137 
out_unm­
;

1139 ià(
	`cİy_äom_u£r
(
kv_m‘a
, 
m‘a_bufãr
, 
m‘a_Ën
)) {

1140 
»t
 = -
EFAULT
;

1141 
out_ä“_m‘a
;

1143 
off£t
 = 
	`off£t_š_·ge
(
kv_m‘a
);

1144 
p_·ge
 = 
	`vœt_to_·ge
(
kv_m‘a
);

1145 
	`g‘_·ge
(
p_·ge
);

1147 ià(
aio
) {

1148 
aiocb
->
u£_m‘a
 = 
Œue
;

1149 
aiocb
->
m‘a
 = 
kv_m‘a
;

1150 
m‘a_sg_±r
 = &
aiocb
->
m‘a_sg
;

1152 
m‘a_sg_±r
 = &
m‘a_sg
;

1154 
	`sg_š™_bË
(
m‘a_sg_±r
, 1);

1155 
	`sg_£t_·ge
(
m‘a_sg_±r
, 
p_·ge
, 
m‘a_Ën
, 
off£t
);

1156 
	`sg_m¬k_’d
(
m‘a_sg_±r
);

1157 
·¿m
->
kv_m‘a_sg_±r
 = 
m‘a_sg_±r
;

1159 
·¿m
->
kv_m‘a_sg_±r
 = 
NULL
;

1162 ià(
aio
) {

1163 
aiocb
->
ev’t
.
ùxid
 = 
±hr_cmd
->ctxid;

1164 
aiocb
->
ev’t
.
»qid
 = 
±hr_cmd
->reqid;

1165 
aiocb
->
İcode
 = 
cmd
->
commÚ
.opcode;

1166 
»q
->
’d_io_d©a
 = 
aiocb
;

1167 
»q
->
¥ecŸl
 = &
aiocb
->
cqe
;

1168 
	`blk_execu‹_rq_nowa™
(
»q
->
q
, 
disk
,„eq, 0, 
kv_async_com¶‘iÚ
);

1171 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1172 
»t
 = 
»q
->
”rÜs
;

1173 ià(
»suÉ
)

1174 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1175 ià(
¡©us
)

1176 *
¡©us
 = 
	`Ë16_to_ıu
(
cqe
.status) >> 1;

1177 ià(
»t
 && !
	`is_kv_™”_»q_cmd
(
cmd
->
commÚ
.
İcode
è&& !
	`is_kv_™”_»ad_cmd
(cmd->common.opcode)) {

1179 
	`´_”r
("__nvme_subm™_u£r_cmd faed!!!!!: opcode(%02x)\n", 
cmd
->
commÚ
.
İcode
);

1183 ià(
Ãed_to_cİy
) {

1184 ià((
	`is_kv_»Œ›ve_cmd
(
cmd
->
commÚ
.
İcode
è&& !
»t
) ||

1185 (
	`is_kv_™”_»ad_cmd
(
cmd
->
commÚ
.
İcode
è&& (!
»t
 || (((
	`Ë16_to_ıu
(
cqe
.
¡©us
) >>1) & 0x00ff) == 0x0093)))) {

1187 *
d©a
 = 
kv_d©a
;

1188 
	`´_”r
("recevied data %c:%c:%c:%c: %c:%c:%c:%c.\n",

1189 
d©a
[0], data[1], data[2], data[3],

1190 
d©a
[4], data[5], data[6], data[7]);

1192 ()
	`sg_cİy_äom_bufãr
(
u£r_ùx
->
sg
, u£r_ùx->
ÃÁs
,

1193 
kv_d©a
, 
u£r_ùx
->
Ën
);

1197 
out_ä“_m‘a
:

1198 ià(
p_·ge
è
	`put_·ge
(p_page);

1199 ià(
kv_m‘a
è
	`kä“
(kv_meta);

1200 
out_unm­
:

1201 ià(
u£r_ùx
) {

1202 
i
 = 0; i < 
u£r_ùx
->
ÃÁs
; i++) {

1203 
	`put_·ge
(
	`sg_·ge
(&
u£r_ùx
->
sg
[
i
]));

1205 
	`kä“
(
u£r_ùx
);

1207 ià(
Ãed_to_cİy
) {

1208 ià(
k”Ãl_ùx
) {

1209 
i
 = 0; i < 
k”Ãl_ùx
->
ÃÁs
; i++) {

1210 
	`put_·ge
(
	`sg_·ge
(&
k”Ãl_ùx
->
sg
[
i
]));

1212 
	`kä“
(
k”Ãl_ùx
);

1214 ià(
kv_d©a
è
	`kä“
(kv_data);

1216 
out_»q_’d
:

1217 ià(
aio
 && 
aiocb
è
	`mempoŞ_ä“
×iocb, 
kaiocb_mempoŞ
);

1218 
	`blk_mq_ä“_»que¡
(
»q
);

1220 ià(
	`is_kv_¡Üe_cmd
(
cmd
->
commÚ
.
İcode
è|| 
	`is_kv_­³nd_cmd
(cmd->common.opcode)) {

1221 
	`g’”ic_’d_io_acù
(
WRITE
, &
disk
->
·¹0
, 
¡¬t_time
);

1223 
	`g’”ic_’d_io_acù
(
READ
, &
disk
->
·¹0
, 
¡¬t_time
);

1225 
out_’d
:

1226  
»t
;

1227 
	}
}

1229 
	$__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1230 
__u£r
 *
ubufãr
, 
bufæ’
,

1231 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

1232 
u32
 *
»suÉ
, 
timeout
)

1234 
boŞ
 
wr™e
 = 
	`nvme_is_wr™e
(
cmd
);

1235 
nvme_com¶‘iÚ
 
cqe
;

1236 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

1237 
g’disk
 *
disk
 = 
ns
 ?‚s->disk : 
NULL
;

1238 
»que¡
 *
»q
;

1239 
bio
 *biØğ
NULL
;

1240 *
m‘a
 = 
NULL
;

1241 
»t
;

1243 
»q
 = 
	`nvme_®loc_»que¡
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

1244 ià(
	`IS_ERR
(
»q
))

1245  
	`PTR_ERR
(
»q
);

1247 
»q
->
timeout
 =imeouˆ?imeouˆ: 
ADMIN_TIMEOUT
;

1248 
»q
->
¥ecŸl
 = &
cqe
;

1250 ià(
ubufãr
 && 
bufæ’
) {

1251 
»t
 = 
	`blk_rq_m­_u£r
(
q
, 
»q
, 
NULL
, 
ubufãr
, 
bufæ’
,

1252 
GFP_KERNEL
);

1253 ià(
»t
)

1254 
out
;

1255 
bio
 = 
»q
->bio;

1257 ià(!
disk
)

1258 
subm™
;

1259 
bio
->
bi_bdev
 = 
	`bdg‘_disk
(
disk
, 0);

1260 ià(!
bio
->
bi_bdev
) {

1261 
»t
 = -
ENODEV
;

1262 
out_unm­
;

1265 ià(
m‘a_bufãr
 && 
m‘a_Ën
) {

1266 
bio_š‹gr™y_·ylßd
 *
b
;

1268 
m‘a
 = 
	`km®loc
(
m‘a_Ën
, 
GFP_KERNEL
);

1269 ià(!
m‘a
) {

1270 
»t
 = -
ENOMEM
;

1271 
out_unm­
;

1274 ià(
wr™e
) {

1275 ià(
	`cİy_äom_u£r
(
m‘a
, 
m‘a_bufãr
,

1276 
m‘a_Ën
)) {

1277 
»t
 = -
EFAULT
;

1278 
out_ä“_m‘a
;

1282 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
GFP_KERNEL
, 1);

1283 ià(
	`IS_ERR
(
b
)) {

1284 
»t
 = 
	`PTR_ERR
(
b
);

1285 
out_ä“_m‘a
;

1288 
b
->
b_™”
.
bi_size
 = 
m‘a_Ën
;

1289 
b
->
b_™”
.
bi_£ùÜ
 = 
m‘a_£ed
;

1291 
»t
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`vœt_to_·ge
(
m‘a
),

1292 
m‘a_Ën
, 
	`off£t_š_·ge
(
m‘a
));

1293 ià(
»t
 !ğ
m‘a_Ën
) {

1294 
»t
 = -
ENOMEM
;

1295 
out_ä“_m‘a
;

1299 
subm™
:

1300 
	`blk_execu‹_rq
(
»q
->
q
, 
disk
,„eq, 0);

1301 
»t
 = 
»q
->
”rÜs
;

1302 ià(
»suÉ
)

1303 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1304 ià(
m‘a
 && !
»t
 && !
wr™e
) {

1305 ià(
	`cİy_to_u£r
(
m‘a_bufãr
, 
m‘a
, 
m‘a_Ën
))

1306 
»t
 = -
EFAULT
;

1308 
out_ä“_m‘a
:

1309 
	`kä“
(
m‘a
);

1310 
out_unm­
:

1311 ià(
bio
) {

1312 ià(
disk
 && 
bio
->
bi_bdev
)

1313 
	`bdput
(
bio
->
bi_bdev
);

1314 
	`blk_rq_unm­_u£r
(
bio
);

1316 
out
:

1317 
	`blk_mq_ä“_»que¡
(
»q
);

1318  
»t
;

1319 
	}
}

1321 
	$nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

1322 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

1323 
timeout
)

1325  
	`__nvme_subm™_u£r_cmd
(
q
, 
cmd
, 
ubufãr
, 
bufæ’
, 
NULL
, 0, 0,

1326 
»suÉ
, 
timeout
);

1327 
	}
}

1329 
	$nvme_k“p_®ive_’d_io
(
»que¡
 *
rq
, 
”rÜ
)

1331 
nvme_ù¾
 *
ù¾
 = 
rq
->
’d_io_d©a
;

1333 
	`blk_mq_ä“_»que¡
(
rq
);

1335 ià(
”rÜ
) {

1336 
	`dev_”r
(
ù¾
->
deviû
,

1337 "çed‚vme_k“p_®ive_’d_iØ”rÜ=%d\n", 
”rÜ
);

1341 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1342 
	}
}

1344 
	$nvme_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1346 
nvme_commªd
 
c
;

1347 
»que¡
 *
rq
;

1349 
	`mem£t
(&
c
, 0, (c));

1350 
c
.
commÚ
.
İcode
 = 
nvme_admš_k“p_®ive
;

1352 
rq
 = 
	`nvme_®loc_»que¡
(
ù¾
->
admš_q
, &
c
, 
BLK_MQ_REQ_RESERVED
,

1353 
NVME_QID_ANY
);

1354 ià(
	`IS_ERR
(
rq
))

1355  
	`PTR_ERR
(
rq
);

1357 
rq
->
timeout
 = 
ù¾
->
k©o
 * 
HZ
;

1358 
rq
->
’d_io_d©a
 = 
ù¾
;

1360 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q, 0, 
nvme_k“p_®ive_’d_io
);

1363 
	}
}

1365 
	$nvme_k“p_®ive_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1367 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

1368 
nvme_ù¾
, 
ka_wÜk
);

1370 ià(
	`nvme_k“p_®ive
(
ù¾
)) {

1372 
	`dev_”r
(
ù¾
->
deviû
, "keep-alive failed\n");

1373 
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

1376 
	}
}

1378 
	$nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1380 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1383 
	`INIT_DELAYED_WORK
(&
ù¾
->
ka_wÜk
, 
nvme_k“p_®ive_wÜk
);

1384 
	`scheduË_d–ayed_wÜk
(&
ù¾
->
ka_wÜk
, cŒl->
k©o
 * 
HZ
);

1385 
	}
}

1386 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_k“p_®ive
);

1388 
	$nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
)

1390 ià(
	`uÆik–y
(
ù¾
->
k©o
 == 0))

1393 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
ka_wÜk
);

1394 
	}
}

1395 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_k“p_®ive
);

1397 
	$nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
)

1399 
nvme_commªd
 
c
 = { };

1400 
”rÜ
;

1403 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1404 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(
NVME_ID_CNS_CTRL
);

1406 *
id
 = 
	`km®loc
((
nvme_id_ù¾
), 
GFP_KERNEL
);

1407 ià(!*
id
)

1408  -
ENOMEM
;

1410 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1411 (
nvme_id_ù¾
));

1412 ià(
”rÜ
)

1413 
	`kä“
(*
id
);

1414  
”rÜ
;

1415 
	}
}

1417 
	$nvme_id’tify_ns_li¡
(
nvme_ù¾
 *
dev
, 
nsid
, 
__Ë32
 *
ns_li¡
)

1419 
nvme_commªd
 
c
 = { };

1421 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
;

1422 
c
.
id’tify
.
ús
 = 
	`ıu_to_Ë32
(
NVME_ID_CNS_NS_ACTIVE_LIST
);

1423 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1424  
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, 
ns_li¡
, 0x1000);

1425 
	}
}

1427 
	$nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

1428 
nvme_id_ns
 **
id
)

1430 
nvme_commªd
 
c
 = { };

1431 
”rÜ
;

1434 
c
.
id’tify
.
İcode
 = 
nvme_admš_id’tify
,

1435 
c
.
id’tify
.
nsid
 = 
	`ıu_to_Ë32
(nsid),

1437 *
id
 = 
	`km®loc
((
nvme_id_ns
), 
GFP_KERNEL
);

1438 ià(!*
id
)

1439  -
ENOMEM
;

1441 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
id
,

1442 (
nvme_id_ns
));

1443 ià(
”rÜ
)

1444 
	`kä“
(*
id
);

1445  
”rÜ
;

1446 
	}
}

1448 
	$nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

1449 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1451 
nvme_commªd
 
c
;

1452 
nvme_com¶‘iÚ
 
cqe
;

1453 
»t
;

1455 
	`mem£t
(&
c
, 0, (c));

1456 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_g‘_ã©u»s
;

1457 
c
.
ã©u»s
.
nsid
 = 
	`ıu_to_Ë32
(nsid);

1458 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1460 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
cqe
, 
bufãr
, 
buæ’
, 0,

1461 
NVME_QID_ANY
, 0, 0);

1462 ià(
»t
 >ğ0 && 
»suÉ
)

1463 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1464  
»t
;

1465 
	}
}

1467 
	$nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

1468 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
)

1470 
nvme_commªd
 
c
;

1471 
nvme_com¶‘iÚ
 
cqe
;

1472 
»t
;

1474 
	`mem£t
(&
c
, 0, (c));

1475 
c
.
ã©u»s
.
İcode
 = 
nvme_admš_£t_ã©u»s
;

1476 
c
.
ã©u»s
.
fid
 = 
	`ıu_to_Ë32
(fid);

1477 
c
.
ã©u»s
.
dwÜd11
 = 
	`ıu_to_Ë32
(dword11);

1479 
»t
 = 
	`__nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, &
cqe
,

1480 
bufãr
, 
buæ’
, 0, 
NVME_QID_ANY
, 0, 0);

1481 ià(
»t
 >ğ0 && 
»suÉ
)

1482 *
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
.result);

1483  
»t
;

1484 
	}
}

1486 
	$nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
)

1488 
nvme_commªd
 
c
 = { };

1489 
”rÜ
;

1491 
c
.
commÚ
.
İcode
 = 
nvme_admš_g‘_log_·ge
,

1492 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(0xFFFFFFFF),

1493 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(

1494 ((((
nvme_sm¬t_log
) / 4) - 1) << 16) |

1495 
NVME_LOG_SMART
),

1497 *
log
 = 
	`km®loc
((
nvme_sm¬t_log
), 
GFP_KERNEL
);

1498 ià(!*
log
)

1499  -
ENOMEM
;

1501 
”rÜ
 = 
	`nvme_subm™_sync_cmd
(
dev
->
admš_q
, &
c
, *
log
,

1502 (
nvme_sm¬t_log
));

1503 ià(
”rÜ
)

1504 
	`kä“
(*
log
);

1505  
”rÜ
;

1506 
	}
}

1508 
	$nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
)

1510 
u32
 
q_couÁ
 = (*
couÁ
 - 1) | ((*count - 1) << 16);

1511 
u32
 
»suÉ
;

1512 
¡©us
, 
Ä_io_queues
;

1514 
¡©us
 = 
	`nvme_£t_ã©u»s
(
ù¾
, 
NVME_FEAT_NUM_QUEUES
, 
q_couÁ
, 
NULL
, 0,

1515 &
»suÉ
);

1516 ià(
¡©us
 < 0)

1517  
¡©us
;

1524 ià(
¡©us
 > 0) {

1525 
	`dev_”r
(
ù¾
->
dev
, "Could‚Ù s‘ queucouÁ (%d)\n", 
¡©us
);

1526 *
couÁ
 = 0;

1528 
Ä_io_queues
 = 
	`mš
(
»suÉ
 & 0xffff,„esult >> 16) + 1;

1529 *
couÁ
 = 
	`mš
(*couÁ, 
Ä_io_queues
);

1533 
	}
}

1534 
EXPORT_SYMBOL_GPL
(
nvme_£t_queue_couÁ
);

1536 
	$nvme_subm™_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1538 
nvme_u£r_io
 
io
;

1539 
nvme_commªd
 
c
;

1540 
Ëngth
, 
m‘a_Ën
;

1541 
__u£r
 *
m‘ad©a
;

1543 ià(
	`cİy_äom_u£r
(&
io
, 
uio
, (io)))

1544  -
EFAULT
;

1545 ià(
io
.
æags
)

1546  -
EINVAL
;

1548 
io
.
İcode
) {

1549 
nvme_cmd_wr™e
:

1550 
nvme_cmd_»ad
:

1551 
nvme_cmd_com·»
:

1554  -
EINVAL
;

1557 
Ëngth
 = (
io
.
nblocks
 + 1è<< 
ns
->
lba_shiá
;

1558 
m‘a_Ën
 = (
io
.
nblocks
 + 1è* 
ns
->
ms
;

1559 
m‘ad©a
 = (
__u£r
 *)(
ušŒ_t
)
io
.metadata;

1561 ià(
ns
->
ext
) {

1562 
Ëngth
 +ğ
m‘a_Ën
;

1563 
m‘a_Ën
 = 0;

1564 } ià(
m‘a_Ën
) {

1565 ià((
io
.
m‘ad©a
 & 3) || !io.metadata)

1566  -
EINVAL
;

1569 
	`mem£t
(&
c
, 0, (c));

1570 
c
.
rw
.
İcode
 = 
io
.opcode;

1571 
c
.
rw
.
æags
 = 
io
.flags;

1572 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1573 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
io
.slba);

1574 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
io
.
nblocks
);

1575 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
io
.control);

1576 
c
.
rw
.
dsmgmt
 = 
	`ıu_to_Ë32
(
io
.dsmgmt);

1577 
c
.
rw
.
»áag
 = 
	`ıu_to_Ë32
(
io
.reftag);

1578 
c
.
rw
.
­±ag
 = 
	`ıu_to_Ë16
(
io
.apptag);

1579 
c
.
rw
.
­pmask
 = 
	`ıu_to_Ë16
(
io
.appmask);

1581  
	`__nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1582 (
__u£r
 *)(
ušŒ_t
)
io
.
addr
, 
Ëngth
,

1583 
m‘ad©a
, 
m‘a_Ën
, 
io
.
¦ba
, 
NULL
, 0);

1584 
	}
}

1586 
	$nvme_u£r_kv_cmd
(
nvme_ù¾
 *
ù¾
,

1587 
nvme_ns
 *
ns
,

1588 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
, 
boŞ
 
aio
)

1590 
nvme_·s¡hru_kv_cmd
 
cmd
;

1591 
nvme_commªd
 
c
;

1592 
timeout
 = 0;

1593 
¡©us
;

1594 
__u£r
 *
m‘ad©a
 = 
NULL
;

1595 
m‘a_Ën
 = 0;

1596 
İtiÚ
 = 0;

1597 
™”_hªdË
 = 0;

1598 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1599  -
EACCES
;

1600 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1601  -
EFAULT
;

1602 ià(
cmd
.
æags
)

1603  -
EINVAL
;

1607 ià(!
	`is_kv_cmd
(
cmd
.
İcode
)) {

1608  -
EINVAL
;

1610 
	`mem£t
(&
c
, 0, (c));

1611 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1612 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1613 #ifdeà
KSID_SUPPORT


1614 
c
.
commÚ
.
nsid
 = 
cmd
.
cdw3
;

1616 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1618 ià(
cmd
.
timeout_ms
)

1619 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1626 
cmd
.
İcode
) {

1627 
nvme_cmd_kv_¡Üe
:

1628 
nvme_cmd_kv_­³nd
:

1629 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1630 
c
.
kv_¡Üe
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1632 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1633 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1634 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1635 
¡©us
 = -
EINVAL
;

1636 
ex™
;

1638 
c
.
kv_¡Üe
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1639 
c
.
kv_¡Üe
.
İtiÚ
 = (option & 0xff);

1641 ià(
cmd
.
d©a_Ëngth
 % 4) {

1642 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2) + 1);

1643 
c
.
kv_¡Üe
.
šv®id_by‹
 = 4 - (
cmd
.
d©a_Ëngth
 % 4);

1645 
c
.
kv_¡Üe
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1647 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1648 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1649 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1651 
	`memıy
(
c
.
kv_¡Üe
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1654 
nvme_cmd_kv_»Œ›ve
:

1655 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1656 
c
.
kv_»Œ›ve
.
off£t
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1658 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1659 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1660 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1661 
¡©us
 = -
EINVAL
;

1662 
ex™
;

1664 
c
.
kv_»Œ›ve
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1665 
c
.
kv_»Œ›ve
.
İtiÚ
 = (option & 0xff);

1666 
c
.
kv_»Œ›ve
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1668 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1669 
m‘ad©a
 = (
__u£r
*)
cmd
.
key_addr
;

1670 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1672 
	`memıy
(
c
.
kv_»Œ›ve
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1675 ià(
aio
 && 
	`off£t_š_·ge
(
cmd
.
d©a_addr
)) {

1677 
¡©us
 = -
EINVAL
;

1678 
ex™
;

1682 
nvme_cmd_kv_d–‘e
:

1683 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1684 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1685 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1686 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1687 
¡©us
 = -
EINVAL
;

1688 
ex™
;

1690 
c
.
kv_d–‘e
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1691 
c
.
kv_d–‘e
.
İtiÚ
 = (option & 0xff);

1692 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1693 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1694 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1696 
	`memıy
(
c
.
kv_d–‘e
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1699 
nvme_cmd_kv_exi¡
:

1700 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1701 ià(
cmd
.
key_Ëngth
 > 
KVCMD_MAX_KEY_SIZE
 ||

1702 
cmd
.
key_Ëngth
 < 
KVCMD_MIN_KEY_SIZE
) {

1703 
cmd
.
»suÉ
 = 
KVS_ERR_VALUE
;

1704 
¡©us
 = -
EINVAL
;

1705 
ex™
;

1707 
c
.
kv_exi¡
.
key_Ën
 = 
	`ıu_to_Ë32
(
cmd
.
key_Ëngth
 -1);

1708 
c
.
kv_exi¡
.
İtiÚ
 = (option & 0xff);

1709 ià(
cmd
.
key_Ëngth
 > 
KVCMD_INLINE_KEY_MAX
) {

1710 
m‘ad©a
 = (
__u£r
 *)
cmd
.
key_addr
;

1711 
m‘a_Ën
 = 
cmd
.
key_Ëngth
;

1713 
	`memıy
(
c
.
kv_exi¡
.
key
, 
cmd
.key, cmd.
key_Ëngth
);

1717 
nvme_cmd_kv_™”_»q
:

1718 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1719 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1720 
c
.
kv_™”_»q
.
™”_hªdË
 = iter_handle & 0xff;

1721 
c
.
kv_™”_»q
.
İtiÚ
 = option & 0xff;

1722 
c
.
kv_™”_»q
.
™”_v®
 = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1723 
c
.
kv_™”_»q
.
™”_b™mask
 = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1725 
nvme_cmd_kv_™”_»ad
:

1726 
İtiÚ
 = 
	`ıu_to_Ë32
(
cmd
.
cdw4
);

1727 
™”_hªdË
 = 
	`ıu_to_Ë32
(
cmd
.
cdw5
);

1728 
c
.
kv_™”_»ad
.
™”_hªdË
 = iter_handle & 0xff;

1729 
c
.
kv_™”_»ad
.
İtiÚ
 = option & 0xff;

1730 
c
.
kv_™”_»ad
.
v®ue_Ën
 = 
	`ıu_to_Ë32
((
cmd
.
d©a_Ëngth
 >> 2));

1733 
cmd
.
»suÉ
 = 
KVS_ERR_IO
;

1734 
¡©us
 = -
EINVAL
;

1735 
ex™
;

1744 
¡©us
 = 
	`__nvme_subm™_kv_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
, &
cmd
,

1745 (
__u£r
 *)(
ušŒ_t
)
cmd
.
d©a_addr
, cmd.
d©a_Ëngth
, 
m‘ad©a
, 
m‘a_Ën
, 0,

1746 &
cmd
.
»suÉ
, &cmd.
¡©us
, 
timeout
, 
aio
);

1747 
ex™
:

1748 ià(!
aio
) {

1749 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1750  -
EFAULT
;

1751 ià(
	`put_u£r
(
cmd
.
¡©us
, &
ucmd
->status))

1752  -
EFAULT
;

1754  
¡©us
;

1756 
	}
}

1758 
	$nvme_u£r_kv_aio_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1759 
nvme_·s¡hru_kv_cmd
 
__u£r
 *
ucmd
)

1761  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, 
ucmd
, 
Œue
);

1762 
	}
}

1765 
	$nvme_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
nvme_ns
 *
ns
,

1766 
nvme_·s¡hru_cmd
 
__u£r
 *
ucmd
)

1768 
nvme_·s¡hru_cmd
 
cmd
;

1769 
nvme_commªd
 
c
;

1770 
timeout
 = 0;

1771 
¡©us
;

1772 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1773  -
EACCES
;

1774 ià(
	`cİy_äom_u£r
(&
cmd
, 
ucmd
, (cmd)))

1775  -
EFAULT
;

1776 ià(
cmd
.
æags
)

1777  -
EINVAL
;

1778 ià(
	`is_kv_cmd
(
cmd
.
İcode
))

1779  
	`nvme_u£r_kv_cmd
(
ù¾
, 
ns
, (
nvme_·s¡hru_kv_cmd
 
__u£r
 *)
ucmd
, 
çl£
);

1781 
	`mem£t
(&
c
, 0, (c));

1782 
c
.
commÚ
.
İcode
 = 
cmd
.opcode;

1783 
c
.
commÚ
.
æags
 = 
cmd
.flags;

1784 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
cmd
.nsid);

1785 
c
.
commÚ
.
cdw2
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw2);

1786 
c
.
commÚ
.
cdw2
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw3
);

1787 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
cmd
.cdw10);

1788 
c
.
commÚ
.
cdw10
[1] = 
	`ıu_to_Ë32
(
cmd
.
cdw11
);

1789 
c
.
commÚ
.
cdw10
[2] = 
	`ıu_to_Ë32
(
cmd
.
cdw12
);

1790 
c
.
commÚ
.
cdw10
[3] = 
	`ıu_to_Ë32
(
cmd
.
cdw13
);

1791 
c
.
commÚ
.
cdw10
[4] = 
	`ıu_to_Ë32
(
cmd
.
cdw14
);

1792 
c
.
commÚ
.
cdw10
[5] = 
	`ıu_to_Ë32
(
cmd
.
cdw15
);

1794 ià(
cmd
.
timeout_ms
)

1795 
timeout
 = 
	`m£cs_to_jiff›s
(
cmd
.
timeout_ms
);

1797 
¡©us
 = 
	`nvme_subm™_u£r_cmd
(
ns
 ?‚s->
queue
 : 
ù¾
->
admš_q
, &
c
,

1798 (
__u£r
 *)(
ušŒ_t
)
cmd
.
addr
, cmd.
d©a_Ën
,

1799 &
cmd
.
»suÉ
, 
timeout
);

1800 ià(
¡©us
 >= 0) {

1801 ià(
	`put_u£r
(
cmd
.
»suÉ
, &
ucmd
->result))

1802  -
EFAULT
;

1805  
¡©us
;

1806 
	}
}

1808 
	$nvme_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1809 
cmd
, 
¬g
)

1811 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

1812 
cmd
) {

1813 
NVME_IOCTL_ID
:

1814 
	`fÜû_sucûssful_sysÿÎ_»tuº
();

1815  
ns
->
ns_id
;

1816 
NVME_IOCTL_ADMIN_CMD
:

1817  
	`nvme_u£r_cmd
(
ns
->
ù¾
, 
NULL
, (
__u£r
 *)
¬g
);

1818 
NVME_IOCTL_IO_CMD
:

1819  
	`nvme_u£r_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1820 
NVME_IOCTL_SUBMIT_IO
:

1821  
	`nvme_subm™_io
(
ns
, (
__u£r
 *)
¬g
);

1822 #ifdeà
CONFIG_BLK_DEV_NVME_SCSI


1823 
SG_GET_VERSION_NUM
:

1824  
	`nvme_sg_g‘_v”siÚ_num
((
__u£r
 *)
¬g
);

1825 
SG_IO
:

1826  
	`nvme_sg_io
(
ns
, (
__u£r
 *)
¬g
);

1828 
NVME_IOCTL_IO_KV_CMD
:

1829  
	`nvme_u£r_kv_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
, 
çl£
);

1830 
NVME_IOCTL_AIO_CMD
:

1831  
	`nvme_u£r_kv_aio_cmd
(
ns
->
ù¾
,‚s, (
__u£r
 *)
¬g
);

1832 
NVME_IOCTL_SET_AIOCTX
:

1833  
	`nvme_£t_aioùx
((
__u£r
*)
¬g
);

1834 
NVME_IOCTL_DEL_AIOCTX
:

1835  
	`nvme_d–_aioùx
((
__u£r
*)
¬g
);

1836 
NVME_IOCTL_GET_AIOEVENT
:

1837  
	`nvme_g‘_iÛv’ts
((
__u£r
*)
¬g
);

1839  -
ENOTTY
;

1841 
	}
}

1843 #ifdeà
CONFIG_COMPAT


1844 
	$nvme_com·t_ioùl
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
,

1845 
cmd
, 
¬g
)

1847 
cmd
) {

1848 
SG_IO
:

1849  -
ENOIOCTLCMD
;

1851  
	`nvme_ioùl
(
bdev
, 
mode
, 
cmd
, 
¬g
);

1852 
	}
}

1854 
	#nvme_com·t_ioùl
 
NULL


	)

1857 
	$nvme_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

1859  
	`nvme_g‘_ns_äom_disk
(
bdev
->
bd_disk
è? 0 : -
ENXIO
;

1860 
	}
}

1862 
	$nvme_»Ëa£
(
g’disk
 *
disk
, 
fmode_t
 
mode
)

1864 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1866 
	`moduË_put
(
ns
->
ù¾
->
İs
->
moduË
);

1867 
	`nvme_put_ns
(
ns
);

1868 
	}
}

1870 
	$nvme_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

1873 
geo
->
h—ds
 = 1 << 6;

1874 
geo
->
£ùÜs
 = 1 << 5;

1875 
geo
->
cylšd”s
 = 
	`g‘_ÿ·c™y
(
bdev
->
bd_disk
) >> 11;

1877 
	}
}

1879 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


1880 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1882 
blk_š‹gr™y
 
š‹gr™y
;

1884 
	`mem£t
(&
š‹gr™y
, 0, (integrity));

1885 
ns
->
pi_ty³
) {

1886 
NVME_NS_DPS_PI_TYPE3
:

1887 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³3_üc
;

1888 
š‹gr™y
.
g_size
 = (
u16
è+ (
u32
);

1889 
š‹gr™y
.
æags
 |ğ
BLK_INTEGRITY_DEVICE_CAPABLE
;

1891 
NVME_NS_DPS_PI_TYPE1
:

1892 
NVME_NS_DPS_PI_TYPE2
:

1893 
š‹gr™y
.
´ofe
 = &
t10_pi_ty³1_üc
;

1894 
š‹gr™y
.
g_size
 = (
u16
);

1895 
š‹gr™y
.
æags
 |ğ
BLK_INTEGRITY_DEVICE_CAPABLE
;

1898 
š‹gr™y
.
´ofe
 = 
NULL
;

1901 
š‹gr™y
.
tu¶e_size
 = 
ns
->
ms
;

1902 
	`blk_š‹gr™y_»gi¡”
(
ns
->
disk
, &
š‹gr™y
);

1903 
	`blk_queue_max_š‹gr™y_£gm’ts
(
ns
->
queue
, 1);

1904 
	}
}

1906 
	$nvme_š™_š‹gr™y
(
nvme_ns
 *
ns
)

1908 
	}
}

1911 
	$nvme_cÚfig_disÿrd
(
nvme_ns
 *
ns
)

1913 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

1914 
u32
 
logiÿl_block_size
 = 
	`queue_logiÿl_block_size
(
ns
->
queue
);

1916 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DISCARD_ZEROES
)

1917 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 1;

1919 
ns
->
queue
->
lim™s
.
disÿrd_z”Ûs_d©a
 = 0;

1921 
ns
->
queue
->
lim™s
.
disÿrd_®ignm’t
 = 
logiÿl_block_size
;

1922 
ns
->
queue
->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
logiÿl_block_size
;

1923 
	`blk_queue_max_disÿrd_£ùÜs
(
ns
->
queue
, 
UINT_MAX
);

1924 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, 
ns
->
queue
);

1925 
	}
}

1927 
	$nvme_»v®id©e_ns
(
nvme_ns
 *
ns
, 
nvme_id_ns
 **
id
)

1929 ià(
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, 
id
)) {

1930 
	`dev_w¬n
(
ns
->
ù¾
->
dev
, "%s: Id’tify fau»\n", 
__func__
);

1931  -
ENODEV
;

1934 ià((*
id
)->
nÿp
 == 0) {

1935 
	`kä“
(*
id
);

1936  -
ENODEV
;

1939 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

1940 
	`memıy
(
ns
->
eui
, (*
id
)->
eui64
, (ns->eui));

1941 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 0))

1942 
	`memıy
(
ns
->
uuid
, (*
id
)->
nguid
, (ns->uuid));

1945 
	}
}

1947 
	$__nvme_»v®id©e_disk
(
g’disk
 *
disk
, 
nvme_id_ns
 *
id
)

1949 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1950 
u8
 
lbaf
, 
pi_ty³
;

1951 
u16
 
Şd_ms
;

1952 
bs
;

1954 
Şd_ms
 = 
ns
->
ms
;

1955 
lbaf
 = 
id
->
æbas
 & 
NVME_NS_FLBAS_LBA_MASK
;

1956 
ns
->
lba_shiá
 = 
id
->
lbaf
[lbaf].
ds
;

1957 
ns
->
ms
 = 
	`Ë16_to_ıu
(
id
->
lbaf
[lbaf].ms);

1958 
ns
->
ext
 =‚s->
ms
 && (
id
->
æbas
 & 
NVME_NS_FLBAS_META_EXT
);

1963 ià(
ns
->
lba_shiá
 == 0)

1964 
ns
->
lba_shiá
 = 9;

1965 
bs
 = 1 << 
ns
->
lba_shiá
;

1967 
pi_ty³
 = 
ns
->
ms
 =ğ(
t10_pi_tu¶e
) ?

1968 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
 : 0;

1970 
	`blk_mq_ä“ze_queue
(
disk
->
queue
);

1971 ià(
	`blk_g‘_š‹gr™y
(
disk
è&& (
ns
->
pi_ty³
 !=…i_type ||

1972 
ns
->
ms
 !ğ
Şd_ms
 ||

1973 
bs
 !ğ
	`queue_logiÿl_block_size
(
disk
->
queue
) ||

1974 (
ns
->
ms
 &&‚s->
ext
)))

1975 
	`blk_š‹gr™y_uÄegi¡”
(
disk
);

1977 
ns
->
pi_ty³
 =…i_type;

1978 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 
bs
);

1980 ià(
ns
->
ms
 && !
	`blk_g‘_š‹gr™y
(
disk
è&& !ns->
ext
)

1981 
	`nvme_š™_š‹gr™y
(
ns
);

1982 ià(
ns
->
ms
 && !Òs->m =ğ8 &&‚s->
pi_ty³
è&& !
	`blk_g‘_š‹gr™y
(
disk
))

1983 
	`£t_ÿ·c™y
(
disk
, 0);

1985 
	`£t_ÿ·c™y
(
disk
, 
	`Ë64_to_ıup
(&
id
->
nsze
è<< (
ns
->
lba_shiá
 - 9));

1987 ià(
ns
->
ù¾
->
Úcs
 & 
NVME_CTRL_ONCS_DSM
)

1988 
	`nvme_cÚfig_disÿrd
(
ns
);

1989 
	`blk_mq_unä“ze_queue
(
disk
->
queue
);

1990 
	}
}

1992 
	$nvme_»v®id©e_disk
(
g’disk
 *
disk
)

1994 
nvme_ns
 *
ns
 = 
disk
->
´iv©e_d©a
;

1995 
nvme_id_ns
 *
id
 = 
NULL
;

1996 
»t
;

1998 ià(
	`‹¡_b™
(
NVME_NS_DEAD
, &
ns
->
æags
)) {

1999 
	`£t_ÿ·c™y
(
disk
, 0);

2000  -
ENODEV
;

2003 
»t
 = 
	`nvme_»v®id©e_ns
(
ns
, &
id
);

2004 ià(
»t
)

2005  
»t
;

2007 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

2008 
	`kä“
(
id
);

2011 
	}
}

2013 
	$nvme_´_ty³
(
´_ty³
 
ty³
)

2015 
ty³
) {

2016 
PR_WRITE_EXCLUSIVE
:

2018 
PR_EXCLUSIVE_ACCESS
:

2020 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

2022 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

2024 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

2026 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

2031 
	}
};

2033 
	$nvme_´_commªd
(
block_deviû
 *
bdev
, 
u32
 
cdw10
,

2034 
u64
 
key
, u64 
§_key
, 
u8
 
İ
)

2036 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

2037 
nvme_commªd
 
c
;

2038 
u8
 
d©a
[16] = { 0, };

2040 
	`put_uÇligÃd_Ë64
(
key
, &
d©a
[0]);

2041 
	`put_uÇligÃd_Ë64
(
§_key
, &
d©a
[8]);

2043 
	`mem£t
(&
c
, 0, (c));

2044 
c
.
commÚ
.
İcode
 = 
İ
;

2045 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2046 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(cdw10);

2048  
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

2049 
	}
}

2051 
	$nvme_´_»gi¡”
(
block_deviû
 *
bdev
, 
u64
 
Şd
,

2052 
u64
 
Ãw
, 
æags
)

2054 
u32
 
cdw10
;

2056 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2057  -
EOPNOTSUPP
;

2059 
cdw10
 = 
Şd
 ? 2 : 0;

2060 
cdw10
 |ğ(
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

2061 
cdw10
 |= (1 << 30) | (1 << 31);

2062  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_»gi¡”
);

2063 
	}
}

2065 
	$nvme_´_»£rve
(
block_deviû
 *
bdev
, 
u64
 
key
,

2066 
´_ty³
 
ty³
, 
æags
)

2068 
u32
 
cdw10
;

2070 ià(
æags
 & ~
PR_FL_IGNORE_KEY
)

2071  -
EOPNOTSUPP
;

2073 
cdw10
 = 
	`nvme_´_ty³
(
ty³
) << 8;

2074 
cdw10
 |ğ((
æags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

2075  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_acquœe
);

2076 
	}
}

2078 
	$nvme_´_´“m±
(
block_deviû
 *
bdev
, 
u64
 
Şd
, u64 
Ãw
,

2079 
´_ty³
 
ty³
, 
boŞ
 
abÜt
)

2081 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
abÜt
 ? 2 : 1;

2082  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
Şd
, 
Ãw
, 
nvme_cmd_»sv_acquœe
);

2083 
	}
}

2085 
	$nvme_´_ş—r
(
block_deviû
 *
bdev
, 
u64
 
key
)

2087 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

2088  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»gi¡”
);

2089 
	}
}

2091 
	$nvme_´_»Ëa£
(
block_deviû
 *
bdev
, 
u64
 
key
, 
´_ty³
 
ty³
)

2093 
u32
 
cdw10
 = 
	`nvme_´_ty³
(
ty³
è<< 8 | 
key
 ? 1 << 3 : 0;

2094  
	`nvme_´_commªd
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_»sv_»Ëa£
);

2095 
	}
}

2097 cÚ¡ 
´_İs
 
	gnvme_´_İs
 = {

2098 .
´_»gi¡”
 = 
nvme_´_»gi¡”
,

2099 .
	g´_»£rve
 = 
nvme_´_»£rve
,

2100 .
	g´_»Ëa£
 = 
nvme_´_»Ëa£
,

2101 .
	g´_´“m±
 = 
nvme_´_´“m±
,

2102 .
	g´_ş—r
 = 
nvme_´_ş—r
,

2105 cÚ¡ 
block_deviû_İ”©iÚs
 
	gnvme_fİs
 = {

2106 .
owÃr
 = 
THIS_MODULE
,

2107 .
	gioùl
 = 
nvme_ioùl
,

2108 .
	gcom·t_ioùl
 = 
nvme_com·t_ioùl
,

2109 .
	gİ’
 = 
nvme_İ’
,

2110 .
	g»Ëa£
 = 
nvme_»Ëa£
,

2111 .
	gg‘geo
 = 
nvme_g‘geo
,

2112 .
	g»v®id©e_disk
ğ
nvme_»v®id©e_disk
,

2113 .
	g´_İs
 = &
nvme_´_İs
,

2116 
	$nvme_wa™_»ady
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
, 
boŞ
 
’abËd
)

2118 
timeout
 =

2119 ((
	`NVME_CAP_TIMEOUT
(
ÿp
è+ 1è* 
HZ
 / 2è+ 
jiff›s
;

2120 
u32
 
c¡s
, 
b™
 = 
’abËd
 ? 
NVME_CSTS_RDY
 : 0;

2121 
»t
;

2123 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2124 ià(
c¡s
 == ~0)

2125  -
ENODEV
;

2126 ià((
c¡s
 & 
NVME_CSTS_RDY
è=ğ
b™
)

2129 
	`m¦“p
(100);

2130 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2131  -
EINTR
;

2132 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2133 
	`dev_”r
(
ù¾
->
deviû
,

2134 "Deviû‚Ù„—dy;‡bÜtšg %s\n", 
’abËd
 ?

2136  -
ENODEV
;

2140  
»t
;

2141 
	}
}

2149 
	$nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2151 
»t
;

2153 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2154 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_ENABLE
;

2156 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2157 ià(
»t
)

2158  
»t
;

2160 ià(
ù¾
->
quœks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

2161 
	`m¦“p
(
NVME_QUIRK_DELAY_AMOUNT
);

2163  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
çl£
);

2164 
	}
}

2165 
EXPORT_SYMBOL_GPL
(
nvme_di§bË_ù¾
);

2167 
	$nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
)

2174 
dev_·ge_mš
 = 
	`NVME_CAP_MPSMIN
(
ÿp
è+ 12, 
·ge_shiá
 = 12;

2175 
»t
;

2177 ià(
·ge_shiá
 < 
dev_·ge_mš
) {

2178 
	`dev_”r
(
ù¾
->
deviû
,

2180 1 << 
dev_·ge_mš
, 1 << 
·ge_shiá
);

2181  -
ENODEV
;

2184 
ù¾
->
·ge_size
 = 1 << 
·ge_shiá
;

2186 
ù¾
->
ù¾_cÚfig
 = 
NVME_CC_CSS_NVM
;

2187 
ù¾
->
ù¾_cÚfig
 |ğ(
·ge_shiá
 - 12è<< 
NVME_CC_MPS_SHIFT
;

2188 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ARB_RR
 | 
NVME_CC_SHN_NONE
;

2189 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

2190 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_ENABLE
;

2192 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2193 ià(
»t
)

2194  
»t
;

2195  
	`nvme_wa™_»ady
(
ù¾
, 
ÿp
, 
Œue
);

2196 
	}
}

2197 
EXPORT_SYMBOL_GPL
(
nvme_’abË_ù¾
);

2199 
	$nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
)

2201 
timeout
 = 
SHUTDOWN_TIMEOUT
 + 
jiff›s
;

2202 
u32
 
c¡s
;

2203 
»t
;

2205 
ù¾
->
ù¾_cÚfig
 &ğ~
NVME_CC_SHN_MASK
;

2206 
ù¾
->
ù¾_cÚfig
 |ğ
NVME_CC_SHN_NORMAL
;

2208 
»t
 = 
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_CC
, cŒl->
ù¾_cÚfig
);

2209 ià(
»t
)

2210  
»t
;

2212 (
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
c¡s
)) == 0) {

2213 ià((
c¡s
 & 
NVME_CSTS_SHST_MASK
è=ğ
NVME_CSTS_SHST_CMPLT
)

2216 
	`m¦“p
(100);

2217 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

2218  -
EINTR
;

2219 ià(
	`time_aá”
(
jiff›s
, 
timeout
)) {

2220 
	`dev_”r
(
ù¾
->
deviû
,

2222  -
ENODEV
;

2226  
»t
;

2227 
	}
}

2228 
EXPORT_SYMBOL_GPL
(
nvme_shutdown_ù¾
);

2230 
	$nvme_£t_queue_lim™s
(
nvme_ù¾
 *
ù¾
,

2231 
»que¡_queue
 *
q
)

2233 
boŞ
 
vwc
 = 
çl£
;

2235 ià(
ù¾
->
max_hw_£ùÜs
) {

2236 
u32
 
max_£gm’ts
 =

2237 (
ù¾
->
max_hw_£ùÜs
 / (ù¾->
·ge_size
 >> 9)) + 1;

2239 
	`blk_queue_max_hw_£ùÜs
(
q
, 
ù¾
->
max_hw_£ùÜs
);

2240 
	`blk_queue_max_£gm’ts
(
q
, 
	`mš_t
(
u32
, 
max_£gm’ts
, 
USHRT_MAX
));

2242 ià(
ù¾
->
¡re_size
)

2243 
	`blk_queue_chunk_£ùÜs
(
q
, 
ù¾
->
¡re_size
 >> 9);

2244 
	`blk_queue_vœt_bound¬y
(
q
, 
ù¾
->
·ge_size
 - 1);

2245 ià(
ù¾
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2246 
vwc
 = 
Œue
;

2247 
	`blk_queue_wr™e_ÿche
(
q
, 
vwc
, vwc);

2248 
	}
}

2255 
	$nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
)

2257 
nvme_id_ù¾
 *
id
;

2258 
u64
 
ÿp
;

2259 
»t
, 
·ge_shiá
;

2260 
u32
 
max_hw_£ùÜs
;

2262 
»t
 = 
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_VS
, &ù¾->
vs
);

2263 ià(
»t
) {

2264 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg VS faed (%d)\n", 
»t
);

2265  
»t
;

2268 
»t
 = 
ù¾
->
İs
->
	`»g_»ad64
(ù¾, 
NVME_REG_CAP
, &
ÿp
);

2269 ià(
»t
) {

2270 
	`dev_”r
(
ù¾
->
deviû
, "R—dšg CAP faed (%d)\n", 
»t
);

2271  
»t
;

2273 
·ge_shiá
 = 
	`NVME_CAP_MPSMIN
(
ÿp
) + 12;

2275 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0))

2276 
ù¾
->
subsy¡em
 = 
	`NVME_CAP_NSSRC
(
ÿp
);

2278 
»t
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id
);

2279 ià(
»t
) {

2280 
	`dev_”r
(
ù¾
->
deviû
, "Id’tify CÚŒŞË¸çed (%d)\n", 
»t
);

2281  -
EIO
;

2284 
ù¾
->
vid
 = 
	`Ë16_to_ıu
(
id
->vid);

2285 
ù¾
->
Úcs
 = 
	`Ë16_to_ıup
(&
id
->oncs);

2286 
	`©omic_£t
(&
ù¾
->
abÜt_lim™
, 
id
->
aş
 + 1);

2287 
ù¾
->
vwc
 = 
id
->vwc;

2288 
ù¾
->
úid
 = 
	`Ë16_to_ıup
(&
id
->cntlid);

2289 
	`memıy
(
ù¾
->
£rŸl
, 
id
->
¢
, (id->sn));

2290 
	`memıy
(
ù¾
->
mod–
, 
id
->
mn
, (id->mn));

2291 
	`memıy
(
ù¾
->
fœmw¬e_»v
, 
id
->
ä
, (id->fr));

2292 ià(
id
->
mdts
)

2293 
max_hw_£ùÜs
 = 1 << (
id
->
mdts
 + 
·ge_shiá
 - 9);

2295 
max_hw_£ùÜs
 = 
UINT_MAX
;

2296 
ù¾
->
max_hw_£ùÜs
 =

2297 
	`mš_nÙ_z”o
(
ù¾
->
max_hw_£ùÜs
, max_hw_sectors);

2299 ià((
ù¾
->
quœks
 & 
NVME_QUIRK_STRIPE_SIZE
è&& 
id
->
vs
[3]) {

2300 
max_hw_£ùÜs
;

2302 
ù¾
->
¡re_size
 = 1 << (
id
->
vs
[3] + 
·ge_shiá
);

2303 
max_hw_£ùÜs
 = 
ù¾
->
¡re_size
 >> (
·ge_shiá
 - 9);

2304 ià(
ù¾
->
max_hw_£ùÜs
) {

2305 
ù¾
->
max_hw_£ùÜs
 = 
	`mš
(max_hw_sectors,

2306 
ù¾
->
max_hw_£ùÜs
);

2308 
ù¾
->
max_hw_£ùÜs
 = max_hw_sectors;

2312 
	`nvme_£t_queue_lim™s
(
ù¾
, cŒl->
admš_q
);

2313 
ù¾
->
sgls
 = 
	`Ë32_to_ıu
(
id
->sgls);

2314 
ù¾
->
kas
 = 
	`Ë16_to_ıu
(
id
->kas);

2316 ià(
ù¾
->
İs
->
is_çbrics
) {

2317 
ù¾
->
icdoff
 = 
	`Ë16_to_ıu
(
id
->icdoff);

2318 
ù¾
->
ioccsz
 = 
	`Ë32_to_ıu
(
id
->ioccsz);

2319 
ù¾
->
iÜcsz
 = 
	`Ë32_to_ıu
(
id
->iorcsz);

2320 
ù¾
->
maxcmd
 = 
	`Ë16_to_ıu
(
id
->maxcmd);

2326 ià(
ù¾
->
úid
 !ğ
	`Ë16_to_ıu
(
id
->cntlid))

2327 
»t
 = -
EINVAL
;

2329 ià(!
ù¾
->
İts
->
discov”y_nqn
 && !ù¾->
kas
) {

2330 
	`dev_”r
(
ù¾
->
dev
,

2332 
»t
 = -
EINVAL
;

2335 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
id
->cntlid);

2338 
	`kä“
(
id
);

2339  
»t
;

2340 
	}
}

2341 
EXPORT_SYMBOL_GPL
(
nvme_š™_id’tify
);

2343 
	$nvme_dev_İ’
(
šode
 *šode, 
fe
 *file)

2345 
nvme_ù¾
 *
ù¾
;

2346 
š¡ªû
 = 
	`imšÜ
(
šode
);

2347 
»t
 = -
ENODEV
;

2349 
	`¥š_lock
(&
dev_li¡_lock
);

2350 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_ù¾_li¡
, 
node
) {

2351 ià(
ù¾
->
š¡ªû
 != instance)

2354 ià(!
ù¾
->
admš_q
) {

2355 
»t
 = -
EWOULDBLOCK
;

2358 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->
k»f
))

2360 
fe
->
´iv©e_d©a
 = 
ù¾
;

2361 
»t
 = 0;

2364 
	`¥š_uÆock
(&
dev_li¡_lock
);

2366  
»t
;

2367 
	}
}

2369 
	$nvme_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

2371 
	`nvme_put_ù¾
(
fe
->
´iv©e_d©a
);

2373 
	}
}

2375 
	$nvme_dev_u£r_cmd
(
nvme_ù¾
 *
ù¾
, 
__u£r
 *
¬gp
)

2377 
nvme_ns
 *
ns
;

2378 
»t
;

2380 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2381 ià(
	`li¡_em±y
(&
ù¾
->
Çme¥aûs
)) {

2382 
»t
 = -
ENOTTY
;

2383 
out_uÆock
;

2386 
ns
 = 
	`li¡_fœ¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
);

2387 ià(
ns
 !ğ
	`li¡_Ï¡_’Œy
(&
ù¾
->
Çme¥aûs
, 
nvme_ns
, 
li¡
)) {

2388 
	`dev_w¬n
(
ù¾
->
deviû
,

2390 
»t
 = -
EINVAL
;

2391 
out_uÆock
;

2394 
	`dev_w¬n
(
ù¾
->
deviû
,

2396 
	`k»f_g‘
(&
ns
->
k»f
);

2397 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2399 
»t
 = 
	`nvme_u£r_cmd
(
ù¾
, 
ns
, 
¬gp
);

2400 
	`nvme_put_ns
(
ns
);

2401  
»t
;

2403 
out_uÆock
:

2404 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2405  
»t
;

2406 
	}
}

2408 
	$nvme_dev_ioùl
(
fe
 *fe, 
cmd
,

2409 
¬g
)

2411 
nvme_ù¾
 *
ù¾
 = 
fe
->
´iv©e_d©a
;

2412 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

2414 
cmd
) {

2415 
NVME_IOCTL_ADMIN_CMD
:

2416  
	`nvme_u£r_cmd
(
ù¾
, 
NULL
, 
¬gp
);

2417 
NVME_IOCTL_IO_CMD
:

2418  
	`nvme_dev_u£r_cmd
(
ù¾
, 
¬gp
);

2419 
NVME_IOCTL_RESET
:

2420 
	`dev_w¬n
(
ù¾
->
deviû
, "resetting controller\n");

2421  
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2422 
NVME_IOCTL_SUBSYS_RESET
:

2423  
	`nvme_»£t_subsy¡em
(
ù¾
);

2424 
NVME_IOCTL_RESCAN
:

2425 
	`nvme_queue_sÿn
(
ù¾
);

2428  -
ENOTTY
;

2430 
	}
}

2432 cÚ¡ 
fe_İ”©iÚs
 
	gnvme_dev_fİs
 = {

2433 .
owÃr
 = 
THIS_MODULE
,

2434 .
	gİ’
 = 
nvme_dev_İ’
,

2435 .
	g»Ëa£
 = 
nvme_dev_»Ëa£
,

2436 .
	guÆocked_ioùl
 = 
nvme_dev_ioùl
,

2437 .
	gcom·t_ioùl
 = 
nvme_dev_ioùl
,

2440 
ssize_t
 
	$nvme_sysfs_»£t
(
deviû
 *
dev
,

2441 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2442 
size_t
 
couÁ
)

2444 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2445 
»t
;

2447 
»t
 = 
ù¾
->
İs
->
	`»£t_ù¾
(ctrl);

2448 ià(
»t
 < 0)

2449  
»t
;

2450  
couÁ
;

2451 
	}
}

2452 
DEVICE_ATTR
(
»£t_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»£t
);

2454 
ssize_t
 
	$nvme_sysfs_»sÿn
(
deviû
 *
dev
,

2455 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2456 
size_t
 
couÁ
)

2458 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2460 
	`nvme_queue_sÿn
(
ù¾
);

2461  
couÁ
;

2462 
	}
}

2463 
DEVICE_ATTR
(
»sÿn_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_»sÿn
);

2465 
ssize_t
 
	$wwid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2466 *
buf
)

2468 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

2469 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

2470 
£rŸl_Ën
 = (
ù¾
->
£rŸl
);

2471 
mod–_Ën
 = (
ù¾
->
mod–
);

2473 ià(
	`memchr_šv
(
ns
->
uuid
, 0, (ns->uuid)))

2474  
	`¥rštf
(
buf
, "eui.%16phN\n", 
ns
->
uuid
);

2476 ià(
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

2477  
	`¥rštf
(
buf
, "eui.%8phN\n", 
ns
->
eui
);

2479 
ù¾
->
£rŸl
[
£rŸl_Ën
 - 1] == ' ')

2480 
£rŸl_Ën
--;

2481 
ù¾
->
mod–
[
mod–_Ën
 - 1] == ' ')

2482 
mod–_Ën
--;

2484  
	`¥rštf
(
buf
, "nvme.%04x-%*phN-%*phN-%08x\n", 
ù¾
->
vid
,

2485 
£rŸl_Ën
, 
ù¾
->
£rŸl
, 
mod–_Ën
, cŒl->
mod–
, 
ns
->
ns_id
);

2486 
	}
}

2487 
DEVICE_ATTR
(
wwid
, 
S_IRUGO
, 
wwid_show
, 
NULL
);

2489 
ssize_t
 
	$uuid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2490 *
buf
)

2492 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

2493  
	`¥rštf
(
buf
, "%pU\n", 
ns
->
uuid
);

2494 
	}
}

2495 
DEVICE_ATTR
(
uuid
, 
S_IRUGO
, 
uuid_show
, 
NULL
);

2497 
ssize_t
 
	$eui_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2498 *
buf
)

2500 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

2501  
	`¥rštf
(
buf
, "%8phd\n", 
ns
->
eui
);

2502 
	}
}

2503 
DEVICE_ATTR
(
eui
, 
S_IRUGO
, 
eui_show
, 
NULL
);

2505 
ssize_t
 
	$nsid_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
,

2506 *
buf
)

2508 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

2509  
	`¥rštf
(
buf
, "%d\n", 
ns
->
ns_id
);

2510 
	}
}

2511 
DEVICE_ATTR
(
nsid
, 
S_IRUGO
, 
nsid_show
, 
NULL
);

2513 
©Œibu‹
 *
	gnvme_ns_©Œs
[] = {

2514 &
dev_©Œ_wwid
.
©Œ
,

2515 &
dev_©Œ_uuid
.
©Œ
,

2516 &
dev_©Œ_eui
.
©Œ
,

2517 &
dev_©Œ_nsid
.
©Œ
,

2518 
NULL
,

2521 
umode_t
 
	$nvme_ns_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2522 
©Œibu‹
 *
a
, 
n
)

2524 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2525 
nvme_ns
 *
ns
 = 
	`nvme_g‘_ns_äom_dev
(
dev
);

2527 ià(
a
 =ğ&
dev_©Œ_uuid
.
©Œ
) {

2528 ià(!
	`memchr_šv
(
ns
->
uuid
, 0, (ns->uuid)))

2531 ià(
a
 =ğ&
dev_©Œ_eui
.
©Œ
) {

2532 ià(!
	`memchr_šv
(
ns
->
eui
, 0, (ns->eui)))

2535  
a
->
mode
;

2536 
	}
}

2538 cÚ¡ 
©Œibu‹_group
 
	gnvme_ns_©Œ_group
 = {

2539 .
©Œs
 = 
nvme_ns_©Œs
,

2540 .
	gis_visibË
 = 
nvme_ns_©Œs_¬e_visibË
,

2543 
	#nvme_show_¡r_funùiÚ
(
f›ld
) \

2544 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2545 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2547 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2548  
	`¥rštf
(
buf
, "%.*s\n", ()(
ù¾
->
f›ld
), ctrl->field); \

2550 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2552 
	#nvme_show_št_funùiÚ
(
f›ld
) \

2553 
ssize_t
 
f›ld
##
	`_show
(
deviû
 *
dev
, \

2554 
deviû_©Œibu‹
 *
©Œ
, *
buf
) \

2556 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
); \

2557  
	`¥rštf
(
buf
, "%d\n", 
ù¾
->
f›ld
); \

2559 
	`DEVICE_ATTR
(
f›ld
, 
S_IRUGO
, f›ld##
_show
, 
NULL
);

	)

2561 
nvme_show_¡r_funùiÚ
(
mod–
);

2562 
nvme_show_¡r_funùiÚ
(
£rŸl
);

2563 
nvme_show_¡r_funùiÚ
(
fœmw¬e_»v
);

2564 
nvme_show_št_funùiÚ
(
úid
);

2566 
ssize_t
 
	$nvme_sysfs_d–‘e
(
deviû
 *
dev
,

2567 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

2568 
size_t
 
couÁ
)

2570 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2572 ià(
	`deviû_»move_fe_£lf
(
dev
, 
©Œ
))

2573 
ù¾
->
İs
->
	`d–‘e_ù¾
(ctrl);

2574  
couÁ
;

2575 
	}
}

2576 
DEVICE_ATTR
(
d–‘e_cÚŒŞËr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_d–‘e
);

2578 
ssize_t
 
	$nvme_sysfs_show_Œª¥Üt
(
deviû
 *
dev
,

2579 
deviû_©Œibu‹
 *
©Œ
,

2580 *
buf
)

2582 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2584  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n", 
ù¾
->
İs
->
Çme
);

2585 
	}
}

2586 
DEVICE_ATTR
(
Œª¥Üt
, 
S_IRUGO
, 
nvme_sysfs_show_Œª¥Üt
, 
NULL
);

2588 
ssize_t
 
	$nvme_sysfs_show_subsy¢qn
(
deviû
 *
dev
,

2589 
deviû_©Œibu‹
 *
©Œ
,

2590 *
buf
)

2592 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2594  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%s\n",

2595 
ù¾
->
İs
->
	`g‘_subsy¢qn
(ctrl));

2596 
	}
}

2597 
DEVICE_ATTR
(
subsy¢qn
, 
S_IRUGO
, 
nvme_sysfs_show_subsy¢qn
, 
NULL
);

2599 
ssize_t
 
	$nvme_sysfs_show_add»ss
(
deviû
 *
dev
,

2600 
deviû_©Œibu‹
 *
©Œ
,

2601 *
buf
)

2603 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2605  
ù¾
->
İs
->
	`g‘_add»ss
(ù¾, 
buf
, 
PAGE_SIZE
);

2606 
	}
}

2607 
DEVICE_ATTR
(
add»ss
, 
S_IRUGO
, 
nvme_sysfs_show_add»ss
, 
NULL
);

2609 
©Œibu‹
 *
	gnvme_dev_©Œs
[] = {

2610 &
dev_©Œ_»£t_cÚŒŞËr
.
©Œ
,

2611 &
dev_©Œ_»sÿn_cÚŒŞËr
.
©Œ
,

2612 &
dev_©Œ_mod–
.
©Œ
,

2613 &
dev_©Œ_£rŸl
.
©Œ
,

2614 &
dev_©Œ_fœmw¬e_»v
.
©Œ
,

2615 &
dev_©Œ_úid
.
©Œ
,

2616 &
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
,

2617 &
dev_©Œ_Œª¥Üt
.
©Œ
,

2618 &
dev_©Œ_subsy¢qn
.
©Œ
,

2619 &
dev_©Œ_add»ss
.
©Œ
,

2620 
NULL


2623 
	#CHECK_ATTR
(
ù¾
, 
a
, 
Çme
) \

2624 ià((
a
è=ğ&
dev_©Œ_
##
Çme
.
©Œ
 && \

2625 !(
ù¾
)->
İs
->
g‘_
##
Çme
) \

2626  0

	)

2628 
umode_t
 
	$nvme_dev_©Œs_¬e_visibË
(
kobjeù
 *
kobj
,

2629 
©Œibu‹
 *
a
, 
n
)

2631 
deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, device, kobj);

2632 
nvme_ù¾
 *
ù¾
 = 
	`dev_g‘_drvd©a
(
dev
);

2634 ià(
a
 =ğ&
dev_©Œ_d–‘e_cÚŒŞËr
.
©Œ
) {

2635 ià(!
ù¾
->
İs
->
d–‘e_ù¾
)

2639 
	`CHECK_ATTR
(
ù¾
, 
a
, 
subsy¢qn
);

2640 
	`CHECK_ATTR
(
ù¾
, 
a
, 
add»ss
);

2642  
a
->
mode
;

2643 
	}
}

2645 
©Œibu‹_group
 
	gnvme_dev_©Œs_group
 = {

2646 .
©Œs
 = 
nvme_dev_©Œs
,

2647 .
	gis_visibË
 = 
nvme_dev_©Œs_¬e_visibË
,

2650 cÚ¡ 
©Œibu‹_group
 *
	gnvme_dev_©Œ_groups
[] = {

2651 &
nvme_dev_©Œs_group
,

2652 
NULL
,

2655 
	$ns_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

2657 
nvme_ns
 *
n§
 = 
	`cÚš”_of
(
a
, nvme_ns, 
li¡
);

2658 
nvme_ns
 *
nsb
 = 
	`cÚš”_of
(
b
, nvme_ns, 
li¡
);

2660  
n§
->
ns_id
 - 
nsb
->ns_id;

2661 
	}
}

2663 
nvme_ns
 *
	$nvme_fšd_g‘_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2665 
nvme_ns
 *
ns
, *
»t
 = 
NULL
;

2667 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2668 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2669 ià(
ns
->
ns_id
 =ğ
nsid
) {

2670 
	`k»f_g‘
(&
ns
->
k»f
);

2671 
»t
 = 
ns
;

2674 ià(
ns
->
ns_id
 > 
nsid
)

2677 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2678  
»t
;

2679 
	}
}

2681 
	$nvme_®loc_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2683 
nvme_ns
 *
ns
;

2684 
g’disk
 *
disk
;

2685 
nvme_id_ns
 *
id
;

2686 
disk_Çme
[
DISK_NAME_LEN
];

2687 
node
 = 
	`dev_to_node
(
ù¾
->
dev
);

2689 
ns
 = 
	`kz®loc_node
((*ns), 
GFP_KERNEL
, 
node
);

2690 ià(!
ns
)

2693 
ns
->
š¡ªû
 = 
	`ida_sim¶e_g‘
(&
ù¾
->
ns_ida
, 1, 0, 
GFP_KERNEL
);

2694 ià(
ns
->
š¡ªû
 < 0)

2695 
out_ä“_ns
;

2697 
ns
->
queue
 = 
	`blk_mq_š™_queue
(
ù¾
->
g£t
);

2698 ià(
	`IS_ERR
(
ns
->
queue
))

2699 
out_»Ëa£_š¡ªû
;

2700 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

2701 
ns
->
queue
->
queued©a
 =‚s;

2702 
ns
->
ù¾
 = ctrl;

2704 
	`k»f_š™
(&
ns
->
k»f
);

2705 
ns
->
ns_id
 = 
nsid
;

2706 
ns
->
lba_shiá
 = 9;

2708 
	`blk_queue_logiÿl_block_size
(
ns
->
queue
, 1 <<‚s->
lba_shiá
);

2709 
	`nvme_£t_queue_lim™s
(
ù¾
, 
ns
->
queue
);

2711 
	`¥rštf
(
disk_Çme
, "nvme%dn%d", 
ù¾
->
š¡ªû
, 
ns
->instance);

2713 ià(
	`nvme_»v®id©e_ns
(
ns
, &
id
))

2714 
out_ä“_queue
;

2716 ià(
	`nvme_nvm_ns_suµÜ‹d
(
ns
, 
id
)) {

2717 ià(
	`nvme_nvm_»gi¡”
(
ns
, 
disk_Çme
, 
node
,

2718 &
nvme_ns_©Œ_group
)) {

2719 
	`dev_w¬n
(
ù¾
->
dev
, "%s: LightNVM init failure\n",

2720 
__func__
);

2721 
out_ä“_id
;

2724 
disk
 = 
	`®loc_disk_node
(0, 
node
);

2725 ià(!
disk
)

2726 
out_ä“_id
;

2728 
disk
->
fİs
 = &
nvme_fİs
;

2729 
disk
->
´iv©e_d©a
 = 
ns
;

2730 
disk
->
queue
 = 
ns
->queue;

2731 
disk
->
æags
 = 
GENHD_FL_EXT_DEVT
;

2732 
	`memıy
(
disk
->
disk_Çme
, disk_Çme, 
DISK_NAME_LEN
);

2733 
ns
->
disk
 = disk;

2735 
	`__nvme_»v®id©e_disk
(
disk
, 
id
);

2738 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2739 
	`li¡_add_
(&
ns
->
li¡
, &
ù¾
->
Çme¥aûs
);

2740 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2742 
	`k»f_g‘
(&
ù¾
->
k»f
);

2744 
	`kä“
(
id
);

2746 ià(
ns
->
ndev
)

2749 
	`deviû_add_disk
(
ù¾
->
deviû
, 
ns
->
disk
);

2750 ià(
	`sysfs_ü—‹_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2751 &
nvme_ns_©Œ_group
))

2752 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

2753 
ns
->
disk
->
disk_Çme
);

2755 
out_ä“_id
:

2756 
	`kä“
(
id
);

2757 
out_ä“_queue
:

2758 
	`blk_ş—nup_queue
(
ns
->
queue
);

2759 
out_»Ëa£_š¡ªû
:

2760 
	`ida_sim¶e_»move
(&
ù¾
->
ns_ida
, 
ns
->
š¡ªû
);

2761 
out_ä“_ns
:

2762 
	`kä“
(
ns
);

2763 
	}
}

2765 
	$nvme_ns_»move
(
nvme_ns
 *
ns
)

2767 ià(
	`‹¡_ªd_£t_b™
(
NVME_NS_REMOVING
, &
ns
->
æags
))

2770 ià(
ns
->
disk
 &&‚s->disk->
æags
 & 
GENHD_FL_UP
) {

2771 ià(
	`blk_g‘_š‹gr™y
(
ns
->
disk
))

2772 
	`blk_š‹gr™y_uÄegi¡”
(
ns
->
disk
);

2773 
	`sysfs_»move_group
(&
	`disk_to_dev
(
ns
->
disk
)->
kobj
,

2774 &
nvme_ns_©Œ_group
);

2775 
	`d–_g’disk
(
ns
->
disk
);

2776 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

2777 
	`blk_ş—nup_queue
(
ns
->
queue
);

2780 
	`mu‹x_lock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2781 
	`li¡_d–_š™
(&
ns
->
li¡
);

2782 
	`mu‹x_uÆock
(&
ns
->
ù¾
->
Çme¥aûs_mu‹x
);

2784 
	`nvme_put_ns
(
ns
);

2785 
	}
}

2787 
	$nvme_v®id©e_ns
(
nvme_ù¾
 *
ù¾
, 
nsid
)

2789 
nvme_ns
 *
ns
;

2791 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
nsid
);

2792 ià(
ns
) {

2793 ià(
ns
->
disk
 && 
	`»v®id©e_disk
(ns->disk))

2794 
	`nvme_ns_»move
(
ns
);

2795 
	`nvme_put_ns
(
ns
);

2797 
	`nvme_®loc_ns
(
ù¾
, 
nsid
);

2798 
	}
}

2800 
	$nvme_»move_šv®id_Çme¥aûs
(
nvme_ù¾
 *
ù¾
,

2801 
nsid
)

2803 
nvme_ns
 *
ns
, *
Ãxt
;

2805 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

2806 ià(
ns
->
ns_id
 > 
nsid
)

2807 
	`nvme_ns_»move
(
ns
);

2809 
	}
}

2811 
	$nvme_sÿn_ns_li¡
(
nvme_ù¾
 *
ù¾
, 
Â
)

2813 
nvme_ns
 *
ns
;

2814 
__Ë32
 *
ns_li¡
;

2815 
i
, 
j
, 
nsid
, 
´ev
 = 0, 
num_li¡s
 = 
	`DIV_ROUND_UP
(
Â
, 1024);

2816 
»t
 = 0;

2818 
ns_li¡
 = 
	`kz®loc
(0x1000, 
GFP_KERNEL
);

2819 ià(!
ns_li¡
)

2820  -
ENOMEM
;

2822 
i
 = 0; i < 
num_li¡s
; i++) {

2823 
»t
 = 
	`nvme_id’tify_ns_li¡
(
ù¾
, 
´ev
, 
ns_li¡
);

2824 ià(
»t
)

2825 
ä“
;

2827 
j
 = 0; j < 
	`mš
(
Â
, 1024U); j++) {

2828 
nsid
 = 
	`Ë32_to_ıu
(
ns_li¡
[
j
]);

2829 ià(!
nsid
)

2830 
out
;

2832 
	`nvme_v®id©e_ns
(
ù¾
, 
nsid
);

2834 ++
´ev
 < 
nsid
) {

2835 
ns
 = 
	`nvme_fšd_g‘_ns
(
ù¾
, 
´ev
);

2836 ià(
ns
) {

2837 
	`nvme_ns_»move
(
ns
);

2838 
	`nvme_put_ns
(
ns
);

2842 
Â
 -ğ
j
;

2844 
out
:

2845 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
´ev
);

2846 
ä“
:

2847 
	`kä“
(
ns_li¡
);

2848  
»t
;

2849 
	}
}

2851 
	$nvme_sÿn_ns_£qu’tŸl
(
nvme_ù¾
 *
ù¾
, 
Â
)

2853 
i
;

2855 
i
 = 1; i <ğ
Â
; i++)

2856 
	`nvme_v®id©e_ns
(
ù¾
, 
i
);

2858 
	`nvme_»move_šv®id_Çme¥aûs
(
ù¾
, 
Â
);

2859 
	}
}

2861 
	$nvme_sÿn_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2863 
nvme_ù¾
 *
ù¾
 =

2864 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
sÿn_wÜk
);

2865 
nvme_id_ù¾
 *
id
;

2866 
Â
;

2868 ià(
ù¾
->
¡©e
 !ğ
NVME_CTRL_LIVE
)

2871 ià(
	`nvme_id’tify_ù¾
(
ù¾
, &
id
))

2874 
Â
 = 
	`Ë32_to_ıu
(
id
->nn);

2875 ià(
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0) &&

2876 !(
ù¾
->
quœks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

2877 ià(!
	`nvme_sÿn_ns_li¡
(
ù¾
, 
Â
))

2878 
dÚe
;

2880 
	`nvme_sÿn_ns_£qu’tŸl
(
ù¾
, 
Â
);

2881 
dÚe
:

2882 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2883 
	`li¡_sÜt
(
NULL
, &
ù¾
->
Çme¥aûs
, 
ns_cmp
);

2884 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

2885 
	`kä“
(
id
);

2886 
	}
}

2888 
	$nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
)

2894 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_LIVE
)

2895 
	`scheduË_wÜk
(&
ù¾
->
sÿn_wÜk
);

2896 
	}
}

2897 
EXPORT_SYMBOL_GPL
(
nvme_queue_sÿn
);

2904 
	$nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
)

2906 
nvme_ns
 *
ns
, *
Ãxt
;

2914 ià(
ù¾
->
¡©e
 =ğ
NVME_CTRL_DEAD
)

2915 
	`nvme_kl_queues
(
ù¾
);

2917 
	`li¡_fÜ_—ch_’Œy_§ã
(
ns
, 
Ãxt
, &
ù¾
->
Çme¥aûs
, 
li¡
)

2918 
	`nvme_ns_»move
(
ns
);

2919 
	}
}

2920 
EXPORT_SYMBOL_GPL
(
nvme_»move_Çme¥aûs
);

2922 
	$nvme_async_ev’t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2924 
nvme_ù¾
 *
ù¾
 =

2925 
	`cÚš”_of
(
wÜk
, 
nvme_ù¾
, 
async_ev’t_wÜk
);

2927 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2928 
ù¾
->
ev’t_lim™
 > 0) {

2929 
«r_idx
 = --
ù¾
->
ev’t_lim™
;

2931 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2932 
ù¾
->
İs
->
	`subm™_async_ev’t
(ù¾, 
«r_idx
);

2933 
	`¥š_lock_œq
(&
ù¾
->
lock
);

2935 
	`¥š_uÆock_œq
(&
ù¾
->
lock
);

2936 
	}
}

2938 
	$nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
,

2939 
nvme_com¶‘iÚ
 *
cqe
)

2941 
u16
 
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status) >> 1;

2942 
u32
 
»suÉ
 = 
	`Ë32_to_ıu
(
cqe
->result);

2944 ià(
¡©us
 =ğ
NVME_SC_SUCCESS
 || stu =ğ
NVME_SC_ABORT_REQ
) {

2945 ++
ù¾
->
ev’t_lim™
;

2946 
	`scheduË_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

2949 ià(
¡©us
 !ğ
NVME_SC_SUCCESS
)

2952 
»suÉ
 & 0xff07) {

2953 
NVME_AER_NOTICE_NS_CHANGED
:

2954 
	`dev_šfo
(
ù¾
->
deviû
, "rescanning\n");

2955 
	`nvme_queue_sÿn
(
ù¾
);

2958 
	`dev_w¬n
(
ù¾
->
deviû
, "asynøev’ˆ»suÉ %08x\n", 
»suÉ
);

2960 
	}
}

2961 
EXPORT_SYMBOL_GPL
(
nvme_com¶‘e_async_ev’t
);

2963 
	$nvme_queue_async_ev’ts
(
nvme_ù¾
 *
ù¾
)

2965 
ù¾
->
ev’t_lim™
 = 
NVME_NR_AERS
;

2966 
	`scheduË_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

2967 
	}
}

2968 
EXPORT_SYMBOL_GPL
(
nvme_queue_async_ev’ts
);

2970 
DEFINE_IDA
(
nvme_š¡ªû_ida
);

2972 
	$nvme_£t_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2974 
š¡ªû
, 
”rÜ
;

2977 ià(!
	`ida_´e_g‘
(&
nvme_š¡ªû_ida
, 
GFP_KERNEL
))

2978  -
ENODEV
;

2980 
	`¥š_lock
(&
dev_li¡_lock
);

2981 
”rÜ
 = 
	`ida_g‘_Ãw
(&
nvme_š¡ªû_ida
, &
š¡ªû
);

2982 
	`¥š_uÆock
(&
dev_li¡_lock
);

2983 } 
”rÜ
 =ğ-
EAGAIN
);

2985 ià(
”rÜ
)

2986  -
ENODEV
;

2988 
ù¾
->
š¡ªû
 = instance;

2990 
	}
}

2992 
	$nvme_»Ëa£_š¡ªû
(
nvme_ù¾
 *
ù¾
)

2994 
	`¥š_lock
(&
dev_li¡_lock
);

2995 
	`ida_»move
(&
nvme_š¡ªû_ida
, 
ù¾
->
š¡ªû
);

2996 
	`¥š_uÆock
(&
dev_li¡_lock
);

2997 
	}
}

2999 
	$nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
)

3001 
	`æush_wÜk
(&
ù¾
->
async_ev’t_wÜk
);

3002 
	`æush_wÜk
(&
ù¾
->
sÿn_wÜk
);

3003 
	`nvme_»move_Çme¥aûs
(
ù¾
);

3005 
	`deviû_de¡roy
(
nvme_şass
, 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
));

3007 
	`¥š_lock
(&
dev_li¡_lock
);

3008 
	`li¡_d–
(&
ù¾
->
node
);

3009 
	`¥š_uÆock
(&
dev_li¡_lock
);

3010 
	}
}

3011 
EXPORT_SYMBOL_GPL
(
nvme_unš™_ù¾
);

3013 
	$nvme_ä“_ù¾
(
k»f
 *kref)

3015 
nvme_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
k»f
, nvme_ctrl, kref);

3017 
	`put_deviû
(
ù¾
->
deviû
);

3018 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

3019 
	`ida_de¡roy
(&
ù¾
->
ns_ida
);

3021 
ù¾
->
İs
->
	`ä“_ù¾
(ctrl);

3022 
	}
}

3024 
	$nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
)

3026 
	`k»f_put
(&
ù¾
->
k»f
, 
nvme_ä“_ù¾
);

3027 
	}
}

3028 
EXPORT_SYMBOL_GPL
(
nvme_put_ù¾
);

3035 
	$nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

3036 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
)

3038 
»t
;

3040 
ù¾
->
¡©e
 = 
NVME_CTRL_NEW
;

3041 
	`¥š_lock_š™
(&
ù¾
->
lock
);

3042 
	`INIT_LIST_HEAD
(&
ù¾
->
Çme¥aûs
);

3043 
	`mu‹x_š™
(&
ù¾
->
Çme¥aûs_mu‹x
);

3044 
	`k»f_š™
(&
ù¾
->
k»f
);

3045 
ù¾
->
dev
 = dev;

3046 
ù¾
->
İs
 = ops;

3047 
ù¾
->
quœks
 = quirks;

3048 
	`INIT_WORK
(&
ù¾
->
sÿn_wÜk
, 
nvme_sÿn_wÜk
);

3049 
	`INIT_WORK
(&
ù¾
->
async_ev’t_wÜk
, 
nvme_async_ev’t_wÜk
);

3051 
»t
 = 
	`nvme_£t_š¡ªû
(
ù¾
);

3052 ià(
»t
)

3053 
out
;

3055 
ù¾
->
deviû
 = 
	`deviû_ü—‹_w™h_groups
(
nvme_şass
, cŒl->
dev
,

3056 
	`MKDEV
(
nvme_ch¬_majÜ
, 
ù¾
->
š¡ªû
),

3057 
ù¾
, 
nvme_dev_©Œ_groups
,

3058 "nvme%d", 
ù¾
->
š¡ªû
);

3059 ià(
	`IS_ERR
(
ù¾
->
deviû
)) {

3060 
»t
 = 
	`PTR_ERR
(
ù¾
->
deviû
);

3061 
out_»Ëa£_š¡ªû
;

3063 
	`g‘_deviû
(
ù¾
->
deviû
);

3064 
	`ida_š™
(&
ù¾
->
ns_ida
);

3066 
	`¥š_lock
(&
dev_li¡_lock
);

3067 
	`li¡_add_
(&
ù¾
->
node
, &
nvme_ù¾_li¡
);

3068 
	`¥š_uÆock
(&
dev_li¡_lock
);

3071 
out_»Ëa£_š¡ªû
:

3072 
	`nvme_»Ëa£_š¡ªû
(
ù¾
);

3073 
out
:

3074  
»t
;

3075 
	}
}

3076 
EXPORT_SYMBOL_GPL
(
nvme_š™_ù¾
);

3085 
	$nvme_kl_queues
(
nvme_ù¾
 *
ù¾
)

3087 
nvme_ns
 *
ns
;

3089 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3090 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3095 ià(
ns
->
disk
 && !
	`‹¡_ªd_£t_b™
(
NVME_NS_DEAD
, &ns->
æags
))

3096 
	`»v®id©e_disk
(
ns
->
disk
);

3098 
	`blk_£t_queue_dyšg
(
ns
->
queue
);

3099 
	`blk_mq_abÜt_»queue_li¡
(
ns
->
queue
);

3100 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

3102 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3103 
	}
}

3104 
EXPORT_SYMBOL_GPL
(
nvme_kl_queues
);

3106 
	$nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
)

3108 
nvme_ns
 *
ns
;

3110 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3111 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3112 
	`¥š_lock_œq
(
ns
->
queue
->
queue_lock
);

3113 
	`queue_æag_£t
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

3114 
	`¥š_uÆock_œq
(
ns
->
queue
->
queue_lock
);

3116 
	`blk_mq_ÿnûl_»queue_wÜk
(
ns
->
queue
);

3117 
	`blk_mq_¡İ_hw_queues
(
ns
->
queue
);

3119 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3120 
	}
}

3121 
EXPORT_SYMBOL_GPL
(
nvme_¡İ_queues
);

3123 
	$nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
)

3125 
nvme_ns
 *
ns
;

3127 
	`mu‹x_lock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3128 
	`li¡_fÜ_—ch_’Œy
(
ns
, &
ù¾
->
Çme¥aûs
, 
li¡
) {

3129 
	`queue_æag_ş—r_uÆocked
(
QUEUE_FLAG_STOPPED
, 
ns
->
queue
);

3130 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ns
->
queue
, 
Œue
);

3131 
	`blk_mq_kick_»queue_li¡
(
ns
->
queue
);

3133 
	`mu‹x_uÆock
(&
ù¾
->
Çme¥aûs_mu‹x
);

3134 
	}
}

3135 
EXPORT_SYMBOL_GPL
(
nvme_¡¬t_queues
);

3137 
__š™
 
	$nvme_cÜe_š™
()

3139 
»suÉ
;

3141 
»suÉ
 = 
	`__»gi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme",

3142 &
nvme_dev_fİs
);

3143 ià(
»suÉ
 < 0)

3144  
»suÉ
;

3145 ià(
»suÉ
 > 0)

3146 
nvme_ch¬_majÜ
 = 
»suÉ
;

3148 
nvme_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme");

3149 ià(
	`IS_ERR
(
nvme_şass
)) {

3150 
»suÉ
 = 
	`PTR_ERR
(
nvme_şass
);

3151 
uÄegi¡”_chrdev
;

3153 
»suÉ
 = 
	`aio_£rviû_š™
();

3154 ià(
»suÉ
)

3155 
uÄegi¡”_chrdev
;

3157 
»suÉ
 = 
	`aio_wÜk”_š™
();

3158 ià(
»suÉ
)

3159 
uÄegi¡”_chrdev
;

3162 
uÄegi¡”_chrdev
:

3163 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

3164  
»suÉ
;

3165 
	}
}

3167 
	$nvme_cÜe_ex™
()

3169 
	`şass_de¡roy
(
nvme_şass
);

3170 
	`__uÄegi¡”_chrdev
(
nvme_ch¬_majÜ
, 0, 
NVME_MINORS
, "nvme");

3171 
	`aio_wÜk”_ex™
();

3172 
	`aio_£rviû_ex™
();

3173 
	}
}

3175 
MODULE_LICENSE
("GPL");

3176 
MODULE_VERSION
("1.0");

3177 
moduË_š™
(
nvme_cÜe_š™
);

3178 
moduË_ex™
(
nvme_cÜe_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/fabrics.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/š™.h
>

16 
	~<lšux/miscdeviû.h
>

17 
	~<lšux/moduË.h
>

18 
	~<lšux/mu‹x.h
>

19 
	~<lšux/·r£r.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~"nvme.h
"

22 
	~"çbrics.h
"

24 
LIST_HEAD
(
nvmf_Œª¥Üts
);

25 
DEFINE_MUTEX
(
nvmf_Œª¥Üts_mu‹x
);

27 
LIST_HEAD
(
nvmf_ho¡s
);

28 
DEFINE_MUTEX
(
nvmf_ho¡s_mu‹x
);

30 
nvmf_ho¡
 *
	gnvmf_deçuÉ_ho¡
;

32 
nvmf_ho¡
 *
	$__nvmf_ho¡_fšd
(cÚ¡ *
ho¡nqn
)

34 
nvmf_ho¡
 *
ho¡
;

36 
	`li¡_fÜ_—ch_’Œy
(
ho¡
, &
nvmf_ho¡s
, 
li¡
) {

37 ià(!
	`¡rcmp
(
ho¡
->
nqn
, 
ho¡nqn
))

38  
ho¡
;

41  
NULL
;

42 
	}
}

44 
nvmf_ho¡
 *
	$nvmf_ho¡_add
(cÚ¡ *
ho¡nqn
)

46 
nvmf_ho¡
 *
ho¡
;

48 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

49 
ho¡
 = 
	`__nvmf_ho¡_fšd
(
ho¡nqn
);

50 ià(
ho¡
) {

51 
	`k»f_g‘
(&
ho¡
->
»f
);

52 
out_uÆock
;

55 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

56 ià(!
ho¡
)

57 
out_uÆock
;

59 
	`k»f_š™
(&
ho¡
->
»f
);

60 
	`memıy
(
ho¡
->
nqn
, 
ho¡nqn
, 
NVMF_NQN_SIZE
);

61 
	`uuid_be_g’
(&
ho¡
->
id
);

63 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

64 
out_uÆock
:

65 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

66  
ho¡
;

67 
	}
}

69 
nvmf_ho¡
 *
	$nvmf_ho¡_deçuÉ
()

71 
nvmf_ho¡
 *
ho¡
;

73 
ho¡
 = 
	`km®loc
((*ho¡), 
GFP_KERNEL
);

74 ià(!
ho¡
)

75  
NULL
;

77 
	`k»f_š™
(&
ho¡
->
»f
);

78 
	`uuid_be_g’
(&
ho¡
->
id
);

79 
	`¢´štf
(
ho¡
->
nqn
, 
NVMF_NQN_SIZE
,

80 "nqn.2014-08.Üg.nvmex´ess:NVMf:uuid:%pUb", &
ho¡
->
id
);

82 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

83 
	`li¡_add_
(&
ho¡
->
li¡
, &
nvmf_ho¡s
);

84 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

86  
ho¡
;

87 
	}
}

89 
	$nvmf_ho¡_de¡roy
(
k»f
 *
»f
)

91 
nvmf_ho¡
 *
ho¡
 = 
	`cÚš”_of
(
»f
, nvmf_host,„ef);

93 
	`mu‹x_lock
(&
nvmf_ho¡s_mu‹x
);

94 
	`li¡_d–
(&
ho¡
->
li¡
);

95 
	`mu‹x_uÆock
(&
nvmf_ho¡s_mu‹x
);

97 
	`kä“
(
ho¡
);

98 
	}
}

100 
	$nvmf_ho¡_put
(
nvmf_ho¡
 *
ho¡
)

102 ià(
ho¡
)

103 
	`k»f_put
(&
ho¡
->
»f
, 
nvmf_ho¡_de¡roy
);

104 
	}
}

112 
	$nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
)

114 
Ën
 = 0;

116 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRADDR
)

117 
Ën
 +ğ
	`¢´štf
(
buf
, 
size
, "Œaddr=%s", 
ù¾
->
İts
->
Œaddr
);

118 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_TRSVCID
)

119 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%strsvcid=%s",

120 (
Ën
è? "," : "", 
ù¾
->
İts
->
Œsvcid
);

121 ià(
ù¾
->
İts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

122 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "%shost_traddr=%s",

123 (
Ën
è? "," : "", 
ù¾
->
İts
->
ho¡_Œaddr
);

124 
Ën
 +ğ
	`¢´štf
(
buf
 +†’, 
size
 -†en, "\n");

126  
Ën
;

127 
	}
}

128 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_add»ss
);

134 cÚ¡ *
	$nvmf_g‘_subsy¢qn
(
nvme_ù¾
 *
ù¾
)

136  
ù¾
->
İts
->
subsy¢qn
;

137 
	}
}

138 
EXPORT_SYMBOL_GPL
(
nvmf_g‘_subsy¢qn
);

161 
	$nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

163 
nvme_commªd
 
cmd
;

164 
nvme_com¶‘iÚ
 
cqe
;

165 
»t
;

167 
	`mem£t
(&
cmd
, 0, (cmd));

168 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

169 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

170 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

172 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
cqe
, 
NULL
, 0, 0,

173 
NVME_QID_ANY
, 0, 0);

175 ià(
»t
 >= 0)

176 *
v®
 = 
	`Ë64_to_ıu
(
cqe
.
»suÉ64
);

177 ià(
	`uÆik–y
(
»t
 != 0))

178 
	`dev_”r
(
ù¾
->
deviû
,

180 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

182  
»t
;

183 
	}
}

184 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad32
);

207 
	$nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

209 
nvme_commªd
 
cmd
;

210 
nvme_com¶‘iÚ
 
cqe
;

211 
»t
;

213 
	`mem£t
(&
cmd
, 0, (cmd));

214 
cmd
.
´İ_g‘
.
İcode
 = 
nvme_çbrics_commªd
;

215 
cmd
.
´İ_g‘
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_g‘
;

216 
cmd
.
´İ_g‘
.
©Œib
 = 1;

217 
cmd
.
´İ_g‘
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

219 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
cqe
, 
NULL
, 0, 0,

220 
NVME_QID_ANY
, 0, 0);

222 ià(
»t
 >= 0)

223 *
v®
 = 
	`Ë64_to_ıu
(
cqe
.
»suÉ64
);

224 ià(
	`uÆik–y
(
»t
 != 0))

225 
	`dev_”r
(
ù¾
->
deviû
,

227 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

228  
»t
;

229 
	}
}

230 
EXPORT_SYMBOL_GPL
(
nvmf_»g_»ad64
);

253 
	$nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

255 
nvme_commªd
 
cmd
;

256 
»t
;

258 
	`mem£t
(&
cmd
, 0, (cmd));

259 
cmd
.
´İ_£t
.
İcode
 = 
nvme_çbrics_commªd
;

260 
cmd
.
´İ_£t
.
fùy³
 = 
nvme_çbrics_ty³_´İ”ty_£t
;

261 
cmd
.
´İ_£t
.
©Œib
 = 0;

262 
cmd
.
´İ_£t
.
off£t
 = 
	`ıu_to_Ë32
(
off
);

263 
cmd
.
´İ_£t
.
v®ue
 = 
	`ıu_to_Ë64
(
v®
);

265 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, 
NULL
, NULL, 0, 0,

266 
NVME_QID_ANY
, 0, 0);

267 ià(
	`uÆik–y
(
»t
))

268 
	`dev_”r
(
ù¾
->
deviû
,

270 
»t
 > 0 ?„‘ & ~
NVME_SC_DNR
 :„‘, 
off
);

271  
»t
;

272 
	}
}

273 
EXPORT_SYMBOL_GPL
(
nvmf_»g_wr™e32
);

290 
	$nvmf_log_cÚÃù_”rÜ
(
nvme_ù¾
 *
ù¾
,

291 
”rv®
, 
off£t
, 
nvme_commªd
 *
cmd
,

292 
nvmf_cÚÃù_d©a
 *
d©a
)

294 
”r_sùy³
 = 
”rv®
 & (~
NVME_SC_DNR
);

296 
”r_sùy³
) {

298 (
NVME_SC_CONNECT_INVALID_PARAM
):

299 ià(
off£t
 >> 16) {

300 *
šv_d©a
 = "Connect Invalid Data Parameter";

302 
off£t
 & 0xffff) {

303 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
úid
)):

304 
	`dev_”r
(
ù¾
->
deviû
,

306 
šv_d©a
, 
d©a
->
úid
);

308 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
ho¡nqn
)):

309 
	`dev_”r
(
ù¾
->
deviû
,

311 
šv_d©a
, 
d©a
->
ho¡nqn
);

313 (
	`off£tof
(
nvmf_cÚÃù_d©a
, 
subsy¢qn
)):

314 
	`dev_”r
(
ù¾
->
deviû
,

316 
šv_d©a
, 
d©a
->
subsy¢qn
);

319 
	`dev_”r
(
ù¾
->
deviû
,

321 
šv_d©a
, 
off£t
 & 0xffff);

325 *
šv_sqe
 = "Connect Invalid SQE Parameter";

327 
off£t
) {

328 (
	`off£tof
(
nvmf_cÚÃù_commªd
, 
qid
)):

329 
	`dev_”r
(
ù¾
->
deviû
,

331 
šv_sqe
, 
cmd
->
cÚÃù
.
qid
);

334 
	`dev_”r
(
ù¾
->
deviû
,

336 
šv_sqe
, 
off£t
);

341 
	`dev_”r
(
ù¾
->
deviû
,

343 
”r_sùy³
);

346 
	}
}

368 
	$nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
)

370 
nvme_commªd
 
cmd
;

371 
nvme_com¶‘iÚ
 
cqe
;

372 
nvmf_cÚÃù_d©a
 *
d©a
;

373 
»t
;

375 
	`mem£t
(&
cmd
, 0, (cmd));

376 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

377 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

378 
cmd
.
cÚÃù
.
qid
 = 0;

385 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
NVMF_AQ_DEPTH
 - 1);

391 
cmd
.
cÚÃù
.
k©o
 = 
ù¾
->
İts
->
discov”y_nqn
 ? 0 :

392 
	`ıu_to_Ë32
((
ù¾
->
k©o
 + 
NVME_KATO_GRACE
) * 1000);

394 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

395 ià(!
d©a
)

396  -
ENOMEM
;

398 
	`memıy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
, (
uuid_be
));

399 
d©a
->
úid
 = 
	`ıu_to_Ë16
(0xffff);

400 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

401 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

403 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, &
cmd
, &
cqe
,

404 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

405 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

406 ià(
»t
) {

407 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
cqe
.
»suÉ
),

408 &
cmd
, 
d©a
);

409 
out_ä“_d©a
;

412 
ù¾
->
úid
 = 
	`Ë16_to_ıu
(
cqe
.
»suÉ16
);

414 
out_ä“_d©a
:

415 
	`kä“
(
d©a
);

416  
»t
;

417 
	}
}

418 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_admš_queue
);

440 
	$nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
)

442 
nvme_commªd
 
cmd
;

443 
nvmf_cÚÃù_d©a
 *
d©a
;

444 
nvme_com¶‘iÚ
 
cqe
;

445 
»t
;

447 
	`mem£t
(&
cmd
, 0, (cmd));

448 
cmd
.
cÚÃù
.
İcode
 = 
nvme_çbrics_commªd
;

449 
cmd
.
cÚÃù
.
fùy³
 = 
nvme_çbrics_ty³_cÚÃù
;

450 
cmd
.
cÚÃù
.
qid
 = 
	`ıu_to_Ë16
(qid);

451 
cmd
.
cÚÃù
.
sqsize
 = 
	`ıu_to_Ë16
(
ù¾
->sqsize);

453 
d©a
 = 
	`kz®loc
((*d©a), 
GFP_KERNEL
);

454 ià(!
d©a
)

455  -
ENOMEM
;

457 
	`memıy
(&
d©a
->
ho¡id
, &
ù¾
->
İts
->
ho¡
->
id
, (
uuid_be
));

458 
d©a
->
úid
 = 
	`ıu_to_Ë16
(
ù¾
->cntlid);

459 
	`¡ºıy
(
d©a
->
subsy¢qn
, 
ù¾
->
İts
->subsy¢qn, 
NVMF_NQN_SIZE
);

460 
	`¡ºıy
(
d©a
->
ho¡nqn
, 
ù¾
->
İts
->
ho¡
->
nqn
, 
NVMF_NQN_SIZE
);

462 
»t
 = 
	`__nvme_subm™_sync_cmd
(
ù¾
->
cÚÃù_q
, &
cmd
, &
cqe
,

463 
d©a
, (*d©a), 0, 
qid
, 1,

464 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
);

465 ià(
»t
) {

466 
	`nvmf_log_cÚÃù_”rÜ
(
ù¾
, 
»t
, 
	`Ë32_to_ıu
(
cqe
.
»suÉ
),

467 &
cmd
, 
d©a
);

469 
	`kä“
(
d©a
);

470  
»t
;

471 
	}
}

472 
EXPORT_SYMBOL_GPL
(
nvmf_cÚÃù_io_queue
);

483 
	$nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

485 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

486 
	`li¡_add_
(&
İs
->
’Œy
, &
nvmf_Œª¥Üts
);

487 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

488 
	}
}

489 
EXPORT_SYMBOL_GPL
(
nvmf_»gi¡”_Œª¥Üt
);

500 
	$nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
)

502 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

503 
	`li¡_d–
(&
İs
->
’Œy
);

504 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

505 
	}
}

506 
EXPORT_SYMBOL_GPL
(
nvmf_uÄegi¡”_Œª¥Üt
);

508 
nvmf_Œª¥Üt_İs
 *
	$nvmf_lookup_Œª¥Üt
(

509 
nvmf_ù¾_İtiÚs
 *
İts
)

511 
nvmf_Œª¥Üt_İs
 *
İs
;

513 
	`lockd•_as£¹_h–d
(&
nvmf_Œª¥Üts_mu‹x
);

515 
	`li¡_fÜ_—ch_’Œy
(
İs
, &
nvmf_Œª¥Üts
, 
’Œy
) {

516 ià(
	`¡rcmp
(
İs
->
Çme
, 
İts
->
Œª¥Üt
) == 0)

517  
İs
;

520  
NULL
;

521 
	}
}

523 cÚ¡ 
m©ch_bË_t
 
	gİt_tok’s
 = {

524 { 
NVMF_OPT_TRANSPORT
, "transport=%s" },

525 { 
NVMF_OPT_TRADDR
, "traddr=%s" },

526 { 
NVMF_OPT_TRSVCID
, "trsvcid=%s" },

527 { 
NVMF_OPT_NQN
, "nqn=%s" },

528 { 
NVMF_OPT_QUEUE_SIZE
, "queue_size=%d" },

529 { 
NVMF_OPT_NR_IO_QUEUES
, "nr_io_queues=%d" },

530 { 
NVMF_OPT_RECONNECT_DELAY
, "reconnect_delay=%d" },

531 { 
NVMF_OPT_KATO
, "keep_alive_tmo=%d" },

532 { 
NVMF_OPT_HOSTNQN
, "hostnqn=%s" },

533 { 
NVMF_OPT_HOST_TRADDR
, "host_traddr=%s" },

534 { 
NVMF_OPT_ERR
, 
NULL
 }

537 
	$nvmf_·r£_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
,

538 cÚ¡ *
buf
)

540 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

541 *
İtiÚs
, *
o
, *
p
;

542 
tok’
, 
»t
 = 0;

543 
size_t
 
nqÆ’
 = 0;

546 
İts
->
queue_size
 = 
NVMF_DEF_QUEUE_SIZE
;

547 
İts
->
Ä_io_queues
 = 
	`num_Úlše_ıus
();

548 
İts
->
»cÚÃù_d–ay
 = 
NVMF_DEF_RECONNECT_DELAY
;

550 
İtiÚs
 = 
o
 = 
	`k¡rdup
(
buf
, 
GFP_KERNEL
);

551 ià(!
İtiÚs
)

552  -
ENOMEM
;

554 (
p
 = 
	`¡r£p
(&
o
, ",\n")è!ğ
NULL
) {

555 ià(!*
p
)

558 
tok’
 = 
	`m©ch_tok’
(
p
, 
İt_tok’s
, 
¬gs
);

559 
İts
->
mask
 |ğ
tok’
;

560 
tok’
) {

561 
NVMF_OPT_TRANSPORT
:

562 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

563 ià(!
p
) {

564 
»t
 = -
ENOMEM
;

565 
out
;

567 
İts
->
Œª¥Üt
 = 
p
;

569 
NVMF_OPT_NQN
:

570 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

571 ià(!
p
) {

572 
»t
 = -
ENOMEM
;

573 
out
;

575 
İts
->
subsy¢qn
 = 
p
;

576 
nqÆ’
 = 
	`¡¾’
(
İts
->
subsy¢qn
);

577 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

578 
	`´_”r
("%s‚eedso be < %d bytes\n",

579 
İts
->
subsy¢qn
, 
NVMF_NQN_SIZE
);

580 
»t
 = -
EINVAL
;

581 
out
;

583 
İts
->
discov”y_nqn
 =

584 !(
	`¡rcmp
(
İts
->
subsy¢qn
,

585 
NVME_DISC_SUBSYS_NAME
));

586 ià(
İts
->
discov”y_nqn
)

587 
İts
->
Ä_io_queues
 = 0;

589 
NVMF_OPT_TRADDR
:

590 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

591 ià(!
p
) {

592 
»t
 = -
ENOMEM
;

593 
out
;

595 
İts
->
Œaddr
 = 
p
;

597 
NVMF_OPT_TRSVCID
:

598 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

599 ià(!
p
) {

600 
»t
 = -
ENOMEM
;

601 
out
;

603 
İts
->
Œsvcid
 = 
p
;

605 
NVMF_OPT_QUEUE_SIZE
:

606 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

607 
»t
 = -
EINVAL
;

608 
out
;

610 ià(
tok’
 < 
NVMF_MIN_QUEUE_SIZE
 ||

611 
tok’
 > 
NVMF_MAX_QUEUE_SIZE
) {

612 
	`´_”r
("Inv®id queue_siz%d\n", 
tok’
);

613 
»t
 = -
EINVAL
;

614 
out
;

616 
İts
->
queue_size
 = 
tok’
;

618 
NVMF_OPT_NR_IO_QUEUES
:

619 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

620 
»t
 = -
EINVAL
;

621 
out
;

623 ià(
tok’
 <= 0) {

624 
	`´_”r
("Inv®id‚umb” oàIOQ %d\n", 
tok’
);

625 
»t
 = -
EINVAL
;

626 
out
;

628 
İts
->
Ä_io_queues
 = 
	`mš_t
(,

629 
	`num_Úlše_ıus
(), 
tok’
);

631 
NVMF_OPT_KATO
:

632 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

633 
»t
 = -
EINVAL
;

634 
out
;

637 ià(
İts
->
discov”y_nqn
) {

638 
	`´_”r
("Discovery controllers cannot‡ccept keep_alive_tmo != 0\n");

639 
»t
 = -
EINVAL
;

640 
out
;

643 ià(
tok’
 < 0) {

644 
	`´_”r
("Inv®id k“p_®ive_tmØ%d\n", 
tok’
);

645 
»t
 = -
EINVAL
;

646 
out
;

647 } ià(
tok’
 == 0) {

649 
	`´_w¬n
("keep_alive_tmo 0 won'tƒxecute keep‡lives!!!\n");

651 
İts
->
k©o
 = 
tok’
;

653 
NVMF_OPT_HOSTNQN
:

654 ià(
İts
->
ho¡
) {

655 
	`´_”r
("hostnqn‡lready user-assigned: %s\n",

656 
İts
->
ho¡
->
nqn
);

657 
»t
 = -
EADDRINUSE
;

658 
out
;

660 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

661 ià(!
p
) {

662 
»t
 = -
ENOMEM
;

663 
out
;

665 
nqÆ’
 = 
	`¡¾’
(
p
);

666 ià(
nqÆ’
 >ğ
NVMF_NQN_SIZE
) {

667 
	`´_”r
("%s‚eedso be < %d bytes\n",

668 
p
, 
NVMF_NQN_SIZE
);

669 
»t
 = -
EINVAL
;

670 
out
;

672 
İts
->
ho¡
 = 
	`nvmf_ho¡_add
(
p
);

673 ià(!
İts
->
ho¡
) {

674 
»t
 = -
ENOMEM
;

675 
out
;

678 
NVMF_OPT_RECONNECT_DELAY
:

679 ià(
	`m©ch_št
(
¬gs
, &
tok’
)) {

680 
»t
 = -
EINVAL
;

681 
out
;

683 ià(
tok’
 <= 0) {

684 
	`´_”r
("Inv®id„ecÚÃù_d–ay %d\n", 
tok’
);

685 
»t
 = -
EINVAL
;

686 
out
;

688 
İts
->
»cÚÃù_d–ay
 = 
tok’
;

690 
NVMF_OPT_HOST_TRADDR
:

691 
p
 = 
	`m©ch_¡rdup
(
¬gs
);

692 ià(!
p
) {

693 
»t
 = -
ENOMEM
;

694 
out
;

696 
İts
->
ho¡_Œaddr
 = 
p
;

699 
	`´_w¬n
("unknown…arameter or missing value '%s' in ctrl creation„equest\n",

700 
p
);

701 
»t
 = -
EINVAL
;

702 
out
;

706 ià(!
İts
->
ho¡
) {

707 
	`k»f_g‘
(&
nvmf_deçuÉ_ho¡
->
»f
);

708 
İts
->
ho¡
 = 
nvmf_deçuÉ_ho¡
;

711 
out
:

712 ià(!
İts
->
discov”y_nqn
 && !İts->
k©o
)

713 
İts
->
k©o
 = 
NVME_DEFAULT_KATO
;

714 
	`kä“
(
İtiÚs
);

715  
»t
;

716 
	}
}

718 
	$nvmf_check_»quœed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

719 
»quœed_İts
)

721 ià((
İts
->
mask
 & 
»quœed_İts
) !=„equired_opts) {

722 
i
;

724 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

725 ià((
İt_tok’s
[
i
].
tok’
 & 
»quœed_İts
) &&

726 !(
İt_tok’s
[
i
].
tok’
 & 
İts
->
mask
)) {

727 
	`´_w¬n
("missing…arameter '%s'\n",

728 
İt_tok’s
[
i
].
·‰”n
);

732  -
EINVAL
;

736 
	}
}

738 
	$nvmf_check_®lowed_İts
(
nvmf_ù¾_İtiÚs
 *
İts
,

739 
®lowed_İts
)

741 ià(
İts
->
mask
 & ~
®lowed_İts
) {

742 
i
;

744 
i
 = 0; i < 
	`ARRAY_SIZE
(
İt_tok’s
); i++) {

745 ià(
İt_tok’s
[
i
].
tok’
 & ~
®lowed_İts
) {

746 
	`´_w¬n
("invalid…arameter '%s'\n",

747 
İt_tok’s
[
i
].
·‰”n
);

751  -
EINVAL
;

755 
	}
}

757 
	$nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
)

759 
	`nvmf_ho¡_put
(
İts
->
ho¡
);

760 
	`kä“
(
İts
->
Œª¥Üt
);

761 
	`kä“
(
İts
->
Œaddr
);

762 
	`kä“
(
İts
->
Œsvcid
);

763 
	`kä“
(
İts
->
subsy¢qn
);

764 
	`kä“
(
İts
->
ho¡_Œaddr
);

765 
	`kä“
(
İts
);

766 
	}
}

767 
EXPORT_SYMBOL_GPL
(
nvmf_ä“_İtiÚs
);

769 
	#NVMF_REQUIRED_OPTS
 (
NVMF_OPT_TRANSPORT
 | 
NVMF_OPT_NQN
)

	)

770 
	#NVMF_ALLOWED_OPTS
 (
NVMF_OPT_QUEUE_SIZE
 | 
NVMF_OPT_NR_IO_QUEUES
 | \

771 
NVMF_OPT_KATO
 | 
NVMF_OPT_HOSTNQN
)

	)

773 
nvme_ù¾
 *

774 
	$nvmf_ü—‹_ù¾
(
deviû
 *
dev
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

776 
nvmf_ù¾_İtiÚs
 *
İts
;

777 
nvmf_Œª¥Üt_İs
 *
İs
;

778 
nvme_ù¾
 *
ù¾
;

779 
»t
;

781 
İts
 = 
	`kz®loc
((*İts), 
GFP_KERNEL
);

782 ià(!
İts
)

783  
	`ERR_PTR
(-
ENOMEM
);

785 
»t
 = 
	`nvmf_·r£_İtiÚs
(
İts
, 
buf
);

786 ià(
»t
)

787 
out_ä“_İts
;

794 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
NVMF_REQUIRED_OPTS
);

795 ià(
»t
)

796 
out_ä“_İts
;

797 
İts
->
mask
 &ğ~
NVMF_REQUIRED_OPTS
;

799 
	`mu‹x_lock
(&
nvmf_Œª¥Üts_mu‹x
);

800 
İs
 = 
	`nvmf_lookup_Œª¥Üt
(
İts
);

801 ià(!
İs
) {

802 
	`´_šfo
("no handler found forransport %s.\n",

803 
İts
->
Œª¥Üt
);

804 
»t
 = -
EINVAL
;

805 
out_uÆock
;

808 
»t
 = 
	`nvmf_check_»quœed_İts
(
İts
, 
İs
->
»quœed_İts
);

809 ià(
»t
)

810 
out_uÆock
;

811 
»t
 = 
	`nvmf_check_®lowed_İts
(
İts
, 
NVMF_ALLOWED_OPTS
 |

812 
İs
->
®lowed_İts
 | ops->
»quœed_İts
);

813 ià(
»t
)

814 
out_uÆock
;

816 
ù¾
 = 
İs
->
	`ü—‹_ù¾
(
dev
, 
İts
);

817 ià(
	`IS_ERR
(
ù¾
)) {

818 
»t
 = 
	`PTR_ERR
(
ù¾
);

819 
out_uÆock
;

822 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

823  
ù¾
;

825 
out_uÆock
:

826 
	`mu‹x_uÆock
(&
nvmf_Œª¥Üts_mu‹x
);

827 
out_ä“_İts
:

828 
	`nvmf_ho¡_put
(
İts
->
ho¡
);

829 
	`kä“
(
İts
);

830  
	`ERR_PTR
(
»t
);

831 
	}
}

833 
şass
 *
	gnvmf_şass
;

834 
deviû
 *
	gnvmf_deviû
;

835 
DEFINE_MUTEX
(
nvmf_dev_mu‹x
);

837 
ssize_t
 
	$nvmf_dev_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
ubuf
,

838 
size_t
 
couÁ
, 
loff_t
 *
pos
)

840 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

841 
nvme_ù¾
 *
ù¾
;

842 cÚ¡ *
buf
;

843 
»t
 = 0;

845 ià(
couÁ
 > 
PAGE_SIZE
)

846  -
ENOMEM
;

848 
buf
 = 
	`memdup_u£r_nul
(
ubuf
, 
couÁ
);

849 ià(
	`IS_ERR
(
buf
))

850  
	`PTR_ERR
(
buf
);

852 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

853 ià(
£q_fe
->
´iv©e
) {

854 
»t
 = -
EINVAL
;

855 
out_uÆock
;

858 
ù¾
 = 
	`nvmf_ü—‹_ù¾
(
nvmf_deviû
, 
buf
, 
couÁ
);

859 ià(
	`IS_ERR
(
ù¾
)) {

860 
»t
 = 
	`PTR_ERR
(
ù¾
);

861 
out_uÆock
;

864 
£q_fe
->
´iv©e
 = 
ù¾
;

866 
out_uÆock
:

867 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

868 
	`kä“
(
buf
);

869  
»t
 ?„‘ : 
couÁ
;

870 
	}
}

872 
	$nvmf_dev_show
(
£q_fe
 *£q_fe, *
´iv©e
)

874 
nvme_ù¾
 *
ù¾
;

875 
»t
 = 0;

877 
	`mu‹x_lock
(&
nvmf_dev_mu‹x
);

878 
ù¾
 = 
£q_fe
->
´iv©e
;

879 ià(!
ù¾
) {

880 
»t
 = -
EINVAL
;

881 
out_uÆock
;

884 
	`£q_´štf
(
£q_fe
, "instance=%d,cntlid=%d\n",

885 
ù¾
->
š¡ªû
, cŒl->
úid
);

887 
out_uÆock
:

888 
	`mu‹x_uÆock
(&
nvmf_dev_mu‹x
);

889  
»t
;

890 
	}
}

892 
	$nvmf_dev_İ’
(
šode
 *šode, 
fe
 *file)

898 
fe
->
´iv©e_d©a
 = 
NULL
;

899  
	`sšgË_İ’
(
fe
, 
nvmf_dev_show
, 
NULL
);

900 
	}
}

902 
	$nvmf_dev_»Ëa£
(
šode
 *šode, 
fe
 *file)

904 
£q_fe
 *£q_fğ
fe
->
´iv©e_d©a
;

905 
nvme_ù¾
 *
ù¾
 = 
£q_fe
->
´iv©e
;

907 ià(
ù¾
)

908 
	`nvme_put_ù¾
(
ù¾
);

909  
	`sšgË_»Ëa£
(
šode
, 
fe
);

910 
	}
}

912 cÚ¡ 
fe_İ”©iÚs
 
	gnvmf_dev_fİs
 = {

913 .
owÃr
 = 
THIS_MODULE
,

914 .
	gwr™e
 = 
nvmf_dev_wr™e
,

915 .
	g»ad
 = 
£q_»ad
,

916 .
	gİ’
 = 
nvmf_dev_İ’
,

917 .
	g»Ëa£
 = 
nvmf_dev_»Ëa£
,

920 
miscdeviû
 
	gnvmf_misc
 = {

921 .
mšÜ
 = 
MISC_DYNAMIC_MINOR
,

922 .
	gÇme
 = "nvme-fabrics",

923 .
	gfİs
 = &
nvmf_dev_fİs
,

926 
__š™
 
	$nvmf_š™
()

928 
»t
;

930 
nvmf_deçuÉ_ho¡
 = 
	`nvmf_ho¡_deçuÉ
();

931 ià(!
nvmf_deçuÉ_ho¡
)

932  -
ENOMEM
;

934 
nvmf_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "nvme-fabrics");

935 ià(
	`IS_ERR
(
nvmf_şass
)) {

936 
	`´_”r
("couldn't„egister class‚vme-fabrics\n");

937 
»t
 = 
	`PTR_ERR
(
nvmf_şass
);

938 
out_ä“_ho¡
;

941 
nvmf_deviû
 =

942 
	`deviû_ü—‹
(
nvmf_şass
, 
NULL
, 
	`MKDEV
(0, 0), NULL, "ctl");

943 ià(
	`IS_ERR
(
nvmf_deviû
)) {

944 
	`´_”r
("couldn't create‚vme-fabris device!\n");

945 
»t
 = 
	`PTR_ERR
(
nvmf_deviû
);

946 
out_de¡roy_şass
;

949 
»t
 = 
	`misc_»gi¡”
(&
nvmf_misc
);

950 ià(
»t
) {

951 
	`´_”r
("couldn'ˆ»gi¡” misødeviû: %d\n", 
»t
);

952 
out_de¡roy_deviû
;

957 
out_de¡roy_deviû
:

958 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

959 
out_de¡roy_şass
:

960 
	`şass_de¡roy
(
nvmf_şass
);

961 
out_ä“_ho¡
:

962 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

963  
»t
;

964 
	}
}

966 
__ex™
 
	$nvmf_ex™
()

968 
	`misc_d”egi¡”
(&
nvmf_misc
);

969 
	`deviû_de¡roy
(
nvmf_şass
, 
	`MKDEV
(0, 0));

970 
	`şass_de¡roy
(
nvmf_şass
);

971 
	`nvmf_ho¡_put
(
nvmf_deçuÉ_ho¡
);

973 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_commªd
) != 64);

974 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_g‘_commªd
) != 64);

975 
	`BUILD_BUG_ON
((
nvmf_´İ”ty_£t_commªd
) != 64);

976 
	`BUILD_BUG_ON
((
nvmf_cÚÃù_d©a
) != 1024);

977 
	}
}

979 
MODULE_LICENSE
("GPL v2");

981 
moduË_š™
(
nvmf_š™
);

982 
moduË_ex™
(
nvmf_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/fabrics.h

14 #iâdeà
_NVME_FABRICS_H


15 
	#_NVME_FABRICS_H
 1

	)

17 
	~<lšux/š.h
>

18 
	~<lšux/š‘.h
>

20 
	#NVMF_MIN_QUEUE_SIZE
 16

	)

21 
	#NVMF_MAX_QUEUE_SIZE
 1024

	)

22 
	#NVMF_DEF_QUEUE_SIZE
 128

	)

23 
	#NVMF_DEF_RECONNECT_DELAY
 10

	)

33 
	snvmf_ho¡
 {

34 
k»f
 
	m»f
;

35 
li¡_h—d
 
	mli¡
;

36 
	mnqn
[
NVMF_NQN_SIZE
];

37 
uuid_be
 
	mid
;

44 
	mNVMF_OPT_ERR
 = 0,

45 
	mNVMF_OPT_TRANSPORT
 = 1 << 0,

46 
	mNVMF_OPT_NQN
 = 1 << 1,

47 
	mNVMF_OPT_TRADDR
 = 1 << 2,

48 
	mNVMF_OPT_TRSVCID
 = 1 << 3,

49 
	mNVMF_OPT_QUEUE_SIZE
 = 1 << 4,

50 
	mNVMF_OPT_NR_IO_QUEUES
 = 1 << 5,

51 
	mNVMF_OPT_TL_RETRY_COUNT
 = 1 << 6,

52 
	mNVMF_OPT_KATO
 = 1 << 7,

53 
	mNVMF_OPT_HOSTNQN
 = 1 << 8,

54 
	mNVMF_OPT_RECONNECT_DELAY
 = 1 << 9,

55 
	mNVMF_OPT_HOST_TRADDR
 = 1 << 10,

81 
	snvmf_ù¾_İtiÚs
 {

82 
	mmask
;

83 *
	mŒª¥Üt
;

84 *
	msubsy¢qn
;

85 *
	mŒaddr
;

86 *
	mŒsvcid
;

87 *
	mho¡_Œaddr
;

88 
size_t
 
	mqueue_size
;

89 
	mÄ_io_queues
;

90 
	m»cÚÃù_d–ay
;

91 
boŞ
 
	mdiscov”y_nqn
;

92 
	mk©o
;

93 
nvmf_ho¡
 *
	mho¡
;

117 
	snvmf_Œª¥Üt_İs
 {

118 
li¡_h—d
 
	m’Œy
;

119 cÚ¡ *
	mÇme
;

120 
	m»quœed_İts
;

121 
	m®lowed_İts
;

122 
	mnvme_ù¾
 *(*
	mü—‹_ù¾
)(
deviû
 *
	mdev
,

123 
nvmf_ù¾_İtiÚs
 *
	mİts
);

126 
nvmf_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
);

127 
nvmf_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
);

128 
nvmf_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
);

129 
nvmf_cÚÃù_admš_queue
(
nvme_ù¾
 *
ù¾
);

130 
nvmf_cÚÃù_io_queue
(
nvme_ù¾
 *
ù¾
, 
u16
 
qid
);

131 
nvmf_»gi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

132 
nvmf_uÄegi¡”_Œª¥Üt
(
nvmf_Œª¥Üt_İs
 *
İs
);

133 
nvmf_ä“_İtiÚs
(
nvmf_ù¾_İtiÚs
 *
İts
);

134 cÚ¡ *
nvmf_g‘_subsy¢qn
(
nvme_ù¾
 *
ù¾
);

135 
nvmf_g‘_add»ss
(
nvme_ù¾
 *
ù¾
, *
buf
, 
size
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/lightnvm.c

23 
	~"nvme.h
"

24 
	~"lšux_nvme.h
"

25 
	~<lšux/b™İs.h
>

26 
	~<lšux/lighŠvm.h
>

27 
	~<lšux/vm®loc.h
>

29 
	envme_nvm_admš_İcode
 {

30 
	mnvme_nvm_admš_id’t™y
 = 0xe2,

31 
	mnvme_nvm_admš_g‘_l2p_tbl
 = 0xea,

32 
	mnvme_nvm_admš_g‘_bb_tbl
 = 0xf2,

33 
	mnvme_nvm_admš_£t_bb_tbl
 = 0xf1,

36 
	snvme_nvm_hb_rw
 {

37 
__u8
 
	mİcode
;

38 
__u8
 
	mæags
;

39 
__u16
 
	mcommªd_id
;

40 
__Ë32
 
	mnsid
;

41 
__u64
 
	mrsvd2
;

42 
__Ë64
 
	mm‘ad©a
;

43 
__Ë64
 
	m´p1
;

44 
__Ë64
 
	m´p2
;

45 
__Ë64
 
	m¥ba
;

46 
__Ë16
 
	mËngth
;

47 
__Ë16
 
	mcÚŒŞ
;

48 
__Ë32
 
	mdsmgmt
;

49 
__Ë64
 
	m¦ba
;

52 
	snvme_nvm_ph_rw
 {

53 
__u8
 
	mİcode
;

54 
__u8
 
	mæags
;

55 
__u16
 
	mcommªd_id
;

56 
__Ë32
 
	mnsid
;

57 
__u64
 
	mrsvd2
;

58 
__Ë64
 
	mm‘ad©a
;

59 
__Ë64
 
	m´p1
;

60 
__Ë64
 
	m´p2
;

61 
__Ë64
 
	m¥ba
;

62 
__Ë16
 
	mËngth
;

63 
__Ë16
 
	mcÚŒŞ
;

64 
__Ë32
 
	mdsmgmt
;

65 
__Ë64
 
	m»sv
;

68 
	snvme_nvm_id’t™y
 {

69 
__u8
 
	mİcode
;

70 
__u8
 
	mæags
;

71 
__u16
 
	mcommªd_id
;

72 
__Ë32
 
	mnsid
;

73 
__u64
 
	mrsvd
[2];

74 
__Ë64
 
	m´p1
;

75 
__Ë64
 
	m´p2
;

76 
__Ë32
 
	mchÆ_off
;

77 
__u32
 
	mrsvd11
[5];

80 
	snvme_nvm_l2±bl
 {

81 
__u8
 
	mİcode
;

82 
__u8
 
	mæags
;

83 
__u16
 
	mcommªd_id
;

84 
__Ë32
 
	mnsid
;

85 
__Ë32
 
	mcdw2
[4];

86 
__Ë64
 
	m´p1
;

87 
__Ë64
 
	m´p2
;

88 
__Ë64
 
	m¦ba
;

89 
__Ë32
 
	mÆb
;

90 
__Ë16
 
	mcdw14
[6];

93 
	snvme_nvm_g‘bbtbl
 {

94 
__u8
 
	mİcode
;

95 
__u8
 
	mæags
;

96 
__u16
 
	mcommªd_id
;

97 
__Ë32
 
	mnsid
;

98 
__u64
 
	mrsvd
[2];

99 
__Ë64
 
	m´p1
;

100 
__Ë64
 
	m´p2
;

101 
__Ë64
 
	m¥ba
;

102 
__u32
 
	mrsvd4
[4];

105 
	snvme_nvm_£tbbtbl
 {

106 
__u8
 
	mİcode
;

107 
__u8
 
	mæags
;

108 
__u16
 
	mcommªd_id
;

109 
__Ë32
 
	mnsid
;

110 
__Ë64
 
	mrsvd
[2];

111 
__Ë64
 
	m´p1
;

112 
__Ë64
 
	m´p2
;

113 
__Ë64
 
	m¥ba
;

114 
__Ë16
 
	mÆb
;

115 
__u8
 
	mv®ue
;

116 
__u8
 
	mrsvd3
;

117 
__u32
 
	mrsvd4
[3];

120 
	snvme_nvm_”a£_blk
 {

121 
__u8
 
	mİcode
;

122 
__u8
 
	mæags
;

123 
__u16
 
	mcommªd_id
;

124 
__Ë32
 
	mnsid
;

125 
__u64
 
	mrsvd
[2];

126 
__Ë64
 
	m´p1
;

127 
__Ë64
 
	m´p2
;

128 
__Ë64
 
	m¥ba
;

129 
__Ë16
 
	mËngth
;

130 
__Ë16
 
	mcÚŒŞ
;

131 
__Ë32
 
	mdsmgmt
;

132 
__Ë64
 
	m»sv
;

135 
	snvme_nvm_commªd
 {

137 
nvme_commÚ_commªd
 
	mcommÚ
;

138 
nvme_nvm_id’t™y
 
	mid’t™y
;

139 
nvme_nvm_hb_rw
 
	mhb_rw
;

140 
nvme_nvm_ph_rw
 
	mph_rw
;

141 
nvme_nvm_l2±bl
 
	ml2p
;

142 
nvme_nvm_g‘bbtbl
 
	mg‘_bb
;

143 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

144 
nvme_nvm_”a£_blk
 
	m”a£
;

148 
	snvme_nvm_com¶‘iÚ
 {

149 
__Ë64
 
	m»suÉ
;

150 
__Ë16
 
	msq_h—d
;

151 
__Ë16
 
	msq_id
;

152 
__u16
 
	mcommªd_id
;

153 
__Ë16
 
	m¡©us
;

156 
	#NVME_NVM_LP_MLC_PAIRS
 886

	)

157 
	snvme_nvm_Í_mlc
 {

158 
__Ë16
 
	mnum_·œs
;

159 
__u8
 
	m·œs
[
NVME_NVM_LP_MLC_PAIRS
];

162 
	snvme_nvm_Í_tbl
 {

163 
__u8
 
	mid
[8];

164 
nvme_nvm_Í_mlc
 
	mmlc
;

167 
	snvme_nvm_id_group
 {

168 
__u8
 
	mmty³
;

169 
__u8
 
	mfmty³
;

170 
__Ë16
 
	m»s16
;

171 
__u8
 
	mnum_ch
;

172 
__u8
 
	mnum_lun
;

173 
__u8
 
	mnum_¶n
;

174 
__u8
 
	mrsvd1
;

175 
__Ë16
 
	mnum_blk
;

176 
__Ë16
 
	mnum_pg
;

177 
__Ë16
 
	måg_sz
;

178 
__Ë16
 
	mc£cs
;

179 
__Ë16
 
	msos
;

180 
__Ë16
 
	mrsvd2
;

181 
__Ë32
 
	mŒdt
;

182 
__Ë32
 
	mŒdm
;

183 
__Ë32
 
	m¹
;

184 
__Ë32
 
	mrm
;

185 
__Ë32
 
	mtb‘
;

186 
__Ë32
 
	mtbem
;

187 
__Ë32
 
	mmpos
;

188 
__Ë32
 
	mmcÿp
;

189 
__Ë16
 
	mı¬
;

190 
__u8
 
	m»£rved
[10];

191 
nvme_nvm_Í_tbl
 
	mÍtbl
;

192 } 
	g__·cked
;

194 
	snvme_nvm_addr_fÜm©
 {

195 
__u8
 
	mch_off£t
;

196 
__u8
 
	mch_Ën
;

197 
__u8
 
	mlun_off£t
;

198 
__u8
 
	mlun_Ën
;

199 
__u8
 
	m¶n_off£t
;

200 
__u8
 
	m¶n_Ën
;

201 
__u8
 
	mblk_off£t
;

202 
__u8
 
	mblk_Ën
;

203 
__u8
 
	mpg_off£t
;

204 
__u8
 
	mpg_Ën
;

205 
__u8
 
	m£ù_off£t
;

206 
__u8
 
	m£ù_Ën
;

207 
__u8
 
	m»s
[4];

208 } 
	g__·cked
;

210 
	snvme_nvm_id
 {

211 
__u8
 
	mv”_id
;

212 
__u8
 
	mvmÁ
;

213 
__u8
 
	mcg½s
;

214 
__u8
 
	m»s
;

215 
__Ë32
 
	mÿp
;

216 
__Ë32
 
	mdom
;

217 
nvme_nvm_addr_fÜm©
 
	mµaf
;

218 
__u8
 
	m»sv
[228];

219 
nvme_nvm_id_group
 
	mgroups
[4];

220 } 
	g__·cked
;

222 
	snvme_nvm_bb_tbl
 {

223 
__u8
 
	mtblid
[4];

224 
__Ë16
 
	mv”id
;

225 
__Ë16
 
	m»vid
;

226 
__Ë32
 
	mrvsd1
;

227 
__Ë32
 
	mtblks
;

228 
__Ë32
 
	mtçù
;

229 
__Ë32
 
	mtgrown
;

230 
__Ë32
 
	mtd»sv
;

231 
__Ë32
 
	mth»sv
;

232 
__Ë32
 
	mrsvd2
[8];

233 
__u8
 
	mblk
[0];

239 
šlše
 
	$_nvme_nvm_check_size
()

241 
	`BUILD_BUG_ON
((
nvme_nvm_id’t™y
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_nvm_hb_rw
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

244 
	`BUILD_BUG_ON
((
nvme_nvm_g‘bbtbl
) != 64);

245 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

246 
	`BUILD_BUG_ON
((
nvme_nvm_l2±bl
) != 64);

247 
	`BUILD_BUG_ON
((
nvme_nvm_”a£_blk
) != 64);

248 
	`BUILD_BUG_ON
((
nvme_nvm_id_group
) != 960);

249 
	`BUILD_BUG_ON
((
nvme_nvm_addr_fÜm©
) != 128);

250 
	`BUILD_BUG_ON
((
nvme_nvm_id
) != 4096);

251 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 512);

252 
	}
}

254 
	$š™_g½s
(
nvm_id
 *nvm_id, 
nvme_nvm_id
 *nvme_nvm_id)

256 
nvme_nvm_id_group
 *
¤c
;

257 
nvm_id_group
 *
d¡
;

258 
i
, 
’d
;

260 
’d
 = 
	`mš_t
(
u32
, 4, 
nvm_id
->
cg½s
);

262 
i
 = 0; i < 
’d
; i++) {

263 
¤c
 = &
nvme_nvm_id
->
groups
[
i
];

264 
d¡
 = &
nvm_id
->
groups
[
i
];

266 
d¡
->
mty³
 = 
¤c
->mtype;

267 
d¡
->
fmty³
 = 
¤c
->fmtype;

268 
d¡
->
num_ch
 = 
¤c
->num_ch;

269 
d¡
->
num_lun
 = 
¤c
->num_lun;

270 
d¡
->
num_¶n
 = 
¤c
->num_pln;

272 
d¡
->
num_pg
 = 
	`Ë16_to_ıu
(
¤c
->num_pg);

273 
d¡
->
num_blk
 = 
	`Ë16_to_ıu
(
¤c
->num_blk);

274 
d¡
->
åg_sz
 = 
	`Ë16_to_ıu
(
¤c
->fpg_sz);

275 
d¡
->
c£cs
 = 
	`Ë16_to_ıu
(
¤c
->csecs);

276 
d¡
->
sos
 = 
	`Ë16_to_ıu
(
¤c
->sos);

278 
d¡
->
Œdt
 = 
	`Ë32_to_ıu
(
¤c
->trdt);

279 
d¡
->
Œdm
 = 
	`Ë32_to_ıu
(
¤c
->trdm);

280 
d¡
->
¹
 = 
	`Ë32_to_ıu
(
¤c
->tprt);

281 
d¡
->
rm
 = 
	`Ë32_to_ıu
(
¤c
->tprm);

282 
d¡
->
tb‘
 = 
	`Ë32_to_ıu
(
¤c
->tbet);

283 
d¡
->
tbem
 = 
	`Ë32_to_ıu
(
¤c
->tbem);

284 
d¡
->
mpos
 = 
	`Ë32_to_ıu
(
¤c
->mpos);

285 
d¡
->
mcÿp
 = 
	`Ë32_to_ıu
(
¤c
->mccap);

287 
d¡
->
ı¬
 = 
	`Ë16_to_ıu
(
¤c
->cpar);

289 ià(
d¡
->
fmty³
 =ğ
NVM_ID_FMTYPE_MLC
) {

290 
	`memıy
(
d¡
->
Ítbl
.
id
, 
¤c
->lptbl.id, 8);

291 
d¡
->
Ítbl
.
mlc
.
num_·œs
 =

292 
	`Ë16_to_ıu
(
¤c
->
Ítbl
.
mlc
.
num_·œs
);

294 ià(
d¡
->
Ítbl
.
mlc
.
num_·œs
 > 
NVME_NVM_LP_MLC_PAIRS
) {

295 
	`´_”r
("nvm:‚umber of MLC…airs‚ot supported\n");

296  -
EINVAL
;

299 
	`memıy
(
d¡
->
Ítbl
.
mlc
.
·œs
, 
¤c
->lptbl.mlc.pairs,

300 
d¡
->
Ítbl
.
mlc
.
num_·œs
);

305 
	}
}

307 
	$nvme_nvm_id’t™y
(
nvm_dev
 *
nvmdev
, 
nvm_id
 *nvm_id)

309 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

310 
nvme_nvm_id
 *nvme_nvm_id;

311 
nvme_nvm_commªd
 
c
 = {};

312 
»t
;

314 
c
.
id’t™y
.
İcode
 = 
nvme_nvm_admš_id’t™y
;

315 
c
.
id’t™y
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

316 
c
.
id’t™y
.
chÆ_off
 = 0;

318 
nvme_nvm_id
 = 
	`km®loc
((nvme_nvm_id), 
GFP_KERNEL
);

319 ià(!
nvme_nvm_id
)

320  -
ENOMEM
;

322 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

323 
nvme_nvm_id
, (nvme_nvm_id));

324 ià(
»t
) {

325 
»t
 = -
EIO
;

326 
out
;

329 
nvm_id
->
v”_id
 = 
nvme_nvm_id
->ver_id;

330 
nvm_id
->
vmÁ
 = 
nvme_nvm_id
->vmnt;

331 
nvm_id
->
cg½s
 = 
nvme_nvm_id
->cgrps;

332 
nvm_id
->
ÿp
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->cap);

333 
nvm_id
->
dom
 = 
	`Ë32_to_ıu
(
nvme_nvm_id
->dom);

334 
	`memıy
(&
nvm_id
->
µaf
, &
nvme_nvm_id
->ppaf,

335 (
nvme_nvm_addr_fÜm©
));

337 
»t
 = 
	`š™_g½s
(
nvm_id
, 
nvme_nvm_id
);

338 
out
:

339 
	`kä“
(
nvme_nvm_id
);

340  
»t
;

341 
	}
}

343 
	$nvme_nvm_g‘_l2p_tbl
(
nvm_dev
 *
nvmdev
, 
u64
 
¦ba
, 
u32
 
Æb
,

344 
nvm_l2p_upd©e_â
 *
upd©e_l2p
, *
´iv
)

346 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

347 
nvme_nvm_commªd
 
c
 = {};

348 
u32
 
Ën
 = 
	`queue_max_hw_£ùÜs
(
ns
->
ù¾
->
admš_q
) << 9;

349 
u32
 
Æb_´_rq
 = 
Ën
 / (
u64
);

350 
u64
 
cmd_¦ba
 = 
¦ba
;

351 *
’Œ›s
;

352 
»t
 = 0;

354 
c
.
l2p
.
İcode
 = 
nvme_nvm_admš_g‘_l2p_tbl
;

355 
c
.
l2p
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

356 
’Œ›s
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

357 ià(!
’Œ›s
)

358  -
ENOMEM
;

360 
Æb
) {

361 
u32
 
cmd_Æb
 = 
	`mš
(
Æb_´_rq
, 
Æb
);

363 
c
.
l2p
.
¦ba
 = 
	`ıu_to_Ë64
(
cmd_¦ba
);

364 
c
.
l2p
.
Æb
 = 
	`ıu_to_Ë32
(
cmd_Æb
);

366 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
,

367 (
nvme_commªd
 *)&
c
, 
’Œ›s
, 
Ën
);

368 ià(
»t
) {

369 
	`dev_”r
(
ns
->
ù¾
->
deviû
,

370 "L2PabË¿nsã¸çed (%d)\n", 
»t
);

371 
»t
 = -
EIO
;

372 
out
;

375 ià(
	`upd©e_l2p
(
cmd_¦ba
, 
cmd_Æb
, 
’Œ›s
, 
´iv
)) {

376 
»t
 = -
EINTR
;

377 
out
;

380 
cmd_¦ba
 +ğ
cmd_Æb
;

381 
Æb
 -ğ
cmd_Æb
;

384 
out
:

385 
	`kä“
(
’Œ›s
);

386  
»t
;

387 
	}
}

389 
	$nvme_nvm_g‘_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

390 
u8
 *
blks
)

392 
»que¡_queue
 *
q
 = 
nvmdev
->q;

393 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

394 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

395 
nvme_nvm_commªd
 
c
 = {};

396 
nvme_nvm_bb_tbl
 *
bb_tbl
;

397 
Ä_blks
 = 
nvmdev
->
blks_³r_lun
 *‚vmdev->
¶ªe_mode
;

398 
tblsz
 = (
nvme_nvm_bb_tbl
è+ 
Ä_blks
;

399 
»t
 = 0;

401 
c
.
g‘_bb
.
İcode
 = 
nvme_nvm_admš_g‘_bb_tbl
;

402 
c
.
g‘_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

403 
c
.
g‘_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µa
.ppa);

405 
bb_tbl
 = 
	`kz®loc
(
tblsz
, 
GFP_KERNEL
);

406 ià(!
bb_tbl
)

407  -
ENOMEM
;

409 
»t
 = 
	`nvme_subm™_sync_cmd
(
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

410 
bb_tbl
, 
tblsz
);

411 ià(
»t
) {

412 
	`dev_”r
(
ù¾
->
deviû
, "g‘ bad blockabË faed (%d)\n", 
»t
);

413 
»t
 = -
EIO
;

414 
out
;

417 ià(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

418 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

419 
	`dev_”r
(
ù¾
->
deviû
, "bbt format mismatch\n");

420 
»t
 = -
EINVAL
;

421 
out
;

424 ià(
	`Ë16_to_ıu
(
bb_tbl
->
v”id
) != 1) {

425 
»t
 = -
EINVAL
;

426 
	`dev_”r
(
ù¾
->
deviû
, "bbt version‚ot supported\n");

427 
out
;

430 ià(
	`Ë32_to_ıu
(
bb_tbl
->
tblks
è!ğ
Ä_blks
) {

431 
»t
 = -
EINVAL
;

432 
	`dev_”r
(
ù¾
->
deviû
,

434 
	`Ë32_to_ıu
(
bb_tbl
->
tblks
), 
Ä_blks
);

435 
out
;

438 
	`memıy
(
blks
, 
bb_tbl
->
blk
, 
nvmdev
->
blks_³r_lun
 *‚vmdev->
¶ªe_mode
);

439 
out
:

440 
	`kä“
(
bb_tbl
);

441  
»t
;

442 
	}
}

444 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 *
µas
,

445 
Ä_µas
, 
ty³
)

447 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

448 
nvme_nvm_commªd
 
c
 = {};

449 
»t
 = 0;

451 
c
.
£t_bb
.
İcode
 = 
nvme_nvm_admš_£t_bb_tbl
;

452 
c
.
£t_bb
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

453 
c
.
£t_bb
.
¥ba
 = 
	`ıu_to_Ë64
(
µas
->
µa
);

454 
c
.
£t_bb
.
Æb
 = 
	`ıu_to_Ë16
(
Ä_µas
 - 1);

455 
c
.
£t_bb
.
v®ue
 = 
ty³
;

457 
»t
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, (
nvme_commªd
 *)&
c
,

458 
NULL
, 0);

459 ià(
»t
)

460 
	`dev_”r
(
ns
->
ù¾
->
deviû
, "set bad blockable failed (%d)\n",

461 
»t
);

462  
»t
;

463 
	}
}

465 
šlše
 
	$nvme_nvm_rqtocmd
(
»que¡
 *
rq
, 
nvm_rq
 *
rqd
,

466 
nvme_ns
 *
ns
, 
nvme_nvm_commªd
 *
c
)

468 
c
->
ph_rw
.
İcode
 = 
rqd
->opcode;

469 
c
->
ph_rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

470 
c
->
ph_rw
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

471 
c
->
ph_rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
rqd
->
dma_m‘a_li¡
);

472 
c
->
ph_rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(
rqd
->
æags
);

473 
c
->
ph_rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_µas
 - 1);

475 ià(
rqd
->
İcode
 =ğ
NVM_OP_HBWRITE
 ||„qd->İcod=ğ
NVM_OP_HBREAD
)

476 
c
->
hb_rw
.
¦ba
 = 
	`ıu_to_Ë64
(
	`nvme_block_Ä
(
ns
,

477 
rqd
->
bio
->
bi_™”
.
bi_£ùÜ
));

478 
	}
}

480 
	$nvme_nvm_’d_io
(
»que¡
 *
rq
, 
”rÜ
)

482 
nvm_rq
 *
rqd
 = 
rq
->
’d_io_d©a
;

483 
nvme_nvm_com¶‘iÚ
 *
cqe
 = 
rq
->
¥ecŸl
;

485 ià(
cqe
)

486 
rqd
->
µa_¡©us
 = 
	`Ë64_to_ıu
(
cqe
->
»suÉ
);

488 
	`nvm_’d_io
(
rqd
, 
”rÜ
);

490 
	`kä“
(
rq
->
cmd
);

491 
	`blk_mq_ä“_»que¡
(
rq
);

492 
	}
}

494 
	$nvme_nvm_subm™_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

496 
»que¡_queue
 *
q
 = 
dev
->q;

497 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

498 
»que¡
 *
rq
;

499 
bio
 *biØğ
rqd
->bio;

500 
nvme_nvm_commªd
 *
cmd
;

502 
rq
 = 
	`blk_mq_®loc_»que¡
(
q
, 
	`bio_d©a_dœ
(
bio
), 0);

503 ià(
	`IS_ERR
(
rq
))

504  -
ENOMEM
;

506 
cmd
 = 
	`kz®loc
((
nvme_nvm_commªd
) +

507 (
nvme_nvm_com¶‘iÚ
), 
GFP_KERNEL
);

508 ià(!
cmd
) {

509 
	`blk_mq_ä“_»que¡
(
rq
);

510  -
ENOMEM
;

513 
rq
->
cmd_ty³
 = 
REQ_TYPE_DRV_PRIV
;

514 
rq
->
iİrio
 = 
	`bio_´io
(
bio
);

516 ià(
	`bio_has_d©a
(
bio
))

517 
rq
->
Ä_phys_£gm’ts
 = 
	`bio_phys_£gm’ts
(
q
, 
bio
);

519 
rq
->
__d©a_Ën
 = 
bio
->
bi_™”
.
bi_size
;

520 
rq
->
bio
 =„q->
biÙa
 = bio;

522 
	`nvme_nvm_rqtocmd
(
rq
, 
rqd
, 
ns
, 
cmd
);

524 
rq
->
cmd
 = (*)cmd;

525 
rq
->
cmd_Ën
 = (
nvme_nvm_commªd
);

526 
rq
->
¥ecŸl
 = 
cmd
 + 1;

528 
rq
->
’d_io_d©a
 = 
rqd
;

530 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_’d_io
);

533 
	}
}

535 
	$nvme_nvm_”a£_block
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

537 
»que¡_queue
 *
q
 = 
dev
->q;

538 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

539 
nvme_nvm_commªd
 
c
 = {};

541 
c
.
”a£
.
İcode
 = 
NVM_OP_ERASE
;

542 
c
.
”a£
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

543 
c
.
”a£
.
¥ba
 = 
	`ıu_to_Ë64
(
rqd
->
µa_addr
.
µa
);

544 
c
.
”a£
.
Ëngth
 = 
	`ıu_to_Ë16
(
rqd
->
Ä_µas
 - 1);

546  
	`nvme_subm™_sync_cmd
(
q
, (
nvme_commªd
 *)&
c
, 
NULL
, 0);

547 
	}
}

549 *
	$nvme_nvm_ü—‹_dma_poŞ
(
nvm_dev
 *
nvmdev
, *
Çme
)

551 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

553  
	`dma_poŞ_ü—‹
(
Çme
, 
ns
->
ù¾
->
dev
, 
PAGE_SIZE
, PAGE_SIZE, 0);

554 
	}
}

556 
	$nvme_nvm_de¡roy_dma_poŞ
(*
poŞ
)

558 
dma_poŞ
 *dma_poŞ = 
poŞ
;

560 
	`dma_poŞ_de¡roy
(
dma_poŞ
);

561 
	}
}

563 *
	$nvme_nvm_dev_dma_®loc
(
nvm_dev
 *
dev
, *
poŞ
,

564 
gå_t
 
mem_æags
, 
dma_addr_t
 *
dma_hªdËr
)

566  
	`dma_poŞ_®loc
(
poŞ
, 
mem_æags
, 
dma_hªdËr
);

567 
	}
}

569 
	$nvme_nvm_dev_dma_ä“
(*
poŞ
, *
addr
,

570 
dma_addr_t
 
dma_hªdËr
)

572 
	`dma_poŞ_ä“
(
poŞ
, 
addr
, 
dma_hªdËr
);

573 
	}
}

575 
nvm_dev_İs
 
	gnvme_nvm_dev_İs
 = {

576 .
id’t™y
 = 
nvme_nvm_id’t™y
,

578 .
	gg‘_l2p_tbl
 = 
nvme_nvm_g‘_l2p_tbl
,

580 .
	gg‘_bb_tbl
 = 
nvme_nvm_g‘_bb_tbl
,

581 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

583 .
	gsubm™_io
 = 
nvme_nvm_subm™_io
,

584 .
	g”a£_block
 = 
nvme_nvm_”a£_block
,

586 .
	gü—‹_dma_poŞ
 = 
nvme_nvm_ü—‹_dma_poŞ
,

587 .
	gde¡roy_dma_poŞ
 = 
nvme_nvm_de¡roy_dma_poŞ
,

588 .
	gdev_dma_®loc
 = 
nvme_nvm_dev_dma_®loc
,

589 .
	gdev_dma_ä“
 = 
nvme_nvm_dev_dma_ä“
,

591 .
	gmax_phys_£ù
 = 64,

594 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
,

595 cÚ¡ 
©Œibu‹_group
 *
©Œs
)

597 
»que¡_queue
 *
q
 = 
ns
->
queue
;

598 
nvm_dev
 *
dev
;

599 
»t
;

601 
dev
 = 
	`nvm_®loc_dev
(
node
);

602 ià(!
dev
)

603  -
ENOMEM
;

605 
dev
->
q
 = q;

606 
	`memıy
(
dev
->
Çme
, 
disk_Çme
, 
DISK_NAME_LEN
);

607 
dev
->
İs
 = &
nvme_nvm_dev_İs
;

608 
dev
->
·»Á_dev
 = 
ns
->
ù¾
->
deviû
;

609 
dev
->
´iv©e_d©a
 = 
ns
;

610 
ns
->
ndev
 = 
dev
;

612 
»t
 = 
	`nvm_»gi¡”
(
dev
);

614 
ns
->
lba_shiá
 = 
	`og2
(
dev
->
£c_size
);

616 ià(
	`sysfs_ü—‹_group
(&
dev
->dev.
kobj
, 
©Œs
))

617 
	`´_w¬n
("%s: failedo create sysfs group for identification\n",

618 
disk_Çme
);

619  
»t
;

620 
	}
}

622 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
)

624 
	`nvm_uÄegi¡”
(
ns
->
ndev
);

625 
	}
}

628 
	#PCI_VENDOR_ID_CNEX
 0x1d1d

	)

629 
	#PCI_DEVICE_ID_CNEX_WL
 0x2807

	)

630 
	#PCI_DEVICE_ID_CNEX_QEMU
 0x1f1f

	)

632 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

634 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

636 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
ù¾
->
dev
);

639 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

640 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_QEMU
 &&

641 
id
->
vs
[0] == 0x1)

645 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_CNEX
 &&

646 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_CNEX_WL
 &&

647 
id
->
vs
[0] == 0x1)

651 
	}
}

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/linux_nvme.h

15 #iâdeà
_LINUX_NVME_H


16 
	#_LINUX_NVME_H


	)

19 
	~<lšux/ty³s.h
>

22 
	#NVMF_NQN_FIELD_LEN
 256

	)

25 
	#NVMF_NQN_SIZE
 223

	)

27 
	#NVMF_TRSVCID_SIZE
 32

	)

28 
	#NVMF_TRADDR_SIZE
 256

	)

29 
	#NVMF_TSAS_SIZE
 256

	)

31 
	#NVME_DISC_SUBSYS_NAME
 "nqn.2014-08.Üg.nvmex´ess.discov”y"

	)

33 
	#NVME_RDMA_IP_PORT
 4420

	)

35 
	envme_subsys_ty³
 {

36 
	mNVME_NQN_DISC
 = 1,

37 
	mNVME_NQN_NVME
 = 2,

42 
	mNVMF_ADDR_FAMILY_PCI
 = 0,

43 
	mNVMF_ADDR_FAMILY_IP4
 = 1,

44 
	mNVMF_ADDR_FAMILY_IP6
 = 2,

45 
	mNVMF_ADDR_FAMILY_IB
 = 3,

46 
	mNVMF_ADDR_FAMILY_FC
 = 4,

51 
	mNVMF_TRTYPE_RDMA
 = 1,

52 
	mNVMF_TRTYPE_FC
 = 2,

53 
	mNVMF_TRTYPE_LOOP
 = 254,

54 
	mNVMF_TRTYPE_MAX
,

59 
	mNVMF_TREQ_NOT_SPECIFIED
 = 0,

60 
	mNVMF_TREQ_REQUIRED
 = 1,

61 
	mNVMF_TREQ_NOT_REQUIRED
 = 2,

68 
	mNVMF_RDMA_QPTYPE_CONNECTED
 = 0,

69 
	mNVMF_RDMA_QPTYPE_DATAGRAM
 = 1,

76 
	mNVMF_RDMA_PRTYPE_NOT_SPECIFIED
 = 0,

77 
	mNVMF_RDMA_PRTYPE_IB
 = 1,

78 
	mNVMF_RDMA_PRTYPE_ROCE
 = 2,

79 
	mNVMF_RDMA_PRTYPE_ROCEV2
 = 3,

80 
	mNVMF_RDMA_PRTYPE_IWARP
 = 4,

87 
	mNVMF_RDMA_CMS_RDMA_CM
 = 0,

90 
	#NVMF_AQ_DEPTH
 32

	)

93 
	mNVME_REG_CAP
 = 0x0000,

94 
	mNVME_REG_VS
 = 0x0008,

95 
	mNVME_REG_INTMS
 = 0x000c,

96 
	mNVME_REG_INTMC
 = 0x0010,

97 
	mNVME_REG_CC
 = 0x0014,

98 
	mNVME_REG_CSTS
 = 0x001c,

99 
	mNVME_REG_NSSR
 = 0x0020,

100 
	mNVME_REG_AQA
 = 0x0024,

101 
	mNVME_REG_ASQ
 = 0x0028,

102 
	mNVME_REG_ACQ
 = 0x0030,

103 
	mNVME_REG_CMBLOC
 = 0x0038,

104 
	mNVME_REG_CMBSZ
 = 0x003c,

107 
	#NVME_CAP_MQES
(
ÿp
è((ÿpè& 0xffff)

	)

108 
	#NVME_CAP_TIMEOUT
(
ÿp
è(((ÿpè>> 24è& 0xff)

	)

109 
	#NVME_CAP_STRIDE
(
ÿp
è(((ÿpè>> 32è& 0xf)

	)

110 
	#NVME_CAP_NSSRC
(
ÿp
è(((ÿpè>> 36è& 0x1)

	)

111 
	#NVME_CAP_MPSMIN
(
ÿp
è(((ÿpè>> 48è& 0xf)

	)

112 
	#NVME_CAP_MPSMAX
(
ÿp
è(((ÿpè>> 52è& 0xf)

	)

114 
	#NVME_CMB_BIR
(
cmbloc
è((cmblocè& 0x7)

	)

115 
	#NVME_CMB_OFST
(
cmbloc
è(((cmblocè>> 12è& 0xfffff)

	)

116 
	#NVME_CMB_SZ
(
cmbsz
è(((cmbszè>> 12è& 0xfffff)

	)

117 
	#NVME_CMB_SZU
(
cmbsz
è(((cmbszè>> 8è& 0xf)

	)

119 
	#NVME_CMB_WDS
(
cmbsz
è((cmbszè& 0x10)

	)

120 
	#NVME_CMB_RDS
(
cmbsz
è((cmbszè& 0x8)

	)

121 
	#NVME_CMB_LISTS
(
cmbsz
è((cmbszè& 0x4)

	)

122 
	#NVME_CMB_CQS
(
cmbsz
è((cmbszè& 0x2)

	)

123 
	#NVME_CMB_SQS
(
cmbsz
è((cmbszè& 0x1)

	)

129 
	#NVME_NVM_IOSQES
 6

	)

130 
	#NVME_NVM_IOCQES
 4

	)

133 
	mNVME_CC_ENABLE
 = 1 << 0,

134 
	mNVME_CC_CSS_NVM
 = 0 << 4,

135 
	mNVME_CC_MPS_SHIFT
 = 7,

136 
	mNVME_CC_ARB_RR
 = 0 << 11,

137 
	mNVME_CC_ARB_WRRU
 = 1 << 11,

138 
	mNVME_CC_ARB_VS
 = 7 << 11,

139 
	mNVME_CC_SHN_NONE
 = 0 << 14,

140 
	mNVME_CC_SHN_NORMAL
 = 1 << 14,

141 
	mNVME_CC_SHN_ABRUPT
 = 2 << 14,

142 
	mNVME_CC_SHN_MASK
 = 3 << 14,

143 
	mNVME_CC_IOSQES
 = 
NVME_NVM_IOSQES
 << 16,

144 
	mNVME_CC_IOCQES
 = 
NVME_NVM_IOCQES
 << 20,

145 
	mNVME_CSTS_RDY
 = 1 << 0,

146 
	mNVME_CSTS_CFS
 = 1 << 1,

147 
	mNVME_CSTS_NSSRO
 = 1 << 4,

148 
	mNVME_CSTS_SHST_NORMAL
 = 0 << 2,

149 
	mNVME_CSTS_SHST_OCCUR
 = 1 << 2,

150 
	mNVME_CSTS_SHST_CMPLT
 = 2 << 2,

151 
	mNVME_CSTS_SHST_MASK
 = 3 << 2,

154 
	snvme_id_pow”_¡©e
 {

155 
__Ë16
 
	mmax_pow”
;

156 
__u8
 
	mrsvd2
;

157 
__u8
 
	mæags
;

158 
__Ë32
 
	m’Œy_Ït
;

159 
__Ë32
 
	mex™_Ït
;

160 
__u8
 
	m»ad_ut
;

161 
__u8
 
	m»ad_Ït
;

162 
__u8
 
	mwr™e_ut
;

163 
__u8
 
	mwr™e_Ït
;

164 
__Ë16
 
	midË_pow”
;

165 
__u8
 
	midË_sÿË
;

166 
__u8
 
	mrsvd19
;

167 
__Ë16
 
	maùive_pow”
;

168 
__u8
 
	maùive_wÜk_sÿË
;

169 
__u8
 
	mrsvd23
[9];

173 
	mNVME_PS_FLAGS_MAX_POWER_SCALE
 = 1 << 0,

174 
	mNVME_PS_FLAGS_NON_OP_STATE
 = 1 << 1,

177 
	snvme_id_ù¾
 {

178 
__Ë16
 
	mvid
;

179 
__Ë16
 
	mssvid
;

180 
	m¢
[20];

181 
	mmn
[40];

182 
	mä
[8];

183 
__u8
 
	m¿b
;

184 
__u8
 
	m›“
[3];

185 
__u8
 
	mcmic
;

186 
__u8
 
	mmdts
;

187 
__Ë16
 
	múid
;

188 
__Ë32
 
	mv”
;

189 
__Ë32
 
	m¹d3r
;

190 
__Ë32
 
	m¹d3e
;

191 
__Ë32
 
	mßes
;

192 
__Ë32
 
	mù¿‰
;

193 
__u8
 
	mrsvd100
[156];

194 
__Ë16
 
	mßcs
;

195 
__u8
 
	maş
;

196 
__u8
 
	m«¾
;

197 
__u8
 
	mämw
;

198 
__u8
 
	mÍa
;

199 
__u8
 
	m–³
;

200 
__u8
 
	mÅss
;

201 
__u8
 
	mavscc
;

202 
__u8
 
	m­¡a
;

203 
__Ë16
 
	mwùemp
;

204 
__Ë16
 
	mcùemp
;

205 
__Ë16
 
	mmtç
;

206 
__Ë32
 
	mhm´e
;

207 
__Ë32
 
	mhmmš
;

208 
__u8
 
	mŠvmÿp
[16];

209 
__u8
 
	munvmÿp
[16];

210 
__Ë32
 
	m½mbs
;

211 
__u8
 
	mrsvd316
[4];

212 
__Ë16
 
	mkas
;

213 
__u8
 
	mrsvd322
[190];

214 
__u8
 
	msqes
;

215 
__u8
 
	mcqes
;

216 
__Ë16
 
	mmaxcmd
;

217 
__Ë32
 
	mÂ
;

218 
__Ë16
 
	mÚcs
;

219 
__Ë16
 
	mfu£s
;

220 
__u8
 
	mâa
;

221 
__u8
 
	mvwc
;

222 
__Ë16
 
	mawun
;

223 
__Ë16
 
	mawupf
;

224 
__u8
 
	mnvscc
;

225 
__u8
 
	mrsvd531
;

226 
__Ë16
 
	macwu
;

227 
__u8
 
	mrsvd534
[2];

228 
__Ë32
 
	msgls
;

229 
__u8
 
	mrsvd540
[228];

230 
	msubnqn
[256];

231 
__u8
 
	mrsvd1024
[768];

232 
__Ë32
 
	mioccsz
;

233 
__Ë32
 
	miÜcsz
;

234 
__Ë16
 
	micdoff
;

235 
__u8
 
	mù¿‰r
;

236 
__u8
 
	mmsdbd
;

237 
__u8
 
	mrsvd1804
[244];

238 
nvme_id_pow”_¡©e
 
	mpsd
[32];

239 
__u8
 
	mvs
[1024];

243 
	mNVME_CTRL_ONCS_COMPARE
 = 1 << 0,

244 
	mNVME_CTRL_ONCS_WRITE_UNCORRECTABLE
 = 1 << 1,

245 
	mNVME_CTRL_ONCS_DSM
 = 1 << 2,

246 
	mNVME_CTRL_VWC_PRESENT
 = 1 << 0,

249 
	snvme_lbaf
 {

250 
__Ë16
 
	mms
;

251 
__u8
 
	mds
;

252 
__u8
 
	m½
;

255 
	snvme_id_ns
 {

256 
__Ë64
 
	mnsze
;

257 
__Ë64
 
	mnÿp
;

258 
__Ë64
 
	mnu£
;

259 
__u8
 
	mnsã©
;

260 
__u8
 
	mÆbaf
;

261 
__u8
 
	mæbas
;

262 
__u8
 
	mmc
;

263 
__u8
 
	mdpc
;

264 
__u8
 
	mdps
;

265 
__u8
 
	mnmic
;

266 
__u8
 
	m»sÿp
;

267 
__u8
 
	måi
;

268 
__u8
 
	mrsvd33
;

269 
__Ë16
 
	mÇwun
;

270 
__Ë16
 
	mÇwupf
;

271 
__Ë16
 
	mÇcwu
;

272 
__Ë16
 
	mÇb¢
;

273 
__Ë16
 
	mÇbo
;

274 
__Ë16
 
	mÇb¥f
;

275 
__u16
 
	mrsvd46
;

276 
__u8
 
	mnvmÿp
[16];

277 
__u8
 
	mrsvd64
[40];

278 
__u8
 
	mnguid
[16];

279 
__u8
 
	meui64
[8];

280 
nvme_lbaf
 
	mlbaf
[16];

281 
__u8
 
	mrsvd192
[192];

282 
__u8
 
	mvs
[3712];

286 
	mNVME_ID_CNS_NS
 = 0x00,

287 
	mNVME_ID_CNS_CTRL
 = 0x01,

288 
	mNVME_ID_CNS_NS_ACTIVE_LIST
 = 0x02,

289 
	mNVME_ID_CNS_NS_PRESENT_LIST
 = 0x10,

290 
	mNVME_ID_CNS_NS_PRESENT
 = 0x11,

291 
	mNVME_ID_CNS_CTRL_NS_LIST
 = 0x12,

292 
	mNVME_ID_CNS_CTRL_LIST
 = 0x13,

296 
	mNVME_NS_FEAT_THIN
 = 1 << 0,

297 
	mNVME_NS_FLBAS_LBA_MASK
 = 0xf,

298 
	mNVME_NS_FLBAS_META_EXT
 = 0x10,

299 
	mNVME_LBAF_RP_BEST
 = 0,

300 
	mNVME_LBAF_RP_BETTER
 = 1,

301 
	mNVME_LBAF_RP_GOOD
 = 2,

302 
	mNVME_LBAF_RP_DEGRADED
 = 3,

303 
	mNVME_NS_DPC_PI_LAST
 = 1 << 4,

304 
	mNVME_NS_DPC_PI_FIRST
 = 1 << 3,

305 
	mNVME_NS_DPC_PI_TYPE3
 = 1 << 2,

306 
	mNVME_NS_DPC_PI_TYPE2
 = 1 << 1,

307 
	mNVME_NS_DPC_PI_TYPE1
 = 1 << 0,

308 
	mNVME_NS_DPS_PI_FIRST
 = 1 << 3,

309 
	mNVME_NS_DPS_PI_MASK
 = 0x7,

310 
	mNVME_NS_DPS_PI_TYPE1
 = 1,

311 
	mNVME_NS_DPS_PI_TYPE2
 = 2,

312 
	mNVME_NS_DPS_PI_TYPE3
 = 3,

315 
	snvme_sm¬t_log
 {

316 
__u8
 
	mü™iÿl_w¬nšg
;

317 
__u8
 
	m‹m³¿tu»
[2];

318 
__u8
 
	mava_¥¬e
;

319 
__u8
 
	m¥¬e_th»sh
;

320 
__u8
 
	m³rûÁ_u£d
;

321 
__u8
 
	mrsvd6
[26];

322 
__u8
 
	md©a_un™s_»ad
[16];

323 
__u8
 
	md©a_un™s_wr™‹n
[16];

324 
__u8
 
	mho¡_»ads
[16];

325 
__u8
 
	mho¡_wr™es
[16];

326 
__u8
 
	mù¾_busy_time
[16];

327 
__u8
 
	mpow”_cyşes
[16];

328 
__u8
 
	mpow”_Ú_hours
[16];

329 
__u8
 
	mun§ã_shutdowns
[16];

330 
__u8
 
	mmedŸ_”rÜs
[16];

331 
__u8
 
	mnum_”r_log_’Œ›s
[16];

332 
__Ë32
 
	mw¬nšg_‹mp_time
;

333 
__Ë32
 
	mü™iÿl_comp_time
;

334 
__Ë16
 
	m‹mp_£nsÜ
[8];

335 
__u8
 
	mrsvd216
[296];

339 
	mNVME_SMART_CRIT_SPARE
 = 1 << 0,

340 
	mNVME_SMART_CRIT_TEMPERATURE
 = 1 << 1,

341 
	mNVME_SMART_CRIT_RELIABILITY
 = 1 << 2,

342 
	mNVME_SMART_CRIT_MEDIA
 = 1 << 3,

343 
	mNVME_SMART_CRIT_VOLATILE_MEMORY
 = 1 << 4,

347 
	mNVME_AER_NOTICE_NS_CHANGED
 = 0x0002,

350 
	snvme_lba_¿nge_ty³
 {

351 
__u8
 
	mty³
;

352 
__u8
 
	m©Œibu‹s
;

353 
__u8
 
	mrsvd2
[14];

354 
__u64
 
	m¦ba
;

355 
__u64
 
	mÆb
;

356 
__u8
 
	mguid
[16];

357 
__u8
 
	mrsvd48
[16];

361 
	mNVME_LBART_TYPE_FS
 = 0x01,

362 
	mNVME_LBART_TYPE_RAID
 = 0x02,

363 
	mNVME_LBART_TYPE_CACHE
 = 0x03,

364 
	mNVME_LBART_TYPE_SWAP
 = 0x04,

366 
	mNVME_LBART_ATTRIB_TEMP
 = 1 << 0,

367 
	mNVME_LBART_ATTRIB_HIDE
 = 1 << 1,

370 
	snvme_»£rv©iÚ_¡©us
 {

371 
__Ë32
 
	mg’
;

372 
__u8
 
	m¹y³
;

373 
__u8
 
	m»gùl
[2];

374 
__u8
 
	m»sv5
[2];

375 
__u8
 
	m±¶s
;

376 
__u8
 
	m»sv10
[13];

378 
__Ë16
 
	múid
;

379 
__u8
 
	mrc¡s
;

380 
__u8
 
	m»sv3
[5];

381 
__Ë64
 
	mho¡id
;

382 
__Ë64
 
	mrkey
;

383 } 
	m»gùl_ds
[];

386 
	envme_async_ev’t_ty³
 {

387 
	mNVME_AER_TYPE_ERROR
 = 0,

388 
	mNVME_AER_TYPE_SMART
 = 1,

389 
	mNVME_AER_TYPE_NOTICE
 = 2,

394 
	envme_İcode
 {

395 
	mnvme_cmd_æush
 = 0x00,

396 
	mnvme_cmd_wr™e
 = 0x01,

397 
	mnvme_cmd_»ad
 = 0x02,

398 
	mnvme_cmd_wr™e_uncÜ
 = 0x04,

399 
	mnvme_cmd_com·»
 = 0x05,

400 
	mnvme_cmd_wr™e_z”Ûs
 = 0x08,

401 
	mnvme_cmd_dsm
 = 0x09,

402 
	mnvme_cmd_»sv_»gi¡”
 = 0x0d,

403 
	mnvme_cmd_»sv_»pÜt
 = 0x0e,

404 
	mnvme_cmd_»sv_acquœe
 = 0x11,

405 
	mnvme_cmd_»sv_»Ëa£
 = 0x15,

406 
	mnvme_cmd_kv_¡Üe
 = 0x81,

407 
	mnvme_cmd_kv_­³nd
 = 0x83,

408 
	mnvme_cmd_kv_»Œ›ve
 = 0x90,

409 
	mnvme_cmd_kv_d–‘e
 = 0xA1,

410 
	mnvme_cmd_kv_™”_»q
 = 0xB1,

411 
	mnvme_cmd_kv_™”_»ad
 = 0xB2,

412 
	mnvme_cmd_kv_exi¡
 = 0xB3,

416 
	#KVCMD_INLINE_KEY_MAX
 (16)

	)

417 
	#KVCMD_MAX_KEY_SIZE
 (255)

	)

418 
	#KVCMD_MIN_KEY_SIZE
 (4)

	)

429 
	mNVME_SGL_FMT_ADDRESS
 = 0x00,

430 
	mNVME_SGL_FMT_OFFSET
 = 0x01,

431 
	mNVME_SGL_FMT_INVALIDATE
 = 0x0f,

446 
	mNVME_SGL_FMT_DATA_DESC
 = 0x00,

447 
	mNVME_SGL_FMT_SEG_DESC
 = 0x02,

448 
	mNVME_SGL_FMT_LAST_SEG_DESC
 = 0x03,

449 
	mNVME_KEY_SGL_FMT_DATA_DESC
 = 0x04,

452 
	snvme_sgl_desc
 {

453 
__Ë64
 
	maddr
;

454 
__Ë32
 
	mËngth
;

455 
__u8
 
	mrsvd
[3];

456 
__u8
 
	mty³
;

459 
	snvme_keyed_sgl_desc
 {

460 
__Ë64
 
	maddr
;

461 
__u8
 
	mËngth
[3];

462 
__u8
 
	mkey
[4];

463 
__u8
 
	mty³
;

466 
	unvme_d©a_±r
 {

468 
__Ë64
 
	m´p1
;

469 
__Ë64
 
	m´p2
;

471 
nvme_sgl_desc
 
	msgl
;

472 
nvme_keyed_sgl_desc
 
	mksgl
;

490 
	mNVME_CMD_FUSE_FIRST
 = (1 << 0),

491 
	mNVME_CMD_FUSE_SECOND
 = (1 << 1),

493 
	mNVME_CMD_SGL_METABUF
 = (1 << 6),

494 
	mNVME_CMD_SGL_METASEG
 = (1 << 7),

495 
	mNVME_CMD_SGL_ALL
 = 
NVME_CMD_SGL_METABUF
 | 
NVME_CMD_SGL_METASEG
,

498 
	snvme_commÚ_commªd
 {

499 
__u8
 
	mİcode
;

500 
__u8
 
	mæags
;

501 
__u16
 
	mcommªd_id
;

502 
__Ë32
 
	mnsid
;

503 
__Ë32
 
	mcdw2
[2];

504 
__Ë64
 
	mm‘ad©a
;

505 
nvme_d©a_±r
 
	md±r
;

506 
__Ë32
 
	mcdw10
[6];

509 
	snvme_rw_commªd
 {

510 
__u8
 
	mİcode
;

511 
__u8
 
	mæags
;

512 
__u16
 
	mcommªd_id
;

513 
__Ë32
 
	mnsid
;

514 
__u64
 
	mrsvd2
;

515 
__Ë64
 
	mm‘ad©a
;

516 
nvme_d©a_±r
 
	md±r
;

517 
__Ë64
 
	m¦ba
;

518 
__Ë16
 
	mËngth
;

519 
__Ë16
 
	mcÚŒŞ
;

520 
__Ë32
 
	mdsmgmt
;

521 
__Ë32
 
	m»áag
;

522 
__Ë16
 
	m­±ag
;

523 
__Ë16
 
	m­pmask
;

527 
	mNVME_RW_LR
 = 1 << 15,

528 
	mNVME_RW_FUA
 = 1 << 14,

529 
	mNVME_RW_DSM_FREQ_UNSPEC
 = 0,

530 
	mNVME_RW_DSM_FREQ_TYPICAL
 = 1,

531 
	mNVME_RW_DSM_FREQ_RARE
 = 2,

532 
	mNVME_RW_DSM_FREQ_READS
 = 3,

533 
	mNVME_RW_DSM_FREQ_WRITES
 = 4,

534 
	mNVME_RW_DSM_FREQ_RW
 = 5,

535 
	mNVME_RW_DSM_FREQ_ONCE
 = 6,

536 
	mNVME_RW_DSM_FREQ_PREFETCH
 = 7,

537 
	mNVME_RW_DSM_FREQ_TEMP
 = 8,

538 
	mNVME_RW_DSM_LATENCY_NONE
 = 0 << 4,

539 
	mNVME_RW_DSM_LATENCY_IDLE
 = 1 << 4,

540 
	mNVME_RW_DSM_LATENCY_NORM
 = 2 << 4,

541 
	mNVME_RW_DSM_LATENCY_LOW
 = 3 << 4,

542 
	mNVME_RW_DSM_SEQ_REQ
 = 1 << 6,

543 
	mNVME_RW_DSM_COMPRESSED
 = 1 << 7,

544 
	mNVME_RW_PRINFO_PRCHK_REF
 = 1 << 10,

545 
	mNVME_RW_PRINFO_PRCHK_APP
 = 1 << 11,

546 
	mNVME_RW_PRINFO_PRCHK_GUARD
 = 1 << 12,

547 
	mNVME_RW_PRINFO_PRACT
 = 1 << 13,

550 
	snvme_dsm_cmd
 {

551 
__u8
 
	mİcode
;

552 
__u8
 
	mæags
;

553 
__u16
 
	mcommªd_id
;

554 
__Ë32
 
	mnsid
;

555 
__u64
 
	mrsvd2
[2];

556 
nvme_d©a_±r
 
	md±r
;

557 
__Ë32
 
	mÄ
;

558 
__Ë32
 
	m©Œibu‹s
;

559 
__u32
 
	mrsvd12
[4];

563 
	mNVME_DSMGMT_IDR
 = 1 << 0,

564 
	mNVME_DSMGMT_IDW
 = 1 << 1,

565 
	mNVME_DSMGMT_AD
 = 1 << 2,

568 
	snvme_dsm_¿nge
 {

569 
__Ë32
 
	mÿ‰r
;

570 
__Ë32
 
	mÆb
;

571 
__Ë64
 
	m¦ba
;

574 
	snvme_kv_¡Üe_commªd
 {

575 
__u8
 
	mİcode
;

576 
__u8
 
	mæags
;

577 
__u16
 
	mcommªd_id
;

578 
__Ë32
 
	mnsid
;

579 
__u64
 
	mrsvd
;

580 
__Ë32
 
	moff£t
;

581 
__u32
 
	mrsvd2
;

582 
nvme_d©a_±r
 
	md±r
;

583 
__Ë32
 
	mv®ue_Ën
;

584 
__u8
 
	mkey_Ën
;

585 
__u8
 
	mİtiÚ
;

586 
__u8
 
	mšv®id_by‹
:2;

587 
__u8
 
	mrsvd3
:6;

588 
__u8
 
	mrsvd4
;

591 
	mkey
[16];

594 
__Ë64
 
	mkey_´p
;

595 
__Ë64
 
	mkey_´p2
;

600 
	snvme_kv_­³nd_commªd
 {

601 
__u8
 
	mİcode
;

602 
__u8
 
	mæags
;

603 
__u16
 
	mcommªd_id
;

604 
__Ë32
 
	mnsid
;

605 
__u64
 
	mrsvd
;

606 
__Ë32
 
	moff£t
;

607 
__u32
 
	mrsvd2
;

608 
nvme_d©a_±r
 
	md±r
;

609 
__Ë32
 
	mv®ue_Ën
;

610 
__u8
 
	mkey_Ën
;

611 
__u8
 
	mİtiÚ
;

612 
__u8
 
	mšv®id_by‹
:2;

613 
__u8
 
	mrsvd3
:6;

614 
__u8
 
	mrsvd4
;

617 
	mkey
[16];

620 
__Ë64
 
	mkey_´p
;

621 
__Ë64
 
	mkey_´p2
;

626 
	snvme_kv_»Œ›ve_commªd
 {

627 
__u8
 
	mİcode
;

628 
__u8
 
	mæags
;

629 
__u16
 
	mcommªd_id
;

630 
__Ë32
 
	mnsid
;

631 
__u64
 
	mrsvd
;

632 
__Ë32
 
	moff£t
;

633 
__u32
 
	mrsvd2
;

634 
nvme_d©a_±r
 
	md±r
;

635 
__Ë32
 
	mv®ue_Ën
;

636 
__u8
 
	mkey_Ën
;

637 
__u8
 
	mİtiÚ
;

638 
__u16
 
	mrsvd3
;

641 
	mkey
[16];

644 
__Ë64
 
	mkey_´p
;

645 
__Ë64
 
	mkey_´p2
;

650 
	snvme_kv_d–‘e_commªd
 {

651 
__u8
 
	mİcode
;

652 
__u8
 
	mæags
;

653 
__u16
 
	mcommªd_id
;

654 
__Ë32
 
	mnsid
;

655 
__u64
 
	mrsvd
;

656 
__Ë32
 
	moff£t
;

657 
__u32
 
	mrsvd2
;

658 
__u64
 
	mrsvd3
[2];

659 
__Ë32
 
	mv®ue_Ën
;

660 
__u8
 
	mkey_Ën
;

661 
__u8
 
	mİtiÚ
;

662 
__u16
 
	mrsvd4
;

665 
	mkey
[16];

668 
__Ë64
 
	mkey_´p
;

669 
__Ë64
 
	mkey_´p2
;

674 
	snvme_kv_™”_»q_commªd
 {

675 
__u8
 
	mİcode
;

676 
__u8
 
	mæags
;

677 
__u16
 
	mcommªd_id
;

678 
__Ë32
 
	mnsid
;

679 
__u64
 
	mrsvd
[4];

680 
__Ë32
 
	mz”o
;

681 
__u8
 
	m™”_hªdË
;

682 
__u8
 
	mİtiÚ
;

683 
__u16
 
	mrsvd2
;

684 
__Ë32
 
	m™”_v®
;

685 
__Ë32
 
	m™”_b™mask
;

686 
__u64
 
	mrsvd3
;

690 
	snvme_kv_™”_»ad_commªd
 {

691 
__u8
 
	mİcode
;

692 
__u8
 
	mæags
;

693 
__u16
 
	mcommªd_id
;

694 
__Ë32
 
	mnsid
;

695 
__u64
 
	mrsvd
[2];

696 
nvme_d©a_±r
 
	md±r
;

697 
__Ë32
 
	mv®ue_Ën
;

698 
__u8
 
	m™”_hªdË
;

699 
__u8
 
	mİtiÚ
;

700 
__u16
 
	mrsvd2
;

701 
__u64
 
	mrsvd3
[2];

704 
	snvme_kv_exi¡_commªd
 {

705 
__u8
 
	mİcode
;

706 
__u8
 
	mæags
;

707 
__u16
 
	mcommªd_id
;

708 
__Ë32
 
	mnsid
;

709 
__u64
 
	mrsvd
;

710 
__Ë32
 
	moff£t
;

711 
__u32
 
	mrsvd2
;

712 
__u64
 
	mrsvd3
[2];

713 
__Ë32
 
	mv®ue_Ën
;

714 
__u8
 
	mkey_Ën
;

715 
__u8
 
	mİtiÚ
;

716 
__u16
 
	mrsvd4
;

719 
	mkey
[16];

722 
__Ë64
 
	mkey_´p
;

723 
__Ë64
 
	mkey_´p2
;

732 
	envme_admš_İcode
 {

733 
	mnvme_admš_d–‘e_sq
 = 0x00,

734 
	mnvme_admš_ü—‹_sq
 = 0x01,

735 
	mnvme_admš_g‘_log_·ge
 = 0x02,

736 
	mnvme_admš_d–‘e_cq
 = 0x04,

737 
	mnvme_admš_ü—‹_cq
 = 0x05,

738 
	mnvme_admš_id’tify
 = 0x06,

739 
	mnvme_admš_abÜt_cmd
 = 0x08,

740 
	mnvme_admš_£t_ã©u»s
 = 0x09,

741 
	mnvme_admš_g‘_ã©u»s
 = 0x0a,

742 
	mnvme_admš_async_ev’t
 = 0x0c,

743 
	mnvme_admš_ns_mgmt
 = 0x0d,

744 
	mnvme_admš_aùiv©e_fw
 = 0x10,

745 
	mnvme_admš_dowÆßd_fw
 = 0x11,

746 
	mnvme_admš_ns_©ch
 = 0x15,

747 
	mnvme_admš_k“p_®ive
 = 0x18,

748 
	mnvme_admš_fÜm©_nvm
 = 0x80,

749 
	mnvme_admš_£cur™y_£nd
 = 0x81,

750 
	mnvme_admš_£cur™y_»cv
 = 0x82,

754 
	mNVME_QUEUE_PHYS_CONTIG
 = (1 << 0),

755 
	mNVME_CQ_IRQ_ENABLED
 = (1 << 1),

756 
	mNVME_SQ_PRIO_URGENT
 = (0 << 1),

757 
	mNVME_SQ_PRIO_HIGH
 = (1 << 1),

758 
	mNVME_SQ_PRIO_MEDIUM
 = (2 << 1),

759 
	mNVME_SQ_PRIO_LOW
 = (3 << 1),

760 
	mNVME_FEAT_ARBITRATION
 = 0x01,

761 
	mNVME_FEAT_POWER_MGMT
 = 0x02,

762 
	mNVME_FEAT_LBA_RANGE
 = 0x03,

763 
	mNVME_FEAT_TEMP_THRESH
 = 0x04,

764 
	mNVME_FEAT_ERR_RECOVERY
 = 0x05,

765 
	mNVME_FEAT_VOLATILE_WC
 = 0x06,

766 
	mNVME_FEAT_NUM_QUEUES
 = 0x07,

767 
	mNVME_FEAT_IRQ_COALESCE
 = 0x08,

768 
	mNVME_FEAT_IRQ_CONFIG
 = 0x09,

769 
	mNVME_FEAT_WRITE_ATOMIC
 = 0x0a,

770 
	mNVME_FEAT_ASYNC_EVENT
 = 0x0b,

771 
	mNVME_FEAT_AUTO_PST
 = 0x0c,

772 
	mNVME_FEAT_HOST_MEM_BUF
 = 0x0d,

773 
	mNVME_FEAT_KATO
 = 0x0f,

774 
	mNVME_FEAT_SW_PROGRESS
 = 0x80,

775 
	mNVME_FEAT_HOST_ID
 = 0x81,

776 
	mNVME_FEAT_RESV_MASK
 = 0x82,

777 
	mNVME_FEAT_RESV_PERSIST
 = 0x83,

778 
	mNVME_LOG_ERROR
 = 0x01,

779 
	mNVME_LOG_SMART
 = 0x02,

780 
	mNVME_LOG_FW_SLOT
 = 0x03,

781 
	mNVME_LOG_DISC
 = 0x70,

782 
	mNVME_LOG_RESERVATION
 = 0x80,

783 
	mNVME_FWACT_REPL
 = (0 << 3),

784 
	mNVME_FWACT_REPL_ACTV
 = (1 << 3),

785 
	mNVME_FWACT_ACTV
 = (2 << 3),

788 
	snvme_id’tify
 {

789 
__u8
 
	mİcode
;

790 
__u8
 
	mæags
;

791 
__u16
 
	mcommªd_id
;

792 
__Ë32
 
	mnsid
;

793 
__u64
 
	mrsvd2
[2];

794 
nvme_d©a_±r
 
	md±r
;

795 
__Ë32
 
	mús
;

796 
__u32
 
	mrsvd11
[5];

799 
	snvme_ã©u»s
 {

800 
__u8
 
	mİcode
;

801 
__u8
 
	mæags
;

802 
__u16
 
	mcommªd_id
;

803 
__Ë32
 
	mnsid
;

804 
__u64
 
	mrsvd2
[2];

805 
nvme_d©a_±r
 
	md±r
;

806 
__Ë32
 
	mfid
;

807 
__Ë32
 
	mdwÜd11
;

808 
__u32
 
	mrsvd12
[4];

811 
	snvme_ü—‹_cq
 {

812 
__u8
 
	mİcode
;

813 
__u8
 
	mæags
;

814 
__u16
 
	mcommªd_id
;

815 
__u32
 
	mrsvd1
[5];

816 
__Ë64
 
	m´p1
;

817 
__u64
 
	mrsvd8
;

818 
__Ë16
 
	mcqid
;

819 
__Ë16
 
	mqsize
;

820 
__Ë16
 
	mcq_æags
;

821 
__Ë16
 
	mœq_veùÜ
;

822 
__u32
 
	mrsvd12
[4];

825 
	snvme_ü—‹_sq
 {

826 
__u8
 
	mİcode
;

827 
__u8
 
	mæags
;

828 
__u16
 
	mcommªd_id
;

829 
__u32
 
	mrsvd1
[5];

830 
__Ë64
 
	m´p1
;

831 
__u64
 
	mrsvd8
;

832 
__Ë16
 
	msqid
;

833 
__Ë16
 
	mqsize
;

834 
__Ë16
 
	msq_æags
;

835 
__Ë16
 
	mcqid
;

836 
__u32
 
	mrsvd12
[4];

839 
	snvme_d–‘e_queue
 {

840 
__u8
 
	mİcode
;

841 
__u8
 
	mæags
;

842 
__u16
 
	mcommªd_id
;

843 
__u32
 
	mrsvd1
[9];

844 
__Ë16
 
	mqid
;

845 
__u16
 
	mrsvd10
;

846 
__u32
 
	mrsvd11
[5];

849 
	snvme_abÜt_cmd
 {

850 
__u8
 
	mİcode
;

851 
__u8
 
	mæags
;

852 
__u16
 
	mcommªd_id
;

853 
__u32
 
	mrsvd1
[9];

854 
__Ë16
 
	msqid
;

855 
__u16
 
	mcid
;

856 
__u32
 
	mrsvd11
[5];

859 
	snvme_dowÆßd_fœmw¬e
 {

860 
__u8
 
	mİcode
;

861 
__u8
 
	mæags
;

862 
__u16
 
	mcommªd_id
;

863 
__u32
 
	mrsvd1
[5];

864 
nvme_d©a_±r
 
	md±r
;

865 
__Ë32
 
	mnumd
;

866 
__Ë32
 
	moff£t
;

867 
__u32
 
	mrsvd12
[4];

870 
	snvme_fÜm©_cmd
 {

871 
__u8
 
	mİcode
;

872 
__u8
 
	mæags
;

873 
__u16
 
	mcommªd_id
;

874 
__Ë32
 
	mnsid
;

875 
__u64
 
	mrsvd2
[4];

876 
__Ë32
 
	mcdw10
;

877 
__u32
 
	mrsvd11
[5];

880 
	snvme_g‘_log_·ge_commªd
 {

881 
__u8
 
	mİcode
;

882 
__u8
 
	mæags
;

883 
__u16
 
	mcommªd_id
;

884 
__Ë32
 
	mnsid
;

885 
__u64
 
	mrsvd2
[2];

886 
nvme_d©a_±r
 
	md±r
;

887 
__u8
 
	mlid
;

888 
__u8
 
	mrsvd10
;

889 
__Ë16
 
	mnumdl
;

890 
__Ë16
 
	mnumdu
;

891 
__u16
 
	mrsvd11
;

892 
__Ë32
 
	mÍŞ
;

893 
__Ë32
 
	mÍou
;

894 
__u32
 
	mrsvd14
[2];

900 
	envmf_çbrics_İcode
 {

901 
	mnvme_çbrics_commªd
 = 0x7f,

904 
	envmf_ÿpsuË_commªd
 {

905 
	mnvme_çbrics_ty³_´İ”ty_£t
 = 0x00,

906 
	mnvme_çbrics_ty³_cÚÃù
 = 0x01,

907 
	mnvme_çbrics_ty³_´İ”ty_g‘
 = 0x04,

910 
	snvmf_commÚ_commªd
 {

911 
__u8
 
	mİcode
;

912 
__u8
 
	m»sv1
;

913 
__u16
 
	mcommªd_id
;

914 
__u8
 
	mfùy³
;

915 
__u8
 
	m»sv2
[35];

916 
__u8
 
	mts
[24];

925 
	#NVME_CNTLID_MIN
 1

	)

926 
	#NVME_CNTLID_MAX
 0xfãf

	)

927 
	#NVME_CNTLID_DYNAMIC
 0xffff

	)

929 
	#MAX_DISC_LOGS
 255

	)

932 
	snvmf_disc_r¥_·ge_’Œy
 {

933 
__u8
 
	mŒty³
;

934 
__u8
 
	madrçm
;

935 
__u8
 
	msubty³
;

936 
__u8
 
	mŒeq
;

937 
__Ë16
 
	mpÜtid
;

938 
__Ë16
 
	múid
;

939 
__Ë16
 
	masqsz
;

940 
__u8
 
	m»sv8
[22];

941 
	mŒsvcid
[
NVMF_TRSVCID_SIZE
];

942 
__u8
 
	m»sv64
[192];

943 
	msubnqn
[
NVMF_NQN_FIELD_LEN
];

944 
	mŒaddr
[
NVMF_TRADDR_SIZE
];

945 
	ut§s
 {

946 
	mcommÚ
[
NVMF_TSAS_SIZE
];

947 
	srdma
 {

948 
__u8
 
	mq±y³
;

949 
__u8
 
	m´ty³
;

950 
__u8
 
	mcms
;

951 
__u8
 
	m»sv3
[5];

952 
__u16
 
	mpkey
;

953 
__u8
 
	m»sv10
[246];

954 } 
	mrdma
;

955 } 
	mt§s
;

959 
	snvmf_disc_r¥_·ge_hdr
 {

960 
__Ë64
 
	mg’ùr
;

961 
__Ë64
 
	mnum»c
;

962 
__Ë16
 
	m»cfmt
;

963 
__u8
 
	m»sv14
[1006];

964 
nvmf_disc_r¥_·ge_’Œy
 
	m’Œ›s
[0];

967 
	snvmf_cÚÃù_commªd
 {

968 
__u8
 
	mİcode
;

969 
__u8
 
	m»sv1
;

970 
__u16
 
	mcommªd_id
;

971 
__u8
 
	mfùy³
;

972 
__u8
 
	m»sv2
[19];

973 
nvme_d©a_±r
 
	md±r
;

974 
__Ë16
 
	m»cfmt
;

975 
__Ë16
 
	mqid
;

976 
__Ë16
 
	msqsize
;

977 
__u8
 
	mÿ‰r
;

978 
__u8
 
	m»sv3
;

979 
__Ë32
 
	mk©o
;

980 
__u8
 
	m»sv4
[12];

983 
	snvmf_cÚÃù_d©a
 {

984 
__u8
 
	mho¡id
[16];

985 
__Ë16
 
	múid
;

986 
	m»sv4
[238];

987 
	msubsy¢qn
[
NVMF_NQN_FIELD_LEN
];

988 
	mho¡nqn
[
NVMF_NQN_FIELD_LEN
];

989 
	m»sv5
[256];

992 
	snvmf_´İ”ty_£t_commªd
 {

993 
__u8
 
	mİcode
;

994 
__u8
 
	m»sv1
;

995 
__u16
 
	mcommªd_id
;

996 
__u8
 
	mfùy³
;

997 
__u8
 
	m»sv2
[35];

998 
__u8
 
	m©Œib
;

999 
__u8
 
	m»sv3
[3];

1000 
__Ë32
 
	moff£t
;

1001 
__Ë64
 
	mv®ue
;

1002 
__u8
 
	m»sv4
[8];

1005 
	snvmf_´İ”ty_g‘_commªd
 {

1006 
__u8
 
	mİcode
;

1007 
__u8
 
	m»sv1
;

1008 
__u16
 
	mcommªd_id
;

1009 
__u8
 
	mfùy³
;

1010 
__u8
 
	m»sv2
[35];

1011 
__u8
 
	m©Œib
;

1012 
__u8
 
	m»sv3
[3];

1013 
__Ë32
 
	moff£t
;

1014 
__u8
 
	m»sv4
[16];

1017 
	snvme_commªd
 {

1019 
nvme_commÚ_commªd
 
	mcommÚ
;

1020 
nvme_rw_commªd
 
	mrw
;

1021 
nvme_id’tify
 
	mid’tify
;

1022 
nvme_ã©u»s
 
	mã©u»s
;

1023 
nvme_ü—‹_cq
 
	mü—‹_cq
;

1024 
nvme_ü—‹_sq
 
	mü—‹_sq
;

1025 
nvme_d–‘e_queue
 
	md–‘e_queue
;

1026 
nvme_dowÆßd_fœmw¬e
 
	mdlfw
;

1027 
nvme_fÜm©_cmd
 
	mfÜm©
;

1028 
nvme_dsm_cmd
 
	mdsm
;

1029 
nvme_abÜt_cmd
 
	mabÜt
;

1030 
nvme_g‘_log_·ge_commªd
 
	mg‘_log_·ge
;

1031 
nvmf_commÚ_commªd
 
	mçbrics
;

1032 
nvmf_cÚÃù_commªd
 
	mcÚÃù
;

1033 
nvmf_´İ”ty_£t_commªd
 
	m´İ_£t
;

1034 
nvmf_´İ”ty_g‘_commªd
 
	m´İ_g‘
;

1035 
nvme_kv_¡Üe_commªd
 
	mkv_¡Üe
;

1036 
nvme_kv_»Œ›ve_commªd
 
	mkv_»Œ›ve
;

1037 
nvme_kv_d–‘e_commªd
 
	mkv_d–‘e
;

1038 
nvme_kv_­³nd_commªd
 
	mkv_­³nd
;

1039 
nvme_kv_™”_»q_commªd
 
	mkv_™”_»q
;

1040 
nvme_kv_™”_»ad_commªd
 
	mkv_™”_»ad
;

1041 
nvme_kv_exi¡_commªd
 
	mkv_exi¡
;

1045 
šlše
 
boŞ
 
	$nvme_is_wr™e
(
nvme_commªd
 *
cmd
)

1052 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_¡Üe
 || cmd->commÚ.İcod=ğ
nvme_cmd_kv_­³nd
)

1054 ià(
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_»Œ›ve
 ||

1055 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_d–‘e
 ||

1056 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»q
 ||

1057 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_™”_»ad
 ||

1058 
cmd
->
commÚ
.
İcode
 =ğ
nvme_cmd_kv_exi¡
 )

1061 ià(
	`uÆik–y
(
cmd
->
commÚ
.
İcode
 =ğ
nvme_çbrics_commªd
))

1062  
cmd
->
çbrics
.
İcode
 & 1;

1063  
cmd
->
commÚ
.
İcode
 & 1;

1064 
	}
}

1070 
	mNVME_SC_SUCCESS
 = 0x0,

1071 
	mNVME_SC_INVALID_OPCODE
 = 0x1,

1072 
	mNVME_SC_INVALID_FIELD
 = 0x2,

1073 
	mNVME_SC_CMDID_CONFLICT
 = 0x3,

1074 
	mNVME_SC_DATA_XFER_ERROR
 = 0x4,

1075 
	mNVME_SC_POWER_LOSS
 = 0x5,

1076 
	mNVME_SC_INTERNAL
 = 0x6,

1077 
	mNVME_SC_ABORT_REQ
 = 0x7,

1078 
	mNVME_SC_ABORT_QUEUE
 = 0x8,

1079 
	mNVME_SC_FUSED_FAIL
 = 0x9,

1080 
	mNVME_SC_FUSED_MISSING
 = 0xa,

1081 
	mNVME_SC_INVALID_NS
 = 0xb,

1082 
	mNVME_SC_CMD_SEQ_ERROR
 = 0xc,

1083 
	mNVME_SC_SGL_INVALID_LAST
 = 0xd,

1084 
	mNVME_SC_SGL_INVALID_COUNT
 = 0xe,

1085 
	mNVME_SC_SGL_INVALID_DATA
 = 0xf,

1086 
	mNVME_SC_SGL_INVALID_METADATA
 = 0x10,

1087 
	mNVME_SC_SGL_INVALID_TYPE
 = 0x11,

1089 
	mNVME_SC_SGL_INVALID_OFFSET
 = 0x16,

1090 
	mNVME_SC_SGL_INVALID_SUBTYPE
 = 0x17,

1092 
	mNVME_SC_LBA_RANGE
 = 0x80,

1093 
	mNVME_SC_CAP_EXCEEDED
 = 0x81,

1094 
	mNVME_SC_NS_NOT_READY
 = 0x82,

1095 
	mNVME_SC_RESERVATION_CONFLICT
 = 0x83,

1100 
	mNVME_SC_CQ_INVALID
 = 0x100,

1101 
	mNVME_SC_QID_INVALID
 = 0x101,

1102 
	mNVME_SC_QUEUE_SIZE
 = 0x102,

1103 
	mNVME_SC_ABORT_LIMIT
 = 0x103,

1104 
	mNVME_SC_ABORT_MISSING
 = 0x104,

1105 
	mNVME_SC_ASYNC_LIMIT
 = 0x105,

1106 
	mNVME_SC_FIRMWARE_SLOT
 = 0x106,

1107 
	mNVME_SC_FIRMWARE_IMAGE
 = 0x107,

1108 
	mNVME_SC_INVALID_VECTOR
 = 0x108,

1109 
	mNVME_SC_INVALID_LOG_PAGE
 = 0x109,

1110 
	mNVME_SC_INVALID_FORMAT
 = 0x10a,

1111 
	mNVME_SC_FW_NEEDS_CONV_RESET
 = 0x10b,

1112 
	mNVME_SC_INVALID_QUEUE
 = 0x10c,

1113 
	mNVME_SC_FEATURE_NOT_SAVEABLE
 = 0x10d,

1114 
	mNVME_SC_FEATURE_NOT_CHANGEABLE
 = 0x10e,

1115 
	mNVME_SC_FEATURE_NOT_PER_NS
 = 0x10f,

1116 
	mNVME_SC_FW_NEEDS_SUBSYS_RESET
 = 0x110,

1117 
	mNVME_SC_FW_NEEDS_RESET
 = 0x111,

1118 
	mNVME_SC_FW_NEEDS_MAX_TIME
 = 0x112,

1119 
	mNVME_SC_FW_ACIVATE_PROHIBITED
 = 0x113,

1120 
	mNVME_SC_OVERLAPPING_RANGE
 = 0x114,

1121 
	mNVME_SC_NS_INSUFFICENT_CAP
 = 0x115,

1122 
	mNVME_SC_NS_ID_UNAVAILABLE
 = 0x116,

1123 
	mNVME_SC_NS_ALREADY_ATTACHED
 = 0x118,

1124 
	mNVME_SC_NS_IS_PRIVATE
 = 0x119,

1125 
	mNVME_SC_NS_NOT_ATTACHED
 = 0x11a,

1126 
	mNVME_SC_THIN_PROV_NOT_SUPP
 = 0x11b,

1127 
	mNVME_SC_CTRL_LIST_INVALID
 = 0x11c,

1132 
	mNVME_SC_BAD_ATTRIBUTES
 = 0x180,

1133 
	mNVME_SC_INVALID_PI
 = 0x181,

1134 
	mNVME_SC_READ_ONLY
 = 0x182,

1139 
	mNVME_SC_CONNECT_FORMAT
 = 0x180,

1140 
	mNVME_SC_CONNECT_CTRL_BUSY
 = 0x181,

1141 
	mNVME_SC_CONNECT_INVALID_PARAM
 = 0x182,

1142 
	mNVME_SC_CONNECT_RESTART_DISC
 = 0x183,

1143 
	mNVME_SC_CONNECT_INVALID_HOST
 = 0x184,

1145 
	mNVME_SC_DISCOVERY_RESTART
 = 0x190,

1146 
	mNVME_SC_AUTH_REQUIRED
 = 0x191,

1151 
	mNVME_SC_WRITE_FAULT
 = 0x280,

1152 
	mNVME_SC_READ_ERROR
 = 0x281,

1153 
	mNVME_SC_GUARD_CHECK
 = 0x282,

1154 
	mNVME_SC_APPTAG_CHECK
 = 0x283,

1155 
	mNVME_SC_REFTAG_CHECK
 = 0x284,

1156 
	mNVME_SC_COMPARE_FAILED
 = 0x285,

1157 
	mNVME_SC_ACCESS_DENIED
 = 0x286,

1158 
	mNVME_SC_UNWRITTEN_BLOCK
 = 0x287,

1160 
	mNVME_SC_DNR
 = 0x4000,

1163 
	snvme_com¶‘iÚ
 {

1168 
__Ë16
 
	m»suÉ16
;

1169 
__Ë32
 
	m»suÉ
;

1170 
__Ë64
 
	m»suÉ64
;

1172 
__Ë16
 
	msq_h—d
;

1173 
__Ë16
 
	msq_id
;

1174 
__u16
 
	mcommªd_id
;

1175 
__Ë16
 
	m¡©us
;

1178 
	#NVME_VS
(
majÜ
, 
mšÜ
, 
‹¹Ÿry
) \

1179 (((
majÜ
è<< 16è| ((
mšÜ
è<< 8è| (
‹¹Ÿry
))

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/linux_nvme_ioctl.h

15 #iâdeà
_UAPI_LINUX_NVME_IOCTL_H


16 
	#_UAPI_LINUX_NVME_IOCTL_H


	)

18 
	~<lšux/ty³s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	mİcode
;

22 
__u8
 
	mæags
;

23 
__u16
 
	mcÚŒŞ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mm‘ad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¦ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	m»áag
;

31 
__u16
 
	m­±ag
;

32 
__u16
 
	m­pmask
;

35 
	snvme_·s¡hru_cmd
 {

36 
__u8
 
	mİcode
;

37 
__u8
 
	mæags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mm‘ad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mm‘ad©a_Ën
;

45 
__u32
 
	md©a_Ën
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	m»suÉ
;

56 
	#KVS_SUCCESS
 0

	)

57 
	#KVS_ERR_ALIGNMENT
 (-1)

	)

58 
	#KVS_ERR_CAPAPCITY
 (-2)

	)

59 
	#KVS_ERR_CLOSE
 (-3)

	)

60 
	#KVS_ERR_CONT_EXIST
 (-4)

	)

61 
	#KVS_ERR_CONT_NAME
 (-5)

	)

62 
	#KVS_ERR_CONT_NOT_EXIST
 (-6)

	)

63 
	#KVS_ERR_DEVICE_NOT_EXIST
 (-7)

	)

64 
	#KVS_ERR_GROUP
 (-8)

	)

65 
	#KVS_ERR_INDEX
 (-9)

	)

66 
	#KVS_ERR_IO
 (-10)

	)

67 
	#KVS_ERR_KEY
 (-11)

	)

68 
	#KVS_ERR_KEY_TYPE
 (-12)

	)

69 
	#KVS_ERR_MEMORY
 (-13)

	)

70 
	#KVS_ERR_NULL_INPUT
 (-14)

	)

71 
	#KVS_ERR_OFFSET
 (-15)

	)

72 
	#KVS_ERR_OPEN
 (-16)

	)

73 
	#KVS_ERR_OPTION_NOT_SUPPORTED
 (-17)

	)

74 
	#KVS_ERR_PERMISSION
 (-18)

	)

75 
	#KVS_ERR_SPACE
 (-19)

	)

76 
	#KVS_ERR_TIMEOUT
 (-20)

	)

77 
	#KVS_ERR_TUPLE_EXIST
 (-21)

	)

78 
	#KVS_ERR_TUPLE_NOT_EXIST
 (-22)

	)

79 
	#KVS_ERR_VALUE
 (-23)

	)

82 
	snvme_·s¡hru_kv_cmd
 {

83 
__u8
 
	mİcode
;

84 
__u8
 
	mæags
;

85 
__u16
 
	mrsvd1
;

86 
__u32
 
	mnsid
;

87 
__u32
 
	mcdw2
;

88 
__u32
 
	mcdw3
;

89 
__u32
 
	mcdw4
;

90 
__u32
 
	mcdw5
;

91 
__u64
 
	md©a_addr
;

92 
__u32
 
	md©a_Ëngth
;

93 
__u32
 
	mkey_Ëngth
;

94 
__u32
 
	mcdw10
;

95 
__u32
 
	mcdw11
;

98 
__u64
 
	mkey_addr
;

99 
__u32
 
	mrsvd5
;

100 
__u32
 
	mrsvd6
;

102 
__u8
 
	mkey
[16];

104 
__u32
 
	mcdw12
;

105 
__u32
 
	mcdw13
;

106 
__u32
 
	mcdw14
;

107 
__u32
 
	mcdw15
;

110 
__u32
 
	mtimeout_ms
;

111 
__u32
 
	m»suÉ
;

112 
__u32
 
	m¡©us
;

113 
__u32
 
	mùxid
;

114 
__u64
 
	m»qid
;

117 
	snvme_aioùx
 {

118 
__u32
 
	mùxid
;

119 
__u32
 
	mev’tfd
;

123 
	snvme_aiÛv’t
 {

124 
__u64
 
	m»qid
;

125 
__u32
 
	mùxid
;

126 
__u32
 
	m»suÉ
;

127 
__u16
 
	m¡©us
;

130 
	#MAX_AIO_EVENTS
 128

	)

131 
	snvme_aiÛv’ts
 {

132 
__u16
 
	mÄ
;

133 
__u32
 
	mùxid
;

134 
nvme_aiÛv’t
 
	mev’ts
[
MAX_AIO_EVENTS
];

138 
	#nvme_admš_cmd
 
nvme_·s¡hru_cmd


	)

140 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

141 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admš_cmd
)

	)

142 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

143 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_·s¡hru_cmd
)

	)

144 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

145 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

146 
	#NVME_IOCTL_RESCAN
 
	`_IO
('N', 0x46)

	)

148 
	#NVME_IOCTL_AIO_CMD
 
	`_IOWR
('N', 0x47, 
nvme_·s¡hru_kv_cmd
)

	)

149 
	#NVME_IOCTL_SET_AIOCTX
 
	`_IOWR
('N', 0x48, 
nvme_aioùx
)

	)

150 
	#NVME_IOCTL_DEL_AIOCTX
 
	`_IOWR
('N', 0x49, 
nvme_aioùx
)

	)

151 
	#NVME_IOCTL_GET_AIOEVENT
 
	`_IOWR
('N', 0x50, 
nvme_aiÛv’ts
)

	)

152 
	#NVME_IOCTL_IO_KV_CMD
 
	`_IOWR
('N', 0x51, 
nvme_·s¡hru_kv_cmd
)

	)

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/nvme.h

14 #iâdeà
_NVME_H


15 
	#_NVME_H


	)

22 
	#REPORT_TIMEOUT


	)

23 
	#KSID_SUPPORT


	)

25 
	~"lšux_nvme.h
"

27 
	~<lšux/pci.h
>

28 
	~<lšux/k»f.h
>

29 
	~<lšux/blk-mq.h
>

30 
	~<lšux/lighŠvm.h
>

33 
	#is_kv_­³nd_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_­³nd
)

	)

34 
	#is_kv_¡Üe_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_¡Üe
)

	)

35 
	#is_kv_»Œ›ve_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_»Œ›ve
)

	)

36 
	#is_kv_d–‘e_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_d–‘e
)

	)

37 
	#is_kv_™”_»q_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»q
)

	)

38 
	#is_kv_™”_»ad_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_™”_»ad
)

	)

39 
	#is_kv_exi¡_cmd
(
İcode
è((İcodeè=ğ
nvme_cmd_kv_exi¡
)

	)

40 
	#is_kv_cmd
(
İcode
è(
	`is_kv_¡Üe_cmd
(İcodeè|| 
	`is_kv_­³nd_cmd
(opcode) ||\

41 
	`is_kv_»Œ›ve_cmd
(
İcode
è|| 
	`is_kv_d–‘e_cmd
(opcode) ||\

42 
	`is_kv_™”_»q_cmd
(
İcode
è|| 
	`is_kv_™”_»ad_cmd
(opcode) ||\

43 
	`is_kv_exi¡_cmd
(
İcode
))

	)

52 
	mNVME_SC_CANCELLED
 = -
EINTR
,

55 
nvme_io_timeout
;

56 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

58 
admš_timeout
;

59 
	#ADMIN_TIMEOUT
 (
admš_timeout
 * 
HZ
)

	)

61 
shutdown_timeout
;

62 
	#SHUTDOWN_TIMEOUT
 (
shutdown_timeout
 * 
HZ
)

	)

64 
	#NVME_DEFAULT_KATO
 5

	)

65 
	#NVME_KATO_GRACE
 10

	)

67 
nvme_max_»Œ›s
;

70 
	mNVME_NS_LBA
 = 0,

71 
	mNVME_NS_LIGHTNVM
 = 1,

78 
	envme_quœks
 {

83 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

89 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

95 
	mNVME_QUIRK_DISCARD_ZEROES
 = (1 << 2),

101 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

104 
	snvme_io_·¿m
 {

105 
sÿ‰”li¡
* 
	mkv_m‘a_sg_±r
;

106 
sÿ‰”li¡
* 
	mkv_d©a_sg_±r
;

107 
	mkv_d©a_ÃÁs
;

108 
	mkv_d©a_Ën
;

111 
šlše
 
nvme_io_·¿m
 *
	$nvme_io_·¿m
(
»que¡
 *
»q
)

113  
	`blk_mq_rq_to_pdu
(
»q
);

114 
	}
}

121 
	#NVME_QUIRK_DELAY_AMOUNT
 2000

	)

123 
	envme_ù¾_¡©e
 {

124 
	mNVME_CTRL_NEW
,

125 
	mNVME_CTRL_LIVE
,

126 
	mNVME_CTRL_RESETTING
,

127 
	mNVME_CTRL_RECONNECTING
,

128 
	mNVME_CTRL_DELETING
,

129 
	mNVME_CTRL_DEAD
,

132 
	snvme_ù¾
 {

133 
nvme_ù¾_¡©e
 
	m¡©e
;

134 
¥šlock_t
 
	mlock
;

135 cÚ¡ 
nvme_ù¾_İs
 *
	mİs
;

136 
»que¡_queue
 *
	madmš_q
;

137 
»que¡_queue
 *
	mcÚÃù_q
;

138 
deviû
 *
	mdev
;

139 
k»f
 
	mk»f
;

140 
	mš¡ªû
;

141 
blk_mq_g_£t
 *
	mg£t
;

142 
li¡_h—d
 
	mÇme¥aûs
;

143 
mu‹x
 
	mÇme¥aûs_mu‹x
;

144 
deviû
 *
	mdeviû
;

145 
li¡_h—d
 
	mnode
;

146 
ida
 
	mns_ida
;

148 
	mÇme
[12];

149 
	m£rŸl
[20];

150 
	mmod–
[40];

151 
	mfœmw¬e_»v
[8];

152 
u16
 
	múid
;

154 
u32
 
	mù¾_cÚfig
;

156 
u32
 
	m·ge_size
;

157 
u32
 
	mmax_hw_£ùÜs
;

158 
u32
 
	m¡re_size
;

159 
u16
 
	mÚcs
;

160 
u16
 
	mvid
;

161 
©omic_t
 
	mabÜt_lim™
;

162 
u8
 
	mev’t_lim™
;

163 
u8
 
	mvwc
;

164 
u32
 
	mvs
;

165 
u32
 
	msgls
;

166 
u16
 
	mkas
;

167 
	mk©o
;

168 
boŞ
 
	msubsy¡em
;

169 
	mquœks
;

170 
wÜk_¡ruù
 
	msÿn_wÜk
;

171 
wÜk_¡ruù
 
	masync_ev’t_wÜk
;

172 
d–ayed_wÜk
 
	mka_wÜk
;

175 
u16
 
	msqsize
;

176 
u32
 
	mioccsz
;

177 
u32
 
	miÜcsz
;

178 
u16
 
	micdoff
;

179 
u16
 
	mmaxcmd
;

180 
nvmf_ù¾_İtiÚs
 *
	mİts
;

186 
	snvme_ns
 {

187 
li¡_h—d
 
	mli¡
;

189 
nvme_ù¾
 *
	mù¾
;

190 
»que¡_queue
 *
	mqueue
;

191 
g’disk
 *
	mdisk
;

192 
nvm_dev
 *
	mndev
;

193 
k»f
 
	mk»f
;

194 
	mš¡ªû
;

196 
u8
 
	meui
[8];

197 
u8
 
	muuid
[16];

199 
	mns_id
;

200 
	mlba_shiá
;

201 
u16
 
	mms
;

202 
boŞ
 
	mext
;

203 
u8
 
	mpi_ty³
;

204 
	mæags
;

206 
	#NVME_NS_REMOVING
 0

	)

207 
	#NVME_NS_DEAD
 1

	)

209 
u64
 
	mmode_£Ëù_num_blocks
;

210 
u32
 
	mmode_£Ëù_block_Ën
;

213 
	snvme_ù¾_İs
 {

214 cÚ¡ *
	mÇme
;

215 
moduË
 *
	mmoduË
;

216 
boŞ
 
	mis_çbrics
;

217 (*
	m»g_»ad32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 *
	mv®
);

218 (*
	m»g_wr™e32
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, u32 
	mv®
);

219 (*
	m»g_»ad64
)(
nvme_ù¾
 *
	mù¾
, 
u32
 
	moff
, 
u64
 *
	mv®
);

220 (*
	m»£t_ù¾
)(
nvme_ù¾
 *
	mù¾
);

221 (*
	mä“_ù¾
)(
nvme_ù¾
 *
	mù¾
);

222 (*
	msubm™_async_ev’t
)(
nvme_ù¾
 *
	mù¾
, 
	m«r_idx
);

223 (*
	md–‘e_ù¾
)(
nvme_ù¾
 *
	mù¾
);

224 cÚ¡ *(*
	mg‘_subsy¢qn
)(
nvme_ù¾
 *
	mù¾
);

225 (*
	mg‘_add»ss
)(
nvme_ù¾
 *
	mù¾
, *
	mbuf
, 
	msize
);

228 
šlše
 
boŞ
 
	$nvme_ù¾_»ady
(
nvme_ù¾
 *
ù¾
)

230 
u32
 
v®
 = 0;

232 ià(
ù¾
->
İs
->
	`»g_»ad32
(ù¾, 
NVME_REG_CSTS
, &
v®
))

233  
çl£
;

234  
v®
 & 
NVME_CSTS_RDY
;

235 
	}
}

237 
šlše
 
	$nvme_»£t_subsy¡em
(
nvme_ù¾
 *
ù¾
)

239 ià(!
ù¾
->
subsy¡em
)

240  -
ENOTTY
;

241  
ù¾
->
İs
->
	`»g_wr™e32
(ù¾, 
NVME_REG_NSSR
, 0x4E564D65);

242 
	}
}

244 
šlše
 
u64
 
	$nvme_block_Ä
(
nvme_ns
 *
ns
, 
£ùÜ_t
 
£ùÜ
)

246  (
£ùÜ
 >> (
ns
->
lba_shiá
 - 9));

247 
	}
}

249 
šlše
 
	$nvme_m­_Ën
(
»que¡
 *
rq
)

251 ià(
	`»q_İ
(
rq
è=ğ
REQ_OP_DISCARD
)

252  (
nvme_dsm_¿nge
);

254  
	`blk_rq_by‹s
(
rq
);

255 
	}
}

257 
šlše
 
	$nvme_ş—nup_cmd
(
»que¡
 *
»q
)

259 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
)

260 
	`kä“
(
»q
->
com¶‘iÚ_d©a
);

261 
	}
}

263 
šlše
 
	$nvme_”rÜ_¡©us
(
u16
 
¡©us
)

265 
¡©us
 & 0x7ff) {

266 
NVME_SC_SUCCESS
:

268 
NVME_SC_CAP_EXCEEDED
:

269  -
ENOSPC
;

271  -
EIO
;

273 
	}
}

275 
šlše
 
boŞ
 
	$nvme_»q_Ãeds_»Œy
(
»que¡
 *
»q
, 
u16
 
¡©us
)

277  !(
¡©us
 & 
NVME_SC_DNR
 || 
	`blk_nÜ‘ry_»que¡
(
»q
)) &&

278 (
jiff›s
 - 
»q
->
¡¬t_time
è<„eq->
timeout
 &&

279 
»q
->
»Œ›s
 < 
nvme_max_»Œ›s
;

280 
	}
}

282 
nvme_ÿnûl_»que¡
(
»que¡
 *
»q
, *
d©a
, 
boŞ
 
»£rved
);

283 
boŞ
 
nvme_chªge_ù¾_¡©e
(
nvme_ù¾
 *
ù¾
,

284 
nvme_ù¾_¡©e
 
Ãw_¡©e
);

285 
nvme_di§bË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

286 
nvme_’abË_ù¾
(
nvme_ù¾
 *
ù¾
, 
u64
 
ÿp
);

287 
nvme_shutdown_ù¾
(
nvme_ù¾
 *
ù¾
);

288 
nvme_š™_ù¾
(
nvme_ù¾
 *
ù¾
, 
deviû
 *
dev
,

289 cÚ¡ 
nvme_ù¾_İs
 *
İs
, 
quœks
);

290 
nvme_unš™_ù¾
(
nvme_ù¾
 *
ù¾
);

291 
nvme_put_ù¾
(
nvme_ù¾
 *
ù¾
);

292 
nvme_š™_id’tify
(
nvme_ù¾
 *
ù¾
);

294 
nvme_queue_sÿn
(
nvme_ù¾
 *
ù¾
);

295 
nvme_»move_Çme¥aûs
(
nvme_ù¾
 *
ù¾
);

297 
	#NVME_NR_AERS
 1

	)

298 
nvme_com¶‘e_async_ev’t
(
nvme_ù¾
 *
ù¾
,

299 
nvme_com¶‘iÚ
 *
cqe
);

300 
nvme_queue_async_ev’ts
(
nvme_ù¾
 *
ù¾
);

302 
nvme_¡İ_queues
(
nvme_ù¾
 *
ù¾
);

303 
nvme_¡¬t_queues
(
nvme_ù¾
 *
ù¾
);

304 
nvme_kl_queues
(
nvme_ù¾
 *
ù¾
);

306 
	#NVME_QID_ANY
 -1

	)

307 
»que¡
 *
nvme_®loc_»que¡
(
»que¡_queue
 *
q
,

308 
nvme_commªd
 *
cmd
, 
æags
, 
qid
);

309 
nvme_»queue_»q
(
»que¡
 *
»q
);

310 
nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
»que¡
 *
»q
,

311 
nvme_commªd
 *
cmd
);

312 
nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

313 *
buf
, 
bufæ’
);

314 
__nvme_subm™_sync_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

315 
nvme_com¶‘iÚ
 *
cqe
, *
bufãr
, 
bufæ’
,

316 
timeout
, 
qid
, 
©_h—d
, 
æags
);

317 
nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

318 
__u£r
 *
ubufãr
, 
bufæ’
, 
u32
 *
»suÉ
,

319 
timeout
);

320 
__nvme_subm™_u£r_cmd
(
»que¡_queue
 *
q
, 
nvme_commªd
 *
cmd
,

321 
__u£r
 *
ubufãr
, 
bufæ’
,

322 
__u£r
 *
m‘a_bufãr
, 
m‘a_Ën
, 
u32
 
m‘a_£ed
,

323 
u32
 *
»suÉ
, 
timeout
);

324 
nvme_id’tify_ù¾
(
nvme_ù¾
 *
dev
, 
nvme_id_ù¾
 **
id
);

325 
nvme_id’tify_ns
(
nvme_ù¾
 *
dev
, 
nsid
,

326 
nvme_id_ns
 **
id
);

327 
nvme_g‘_log_·ge
(
nvme_ù¾
 *
dev
, 
nvme_sm¬t_log
 **
log
);

328 
nvme_g‘_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
nsid
,

329 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
);

330 
nvme_£t_ã©u»s
(
nvme_ù¾
 *
dev
, 
fid
, 
dwÜd11
,

331 *
bufãr
, 
size_t
 
buæ’
, 
u32
 *
»suÉ
);

332 
nvme_£t_queue_couÁ
(
nvme_ù¾
 *
ù¾
, *
couÁ
);

333 
nvme_¡¬t_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

334 
nvme_¡İ_k“p_®ive
(
nvme_ù¾
 *
ù¾
);

336 
	gsg_io_hdr
;

338 
nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
);

339 
nvme_sg_io32
(
nvme_ns
 *
ns
, 
¬g
);

340 
nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

);

342 #ifdeà
CONFIG_NVM


343 
nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
);

344 
nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
, 
node
,

345 cÚ¡ 
©Œibu‹_group
 *
©Œs
);

346 
nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
);

348 
šlše
 
nvme_ns
 *
	$nvme_g‘_ns_äom_dev
(
deviû
 *
dev
)

350 ià(
dev
->
ty³
->
devnode
)

351  
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

353  (
	`cÚš”_of
(
dev
, 
nvm_dev
, dev))->
´iv©e_d©a
;

354 
	}
}

356 
šlše
 
	$nvme_nvm_»gi¡”
(
nvme_ns
 *
ns
, *
disk_Çme
,

357 
node
,

358 cÚ¡ 
©Œibu‹_group
 *
©Œs
)

361 
	}
}

363 
šlše
 
	$nvme_nvm_uÄegi¡”
(
nvme_ns
 *
ns
è{
	}
};

365 
šlše
 
	$nvme_nvm_ns_suµÜ‹d
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

368 
	}
}

369 
šlše
 
nvme_ns
 *
	$nvme_g‘_ns_äom_dev
(
deviû
 *
dev
)

371  
	`dev_to_disk
(
dev
)->
´iv©e_d©a
;

372 
	}
}

375 
__š™
 
nvme_cÜe_š™
();

376 
nvme_cÜe_ex™
();

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/pci.c

15 
	~<lšux/«r.h
>

16 
	~<lšux/b™İs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/blk-mq.h
>

19 
	~<lšux/blk-mq-pci.h
>

20 
	~<lšux/ıu.h
>

21 
	~<lšux/d–ay.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/g’hd.h
>

25 
	~<lšux/hd»g.h
>

26 
	~<lšux/idr.h
>

27 
	~<lšux/š™.h
>

28 
	~<lšux/š‹¼u±.h
>

29 
	~<lšux/io.h
>

30 
	~<lšux/kdev_t.h
>

31 
	~<lšux/k”Ãl.h
>

32 
	~<lšux/mm.h
>

33 
	~<lšux/moduË.h
>

34 
	~<lšux/moduË·¿m.h
>

35 
	~<lšux/mu‹x.h
>

36 
	~<lšux/pci.h
>

37 
	~<lšux/poisÚ.h
>

38 
	~<lšux/±¿û.h
>

39 
	~<lšux/sched.h
>

40 
	~<lšux/¦ab.h
>

41 
	~<lšux/t10-pi.h
>

42 
	~<lšux/tim”.h
>

43 
	~<lšux/ty³s.h
>

44 
	~<lšux/io-64-nÚ©omic-lo-hi.h
>

45 
	~<asm/uÇligÃd.h
>

47 
	~"nvme.h
"

49 
	#NVME_Q_DEPTH
 1024

	)

50 
	#NVME_AQ_DEPTH
 256

	)

51 
	#SQ_SIZE
(
d•th
è(d•th * (
nvme_commªd
))

	)

52 
	#CQ_SIZE
(
d•th
è(d•th * (
nvme_com¶‘iÚ
))

	)

58 
	#NVME_AQ_BLKMQ_DEPTH
 (
NVME_AQ_DEPTH
 - 
NVME_NR_AERS
)

	)

60 
	gu£_th»aded_š‹¼u±s
;

61 
moduË_·¿m
(
u£_th»aded_š‹¼u±s
, , 0);

63 
boŞ
 
	gu£_cmb_sqes
 = 
Œue
;

64 
moduË_·¿m
(
u£_cmb_sqes
, 
boŞ
, 0644);

65 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

67 
wÜkqueue_¡ruù
 *
	gnvme_wÜkq
;

69 
	gnvme_dev
;

70 
	gnvme_queue
;

72 
nvme_»£t
(
nvme_dev
 *
dev
);

73 
nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
);

74 
nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
);

79 
	snvme_dev
 {

80 
nvme_queue
 **
	mqueues
;

81 
blk_mq_g_£t
 
	mg£t
;

82 
blk_mq_g_£t
 
	madmš_g£t
;

83 
u32
 
__iomem
 *
	mdbs
;

84 
deviû
 *
	mdev
;

85 
dma_poŞ
 *
	m´p_·ge_poŞ
;

86 
dma_poŞ
 *
	m´p_sm®l_poŞ
;

87 
	mqueue_couÁ
;

88 
	mÚlše_queues
;

89 
	mmax_qid
;

90 
	mq_d•th
;

91 
u32
 
	mdb_¡ride
;

92 
__iomem
 *
	mb¬
;

93 
wÜk_¡ruù
 
	m»£t_wÜk
;

94 
wÜk_¡ruù
 
	m»move_wÜk
;

95 
tim”_li¡
 
	mw©chdog_tim”
;

96 
mu‹x
 
	mshutdown_lock
;

97 
boŞ
 
	msubsy¡em
;

98 
__iomem
 *
	mcmb
;

99 
dma_addr_t
 
	mcmb_dma_addr
;

100 
u64
 
	mcmb_size
;

101 
u32
 
	mcmbsz
;

102 
u32
 
	mcmbloc
;

103 
nvme_ù¾
 
	mù¾
;

104 
com¶‘iÚ
 
	mioq_wa™
;

107 
šlše
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_ù¾
 *
ù¾
)

109  
	`cÚš”_of
(
ù¾
, 
nvme_dev
, ctrl);

110 
	}
}

116 
	snvme_queue
 {

117 
deviû
 *
	mq_dmadev
;

118 
nvme_dev
 *
	mdev
;

119 
	mœqÇme
[24];

120 
¥šlock_t
 
	mq_lock
;

121 
nvme_commªd
 *
	msq_cmds
;

122 
nvme_commªd
 
__iomem
 *
	msq_cmds_io
;

123 vŞ©
nvme_com¶‘iÚ
 *
	mcqes
;

124 
blk_mq_gs
 **
	mgs
;

125 
dma_addr_t
 
	msq_dma_addr
;

126 
dma_addr_t
 
	mcq_dma_addr
;

127 
u32
 
__iomem
 *
	mq_db
;

128 
u16
 
	mq_d•th
;

129 
s16
 
	mcq_veùÜ
;

130 
u16
 
	msq_
;

131 
u16
 
	mcq_h—d
;

132 
u16
 
	mqid
;

133 
u8
 
	mcq_pha£
;

134 
u8
 
	mcqe_£’
;

143 
	snvme_iod
 {

144 
nvme_io_·¿m
 
	m·¿m
;

145 
	mkv_cmd
;

146 
	m»rv
;

147 
nvme_queue
 *
	mnvmeq
;

148 
	mabÜ‹d
;

149 
	mÅages
;

150 
	mÃÁs
;

151 
	mËngth
;

152 
dma_addr_t
 
	mfœ¡_dma
;

153 
sÿ‰”li¡
 
	mm‘a_sg
;

154 
sÿ‰”li¡
 *
	msg
;

155 
sÿ‰”li¡
 
	mšlše_sg
[0];

161 
šlše
 
	$_nvme_check_size
()

163 
	`BUILD_BUG_ON
((
nvme_rw_commªd
) != 64);

164 
	`BUILD_BUG_ON
((
nvme_ü—‹_cq
) != 64);

165 
	`BUILD_BUG_ON
((
nvme_ü—‹_sq
) != 64);

166 
	`BUILD_BUG_ON
((
nvme_d–‘e_queue
) != 64);

167 
	`BUILD_BUG_ON
((
nvme_ã©u»s
) != 64);

168 
	`BUILD_BUG_ON
((
nvme_fÜm©_cmd
) != 64);

169 
	`BUILD_BUG_ON
((
nvme_abÜt_cmd
) != 64);

170 
	`BUILD_BUG_ON
((
nvme_commªd
) != 64);

171 
	`BUILD_BUG_ON
((
nvme_id_ù¾
) != 4096);

172 
	`BUILD_BUG_ON
((
nvme_id_ns
) != 4096);

173 
	`BUILD_BUG_ON
((
nvme_lba_¿nge_ty³
) != 64);

174 
	`BUILD_BUG_ON
((
nvme_sm¬t_log
) != 512);

175 
	}
}

180 
	#NVME_INT_PAGES
 2

	)

181 
	#NVME_INT_BYTES
(
dev
è(
NVME_INT_PAGES
 * (dev)->
ù¾
.
·ge_size
)

	)

188 
	$nvme_Åages
(
size
, 
nvme_dev
 *
dev
)

190 
Å½s
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
ù¾
.
·ge_size
,

191 
dev
->
ù¾
.
·ge_size
);

192  
	`DIV_ROUND_UP
(8 * 
Å½s
, 
PAGE_SIZE
 - 8);

193 
	}
}

195 
	$nvme_iod_®loc_size
(
nvme_dev
 *
dev
,

196 
size
, 
n£g
)

198  (
__Ë64
 *è* 
	`nvme_Åages
(
size
, 
dev
) +

199 (
sÿ‰”li¡
è* 
n£g
;

200 
	}
}

202 
	$nvme_cmd_size
(
nvme_dev
 *
dev
)

204  (
nvme_iod
) +

205 
	`nvme_iod_®loc_size
(
dev
, 
	`NVME_INT_BYTES
(dev), 
NVME_INT_PAGES
);

206 
	}
}

208 
	$nvmeq_œq
(
nvme_queue
 *
nvmeq
)

210  
	`pci_œq_veùÜ
(
	`to_pci_dev
(
nvmeq
->
dev
->dev),‚vmeq->
cq_veùÜ
);

211 
	}
}

213 
	$nvme_admš_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

214 
hùx_idx
)

216 
nvme_dev
 *
dev
 = 
d©a
;

217 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

219 
	`WARN_ON
(
hùx_idx
 != 0);

220 
	`WARN_ON
(
dev
->
admš_g£t
.
gs
[0] !ğ
hùx
->tags);

221 
	`WARN_ON
(
nvmeq
->
gs
);

223 
hùx
->
driv”_d©a
 = 
nvmeq
;

224 
nvmeq
->
gs
 = &
dev
->
admš_g£t
.tags[0];

226 
	}
}

228 
	$nvme_admš_ex™_hùx
(
blk_mq_hw_ùx
 *
hùx
, 
hùx_idx
)

230 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

232 
nvmeq
->
gs
 = 
NULL
;

233 
	}
}

235 
	$nvme_admš_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

236 
hùx_idx
, 
rq_idx
,

237 
numa_node
)

239 
nvme_dev
 *
dev
 = 
d©a
;

240 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

241 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

243 
	`BUG_ON
(!
nvmeq
);

244 
iod
->
nvmeq
 =‚vmeq;

246 
	}
}

248 
	$nvme_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

249 
hùx_idx
)

251 
nvme_dev
 *
dev
 = 
d©a
;

252 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

254 ià(!
nvmeq
->
gs
)

255 
nvmeq
->
gs
 = &
dev
->
g£t
.gs[
hùx_idx
];

257 
	`WARN_ON
(
dev
->
g£t
.
gs
[
hùx_idx
] !ğ
hùx
->tags);

258 
hùx
->
driv”_d©a
 = 
nvmeq
;

260 
	}
}

262 
	$nvme_š™_»que¡
(*
d©a
, 
»que¡
 *
»q
,

263 
hùx_idx
, 
rq_idx
,

264 
numa_node
)

266 
nvme_dev
 *
dev
 = 
d©a
;

267 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

268 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
hùx_idx
 + 1];

270 
	`BUG_ON
(!
nvmeq
);

271 
iod
->
nvmeq
 =‚vmeq;

273 
	}
}

275 
	$nvme_pci_m­_queues
(
blk_mq_g_£t
 *
£t
)

277 
nvme_dev
 *
dev
 = 
£t
->
driv”_d©a
;

279  
	`blk_mq_pci_m­_queues
(
£t
, 
	`to_pci_dev
(
dev
->dev));

280 
	}
}

289 
	$__nvme_subm™_cmd
(
nvme_queue
 *
nvmeq
,

290 
nvme_commªd
 *
cmd
)

292 
u16
 

 = 
nvmeq
->
sq_
;

294 ià(
nvmeq
->
sq_cmds_io
)

295 
	`memıy_toio
(&
nvmeq
->
sq_cmds_io
[

], 
cmd
, (*cmd));

297 
	`memıy
(&
nvmeq
->
sq_cmds
[

], 
cmd
, (*cmd));

299 ià(++

 =ğ
nvmeq
->
q_d•th
)

300 

 = 0;

301 
	`wr™–
(

, 
nvmeq
->
q_db
);

302 
nvmeq
->
sq_
 = 

;

303 
	}
}

305 
__Ë64
 **
	$iod_li¡
(
»que¡
 *
»q
)

307 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

308  (
__Ë64
 **)(
iod
->
sg
 + 
»q
->
Ä_phys_£gm’ts
);

309 
	}
}

311 
	$__nvme_š™_iod
(
»que¡
 *
rq
, 
size
,

312 
nvme_dev
 *
dev
, 
boŞ
 
kv
)

314 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

315 
n£g
;

316 ià(
kv
) {

317 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

318 
n£g
 = 
·¿m
->
kv_d©a_ÃÁs
;

320 
n£g
 = 
rq
->
Ä_phys_£gm’ts
;

323 ià(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

324 
iod
->
sg
 = 
	`km®loc
(
	`nvme_iod_®loc_size
(
dev
, 
size
, 
n£g
), 
GFP_ATOMIC
);

325 ià(!
iod
->
sg
)

326  
BLK_MQ_RQ_QUEUE_BUSY
;

328 
iod
->
sg
 = iod->
šlše_sg
;

330 
iod
->
kv_cmd
 = 0;

331 
iod
->
abÜ‹d
 = 0;

332 
iod
->
Åages
 = -1;

333 
iod
->
ÃÁs
 = 0;

334 
iod
->
Ëngth
 = 
size
;

336 ià(!(
rq
->
cmd_æags
 & 
REQ_DONTPREP
)) {

337 
rq
->
»Œ›s
 = 0;

338 
rq
->
cmd_æags
 |ğ
REQ_DONTPREP
;

341 
	}
}

344 
	$nvme_š™_iod
(
»que¡
 *
rq
, 
size
,

345 
nvme_dev
 *
dev
)

347  
	`__nvme_š™_iod
(
rq
, 
size
, 
dev
, 
çl£
);

348 
	}
}

350 
	$nvme_š™_iod_fÜ_kv
(
»que¡
 *
rq
, 
size
,

351 
nvme_dev
 *
dev
)

353  
	`__nvme_š™_iod
(
rq
, 
size
, 
dev
, 
Œue
);

354 
	}
}

356 
	$nvme_ä“_iod
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

358 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

359 cÚ¡ 
Ï¡_´p
 = 
dev
->
ù¾
.
·ge_size
 / 8 - 1;

360 
i
;

361 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

362 
dma_addr_t
 
´p_dma
 = 
iod
->
fœ¡_dma
;

364 
	`nvme_ş—nup_cmd
(
»q
);

366 ià(
iod
->
Åages
 == 0)

367 
	`dma_poŞ_ä“
(
dev
->
´p_sm®l_poŞ
, 
li¡
[0], 
´p_dma
);

368 
i
 = 0; i < 
iod
->
Åages
; i++) {

369 
__Ë64
 *
´p_li¡
 = 
li¡
[
i
];

370 
dma_addr_t
 
Ãxt_´p_dma
 = 
	`Ë64_to_ıu
(
´p_li¡
[
Ï¡_´p
]);

371 
	`dma_poŞ_ä“
(
dev
->
´p_·ge_poŞ
, 
´p_li¡
, 
´p_dma
);

372 
´p_dma
 = 
Ãxt_´p_dma
;

375 ià(
iod
->
sg
 !ğiod->
šlše_sg
)

376 
	`kä“
(
iod
->
sg
);

377 
	}
}

379 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


380 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

382 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
v
)

383 
pi
->
»f_g
 = 
	`ıu_to_be32
(
p
);

384 
	}
}

386 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

388 ià(
	`be32_to_ıu
(
pi
->
»f_g
è=ğ
p
)

389 
pi
->
»f_g
 = 
	`ıu_to_be32
(
v
);

390 
	}
}

402 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

403 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

405 
nvme_ns
 *
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

406 
bio_š‹gr™y_·ylßd
 *
b
;

407 
t10_pi_tu¶e
 *
pi
;

408 *
p
, *
pm­
;

409 
u32
 
i
, 
Æb
, 
ts
, 
phys
, 
vœt
;

411 ià(!
ns
->
pi_ty³
 ||‚s->pi_ty³ =ğ
NVME_NS_DPS_PI_TYPE3
)

414 
b
 = 
	`bio_š‹gr™y
(
»q
->
bio
);

415 ià(!
b
)

418 
pm­
 = 
	`km­_©omic
(
b
->
b_vec
->
bv_·ge
è+ b->b_vec->
bv_off£t
;

420 
p
 = 
pm­
;

421 
vœt
 = 
	`b_g‘_£ed
(
b
);

422 
phys
 = 
	`nvme_block_Ä
(
ns
, 
	`blk_rq_pos
(
»q
));

423 
Æb
 = (
	`blk_rq_by‹s
(
»q
è>> 
ns
->
lba_shiá
);

424 
ts
 = 
ns
->
disk
->
queue
->
š‹gr™y
.
tu¶e_size
;

426 
i
 = 0; i < 
Æb
; i++, 
vœt
++, 
phys
++) {

427 
pi
 = (
t10_pi_tu¶e
 *)
p
;

428 
	`dif_sw­
(
phys
, 
vœt
, 
pi
);

429 
p
 +ğ
ts
;

431 
	`kunm­_©omic
(
pm­
);

432 
	}
}

434 
	$nvme_dif_»m­
(
»que¡
 *
»q
,

435 (*
dif_sw­
)(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
))

437 
	}
}

438 
	$nvme_dif_´•
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

440 
	}
}

441 
	$nvme_dif_com¶‘e
(
u32
 
p
, u32 
v
, 
t10_pi_tu¶e
 *
pi
)

443 
	}
}

446 
boŞ
 
	$nvme_£tup_´ps
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

447 
tÙ®_Ën
)

449 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

450 
dma_poŞ
 *
poŞ
;

451 
Ëngth
 = 
tÙ®_Ën
;

452 
sÿ‰”li¡
 *
sg
 = 
iod
->sg;

453 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

454 
u64
 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

455 
u32
 
·ge_size
 = 
dev
->
ù¾
.page_size;

456 
off£t
 = 
dma_addr
 & (
·ge_size
 - 1);

457 
__Ë64
 *
´p_li¡
;

458 
__Ë64
 **
li¡
 = 
	`iod_li¡
(
»q
);

459 
dma_addr_t
 
´p_dma
;

460 
Å½s
, 
i
;

462 
Ëngth
 -ğ(
·ge_size
 - 
off£t
);

463 ià(
Ëngth
 <= 0)

464  
Œue
;

466 
dma_Ën
 -ğ(
·ge_size
 - 
off£t
);

467 ià(
dma_Ën
) {

468 
dma_addr
 +ğ(
·ge_size
 - 
off£t
);

470 
sg
 = 
	`sg_Ãxt
(sg);

471 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

472 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

475 ià(
Ëngth
 <ğ
·ge_size
) {

476 
iod
->
fœ¡_dma
 = 
dma_addr
;

477  
Œue
;

480 
Å½s
 = 
	`DIV_ROUND_UP
(
Ëngth
, 
·ge_size
);

481 ià(
Å½s
 <= (256 / 8)) {

482 
poŞ
 = 
dev
->
´p_sm®l_poŞ
;

483 
iod
->
Åages
 = 0;

485 
poŞ
 = 
dev
->
´p_·ge_poŞ
;

486 
iod
->
Åages
 = 1;

489 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

490 ià(!
´p_li¡
) {

491 
iod
->
fœ¡_dma
 = 
dma_addr
;

492 
iod
->
Åages
 = -1;

493  
çl£
;

495 
li¡
[0] = 
´p_li¡
;

496 
iod
->
fœ¡_dma
 = 
´p_dma
;

497 
i
 = 0;

499 ià(
i
 =ğ
·ge_size
 >> 3) {

500 
__Ë64
 *
Şd_´p_li¡
 = 
´p_li¡
;

501 
´p_li¡
 = 
	`dma_poŞ_®loc
(
poŞ
, 
GFP_ATOMIC
, &
´p_dma
);

502 ià(!
´p_li¡
)

503  
çl£
;

504 
li¡
[
iod
->
Åages
++] = 
´p_li¡
;

505 
´p_li¡
[0] = 
Şd_´p_li¡
[
i
 - 1];

506 
Şd_´p_li¡
[
i
 - 1] = 
	`ıu_to_Ë64
(
´p_dma
);

507 
i
 = 1;

509 
´p_li¡
[
i
++] = 
	`ıu_to_Ë64
(
dma_addr
);

510 
dma_Ën
 -ğ
·ge_size
;

511 
dma_addr
 +ğ
·ge_size
;

512 
Ëngth
 -ğ
·ge_size
;

513 ià(
Ëngth
 <= 0)

515 ià(
dma_Ën
 > 0)

517 
	`BUG_ON
(
dma_Ën
 < 0);

518 
sg
 = 
	`sg_Ãxt
(sg);

519 
dma_addr
 = 
	`sg_dma_add»ss
(
sg
);

520 
dma_Ën
 = 
	`sg_dma_Ën
(
sg
);

523  
Œue
;

524 
	}
}

526 
	$nvme_kv_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

527 
size
, 
nvme_commªd
 *
cmnd
)

529 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

530 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

531 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

532 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

534 ià(
·¿m
->
kv_d©a_sg_±r
) {

535 
sÿ‰”li¡
* 
sg
;

536 
i
;

538 
	`fÜ_—ch_sg
(
·¿m
->
kv_d©a_sg_±r
, 
sg
,…¬am->
kv_d©a_ÃÁs
, 
i
) {

539 
iod
->
sg
[
i
] = *sg;

541 
iod
->
ÃÁs
 = 
·¿m
->
kv_d©a_ÃÁs
;

542 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

543 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

544 
DMA_ATTR_NO_WARN
))

545 
out
;

547 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
size
))

548 
out_unm­
;

550 
cmnd
->
kv_¡Üe
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

551 
cmnd
->
kv_¡Üe
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

553 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

555 ià(
·¿m
->
kv_m‘a_sg_±r
)

557 ià(!
	`dma_m­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
))

558 
out_unm­
;

559 
cmnd
->
kv_¡Üe
.
key_´p
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
·¿m
->
kv_m‘a_sg_±r
));

561  
BLK_MQ_RQ_QUEUE_OK
;

563 
out_unm­
:

564 ià(
·¿m
->
kv_d©a_sg_±r
)

565 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

566 
out
:

567  
»t
;

568 
	}
}

571 
	$nvme_kv_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

573 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

574 
nvme_io_·¿m
* 
·¿m
 = &
iod
->param;

575 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
DMA_BIDIRECTIONAL
;

577 ià(
·¿m
->
kv_d©a_sg_±r
) {

578 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

580 ià(
·¿m
->
kv_m‘a_sg_±r
)

582 
	`dma_unm­_sg
(
dev
->dev, 
·¿m
->
kv_m‘a_sg_±r
, 1, 
DMA_BIDIRECTIONAL
);

584 
	`nvme_ä“_iod
(
dev
, 
»q
);

585 
	}
}

588 
	$nvme_m­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
,

589 
size
, 
nvme_commªd
 *
cmnd
)

591 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

592 
»que¡_queue
 *
q
 = 
»q
->q;

593 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

594 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

595 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

597 ià(
	`is_kv_cmd
(
cmnd
->
commÚ
.
İcode
)) {

598  
	`nvme_kv_m­_d©a
(
dev
, 
»q
, 
size
, 
cmnd
);

600 
	`sg_š™_bË
(
iod
->
sg
, 
»q
->
Ä_phys_£gm’ts
);

601 
iod
->
ÃÁs
 = 
	`blk_rq_m­_sg
(
q
, 
»q
, iod->
sg
);

602 ià(!
iod
->
ÃÁs
)

603 
out
;

605 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

606 ià(!
	`dma_m­_sg_©Œs
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
,

607 
DMA_ATTR_NO_WARN
))

608 
out
;

610 ià(!
	`nvme_£tup_´ps
(
dev
, 
»q
, 
size
))

611 
out_unm­
;

613 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

614 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

615 ià(
	`blk_rq_couÁ_š‹gr™y_sg
(
q
, 
»q
->
bio
) != 1)

616 
out_unm­
;

618 
	`sg_š™_bË
(&
iod
->
m‘a_sg
, 1);

619 ià(
	`blk_rq_m­_š‹gr™y_sg
(
q
, 
»q
->
bio
, &
iod
->
m‘a_sg
) != 1)

620 
out_unm­
;

622 ià(
	`rq_d©a_dœ
(
»q
))

623 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_´•
);

625 ià(!
	`dma_m­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
))

626 
out_unm­
;

629 
cmnd
->
rw
.
d±r
.
´p1
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
iod
->
sg
));

630 
cmnd
->
rw
.
d±r
.
´p2
 = 
	`ıu_to_Ë64
(
iod
->
fœ¡_dma
);

631 ià(
	`blk_š‹gr™y_rq
(
»q
))

632 
cmnd
->
rw
.
m‘ad©a
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(&
iod
->
m‘a_sg
));

633  
BLK_MQ_RQ_QUEUE_OK
;

635 
out_unm­
:

636 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

637 
out
:

638  
»t
;

639 
	}
}

641 
	$nvme_unm­_d©a
(
nvme_dev
 *
dev
, 
»que¡
 *
»q
)

643 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

644 
dma_d©a_dœeùiÚ
 
dma_dœ
 = 
	`rq_d©a_dœ
(
»q
) ?

645 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

647 ià(
iod
->
kv_cmd
) {

648  
	`nvme_kv_unm­_d©a
(
dev
, 
»q
);

651 ià(
iod
->
ÃÁs
) {

652 
	`dma_unm­_sg
(
dev
->dev, 
iod
->
sg
, iod->
ÃÁs
, 
dma_dœ
);

653 ià(
	`blk_š‹gr™y_rq
(
»q
)) {

654 ià(!
	`rq_d©a_dœ
(
»q
))

655 
	`nvme_dif_»m­
(
»q
, 
nvme_dif_com¶‘e
);

656 
	`dma_unm­_sg
(
dev
->dev, &
iod
->
m‘a_sg
, 1, 
dma_dœ
);

660 
	`nvme_ä“_iod
(
dev
, 
»q
);

661 
	}
}

666 
	$nvme_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

667 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

669 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

670 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

671 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

672 
»que¡
 *
»q
 = 
bd
->
rq
;

673 
nvme_commªd
 
cmnd
;

674 
m­_Ën
;

675 
»t
 = 
BLK_MQ_RQ_QUEUE_OK
;

676 
boŞ
 
b_kv_cmd
 = 
çl£
;

682 ià(
ns
 &&‚s->
ms
 && !
	`blk_š‹gr™y_rq
(
»q
)) {

683 ià(!(
ns
->
pi_ty³
 &&‚s->
ms
 == 8) &&

684 
»q
->
cmd_ty³
 !ğ
REQ_TYPE_DRV_PRIV
) {

685 
	`blk_mq_’d_»que¡
(
»q
, -
EFAULT
);

686  
BLK_MQ_RQ_QUEUE_OK
;

691 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
»q
, &
cmnd
);

692 ià(
»t
)

693 
out
;

695 
b_kv_cmd
 = 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
);

697 ià(
b_kv_cmd
) {

698 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

699 
nvme_io_·¿m
 *
·¿m
 = &
iod
->param;

700 
m­_Ën
 = 
·¿m
->
kv_d©a_Ën
;

701 
»t
 = 
	`nvme_š™_iod_fÜ_kv
(
»q
, 
m­_Ën
, 
dev
);

702 ià(
»t
)

703 
out
;

704 
iod
->
kv_cmd
 = 1;

706 
m­_Ën
 = 
	`nvme_m­_Ën
(
»q
);

707 
»t
 = 
	`nvme_š™_iod
(
»q
, 
m­_Ën
, 
dev
);

708 ià(
»t
)

709 
out
;

713 ià(!
b_kv_cmd
) {

714 #ifdeà
REPORT_NON_KV


715 
	`´_”r
("nvme_queue_rq:‚Ú-kv-İcod(%02xèns_id(%d)\n", 
cmnd
.
commÚ
.
İcode
, ((
ns
)?‚s->
ns_id
 : 0));

719 ià(
»q
->
Ä_phys_£gm’ts
 || 
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
))

720 
»t
 = 
	`nvme_m­_d©a
(
dev
, 
»q
, 
m­_Ën
, &
cmnd
);

722 ià(
»t
)

723 
out
;

725 
cmnd
.
commÚ
.
commªd_id
 = 
»q
->
g
;

726 
	`blk_mq_¡¬t_»que¡
(
»q
);

727 #ifdeà
KV_NVME_DUMMY_OP


728 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

729 #ifdeà
KV_NVME_DUMMY_OP_REPORT


730 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

731 
	`´_”r
("[dump‚vme kv comand]\n");

732 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

733 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

734 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

735 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

736 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

737 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

738 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

739 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

740 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

741 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

742 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

743 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

744 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

745 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

746 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

747 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

748 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

749 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

751 ià(
»q
->
¥ecŸl
) {

752 
nvme_com¶‘iÚ
 
cqe
;

753 
	`mem£t
(&
cqe
, 0, (cqe));

754 
cqe
.
commªd_id
 = 
cmnd
.
commÚ
.command_id;

755 
cqe
.
¡©us
 = 0;

756 ià(
	`is_kv_»Œ›ve_cmd
(
cmnd
.
commÚ
.
İcode
)) {

757 
cqe
.
»suÉ
 = 
cmnd
.
commÚ
.
cdw10
[5];

759 
	`memıy
(
»q
->
¥ecŸl
, &
cqe
, (cqe));

761 
	`blk_mq_com¶‘e_»que¡
(
»q
, 0);

762  
BLK_MQ_RQ_QUEUE_OK
;

765 #ifdeà
KV_NVME_OP_REPORT


766 ià(
	`is_kv_cmd
(
cmnd
.
commÚ
.
İcode
)) {

767 
__u32
 *
d©a
 = (__u32*è
cmnd
.
commÚ
.
cdw2
;

768 
	`´_”r
("[dump‚vme kv comand]\n");

769 
	`´_”r
("\tİcode:(%02x)\n", 
cmnd
.
commÚ
.
İcode
);

770 
	`´_”r
("\tæags:(%02x)\n", 
cmnd
.
commÚ
.
æags
);

771 
	`´_”r
("\tcommªd id:(%04x)\n", 
cmnd
.
commÚ
.
commªd_id
);

772 
	`´_”r
("\Š id:(%08x)\n", 
cmnd
.
commÚ
.
nsid
);

773 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

774 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

775 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

776 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

777 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

778 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

779 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

780 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

781 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

782 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

783 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

784 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

785 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

786 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

789 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

790 ià(
	`uÆik–y
(
nvmeq
->
cq_veùÜ
 < 0)) {

791 ià(
ns
 && !
	`‹¡_b™
(
NVME_NS_DEAD
, &ns->
æags
))

792 
»t
 = 
BLK_MQ_RQ_QUEUE_BUSY
;

794 
»t
 = 
BLK_MQ_RQ_QUEUE_ERROR
;

795 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

796 
out
;

798 
	`__nvme_subm™_cmd
(
nvmeq
, &
cmnd
);

799 
	`nvme_´oûss_cq
(
nvmeq
);

800 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

801  
BLK_MQ_RQ_QUEUE_OK
;

802 
out
:

803 
	`nvme_ä“_iod
(
dev
, 
»q
);

804  
»t
;

805 
	}
}

808 #ià
defšed
(
REPORT_NON_KV
è|| defšed(
KV_NVME_TRACE
)

810 
nvme_commªd
 
	gcmd
;

811 
nvme_ns
 *
	gns
 = 
NULL
;

812 
	gcmd
.
	gcommÚ
.
	gnsid
 = 0;

813 ià(
	g»q
->
	gcmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

814 
memıy
(&
cmd
, 
»q
->cmd,  (
nvme_commªd
));

816 ià(
»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
) {

817 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

818 } ià(
»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
) {

819 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_dsm
;

821 
	gcmd
.
	gcommÚ
.
	gİcode
 = (
rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
: 
nvme_cmd_»ad
);

823 ià(
	g»q
->
	grq_disk
) {

824 
	gns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

825 ià(
	gns
è
	gcmd
.
	gcommÚ
.
	gnsid
 = 
ns
->
ns_id
;

828 ià(
	giod
->
	gkv_cmd
)

830 #ifdeà
KV_NVME_TRACE


831 
´_”r
("nvme_com¶e_rq: opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

834 #ifdeà
REPORT_NON_KV


835 
´_”r
("nvme_com¶e_rq:‚Ú kv opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

843 
	$nvme_com¶‘e_rq
(
»que¡
 *
»q
)

845 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

846 
nvme_dev
 *
dev
 = 
iod
->
nvmeq
->dev;

847 
”rÜ
 = 0;

848 #ifdeà
REPORT_NON_KV


849 ià(!
iod
->
kv_cmd
) {

850 
nvme_commªd
 
cmd
;

851 
nvme_ns
 *
ns
 = 
NULL
;

852 
cmd
.
commÚ
.
nsid
 = 0;

853 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

854 
	`memıy
(&
cmd
, 
»q
->cmd,  (
nvme_commªd
));

856 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
) {

857 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

858 } ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
) {

859 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_dsm
;

861 
cmd
.
commÚ
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
: 
nvme_cmd_»ad
);

863 ià(
»q
->
rq_disk
) {

864 
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

865 ià(
ns
è
cmd
.
commÚ
.
nsid
 =‚s->
ns_id
;

868 
	`´_”r
("nvme_com¶e_rq:‚Ú kv opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

871 
	`nvme_unm­_d©a
(
dev
, 
»q
);

873 ià(
	`uÆik–y
(
»q
->
”rÜs
)) {

874 ià(
	`nvme_»q_Ãeds_»Œy
(
»q
,„eq->
”rÜs
)) {

875 
»q
->
»Œ›s
++;

876 
	`nvme_»queue_»q
(
»q
);

880 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

881 
”rÜ
 = 
»q
->
”rÜs
;

883 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
»q
->
”rÜs
);

886 ià(
	`uÆik–y
(
iod
->
abÜ‹d
)) {

887 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

889 
»q
->
”rÜs
);

891 
	`blk_mq_’d_»que¡
(
»q
, 
”rÜ
);

892 
	}
}

895 
šlše
 
boŞ
 
	$nvme_cqe_v®id
(
nvme_queue
 *
nvmeq
, 
u16
 
h—d
,

896 
u16
 
pha£
)

898  (
	`Ë16_to_ıu
(
nvmeq
->
cqes
[
h—d
].
¡©us
è& 1è=ğ
pha£
;

899 
	}
}

901 
	$__nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
, *
g
)

903 
u16
 
h—d
, 
pha£
;

905 
h—d
 = 
nvmeq
->
cq_h—d
;

906 
pha£
 = 
nvmeq
->
cq_pha£
;

908 
	`nvme_cqe_v®id
(
nvmeq
, 
h—d
, 
pha£
)) {

909 
nvme_com¶‘iÚ
 
cqe
 = 
nvmeq
->
cqes
[
h—d
];

910 
»que¡
 *
»q
;

912 ià(++
h—d
 =ğ
nvmeq
->
q_d•th
) {

913 
h—d
 = 0;

914 
pha£
 = !phase;

917 ià(
g
 && *g =ğ
cqe
.
commªd_id
)

918 *
g
 = -1;

920 ià(
	`uÆik–y
(
cqe
.
commªd_id
 >ğ
nvmeq
->
q_d•th
)) {

921 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

923 
cqe
.
commªd_id
, 
	`Ë16_to_ıu
(cqe.
sq_id
));

933 ià(
	`uÆik–y
(
nvmeq
->
qid
 == 0 &&

934 
cqe
.
commªd_id
 >ğ
NVME_AQ_BLKMQ_DEPTH
)) {

935 
	`nvme_com¶‘e_async_ev’t
(&
nvmeq
->
dev
->
ù¾
, &
cqe
);

939 
»q
 = 
	`blk_mq_g_to_rq
(*
nvmeq
->
gs
, 
cqe
.
commªd_id
);

940 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
 &&„eq->
¥ecŸl
)

941 
	`memıy
(
»q
->
¥ecŸl
, &
cqe
, (cqe));

942 
	`blk_mq_com¶‘e_»que¡
(
»q
, 
	`Ë16_to_ıu
(
cqe
.
¡©us
) >> 1);

952 ià(
h—d
 =ğ
nvmeq
->
cq_h—d
 && 
pha£
 =ğnvmeq->
cq_pha£
)

955 ià(
	`lik–y
(
nvmeq
->
cq_veùÜ
 >= 0))

956 
	`wr™–
(
h—d
, 
nvmeq
->
q_db
 +‚vmeq->
dev
->
db_¡ride
);

957 
nvmeq
->
cq_h—d
 = 
h—d
;

958 
nvmeq
->
cq_pha£
 = 
pha£
;

960 
nvmeq
->
cqe_£’
 = 1;

961 
	}
}

963 
	$nvme_´oûss_cq
(
nvme_queue
 *
nvmeq
)

965 
	`__nvme_´oûss_cq
(
nvmeq
, 
NULL
);

966 
	}
}

968 
œq»tuº_t
 
	$nvme_œq
(
œq
, *
d©a
)

970 
œq»tuº_t
 
»suÉ
;

971 
nvme_queue
 *
nvmeq
 = 
d©a
;

972 
	`¥š_lock
(&
nvmeq
->
q_lock
);

973 
	`nvme_´oûss_cq
(
nvmeq
);

974 
»suÉ
 = 
nvmeq
->
cqe_£’
 ? 
IRQ_HANDLED
 : 
IRQ_NONE
;

975 
nvmeq
->
cqe_£’
 = 0;

976 
	`¥š_uÆock
(&
nvmeq
->
q_lock
);

977  
»suÉ
;

978 
	}
}

980 
œq»tuº_t
 
	$nvme_œq_check
(
œq
, *
d©a
)

982 
nvme_queue
 *
nvmeq
 = 
d©a
;

983 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
))

984  
IRQ_WAKE_THREAD
;

985  
IRQ_NONE
;

986 
	}
}

988 
	$nvme_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

990 
nvme_queue
 *
nvmeq
 = 
hùx
->
driv”_d©a
;

992 ià(
	`nvme_cqe_v®id
(
nvmeq
,‚vmeq->
cq_h—d
,‚vmeq->
cq_pha£
)) {

993 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

994 
	`__nvme_´oûss_cq
(
nvmeq
, &
g
);

995 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

997 ià(
g
 == -1)

1002 
	}
}

1004 
	$nvme_pci_subm™_async_ev’t
(
nvme_ù¾
 *
ù¾
, 
«r_idx
)

1006 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

1007 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1008 
nvme_commªd
 
c
;

1010 
	`mem£t
(&
c
, 0, (c));

1011 
c
.
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1012 
c
.
commÚ
.
commªd_id
 = 
NVME_AQ_BLKMQ_DEPTH
 + 
«r_idx
;

1014 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1015 
	`__nvme_subm™_cmd
(
nvmeq
, &
c
);

1016 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1017 
	}
}

1019 
	$ad­‹r_d–‘e_queue
(
nvme_dev
 *
dev
, 
u8
 
İcode
, 
u16
 
id
)

1021 
nvme_commªd
 
c
;

1023 
	`mem£t
(&
c
, 0, (c));

1024 
c
.
d–‘e_queue
.
İcode
 = opcode;

1025 
c
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
id
);

1027  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1028 
	}
}

1030 
	$ad­‹r_®loc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1031 
nvme_queue
 *
nvmeq
)

1033 
nvme_commªd
 
c
;

1034 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_CQ_IRQ_ENABLED
;

1040 
	`mem£t
(&
c
, 0, (c));

1041 
c
.
ü—‹_cq
.
İcode
 = 
nvme_admš_ü—‹_cq
;

1042 
c
.
ü—‹_cq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
cq_dma_addr
);

1043 
c
.
ü—‹_cq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1044 
c
.
ü—‹_cq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1045 
c
.
ü—‹_cq
.
cq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1046 
c
.
ü—‹_cq
.
œq_veùÜ
 = 
	`ıu_to_Ë16
(
nvmeq
->
cq_veùÜ
);

1048  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1049 
	}
}

1051 
	$ad­‹r_®loc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1052 
nvme_queue
 *
nvmeq
)

1054 
nvme_commªd
 
c
;

1055 
æags
 = 
NVME_QUEUE_PHYS_CONTIG
 | 
NVME_SQ_PRIO_MEDIUM
;

1061 
	`mem£t
(&
c
, 0, (c));

1062 
c
.
ü—‹_sq
.
İcode
 = 
nvme_admš_ü—‹_sq
;

1063 
c
.
ü—‹_sq
.
´p1
 = 
	`ıu_to_Ë64
(
nvmeq
->
sq_dma_addr
);

1064 
c
.
ü—‹_sq
.
sqid
 = 
	`ıu_to_Ë16
(
qid
);

1065 
c
.
ü—‹_sq
.
qsize
 = 
	`ıu_to_Ë16
(
nvmeq
->
q_d•th
 - 1);

1066 
c
.
ü—‹_sq
.
sq_æags
 = 
	`ıu_to_Ë16
(
æags
);

1067 
c
.
ü—‹_sq
.
cqid
 = 
	`ıu_to_Ë16
(
qid
);

1069  
	`nvme_subm™_sync_cmd
(
dev
->
ù¾
.
admš_q
, &
c
, 
NULL
, 0);

1070 
	}
}

1072 
	$ad­‹r_d–‘e_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1074  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_cq
, 
cqid
);

1075 
	}
}

1077 
	$ad­‹r_d–‘e_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1079  
	`ad­‹r_d–‘e_queue
(
dev
, 
nvme_admš_d–‘e_sq
, 
sqid
);

1080 
	}
}

1082 
	$abÜt_’dio
(
»que¡
 *
»q
, 
”rÜ
)

1084 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1085 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1086 
u16
 
¡©us
 = 
»q
->
”rÜs
;

1088 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
, "AbÜˆ¡©us: 0x%x", 
¡©us
);

1089 
	`©omic_šc
(&
nvmeq
->
dev
->
ù¾
.
abÜt_lim™
);

1090 
	`blk_mq_ä“_»que¡
(
»q
);

1091 
	}
}

1093 
blk_eh_tim”_»tuº
 
	$nvme_timeout
(
»que¡
 *
»q
, 
boŞ
 
»£rved
)

1095 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
»q
);

1096 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1097 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1098 
»que¡
 *
abÜt_»q
;

1099 
nvme_commªd
 
cmd
;

1107 ià(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
) {

1108 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1110 
»q
->
g
, 
nvmeq
->
qid
);

1111 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1112 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1113  
BLK_EH_HANDLED
;

1121 ià(!
nvmeq
->
qid
 || 
iod
->
abÜ‹d
) {

1122 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

1124 
»q
->
g
, 
nvmeq
->
qid
);

1125 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

1126 
	`nvme_»£t
(
dev
);

1132 
»q
->
”rÜs
 = 
NVME_SC_CANCELLED
;

1133  
BLK_EH_HANDLED
;

1135 #ifdeà
REPORT_TIMEOUT


1137 
nvme_ns
 *
ns
 = 
NULL
;

1138 
cmd
.
commÚ
.
nsid
 = 0;

1139 ià(
»q
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
) {

1140 
	`memıy
(&
cmd
, 
»q
->cmd,  (
nvme_commªd
));

1142 ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_FLUSH
) {

1143 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

1144 } ià(
	`»q_İ
(
»q
è=ğ
REQ_OP_DISCARD
) {

1145 
cmd
.
commÚ
.
İcode
 = 
nvme_cmd_dsm
;

1147 
cmd
.
commÚ
.
İcode
 = (
	`rq_d©a_dœ
(
»q
è? 
nvme_cmd_wr™e
: 
nvme_cmd_»ad
);

1149 ià(
»q
->
rq_disk
) {

1150 
ns
 = 
»q
->
rq_disk
->
´iv©e_d©a
;

1151 ià(
ns
è
cmd
.
commÚ
.
nsid
 =‚s->
ns_id
;

1154 ià(
iod
->
kv_cmd
)

1156 
__u32
 *
d©a
 = (__u32*è
cmd
.
commÚ
.
cdw2
;

1157 
	`´_”r
("nvme_timeout: opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1158 
	`´_”r
("[dump‚vme kv comand]\n");

1159 
	`´_”r
("\tİcode:(%02x)\n", 
cmd
.
commÚ
.
İcode
);

1160 
	`´_”r
("\tæags:(%02x)\n", 
cmd
.
commÚ
.
æags
);

1161 
	`´_”r
("\tcommªd id:(%04x)\n", 
»q
->
g
);

1162 
	`´_”r
("\Š id:(%08x)\n", 
cmd
.
commÚ
.
nsid
);

1163 
	`´_”r
("\tcdw2:(%08x)\n", 
d©a
[0]);

1164 
	`´_”r
("\tcdw3:(%08x)\n", 
d©a
[1]);

1165 
	`´_”r
("\tcdw4:(%08x)\n", 
d©a
[2]);

1166 
	`´_”r
("\tcdw5:(%08x)\n", 
d©a
[3]);

1167 
	`´_”r
("\tcdw6:(%08x)\n", 
d©a
[4]);

1168 
	`´_”r
("\tcdw7:(%08x)\n", 
d©a
[5]);

1169 
	`´_”r
("\tcdw8:(%08x)\n", 
d©a
[6]);

1170 
	`´_”r
("\tcdw9:(%08x)\n", 
d©a
[7]);

1171 
	`´_”r
("\tcdw10:(%08x)\n", 
d©a
[8]);

1172 
	`´_”r
("\tcdw11:(%08x)\n", 
d©a
[9]);

1173 
	`´_”r
("\tcdw12:(%08x)\n", 
d©a
[10]);

1174 
	`´_”r
("\tcdw13:(%08x)\n", 
d©a
[11]);

1175 
	`´_”r
("\tcdw14:(%08x)\n", 
d©a
[12]);

1176 
	`´_”r
("\tcdw15:(%08x)\n", 
d©a
[13]);

1178 
	`´_”r
("nvme_timeout:‚Ú kv opcod(%02xènsid(%dè»que¡ (%d).\n", 
cmd
.
commÚ
.
İcode
, cmd.commÚ.
nsid
, 
»q
->
”rÜs
);

1184 
iod
->
abÜ‹d
 = 1;

1186 ià(
	`©omic_dec_»tuº
(&
dev
->
ù¾
.
abÜt_lim™
) < 0) {

1187 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1188  
BLK_EH_RESET_TIMER
;

1191 
	`mem£t
(&
cmd
, 0, (cmd));

1192 
cmd
.
abÜt
.
İcode
 = 
nvme_admš_abÜt_cmd
;

1193 
cmd
.
abÜt
.
cid
 = 
»q
->
g
;

1194 
cmd
.
abÜt
.
sqid
 = 
	`ıu_to_Ë16
(
nvmeq
->
qid
);

1196 
	`dev_w¬n
(
nvmeq
->
dev
->
ù¾
.
deviû
,

1198 
»q
->
g
, 
nvmeq
->
qid
);

1200 
abÜt_»q
 = 
	`nvme_®loc_»que¡
(
dev
->
ù¾
.
admš_q
, &
cmd
,

1201 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1202 ià(
	`IS_ERR
(
abÜt_»q
)) {

1203 
	`©omic_šc
(&
dev
->
ù¾
.
abÜt_lim™
);

1204  
BLK_EH_RESET_TIMER
;

1207 
abÜt_»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1208 
abÜt_»q
->
’d_io_d©a
 = 
NULL
;

1209 
	`blk_execu‹_rq_nowa™
(
abÜt_»q
->
q
, 
NULL
,‡bÜt_»q, 0, 
abÜt_’dio
);

1216  
BLK_EH_RESET_TIMER
;

1217 
	}
}

1219 
	$nvme_ä“_queue
(
nvme_queue
 *
nvmeq
)

1221 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
Òvmeq->
q_d•th
),

1222 (*)
nvmeq
->
cqes
,‚vmeq->
cq_dma_addr
);

1223 ià(
nvmeq
->
sq_cmds
)

1224 
	`dma_ä“_coh”’t
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
Òvmeq->
q_d•th
),

1225 
nvmeq
->
sq_cmds
,‚vmeq->
sq_dma_addr
);

1226 
	`kä“
(
nvmeq
);

1227 
	}
}

1229 
	$nvme_ä“_queues
(
nvme_dev
 *
dev
, 
lowe¡
)

1231 
i
;

1233 
i
 = 
dev
->
queue_couÁ
 - 1; i >ğ
lowe¡
; i--) {

1234 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[
i
];

1235 
dev
->
queue_couÁ
--;

1236 
dev
->
queues
[
i
] = 
NULL
;

1237 
	`nvme_ä“_queue
(
nvmeq
);

1239 
	}
}

1245 
	$nvme_su¥’d_queue
(
nvme_queue
 *
nvmeq
)

1247 
veùÜ
;

1249 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1250 ià(
nvmeq
->
cq_veùÜ
 == -1) {

1251 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1254 
veùÜ
 = 
	`nvmeq_œq
(
nvmeq
);

1255 
nvmeq
->
dev
->
Úlše_queues
--;

1256 
nvmeq
->
cq_veùÜ
 = -1;

1257 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1259 ià(!
nvmeq
->
qid
 &&‚vmeq->
dev
->
ù¾
.
admš_q
)

1260 
	`blk_mq_¡İ_hw_queues
(
nvmeq
->
dev
->
ù¾
.
admš_q
);

1262 
	`ä“_œq
(
veùÜ
, 
nvmeq
);

1265 
	}
}

1267 
	$nvme_di§bË_admš_queue
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1269 
nvme_queue
 *
nvmeq
 = 
dev
->
queues
[0];

1271 ià(!
nvmeq
)

1273 ià(
	`nvme_su¥’d_queue
(
nvmeq
))

1276 ià(
shutdown
)

1277 
	`nvme_shutdown_ù¾
(&
dev
->
ù¾
);

1279 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
	`lo_hi_»adq
(

1280 
dev
->
b¬
 + 
NVME_REG_CAP
));

1282 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1283 
	`nvme_´oûss_cq
(
nvmeq
);

1284 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1285 
	}
}

1287 
	$nvme_cmb_qd•th
(
nvme_dev
 *
dev
, 
Ä_io_queues
,

1288 
’Œy_size
)

1290 
q_d•th
 = 
dev
->q_depth;

1291 
q_size_®igÃd
 = 
	`roundup
(
q_d•th
 * 
’Œy_size
,

1292 
dev
->
ù¾
.
·ge_size
);

1294 ià(
q_size_®igÃd
 * 
Ä_io_queues
 > 
dev
->
cmb_size
) {

1295 
u64
 
mem_³r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
Ä_io_queues
);

1296 
mem_³r_q
 = 
	`round_down
(mem_³r_q, 
dev
->
ù¾
.
·ge_size
);

1297 
q_d•th
 = 
	`div_u64
(
mem_³r_q
, 
’Œy_size
);

1304 ià(
q_d•th
 < 64)

1305  -
ENOMEM
;

1308  
q_d•th
;

1309 
	}
}

1311 
	$nvme_®loc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1312 
qid
, 
d•th
)

1314 ià(
qid
 && 
dev
->
cmb
 && 
u£_cmb_sqes
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1315 
off£t
 = (
qid
 - 1è* 
	`roundup
(
	`SQ_SIZE
(
d•th
),

1316 
dev
->
ù¾
.
·ge_size
);

1317 
nvmeq
->
sq_dma_addr
 = 
dev
->
cmb_dma_addr
 + 
off£t
;

1318 
nvmeq
->
sq_cmds_io
 = 
dev
->
cmb
 + 
off£t
;

1320 
nvmeq
->
sq_cmds
 = 
	`dma_®loc_coh”’t
(
dev
->dev, 
	`SQ_SIZE
(
d•th
),

1321 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1322 ià(!
nvmeq
->
sq_cmds
)

1323  -
ENOMEM
;

1327 
	}
}

1329 
nvme_queue
 *
	$nvme_®loc_queue
(
nvme_dev
 *
dev
, 
qid
,

1330 
d•th
)

1332 
nvme_queue
 *
nvmeq
 = 
	`kz®loc
((*nvmeq), 
GFP_KERNEL
);

1333 ià(!
nvmeq
)

1334  
NULL
;

1336 
nvmeq
->
cqes
 = 
	`dma_z®loc_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
),

1337 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1338 ià(!
nvmeq
->
cqes
)

1339 
ä“_nvmeq
;

1341 ià(
	`nvme_®loc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
d•th
))

1342 
ä“_cqdma
;

1344 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1345 
nvmeq
->
dev
 = dev;

1346 
	`¢´štf
(
nvmeq
->
œqÇme
, (nvmeq->irqname), "nvme%dq%d",

1347 
dev
->
ù¾
.
š¡ªû
, 
qid
);

1348 
	`¥š_lock_š™
(&
nvmeq
->
q_lock
);

1349 
nvmeq
->
cq_h—d
 = 0;

1350 
nvmeq
->
cq_pha£
 = 1;

1351 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1352 
nvmeq
->
q_d•th
 = 
d•th
;

1353 
nvmeq
->
qid
 = qid;

1354 
nvmeq
->
cq_veùÜ
 = -1;

1355 
dev
->
queues
[
qid
] = 
nvmeq
;

1356 
dev
->
queue_couÁ
++;

1358  
nvmeq
;

1360 
ä“_cqdma
:

1361 
	`dma_ä“_coh”’t
(
dev
->dev, 
	`CQ_SIZE
(
d•th
), (*)
nvmeq
->
cqes
,

1362 
nvmeq
->
cq_dma_addr
);

1363 
ä“_nvmeq
:

1364 
	`kä“
(
nvmeq
);

1365  
NULL
;

1366 
	}
}

1368 
	$queue_»que¡_œq
(
nvme_queue
 *
nvmeq
)

1370 ià(
u£_th»aded_š‹¼u±s
)

1371  
	`»que¡_th»aded_œq
(
	`nvmeq_œq
(
nvmeq
), 
nvme_œq_check
,

1372 
nvme_œq
, 
IRQF_SHARED
, 
nvmeq
->
œqÇme
,‚vmeq);

1374  
	`»que¡_œq
(
	`nvmeq_œq
(
nvmeq
), 
nvme_œq
, 
IRQF_SHARED
,

1375 
nvmeq
->
œqÇme
,‚vmeq);

1376 
	}
}

1378 
	$nvme_š™_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1380 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1382 
	`¥š_lock_œq
(&
nvmeq
->
q_lock
);

1383 
nvmeq
->
sq_
 = 0;

1384 
nvmeq
->
cq_h—d
 = 0;

1385 
nvmeq
->
cq_pha£
 = 1;

1386 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_¡ride
];

1387 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
Òvmeq->
q_d•th
));

1388 
dev
->
Úlše_queues
++;

1389 
	`¥š_uÆock_œq
(&
nvmeq
->
q_lock
);

1390 
	}
}

1392 
	$nvme_ü—‹_queue
(
nvme_queue
 *
nvmeq
, 
qid
)

1394 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1395 
»suÉ
;

1397 
nvmeq
->
cq_veùÜ
 = 
qid
 - 1;

1398 
»suÉ
 = 
	`ad­‹r_®loc_cq
(
dev
, 
qid
, 
nvmeq
);

1399 ià(
»suÉ
 < 0)

1400  
»suÉ
;

1402 
»suÉ
 = 
	`ad­‹r_®loc_sq
(
dev
, 
qid
, 
nvmeq
);

1403 ià(
»suÉ
 < 0)

1404 
»Ëa£_cq
;

1406 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1407 ià(
»suÉ
 < 0)

1408 
»Ëa£_sq
;

1410 
	`nvme_š™_queue
(
nvmeq
, 
qid
);

1411  
»suÉ
;

1413 
»Ëa£_sq
:

1414 
	`ad­‹r_d–‘e_sq
(
dev
, 
qid
);

1415 
»Ëa£_cq
:

1416 
	`ad­‹r_d–‘e_cq
(
dev
, 
qid
);

1417  
»suÉ
;

1418 
	}
}

1420 
blk_mq_İs
 
	gnvme_mq_admš_İs
 = {

1421 .
queue_rq
 = 
nvme_queue_rq
,

1422 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1423 .
	gš™_hùx
 = 
nvme_admš_š™_hùx
,

1424 .
	gex™_hùx
 = 
nvme_admš_ex™_hùx
,

1425 .
	gš™_»que¡
 = 
nvme_admš_š™_»que¡
,

1426 .
	gtimeout
 = 
nvme_timeout
,

1429 
blk_mq_İs
 
	gnvme_mq_İs
 = {

1430 .
queue_rq
 = 
nvme_queue_rq
,

1431 .
	gcom¶‘e
 = 
nvme_com¶‘e_rq
,

1432 .
	gš™_hùx
 = 
nvme_š™_hùx
,

1433 .
	gš™_»que¡
 = 
nvme_š™_»que¡
,

1434 .
	gm­_queues
 = 
nvme_pci_m­_queues
,

1435 .
	gtimeout
 = 
nvme_timeout
,

1436 .
	gpŞl
 = 
nvme_pŞl
,

1439 
	$nvme_dev_»move_admš
(
nvme_dev
 *
dev
)

1441 ià(
dev
->
ù¾
.
admš_q
 && !
	`blk_queue_dyšg
(dev->ctrl.admin_q)) {

1447 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1448 
	`blk_ş—nup_queue
(
dev
->
ù¾
.
admš_q
);

1449 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1451 
	}
}

1453 
	$nvme_®loc_admš_gs
(
nvme_dev
 *
dev
)

1455 ià(!
dev
->
ù¾
.
admš_q
) {

1456 
dev
->
admš_g£t
.
İs
 = &
nvme_mq_admš_İs
;

1457 
dev
->
admš_g£t
.
Ä_hw_queues
 = 1;

1463 
dev
->
admš_g£t
.
queue_d•th
 = 
NVME_AQ_BLKMQ_DEPTH
 - 1;

1464 
dev
->
admš_g£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1465 
dev
->
admš_g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1466 
dev
->
admš_g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1467 
dev
->
admš_g£t
.
driv”_d©a
 = dev;

1469 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
admš_g£t
))

1470  -
ENOMEM
;

1472 
dev
->
ù¾
.
admš_q
 = 
	`blk_mq_š™_queue
(&dev->
admš_g£t
);

1473 ià(
	`IS_ERR
(
dev
->
ù¾
.
admš_q
)) {

1474 
	`blk_mq_ä“_g_£t
(&
dev
->
admš_g£t
);

1475  -
ENOMEM
;

1477 ià(!
	`blk_g‘_queue
(
dev
->
ù¾
.
admš_q
)) {

1478 
	`nvme_dev_»move_admš
(
dev
);

1479 
dev
->
ù¾
.
admš_q
 = 
NULL
;

1480  -
ENODEV
;

1483 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
dev
->
ù¾
.
admš_q
, 
Œue
);

1486 
	}
}

1488 
	$nvme_cÚfigu»_admš_queue
(
nvme_dev
 *
dev
)

1490 
»suÉ
;

1491 
u32
 
aqa
;

1492 
u64
 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

1493 
nvme_queue
 *
nvmeq
;

1495 
dev
->
subsy¡em
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 1, 0) ?

1496 
	`NVME_CAP_NSSRC
(
ÿp
) : 0;

1498 ià(
dev
->
subsy¡em
 &&

1499 (
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
è& 
NVME_CSTS_NSSRO
))

1500 
	`wr™–
(
NVME_CSTS_NSSRO
, 
dev
->
b¬
 + 
NVME_REG_CSTS
);

1502 
»suÉ
 = 
	`nvme_di§bË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1503 ià(
»suÉ
 < 0)

1504  
»suÉ
;

1506 
nvmeq
 = 
dev
->
queues
[0];

1507 ià(!
nvmeq
) {

1508 
nvmeq
 = 
	`nvme_®loc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1509 ià(!
nvmeq
)

1510  -
ENOMEM
;

1513 
aqa
 = 
nvmeq
->
q_d•th
 - 1;

1514 
aqa
 |=‡qa << 16;

1516 
	`wr™–
(
aqa
, 
dev
->
b¬
 + 
NVME_REG_AQA
);

1517 
	`lo_hi_wr™eq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ASQ
);

1518 
	`lo_hi_wr™eq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¬
 + 
NVME_REG_ACQ
);

1520 
»suÉ
 = 
	`nvme_’abË_ù¾
(&
dev
->
ù¾
, 
ÿp
);

1521 ià(
»suÉ
)

1522  
»suÉ
;

1524 
nvmeq
->
cq_veùÜ
 = 0;

1525 
»suÉ
 = 
	`queue_»que¡_œq
(
nvmeq
);

1526 ià(
»suÉ
) {

1527 
nvmeq
->
cq_veùÜ
 = -1;

1528  
»suÉ
;

1531  
»suÉ
;

1532 
	}
}

1534 
boŞ
 
	$nvme_should_»£t
(
nvme_dev
 *
dev
, 
u32
 
c¡s
)

1540 
boŞ
 
ns¤o
 = 
dev
->
subsy¡em
 && (
c¡s
 & 
NVME_CSTS_NSSRO
);

1543 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

1544  
çl£
;

1549 ià(!(
c¡s
 & 
NVME_CSTS_CFS
è&& !
ns¤o
)

1550  
çl£
;

1555 ià(
	`pci_chªÃl_ofæše
(
	`to_pci_dev
(
dev
->dev)))

1556  
çl£
;

1558  
Œue
;

1559 
	}
}

1561 
	$nvme_w©chdog_tim”
(
d©a
)

1563 
nvme_dev
 *
dev
 = (nvme_dev *)
d©a
;

1564 
u32
 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1567 ià(
	`nvme_should_»£t
(
dev
, 
c¡s
)) {

1568 ià(!
	`nvme_»£t
(
dev
))

1569 
	`dev_w¬n
(
dev
->dev,

1571 
c¡s
);

1575 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

1576 
	}
}

1578 
	$nvme_ü—‹_io_queues
(
nvme_dev
 *
dev
)

1580 
i
, 
max
;

1581 
»t
 = 0;

1583 
i
 = 
dev
->
queue_couÁ
; i <ğdev->
max_qid
; i++) {

1584 ià(!
	`nvme_®loc_queue
(
dev
, 
i
, dev->
q_d•th
)) {

1585 
»t
 = -
ENOMEM
;

1590 
max
 = 
	`mš
(
dev
->
max_qid
, dev->
queue_couÁ
 - 1);

1591 
i
 = 
dev
->
Úlše_queues
; i <ğ
max
; i++) {

1592 
»t
 = 
	`nvme_ü—‹_queue
(
dev
->
queues
[
i
], i);

1593 ià(
»t
)

1603  
»t
 >= 0 ? 0 :„et;

1604 
	}
}

1606 
ssize_t
 
	$nvme_cmb_show
(
deviû
 *
dev
,

1607 
deviû_©Œibu‹
 *
©Œ
,

1608 *
buf
)

1610 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_g‘_drvd©a
(
dev
));

1612  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "cmbloc : x%08x\ncmbsz : x%08x\n",

1613 
ndev
->
cmbloc
,‚dev->
cmbsz
);

1614 
	}
}

1615 
DEVICE_ATTR
(
cmb
, 
S_IRUGO
, 
nvme_cmb_show
, 
NULL
);

1617 
__iomem
 *
	$nvme_m­_cmb
(
nvme_dev
 *
dev
)

1619 
u64
 
szu
, 
size
, 
off£t
;

1620 
»sourû_size_t
 
b¬_size
;

1621 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1622 
__iomem
 *
cmb
;

1623 
dma_addr_t
 
dma_addr
;

1625 
dev
->
cmbsz
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBSZ
);

1626 ià(!(
	`NVME_CMB_SZ
(
dev
->
cmbsz
)))

1627  
NULL
;

1628 
dev
->
cmbloc
 = 
	`»adl
(dev->
b¬
 + 
NVME_REG_CMBLOC
);

1630 ià(!
u£_cmb_sqes
)

1631  
NULL
;

1633 
szu
 = (
u64
)1 << (12 + 4 * 
	`NVME_CMB_SZU
(
dev
->
cmbsz
));

1634 
size
 = 
szu
 * 
	`NVME_CMB_SZ
(
dev
->
cmbsz
);

1635 
off£t
 = 
szu
 * 
	`NVME_CMB_OFST
(
dev
->
cmbloc
);

1636 
b¬_size
 = 
	`pci_»sourû_Ën
(
pdev
, 
	`NVME_CMB_BIR
(
dev
->
cmbloc
));

1638 ià(
off£t
 > 
b¬_size
)

1639  
NULL
;

1646 ià(
size
 > 
b¬_size
 - 
off£t
)

1647 
size
 = 
b¬_size
 - 
off£t
;

1649 
dma_addr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 
	`NVME_CMB_BIR
(
dev
->
cmbloc
)è+ 
off£t
;

1650 
cmb
 = 
	`iÜem­_wc
(
dma_addr
, 
size
);

1651 ià(!
cmb
)

1652  
NULL
;

1654 
dev
->
cmb_dma_addr
 = 
dma_addr
;

1655 
dev
->
cmb_size
 = 
size
;

1656  
cmb
;

1657 
	}
}

1659 
šlše
 
	$nvme_»Ëa£_cmb
(
nvme_dev
 *
dev
)

1661 ià(
dev
->
cmb
) {

1662 
	`iounm­
(
dev
->
cmb
);

1663 
dev
->
cmb
 = 
NULL
;

1665 
	}
}

1667 
size_t
 
	$db_b¬_size
(
nvme_dev
 *
dev
, 
Ä_io_queues
)

1669  4096 + ((
Ä_io_queues
 + 1è* 8 * 
dev
->
db_¡ride
);

1670 
	}
}

1672 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

1674 
nvme_queue
 *
admšq
 = 
dev
->
queues
[0];

1675 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1676 
»suÉ
, 
Ä_io_queues
, 
size
;

1678 
Ä_io_queues
 = 
	`num_Úlše_ıus
();

1679 
»suÉ
 = 
	`nvme_£t_queue_couÁ
(&
dev
->
ù¾
, &
Ä_io_queues
);

1680 ià(
»suÉ
 < 0)

1681  
»suÉ
;

1683 ià(
Ä_io_queues
 == 0)

1686 ià(
dev
->
cmb
 && 
	`NVME_CMB_SQS
(dev->
cmbsz
)) {

1687 
»suÉ
 = 
	`nvme_cmb_qd•th
(
dev
, 
Ä_io_queues
,

1688 (
nvme_commªd
));

1689 ià(
»suÉ
 > 0)

1690 
dev
->
q_d•th
 = 
»suÉ
;

1692 
	`nvme_»Ëa£_cmb
(
dev
);

1695 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1696 ià(
size
 > 8192) {

1697 
	`iounm­
(
dev
->
b¬
);

1699 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 
size
);

1700 ià(
dev
->
b¬
)

1702 ià(!--
Ä_io_queues
)

1703  -
ENOMEM
;

1704 
size
 = 
	`db_b¬_size
(
dev
, 
Ä_io_queues
);

1706 
dev
->
dbs
 = dev->
b¬
 + 4096;

1707 
admšq
->
q_db
 = 
dev
->
dbs
;

1711 
	`ä“_œq
(
	`pci_œq_veùÜ
(
pdev
, 0), 
admšq
);

1717 
	`pci_ä“_œq_veùÜs
(
pdev
);

1718 
Ä_io_queues
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1,‚r_io_queues,

1719 
PCI_IRQ_ALL_TYPES
 | 
PCI_IRQ_AFFINITY
);

1720 ià(
Ä_io_queues
 <= 0)

1721  -
EIO
;

1722 
dev
->
max_qid
 = 
Ä_io_queues
;

1731 
»suÉ
 = 
	`queue_»que¡_œq
(
admšq
);

1732 ià(
»suÉ
) {

1733 
admšq
->
cq_veùÜ
 = -1;

1734  
»suÉ
;

1736  
	`nvme_ü—‹_io_queues
(
dev
);

1737 
	}
}

1739 
	$nvme_d–_queue_’d
(
»que¡
 *
»q
, 
”rÜ
)

1741 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

1743 
	`blk_mq_ä“_»que¡
(
»q
);

1744 
	`com¶‘e
(&
nvmeq
->
dev
->
ioq_wa™
);

1745 
	}
}

1747 
	$nvme_d–_cq_’d
(
»que¡
 *
»q
, 
”rÜ
)

1749 
nvme_queue
 *
nvmeq
 = 
»q
->
’d_io_d©a
;

1751 ià(!
”rÜ
) {

1752 
æags
;

1759 
	`¥š_lock_œq§ve_Ã¡ed
(&
nvmeq
->
q_lock
, 
æags
,

1760 
SINGLE_DEPTH_NESTING
);

1761 
	`nvme_´oûss_cq
(
nvmeq
);

1762 
	`¥š_uÆock_œq»¡Üe
(&
nvmeq
->
q_lock
, 
æags
);

1765 
	`nvme_d–_queue_’d
(
»q
, 
”rÜ
);

1766 
	}
}

1768 
	$nvme_d–‘e_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
İcode
)

1770 
»que¡_queue
 *
q
 = 
nvmeq
->
dev
->
ù¾
.
admš_q
;

1771 
»que¡
 *
»q
;

1772 
nvme_commªd
 
cmd
;

1774 
	`mem£t
(&
cmd
, 0, (cmd));

1775 
cmd
.
d–‘e_queue
.
İcode
 = opcode;

1776 
cmd
.
d–‘e_queue
.
qid
 = 
	`ıu_to_Ë16
(
nvmeq
->qid);

1778 
»q
 = 
	`nvme_®loc_»que¡
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1779 ià(
	`IS_ERR
(
»q
))

1780  
	`PTR_ERR
(
»q
);

1782 
»q
->
timeout
 = 
ADMIN_TIMEOUT
;

1783 
»q
->
’d_io_d©a
 = 
nvmeq
;

1785 
	`blk_execu‹_rq_nowa™
(
q
, 
NULL
, 
»q
, 
çl£
,

1786 
İcode
 =ğ
nvme_admš_d–‘e_cq
 ?

1787 
nvme_d–_cq_’d
 : 
nvme_d–_queue_’d
);

1789 
	}
}

1791 
	$nvme_di§bË_io_queues
(
nvme_dev
 *
dev
, 
queues
)

1793 
·ss
;

1794 
timeout
;

1795 
u8
 
İcode
 = 
nvme_admš_d–‘e_sq
;

1797 
·ss
 = 0;…ass < 2;…ass++) {

1798 
£Á
 = 0, 
i
 = 
queues
;

1800 
	`»š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

1801 
»Œy
:

1802 
timeout
 = 
ADMIN_TIMEOUT
;

1803 ; 
i
 > 0; i--, 
£Á
++)

1804 ià(
	`nvme_d–‘e_queue
(
dev
->
queues
[
i
], 
İcode
))

1807 
£Á
--) {

1808 
timeout
 = 
	`wa™_fÜ_com¶‘iÚ_io_timeout
(&
dev
->
ioq_wa™
,imeout);

1809 ià(
timeout
 == 0)

1811 ià(
i
)

1812 
»Œy
;

1814 
İcode
 = 
nvme_admš_d–‘e_cq
;

1816 
	}
}

1824 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

1826 ià(!
dev
->
ù¾
.
g£t
) {

1827 
dev
->
g£t
.
İs
 = &
nvme_mq_İs
;

1828 
dev
->
g£t
.
Ä_hw_queues
 = dev->
Úlše_queues
 - 1;

1829 
dev
->
g£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

1830 
dev
->
g£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1831 
dev
->
g£t
.
queue_d•th
 =

1832 
	`mš_t
(, 
dev
->
q_d•th
, 
BLK_MQ_MAX_DEPTH
) - 1;

1833 
dev
->
g£t
.
cmd_size
 = 
	`nvme_cmd_size
(dev);

1834 
dev
->
g£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

1835 
dev
->
g£t
.
driv”_d©a
 = dev;

1837 ià(
	`blk_mq_®loc_g_£t
(&
dev
->
g£t
))

1839 
dev
->
ù¾
.
g£t
 = &dev->tagset;

1841 
	`blk_mq_upd©e_Ä_hw_queues
(&
dev
->
g£t
, dev->
Úlše_queues
 - 1);

1844 
	`nvme_ä“_queues
(
dev
, dev->
Úlše_queues
);

1848 
	}
}

1850 
	$nvme_pci_’abË
(
nvme_dev
 *
dev
)

1852 
u64
 
ÿp
;

1853 
»suÉ
 = -
ENOMEM
;

1854 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1856 ià(
	`pci_’abË_deviû_mem
(
pdev
))

1857  
»suÉ
;

1859 
	`pci_£t_ma¡”
(
pdev
);

1861 ià(
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

1862 
	`dma_£t_mask_ªd_coh”’t
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

1863 
di§bË
;

1865 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
) == -1) {

1866 
»suÉ
 = -
ENODEV
;

1867 
di§bË
;

1875 
»suÉ
 = 
	`pci_®loc_œq_veùÜs
(
pdev
, 1, 1, 
PCI_IRQ_ALL_TYPES
);

1876 ià(
»suÉ
 < 0)

1877  
»suÉ
;

1879 
ÿp
 = 
	`lo_hi_»adq
(
dev
->
b¬
 + 
NVME_REG_CAP
);

1881 
dev
->
q_d•th
 = 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ÿp
è+ 1, 
NVME_Q_DEPTH
);

1882 
dev
->
db_¡ride
 = 1 << 
	`NVME_CAP_STRIDE
(
ÿp
);

1883 
dev
->
dbs
 = dev->
b¬
 + 4096;

1889 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_APPLE
 &&…dev->
deviû
 == 0x2001) {

1890 
dev
->
q_d•th
 = 2;

1891 
	`dev_w¬n
(
dev
->dev, "detected Apple NVMe controller, set "

1893 
dev
->
q_d•th
);

1904 ià(
	`»adl
(
dev
->
b¬
 + 
NVME_REG_VS
è>ğ
	`NVME_VS
(1, 2, 0)) {

1905 
dev
->
cmb
 = 
	`nvme_m­_cmb
(dev);

1907 ià(
dev
->
cmbsz
) {

1908 ià(
	`sysfs_add_fe_to_group
(&
dev
->
ù¾
.
deviû
->
kobj
,

1909 &
dev_©Œ_cmb
.
©Œ
, 
NULL
))

1910 
	`dev_w¬n
(
dev
->dev,

1915 
	`pci_’abË_pc›_”rÜ_»pÜtšg
(
pdev
);

1916 
	`pci_§ve_¡©e
(
pdev
);

1919 
di§bË
:

1920 
	`pci_di§bË_deviû
(
pdev
);

1921  
»suÉ
;

1922 
	}
}

1924 
	$nvme_dev_unm­
(
nvme_dev
 *
dev
)

1926 ià(
dev
->
b¬
)

1927 
	`iounm­
(
dev
->
b¬
);

1928 
	`pci_»Ëa£_mem_»giÚs
(
	`to_pci_dev
(
dev
->dev));

1929 
	}
}

1931 
	$nvme_pci_di§bË
(
nvme_dev
 *
dev
)

1933 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1935 
	`pci_ä“_œq_veùÜs
(
pdev
);

1937 ià(
	`pci_is_’abËd
(
pdev
)) {

1938 
	`pci_di§bË_pc›_”rÜ_»pÜtšg
(
pdev
);

1939 
	`pci_di§bË_deviû
(
pdev
);

1941 
	}
}

1943 
	$nvme_dev_di§bË
(
nvme_dev
 *
dev
, 
boŞ
 
shutdown
)

1945 
i
, 
queues
;

1946 
u32
 
c¡s
 = -1;

1948 
	`d–_tim”_sync
(&
dev
->
w©chdog_tim”
);

1950 
	`mu‹x_lock
(&
dev
->
shutdown_lock
);

1951 ià(
	`pci_is_’abËd
(
	`to_pci_dev
(
dev
->dev))) {

1952 
	`nvme_¡İ_queues
(&
dev
->
ù¾
);

1953 
c¡s
 = 
	`»adl
(
dev
->
b¬
 + 
NVME_REG_CSTS
);

1956 
queues
 = 
dev
->
Úlše_queues
 - 1;

1957 
i
 = 
dev
->
queue_couÁ
 - 1; i > 0; i--)

1958 
	`nvme_su¥’d_queue
(
dev
->
queues
[
i
]);

1960 ià(
c¡s
 & 
NVME_CSTS_CFS
 || !(c¡ & 
NVME_CSTS_RDY
)) {

1965 ià(
dev
->
queue_couÁ
)

1966 
	`nvme_su¥’d_queue
(
dev
->
queues
[0]);

1968 
	`nvme_di§bË_io_queues
(
dev
, 
queues
);

1969 
	`nvme_di§bË_admš_queue
(
dev
, 
shutdown
);

1971 
	`nvme_pci_di§bË
(
dev
);

1973 
	`blk_mq_g£t_busy_™”
(&
dev
->
g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

1974 
	`blk_mq_g£t_busy_™”
(&
dev
->
admš_g£t
, 
nvme_ÿnûl_»que¡
, &dev->
ù¾
);

1975 
	`mu‹x_uÆock
(&
dev
->
shutdown_lock
);

1976 
	}
}

1978 
	$nvme_£tup_´p_poŞs
(
nvme_dev
 *
dev
)

1980 
dev
->
´p_·ge_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist…age", dev->dev,

1981 
PAGE_SIZE
, PAGE_SIZE, 0);

1982 ià(!
dev
->
´p_·ge_poŞ
)

1983  -
ENOMEM
;

1986 
dev
->
´p_sm®l_poŞ
 = 
	`dma_poŞ_ü—‹
("prp†ist 256", dev->dev,

1988 ià(!
dev
->
´p_sm®l_poŞ
) {

1989 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

1990  -
ENOMEM
;

1993 
	}
}

1995 
	$nvme_»Ëa£_´p_poŞs
(
nvme_dev
 *
dev
)

1997 
	`dma_poŞ_de¡roy
(
dev
->
´p_·ge_poŞ
);

1998 
	`dma_poŞ_de¡roy
(
dev
->
´p_sm®l_poŞ
);

1999 
	}
}

2001 
	$nvme_pci_ä“_ù¾
(
nvme_ù¾
 *
ù¾
)

2003 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2005 
	`put_deviû
(
dev
->dev);

2006 ià(
dev
->
g£t
.
gs
)

2007 
	`blk_mq_ä“_g_£t
(&
dev
->
g£t
);

2008 ià(
dev
->
ù¾
.
admš_q
)

2009 
	`blk_put_queue
(
dev
->
ù¾
.
admš_q
);

2010 
	`kä“
(
dev
->
queues
);

2011 
	`kä“
(
dev
);

2012 
	}
}

2014 
	$nvme_»move_d—d_ù¾
(
nvme_dev
 *
dev
, 
¡©us
)

2016 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "Removšg‡á”…robçu» stus: %d\n", 
¡©us
);

2018 
	`k»f_g‘
(&
dev
->
ù¾
.
k»f
);

2019 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2020 ià(!
	`scheduË_wÜk
(&
dev
->
»move_wÜk
))

2021 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2022 
	}
}

2024 
	$nvme_»£t_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2026 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»£t_wÜk
);

2027 
»suÉ
 = -
ENODEV
;

2029 ià(
	`WARN_ON
(
dev
->
ù¾
.
¡©e
 =ğ
NVME_CTRL_RESETTING
))

2030 
out
;

2036 ià(
dev
->
ù¾
.
ù¾_cÚfig
 & 
NVME_CC_ENABLE
)

2037 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2039 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_RESETTING
))

2040 
out
;

2042 
»suÉ
 = 
	`nvme_pci_’abË
(
dev
);

2043 ià(
»suÉ
)

2044 
out
;

2046 
»suÉ
 = 
	`nvme_cÚfigu»_admš_queue
(
dev
);

2047 ià(
»suÉ
)

2048 
out
;

2050 
	`nvme_š™_queue
(
dev
->
queues
[0], 0);

2051 
»suÉ
 = 
	`nvme_®loc_admš_gs
(
dev
);

2052 ià(
»suÉ
)

2053 
out
;

2055 
»suÉ
 = 
	`nvme_š™_id’tify
(&
dev
->
ù¾
);

2056 ià(
»suÉ
)

2057 
out
;

2059 
»suÉ
 = 
	`nvme_£tup_io_queues
(
dev
);

2060 ià(
»suÉ
)

2061 
out
;

2069 ià(
dev
->
Úlše_queues
 > 1)

2070 
	`nvme_queue_async_ev’ts
(&
dev
->
ù¾
);

2072 
	`mod_tim”
(&
dev
->
w©chdog_tim”
, 
	`round_jiff›s
(
jiff›s
 + 
HZ
));

2078 ià(
dev
->
Úlše_queues
 < 2) {

2079 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "IO queues‚ot created\n");

2080 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2081 
	`nvme_»move_Çme¥aûs
(&
dev
->
ù¾
);

2083 
	`nvme_¡¬t_queues
(&
dev
->
ù¾
);

2084 
	`nvme_dev_add
(
dev
);

2087 ià(!
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_LIVE
)) {

2088 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
, "failedo mark controller†ive\n");

2089 
out
;

2092 ià(
dev
->
Úlše_queues
 > 1)

2093 
	`nvme_queue_sÿn
(&
dev
->
ù¾
);

2096 
out
:

2097 
	`nvme_»move_d—d_ù¾
(
dev
, 
»suÉ
);

2098 
	}
}

2100 
	$nvme_»move_d—d_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2102 
nvme_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, nvme_dev, 
»move_wÜk
);

2103 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2105 
	`nvme_kl_queues
(&
dev
->
ù¾
);

2106 ià(
	`pci_g‘_drvd©a
(
pdev
))

2107 
	`deviû_»Ëa£_driv”
(&
pdev
->
dev
);

2108 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2109 
	}
}

2111 
	$nvme_»£t
(
nvme_dev
 *
dev
)

2113 ià(!
dev
->
ù¾
.
admš_q
 || 
	`blk_queue_dyšg
(dev->ctrl.admin_q))

2114  -
ENODEV
;

2115 ià(
	`wÜk_busy
(&
dev
->
»£t_wÜk
))

2116  -
ENODEV
;

2117 ià(!
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
))

2118  -
EBUSY
;

2120 
	}
}

2122 
	$nvme_pci_»g_»ad32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 *
v®
)

2124 *
v®
 = 
	`»adl
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2126 
	}
}

2128 
	$nvme_pci_»g_wr™e32
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, u32 
v®
)

2130 
	`wr™–
(
v®
, 
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2132 
	}
}

2134 
	$nvme_pci_»g_»ad64
(
nvme_ù¾
 *
ù¾
, 
u32
 
off
, 
u64
 *
v®
)

2136 *
v®
 = 
	`»adq
(
	`to_nvme_dev
(
ù¾
)->
b¬
 + 
off
);

2138 
	}
}

2140 
	$nvme_pci_»£t_ù¾
(
nvme_ù¾
 *
ù¾
)

2142 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
ù¾
);

2143 
»t
 = 
	`nvme_»£t
(
dev
);

2145 ià(!
»t
)

2146 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2147  
»t
;

2148 
	}
}

2150 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_pci_ù¾_İs
 = {

2151 .
Çme
 = "pcie",

2152 .
	gmoduË
 = 
THIS_MODULE
,

2153 .
	g»g_»ad32
 = 
nvme_pci_»g_»ad32
,

2154 .
	g»g_wr™e32
 = 
nvme_pci_»g_wr™e32
,

2155 .
	g»g_»ad64
 = 
nvme_pci_»g_»ad64
,

2156 .
	g»£t_ù¾
 = 
nvme_pci_»£t_ù¾
,

2157 .
	gä“_ù¾
 = 
nvme_pci_ä“_ù¾
,

2158 .
	gsubm™_async_ev’t
 = 
nvme_pci_subm™_async_ev’t
,

2161 
	$nvme_dev_m­
(
nvme_dev
 *
dev
)

2163 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2165 ià(
	`pci_»que¡_mem_»giÚs
(
pdev
, "nvme"))

2166  -
ENODEV
;

2168 
dev
->
b¬
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 0), 8192);

2169 ià(!
dev
->
b¬
)

2170 
»Ëa£
;

2173 
»Ëa£
:

2174 
	`pci_»Ëa£_mem_»giÚs
(
pdev
);

2175  -
ENODEV
;

2176 
	}
}

2178 
	$nvme_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

2180 
node
, 
»suÉ
 = -
ENOMEM
;

2181 
nvme_dev
 *
dev
;

2183 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2184 ià(
node
 =ğ
NUMA_NO_NODE
)

2185 
	`£t_dev_node
(&
pdev
->
dev
, 
fœ¡_memÜy_node
);

2187 
dev
 = 
	`kz®loc_node
((*dev), 
GFP_KERNEL
, 
node
);

2188 ià(!
dev
)

2189  -
ENOMEM
;

2190 
dev
->
queues
 = 
	`kz®loc_node
((
	`num_possibË_ıus
() + 1) * (*),

2191 
GFP_KERNEL
, 
node
);

2192 ià(!
dev
->
queues
)

2193 
ä“
;

2195 
dev
->dev = 
	`g‘_deviû
(&
pdev
->dev);

2196 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2198 
»suÉ
 = 
	`nvme_dev_m­
(
dev
);

2199 ià(
»suÉ
)

2200 
ä“
;

2202 
	`INIT_WORK
(&
dev
->
»£t_wÜk
, 
nvme_»£t_wÜk
);

2203 
	`INIT_WORK
(&
dev
->
»move_wÜk
, 
nvme_»move_d—d_ù¾_wÜk
);

2204 
	`£tup_tim”
(&
dev
->
w©chdog_tim”
, 
nvme_w©chdog_tim”
,

2205 ()
dev
);

2206 
	`mu‹x_š™
(&
dev
->
shutdown_lock
);

2207 
	`š™_com¶‘iÚ
(&
dev
->
ioq_wa™
);

2209 
»suÉ
 = 
	`nvme_£tup_´p_poŞs
(
dev
);

2210 ià(
»suÉ
)

2211 
put_pci
;

2213 
»suÉ
 = 
	`nvme_š™_ù¾
(&
dev
->
ù¾
, &
pdev
->dev, &
nvme_pci_ù¾_İs
,

2214 
id
->
driv”_d©a
);

2215 ià(
»suÉ
)

2216 
»Ëa£_poŞs
;

2218 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "pc˜funùiÚ %s\n", 
	`dev_Çme
(&
pdev
->dev));

2220 
	`queue_wÜk
(
nvme_wÜkq
, &
dev
->
»£t_wÜk
);

2223 
»Ëa£_poŞs
:

2224 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2225 
put_pci
:

2226 
	`put_deviû
(
dev
->dev);

2227 
	`nvme_dev_unm­
(
dev
);

2228 
ä“
:

2229 
	`kä“
(
dev
->
queues
);

2230 
	`kä“
(
dev
);

2231  
»suÉ
;

2232 
	}
}

2234 
	$nvme_»£t_nÙify
(
pci_dev
 *
pdev
, 
boŞ
 
´•¬e
)

2236 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2238 ià(
´•¬e
)

2239 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2241 
	`nvme_»£t
(
dev
);

2242 
	}
}

2244 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2246 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2247 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2248 
	}
}

2255 
	$nvme_»move
(
pci_dev
 *
pdev
)

2257 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2259 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DELETING
);

2261 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2263 ià(!
	`pci_deviû_is_´e£Á
(
pdev
))

2264 
	`nvme_chªge_ù¾_¡©e
(&
dev
->
ù¾
, 
NVME_CTRL_DEAD
);

2266 
	`æush_wÜk
(&
dev
->
»£t_wÜk
);

2267 
	`nvme_unš™_ù¾
(&
dev
->
ù¾
);

2268 
	`nvme_dev_di§bË
(
dev
, 
Œue
);

2269 
	`nvme_dev_»move_admš
(
dev
);

2270 
	`nvme_ä“_queues
(
dev
, 0);

2271 
	`nvme_»Ëa£_cmb
(
dev
);

2272 
	`nvme_»Ëa£_´p_poŞs
(
dev
);

2273 
	`nvme_dev_unm­
(
dev
);

2274 
	`nvme_put_ù¾
(&
dev
->
ù¾
);

2275 
	}
}

2277 
	$nvme_pci_¤iov_cÚfigu»
(
pci_dev
 *
pdev
, 
numvfs
)

2279 
»t
 = 0;

2281 ià(
numvfs
 == 0) {

2282 ià(
	`pci_vfs_assigÃd
(
pdev
)) {

2283 
	`dev_w¬n
(&
pdev
->
dev
,

2285  -
EPERM
;

2287 
	`pci_di§bË_¤iov
(
pdev
);

2291 
»t
 = 
	`pci_’abË_¤iov
(
pdev
, 
numvfs
);

2292  
»t
 ?„‘ : 
numvfs
;

2293 
	}
}

2295 #ifdeà
CONFIG_PM_SLEEP


2296 
	$nvme_su¥’d
(
deviû
 *
dev
)

2298 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2299 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2301 
	`nvme_dev_di§bË
(
ndev
, 
Œue
);

2303 
	}
}

2305 
	$nvme_»sume
(
deviû
 *
dev
)

2307 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2308 
nvme_dev
 *
ndev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2310 
	`nvme_»£t
(
ndev
);

2312 
	}
}

2315 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_İs
, 
nvme_su¥’d
, 
nvme_»sume
);

2317 
pci_”s_»suÉ_t
 
	$nvme_”rÜ_d‘eùed
(
pci_dev
 *
pdev
,

2318 
pci_chªÃl_¡©e_t
 
¡©e
)

2320 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2327 
¡©e
) {

2328 
pci_chªÃl_io_nÜm®
:

2329  
PCI_ERS_RESULT_CAN_RECOVER
;

2330 
pci_chªÃl_io_äoz’
:

2331 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2333 
	`nvme_dev_di§bË
(
dev
, 
çl£
);

2334  
PCI_ERS_RESULT_NEED_RESET
;

2335 
pci_chªÃl_io_³rm_çu»
:

2336 
	`dev_w¬n
(
dev
->
ù¾
.
deviû
,

2338  
PCI_ERS_RESULT_DISCONNECT
;

2340  
PCI_ERS_RESULT_NEED_RESET
;

2341 
	}
}

2343 
pci_”s_»suÉ_t
 
	$nvme_¦Ù_»£t
(
pci_dev
 *
pdev
)

2345 
nvme_dev
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2347 
	`dev_šfo
(
dev
->
ù¾
.
deviû
, "restart‡fter slot„eset\n");

2348 
	`pci_»¡Üe_¡©e
(
pdev
);

2349 
	`nvme_»£t
(
dev
);

2350  
PCI_ERS_RESULT_RECOVERED
;

2351 
	}
}

2353 
	$nvme_”rÜ_»sume
(
pci_dev
 *
pdev
)

2355 
	`pci_ş—nup_«r_uncÜ»ù_”rÜ_¡©us
(
pdev
);

2356 
	}
}

2358 cÚ¡ 
pci_”rÜ_hªdËrs
 
	gnvme_”r_hªdËr
 = {

2359 .
”rÜ_d‘eùed
 = 
nvme_”rÜ_d‘eùed
,

2360 .
	g¦Ù_»£t
 = 
nvme_¦Ù_»£t
,

2361 .
	g»sume
 = 
nvme_”rÜ_»sume
,

2362 .
	g»£t_nÙify
 = 
nvme_»£t_nÙify
,

2366 
	#PCI_CLASS_STORAGE_EXPRESS
 0x010802

	)

2368 cÚ¡ 
pci_deviû_id
 
	gnvme_id_bË
[] = {

2369 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2370 .
driv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2371 
NVME_QUIRK_DISCARD_ZEROES
, },

2372 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

2373 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2374 
NVME_QUIRK_DISCARD_ZEROES
, },

2375 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

2376 .
	gdriv”_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2377 
NVME_QUIRK_DISCARD_ZEROES
, },

2378 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2379 .
	gdriv”_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
, },

2380 { 
PCI_DEVICE
(0x1c58, 0x0003),

2381 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2382 { 
PCI_DEVICE
(0x1c5f, 0x0540),

2383 .
	gdriv”_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2384 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2385 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

2388 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_bË
);

2390 
pci_driv”
 
	gnvme_driv”
 = {

2391 .
Çme
 = "nvme",

2392 .
	gid_bË
 = 
nvme_id_bË
,

2393 .
	g´obe
 = 
nvme_´obe
,

2394 .
	g»move
 = 
nvme_»move
,

2395 .
	gshutdown
 = 
nvme_shutdown
,

2396 .
	gdriv”
 = {

2397 .
pm
 = &
nvme_dev_pm_İs
,

2399 .
	g¤iov_cÚfigu»
 = 
nvme_pci_¤iov_cÚfigu»
,

2400 .
	g”r_hªdËr
 = &
nvme_”r_hªdËr
,

2403 
__š™
 
	$nvme_š™
()

2405 
»suÉ
;

2407 
nvme_wÜkq
 = 
	`®loc_wÜkqueue
("nvme", 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
, 0);

2408 ià(!
nvme_wÜkq
)

2409  -
ENOMEM
;

2411 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
nvme_driv”
);

2412 ià(
»suÉ
)

2413 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2414  
»suÉ
;

2415 
	}
}

2417 
__ex™
 
	$nvme_ex™
()

2419 
	`pci_uÄegi¡”_driv”
(&
nvme_driv”
);

2420 
	`de¡roy_wÜkqueue
(
nvme_wÜkq
);

2421 
	`_nvme_check_size
();

2422 
	}
}

2424 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

2425 
MODULE_LICENSE
("GPL");

2426 
MODULE_VERSION
("1.0");

2427 
moduË_š™
(
nvme_š™
);

2428 
moduË_ex™
(
nvme_ex™
);

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/rdma.c

14 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

15 
	~<lšux/moduË.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/”r.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/©omic.h
>

21 
	~<lšux/blk-mq.h
>

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/li¡.h
>

24 
	~<lšux/mu‹x.h
>

25 
	~<lšux/sÿ‰”li¡.h
>

27 
	~"nvme.h
"

28 
	~"lšux_nvme.h
"

30 
	~<asm/uÇligÃd.h
>

32 
	~<rdma/ib_v”bs.h
>

33 
	~<rdma/rdma_cm.h
>

34 
	~<rdma/ib_cm.h
>

35 
	~<lšux/nvme-rdma.h
>

37 
	~"nvme.h
"

38 
	~"çbrics.h
"

41 
	#NVME_RDMA_CONNECT_TIMEOUT_MS
 1000

	)

43 
	#NVME_RDMA_MAX_SEGMENT_SIZE
 0xfffffà

	)

45 
	#NVME_RDMA_MAX_SEGMENTS
 256

	)

47 
	#NVME_RDMA_MAX_INLINE_SEGMENTS
 1

	)

53 
	#NVME_RDMA_NR_AEN_COMMANDS
 1

	)

54 
	#NVME_RDMA_AQ_BLKMQ_DEPTH
 \

55 (
NVMF_AQ_DEPTH
 - 
NVME_RDMA_NR_AEN_COMMANDS
)

	)

57 
	snvme_rdma_deviû
 {

58 
ib_deviû
 *
	mdev
;

59 
ib_pd
 *
	mpd
;

60 
k»f
 
	m»f
;

61 
li¡_h—d
 
	m’Œy
;

64 
	snvme_rdma_qe
 {

65 
ib_cqe
 
	mcqe
;

66 *
	md©a
;

67 
u64
 
	mdma
;

70 
	gnvme_rdma_queue
;

71 
	snvme_rdma_»que¡
 {

72 
ib_mr
 *
	mmr
;

73 
nvme_rdma_qe
 
	msqe
;

74 
ib_sge
 
	msge
[1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
];

75 
u32
 
	mnum_sge
;

76 
	mÃÁs
;

77 
boŞ
 
	mšlše_d©a
;

78 
ib_»g_wr
 
	m»g_wr
;

79 
ib_cqe
 
	m»g_cqe
;

80 
nvme_rdma_queue
 *
	mqueue
;

81 
sg_bË
 
	msg_bË
;

82 
sÿ‰”li¡
 
	mfœ¡_sgl
[];

85 
	envme_rdma_queue_æags
 {

86 
	mNVME_RDMA_Q_CONNECTED
 = (1 << 0),

87 
	mNVME_RDMA_IB_QUEUE_ALLOCATED
 = (1 << 1),

88 
	mNVME_RDMA_Q_DELETING
 = (1 << 2),

89 
	mNVME_RDMA_Q_LIVE
 = (1 << 3),

92 
	snvme_rdma_queue
 {

93 
nvme_rdma_qe
 *
	mr¥_ršg
;

94 
u8
 
	msig_couÁ
;

95 
	mqueue_size
;

96 
size_t
 
	mcmnd_ÿpsuË_Ën
;

97 
nvme_rdma_ù¾
 *
	mù¾
;

98 
nvme_rdma_deviû
 *
	mdeviû
;

99 
ib_cq
 *
	mib_cq
;

100 
ib_qp
 *
	mqp
;

102 
	mæags
;

103 
rdma_cm_id
 *
	mcm_id
;

104 
	mcm_”rÜ
;

105 
com¶‘iÚ
 
	mcm_dÚe
;

108 
	snvme_rdma_ù¾
 {

110 
¥šlock_t
 
	mlock
;

113 
nvme_rdma_queue
 *
	mqueues
;

114 
u32
 
	mqueue_couÁ
;

117 
blk_mq_g_£t
 
	mg_£t
;

118 
wÜk_¡ruù
 
	md–‘e_wÜk
;

119 
wÜk_¡ruù
 
	m»£t_wÜk
;

120 
wÜk_¡ruù
 
	m”r_wÜk
;

122 
nvme_rdma_qe
 
	masync_ev’t_sqe
;

124 
	m»cÚÃù_d–ay
;

125 
d–ayed_wÜk
 
	m»cÚÃù_wÜk
;

127 
li¡_h—d
 
	mli¡
;

129 
blk_mq_g_£t
 
	madmš_g_£t
;

130 
nvme_rdma_deviû
 *
	mdeviû
;

132 
u64
 
	mÿp
;

133 
u32
 
	mmax_ä_·ges
;

136 
sockaddr
 
	maddr
;

137 
sockaddr_š
 
	maddr_š
;

140 
nvme_ù¾
 
	mù¾
;

143 
šlše
 
nvme_rdma_ù¾
 *
	$to_rdma_ù¾
(
nvme_ù¾
 *
ù¾
)

145  
	`cÚš”_of
(
ù¾
, 
nvme_rdma_ù¾
, ctrl);

146 
	}
}

148 
LIST_HEAD
(
deviû_li¡
);

149 
DEFINE_MUTEX
(
deviû_li¡_mu‹x
);

151 
LIST_HEAD
(
nvme_rdma_ù¾_li¡
);

152 
DEFINE_MUTEX
(
nvme_rdma_ù¾_mu‹x
);

154 
wÜkqueue_¡ruù
 *
	gnvme_rdma_wq
;

161 
boŞ
 
	g»gi¡”_®ways
 = 
Œue
;

162 
moduË_·¿m
(
»gi¡”_®ways
, 
boŞ
, 0444);

163 
MODULE_PARM_DESC
(
»gi¡”_®ways
,

166 
nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

167 
rdma_cm_ev’t
 *
ev’t
);

168 
nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
);

171 
šlše
 
	$put_uÇligÃd_Ë24
(
u32
 
v®
, 
u8
 *
p
)

173 *
p
++ = 
v®
;

174 *
p
++ = 
v®
 >> 8;

175 *
p
++ = 
v®
 >> 16;

176 
	}
}

178 
šlše
 
	$nvme_rdma_queue_idx
(
nvme_rdma_queue
 *
queue
)

180  
queue
 - queue->
ù¾
->
queues
;

181 
	}
}

183 
šlše
 
size_t
 
	$nvme_rdma_šlše_d©a_size
(
nvme_rdma_queue
 *
queue
)

185  
queue
->
cmnd_ÿpsuË_Ën
 - (
nvme_commªd
);

186 
	}
}

188 
	$nvme_rdma_ä“_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

189 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

191 
	`ib_dma_unm­_sšgË
(
ibdev
, 
qe
->
dma
, 
ÿpsuË_size
, 
dœ
);

192 
	`kä“
(
qe
->
d©a
);

193 
	}
}

195 
	$nvme_rdma_®loc_qe
(
ib_deviû
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

196 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

198 
qe
->
d©a
 = 
	`kz®loc
(
ÿpsuË_size
, 
GFP_KERNEL
);

199 ià(!
qe
->
d©a
)

200  -
ENOMEM
;

202 
qe
->
dma
 = 
	`ib_dma_m­_sšgË
(
ibdev
, qe->
d©a
, 
ÿpsuË_size
, 
dœ
);

203 ià(
	`ib_dma_m­pšg_”rÜ
(
ibdev
, 
qe
->
dma
)) {

204 
	`kä“
(
qe
->
d©a
);

205  -
ENOMEM
;

209 
	}
}

211 
	$nvme_rdma_ä“_ršg
(
ib_deviû
 *
ibdev
,

212 
nvme_rdma_qe
 *
ršg
, 
size_t
 
ib_queue_size
,

213 
size_t
 
ÿpsuË_size
, 
dma_d©a_dœeùiÚ
 
dœ
)

215 
i
;

217 
i
 = 0; i < 
ib_queue_size
; i++)

218 
	`nvme_rdma_ä“_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
);

219 
	`kä“
(
ršg
);

220 
	}
}

222 
nvme_rdma_qe
 *
	$nvme_rdma_®loc_ršg
(
ib_deviû
 *
ibdev
,

223 
size_t
 
ib_queue_size
, size_ˆ
ÿpsuË_size
,

224 
dma_d©a_dœeùiÚ
 
dœ
)

226 
nvme_rdma_qe
 *
ršg
;

227 
i
;

229 
ršg
 = 
	`kÿÎoc
(
ib_queue_size
, (
nvme_rdma_qe
), 
GFP_KERNEL
);

230 ià(!
ršg
)

231  
NULL
;

233 
i
 = 0; i < 
ib_queue_size
; i++) {

234 ià(
	`nvme_rdma_®loc_qe
(
ibdev
, &
ršg
[
i
], 
ÿpsuË_size
, 
dœ
))

235 
out_ä“_ršg
;

238  
ršg
;

240 
out_ä“_ršg
:

241 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
ršg
, 
i
, 
ÿpsuË_size
, 
dœ
);

242  
NULL
;

243 
	}
}

245 
	$nvme_rdma_qp_ev’t
(
ib_ev’t
 *
ev’t
, *
cÚ‹xt
)

247 
	`´_debug
("QPƒv’ˆ%d\n", 
ev’t
->event);

248 
	}
}

250 
	$nvme_rdma_wa™_fÜ_cm
(
nvme_rdma_queue
 *
queue
)

252 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(&
queue
->
cm_dÚe
,

253 
	`m£cs_to_jiff›s
(
NVME_RDMA_CONNECT_TIMEOUT_MS
) + 1);

254  
queue
->
cm_”rÜ
;

255 
	}
}

257 
	$nvme_rdma_ü—‹_qp
(
nvme_rdma_queue
 *
queue
, cÚ¡ 
çùÜ
)

259 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

260 
ib_qp_š™_©Œ
 
š™_©Œ
;

261 
»t
;

263 
	`mem£t
(&
š™_©Œ
, 0, (init_attr));

264 
š™_©Œ
.
ev’t_hªdËr
 = 
nvme_rdma_qp_ev’t
;

266 
š™_©Œ
.
ÿp
.
max_£nd_wr
 = 
çùÜ
 * 
queue
->
queue_size
 + 1;

268 
š™_©Œ
.
ÿp
.
max_»cv_wr
 = 
queue
->
queue_size
 + 1;

269 
š™_©Œ
.
ÿp
.
max_»cv_sge
 = 1;

270 
š™_©Œ
.
ÿp
.
max_£nd_sge
 = 1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
;

271 
š™_©Œ
.
sq_sig_ty³
 = 
IB_SIGNAL_REQ_WR
;

272 
š™_©Œ
.
qp_ty³
 = 
IB_QPT_RC
;

273 
š™_©Œ
.
£nd_cq
 = 
queue
->
ib_cq
;

274 
š™_©Œ
.
»cv_cq
 = 
queue
->
ib_cq
;

276 
»t
 = 
	`rdma_ü—‹_qp
(
queue
->
cm_id
, 
dev
->
pd
, &
š™_©Œ
);

278 
queue
->
qp
 = queue->
cm_id
->qp;

279  
»t
;

280 
	}
}

282 
	$nvme_rdma_»š™_»que¡
(*
d©a
, 
»que¡
 *
rq
)

284 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

285 
nvme_rdma_deviû
 *
dev
 = 
ù¾
->
deviû
;

286 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

287 
»t
 = 0;

289 ià(!
»q
->
mr
->
Ãed_šv®
)

290 
out
;

292 
	`ib_d”eg_mr
(
»q
->
mr
);

294 
»q
->
mr
 = 
	`ib_®loc_mr
(
dev
->
pd
, 
IB_MR_TYPE_MEM_REG
,

295 
ù¾
->
max_ä_·ges
);

296 ià(
	`IS_ERR
(
»q
->
mr
)) {

297 
»t
 = 
	`PTR_ERR
(
»q
->
mr
);

298 
»q
->
mr
 = 
NULL
;

299 
out
;

302 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

304 
out
:

305  
»t
;

306 
	}
}

308 
	$__nvme_rdma_ex™_»que¡
(
nvme_rdma_ù¾
 *
ù¾
,

309 
»que¡
 *
rq
, 
queue_idx
)

311 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

312 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

313 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

315 ià(
»q
->
mr
)

316 
	`ib_d”eg_mr
(
»q
->
mr
);

318 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

319 
DMA_TO_DEVICE
);

320 
	}
}

322 
	$nvme_rdma_ex™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

323 
hùx_idx
, 
rq_idx
)

325  
	`__nvme_rdma_ex™_»que¡
(
d©a
, 
rq
, 
hùx_idx
 + 1);

326 
	}
}

328 
	$nvme_rdma_ex™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

329 
hùx_idx
, 
rq_idx
)

331  
	`__nvme_rdma_ex™_»que¡
(
d©a
, 
rq
, 0);

332 
	}
}

334 
	$__nvme_rdma_š™_»que¡
(
nvme_rdma_ù¾
 *
ù¾
,

335 
»que¡
 *
rq
, 
queue_idx
)

337 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

338 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
queue_idx
];

339 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

340 
ib_deviû
 *
ibdev
 = 
dev
->dev;

341 
»t
;

343 
	`BUG_ON
(
queue_idx
 >ğ
ù¾
->
queue_couÁ
);

345 
»t
 = 
	`nvme_rdma_®loc_qe
(
ibdev
, &
»q
->
sqe
, (
nvme_commªd
),

346 
DMA_TO_DEVICE
);

347 ià(
»t
)

348  
»t
;

350 
»q
->
mr
 = 
	`ib_®loc_mr
(
dev
->
pd
, 
IB_MR_TYPE_MEM_REG
,

351 
ù¾
->
max_ä_·ges
);

352 ià(
	`IS_ERR
(
»q
->
mr
)) {

353 
»t
 = 
	`PTR_ERR
(
»q
->
mr
);

354 
out_ä“_qe
;

357 
»q
->
queue
 = queue;

361 
out_ä“_qe
:

362 
	`nvme_rdma_ä“_qe
(
dev
->dev, &
»q
->
sqe
, (
nvme_commªd
),

363 
DMA_TO_DEVICE
);

364  -
ENOMEM
;

365 
	}
}

367 
	$nvme_rdma_š™_»que¡
(*
d©a
, 
»que¡
 *
rq
,

368 
hùx_idx
, 
rq_idx
,

369 
numa_node
)

371  
	`__nvme_rdma_š™_»que¡
(
d©a
, 
rq
, 
hùx_idx
 + 1);

372 
	}
}

374 
	$nvme_rdma_š™_admš_»que¡
(*
d©a
, 
»que¡
 *
rq
,

375 
hùx_idx
, 
rq_idx
,

376 
numa_node
)

378  
	`__nvme_rdma_š™_»que¡
(
d©a
, 
rq
, 0);

379 
	}
}

381 
	$nvme_rdma_š™_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

382 
hùx_idx
)

384 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

385 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[
hùx_idx
 + 1];

387 
	`BUG_ON
(
hùx_idx
 >ğ
ù¾
->
queue_couÁ
);

389 
hùx
->
driv”_d©a
 = 
queue
;

391 
	}
}

393 
	$nvme_rdma_š™_admš_hùx
(
blk_mq_hw_ùx
 *
hùx
, *
d©a
,

394 
hùx_idx
)

396 
nvme_rdma_ù¾
 *
ù¾
 = 
d©a
;

397 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

399 
	`BUG_ON
(
hùx_idx
 != 0);

401 
hùx
->
driv”_d©a
 = 
queue
;

403 
	}
}

405 
	$nvme_rdma_ä“_dev
(
k»f
 *
»f
)

407 
nvme_rdma_deviû
 *
ndev
 =

408 
	`cÚš”_of
(
»f
, 
nvme_rdma_deviû
,„ef);

410 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

411 
	`li¡_d–
(&
ndev
->
’Œy
);

412 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

414 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

415 
	`kä“
(
ndev
);

416 
	}
}

418 
	$nvme_rdma_dev_put
(
nvme_rdma_deviû
 *
dev
)

420 
	`k»f_put
(&
dev
->
»f
, 
nvme_rdma_ä“_dev
);

421 
	}
}

423 
	$nvme_rdma_dev_g‘
(
nvme_rdma_deviû
 *
dev
)

425  
	`k»f_g‘_uÆess_z”o
(&
dev
->
»f
);

426 
	}
}

428 
nvme_rdma_deviû
 *

429 
	$nvme_rdma_fšd_g‘_deviû
(
rdma_cm_id
 *
cm_id
)

431 
nvme_rdma_deviû
 *
ndev
;

433 
	`mu‹x_lock
(&
deviû_li¡_mu‹x
);

434 
	`li¡_fÜ_—ch_’Œy
(
ndev
, &
deviû_li¡
, 
’Œy
) {

435 ià(
ndev
->
dev
->
node_guid
 =ğ
cm_id
->
deviû
->node_guid &&

436 
	`nvme_rdma_dev_g‘
(
ndev
))

437 
out_uÆock
;

440 
ndev
 = 
	`kz®loc
((*ndev), 
GFP_KERNEL
);

441 ià(!
ndev
)

442 
out_”r
;

444 
ndev
->
dev
 = 
cm_id
->
deviû
;

445 
	`k»f_š™
(&
ndev
->
»f
);

447 
ndev
->
pd
 = 
	`ib_®loc_pd
Òdev->
dev
,

448 
»gi¡”_®ways
 ? 0 : 
IB_PD_UNSAFE_GLOBAL_RKEY
);

449 ià(
	`IS_ERR
(
ndev
->
pd
))

450 
out_ä“_dev
;

452 ià(!(
ndev
->
dev
->
©Œs
.
deviû_ÿp_æags
 &

453 
IB_DEVICE_MEM_MGT_EXTENSIONS
)) {

454 
	`dev_”r
(&
ndev
->
dev
->dev,

456 
out_ä“_pd
;

459 
	`li¡_add
(&
ndev
->
’Œy
, &
deviû_li¡
);

460 
out_uÆock
:

461 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

462  
ndev
;

464 
out_ä“_pd
:

465 
	`ib_d—Îoc_pd
(
ndev
->
pd
);

466 
out_ä“_dev
:

467 
	`kä“
(
ndev
);

468 
out_”r
:

469 
	`mu‹x_uÆock
(&
deviû_li¡_mu‹x
);

470  
NULL
;

471 
	}
}

473 
	$nvme_rdma_de¡roy_queue_ib
(
nvme_rdma_queue
 *
queue
)

475 
nvme_rdma_deviû
 *
dev
;

476 
ib_deviû
 *
ibdev
;

478 ià(!
	`‹¡_ªd_ş—r_b™
(
NVME_RDMA_IB_QUEUE_ALLOCATED
, &
queue
->
æags
))

481 
dev
 = 
queue
->
deviû
;

482 
ibdev
 = 
dev
->dev;

483 
	`rdma_de¡roy_qp
(
queue
->
cm_id
);

484 
	`ib_ä“_cq
(
queue
->
ib_cq
);

486 
	`nvme_rdma_ä“_ršg
(
ibdev
, 
queue
->
r¥_ršg
, queue->
queue_size
,

487 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

489 
	`nvme_rdma_dev_put
(
dev
);

490 
	}
}

492 
	$nvme_rdma_ü—‹_queue_ib
(
nvme_rdma_queue
 *
queue
,

493 
nvme_rdma_deviû
 *
dev
)

495 
ib_deviû
 *
ibdev
 = 
dev
->dev;

496 cÚ¡ 
£nd_wr_çùÜ
 = 3;

497 cÚ¡ 
cq_çùÜ
 = 
£nd_wr_çùÜ
 + 1;

498 
comp_veùÜ
, 
idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

500 
»t
;

502 
queue
->
deviû
 = 
dev
;

508 ià(
idx
 == 0)

509 
comp_veùÜ
 = 0;

511 
comp_veùÜ
 = 
idx
 % 
ibdev
->
num_comp_veùÜs
;

515 
queue
->
ib_cq
 = 
	`ib_®loc_cq
(
dev
->dev, queue,

516 
cq_çùÜ
 * 
queue
->
queue_size
 + 1, 
comp_veùÜ
,

517 
IB_POLL_SOFTIRQ
);

518 ià(
	`IS_ERR
(
queue
->
ib_cq
)) {

519 
»t
 = 
	`PTR_ERR
(
queue
->
ib_cq
);

520 
out
;

523 
»t
 = 
	`nvme_rdma_ü—‹_qp
(
queue
, 
£nd_wr_çùÜ
);

524 ià(
»t
)

525 
out_de¡roy_ib_cq
;

527 
queue
->
r¥_ršg
 = 
	`nvme_rdma_®loc_ršg
(
ibdev
, queue->
queue_size
,

528 (
nvme_com¶‘iÚ
), 
DMA_FROM_DEVICE
);

529 ià(!
queue
->
r¥_ršg
) {

530 
»t
 = -
ENOMEM
;

531 
out_de¡roy_qp
;

533 
	`£t_b™
(
NVME_RDMA_IB_QUEUE_ALLOCATED
, &
queue
->
æags
);

537 
out_de¡roy_qp
:

538 
	`ib_de¡roy_qp
(
queue
->
qp
);

539 
out_de¡roy_ib_cq
:

540 
	`ib_ä“_cq
(
queue
->
ib_cq
);

541 
out
:

542  
»t
;

543 
	}
}

545 
	$nvme_rdma_š™_queue
(
nvme_rdma_ù¾
 *
ù¾
,

546 
idx
, 
size_t
 
queue_size
)

548 
nvme_rdma_queue
 *
queue
;

549 
»t
;

551 
queue
 = &
ù¾
->
queues
[
idx
];

552 
queue
->
ù¾
 = ctrl;

553 
	`š™_com¶‘iÚ
(&
queue
->
cm_dÚe
);

555 ià(
idx
 > 0)

556 
queue
->
cmnd_ÿpsuË_Ën
 = 
ù¾
->ù¾.
ioccsz
 * 16;

558 
queue
->
cmnd_ÿpsuË_Ën
 = (
nvme_commªd
);

560 
queue
->
queue_size
 = queue_size;

562 
queue
->
cm_id
 = 
	`rdma_ü—‹_id
(&
š™_Ãt
, 
nvme_rdma_cm_hªdËr
, queue,

563 
RDMA_PS_TCP
, 
IB_QPT_RC
);

564 ià(
	`IS_ERR
(
queue
->
cm_id
)) {

565 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

566 "çedØü—‹ CM ID: %ld\n", 
	`PTR_ERR
(
queue
->
cm_id
));

567  
	`PTR_ERR
(
queue
->
cm_id
);

570 
queue
->
cm_”rÜ
 = -
ETIMEDOUT
;

571 
»t
 = 
	`rdma_»sŞve_addr
(
queue
->
cm_id
, 
NULL
, &
ù¾
->
addr
,

572 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

573 ià(
»t
) {

574 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

575 "rdma_»sŞve_add¸çed (%d).\n", 
»t
);

576 
out_de¡roy_cm_id
;

579 
»t
 = 
	`nvme_rdma_wa™_fÜ_cm
(
queue
);

580 ià(
»t
) {

581 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

582 "rdma_»sŞve_add¸wa™ faed (%d).\n", 
»t
);

583 
out_de¡roy_cm_id
;

586 
	`ş—r_b™
(
NVME_RDMA_Q_DELETING
, &
queue
->
æags
);

587 
	`£t_b™
(
NVME_RDMA_Q_CONNECTED
, &
queue
->
æags
);

591 
out_de¡roy_cm_id
:

592 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

593 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

594  
»t
;

595 
	}
}

597 
	$nvme_rdma_¡İ_queue
(
nvme_rdma_queue
 *
queue
)

599 
	`rdma_discÚÃù
(
queue
->
cm_id
);

600 
	`ib_d¿š_qp
(
queue
->
qp
);

601 
	}
}

603 
	$nvme_rdma_ä“_queue
(
nvme_rdma_queue
 *
queue
)

605 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

606 
	`rdma_de¡roy_id
(
queue
->
cm_id
);

607 
	}
}

609 
	$nvme_rdma_¡İ_ªd_ä“_queue
(
nvme_rdma_queue
 *
queue
)

611 ià(
	`‹¡_ªd_£t_b™
(
NVME_RDMA_Q_DELETING
, &
queue
->
æags
))

613 
	`nvme_rdma_¡İ_queue
(
queue
);

614 
	`nvme_rdma_ä“_queue
(
queue
);

615 
	}
}

617 
	$nvme_rdma_ä“_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

619 
i
;

621 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++)

622 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[
i
]);

623 
	}
}

625 
	$nvme_rdma_cÚÃù_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

627 
i
, 
»t
 = 0;

629 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++) {

630 
»t
 = 
	`nvmf_cÚÃù_io_queue
(&
ù¾
->ù¾, 
i
);

631 ià(
»t
) {

632 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

633 "çedØcÚÃù i/Øqueue: %d\n", 
»t
);

634 
out_ä“_queues
;

636 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

641 
out_ä“_queues
:

642 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

643  
»t
;

644 
	}
}

646 
	$nvme_rdma_š™_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

648 
i
, 
»t
;

650 
i
 = 1; i < 
ù¾
->
queue_couÁ
; i++) {

651 
»t
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 
i
,

652 
ù¾
->ù¾.
İts
->
queue_size
);

653 ià(
»t
) {

654 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

655 "çedØš™Ÿlizi/Øqueue: %d\n", 
»t
);

656 
out_ä“_queues
;

662 
out_ä“_queues
:

663 
i
--; i >= 1; i--)

664 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[
i
]);

666  
»t
;

667 
	}
}

669 
	$nvme_rdma_de¡roy_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
)

671 
	`nvme_rdma_ä“_qe
(
ù¾
->
queues
[0].
deviû
->
dev
, &ù¾->
async_ev’t_sqe
,

672 (
nvme_commªd
), 
DMA_TO_DEVICE
);

673 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[0]);

674 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

675 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

676 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

677 
	}
}

679 
	$nvme_rdma_ä“_ù¾
(
nvme_ù¾
 *
nù¾
)

681 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

683 ià(
	`li¡_em±y
(&
ù¾
->
li¡
))

684 
ä“_ù¾
;

686 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

687 
	`li¡_d–
(&
ù¾
->
li¡
);

688 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

690 
	`kä“
(
ù¾
->
queues
);

691 
	`nvmf_ä“_İtiÚs
(
nù¾
->
İts
);

692 
ä“_ù¾
:

693 
	`kä“
(
ù¾
);

694 
	}
}

696 
	$nvme_rdma_»cÚÃù_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

698 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

699 
nvme_rdma_ù¾
, 
»cÚÃù_wÜk
);

700 
boŞ
 
chªged
;

701 
»t
;

703 ià(
ù¾
->
queue_couÁ
 > 1) {

704 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

706 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

707 ià(
»t
)

708 
»queue
;

711 
	`nvme_rdma_¡İ_ªd_ä“_queue
(&
ù¾
->
queues
[0]);

713 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
admš_g_£t
);

714 ià(
»t
)

715 
»queue
;

717 
»t
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 0, 
NVMF_AQ_DEPTH
);

718 ià(
»t
)

719 
»queue
;

721 
	`blk_mq_¡¬t_¡İ³d_hw_queues
(
ù¾
->ù¾.
admš_q
, 
Œue
);

723 
»t
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

724 ià(
»t
)

725 
¡İ_admš_q
;

727 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

729 
»t
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->
ÿp
);

730 ià(
»t
)

731 
¡İ_admš_q
;

733 
	`nvme_¡¬t_k“p_®ive
(&
ù¾
->ctrl);

735 ià(
ù¾
->
queue_couÁ
 > 1) {

736 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

737 ià(
»t
)

738 
¡İ_admš_q
;

740 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

741 ià(
»t
)

742 
¡İ_admš_q
;

745 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

746 
	`WARN_ON_ONCE
(!
chªged
);

748 ià(
ù¾
->
queue_couÁ
 > 1) {

749 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

750 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

751 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

754 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "Successfully„econnected\n");

758 
¡İ_admš_q
:

759 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

760 
»queue
:

762 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_RECONNECTING
) {

763 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

765 
	`queue_d–ayed_wÜk
(
nvme_rdma_wq
, &
ù¾
->
»cÚÃù_wÜk
,

766 
ù¾
->
»cÚÃù_d–ay
 * 
HZ
);

768 
	}
}

770 
	$nvme_rdma_”rÜ_»cov”y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

772 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

773 
nvme_rdma_ù¾
, 
”r_wÜk
);

774 
i
;

776 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

778 
i
 = 0; i < 
ù¾
->
queue_couÁ
; i++) {

779 
	`ş—r_b™
(
NVME_RDMA_Q_CONNECTED
, &
ù¾
->
queues
[
i
].
æags
);

780 
	`ş—r_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[
i
].
æags
);

783 ià(
ù¾
->
queue_couÁ
 > 1)

784 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

785 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

788 ià(
ù¾
->
queue_couÁ
 > 1)

789 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

790 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

791 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

792 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

794 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "reconnecting in %d seconds\n",

795 
ù¾
->
»cÚÃù_d–ay
);

797 
	`queue_d–ayed_wÜk
(
nvme_rdma_wq
, &
ù¾
->
»cÚÃù_wÜk
,

798 
ù¾
->
»cÚÃù_d–ay
 * 
HZ
);

799 
	}
}

801 
	$nvme_rdma_”rÜ_»cov”y
(
nvme_rdma_ù¾
 *
ù¾
)

803 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RECONNECTING
))

806 
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
”r_wÜk
);

807 
	}
}

809 
	$nvme_rdma_wr_”rÜ
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
,

810 cÚ¡ *
İ
)

812 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

813 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

815 ià(
ù¾
->ù¾.
¡©e
 =ğ
NVME_CTRL_LIVE
)

816 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

818 
İ
, 
wc
->
wr_cqe
,

819 
	`ib_wc_¡©us_msg
(
wc
->
¡©us
), wc->status);

820 
	`nvme_rdma_”rÜ_»cov”y
(
ù¾
);

821 
	}
}

823 
	$nvme_rdma_mem»g_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

825 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

826 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "MEMREG");

827 
	}
}

829 
	$nvme_rdma_šv_rkey_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

831 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

832 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "LOCAL_INV");

833 
	}
}

835 
	$nvme_rdma_šv_rkey
(
nvme_rdma_queue
 *
queue
,

836 
nvme_rdma_»que¡
 *
»q
)

838 
ib_£nd_wr
 *
bad_wr
;

839 
ib_£nd_wr
 
wr
 = {

840 .
İcode
 = 
IB_WR_LOCAL_INV
,

841 .
Ãxt
 = 
NULL
,

842 .
num_sge
 = 0,

843 .
£nd_æags
 = 0,

844 .
ex
.
šv®id©e_rkey
 = 
»q
->
mr
->
rkey
,

847 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_šv_rkey_dÚe
;

848 
wr
.
wr_cqe
 = &
»q
->
»g_cqe
;

850  
	`ib_po¡_£nd
(
queue
->
qp
, &
wr
, &
bad_wr
);

851 
	}
}

853 
	$nvme_rdma_unm­_d©a
(
nvme_rdma_queue
 *
queue
,

854 
»que¡
 *
rq
)

856 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

857 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

858 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

859 
ib_deviû
 *
ibdev
 = 
dev
->dev;

860 
»s
;

862 ià(!
	`blk_rq_by‹s
(
rq
))

865 ià(
»q
->
mr
->
Ãed_šv®
) {

866 
»s
 = 
	`nvme_rdma_šv_rkey
(
queue
, 
»q
);

867 ià(
»s
 < 0) {

868 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

870 
»q
->
mr
->
rkey
, 
»s
);

871 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

875 
	`ib_dma_unm­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
,

876 
»q
->
ÃÁs
, 
	`rq_d©a_dœ
(
rq
) ==

877 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

879 
	`nvme_ş—nup_cmd
(
rq
);

880 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

881 
	}
}

883 
	$nvme_rdma_£t_sg_nuÎ
(
nvme_commªd
 *
c
)

885 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

887 
sg
->
addr
 = 0;

888 
	`put_uÇligÃd_Ë24
(0, 
sg
->
Ëngth
);

889 
	`put_uÇligÃd_Ë32
(0, 
sg
->
key
);

890 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

892 
	}
}

894 
	$nvme_rdma_m­_sg_šlše
(
nvme_rdma_queue
 *
queue
,

895 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

897 
nvme_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
sgl
;

899 
»q
->
sge
[1].
addr
 = 
	`sg_dma_add»ss
Ôeq->
sg_bË
.
sgl
);

900 
»q
->
sge
[1].
Ëngth
 = 
	`sg_dma_Ën
Ôeq->
sg_bË
.
sgl
);

901 
»q
->
sge
[1].
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

903 
sg
->
addr
 = 
	`ıu_to_Ë64
(
queue
->
ù¾
->ù¾.
icdoff
);

904 
sg
->
Ëngth
 = 
	`ıu_to_Ë32
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
));

905 
sg
->
ty³
 = (
NVME_SGL_FMT_DATA_DESC
 << 4è| 
NVME_SGL_FMT_OFFSET
;

907 
»q
->
šlše_d©a
 = 
Œue
;

908 
»q
->
num_sge
++;

910 
	}
}

912 
	$nvme_rdma_m­_sg_sšgË
(
nvme_rdma_queue
 *
queue
,

913 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
)

915 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

917 
sg
->
addr
 = 
	`ıu_to_Ë64
(
	`sg_dma_add»ss
(
»q
->
sg_bË
.
sgl
));

918 
	`put_uÇligÃd_Ë24
(
	`sg_dma_Ën
(
»q
->
sg_bË
.
sgl
), 
sg
->
Ëngth
);

919 
	`put_uÇligÃd_Ë32
(
queue
->
deviû
->
pd
->
un§ã_glob®_rkey
, 
sg
->
key
);

920 
sg
->
ty³
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

922 
	}
}

924 
	$nvme_rdma_m­_sg_ä
(
nvme_rdma_queue
 *
queue
,

925 
nvme_rdma_»que¡
 *
»q
, 
nvme_commªd
 *
c
,

926 
couÁ
)

928 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
commÚ
.
d±r
.
ksgl
;

929 
Ä
;

931 
Ä
 = 
	`ib_m­_mr_sg
(
»q
->
mr
,„eq->
sg_bË
.
sgl
, 
couÁ
, 
NULL
, 
PAGE_SIZE
);

932 ià(
Ä
 < 
couÁ
) {

933 ià(
Ä
 < 0)

934  
Ä
;

935  -
EINVAL
;

938 
	`ib_upd©e_ç¡_»g_key
(
»q
->
mr
, 
	`ib_šc_rkey
Ôeq->mr->
rkey
));

940 
»q
->
»g_cqe
.
dÚe
 = 
nvme_rdma_mem»g_dÚe
;

941 
	`mem£t
(&
»q
->
»g_wr
, 0, (req->reg_wr));

942 
»q
->
»g_wr
.
wr
.
İcode
 = 
IB_WR_REG_MR
;

943 
»q
->
»g_wr
.
wr
.
wr_cqe
 = &»q->
»g_cqe
;

944 
»q
->
»g_wr
.
wr
.
num_sge
 = 0;

945 
»q
->
»g_wr
.
mr
 =„eq->mr;

946 
»q
->
»g_wr
.
key
 =„eq->
mr
->
rkey
;

947 
»q
->
»g_wr
.
acûss
 = 
IB_ACCESS_LOCAL_WRITE
 |

948 
IB_ACCESS_REMOTE_READ
 |

949 
IB_ACCESS_REMOTE_WRITE
;

951 
»q
->
mr
->
Ãed_šv®
 = 
Œue
;

953 
sg
->
addr
 = 
	`ıu_to_Ë64
(
»q
->
mr
->
iova
);

954 
	`put_uÇligÃd_Ë24
(
»q
->
mr
->
Ëngth
, 
sg
->length);

955 
	`put_uÇligÃd_Ë32
(
»q
->
mr
->
rkey
, 
sg
->
key
);

956 
sg
->
ty³
 = (
NVME_KEY_SGL_FMT_DATA_DESC
 << 4) |

957 
NVME_SGL_FMT_INVALIDATE
;

960 
	}
}

962 
	$nvme_rdma_m­_d©a
(
nvme_rdma_queue
 *
queue
,

963 
»que¡
 *
rq
, 
m­_Ën
,

964 
nvme_commªd
 *
c
)

966 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

967 
nvme_rdma_deviû
 *
dev
 = 
queue
->
deviû
;

968 
ib_deviû
 *
ibdev
 = 
dev
->dev;

969 
ÃÁs
, 
couÁ
;

970 
»t
;

972 
»q
->
num_sge
 = 1;

973 
»q
->
šlše_d©a
 = 
çl£
;

974 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

976 
c
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

978 ià(!
	`blk_rq_by‹s
(
rq
))

979  
	`nvme_rdma_£t_sg_nuÎ
(
c
);

981 
»q
->
sg_bË
.
sgl
 =„eq->
fœ¡_sgl
;

982 
»t
 = 
	`sg_®loc_bË_chašed
(&
»q
->
sg_bË
, 
rq
->
Ä_phys_£gm’ts
,

983 
»q
->
sg_bË
.
sgl
);

984 ià(
»t
)

985  -
ENOMEM
;

987 
ÃÁs
 = 
	`blk_rq_m­_sg
(
rq
->
q
,„q, 
»q
->
sg_bË
.
sgl
);

988 
	`BUG_ON
(
ÃÁs
 > 
rq
->
Ä_phys_£gm’ts
);

989 
»q
->
ÃÁs
 =‚ents;

991 
couÁ
 = 
	`ib_dma_m­_sg
(
ibdev
, 
»q
->
sg_bË
.
sgl
, 
ÃÁs
,

992 
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

993 ià(
	`uÆik–y
(
couÁ
 <= 0)) {

994 
	`sg_ä“_bË_chašed
(&
»q
->
sg_bË
, 
Œue
);

995  -
EIO
;

998 ià(
couÁ
 == 1) {

999 ià(
	`rq_d©a_dœ
(
rq
è=ğ
WRITE
 &&

1000 
m­_Ën
 <ğ
	`nvme_rdma_šlše_d©a_size
(
queue
) &&

1001 
	`nvme_rdma_queue_idx
(
queue
))

1002  
	`nvme_rdma_m­_sg_šlše
(
queue
, 
»q
, 
c
);

1004 ià(
dev
->
pd
->
æags
 & 
IB_PD_UNSAFE_GLOBAL_RKEY
)

1005  
	`nvme_rdma_m­_sg_sšgË
(
queue
, 
»q
, 
c
);

1008  
	`nvme_rdma_m­_sg_ä
(
queue
, 
»q
, 
c
, 
couÁ
);

1009 
	}
}

1011 
	$nvme_rdma_£nd_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1013 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
))

1014 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "SEND");

1015 
	}
}

1017 
	$nvme_rdma_po¡_£nd
(
nvme_rdma_queue
 *
queue
,

1018 
nvme_rdma_qe
 *
qe
, 
ib_sge
 *
sge
, 
u32
 
num_sge
,

1019 
ib_£nd_wr
 *
fœ¡
, 
boŞ
 
æush
)

1021 
ib_£nd_wr
 
wr
, *
bad_wr
;

1022 
»t
;

1024 
sge
->
addr
 = 
qe
->
dma
;

1025 
sge
->
Ëngth
 = (
nvme_commªd
),

1026 
sge
->
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1028 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_£nd_dÚe
;

1030 
wr
.
Ãxt
 = 
NULL
;

1031 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1032 
wr
.
sg_li¡
 = 
sge
;

1033 
wr
.
num_sge
 =‚um_sge;

1034 
wr
.
İcode
 = 
IB_WR_SEND
;

1035 
wr
.
£nd_æags
 = 0;

1054 ià((++
queue
->
sig_couÁ
 % 32è=ğ0 || 
æush
)

1055 
wr
.
£nd_æags
 |ğ
IB_SEND_SIGNALED
;

1057 ià(
fœ¡
)

1058 
fœ¡
->
Ãxt
 = &
wr
;

1060 
fœ¡
 = &
wr
;

1062 
»t
 = 
	`ib_po¡_£nd
(
queue
->
qp
, 
fœ¡
, &
bad_wr
);

1063 ià(
»t
) {

1064 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1065 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1067  
»t
;

1068 
	}
}

1070 
	$nvme_rdma_po¡_»cv
(
nvme_rdma_queue
 *
queue
,

1071 
nvme_rdma_qe
 *
qe
)

1073 
ib_»cv_wr
 
wr
, *
bad_wr
;

1074 
ib_sge
 
li¡
;

1075 
»t
;

1077 
li¡
.
addr
 = 
qe
->
dma
;

1078 
li¡
.
Ëngth
 = (
nvme_com¶‘iÚ
);

1079 
li¡
.
lkey
 = 
queue
->
deviû
->
pd
->
loÿl_dma_lkey
;

1081 
qe
->
cqe
.
dÚe
 = 
nvme_rdma_»cv_dÚe
;

1083 
wr
.
Ãxt
 = 
NULL
;

1084 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1085 
wr
.
sg_li¡
 = &
li¡
;

1086 
wr
.
num_sge
 = 1;

1088 
»t
 = 
	`ib_po¡_»cv
(
queue
->
qp
, &
wr
, &
bad_wr
);

1089 ià(
»t
) {

1090 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1091 "% çed w™hƒ¼Ü cod%d\n", 
__func__
, 
»t
);

1093  
»t
;

1094 
	}
}

1096 
blk_mq_gs
 *
	$nvme_rdma_g£t
(
nvme_rdma_queue
 *
queue
)

1098 
u32
 
queue_idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

1100 ià(
queue_idx
 == 0)

1101  
queue
->
ù¾
->
admš_g_£t
.
gs
[
queue_idx
];

1102  
queue
->
ù¾
->
g_£t
.
gs
[
queue_idx
 - 1];

1103 
	}
}

1105 
	$nvme_rdma_subm™_async_ev’t
(
nvme_ù¾
 *
¬g
, 
«r_idx
)

1107 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
¬g
);

1108 
nvme_rdma_queue
 *
queue
 = &
ù¾
->
queues
[0];

1109 
ib_deviû
 *
dev
 = 
queue
->
deviû
->dev;

1110 
nvme_rdma_qe
 *
sqe
 = &
ù¾
->
async_ev’t_sqe
;

1111 
nvme_commªd
 *
cmd
 = 
sqe
->
d©a
;

1112 
ib_sge
 
sge
;

1113 
»t
;

1115 ià(
	`WARN_ON_ONCE
(
«r_idx
 != 0))

1118 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
, (*
cmd
), 
DMA_TO_DEVICE
);

1120 
	`mem£t
(
cmd
, 0, (*cmd));

1121 
cmd
->
commÚ
.
İcode
 = 
nvme_admš_async_ev’t
;

1122 
cmd
->
commÚ
.
commªd_id
 = 
NVME_RDMA_AQ_BLKMQ_DEPTH
;

1123 
cmd
->
commÚ
.
æags
 |ğ
NVME_CMD_SGL_METABUF
;

1124 
	`nvme_rdma_£t_sg_nuÎ
(
cmd
);

1126 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
, (*
cmd
),

1127 
DMA_TO_DEVICE
);

1129 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, &
sge
, 1, 
NULL
, 
çl£
);

1130 
	`WARN_ON_ONCE
(
»t
);

1131 
	}
}

1133 
	$nvme_rdma_´oûss_nvme_r¥
(
nvme_rdma_queue
 *
queue
,

1134 
nvme_com¶‘iÚ
 *
cqe
, 
ib_wc
 *
wc
, 
g
)

1136 
u16
 
¡©us
 = 
	`Ë16_to_ıu
(
cqe
->status);

1137 
»que¡
 *
rq
;

1138 
nvme_rdma_»que¡
 *
»q
;

1139 
»t
 = 0;

1141 
¡©us
 >>= 1;

1143 
rq
 = 
	`blk_mq_g_to_rq
(
	`nvme_rdma_g£t
(
queue
), 
cqe
->
commªd_id
);

1144 ià(!
rq
) {

1145 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1147 
cqe
->
commªd_id
, 
queue
->
qp
->
qp_num
);

1148 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1149  
»t
;

1151 
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1153 ià(
rq
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
 &&„q->
¥ecŸl
)

1154 
	`memıy
(
rq
->
¥ecŸl
, 
cqe
, (*cqe));

1156 ià(
rq
->
g
 ==ag)

1157 
»t
 = 1;

1159 ià((
wc
->
wc_æags
 & 
IB_WC_WITH_INVALIDATE
) &&

1160 
wc
->
ex
.
šv®id©e_rkey
 =ğ
»q
->
mr
->
rkey
)

1161 
»q
->
mr
->
Ãed_šv®
 = 
çl£
;

1163 
	`blk_mq_com¶‘e_»que¡
(
rq
, 
¡©us
);

1165  
»t
;

1166 
	}
}

1168 
	$__nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
, 
g
)

1170 
nvme_rdma_qe
 *
qe
 =

1171 
	`cÚš”_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1172 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_cÚ‹xt
;

1173 
ib_deviû
 *
ibdev
 = 
queue
->
deviû
->
dev
;

1174 
nvme_com¶‘iÚ
 *
cqe
 = 
qe
->
d©a
;

1175 cÚ¡ 
size_t
 
Ën
 = (
nvme_com¶‘iÚ
);

1176 
»t
 = 0;

1178 ià(
	`uÆik–y
(
wc
->
¡©us
 !ğ
IB_WC_SUCCESS
)) {

1179 
	`nvme_rdma_wr_”rÜ
(
cq
, 
wc
, "RECV");

1183 
	`ib_dma_sync_sšgË_fÜ_ıu
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1190 ià(
	`uÆik–y
(
	`nvme_rdma_queue_idx
(
queue
) == 0 &&

1191 
cqe
->
commªd_id
 >ğ
NVME_RDMA_AQ_BLKMQ_DEPTH
))

1192 
	`nvme_com¶‘e_async_ev’t
(&
queue
->
ù¾
->ù¾, 
cqe
);

1194 
»t
 = 
	`nvme_rdma_´oûss_nvme_r¥
(
queue
, 
cqe
, 
wc
, 
g
);

1195 
	`ib_dma_sync_sšgË_fÜ_deviû
(
ibdev
, 
qe
->
dma
, 
Ën
, 
DMA_FROM_DEVICE
);

1197 
	`nvme_rdma_po¡_»cv
(
queue
, 
qe
);

1198  
»t
;

1199 
	}
}

1201 
	$nvme_rdma_»cv_dÚe
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1203 
	`__nvme_rdma_»cv_dÚe
(
cq
, 
wc
, -1);

1204 
	}
}

1206 
	$nvme_rdma_cÚn_e¡ablished
(
nvme_rdma_queue
 *
queue
)

1208 
»t
, 
i
;

1210 
i
 = 0; i < 
queue
->
queue_size
; i++) {

1211 
»t
 = 
	`nvme_rdma_po¡_»cv
(
queue
, &queue->
r¥_ršg
[
i
]);

1212 ià(
»t
)

1213 
out_de¡roy_queue_ib
;

1218 
out_de¡roy_queue_ib
:

1219 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1220  
»t
;

1221 
	}
}

1223 
	$nvme_rdma_cÚn_»jeùed
(
nvme_rdma_queue
 *
queue
,

1224 
rdma_cm_ev’t
 *
ev
)

1226 ià(
ev
->
·¿m
.
cÚn
.
´iv©e_d©a_Ën
) {

1227 
nvme_rdma_cm_»j
 *
»j
 =

1228 (
nvme_rdma_cm_»j
 *)
ev
->
·¿m
.
cÚn
.
´iv©e_d©a
;

1230 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1231 "CÚÃù„ejeùed, stu %d.", 
	`Ë16_to_ıu
(
»j
->
¡s
));

1234 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1238  -
ECONNRESET
;

1239 
	}
}

1241 
	$nvme_rdma_addr_»sŞved
(
nvme_rdma_queue
 *
queue
)

1243 
nvme_rdma_deviû
 *
dev
;

1244 
»t
;

1246 
dev
 = 
	`nvme_rdma_fšd_g‘_deviû
(
queue
->
cm_id
);

1247 ià(!
dev
) {

1248 
	`dev_”r
(
queue
->
cm_id
->
deviû
->
dma_deviû
,

1250  -
ECONNREFUSED
;

1253 
»t
 = 
	`nvme_rdma_ü—‹_queue_ib
(
queue
, 
dev
);

1254 ià(
»t
) {

1255 
	`nvme_rdma_dev_put
(
dev
);

1256 
out
;

1259 
»t
 = 
	`rdma_»sŞve_rou‹
(
queue
->
cm_id
, 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

1260 ià(
»t
) {

1261 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1263 
queue
->
cm_”rÜ
);

1264 
out_de¡roy_queue
;

1269 
out_de¡roy_queue
:

1270 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1271 
out
:

1272  
»t
;

1273 
	}
}

1275 
	$nvme_rdma_rou‹_»sŞved
(
nvme_rdma_queue
 *
queue
)

1277 
nvme_rdma_ù¾
 *
ù¾
 = 
queue
->ctrl;

1278 
rdma_cÚn_·¿m
 
·¿m
 = { };

1279 
nvme_rdma_cm_»q
 
´iv
 = { };

1280 
»t
;

1282 
·¿m
.
qp_num
 = 
queue
->
qp
->qp_num;

1283 
·¿m
.
æow_cÚŒŞ
 = 1;

1285 
·¿m
.
»¥Úd”_»sourûs
 = 
queue
->
deviû
->
dev
->
©Œs
.
max_qp_rd_©om
;

1287 
·¿m
.
»Œy_couÁ
 = 7;

1288 
·¿m
.
ºr_»Œy_couÁ
 = 7;

1289 
·¿m
.
´iv©e_d©a
 = &
´iv
;

1290 
·¿m
.
´iv©e_d©a_Ën
 = (
´iv
);

1292 
´iv
.
»cfmt
 = 
	`ıu_to_Ë16
(
NVME_RDMA_CM_FMT_1_0
);

1293 
´iv
.
qid
 = 
	`ıu_to_Ë16
(
	`nvme_rdma_queue_idx
(
queue
));

1298 ià(
´iv
.
qid
 == 0) {

1299 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
NVMF_AQ_DEPTH
);

1300 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
NVMF_AQ_DEPTH
 - 1);

1307 
´iv
.
hrqsize
 = 
	`ıu_to_Ë16
(
queue
->
queue_size
);

1308 
´iv
.
hsqsize
 = 
	`ıu_to_Ë16
(
queue
->
ù¾
->ù¾.
sqsize
);

1311 
»t
 = 
	`rdma_cÚÃù
(
queue
->
cm_id
, &
·¿m
);

1312 ià(
»t
) {

1313 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1314 "rdma_cÚÃù faed (%d).\n", 
»t
);

1315 
out_de¡roy_queue_ib
;

1320 
out_de¡roy_queue_ib
:

1321 
	`nvme_rdma_de¡roy_queue_ib
(
queue
);

1322  
»t
;

1323 
	}
}

1325 
	$nvme_rdma_cm_hªdËr
(
rdma_cm_id
 *
cm_id
,

1326 
rdma_cm_ev’t
 *
ev
)

1328 
nvme_rdma_queue
 *
queue
 = 
cm_id
->
cÚ‹xt
;

1329 
cm_”rÜ
 = 0;

1331 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
, "%s (%d): status %d id %p\n",

1332 
	`rdma_ev’t_msg
(
ev
->
ev’t
),ƒv->event,

1333 
ev
->
¡©us
, 
cm_id
);

1335 
ev
->
ev’t
) {

1336 
RDMA_CM_EVENT_ADDR_RESOLVED
:

1337 
cm_”rÜ
 = 
	`nvme_rdma_addr_»sŞved
(
queue
);

1339 
RDMA_CM_EVENT_ROUTE_RESOLVED
:

1340 
cm_”rÜ
 = 
	`nvme_rdma_rou‹_»sŞved
(
queue
);

1342 
RDMA_CM_EVENT_ESTABLISHED
:

1343 
queue
->
cm_”rÜ
 = 
	`nvme_rdma_cÚn_e¡ablished
(queue);

1345 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1347 
RDMA_CM_EVENT_REJECTED
:

1348 
cm_”rÜ
 = 
	`nvme_rdma_cÚn_»jeùed
(
queue
, 
ev
);

1350 
RDMA_CM_EVENT_ADDR_ERROR
:

1351 
RDMA_CM_EVENT_ROUTE_ERROR
:

1352 
RDMA_CM_EVENT_CONNECT_ERROR
:

1353 
RDMA_CM_EVENT_UNREACHABLE
:

1354 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1355 "CMƒ¼Üƒv’ˆ%d\n", 
ev
->
ev’t
);

1356 
cm_”rÜ
 = -
ECONNRESET
;

1358 
RDMA_CM_EVENT_DISCONNECTED
:

1359 
RDMA_CM_EVENT_ADDR_CHANGE
:

1360 
RDMA_CM_EVENT_TIMEWAIT_EXIT
:

1361 
	`dev_dbg
(
queue
->
ù¾
->ù¾.
deviû
,

1363 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1365 
RDMA_CM_EVENT_DEVICE_REMOVAL
:

1369 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1370 "UÃx³ùed RDMA CMƒv’ˆ(%d)\n", 
ev
->
ev’t
);

1371 
	`nvme_rdma_”rÜ_»cov”y
(
queue
->
ù¾
);

1375 ià(
cm_”rÜ
) {

1376 
queue
->
cm_”rÜ
 = cm_error;

1377 
	`com¶‘e
(&
queue
->
cm_dÚe
);

1381 
	}
}

1383 
blk_eh_tim”_»tuº


1384 
	$nvme_rdma_timeout
(
»que¡
 *
rq
, 
boŞ
 
»£rved
)

1386 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1389 
	`nvme_rdma_”rÜ_»cov”y
(
»q
->
queue
->
ù¾
);

1392 
rq
->
”rÜs
 = 
NVME_SC_ABORT_REQ
 | 
NVME_SC_DNR
;

1394  
BLK_EH_HANDLED
;

1395 
	}
}

1400 
šlše
 
boŞ
 
	$nvme_rdma_queue_is_»ady
(
nvme_rdma_queue
 *
queue
,

1401 
»que¡
 *
rq
)

1403 ià(
	`uÆik–y
(!
	`‹¡_b™
(
NVME_RDMA_Q_LIVE
, &
queue
->
æags
))) {

1404 
nvme_commªd
 *
cmd
 = (nvme_commªd *)
rq
->cmd;

1406 ià(
rq
->
cmd_ty³
 !ğ
REQ_TYPE_DRV_PRIV
 ||

1407 
cmd
->
commÚ
.
İcode
 !ğ
nvme_çbrics_commªd
 ||

1408 
cmd
->
çbrics
.
fùy³
 !ğ
nvme_çbrics_ty³_cÚÃù
)

1409  
çl£
;

1412  
Œue
;

1413 
	}
}

1415 
	$nvme_rdma_queue_rq
(
blk_mq_hw_ùx
 *
hùx
,

1416 cÚ¡ 
blk_mq_queue_d©a
 *
bd
)

1418 
nvme_ns
 *
ns
 = 
hùx
->
queue
->
queued©a
;

1419 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1420 
»que¡
 *
rq
 = 
bd
->rq;

1421 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1422 
nvme_rdma_qe
 *
sqe
 = &
»q
->sqe;

1423 
nvme_commªd
 *
c
 = 
sqe
->
d©a
;

1424 
boŞ
 
æush
 = 
çl£
;

1425 
ib_deviû
 *
dev
;

1426 
m­_Ën
;

1427 
»t
;

1429 
	`WARN_ON_ONCE
(
rq
->
g
 < 0);

1431 ià(!
	`nvme_rdma_queue_is_»ady
(
queue
, 
rq
))

1432  
BLK_MQ_RQ_QUEUE_BUSY
;

1434 
dev
 = 
queue
->
deviû
->dev;

1435 
	`ib_dma_sync_sšgË_fÜ_ıu
(
dev
, 
sqe
->
dma
,

1436 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1438 
»t
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
c
);

1439 ià(
»t
)

1440  
»t
;

1442 
c
->
commÚ
.
commªd_id
 = 
rq
->
g
;

1443 
	`blk_mq_¡¬t_»que¡
(
rq
);

1445 
m­_Ën
 = 
	`nvme_m­_Ën
(
rq
);

1446 
»t
 = 
	`nvme_rdma_m­_d©a
(
queue
, 
rq
, 
m­_Ën
, 
c
);

1447 ià(
»t
 < 0) {

1448 
	`dev_”r
(
queue
->
ù¾
->ù¾.
deviû
,

1449 "FaedØm­ d©¨(%d)\n", 
»t
);

1450 
	`nvme_ş—nup_cmd
(
rq
);

1451 
”r
;

1454 
	`ib_dma_sync_sšgË_fÜ_deviû
(
dev
, 
sqe
->
dma
,

1455 (
nvme_commªd
), 
DMA_TO_DEVICE
);

1457 ià(
rq
->
cmd_ty³
 =ğ
REQ_TYPE_FS
 && 
	`»q_İ
Ôqè=ğ
REQ_OP_FLUSH
)

1458 
æush
 = 
Œue
;

1459 
»t
 = 
	`nvme_rdma_po¡_£nd
(
queue
, 
sqe
, 
»q
->
sge
,„eq->
num_sge
,

1460 
»q
->
mr
->
Ãed_šv®
 ? &»q->
»g_wr
.
wr
 : 
NULL
, 
æush
);

1461 ià(
»t
) {

1462 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1463 
”r
;

1466  
BLK_MQ_RQ_QUEUE_OK
;

1467 
”r
:

1468  (
»t
 =ğ-
ENOMEM
 ||„‘ =ğ-
EAGAIN
) ?

1469 
BLK_MQ_RQ_QUEUE_BUSY
 : 
BLK_MQ_RQ_QUEUE_ERROR
;

1470 
	}
}

1472 
	$nvme_rdma_pŞl
(
blk_mq_hw_ùx
 *
hùx
, 
g
)

1474 
nvme_rdma_queue
 *
queue
 = 
hùx
->
driv”_d©a
;

1475 
ib_cq
 *
cq
 = 
queue
->ib_cq;

1476 
ib_wc
 
wc
;

1477 
found
 = 0;

1479 
	`ib_»q_nÙify_cq
(
cq
, 
IB_CQ_NEXT_COMP
);

1480 
	`ib_pŞl_cq
(
cq
, 1, &
wc
) > 0) {

1481 
ib_cqe
 *
cqe
 = 
wc
.
wr_cqe
;

1483 ià(
cqe
) {

1484 ià(
cqe
->
dÚe
 =ğ
nvme_rdma_»cv_dÚe
)

1485 
found
 |ğ
	`__nvme_rdma_»cv_dÚe
(
cq
, &
wc
, 
g
);

1487 
cqe
->
	`dÚe
(
cq
, &
wc
);

1491  
found
;

1492 
	}
}

1494 
	$nvme_rdma_com¶‘e_rq
(
»que¡
 *
rq
)

1496 
nvme_rdma_»que¡
 *
»q
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1497 
nvme_rdma_queue
 *
queue
 = 
»q
->queue;

1498 
”rÜ
 = 0;

1500 
	`nvme_rdma_unm­_d©a
(
queue
, 
rq
);

1502 ià(
	`uÆik–y
(
rq
->
”rÜs
)) {

1503 ià(
	`nvme_»q_Ãeds_»Œy
(
rq
,„q->
”rÜs
)) {

1504 
	`nvme_»queue_»q
(
rq
);

1508 ià(
rq
->
cmd_ty³
 =ğ
REQ_TYPE_DRV_PRIV
)

1509 
”rÜ
 = 
rq
->
”rÜs
;

1511 
”rÜ
 = 
	`nvme_”rÜ_¡©us
(
rq
->
”rÜs
);

1514 
	`blk_mq_’d_»que¡
(
rq
, 
”rÜ
);

1515 
	}
}

1517 
blk_mq_İs
 
	gnvme_rdma_mq_İs
 = {

1518 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1519 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1520 .
	gš™_»que¡
 = 
nvme_rdma_š™_»que¡
,

1521 .
	gex™_»que¡
 = 
nvme_rdma_ex™_»que¡
,

1522 .
	g»š™_»que¡
 = 
nvme_rdma_»š™_»que¡
,

1523 .
	gš™_hùx
 = 
nvme_rdma_š™_hùx
,

1524 .
	gpŞl
 = 
nvme_rdma_pŞl
,

1525 .
	gtimeout
 = 
nvme_rdma_timeout
,

1528 
blk_mq_İs
 
	gnvme_rdma_admš_mq_İs
 = {

1529 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1530 .
	gcom¶‘e
 = 
nvme_rdma_com¶‘e_rq
,

1531 .
	gš™_»que¡
 = 
nvme_rdma_š™_admš_»que¡
,

1532 .
	gex™_»que¡
 = 
nvme_rdma_ex™_admš_»que¡
,

1533 .
	g»š™_»que¡
 = 
nvme_rdma_»š™_»que¡
,

1534 .
	gš™_hùx
 = 
nvme_rdma_š™_admš_hùx
,

1535 .
	gtimeout
 = 
nvme_rdma_timeout
,

1538 
	$nvme_rdma_cÚfigu»_admš_queue
(
nvme_rdma_ù¾
 *
ù¾
)

1540 
”rÜ
;

1542 
”rÜ
 = 
	`nvme_rdma_š™_queue
(
ù¾
, 0, 
NVMF_AQ_DEPTH
);

1543 ià(
”rÜ
)

1544  
”rÜ
;

1546 
ù¾
->
deviû
 = cŒl->
queues
[0].device;

1552 
”rÜ
 = -
EINVAL
;

1553 ià(!
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
))

1554 
out_ä“_queue
;

1556 
ù¾
->
max_ä_·ges
 = 
	`mš_t
(
u32
, 
NVME_RDMA_MAX_SEGMENTS
,

1557 
ù¾
->
deviû
->
dev
->
©Œs
.
max_ç¡_»g_·ge_li¡_Ën
);

1559 
	`mem£t
(&
ù¾
->
admš_g_£t
, 0, (ctrl->admin_tag_set));

1560 
ù¾
->
admš_g_£t
.
İs
 = &
nvme_rdma_admš_mq_İs
;

1561 
ù¾
->
admš_g_£t
.
queue_d•th
 = 
NVME_RDMA_AQ_BLKMQ_DEPTH
;

1562 
ù¾
->
admš_g_£t
.
»£rved_gs
 = 2;

1563 
ù¾
->
admš_g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1564 
ù¾
->
admš_g_£t
.
cmd_size
 = (
nvme_rdma_»que¡
) +

1565 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

1566 
ù¾
->
admš_g_£t
.
driv”_d©a
 = ctrl;

1567 
ù¾
->
admš_g_£t
.
Ä_hw_queues
 = 1;

1568 
ù¾
->
admš_g_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1570 
”rÜ
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
admš_g_£t
);

1571 ià(
”rÜ
)

1572 
out_put_dev
;

1574 
ù¾
->ù¾.
admš_q
 = 
	`blk_mq_š™_queue
(&ù¾->
admš_g_£t
);

1575 ià(
	`IS_ERR
(
ù¾
->ù¾.
admš_q
)) {

1576 
”rÜ
 = 
	`PTR_ERR
(
ù¾
->ù¾.
admš_q
);

1577 
out_ä“_g£t
;

1580 
”rÜ
 = 
	`nvmf_cÚÃù_admš_queue
(&
ù¾
->ctrl);

1581 ià(
”rÜ
)

1582 
out_ş—nup_queue
;

1584 
	`£t_b™
(
NVME_RDMA_Q_LIVE
, &
ù¾
->
queues
[0].
æags
);

1586 
”rÜ
 = 
	`nvmf_»g_»ad64
(&
ù¾
->ù¾, 
NVME_REG_CAP
, &ù¾->
ÿp
);

1587 ià(
”rÜ
) {

1588 
	`dev_”r
(
ù¾
->ù¾.
deviû
,

1590 
out_ş—nup_queue
;

1593 
ù¾
->ù¾.
sqsize
 =

1594 
	`mš_t
(, 
	`NVME_CAP_MQES
(
ù¾
->
ÿp
è+ 1, cŒl->ù¾.
sqsize
);

1596 
”rÜ
 = 
	`nvme_’abË_ù¾
(&
ù¾
->ù¾, cŒl->
ÿp
);

1597 ià(
”rÜ
)

1598 
out_ş—nup_queue
;

1600 
ù¾
->ù¾.
max_hw_£ùÜs
 =

1601 (
ù¾
->
max_ä_·ges
 - 1è<< (
PAGE_SHIFT
 - 9);

1603 
”rÜ
 = 
	`nvme_š™_id’tify
(&
ù¾
->ctrl);

1604 ià(
”rÜ
)

1605 
out_ş—nup_queue
;

1607 
”rÜ
 = 
	`nvme_rdma_®loc_qe
(
ù¾
->
queues
[0].
deviû
->
dev
,

1608 &
ù¾
->
async_ev’t_sqe
, (
nvme_commªd
),

1609 
DMA_TO_DEVICE
);

1610 ià(
”rÜ
)

1611 
out_ş—nup_queue
;

1613 
	`nvme_¡¬t_k“p_®ive
(&
ù¾
->ctrl);

1617 
out_ş—nup_queue
:

1618 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
admš_q
);

1619 
out_ä“_g£t
:

1621 
	`nvme_rdma_¡İ_queue
(&
ù¾
->
queues
[0]);

1622 
	`blk_mq_ä“_g_£t
(&
ù¾
->
admš_g_£t
);

1623 
out_put_dev
:

1624 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1625 
out_ä“_queue
:

1626 
	`nvme_rdma_ä“_queue
(&
ù¾
->
queues
[0]);

1627  
”rÜ
;

1628 
	}
}

1630 
	$nvme_rdma_shutdown_ù¾
(
nvme_rdma_ù¾
 *
ù¾
)

1632 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

1633 
	`ÿnûl_wÜk_sync
(&
ù¾
->
”r_wÜk
);

1634 
	`ÿnûl_d–ayed_wÜk_sync
(&
ù¾
->
»cÚÃù_wÜk
);

1636 ià(
ù¾
->
queue_couÁ
 > 1) {

1637 
	`nvme_¡İ_queues
(&
ù¾
->ctrl);

1638 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
g_£t
,

1639 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1640 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

1643 ià(
	`‹¡_b™
(
NVME_RDMA_Q_CONNECTED
, &
ù¾
->
queues
[0].
æags
))

1644 
	`nvme_shutdown_ù¾
(&
ù¾
->ctrl);

1646 
	`blk_mq_¡İ_hw_queues
(
ù¾
->ù¾.
admš_q
);

1647 
	`blk_mq_g£t_busy_™”
(&
ù¾
->
admš_g_£t
,

1648 
nvme_ÿnûl_»que¡
, &
ù¾
->ctrl);

1649 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
);

1650 
	}
}

1652 
	$__nvme_rdma_»move_ù¾
(
nvme_rdma_ù¾
 *
ù¾
, 
boŞ
 
shutdown
)

1654 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1655 ià(
shutdown
)

1656 
	`nvme_rdma_shutdown_ù¾
(
ù¾
);

1658 ià(
ù¾
->ù¾.
g£t
) {

1659 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1660 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1661 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1664 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1665 
	}
}

1667 
	$nvme_rdma_d–_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1669 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1670 
nvme_rdma_ù¾
, 
d–‘e_wÜk
);

1672 
	`__nvme_rdma_»move_ù¾
(
ù¾
, 
Œue
);

1673 
	}
}

1675 
	$__nvme_rdma_d–_ù¾
(
nvme_rdma_ù¾
 *
ù¾
)

1677 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_DELETING
))

1678  -
EBUSY
;

1680 ià(!
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
d–‘e_wÜk
))

1681  -
EBUSY
;

1684 
	}
}

1686 
	$nvme_rdma_d–_ù¾
(
nvme_ù¾
 *
nù¾
)

1688 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

1689 
»t
 = 0;

1695 ià(!
	`k»f_g‘_uÆess_z”o
(&
ù¾
->ù¾.
k»f
))

1696  -
EBUSY
;

1697 
»t
 = 
	`__nvme_rdma_d–_ù¾
(
ù¾
);

1698 ià(!
»t
)

1699 
	`æush_wÜk
(&
ù¾
->
d–‘e_wÜk
);

1700 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1701  
»t
;

1702 
	}
}

1704 
	$nvme_rdma_»move_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1706 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1707 
nvme_rdma_ù¾
, 
d–‘e_wÜk
);

1709 
	`__nvme_rdma_»move_ù¾
(
ù¾
, 
çl£
);

1710 
	}
}

1712 
	$nvme_rdma_»£t_ù¾_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1714 
nvme_rdma_ù¾
 *
ù¾
 = 
	`cÚš”_of
(
wÜk
,

1715 
nvme_rdma_ù¾
, 
»£t_wÜk
);

1716 
»t
;

1717 
boŞ
 
chªged
;

1719 
	`nvme_rdma_shutdown_ù¾
(
ù¾
);

1721 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
);

1722 ià(
»t
) {

1724 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_rdma_»move_ù¾_wÜk
);

1725 
d–_d—d_ù¾
;

1728 ià(
ù¾
->
queue_couÁ
 > 1) {

1729 
»t
 = 
	`blk_mq_»š™_g£t
(&
ù¾
->
g_£t
);

1730 ià(
»t
)

1731 
d–_d—d_ù¾
;

1733 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

1734 ià(
»t
)

1735 
d–_d—d_ù¾
;

1737 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

1738 ià(
»t
)

1739 
d–_d—d_ù¾
;

1742 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1743 
	`WARN_ON_ONCE
(!
chªged
);

1745 ià(
ù¾
->
queue_couÁ
 > 1) {

1746 
	`nvme_¡¬t_queues
(&
ù¾
->ctrl);

1747 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

1748 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

1753 
d–_d—d_ù¾
:

1755 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
, "Removing‡fter„eset failure\n");

1756 
	`WARN_ON
(!
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
d–‘e_wÜk
));

1757 
	}
}

1759 
	$nvme_rdma_»£t_ù¾
(
nvme_ù¾
 *
nù¾
)

1761 
nvme_rdma_ù¾
 *
ù¾
 = 
	`to_rdma_ù¾
(
nù¾
);

1763 ià(!
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_RESETTING
))

1764  -
EBUSY
;

1766 ià(!
	`queue_wÜk
(
nvme_rdma_wq
, &
ù¾
->
»£t_wÜk
))

1767  -
EBUSY
;

1769 
	`æush_wÜk
(&
ù¾
->
»£t_wÜk
);

1772 
	}
}

1774 cÚ¡ 
nvme_ù¾_İs
 
	gnvme_rdma_ù¾_İs
 = {

1775 .
Çme
 = "rdma",

1776 .
	gmoduË
 = 
THIS_MODULE
,

1777 .
	gis_çbrics
 = 
Œue
,

1778 .
	g»g_»ad32
 = 
nvmf_»g_»ad32
,

1779 .
	g»g_»ad64
 = 
nvmf_»g_»ad64
,

1780 .
	g»g_wr™e32
 = 
nvmf_»g_wr™e32
,

1781 .
	g»£t_ù¾
 = 
nvme_rdma_»£t_ù¾
,

1782 .
	gä“_ù¾
 = 
nvme_rdma_ä“_ù¾
,

1783 .
	gsubm™_async_ev’t
 = 
nvme_rdma_subm™_async_ev’t
,

1784 .
	gd–‘e_ù¾
 = 
nvme_rdma_d–_ù¾
,

1785 .
	gg‘_subsy¢qn
 = 
nvmf_g‘_subsy¢qn
,

1786 .
	gg‘_add»ss
 = 
nvmf_g‘_add»ss
,

1789 
	$nvme_rdma_ü—‹_io_queues
(
nvme_rdma_ù¾
 *
ù¾
)

1791 
nvmf_ù¾_İtiÚs
 *
İts
 = 
ù¾
->ctrl.opts;

1792 
»t
;

1794 
»t
 = 
	`nvme_£t_queue_couÁ
(&
ù¾
->ù¾, &
İts
->
Ä_io_queues
);

1795 ià(
»t
)

1796  
»t
;

1798 
ù¾
->
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

1799 ià(
ù¾
->
queue_couÁ
 < 2)

1802 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

1803 "ü—tšg %d I/O queues.\n", 
İts
->
Ä_io_queues
);

1805 
»t
 = 
	`nvme_rdma_š™_io_queues
(
ù¾
);

1806 ià(
»t
)

1807  
»t
;

1813 
»t
 = -
EINVAL
;

1814 ià(!
	`nvme_rdma_dev_g‘
(
ù¾
->
deviû
))

1815 
out_ä“_io_queues
;

1817 
	`mem£t
(&
ù¾
->
g_£t
, 0, (ctrl->tag_set));

1818 
ù¾
->
g_£t
.
İs
 = &
nvme_rdma_mq_İs
;

1819 
ù¾
->
g_£t
.
queue_d•th
 = cŒl->ù¾.
İts
->
queue_size
;

1820 
ù¾
->
g_£t
.
»£rved_gs
 = 1;

1821 
ù¾
->
g_£t
.
numa_node
 = 
NUMA_NO_NODE
;

1822 
ù¾
->
g_£t
.
æags
 = 
BLK_MQ_F_SHOULD_MERGE
;

1823 
ù¾
->
g_£t
.
cmd_size
 = (
nvme_rdma_»que¡
) +

1824 
SG_CHUNK_SIZE
 * (
sÿ‰”li¡
);

1825 
ù¾
->
g_£t
.
driv”_d©a
 = ctrl;

1826 
ù¾
->
g_£t
.
Ä_hw_queues
 = cŒl->
queue_couÁ
 - 1;

1827 
ù¾
->
g_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

1829 
»t
 = 
	`blk_mq_®loc_g_£t
(&
ù¾
->
g_£t
);

1830 ià(
»t
)

1831 
out_put_dev
;

1832 
ù¾
->ù¾.
g£t
 = &ù¾->
g_£t
;

1834 
ù¾
->ù¾.
cÚÃù_q
 = 
	`blk_mq_š™_queue
(&ù¾->
g_£t
);

1835 ià(
	`IS_ERR
(
ù¾
->ù¾.
cÚÃù_q
)) {

1836 
»t
 = 
	`PTR_ERR
(
ù¾
->ù¾.
cÚÃù_q
);

1837 
out_ä“_g_£t
;

1840 
»t
 = 
	`nvme_rdma_cÚÃù_io_queues
(
ù¾
);

1841 ià(
»t
)

1842 
out_ş—nup_cÚÃù_q
;

1846 
out_ş—nup_cÚÃù_q
:

1847 
	`blk_ş—nup_queue
(
ù¾
->ù¾.
cÚÃù_q
);

1848 
out_ä“_g_£t
:

1849 
	`blk_mq_ä“_g_£t
(&
ù¾
->
g_£t
);

1850 
out_put_dev
:

1851 
	`nvme_rdma_dev_put
(
ù¾
->
deviû
);

1852 
out_ä“_io_queues
:

1853 
	`nvme_rdma_ä“_io_queues
(
ù¾
);

1854  
»t
;

1855 
	}
}

1857 
	$nvme_rdma_·r£_addr
(
sockaddr_š
 *
š_addr
, *
p
)

1859 
u8
 *
addr
 = (u8 *)&
š_addr
->
sš_addr
.
s_addr
;

1860 
size_t
 
buæ’
 = 
	`¡¾’
(
p
);

1864 ià(
buæ’
 > 
INET_ADDRSTRLEN
)

1865  -
EINVAL
;

1866 ià(
	`š4_±Ú
(
p
, 
buæ’
, 
addr
, '\0', 
NULL
) == 0)

1867  -
EINVAL
;

1868 
š_addr
->
sš_çmy
 = 
AF_INET
;

1870 
	}
}

1872 
nvme_ù¾
 *
	$nvme_rdma_ü—‹_ù¾
(
deviû
 *
dev
,

1873 
nvmf_ù¾_İtiÚs
 *
İts
)

1875 
nvme_rdma_ù¾
 *
ù¾
;

1876 
»t
;

1877 
boŞ
 
chªged
;

1879 
ù¾
 = 
	`kz®loc
((*ù¾), 
GFP_KERNEL
);

1880 ià(!
ù¾
)

1881  
	`ERR_PTR
(-
ENOMEM
);

1882 
ù¾
->ù¾.
İts
 = opts;

1883 
	`INIT_LIST_HEAD
(&
ù¾
->
li¡
);

1885 
»t
 = 
	`nvme_rdma_·r£_addr
(&
ù¾
->
addr_š
, 
İts
->
Œaddr
);

1886 ià(
»t
) {

1887 
	`´_”r
("m®fÜmed IP‡dd»s ·s£d: %s\n", 
İts
->
Œaddr
);

1888 
out_ä“_ù¾
;

1891 ià(
İts
->
mask
 & 
NVMF_OPT_TRSVCID
) {

1892 
u16
 
pÜt
;

1894 
»t
 = 
	`k¡¹ou16
(
İts
->
Œsvcid
, 0, &
pÜt
);

1895 ià(
»t
)

1896 
out_ä“_ù¾
;

1898 
ù¾
->
addr_š
.
sš_pÜt
 = 
	`ıu_to_be16
(
pÜt
);

1900 
ù¾
->
addr_š
.
sš_pÜt
 = 
	`ıu_to_be16
(
NVME_RDMA_IP_PORT
);

1903 
»t
 = 
	`nvme_š™_ù¾
(&
ù¾
->ù¾, 
dev
, &
nvme_rdma_ù¾_İs
,

1905 ià(
»t
)

1906 
out_ä“_ù¾
;

1908 
ù¾
->
»cÚÃù_d–ay
 = 
İts
->reconnect_delay;

1909 
	`INIT_DELAYED_WORK
(&
ù¾
->
»cÚÃù_wÜk
,

1910 
nvme_rdma_»cÚÃù_ù¾_wÜk
);

1911 
	`INIT_WORK
(&
ù¾
->
”r_wÜk
, 
nvme_rdma_”rÜ_»cov”y_wÜk
);

1912 
	`INIT_WORK
(&
ù¾
->
d–‘e_wÜk
, 
nvme_rdma_d–_ù¾_wÜk
);

1913 
	`INIT_WORK
(&
ù¾
->
»£t_wÜk
, 
nvme_rdma_»£t_ù¾_wÜk
);

1914 
	`¥š_lock_š™
(&
ù¾
->
lock
);

1916 
ù¾
->
queue_couÁ
 = 
İts
->
Ä_io_queues
 + 1;

1917 
ù¾
->ù¾.
sqsize
 = 
İts
->
queue_size
 - 1;

1918 
ù¾
->ù¾.
k©o
 = 
İts
->kato;

1920 
»t
 = -
ENOMEM
;

1921 
ù¾
->
queues
 = 
	`kÿÎoc
(ù¾->
queue_couÁ
, (*ctrl->queues),

1922 
GFP_KERNEL
);

1923 ià(!
ù¾
->
queues
)

1924 
out_unš™_ù¾
;

1926 
»t
 = 
	`nvme_rdma_cÚfigu»_admš_queue
(
ù¾
);

1927 ià(
»t
)

1928 
out_kä“_queues
;

1931 ià(
ù¾
->ù¾.
icdoff
) {

1932 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "icdoff is‚ot supported!\n");

1933 
out_»move_admš_queue
;

1937 ià(!(
ù¾
->ù¾.
sgls
 & (1 << 20))) {

1938 
	`dev_”r
(
ù¾
->ù¾.
deviû
, "Mandatory keyed sgls‡re‚ot support\n");

1939 
out_»move_admš_queue
;

1942 ià(
İts
->
queue_size
 > 
ù¾
->ù¾.
maxcmd
) {

1944 
	`dev_w¬n
(
ù¾
->ù¾.
deviû
,

1946 
İts
->
queue_size
, 
ù¾
->ù¾.
maxcmd
);

1947 
İts
->
queue_size
 = 
ù¾
->ù¾.
maxcmd
;

1950 ià(
İts
->
Ä_io_queues
) {

1951 
»t
 = 
	`nvme_rdma_ü—‹_io_queues
(
ù¾
);

1952 ià(
»t
)

1953 
out_»move_admš_queue
;

1956 
chªged
 = 
	`nvme_chªge_ù¾_¡©e
(&
ù¾
->ù¾, 
NVME_CTRL_LIVE
);

1957 
	`WARN_ON_ONCE
(!
chªged
);

1959 
	`dev_šfo
(
ù¾
->ù¾.
deviû
, "new ctrl: NQN \"%s\",‡ddr %pISp\n",

1960 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

1962 
	`k»f_g‘
(&
ù¾
->ù¾.
k»f
);

1964 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

1965 
	`li¡_add_
(&
ù¾
->
li¡
, &
nvme_rdma_ù¾_li¡
);

1966 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

1968 ià(
İts
->
Ä_io_queues
) {

1969 
	`nvme_queue_sÿn
(&
ù¾
->ctrl);

1970 
	`nvme_queue_async_ev’ts
(&
ù¾
->ctrl);

1973  &
ù¾
->ctrl;

1975 
out_»move_admš_queue
:

1976 
	`nvme_¡İ_k“p_®ive
(&
ù¾
->ctrl);

1977 
	`nvme_rdma_de¡roy_admš_queue
(
ù¾
);

1978 
out_kä“_queues
:

1979 
	`kä“
(
ù¾
->
queues
);

1980 
out_unš™_ù¾
:

1981 
	`nvme_unš™_ù¾
(&
ù¾
->ctrl);

1982 
	`nvme_put_ù¾
(&
ù¾
->ctrl);

1983 ià(
»t
 > 0)

1984 
»t
 = -
EIO
;

1985  
	`ERR_PTR
(
»t
);

1986 
out_ä“_ù¾
:

1987 
	`kä“
(
ù¾
);

1988  
	`ERR_PTR
(
»t
);

1989 
	}
}

1991 
nvmf_Œª¥Üt_İs
 
	gnvme_rdma_Œª¥Üt
 = {

1992 .
Çme
 = "rdma",

1993 .
	g»quœed_İts
 = 
NVMF_OPT_TRADDR
,

1994 .
	g®lowed_İts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
,

1995 .
	gü—‹_ù¾
 = 
nvme_rdma_ü—‹_ù¾
,

1998 
	$nvme_rdma_add_Úe
(
ib_deviû
 *ib_device)

2000 
	}
}

2002 
	$nvme_rdma_»move_Úe
(
ib_deviû
 *ib_deviû, *
ş›Á_d©a
)

2004 
nvme_rdma_ù¾
 *
ù¾
;

2007 
	`mu‹x_lock
(&
nvme_rdma_ù¾_mu‹x
);

2008 
	`li¡_fÜ_—ch_’Œy
(
ù¾
, &
nvme_rdma_ù¾_li¡
, 
li¡
) {

2009 ià(
ù¾
->
deviû
->
dev
 !ğ
ib_deviû
)

2011 
	`dev_šfo
(
ù¾
->ù¾.
deviû
,

2013 
ù¾
->ù¾.
İts
->
subsy¢qn
, &ù¾->
addr
);

2014 
	`__nvme_rdma_d–_ù¾
(
ù¾
);

2016 
	`mu‹x_uÆock
(&
nvme_rdma_ù¾_mu‹x
);

2018 
	`æush_wÜkqueue
(
nvme_rdma_wq
);

2019 
	}
}

2021 
ib_ş›Á
 
	gnvme_rdma_ib_ş›Á
 = {

2022 .
Çme
 = "nvme_rdma",

2023 .
	gadd
 = 
nvme_rdma_add_Úe
,

2024 .
	g»move
 = 
nvme_rdma_»move_Úe


2027 
__š™
 
	$nvme_rdma_š™_moduË
()

2029 
»t
;

2031 
nvme_rdma_wq
 = 
	`ü—‹_wÜkqueue
("nvme_rdma_wq");

2032 ià(!
nvme_rdma_wq
)

2033  -
ENOMEM
;

2035 
»t
 = 
	`ib_»gi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2036 ià(
»t
) {

2037 
	`de¡roy_wÜkqueue
(
nvme_rdma_wq
);

2038  
»t
;

2041 
	`nvmf_»gi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2043 
	}
}

2045 
__ex™
 
	$nvme_rdma_ş—nup_moduË
()

2047 
	`nvmf_uÄegi¡”_Œª¥Üt
(&
nvme_rdma_Œª¥Üt
);

2048 
	`ib_uÄegi¡”_ş›Á
(&
nvme_rdma_ib_ş›Á
);

2049 
	`de¡roy_wÜkqueue
(
nvme_rdma_wq
);

2050 
	}
}

2052 
moduË_š™
(
nvme_rdma_š™_moduË
);

2053 
moduË_ex™
(
nvme_rdma_ş—nup_moduË
);

2055 
MODULE_LICENSE
("GPL v2");

	@PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/scsi.c

20 
	~<lšux/bio.h
>

21 
	~<lšux/b™İs.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/com·t.h
>

24 
	~<lšux/d–ay.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/g’hd.h
>

28 
	~<lšux/idr.h
>

29 
	~<lšux/š™.h
>

30 
	~<lšux/š‹¼u±.h
>

31 
	~<lšux/io.h
>

32 
	~<lšux/kdev_t.h
>

33 
	~<lšux/kth»ad.h
>

34 
	~<lšux/k”Ãl.h
>

35 
	~<lšux/mm.h
>

36 
	~<lšux/moduË.h
>

37 
	~<lšux/moduË·¿m.h
>

38 
	~<lšux/pci.h
>

39 
	~<lšux/poisÚ.h
>

40 
	~<lšux/sched.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/ty³s.h
>

43 
	~<asm/uÇligÃd.h
>

44 
	~<scsi/sg.h
>

45 
	~<scsi/scsi.h
>

47 
	~"nvme.h
"

49 
	gsg_v”siÚ_num
 = 30534;

52 
	#VPD_SUPPORTED_PAGES
 0x00

	)

53 
	#VPD_SERIAL_NUMBER
 0x80

	)

54 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

55 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

56 
	#VPD_BLOCK_LIMITS
 0xB0

	)

57 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

60 
	#FORMAT_UNIT_SHORT_PARM_LIST_LEN
 4

	)

61 
	#FORMAT_UNIT_LONG_PARM_LIST_LEN
 8

	)

62 
	#FORMAT_UNIT_PROT_INT_OFFSET
 3

	)

63 
	#FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
 0

	)

64 
	#FORMAT_UNIT_PROT_FIELD_USAGE_MASK
 0x07

	)

67 
	#FIXED_SENSE_DATA
 0x70

	)

68 
	#DESC_FORMAT_SENSE_DATA
 0x72

	)

69 
	#FIXED_SENSE_DATA_ADD_LENGTH
 10

	)

70 
	#LUN_ENTRY_SIZE
 8

	)

71 
	#LUN_DATA_HEADER_SIZE
 8

	)

72 
	#ALL_LUNS_RETURNED
 0x02

	)

73 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

74 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

75 
	#DOWNLOAD_SAVE_ACTIVATE
 0x05

	)

76 
	#DOWNLOAD_SAVE_DEFER_ACTIVATE
 0x0E

	)

77 
	#ACTIVATE_DEFERRED_MICROCODE
 0x0F

	)

78 
	#FORMAT_UNIT_IMMED_MASK
 0x2

	)

79 
	#FORMAT_UNIT_IMMED_OFFSET
 1

	)

80 
	#KELVIN_TEMP_FACTOR
 273

	)

81 
	#FIXED_FMT_SENSE_DATA_SIZE
 18

	)

82 
	#DESC_FMT_SENSE_DATA_SIZE
 8

	)

85 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

86 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

87 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

88 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

89 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

90 
	#INQ_BDEV_LIMITS_PAGE
 0xB0

	)

91 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

92 
	#INQ_SERIAL_NUMBER_LENGTH
 0x14

	)

93 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 6

	)

94 
	#VERSION_SPC_4
 0x06

	)

95 
	#ACA_UNSUPPORTED
 0

	)

96 
	#STANDARD_INQUIRY_LENGTH
 36

	)

97 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

98 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

99 
	#RESERVED_FIELD
 0

	)

102 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

103 
	#MODE_PAGE_CACHING
 0x08

	)

104 
	#MODE_PAGE_CONTROL
 0x0A

	)

105 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

106 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

107 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

108 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

109 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

110 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

111 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

112 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

113 
	#MODE_PAGE_ALL_LEN
 0x54

	)

114 
	#MODE_SENSE6_MPH_SIZE
 4

	)

115 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

116 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

117 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

118 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

119 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

120 
	#MODE_SENSE_DBD_MASK
 8

	)

121 
	#MODE_SENSE_DBD_SHIFT
 3

	)

122 
	#MODE_SENSE10_MPH_SIZE
 8

	)

123 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

124 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

125 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

126 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

127 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

128 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

129 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

130 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

131 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

132 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

133 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

134 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

135 
	#SHORT_DESC_BLOCK
 8

	)

136 
	#LONG_DESC_BLOCK
 16

	)

137 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

138 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

139 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

140 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

141 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

144 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
 0x00

	)

145 
	#LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
 0x07

	)

146 
	#LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
 0x2F

	)

147 
	#LOG_PAGE_TEMPERATURE_PAGE
 0x0D

	)

148 
	#LOG_SENSE_CDB_SP_NOT_ENABLED
 0

	)

149 
	#LOG_SENSE_CDB_PC_MASK
 0xC0

	)

150 
	#LOG_SENSE_CDB_PC_SHIFT
 6

	)

151 
	#LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
 1

	)

152 
	#LOG_SENSE_CDB_PAGE_CODE_MASK
 0x3F

	)

153 
	#REMAINING_INFO_EXCP_PAGE_LENGTH
 0x8

	)

154 
	#LOG_INFO_EXCP_PAGE_LENGTH
 0xC

	)

155 
	#REMAINING_TEMP_PAGE_LENGTH
 0xC

	)

156 
	#LOG_TEMP_PAGE_LENGTH
 0x10

	)

157 
	#LOG_TEMP_UNKNOWN
 0xFF

	)

158 
	#SUPPORTED_LOG_PAGES_PAGE_LENGTH
 0x3

	)

161 
	#READ_CAP_10_RESP_SIZE
 8

	)

162 
	#READ_CAP_16_RESP_SIZE
 32

	)

165 
	#BYTES_TO_DWORDS
 4

	)

166 
	#NVME_MAX_FIRMWARE_SLOT
 7

	)

169 
	#REPORT_LUNS_FIRST_LUN_OFFSET
 8

	)

173 
	#SCSI_ASC_NO_SENSE
 0x00

	)

174 
	#SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

175 
	#SCSI_ASC_LUN_NOT_READY
 0x04

	)

176 
	#SCSI_ASC_WARNING
 0x0B

	)

177 
	#SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

178 
	#SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

179 
	#SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

180 
	#SCSI_ASC_UNRECOVERED_READ_ERROR
 0x11

	)

181 
	#SCSI_ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

182 
	#SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
 0x20

	)

183 
	#SCSI_ASC_ILLEGAL_COMMAND
 0x20

	)

184 
	#SCSI_ASC_ILLEGAL_BLOCK
 0x21

	)

185 
	#SCSI_ASC_INVALID_CDB
 0x24

	)

186 
	#SCSI_ASC_INVALID_LUN
 0x25

	)

187 
	#SCSI_ASC_INVALID_PARAMETER
 0x26

	)

188 
	#SCSI_ASC_FORMAT_COMMAND_FAILED
 0x31

	)

189 
	#SCSI_ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

193 
	#SCSI_ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

194 
	#SCSI_ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

195 
	#SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

196 
	#SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

197 
	#SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

198 
	#SCSI_ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

199 
	#SCSI_ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

200 
	#SCSI_ASCQ_INVALID_LUN_ID
 0x09

	)

203 
šlše
 
u32
 
	$g‘_uÇligÃd_be24
(
u8
 *
buf
)

205  0xfffffà& (
u32
è
	`g‘_uÇligÃd_be32
(
buf
 - 1);

206 
	}
}

211 
	snvme_Œªs_io_cdb
 {

212 
u8
 
	mfua
;

213 
u8
 
	m´Ù_šfo
;

214 
u64
 
	mlba
;

215 
u32
 
	mxãr_Ën
;

224 
	$nvme_Œªs_cİy_to_u£r
(
sg_io_hdr
 *
hdr
, *
äom
,

225 
n
)

227 
i
;

228 *
šdex
 = 
äom
;

229 
size_t
 
»maššg
 = 
n
;

230 
size_t
 
xãr_Ën
;

232 ià(
hdr
->
iovec_couÁ
 > 0) {

233 
sg_iovec
 
sgl
;

235 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

236 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

237 
i
 * (
sg_iovec
),

238 (
sg_iovec
)))

239  -
EFAULT
;

240 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

241 ià(
	`cİy_to_u£r
(
sgl
.
iov_ba£
, 
šdex
, 
xãr_Ën
))

242  -
EFAULT
;

244 
šdex
 +ğ
xãr_Ën
;

245 
»maššg
 -ğ
xãr_Ën
;

246 ià(
»maššg
 == 0)

252 ià(
	`cİy_to_u£r
(
hdr
->
dxã½
, 
äom
, 
n
))

253  -
EFAULT
;

255 
	}
}

259 
	$nvme_Œªs_cİy_äom_u£r
(
sg_io_hdr
 *
hdr
, *
to
,

260 
n
)

262 
i
;

263 *
šdex
 = 
to
;

264 
size_t
 
»maššg
 = 
n
;

265 
size_t
 
xãr_Ën
;

267 ià(
hdr
->
iovec_couÁ
 > 0) {

268 
sg_iovec
 
sgl
;

270 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

271 ià(
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

272 
i
 * (
sg_iovec
),

273 (
sg_iovec
)))

274  -
EFAULT
;

275 
xãr_Ën
 = 
	`mš
(
»maššg
, 
sgl
.
iov_Ën
);

276 ià(
	`cİy_äom_u£r
(
šdex
, 
sgl
.
iov_ba£
, 
xãr_Ën
))

277  -
EFAULT
;

278 
šdex
 +ğ
xãr_Ën
;

279 
»maššg
 -ğ
xãr_Ën
;

280 ià(
»maššg
 == 0)

286 ià(
	`cİy_äom_u£r
(
to
, 
hdr
->
dxã½
, 
n
))

287  -
EFAULT
;

289 
	}
}

293 
	$nvme_Œªs_com¶‘iÚ
(
sg_io_hdr
 *
hdr
, 
u8
 
¡©us
, u8 
£n£_key
,

294 
u8
 
asc
, u8 
ascq
)

296 
u8
 
xãr_Ën
;

297 
u8
 
»¥
[
DESC_FMT_SENSE_DATA_SIZE
];

299 ià(
	`scsi_¡©us_is_good
(
¡©us
)) {

300 
hdr
->
¡©us
 = 
SAM_STAT_GOOD
;

301 
hdr
->
masked_¡©us
 = 
GOOD
;

302 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

303 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

304 
hdr
->
sb_Ën_wr
 = 0;

306 
hdr
->
¡©us
 = status;

307 
hdr
->
masked_¡©us
 = 
¡©us
 >> 1;

308 
hdr
->
ho¡_¡©us
 = 
DID_OK
;

309 
hdr
->
driv”_¡©us
 = 
DRIVER_OK
;

311 
	`mem£t
(
»¥
, 0, 
DESC_FMT_SENSE_DATA_SIZE
);

312 
»¥
[0] = 
DESC_FORMAT_SENSE_DATA
;

313 
»¥
[1] = 
£n£_key
;

314 
»¥
[2] = 
asc
;

315 
»¥
[3] = 
ascq
;

317 
xãr_Ën
 = 
	`mš_t
(
u8
, 
hdr
->
mx_sb_Ën
, 
DESC_FMT_SENSE_DATA_SIZE
);

318 
hdr
->
sb_Ën_wr
 = 
xãr_Ën
;

319 ià(
	`cİy_to_u£r
(
hdr
->
sbp
, 
»¥
, 
xãr_Ën
) > 0)

320  -
EFAULT
;

324 
	}
}

332 
	$nvme_Œªs_¡©us_code
(
sg_io_hdr
 *
hdr
, 
nvme_sc
)

334 
u8
 
¡©us
, 
£n£_key
, 
asc
, 
ascq
;

335 
»s
;

338 ià(
nvme_sc
 < 0)

339  
nvme_sc
;

342 
nvme_sc
 & 0x7FF) {

344 
NVME_SC_SUCCESS
:

345 
¡©us
 = 
SAM_STAT_GOOD
;

346 
£n£_key
 = 
NO_SENSE
;

347 
asc
 = 
SCSI_ASC_NO_SENSE
;

348 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

350 
NVME_SC_INVALID_OPCODE
:

351 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

352 
£n£_key
 = 
ILLEGAL_REQUEST
;

353 
asc
 = 
SCSI_ASC_ILLEGAL_COMMAND
;

354 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

356 
NVME_SC_INVALID_FIELD
:

357 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

358 
£n£_key
 = 
ILLEGAL_REQUEST
;

359 
asc
 = 
SCSI_ASC_INVALID_CDB
;

360 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

362 
NVME_SC_DATA_XFER_ERROR
:

363 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

364 
£n£_key
 = 
MEDIUM_ERROR
;

365 
asc
 = 
SCSI_ASC_NO_SENSE
;

366 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

368 
NVME_SC_POWER_LOSS
:

369 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

370 
£n£_key
 = 
ABORTED_COMMAND
;

371 
asc
 = 
SCSI_ASC_WARNING
;

372 
ascq
 = 
SCSI_ASCQ_POWER_LOSS_EXPECTED
;

374 
NVME_SC_INTERNAL
:

375 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

376 
£n£_key
 = 
HARDWARE_ERROR
;

377 
asc
 = 
SCSI_ASC_INTERNAL_TARGET_FAILURE
;

378 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

380 
NVME_SC_ABORT_REQ
:

381 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

382 
£n£_key
 = 
ABORTED_COMMAND
;

383 
asc
 = 
SCSI_ASC_NO_SENSE
;

384 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

386 
NVME_SC_ABORT_QUEUE
:

387 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

388 
£n£_key
 = 
ABORTED_COMMAND
;

389 
asc
 = 
SCSI_ASC_NO_SENSE
;

390 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

392 
NVME_SC_FUSED_FAIL
:

393 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

394 
£n£_key
 = 
ABORTED_COMMAND
;

395 
asc
 = 
SCSI_ASC_NO_SENSE
;

396 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

398 
NVME_SC_FUSED_MISSING
:

399 
¡©us
 = 
SAM_STAT_TASK_ABORTED
;

400 
£n£_key
 = 
ABORTED_COMMAND
;

401 
asc
 = 
SCSI_ASC_NO_SENSE
;

402 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

404 
NVME_SC_INVALID_NS
:

405 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

406 
£n£_key
 = 
ILLEGAL_REQUEST
;

407 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

408 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

410 
NVME_SC_LBA_RANGE
:

411 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

412 
£n£_key
 = 
ILLEGAL_REQUEST
;

413 
asc
 = 
SCSI_ASC_ILLEGAL_BLOCK
;

414 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

416 
NVME_SC_CAP_EXCEEDED
:

417 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

418 
£n£_key
 = 
MEDIUM_ERROR
;

419 
asc
 = 
SCSI_ASC_NO_SENSE
;

420 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

422 
NVME_SC_NS_NOT_READY
:

423 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

424 
£n£_key
 = 
NOT_READY
;

425 
asc
 = 
SCSI_ASC_LUN_NOT_READY
;

426 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

430 
NVME_SC_INVALID_FORMAT
:

431 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

432 
£n£_key
 = 
ILLEGAL_REQUEST
;

433 
asc
 = 
SCSI_ASC_FORMAT_COMMAND_FAILED
;

434 
ascq
 = 
SCSI_ASCQ_FORMAT_COMMAND_FAILED
;

436 
NVME_SC_BAD_ATTRIBUTES
:

437 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

438 
£n£_key
 = 
ILLEGAL_REQUEST
;

439 
asc
 = 
SCSI_ASC_INVALID_CDB
;

440 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

444 
NVME_SC_WRITE_FAULT
:

445 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

446 
£n£_key
 = 
MEDIUM_ERROR
;

447 
asc
 = 
SCSI_ASC_PERIPHERAL_DEV_WRITE_FAULT
;

448 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

450 
NVME_SC_READ_ERROR
:

451 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

452 
£n£_key
 = 
MEDIUM_ERROR
;

453 
asc
 = 
SCSI_ASC_UNRECOVERED_READ_ERROR
;

454 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

456 
NVME_SC_GUARD_CHECK
:

457 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

458 
£n£_key
 = 
MEDIUM_ERROR
;

459 
asc
 = 
SCSI_ASC_LOG_BLOCK_GUARD_CHECK_FAILED
;

460 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
;

462 
NVME_SC_APPTAG_CHECK
:

463 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

464 
£n£_key
 = 
MEDIUM_ERROR
;

465 
asc
 = 
SCSI_ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
;

466 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
;

468 
NVME_SC_REFTAG_CHECK
:

469 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

470 
£n£_key
 = 
MEDIUM_ERROR
;

471 
asc
 = 
SCSI_ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
;

472 
ascq
 = 
SCSI_ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
;

474 
NVME_SC_COMPARE_FAILED
:

475 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

476 
£n£_key
 = 
MISCOMPARE
;

477 
asc
 = 
SCSI_ASC_MISCOMPARE_DURING_VERIFY
;

478 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

480 
NVME_SC_ACCESS_DENIED
:

481 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

482 
£n£_key
 = 
ILLEGAL_REQUEST
;

483 
asc
 = 
SCSI_ASC_ACCESS_DENIED_INVALID_LUN_ID
;

484 
ascq
 = 
SCSI_ASCQ_INVALID_LUN_ID
;

488 
NVME_SC_CMDID_CONFLICT
:

489 
NVME_SC_CMD_SEQ_ERROR
:

490 
NVME_SC_CQ_INVALID
:

491 
NVME_SC_QID_INVALID
:

492 
NVME_SC_QUEUE_SIZE
:

493 
NVME_SC_ABORT_LIMIT
:

494 
NVME_SC_ABORT_MISSING
:

495 
NVME_SC_ASYNC_LIMIT
:

496 
NVME_SC_FIRMWARE_SLOT
:

497 
NVME_SC_FIRMWARE_IMAGE
:

498 
NVME_SC_INVALID_VECTOR
:

499 
NVME_SC_INVALID_LOG_PAGE
:

501 
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

502 
£n£_key
 = 
ILLEGAL_REQUEST
;

503 
asc
 = 
SCSI_ASC_NO_SENSE
;

504 
ascq
 = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

508 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
¡©us
, 
£n£_key
, 
asc
, 
ascq
);

509  
»s
 ?„e : 
nvme_sc
;

510 
	}
}

514 
	$nvme_Œªs_¡ªd¬d_šquœy_·ge
(
nvme_ns
 *
ns
,

515 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

516 
®loc_Ën
)

518 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

519 
nvme_id_ns
 *
id_ns
;

520 
»s
;

521 
nvme_sc
;

522 
xãr_Ën
;

523 
u8
 
»¥_d©a_fÜm©
 = 0x02;

524 
u8
 
´Ùeù
;

525 
u8
 
cmdque
 = 0x01 << 1;

526 
u8
 
fw_off£t
 = (
ù¾
->
fœmw¬e_»v
);

529 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

530 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

531 ià(
»s
)

532  
»s
;

534 ià(
id_ns
->
dps
)

535 
´Ùeù
 = 0x01;

537 
´Ùeù
 = 0;

538 
	`kä“
(
id_ns
);

540 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

541 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

542 
šq_»¥Ú£
[3] = 
»¥_d©a_fÜm©
;

543 
šq_»¥Ú£
[4] = 
ADDITIONAL_STD_INQ_LENGTH
;

544 
šq_»¥Ú£
[5] = 
´Ùeù
;

545 
šq_»¥Ú£
[7] = 
cmdque
;

546 
	`¡ºıy
(&
šq_»¥Ú£
[8], "NVMe ", 8);

547 
	`¡ºıy
(&
šq_»¥Ú£
[16], 
ù¾
->
mod–
, 16);

549 
ù¾
->
fœmw¬e_»v
[
fw_off£t
 - 1] == ' ' && fw_offset > 4)

550 
fw_off£t
--;

551 
fw_off£t
 -= 4;

552 
	`¡ºıy
(&
šq_»¥Ú£
[32], 
ù¾
->
fœmw¬e_»v
 + 
fw_off£t
, 4);

554 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

555  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

556 
	}
}

558 
	$nvme_Œªs_suµÜ‹d_vpd_·ges
(
nvme_ns
 *
ns
,

559 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

560 
®loc_Ën
)

562 
xãr_Ën
;

564 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

565 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

566 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

567 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

568 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

569 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

570 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

571 
šq_»¥Ú£
[8] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

572 
šq_»¥Ú£
[9] = 
INQ_BDEV_LIMITS_PAGE
;

574 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

575  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

576 
	}
}

578 
	$nvme_Œªs_un™_£rŸl_·ge
(
nvme_ns
 *
ns
,

579 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
,

580 
®loc_Ën
)

582 
xãr_Ën
;

584 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

585 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

586 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

587 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
ns
->
ù¾
->
£rŸl
, 
INQ_SERIAL_NUMBER_LENGTH
);

589 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

590  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

591 
	}
}

593 
	$nvme_fl_deviû_id_eui64
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

594 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

596 
nvme_id_ns
 *
id_ns
;

597 
nvme_sc
, 
»s
;

598 
size_t
 
Ën
;

599 *
eui
;

601 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

602 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

603 ià(
»s
)

604  
»s
;

606 
eui
 = 
id_ns
->
eui64
;

607 
Ën
 = (
id_ns
->
eui64
);

609 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 2, 0)) {

610 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

611 
eui
 = 
id_ns
->
nguid
;

612 
Ën
 = (
id_ns
->
nguid
);

616 ià(
	`b™m­_em±y
(
eui
, 
Ën
 * 8)) {

617 
»s
 = -
EOPNOTSUPP
;

618 
out_ä“_id
;

621 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

622 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

623 
šq_»¥Ú£
[3] = 4 + 
Ën
;

626 
šq_»¥Ú£
[4] = 0x01;

627 
šq_»¥Ú£
[5] = 0x02;

628 
šq_»¥Ú£
[6] = 0x00;

629 
šq_»¥Ú£
[7] = 
Ën
;

630 
	`memıy
(&
šq_»¥Ú£
[8], 
eui
, 
Ën
);

632 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

633 
out_ä“_id
:

634 
	`kä“
(
id_ns
);

635  
»s
;

636 
	}
}

638 
	$nvme_fl_deviû_id_scsi_¡ršg
(
nvme_ns
 *
ns
,

639 
sg_io_hdr
 *
hdr
, 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

641 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

642 
nvme_id_ù¾
 *
id_ù¾
;

643 
nvme_sc
, 
»s
;

645 ià(
®loc_Ën
 < 72) {

646  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

647 
SAM_STAT_CHECK_CONDITION
,

648 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

649 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

652 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

653 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

654 ià(
»s
)

655  
»s
;

657 
	`mem£t
(
šq_»¥Ú£
, 0, 
®loc_Ën
);

658 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

659 
šq_»¥Ú£
[3] = 0x48;

662 
šq_»¥Ú£
[4] = 0x03;

663 
šq_»¥Ú£
[5] = 0x08;

664 
šq_»¥Ú£
[6] = 0x00;

665 
šq_»¥Ú£
[7] = 0x44;

667 
	`¥rštf
(&
šq_»¥Ú£
[8], "%04x", 
	`Ë16_to_ıu
(
id_ù¾
->
vid
));

668 
	`memıy
(&
šq_»¥Ú£
[12], 
ù¾
->
mod–
, (ctrl->model));

669 
	`¥rštf
(&
šq_»¥Ú£
[52], "%04x", 
	`ıu_to_be32
(
ns
->
ns_id
));

670 
	`memıy
(&
šq_»¥Ú£
[56], 
ù¾
->
£rŸl
, (ctrl->serial));

672 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
®loc_Ën
);

673 
	`kä“
(
id_ù¾
);

674  
»s
;

675 
	}
}

677 
	$nvme_Œªs_deviû_id_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

678 
u8
 *
»¥
, 
®loc_Ën
)

680 
»s
;

682 ià(
ns
->
ù¾
->
vs
 >ğ
	`NVME_VS
(1, 1, 0)) {

683 
»s
 = 
	`nvme_fl_deviû_id_eui64
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

684 ià(
»s
 !ğ-
EOPNOTSUPP
)

685  
»s
;

688  
	`nvme_fl_deviû_id_scsi_¡ršg
(
ns
, 
hdr
, 
»¥
, 
®loc_Ën
);

689 
	}
}

691 
	$nvme_Œªs_ext_šq_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

692 
®loc_Ën
)

694 
u8
 *
šq_»¥Ú£
;

695 
»s
;

696 
nvme_sc
;

697 
nvme_ù¾
 *
ù¾
 = 
ns
->ctrl;

698 
nvme_id_ù¾
 *
id_ù¾
;

699 
nvme_id_ns
 *
id_ns
;

700 
xãr_Ën
;

701 
u8
 
miüocode
 = 0x80;

702 
u8
 
¥t
;

703 
u8
 
¥t_lut
[8] = {0, 0, 2, 1, 4, 6, 5, 7};

704 
u8
 
grd_chk
, 
­p_chk
, 
»f_chk
, 
´Ùeù
;

705 
u8
 
uask_sup
 = 0x20;

706 
u8
 
v_sup
;

707 
u8
 
luişr
 = 0x01;

709 
šq_»¥Ú£
 = 
	`km®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

710 ià(
šq_»¥Ú£
 =ğ
NULL
)

711  -
ENOMEM
;

713 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ù¾
, 
ns
->
ns_id
, &
id_ns
);

714 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

715 ià(
»s
)

716 
out_ä“_šq
;

718 
¥t
 = 
¥t_lut
[
id_ns
->
dpc
 & 0x07] << 3;

719 ià(
id_ns
->
dps
)

720 
´Ùeù
 = 0x01;

722 
´Ùeù
 = 0;

723 
	`kä“
(
id_ns
);

725 
grd_chk
 = 
´Ùeù
 << 2;

726 
­p_chk
 = 
´Ùeù
 << 1;

727 
»f_chk
 = 
´Ùeù
;

729 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ù¾
, &
id_ù¾
);

730 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

731 ià(
»s
)

732 
out_ä“_šq
;

734 
v_sup
 = 
id_ù¾
->
vwc
;

735 
	`kä“
(
id_ù¾
);

737 
	`mem£t
(
šq_»¥Ú£
, 0, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

738 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

739 
šq_»¥Ú£
[2] = 0x00;

740 
šq_»¥Ú£
[3] = 0x3C;

741 
šq_»¥Ú£
[4] = 
miüocode
 | 
¥t
 | 
grd_chk
 | 
­p_chk
 | 
»f_chk
;

742 
šq_»¥Ú£
[5] = 
uask_sup
;

743 
šq_»¥Ú£
[6] = 
v_sup
;

744 
šq_»¥Ú£
[7] = 
luişr
;

745 
šq_»¥Ú£
[8] = 0;

746 
šq_»¥Ú£
[9] = 0;

748 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

749 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

751 
out_ä“_šq
:

752 
	`kä“
(
šq_»¥Ú£
);

753  
»s
;

754 
	}
}

756 
	$nvme_Œªs_bdev_lim™s_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

757 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

759 
__be32
 
max_£ùÜs
 = 
	`ıu_to_be32
(

760 
	`nvme_block_Ä
(
ns
, 
	`queue_max_hw_£ùÜs
Òs->
queue
)));

761 
__be32
 
max_disÿrd
 = 
	`ıu_to_be32
(
ns
->
queue
->
lim™s
.
max_disÿrd_£ùÜs
);

762 
__be32
 
disÿrd_desc_couÁ
 = 
	`ıu_to_be32
(0x100);

764 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

765 
šq_»¥Ú£
[1] = 
VPD_BLOCK_LIMITS
;

766 
šq_»¥Ú£
[3] = 0x3c;

767 
	`memıy
(&
šq_»¥Ú£
[8], &
max_£ùÜs
, (
u32
));

768 
	`memıy
(&
šq_»¥Ú£
[20], &
max_disÿrd
, (
u32
));

770 ià(
max_disÿrd
)

771 
	`memıy
(&
šq_»¥Ú£
[24], &
disÿrd_desc_couÁ
, (
u32
));

773  
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 0x3c);

774 
	}
}

776 
	$nvme_Œªs_bdev_ch¬_·ge
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

777 
®loc_Ën
)

779 
u8
 *
šq_»¥Ú£
;

780 
»s
;

781 
xãr_Ën
;

783 
šq_»¥Ú£
 = 
	`kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_KERNEL
);

784 ià(
šq_»¥Ú£
 =ğ
NULL
) {

785 
»s
 = -
ENOMEM
;

786 
out_mem
;

789 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

790 
šq_»¥Ú£
[2] = 0x00;

791 
šq_»¥Ú£
[3] = 0x3C;

792 
šq_»¥Ú£
[4] = 0x00;

793 
šq_»¥Ú£
[5] = 0x01;

794 
šq_»¥Ú£
[6] = 0x00;

796 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

797 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
šq_»¥Ú£
, 
xãr_Ën
);

799 
	`kä“
(
šq_»¥Ú£
);

800 
out_mem
:

801  
»s
;

802 
	}
}

806 
	$nvme_Œªs_log_suµ_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

807 
®loc_Ën
)

809 
»s
;

810 
xãr_Ën
;

811 
u8
 *
log_»¥Ú£
;

813 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
, 
GFP_KERNEL
);

814 ià(
log_»¥Ú£
 =ğ
NULL
) {

815 
»s
 = -
ENOMEM
;

816 
out_mem
;

819 
log_»¥Ú£
[0] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

821 
log_»¥Ú£
[3] = 
SUPPORTED_LOG_PAGES_PAGE_LENGTH
;

822 
log_»¥Ú£
[4] = 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
;

823 
log_»¥Ú£
[5] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

824 
log_»¥Ú£
[6] = 
LOG_PAGE_TEMPERATURE_PAGE
;

826 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_PAGE_SUPPORTED_LOG_PAGES_LENGTH
);

827 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

829 
	`kä“
(
log_»¥Ú£
);

830 
out_mem
:

831  
»s
;

832 
	}
}

834 
	$nvme_Œªs_log_šfo_exû±iÚs
(
nvme_ns
 *
ns
,

835 
sg_io_hdr
 *
hdr
, 
®loc_Ën
)

837 
»s
;

838 
xãr_Ën
;

839 
u8
 *
log_»¥Ú£
;

840 
nvme_sm¬t_log
 *
sm¬t_log
;

841 
u8
 
‹mp_c
;

842 
u16
 
‹mp_k
;

844 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_INFO_EXCP_PAGE_LENGTH
, 
GFP_KERNEL
);

845 ià(
log_»¥Ú£
 =ğ
NULL
)

846  -
ENOMEM
;

848 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

849 ià(
»s
 < 0)

850 
out_ä“_»¥Ú£
;

852 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

853 
‹mp_c
 = 
LOG_TEMP_UNKNOWN
;

855 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

856 (
sm¬t_log
->
‹m³¿tu»
[0]);

857 
‹mp_c
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

859 
	`kä“
(
sm¬t_log
);

861 
log_»¥Ú£
[0] = 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
;

863 
log_»¥Ú£
[3] = 
REMAINING_INFO_EXCP_PAGE_LENGTH
;

866 
log_»¥Ú£
[6] = 0x23;

867 
log_»¥Ú£
[7] = 0x04;

870 
log_»¥Ú£
[10] = 
‹mp_c
;

872 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_INFO_EXCP_PAGE_LENGTH
);

873 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

875 
out_ä“_»¥Ú£
:

876 
	`kä“
(
log_»¥Ú£
);

877  
»s
;

878 
	}
}

880 
	$nvme_Œªs_log_‹m³¿tu»
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

881 
®loc_Ën
)

883 
»s
;

884 
xãr_Ën
;

885 
u8
 *
log_»¥Ú£
;

886 
nvme_sm¬t_log
 *
sm¬t_log
;

887 
u32
 
ã©u»_»¥
;

888 
u8
 
‹mp_c_cur
, 
‹mp_c_th»sh
;

889 
u16
 
‹mp_k
;

891 
log_»¥Ú£
 = 
	`kz®loc
(
LOG_TEMP_PAGE_LENGTH
, 
GFP_KERNEL
);

892 ià(
log_»¥Ú£
 =ğ
NULL
)

893  -
ENOMEM
;

895 
»s
 = 
	`nvme_g‘_log_·ge
(
ns
->
ù¾
, &
sm¬t_log
);

896 ià(
»s
 < 0)

897 
out_ä“_»¥Ú£
;

899 ià(
»s
 !ğ
NVME_SC_SUCCESS
) {

900 
‹mp_c_cur
 = 
LOG_TEMP_UNKNOWN
;

902 
‹mp_k
 = (
sm¬t_log
->
‹m³¿tu»
[1] << 8) +

903 (
sm¬t_log
->
‹m³¿tu»
[0]);

904 
‹mp_c_cur
 = 
‹mp_k
 - 
KELVIN_TEMP_FACTOR
;

906 
	`kä“
(
sm¬t_log
);

909 
»s
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_TEMP_THRESH
, 0, 
NULL
, 0,

910 &
ã©u»_»¥
);

911 ià(
»s
 !ğ
NVME_SC_SUCCESS
)

912 
‹mp_c_th»sh
 = 
LOG_TEMP_UNKNOWN
;

914 
‹mp_c_th»sh
 = (
ã©u»_»¥
 & 0xFFFFè- 
KELVIN_TEMP_FACTOR
;

916 
log_»¥Ú£
[0] = 
LOG_PAGE_TEMPERATURE_PAGE
;

918 
log_»¥Ú£
[3] = 
REMAINING_TEMP_PAGE_LENGTH
;

921 
log_»¥Ú£
[6] = 0x01;

922 
log_»¥Ú£
[7] = 0x02;

924 
log_»¥Ú£
[9] = 
‹mp_c_cur
;

926 
log_»¥Ú£
[11] = 0x01;

927 
log_»¥Ú£
[12] = 0x01;

928 
log_»¥Ú£
[13] = 0x02;

930 
log_»¥Ú£
[15] = 
‹mp_c_th»sh
;

932 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
LOG_TEMP_PAGE_LENGTH
);

933 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
log_»¥Ú£
, 
xãr_Ën
);

935 
out_ä“_»¥Ú£
:

936 
	`kä“
(
log_»¥Ú£
);

937  
»s
;

938 
	}
}

942 
	$nvme_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

943 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

946 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

947  -
EINVAL
;

949 ià(
cdb10
) {

950 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

951 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

952 
»¥
[3] = 0x10 ;

953 
»¥
[4] = 
Îb¯
;

954 
»¥
[5] = 
RESERVED_FIELD
;

955 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

956 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

958 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

959 
»¥
[2] = 0x10 ;

960 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

964 
	}
}

966 
	$nvme_Œªs_fl_blk_desc
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

967 
u8
 *
»¥
, 
Ën
, u8 
Îb¯
)

969 
»s
;

970 
nvme_sc
;

971 
nvme_id_ns
 *
id_ns
;

972 
u8
 
æbas
;

973 
u32
 
lba_Ëngth
;

975 ià(
Îb¯
 =ğ0 && 
Ën
 < 
MODE_PAGE_BLK_DES_LEN
)

976  -
EINVAL
;

977 ià(
Îb¯
 > 0 && 
Ën
 < 
MODE_PAGE_LLBAA_BLK_DES_LEN
)

978  -
EINVAL
;

980 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

981 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

982 ià(
»s
)

983  
»s
;

985 
æbas
 = (
id_ns
->flbas) & 0x0F;

986 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

988 ià(
Îb¯
 == 0) {

989 
__be32
 
tmp_ÿp
 = 
	`ıu_to_be32
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

991 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
 & 0x00FFFFFF);

993 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u32
));

994 
	`memıy
(&
»¥
[4], &
tmp_Ën
, (
u32
));

996 
__be64
 
tmp_ÿp
 = 
	`ıu_to_be64
(
	`Ë64_to_ıu
(
id_ns
->
nÿp
));

997 
__be32
 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

999 
	`memıy
(
»¥
, &
tmp_ÿp
, (
u64
));

1001 
	`memıy
(&
»¥
[12], &
tmp_Ën
, (
u32
));

1004 
	`kä“
(
id_ns
);

1005  
»s
;

1006 
	}
}

1008 
	$nvme_Œªs_fl_cÚŒŞ_·ge
(
nvme_ns
 *
ns
,

1009 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1010 
Ën
)

1012 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

1013  -
EINVAL
;

1015 
»¥
[0] = 
MODE_PAGE_CONTROL
;

1016 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

1017 
»¥
[2] = 0x0E;

1019 
»¥
[3] = 0x12;

1021 
»¥
[5] = 0x40;

1023 
»¥
[8] = 0xFF;

1024 
»¥
[9] = 0xFF;

1028 
	}
}

1030 
	$nvme_Œªs_fl_ÿchšg_·ge
(
nvme_ns
 *
ns
,

1031 
sg_io_hdr
 *
hdr
,

1032 
u8
 *
»¥
, 
Ën
)

1034 
»s
 = 0;

1035 
nvme_sc
;

1036 
u32
 
ã©u»_»¥
;

1037 
u8
 
vwc
;

1039 ià(
Ën
 < 
MODE_PAGE_CACHING_LEN
)

1040  -
EINVAL
;

1042 
nvme_sc
 = 
	`nvme_g‘_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
, 0, 
NULL
, 0,

1043 &
ã©u»_»¥
);

1044 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1045 ià(
»s
)

1046  
»s
;

1048 
vwc
 = 
ã©u»_»¥
 & 0x00000001;

1050 
»¥
[0] = 
MODE_PAGE_CACHING
;

1051 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

1052 
»¥
[2] = 
vwc
 << 2;

1054 
	}
}

1056 
	$nvme_Œªs_fl_pow_úd_·ge
(
nvme_ns
 *
ns
,

1057 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1058 
Ën
)

1060 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

1061  -
EINVAL
;

1063 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

1064 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

1068 
	}
}

1070 
	$nvme_Œªs_fl_šf_exc_·ge
(
nvme_ns
 *
ns
,

1071 
sg_io_hdr
 *
hdr
, 
u8
 *
»¥
,

1072 
Ën
)

1074 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

1075  -
EINVAL
;

1077 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

1078 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

1079 
»¥
[2] = 0x88;

1083 
	}
}

1085 
	$nvme_Œªs_fl_®l_·ges
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1086 
u8
 *
»¥
, 
Ën
)

1088 
»s
;

1089 
u16
 
mode_·ges_off£t_1
 = 0;

1090 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

1092 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

1093 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

1094 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

1096 
»s
 = 
	`nvme_Œªs_fl_ÿchšg_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_1
],

1097 
MODE_PAGE_CACHING_LEN
);

1098 ià(
»s
)

1099  
»s
;

1100 
»s
 = 
	`nvme_Œªs_fl_cÚŒŞ_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_2
],

1101 
MODE_PAGE_CONTROL_LEN
);

1102 ià(
»s
)

1103  
»s
;

1104 
»s
 = 
	`nvme_Œªs_fl_pow_úd_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_3
],

1105 
MODE_PAGE_POW_CND_LEN
);

1106 ià(
»s
)

1107  
»s
;

1108  
	`nvme_Œªs_fl_šf_exc_·ge
(
ns
, 
hdr
, &
»¥
[
mode_·ges_off£t_4
],

1109 
MODE_PAGE_INF_EXC_LEN
);

1110 
	}
}

1112 
šlše
 
	$nvme_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

1114 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

1116  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

1120 
	}
}

1122 
nvme_Œªs_mode_·ge_ü—‹
(
nvme_ns
 *
ns
,

1123 
sg_io_hdr
 *
hdr
, 
u8
 *
cmd
,

1124 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

1125 (*
mode_·ge_fl_func
)

1126 (
nvme_ns
 *,

1127 
sg_io_hdr
 *
hdr
, 
u8
 *, ),

1128 
u16
 
mode_·ges_tÙ_Ën
)

1130 
»s
;

1131 
xãr_Ën
;

1132 
u8
 *
»¥Ú£
;

1133 
u8
 
dbd
, 
Îb¯
;

1134 
u16
 
»¥_size
;

1135 
mph_size
;

1136 
u16
 
mode_·ges_off£t_1
;

1137 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

1139 
dbd
 = (
cmd
[1] & 
MODE_SENSE_DBD_MASK
è>> 
MODE_SENSE_DBD_SHIFT
;

1140 
Îb¯
 = (
cmd
[1] & 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
;

1141 
mph_size
 = 
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
;

1143 
blk_desc_Ën
 = 
	`nvme_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

1145 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1147 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

1149 
blk_desc_off£t
 = 
mph_size
;

1150 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

1152 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

1153 ià(
»¥Ú£
 =ğ
NULL
) {

1154 
»s
 = -
ENOMEM
;

1155 
out_mem
;

1158 
»s
 = 
	`nvme_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
,

1159 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

1160 ià(
»s
)

1161 
out_ä“
;

1162 ià(
blk_desc_Ën
 > 0) {

1163 
»s
 = 
	`nvme_Œªs_fl_blk_desc
(
ns
, 
hdr
,

1164 &
»¥Ú£
[
blk_desc_off£t
],

1165 
blk_desc_Ën
, 
Îb¯
);

1166 ià(
»s
)

1167 
out_ä“
;

1169 
»s
 = 
	`mode_·ge_fl_func
(
ns
, 
hdr
, &
»¥Ú£
[
mode_·ges_off£t_1
],

1170 
mode_·ges_tÙ_Ën
);

1171 ià(
»s
)

1172 
out_ä“
;

1174 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

1175 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

1177 
out_ä“
:

1178 
	`kä“
(
»¥Ú£
);

1179 
out_mem
:

1180  
»s
;

1181 
	}
}

1185 
	$nvme_Œªs_fl_»ad_ÿp
(
u8
 *
»¥Ú£
, 
nvme_id_ns
 *
id_ns
,

1186 
u8
 
cdb16
)

1188 
u8
 
æbas
;

1189 
u32
 
lba_Ëngth
;

1190 
u64
 
¾ba
;

1191 
u8
 
´Ù_’
;

1192 
u8
 
p_ty³_lut
[4] = {0, 0, 1, 2};

1193 
__be64
 
tmp_¾ba
;

1194 
__be32
 
tmp_¾ba_32
;

1195 
__be32
 
tmp_Ën
;

1197 
æbas
 = (
id_ns
->flbas) & 0x0F;

1198 
lba_Ëngth
 = (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1199 
¾ba
 = 
	`Ë64_to_ıup
(&
id_ns
->
nsze
) - 1;

1200 (
id_ns
->
dps
è? (
´Ù_’
 = 0x01) : (prot_en = 0);

1202 ià(!
cdb16
) {

1203 ià(
¾ba
 > 0xFFFFFFFF)

1204 
¾ba
 = 0xFFFFFFFF;

1205 
tmp_¾ba_32
 = 
	`ıu_to_be32
(
¾ba
);

1206 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1207 
	`memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

1208 
	`memıy
(&
»¥Ú£
[4], &
tmp_Ën
, (
u32
));

1210 
tmp_¾ba
 = 
	`ıu_to_be64
(
¾ba
);

1211 
tmp_Ën
 = 
	`ıu_to_be32
(
lba_Ëngth
);

1212 
	`memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

1213 
	`memıy
(&
»¥Ú£
[8], &
tmp_Ën
, (
u32
));

1214 
»¥Ú£
[12] = (
p_ty³_lut
[
id_ns
->
dps
 & 0x3] << 1è| 
´Ù_’
;

1219 
	}
}

1223 
	$nvme_Œªs_£nd_aùiv©e_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1224 
u8
 
bufãr_id
)

1226 
nvme_commªd
 
c
;

1227 
nvme_sc
;

1229 
	`mem£t
(&
c
, 0, (c));

1230 
c
.
commÚ
.
İcode
 = 
nvme_admš_aùiv©e_fw
;

1231 
c
.
commÚ
.
cdw10
[0] = 
	`ıu_to_Ë32
(
bufãr_id
 | 
NVME_FWACT_REPL_ACTV
);

1233 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

1234  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1235 
	}
}

1237 
	$nvme_Œªs_£nd_dowÆßd_fw_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1238 
u8
 
İcode
, 
u32
 
tÙ_Ën
, u32 
off£t
,

1239 
u8
 
bufãr_id
)

1241 
nvme_sc
;

1242 
nvme_commªd
 
c
;

1244 ià(
hdr
->
iovec_couÁ
 > 0) {

1246  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1247 
SAM_STAT_CHECK_CONDITION
,

1248 
ILLEGAL_REQUEST
,

1249 
SCSI_ASC_INVALID_CDB
,

1250 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1253 
	`mem£t
(&
c
, 0, (c));

1254 
c
.
commÚ
.
İcode
 = 
nvme_admš_dowÆßd_fw
;

1255 
c
.
dlfw
.
numd
 = 
	`ıu_to_Ë32
((
tÙ_Ën
/
BYTES_TO_DWORDS
) - 1);

1256 
c
.
dlfw
.
off£t
 = 
	`ıu_to_Ë32
(off£t/
BYTES_TO_DWORDS
);

1258 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
ù¾
->
admš_q
, &
c
,

1259 
hdr
->
dxã½
, 
tÙ_Ën
, 
NULL
, 0);

1260  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1261 
	}
}

1265 
šlše
 
	$nvme_Œªs_mode£l_g‘_bd_Ën
(
u8
 *
·rm_li¡
, u8 
cdb10
,

1266 
u16
 *
bd_Ën
, 
u8
 *
Îb¯
)

1268 ià(
cdb10
) {

1270 *
bd_Ën
 = (
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
] << 8) +

1271 
·rm_li¡
[
MODE_SELECT_10_BD_OFFSET
 + 1];

1272 *
Îb¯
 = 
·rm_li¡
[
MODE_SELECT_10_LLBAA_OFFSET
] &

1273 
MODE_SELECT_10_LLBAA_MASK
;

1276 *
bd_Ën
 = 
·rm_li¡
[
MODE_SELECT_6_BD_OFFSET
];

1278 
	}
}

1280 
	$nvme_Œªs_mode£l_§ve_bd
(
nvme_ns
 *
ns
, 
u8
 *
·rm_li¡
,

1281 
u16
 
idx
, u16 
bd_Ën
, 
u8
 
Îb¯
)

1283 
u16
 
bd_num
;

1285 
bd_num
 = 
bd_Ën
 / ((
Îb¯
 == 0) ?

1286 
SHORT_DESC_BLOCK
 : 
LONG_DESC_BLOCK
);

1289 ià(
Îb¯
 == 0) {

1291 
ns
->
mode_£Ëù_num_blocks
 =

1292 (
·rm_li¡
[
idx
 + 1] << 16) +

1293 (
·rm_li¡
[
idx
 + 2] << 8) +

1294 (
·rm_li¡
[
idx
 + 3]);

1296 
ns
->
mode_£Ëù_block_Ën
 =

1297 (
·rm_li¡
[
idx
 + 5] << 16) +

1298 (
·rm_li¡
[
idx
 + 6] << 8) +

1299 (
·rm_li¡
[
idx
 + 7]);

1302 
ns
->
mode_£Ëù_num_blocks
 =

1303 (((
u64
)
·rm_li¡
[
idx
 + 0]) << 56) +

1304 (((
u64
)
·rm_li¡
[
idx
 + 1]) << 48) +

1305 (((
u64
)
·rm_li¡
[
idx
 + 2]) << 40) +

1306 (((
u64
)
·rm_li¡
[
idx
 + 3]) << 32) +

1307 (((
u64
)
·rm_li¡
[
idx
 + 4]) << 24) +

1308 (((
u64
)
·rm_li¡
[
idx
 + 5]) << 16) +

1309 (((
u64
)
·rm_li¡
[
idx
 + 6]) << 8) +

1310 ((
u64
)
·rm_li¡
[
idx
 + 7]);

1312 
ns
->
mode_£Ëù_block_Ën
 =

1313 (
·rm_li¡
[
idx
 + 12] << 24) +

1314 (
·rm_li¡
[
idx
 + 13] << 16) +

1315 (
·rm_li¡
[
idx
 + 14] << 8) +

1316 (
·rm_li¡
[
idx
 + 15]);

1318 
	}
}

1320 
	$nvme_Œªs_mode£l_g‘_mp
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1321 
u8
 *
mode_·ge
, u8 
·ge_code
)

1323 
»s
 = 0;

1324 
nvme_sc
;

1325 
dwÜd11
;

1327 
·ge_code
) {

1328 
MODE_PAGE_CACHING
:

1329 
dwÜd11
 = ((
mode_·ge
[2] & 
CACHING_MODE_PAGE_WCE_MASK
) ? 1 : 0);

1330 
nvme_sc
 = 
	`nvme_£t_ã©u»s
(
ns
->
ù¾
, 
NVME_FEAT_VOLATILE_WC
,

1331 
dwÜd11
, 
NULL
, 0, NULL);

1332 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1334 
MODE_PAGE_CONTROL
:

1336 
MODE_PAGE_POWER_CONDITION
:

1338 ià((
mode_·ge
[2] & 0x01) != 0 || (mode_page[3] & 0x0F) != 0) {

1339 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1340 
SAM_STAT_CHECK_CONDITION
,

1341 
ILLEGAL_REQUEST
,

1342 
SCSI_ASC_INVALID_PARAMETER
,

1343 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1348 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1349 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1350 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1354  
»s
;

1355 
	}
}

1357 
	$nvme_Œªs_mode£l_d©a
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1358 
u8
 *
cmd
, 
u16
 
·rm_li¡_Ën
, u8 
pf
,

1359 
u8
 
¥
, u8 
cdb10
)

1361 
»s
;

1362 
u8
 *
·rm_li¡
;

1363 
u16
 
bd_Ën
;

1364 
u8
 
Îb¯
 = 0;

1365 
u16
 
šdex
, 
§ved_šdex
;

1366 
u8
 
·ge_code
;

1367 
u16
 
mp_size
;

1370 
·rm_li¡
 = 
	`km®loc
(
·rm_li¡_Ën
, 
GFP_KERNEL
);

1371 ià(
·rm_li¡
 =ğ
NULL
) {

1372 
»s
 = -
ENOMEM
;

1373 
out
;

1376 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
·rm_li¡_Ën
);

1377 ià(
»s
)

1378 
out_mem
;

1380 
	`nvme_Œªs_mode£l_g‘_bd_Ën
(
·rm_li¡
, 
cdb10
, &
bd_Ën
, &
Îb¯
);

1381 
šdex
 = (
cdb10
è? (
MODE_SELECT_10_MPH_SIZE
è: (
MODE_SELECT_6_MPH_SIZE
);

1383 ià(
bd_Ën
 != 0) {

1385 
	`nvme_Œªs_mode£l_§ve_bd
(
ns
, 
·rm_li¡
, 
šdex
, 
bd_Ën
, 
Îb¯
);

1386 
šdex
 +ğ
bd_Ën
;

1388 
§ved_šdex
 = 
šdex
;

1393 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1394 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1395 ià((
·ge_code
 !ğ
MODE_PAGE_CACHING
) &&

1396 (
·ge_code
 !ğ
MODE_PAGE_CONTROL
) &&

1397 (
·ge_code
 !ğ
MODE_PAGE_POWER_CONDITION
)) {

1398 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1399 
SAM_STAT_CHECK_CONDITION
,

1400 
ILLEGAL_REQUEST
,

1401 
SCSI_ASC_INVALID_CDB
,

1402 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1403 
out_mem
;

1405 
šdex
 +ğ
mp_size
;

1406 } 
šdex
 < 
·rm_li¡_Ën
);

1409 
šdex
 = 
§ved_šdex
;

1411 
·ge_code
 = 
·rm_li¡
[
šdex
] & 
MODE_SELECT_PAGE_CODE_MASK
;

1412 
mp_size
 = 
·rm_li¡
[
šdex
 + 1] + 2;

1413 
»s
 = 
	`nvme_Œªs_mode£l_g‘_mp
(
ns
, 
hdr
, &
·rm_li¡
[
šdex
],

1414 
·ge_code
);

1415 ià(
»s
)

1417 
šdex
 +ğ
mp_size
;

1418 } 
šdex
 < 
·rm_li¡_Ën
);

1420 
out_mem
:

1421 
	`kä“
(
·rm_li¡
);

1422 
out
:

1423  
»s
;

1424 
	}
}

1428 
	$nvme_Œªs_fmt_£t_blk_size_couÁ
(
nvme_ns
 *
ns
,

1429 
sg_io_hdr
 *
hdr
)

1431 
»s
 = 0;

1432 
nvme_sc
;

1433 
u8
 
æbas
;

1442 ià(
ns
->
mode_£Ëù_num_blocks
 =ğ0 ||‚s->
mode_£Ëù_block_Ën
 == 0) {

1443 
nvme_id_ns
 *
id_ns
;

1445 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1446 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1447 ià(
»s
)

1448  
»s
;

1450 ià(
ns
->
mode_£Ëù_num_blocks
 == 0)

1451 
ns
->
mode_£Ëù_num_blocks
 = 
	`Ë64_to_ıu
(
id_ns
->
nÿp
);

1452 ià(
ns
->
mode_£Ëù_block_Ën
 == 0) {

1453 
æbas
 = (
id_ns
->flbas) & 0x0F;

1454 
ns
->
mode_£Ëù_block_Ën
 =

1455 (1 << (
id_ns
->
lbaf
[
æbas
].
ds
));

1458 
	`kä“
(
id_ns
);

1462 
	}
}

1464 
	$nvme_Œªs_fmt_g‘_·rm_h—d”
(
sg_io_hdr
 *
hdr
, 
u8
 
Ën
,

1465 
u8
 
fÜm©_´Ù_šfo
, u8 *
nvme_pf_code
)

1467 
»s
;

1468 
u8
 *
·rm_li¡
;

1469 
u8
 
pf_u§ge
, 
pf_code
;

1471 
·rm_li¡
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1472 ià(
·rm_li¡
 =ğ
NULL
) {

1473 
»s
 = -
ENOMEM
;

1474 
out
;

1476 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
·rm_li¡
, 
Ën
);

1477 ià(
»s
)

1478 
out_mem
;

1480 ià((
·rm_li¡
[
FORMAT_UNIT_IMMED_OFFSET
] &

1481 
FORMAT_UNIT_IMMED_MASK
) != 0) {

1482 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1483 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1484 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1485 
out_mem
;

1488 ià(
Ën
 =ğ
FORMAT_UNIT_LONG_PARM_LIST_LEN
 &&

1489 (
·rm_li¡
[
FORMAT_UNIT_PROT_INT_OFFSET
] & 0x0F) != 0) {

1490 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1491 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1492 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1493 
out_mem
;

1495 
pf_u§ge
 = 
·rm_li¡
[
FORMAT_UNIT_PROT_FIELD_USAGE_OFFSET
] &

1496 
FORMAT_UNIT_PROT_FIELD_USAGE_MASK
;

1497 
pf_code
 = (
pf_u§ge
 << 2è| 
fÜm©_´Ù_šfo
;

1498 
pf_code
) {

1500 *
nvme_pf_code
 = 0;

1503 *
nvme_pf_code
 = 1;

1506 *
nvme_pf_code
 = 2;

1509 *
nvme_pf_code
 = 3;

1512 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1513 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1514 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1518 
out_mem
:

1519 
	`kä“
(
·rm_li¡
);

1520 
out
:

1521  
»s
;

1522 
	}
}

1524 
	$nvme_Œªs_fmt_£nd_cmd
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1525 
u8
 
´Ù_šfo
)

1527 
»s
;

1528 
nvme_sc
;

1529 
nvme_id_ns
 *
id_ns
;

1530 
u8
 
i
;

1531 
u8
 
æbas
, 
Æbaf
;

1532 
u8
 
£Ëùed_lbaf
 = 0xFF;

1533 
u32
 
cdw10
 = 0;

1534 
nvme_commªd
 
c
;

1537 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

1538 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1539 ià(
»s
)

1540  
»s
;

1542 
æbas
 = (
id_ns
->flbas) & 0x0F;

1543 
Æbaf
 = 
id_ns
->nlbaf;

1545 
i
 = 0; i < 
Æbaf
; i++) {

1546 ià(
ns
->
mode_£Ëù_block_Ën
 =ğ(1 << (
id_ns
->
lbaf
[
i
].
ds
))) {

1547 
£Ëùed_lbaf
 = 
i
;

1551 ià(
£Ëùed_lbaf
 > 0x0F) {

1552 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1553 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1554 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1556 ià(
ns
->
mode_£Ëù_num_blocks
 !ğ
	`Ë64_to_ıu
(
id_ns
->
nÿp
)) {

1557 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1558 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_PARAMETER
,

1559 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1562 
cdw10
 |ğ
´Ù_šfo
 << 5;

1563 
cdw10
 |ğ
£Ëùed_lbaf
 & 0x0F;

1564 
	`mem£t
(&
c
, 0, (c));

1565 
c
.
fÜm©
.
İcode
 = 
nvme_admš_fÜm©_nvm
;

1566 
c
.
fÜm©
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1567 
c
.
fÜm©
.
cdw10
 = 
	`ıu_to_Ë32
(cdw10);

1569 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
ù¾
->
admš_q
, &
c
, 
NULL
, 0);

1570 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1572 
	`kä“
(
id_ns
);

1573  
»s
;

1574 
	}
}

1576 
šlše
 
u32
 
	$nvme_Œªs_io_g‘_num_cmds
(
sg_io_hdr
 *
hdr
,

1577 
nvme_Œªs_io_cdb
 *
cdb_šfo
,

1578 
u32
 
max_blocks
)

1581 ià(
hdr
->
iovec_couÁ
 > 0)

1582  
hdr
->
iovec_couÁ
;

1583 ià(
cdb_šfo
->
xãr_Ën
 > 
max_blocks
)

1584  ((
cdb_šfo
->
xãr_Ën
 - 1è/ 
max_blocks
) + 1;

1587 
	}
}

1589 
u16
 
	$nvme_Œªs_io_g‘_cÚŒŞ
(
nvme_ns
 *
ns
,

1590 
nvme_Œªs_io_cdb
 *
cdb_šfo
)

1592 
u16
 
cÚŒŞ
 = 0;

1596 ià(
cdb_šfo
->
fua
 > 0)

1597 
cÚŒŞ
 |ğ
NVME_RW_FUA
;

1599  
cÚŒŞ
;

1600 
	}
}

1602 
	$nvme_Œªs_do_nvme_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1603 
nvme_Œªs_io_cdb
 *
cdb_šfo
, 
u8
 
is_wr™e
)

1605 
nvme_sc
 = 
NVME_SC_SUCCESS
;

1606 
u32
 
num_cmds
;

1607 
u64
 
un™_Ën
;

1608 
u64
 
un™_num_blocks
;

1609 
u32
 
»tcode
;

1610 
u32
 
i
 = 0;

1611 
u64
 
nvme_off£t
 = 0;

1612 
__u£r
 *
Ãxt_m­pšg_addr
;

1613 
nvme_commªd
 
c
;

1614 
u8
 
İcode
 = (
is_wr™e
 ? 
nvme_cmd_wr™e
 : 
nvme_cmd_»ad
);

1615 
u16
 
cÚŒŞ
;

1616 
u32
 
max_blocks
 = 
	`queue_max_hw_£ùÜs
(
ns
->
queue
);

1618 
num_cmds
 = 
	`nvme_Œªs_io_g‘_num_cmds
(
hdr
, 
cdb_šfo
, 
max_blocks
);

1629 
i
 = 0; i < 
num_cmds
; i++) {

1630 
	`mem£t
(&
c
, 0, (c));

1631 ià(
hdr
->
iovec_couÁ
 > 0) {

1632 
sg_iovec
 
sgl
;

1634 
»tcode
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1635 
i
 * (
sg_iovec
),

1636 (
sg_iovec
));

1637 ià(
»tcode
)

1638  -
EFAULT
;

1639 
un™_Ën
 = 
sgl
.
iov_Ën
;

1640 
un™_num_blocks
 = 
un™_Ën
 >> 
ns
->
lba_shiá
;

1641 
Ãxt_m­pšg_addr
 = 
sgl
.
iov_ba£
;

1643 
un™_num_blocks
 = 
	`mš
((
u64
)
max_blocks
,

1644 (
cdb_šfo
->
xãr_Ën
 - 
nvme_off£t
));

1645 
un™_Ën
 = 
un™_num_blocks
 << 
ns
->
lba_shiá
;

1646 
Ãxt_m­pšg_addr
 = 
hdr
->
dxã½
 +

1647 ((1 << 
ns
->
lba_shiá
è* 
nvme_off£t
);

1650 
c
.
rw
.
İcode
 = opcode;

1651 
c
.
rw
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

1652 
c
.
rw
.
¦ba
 = 
	`ıu_to_Ë64
(
cdb_šfo
->
lba
 + 
nvme_off£t
);

1653 
c
.
rw
.
Ëngth
 = 
	`ıu_to_Ë16
(
un™_num_blocks
 - 1);

1654 
cÚŒŞ
 = 
	`nvme_Œªs_io_g‘_cÚŒŞ
(
ns
, 
cdb_šfo
);

1655 
c
.
rw
.
cÚŒŞ
 = 
	`ıu_to_Ë16
(control);

1657 ià(
	`g‘_ÿ·c™y
(
ns
->
disk
è- 
un™_num_blocks
 <

1658 
cdb_šfo
->
lba
 + 
nvme_off£t
) {

1659 
nvme_sc
 = 
NVME_SC_LBA_RANGE
;

1662 
nvme_sc
 = 
	`nvme_subm™_u£r_cmd
(
ns
->
queue
, &
c
,

1663 
Ãxt_m­pšg_addr
, 
un™_Ën
, 
NULL
, 0);

1664 ià(
nvme_sc
)

1667 
nvme_off£t
 +ğ
un™_num_blocks
;

1670  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

1671 
	}
}

1676 
	$nvme_Œªs_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
, 
u8
 
is_wr™e
,

1677 
u8
 *
cmd
)

1679 
»s
 = 0;

1680 
nvme_Œªs_io_cdb
 
cdb_šfo
 = { 0, };

1681 
u8
 
İcode
 = 
cmd
[0];

1682 
u64
 
xãr_by‹s
;

1683 
u64
 
sum_iov_Ën
 = 0;

1684 
sg_iovec
 
sgl
;

1685 
i
;

1686 
size_t
 
nÙ_cİ›d
;

1692 
İcode
) {

1693 
WRITE_6
:

1694 
READ_6
:

1697 
cdb_šfo
.
fua
 = 
cmd
[1] & 0x8;

1698 
cdb_šfo
.
´Ù_šfo
 = (
cmd
[1] & 0xe0) >> 5;

1699 ià(
cdb_šfo
.
´Ù_šfo
 && !
ns
->
pi_ty³
) {

1700  
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1701 
SAM_STAT_CHECK_CONDITION
,

1702 
ILLEGAL_REQUEST
,

1703 
SCSI_ASC_INVALID_CDB
,

1704 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1708 
İcode
) {

1709 
WRITE_6
:

1710 
READ_6
:

1711 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[1]);

1712 
cdb_šfo
.
xãr_Ën
 = 
cmd
[4];

1713 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1714 
cdb_šfo
.
xãr_Ën
 = 256;

1716 
WRITE_10
:

1717 
READ_10
:

1718 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1719 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1721 
WRITE_12
:

1722 
READ_12
:

1723 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[2]);

1724 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

1726 
WRITE_16
:

1727 
READ_16
:

1728 
cdb_šfo
.
lba
 = 
	`g‘_uÇligÃd_be64
(&
cmd
[2]);

1729 
cdb_šfo
.
xãr_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

1733 
»s
 = -
EIO
;

1734 
out
;

1738 ià(
hdr
->
iovec_couÁ
 > 0) {

1739 
i
 = 0; i < 
hdr
->
iovec_couÁ
; i++) {

1740 
nÙ_cİ›d
 = 
	`cİy_äom_u£r
(&
sgl
, 
hdr
->
dxã½
 +

1741 
i
 * (
sg_iovec
),

1742 (
sg_iovec
));

1743 ià(
nÙ_cİ›d
)

1744  -
EFAULT
;

1745 
sum_iov_Ën
 +ğ
sgl
.
iov_Ën
;

1747 ià(
sgl
.
iov_Ën
 % (1 << 
ns
->
lba_shiá
) != 0) {

1748 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1749 
SAM_STAT_CHECK_CONDITION
,

1750 
ILLEGAL_REQUEST
,

1751 
SCSI_ASC_INVALID_PARAMETER
,

1752 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1753 
out
;

1757 
sum_iov_Ën
 = 
hdr
->
dxãr_Ën
;

1761 
xãr_by‹s
 = 
	`mš
(((
u64
)
hdr
->
dxãr_Ën
), 
sum_iov_Ën
);

1764 ià(
xãr_by‹s
 !ğ(
cdb_šfo
.
xãr_Ën
 << 
ns
->
lba_shiá
)) {

1765 
»s
 = -
EINVAL
;

1766 
out
;

1770 ià(
cdb_šfo
.
xãr_Ën
 == 0)

1771 
out
;

1774 
»s
 = 
	`nvme_Œªs_do_nvme_io
(
ns
, 
hdr
, &
cdb_šfo
, 
is_wr™e
);

1775 ià(
»s
)

1776 
out
;

1778 
out
:

1779  
»s
;

1780 
	}
}

1782 
	$nvme_Œªs_šquœy
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1783 
u8
 *
cmd
)

1785 
»s
 = 0;

1786 
u8
 
evpd
;

1787 
u8
 
·ge_code
;

1788 
®loc_Ën
;

1789 
u8
 *
šq_»¥Ú£
;

1791 
evpd
 = 
cmd
[1] & 0x01;

1792 
·ge_code
 = 
cmd
[2];

1793 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[3]);

1795 
šq_»¥Ú£
 = 
	`km®loc
(
	`max
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
),

1796 
GFP_KERNEL
);

1797 ià(
šq_»¥Ú£
 =ğ
NULL
) {

1798 
»s
 = -
ENOMEM
;

1799 
out_mem
;

1802 ià(
evpd
 == 0) {

1803 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

1804 
»s
 = 
	`nvme_Œªs_¡ªd¬d_šquœy_·ge
(
ns
, 
hdr
,

1805 
šq_»¥Ú£
, 
®loc_Ën
);

1807 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1808 
SAM_STAT_CHECK_CONDITION
,

1809 
ILLEGAL_REQUEST
,

1810 
SCSI_ASC_INVALID_CDB
,

1811 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1814 
·ge_code
) {

1815 
VPD_SUPPORTED_PAGES
:

1816 
»s
 = 
	`nvme_Œªs_suµÜ‹d_vpd_·ges
(
ns
, 
hdr
,

1817 
šq_»¥Ú£
, 
®loc_Ën
);

1819 
VPD_SERIAL_NUMBER
:

1820 
»s
 = 
	`nvme_Œªs_un™_£rŸl_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1821 
®loc_Ën
);

1823 
VPD_DEVICE_IDENTIFIERS
:

1824 
»s
 = 
	`nvme_Œªs_deviû_id_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1825 
®loc_Ën
);

1827 
VPD_EXTENDED_INQUIRY
:

1828 
»s
 = 
	`nvme_Œªs_ext_šq_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1830 
VPD_BLOCK_LIMITS
:

1831 
»s
 = 
	`nvme_Œªs_bdev_lim™s_·ge
(
ns
, 
hdr
, 
šq_»¥Ú£
,

1832 
®loc_Ën
);

1834 
VPD_BLOCK_DEV_CHARACTERISTICS
:

1835 
»s
 = 
	`nvme_Œªs_bdev_ch¬_·ge
(
ns
, 
hdr
, 
®loc_Ën
);

1838 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

1839 
SAM_STAT_CHECK_CONDITION
,

1840 
ILLEGAL_REQUEST
,

1841 
SCSI_ASC_INVALID_CDB
,

1842 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1846 
	`kä“
(
šq_»¥Ú£
);

1847 
out_mem
:

1848  
»s
;

1849 
	}
}

1851 
	$nvme_Œªs_log_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1852 
u8
 *
cmd
)

1854 
»s
;

1855 
u16
 
®loc_Ën
;

1856 
u8
 
pc
;

1857 
u8
 
·ge_code
;

1859 ià(
cmd
[1] !ğ
LOG_SENSE_CDB_SP_NOT_ENABLED
) {

1860 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1861 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1862 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1863 
out
;

1866 
·ge_code
 = 
cmd
[2] & 
LOG_SENSE_CDB_PAGE_CODE_MASK
;

1867 
pc
 = (
cmd
[2] & 
LOG_SENSE_CDB_PC_MASK
è>> 
LOG_SENSE_CDB_PC_SHIFT
;

1868 ià(
pc
 !ğ
LOG_SENSE_CDB_PC_CUMULATIVE_VALUES
) {

1869 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1870 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1871 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1872 
out
;

1874 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1875 
·ge_code
) {

1876 
LOG_PAGE_SUPPORTED_LOG_PAGES_PAGE
:

1877 
»s
 = 
	`nvme_Œªs_log_suµ_·ges
(
ns
, 
hdr
, 
®loc_Ën
);

1879 
LOG_PAGE_INFORMATIONAL_EXCEPTIONS_PAGE
:

1880 
»s
 = 
	`nvme_Œªs_log_šfo_exû±iÚs
(
ns
, 
hdr
, 
®loc_Ën
);

1882 
LOG_PAGE_TEMPERATURE_PAGE
:

1883 
»s
 = 
	`nvme_Œªs_log_‹m³¿tu»
(
ns
, 
hdr
, 
®loc_Ën
);

1886 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1887 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1888 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1892 
out
:

1893  
»s
;

1894 
	}
}

1896 
	$nvme_Œªs_mode_£Ëù
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1897 
u8
 *
cmd
)

1899 
u8
 
cdb10
 = 0;

1900 
u16
 
·rm_li¡_Ën
;

1901 
u8
 
·ge_fÜm©
;

1902 
u8
 
§ve_·ges
;

1904 
·ge_fÜm©
 = 
cmd
[1] & 
MODE_SELECT_CDB_PAGE_FORMAT_MASK
;

1905 
§ve_·ges
 = 
cmd
[1] & 
MODE_SELECT_CDB_SAVE_PAGES_MASK
;

1907 ià(
cmd
[0] =ğ
MODE_SELECT
) {

1908 
·rm_li¡_Ën
 = 
cmd
[4];

1910 
·rm_li¡_Ën
 = 
cmd
[7];

1911 
cdb10
 = 1;

1914 ià(
·rm_li¡_Ën
 != 0) {

1919  
	`nvme_Œªs_mode£l_d©a
(
ns
, 
hdr
, 
cmd
, 
·rm_li¡_Ën
,

1920 
·ge_fÜm©
, 
§ve_·ges
, 
cdb10
);

1924 
	}
}

1926 
	$nvme_Œªs_mode_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1927 
u8
 *
cmd
)

1929 
»s
 = 0;

1930 
u16
 
®loc_Ën
;

1931 
u8
 
cdb10
 = 0;

1933 ià(
cmd
[0] =ğ
MODE_SENSE
) {

1934 
®loc_Ën
 = 
cmd
[4];

1936 
®loc_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

1937 
cdb10
 = 1;

1940 ià((
cmd
[2] & 
MODE_SENSE_PAGE_CONTROL_MASK
) !=

1941 
MODE_SENSE_PC_CURRENT_VALUES
) {

1942 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1943 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1944 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1945 
out
;

1948 
cmd
[2] & 
MODE_SENSE_PAGE_CODE_MASK
) {

1949 
MODE_PAGE_CACHING
:

1950 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1951 
cdb10
,

1952 &
nvme_Œªs_fl_ÿchšg_·ge
,

1953 
MODE_PAGE_CACHING_LEN
);

1955 
MODE_PAGE_CONTROL
:

1956 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1957 
cdb10
,

1958 &
nvme_Œªs_fl_cÚŒŞ_·ge
,

1959 
MODE_PAGE_CONTROL_LEN
);

1961 
MODE_PAGE_POWER_CONDITION
:

1962 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1963 
cdb10
,

1964 &
nvme_Œªs_fl_pow_úd_·ge
,

1965 
MODE_PAGE_POW_CND_LEN
);

1967 
MODE_PAGE_INFO_EXCEP
:

1968 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1969 
cdb10
,

1970 &
nvme_Œªs_fl_šf_exc_·ge
,

1971 
MODE_PAGE_INF_EXC_LEN
);

1973 
MODE_PAGE_RETURN_ALL
:

1974 
»s
 = 
	`nvme_Œªs_mode_·ge_ü—‹
(
ns
, 
hdr
, 
cmd
, 
®loc_Ën
,

1975 
cdb10
,

1976 &
nvme_Œªs_fl_®l_·ges
,

1977 
MODE_PAGE_ALL_LEN
);

1980 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

1981 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

1982 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

1986 
out
:

1987  
»s
;

1988 
	}
}

1990 
	$nvme_Œªs_»ad_ÿ·c™y
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

1991 
u8
 *
cmd
, u8 
cdb16
)

1993 
»s
;

1994 
nvme_sc
;

1995 
u32
 
®loc_Ën
;

1996 
u32
 
»¥_size
;

1997 
u32
 
xãr_Ën
;

1998 
nvme_id_ns
 *
id_ns
;

1999 
u8
 *
»¥Ú£
;

2001 ià(
cdb16
) {

2002 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[10]);

2003 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

2005 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

2006 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

2009 
nvme_sc
 = 
	`nvme_id’tify_ns
(
ns
->
ù¾
,‚s->
ns_id
, &
id_ns
);

2010 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2011 ià(
»s
)

2012  
»s
;

2014 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2015 ià(
»¥Ú£
 =ğ
NULL
) {

2016 
»s
 = -
ENOMEM
;

2017 
out_ä“_id
;

2019 
	`nvme_Œªs_fl_»ad_ÿp
(
»¥Ú£
, 
id_ns
, 
cdb16
);

2021 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2022 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2024 
	`kä“
(
»¥Ú£
);

2025 
out_ä“_id
:

2026 
	`kä“
(
id_ns
);

2027  
»s
;

2028 
	}
}

2030 
	$nvme_Œªs_»pÜt_luns
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2031 
u8
 *
cmd
)

2033 
»s
;

2034 
nvme_sc
;

2035 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2036 
u8
 *
»¥Ú£
;

2037 
nvme_id_ù¾
 *
id_ù¾
;

2038 
u32
 
Î_Ëngth
, 
lun_id
;

2039 
u8
 
lun_id_off£t
 = 
REPORT_LUNS_FIRST_LUN_OFFSET
;

2040 
__be32
 
tmp_Ën
;

2042 
cmd
[2]) {

2044  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2045 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2046 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2047 
ALL_LUNS_RETURNED
:

2048 
ALL_WELL_KNOWN_LUNS_RETURNED
:

2049 
RESTRICTED_LUNS_RETURNED
:

2050 
nvme_sc
 = 
	`nvme_id’tify_ù¾
(
ns
->
ù¾
, &
id_ù¾
);

2051 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2052 ià(
»s
)

2053  
»s
;

2055 
Î_Ëngth
 = 
	`Ë32_to_ıu
(
id_ù¾
->
Â
è* 
LUN_ENTRY_SIZE
;

2056 
»¥_size
 = 
Î_Ëngth
 + 
LUN_DATA_HEADER_SIZE
;

2058 
®loc_Ën
 = 
	`g‘_uÇligÃd_be32
(&
cmd
[6]);

2059 ià(
®loc_Ën
 < 
»¥_size
) {

2060 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
,

2061 
SAM_STAT_CHECK_CONDITION
,

2062 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2063 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2064 
out_ä“_id
;

2067 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2068 ià(
»¥Ú£
 =ğ
NULL
) {

2069 
»s
 = -
ENOMEM
;

2070 
out_ä“_id
;

2074 
lun_id
 = 0;†un_id < 
	`Ë32_to_ıu
(
id_ù¾
->
Â
);†un_id++) {

2079 
__be64
 
tmp_id
 = 
	`ıu_to_be64
(
lun_id
);

2080 
	`memıy
(&
»¥Ú£
[
lun_id_off£t
], &
tmp_id
, (
u64
));

2081 
lun_id_off£t
 +ğ
LUN_ENTRY_SIZE
;

2083 
tmp_Ën
 = 
	`ıu_to_be32
(
Î_Ëngth
);

2084 
	`memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

2087 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2088 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2090 
	`kä“
(
»¥Ú£
);

2091 
out_ä“_id
:

2092 
	`kä“
(
id_ù¾
);

2093  
»s
;

2094 
	}
}

2096 
	$nvme_Œªs_»que¡_£n£
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2097 
u8
 *
cmd
)

2099 
»s
;

2100 
u8
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

2101 
u8
 
desc_fÜm©
;

2102 
u8
 *
»¥Ú£
;

2104 
desc_fÜm©
 = 
cmd
[1] & 0x01;

2105 
®loc_Ën
 = 
cmd
[4];

2107 
»¥_size
 = ((
desc_fÜm©
è? (
DESC_FMT_SENSE_DATA_SIZE
) :

2108 (
FIXED_FMT_SENSE_DATA_SIZE
));

2109 
»¥Ú£
 = 
	`kz®loc
(
»¥_size
, 
GFP_KERNEL
);

2110 ià(
»¥Ú£
 =ğ
NULL
) {

2111 
»s
 = -
ENOMEM
;

2112 
out
;

2115 ià(
desc_fÜm©
) {

2117 
»¥Ú£
[0] = 
DESC_FORMAT_SENSE_DATA
;

2118 
»¥Ú£
[1] = 
NO_SENSE
;

2120 
»¥Ú£
[2] = 
SCSI_ASC_NO_SENSE
;

2121 
»¥Ú£
[3] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2125 
»¥Ú£
[0] = 
FIXED_SENSE_DATA
;

2127 
»¥Ú£
[2] = 
NO_SENSE
;

2129 
»¥Ú£
[7] = 
FIXED_SENSE_DATA_ADD_LENGTH
;

2131 
»¥Ú£
[12] = 
SCSI_ASC_NO_SENSE
;

2132 
»¥Ú£
[13] = 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
;

2137 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

2138 
»s
 = 
	`nvme_Œªs_cİy_to_u£r
(
hdr
, 
»¥Ú£
, 
xãr_Ën
);

2140 
	`kä“
(
»¥Ú£
);

2141 
out
:

2142  
»s
;

2143 
	}
}

2145 
	$nvme_Œªs_£cur™y_´ÙocŞ
(
nvme_ns
 *
ns
,

2146 
sg_io_hdr
 *
hdr
,

2147 
u8
 *
cmd
)

2149  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2150 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2151 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2152 
	}
}

2154 
	$nvme_Œªs_synchrÚize_ÿche
(
nvme_ns
 *
ns
,

2155 
sg_io_hdr
 *
hdr
)

2157 
nvme_sc
;

2158 
nvme_commªd
 
c
;

2160 
	`mem£t
(&
c
, 0, (c));

2161 
c
.
commÚ
.
İcode
 = 
nvme_cmd_æush
;

2162 
c
.
commÚ
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2164 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
NULL
, 0);

2165  
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2166 
	}
}

2168 
	$nvme_Œªs_¡¬t_¡İ
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2169 
u8
 *
cmd
)

2171 
u8
 
immed
, 
pcmod
, 
no_æush
, 
¡¬t
;

2173 
immed
 = 
cmd
[1] & 0x01;

2174 
pcmod
 = 
cmd
[3] & 0x0f;

2175 
no_æush
 = 
cmd
[4] & 0x04;

2176 
¡¬t
 = 
cmd
[4] & 0x01;

2178 ià(
immed
 != 0) {

2179  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2180 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2181 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2183 ià(
no_æush
 == 0) {

2185 
»s
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2186 ià(
»s
)

2187  
»s
;

2192 
	}
}

2194 
	$nvme_Œªs_fÜm©_un™
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2195 
u8
 *
cmd
)

2197 
»s
;

2198 
u8
 
·rm_hdr_Ën
 = 0;

2199 
u8
 
nvme_pf_code
 = 0;

2200 
u8
 
fÜm©_´Ù_šfo
, 
lÚg_li¡
, 
fÜm©_d©a
;

2202 
fÜm©_´Ù_šfo
 = (
cmd
[1] & 0xc0) >> 6;

2203 
lÚg_li¡
 = 
cmd
[1] & 0x20;

2204 
fÜm©_d©a
 = 
cmd
[1] & 0x10;

2206 ià(
fÜm©_d©a
 != 0) {

2207 ià(
fÜm©_´Ù_šfo
 != 0) {

2208 ià(
lÚg_li¡
 == 0)

2209 
·rm_hdr_Ën
 = 
FORMAT_UNIT_SHORT_PARM_LIST_LEN
;

2211 
·rm_hdr_Ën
 = 
FORMAT_UNIT_LONG_PARM_LIST_LEN
;

2213 } ià(
fÜm©_d©a
 =ğ0 && 
fÜm©_´Ù_šfo
 != 0) {

2214 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2215 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2216 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2217 
out
;

2225 ià(
·rm_hdr_Ën
 > 0) {

2226 
»s
 = 
	`nvme_Œªs_fmt_g‘_·rm_h—d”
(
hdr
, 
·rm_hdr_Ën
,

2227 
fÜm©_´Ù_šfo
, &
nvme_pf_code
);

2228 ià(
»s
)

2229 
out
;

2233 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 0);

2236 
»s
 = 
	`nvme_Œªs_fmt_£t_blk_size_couÁ
(
ns
, 
hdr
);

2237 ià(
»s
)

2238 
out
;

2240 
»s
 = 
	`nvme_Œªs_fmt_£nd_cmd
(
ns
, 
hdr
, 
nvme_pf_code
);

2242 
out
:

2243  
»s
;

2244 
	}
}

2246 
	$nvme_Œªs_‹¡_un™_»ady
(
nvme_ns
 *
ns
,

2247 
sg_io_hdr
 *
hdr
,

2248 
u8
 *
cmd
)

2250 ià(
	`nvme_ù¾_»ady
(
ns
->
ù¾
))

2251  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2252 
NOT_READY
, 
SCSI_ASC_LUN_NOT_READY
,

2253 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2255  
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_GOOD
, 
NO_SENSE
, 0, 0);

2256 
	}
}

2258 
	$nvme_Œªs_wr™e_bufãr
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2259 
u8
 *
cmd
)

2261 
»s
 = 0;

2262 
u32
 
bufãr_off£t
, 
·rm_li¡_Ëngth
;

2263 
u8
 
bufãr_id
, 
mode
;

2265 
·rm_li¡_Ëngth
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[6]);

2266 ià(
·rm_li¡_Ëngth
 % 
BYTES_TO_DWORDS
 != 0) {

2268 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2269 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2270 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2271 
out
;

2273 
bufãr_id
 = 
cmd
[2];

2274 ià(
bufãr_id
 > 
NVME_MAX_FIRMWARE_SLOT
) {

2275 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2276 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2277 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2278 
out
;

2280 
mode
 = 
cmd
[1] & 0x1f;

2281 
bufãr_off£t
 = 
	`g‘_uÇligÃd_be24
(&
cmd
[3]);

2283 
mode
) {

2284 
DOWNLOAD_SAVE_ACTIVATE
:

2285 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2286 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2287 
bufãr_id
);

2288 ià(
»s
)

2289 
out
;

2290 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2292 
DOWNLOAD_SAVE_DEFER_ACTIVATE
:

2293 
»s
 = 
	`nvme_Œªs_£nd_dowÆßd_fw_cmd
(
ns
, 
hdr
, 
nvme_admš_dowÆßd_fw
,

2294 
·rm_li¡_Ëngth
, 
bufãr_off£t
,

2295 
bufãr_id
);

2297 
ACTIVATE_DEFERRED_MICROCODE
:

2298 
»s
 = 
	`nvme_Œªs_£nd_aùiv©e_fw_cmd
(
ns
, 
hdr
, 
bufãr_id
);

2301 
»s
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2302 
ILLEGAL_REQUEST
, 
SCSI_ASC_INVALID_CDB
,

2303 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2307 
out
:

2308  
»s
;

2309 
	}
}

2311 
	sscsi_unm­_blk_desc
 {

2312 
__be64
 
	m¦ba
;

2313 
__be32
 
	mÆb
;

2314 
u32
 
	m»sv
;

2317 
	sscsi_unm­_·rm_li¡
 {

2318 
__be16
 
	munm­_d©a_Ën
;

2319 
__be16
 
	munm­_blk_desc_d©a_Ën
;

2320 
u32
 
	m»sv
;

2321 
scsi_unm­_blk_desc
 
	mdesc
[0];

2324 
	$nvme_Œªs_unm­
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
,

2325 
u8
 *
cmd
)

2327 
scsi_unm­_·rm_li¡
 *
¶i¡
;

2328 
nvme_dsm_¿nge
 *
¿nge
;

2329 
nvme_commªd
 
c
;

2330 
i
, 
nvme_sc
, 
»s
;

2331 
u16
 
ndesc
, 
li¡_Ën
;

2333 
li¡_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
[7]);

2334 ià(!
li¡_Ën
)

2335  -
EINVAL
;

2337 
¶i¡
 = 
	`km®loc
(
li¡_Ën
, 
GFP_KERNEL
);

2338 ià(!
¶i¡
)

2339  -
ENOMEM
;

2341 
»s
 = 
	`nvme_Œªs_cİy_äom_u£r
(
hdr
, 
¶i¡
, 
li¡_Ën
);

2342 ià(
»s
)

2343 
out
;

2345 
ndesc
 = 
	`be16_to_ıu
(
¶i¡
->
unm­_blk_desc_d©a_Ën
) >> 4;

2346 ià(!
ndesc
 ||‚desc > 256) {

2347 
»s
 = -
EINVAL
;

2348 
out
;

2351 
¿nge
 = 
	`kÿÎoc
(
ndesc
, (*¿nge), 
GFP_KERNEL
);

2352 ià(!
¿nge
) {

2353 
»s
 = -
ENOMEM
;

2354 
out
;

2357 
i
 = 0; i < 
ndesc
; i++) {

2358 
¿nge
[
i
].
Æb
 = 
	`ıu_to_Ë32
(
	`be32_to_ıu
(
¶i¡
->
desc
[i].nlb));

2359 
¿nge
[
i
].
¦ba
 = 
	`ıu_to_Ë64
(
	`be64_to_ıu
(
¶i¡
->
desc
[i].slba));

2360 
¿nge
[
i
].
ÿ‰r
 = 0;

2363 
	`mem£t
(&
c
, 0, (c));

2364 
c
.
dsm
.
İcode
 = 
nvme_cmd_dsm
;

2365 
c
.
dsm
.
nsid
 = 
	`ıu_to_Ë32
(
ns
->
ns_id
);

2366 
c
.
dsm
.
Ä
 = 
	`ıu_to_Ë32
(
ndesc
 - 1);

2367 
c
.
dsm
.
©Œibu‹s
 = 
	`ıu_to_Ë32
(
NVME_DSMGMT_AD
);

2369 
nvme_sc
 = 
	`nvme_subm™_sync_cmd
(
ns
->
queue
, &
c
, 
¿nge
,

2370 
ndesc
 * (*
¿nge
));

2371 
»s
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
nvme_sc
);

2373 
	`kä“
(
¿nge
);

2374 
out
:

2375 
	`kä“
(
¶i¡
);

2376  
»s
;

2377 
	}
}

2379 
	$nvme_scsi_Œª¦©e
(
nvme_ns
 *
ns
, 
sg_io_hdr
 *
hdr
)

2381 
u8
 
cmd
[
BLK_MAX_CDB
];

2382 
»tcode
;

2383 
İcode
;

2385 ià(
hdr
->
cmdp
 =ğ
NULL
)

2386  -
EMSGSIZE
;

2387 ià(
	`cİy_äom_u£r
(
cmd
, 
hdr
->
cmdp
, hdr->
cmd_Ën
))

2388  -
EFAULT
;

2394 
»tcode
 = 
	`nvme_Œªs_¡©us_code
(
hdr
, 
NVME_SC_SUCCESS
);

2395 ià(
»tcode
)

2396  
»tcode
;

2398 
İcode
 = 
cmd
[0];

2400 
İcode
) {

2401 
READ_6
:

2402 
READ_10
:

2403 
READ_12
:

2404 
READ_16
:

2405 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 0, 
cmd
);

2407 
WRITE_6
:

2408 
WRITE_10
:

2409 
WRITE_12
:

2410 
WRITE_16
:

2411 
»tcode
 = 
	`nvme_Œªs_io
(
ns
, 
hdr
, 1, 
cmd
);

2413 
INQUIRY
:

2414 
»tcode
 = 
	`nvme_Œªs_šquœy
(
ns
, 
hdr
, 
cmd
);

2416 
LOG_SENSE
:

2417 
»tcode
 = 
	`nvme_Œªs_log_£n£
(
ns
, 
hdr
, 
cmd
);

2419 
MODE_SELECT
:

2420 
MODE_SELECT_10
:

2421 
»tcode
 = 
	`nvme_Œªs_mode_£Ëù
(
ns
, 
hdr
, 
cmd
);

2423 
MODE_SENSE
:

2424 
MODE_SENSE_10
:

2425 
»tcode
 = 
	`nvme_Œªs_mode_£n£
(
ns
, 
hdr
, 
cmd
);

2427 
READ_CAPACITY
:

2428 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 0);

2430 
SERVICE_ACTION_IN_16
:

2431 
cmd
[1]) {

2432 
SAI_READ_CAPACITY_16
:

2433 
»tcode
 = 
	`nvme_Œªs_»ad_ÿ·c™y
(
ns
, 
hdr
, 
cmd
, 1);

2436 
out
;

2439 
REPORT_LUNS
:

2440 
»tcode
 = 
	`nvme_Œªs_»pÜt_luns
(
ns
, 
hdr
, 
cmd
);

2442 
REQUEST_SENSE
:

2443 
»tcode
 = 
	`nvme_Œªs_»que¡_£n£
(
ns
, 
hdr
, 
cmd
);

2445 
SECURITY_PROTOCOL_IN
:

2446 
SECURITY_PROTOCOL_OUT
:

2447 
»tcode
 = 
	`nvme_Œªs_£cur™y_´ÙocŞ
(
ns
, 
hdr
, 
cmd
);

2449 
START_STOP
:

2450 
»tcode
 = 
	`nvme_Œªs_¡¬t_¡İ
(
ns
, 
hdr
, 
cmd
);

2452 
SYNCHRONIZE_CACHE
:

2453 
»tcode
 = 
	`nvme_Œªs_synchrÚize_ÿche
(
ns
, 
hdr
);

2455 
FORMAT_UNIT
:

2456 
»tcode
 = 
	`nvme_Œªs_fÜm©_un™
(
ns
, 
hdr
, 
cmd
);

2458 
TEST_UNIT_READY
:

2459 
»tcode
 = 
	`nvme_Œªs_‹¡_un™_»ady
(
ns
, 
hdr
, 
cmd
);

2461 
WRITE_BUFFER
:

2462 
»tcode
 = 
	`nvme_Œªs_wr™e_bufãr
(
ns
, 
hdr
, 
cmd
);

2464 
UNMAP
:

2465 
»tcode
 = 
	`nvme_Œªs_unm­
(
ns
, 
hdr
, 
cmd
);

2468 
out
:

2469 
»tcode
 = 
	`nvme_Œªs_com¶‘iÚ
(
hdr
, 
SAM_STAT_CHECK_CONDITION
,

2470 
ILLEGAL_REQUEST
, 
SCSI_ASC_ILLEGAL_COMMAND
,

2471 
SCSI_ASCQ_CAUSE_NOT_REPORTABLE
);

2474  
»tcode
;

2475 
	}
}

2477 
	$nvme_sg_io
(
nvme_ns
 *
ns
, 
sg_io_hdr
 
__u£r
 *
u_hdr
)

2479 
sg_io_hdr
 
hdr
;

2480 
»tcode
;

2482 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2483  -
EACCES
;

2484 ià(
	`cİy_äom_u£r
(&
hdr
, 
u_hdr
, (hdr)))

2485  -
EFAULT
;

2486 ià(
hdr
.
š‹rçû_id
 != 'S')

2487  -
EINVAL
;

2488 ià(
hdr
.
cmd_Ën
 > 
BLK_MAX_CDB
)

2489  -
EINVAL
;

2495 
»tcode
 = 
	`nvme_scsi_Œª¦©e
(
ns
, &
hdr
);

2496 ià(
»tcode
 < 0)

2497  
»tcode
;

2498 ià(
	`cİy_to_u£r
(
u_hdr
, &
hdr
, (
sg_io_hdr_t
)) > 0)

2499  -
EFAULT
;

2501 
	}
}

2503 
	$nvme_sg_g‘_v”siÚ_num
(
__u£r
 *

)

2505  
	`put_u£r
(
sg_v”siÚ_num
, 

);

2506 
	}
}

	@application/kvbench/bench/arch.h

18 #iâdeà
_JSAHN_ARCH_H


19 
	#_JSAHN_ARCH_H


	)

21 
	#__STDC_FORMAT_MACROS


	)

23 
	~<¡dio.h
>

24 
	~<fú.h
>

26 
	~"fÜe¡db_’dŸn.h
"

28 
	#_LARGE_FILE
 1

	)

29 #iâdeà
_FILE_OFFSET_BITS


30 
	#_FILE_OFFSET_BITS
 64

	)

31 #–ià(
_FILE_OFFSET_BITS
 != 64)

34 
	#_LARGEFILE_SOURCE
 1

	)

35 #iâdeà
O_LARGEFILE


36 
	#O_LARGEFILE
 0

	)

39 #iâdeà
_MSC_VER


40 
	~<¡dboŞ.h
>

42 #iâdeà
__ılu¥lus


43 #´agm¨
Úû


44 
	#çl£
 (0)

	)

45 
	#Œue
 (1)

	)

46 
	#boŞ
 

	)

50 #ifdeà
__APPLE__


51 
	~<š‰y³s.h
>

52 
	~<®loÿ.h
>

53 
	~<T¬g‘CÚd™iÚ®s.h
>

55 
	#INLINE
 
šlše


	)

57 
	#_X64
 "Îx"

	)

58 
	#_F64
 "Îd"

	)

59 
	#_FSEC
 "ld"

	)

60 
	#_FUSEC
 "d"

	)

62 
	#_ARCH_O_DIRECT
 (0x0)

	)

64 #ià
TARGET_CPU_ARM


65 
	#_ALIGN_MEM_ACCESS


	)

68 
	#m®loc_®ign
(
addr
, 
®ign
, 
size
) \

69 {
__»t__
=0; __»t__=
	`posix_mem®ign
(&(
addr
), (
®ign
), (
size
));}

	)

70 
	#ä“_®ign
(
addr
è
	`ä“
×ddr)

	)

72 #iâdeà
¥š_t


74 
	~<libk”n/OSAtomic.h
>

75 
	#¥š_t
 
OSSpšLock


	)

76 
	#¥š_lock
(
¬g
è
	`OSSpšLockLock
×rg)

	)

77 
	#¥š_uÆock
(
¬g
è
	`OSSpšLockUÆock
×rg)

	)

78 
	#SPIN_INITIALIZER
 (
¥š_t
)(0)

	)

79 
	#¥š_š™
(
¬g
è*×rgèğ(
¥š_t
)(0)

	)

80 
	#¥š_de¡roy
(
¬g
)

	)

82 #iâdeà
mu‹x_t


84 
	~<±h»ad.h
>

85 
	#mu‹x_t
 
±h»ad_mu‹x_t


	)

86 
	#mu‹x_š™
(
¬g
è
	`±h»ad_mu‹x_š™
×rg, 
NULL
)

	)

87 
	#mu‹x_lock
(
¬g
è
	`±h»ad_mu‹x_lock
×rg)

	)

88 
	#mu‹x_uÆock
(
¬g
è
	`±h»ad_mu‹x_uÆock
×rg)

	)

89 
	#MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

90 
	#mu‹x_de¡roy
(
¬g
è
	`±h»ad_mu‹x_de¡roy
×rg)

	)

92 #iâdeà
th»ad_t


94 
	~<±h»ad.h
>

95 
	#th»ad_t
 
±h»ad_t


	)

96 
	#th»ad_cÚd_t
 
±h»ad_cÚd_t


	)

97 
	#th»ad_ü—‹
(
tid
, 
func
, 
¬gs
) \

98 
	`±h»ad_ü—‹
((
tid
), 
NULL
, (
func
), (
¬gs
))

	)

99 
	#th»ad_još
(
tid
, 
»t
è
	`±h»ad_još
Ñid,„‘)

	)

100 
	#th»ad_ÿnûl
(
tid
è
	`±h»ad_ÿnûl
Ñid)

	)

101 
	#th»ad_ex™
(
code
è
	`±h»ad_ex™
(code)

	)

102 
	#th»ad_cÚd_š™
(
cÚd
è
	`±h»ad_cÚd_š™
(cÚd, 
NULL
)

	)

103 
	#th»ad_cÚd_de¡roy
(
cÚd
è
	`±h»ad_cÚd_de¡roy
(cÚd)

	)

104 
	#th»ad_cÚd_wa™
(
cÚd
, 
mu‹x
è
	`±h»ad_cÚd_wa™
(cÚd, mu‹x)

	)

105 
	#th»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
ms
) \

107 
time¥ec
 
ts
 = 
	`cÚv”t_»Éime_to_ab¡ime
(
ms
); \

108 
	`±h»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, &
ts
); \

109 }

	)

110 
	#th»ad_cÚd_sigÇl
(
cÚd
è
	`±h»ad_cÚd_sigÇl
(cÚd)

	)

111 
	#th»ad_cÚd_brßdÿ¡
(
cÚd
è
	`±h»ad_cÚd_brßdÿ¡
(cÚd)

	)

114 #–ià
__ANDROID__


115 
	~<š‰y³s.h
>

116 
	~<®loÿ.h
>

118 
	#INLINE
 
__šlše


	)

120 
	#_X64
 "Îx"

	)

121 
	#_F64
 "Îd"

	)

122 
	#_FSEC
 "ld"

	)

123 
	#_FUSEC
 "ld"

	)

125 
	#_ARCH_O_DIRECT
 (
O_DIRECT
)

	)

126 
	#m®loc_®ign
(
addr
, 
®ign
, 
size
) \

127 (
addr
 = 
	`mem®ign
((
®ign
), (
size
)))

	)

128 
	#ä“_®ign
(
addr
è
	`ä“
×ddr)

	)

130 #iâdeà
¥š_t


132 
	~<±h»ad.h
>

133 
	#¥š_t
 
±h»ad_mu‹x_t


	)

134 
	#¥š_š™
(
¬g
è
	`±h»ad_mu‹x_š™
×rg, 
NULL
)

	)

135 
	#¥š_lock
(
¬g
è
	`±h»ad_mu‹x_lock
×rg)

	)

136 
	#¥š_uÆock
(
¬g
è
	`±h»ad_mu‹x_uÆock
×rg)

	)

137 
	#¥š_de¡roy
(
¬g
è
	`±h»ad_mu‹x_de¡roy
×rg)

	)

138 
	#SPIN_INITIALIZER
 ((
¥š_t
)
PTHREAD_MUTEX_INITIALIZER
)

	)

140 #iâdeà
mu‹x_t


142 
	~<±h»ad.h
>

143 
	#mu‹x_t
 
±h»ad_mu‹x_t


	)

144 
	#mu‹x_š™
(
¬g
è
	`±h»ad_mu‹x_š™
×rg, 
NULL
)

	)

145 
	#mu‹x_lock
(
¬g
è
	`±h»ad_mu‹x_lock
×rg)

	)

146 
	#mu‹x_uÆock
(
¬g
è
	`±h»ad_mu‹x_uÆock
×rg)

	)

147 
	#MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

148 
	#mu‹x_de¡roy
(
¬g
è
	`±h»ad_mu‹x_de¡roy
×rg)

	)

150 #iâdeà
th»ad_t


152 
	~<±h»ad.h
>

153 
	#th»ad_t
 
±h»ad_t


	)

154 
	#th»ad_cÚd_t
 
±h»ad_cÚd_t


	)

155 
	#th»ad_ü—‹
(
tid
, 
func
, 
¬gs
) \

156 
	`±h»ad_ü—‹
((
tid
), 
NULL
, (
func
), (
¬gs
))

	)

157 
	#th»ad_još
(
tid
, 
»t
è
	`±h»ad_još
Ñid,„‘)

	)

158 
	#th»ad_ÿnûl
(
tid
è
	`±h»ad_ÿnûl
Ñid)

	)

159 
	#th»ad_ex™
(
code
è
	`±h»ad_ex™
(code)

	)

160 
	#th»ad_cÚd_š™
(
cÚd
è
	`±h»ad_cÚd_š™
(cÚd, 
NULL
)

	)

161 
	#th»ad_cÚd_de¡roy
(
cÚd
è
	`±h»ad_cÚd_de¡roy
(cÚd)

	)

162 
	#th»ad_cÚd_wa™
(
cÚd
, 
mu‹x
è
	`±h»ad_cÚd_wa™
(cÚd, mu‹x)

	)

163 
	#th»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
ms
) \

165 
time¥ec
 
ts
 = 
	`cÚv”t_»Éime_to_ab¡ime
(
ms
); \

166 
	`±h»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, &
ts
); \

167 }

	)

168 
	#th»ad_cÚd_sigÇl
(
cÚd
è
	`±h»ad_cÚd_sigÇl
(cÚd)

	)

169 
	#th»ad_cÚd_brßdÿ¡
(
cÚd
è
	`±h»ad_cÚd_brßdÿ¡
(cÚd)

	)

172 #ifdeà
as£¹


173 #undeà
as£¹


175 
	#as£¹
(
a
è×)

	)

177 #–ià
__lšux__


178 
	~<š‰y³s.h
>

179 
	~<®loÿ.h
>

181 
	#INLINE
 
__šlše


	)

183 
	#_X64
 
PRIx64


	)

184 
	#_F64
 
PRIu64


	)

185 
	#_FSEC
 "ld"

	)

186 
	#_FUSEC
 "ld"

	)

188 
	#_ARCH_O_DIRECT
 (
O_DIRECT
)

	)

190 
	#m®loc_®ign
(
addr
, 
®ign
, 
size
) \

191 {
__»t__
=0; __»t__=
	`posix_mem®ign
(&(
addr
), (
®ign
), (
size
));}

	)

192 
	#ä“_®ign
(
addr
è
	`ä“
×ddr)

	)

194 #iâdeà
¥š_t


196 
	~<±h»ad.h
>

197 
	#¥š_t
 
±h»ad_¥šlock_t


	)

198 
	#¥š_š™
(
¬g
è
	`±h»ad_¥š_š™
×rg, 
PTHREAD_PROCESS_SHARED
)

	)

199 
	#¥š_lock
(
¬g
è
	`±h»ad_¥š_lock
×rg)

	)

200 
	#¥š_uÆock
(
¬g
è
	`±h»ad_¥š_uÆock
×rg)

	)

201 
	#¥š_de¡roy
(
¬g
è
	`±h»ad_¥š_de¡roy
×rg)

	)

202 
	#SPIN_INITIALIZER
 (
¥š_t
)(1)

	)

204 #iâdeà
mu‹x_t


206 
	~<±h»ad.h
>

207 
	#mu‹x_t
 
±h»ad_mu‹x_t


	)

208 
	#mu‹x_š™
(
¬g
è
	`±h»ad_mu‹x_š™
×rg, 
NULL
)

	)

209 
	#mu‹x_lock
(
¬g
è
	`±h»ad_mu‹x_lock
×rg)

	)

210 
	#mu‹x_uÆock
(
¬g
è
	`±h»ad_mu‹x_uÆock
×rg)

	)

211 
	#MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

212 
	#mu‹x_de¡roy
(
¬g
è
	`±h»ad_mu‹x_de¡roy
×rg)

	)

214 #iâdeà
th»ad_t


216 
	~<±h»ad.h
>

217 
	#th»ad_t
 
±h»ad_t


	)

218 
	#th»ad_cÚd_t
 
±h»ad_cÚd_t


	)

219 
	#th»ad_ü—‹
(
tid
, 
func
, 
¬gs
) \

220 
	`±h»ad_ü—‹
((
tid
), 
NULL
, (
func
), (
¬gs
))

	)

221 
	#th»ad_još
(
tid
, 
»t
è
	`±h»ad_još
Ñid,„‘)

	)

222 
	#th»ad_ÿnûl
(
tid
è
	`±h»ad_ÿnûl
Ñid)

	)

223 
	#th»ad_ex™
(
code
è
	`±h»ad_ex™
(code)

	)

224 
	#th»ad_cÚd_š™
(
cÚd
è
	`±h»ad_cÚd_š™
(cÚd, 
NULL
)

	)

225 
	#th»ad_cÚd_de¡roy
(
cÚd
è
	`±h»ad_cÚd_de¡roy
(cÚd)

	)

226 
	#th»ad_cÚd_wa™
(
cÚd
, 
mu‹x
è
	`±h»ad_cÚd_wa™
(cÚd, mu‹x)

	)

227 
	#th»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
ms
) \

229 
time¥ec
 
ts
 = 
	`cÚv”t_»Éime_to_ab¡ime
(
ms
); \

230 
	`±h»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, &
ts
); \

231 }

	)

232 
	#th»ad_cÚd_sigÇl
(
cÚd
è
	`±h»ad_cÚd_sigÇl
(cÚd)

	)

233 
	#th»ad_cÚd_brßdÿ¡
(
cÚd
è
	`±h»ad_cÚd_brßdÿ¡
(cÚd)

	)

236 #–ià
defšed
(
WIN32
è|| defšed(
_WIN32
)

239 
	#_FSEC
 "ld"

	)

240 
	#_FUSEC
 "ld"

	)

242 
	#_ARCH_O_DIRECT
 (0x0)

	)

244 #ifdeà
_MSC_VER


246 
	~<Wšdows.h
>

247 
	~"g‘timeofday_vs.h
"

248 
	#INLINE
 
šlše


	)

250 
	#_X64
 "Îx"

	)

251 
	#_F64
 "Îu"

	)

252 
	#_CRT_SECURE_NO_WARNINGS


	)

253 
	#g‘timeofday
 
g‘timeofday_vs


	)

254 
	#¦“p
(
£c
è
	`SË•
((£c)*1000)

	)

255 
	tmode_t
;

256 
	~<Ba£Tsd.h
>

257 
SSIZE_T
 
	tssize_t
;

259 
	~<š‰y³s.h
>

260 
	~<wšdows.h
>

261 
	#_X64
 
PRIx64


	)

262 
	#_F64
 
PRIu64


	)

263 
	#INLINE
 
__šlše


	)

265 
	~<¡dšt.h
>

266 
	~<¡dlib.h
>

267 
	#m®loc_®ign
(
addr
, 
®ign
, 
size
) \

268 (
addr
 = (*)
	`_®igÃd_m®loc
((
size
), (
®ign
)))

	)

269 
	#ä“_®ign
(
addr
è
	`_®igÃd_ä“
×ddr)

	)

271 #iâdeà
¥š_t


273 
	#¥š_t
 
CRITICAL_SECTION


	)

274 
	#¥š_š™
(
¬g
è
	`In™ŸlizeCr™iÿlSeùiÚ
×rg)

	)

275 
	#¥š_lock
(
¬g
è
	`EÁ”Cr™iÿlSeùiÚ
×rg)

	)

276 
	#¥š_uÆock
(
¬g
è
	`L—veCr™iÿlSeùiÚ
×rg)

	)

277 
	#¥š_de¡roy
(
¬g
è
	`D–‘eCr™iÿlSeùiÚ
×rg)

	)

279 #iâdeà
mu‹x_t


281 
	#mu‹x_t
 
CRITICAL_SECTION


	)

282 
	#mu‹x_š™
(
¬g
è
	`In™ŸlizeCr™iÿlSeùiÚ
×rg)

	)

283 
	#mu‹x_lock
(
¬g
è
	`EÁ”Cr™iÿlSeùiÚ
×rg)

	)

284 
	#mu‹x_uÆock
(
¬g
è
	`L—veCr™iÿlSeùiÚ
×rg)

	)

285 
	#mu‹x_de¡roy
(
¬g
è
	`D–‘eCr™iÿlSeùiÚ
×rg)

	)

287 #iâdeà
th»ad_t


289 
	#th»ad_t
 
HANDLE


	)

290 
	#th»ad_cÚd_t
 
CONDITION_VARIABLE


	)

291 
	#th»ad_ü—‹
(
tid
, 
func
, 
¬gs
) \

293 
DWORD
 
__dt__
; \

294 *(
tid
èğ
	`C»©eTh»ad
(
NULL
, 0, \

295 (
LPTHREAD_START_ROUTINE
)(
func
), (
¬gs
), 0, &
__dt__
); \

296 }

	)

297 
	#th»ad_još
(
tid
, 
»t
è
	`Wa™FÜSšgËObjeù
Ñid, 
INFINITE
)

	)

298 
	#th»ad_ÿnûl
(
tid
è
	`T”mš©eTh»ad
Ñid, 0);

	)

299 
	#th»ad_ex™
(
code
è
	`Ex™Th»ad
(code)

	)

300 
	#th»ad_cÚd_š™
(
cÚd
è
	`In™ŸlizeCÚd™iÚV¬ŸbË
(cÚd)

	)

301 
	#th»ad_cÚd_de¡roy
(
cÚd
è()
	)
cond

302 
	#th»ad_cÚd_wa™
(
cÚd
, 
mu‹x
è
	`SË•CÚd™iÚV¬ŸbËCS
(cÚd, mu‹x, 
INFINITE
)

	)

303 
	#th»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
m£c
) \

304 
	`SË•CÚd™iÚV¬ŸbËCS
(
cÚd
, 
mu‹x
, 
m£c
)

	)

305 
	#th»ad_cÚd_sigÇl
(
cÚd
è
	`WakeCÚd™iÚV¬ŸbË
(cÚd)

	)

306 
	#th»ad_cÚd_brßdÿ¡
(
cÚd
è
	`WakeAÎCÚd™iÚV¬ŸbË
(cÚd)

	)

309 #–ià
__CYGWIN__


311 
	~<š‰y³s.h
>

312 
	~<®loÿ.h
>

314 
	#INLINE
 
__šlše


	)

316 
	#_X64
 
PRIx64


	)

317 
	#_F64
 
PRIu64


	)

318 
	#_FSEC
 "ld"

	)

319 
	#_FUSEC
 "ld"

	)

321 
	#_ARCH_O_DIRECT
 (0x0)

	)

323 
	#m®loc_®ign
(
addr
, 
®ign
, 
size
) \

324 (
addr
 = 
	`mem®ign
((
®ign
), (
size
)))

	)

325 
	#ä“_®ign
(
addr
è
	`ä“
×ddr)

	)

327 #iâdeà
¥š_t


329 
	~<±h»ad.h
>

330 
	#¥š_t
 
±h»ad_¥šlock_t


	)

331 
	#¥š_š™
(
¬g
è
	`±h»ad_¥š_š™
×rg, 
PTHREAD_PROCESS_SHARED
)

	)

332 
	#¥š_lock
(
¬g
è
	`±h»ad_¥š_lock
×rg)

	)

333 
	#¥š_uÆock
(
¬g
è
	`±h»ad_¥š_uÆock
×rg)

	)

334 
	#¥š_de¡roy
(
¬g
è
	`±h»ad_¥š_de¡roy
×rg)

	)

335 
	#SPIN_INITIALIZER
 (
¥š_t
)(1)

	)

337 #iâdeà
mu‹x_t


339 
	~<±h»ad.h
>

340 
	#mu‹x_t
 
±h»ad_mu‹x_t


	)

341 
	#mu‹x_š™
(
¬g
è
	`±h»ad_mu‹x_š™
×rg, 
NULL
)

	)

342 
	#mu‹x_lock
(
¬g
è
	`±h»ad_mu‹x_lock
×rg)

	)

343 
	#mu‹x_uÆock
(
¬g
è
	`±h»ad_mu‹x_uÆock
×rg)

	)

344 
	#MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

345 
	#mu‹x_de¡roy
(
¬g
è
	`±h»ad_mu‹x_de¡roy
×rg)

	)

347 #iâdeà
th»ad_t


349 
	~<±h»ad.h
>

350 
	#th»ad_t
 
±h»ad_t


	)

351 
	#th»ad_cÚd_t
 
±h»ad_cÚd_t


	)

352 
	#th»ad_ü—‹
(
tid
, 
func
, 
¬gs
) \

353 
	`±h»ad_ü—‹
((
tid
), 
NULL
, (
func
), (
¬gs
))

	)

354 
	#th»ad_još
(
tid
, 
»t
è
	`±h»ad_još
Ñid,„‘)

	)

355 
	#th»ad_ÿnûl
(
tid
è
	`±h»ad_ÿnûl
Ñid)

	)

356 
	#th»ad_ex™
(
code
è
	`±h»ad_ex™
(code)

	)

357 
	#th»ad_cÚd_š™
(
cÚd
è
	`±h»ad_cÚd_š™
(cÚd, 
NULL
)

	)

358 
	#th»ad_cÚd_de¡roy
(
cÚd
è
	`±h»ad_cÚd_de¡roy
(cÚd)

	)

359 
	#th»ad_cÚd_wa™
(
cÚd
, 
mu‹x
è
	`±h»ad_cÚd_wa™
(cÚd, mu‹x)

	)

360 
	#th»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
ms
) \

362 
time¥ec
 
ts
 = 
	`cÚv”t_»Éime_to_ab¡ime
(
ms
); \

363 
	`±h»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, &
ts
); \

364 }

	)

365 
	#th»ad_cÚd_sigÇl
(
cÚd
è
	`±h»ad_cÚd_sigÇl
(cÚd)

	)

366 
	#th»ad_cÚd_brßdÿ¡
(
cÚd
è
	`±h»ad_cÚd_brßdÿ¡
(cÚd)

	)

370 
	#INLINE
 
make_”rÜ


	)

	@application/kvbench/bench/couch_bench.cc

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<g‘İt.h
>

4 
	~<¡ršg.h
>

5 
	~<sys/time.h
>

6 
	~<sys/¡©.h
>

7 
	~<as£¹.h
>

8 
	~<sys/ty³s.h
>

9 
	~<uni¡d.h
>

10 #iâdeà
__APPLE__


11 
	~<m®loc.h
>

13 
	~<sigÇl.h
>

14 
	~<dœ’t.h
>

16 
	~"libcouch¡Üe/couch_db.h
"

17 
	~"libcouch¡Üe/fe_İs.h
"

18 
	~"adv_¿ndom.h
"

19 
	~"¡İw©ch.h
"

20 
	~"š¬£r.h
"

21 
	~"wÜklßd.h
"

23 
	~"¬ch.h
"

24 
	~"zfŸn_¿ndom.h
"

25 
	~"keyg’.h
"

26 
	~"keylßd”.h
"

27 
	~"memÜy.h
"

28 
	~"memËak.h
"

30 #ià
defšed
 
__BLOBFS_ROCKS_BENCH


31 
	~"rocksdb/’v.h
"

35 
	#COMP_LAT


	)

36 
	#time_check
 (0)

	)

37 
	#time_check2
 (0)

	)

38 
	#SEC_TO_NANO
 (1000000000L)

	)

42 #ifdeà
THREADPOOL


43 
	~"thpoŞ.h
"

47 
couch¡Üe_”rÜ_t
 
couch¡Üe_şo£_db
(
Db
 *
db
);

49 
	#®ÿ
(
ty³
, 
n
è(Ñy³*)
	`®loÿ
(Ñy³è* (n)))

	)

50 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

51 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

52 
	#¿ndomize
(è
	`¤ªd
(()
	`time
(
NULL
))

	)

53 #ifdeà
__DEBUG


54 #iâdeà
__DEBUG_COUCHBENCH


55 #undeà
DBG


56 #undeà
DBGCMD


57 #undeà
DBGSW


58 
	#DBG
(
¬gs
...)

	)

59 
	#DBGCMD
(
commªd
...)

	)

60 
	#DBGSW
(
n
, 
commªd
...)

	)

63 
št64_t
 
	gDATABUF_MAXLEN
 = 0;

65 
	sb’ch_šfo
 {

66 
ušt8_t
 
	mš™Ÿlize
;

67 
ušt64_t
 
	mÿche_size
;

68 
	mauto_com·ùiÚ
;

71 * (*
	m®loÿ‹_mem
)(
	m®ignm’t
, 
ušt64_t
 
	msize
, 
	mnodeid
);

72 (*
	mä“_mem
)(*
	m±r
);

73 
	m®loÿtÜty³
;

74 
ušt64_t
 
	mkp_un™size
;

75 
ušt64_t
 
	mvp_un™size
;

76 
ušt64_t
 
	mkp_numun™s
;

77 
ušt64_t
 
	mvp_numun™s
;

78 
ušt64_t
 
	mkp_®ignm’t
;

79 
ušt64_t
 
	mvp_®ignm’t
;

80 
š¡ªû_šfo_t
 *
	mš¡ªûs
;

81 
ıu_šfo
 *
	mıušfo
;

84 *
	mdeviû_·th
;

85 *
	mkv_deviû_·th
;

86 *
	mkv_emul_cÚfigfe
;

87 **
	mdeviû_Çme
;

88 
št32_t
 
	mdeviû_id
;

89 
	m¡Üe_İtiÚ
;

90 
	mqueue_d•th
;

91 
	maiÙh»ads_³r_deviû
;

92 *
	mcÜe_ids
;

93 *
	mcq_th»ad_ids
;

94 
	mmem_size_mb
;

95 
ušt8_t
 
	mw™h_™”©Ü
;

96 
ušt8_t
 
	m™”©Ü_mode
;

100 
ušt8_t
 
	mkv_wr™e_mode
;

101 
ušt8_t
 
	m®low_¦“p
;

104 
ušt16_t
 
	mas_pÜt
;

105 
ušt32_t
 
	mloİ_ÿ·c™y
;

106 *
	mÇme_¥aû
;

109 *
	m¥dk_cÚf_fe
;

111 
ušt64_t
 
	m¥dk_ÿche_size
;

113 
	mauto_com·ùiÚ_th»ads
;

114 
ušt64_t
 
	mwbs_š™
;

115 
ušt64_t
 
	mwbs_b’ch
;

116 
ušt64_t
 
	mbloom_bpk
;

117 
ušt8_t
 
	mcom·ùiÚ_¡yË
;

118 
ušt64_t
 
	mfdb_w®
;

119 
	mfdb_ty³
;

120 
	mwt_ty³
;

121 
	mcom´essiÚ
;

122 
	mcom´essib™y
;

123 
	m¥l™_pù
;

124 
size_t
 
	mËaf_pg_size
, 
	mšt_pg_size
;

126 
ušt32_t
 
	mÏ‹ncy_¿‹
;

127 
ušt32_t
 
	mÏ‹ncy_max
;

131 
ušt64_t
 
	mndocs
;

132 
	mamp_çùÜ
;

133 *
	mkeyfe
;

134 *
	mdbÇme
;

135 *
	mš™_f’ame
;

136 *
	mf’ame
;

137 *
	mlog_f’ame
;

138 
size_t
 
	mnfes
;

141 
size_t
 
	mpİ_Áh»ads
;

142 
size_t
 
	mpİ_b©chsize
;

143 
ušt8_t
 
	mpİ_comm™
;

144 
ušt8_t
 
	mfdb_æush_w®
;

145 
ušt8_t
 
	m£q_fl
;

146 
ušt8_t
 
	mpİ_fœ¡
;

147 
ušt8_t
 
	m´e_g’
;

150 
size_t
 
	mÆev–
;

151 
size_t
 
	mÅ»fixes
;

152 
keyg’
 
	mkeyg’
;

153 
keylßd”
 
	mkl
;

154 
size_t
 
	mavg_keyËn
;

157 
size_t
 
	mÄ—d”s
;

158 
size_t
 
	mn™”©Üs
;

159 
size_t
 
	mnwr™”s
;

160 
size_t
 
	mnd–‘”s
;

161 
size_t
 
	m»ad”_İs
;

162 
size_t
 
	mwr™”_İs
;

163 
	mdisjošt_wr™e
;

166 
ºdšfo
 
	mkeyËn
;

167 
ºdšfo
 
	m´efixËn
;

168 
ºdšfo
 
	mbodyËn
;

169 
	mv®ue_size
[5];

170 
	mv®ue_size_¿tio
[5];

171 
size_t
 
	mnb©ches
;

172 
size_t
 
	mnİs
;

173 
size_t
 
	mw¬mup_£cs
;

174 
size_t
 
	mb’ch_£cs
;

175 
ºdšfo
 
	mb©ch_di¡
;

176 
ºdšfo
 
	mrb©chsize
;

177 
ºdšfo
 
	mib©chsize
;

178 
ºdšfo
 
	mwb©chsize
;

179 
ºdšfo
 
	mİ_di¡
;

180 
size_t
 
	mb©ch¿nge
;

181 
ušt8_t
 
	m»ad_qu”y_by£q
;

185 
size_t
 
	m¿tio
[4];

186 
size_t
 
	mcom·ù_th»s
;

187 
size_t
 
	mcom·ù_³riod
;

188 
size_t
 
	mblock_»u£_th»s
;

191 
ušt8_t
 
	msync_wr™e
;

194 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

196 
ušt32_t
 
	gºd_£ed
;

197 
	g´št_‹rm_ms
 = 100;

198 
	gfesize_chk_‹rm
 = 4;

200 
FILE
 *
	glog_å
 = 
NULL
;

201 
FILE
 *
	gš£¹_Ï‹ncy_å
 = 
NULL
;

202 
FILE
 *
	gš£¹_İs_å
 = 
NULL
;

203 
FILE
 *
	grun_Ï‹ncy_å
 = 
NULL
;

204 
FILE
 *
	grun_İs_å
 = 
NULL
;

207 
	#Írštf
(...) { \

208 
	`´štf
(
__VA_ARGS__
); \

209 ià(
log_å
è
	`årštf
Öog_å, 
__VA_ARGS__
); } \

210 

	)

211 
	$_cmp_docs
(cÚ¡ *
a
, cÚ¡ *
b
)

213 
Doc
 *
¯
, *
bb
;

214 
¯
 = (
Doc
 *)
a
;

215 
bb
 = (
Doc
 *)
b
;

217 ià(
¯
->
id
.
size
 =ğ
bb
->id.sizeè 
	`memcmp
×a->id.
buf
, bb->id.buf,‡a->id.size);

219 
size_t
 
Ën
 = 
	`MIN
(
¯
->
id
.
size
 , 
bb
->id.size);

220 
cmp
 = 
	`memcmp
(
¯
->
id
.
buf
, 
bb
->id.buf, 
Ën
);

221 ià(
cmp
 != 0)  cmp;

223  (
¯
->
id
.
size
 - 
bb
->id.size);

226 
	}
}

228 
ušt8_t
 
	gm‘abuf
[256];

230 
	#PRINT_TIME
(
t
,
¡r
) \

231 
	`´štf
("%d.%01d" 
¡r
, ()(
t
).
tv_£c
, ()Ñ).
tv_u£c
 / 100000);

	)

232 
	#LOG_PRINT_TIME
(
t
,
¡r
) \

233 
	`Írštf
("%d.%01d" 
¡r
, ()(
t
).
tv_£c
, ()Ñ).
tv_u£c
 / 100000);

	)

235 
ušt64_t
 
	$g‘_fesize
(*
f’ame
)

237 
¡©
 
fe¡©
;

238 
	`¡©
(
f’ame
, &
fe¡©
);

239  
fe¡©
.
¡_size
;

240 
	}
}

242 * 
	$´št_fesize_­´ox
(
ušt64_t
 
size
, *
ouut
)

244 ià(
size
 < 1024*1024) {

245 
	`¥rštf
(
ouut
, "%.2àKB", ()
size
 / 1024);

246 }ià(
size
 >= 1024*1024 && size < 1024*1024*1024) {

247 
	`¥rštf
(
ouut
, "%.2àMB", ()
size
 / (1024*1024));

249 
	`¥rštf
(
ouut
, "%.2àGB", ()
size
 / (1024*1024*1024));

251  
ouut
;

252 
	}
}

254 
	$´št_fesize
(*
f’ame
)

256 
buf
[256];

257 
ušt64_t
 
size
 = 
	`g‘_fesize
(
f’ame
);

259 
	`´štf
("file size : %lu bytes (%s)\n",

260 ()
size
, 
	`´št_fesize_­´ox
(size, 
buf
));

261 
	}
}

263 #ià
defšed
(
__lšux
è&& !defšed(
__ANDROID__
)

264 
	#__PRINT_IOSTAT


	)

266 
ušt64_t
 
	$´št_´oc_io_¡©
(*
buf
, 
´št
)

268 #ifdeà
__PRINT_IOSTAT


269 
	`¥rštf
(
buf
, "/´oc/%d/io", 
	`g‘pid
());

270 
¡r
[64];

271 
»t
; ()ret;

272 
‹mp
;

273 
ušt64_t
 
v®
=0;

274 
FILE
 *
å
 = 
	`fİ’
(
buf
, "r");

275 !
	`ãof
(
å
)) {

276 
»t
 = 
	`fsÿnf
(
å
, "% %lu", 
¡r
, &
‹mp
);

277 ià(!
	`¡rcmp
(
¡r
, "write_bytes:")) {

278 
v®
 = 
‹mp
;

279 ià(
´št
) {

280 
	`Írštf
("[proc IO] %lu bytes written (%s)\n",

281 ()
v®
, 
	`´št_fesize_­´ox
(v®, 
¡r
));

285 
	`fşo£
(
å
);

286  
v®
;

291 
	}
}

293 
	$em±y_ÿÎback
(
Db
 *
db
, 
DocInfo
 *
docšfo
, *
ùx
)

296 
	}
}

299 
	#MAX_KEYLEN
 (64)

	)

300 
	$g‘_v®ue_size_by_¿tio
(
b’ch_šfo
 *
bšfo
, 
size_t
 
idx
) {

302 
v®ue_size
 = 0;

303 if(
idx
 % 100 < 
bšfo
->
v®ue_size_¿tio
[0]){

304 
v®ue_size
 = 
bšfo
->value_size[0] == 0 ? 4096 : binfo->value_size[0];

305 } ià(
idx
 % 100 < 
bšfo
->
v®ue_size_¿tio
[0] + binfo->value_size_ratio[1] ) {

306 
v®ue_size
 = 
bšfo
->value_size[1] == 0 ? 4096 : binfo->value_size[1];

307 } ià(
idx
 % 100 < 
bšfo
->
v®ue_size_¿tio
[0] + binfo->value_size_ratio[1] + binfo->value_size_ratio[2]){

308 
v®ue_size
 = 
bšfo
->value_size[2] == 0 ? 4096 : binfo->value_size[2];

309 } ià(
idx
 % 100 < 
bšfo
->
v®ue_size_¿tio
[0] + binfo->value_size_ratio[1] + binfo->value_size_ratio[2] + binfo->value_size_ratio[3]) {

310 
v®ue_size
 = 
bšfo
->value_size[3] == 0 ? 4096 : binfo->value_size[3];

312 
v®ue_size
 = 
bšfo
->value_size[4] == 0 ? 4096 : binfo->value_size[4];

315  
v®ue_size
 == 0 ? 4096 : value_size;

316 
	}
}

318 
	$_ü—‹_doc
(
b’ch_šfo
 *
bšfo
,

319 
size_t
 
idx
, 
Doc
 **
pdoc
,

320 
DocInfo
 **
pšfo
, 
£q_fl
,

321 
sock‘id
, 
mempoŞ_t
 *
kp
, mempoŞ_ˆ*
vp
)

323 
r
, 
keyËn
 = 0;

324 
ušt32_t
 
üc
;

325 
Doc
 *
doc
 = *
pdoc
;

326 #ià
defšed
 
__FDB_BENCH
 || defšed 
__WT_BENCH


327 
DocInfo
 *
šfo
 = *
pšfo
;

329 
keybuf
[
MAX_KEYLEN
];

331 if(
bšfo
->
bodyËn
.
ty³
 !ğ
RND_FIXED
) {

332 
üc
 = 
	`keyg’_idx2üc
(
idx
, 0);

333 
	`BDR_RNG_VARS_SET
(
üc
);

336 
keyËn
 = (
bšfo
->keyËn.
ty³
 =ğ
RND_FIXED
)? bšfo->keyËn.
a
 : 0;

337 ià(!
doc
) {

338 
doc
 = (
Doc
 *)
	`m®loc
((Doc));

339 
doc
->
id
.
buf
 = 
NULL
;

340 
doc
->
d©a
.
buf
 = 
NULL
;

343 if(
bšfo
->
kv_wr™e_mode
 =ğ0 || 
doc
->
id
.
buf
 =ğ
NULL
){

344 
doc
->
id
.
buf
 = (*)
	`AÎoÿ‹
(
kp
);

348 if(
doc
->
id
.
buf
 =ğ
NULL
){ 
	`årštf
(
¡d”r
, "NØpoŞƒËm‡vaabË fÜ key - %d\n", 
kp
->
num_ä“blocks
); 
	`ex™
(1);}

350 ià(
bšfo
->
keyfe
) {

351 
doc
->
id
.
size
 = 
	`keylßd”_g‘_key
(&
bšfo
->
kl
, 
idx
, doc->id.
buf
);

353 if(
£q_fl
) {

354 
doc
->
id
.
size
 = 
bšfo
->
keyËn
.
a
;

355 
	`keyg’_£qfl
(
idx
, 
doc
->
id
.
buf
, 
bšfo
->
keyËn
.
a
);

358 
doc
->
id
.
size
 = 
bšfo
->
keyËn
.
a
;

359 
	`keyg’_£ed2key
(&
bšfo
->
keyg’
, 
idx
, 
doc
->
id
.
buf
, 
keyËn
);

367 if(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_FIXED
) {

368 
doc
->
d©a
.
size
 = 
bšfo
->
bodyËn
.
a
;

369 ià(
doc
->
d©a
.
buf
 =ğ
NULL
 || 
bšfo
->
kv_wr™e_mode
 == 0) {

373 
doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
vp
);

375 if(
doc
->
d©a
.
buf
 =ğ
NULL
){ 
	`årštf
(
¡d”r
, "NØpoŞƒËm‡vaabË fÜ v®u- %d\n", 
vp
->
num_ä“blocks
); 
	`ex™
(1);}

379 } ià(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_RATIO
) {

380 
doc
->
d©a
.
size
 = 
	`g‘_v®ue_size_by_¿tio
(
bšfo
, 
idx
);

381 ià(
doc
->
d©a
.
buf
 =ğ
NULL
 || 
bšfo
->
kv_wr™e_mode
 == 0) {

382 
doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
vp
);

387 
üc
 = 
	`keyg’_idx2üc
(
idx
, 0);

388 
	`BDR_RNG_VARS_SET
(
üc
);

390 
BDR_RNG_NEXTPAIR
;

391 
r
 = 
	`g‘_¿ndom
(&
bšfo
->
bodyËn
, 
ºgz
, 
ºgz2
);

392 ià(
r
 < 8)„ = 8;

393 if(
r
 > 
DATABUF_MAXLEN
)„ = DATABUF_MAXLEN;

395 
doc
->
d©a
.
size
 = 
r
;

397 
doc
->
d©a
.
size
 = (
size_t
)((doc->d©a.size+1è/ ((
ušt64_t
)*1)) *

398 ((
ušt64_t
)*1);

399 ià(
doc
->
d©a
.
buf
 =ğ
NULL
 ||
bšfo
->
kv_wr™e_mode
 == 0) {

401 
max_bodyËn
, 
avg_bodyËn
;

402 
i
, 
abt_¬¿y_size
, 
ºd_¡r_Ën
;

403 *
abt_¬¿y
 = (*)"abcdefghijklmnopqrstuvwxyz"

405 
abt_¬¿y_size
 = 
	`¡¾’
(
abt_¬¿y
);

407 ià(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_NORMAL
) {

408 
max_bodyËn
 = 
bšfo
->
bodyËn
.
a
 + bšfo->bodyËn.
b
 * 6;

409 
avg_bodyËn
 = 
bšfo
->
bodyËn
.
a
;

410 } ià(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_UNIFORM
) {

412 
max_bodyËn
 = 
bšfo
->
bodyËn
.
b
 + 16;

413 
avg_bodyËn
 = (
bšfo
->
bodyËn
.
a
 + bšfo->bodyËn.
b
)/2;

416 
doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
vp
);

417 ià(
bšfo
->
com´essib™y
 == 0) {

419 
ºd_¡r_Ën
 = 
max_bodyËn
;

420 } ià(
bšfo
->
com´essib™y
 == 100) {

422 
ºd_¡r_Ën
 = 0;

425 
ºd_¡r_Ën
 = 
avg_bodyËn
 * (100 - 
bšfo
->
com´essib™y
);

426 
ºd_¡r_Ën
 /= 100;

429 
	`mem£t
(
doc
->
d©a
.
buf
, 'x', 
max_bodyËn
);

430 
i
=0;i<
ºd_¡r_Ën
;++i){

431 
doc
->
d©a
.
buf
[
i
] = 
abt_¬¿y
[
	`¿nd
(è% 
abt_¬¿y_size
];

435 
	`memıy
(
doc
->
d©a
.
buf
 + doc->d©a.
size
 - 5, (*)"<end>", 5);

445 #ià
defšed
 
__FDB_BENCH
 || defšed 
__WT_BENCH


446 ià(!
šfo
)

447 
šfo
 = (
DocInfo
*)
	`m®loc
((DocInfo));

449 
	`mem£t
(
šfo
, 0, (
DocInfo
));

450 
šfo
->
id
 = 
doc
->id;

451 
šfo
->
»v_m‘a
.
buf
 = (*)
m‘abuf
;

452 
šfo
->
»v_m‘a
.
size
 = 4;

453 
šfo
->
cÚ‹Á_m‘a
 = (
bšfo
->
com´essiÚ
)?(
COUCH_DOC_IS_COMPRESSED
):(0);

454 *
pšfo
 = 
šfo
;

456 *
pdoc
 = 
doc
;

458 
	}
}

460 
	sÏ‹ncy_th»ad_¡©
 {

461 
ušt64_t
 
	mcursÜ
;

462 
ušt64_t
 
	mn§m¶es
;

463 
ušt64_t
 
	mmax_§m¶es
;

464 
ušt32_t
 *
	m§m¶es
;

467 
	spİ_th»ad_¬gs
 {

468 
	mn
;

469 
	mcÜeid
;

470 
	msock‘id
;

471 
	mcur_qd•th
;

472 
Db
 **
	mdb
;

473 
b’ch_šfo
 *
	mbšfo
;

474 
pİ_th»ad_¬gs
 *
	mpİ_¬gs
;

475 
¥š_t
 *
	mlock
;

476 
mempoŞ_t
 *
	mkeypoŞ
;

477 
mempoŞ_t
 *
	mv®u•oŞ
;

478 
	m¡d
::
©omic_ušt_ç¡64_t
 
iocouÁ
;

480 
¡İw©ch
 *
	msw
;

481 
¡İw©ch
 *
	msw_lÚg
;

482 
Ï‹ncy_¡©
 *
	ml_wr™e
;

485 
	#SET_DOC_RANGE
(
ndocs
, 
nfes
, 
idx
, 
begš
, 
’d
) \

486 
begš
 = (
ndocs
è* ((
idx
)+0è/ (
nfes
); \

487 
’d
 = (
ndocs
è* ((
idx
)+1è/ (
nfes
);

	)

489 
	#GET_FILE_NO
(
ndocs
, 
nfes
, 
idx
) \

490 ((
idx
è/ ( ((
ndocs
è+ (
nfes
-1)è/ (nfes)))

	)

492 
	$_g‘_fe_¿nge
(
t_idx
, 
num_th»ads
, 
num_fes
,

493 *
begš
, *
’d
)

513 
quÙ›Á
;

514 
»mašd”
;

516 
quÙ›Á
 = 
num_fes
 / 
num_th»ads
;

517 
»mašd”
 = 
num_fes
 - (
quÙ›Á
 * 
num_th»ads
);

519 ià(
»mašd”
) {

520 ià(
t_idx
 < 
»mašd”
) {

521 *
begš
 = (
quÙ›Á
+1è* 
t_idx
;

522 *
’d
 = (*
begš
è+ 
quÙ›Á
;

524 *
begš
 = (
quÙ›Á
+1è* 
»mašd”
 + quÙ›Á * (
t_idx
 -„emainder);

525 *
’d
 = (*
begš
è+ 
quÙ›Á
 - 1;

528 *
begš
 = 
quÙ›Á
 * 
t_idx
;

529 *
’d
 = (*
begš
è+ 
quÙ›Á
 - 1;

531 
	}
}

533 
g‘ev’ts
(
Db
 *
db
, 
mš
, 
max
, 
IoCÚ‹xt
 **
cÚ‹xt
);

534 
»Ëa£_cÚ‹xt
(
Db
 *
db
, 
IoCÚ‹xt
 **
cÚ‹xts
, 
Ä
);

535 
·ss_l¡©_to_db
(
Db
 *
db
, 
Ï‹ncy_¡©
 *
l_»ad
,†©’cy_¡© *
l_wr™e
,†©’cy_¡© *
l_d–‘e
);

536 *
	$pİ_th»ad
(*
void¬gs
){

539 
ušt64_t
 
i
, 
k
, 
c
, 
n
, 
db_idx
, 
j
;

540 
ušt64_t
 
couÁ”
;

541 
pİ_th»ad_¬gs
 *
¬gs
 = (pİ_th»ad_¬g *)
void¬gs
;

542 
b’ch_šfo
 *
bšfo
 = 
¬gs
->binfo;

543 
size_t
 
b©chsize
 = 
¬gs
->
bšfo
->
pİ_b©chsize
;

544 
Db
 *
db
;

545 
Doc
 **
docs
;

546 
DocInfo
 **
šfos
 = 
NULL
;

548 #ià
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

550 
rocksdb
::
	`SpdkIn™ŸlizeTh»ad
();

554 
¡İw©ch
 
sw_mÚ™Ü
, 
sw_Ï‹ncy
;

555 
timev®
 
g­
;

556 
curfe_no
, 
§m¶šg_ms
, 
mÚ™Üšg
;

557 
ušt64_t
 
cur_§m¶e
;

558 
Ï‹ncy_¡©
 *
l_¡©
 = 
¬gs
->
l_wr™e
;

560 ià(
bšfo
->
Ï‹ncy_¿‹
) {

561 
§m¶šg_ms
 = 1000 / 
bšfo
->
Ï‹ncy_¿‹
;

563 
§m¶šg_ms
 = 0;

566 
	`¡İw©ch_š™_¡¬t
(&
sw_mÚ™Ü
);

567 #ià
defšed
 
__AS_BENCH


568 
db_idx
 = 
¬gs
->
n
;

570 
db_idx
 = 
¬gs
->
n
 / 
bšfo
->
pİ_Áh»ads
;

572 
db
 = 
¬gs
->db[
db_idx
];

573 
c
 = (
¬gs
->
n
 % 
bšfo
->
pİ_Áh»ads
è* 
b©chsize
;

575 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


576 if(
bšfo
->
kv_wr™e_mode
 == 0)

577 
	`·ss_l¡©_to_db
(
db
, 
NULL
, 
l_¡©
, NULL);

580 if(
bšfo
->
kv_wr™e_mode
 == 1) {

582 
docs
 = (
Doc
**)
	`ÿÎoc
(
b©chsize
, (Doc*));

583 #ià
defšed
 
__FDB_BENCH
 || defšed 
__WT_BENCH


584 
šfos
 = (
DocInfo
**)
	`ÿÎoc
(
b©chsize
, (DocInfo*));

586 
i
=0;i<
b©chsize
;++i) {

587 
docs
[
i
] = 
NULL
;

588 #ià
defšed
 
__FDB_BENCH
 || defšed 
__WT_BENCH


589 
šfos
[
i
] = 
NULL
;

590 
	`_ü—‹_doc
(
bšfo
, 
i
, &
docs
[i], &
šfos
[i], bšfo->
£q_fl
,

591 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

593 
	`_ü—‹_doc
(
bšfo
, 
i
, &
docs
[i], 
NULL
, bšfo->
£q_fl
,

594 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

598 
c
 < 
bšfo
->
ndocs
) {

599 
i
 = 
c
; (˜< c + 
b©chsize
 && i < 
bšfo
->
ndocs
); ++i){

600 #ià
defšed
 
__FDB_BENCH
 || defšed 
__WT_BENCH


601 
	`_ü—‹_doc
(
bšfo
, 
i
, &
docs
[i-
c
], &
šfos
[i-c], bšfo->
£q_fl
,

602 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

604 
	`_ü—‹_doc
(
bšfo
, 
i
, &
docs
[i-
c
], 
NULL
, bšfo->
£q_fl
,

605 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

610 ià(
§m¶šg_ms
 &&

611 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

612 ià(
l_¡©
->
cursÜ
 >ğ
bšfo
->
Ï‹ncy_max
) {

613 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
bšfo
->
Ï‹ncy_max
;

614 
l_¡©
->
n§m¶es
 = 
bšfo
->
Ï‹ncy_max
;

616 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
 + 1;

618 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

619 
	`¡İw©ch_š™_¡¬t
(&
sw_Ï‹ncy
);

620 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

621 
mÚ™Üšg
 = 1;

622 
l_¡©
->
cursÜ
++;

624 
mÚ™Üšg
 = 0;

627 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


628 
	`couch¡Üe_§ve_docum’ts
(
db
, 
docs
, 
NULL
, 
i
-
c
, 0);

630 
	`couch¡Üe_§ve_docum’ts
(
db
, 
docs
, 
šfos
, 
i
-
c
, 
bšfo
->
com´essiÚ
);

633 
¬gs
->
iocouÁ
.
	`ãtch_add
(
i
-
c
, 
¡d
::
memÜy_Üd”_»Ëa£
);

635 ià(
bšfo
->
pİ_comm™
) {

636 
	`couch¡Üe_comm™
(
db
);

639 ià(
mÚ™Üšg
) {

640 
g­
 = 
	`¡İw©ch_g‘_cu¹ime
(&
sw_Ï‹ncy
);

641 
l_¡©
->
§m¶es
[
cur_§m¶e
] = 
	`_timev®_to_us
(
g­
);

644 
c
 +ğ
bšfo
->
pİ_Áh»ads
 * 
b©chsize
;

647 if(!
bšfo
->
pİ_comm™
) {

648 
	`couch¡Üe_comm™
(
db
);

652 
i
=0;i<
b©chsize
;++i){

653 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


657 ià(
docs
[
i
]) {

660 #ià
defšed
 
__FDB_BENCH
 || defšed 
__WT_BENCH


661 ià(
šfos
[
i
]è
	`ä“
(infos[i]);

665 
	`ä“
(
docs
);

666 if(
šfos
è
	`ä“
(infos);

669 #ià!
	`defšed
 (
__KV_BENCH
è&& !defšed (
__AS_BENCH
)

670 
	`årštf
(
¡dout
, "no‡sync write mode forhis DB\n");

671 
	`ex™
(0);

674 
docs
 = (
Doc
**)
	`ÿÎoc
(
b©chsize
, (Doc*));

675 
IoCÚ‹xt_t
 *
cÚ‹xts
[256];

677 
c
 < 
bšfo
->
ndocs
) {

679 
¬gs
->
cur_qd•th
 < 
bšfo
->
queue_d•th
) {

680 if(
c
 >ğ
bšfo
->
ndocs
) ;

681 
	`_ü—‹_doc
(
bšfo
, 
c
, &
docs
[0], 
NULL
, bšfo->
£q_fl
,

682 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

684 ià(
§m¶šg_ms
 &&

685 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

686 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

687 
mÚ™Üšg
 = 1;

689 
mÚ™Üšg
 = 0;

692 
	`couch¡Üe_§ve_docum’ts
(
db
, 
docs
, 
NULL
, 1, 
mÚ™Üšg
);

693 
¬gs
->
cur_qd•th
++;

695 
c
 +ğ
bšfo
->
pİ_Áh»ads
 * 
b©chsize
;

698 ià(
¬gs
->
cur_qd•th
 > 0) {

700 
Ä
 = 
	`g‘ev’ts
(
db
, 0, 
¬gs
->
cur_qd•th
, 
cÚ‹xts
);

701 
j
 = 0; j < 
Ä
; j++) {

702 if(
cÚ‹xts
[
j
]è
	`nÙify
(cÚ‹xts[j], 
¬gs
->
keypoŞ
,‡rgs->
v®u•oŞ
);

705 
	`»Ëa£_cÚ‹xt
(
db
, 
cÚ‹xts
, 
Ä
);

707 
¬gs
->
cur_qd•th
 -ğ
Ä
;

708 
¬gs
->
iocouÁ
.
	`ãtch_add
(
Ä
, 
¡d
::
memÜy_Üd”_»Ëa£
);

711 if(
¬gs
->
cur_qd•th
 =ğ
bšfo
->
queue_d•th
)

713 
	`u¦“p
(1);

719 
¬gs
->
cur_qd•th
 > 0) {

721 
Ä
 = 
	`g‘ev’ts
(
db
, 0, 
¬gs
->
cur_qd•th
, 
cÚ‹xts
);

723 
j
 = 0; j < 
Ä
; j++) {

724 if(
cÚ‹xts
[
j
]è
	`nÙify
(cÚ‹xts[j], 
¬gs
->
keypoŞ
,‡rgs->
v®u•oŞ
);

727 
	`»Ëa£_cÚ‹xt
(
db
, 
cÚ‹xts
, 
Ä
);

729 
¬gs
->
cur_qd•th
 -ğ
Ä
;

730 
¬gs
->
iocouÁ
.
	`ãtch_add
(
Ä
, 
¡d
::
memÜy_Üd”_»Ëa£
);

735 if(
¬gs
->
keypoŞ
)

736 
	`de¡roy
(
bšfo
->
®loÿtÜty³
, 
¬gs
->
keypoŞ
);

737 if(
¬gs
->
v®u•oŞ
)

738 
	`de¡roy
(
bšfo
->
®loÿtÜty³
, 
¬gs
->
v®u•oŞ
);

740 
	}
}

743 * 
	$pİ_´št_time
(*
void¬gs
)

746 
buf
[1024];

747 
i
;

748 
iİs
, 
iİs_i
;

749 
ušt64_t
 
couÁ”
 = 0, 
couÁ”_´ev
 = 0;

750 
ušt64_t
 
cur_iocouÁ
 = 0;

751 
ušt64_t
 
c
 = 0;

752 
ušt64_t
 
»maš_£c
 = 0;

753 
ušt64_t
 
–­£d_ms
 = 0;

754 
ušt64_t
 
by‹s_wr™‹n
 = 0;

755 
pİ_th»ad_¬gs
 *
¬gs
 = (pİ_th»ad_¬g *)
void¬gs
;

756 
b’ch_šfo
 *
bšfo
 = 
¬gs
->binfo;

757 
timev®
 
tv
, 
tv_i
;

759 
couÁ”
 < 
bšfo
->
ndocs
 * bšfo->
nfes
)

761 
couÁ”
 = 0;

762 
i
 = 0; i < 
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
; i++) {

763 
cur_iocouÁ
 = 
¬gs
->
pİ_¬gs
[
i
].
iocouÁ
.
	`lßd
();

764 
couÁ”
 +ğ
cur_iocouÁ
;

768 ià(
	`¡İw©ch_check_ms
(
¬gs
->
sw
, 
´št_‹rm_ms
)){

769 
tv
 = 
	`¡İw©ch_g‘_cu¹ime
(
¬gs
->
sw_lÚg
);

770 
tv_i
 = 
	`¡İw©ch_g‘_cu¹ime
(
¬gs
->
sw
);

771 
	`¡İw©ch_¡¬t
(
¬gs
->
sw
);

772 ià(++
c
 % 10 =ğ0 && 
couÁ”
) {

773 
–­£d_ms
 = (
ušt64_t
)
tv
.
tv_£c
 * 1000 +

774 (
ušt64_t
)
tv
.
tv_u£c
 / 1000;

775 
»maš_£c
 = (
bšfo
->
ndocs
 * bšfo->
nfes
 - 
couÁ”
);

776 
»maš_£c
 =„emaš_£ø/ 
	`MAX
(1, (
couÁ”
 / 
–­£d_ms
));

777 
»maš_£c
 =„emain_sec / 1000;

780 
iİs
 = ()
couÁ”
 / (
tv
.
tv_£c
 +v.
tv_u£c
/1000000.0);

781 
iİs_i
 = ()(
couÁ”
 - 
couÁ”_´ev
) /

782 (
tv_i
.
tv_£c
 +v_i.
tv_u£c
/1000000.0);

783 
couÁ”_´ev
 = 
couÁ”
;

785 #ià
	`defšed
 (
__ROCKS_BENCH
è|| defšed (
__BLOBFS_ROCKS_BENCH
è|| defšed (
__FDB_BENCH
è|| defšed (
__WT_BENCH
è|| defšed (
__LEVEL_BENCH
è|| defšed(
__KVDB_BENCH
)

786 ià(
c
 % 
fesize_chk_‹rm
 == 0) {

787 
by‹s_wr™‹n
 = 
	`´št_´oc_io_¡©
(
buf
, 0);

791 
	`´štf
("\r[%d.%01d s] ", ()
tv
.
tv_£c
, ()Ñv.
tv_u£c
/100000));

793 
	`´štf
("%" 
_F64
 " / %" _F64, 
couÁ”
, (
ušt64_t
)
bšfo
->
ndocs
 * bšfo->
nfes
);

795 
	`´štf
(" (%.2àİs/£c, %.2àİs/£c, ", 
iİs
, 
iİs_i
);

797 
	`´štf
("%.1à%%, ", ()(
couÁ”
 * 100.0 / (
bšfo
->
ndocs
 * bšfo->
nfes
)));

799 
	`´štf
("%sè", 
	`´št_fesize_­´ox
(
by‹s_wr™‹n
, 
buf
));

800 
	`´štf
(" (-%d s)", ()
»maš_£c
);

801 
	`fæush
(
¡dout
);

803 ià(
š£¹_İs_å
) {

804 
	`årštf
(
š£¹_İs_å
,

805 "%d.%01d,%.2f,%.2f,%" 
_F64
 ",%" _F64 "\n",

806 ()
tv
.
tv_£c
, ()Ñv.
tv_u£c
/100000),

807 
iİs
, 
iİs_i
, (
ušt64_t
)
couÁ”
, 
by‹s_wr™‹n
);

810 
	`u¦“p
(
´št_‹rm_ms
 * 1000);

816  
NULL
;

817 
	}
}

819 
_wa™_Ëv–db_com·ùiÚ
(
b’ch_šfo
 *
bšfo
, 
Db
 **
db
);

820 
_´št_³rûÁe
(
b’ch_šfo
 *
bšfo
,

821 
Ï‹ncy_¡©
 *
l_w¡©
,

822 
Ï‹ncy_¡©
 *
l_r¡©
,

823 
Ï‹ncy_¡©
 *
l_d¡©
,

824 cÚ¡ *
un™
, 
mode
);

825 
	$pİuÏtiÚ
(
Db
 **
db
, 
b’ch_šfo
 *
bšfo
)

827 
size_t
 
i
, 
j
;

828 *
»t
[
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
 + 1];

829 
th»ad_t
 
tid
[
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
 +1];

830 
pİ_th»ad_¬gs
 
¬gs
[
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
 + 1];

831 
¡İw©ch
 
sw
, 
sw_lÚg
;

832 
timev®
 
tv
;

833 
timev®
 
t1
, 
t3
;

834 
tÙ®miüo£cs
 = 0;

835 
iİs
 = 0, 
Ï‹ncy_ms
 = 0;

837 
keyËn
 = (
bšfo
->keyËn.
ty³
 =ğ
RND_FIXED
)? bšfo->keyËn.
a
 : 0;

838 
	`g‘timeofday
(&
t1
, 
NULL
);

840 
	`¡İw©ch_š™
(&
sw
);

841 
	`¡İw©ch_¡¬t
(&
sw
);

842 
	`¡İw©ch_š™
(&
sw_lÚg
);

843 
	`¡İw©ch_¡¬t
(&
sw_lÚg
);

845 #ifdeà
THREADPOOL


846 
th»adpoŞ
 
thpoŞ
 = 
	`thpoŞ_š™
(
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
);

849 
±h»ad_©Œ_t
 
©Œ
[
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
];

850 
ıu_£t_t
 
ıus
;

851 
db_idx
, 
td_idx
, 
nodeid
;

852 
poŞ_šfo_t
 
šfo_key
, 
šfo_v®ue
;

855 
šfo_key
.
®loÿtÜty³
 = 
šfo_v®ue
.®loÿtÜty³ = 
bšfo
->allocatortype;

856 
šfo_key
.
numun™s
 = 
bšfo
->
kp_numun™s
;

857 
šfo_key
.
un™size
 = 
bšfo
->
kp_un™size
;

858 
šfo_key
.
®ignm’t
 = 
bšfo
->
kp_®ignm’t
;

859 
šfo_v®ue
.
numun™s
 = 
bšfo
->
vp_numun™s
;

860 
šfo_v®ue
.
un™size
 = 
bšfo
->
vp_un™size
;

861 
šfo_v®ue
.
®ignm’t
 = 
bšfo
->
vp_®ignm’t
;

863 
i
=0;i<
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
;++i){

864 
	`±h»ad_©Œ_š™
(&
©Œ
[
i
]);

865 
db_idx
 = 
i
 / 
bšfo
->
pİ_Áh»ads
;

866 
td_idx
 = 
i
%
bšfo
->
pİ_Áh»ads
;

867 
nodeid
 = 
bšfo
->
š¡ªûs
[
db_idx
].
nodeid_lßd
;

868 
nodeid
 = 0;

875 if(
bšfo
->
š¡ªûs
[
db_idx
].
cÜeids_pİ
[
td_idx
] != -1) {

876 
	`CPU_ZERO
(&
ıus
);

877 
	`CPU_SET
(
bšfo
->
š¡ªûs
[
db_idx
].
cÜeids_pİ
[
td_idx
], &
ıus
);

878 
	`±h»ad_©Œ_£ffš™y_Å
(&
©Œ
[
i
], (
ıu_£t_t
), &
ıus
);

879 } if(
nodeid
 != -1){

880 
	`CPU_ZERO
(&
ıus
);

881 
j
 = 0; j < 
bšfo
->
ıušfo
->
num_cÜes_³r_numªodes
; j++){

882 
	`CPU_SET
(
bšfo
->
ıušfo
->
ıuli¡
[
nodeid
][
j
], &
ıus
);

884 
	`±h»ad_©Œ_£ffš™y_Å
(&
©Œ
[
i
], (
ıu_£t_t
), &
ıus
);

887 
	`CPU_ZERO
(&
ıus
);

888 
nodeid
 = 
db_idx
 % 
bšfo
->
ıušfo
->
num_numªodes
;

889 
	`CPU_ZERO
(&
ıus
);

890 
j
 = 0; j < 
bšfo
->
ıušfo
->
num_cÜes_³r_numªodes
; j++){

891 
	`CPU_SET
(
bšfo
->
ıušfo
->
ıuli¡
[
nodeid
][
j
], &
ıus
);

893 
	`±h»ad_©Œ_£ffš™y_Å
(&
©Œ
[
i
], (
ıu_£t_t
), &
ıus
);

895 
¬gs
[
i
].
sock‘id
 = 
nodeid
;

897 
¬gs
[
i
].
keypoŞ
 = (
mempoŞ_t
 *)
	`m®loc
((mempool_t));

898 
¬gs
[
i
].
keypoŞ
->
ba£
 =‡rgs[i].keypoŞ->
Ãxtä“block
 = 
NULL
;

899 
	`poŞ_£tup
(&
šfo_key
, 
¬gs
[
i
].
keypoŞ
, 
nodeid
);

901 
¬gs
[
i
].
v®u•oŞ
 = (
mempoŞ_t
 *)
	`m®loc
((mempool_t));

902 
¬gs
[
i
].
v®u•oŞ
->
ba£
 =‡rgs[i].v®u•oŞ->
Ãxtä“block
 = 
NULL
;

903 
	`poŞ_£tup
(&
šfo_v®ue
, 
¬gs
[
i
].
v®u•oŞ
, 
nodeid
);

905 
	`årštf
(
¡dout
, "th»ad %d in™Ÿlizkey…oŞ - ba£ i %p,‚exˆä“ %°ä“ %d\n", ()
i
, 
¬gs
[i].
keypoŞ
->
ba£
,‡rgs[i].keypoŞ->
Ãxtä“block
,‡rgs[i].keypoŞ->
num_ä“blocks
);

906 
	`årštf
(
¡dout
, "th»ad %d in™Ÿlizv®upoŞ - ba£ i %p,‚exˆä“ %°ä“ %d, un™ siz%ld\n", ()
i
, 
¬gs
[i].
v®u•oŞ
->
ba£
,‡rgs[i].v®u•oŞ->
Ãxtä“block
,‡rgs[i].v®u•oŞ->
num_ä“blocks
, 
šfo_v®ue
.
un™size
);

908 
¬gs
[
i
].
l_wr™e
 = (
Ï‹ncy_¡©
 *)
	`ÿÎoc
(1, (latency_stat));

909 
¬gs
[
i
].
l_wr™e
->
§m¶es
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* 
bšfo
->
Ï‹ncy_max
);

913 
i
=0;i<=
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
;++i){

914 
¬gs
[
i
].
n
 = i;

915 
¬gs
[
i
].
db
 = db;

916 
¬gs
[
i
].
bšfo
 = binfo;

917 
¬gs
[
i
].
sw
 = &sw;

918 
¬gs
[
i
].
sw_lÚg
 = &sw_long;

919 
¬gs
[
i
].
iocouÁ
 = 0;

920 
¬gs
[
i
].
cur_qd•th
 = 0;

921 ià(
i
 < 
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
) {

922 #ifdeà
THREADPOOL


923 
	`thpoŞ_add_wÜk
(
thpoŞ
, 
pİ_th»ad
, &
¬gs
[
i
]);

925 
	`±h»ad_ü—‹
(&
tid
[
i
], &
©Œ
[i], 
pİ_th»ad
, &
¬gs
[i]);

929 if(
š£¹_İs_å
)

930 
	`årštf
(
š£¹_İs_å
, "time,iops,iops_i,counter\n");

931 
¬gs
[
i
].
pİ_¬gs
 =‡rgs;

932 
	`th»ad_ü—‹
(&
tid
[
i
], 
pİ_´št_time
, &
¬gs
[i]);

936 
i
=0; i<=
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
; ++i){

937 
	`th»ad_još
(
tid
[
i
], &
»t
[i]);

940 #ià
	`defšed
 (
__KV_BENCH
è|| defšed (
__AS_BENCH
)

943 #–ià
	`defšed
 (
__ROCKS_BENCH
è|| defšed (
__LEVEL_BENCH
)

944 
	`_wa™_Ëv–db_com·ùiÚ
(
bšfo
, 
db
);

947 
	`g‘timeofday
(&
t3
, 
NULL
);

948 
tÙ®miüo£cs
 = (
t3
.
tv_£c
 - 
t1
.tv_sec) * 1000000;

949 
tÙ®miüo£cs
 +ğ(
t3
.
tv_u£c
 - 
t1
.tv_usec);

950 
Ï‹ncy_ms
 = ()
tÙ®miüo£cs
 / ((è
bšfo
->
ndocs
 * (èbšfo->
nfes
);

951 
iİs
 = 1000000 / 
Ï‹ncy_ms
;

952 
	`Írštf
("\nThroughput(In£¹iÚè%.2àÏ‹ncy=%lf\n", 
iİs
, 
Ï‹ncy_ms
);

954 if(
bšfo
->
Ï‹ncy_¿‹
){

956 
Ï‹ncy_¡©
 
l_¡©
;

957 
ušt32_t
 *
tmp
;

958 
	`mem£t
(&
l_¡©
, 0, (
Ï‹ncy_¡©
));

959 
l_¡©
.
§m¶es
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* 
bšfo
->
Ï‹ncy_max
 * bšfo->
pİ_Áh»ads
 * bšfo->
nfes
);

960 
tmp
 = 
l_¡©
.
§m¶es
;

961 
i
 = 0; i < 
bšfo
->
pİ_Áh»ads
 * bšfo->
nfes
; i++){

962 
l_¡©
.
n§m¶es
 +ğ
¬gs
[
i
].
l_wr™e
->nsamples;

963 
	`memıy
(
tmp
, 
¬gs
[
i
].
l_wr™e
->
§m¶es
, (
ušt32_t
è*‡rgs[i].l_wr™e->
n§m¶es
);

964 
tmp
 +ğ
¬gs
[
i
].
l_wr™e
->
n§m¶es
;

965 
	`ä“
(
¬gs
[
i
].
l_wr™e
->
§m¶es
);

968 
	`_´št_³rûÁe
(
bšfo
, &
l_¡©
, 
NULL
, NULL, "us", 1);

969 
	`Írštf
("\n");

970 
	`ä“
(
l_¡©
.
§m¶es
);

972 #ifdeà
THREADPOOL


974 
	`thpoŞ_de¡roy
(
thpoŞ
);

977 
	`årštf
(
¡dout
, "population done \n");

979 
	}
}

981 
	$_g‘_rw_çùÜ
(
b’ch_šfo
 *
bšfo
, *
´ob
)

984 
p
 = 
bšfo
->
¿tio
[1] + binfo->ratio[2];

985 
wb
, 
rb
;

988 ià(
bšfo
->
rb©chsize
.
ty³
 =ğ
RND_NORMAL
) {

989 
rb
 = ()
bšfo
->
rb©chsize
.
a
;

990 
wb
 = ()
bšfo
->
wb©chsize
.
a
;

992 
rb
 = ()(
bšfo
->
rb©chsize
.
a
 + bšfo->rb©chsize.
b
) / 2;

993 
wb
 = ()(
bšfo
->
wb©chsize
.
a
 + bšfo->wb©chsize.
b
) / 2;

996 ià(
bšfo
->
¿tio
[1] + binfo->ratio[2] < 100) {

997 *
´ob
 = (
p
 * 
rb
è/ ( (1-p)*
wb
 +…*rb );

999 *
´ob
 = 65536;

1001 
	}
}

1003 
	sb’ch_»suÉ_h™
{

1004 
ušt32_t
 
	midx
;

1005 
ušt64_t
 
	mh™
;

1008 
	sb’ch_»suÉ
{

1009 
b’ch_šfo
 *
	mbšfo
;

1010 
ušt64_t
 
	mndocs
;

1011 
ušt64_t
 
	mnfes
;

1012 
b’ch_»suÉ_h™
 *
	mdoc_h™
;

1013 
b’ch_»suÉ_h™
 *
	mfe_h™
;

1017 #ifdeà
__BENCH_RESULT


1018 
	$_b’ch_»suÉ_š™
(
b’ch_»suÉ
 *
»suÉ
, 
b’ch_šfo
 *
bšfo
)

1021 
ušt64_t
 
i
;

1022 
»suÉ
->
bšfo
 = binfo;

1023 
»suÉ
->
ndocs
 = 
bšfo
->ndocs;

1024 
»suÉ
->
nfes
 = 
bšfo
->nfiles;

1026 
»suÉ
->
doc_h™
 = (
b’ch_»suÉ_h™
*)

1027 
	`m®loc
((
b’ch_»suÉ_h™
è* 
bšfo
->
ndocs
);

1028 
»suÉ
->
fe_h™
 = (
b’ch_»suÉ_h™
*)

1029 
	`m®loc
((
b’ch_»suÉ_h™
è* 
bšfo
->
nfes
);

1030 
	`mem£t
(
»suÉ
->
doc_h™
, 0,

1031 (
b’ch_»suÉ_h™
è* 
bšfo
->
ndocs
);

1032 
	`mem£t
(
»suÉ
->
fe_h™
, 0,

1033 (
b’ch_»suÉ_h™
è* 
bšfo
->
nfes
);

1035 
i
=0;i<
bšfo
->
ndocs
;++i){

1036 
»suÉ
->
doc_h™
[
i
].
idx
 = i;

1038 
i
=0;i<
bšfo
->
nfes
;++i){

1039 
»suÉ
->
fe_h™
[
i
].
idx
 = i;

1041 
	}
}

1043 
	$_b’ch_»suÉ_doc_h™
(
b’ch_»suÉ
 *
»suÉ
, 
ušt64_t
 
idx
)

1045 
»suÉ
->
doc_h™
[
idx
].
h™
++;

1046 
	}
}

1048 
	$_b’ch_»suÉ_fe_h™
(
b’ch_»suÉ
 *
»suÉ
, 
ušt64_t
 
idx
)

1050 
»suÉ
->
fe_h™
[
idx
].
h™
++;

1051 
	}
}

1053 
	$_b’ch_»suÉ_cmp
(cÚ¡ *
a
, cÚ¡ *
b
)

1055 
b’ch_»suÉ_h™
 *
¯
, *
bb
;

1056 
¯
 = (
b’ch_»suÉ_h™
*)
a
;

1057 
bb
 = (
b’ch_»suÉ_h™
*)
b
;

1059 ià(
¯
->
h™
 < 
bb
->hit)  1;

1060 ià(
¯
->
h™
 > 
bb
->hit)  -1;

1062 
	}
}

1064 
	$_b’ch_»suÉ_´št
(
b’ch_»suÉ
 *
»suÉ
)

1066 
buf
[1024];

1067 
size_t
 
keyËn
;

1068 
ušt64_t
 
i
;

1069 
ušt32_t
 
üc
;

1070 
ušt64_t
 
fe_sum
, 
doc_sum
, 
cum
;

1071 
FILE
 *
å
;

1073 
fe_sum
 = 
doc_sum
 = 0;

1075 
	`´štf
("printing bench„esults.. \n");

1077 
i
=0;i<
»suÉ
->
nfes
;++iè
fe_sum
 +ğ»suÉ->
fe_h™
[i].
h™
;

1078 
i
=0;i<
»suÉ
->
ndocs
;++iè
doc_sum
 +ğ»suÉ->
doc_h™
[i].
h™
;

1080 
	`qsÜt
(
»suÉ
->
fe_h™
,„esuÉ->
nfes
,

1081 (
b’ch_»suÉ_h™
), 
_b’ch_»suÉ_cmp
);

1082 
	`qsÜt
(
»suÉ
->
doc_h™
,„esuÉ->
ndocs
,

1083 (
b’ch_»suÉ_h™
), 
_b’ch_»suÉ_cmp
);

1085 
å
 = 
	`fİ’
("result.txt", "w");

1086 
	`årštf
(
å
, "== files ==\n");

1087 
cum
 = 0;

1088 
i
=0;i<
»suÉ
->
nfes
;++i){

1089 
cum
 +ğ
»suÉ
->
fe_h™
[
i
].
h™
;

1091 
	`årštf
(
å
, "%8d%8d%8.1f %%%8.1f %%\n",

1092 ()
»suÉ
->
fe_h™
[
i
].
idx
,

1093 ()
»suÉ
->
fe_h™
[
i
].
h™
,

1094 100.0 * 
»suÉ
->
fe_h™
[
i
].
h™
/ 
fe_sum
,

1095 100.0 * 
cum
 / 
fe_sum
);

1098 
	`årštf
(
å
, "== documents ==\n");

1099 
cum
 = 0;

1100 
i
=0;i<
»suÉ
->
ndocs
;++i){

1101 
cum
 +ğ
»suÉ
->
doc_h™
[
i
].
h™
;

1102 ià(
»suÉ
->
doc_h™
[
i
].
h™
 > 0) {

1103 
	`årštf
(
å
, "%8d%8d%8.1f %%%8.1f %%\n",

1104 ()
»suÉ
->
doc_h™
[
i
].
idx
,

1105 ()
»suÉ
->
doc_h™
[
i
].
h™
,

1106 100.0 * 
»suÉ
->
doc_h™
[
i
].
h™
/ 
doc_sum
,

1107 100.0 * 
cum
 / 
doc_sum
);

1110 
	`fşo£
(
å
);

1111 
	}
}

1113 
	$_b’ch_»suÉ_ä“
(
b’ch_»suÉ
 *
»suÉ
)

1115 
	`ä“
(
»suÉ
->
doc_h™
);

1116 
	`ä“
(
»suÉ
->
fe_h™
);

1117 
	}
}

1120 
	#_b’ch_»suÉ_š™
(
a
,
b
)

	)

1121 
	#_b’ch_»suÉ_doc_h™
(
a
,
b
)

	)

1122 
	#_b’ch_»suÉ_fe_h™
(
a
,
b
)

	)

1123 
	#_b’ch_»suÉ_cmp
(
a
,
b
)

	)

1124 
	#_b’ch_»suÉ_´št
(
a
)

	)

1125 
	#_b’ch_»suÉ_ä“
(
a
)

	)

1128 
	#OP_CLOSE
 (0x01)

	)

1129 
	#OP_CLOSE_OK
 (0x02)

	)

1130 
	#OP_REOPEN
 (0x04)

	)

1131 
	sb’ch_th»ad_¬gs
 {

1132 
	mid
;

1133 
	mcÜeid
;

1134 
	msock‘id
;

1135 
	mcur_qd•th
;

1136 
Db
 **
	mdb
;

1137 
	mmode
;

1138 
	mäªge_begš
;

1139 
	mäªge_’d
;

1140 *
	mcom·ùiÚ_no
;

1141 
ušt32_t
 
	mºd_£ed
;

1142 
b’ch_šfo
 *
	mbšfo
;

1143 
b’ch_»suÉ
 *
	m»suÉ
;

1144 
zf_ºd
 *
	mzf
;

1145 
b’ch_sh¬ed_¡©
 *
	mb_¡©
;

1146 
Ï‹ncy_¡©
 *
	ml_»ad
;

1147 
Ï‹ncy_¡©
 *
	ml_wr™e
;

1148 
Ï‹ncy_¡©
 *
	ml_d–‘e
;

1149 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_»ad
;

1150 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_wr™e
;

1151 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_d–‘e
;

1152 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_™”_key
;

1153 
mempoŞ_t
 *
	mkeypoŞ
;

1154 
mempoŞ_t
 *
	mv®u•oŞ
;

1155 #ifdeà
__TIME_CHECK


1156 
Ï‹ncy_¡©
 *
	ml_´•
;

1157 
Ï‹ncy_¡©
 *
	ml_»®
;

1159 
ušt8_t
 
	m‹rmš©e_sigÇl
;

1160 
ušt8_t
 
	mİ_sigÇl
;

1161 #ià
defšed
(
__BLOBFS_ROCKS_BENCH
)

1166 
	scom·ùÜ_¬gs
 {

1167 *
	mcurfe
;

1168 *
	mÃwfe
;

1169 
b’ch_šfo
 *
	mbšfo
;

1170 
¡İw©ch
 *
	msw_com·ùiÚ
;

1171 
b’ch_th»ad_¬gs
 *
	mb_¬gs
;

1172 *
	mcur_com·ùiÚ
;

1173 
	mb’ch_th»ads
;

1174 
	mcurfe_no
;

1175 
ušt8_t
 
	mæag
;

1176 
¥š_t
 *
	mlock
;

1179 #ià
defšed
(
__COUCH_BENCH
)

1180 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_db
(
Db
 *
db
)

1184  
COUCHSTORE_SUCCESS
;

1185 
	}
}

1188 (*
Şd_hªdËr
)();

1189 
gÙ_sigÇl
 = 0;

1191 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__COUCH_BENCH
)

1193 * 
	$com·ùÜ
(*
void¬gs
)

1195 
com·ùÜ_¬gs
 *
¬gs
 = (com·ùÜ_¬gs*)
void¬gs
;

1196 
¡İw©ch
 *
sw_com·ùiÚ
 = 
¬gs
->sw_compaction;

1197 
Db
 *
db
;

1198 *
curfe
 = 
¬gs
->curfile;

1199 *
Ãwfe
 = 
¬gs
->newfile;

1201 
	`couch¡Üe_İ’_db
(
curfe
,

1202 
COUCHSTORE_OPEN_FLAG_CREATE
 |

1203 ((
¬gs
->
bšfo
->
sync_wr™e
)?(0x10):(0x0)),

1204 &
db
);

1205 
	`¡İw©ch_¡¬t
(
sw_com·ùiÚ
);

1206 
	`couch¡Üe_com·ù_db
(
db
, 
Ãwfe
);

1207 
	`couch¡Üe_şo£_db
(
db
);

1208 
	`¡İw©ch_¡İ
(
sw_com·ùiÚ
);

1210 
	`¥š_lock
(
¬gs
->
lock
);

1211 *(
¬gs
->
cur_com·ùiÚ
) = -1;

1212 ià(
¬gs
->
æag
 & 0x1) {

1213 
»t
, 
i
, 
j
; ()ret;

1214 
şo£_ack
 = 0;

1215 
cmd
[256];

1217 
i
=0; i<
¬gs
->
b’ch_th»ads
; ++i) {

1218 
¬gs
->
b_¬gs
[
i
].
İ_sigÇl
 |ğ
OP_REOPEN
;

1223 
şo£_ack
 = 0;

1224 
j
=0; j<
¬gs
->
b’ch_th»ads
; ++j) {

1225 ià(
¬gs
->
b_¬gs
[
j
].
İ_sigÇl
 == 0) {

1226 
şo£_ack
++;

1229 ià(
şo£_ack
 < 
¬gs
->
b’ch_th»ads
) {

1230 
	`u¦“p
(10000);

1235 ià(
gÙ_sigÇl
) {

1242 
	`¥rštf
(
cmd
, "rm -rà% 2>ƒ¼Ülog.txt", 
curfe
);

1243 
»t
 = 
	`sy¡em
(
cmd
);

1245 
	`¥š_uÆock
(
¬gs
->
lock
);

1247 
	`ä“
(
¬gs
->
curfe
);

1248 
	`ä“
(
¬gs
->
Ãwfe
);

1250  
NULL
;

1251 
	}
}

1255 
	$sigÇl_hªdËr_cÚfœm
(
sig_no
)

1257 *
r
;

1258 
cmd
[1024];

1259 
	`´štf
("\nAre you sureoerminate (y/N)? ");

1260 
r
 = 
	`fg‘s
(
cmd
, 1024, 
¡dš
);

1261 ià(
r
 =ğ
cmd
 && (cmd[0] == 'y' || cmd[0] == 'Y')) {

1262 
	`´štf
("Force benchmark…rogramoerminate.. "

1264 
	`ex™
(0);

1266 
	}
}

1267 
	$sigÇl_hªdËr
(
sig_no
)

1269 
	`´štf
("\n ### got Ctrl+C ### \n");

1270 
	`fæush
(
¡dout
);

1271 
gÙ_sigÇl
 = 1;

1274 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr_cÚfœm
);

1275 
	}
}

1277 
	$_dœ_sÿn
(
b’ch_šfo
 *
bšfo
, *
com·ùiÚ_no
)

1279 
f’ame_Ën
 = 
	`¡¾’
(
bšfo
->
f’ame
);

1280 
dœÇme_Ën
 = 0;

1281 
i
;

1282 
db_no
, 
ıt_no
;

1283 
»suÉ
 = 0;

1284 
dœÇme
[256], *
f’ame
;

1285 
DIR
 *
dœ_šfo
;

1286 
dœ’t
 *
dœ_’Œy
;

1287 
Çme
[256];

1289 ià(
bšfo
->
f’ame
[
f’ame_Ën
-1] == '/') {

1290 
f’ame_Ën
--;

1293 
	`¡ºıy
(
Çme
, 
bšfo
->
f’ame
, 
f’ame_Ën
);

1294 
	`¡ºıy
(
Çme
 + 
f’ame_Ën
, "/dummy", 6);

1311 
	`¡ºıy
(
dœÇme
, 
bšfo
->
f’ame
, 
f’ame_Ën
);

1312 
dœÇme
[
f’ame_Ën
] = 0;

1313 
f’ame
 = 
Çme
 + 
f’ame_Ën
 +1;

1314 
dœ_šfo
 = 
	`İ’dœ
(
dœÇme
);

1315 ià(
dœ_šfo
 !ğ
NULL
) {

1316 (
dœ_’Œy
 = 
	`»addœ
(
dœ_šfo
))) {

1317 ià(!
	`¡ºcmp
(
dœ_’Œy
->
d_Çme
, 
f’ame
, 
	`¡¾’
(filename))) {

1318 
	`årštf
(
¡dout
, "% % %s\n", 
dœ_’Œy
->
d_Çme
, 
f’ame
, 
dœÇme
);

1320 
»suÉ
 = 1;

1321 ià(
com·ùiÚ_no
) {

1322 
	`ssÿnf
(
dœ_’Œy
->
d_Çme
 + (
f’ame_Ën
 - 
dœÇme_Ën
),

1323 "%d.%d", &
db_no
, &
ıt_no
);

1324 
com·ùiÚ_no
[
db_no
] = 
ıt_no
;

1328 
	`şo£dœ
(
dœ_šfo
);

1331  
»suÉ
;

1332 
	}
}

1334 
	sb’ch_sh¬ed_¡©
 {

1336 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_»ad
;

1337 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_wr™e
;

1338 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_d–‘e
;

1339 
	m¡d
::
©omic_ušt_ç¡64_t
 
İ_™”_key
;

1344 
	s™”©e_¬gs
 {

1345 
ušt64_t
 
	mb©chsize
;

1346 
ušt64_t
 
	mcouÁ”
;

1349 
	$™”©e_ÿÎback
(
Db
 *
db
,

1350 
d•th
,

1351 cÚ¡ 
DocInfo
* 
doc_šfo
,

1352 
ušt64_t
 
subŒ“_size
,

1353 cÚ¡ 
sized_buf
* 
»duû_v®ue
,

1354 *
ùx
)

1356 
™”©e_¬gs
 *
¬gs
 = (™”©e_¬g *)
ùx
;

1357 ià(
doc_šfo
) {

1358 
¬gs
->
couÁ”
++;

1359 #ià
	`defšed
(
__COUCH_BENCH
)

1361 
Doc
 *
doc
 = 
NULL
;

1362 
	`couch¡Üe_İ’_doc_w™h_docšfo
(
db
, (
DocInfo
*)
doc_šfo
, &
doc
, 0x0);

1363 
	`couch¡Üe_ä“_docum’t
(
doc
);

1366 ià(
¬gs
->
couÁ”
 <‡rgs->
b©chsize
) {

1371 
	}
}

1373 
	#MAX_BATCHSIZE
 (65536)

	)

1375 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_docum’t_kv
 (
Db
 *
db
,

1376 
sized_buf
 *
key
,sized_buà*
v®ue
,

1377 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
);

1378 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_docum’t_kvrocks
(
Db
 *
db
, cÚ¡ *
id
,

1379 
size_t
 
idËn
, size_ˆ
v®u–’
,

1380 
Doc
 **
pDoc
, 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
);

1381 
couch¡Üe_”rÜ_t
 
couch¡Üe_d–‘e_docum’t_kv
(
Db
 *
db
, 
sized_buf
 *
key
,

1382 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
);

1383 
couch¡Üe_”rÜ_t
 
couch¡Üe_™”©Ü_İ’
(
Db
 *
db
, 
İtiÚs
);

1384 
couch¡Üe_”rÜ_t
 
couch¡Üe_™”©Ü_şo£
(
Db
 *
db
);

1385 
couch¡Üe_”rÜ_t
 
couch¡Üe_™”©Ü_Ãxt
(
Db
 *
db
);

1386 
boŞ
 
couch¡Üe_™”©Ü_check_¡©us
(
Db
 *
db
);

1387 
couch¡Üe_™”©Ü_g‘_num’Œ›s
(
Db
 *
db
);

1388 
couch¡Üe_™”©Ü_has_fšish
(
Db
 *
db
);

1389 * 
	$b’ch_th»ad
(*
void¬gs
)

1391 
b’ch_th»ad_¬gs
 *
¬gs
 = (b’ch_th»ad_¬g *)
void¬gs
;

1392 
size_t
 
i
;

1393 
j
;

1394 
b©chsize
;

1395 
wr™e_mode
 = 0, 
wr™e_mode_r
;

1396 
comm™_mask
[
¬gs
->
bšfo
->
nfes
]; ()commit_mask;

1397 
curfe_no
, 
§m¶šg_ms
, 
mÚ™Üšg
;

1399 
ušt64_t
 
cur_İ_idx
 = 0;

1400 
curfe
[256], 
keybuf
[
MAX_KEYLEN
];

1401 
ušt64_t
 
r
, 
üc
, 
İ_med
;

1403 
ušt64_t
 
ex³ùed_us
, 
–­£d_us
, 
–­£d_£c
;

1404 
ušt64_t
 
cur_§m¶e
;

1405 
Db
 **
db
;

1406 
db_idx
;

1407 
Doc
 *
rq_doc
 = 
NULL
;

1408 
sized_buf
 
rq_id
, 
rq_v®ue
;

1409 
ºdšfo
 
İ_di¡
;

1410 
b’ch_šfo
 *
bšfo
 = 
¬gs
->binfo;

1411 #ifdeà
__BENCH_RESULT


1412 
b’ch_»suÉ
 *
»suÉ
 = 
¬gs
->result;

1414 
zf_ºd
 *
zf
 = 
¬gs
->zipf;

1415 
Ï‹ncy_¡©
 *
l_¡©
;

1416 
¡İw©ch
 
sw
, 
sw_mÚ™Ü
, 
sw_Ï‹ncy
;

1417 
timev®
 
g­
;

1418 
couch¡Üe_”rÜ_t
 
”r
 = 
COUCHSTORE_SUCCESS
;

1419 
keyËn
 = (
bšfo
->keyËn.
ty³
 =ğ
RND_FIXED
)? bšfo->keyËn.
a
 : 0;

1420 
tÙ®_’Œ›s
 = 0;

1421 
™”©Ü_£nd
 = 0;

1423 #ià
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

1425 
rocksdb
::
	`SpdkIn™ŸlizeTh»ad
();

1428 #ià
	`defšed
 (
__FDB_BENCH
è|| defšed(
__WT_BENCH
)

1429 
DocInfo
 *
rq_šfo
 = 
NULL
;

1432 
rq_id
.
buf
 = 
NULL
;

1433 
db
 = 
¬gs
->db;

1434 #ià
defšed
 
__KV_BENCH


1435 
db_idx
 = 
¬gs
->
id
 % 
bšfo
->
nfes
;

1436 #–ià
defšed
 
__BLOBFS_ROCKS_BENCH


1437 
sšgËdb_th»ad_num
 = 
bšfo
->
Ä—d”s
 + bšfo->
n™”©Üs
 + bšfo->
nwr™”s
 + bšfo->
nd–‘”s
;

1438 
db_idx
 = 
¬gs
->
id
 / 
sšgËdb_th»ad_num
;

1440 
db_idx
 = 0;

1442 
İ_med
 = 0;

1443 
–­£d_us
 = 0;

1445 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


1446 if(
bšfo
->
kv_wr™e_mode
 == 0)

1447 
	`·ss_l¡©_to_db
(
db
[
db_idx
], 
¬gs
->
l_»ad
,‡rgs->
l_wr™e
,‡rgs->
l_d–‘e
);

1455 
üc
 = 
¬gs
->
ºd_£ed
 +‡rgs->
id
;

1456 
üc
 = 
	`MurmurHash64A
(&crc, (crc), 0);

1457 
	`BDR_RNG_VARS_SET
(
üc
);

1458 
BDR_RNG_NEXTPAIR
;

1459 
BDR_RNG_NEXTPAIR
;

1460 
BDR_RNG_NEXTPAIR
;

1462 
	`¡İw©ch_š™_¡¬t
(&
sw
);

1463 
	`¡İw©ch_š™_¡¬t
(&
sw_mÚ™Ü
);

1464 ià(
bšfo
->
Ï‹ncy_¿‹
) {

1465 
§m¶šg_ms
 = 1000 / 
bšfo
->
Ï‹ncy_¿‹
;

1467 
§m¶šg_ms
 = 0;

1469 
IoCÚ‹xt_t
 *
cÚ‹xts
[256];

1471 #ià
defšed
 
__KV_BENCH


1473 if(
bšfo
->
w™h_™”©Ü
 > 0) {

1474 if(
bšfo
->
kv_wr™e_mode
 == 1) {

1475 
	`årštf
(
¡dout
, "WARN: Only support iterator under ASYNC mode\n");

1476 
	`ex™
(0);

1478 
	`couch¡Üe_™”©Ü_İ’
(
db
[
db_idx
], 
bšfo
->
™”©Ü_mode
);

1491 
	`årštf
(
¡dout
, "Iterator open done \n");

1495 !
¬gs
->
‹rmš©e_sigÇl
) {

1496 ià(
¬gs
->
İ_sigÇl
 & 
OP_CLOSE
) {

1497 
¬gs
->
İ_sigÇl
 |ğ
OP_CLOSE_OK
;

1498 
¬gs
->
İ_sigÇl
 &ğ~(
OP_CLOSE
);

1499 !(
¬gs
->
İ_sigÇl
 & 
OP_REOPEN
)) {

1500 
	`u¦“p
(10000);

1502 ià(
¬gs
->
İ_sigÇl
 & 
OP_CLOSE
) {

1507 ià(
¬gs
->
İ_sigÇl
 & 
OP_REOPEN
) {

1508 #ià
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

1511 ià((è
bšfo
->
nfes
 > 1)

1512 
	`´štf
("WARN: BlobFS RocksDB has‚ot beenested with‚files > 1\n");

1515 
i
=0; i<
¬gs
->
bšfo
->
nfes
; ++i) {

1516 
	`couch¡Üe_şo£_db
(
¬gs
->
db
[
i
]);

1518 
	`¥rštf
(
curfe
, "%s%d.%d", 
bšfo
->
f’ame
, ()
i
,

1519 
¬gs
->
com·ùiÚ_no
[
i
]);

1520 #ià!
	`defšed
(
__KV_BENCH
è&& !defšed(
__KVV_BENCH
è&& !defšed(
__KVROCKS_BENCH
è&& !defšed(
__AS_BENCH
)

1521 #ià
	`defšed
 (
__BLOBFS_ROCKS_BENCH
)

1522 
	`couch¡Üe_İ’_db
(
curfe
,

1523 0x0, &
¬gs
->
db
[
i
]);

1525 
	`couch¡Üe_İ’_db
(
curfe
, 0x0, &
¬gs
->
db
[
i
]);

1529 
¬gs
->
İ_sigÇl
 = 0;

1546 ià(
bšfo
->
b©ch_di¡
.
ty³
 =ğ
RND_UNIFORM
) {

1548 
BDR_RNG_NEXTPAIR
;

1549 
İ_med
 = 
	`g‘_¿ndom
(&
bšfo
->
b©ch_di¡
, 
ºgz
, 
ºgz2
);

1552 
BDR_RNG_NEXTPAIR
;

1553 
İ_med
 = 
	`zf_ºd_g‘
(
zf
);

1554 
İ_med
 = op_med * 
bšfo
->
b©ch_di¡
.
b
 +

1555 (
ºgz
 % 
bšfo
->
b©ch_di¡
.
b
);

1557 
r
 = 
İ_med
;

1559 ià(
bšfo
->
kv_wr™e_mode
 == 1) {

1561 if(
¬gs
->
mode
 > 0){

1562 
wr™e_mode
 = 
¬gs
->
mode
;

1564 if(
cur_İ_idx
 % 100 < 
bšfo
->
¿tio
[1] + binfo->ratio[2]){

1565 
wr™e_mode
 = 1;

1566 } if(
cur_İ_idx
 % 100 < 
bšfo
->
¿tio
[0] + binfo->ratio[1] + binfo->ratio[2]){

1567 
wr™e_mode
 = 2;

1569 
wr™e_mode
 = 4;

1571 
cur_İ_idx
++;

1574 if(
wr™e_mode
 == 1) {

1575 
	`_ü—‹_doc
(
bšfo
, 
r
, &
rq_doc
, 
NULL
, bšfo->
£q_fl
,

1576 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

1578 ià(
§m¶šg_ms
 &&

1579 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

1580 if(
wr™e_mode
 == 2)

1581 
l_¡©
 = 
¬gs
->
l_»ad
;

1582 if(
wr™e_mode
 == 1)

1583 
l_¡©
 = 
¬gs
->
l_wr™e
;

1585 
l_¡©
 = 
¬gs
->
l_d–‘e
;

1587 
l_¡©
->
cursÜ
++;

1588 ià(
l_¡©
->
cursÜ
 >ğ
bšfo
->
Ï‹ncy_max
) {

1589 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
bšfo
->
Ï‹ncy_max
;

1590 
l_¡©
->
n§m¶es
 = 
bšfo
->
Ï‹ncy_max
;

1592 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
;

1594 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

1595 
	`¡İw©ch_š™_¡¬t
(&
sw_Ï‹ncy
);

1596 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

1597 
mÚ™Üšg
 = 1;

1599 
mÚ™Üšg
 = 0;

1601 #ià
defšed
 
__AS_BENCH


1602 
”r
 = 
	`couch¡Üe_§ve_docum’t
(
NULL
, 
rq_doc
,

1603 
NULL
, 
mÚ™Üšg
);

1604 
	`DeAÎoÿ‹
(
rq_doc
->
id
.
buf
, 
¬gs
->
keypoŞ
);

1605 
rq_doc
->
id
.
buf
 = 
NULL
;

1606 #–ià
defšed
 
__KV_BENCH


1607 
”r
 = 
	`couch¡Üe_§ve_docum’t
(
db
[
db_idx
], 
rq_doc
,

1608 
NULL
, 
mÚ™Üšg
);

1609 
	`DeAÎoÿ‹
(
rq_doc
->
id
.
buf
, 
¬gs
->
keypoŞ
);

1610 
rq_doc
->
id
.
buf
 = 
NULL
;

1612 
”r
 = 
	`couch¡Üe_§ve_docum’t
(
db
[
db_idx
], 
rq_doc
, 
NULL
, 
bšfo
->
com´essiÚ
);

1617 ià(
”r
 !ğ
COUCHSTORE_SUCCESS
) {

1618 
	`årštf
(
¡d”r
,"wr™”rÜ:h»ad %d \n", 
¬gs
->
id
);

1620 } ià(
wr™e_mode
 == 2) {

1622 #ià
defšed
 
__ROCKS_BENCH
 || 
	`defšed
(
__KVDB_BENCH
)

1623 if(
rq_id
.
buf
 =ğ
NULL
èrq_id.buàğ(*)
	`AÎoÿ‹
(
¬gs
->
keypoŞ
);

1624 if(
bšfo
->
keyfe
) {

1625 
rq_id
.
size
 = 
	`keylßd”_g‘_key
(&
bšfo
->
kl
, 
r
, 
rq_doc
->
id
.
buf
);

1627 ià(
bšfo
->
£q_fl
){

1628 
rq_id
.
size
 = 
bšfo
->
keyËn
.
a
;

1629 
	`keyg’_£qfl
(
r
, 
rq_id
.
buf
, 
bšfo
->
keyËn
.
a
);

1631 
rq_id
.
size
 = 
keyËn
;

1632 
	`keyg’_£ed2key
(&
bšfo
->
keyg’
, 
r
, 
rq_id
.
buf
, 
keyËn
);

1636 if(
rq_doc
 =ğ
NULL
èrq_doøğ(
Doc
 *)
	`m®loc
((Doc));

1637 if(
rq_doc
->
id
.
buf
 =ğ
NULL
)

1638 
rq_doc
->
id
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
keypoŞ
);

1640 ià(
bšfo
->
keyfe
) {

1641 
rq_doc
->
id
.
size
 = 
	`keylßd”_g‘_key
(&
bšfo
->
kl
, 
r
,„q_doc->id.
buf
);

1643 ià(
bšfo
->
£q_fl
){

1644 
rq_doc
->
id
.
size
 = 
bšfo
->
keyËn
.
a
;

1645 
	`keyg’_£qfl
(
r
, 
rq_doc
->
id
.
buf
, 
bšfo
->
keyËn
.
a
);

1647 
rq_doc
->
id
.
size
 = 
keyËn
;

1648 
	`keyg’_£ed2key
(&
bšfo
->
keyg’
, 
r
, 
rq_doc
->
id
.
buf
, 
keyËn
 );

1652 if(
rq_doc
->
d©a
.
buf
 =ğ
NULL
)

1653 
rq_doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
v®u•oŞ
);

1655 if(
bšfo
-> 
bodyËn
.
ty³
 =ğ
RND_RATIO
)

1656 
rq_doc
->
d©a
.
size
 = 
	`g‘_v®ue_size_by_¿tio
(
bšfo
, 
r
);

1658 
rq_doc
->
d©a
.
size
 = 
bšfo
->
bodyËn
.
a
;

1661 ià(
§m¶šg_ms
 &&

1662 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

1663 if(
wr™e_mode
 == 2)

1664 
l_¡©
 = 
¬gs
->
l_»ad
;

1665 if(
wr™e_mode
 == 1)

1666 
l_¡©
 = 
¬gs
->
l_wr™e
;

1668 
l_¡©
 = 
¬gs
->
l_d–‘e
;

1669 
l_¡©
->
cursÜ
++;

1670 ià(
l_¡©
->
cursÜ
 >ğ
bšfo
->
Ï‹ncy_max
) {

1671 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
bšfo
->
Ï‹ncy_max
;

1672 
l_¡©
->
n§m¶es
 = 
bšfo
->
Ï‹ncy_max
;

1674 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
;

1676 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

1677 
	`¡İw©ch_š™_¡¬t
(&
sw_Ï‹ncy
);

1678 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

1679 
mÚ™Üšg
 = 1;

1681 
mÚ™Üšg
 = 0;

1684 #ià
defšed
 
__KV_BENCH


1685 
”r
 = 
	`couch¡Üe_İ’_docum’t_kv
(
db
[
db_idx
], &
rq_doc
->
id
,

1686 &
rq_doc
->
d©a
, 
mÚ™Üšg
);

1687 
	`DeAÎoÿ‹
(
rq_doc
->
id
.
buf
, 
¬gs
->
keypoŞ
);

1688 
rq_doc
->
id
.
buf
 = 
NULL
;

1689 
	`DeAÎoÿ‹
(
rq_doc
->
d©a
.
buf
, 
¬gs
->
v®u•oŞ
);

1690 
rq_doc
->
d©a
.
buf
 = 
NULL
;

1692 #–ià
defšed
 
__ROCKS_BENCH
 || 
	`defšed
(
__KVDB_BENCH
)

1693 
”r
 = 
	`couch¡Üe_İ’_docum’t
(
db
[
db_idx
], 
rq_id
.
buf
,

1694 
rq_id
.
size
, 
NULL
, 
mÚ™Üšg
);

1695 #–ià
defšed
 
__KVROCKS_BENCH


1696 
”r
 = 
	`couch¡Üe_İ’_docum’t_kvrocks
(
db
[
db_idx
], 
rq_doc
->
id
.
buf
,

1697 
rq_doc
->
id
.
size
,„q_doc->
d©a
.size,

1698 
NULL
, 
mÚ™Üšg
);

1700 
”r
 = 
	`couch¡Üe_İ’_docum’t
(
db
[
db_idx
], 
rq_doc
->
id
.
buf
,

1701 
rq_doc
->
id
.
size
, 
NULL
, 
mÚ™Üšg
);

1703 #ià
defšed
 
__FDB_BENCH
 || defšed 
__LEVEL_BENCH


1705 
rq_doc
->
id
.
buf
 = 
NULL
;

1706 
	`couch¡Üe_ä“_docum’t
(
rq_doc
);

1707 
rq_doc
 = 
NULL
;

1711 ià(
”r
 !ğ
COUCHSTORE_SUCCESS
) {

1712 
	`´štf
("»adƒ¼Ü: docum’ˆnumb” %" 
_F64
 "\n", 
r
);

1718 if(
rq_doc
 =ğ
NULL
èrq_doøğ(
Doc
 *)
	`m®loc
((Doc));

1719 if(
rq_doc
->
id
.
buf
 =ğ
NULL
)

1720 
rq_doc
->
id
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
keypoŞ
);

1721 ià(
bšfo
->
keyfe
) {

1722 
rq_doc
->
id
.
size
 = 
	`keylßd”_g‘_key
(&
bšfo
->
kl
, 
r
,„q_doc->id.
buf
);

1724 ià(
bšfo
->
£q_fl
){

1725 
rq_doc
->
id
.
size
 = 
bšfo
->
keyËn
.
a
;

1726 
	`keyg’_£qfl
(
r
, 
rq_doc
->
id
.
buf
, 
bšfo
->
keyËn
.
a
);

1728 
rq_doc
->
id
.
size
 = 
keyËn
;

1729 
	`keyg’_£ed2key
(&
bšfo
->
keyg’
, 
r
, 
rq_doc
->
id
.
buf
, 
keyËn
);

1733 if(
rq_doc
->
d©a
.
buf
 =ğ
NULL
)

1734 
rq_doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
v®u•oŞ
);

1735 
rq_doc
->
d©a
.
size
 = 
bšfo
->
bodyËn
.
a
;

1737 ià(
§m¶šg_ms
 &&

1738 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

1739 if(
wr™e_mode
 == 2)

1740 
l_¡©
 = 
¬gs
->
l_»ad
;

1741 if(
wr™e_mode
 == 1)

1742 
l_¡©
 = 
¬gs
->
l_wr™e
;

1744 
l_¡©
 = 
¬gs
->
l_d–‘e
;

1746 
l_¡©
->
cursÜ
++;

1747 ià(
l_¡©
->
cursÜ
 >ğ
bšfo
->
Ï‹ncy_max
) {

1748 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
bšfo
->
Ï‹ncy_max
;

1749 
l_¡©
->
n§m¶es
 = 
bšfo
->
Ï‹ncy_max
;

1751 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
;

1754 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

1755 
	`¡İw©ch_š™_¡¬t
(&
sw_Ï‹ncy
);

1756 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

1757 
mÚ™Üšg
 = 1;

1759 
mÚ™Üšg
 = 0;

1762 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


1763 
	`couch¡Üe_d–‘e_docum’t_kv
(
db
[
db_idx
], &
rq_doc
->
id
, 
mÚ™Üšg
);

1765 
”r
 = 
	`couch¡Üe_d–‘e_docum’t
(
db
[
db_idx
], 
rq_doc
->
id
.
buf
,„q_doc->id.
size
, 
mÚ™Üšg
);

1767 
	`DeAÎoÿ‹
(
rq_doc
->
id
.
buf
, 
¬gs
->
keypoŞ
);

1768 
rq_doc
->
id
.
buf
 = 
NULL
;

1771 ià(
mÚ™Üšg
) {

1772 
g­
 = 
	`¡İw©ch_g‘_cu¹ime
(&
sw_Ï‹ncy
);

1773 
l_¡©
->
§m¶es
[
cur_§m¶e
] = 
	`_timev®_to_us
(
g­
);

1776 if(
wr™e_mode
 == 1) {

1777 
¬gs
->
İ_wr™e
.
	`ãtch_add
(1, 
¡d
::
memÜy_Üd”_»Ëa£
);

1778 } if(
wr™e_mode
 == 2){

1779 
¬gs
->
İ_»ad
.
	`ãtch_add
(1, 
¡d
::
memÜy_Üd”_»Ëa£
);

1781 
¬gs
->
İ_d–‘e
.
	`ãtch_add
(1, 
¡d
::
memÜy_Üd”_»Ëa£
);

1786 #ià!
defšed
 
__KV_BENCH
 && !defšed 
__AS_BENCH


1787 
	`årštf
(
¡d”r
, "Async is‚ot supported inhis‡pplication\n");

1788 
	`ex™
(0);

1791 #ià
defšed
 
__KV_BENCH


1793 if(
bšfo
->
w™h_™”©Ü
 > 0) {

1794 
Ä
 = 0;

1796 if(
bšfo
->
w™h_™”©Ü
 == 2) {

1798 
time¥ec
 
t1
, 
t2
;

1799 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t1
);

1800 
Ä
 = 0;

1803 
	`couch¡Üe_™”©Ü_Ãxt
(
db
[
db_idx
]);

1804  
Ä
 == 0) {

1805 
Ä
 = 
	`g‘ev’ts
(
db
[
db_idx
], 0, 1, 
cÚ‹xts
);

1807 
j
 = 0; j < 
Ä
; j++) {

1808 if(
cÚ‹xts
[
j
]è
	`nÙify
(cÚ‹xts[j], 
¬gs
->
keypoŞ
,‡rgs->
v®u•oŞ
);

1810 
	`»Ëa£_cÚ‹xt
(
db
[
db_idx
], 
cÚ‹xts
, 
Ä
);

1811 
tÙ®_’Œ›s
 +ğ
	`couch¡Üe_™”©Ü_g‘_num’Œ›s
(
db
[
db_idx
]);

1812 
Ä
 = 0;

1813 ià(
	`couch¡Üe_™”©Ü_check_¡©us
(
db
[
db_idx
])) ;

1816 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t2
);

1817 
ušt64_t
 
g­
 = 
t2
.
tv_£c
 * 1000000000L +2.
tv_n£c
 - (
t1
.tv_sec * 1000000000L +1.tv_nsec);

1818 
£c
 = ()
g­
 / 1000000000.00;

1819 
s
 = ()
tÙ®_’Œ›s
 / 
£c
;

1820 
	`årštf
(
¡dout
, "I‹¿tiÚ DÚ- %ld:Ù® %.2à£c,ps: %.2f\n", 
tÙ®_’Œ›s
, 
£c
,
s
);

1821 
gÙ_sigÇl
 = 1;

1826 if(
¬gs
->
cur_qd•th
 < 
bšfo
->
queue_d•th
) {

1827 if(
¬gs
->
‹rmš©e_sigÇl
) ;

1828 #ià
defšed
 
__KV_BENCH


1829 if(
bšfo
->
w™h_™”©Ü
 =ğ1 && 
™”©Ü_£nd
 =ğ0 && 
¬gs
->
cur_qd•th
 < bšfo->
queue_d•th
 - 1) {

1831 ià(!
	`couch¡Üe_™”©Ü_check_¡©us
(
db
[
db_idx
])) {

1832 if(
couch¡Üe_™”©Ü_has_fšish
) {

1833 
	`couch¡Üe_™”©Ü_Ãxt
(
db
[
db_idx
]);

1834 
¬gs
->
cur_qd•th
++;

1835 
™”©Ü_£nd
 = 1;

1838 
	`årštf
(
¡dout
, "Iteration Done \n");

1839 
gÙ_sigÇl
 = 1;

1845 if(
¬gs
->
mode
 > 0){

1846 
wr™e_mode
 = 
¬gs
->
mode
;

1848 if(
cur_İ_idx
 % 100 < 
bšfo
->
¿tio
[1] + binfo->ratio[2]){

1849 
wr™e_mode
 = 1;

1850 } if(
cur_İ_idx
 % 100 < 
bšfo
->
¿tio
[0] + binfo->ratio[1] + binfo->ratio[2]){

1851 
wr™e_mode
 = 2;

1853 
wr™e_mode
 = 4;

1855 
cur_İ_idx
++;

1858 if(
wr™e_mode
 == 1) {

1859 if(
rq_doc
 =ğ
NULL
èrq_doøğ(
Doc
 *)
	`m®loc
((Doc));

1860 
	`_ü—‹_doc
(
bšfo
, 
r
, &
rq_doc
, 
NULL
, bšfo->
£q_fl
,

1861 
¬gs
->
sock‘id
,‡rgs->
keypoŞ
,‡rgs->
v®u•oŞ
);

1862 #ià!
defšed
 
__KV_BENCH
 && !defšed 
__AS_BENCH


1865 ià(
§m¶šg_ms
 &&

1866 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

1867 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

1868 
mÚ™Üšg
 = 1;

1870 
mÚ™Üšg
 = 0;

1873 
”r
 = 
	`couch¡Üe_§ve_docum’t
(
db
[
db_idx
], 
rq_doc
,

1874 
NULL
, 
mÚ™Üšg
);

1878 } if(
wr™e_mode
 == 2) {

1880 if(
rq_doc
 =ğ
NULL
èrq_doøğ(
Doc
 *)
	`m®loc
((Doc));

1881 
rq_doc
->
id
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
keypoŞ
);

1883 ià(
bšfo
->
keyfe
) {

1884 
rq_doc
->
id
.
size
 = 
	`keylßd”_g‘_key
(&
bšfo
->
kl
, 
r
,„q_doc->id.
buf
);

1886 ià(
bšfo
->
£q_fl
){

1887 
rq_doc
->
id
.
size
 = 
bšfo
->
keyËn
.
a
;

1888 
	`keyg’_£qfl
(
r
, 
rq_doc
->
id
.
buf
, 
bšfo
->
keyËn
.
a
);

1890 
rq_doc
->
id
.
size
 = 
keyËn
;

1891 
	`keyg’_£ed2key
(&
bšfo
->
keyg’
, 
r
, 
rq_doc
->
id
.
buf
, 
keyËn
);

1895 #ià
defšed
 
__KV_BENCH


1896 
rq_doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
v®u•oŞ
);

1897 ià(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_RATIO
)

1898 
rq_doc
->
d©a
.
size
 = 
	`g‘_v®ue_size_by_¿tio
(
bšfo
, 
r
);

1900 
rq_doc
->
d©a
.
size
 = 
bšfo
->
bodyËn
.
a
;

1902 ià(
§m¶šg_ms
 &&

1903 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

1904 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

1905 
mÚ™Üšg
 = 1;

1907 
mÚ™Üšg
 = 0;

1910 #ià
defšed
 
__KV_BENCH


1912 
	`couch¡Üe_İ’_docum’t_kv
(
db
[
db_idx
], &
rq_doc
->
id
, &rq_doc->
d©a
, 
mÚ™Üšg
);

1918 
	`couch¡Üe_İ’_docum’t
(
db
[
db_idx
], 
rq_doc
->
id
.
buf
,„q_doc->id.
size
, 
NULL
, 
mÚ™Üšg
);

1921 if(
rq_doc
 =ğ
NULL
èrq_doøğ(
Doc
 *)
	`m®loc
((Doc));

1923 
rq_doc
->
id
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
keypoŞ
);

1924 ià(
bšfo
->
keyfe
) {

1925 
rq_doc
->
id
.
size
 = 
	`keylßd”_g‘_key
(&
bšfo
->
kl
, 
r
,„q_doc->id.
buf
);

1927 ià(
bšfo
->
£q_fl
){

1928 
rq_doc
->
id
.
size
 = 
bšfo
->
keyËn
.
a
;

1929 
	`keyg’_£qfl
(
r
, 
rq_doc
->
id
.
buf
, 
bšfo
->
keyËn
.
a
);

1931 
rq_doc
->
id
.
size
 = 
keyËn
;

1932 
	`keyg’_£ed2key
(&
bšfo
->
keyg’
, 
r
, 
rq_doc
->
id
.
buf
, 
keyËn
);

1936 if(
rq_doc
->
d©a
.
buf
 =ğ
NULL
)

1937 
rq_doc
->
d©a
.
buf
 = (*)
	`AÎoÿ‹
(
¬gs
->
v®u•oŞ
);

1938 
rq_doc
->
d©a
.
size
 = 
bšfo
->
bodyËn
.
a
;

1940 ià(
§m¶šg_ms
 &&

1941 
	`¡İw©ch_check_ms
(&
sw_mÚ™Ü
, 
§m¶šg_ms
)) {

1942 
	`¡İw©ch_¡¬t
(&
sw_mÚ™Ü
);

1943 
mÚ™Üšg
 = 1;

1945 
mÚ™Üšg
 = 0;

1948 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


1949 
	`couch¡Üe_d–‘e_docum’t_kv
(
db
[
db_idx
], &
rq_doc
->
id
, 
mÚ™Üšg
);

1951 
	`couch¡Üe_d–‘e_docum’t
(
db
[
db_idx
], 
rq_doc
->
id
.
buf
,„q_doc->id.
size
, 
mÚ™Üšg
);

1954 
¬gs
->
cur_qd•th
++;

1955 if(
wr™e_mode
 == 1) {

1956 
¬gs
->
İ_wr™e
.
	`ãtch_add
(1, 
¡d
::
memÜy_Üd”_»Ëa£
);

1957 } if(
wr™e_mode
 == 2){

1958 
¬gs
->
İ_»ad
.
	`ãtch_add
(1, 
¡d
::
memÜy_Üd”_»Ëa£
);

1960 
¬gs
->
İ_d–‘e
.
	`ãtch_add
(1, 
¡d
::
memÜy_Üd”_»Ëa£
);

1966 if(
¬gs
->
cur_qd•th
 > 0) {

1969 
Ä
 = 
	`g‘ev’ts
(
db
[
db_idx
], 0, 
¬gs
->
cur_qd•th
, 
cÚ‹xts
);

1970 
j
 = 0; j < 
Ä
; j++) {

1971 if(
cÚ‹xts
[
j
]è
	`nÙify
(cÚ‹xts[j], 
¬gs
->
keypoŞ
,‡rgs->
v®u•oŞ
);

1974 
	`»Ëa£_cÚ‹xt
(
db
[
db_idx
], 
cÚ‹xts
, 
Ä
);

1975 
¬gs
->
cur_qd•th
 -ğ
Ä
;

1977 #ià
defšed
 
__KV_BENCH


1978 if(
bšfo
->
w™h_™”©Ü
 == 1) {

1979 
tÙ®_’Œ›s
 +ğ
	`couch¡Üe_™”©Ü_g‘_num’Œ›s
(
db
[
db_idx
]);

1980 if(
	`couch¡Üe_™”©Ü_has_fšish
(
db
[
db_idx
]))

1981 
™”©Ü_£nd
 = 0;

1983 if(
	`couch¡Üe_™”©Ü_check_¡©us
(
db
[
db_idx
])){

1984 
gÙ_sigÇl
 = 1;

1991 if(
¬gs
->
cur_qd•th
 =ğ
bšfo
->
queue_d•th
)

1992 
	`u¦“p
(1);

1999 #ià
defšed
 
__KV_BENCH
 || defšed 
__AS_BENCH


2000 
Ä
 = 
¬gs
->
cur_qd•th
;

2001 
¬gs
->
cur_qd•th
 > 0 && 
bšfo
->
kv_wr™e_mode
 == 0 ) {

2003 
Ä
 = 
	`g‘ev’ts
(
db
[
db_idx
], 0, 
¬gs
->
cur_qd•th
, 
cÚ‹xts
);

2004 
j
 = 0; j < 
Ä
; j++) {

2005 if(
cÚ‹xts
[
j
]è
	`nÙify
(cÚ‹xts[j], 
¬gs
->
keypoŞ
,‡rgs->
v®u•oŞ
);

2007 
	`»Ëa£_cÚ‹xt
(
db
[
db_idx
], 
cÚ‹xts
, 
Ä
);

2008 
¬gs
->
cur_qd•th
 -ğ
Ä
;

2009 #ià
defšed
 
__KV_BENCH


2010 if(
bšfo
->
w™h_™”©Ü
 == 1) {

2011 
tÙ®_’Œ›s
 +ğ
	`couch¡Üe_™”©Ü_g‘_num’Œ›s
(
db
[
db_idx
]);

2018 #ià
defšed
 
__KV_BENCH


2019 if(
bšfo
->
w™h_™”©Ü
 > 0) {

2020 
Ä
 = 0;

2022 
	`couch¡Üe_™”©Ü_şo£
(
db
[
db_idx
]);

2023 
	`årštf
(
¡dout
, "Iterator close done \n");

2028 
¬gs
->
b_¡©
->
İ_»ad
.
	`ãtch_add
×rgs->İ_»ad.
	`lßd
(), 
¡d
::
memÜy_Üd”_»Ëa£
);

2029 
¬gs
->
b_¡©
->
İ_wr™e
.
	`ãtch_add
×rgs->İ_wr™e.
	`lßd
(), 
¡d
::
memÜy_Üd”_»Ëa£
);

2030 
¬gs
->
b_¡©
->
İ_d–‘e
.
	`ãtch_add
×rgs->İ_d–‘e.
	`lßd
(), 
¡d
::
memÜy_Üd”_»Ëa£
);

2031 
¬gs
->
b_¡©
->
İ_™”_key
.
	`ãtch_add
(
tÙ®_’Œ›s
, 
¡d
::
memÜy_Üd”_»Ëa£
);

2033 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__WT_BENCH
)

2034 ià(
rq_doc
) {

2035 
	`ä“
(
rq_doc
->
id
.
buf
);

2036 
	`ä“
(
rq_doc
->
d©a
.
buf
);

2037 
	`ä“
(
rq_doc
);

2039 ià(
rq_šfo
) {

2040 
	`ä“
(
rq_šfo
);

2044 if(
¬gs
->
keypoŞ
)

2045 
	`de¡roy
(
bšfo
->
®loÿtÜty³
, 
¬gs
->
keypoŞ
);

2046 if(
¬gs
->
v®u•oŞ
)

2047 
	`de¡roy
(
bšfo
->
®loÿtÜty³
, 
¬gs
->
v®u•oŞ
);

2049  
NULL
;

2050 
	}
}

2052 
	$_wa™_Ëv–db_com·ùiÚ
(
b’ch_šfo
 *
bšfo
, 
Db
 **
db
)

2054 
n
=6;

2055 
i
, 
»t
; ()ret;

2056 
buf
[256], 
¡r
[64];

2057 
‹mp
;

2058 
ušt64_t
 
couÁ
=0;

2059 
ušt64_t
 
v®
[
n
];

2060 
FILE
 *
å
;

2062 
i
=0;i<
n
;++i){

2063 
v®
[
i
] = i;

2066 
	`¥rštf
(
buf
, "/´oc/%d/io", 
	`g‘pid
());

2067 
	`fæush
(
¡dout
);

2068 
	`Írštf
("waiting for background compaction of "

2070 
	`fæush
(
¡dout
);

2073 
å
 = 
	`fİ’
(
buf
, "r");

2074 !
	`ãof
(
å
)) {

2075 
»t
 = 
	`fsÿnf
(
å
, "% %lu", 
¡r
, &
‹mp
);

2076 ià(!
	`¡rcmp
(
¡r
, "write_bytes:")) {

2077 
v®
[
couÁ
] = 
‹mp
;

2078 
couÁ
 = (couÁ+1è% 
n
;

2079 
i
=1;i<
n
;++i){

2080 ià(
v®
[
i
-1] !ğv®[i]è
wa™_Ãxt
;

2082 
	`Írštf
(" done\n");

2083 
	`fæush
(
¡dout
);

2084 
	`fşo£
(
å
);

2089 
wa™_Ãxt
:

2090 
	`fşo£
(
å
);

2091 
	`u¦“p
(600000);

2093 
	}
}

2096 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_æags
(
ušt64_t
 
æags
);

2097 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_ÿche
(
ušt64_t
 
size
);

2098 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_¥dk_ÿche
(
ušt64_t
 
size
);

2099 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_com·ùiÚ
(
mode
,

2100 
size_t
 
com·ù_th»s
,

2101 
size_t
 
block_»u£_th»s
);

2102 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_auto_com·ùiÚ_th»ads
(
num_th»ads
);

2103 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_chk_³riod
(
size_t
 
£cÚds
);

2104 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_cÚn
(cÚ¡ *
f’ame
);

2105 
couch¡Üe_”rÜ_t
 
couch¡Üe_şo£_cÚn
();

2106 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_w®_size
(
size_t
 
size
);

2107 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_wbs_size
(
ušt64_t
 
size
);

2108 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_idx_ty³
(
ty³
);

2109 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_sync
(
Db
 *
db
, 
sync
);

2110 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_bloom
(
b™s_³r_key
);

2111 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_com·ùiÚ_¡yË
(
¡yË
);

2112 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_com´essiÚ
(
İt
);

2113 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_¥l™_pù
(
pù
);

2114 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_·ge_size
(
size_t
 
Ëaf_pg_size
, size_ˆ
št_pg_size
);

2116 
couch¡Üe_”rÜ_t
 
couch¡Üe_as_£tup
(cÚ¡ *
ho¡s
,

2117 
ušt16_t
 
pÜt
,

2118 
ušt32_t
 
loİ_ÿ·c™y
,

2119 cÚ¡ *
Çme_¥aû
,

2120 
wr™e_mode
);

2122 
couch¡Üe_”rÜ_t
 
couch¡Üe_£tup_deviû
(cÚ¡ *
dev_·th
,

2123 **
deviû_Çmes
,

2124 *
cÚfig_fe
,

2125 
num_deviûs
, 
wr™e_mode
, 
is_pŞlšg
);

2126 
couch¡Üe_”rÜ_t
 
couch¡Üe_şo£_deviû
(
št32_t
 
dev_id
);

2127 
couch¡Üe_”rÜ_t
 
couch¡Üe_ex™_’v
();

2128 
g‘ev’ts
(
Db
 *
db
, 
mš
, 
max
, 
IoCÚ‹xt
 **
cÚ‹xt
);

2129 
»Ëa£_cÚ‹xt
(
Db
 *
db
, 
IoCÚ‹xt
 **
cÚ‹xts
, 
Ä
);

2130 
couch¡Üe_”rÜ_t
 
couch¡Üe_kvs_£t_aio_İtiÚ
(
queue_d•th
, *
cÜe_masks
, *
cq_th»ad_masks
, 
ušt32_t
 
mem_size_mb
);

2131 
couch¡Üe_”rÜ_t
 
couch¡Üe_kvs_£t_aiÙh»ads
(
aio_th»ads
);

2132 
couch¡Üe_”rÜ_t
 
couch¡Üe_kvs_£t_cÜemask
(*
cÜe_ids
);

2133 
couch¡Üe_”rÜ_t
 
couch¡Üe_kvs_g‘_aiocom¶‘iÚ
(
št32_t
 *
couÁ
);

2135 
	$_dÛs_fe_exi¡
(*
f’ame
) {

2136 
¡©
 
¡
;

2137 
»suÉ
 = 
	`¡©
(
f’ame
, &
¡
);

2138  
»suÉ
 == 0;

2139 
	}
}

2141 *
	$_g‘_dœÇme
(*
f’ame
, *
dœÇme_buf
)

2143 
i
;

2144 
Ën
 = 
	`¡¾’
(
f’ame
);

2147 
i
=
Ën
-1; i>=0; --i){

2148 ià(
f’ame
[
i
] == '/' && i>0) {

2149 
	`memıy
(
dœÇme_buf
, 
f’ame
, 
i
);

2150 
dœÇme_buf
[
i
] = 0;

2151  
dœÇme_buf
;

2154  
NULL
;

2155 
	}
}

2157 *
	$_g‘_f’ame_pos
(*
f’ame
)

2159 
i
;

2160 
Ën
 = 
	`¡¾’
(
f’ame
);

2163 
i
=
Ën
-1; i>=0; --i){

2164 ià(
f’ame
[
i
] == '/') {

2165  
f’ame
 + 
i
 + 1;

2168  
NULL
;

2169 
	}
}

2171 
	$_cmp_ušt32_t
(cÚ¡ *
key1
, cÚ¡ *
key2
)

2173 
ušt32_t
 
a
, 
b
;

2175 
a
 = *(
ušt32_t
*)
key1
;

2176 
b
 = *(
ušt32_t
*)
key2
;

2178 ià(
a
 < 
b
) {

2180 } ià(
a
 > 
b
) {

2185 
	}
}

2187 #ifdeà
__TIME_CHECK


2188 
	$_´št_time
(
Ï‹ncy_¡©
 *
l_´•
, Ï‹ncy_¡© *
l_»®
)

2190 
i
;

2191 if(
tim–og_å
) {

2192 
i
 = 0; i < 
l_´•
->
n§m¶es
; i++) {

2193 
	`årštf
(
tim–og_å
, "%d %d\n", ()
l_´•
->
§m¶es
[
i
], ()
l_»®
->samples[i]);

2196 
	}
}

2199 
	$_´št_Ï‹ncy
(
b’ch_šfo
 *
bšfo
,

2200 
Ï‹ncy_¡©
 *
l_¡©
,

2201 cÚ¡ *
un™
)

2204 
³rûÁe
[6] = {100, 500, 5000, 9500, 9900, 9999};

2205 
ušt64_t
 
i
, 
pos
, 
begš
, 
’d
;

2206 
avg
 = 0;

2208 ià(
l_¡©
->
n§m¶es
 < 100) {

2210 
	`´štf
("nÙƒnough sam¶e %ld\n", 
l_¡©
->
n§m¶es
);

2215 
	`qsÜt
(
l_¡©
->
§m¶es
,†_¡©->
n§m¶es
, (
ušt32_t
), 
_cmp_ušt32_t
);

2218 
begš
 = 
l_¡©
->
n§m¶es
 / 100;

2219 
’d
 = 
l_¡©
->
n§m¶es
*99 / 100;

2220 
i
=
begš
; i<
’d
; ++i){

2221 
avg
 +ğ
l_¡©
->
§m¶es
[
i
];

2223 
avg
 /ğ(
’d
 - 
begš
);

2224 
	`Írštf
("%d samples (%d Hz),‡verage: %.2f %s\n",

2225 ()
l_¡©
->
n§m¶es
, ()
bšfo
->
Ï‹ncy_¿‹
,

2226 
avg
, 
un™
);

2228 
i
=0; i<6; ++i) {

2229 
pos
 = 
l_¡©
->
n§m¶es
 * 
³rûÁe
[
i
] / 10000;

2230 ifĞ
i
 =ğ5 && 
l_¡©
->
n§m¶es
 < 10000){

2231 
	`Írštf
("N/A %s (%.2f%%)",

2232 
un™
, ()
³rûÁe
[
i
] / 100);

2234 
	`Írštf
("%d % (%.2f%%)", ()
l_¡©
->
§m¶es
[
pos
],

2235 
un™
, ()
³rûÁe
[
i
] / 100);

2237 ià(
i
+1 < 6) {

2238 
	`Írštf
(", ");

2240 
	`Írštf
("\n");

2243 
	}
}

2249 
	$_´št_³rûÁe
(
b’ch_šfo
 *
bšfo
,

2250 
Ï‹ncy_¡©
 *
wl_¡©
,

2251 
Ï‹ncy_¡©
 *
¾_¡©
,

2252 
Ï‹ncy_¡©
 *
dl_¡©
,

2253 cÚ¡ *
un™
, 
mode
)

2255 
³rûÁe
[6] = {100, 500, 5000, 9500, 9900, 9999};

2256 
ušt64_t
 
i
, 
pos1
, 
pos2
;

2257 
FILE
 *
tmp
;

2259 if(
wl_¡©
) {

2260 
	`Írštf
("\nwrite†atency distribution\n");

2261 
	`_´št_Ï‹ncy
(
bšfo
, 
wl_¡©
, 
un™
);

2263 if(
¾_¡©
) {

2264 
	`Írštf
("\nread†atency distribution\n");

2265 
	`_´št_Ï‹ncy
(
bšfo
, 
¾_¡©
, 
un™
);

2267 if(
dl_¡©
) {

2268 
	`Írštf
("\ndelete†atency distribution\n");

2269 
	`_´št_Ï‹ncy
(
bšfo
, 
dl_¡©
, 
un™
);

2273 
tmp
 = (
mode
 =ğ1è? 
š£¹_Ï‹ncy_å
 : 
run_Ï‹ncy_å
;

2275 ià(
tmp
) {

2276 
	`årštf
(
tmp
, "pos,write,read,delete\n");

2277 
i
=1;i<100;++i){

2294 ià(
wl_¡©
){

2295 
pos1
 = 
wl_¡©
->
n§m¶es
 * 
i
 / 100;

2296 
	`årštf
(
tmp
, "%d,%d,", ()
i
, ()
wl_¡©
->
§m¶es
[
pos1
]);

2298 
	`årštf
(
tmp
, "%d,0,", ()
i
);

2300 if(
¾_¡©
) {

2301 
pos1
 = 
¾_¡©
->
n§m¶es
 * 
i
 / 100;

2302 
	`årštf
(
tmp
, "%d,", ()
¾_¡©
->
§m¶es
[
pos1
]);

2304 
	`årštf
(
tmp
, "0,");

2306 if(
dl_¡©
) {

2307 
pos1
 = 
dl_¡©
->
n§m¶es
 * 
i
 / 100;

2308 
	`årštf
(
tmp
, "%d\n", ()
dl_¡©
->
§m¶es
[
pos1
]);

2310 
	`årštf
(
tmp
, "0\n");

2314 
	}
}

2316 
	$db_’v_£tup
(
b’ch_šfo
 *
bšfo
){

2318 #ià!
	`defšed
(
__COUCH_BENCH
è&& !defšed(
__KV_BENCH
è&& !defšed(
__KVROCKS_BENCH
è&& !defšed(
__AS_BENCH
)

2319 
	`couch¡Üe_£t_ÿche
(
bšfo
->
ÿche_size
);

2320 
	`couch¡Üe_£t_com´essiÚ
(
bšfo
->
com´essiÚ
);

2323 #ià
	`defšed
(
__FDB_BENCH
)

2325 
	`couch¡Üe_£t_com·ùiÚ
(
bšfo
->
auto_com·ùiÚ
,

2326 
bšfo
->
com·ù_th»s
,

2327 
bšfo
->
block_»u£_th»s
);

2328 
	`couch¡Üe_£t_idx_ty³
(
bšfo
->
fdb_ty³
);

2329 
	`couch¡Üe_£t_w®_size
(
bšfo
->
fdb_w®
);

2330 
	`couch¡Üe_£t_auto_com·ùiÚ_th»ads
(
bšfo
->
auto_com·ùiÚ_th»ads
);

2332 #ià
	`defšed
(
__WT_BENCH
è|| defšed(
__FDB_BENCH
)

2334 
	`couch¡Üe_£t_chk_³riod
(
bšfo
->
com·ù_³riod
);

2337 #ià
	`defšed
(
__ROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed (
__LEVEL_BENCH
è|| defšed(
__KVDB_BENCH
)

2339 #ià!
	`defšed
 (
__LEVEL_BENCH
)

2340 ià(
bšfo
->
com·ùiÚ_¡yË
) {

2341 
	`couch¡Üe_£t_com·ùiÚ_¡yË
(
bšfo
->
com·ùiÚ_¡yË
);

2344 
	`couch¡Üe_£t_bloom
(
bšfo
->
bloom_bpk
);

2346 #ià
	`defšed
(
__WT_BENCH
)

2348 
	`couch¡Üe_£t_¥l™_pù
(
bšfo
->
¥l™_pù
);

2349 
	`couch¡Üe_£t_·ge_size
(
bšfo
->
Ëaf_pg_size
, bšfo->
št_pg_size
);

2352 #ià
	`defšed
(
__KV_BENCH
)

2355 
	`couch¡Üe_kvs_£t_aio_İtiÚ
(
bšfo
->
queue_d•th
, bšfo->
cÜe_ids
, bšfo->
cq_th»ad_ids
, bšfo->
mem_size_mb
);

2356 
	`couch¡Üe_kvs_£t_aiÙh»ads
(
bšfo
->
aiÙh»ads_³r_deviû
);

2357 
	`couch¡Üe_kvs_£t_cÜemask
(
bšfo
->
cÜe_ids
);

2359 
	`couch¡Üe_£tup_deviû
(
bšfo
->
kv_deviû_·th
, 
NULL
, bšfo->
kv_emul_cÚfigfe
, bšfo->
nfes
, bšfo->
kv_wr™e_mode
, 0 );

2361 #ià
	`defšed
(
__AS_BENCH
)

2363 
	`couch¡Üe_as_£tup
(
bšfo
->
deviû_·th
, bšfo->
as_pÜt
, bšfo->
loİ_ÿ·c™y
, bšfo->
Çme_¥aû
, bšfo->
kv_wr™e_mode
);

2365 #ià
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

2366 
	`couch¡Üe_£t_¥dk_ÿche
(
bšfo
->
¥dk_ÿche_size
);

2367 
	`couch¡Üe_£tup_deviû
(
bšfo
->
f’ame
, bšfo->
deviû_Çme
,

2368 
bšfo
->
¥dk_cÚf_fe
, bšfo->
nfes
, 0, 0);

2371 
	}
}

2373 
	$do_b’ch
(
b’ch_šfo
 *
bšfo
)

2375 
BDR_RNG_VARS
;

2376 
i
, 
j
, 
»t
; ()j; ()ret;

2377 
curfe_no
, 
com·ùiÚ_tuº
;

2378 
com·ùiÚ_no
[
bšfo
->
nfes
], 
tÙ®_com·ùiÚ
 = 0;

2379 
cur_com·ùiÚ
 = -1;

2380 
b’ch_th»ads
, 
sšgËdb_th»ad_num
, 
fœ¡_db_idx
;

2381 
ušt64_t
 
İ_couÁ_»ad
, 
İ_couÁ_wr™e
, 
İ_couÁ_d–‘e
, 
İ_couÁ_™”_key
, 
di¥Ïy_tick
 = 0;

2382 
ušt64_t
 
´ev_İ_couÁ_»ad
, 
´ev_İ_couÁ_wr™e
, 
´ev_İ_couÁ_d–‘e
;

2383 
ušt64_t
 
wr™‹n_š™
, 
wr™‹n_fš®
, 
wr™‹n_´ev
;

2384 
ušt64_t
 
Çnd_wr™‹n_š™
, 
Çnd_wr™‹n_fš®
;

2385 
ušt64_t
 
avg_docsize
;

2386 
curfe
[256], 
Ãwfe
[256], 
bodybuf
[1024], 
cmd
[256];

2387 
fsize1
[128], 
fsize2
[128], *
¡r
;

2388 
¥aûs
[128];

2389 *
com·ùÜ_»t
;

2390 **
b’ch_wÜk”_»t
;

2391 
g­_doubË
;

2392 
boŞ
 
w¬mšgup
 = 
çl£
;

2393 
boŞ
 
¡¬og
 = 
çl£
;

2394 #ià
defšed
 
__AS_BENCH


2395 
Db
 *
db
[
bšfo
->
nfes
 * bšfo->
pİ_Áh»ads
];

2397 
Db
 *
db
[
bšfo
->
nfes
];

2400 #ifdeà
__FDB_BENCH


2401 
Db
 *
šfo_hªdË
[
bšfo
->
nfes
];

2403 #ià
	`defšed
(
__KV_BENCH
è|| defšed(
__AS_BENCH
è|| defšed(
__KVROCKS_BENCH
)

2405 *
dev_·th
[
bšfo
->
nfes
];

2407 #ià
	`defšed
(
__AS_BENCH
)

2409 cÚ¡ *
ho¡
;

2410 
ušt16_t
 
pÜt
;

2412 #ifdeà
__BLOBFS_ROCKS_BENCH


2415 
DbInfo
 *
dbšfo
;

2416 
th»ad_t
 
tid_com·ùÜ
;

2417 
th»ad_t
 *
b’ch_wÜk”
;

2418 
¥š_t
 
cur_com·ùiÚ_lock
;

2419 
¡İw©ch
 
sw
, 
sw_com·ùiÚ
, 
´og»ss
;

2420 
timev®
 
g­
, 
_g­
;

2421 
zf_ºd
 
zf
;

2422 
b’ch_»suÉ
 
»suÉ
;

2423 
b’ch_sh¬ed_¡©
 
b_¡©
;

2424 
b’ch_th»ad_¬gs
 *
b_¬gs
;

2426 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__COUCH_BENCH
)

2427 
com·ùÜ_¬gs
 
c_¬gs
;

2429 
FILE
 *
tmp
;

2431 
	`memËak_¡¬t
();

2433 
	`¥š_š™
(&
cur_com·ùiÚ_lock
);

2435 
dbšfo
 = (
DbInfo
 *)
	`m®loc
((DbInfo));

2436 
	`¡İw©ch_š™
(&
sw
);

2437 
	`¡İw©ch_š™
(&
sw_com·ùiÚ
);

2439 
	`_b’ch_»suÉ_š™
(&
»suÉ
, 
bšfo
);

2441 
wr™‹n_š™
 = 
wr™‹n_fš®
 = 
wr™‹n_´ev
 = 0;

2442 
	`mem£t
(&
tid_com·ùÜ
, 0x0, (tid_compactor));

2444 ià(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_NORMAL
 || bšfo->bodyËn.ty³ =ğ
RND_FIXED
) {

2445 
avg_docsize
 = 
bšfo
->
bodyËn
.
a
;

2447 
avg_docsize
 = (
bšfo
->
bodyËn
.
a
 + bšfo->bodyËn.
b
)/2;

2450 ià(
bšfo
->
keyËn
.
ty³
 =ğ
RND_NORMAL
 || bšfo->keyËn.ty³ =ğ
RND_FIXED
) {

2451 
avg_docsize
 +ğ
bšfo
->
keyËn
.
a
;

2453 
avg_docsize
 +ğ((
bšfo
->
keyËn
.
a
 + bšfo->keyËn.
b
)/2);

2456 
	`¡rıy
(
fsize1
, 
	`´št_fesize_­´ox
(0, 
cmd
));

2457 
	`¡rıy
(
fsize2
, 
	`´št_fesize_­´ox
(0, 
cmd
));

2458 
	`mem£t
(
¥aûs
, ' ', 80);

2459 
¥aûs
[80] = 0;

2461 
	`db_’v_£tup
(
bšfo
);

2463 #ià
	`defšed
(
__KV_BENCH
è|| defšed (
__KVROCKS_BENCH
)

2466 *
±
;

2467 
i
 = 0;

2468 
±
 = 
	`¡¹ok
 (
bšfo
->
kv_deviû_·th
, ",");

2469 
±
 !ğ
NULL
) {

2470 
dev_·th
[
i
++] = 
±
;

2471 
±
 = 
	`¡¹ok
 (
NULL
, ",");

2475 ià(
bšfo
->
š™Ÿlize
) {

2477 #ià!
	`defšed
 (
__KV_BENCH
è&& !defšed(
__KVROCKS_BENCH
è&& !defšed(
__AS_BENCH
)

2479 ià(
	`_dœ_sÿn
(
bšfo
, 
NULL
)) {

2481 
ªsw”
[64], *
»t
;

2482 
	`mem£t
(
ªsw”
, 0x0, (answer));

2483 
	`Írštf
("\nPrevious DB file‡lreadyƒxists. "

2485 
»t
 = 
	`fg‘s
(
ªsw”
, ×nsw”), 
¡dš
);

2486 ià(
»t
 && !(
ªsw”
[0] == 'Y' ||‡nswer[0] == 'y')) {

2487 
	`Írštf
("Terminate benchmark ..\n\n");

2489 
	`ä“
(
dbšfo
);

2490 
	`_b’ch_»suÉ_ä“
(&
»suÉ
);

2491 
	`memËak_’d
();

2497 
	`Írštf
("\ninitialize\n");

2498 
	`¥rštf
(
cmd
, "rm -rà%s*/* 2>ƒ¼Ülog.txt", 
bšfo
->
f’ame
);

2499 
»t
 = 
	`sy¡em
(
cmd
);

2502 ià(!
	`_dÛs_fe_exi¡
(
bšfo
->
f’ame
)){

2503 
	`´štf
("ü—‹ %s\n", 
bšfo
->
f’ame
);

2504 
	`¥rštf
(
cmd
, "mkdœ -°% >ƒ¼Ülog.txt", 
bšfo
->
f’ame
);

2505 
»t
 = 
	`sy¡em
(
cmd
);

2509 ià(
bšfo
->
pİ_fœ¡
) {

2510 #ià
	`defšed
(
__WT_BENCH
)

2512 
	`couch¡Üe_£t_idx_ty³
(
bšfo
->
wt_ty³
);

2513 
	`couch¡Üe_İ’_cÚn
((*)
bšfo
->
f’ame
);

2515 #ià
	`defšed
(
__LEVEL_BENCH
è|| defšed(
__ROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

2517 
	`couch¡Üe_£t_wbs_size
(
bšfo
->
wbs_š™
);

2521 #ià
defšed
 
__AS_BENCH


2522 
i
 = 0; i < ()
bšfo
->
nfes
 * bšfo->
pİ_Áh»ads
; ++i) {

2523 
	`couch¡Üe_İ’_db
(
curfe
, 
COUCHSTORE_OPEN_FLAG_CREATE
, &
db
[
i
]);

2526 
i
=0; i<()
bšfo
->
nfes
; ++i){

2527 
com·ùiÚ_no
[
i
] = 0;

2528 
	`¥rštf
(
curfe
, "%s/%d", 
bšfo
->
š™_f’ame
, 
i
);

2529 
	`´štf
("db %d‚ami %s\n", 
i
, 
curfe
);

2531 #ià
	`defšed
(
__KV_BENCH
)

2532 
	`couch¡Üe_İ’_db_kvs
(
dev_·th
[
i
], &
db
[i], i);

2534 #–ià
	`defšed
(
__KVROCKS_BENCH
)

2535 
	`årštf
(
¡dout
, "==ğİ’šg dev %s\n", 
dev_·th
[
i
]);

2536 
	`couch¡Üe_İ’_db
(
dev_·th
[
i
], 
COUCHSTORE_OPEN_FLAG_CREATE
, &
db
[i]);

2538 #ià
	`defšed
(
__FDB_BENCH
)

2539 ià(!
bšfo
->
pİ_comm™
) {

2542 
	`couch¡Üe_£t_æags
(0x1);

2545 
	`couch¡Üe_İ’_db
(
curfe
, 
COUCHSTORE_OPEN_FLAG_CREATE
, &
db
[
i
]);

2547 #ià
	`defšed
(
__LEVEL_BENCH
è|| defšed(
__ROCKS_BENCH
è|| defšed(
__KVROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

2548 ià(!
bšfo
->
pİ_comm™
) {

2549 
	`couch¡Üe_£t_sync
(
db
[
i
], 0);

2555 
	`¡İw©ch_¡¬t
(&
sw
);

2556 
	`pİuÏtiÚ
(
db
, 
bšfo
);

2558 #ià 
	`defšed
(
__PRINT_IOSTAT
) && \

2559 (
	`defšed
(
__LEVEL_BENCH
è|| defšed(
__ROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
))

2561 
g­
 = 
	`¡İw©ch_¡İ
(&
sw
);

2562 
	`LOG_PRINT_TIME
(
g­
, " secƒlapsed\n");

2566 #ià!
	`defšed
(
__KV_BENCH
è&& !defšed (
__KVROCKS_BENCH
è&& !defšed(
__AS_BENCH
)

2567 ià(
bšfo
->
sync_wr™e
) {

2568 
	`fæush
(
¡dout
);

2569 
	`¥rštf
(
cmd
, "sync");

2570 
»t
 = 
	`sy¡em
(
cmd
);

2571 
	`fæush
(
¡dout
);

2575 #ià!
defšed
 
__KV_BENCH
 && !defšed 
__AS_BENCH


2576 
wr™‹n_fš®
 = 
wr™‹n_š™
 = 
	`´št_´oc_io_¡©
(
cmd
, 1);

2577 
wr™‹n_´ev
 = 
wr™‹n_fš®
;

2578 
waf_a
;

2579 
ušt64_t
 
w_³r_doc
 = ()
wr™‹n_fš®
 / 
bšfo
->
ndocs
;

2580 
waf_a
 = ()
w_³r_doc
 / 
avg_docsize
;

2581 
	`Írštf
("%s written…er doc update (%.1f x write‡mplification)\n",

2582 
	`´št_fesize_­´ox
(
w_³r_doc
, 
bodybuf
), 
waf_a
);

2585 #ià!
defšed
 
__KVROCKS_BENCH
 && !defšed 
__KV_BENCH
 && !defšed 
__BLOBFS_ROCKS_BENCH


2586 #ià
defšed
 
__AS_BENCH


2587 
i
=0; i<()
bšfo
->
nfes
 * bšfo->
pİ_Áh»ads
; ++i){

2588 
	`´štf
("şo£ db %d\n", 
i
);

2589 
	`couch¡Üe_şo£_db
(
db
[
i
]);

2592 
i
=0; i<()
bšfo
->
nfes
; ++i){

2593 
	`´štf
("şo£ db %d\n", 
i
);

2594 
	`couch¡Üe_şo£_db
(
db
[
i
]);

2598 
g­
 = 
	`¡İw©ch_¡İ
(&
sw
);

2599 #ià
	`defšed
(
__LEVEL_BENCH
è|| defšed(
__ROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

2600 #ià
	`defšed
(
__PRINT_IOSTAT
)

2601 
g­
.
tv_£c
 -= 3;

2604 
g­_doubË
 = 
g­
.
tv_£c
 + ()g­.
tv_u£c
 / 1000000.0;

2605 
	`LOG_PRINT_TIME
(
g­
, " secƒlapsed ");

2606 
	`Írštf
("(%.2àİs/£c)\n", 
bšfo
->
ndocs
 * bšfo->
nfes
 / 
g­_doubË
);

2608 
	`årštf
(
¡dout
, "Start benchmark without…opulation\n");

2609 #ià
	`defšed
(
__KV_BENCH
)

2610 
i
=0; i<()
bšfo
->
nfes
; ++i){

2611 
	`couch¡Üe_İ’_db_kvs
(
dev_·th
[
i
], &
db
[i], i);

2614 #–ià
	`defšed
(
__KVROCKS_BENCH
)

2615 
i
=0; i<()
bšfo
->
nfes
; ++i){

2616 
	`couch¡Üe_İ’_db
(
dev_·th
[
i
], 
COUCHSTORE_OPEN_FLAG_CREATE
, &
db
[i]);

2618 #–ià
	`defšed
 (
__AS_BENCH
)

2625 
	`¡İw©ch_¡¬t
(&
sw
);

2626 
i
=0; i<()
bšfo
->
nfes
; ++i) {

2627 
com·ùiÚ_no
[
i
] = 0;

2629 #ià
	`defšed
(
__WT_BENCH
)

2631 
	`couch¡Üe_İ’_cÚn
((*)
bšfo
->
f’ame
);

2632 #–ià
	`defšed
 (
__ROCKS_BENCH
è|| defšed (
__FDB_BENCH
è|| defšed (
__LEVEL_BENCH
è|| defšed(
__KVDB_BENCH
)

2633 
	`_dœ_sÿn
(
bšfo
, 
com·ùiÚ_no
);

2634 #–ià
	`defšed
 (
__KV_BENCH
)

2635 
i
=0; i<()
bšfo
->
nfes
; ++i){

2636 
	`couch¡Üe_İ’_db_kvs
(
dev_·th
[
i
], &
db
[i], i);

2643 
	`Írštf
("\nbenchmark\n");

2644 
	`Írštf
("opening DB instance .. \n");

2646 
com·ùiÚ_tuº
 = 0;

2648 #ià
	`defšed
(
__ROCKS_BENCH
è|| defšed (
__LEVEL_BENCH
è|| defšed(
__KVDB_BENCH
)

2649 
	`couch¡Üe_£t_wbs_size
(
bšfo
->
wbs_b’ch
);

2651 #ià
	`defšed
(
__FDB_BENCH
)

2655 ià(
bšfo
->
sync_wr™e
) {

2656 
	`couch¡Üe_£t_æags
(0x0);

2658 
	`couch¡Üe_£t_æags
(0x10);

2662 ià(
bšfo
->
b©ch_di¡
.
ty³
 =ğ
RND_ZIPFIAN
) {

2664 if(
bšfo
->
nİs
 > 0) {

2665 
	`zf_ºd_š™
(&
zf
, (
bšfo
->
ndocs
 + bšfo->
nİs
 * bšfo->
¿tio
[2] * 2è/ bšfo->
b©ch_di¡
.
b
,

2666 
bšfo
->
b©ch_di¡
.
a
/100.0, 1024*1024);

2668 
	`zf_ºd_š™
(&
zf
, 
bšfo
->
ndocs
 * bšfo->
amp_çùÜ
 / bšfo->
b©ch_di¡
.
b
,

2669 
bšfo
->
b©ch_di¡
.
a
/100.0, 1024*1024);

2674 
Şd_hªdËr
 = 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

2675 
b_¡©
.
İ_»ad
 = b_¡©.
İ_wr™e
ğb_¡©.
İ_d–‘e
 = b_¡©.
İ_™”_key
 = 0;

2686 
sšgËdb_th»ad_num
 = 
bšfo
->
Ä—d”s
 + bšfo->
n™”©Üs
 + bšfo->
nwr™”s
 + bšfo->
nd–‘”s
;

2687 
b’ch_th»ads
 = 
sšgËdb_th»ad_num
 * 
bšfo
->
nfes
;

2688 #ià
defšed
 
__KV_BENCH


2690 
b’ch_th»ads
 = 
bšfo
->
nfes
;

2693 
b_¬gs
 = 
	`®ÿ
(
b’ch_th»ad_¬gs
, 
b’ch_th»ads
);

2694 
b’ch_wÜk”
 = 
	`®ÿ
(
th»ad_t
, 
b’ch_th»ads
);

2697 
±h»ad_©Œ_t
 
©Œ
[
b’ch_th»ads
];

2698 
ıu_£t_t
 
ıus
;

2700 
db_idx
, 
td_idx
, 
nodeid
;

2701 
tÙ®_¿tio
 = 
bšfo
->
¿tio
[0] + binfo->ratio[1] + binfo->ratio[2] + binfo->ratio[3];

2702 
poŞ_šfo_t
 
šfo_key
, 
šfo_v®ue
;

2704 
šfo_key
.
®loÿtÜty³
 = 
šfo_v®ue
.®loÿtÜty³ = 
bšfo
->allocatortype;

2705 
šfo_key
.
numun™s
 = 
bšfo
->
kp_numun™s
;

2706 
šfo_key
.
un™size
 = 
bšfo
->
kp_un™size
;

2707 
šfo_key
.
®ignm’t
 = 
bšfo
->
kp_®ignm’t
;

2708 
šfo_v®ue
.
numun™s
 = 
bšfo
->
vp_numun™s
;

2709 
šfo_v®ue
.
un™size
 = 
bšfo
->
vp_un™size
;

2710 
šfo_v®ue
.
®ignm’t
 = 
bšfo
->
vp_®ignm’t
;

2712 
i
=0;i<
b’ch_th»ads
;++i){

2713 if(
tÙ®_¿tio
 > 0 &&otal_ratio <= 100) {

2714 
b_¬gs
[
i
].
mode
 = 0;

2716 ià((
size_t
)
i
 % 
sšgËdb_th»ad_num
 < 
bšfo
->
nwr™”s
) {

2717 
b_¬gs
[
i
].
mode
 = 1;

2718 } ià((
size_t
)
i
 % 
sšgËdb_th»ad_num
 < 
bšfo
->
nwr™”s
 + bšfo->
Ä—d”s
) {

2719 
b_¬gs
[
i
].
mode
 = 2;

2720 } ià((
size_t
)
i
 % 
sšgËdb_th»ad_num
 < 
bšfo
->
nwr™”s
 +

2721 
bšfo
->
Ä—d”s
 + bšfo->
n™”©Üs
){

2722 
b_¬gs
[
i
].
mode
 = 3;

2724 
b_¬gs
[
i
].
mode
 = 4;

2728 
b_¬gs
[
i
].
id
 = i;

2729 
b_¬gs
[
i
].
ºd_£ed
 =„nd_seed;

2730 
b_¬gs
[
i
].
com·ùiÚ_no
 = compaction_no;

2731 
b_¬gs
[
i
].
b_¡©
 = &b_stat;

2732 
b_¬gs
[
i
].
l_»ad
 = (
Ï‹ncy_¡©
 *)
	`ÿÎoc
(1, (latency_stat));

2733 
b_¬gs
[
i
].
l_wr™e
 = (
Ï‹ncy_¡©
 *)
	`ÿÎoc
(1, (latency_stat));

2734 
b_¬gs
[
i
].
l_d–‘e
 = (
Ï‹ncy_¡©
 *)
	`ÿÎoc
(1, (latency_stat));

2735 
b_¬gs
[
i
].
l_»ad
->
§m¶es
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* 
bšfo
->
Ï‹ncy_max
);

2736 
b_¬gs
[
i
].
l_wr™e
->
§m¶es
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* 
bšfo
->
Ï‹ncy_max
);

2737 
b_¬gs
[
i
].
l_d–‘e
->
§m¶es
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* 
bšfo
->
Ï‹ncy_max
);

2738 
b_¬gs
[
i
].
İ_»ad
 = b_¬gs[i].
İ_wr™e
 = b_¬gs[i].
İ_d–‘e
 = b_¬gs[i].
İ_™”_key
 = 0;

2739 
b_¬gs
[
i
].
cur_qd•th
 = 0;

2742 
b_¬gs
[
i
].
zf
 = &zipf;

2743 
b_¬gs
[
i
].
‹rmš©e_sigÇl
 = 0;

2744 
b_¬gs
[
i
].
İ_sigÇl
 = 0;

2745 
b_¬gs
[
i
].
bšfo
 = binfo;

2747 
b_¬gs
[
i
].
keypoŞ
 = (
mempoŞ_t
 *)
	`m®loc
((mempool_t));

2748 
b_¬gs
[
i
].
keypoŞ
->
ba£
 = b_¬gs[i].keypoŞ->
Ãxtä“block
 = 
NULL
;

2749 
	`poŞ_£tup
(&
šfo_key
, 
b_¬gs
[
i
].
keypoŞ
, 
nodeid
);

2751 
b_¬gs
[
i
].
v®u•oŞ
 = (
mempoŞ_t
 *)
	`m®loc
((mempool_t));

2752 
b_¬gs
[
i
].
v®u•oŞ
->
ba£
 = b_¬gs[i].v®u•oŞ->
Ãxtä“block
 = 
NULL
;

2753 
	`poŞ_£tup
(&
šfo_v®ue
, 
b_¬gs
[
i
].
v®u•oŞ
, 
nodeid
);

2756 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__COUCH_BENCH
è|| defšed(
__WT_BENCH
)

2757 
b_¬gs
[
i
].
db
 = (
Db
**)
	`m®loc
((Db*è* 
bšfo
->
nfes
);

2758 
j
=0; j<()
bšfo
->
nfes
; ++j){

2759 
	`¥rštf
(
curfe
, "%s%d.%d", 
bšfo
->
f’ame
, 
j
, 
com·ùiÚ_no
[j]);

2760 
	`couch¡Üe_İ’_db
(
curfe
,

2761 
COUCHSTORE_OPEN_FLAG_CREATE
 |

2762 ((
bšfo
->
sync_wr™e
)?(0x10):(0x0)),

2763 &
b_¬gs
[
i
].
db
[
j
]);

2764 #ià
	`defšed
(
__FDB_BENCH
)

2766 ià(
i
==0) {

2767 
	`couch¡Üe_İ’_db
(
curfe
,

2768 
COUCHSTORE_OPEN_FLAG_CREATE
 |

2769 ((
bšfo
->
sync_wr™e
)?(0x10):(0x0)),

2770 &
šfo_hªdË
[
j
]);

2774 #–ià
	`defšed
(
__ROCKS_BENCH
è|| defšed (
__LEVEL_BENCH
è|| defšed(
__KVDB_BENCH
)

2775 ià(
i
 % 
sšgËdb_th»ad_num
 ==0) {

2776 
b_¬gs
[
i
].
db
 = (
Db
**)
	`m®loc
((Db*));

2777 
	`¥rštf
(
curfe
, "%s/%d", 
bšfo
->
f’ame
, 
i
 / 
sšgËdb_th»ad_num
);

2778 
	`couch¡Üe_İ’_db
(
curfe
,

2779 
COUCHSTORE_OPEN_FLAG_CREATE
, &
b_¬gs
[
i
].
db
[0]);

2780 
	`couch¡Üe_£t_sync
(
b_¬gs
[
i
].
db
[0], 
bšfo
->
sync_wr™e
);

2782 
fœ¡_db_idx
 = 
i
 / 
sšgËdb_th»ad_num
 * singledb_thread_num;

2783 
b_¬gs
[
i
].
db
 = b_¬gs[
fœ¡_db_idx
].db;

2786 #–ià
	`defšed
 (
__KVROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
)

2787 
b_¬gs
[
i
].
db
 = db;

2788 #–ià
	`defšed
(
__KV_BENCH
)

2798 
b_¬gs
[
i
].
db
 = db;

2800 #ià
	`defšed
(
__AS_BENCH
)

2802 
b_¬gs
[
i
].
db
 = (
Db
**)
	`m®loc
((Db*));

2803 
	`couch¡Üe_İ’_db
(
curfe
, 
COUCHSTORE_OPEN_FLAG_CREATE
, &
b_¬gs
[
i
].
db
[0]);

2805 #ià
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

2809 
db_idx
 = 
i
 / 
sšgËdb_th»ad_num
;

2810 
td_idx
 = 
i
 % 
sšgËdb_th»ad_num
;

2811 
nodeid
 = 
bšfo
->
š¡ªûs
[
db_idx
].
nodeid_³rf
;

2813 
	`±h»ad_©Œ_š™
(&
©Œ
[
i
]);

2814 
b_¬gs
[
i
].
sock‘id
 = 
nodeid
;

2816 if(
bšfo
->
š¡ªûs
[
db_idx
].
cÜeids_b’ch
[
td_idx
] != -1) {

2817 
	`CPU_ZERO
(&
ıus
);

2818 
	`CPU_SET
(
bšfo
->
š¡ªûs
[
db_idx
].
cÜeids_b’ch
[
td_idx
], &
ıus
);

2819 
	`±h»ad_©Œ_£ffš™y_Å
(&
©Œ
[
i
], (
ıu_£t_t
), &
ıus
);

2820 } if(
nodeid
 != -1){

2821 
	`CPU_ZERO
(&
ıus
);

2822 
j
 = 0; j < 
bšfo
->
ıušfo
->
num_cÜes_³r_numªodes
; j++){

2823 
	`CPU_SET
(
bšfo
->
ıušfo
->
ıuli¡
[
nodeid
][
j
], &
ıus
);

2825 
	`±h»ad_©Œ_£ffš™y_Å
(&
©Œ
[
i
], (
ıu_£t_t
), &
ıus
);

2828 
	`CPU_ZERO
(&
ıus
);

2829 
nodeid
 = 
db_idx
 % 
bšfo
->
ıušfo
->
num_numªodes
;

2830 
	`CPU_ZERO
(&
ıus
);

2831 
j
 = 0; j < 
bšfo
->
ıušfo
->
num_cÜes_³r_numªodes
; j++){

2832 
	`CPU_SET
(
bšfo
->
ıušfo
->
ıuli¡
[
nodeid
][
j
], &
ıus
);

2835 
	`±h»ad_©Œ_£ffš™y_Å
(&
©Œ
[
i
], (
ıu_£t_t
), &
ıus
);

2841 
b’ch_wÜk”_»t
 = 
	`®ÿ
(*, 
b’ch_th»ads
);

2843 
i
 = 0; i < 
b’ch_th»ads
; ++i){

2844 
	`±h»ad_ü—‹
(&
b’ch_wÜk”
[
i
], &
©Œ
[i], 
b’ch_th»ad
, (*)&
b_¬gs
[i]);

2847 
´ev_İ_couÁ_»ad
 = 
´ev_İ_couÁ_wr™e
 = 
´ev_İ_couÁ_d–‘e
 = 0;

2848 
g­
 = 
	`¡İw©ch_¡İ
(&
sw
);

2849 if(
bšfo
->
pİ_fœ¡
)

2850 
	`LOG_PRINT_TIME
(
g­
, " secƒlapsed\n");

2853 
	`¡İw©ch_š™
(&
sw
);

2854 
	`¡İw©ch_¡¬t
(&
sw
);

2857 
	`¡İw©ch_š™
(&
´og»ss
);

2858 
	`¡İw©ch_¡¬t
(&
´og»ss
);

2860 ià(
bšfo
->
w¬mup_£cs
) {

2861 
w¬mšgup
 = 
Œue
;

2862 
	`Írštf
("\nwarming up\n");

2863 
	`Írštf
("time,ops_avg,ops_i,read_cnt,write_cnt,bytes_written\n");

2866 if(
run_İs_å
)

2867 
	`årštf
(
run_İs_å
, "time,ops_avg,ops_i,read_cnt,write_cnt,bytes_written\n");

2869 
i
 = 0;

2870 
i
 < ()
bšfo
->
nb©ches
 || binfo->nbatches == 0) {

2871 
İ_couÁ_»ad
 = 
İ_couÁ_wr™e
 = 
İ_couÁ_d–‘e
 = 0;

2872 
j
 = 0; j< 
b’ch_th»ads
; j++){

2873 
İ_couÁ_»ad
 +ğ
b_¬gs
[
j
].
İ_»ad
.
	`lßd
();

2874 
İ_couÁ_wr™e
 +ğ
b_¬gs
[
j
].
İ_wr™e
.
	`lßd
();

2875 
İ_couÁ_d–‘e
 +ğ
b_¬gs
[
j
].
İ_d–‘e
.
	`lßd
();

2880 ià(
	`¡İw©ch_check_ms
(&
´og»ss
, 
´št_‹rm_ms
)) {

2882 
ušt64_t
 
cur_size
 = 0;

2883 
ıt_no
;

2884 
–­£d_time
;

2885 
Db
 *
‹mp_db
;

2887 
di¥Ïy_tick
++;

2890 
_g­
 = 
	`¡İw©ch_g‘_cu¹ime
(&
´og»ss
);

2891 
	`¡İw©ch_š™
(&
´og»ss
);

2923 
	`¡İw©ch_¡İ
(&
sw
);

2925 
	`´štf
("\r%s", 
¥aûs
);

2927 
	`´štf
("%c[1A%c[0C", 27, 27);

2928 
	`´štf
("\r%s\r", 
¥aûs
);

2930 ià(!
w¬mšgup
 && 
bšfo
->
nb©ches
 > 0) {

2932 
	`´štf
("%5.1à%% (", 
i
*100.0 / (
bšfo
->
nb©ches
-1));

2933 
g­
 = 
sw
.
–­£d
;

2934 
	`PRINT_TIME
(
g­
, " s, ");

2935 } ià(
w¬mšgup
 || 
bšfo
->
b’ch_£cs
 > 0) {

2937 
	`´štf
("(");

2938 
g­
 = 
sw
.
–­£d
;

2939 
	`PRINT_TIME
(
g­
, " s / ");

2940 ià(
w¬mšgup
) {

2941 
	`´štf
("%d s, ", ()
bšfo
->
w¬mup_£cs
);

2943 
	`´štf
("%d s, ", ()
bšfo
->
b’ch_£cs
);

2947 
	`´štf
("%5.1f %% (",

2948 (
İ_couÁ_»ad
+
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
)*100.0 /

2949 (
bšfo
->
nİs
 * bšfo->
nfes
 -1));

2950 
g­
 = 
sw
.
–­£d
;

2951 
	`PRINT_TIME
(
g­
, " s, ");

2954 
–­£d_time
 = 
g­
.
tv_£c
 + ()g­.
tv_u£c
 / 1000000.0;

2956 
	`´štf
("%8.2f ops/s, ",

2957 ()(
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
è/ 
–­£d_time
);

2959 
	`´štf
("%8.2f ops/s)",

2960 ()((
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
) -

2961 (
´ev_İ_couÁ_»ad
 + 
´ev_İ_couÁ_wr™e
 +

2962 
´ev_İ_couÁ_d–‘e
)) /

2963 (
_g­
.
tv_£c
 + ()_g­.
tv_u£c
 / 1000000.0));

2965 #ià
	`defšed
 (
__KV_BENCH
è|| defšed(
__KVROCKS_BENCH
è|| defšed (
__AS_BENCH
)

2968 ià(
di¥Ïy_tick
 % 
fesize_chk_‹rm
 == 0) {

2969 
wr™‹n_´ev
 = 
wr™‹n_fš®
;

2970 
wr™‹n_fš®
 = 
	`´št_´oc_io_¡©
(
cmd
, 0);

2974 
tmp
 = (
w¬mšgup
 =ğ
Œue
è? 
log_å
 : 
run_İs_å
;

2976 if(
tmp
){

2983 
	`årštf
(
tmp
,

2985 "%" 
_F64
",%" _F64 ",%" _F64 "\n",

2986 ()
g­
.
tv_£c
, ()g­.
tv_u£c
 / 100000,

2987 ()(
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
) /

2988 (
–­£d_time
),

2989 ()((
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
) -

2990 (
´ev_İ_couÁ_»ad
 + 
´ev_İ_couÁ_wr™e
 +

2991 
´ev_İ_couÁ_d–‘e
)) /

2992 (
_g­
.
tv_£c
 + ()_g­.
tv_u£c
 / 1000000.0),

2993 
İ_couÁ_»ad
, 
İ_couÁ_wr™e
,

2994 
wr™‹n_fš®
 - 
wr™‹n_š™
);

2997 
	`´štf
("\n");

2998 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__COUCH_BENCH
)

2999 ià(
di¥Ïy_tick
 % 
fesize_chk_‹rm
 == 0) {

3000 
cur_size
 = 
dbšfo
->
fe_size
;

3001 ià(
bšfo
->
auto_com·ùiÚ
) {

3002 
	`´št_fesize_­´ox
(
cur_size
, 
fsize1
);

3004 
curfe_‹mp
[256];

3005 
ušt64_t
 
cur_size_‹mp
;

3006 
	`¥rštf
(
curfe_‹mp
, "%s%d.%d",

3007 
bšfo
->
f’ame
, ()
curfe_no
,

3008 
com·ùiÚ_no
[
curfe_no
]);

3009 
cur_size_‹mp
 = 
	`g‘_fesize
(
curfe_‹mp
);

3010 
	`´št_fesize_­´ox
(
cur_size_‹mp
, 
fsize1
);

3012 
	`´št_fesize_­´ox
(
dbšfo
->
¥aû_u£d
, 
fsize2
);

3016 
	`´štf
("(% / %sè", 
fsize1
, 
fsize2
);

3019 #ifdeà
__PRINT_IOSTAT


3020 
ušt64_t
 
w_³r_doc
;

3021 
ušt64_t
 
š¡_wr™‹n_doc
;

3024 
	`´štf
("(%s, ", 
	`´št_fesize_­´ox
(
wr™‹n_fš®
 - 
wr™‹n_š™
, 
cmd
));

3026 
	`´štf
("%s/ ", 
	`´št_fesize_­´ox
((
wr™‹n_fš®
 - 
wr™‹n_š™
) /

3027 
–­£d_time
, 
cmd
));

3029 ià(
wr™‹n_fš®
 - 
wr™‹n_š™
 > 0) {

3030 
w_³r_doc
 = ()(
wr™‹n_fš®
 - 
wr™‹n_š™
è/ 
İ_couÁ_wr™e
;

3032 
w_³r_doc
 = 0;

3034 
	`´štf
("%.1àx, ", ()
w_³r_doc
 / 
avg_docsize
);

3037 
	`´štf
("%s/ ", 
	`´št_fesize_­´ox
(

3038 (
wr™‹n_fš®
 - 
wr™‹n_´ev
) /

3039 (
´št_‹rm_ms
 * 
fesize_chk_‹rm
 / 1000.0), 
cmd
));

3041 
š¡_wr™‹n_doc
 = (
İ_couÁ_wr™e
 - 
´ev_İ_couÁ_wr™e
) *

3042 
fesize_chk_‹rm
;

3043 ià(
š¡_wr™‹n_doc
) {

3044 
w_³r_doc
 = ()(
wr™‹n_fš®
 - 
wr™‹n_´ev
è/ 
š¡_wr™‹n_doc
;

3046 
w_³r_doc
 = 0;

3048 
	`´štf
("%.1àx)", ()
w_³r_doc
 / 
avg_docsize
);

3050 
	`fæush
(
¡dout
);

3052 
´ev_İ_couÁ_»ad
 = 
İ_couÁ_»ad
;

3053 
´ev_İ_couÁ_wr™e
 = 
İ_couÁ_wr™e
;

3054 
´ev_İ_couÁ_d–‘e
 = 
İ_couÁ_d–‘e
;

3056 
	`¡İw©ch_¡¬t
(&
sw
);

3058 ià(
bšfo
->
b’ch_£cs
 && !
w¬mšgup
 &&

3059 (
size_t
)
sw
.
–­£d
.
tv_£c
 >ğ
bšfo
->
b’ch_£cs
)

3062 ià((
size_t
)
sw
.
–­£d
.
tv_£c
 >ğ
bšfo
->
w¬mup_£cs
){

3063 ià(
w¬mšgup
) {

3065 
	`¡İw©ch_š™_¡¬t
(&
sw
);

3066 
´ev_İ_couÁ_»ad
 = 
İ_couÁ_»ad
 = 0;

3067 
´ev_İ_couÁ_wr™e
 = 
İ_couÁ_wr™e
 = 0;

3068 
´ev_İ_couÁ_d–‘e
 = 
İ_couÁ_d–‘e
 = 0;

3069 
wr™‹n_š™
 = 
wr™‹n_fš®
;

3090 
j
=0; j<
b’ch_th»ads
; j++){

3091 
b_¬gs
[
j
].
İ_»ad
 = b_¬gs[j].
İ_wr™e
 = b_¬gs[j].
İ_d–‘e
 = b_¬gs[j].
İ_™”_key
 = 0;

3092 
b_¬gs
[
j
].
l_»ad
->
n§m¶es
 = b_¬gs[j].
l_wr™e
->nsamples

3093 ğ
b_¬gs
[
j
].
l_d–‘e
->
n§m¶es
 = 0;

3094 
b_¬gs
[
j
].
l_»ad
->
cursÜ
 = b_¬gs[j].
l_wr™e
->cursor

3095 ğ
b_¬gs
[
j
].
l_d–‘e
->
cursÜ
 = 0;

3097 
w¬mšgup
 = 
çl£
;

3098 
	`Írštf
("\nevaluation\n");

3099 
	`Írštf
("time,ops_avg,ops_i,read_cnt,write_cnt,bytes_written\n");

3104 if(!
¡¬og
) {

3105 
¡¬og
 = 
Œue
;

3109 
	`¡İw©ch_¡¬t
(&
´og»ss
);

3112 
	`¡İw©ch_¡¬t
(&
´og»ss
);

3113 
	`u¦“p
(
´št_‹rm_ms
 * 1000);

3116 ià(
bšfo
->
nİs
 && !
w¬mšgup
 &&

3117 (
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
è>ğ
bšfo
->
nİs
 * bšfo->
nfes
)

3120 ià(
gÙ_sigÇl
) {

3131 
i
=0;i<
b’ch_th»ads
;++i){

3132 
b_¬gs
[
i
].
‹rmš©e_sigÇl
 = 1;

3135 
i
=0;i<
b’ch_th»ads
;++i){

3136 
	`th»ad_još
(
b’ch_wÜk”
[
i
], &
b’ch_wÜk”_»t
[i]);

3139 #ià
	`defšed
 (
__KV_BENCH
è|| defšed (
__AS_BENCH
)

3142 #–ià
	`defšed
 (
__ROCKS_BENCH
è|| defšed (
__LEVEL_BENCH
)

3143 
	`_wa™_Ëv–db_com·ùiÚ
(
bšfo
, 
db
);

3146 
	`Írštf
("\n");

3147 
	`¡İw©ch_¡İ
(&
sw
);

3148 
g­
 = 
sw
.
–­£d
;

3149 
	`LOG_PRINT_TIME
(
g­
, " secƒlapsed\n");

3150 
g­_doubË
 = 
g­
.
tv_£c
 + ()g­.
tv_u£c
 / 1000000.0;

3152 
İ_couÁ_»ad
 = 
b_¡©
.
İ_»ad
.
	`lßd
();

3153 
İ_couÁ_wr™e
 = 
b_¡©
.
İ_wr™e
.
	`lßd
();

3154 
İ_couÁ_d–‘e
 = 
b_¡©
.
İ_d–‘e
.
	`lßd
();

3155 
İ_couÁ_™”_key
 = 
b_¡©
.
İ_™”_key
.
	`lßd
();

3156 ià(
İ_couÁ_»ad
) {

3157 
	`Írštf
("%" 
_F64
 "„eads (%.2f ops/sec, %.2f us/read)\n",

3158 
İ_couÁ_»ad
,

3159 ()
İ_couÁ_»ad
 / 
g­_doubË
,

3160 
g­_doubË
 * 1000000 / 
İ_couÁ_»ad
);

3162 ià(
İ_couÁ_wr™e
) {

3163 
	`Írštf
("%" 
_F64
 " writes (%.2f ops/sec, %.2f us/write)\n",

3164 
İ_couÁ_wr™e
,

3165 ()
İ_couÁ_wr™e
 / 
g­_doubË
,

3166 
g­_doubË
 * 1000000 / 
İ_couÁ_wr™e
);

3168 ià(
İ_couÁ_d–‘e
) {

3169 
	`Írštf
("%" 
_F64
 " deletes (%.2f ops/sec, %.2f us/delete)\n",

3170 
İ_couÁ_d–‘e
,

3171 ()
İ_couÁ_d–‘e
 / 
g­_doubË
,

3172 
g­_doubË
 * 1000000 / 
İ_couÁ_d–‘e
);

3175 
	`Írštf
("tÙ® %" 
_F64
 " operations…erformed\n",

3176 
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
);

3178 
	`Írštf
("Throughput(B’chm¬kè%.2àİs/£c\n", ()(
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
è/ 
g­_doubË
);

3180 if(
İ_couÁ_™”_key
 > 0) {

3181 
	`Írštf
("Throughput(I‹¿tÜè %.2àkeys/£c;Ù® %ld keys\n", ()(
İ_couÁ_™”_key
è/ 
g­_doubË
, op_count_iter_key);

3184 if(
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
 > 0) {

3185 
	`Írštf
("av”agÏ‹ncy %f\n", 
g­_doubË
 * 1000000 /

3186 Ğ
İ_couÁ_»ad
 + 
İ_couÁ_wr™e
 + 
İ_couÁ_d–‘e
));

3188 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__COUCH_BENCH
)

3189 ià(!
bšfo
->
auto_com·ùiÚ
) {

3191 
	`Írštf
("compaction : occurred %dime%s, ",

3192 
tÙ®_com·ùiÚ
, (total_compaction>1)?("s"):(""));

3193 
	`LOG_PRINT_TIME
(
sw_com·ùiÚ
.
–­£d
, " secƒlapsed\n");

3197 #ià!
defšed
 
__KV_BENCH
 && !defšed 
__AS_BENCH


3198 
wr™‹n_fš®
 = 
	`´št_´oc_io_¡©
(
cmd
, 1);

3201 #ià
	`defšed
(
__PRINT_IOSTAT
)

3203 
ušt64_t
 
wr™‹n
 = 
wr™‹n_fš®
 - 
wr™‹n_š™
;

3204 
ušt64_t
 
w_³r_doc
 = ()
wr™‹n
 / 
İ_couÁ_wr™e
;

3205 
waf_d
, 
waf_a
;

3207 ià(
İ_couÁ_wr™e
) {

3208 
	`Írštf
("tÙ® %" 
_F64
 " bytes (%s) written during benchmark\n",

3209 
wr™‹n
,

3210 
	`´št_fesize_­´ox
((
wr™‹n_fš®
 - 
wr™‹n_š™
),

3211 
bodybuf
));

3212 
	`Írštf
("average disk writehroughput: %.2f MB/s\n",

3213 ()
wr™‹n
 / (
g­
.
tv_£c
*1000000 + g­.
tv_u£c
) *

3215 
waf_a
 = ()
w_³r_doc
 / 
avg_docsize
;

3216 
	`Írštf
("%s written…er doc update (%.1f x write‡mplification)\n",

3217 
	`´št_fesize_­´ox
(
w_³r_doc
, 
bodybuf
),

3218 
waf_a
);

3224 if(
bšfo
->
Ï‹ncy_¿‹
 && bšfo->
w™h_™”©Ü
 != 2) {

3225 
Ï‹ncy_¡©
 
w_¡©
;

3226 
Ï‹ncy_¡©
 
r_¡©
;

3227 
Ï‹ncy_¡©
 
d_¡©
;

3228 
ušt32_t
 *
t1
, *
t2
, *
t3
;

3229 
	`mem£t
(&
w_¡©
, 0, (
Ï‹ncy_¡©
));

3230 
	`mem£t
(&
r_¡©
, 0, (
Ï‹ncy_¡©
));

3231 
	`mem£t
(&
d_¡©
, 0, (
Ï‹ncy_¡©
));

3233 
w_¡©
.
§m¶es
 = (
ušt32_t
*)
	`m®loc
((uint32_t) *

3234 
bšfo
->
Ï‹ncy_max
 * 
b’ch_th»ads
);

3235 
r_¡©
.
§m¶es
 = (
ušt32_t
*)
	`m®loc
((uint32_t) *

3236 
bšfo
->
Ï‹ncy_max
 * 
b’ch_th»ads
);

3237 
d_¡©
.
§m¶es
 = (
ušt32_t
*)
	`m®loc
((uint32_t) *

3238 
bšfo
->
Ï‹ncy_max
 * 
b’ch_th»ads
);

3239 
t1
 = 
w_¡©
.
§m¶es
;

3240 
t2
 = 
r_¡©
.
§m¶es
;

3241 
t3
 = 
d_¡©
.
§m¶es
;

3243 
i
 = 0; i < 
b’ch_th»ads
; i++){

3244 
w_¡©
.
n§m¶es
 +ğ
b_¬gs
[
i
].
l_wr™e
->nsamples;

3245 
r_¡©
.
n§m¶es
 +ğ
b_¬gs
[
i
].
l_»ad
->nsamples;

3246 
d_¡©
.
n§m¶es
 +ğ
b_¬gs
[
i
].
l_d–‘e
->nsamples;

3248 
	`memıy
(
t1
, 
b_¬gs
[
i
].
l_wr™e
->
§m¶es
, (
ušt32_t
) *

3249 
b_¬gs
[
i
].
l_wr™e
->
n§m¶es
);

3250 
	`memıy
(
t2
, 
b_¬gs
[
i
].
l_»ad
->
§m¶es
, (
ušt32_t
) *

3251 
b_¬gs
[
i
].
l_»ad
->
n§m¶es
);

3252 
	`memıy
(
t3
, 
b_¬gs
[
i
].
l_d–‘e
->
§m¶es
, (
ušt32_t
) *

3253 
b_¬gs
[
i
].
l_d–‘e
->
n§m¶es
);

3255 
t1
 +ğ
b_¬gs
[
i
].
l_wr™e
->
n§m¶es
;

3256 
t2
 +ğ
b_¬gs
[
i
].
l_»ad
->
n§m¶es
;

3257 
t3
 +ğ
b_¬gs
[
i
].
l_d–‘e
->
n§m¶es
;

3258 
	`ä“
(
b_¬gs
[
i
].
l_wr™e
->
§m¶es
);

3259 
	`ä“
(
b_¬gs
[
i
].
l_»ad
->
§m¶es
);

3260 
	`ä“
(
b_¬gs
[
i
].
l_d–‘e
->
§m¶es
);

3263 
	`_´št_³rûÁe
(
bšfo
, (
w_¡©
.
n§m¶es
 =ğ0? 
NULL
: &w_stat),

3264 (
r_¡©
.
n§m¶es
 =ğ0? 
NULL
 : &r_stat),

3265 (
d_¡©
.
n§m¶es
 =ğ0? 
NULL
 : &d_stat), "us", 2);

3266 
	`ä“
(
w_¡©
.
§m¶es
);

3267 
	`ä“
(
r_¡©
.
§m¶es
);

3268 
	`ä“
(
d_¡©
.
§m¶es
);

3271 
	`Írštf
("\n");

3273 
	`keyg’_ä“
(&
bšfo
->
keyg’
);

3274 ià(
bšfo
->
keyfe
) {

3275 
	`keylßd”_ä“
(&
bšfo
->
kl
);

3277 ià(
bšfo
->
b©ch_di¡
.
ty³
 =ğ
RND_ZIPFIAN
) {

3278 
	`zf_ºd_ä“
(&
zf
);

3281 #ifdeà
__FDB_BENCH


3286 
	`´štf
("waiting forermination of DB module..\n");

3287 #ià
	`defšed
(
__FDB_BENCH
è|| defšed(
__COUCH_BENCH
è|| defšed(
__WT_BENCH
)

3288 
i
=0;i<
b’ch_th»ads
;++i){

3289 
j
=0;j<()
bšfo
->
nfes
;++j){

3290 
	`couch¡Üe_şo£_db
(
b_¬gs
[
i
].
db
[
j
]);

3291 #ifdeà
__FDB_BENCH


3292 ià(
i
==0) {

3293 
	`couch¡Üe_şo£_db
(
šfo_hªdË
[
j
]);

3297 
	`ä“
(
b_¬gs
[
i
].
db
);

3299 #–ià
	`defšed
(
__KV_BENCH
è|| defšed(
__KVROCKS_BENCH
è|| 
defšed
 
__BLOBFS_ROCKS_BENCH


3300 
j
=0;j<()
bšfo
->
nfes
;++j){

3301 
	`couch¡Üe_şo£_db
(
db
[
j
]);

3303 #–ià
	`defšed
 (
__LEVEL_BENCH
)

3305 
j
 = 0; j < 
b’ch_th»ads
; j+ğ
sšgËdb_th»ad_num
){

3306 
	`couch¡Üe_şo£_db
(
b_¬gs
[
j
].
db
[0]);

3308 #ià!
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

3309 
	`ä“
(
b_¬gs
[0].
db
);

3312 #–ià
	`defšed
 (
__ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

3313 
j
 = 0; j < 
b’ch_th»ads
; j+ğ
sšgËdb_th»ad_num
){

3314 
	`couch¡Üe_şo£_db
(
b_¬gs
[
j
].
db
[0]);

3315 
	`ä“
(
b_¬gs
[
j
].
db
);

3316 
	`årštf
(
¡dout
, "şo£ & f»db iÀth»ad %d\n", 
j
);

3318 #–ià
	`defšed
 (
__AS_BENCH
)

3319  
j
 = 0; j < 
b’ch_th»ads
; j++){

3320 
	`´štf
("şo£ db %d\n", 
j
);

3321 
	`couch¡Üe_şo£_db
(
b_¬gs
[
j
].
db
[0]);

3325 #ià
	`defšed
(
__KV_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
)

3328 
	`couch¡Üe_ex™_’v
();

3330 #ià
	`defšed
 (
__AS_BENCH
)

3331 
	`couch¡Üe_şo£_deviû
(
bšfo
->
ndocs
);

3333 #ià
	`defšed
(
__WT_BENCH
è|| defšed(
__FDB_BENCH
)

3334 
	`couch¡Üe_şo£_cÚn
();

3337 
	`Írštf
("\n");

3338 
	`¡İw©ch_¡İ
(&
sw
);

3339 
g­
 = 
sw
.
–­£d
;

3340 
	`LOG_PRINT_TIME
(
g­
, " secƒlapsed\n");

3342 
	`ä“
(
dbšfo
);

3344 
	`_b’ch_»suÉ_´št
(&
»suÉ
);

3345 
	`_b’ch_»suÉ_ä“
(&
»suÉ
);

3354 
	`memËak_’d
();

3355 
	}
}

3357 
	$_´št_b’chšfo
(
b’ch_šfo
 *
bšfo
)

3359 
‹mp¡r
[256];

3361 
	`Írštf
("\n === benchmark configuration ===\n");

3362 
	`Írštf
("DB moduË: %s\n", 
bšfo
->
dbÇme
);

3364 
	`Írštf
("¿ndom s“d: %d\n", ()
ºd_£ed
);

3366 ià(
	`¡rcmp
(
bšfo
->
š™_f’ame
, bšfo->
f’ame
)) {

3367 
	`Írštf
("š™ŸÈf’ame: %s#\n", 
bšfo
->
š™_f’ame
);

3369 
	`Írštf
("f’ame: %s#", 
bšfo
->
f’ame
);

3370 ià(
bšfo
->
š™Ÿlize
) {

3371 
	`Írštf
(" (initialize)\n");

3373 
	`Írštf
(" (useƒxisting DB file)\n");

3376 
	`Írštf
("# docum’t (i.e. wÜkšg s‘ size): %ld\n", ()
bšfo
->
ndocs
);

3378 ià(
bšfo
->
nfes
 > 1) {

3379 
	`Írštf
("# fes: %d\n", ()
bšfo
->
nfes
);

3382 
	`Írštf
("#hreads: ");

3383 
	`Írštf
("»ad” %d, i‹¿tÜ %d", ()
bšfo
->
Ä—d”s
,

3384 ()
bšfo
->
n™”©Üs
);

3386 ià(
bšfo
->
¿tio
[1] > 100) {

3387 ià(
bšfo
->
»ad”_İs
) {

3388 
	`Írštf
(" (%d ops/£c), ", ()
bšfo
->
»ad”_İs
);

3390 
	`Írštf
(" (max), ");

3393 
	`Írštf
(", ");

3395 
	`Írštf
("wr™” %d, d–‘” %d", ()
bšfo
->
nwr™”s
, ()bšfo->
nd–‘”s
);

3397 ià(
bšfo
->
¿tio
[1] > 100) {

3398 ià(
bšfo
->
wr™”_İs
) {

3399 
	`Írštf
(" (%d ops/£c)\n", ()
bšfo
->
wr™”_İs
);

3401 
	`Írštf
(" (max)\n");

3404 
	`Írštf
("\n");

3406 ià(
bšfo
->
disjošt_wr™e
) {

3407 
	`Írštf
("enabled disjoint write‡mong %d writers over %d files\n",

3408 ()
bšfo
->
nwr™”s
, ()bšfo->
nfes
);

3411 
	`Írštf
("#‡uto-com·ùiÚh»ads: %d\n", 
bšfo
->
auto_com·ùiÚ_th»ads
);

3413 
	`Írštf
("block cache size: %s\n",

3414 
	`´št_fesize_­´ox
(
bšfo
->
ÿche_size
, 
‹mp¡r
));

3415 #ià
	`defšed
(
__LEVEL_BENCH
è|| defšed(
__ROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

3416 
	`Írštf
("WBS size: %s (init), ",

3417 
	`´št_fesize_­´ox
(
bšfo
->
wbs_š™
, 
‹mp¡r
));

3418 
	`Írštf
("%s (bench)\n",

3419 
	`´št_fesize_­´ox
(
bšfo
->
wbs_b’ch
, 
‹mp¡r
));

3420 ià(
bšfo
->
bloom_bpk
) {

3421 
	`Írštf
("bloom f‹¸’abËd (%d b™ ³¸key)\n", ()
bšfo
->
bloom_bpk
);

3425 #ià
	`defšed
(
__ROCKS_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

3426 
	`Írštf
("compaction style: ");

3427 
bšfo
->
com·ùiÚ_¡yË
) {

3429 
	`Írštf
("level (default)\n");

3432 
	`Írštf
("universal\n");

3435 
	`Írštf
("FIFO\n");

3440 #ià
	`defšed
(
__FDB_BENCH
)

3441 
	`Írštf
("WAL size: %" 
_F64
"\n", 
bšfo
->
fdb_w®
);

3442 
	`Írštf
("šdexšg: %s\n", (
bšfo
->
fdb_ty³
==0)?"hb+trie":"b-tree");

3445 #ià
	`defšed
(
__WT_BENCH
)

3446 
	`Írštf
("šdexšg: %s\n", (
bšfo
->
wt_ty³
==0)?"b-tree":"lsm-tree");

3449 ià(
bšfo
->
com´essiÚ
) {

3450 
	`Írštf
("compression isƒnabled (compressibility %d %%)\n",

3451 
bšfo
->
com´essib™y
);

3454 ià(
bšfo
->
keyfe
) {

3456 
	`Írštf
("key data: %s (avg†ength: %d)\n",

3457 
bšfo
->
keyfe
, ()bšfo->
avg_keyËn
);

3459 ià(
bšfo
->
keyËn
.
ty³
 =ğ
RND_FIXED
) {

3460 
	`Írštf
("key†ength: %s(%d) / ",

3462 ()
bšfo
->
keyËn
.
a
);

3465 
	`Írštf
("key†ength: %s(%d,%d) / ",

3466 (
bšfo
->
keyËn
.
ty³
 =ğ
RND_NORMAL
)?"Norm":"Uniform",

3467 ()
bšfo
->
keyËn
.
a
, ()bšfo->keyËn.
b
);

3470 if(
bšfo
->
bodyËn
.
ty³
 =ğ
RND_FIXED
){

3471 
	`Írštf
("body†ength: %s(%d)\n",

3473 ()
bšfo
->
bodyËn
.
a
);

3475 
	`Írštf
("body†ength: %s(%d,%d)\n",

3476 (
bšfo
->
bodyËn
.
ty³
 =ğ
RND_NORMAL
)?"Norm":"Uniform",

3477 ()
bšfo
->
bodyËn
.
a
, ()bšfo->bodyËn.
b
);

3479 
	`Írštf
("batch distribution: ");

3480 ià(
bšfo
->
b©ch_di¡
.
ty³
 =ğ
RND_UNIFORM
) {

3481 
	`Írštf
("Uniform\n");

3483 
	`Írštf
("Zipfian (s=%.2f, group: %d documents)\n",

3484 ()
bšfo
->
b©ch_di¡
.
a
/100.0, ()bšfo->b©ch_di¡.
b
);

3487 ià(
bšfo
->
nb©ches
 > 0) {

3488 
	`Írštf
("# batches for benchmark: %lu\n",

3489 ()
bšfo
->
nb©ches
);

3491 ià(
bšfo
->
nİs
 > 0){

3492 
	`Írštf
("# operations for benchmark: %lu\n",

3493 ()
bšfo
->
nİs
);

3495 ià(
bšfo
->
b’ch_£cs
 > 0){

3496 
	`Írštf
("benchmark duration: %lu seconds\n",

3497 ()
bšfo
->
b’ch_£cs
);

3500 
	`Írštf
("read batch size:…oint %s(%d,%d),„ange %s(%d,%d)\n",

3501 (
bšfo
->
rb©chsize
.
ty³
 =ğ
RND_NORMAL
)?"Norm":"Uniform",

3502 ()
bšfo
->
rb©chsize
.
a
, ()bšfo->rb©chsize.
b
,

3503 (
bšfo
->
ib©chsize
.
ty³
 =ğ
RND_NORMAL
)?"Norm":"Uniform",

3504 ()
bšfo
->
ib©chsize
.
a
, ()bšfo->ib©chsize.
b
);

3505 
	`Írštf
("write batch size: %s(%d,%d)\n",

3506 (
bšfo
->
wb©chsize
.
ty³
 =ğ
RND_NORMAL
)?"Norm":"Uniform",

3507 ()
bšfo
->
wb©chsize
.
a
, ()bšfo->wb©chsize.
b
);

3508 
	`Írštf
("inside batch distribution: %s",

3509 (
bšfo
->
İ_di¡
.
ty³
 =ğ
RND_NORMAL
)?"Norm":"Uniform");

3510 
	`Írštf
(" (-%d ~ +%d,otal %d)\n",

3511 ()
bšfo
->
b©ch¿nge
 , ()binfo->batchrange,

3512 ()
bšfo
->
b©ch¿nge
*2);

3514 ià(
bšfo
->
¿tio
[1] + binfo->ratio[2] <= 100) {

3515 
	`Írštf
("wr™¿tio: %d %%", ()
bšfo
->
¿tio
[1]);

3517 
	`Írštf
("write„atio: max capacity");

3519 
	`Írštf
(" (%s)\n", ((
bšfo
->
sync_wr™e
)?("synchronous"):("asynchronous")));

3520 
	`Írštf
("š£¹iÚ ord”: %s\n", ((
bšfo
->
£q_fl
)?("sequential fill"):("random fill")));

3522 #ià
	`defšed
(
__FDB_BENCH
)

3523 
	`Írštf
("compactionhreshold: %d %% "

3525 ()
bšfo
->
com·ù_th»s
, ()bšfo->
com·ù_³riod
,

3526 ((
bšfo
->
auto_com·ùiÚ
)?("auto"):("manual")));

3527 ià(
bšfo
->
block_»u£_th»s
) {

3528 
	`Írštf
("block„eu£h»shŞd: %d %%\n", ()
bšfo
->
block_»u£_th»s
);

3531 #ià
	`defšed
(
__COUCH_BENCH
)

3532 
	`Írštf
("com·ùiÚh»shŞd: %d %%\n", ()
bšfo
->
com·ù_th»s
);

3534 #ià
	`defšed
(
__WT_BENCH
)

3535 
	`Írštf
("checkpošˆ³riod: %d secÚds\n", ()
bšfo
->
com·ù_³riod
);

3537 
	}
}

3539 
	$_£t_keyg’
(
b’ch_šfo
 *
bšfo
)

3541 
size_t
 
i
, 
Ëv–
 = 
bšfo
->
Æev–
+1;

3542 
avg_keyËn
, 
avg_´efixËn
;

3543 
ºdšfo
 
ºd_Ën
[
Ëv–
], 
ºd_di¡
[level];

3544 
keyg’_İtiÚ
 
İt
;

3546 ià(
bšfo
->
keyËn
.
ty³
 =ğ
RND_NORMAL
 || bšfo->keyËn.ty³ =ğ
RND_FIXED
) {

3547 
avg_keyËn
 = 
bšfo
->
keyËn
.
a
;

3549 
avg_keyËn
 = (
bšfo
->
keyËn
.
a
 + bšfo->keyËn.
b
) / 2;

3551 ià(
bšfo
->
´efixËn
.
ty³
 =ğ
RND_NORMAL
) {

3552 
avg_´efixËn
 = 
bšfo
->
´efixËn
.
a
;

3554 
avg_´efixËn
 = (
bšfo
->
´efixËn
.
a
 + bšfo->´efixËn.
b
) / 2;

3557 
i
=0;i<
bšfo
->
Æev–
+1; ++i) {

3558 ià(
i
<
bšfo
->
Æev–
) {

3559 
ºd_Ën
[
i
] = 
bšfo
->
´efixËn
;

3560 
ºd_di¡
[
i
].
ty³
 = 
RND_UNIFORM
;

3561 
ºd_di¡
[
i
].
a
 = 0;

3562 
ºd_di¡
[
i
].
b
 = 
bšfo
->
Å»fixes
;

3565 if(
bšfo
->
keyËn
.
ty³
 =ğ
RND_NORMAL
) {

3566 
ºd_Ën
[
i
].
ty³
 = 
RND_NORMAL
;

3567 
ºd_Ën
[
i
].
a
 = 
avg_keyËn
 - 
avg_´efixËn
 * 
bšfo
->
Æev–
;

3568 
ºd_Ën
[
i
].
b
 = 
bšfo
->
keyËn
.b;

3569 
ºd_di¡
[
i
].
ty³
 = 
RND_UNIFORM
;

3570 
ºd_di¡
[
i
].
a
 = 0;

3571 
ºd_di¡
[
i
].
b
 = 0xfffffffffffffff;

3573 
ºd_Ën
[
i
].
ty³
 = 
RND_UNIFORM
;

3574 
ºd_Ën
[
i
].
a
 = 
bšfo
->
keyËn
.¨- 
avg_´efixËn
 * bšfo->
Æev–
;

3575 
ºd_Ën
[
i
].
b
 = 
bšfo
->
keyËn
.b;

3576 
ºd_di¡
[
i
].
ty³
 = 
RND_UNIFORM
;

3577 
ºd_di¡
[
i
].
a
 = 
bšfo
->
keyËn
.¨- 
avg_´efixËn
 * bšfo->
Æev–
;

3578 
ºd_di¡
[
i
].
b
 = 
bšfo
->
keyËn
.b;

3582 
İt
.
abt_Úly
 = 1;

3583 
İt
.
d–im™”
 = 1;

3584 
	`keyg’_š™
(&
bšfo
->
keyg’
, 
Ëv–
, 
ºd_Ën
, 
ºd_di¡
, &
İt
);

3585 
	}
}

3587 
	$_£t_keylßd”
(
b’ch_šfo
 *
bšfo
)

3589 
»t
;

3590 
keylßd”_İtiÚ
 
İtiÚ
;

3592 
İtiÚ
.
max_nkeys
 = 
bšfo
->
ndocs
;

3593 
»t
 = 
	`keylßd”_š™
(&
bšfo
->
kl
, bšfo->
keyfe
, &
İtiÚ
);

3594 ià(
»t
 < 0) {

3595 
	`´štf
("”rÜ occu»d duršg†ßdšg f%s\n", 
bšfo
->
keyfe
);

3596 
	`ex™
(0);

3598 
bšfo
->
ndocs
 = 
	`keylßd”_g‘_nkeys
(&bšfo->
kl
);

3599 
bšfo
->
avg_keyËn
 = 
	`keylßd”_g‘_avg_keyËn
(&bšfo->
kl
);

3600 
	}
}

3603 
	$š™_ıu_aff
(
b’ch_šfo
 *
bšfo
){

3604 
i
, 
j
, 
lše_num
 = 0, 
cÜe_couÁ
 = 0;

3605 
nodeid
 = 0, 
cÜeid
 = 0, 
šsid_lßd
 = 0,
šsid_³rf
 = 0;

3606 
cur_lßd
 = 0, 
cur_b’ch
 = 0, 
´ev_lßd_šsid
 = -1, 
´ev_b’ch_šsid
 = -1;

3607 
diùiÚ¬y
 *
cfg
;

3608 
FILE
 *
å
;

3609 
lše
[128];

3612 
å
 = 
	`fİ’
("cpu.txt", "r");

3613 if(
å
 =ğ
NULL
) {

3614 
	`årštf
(
¡d”r
, "please genrerate cpu core info file with \"-c\" option\n");

3615 
	`ex™
(0);

3618 
tÙ®_b’ch_th»ads
 = 
bšfo
->
Ä—d”s
 + bšfo->
n™”©Üs
 + bšfo->
nwr™”s
 + bšfo->
nd–‘”s
;

3619 
bšfo
->
š¡ªûs
 = (
š¡ªû_šfo_t
 *)
	`m®loc
((š¡ªû_šfo_tè* bšfo->
nfes
);

3620 
i
 = 0; i < 
bšfo
->
nfes
; i++) {

3621 
bšfo
->
š¡ªûs
[
i
].
cÜeids_pİ
 = (*)
	`m®loc
((è* bšfo->
pİ_Áh»ads
);

3622 
j
 = 0; j<
bšfo
->
pİ_Áh»ads
; j++)

3623 
bšfo
->
š¡ªûs
[
i
].
cÜeids_pİ
[
j
] = -1;

3625 
bšfo
->
š¡ªûs
[
i
].
cÜeids_b’ch
 = (*)
	`m®loc
((è* 
tÙ®_b’ch_th»ads
);

3626 
j
 = 0; j< 
tÙ®_b’ch_th»ads
; j++)

3627 
bšfo
->
š¡ªûs
[
i
].
cÜeids_b’ch
[
j
] = -1;

3628 
bšfo
->
š¡ªûs
[
i
].
nodeid_lßd
 = -1;

3629 
bšfo
->
š¡ªûs
[
i
].
nodeid_³rf
 = -1;

3632 
bšfo
->
ıušfo
->
ıuli¡
 = (**)
	`ÿÎoc
(1, (*è* bšfo->ıušfo->
num_numªodes
);

3633 
i
 = 0; i < 
bšfo
->
ıušfo
->
num_numªodes
; i++) {

3634 
bšfo
->
ıušfo
->
ıuli¡
[
i
] = (*)
	`ÿÎoc
(1, (è* bšfo->ıušfo->
num_cÜes_³r_numªodes
);

3637 
	`fg‘s
(
lše
, †še, 
å
)!ğ
NULL
 ){

3638 if(
lše_num
 == 0) {line_num++; ;}

3639 
	`ssÿnf
(
lše
, "%d,%d,%d,%d", &
nodeid
, &
cÜeid
, &
šsid_lßd
, &
šsid_³rf
);

3640 
bšfo
->
ıušfo
->
ıuli¡
[
nodeid
][
cÜe_couÁ
++ % bšfo->ıušfo->
num_cÜes_³r_numªodes
] = 
cÜeid
;

3641 if(
šsid_lßd
 >=0 && insid_lßd < 
bšfo
->
nfes
) {

3642 if(
´ev_lßd_šsid
 !ğ
šsid_lßd
) {

3643 if(
´ev_lßd_šsid
 != -1){

3644 
cur_lßd
 < 
bšfo
->
pİ_Áh»ads
)

3645 
bšfo
->
š¡ªûs
[
´ev_lßd_šsid
].
cÜeids_pİ
[
cur_lßd
++] = -1;

3647 
cur_lßd
 = 0;

3648 
´ev_lßd_šsid
 = 
šsid_lßd
;

3649 
bšfo
->
š¡ªûs
[
šsid_lßd
].
nodeid_lßd
 = 
nodeid
;

3651 if(
cur_lßd
 < 
bšfo
->
pİ_Áh»ads
)

3652 
bšfo
->
š¡ªûs
[
šsid_lßd
].
cÜeids_pİ
[
cur_lßd
++] = 
cÜeid
;

3655 if(
šsid_³rf
 >=0 && insid_³rà< 
bšfo
->
nfes
){

3656 if(
´ev_b’ch_šsid
 !ğ
šsid_³rf
) {

3657 if(
´ev_b’ch_šsid
 != -1) {

3658 
cur_b’ch
 < 
tÙ®_b’ch_th»ads
)

3659 
bšfo
->
š¡ªûs
[
´ev_b’ch_šsid
].
cÜeids_b’ch
[
cur_b’ch
++] = -1;

3661 
cur_b’ch
 = 0;

3662 
´ev_b’ch_šsid
 = 
šsid_³rf
;

3663 
bšfo
->
š¡ªûs
[
šsid_³rf
].
nodeid_³rf
 = 
nodeid
;

3665 if(
cur_b’ch
 < 
tÙ®_b’ch_th»ads
)

3666 
bšfo
->
š¡ªûs
[
šsid_³rf
].
cÜeids_b’ch
[
cur_b’ch
++] = 
cÜeid
;

3668 
lše_num
++;

3671 
i
=0;i<
bšfo
->
ıušfo
->
num_numªodes
;i++){

3672 
	`´štf
("nod%d: ", 
i
);

3673 
j
=0;j< 
bšfo
->
ıušfo
->
num_cÜes_³r_numªodes
; j++)

3674 
	`´štf
("%d ", 
bšfo
->
ıušfo
->
ıuli¡
[
i
][
j
]);

3675 
	`´štf
("\n");

3678 
i
 = 0; i < 
bšfo
->
nfes
; i++) {

3679 
	`g‘_nvme_numa_node
(
bšfo
->
deviû_Çme
[
i
], &bšfo->
š¡ªûs
[i]);

3680 
cur_lßd
 < 
bšfo
->
pİ_Áh»ads
){

3682 
bšfo
->
š¡ªûs
[
i
].
cÜeids_pİ
[
cur_lßd
++] = -1;

3684 
cur_b’ch
 < 
tÙ®_b’ch_th»ads
) {

3686 
bšfo
->
š¡ªûs
[
i
].
cÜeids_b’ch
[
cur_b’ch
++] = -1;

3690 
i
 = 0;˜< 
bšfo
->
nfes
; i++){

3691 
	`´štf
("pİ -- dev %s,‚umaid %d, cÜe: ", 
bšfo
->
deviû_Çme
[
i
], bšfo->
š¡ªûs
[i].
nodeid_lßd
);

3692 
j
 = 0; j < 
bšfo
->
pİ_Áh»ads
; j++)

3693 
	`´štf
("%d ", 
bšfo
->
š¡ªûs
[
i
].
cÜeids_pİ
[
j
]);

3694 
	`´štf
("\n");

3696 
i
 = 0;˜< 
bšfo
->
nfes
; i++){

3697 
	`´štf
("b’ch --- dev %s,‚umaid %d, cÜe: ", 
bšfo
->
deviû_Çme
[
i
], bšfo->
š¡ªûs
[i].
nodeid_³rf
);

3698 
j
 = 0; j < 
tÙ®_b’ch_th»ads
; j++)

3699 
	`´štf
("%d ", 
bšfo
->
š¡ªûs
[
i
].
cÜeids_b’ch
[
j
]);

3700 
	`´štf
("\n");

3703 if(
å
è
	`fşo£
(fp);

3704 
	}
}

3706 
b’ch_šfo
 
	$g‘_b’chšfo
(* 
b’ch_cÚfig_f’ame
, 
cÚfig_Úly
)

3708 
i
, 
j
;

3709 
diùiÚ¬y
 *
cfg
;

3710 *
¡r
;

3711 
b’ch_šfo
 
bšfo
;

3712 *
±
;

3713 
	`mem£t
(&
bšfo
, 0x0, (binfo));

3714 
cfg
 = 
	`š¬£r_Ãw
(
b’ch_cÚfig_f’ame
);

3716 if(
cÚfig_Úly
){

3717 
ıu_šfo
 *
ıušfo
 = (ıu_šfØ*)
	`m®loc
((cpu_info));

3718 
	`mem£t
(
ıušfo
, 0, (
ıu_šfo
));

3719 
	`g‘_ıušfo
(
ıušfo
, 1);

3720 
	`´štf
("tÙ® %d‚odes, %d cÜe ³¸node\n", 
ıušfo
->
num_numªodes
, cpušfo->
num_cÜes_³r_numªodes
);

3721 
	`ä“
(
ıušfo
);

3722 
	`ex™
(0);

3724 
bšfo
.
ıušfo
 = (
ıu_šfo
 *)
	`m®loc
((cpu_info));

3725 
	`mem£t
(
bšfo
.
ıušfo
, 0, (
ıu_šfo
));

3726 
	`g‘_ıušfo
(
bšfo
.
ıušfo
, 0);

3730 *
dbÇme
 = (*)
	`m®loc
(64);

3731 *
f’ame
 = (*)
	`m®loc
(256);

3732 *
š™_f’ame
 = (*)
	`m®loc
(256);

3733 *
log_f’ame
 = (*)
	`m®loc
(256);

3734 *
deviû_·th
 = (*)
	`m®loc
(256);

3735 *
kv_deviû_·th
 = (*)
	`m®loc
(1024);

3736 *
kv_emul_cÚfigfe
 = (*)
	`m®loc
(1024);

3737 *
Çme_¥aû
 = (*)
	`m®loc
(256);

3738 *
¥dk_cÚf_fe
 = (*)
	`m®loc
(256);

3740 *
cÜe_ids
 = (*)
	`m®loc
(256);

3741 *
cq_th»ad_ids
 = (*)
	`m®loc
(256);

3742 
dbÇme_po¡fix
[64];

3743 
size_t
 
ncÜes
;

3744 #ià
	`defšed
(
WIN32
è|| defšed(
_WIN32
)

3745 
SYSTEM_INFO
 
sysšfo
;

3746 
	`G‘Sy¡emInfo
(&
sysšfo
);

3747 
ncÜes
 = (
size_t
)
sysšfo
.
dwNumb”OfProûssÜs
;

3749 
ncÜes
 = (
size_t
)
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

3752 #ifdeà
__FDB_BENCH


3753 
	`¥rštf
(
dbÇme
, "ForestDB");

3754 
	`¥rštf
(
dbÇme_po¡fix
, "fdb");

3755 #–ià
__COUCH_BENCH


3756 
	`¥rštf
(
dbÇme
, "Couchstore");

3757 
	`¥rštf
(
dbÇme_po¡fix
, "couch");

3758 #–ià
__LEVEL_BENCH


3759 
	`¥rštf
(
dbÇme
, "LevelDB");

3760 
	`¥rštf
(
dbÇme_po¡fix
, "level");

3761 #–ià
__ROCKS_BENCH


3762 
	`¥rštf
(
dbÇme
, "RocksDB");

3763 
	`¥rštf
(
dbÇme_po¡fix
, "rocks");

3764 #–ià
__BLOBFS_ROCKS_BENCH


3765 
	`¥rštf
(
dbÇme
, "BlobFSRocksDB");

3766 
	`¥rštf
(
dbÇme_po¡fix
, "blobfs_rocks");

3767 #–ià
__WT_BENCH


3768 
	`¥rštf
(
dbÇme
, "WiredTiger");

3769 
	`¥rštf
(
dbÇme_po¡fix
, "wt");

3770 #–ià
__KV_BENCH


3771 
	`¥rštf
(
dbÇme
, "KVS");

3772 
	`¥rštf
(
dbÇme_po¡fix
, "kvs");

3773 #–ià
__KVDB_BENCH


3774 
	`¥rštf
(
dbÇme
, "KVDB");

3775 
	`¥rštf
(
dbÇme_po¡fix
, "kvdb");

3776 #–ià
__KVROCKS_BENCH


3777 
	`¥rštf
(
dbÇme
, "KVROCKS");

3778 
	`¥rštf
(
dbÇme_po¡fix
, "kvrocks");

3779 #–ià
__AS_BENCH


3780 
	`¥rštf
(
dbÇme
, "Aerospike");

3781 
	`¥rštf
(
dbÇme_po¡fix
, "as");

3783 
	`¥rštf
(
dbÇme
, "unknown");

3784 
	`¥rštf
(
dbÇme_po¡fix
, "unknown");

3788 
bšfo
.
dbÇme
 = dbname;

3789 
bšfo
.
f’ame
 = filename;

3790 
bšfo
.
š™_f’ame
 = init_filename;

3791 
bšfo
.
log_f’ame
 =†og_filename;

3792 
bšfo
.
deviû_·th
 = device_path;

3793 
bšfo
.
kv_deviû_·th
 = kv_device_path;

3794 
bšfo
.
kv_emul_cÚfigfe
 = kv_emul_configfile;

3795 
bšfo
.
cÜe_ids
 = core_ids;

3796 
bšfo
.
cq_th»ad_ids
 = cq_thread_ids;

3797 
bšfo
.
¥dk_cÚf_fe
 = spdk_conf_file;

3799 
bšfo
.
Çme_¥aû
 =‚ame_space;

3801 
bšfo
.
ndocs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"document:ndocs", 10000);

3803 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"document:key_file", (*)"");

3804 ià(
	`¡rcmp
(
¡r
, "")) {

3805 
bšfo
.
keyfe
 = (*)
	`m®loc
(256);

3806 
	`¡rıy
(
bšfo
.
keyfe
, 
¡r
);

3807 
	`_£t_keylßd”
(&
bšfo
);

3809 
bšfo
.
keyfe
 = 
NULL
;

3811 
bšfo
.
amp_çùÜ
 = 
	`š¬£r_g‘doubË
(
cfg
, (*)"document:amp_factor", 1);

3813 
poŞ_šfo_t
 
šfo
;

3814 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"system:allocator", (*)"default");

3816 ià(
¡r
[0] == 'N' || str[0] == 'n') {

3817 
bšfo
.
®loÿ‹_mem
 = &
®loÿ‹_mem_numa
;

3818 
bšfo
.
ä“_mem
 = &
ä“_mem_numa
;

3819 
bšfo
.
®loÿtÜty³
 = 
šfo
.®loÿtÜty³ = 
NUMA_ALLOCATOR
;

3820 } ià(
¡r
[0] == 'p' || str[0] == 'P'){

3821 
bšfo
.
®loÿ‹_mem
 = &
®loÿ‹_mem_posix
;

3822 
bšfo
.
ä“_mem
 = &
ä“_mem_posix
;

3823 
bšfo
.
®loÿtÜty³
 = 
šfo
.®loÿtÜty³ = 
POSIX_ALLOCATOR
;

3824 } ià(
¡r
[0] == 's' || str[0] == 'S') {

3825 #ià
defšed
 
__KV_BENCH


3826 
bšfo
.
®loÿ‹_mem
 = &
®loÿ‹_mem_¥dk
;

3827 
bšfo
.
ä“_mem
 = &
ä“_mem_¥dk
;

3828 
bšfo
.
®loÿtÜty³
 = 
šfo
.®loÿtÜty³ = 
SPDK_ALLOCATOR
;

3830 
	`årštf
(
¡dout
, "No SPDK‡llocator‡vailable,…lease use Posix or Numa\n");

3831 
	`ex™
(0);

3835 
bšfo
.
®loÿtÜty³
 = 
šfo
.®loÿtÜty³ = 
NO_POOL
;

3838 
bšfo
.
kp_numun™s
 = 
	`š¬£r_g‘št
(
cfg
, (*)"system:key_pool_size", 128);

3839 
bšfo
.
kp_un™size
 = 
	`š¬£r_g‘št
(
cfg
, (*)"system:key_pool_unit", 16);

3840 
bšfo
.
kp_®ignm’t
 = 
	`š¬£r_g‘št
(
cfg
, (*)"system:key_pool_alignment", 4096);

3841 
bšfo
.
vp_numun™s
 = 
	`š¬£r_g‘št
(
cfg
, (*)"system:value_pool_size", 128);

3842 
bšfo
.
vp_un™size
 = 
	`š¬£r_g‘št
(
cfg
, (*)"system:value_pool_unit", 4096);

3843 
bšfo
.
vp_®ignm’t
 = 
	`š¬£r_g‘št
(
cfg
, (*)"system:value_pool_alignment", 4096);

3845 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:write_mode", (*)"sync");

3846 
bšfo
.
kv_wr™e_mode
 = (
¡r
[0]=='s')?(1):(0);

3848 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:allow_sleep", (*)"true");

3849 
bšfo
.
®low_¦“p
 = (
¡r
[0]=='t')?(1):(0);

3851 *
devÇme_»t
;

3852 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"system:device_path", (*)"");

3853 
	`¡rıy
(
bšfo
.
deviû_·th
, 
¡r
);

3855 
bšfo
.
deviû_Çme
 = (**)
	`m®loc
((*) * 256);

3856 
i
 = 0;

3857 
±
 = 
	`¡¹ok
 (
¡r
, ",");

3858 
±
 !ğ
NULL
){

3859 
bšfo
.
deviû_Çme
[
i
] = (*)
	`m®loc
(256);

3860 
devÇme_»t
 = 
	`_g‘_f’ame_pos
(
±
);

3861 
	`¡rıy
(
bšfo
.
deviû_Çme
[
i
++], 
devÇme_»t
);

3862 
±
 = 
	`¡¹ok
(
NULL
, ",");

3864 
bšfo
.
nfes
 = 
i
;

3866 #ià
	`defšed
(
__KV_BENCH
è|| defšed (
__AS_BENCH
è|| defšed (
__KVROCKS_BENCH
)

3867 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:store_option", (*)"post");

3868 ià(
¡r
[0] =ğ'i' || sŒ[0] =ğ'I'è
bšfo
.
¡Üe_İtiÚ
 = 0;

3869 ià(
¡r
[0] =ğ'p' || sŒ[0] =ğ'P'è
bšfo
.
¡Üe_İtiÚ
 = 1;

3870 
bšfo
.
¡Üe_İtiÚ
 = 2;

3872 
bšfo
.
queue_d•th
 = 
	`š¬£r_g‘št
(
cfg
, (*)"kvs:queue_depth", 8);

3873 if(
bšfo
.
kv_wr™e_mode
 == 0) {

3874 ià(
bšfo
.
queue_d•th
 > bšfo.
kp_numun™s
 || bšfo.queue_d•th > bšfo.
vp_numun™s
) {

3875 
	`årštf
(
¡d”r
, "wARN: PËa£ s‘ key/v®upoŞ un™ƒqu®ØÜ†¬g”hªhqueue_d•th: %d\n", 
bšfo
.
queue_d•th
);

3876 
	`ex™
(1);

3880 
bšfo
.
aiÙh»ads_³r_deviû
 = 
	`š¬£r_g‘št
(
cfg
, (*)"kvs:aiothreads_per_device", 2);

3882 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:core_ids", (*)"1");

3883 
	`¡rıy
(
bšfo
.
cÜe_ids
, 
¡r
);

3885 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:cq_thread_ids", (*)"2");

3886 
	`¡rıy
(
bšfo
.
cq_th»ad_ids
, 
¡r
);

3888 
bšfo
.
mem_size_mb
 = 
	`š¬£r_g‘št
(
cfg
, (*)"kvs:mem_size_mb", 1024);

3889 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:device_path", (*)"");

3890 
	`¡rıy
(
bšfo
.
kv_deviû_·th
, 
¡r
);

3892 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:emul_configfile", (*)"/tmp/kvemul.conf");

3893 
	`¡rıy
(
bšfo
.
kv_emul_cÚfigfe
, 
¡r
);

3895 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:with_iterator", (*)"false");

3896 ià(
¡r
[0] == 't' || str[0] == 'T') {

3898 
bšfo
.
w™h_™”©Ü
 = 1;

3899 } ià(
¡r
[0] == 'a' || str[0] == 'A') {

3901 
bšfo
.
w™h_™”©Ü
 = 2;

3904 
bšfo
.
w™h_™”©Ü
 = 0;

3907 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"kvs:iterator_mode", (*)"key");

3908 ià(
¡r
[0] == 'v') {

3910 
bšfo
.
™”©Ü_mode
 = 1;

3913 
bšfo
.
™”©Ü_mode
 = 0;

3915 
	`årštf
(
¡dout
, "w™h i‹¿tÜ %d - mod%d\n", 
bšfo
.
w™h_™”©Ü
, bšfo.
™”©Ü_mode
);

3926 #ià
	`defšed
(
__AS_BENCH
)

3927 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"aerospike:hosts", (*)"127.0.0.1");

3928 
	`¡rıy
(
bšfo
.
deviû_·th
, 
¡r
);

3930 
bšfo
.
as_pÜt
 = 
	`š¬£r_g‘št
(
cfg
, (*)"aerospike:port", 3000);

3931 
bšfo
.
loİ_ÿ·c™y
 = 
	`š¬£r_g‘št
(
cfg
, (*)"aerospike:loop_capacity", 10);

3933 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"aerospike:namespace", (*)"test");

3934 
	`¡rıy
(
bšfo
.
Çme_¥aû
, 
¡r
);

3937 #ià
	`defšed
(
__BLOBFS_ROCKS_BENCH
)

3938 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"blobfs:spdk_conf_file", (*)"");

3939 
	`¡rıy
(
bšfo
.
¥dk_cÚf_fe
, 
¡r
);

3942 
bšfo
.
¥dk_ÿche_size
 = 
	`š¬£r_g‘št
(
cfg
, (*)"blobfs:spdk_cache_size", 4096);

3943 
	`årštf
(
¡d”r
, "SPDK CÚàfe: %s, cachsize: %lu.\n", 
bšfo
.
¥dk_cÚf_fe
, bšfo.
¥dk_ÿche_size
);

3946 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"log:filename", (*)"");

3947 
	`¡rıy
(
bšfo
.
log_f’ame
, 
¡r
);

3949 
bšfo
.
ÿche_size
 =

3950 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:cache_size_MB", 128);

3951 
bšfo
.
ÿche_size
 *= (1024*1024);

3953 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_config:compaction_mode",

3955 ià(
¡r
[0] =ğ'a' || sŒ[0] =ğ'A'è
bšfo
.
auto_com·ùiÚ
 = 1;

3956 
bšfo
.
auto_com·ùiÚ
 = 0;

3957 #ià
	`defšed
(
__LEVEL_BENCH
è|| defšed(
__ROCKS_BENCH
è|| defšed(
__WT_BENCH
è|| defšed(
__BLOBFS_ROCKS_BENCH
è|| defšed(
__KVDB_BENCH
)

3958 
bšfo
.
auto_com·ùiÚ
 = 1;

3959 #–ià
	`defšed
(
__COUCH_BENCH
)

3961 
bšfo
.
auto_com·ùiÚ
 = 0;

3965 
bšfo
.
auto_com·ùiÚ_th»ads
 =

3966 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:auto_compaction_threads", 4);

3969 
bšfo
.
wbs_š™
 =

3970 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:wbs_init_MB", 4);

3971 
bšfo
.
wbs_š™
 *= (1024*1024);

3972 
bšfo
.
wbs_b’ch
 =

3973 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:wbs_bench_MB", 4);

3974 
bšfo
.
wbs_b’ch
 *= (1024*1024);

3976 
bšfo
.
bloom_bpk
 =

3977 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:bloom_bits_per_key", 0);

3979 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_config:compaction_style",

3981 ià(
¡r
[0] == 'F' || str[0] == 'f') {

3983 
bšfo
.
com·ùiÚ_¡yË
 = 2;

3984 } ià(
¡r
[0] == 'U' || str[0] == 'u') {

3986 
bšfo
.
com·ùiÚ_¡yË
 = 1;

3989 
bšfo
.
com·ùiÚ_¡yË
 = 0;

3992 
bšfo
.
fdb_w®
 = 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:fdb_wal", 4096);

3994 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_config:fdb_type", (*)"hb+trie");

3995 ià(
¡r
[0] == 'h' || str[0] == 'H') {

3996 
bšfo
.
fdb_ty³
 = 0;

3998 
bšfo
.
fdb_ty³
 = 1;

4001 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_config:wt_type", (*)"btree");

4002 ià(
¡r
[0] == 'b' || str[0] == 'B') {

4003 
bšfo
.
wt_ty³
 = 0;

4005 
bšfo
.
wt_ty³
 = 1;

4009 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_config:compression", (*)"false");

4010 ià(
¡r
[0] == 't' || str[0] == 'T' || str[0] == 'e' || str[0] == 'E') {

4012 
bšfo
.
com´essiÚ
 = 1;

4014 
bšfo
.
com´essiÚ
 = 0;

4017 
bšfo
.
¥l™_pù
 =

4018 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:split_pct", 100);

4019 
bšfo
.
Ëaf_pg_size
 =

4020 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:leaf_pg_size_KB", 4);

4021 
bšfo
.
št_pg_size
 =

4022 
	`š¬£r_g‘št
(
cfg
, (*)"db_config:int_pg_size_KB", 4);

4024 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_file:filename",

4026 
dœÇme
[256], *
dœÇme_»t
, *
f’ame_»t
;

4027 
dœÇme_»t
 = 
	`_g‘_dœÇme
(
¡r
, 
dœÇme
);

4028 
f’ame_»t
 = 
	`_g‘_f’ame_pos
(
¡r
);

4029 ià(
dœÇme_»t
) {

4034 
	`¥rštf
(
bšfo
.
f’ame
, "%s/%s", 
dœÇme_»t
, 
f’ame_»t
);

4036 
	`¥rštf
(
bšfo
.
f’ame
, "%s/%s_%s",

4037 
dbÇme_po¡fix
, 
¡r
, dbname_postfix);

4040 
	`´štf
("db‚am%s\n", 
bšfo
.
f’ame
);

4042 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"db_file:init_filename",

4043 
bšfo
.
f’ame
);

4044 
	`¡rıy
(
bšfo
.
š™_f’ame
, 
¡r
);

4046 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"population:pre_gen",

4048 
bšfo
.
´e_g’
 = (
¡r
[0]=='t')?(1):(0);

4050 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"population:seq_fill",

4052 
bšfo
.
£q_fl
 = (
¡r
[0]=='t')?(1):(0);

4054 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"population:pop_first",

4056 
bšfo
.
pİ_fœ¡
 = (
¡r
[0]=='t')?(1):(0);

4058 
bšfo
.
pİ_Áh»ads
 = 
	`š¬£r_g‘št
(
cfg
, (*)"population:nthreads",

4059 
ncÜes
*2);

4060 ià(
bšfo
.
pİ_Áh»ads
 < 1èbšfo.pİ_Áh»ad ğ
ncÜes
*2;

4061 #ià
defšed
 
__KV_BENCH
 || defšed 
__KVROCKS_BENCH


4062 if(
bšfo
.
pİ_Áh»ads
 > 1) {

4063 
	`årštf
(
¡d”r
, "WARN: KV SSD only support onehread…er device‚ow\n");

4065 
bšfo
.
pİ_Áh»ads
 = 1;

4068 
bšfo
.
pİ_b©chsize
 = 
	`š¬£r_g‘št
(
cfg
, (*)"population:batchsize",

4071 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"population:periodic_commit",

4073 ià(
¡r
[0] =ğ'n' ) 
bšfo
.
pİ_comm™
 = 0;

4074 
bšfo
.
pİ_comm™
 = 1;

4076 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"population:fdb_flush_wal",

4078 ià(
¡r
[0] =ğ'n' ) 
bšfo
.
fdb_æush_w®
 = 0;

4079 
bšfo
.
fdb_æush_w®
 = 1;

4082 
max_key_Ën
;

4083 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"key_length:distribution",

4085 ià(
¡r
[0] == 'n') {

4086 
bšfo
.
keyËn
.
ty³
 = 
RND_NORMAL
;

4087 
bšfo
.
keyËn
.
a
 = 
	`š¬£r_g‘št
(
cfg
, (*)"key_length:median", 64);

4088 
bšfo
.
keyËn
.
b
 =

4089 
	`š¬£r_g‘št
(
cfg
, (*)"key_length:standard_deviation", 8);

4090 
max_key_Ën
 = 
bšfo
.
keyËn
.
a
 + bšfo.keyËn.
b
 * 6;

4091 }ià(
¡r
[0] == 'u'){

4092 
bšfo
.
keyËn
.
ty³
 = 
RND_UNIFORM
;

4093 
bšfo
.
keyËn
.
a
 =

4094 
	`š¬£r_g‘št
(
cfg
, (*)"key_length:lower_bound", 32);

4095 
bšfo
.
keyËn
.
b
 =

4096 
	`š¬£r_g‘št
(
cfg
, (*)"key_length:upper_bound", 96);

4097 
max_key_Ën
 = 
bšfo
.
keyËn
.
b
 + 16;

4099 
bšfo
.
keyËn
.
ty³
 = 
RND_FIXED
;

4100 
bšfo
.
keyËn
.
a
 = 
	`š¬£r_g‘št
(
cfg
, (*)"key_length:fixed_size", 16);

4101 
max_key_Ën
 = 
bšfo
.
keyËn
.
a
;

4103 if(
bšfo
.
kp_un™size
 < 
max_key_Ën
) {

4104 
	`årštf
(
¡d”r
, "WARN: PËa£ s‘ 'key_poŞ_un™'Øbequ®ØÜ†¬g”hªhÏrge¡…ossibË key sizš you¸cÚfig: %d\n", 
max_key_Ën
);

4105 
	`ex™
(1);

4109 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"prefix:distribution",

4111 ià(
¡r
[0] == 'n') {

4112 
bšfo
.
´efixËn
.
ty³
 = 
RND_NORMAL
;

4113 
bšfo
.
´efixËn
.
a
 = 
	`š¬£r_g‘št
(
cfg
, (*)"prefix:median", 8);

4114 
bšfo
.
´efixËn
.
b
 =

4115 
	`š¬£r_g‘št
(
cfg
, (*)"prefix:standard_deviation", 1);

4117 
bšfo
.
´efixËn
.
ty³
 = 
RND_UNIFORM
;

4118 
bšfo
.
´efixËn
.
a
 =

4119 
	`š¬£r_g‘št
(
cfg
, (*)"prefix:lower_bound", 4);

4120 
bšfo
.
´efixËn
.
b
 =

4121 
	`š¬£r_g‘št
(
cfg
, (*)"prefix:upper_bound", 12);

4123 
bšfo
.
Æev–
 = 
	`š¬£r_g‘št
(
cfg
, (*)"prefix:level", 0);

4124 
bšfo
.
Å»fixes
 = 
	`š¬£r_g‘št
(
cfg
, (*)"prefix:nprefixes", 100);

4127 
bšfo
.
Ä—d”s
 = 
	`š¬£r_g‘št
(
cfg
, (*)"threads:readers", 0);

4128 
bšfo
.
n™”©Üs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"threads:iterators", 0);

4129 
bšfo
.
nwr™”s
 = 
	`š¬£r_g‘št
(
cfg
, (*)"threads:writers", 0);

4130 
bšfo
.
nd–‘”s
 = 
	`š¬£r_g‘št
(
cfg
, (*)"threads:deleters", 0);

4131 
bšfo
.
»ad”_İs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"threads:reader_ops", 0);

4132 
bšfo
.
wr™”_İs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"threads:writer_ops", 0);

4133 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"threads:disjoint_write", (*)"false");

4134 ià(
¡r
[0] == 't' || str[0] == 'T' || str[0] == 'e' || str[0] == 'E') {

4136 
bšfo
.
disjošt_wr™e
 = 1;

4138 
bšfo
.
disjošt_wr™e
 = 0;

4140 #ià
defšed
 
__KV_BENCH
 || defšed 
__KVROCKS_BENCH


4142 ià(
bšfo
.
Ä—d”s
 + bšfo.
nd–‘”s
 + bšfo.
nwr™”s
 > 1) {

4143 
	`årštf
(
¡d”r
, "WARN: KV SSD only support onehread…er device‚ow\n");

4145 
bšfo
.
Ä—d”s
 = bšfo.
nd–‘”s
 = 0;

4146 
bšfo
.
nwr™”s
 = 1;

4148 
	`š™_ıu_aff
(&
bšfo
);

4151 
	`_£t_keyg’
(&
bšfo
);

4154 
max_body_buf
;

4155 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"body_length:distribution",

4157 ià(
¡r
[0] == 'n') {

4158 
bšfo
.
bodyËn
.
ty³
 = 
RND_NORMAL
;

4159 
bšfo
.
bodyËn
.
a
 =

4160 
	`š¬£r_g‘št
(
cfg
, (*)"body_length:median", 512);

4161 
bšfo
.
bodyËn
.
b
 =

4162 
	`š¬£r_g‘št
(
cfg
, (*)"body_length:standard_deviation", 32);

4163 
DATABUF_MAXLEN
 = 
bšfo
.
bodyËn
.
a
 + 5*bšfo.bodyËn.
b
;

4164 
max_body_buf
 = 
bšfo
.
bodyËn
.
a
 + bšfo.bodyËn.
b
 * 6;

4165 }ià(
¡r
[0] == 'u'){

4166 
bšfo
.
bodyËn
.
ty³
 = 
RND_UNIFORM
;

4167 
bšfo
.
bodyËn
.
a
 =

4168 
	`š¬£r_g‘št
(
cfg
, (*)"body_length:lower_bound", 448);

4169 
bšfo
.
bodyËn
.
b
 =

4170 
	`š¬£r_g‘št
(
cfg
, (*)"body_length:upper_bound", 576);

4171 
DATABUF_MAXLEN
 = 
bšfo
.
bodyËn
.
b
;

4172 
max_body_buf
 = 
bšfo
.
bodyËn
.
b
 + 16;

4173 } ià(
¡r
[0] == 'f'){

4174 
bšfo
.
bodyËn
.
ty³
 = 
RND_FIXED
;

4175 
bšfo
.
bodyËn
.
a
 =

4176 
	`š¬£r_g‘št
(
cfg
, (*)"body_length:fixed_size", 512);

4177 
DATABUF_MAXLEN
 = 
bšfo
.
bodyËn
.
a
;

4178 
max_body_buf
 = 
bšfo
.
bodyËn
.
a
;

4179 } ià(
¡r
[0] == 'r') {

4180 
buf
[256];

4181 *
±
;

4182 
i
 = 0;

4183 
bšfo
.
bodyËn
.
ty³
 = 
RND_RATIO
;

4184 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"body_length:value_size",(*)"4096");

4185 
	`mem£t
(
bšfo
.
v®ue_size
, 0, (binfo.value_size));

4186 
	`¡rıy
(
buf
, 
¡r
);

4187 
±
 = 
	`¡¹ok
 ((*)
buf
, ",");

4188 
±
 !ğ
NULL
 && 
i
 < 5) {

4189 
bšfo
.
v®ue_size
[
i
++] = 
	`©oi
(
±
);

4190 
DATABUF_MAXLEN
 = 
	`MAX
(DATABUF_MAXLEN, 
	`©oi
(
±
));

4191 
±
 = 
	`¡¹ok
(
NULL
, ",");

4193 
max_body_buf
 = 
DATABUF_MAXLEN
;

4194 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"body_length:value_size_ratio",(*)"100:0");

4195 
i
 = 0;

4196 
tÙ®_¿tio
 = 0;;

4197 
	`mem£t
(
bšfo
.
v®ue_size_¿tio
, 0, (binfo.value_size_ratio));

4198 
	`¡rıy
(
buf
, 
¡r
);

4199 
±
 = 
	`¡¹ok
((*)
buf
, ":");

4200 
±
!ğ
NULL
 && 
i
 < 5) {

4201 
bšfo
.
v®ue_size_¿tio
[
i
++] = 
	`©oi
(
±
);

4202 
tÙ®_¿tio
 +ğ
	`©oi
(
±
);

4203 
±
 = 
	`¡¹ok
(
NULL
, ":");

4206 if(
tÙ®_¿tio
 != 100) {

4207 
	`årštf
(
¡dout
, "WARN: Total value size„atio shouldƒqualo 100\n");

4208 
	`ex™
(1);

4211 
bšfo
.
vp_un™size
 = 
DATABUF_MAXLEN
;

4214 
	`årštf
(
¡dout
, "Please set value size (body_length) distribution…roperly:\n");

4215 
	`årštf
(
¡dout
, "fixed,ratio,uniform,normal\n");

4216 
	`ex™
(1);

4219 if(
bšfo
.
vp_un™size
 < 
max_body_buf
) {

4220 
	`årštf
(
¡d”r
, "WARN: PËa£ s‘ 'v®ue_poŞ_un™'Øbequ®ØÜ†¬g”hªhÏrge¡…ossibË v®usizš you¸cÚfig: %d\n", 
max_body_buf
);

4221 
	`ex™
(1);

4223 if(
bšfo
.
vp_un™size
 =ğ0 || bšfo.
kp_un™size
 == 0){

4224 
	`årštf
(
¡d”r
, "WARN: Invalide memory…ool size, should be greaterhan 0\n");

4225 
	`ex™
(1);

4228 
bšfo
.
com´essib™y
 =

4229 
	`š¬£r_g‘št
(
cfg
, (*)"body_length:compressibility", 100);

4230 ià(
bšfo
.
com´essib™y
 > 100) {

4231 
bšfo
.
com´essib™y
 = 100;

4233 ià(
bšfo
.
com´essib™y
 < 0) {

4234 
bšfo
.
com´essib™y
 = 0;

4237 
bšfo
.
nb©ches
 = 
	`š¬£r_g‘št
(
cfg
, (*)"operation:nbatches", 0);

4238 
bšfo
.
nİs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"operation:nops", 0);

4239 
bšfo
.
w¬mup_£cs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"operation:warmingup", 0);

4240 
bšfo
.
b’ch_£cs
 = 
	`š¬£r_g‘št
(
cfg
, (*)"operation:duration", 0);

4241 ià(
bšfo
.
nb©ches
 =ğ0 && bšfo.
nİs
 =ğ0 && bšfo.
b’ch_£cs
 == 0) {

4242 
bšfo
.
b’ch_£cs
 = 60;

4245 
size_t
 
avg_wr™e_b©chsize
;

4246 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"operation:batchsize_distribution",

4248 ià(
¡r
[0] == 'n') {

4249 
bšfo
.
rb©chsize
.
ty³
 = 
RND_NORMAL
;

4250 
bšfo
.
rb©chsize
.
a
 =

4251 
	`š¬£r_g‘št
(
cfg
, (*)"operation:read_batchsize_median", 3);

4252 
bšfo
.
rb©chsize
.
b
 =

4253 
	`š¬£r_g‘št
(
cfg
, (*)"operation:read_batchsize_"

4255 
bšfo
.
ib©chsize
.
ty³
 = 
RND_NORMAL
;

4256 
bšfo
.
ib©chsize
.
a
 =

4257 
	`š¬£r_g‘št
(
cfg
, (*)"operation:iterate_batchsize_median", 1000);

4258 
bšfo
.
ib©chsize
.
b
 =

4259 
	`š¬£r_g‘št
(
cfg
, (*)"operation:iterate_batchsize_"

4261 
bšfo
.
wb©chsize
.
ty³
 = 
RND_NORMAL
;

4262 
bšfo
.
wb©chsize
.
a
 =

4263 
	`š¬£r_g‘št
(
cfg
, (*)"operation:write_batchsize_"

4265 
bšfo
.
wb©chsize
.
b
 =

4266 
	`š¬£r_g‘št
(
cfg
, (*)"operation:write_batchsize_"

4268 
avg_wr™e_b©chsize
 = 
bšfo
.
wb©chsize
.
a
;

4270 
bšfo
.
rb©chsize
.
ty³
 = 
RND_UNIFORM
;

4271 
bšfo
.
rb©chsize
.
a
 =

4272 
	`š¬£r_g‘št
(
cfg
, (*)"operation:read_batchsize_"

4274 
bšfo
.
rb©chsize
.
b
 =

4275 
	`š¬£r_g‘št
(
cfg
, (*)"operation:read_batchsize_"

4277 
bšfo
.
ib©chsize
.
ty³
 = 
RND_UNIFORM
;

4278 
bšfo
.
ib©chsize
.
a
 =

4279 
	`š¬£r_g‘št
(
cfg
, (*)"operation:iterate_batchsize_"

4281 
bšfo
.
ib©chsize
.
b
 =

4282 
	`š¬£r_g‘št
(
cfg
, (*)"operation:iterate_batchsize_"

4284 
bšfo
.
wb©chsize
.
ty³
 = 
RND_UNIFORM
;

4285 
bšfo
.
wb©chsize
.
a
 =

4286 
	`š¬£r_g‘št
(
cfg
, (*)"operation:write_batchsize_"

4288 
bšfo
.
wb©chsize
.
b
 =

4289 
	`š¬£r_g‘št
(
cfg
, (*)"operation:write_batchsize_"

4291 
avg_wr™e_b©chsize
 = (
bšfo
.
wb©chsize
.
a
 + bšfo.wb©chsize.
b
)/2;

4294 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"operation:read_query",

4296 ià(
¡r
[0] == 'k' || str[0] == 'i') {

4297 
bšfo
.
»ad_qu”y_by£q
 = 0;

4301 
bšfo
.
»ad_qu”y_by£q
 = 0;

4329 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
,

4332 ià(
¡r
[0] == 'n') {

4333 
bšfo
.
İ_di¡
.
ty³
 = 
RND_NORMAL
;

4335 
bšfo
.
İ_di¡
.
ty³
 = 
RND_UNIFORM
;

4338 
bšfo
.
b©ch¿nge
 = 
	`š¬£r_g‘št
(
cfg
, (*)"operation:batch_range",

4339 
avg_wr™e_b©chsize
);

4350 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"operation:read_write_insert_delete",

4352 
	`´štf
("¿tiØi %s\n", 
¡r
);

4354 
	`mem£t
(
bšfo
.
¿tio
, 0, (binfo.ratio));

4355 
buff
[256];

4356 
i
 = 0;

4357 
	`¡rıy
(
buff
, 
¡r
);

4358 
±
 = 
	`¡¹ok
 ((*)
buff
, ":");

4359 
±
 !ğ
NULL
){

4360 
bšfo
.
¿tio
[
i
++] = 
	`©oi
(
±
);

4361 
±
 = 
	`¡¹ok
(
NULL
, ":");

4364 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
,

4367 ià(
¡r
[0] == 'u') {

4368 
bšfo
.
b©ch_di¡
.
ty³
 = 
RND_UNIFORM
;

4369 
bšfo
.
b©ch_di¡
.
a
 = 0;

4371 if(
bšfo
.
nİs
 > 0){

4374 
bšfo
.
b©ch_di¡
.
b
 = bšfo.
ndocs
 + bšfo.
nİs
 * bšfo.
¿tio
[2] * 2;

4375 
	`´štf
("Usšg in£¹iÚ„©iØcÚŒŞ, key„ªg0~%ld\n", 
bšfo
.
b©ch_di¡
.
b
);

4377 
bšfo
.
b©ch_di¡
.
b
 = bšfo.
ndocs
 * bšfo.
amp_çùÜ
;

4380 
s
 = 
	`š¬£r_g‘doubË
(
cfg
, (*)"operation:"

4382 
bšfo
.
b©ch_di¡
.
ty³
 = 
RND_ZIPFIAN
;

4383 
bšfo
.
b©ch_di¡
.
a
 = (
št64_t
)(
s
 * 100);

4384 
bšfo
.
b©ch_di¡
.
b
 =

4385 
	`š¬£r_g‘št
(
cfg
, (*)"operation:batch_parameter2", 64);

4388 
¡r
 = 
	`š¬£r_g‘¡ršg
(
cfg
, (*)"operation:write_type",

4390 
bšfo
.
sync_wr™e
 = (
¡r
[0]=='s')?(1):(0);

4392 
bšfo
.
com·ù_th»s
 =

4393 
	`š¬£r_g‘št
(
cfg
, (*)"compaction:threshold", 30);

4394 
bšfo
.
com·ù_³riod
 =

4395 
	`š¬£r_g‘št
(
cfg
, (*)"compaction:period", 60);

4396 
bšfo
.
block_»u£_th»s
 =

4397 
	`š¬£r_g‘št
(
cfg
, (*)"compaction:block_reuse", 70);

4398 ià(
bšfo
.
block_»u£_th»s
) {

4399 ià(
bšfo
.
block_»u£_th»s
 > 100) {

4400 
bšfo
.
block_»u£_th»s
 = 100;

4403 #ifdeà
__FDB_BENCH


4406 
live_¿tio
 = 100 - 
bšfo
.
block_»u£_th»s
;

4407 ià(
bšfo
.
com·ù_th»s
 > 0 && binfo.compact_thres < 100) {

4408 
bšfo
.
com·ù_th»s
 = 100 - 
live_¿tio
/2;

4414 
bšfo
.
Ï‹ncy_¿‹
 =

4415 
	`š¬£r_g‘št
(
cfg
, (*)"latency_monitor:rate", 100);

4416 ià(
bšfo
.
Ï‹ncy_¿‹
 > 1000) {

4417 
bšfo
.
Ï‹ncy_¿‹
 = 1000;

4419 
bšfo
.
Ï‹ncy_max
 =

4420 
	`š¬£r_g‘št
(
cfg
, (*)"latency_monitor:max_samples", 1000000);

4422 
´št_‹rm_ms
 =

4423 
	`š¬£r_g‘št
(
cfg
, (*)"latency_monitor:print_term_ms", 100);

4425 
	`š¬£r_ä“
(
cfg
);

4426  
bšfo
;

4427 
	}
}

4429 
	$maš
(
¬gc
, **
¬gv
){

4430 
İt
, 
i
;

4431 
š™Ÿlize
 = 1;

4432 
cÚfig_Úly
 = 0;

4433 
cÚfig_f’ame
[256];

4434 cÚ¡ *
shÜt_İt
 = "hecf:";

4435 
f’ame
[256], 
tim–og_f’ame
[256];

4436 
š£¹_Ï‹ncy_f’ame
[256], 
š£¹_İs_f’ame
[256];

4437 
run_Ï‹ncy_f’ame
[256], 
run_İs_f’ame
[256];

4438 
b’ch_šfo
 
bšfo
;

4439 
timev®
 
g­
;

4441 
	`¿ndomize
();

4442 
ºd_£ed
 = 
	`¿nd
();

4444 
	`¡rıy
(
cÚfig_f’ame
,"bench_config.ini");

4446 
İtiÚ
 
lÚg_İt
[] =

4448 {"d©aba£", 
no_¬gum’t
, 
NULL
, 'e'},

4449 {"cÚfig", 
no_¬gum’t
, 
NULL
, 'c'},

4450 {"h–p", 
no_¬gum’t
, 
NULL
, 'h'},

4451 {"fe", 
İtiÚ®_¬gum’t
, 
NULL
, 'f'},

4452 {
NULL
, 0, NULL, 0 }

4455  (
İt
 = 
	`g‘İt_lÚg
(
¬gc
, 
¬gv
, 
shÜt_İt
, 
lÚg_İt
, 
NULL
) ) != -1) {

4456 
İt
)

4463 
	`´štf
("Usšg \"%s\" cÚfig fe\n", 
İrg
);

4464 
	`¡rıy
(
cÚfig_f’ame
, 
İrg
);

4468 
	`´štf
("Usingƒxisting DB file\n");

4469 
š™Ÿlize
 = 0;

4473 
	`´štf
("Generating CPU file only\n");

4474 
cÚfig_Úly
 = 1;

4478 
	`´štf
("U§ge: % [OPTIONS]\n", 
¬gv
[0]);

4479 
	`´štf
(" -f file file\n");

4480 
	`´štf
(" -e, --existing useƒxisting database file\n");

4481 
	`´štf
(" -c, --config only generate CPU config file\n");

4482 
	`´štf
(" -h, --help…rinthis help‡ndƒxit\n");

4483 
	`´štf
("\n");

4488 
	`årštf
(
¡d”r
, "Try `% --h–p' fÜ mÜšfÜm©iÚ.\n", 
¬gv
[0]);

4492 
	`årštf
(
¡d”r
, "%s: inv®id o±iÚ -- %c\n", 
¬gv
[0], 
İt
);

4493 
	`årštf
(
¡d”r
, "Try `% --h–p' fÜ mÜšfÜm©iÚ.\n", 
¬gv
[0]);

4498 
bšfo
 = 
	`g‘_b’chšfo
(
cÚfig_f’ame
, 
cÚfig_Úly
);

4500 ià(
	`¡rcmp
(
bšfo
.
log_f’ame
, "")){

4501 
»t
;

4502 
‹mp
[256], 
cmd
[256], *
¡r
, *
f’ame_»t
;

4505 
¡r
 = 
	`_g‘_dœÇme
(
bšfo
.
log_f’ame
, 
‹mp
);

4506 ià(
¡r
) {

4507 ià(!
	`_dÛs_fe_exi¡
(
¡r
)) {

4508 
	`¥rštf
(
cmd
, "mkdœ -°% >ƒ¼Ülog.txt", 
¡r
);

4509 
»t
 = 
	`sy¡em
(
cmd
);

4510 ()
»t
;

4515 
	`g‘timeofday
(&
g­
, 
NULL
);

4517 
f’ame_»t
 = 
	`_g‘_f’ame_pos
(
bšfo
.
log_f’ame
);

4518 
	`¥rštf
(
f’ame
, "%s/%s-%s.txt",

4519 
¡r
, 
bšfo
.
dbÇme
, 
f’ame_»t
);

4520 
log_å
 = 
	`fİ’
(
f’ame
, "w");

4525 
	`¥rštf
(
š£¹_Ï‹ncy_f’ame
, "%s/%s-insert.latency.csv",

4526 
¡r
, 
bšfo
.
dbÇme
);

4527 
	`¥rštf
(
š£¹_İs_f’ame
, "%s/%s-insert.ops.csv",

4528 
¡r
, 
bšfo
.
dbÇme
);

4529 
	`¥rštf
(
run_Ï‹ncy_f’ame
, "%s/%s-run.latency.csv",

4530 
¡r
, 
bšfo
.
dbÇme
);

4531 
	`¥rštf
(
run_İs_f’ame
, "%s/%s-run.ops.csv",

4532 
¡r
, 
bšfo
.
dbÇme
);

4534 
š£¹_Ï‹ncy_å
 = 
	`fİ’
(
š£¹_Ï‹ncy_f’ame
, "w");

4535 
š£¹_İs_å
 = 
	`fİ’
(
š£¹_İs_f’ame
, "w");

4536 if(
bšfo
.
w™h_™”©Ü
 != 2) {

4537 
run_Ï‹ncy_å
 = 
	`fİ’
(
run_Ï‹ncy_f’ame
, "w");

4538 
run_İs_å
 = 
	`fİ’
(
run_İs_f’ame
, "w");

4542 
bšfo
.
š™Ÿlize
 = initialize;

4544 
	`_´št_b’chšfo
(&
bšfo
);

4546 
	`do_b’ch
(&
bšfo
);

4548 ià(
log_å
) {

4549 
	`fşo£
(
log_å
);

4551 if(
š£¹_Ï‹ncy_å
)

4552 
	`fşo£
(
š£¹_Ï‹ncy_å
);

4553 if(
š£¹_İs_å
)

4554 
	`fşo£
(
š£¹_İs_å
);

4555 if(
run_Ï‹ncy_å
)

4556 
	`fşo£
(
run_Ï‹ncy_å
);

4557 if(
run_İs_å
)

4558 
	`fşo£
(
run_İs_å
);

4559 if(
bšfo
.
ıušfo
){

4560 if(
bšfo
.
ıušfo
->
ıuli¡
)

4561 
	`ä“
(
bšfo
.
ıušfo
->
ıuli¡
);

4562 
	`ä“
(
bšfo
.
ıušfo
);

4564 if(
bšfo
.
š¡ªûs
){

4565 if(
bšfo
.
š¡ªûs
->
cÜeids_pİ
)

4566 
	`ä“
(
bšfo
.
š¡ªûs
->
cÜeids_pİ
);

4567 if(
bšfo
.
š¡ªûs
->
cÜeids_b’ch
)

4568 
	`ä“
(
bšfo
.
š¡ªûs
->
cÜeids_b’ch
);

4569 
	`ä“
(
bšfo
.
š¡ªûs
);

4572 if(
bšfo
.
deviû_Çme
) {

4573 
i
 = 0; i < 
bšfo
.
nfes
; i++)

4574 
	`ä“
(
bšfo
.
deviû_Çme
[
i
]);

4575 
	`ä“
(
bšfo
.
deviû_Çme
);

4577 if(
bšfo
.
dbÇme
)

4578 
	`ä“
(
bšfo
.
dbÇme
);

4579 if(
bšfo
.
f’ame
)

4580 
	`ä“
(
bšfo
.
f’ame
);

4581 if(
bšfo
.
š™_f’ame
)

4582 
	`ä“
(
bšfo
.
š™_f’ame
);

4583 if(
bšfo
.
log_f’ame
)

4584 
	`ä“
(
bšfo
.
log_f’ame
);

4585 if(
bšfo
.
deviû_·th
)

4586 
	`ä“
(
bšfo
.
deviû_·th
);

4587 if(
bšfo
.
kv_deviû_·th
)

4588 
	`ä“
(
bšfo
.
kv_deviû_·th
);

4589 if(
bšfo
.
kv_emul_cÚfigfe
)

4590 
	`ä“
(
bšfo
.
kv_emul_cÚfigfe
);

4591 if(
bšfo
.
¥dk_cÚf_fe
)

4592 
	`ä“
(
bšfo
.
¥dk_cÚf_fe
);

4595 if(
bšfo
.
cÜe_ids
)

4596 
	`ä“
(
bšfo
.
cÜe_ids
);

4597 if(
bšfo
.
cq_th»ad_ids
)

4598 
	`ä“
(
bšfo
.
cq_th»ad_ids
);

4599 if(
bšfo
.
Çme_¥aû
)

4600 
	`ä“
(
bšfo
.
Çme_¥aû
);

4602 
	}
}

	@application/kvbench/bench/forestdb_endian.h

1 #iâdeà
_FDB_ENDIAN_H


2 
	#_FDB_ENDIAN_H


	)

4 #ià
defšed
(
WIN32
è|| defšed(
_WIN32
)

5 #iâdeà
_LITTLE_ENDIAN


6 
	#_LITTLE_ENDIAN


	)

9 #–ià
__APPLE__


10 
	~<machše/’dŸn.h
>

11 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


12 #iâdeà
_LITTLE_ENDIAN


13 
	#_LITTLE_ENDIAN


	)

15 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


16 #iâdeà
_BIG_ENDIAN


17 
	#_BIG_ENDIAN


	)

23 #–ià
__lšux__


24 
	~<’dŸn.h
>

25 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


26 #iâdeà
_LITTLE_ENDIAN


27 
	#_LITTLE_ENDIAN


	)

29 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


30 #iâdeà
_BIG_ENDIAN


31 
	#_BIG_ENDIAN


	)

39 #iâdeà
b™sw­64


40 
	#b™sw­64
(
v
) \

41 Ğ(((
v
) & 0xff00000000000000ULL) >> 56) \

42 | (((
v
) & 0x00ff000000000000ULL) >> 40) \

43 | (((
v
) & 0x0000ff0000000000ULL) >> 24) \

44 | (((
v
) & 0x000000ff00000000ULL) >> 8) \

45 | (((
v
) & 0x00000000ff000000ULL) << 8) \

46 | (((
v
) & 0x0000000000ff0000ULL) << 24) \

47 | (((
v
) & 0x000000000000ff00ULL) << 40) \

48 | (((
v
è& 0x00000000000000ffULLè<< 56è)

	)

51 #iâdeà
b™sw­32


52 
	#b™sw­32
(
v
) \

53 Ğ(((
v
) & 0xff000000) >> 24) \

54 | (((
v
) & 0x00ff0000) >> 8) \

55 | (((
v
) & 0x0000ff00) << 8) \

56 | (((
v
è& 0x000000ffè<< 24è)

	)

59 #iâdeà
b™sw­16


60 
	#b™sw­16
(
v
) \

61 Ğ(((
v
) & 0xff00) >> 8) \

62 | (((
v
è& 0x00ffè<< 8è)

	)

65 #ià
defšed
(
_LITTLE_ENDIAN
)

67 
	#_’c64
(
v
è
	`b™sw­64
(v)

	)

68 
	#_dec64
(
v
è
	`b™sw­64
(v)

	)

69 
	#_’c32
(
v
è
	`b™sw­32
(v)

	)

70 
	#_dec32
(
v
è
	`b™sw­32
(v)

	)

71 
	#_’c16
(
v
è
	`b™sw­16
(v)

	)

72 
	#_dec16
(
v
è
	`b™sw­16
(v)

	)

75 
	#_’c64
(
v
è(v)

	)

76 
	#_dec64
(
v
è(v)

	)

77 
	#_’c32
(
v
è(v)

	)

78 
	#_dec32
(
v
è(v)

	)

79 
	#_’c16
(
v
è(v)

	)

80 
	#_dec16
(
v
è(v)

	)

83 #ifdeà
__ENDIAN_SAFE


84 
	#_’dŸn_’code
(
v
) \

85 (((
v
è=ğ8)?(
	`_’c64
(v)):( \

86 ((
v
è=ğ4)?(
	`_’c32
(v)):( \

87 ((
v
è=ğ2)?(
	`_’c16
(v)):(v))))

	)

88 
	#_’dŸn_decode
(
v
) \

89 (((
v
è=ğ8)?(
	`_dec64
(v)):( \

90 ((
v
è=ğ4)?(
	`_dec32
(v)):( \

91 ((
v
è=ğ2)?(
	`_dec16
(v)):(v))))

	)

93 
	#_’dŸn_’code
(
v
è(v)

	)

94 
	#_’dŸn_decode
(
v
è(v)

	)

	@application/kvbench/include/aerospike/aerospike.h

17 #´agm¨
Úû


71 
	~<«ro¥ike/as_”rÜ.h
>

72 
	~<«ro¥ike/as_cÚfig.h
>

73 
	~<«ro¥ike/as_log.h
>

74 
	~<«ro¥ike/as_¡©us.h
>

75 
	~<¡dboŞ.h
>

77 #ifdeà
__ılu¥lus


89 
as_şu¡”_s
;

180 
	s«ro¥ike_s
 {

186 
boŞ
 
_ä“
;

192 
as_şu¡”_s
 * 
şu¡”
;

197 
as_cÚfig
 
cÚfig
;

199 } 
	t«ro¥ike
;

231 
«ro¥ike
*

232 
«ro¥ike_š™
(
«ro¥ike
* 
as
, 
as_cÚfig
* 
cÚfig
);

255 
«ro¥ike
*

256 
«ro¥ike_Ãw
(
as_cÚfig
* 
cÚfig
);

264 
«ro¥ike_š™_lua
(
as_cÚfig_lua
* 
cÚfig
);

278 
«ro¥ike_de¡roy
(
«ro¥ike
* 
as
);

299 
as_¡©us


300 
«ro¥ike_cÚÃù
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
);

316 
as_¡©us


317 
«ro¥ike_şo£
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
);

332 
boŞ


333 
«ro¥ike_şu¡”_is_cÚÃùed
(
«ro¥ike
* 
as
);

344 
boŞ


345 
«ro¥ike_has_p–ššg
(
«ro¥ike
* 
as
);

354 
«ro¥ike_¡İ_Ú_š‹¼u±
(
boŞ
 
¡İ
);

377 
as_¡©us


378 
«ro¥ike_Œunÿ‹
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, 
as_pŞicy_šfo
* 
pŞicy
, cÚ¡ * 
ns
, cÚ¡ * 
£t
, 
ušt64_t
 
befÜe_Çnos
);

390 
as_¡©us


391 
«ro¥ike_»lßd_s_cÚfig
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
);

393 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_batch.h

17 #´agm¨
Úû


30 
	~<«ro¥ike/«ro¥ike.h
>

31 
	~<«ro¥ike/as_b©ch.h
>

32 
	~<«ro¥ike/as_li¡’”.h
>

33 
	~<«ro¥ike/as_”rÜ.h
>

34 
	~<«ro¥ike/as_key.h
>

35 
	~<«ro¥ike/as_li¡.h
>

36 
	~<«ro¥ike/as_İ”©iÚs.h
>

37 
	~<«ro¥ike/as_pŞicy.h
>

38 
	~<«ro¥ike/as_»cÜd.h
>

39 
	~<«ro¥ike/as_¡©us.h
>

40 
	~<«ro¥ike/as_v®.h
>

41 
	~<«ro¥ike/as_veùÜ.h
>

43 #ifdeà
__ılu¥lus


55 
	sas_b©ch_»ad_»cÜd_s
 {

59 
as_key
 
key
;

64 ** 
bš_Çmes
;

69 
ušt32_t
 
n_bš_Çmes
;

76 
boŞ
 
»ad_®l_bšs
;

94 
as_¡©us
 
»suÉ
;

100 
as_»cÜd
 
»cÜd
;

101 } 
	tas_b©ch_»ad_»cÜd
;

106 
	sas_b©ch_»ad_»cÜds_s
 {

110 
as_veùÜ
 
li¡
;

111 } 
	tas_b©ch_»ad_»cÜds
;

135 
boŞ
 (*
	t«ro¥ike_b©ch_»ad_ÿÎback
)(cÚ¡ 
	tas_b©ch_»ad
* 
	t»suÉs
, 
	tušt32_t
 
	tn
, * 
	tud©a
);

142 
boŞ
 (*
	tas_b©ch_ÿÎback_xdr
)(
	tas_key
* 
	tkey
, 
	tas_»cÜd
* 
	t»cÜd
, * 
	tud©a
);

157 (*
as_async_b©ch_li¡’”
)(
	tas_”rÜ
* 
	t”r
, 
	tas_b©ch_»ad_»cÜds
* 
	t»cÜds
, * 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

175 
	#as_b©ch_»ad_š™a
(
__»cÜds
, 
__ÿ·c™y
) \

176 
	`as_veùÜ_š™a
(&((
__»cÜds
)->
li¡
), (
as_b©ch_»ad_»cÜd
), 
__ÿ·c™y
);

	)

190 
šlše
 

191 
as_b©ch_»ad_š™
(
as_b©ch_»ad_»cÜds
* 
»cÜds
, 
ušt32_t
 
ÿ·c™y
)

193 
as_veùÜ_š™
(&
»cÜds
->
li¡
, (
as_b©ch_»ad_»cÜd
), 
ÿ·c™y
);

208 
šlše
 
as_b©ch_»ad_»cÜds
*

209 
as_b©ch_»ad_ü—‹
(
ušt32_t
 
ÿ·c™y
)

211  (
as_b©ch_»ad_»cÜds
*è
as_veùÜ_ü—‹
((
as_b©ch_»ad_»cÜd
), 
ÿ·c™y
);

223 
šlše
 
as_b©ch_»ad_»cÜd
*

224 
as_b©ch_»ad_»£rve
(
as_b©ch_»ad_»cÜds
* 
»cÜds
)

226  (
as_b©ch_»ad_»cÜd
*)
as_veùÜ_»£rve
(&
»cÜds
->
li¡
);

239 
as_b©ch_»ad_de¡roy
(
as_b©ch_»ad_»cÜds
* 
»cÜds
);

245 
boŞ


246 
«ro¥ike_has_b©ch_šdex
(
«ro¥ike
* 
as
);

288 
as_¡©us


289 
«ro¥ike_b©ch_»ad
(

290 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_b©ch
* 
pŞicy
, 
as_b©ch_»ad_»cÜds
* 
»cÜds


356 
as_¡©us


357 
«ro¥ike_b©ch_»ad_async
(

358 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_b©ch
* 
pŞicy
, 
as_b©ch_»ad_»cÜds
* 
»cÜds
,

359 
as_async_b©ch_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ


391 
as_¡©us


392 
«ro¥ike_b©ch_g‘
(

393 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_b©ch
 * 
pŞicy
, cÚ¡ 
as_b©ch
 * 
b©ch
,

394 
«ro¥ike_b©ch_»ad_ÿÎback
 
ÿÎback
, * 
ud©a


402 
as_¡©us


403 
«ro¥ike_b©ch_g‘_xdr
(

404 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_b©ch
* 
pŞicy
, cÚ¡ 
as_b©ch
* 
b©ch
,

405 
as_b©ch_ÿÎback_xdr
 
ÿÎback
, * 
ud©a


441 
as_¡©us


442 
«ro¥ike_b©ch_g‘_bšs
(

443 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_b©ch
* 
pŞicy
, cÚ¡ 
as_b©ch
* 
b©ch
,

444 cÚ¡ ** 
bšs
, 
ušt32_t
 
n_bšs
, 
«ro¥ike_b©ch_»ad_ÿÎback
 
ÿÎback
, * 
ud©a


476 
as_¡©us


477 
«ro¥ike_b©ch_exi¡s
(

478 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_b©ch
 * 
pŞicy
, cÚ¡ 
as_b©ch
 * 
b©ch
,

479 
«ro¥ike_b©ch_»ad_ÿÎback
 
ÿÎback
, * 
ud©a


482 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_index.h

17 #´agm¨
Úû


43 
	~<«ro¥ike/«ro¥ike.h
>

44 
	~<«ro¥ike/as_bš.h
>

45 
	~<«ro¥ike/as_”rÜ.h
>

46 
	~<«ro¥ike/as_key.h
>

47 
	~<«ro¥ike/as_pŞicy.h
>

48 
	~<«ro¥ike/as_¡©us.h
>

50 #ifdeà
__ılu¥lus


57 
	#AS_INDEX_POSITION_MAX_SZ
 256

	)

59 
	tas_šdex_pos™iÚ
[
AS_INDEX_POSITION_MAX_SZ
];

66 
	eas_šdex_ty³_s
 {

67 
AS_INDEX_TYPE_DEFAULT
,

68 
AS_INDEX_TYPE_LIST
,

69 
AS_INDEX_TYPE_MAPKEYS
,

70 
AS_INDEX_TYPE_MAPVALUES


71 } 
	tas_šdex_ty³
;

76 
	eas_šdex_d©©y³_s
 {

77 
AS_INDEX_STRING
,

78 
AS_INDEX_NUMERIC
,

79 
AS_INDEX_GEO2DSPHERE


80 } 
	tas_šdex_d©©y³
;

89 
	sas_šdex_sk_s
 {

93 
«ro¥ike
 * 
as
;

98 
as_Çme¥aû
 
ns
;

103 
Çme
[64];

108 
boŞ
 
dÚe
;

109 } 
	tas_šdex_sk
;

145 
as_¡©us
 
«ro¥ike_šdex_ü—‹_com¶ex
(

146 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, 
as_šdex_sk
 * 
sk
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

147 cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_šdex_pos™iÚ
 
pos™iÚ
, cÚ¡ * 
Çme
,

148 
as_šdex_ty³
 
™y³
, 
as_šdex_d©©y³
 
dty³
);

178 
šlše
 
as_¡©us
 
«ro¥ike_šdex_ü—‹
(

179 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, 
as_šdex_sk
 * 
sk
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

180 cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_bš_Çme
 
bš
, cÚ¡ * 
Çme
,

181 
as_šdex_d©©y³
 
dty³
)

183  
«ro¥ike_šdex_ü—‹_com¶ex
(
as
, 
”r
, 
sk
, 
pŞicy
, 
ns
, 
£t
, 
bš
, 
Çme
, 
AS_INDEX_TYPE_DEFAULT
, 
dty³
);

197 
as_¡©us
 
«ro¥ike_šdex_ü—‹_wa™
(
as_”rÜ
 * 
”r
, 
as_šdex_sk
 * 
sk
, 
ušt32_t
 
š‹rv®_ms
);

218 
as_¡©us
 
«ro¥ike_šdex_»move
(

219 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

220 cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ * 
Çme
);

233 
šlše
 
as_¡©us
 
«ro¥ike_šdex_š‹g”_ü—‹
(

234 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

235 cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_bš_Çme
 
bš
, cÚ¡ * 
Çme
)

237  
«ro¥ike_šdex_ü—‹_com¶ex
(
as
, 
”r
, 0, 
pŞicy
, 
ns
, 
£t
, 
bš
, 
Çme
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_NUMERIC
);

247 
šlše
 
as_¡©us
 
«ro¥ike_šdex_¡ršg_ü—‹
(

248 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

249 cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_bš_Çme
 
bš
, cÚ¡ * 
Çme
)

251  
«ro¥ike_šdex_ü—‹_com¶ex
(
as
, 
”r
, 0, 
pŞicy
, 
ns
, 
£t
, 
bš
, 
Çme
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_STRING
);

254 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_info.h

17 #´agm¨
Úû


27 
	~<«ro¥ike/«ro¥ike.h
>

28 
	~<«ro¥ike/«ro¥ike_sÿn.h
>

29 
	~<«ro¥ike/as_”rÜ.h
>

30 
	~<«ro¥ike/as_node.h
>

31 
	~<«ro¥ike/as_pŞicy.h
>

32 
	~<«ro¥ike/as_¡©us.h
>

34 #ifdeà
__ılu¥lus


55 
boŞ
 (*
	t«ro¥ike_šfo_fÜ—ch_ÿÎback
)(cÚ¡ 
	tas_”rÜ
* 
	t”r
, cÚ¡ 
	tas_node
* 
	tnode
, cÚ¡ * 
	t»q
, * 
	t»s
, * 
	tud©a
);

87 
as_¡©us


88 
«ro¥ike_šfo_node
(

89 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, 
as_node
* 
node
,

90 cÚ¡ * 
»q
, ** 
»s


125 
as_¡©us


126 
«ro¥ike_šfo_ho¡
(

127 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, cÚ¡ * 
ho¡Çme
, 
ušt16_t
 
pÜt
,

128 cÚ¡ * 
»q
, ** 
»s


159 
as_¡©us


160 
«ro¥ike_šfo_sock‘_add»ss
(

161 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, 
sockaddr_š
* 
§_š
,

162 cÚ¡ * 
»q
, ** 
»s


193 
as_¡©us


194 
«ro¥ike_šfo_ªy
(

195 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, cÚ¡ * 
»q
, ** 
»s


227 
as_¡©us


228 
«ro¥ike_šfo_fÜ—ch
(

229 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, cÚ¡ * 
»q
,

230 
«ro¥ike_šfo_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a


233 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_key.h

17 #´agm¨
Úû


31 
	~<«ro¥ike/«ro¥ike.h
>

32 
	~<«ro¥ike/as_li¡’”.h
>

33 
	~<«ro¥ike/as_”rÜ.h
>

34 
	~<«ro¥ike/as_key.h
>

35 
	~<«ro¥ike/as_li¡.h
>

36 
	~<«ro¥ike/as_İ”©iÚs.h
>

37 
	~<«ro¥ike/as_pŞicy.h
>

38 
	~<«ro¥ike/as_»cÜd.h
>

39 
	~<«ro¥ike/as_¡©us.h
>

40 
	~<«ro¥ike/as_v®.h
>

42 #ifdeà
__ılu¥lus


76 
as_¡©us


77 
«ro¥ike_key_g‘
(

78 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»ad
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, 
as_»cÜd
** 
»c


116 
as_¡©us


117 
«ro¥ike_key_g‘_async
(

118 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»ad
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

119 
as_async_»cÜd_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

120 
as_pe_li¡’”
 
pe_li¡’”


152 
as_¡©us


153 
«ro¥ike_key_£Ëù
(

154 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»ad
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

155 cÚ¡ * 
bšs
[], 
as_»cÜd
** 
»c


196 
as_¡©us


197 
«ro¥ike_key_£Ëù_async
(

198 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»ad
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, cÚ¡ * 
bšs
[],

199 
as_async_»cÜd_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
, 
as_pe_li¡’”
 
pe_li¡’”


235 
as_¡©us


236 
«ro¥ike_key_exi¡s
(

237 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»ad
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, 
as_»cÜd
** 
»c


281 
as_¡©us


282 
«ro¥ike_key_exi¡s_async
(

283 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»ad
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

284 
as_async_»cÜd_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

285 
as_pe_li¡’”
 
pe_li¡’”


316 
as_¡©us


317 
«ro¥ike_key_put
(

318 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_wr™e
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, 
as_»cÜd
* 
»c


362 
as_¡©us


363 
«ro¥ike_key_put_async
(

364 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_wr™e
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, 
as_»cÜd
* 
»c
,

365 
as_async_wr™e_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
, 
as_pe_li¡’”
 
pe_li¡’”


389 
as_¡©us


390 
«ro¥ike_key_»move
(

391 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»move
* 
pŞicy
, cÚ¡ 
as_key
* 
key


428 
as_¡©us


429 
«ro¥ike_key_»move_async
(

430 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»move
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

431 
as_async_wr™e_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

432 
as_pe_li¡’”
 
pe_li¡’”


470 
as_¡©us


471 
«ro¥ike_key_İ”©e
(

472 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_İ”©e
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

473 cÚ¡ 
as_İ”©iÚs
* 
İs
, 
as_»cÜd
** 
»c


519 
as_¡©us


520 
«ro¥ike_key_İ”©e_async
(

521 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_İ”©e
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, cÚ¡ 
as_İ”©iÚs
* 
İs
,

522 
as_async_»cÜd_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
, 
as_pe_li¡’”
 
pe_li¡’”


563 
as_¡©us
 
«ro¥ike_key_­¶y
(

564 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_­¶y
 * 
pŞicy
,

565 cÚ¡ 
as_key
 * 
key
,

566 cÚ¡ * 
moduË
, cÚ¡ * 
funùiÚ
, 
as_li¡
 * 
¬gli¡
,

567 
as_v®
 ** 
»suÉ


615 
as_¡©us


616 
«ro¥ike_key_­¶y_async
(

617 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_­¶y
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

618 cÚ¡ * 
moduË
, cÚ¡ * 
funùiÚ
, 
as_li¡
* 
¬gli¡
,

619 
as_async_v®ue_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

620 
as_pe_li¡’”
 
pe_li¡’”


627 
boŞ


628 
«ro¥ike_has_doubË
(
«ro¥ike
* 
as
);

634 
boŞ


635 
«ro¥ike_has_geo
(
«ro¥ike
* 
as
);

641 
as_¡©us


642 
«ro¥ike_key_put_async_ex
(

643 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_wr™e
* 
pŞicy
, cÚ¡ 
as_key
* 
key
, 
as_»cÜd
* 
»c
,

644 
as_async_wr™e_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
, 
as_pe_li¡’”
 
pe_li¡’”
,

645 
size_t
* 
Ëngth
, size_t* 
comp_Ëngth


648 
as_¡©us


649 
«ro¥ike_key_»move_async_ex
(

650 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_»move
* 
pŞicy
, cÚ¡ 
as_key
* 
key
,

651 
as_async_wr™e_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

652 
as_pe_li¡’”
 
pe_li¡’”
, 
size_t
* 
Ëngth


658 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_query.h

17 #´agm¨
Úû


89 
	~<«ro¥ike/«ro¥ike.h
>

90 
	~<«ro¥ike/as_”rÜ.h
>

91 
	~<«ro¥ike/as_ev’t.h
>

92 
	~<«ro¥ike/as_job.h
>

93 
	~<«ro¥ike/as_pŞicy.h
>

94 
	~<«ro¥ike/as_qu”y.h
>

95 
	~<«ro¥ike/as_»cÜd.h
>

96 
	~<«ro¥ike/as_¡©us.h
>

97 
	~<«ro¥ike/as_¡»am.h
>

99 #ifdeà
__ılu¥lus


127 
boŞ
 (*
	t«ro¥ike_qu”y_fÜ—ch_ÿÎback
)(cÚ¡ 
	tas_v®
* 
	tv®
, * 
	tud©a
);

145 
boŞ
 (*
	tas_async_qu”y_»cÜd_li¡’”
)(
	tas_”rÜ
* 
	t”r
, 
	tas_»cÜd
* 
	t»cÜd
, * 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

180 
as_¡©us


181 
«ro¥ike_qu”y_fÜ—ch
(

182 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_qu”y
* 
pŞicy
, cÚ¡ 
as_qu”y
* 
qu”y
,

183 
«ro¥ike_qu”y_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a


232 
as_¡©us


233 
«ro¥ike_qu”y_async
(

234 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_qu”y
* 
pŞicy
, cÚ¡ 
as_qu”y
* 
qu”y
,

235 
as_async_qu”y_»cÜd_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ


272 
as_¡©us


273 
«ro¥ike_qu”y_background
(

274 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_wr™e
* 
pŞicy
,

275 cÚ¡ 
as_qu”y
* 
qu”y
, 
ušt64_t
* 
qu”y_id


292 
šlše
 
as_¡©us


293 
«ro¥ike_qu”y_wa™
(

294 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
,

295 cÚ¡ 
as_qu”y
* 
qu”y
, 
ušt64_t
 
qu”y_id
, 
ušt32_t
 
š‹rv®_ms


298 cÚ¡ * 
moduË
 = (
qu”y
->
wh”e
.
size
 > 0)? "query" : "scan";

299  
«ro¥ike_job_wa™
(
as
, 
”r
, 
pŞicy
, 
moduË
, 
qu”y_id
, 
š‹rv®_ms
);

316 
šlše
 
as_¡©us


317 
«ro¥ike_qu”y_šfo
(

318 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
,

319 cÚ¡ 
as_qu”y
* 
qu”y
, 
ušt64_t
 
qu”y_id
, 
as_job_šfo
* 
šfo


322 cÚ¡ * 
moduË
 = (
qu”y
->
wh”e
.
size
 > 0)? "query" : "scan";

323  
«ro¥ike_job_šfo
(
as
, 
”r
, 
pŞicy
, 
moduË
, 
qu”y_id
, 
çl£
, 
šfo
);

326 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_scan.h

17 #´agm¨
Úû


95 
	~<«ro¥ike/«ro¥ike.h
>

96 
	~<«ro¥ike/as_li¡’”.h
>

97 
	~<«ro¥ike/as_”rÜ.h
>

98 
	~<«ro¥ike/as_pŞicy.h
>

99 
	~<«ro¥ike/as_»cÜd.h
>

100 
	~<«ro¥ike/as_sÿn.h
>

101 
	~<«ro¥ike/as_¡©us.h
>

102 
	~<«ro¥ike/as_v®.h
>

104 #ifdeà
__ılu¥lus


134 
boŞ
 (*
	t«ro¥ike_sÿn_fÜ—ch_ÿÎback
)(cÚ¡ 
	tas_v®
* 
	tv®
, * 
	tud©a
);

152 
boŞ
 (*
	tas_async_sÿn_li¡’”
)(
	tas_”rÜ
* 
	t”r
, 
	tas_»cÜd
* 
	t»cÜd
, * 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

192 
as_¡©us


193 
«ro¥ike_sÿn_background
(

194 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_sÿn
* 
pŞicy
, cÚ¡ 
as_sÿn
* 
sÿn
,

195 
ušt64_t
* 
sÿn_id


214 
as_¡©us


215 
«ro¥ike_sÿn_wa™
(

216 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, 
ušt64_t
 
sÿn_id
,

217 
ušt32_t
 
š‹rv®_ms


246 
as_¡©us


247 
«ro¥ike_sÿn_šfo
(

248 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, 
ušt64_t
 
sÿn_id
, 
as_sÿn_šfo
* 
šfo


281 
as_¡©us


282 
«ro¥ike_sÿn_fÜ—ch
(

283 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_sÿn
* 
pŞicy
, cÚ¡ 
as_sÿn
* 
sÿn
,

284 
«ro¥ike_sÿn_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a


324 
as_¡©us


325 
«ro¥ike_sÿn_node
(

326 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_sÿn
* 
pŞicy
, cÚ¡ 
as_sÿn
* 
sÿn
,

327 cÚ¡ * 
node_Çme
, 
«ro¥ike_sÿn_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a


377 
as_¡©us


378 
«ro¥ike_sÿn_async
(

379 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_sÿn
* 
pŞicy
, cÚ¡ 
as_sÿn
* 
sÿn
, 
ušt64_t
* 
sÿn_id
,

380 
as_async_sÿn_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ


437 
as_¡©us


438 
«ro¥ike_sÿn_node_async
(

439 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_sÿn
* 
pŞicy
, cÚ¡ 
as_sÿn
* 
sÿn
, 
ušt64_t
* 
sÿn_id
,

440 cÚ¡ * 
node_Çme
, 
as_async_sÿn_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ


443 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/aerospike_udf.h

17 #´agm¨
Úû


33 
	~<«ro¥ike/«ro¥ike.h
>

34 
	~<«ro¥ike/as_”rÜ.h
>

35 
	~<«ro¥ike/as_pŞicy.h
>

36 
	~<«ro¥ike/as_¡©us.h
>

37 
	~<«ro¥ike/as_udf.h
>

39 #ifdeà
__ılu¥lus


78 
as_¡©us
 
«ro¥ike_udf_li¡
(

79 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

80 
as_udf_fes
 * 
fes


116 
as_¡©us
 
«ro¥ike_udf_g‘
(

117 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

118 cÚ¡ * 
f’ame
, 
as_udf_ty³
 
ty³
, 
as_udf_fe
 * 
fe


149 
as_¡©us
 
«ro¥ike_udf_put
(

150 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

151 cÚ¡ * 
f’ame
, 
as_udf_ty³
 
ty³
, 
as_by‹s
 * 
cÚ‹Á


177 
as_¡©us
 
«ro¥ike_udf_put_wa™
(

178 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

179 cÚ¡ * 
f’ame
, 
ušt32_t
 
š‹rv®_ms
);

200 
as_¡©us
 
«ro¥ike_udf_»move
(

201 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
, cÚ¡ * 
f’ame


223 
as_¡©us
 
«ro¥ike_udf_»move_wa™
(

224 
«ro¥ike
 * 
as
, 
as_”rÜ
 * 
”r
, cÚ¡ 
as_pŞicy_šfo
 * 
pŞicy
,

225 cÚ¡ * 
f’ame
, 
ušt32_t
 
š‹rv®_ms
);

227 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_address.h

17 #´agm¨
Úû


19 
	~<c™ru¦—f/cf_by‹_Üd”.h
>

20 
	~<Ãtš‘/š.h
>

21 
	~<¡ršg.h
>

22 
	~<sys/sock‘.h
>

24 #ifdeà
__ılu¥lus


39 
as_add»ss_Çme
(
sockaddr
* 
addr
, * 
Çme
, 
sockËn_t
 
size
);

52 
as_add»ss_shÜt_Çme
(
sockaddr
* 
addr
, * 
Çme
, 
sockËn_t
 
size
);

58 
šlše
 
š_pÜt_t


59 
as_add»ss_pÜt
(
sockaddr
* 
addr
)

61 
š_pÜt_t
 
pÜt
 = (
addr
->
§_çmy
 =ğ
AF_INET
)?

62 ((
sockaddr_š
*)
addr
)->
sš_pÜt
 :

63 ((
sockaddr_š6
*)
addr
)->
sš6_pÜt
;

64  
cf_sw­_äom_be16
(
pÜt
);

71 
šlše
 
sockËn_t


72 
as_add»ss_size
(
sockaddr
* 
addr
)

74  (
addr
->
§_çmy
 =ğ
AF_INET
)? (
sockaddr_š
è: (
sockaddr_š6
);

81 
šlše
 

82 
as_add»ss_cİy_¡Üage
(
sockaddr
* 
¤c
, 
sockaddr_¡Üage
* 
Œg
)

84 
size_t
 
size
 = 
as_add»ss_size
(
¤c
);

85 
memıy
(
Œg
, 
¤c
, 
size
);

88 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_admin.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/«ro¥ike.h
>

20 
	~<«ro¥ike/as_cÚfig.h
>

21 
	~<«ro¥ike/as_key.h
>

22 
	~<«ro¥ike/as_sock‘.h
>

24 #ifdeà
__ılu¥lus


35 
	#AS_ROLE_SIZE
 32

	)

44 
	eas_´ivege_code_e
 {

48 
AS_PRIVILEGE_USER_ADMIN
 = 0,

55 
AS_PRIVILEGE_SYS_ADMIN
 = 1,

62 
AS_PRIVILEGE_DATA_ADMIN
 = 2,

67 
AS_PRIVILEGE_READ
 = 10,

72 
AS_PRIVILEGE_READ_WRITE
 = 11,

77 
AS_PRIVILEGE_READ_WRITE_UDF
 = 12

78 } 
	tas_´ivege_code
;

83 
	sas_´ivege_s
 {

88 
as_Çme¥aû
 
ns
;

94 
as_£t
 
£t
;

99 
as_´ivege_code
 
code
;

100 } 
	tas_´ivege
;

105 
	sas_rŞe_s
 {

109 
Çme
[
AS_ROLE_SIZE
];

114 
´iveges_size
;

119 
as_´ivege
 
´iveges
[];

120 } 
	tas_rŞe
;

125 
	sas_u£r_s
 {

129 
Çme
[
AS_USER_SIZE
];

134 
rŞes_size
;

139 
rŞes
[][
AS_ROLE_SIZE
];

140 } 
	tas_u£r
;

142 
as_node_s
;

152 
as_¡©us


153 
«ro¥ike_ü—‹_u£r
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
, cÚ¡ * 
·sswÜd
, cÚ¡ ** 
rŞes
, 
rŞes_size
);

158 
as_¡©us


159 
«ro¥ike_drİ_u£r
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
);

164 
as_¡©us


165 
«ro¥ike_£t_·sswÜd
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
, cÚ¡ * 
·sswÜd
);

170 
as_¡©us


171 
«ro¥ike_chªge_·sswÜd
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
, cÚ¡ * 
·sswÜd
);

176 
as_¡©us


177 
«ro¥ike_g¿Á_rŞes
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
, cÚ¡ ** 
rŞes
, 
rŞes_size
);

182 
as_¡©us


183 
«ro¥ike_»voke_rŞes
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
, cÚ¡ ** 
rŞes
, 
rŞes_size
);

188 
as_¡©us


189 
«ro¥ike_ü—‹_rŞe
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
rŞe
, 
as_´ivege
** 
´iveges
, 
´iveges_size
);

194 
as_¡©us


195 
«ro¥ike_drİ_rŞe
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
rŞe
);

200 
as_¡©us


201 
«ro¥ike_g¿Á_´iveges
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
rŞe
, 
as_´ivege
** 
´iveges
, 
´iveges_size
);

206 
as_¡©us


207 
«ro¥ike_»voke_´iveges
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
rŞe
, 
as_´ivege
** 
´iveges
, 
´iveges_size
);

213 
as_¡©us


214 
«ro¥ike_qu”y_u£r
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
u£r_Çme
, 
as_u£r
** 
u£r
);

220 
as_u£r_de¡roy
(
as_u£r
* 
u£r
);

226 
as_¡©us


227 
«ro¥ike_qu”y_u£rs
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, 
as_u£r
*** 
u£rs
, * 
u£rs_size
);

233 
as_u£rs_de¡roy
(
as_u£r
** 
u£rs
, 
u£rs_size
);

239 
as_¡©us


240 
«ro¥ike_qu”y_rŞe
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, cÚ¡ * 
rŞe_Çme
, 
as_rŞe
** 
rŞe
);

246 
as_rŞe_de¡roy
(
as_rŞe
* 
rŞe
);

252 
as_¡©us


253 
«ro¥ike_qu”y_rŞes
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_admš
* 
pŞicy
, 
as_rŞe
*** 
rŞes
, * 
rŞes_size
);

259 
as_rŞes_de¡roy
(
as_rŞe
** 
rŞes
, 
rŞes_size
);

266 
as_¡©us


267 
as_auth’tiÿ‹
(
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node_s
* 
node
, cÚ¡ * 
u£r
, cÚ¡ * 
üed’tŸl
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše_ms
);

273 
ušt32_t


274 
as_auth’tiÿ‹_£t
(cÚ¡ * 
u£r
, cÚ¡ * 
üed’tŸl
, 
ušt8_t
* 
bufãr
);

276 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_aerospike.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_ut.h
>

20 
	~<«ro¥ike/as_ty³s.h
>

21 
	~<c™ru¦—f/cf_şock.h
>

23 #ifdeà
__ılu¥lus


31 
as_«ro¥ike_s
 
	tas_«ro¥ike
;

32 
as_«ro¥ike_hooks_s
 
	tas_«ro¥ike_hooks
;

34 
	sas_«ro¥ike_s
 {

35 
boŞ
 
is_rÿÎoc
;

36 * 
sourû
;

37 cÚ¡ 
as_«ro¥ike_hooks
 * 
hooks
;

40 
	sas_«ro¥ike_hooks_s
 {

41 (* 
de¡roy
)(
as_«ro¥ike
 *);

43 (* 
»c_ü—‹
)(cÚ¡ 
as_«ro¥ike
 *, cÚ¡ 
as_»c
 *);

44 (* 
»c_upd©e
)(cÚ¡ 
as_«ro¥ike
 *, cÚ¡ 
as_»c
 *);

45 (* 
»c_»move
)(cÚ¡ 
as_«ro¥ike
 *, cÚ¡ 
as_»c
 *);

46 (* 
»c_exi¡s
)(cÚ¡ 
as_«ro¥ike
 *, cÚ¡ 
as_»c
 *);

48 (*
log
)(cÚ¡ 
as_«ro¥ike
 *, const *, const , const , const *);

49 
cf_şock
 (* 
g‘_cu¼’t_time
)ĞcÚ¡ 
as_«ro¥ike
 * );

50 (*
£t_cÚ‹xt
èĞcÚ¡ 
as_«ro¥ike
 *, cÚ¡ 
as_»c
 *, cÚ¡ 
ušt32_t
 
cÚ‹xt
 );

51 (*
g‘_cÚfig
èĞcÚ¡ 
as_«ro¥ike
 *, cÚ¡ 
as_»c
 *, const * );

58 
as_«ro¥ike
 * 
as_«ro¥ike_š™
×s_«ro¥ik*
a
, *
sourû
, cÚ¡ 
as_«ro¥ike_hooks
 *
hooks
);

60 
as_«ro¥ike
 * 
as_«ro¥ike_Ãw
(*
sourû
, cÚ¡ 
as_«ro¥ike_hooks
 *
hooks
);

62 
as_«ro¥ike_de¡roy
(
as_«ro¥ike
 *);

68 
šlše
 
as_«ro¥ike_»c_ü—‹
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ 
as_»c
 * 
r
)

70  
as_ut_hook
(
»c_ü—‹
, 1, 
a
, 
r
);

73 
šlše
 
as_«ro¥ike_»c_upd©e
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ 
as_»c
 * 
r
)

75  
as_ut_hook
(
»c_upd©e
, 1, 
a
, 
r
);

78 
šlše
 
as_«ro¥ike_»c_exi¡s
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ 
as_»c
 * 
r
)

80  
as_ut_hook
(
»c_exi¡s
, 1, 
a
, 
r
);

83 
šlše
 
as_«ro¥ike_»c_»move
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ 
as_»c
 * 
r
)

85  
as_ut_hook
(
»c_»move
, 1, 
a
, 
r
);

88 
šlše
 
as_«ro¥ike_log
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ * 
Çme
, cÚ¡ 
lše
, cÚ¡ 
lvl
, cÚ¡ * 
msg
)

90  
as_ut_hook
(
log
, 1, 
a
, 
Çme
, 
lše
, 
lvl
, 
msg
);

93 
šlše
 
cf_şock
 
as_«ro¥ike_g‘_cu¼’t_time
(cÚ¡ 
as_«ro¥ike
 * 
a
 )

95  
as_ut_hook
(
g‘_cu¼’t_time
, 0, 
a
);

98 
šlše
 
as_«ro¥ike_£t_cÚ‹xt
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ 
as_»c
 *
r
, cÚ¡ 
ušt32_t
 
cÚ‹xt
 )

100  
as_ut_hook
(
£t_cÚ‹xt
, 2, 
a
, 
r
, 
cÚ‹xt
);

103 
šlše
 
as_«ro¥ike_g‘_cÚfig
(cÚ¡ 
as_«ro¥ike
 * 
a
, cÚ¡ 
as_»c
 *
r
, cÚ¡ *
Çme
)

105  
as_ut_hook
(
g‘_cÚfig
, 0, 
a
, 
r
, 
Çme
);

108 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_arraylist.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_by‹s.h
>

21 
	~<«ro¥ike/as_doubË.h
>

22 
	~<«ro¥ike/as_š‹g”.h
>

23 
	~<«ro¥ike/as_li¡.h
>

24 
	~<«ro¥ike/as_m­.h
>

25 
	~<«ro¥ike/as_¡ršg.h
>

26 
	~<«ro¥ike/as_v®.h
>

28 
	~<¡dboŞ.h
>

29 
	~<¡dšt.h
>

31 #ifdeà
__ılu¥lus


99 
	sas_¬¿yli¡_s
 {

106 
as_li¡
 
_
;

112 
ušt32_t
 
block_size
;

117 
ušt32_t
 
ÿ·c™y
;

122 
ušt32_t
 
size
;

127 
as_v®
 ** 
–em’ts
;

133 
boŞ
 
ä“
;

135 } 
	tas_¬¿yli¡
;

140 
	eas_¬¿yli¡_¡©us_e
 {

145 
AS_ARRAYLIST_OK
 = 0,

150 
AS_ARRAYLIST_ERR_ALLOC
 = 1,

155 
AS_ARRAYLIST_ERR_MAX
 = 2,

160 
AS_ARRAYLIST_ERR_INDEX
 = 3

162 } 
	tas_¬¿yli¡_¡©us
;

181 
	#as_¬¿yli¡_š™a
(
__li¡
, 
__n
)\

182 
	`as_¬¿yli¡_š™
((
__li¡
), 0, 0);\

183 (
__li¡
)->
ä“
 = 
çl£
;\

184 (
__li¡
)->
ÿ·c™y
 = (
__n
);\

185 (
__li¡
)->
size
 = 0;\

186 (
__li¡
)->
–em’ts
 = (
as_v®
**è
	`®loÿ
(×s_v®*è* (
__n
));

	)

207 
as_¬¿yli¡
 * 
as_¬¿yli¡_š™
×s_¬¿yli¡ * 
li¡
, 
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
block_size
);

219 
as_¬¿yli¡
 * 
as_¬¿yli¡_Ãw
(
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
block_size
);

227 
as_¬¿yli¡_de¡roy
(
as_¬¿yli¡
 * 
li¡
);

241 
ušt32_t
 
as_¬¿yli¡_hashcode
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
);

251 
ušt32_t
 
as_¬¿yli¡_size
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
);

267 
as_¬¿yli¡_cÚÿt
(
as_¬¿yli¡
 * 
li¡
, cÚ¡‡s_¬¿yli¡ * 
li¡2
);

279 
as_¬¿yli¡_Œim
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
);

289 
as_v®
 * 
as_¬¿yli¡_h—d
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
);

299 
as_¬¿yli¡
 * 
as_¬¿yli¡_
(cÚ¡‡s_¬¿yli¡ * 
li¡
);

310 
as_¬¿yli¡
 * 
as_¬¿yli¡_drİ
(cÚ¡‡s_¬¿yli¡ * 
li¡
, 
ušt32_t
 
n
);

321 
as_¬¿yli¡
 * 
as_¬¿yli¡_ke
(cÚ¡‡s_¬¿yli¡ * 
li¡
, 
ušt32_t
 
n
);

336 
as_v®
 * 
as_¬¿yli¡_g‘
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
);

347 
št64_t
 
as_¬¿yli¡_g‘_št64
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
);

358 
as_¬¿yli¡_g‘_doubË
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
);

369 * 
as_¬¿yli¡_g‘_¡r
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
);

380 
šlše
 
as_š‹g”
 * 
as_¬¿yli¡_g‘_š‹g”
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
)

382  
as_š‹g”_äomv®
(
as_¬¿yli¡_g‘
(
li¡
, 
šdex
));

394 
šlše
 
as_doubË
* 
as_¬¿yli¡_g‘_as_doubË
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
)

396  
as_doubË_äomv®
(
as_¬¿yli¡_g‘
(
li¡
, 
šdex
));

408 
šlše
 
as_¡ršg
 * 
as_¬¿yli¡_g‘_¡ršg
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
)

410  
as_¡ršg_äomv®
(
as_¬¿yli¡_g‘
(
li¡
, 
šdex
));

422 
šlše
 
as_by‹s
 * 
as_¬¿yli¡_g‘_by‹s
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
)

424  
as_by‹s_äomv®
(
as_¬¿yli¡_g‘
(
li¡
, 
šdex
));

436 
šlše
 
as_li¡
 * 
as_¬¿yli¡_g‘_li¡
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
)

438  
as_li¡_äomv®
(
as_¬¿yli¡_g‘
(
li¡
, 
šdex
));

450 
šlše
 
as_m­
 * 
as_¬¿yli¡_g‘_m­
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
)

452  
as_m­_äomv®
(
as_¬¿yli¡_g‘
(
li¡
, 
šdex
));

475 
as_¬¿yli¡_£t
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_v®
 * 
v®ue
);

487 
as_¬¿yli¡_£t_št64
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
št64_t
 
v®ue
);

499 
as_¬¿yli¡_£t_doubË
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
v®ue
);

511 
as_¬¿yli¡_£t_¡r
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, cÚ¡ * 
v®ue
);

523 
šlše
 
as_¬¿yli¡_£t_š‹g”
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_š‹g”
 * 
v®ue
)

525  
as_¬¿yli¡_£t
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

538 
šlše
 
as_¬¿yli¡_£t_as_doubË
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_doubË
 * 
v®ue
)

540  
as_¬¿yli¡_£t
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

553 
šlše
 
as_¬¿yli¡_£t_¡ršg
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_¡ršg
 * 
v®ue
)

555  
as_¬¿yli¡_£t
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

568 
šlše
 
as_¬¿yli¡_£t_by‹s
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_by‹s
 * 
v®ue
)

570  
as_¬¿yli¡_£t
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

583 
šlše
 
as_¬¿yli¡_£t_li¡
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_li¡
 * 
v®ue
)

585  
as_¬¿yli¡_£t
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

598 
šlše
 
as_¬¿yli¡_£t_m­
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_m­
 * 
v®ue
)

600  
as_¬¿yli¡_£t
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

620 
as_¬¿yli¡_š£¹
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_v®
 * 
v®ue
);

632 
as_¬¿yli¡_š£¹_št64
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
št64_t
 
v®ue
);

644 
as_¬¿yli¡_š£¹_doubË
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
v®ue
);

656 
as_¬¿yli¡_š£¹_¡r
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, cÚ¡ * 
v®ue
);

668 
šlše
 
as_¬¿yli¡_š£¹_š‹g”
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_š‹g”
 * 
v®ue
)

670  
as_¬¿yli¡_š£¹
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

683 
šlše
 
as_¬¿yli¡_š£¹_as_doubË
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_doubË
 * 
v®ue
)

685  
as_¬¿yli¡_š£¹
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

698 
šlše
 
as_¬¿yli¡_š£¹_¡ršg
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_¡ršg
 * 
v®ue
)

700  
as_¬¿yli¡_š£¹
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

713 
šlše
 
as_¬¿yli¡_š£¹_by‹s
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_by‹s
 * 
v®ue
)

715  
as_¬¿yli¡_š£¹
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

728 
šlše
 
as_¬¿yli¡_š£¹_li¡
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_li¡
 * 
v®ue
)

730  
as_¬¿yli¡_š£¹
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

743 
šlše
 
as_¬¿yli¡_š£¹_m­
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_m­
 * 
v®ue
)

745  
as_¬¿yli¡_š£¹
(
li¡
, 
šdex
, (
as_v®
 *è
v®ue
);

761 
as_¬¿yli¡_­³nd
(
as_¬¿yli¡
 * 
li¡
, 
as_v®
 * 
v®ue
);

772 
as_¬¿yli¡_­³nd_št64
(
as_¬¿yli¡
 * 
li¡
, 
št64_t
 
v®ue
);

783 
as_¬¿yli¡_­³nd_doubË
(
as_¬¿yli¡
 * 
li¡
, 
v®ue
);

794 
as_¬¿yli¡_­³nd_¡r
(
as_¬¿yli¡
 * 
li¡
, cÚ¡ * 
v®ue
);

805 
šlše
 
as_¬¿yli¡_­³nd_š‹g”
(
as_¬¿yli¡
 * 
li¡
, 
as_š‹g”
 * 
v®ue
)

807  
as_¬¿yli¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

819 
šlše
 
as_¬¿yli¡_­³nd_as_doubË
(
as_¬¿yli¡
 * 
li¡
, 
as_doubË
 * 
v®ue
)

821  
as_¬¿yli¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

833 
šlše
 
as_¬¿yli¡_­³nd_¡ršg
(
as_¬¿yli¡
 * 
li¡
, 
as_¡ršg
 * 
v®ue
)

835  
as_¬¿yli¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

847 
šlše
 
as_¬¿yli¡_­³nd_by‹s
(
as_¬¿yli¡
 * 
li¡
, 
as_by‹s
 * 
v®ue
)

849  
as_¬¿yli¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

861 
šlše
 
as_¬¿yli¡_­³nd_li¡
(
as_¬¿yli¡
 * 
li¡
, 
as_li¡
 * 
v®ue
)

863  
as_¬¿yli¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

875 
šlše
 
as_¬¿yli¡_­³nd_m­
(
as_¬¿yli¡
 * 
li¡
, 
as_m­
 * 
v®ue
)

877  
as_¬¿yli¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

893 
as_¬¿yli¡_´•’d
(
as_¬¿yli¡
 * 
li¡
, 
as_v®
 * 
v®ue
);

904 
as_¬¿yli¡_´•’d_št64
(
as_¬¿yli¡
 * 
li¡
, 
št64_t
 
v®ue
);

915 
as_¬¿yli¡_´•’d_doubË
(
as_¬¿yli¡
 * 
li¡
, 
v®ue
);

926 
as_¬¿yli¡_´•’d_¡r
(
as_¬¿yli¡
 * 
li¡
, cÚ¡ * 
v®ue
);

937 
šlše
 
as_¬¿yli¡_´•’d_š‹g”
(
as_¬¿yli¡
 * 
li¡
, 
as_š‹g”
 * 
v®ue
)

939  
as_¬¿yli¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

951 
šlše
 
as_¬¿yli¡_´•’d_as_doubË
(
as_¬¿yli¡
 * 
li¡
, 
as_doubË
 * 
v®ue
)

953  
as_¬¿yli¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

965 
šlše
 
as_¬¿yli¡_´•’d_¡ršg
(
as_¬¿yli¡
 * 
li¡
, 
as_¡ršg
 * 
v®ue
)

967  
as_¬¿yli¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

979 
šlše
 
as_¬¿yli¡_´•’d_by‹s
(
as_¬¿yli¡
 * 
li¡
, 
as_by‹s
 * 
v®ue
)

981  
as_¬¿yli¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

993 
šlše
 
as_¬¿yli¡_´•’d_li¡
(
as_¬¿yli¡
 * 
li¡
, 
as_li¡
 * 
v®ue
)

995  
as_¬¿yli¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1007 
šlše
 
as_¬¿yli¡_´•’d_m­
(
as_¬¿yli¡
 * 
li¡
, 
as_m­
 * 
v®ue
)

1009  
as_¬¿yli¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1028 
as_¬¿yli¡_»move
(
as_¬¿yli¡
 * 
li¡
, 
ušt32_t
 
šdex
);

1045 
boŞ
 
as_¬¿yli¡_fÜ—ch
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
, 
as_li¡_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
);

1047 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_arraylist_iterator.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_¬¿yli¡.h
>

21 
	~<«ro¥ike/as_™”©Ü.h
>

23 
	~<¡dboŞ.h
>

24 
	~<¡dšt.h
>

26 #ifdeà
__ılu¥lus


90 
	sas_¬¿yli¡_™”©Ü_s
 {

96 
as_™”©Ü
 
_
;

101 cÚ¡ 
as_¬¿yli¡
 * 
li¡
;

106 
ušt32_t
 
pos
;

108 } 
	tas_¬¿yli¡_™”©Ü
;

124 
as_¬¿yli¡_™”©Ü
 * 
as_¬¿yli¡_™”©Ü_š™
×s_¬¿yli¡_™”©Ü * 
™”©Ü
, cÚ¡ 
as_¬¿yli¡
 * 
li¡
);

135 
as_¬¿yli¡_™”©Ü
 * 
as_¬¿yli¡_™”©Ü_Ãw
(cÚ¡ 
as_¬¿yli¡
 * 
li¡
);

144 
as_¬¿yli¡_™”©Ü_de¡roy
(
as_¬¿yli¡_™”©Ü
 * 
™”©Ü
);

159 
boŞ
 
as_¬¿yli¡_™”©Ü_has_Ãxt
(cÚ¡ 
as_¬¿yli¡_™”©Ü
 * 
™”©Ü
);

171 cÚ¡ 
as_v®
 * 
as_¬¿yli¡_™”©Ü_Ãxt
(
as_¬¿yli¡_™”©Ü
 * 
™”©Ü
);

173 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_async.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_async_´Ùo.h
>

20 
	~<«ro¥ike/as_şu¡”.h
>

21 
	~<«ro¥ike/as_ev’t_š‹º®.h
>

22 
	~<«ro¥ike/as_li¡’”.h
>

23 
	~<c™ru¦—f/®loc.h
>

25 #ifdeà
__ılu¥lus


33 
	#AS_ASYNC_TYPE_WRITE
 0

	)

34 
	#AS_ASYNC_TYPE_RECORD
 1

	)

35 
	#AS_ASYNC_TYPE_VALUE
 2

	)

36 
	#AS_ASYNC_TYPE_BATCH
 3

	)

37 
	#AS_ASYNC_TYPE_SCAN
 4

	)

38 
	#AS_ASYNC_TYPE_QUERY
 5

	)

40 
	#AS_AUTHENTICATION_MAX_SIZE
 158

	)

42 
	#AS_ASYNC_CONNECTION_COMPLETE
 0

	)

43 
	#AS_ASYNC_CONNECTION_PENDING
 1

	)

44 
	#AS_ASYNC_CONNECTION_ERROR
 2

	)

46 
	sas_async_wr™e_commªd
 {

47 
as_ev’t_commªd
 
commªd
;

48 
as_async_wr™e_li¡’”
 
li¡’”
;

49 
ušt8_t
 
¥aû
[];

50 } 
	tas_async_wr™e_commªd
;

52 
	sas_async_»cÜd_commªd
 {

53 
as_ev’t_commªd
 
commªd
;

54 
as_async_»cÜd_li¡’”
 
li¡’”
;

55 
ušt8_t
 
¥aû
[];

56 } 
	tas_async_»cÜd_commªd
;

58 
	sas_async_v®ue_commªd
 {

59 
as_ev’t_commªd
 
commªd
;

60 
as_async_v®ue_li¡’”
 
li¡’”
;

61 
ušt8_t
 
¥aû
[];

62 } 
	tas_async_v®ue_commªd
;

68 
šlše
 
as_ev’t_commªd
*

69 
as_async_wr™e_commªd_ü—‹
(

70 
as_şu¡”
* 
şu¡”
, cÚ¡ 
as_pŞicy_ba£
* 
pŞicy
, 
as_pŞicy_»¶iÿ
 
»¶iÿ
, * 
·¹™iÚ
,

71 
ušt8_t
 
æags
, 
as_async_wr™e_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

72 
as_pe_li¡’”
 
pe_li¡’”
, 
size_t
 
size
, 
as_ev’t_·r£_»suÉs_â
 
·r£_»suÉs


77 
size_t
 
s
 = ((
as_async_wr™e_commªd
è+ 
size
 + 
AS_AUTHENTICATION_MAX_SIZE
 + 1023) & ~1023;

78 
as_ev’t_commªd
* 
cmd
 = (as_ev’t_commªd*)
cf_m®loc
(
s
);

79 
as_async_wr™e_commªd
* 
wcmd
 = (as_async_wr™e_commªd*)
cmd
;

80 
cmd
->
tÙ®_d—dlše
 = 
pŞicy
->
tÙ®_timeout
;

81 
cmd
->
sock‘_timeout
 = 
pŞicy
->socket_timeout;

82 
cmd
->
max_»Œ›s
 = 
pŞicy
->max_retries;

83 
cmd
->
™”©iÚ
 = 0;

84 
cmd
->
»¶iÿ
 =„eplica;

85 
cmd
->
ev’t_loİ
 = 
as_ev’t_assign
(event_loop);

86 
cmd
->
şu¡”
 = cluster;

87 
cmd
->
node
 = 
NULL
;

88 
cmd
->
·¹™iÚ
 =…artition;

89 
cmd
->
ud©a
 = udata;

90 
cmd
->
·r£_»suÉs
 =…arse_results;

91 
cmd
->
pe_li¡’”
 =…ipe_listener;

92 
cmd
->
buf
 = 
wcmd
->
¥aû
;

93 
cmd
->
»ad_ÿ·c™y
 = (
ušt32_t
)(
s
 - 
size
 - (
as_async_wr™e_commªd
));

94 
cmd
->
ty³
 = 
AS_ASYNC_TYPE_WRITE
;

95 
cmd
->
¡©e
 = 
AS_ASYNC_STATE_UNREGISTERED
;

96 
cmd
->
æags
 = flags;

97 
cmd
->
de£rŸlize
 = 
çl£
;

98 
wcmd
->
li¡’”
 =†istener;

99  
cmd
;

102 
šlše
 
as_ev’t_commªd
*

103 
as_async_»cÜd_commªd_ü—‹
(

104 
as_şu¡”
* 
şu¡”
, cÚ¡ 
as_pŞicy_ba£
* 
pŞicy
, 
as_pŞicy_»¶iÿ
 
»¶iÿ
, * 
·¹™iÚ
,

105 
boŞ
 
de£rŸlize
, 
ušt8_t
 
æags
, 
as_async_»cÜd_li¡’”
 
li¡’”
, * 
ud©a
,

106 
as_ev’t_loİ
* 
ev’t_loİ
, 
as_pe_li¡’”
 
pe_li¡’”
, 
size_t
 
size
,

107 
as_ev’t_·r£_»suÉs_â
 
·r£_»suÉs


113 
size_t
 
s
 = ((
as_async_»cÜd_commªd
è+ 
size
 + 
AS_AUTHENTICATION_MAX_SIZE
 + 4095) & ~4095;

114 
as_ev’t_commªd
* 
cmd
 = (as_ev’t_commªd*)
cf_m®loc
(
s
);

115 
as_async_»cÜd_commªd
* 
rcmd
 = (as_async_»cÜd_commªd*)
cmd
;

116 
cmd
->
tÙ®_d—dlše
 = 
pŞicy
->
tÙ®_timeout
;

117 
cmd
->
sock‘_timeout
 = 
pŞicy
->socket_timeout;

118 
cmd
->
max_»Œ›s
 = 
pŞicy
->max_retries;

119 
cmd
->
™”©iÚ
 = 0;

120 
cmd
->
»¶iÿ
 =„eplica;

121 
cmd
->
ev’t_loİ
 = 
as_ev’t_assign
(event_loop);

122 
cmd
->
şu¡”
 = cluster;

123 
cmd
->
node
 = 
NULL
;

124 
cmd
->
·¹™iÚ
 =…artition;

125 
cmd
->
ud©a
 = udata;

126 
cmd
->
·r£_»suÉs
 =…arse_results;

127 
cmd
->
pe_li¡’”
 =…ipe_listener;

128 
cmd
->
buf
 = 
rcmd
->
¥aû
;

129 
cmd
->
»ad_ÿ·c™y
 = (
ušt32_t
)(
s
 - 
size
 - (
as_async_»cÜd_commªd
));

130 
cmd
->
ty³
 = 
AS_ASYNC_TYPE_RECORD
;

131 
cmd
->
¡©e
 = 
AS_ASYNC_STATE_UNREGISTERED
;

132 
cmd
->
æags
 = flags;

133 
cmd
->
de£rŸlize
 = deserialize;

134 
rcmd
->
li¡’”
 =†istener;

135  
cmd
;

138 
šlše
 
as_ev’t_commªd
*

139 
as_async_v®ue_commªd_ü—‹
(

140 
as_şu¡”
* 
şu¡”
, cÚ¡ 
as_pŞicy_ba£
* 
pŞicy
, 
as_pŞicy_»¶iÿ
 
»¶iÿ
, * 
·¹™iÚ
,

141 
ušt8_t
 
æags
, 
as_async_v®ue_li¡’”
 
li¡’”
, * 
ud©a
, 
as_ev’t_loİ
* 
ev’t_loİ
,

142 
as_pe_li¡’”
 
pe_li¡’”
, 
size_t
 
size
, 
as_ev’t_·r£_»suÉs_â
 
·r£_»suÉs


148 
size_t
 
s
 = ((
as_async_v®ue_commªd
è+ 
size
 + 
AS_AUTHENTICATION_MAX_SIZE
 + 4095) & ~4095;

149 
as_ev’t_commªd
* 
cmd
 = (as_ev’t_commªd*)
cf_m®loc
(
s
);

150 
as_async_v®ue_commªd
* 
vcmd
 = (as_async_v®ue_commªd*)
cmd
;

151 
cmd
->
tÙ®_d—dlše
 = 
pŞicy
->
tÙ®_timeout
;

152 
cmd
->
sock‘_timeout
 = 
pŞicy
->socket_timeout;

153 
cmd
->
max_»Œ›s
 = 
pŞicy
->max_retries;

154 
cmd
->
™”©iÚ
 = 0;

155 
cmd
->
»¶iÿ
 =„eplica;

156 
cmd
->
ev’t_loİ
 = 
as_ev’t_assign
(event_loop);

157 
cmd
->
şu¡”
 = cluster;

158 
cmd
->
node
 = 
NULL
;

159 
cmd
->
·¹™iÚ
 =…artition;

160 
cmd
->
ud©a
 = udata;

161 
cmd
->
·r£_»suÉs
 =…arse_results;

162 
cmd
->
pe_li¡’”
 =…ipe_listener;

163 
cmd
->
buf
 = 
vcmd
->
¥aû
;

164 
cmd
->
»ad_ÿ·c™y
 = (
ušt32_t
)(
s
 - 
size
 - (
as_async_v®ue_commªd
));

165 
cmd
->
ty³
 = 
AS_ASYNC_TYPE_VALUE
;

166 
cmd
->
¡©e
 = 
AS_ASYNC_STATE_UNREGISTERED
;

167 
cmd
->
æags
 = flags;

168 
cmd
->
de£rŸlize
 = 
çl£
;

169 
vcmd
->
li¡’”
 =†istener;

170  
cmd
;

173 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_async_proto.h

17 #´agm¨
Úû


19 
	~<¡dboŞ.h
>

20 
	~<¡dšt.h
>

22 #ifdeà
__ılu¥lus


26 
as_şu¡”_s
;

32 
ušt32_t


33 
as_async_g‘_şu¡”_couÁ
();

35 
ušt32_t


36 
as_async_g‘_³ndšg
(
as_şu¡”_s
* 
şu¡”
);

38 
ušt32_t


39 
as_async_g‘_cÚÃùiÚs
(
as_şu¡”_s
* 
şu¡”
);

42 
as_async_upd©e_max_idË
(
as_şu¡”_s
* 
şu¡”
, 
ušt32_t
 
max_idË
);

45 
as_async_upd©e_max_cÚns
(
as_şu¡”_s
* 
şu¡”
, 
boŞ
 
pe
, 
ušt32_t
 
max_cÚns
);

47 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_batch.h

17 #´agm¨
Úû


19 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Waddress"

21 
	~<«ro¥ike/as_bš.h
>

22 
	~<«ro¥ike/as_key.h
>

23 
	~<«ro¥ike/as_»cÜd.h
>

24 
	~<«ro¥ike/as_¡©us.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dboŞ.h
>

28 #ifdeà
__ılu¥lus


39 
	sas_b©ch_s
 {

45 
boŞ
 
_ä“
;

56 
boŞ
 
_ä“
;

61 
ušt32_t
 
size
;

66 
as_key
 * 
’Œ›s
;

68 } 
keys
;

70 } 
	tas_b©ch
;

81 
	sas_b©ch_»ad_s
 {

86 cÚ¡ 
as_key
 * 
key
;

91 
as_¡©us
 
»suÉ
;

96 
as_»cÜd
 
»cÜd
;

98 } 
	tas_b©ch_»ad
;

127 
	#as_b©ch_š™a
(
__b©ch
, 
__size
) \

129 iàĞ(
__b©ch
è!ğ
NULL
 ) {\

130 (
__b©ch
)->
_ä“
 = 
çl£
;\

131 (
__b©ch
)->
keys
.
’Œ›s
 = (
as_key
*è
	`®loÿ
(×s_keyè* (
__size
));\

132 iàĞ(
__b©ch
)->
keys
.
’Œ›s
 ) { \

133 (
__b©ch
)->
keys
.
_ä“
 = 
çl£
;\

134 (
__b©ch
)->
keys
.
size
 = (
__size
);\

137 } 0)

	)

161 
as_b©ch
 * 
as_b©ch_Ãw
(
ušt32_t
 
size
);

182 
as_b©ch
 * 
as_b©ch_š™
×s_b©ch * 
b©ch
, 
ušt32_t
 
size
);

196 
as_b©ch_de¡roy
(
as_b©ch
 * 
b©ch
);

210 
šlše
 
as_key
 * 
as_b©ch_key©
(cÚ¡ 
as_b©ch
 * 
b©ch
, 
ušt32_t
 
i
)

212  (
b©ch
 !ğ
NULL
 && b©ch->
keys
.
’Œ›s
 !ğNULL && b©ch->keys.
size
 > 
i
) ? &batch->keys.entries[i] : NULL;

215 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_bin.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_š‹g”.h
>

20 
	~<«ro¥ike/as_¡ršg.h
>

21 
	~<«ro¥ike/as_geojsÚ.h
>

22 
	~<«ro¥ike/as_by‹s.h
>

23 
	~<«ro¥ike/as_li¡.h
>

24 
	~<«ro¥ike/as_m­.h
>

25 
	~<«ro¥ike/as_v®.h
>

27 #ifdeà
__ılu¥lus


38 
	#AS_BIN_NAME_MAX_SIZE
 15

	)

43 
	#AS_BIN_NAME_MAX_LEN
 (
AS_BIN_NAME_MAX_SIZE
 - 1)

	)

52 
	tas_bš_Çme
[
AS_BIN_NAME_MAX_SIZE
];

57 
	uas_bš_v®ue_s
 {

58 
as_v®
 
n
;

59 
as_š‹g”
 
š‹g”
;

60 
as_doubË
 
dbl
;

61 
as_¡ršg
 
¡ršg
;

62 
as_by‹s
 
by‹s
;

63 
as_li¡
 
li¡
;

64 
as_m­
 
m­
;

65 } 
	tas_bš_v®ue
;

77 
	sas_bš_s
 {

82 
as_bš_Çme
 
Çme
;

87 
as_bš_v®ue
 
v®ue
;

94 
as_bš_v®ue
 * 
v®u•
;

96 } 
	tas_bš
;

101 
	sas_bšs_s
 {

107 
boŞ
 
_ä“
;

112 
ušt16_t
 
ÿ·c™y
;

117 
ušt16_t
 
size
;

122 
as_bš
 * 
’Œ›s
;

124 } 
	tas_bšs
;

143 
šlše
 * 
as_bš_g‘_Çme
(cÚ¡ 
as_bš
 * 
bš
) {

144  (*è
bš
->
Çme
;

161 
šlše
 
as_bš_v®ue
 * 
as_bš_g‘_v®ue
(cÚ¡ 
as_bš
 * 
bš
) {

162  
bš
->
v®u•
;

179 
šlše
 
as_v®_t
 
as_bš_g‘_ty³
(cÚ¡ 
as_bš
 * 
bš
) {

180  
as_v®_ty³
(
bš
->
v®u•
);

183 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_boolean.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dboŞ.h
>

25 #ifdeà
__ılu¥lus


46 
	sas_boŞ—n_s
 {

53 
as_v®
 
_
;

58 
boŞ
 
v®ue
;

60 } 
	tas_boŞ—n
;

72 cÚ¡ 
as_boŞ—n
 
as_Œue
;

80 cÚ¡ 
as_boŞ—n
 
as_çl£
;

96 
as_boŞ—n
 * 
as_boŞ—n_š™
×s_boŞ—À* 
boŞ—n
, 
boŞ
 
v®ue
);

108 
as_boŞ—n
 * 
as_boŞ—n_Ãw
(
boŞ
 
v®ue
);

117 
šlše
 
as_boŞ—n_de¡roy
(
as_boŞ—n
 * 
boŞ—n
) {

118 
as_v®_de¡roy
((
as_v®
 *è
boŞ—n
);

130 
šlše
 
boŞ
 
as_boŞ—n_g‘Ü–£
(cÚ¡ 
as_boŞ—n
 * 
boŞ—n
, boŞ 
çÎback
) {

131  
	gboŞ—n
 ? boŞ—n->
	gv®ue
 : 
çÎback
;

139 
šlše
 
boŞ
 
as_boŞ—n_g‘
(cÚ¡ 
as_boŞ—n
 * 
boŞ—n
) {

140  
as_boŞ—n_g‘Ü–£
(
boŞ—n
, 
çl£
);

149 
šlše
 
boŞ
 
as_boŞ—n_toboŞ
(cÚ¡ 
as_boŞ—n
 * 
boŞ—n
) {

150  
as_boŞ—n_g‘Ü–£
(
boŞ—n
, 
çl£
);

162 
šlše
 
as_v®
 * 
as_boŞ—n_tov®
(cÚ¡ 
as_boŞ—n
 * 
boŞ—n
) {

163  (
	gas_v®
 *è
	gboŞ—n
;

171 
šlše
 
as_boŞ—n
 * 
as_boŞ—n_äomv®
(cÚ¡ 
as_v®
 * 
v
) {

172  
as_ut_äomv®
(
v
, 
AS_BOOLEAN
, 
as_boŞ—n
);

183 
as_boŞ—n_v®_de¡roy
(
as_v®
 * 
v
);

189 
ušt32_t
 
as_boŞ—n_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

195 * 
as_boŞ—n_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

197 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_buffer.h

18 #´agm¨
Úû


20 
	~<¡dšt.h
>

22 #ifdeà
__ılu¥lus


33 
	sas_bufãr_s
 {

38 
ušt32_t
 
ÿ·c™y
;

43 
ušt32_t
 
size
;

48 
ušt8_t
 * 
d©a
;

50 } 
	tas_bufãr
;

59 
as_bufãr_š™
(
as_bufãr
 * 
b
);

64 
as_bufãr_de¡roy
(
as_bufãr
 * 
b
);

66 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_buffer_pool.h

17 #´agm¨
Úû


19 
	~<c™ru¦—f/cf_queue.h
>

21 #ifdeà
__ılu¥lus


33 
	sas_bufãr_»suÉ_s
 {

34 * 
d©a
;

35 
ušt32_t
 
ÿ·c™y
;

36 } 
	tas_bufãr_»suÉ
;

42 
	sas_bufãr_poŞ_s
 {

43 
cf_queue
* 
queue
;

44 
ušt32_t
 
h—d”_size
;

45 
ušt32_t
 
bufãr_size
;

46 } 
	tas_bufãr_poŞ
;

65 
as_bufãr_poŞ_š™
(
as_bufãr_poŞ
* 
poŞ
, 
ušt32_t
 
h—d”_size
, ušt32_ˆ
bufãr_size
);

84 
as_bufãr_poŞ_pİ
(
as_bufãr_poŞ
* 
poŞ
, 
ušt32_t
 
size
, 
as_bufãr_»suÉ
* 
bufãr
);

101 
as_bufãr_poŞ_push
(
as_bufãr_poŞ
* 
poŞ
, * 
bufãr
, 
ušt32_t
 
ÿ·c™y
);

120 
as_bufãr_poŞ_push_lim™
(
as_bufãr_poŞ
* 
poŞ
, * 
bufãr
, 
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
max_bufãrs
);

133 
as_bufãr_poŞ_drİ_bufãrs
(
as_bufãr_poŞ
* 
poŞ
, 
bufãr_couÁ
);

142 
as_bufãr_poŞ_de¡roy
(
as_bufãr_poŞ
* 
poŞ
);

144 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_bytes.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dboŞ.h
>

24 
	~<¡dšt.h
>

25 
	~<¡ršg.h
>

27 #ifdeà
__ılu¥lus


38 
	eas_by‹s_ty³_e
 {

43 
AS_BYTES_UNDEF
 = 0,

48 
AS_BYTES_INTEGER
 = 1,

53 
AS_BYTES_DOUBLE
 = 2,

58 
AS_BYTES_STRING
 = 3,

63 
AS_BYTES_BLOB
 = 4,

68 
AS_BYTES_JAVA
 = 7,

73 
AS_BYTES_CSHARP
 = 8,

78 
AS_BYTES_PYTHON
 = 9,

83 
AS_BYTES_RUBY
 = 10,

88 
AS_BYTES_PHP
 = 11,

93 
AS_BYTES_ERLANG
 = 12,

98 
AS_BYTES_MAP
 = 19,

103 
AS_BYTES_LIST
 = 20,

108 
AS_BYTES_LDT
 = 21,

113 
AS_BYTES_GEOJSON
 = 23,

118 
AS_BYTES_TYPE_MAX
 = 24

120 } 
	tas_by‹s_ty³
;

243 
	sas_by‹s_s
 {

250 
as_v®
 
_
;

255 
ušt32_t
 
ÿ·c™y
;

260 
ušt32_t
 
size
;

265 
ušt8_t
 * 
v®ue
;

271 
boŞ
 
ä“
;

276 
as_by‹s_ty³
 
ty³
;

278 } 
	tas_by‹s
;

296 
	#as_by‹s_š™a
(
__by‹s
, 
__ÿ·c™y
)\

297 
	`as_by‹s_š™
(
__by‹s
, 0);\

298 (
__by‹s
)->
ty³
 = 
AS_BYTES_BLOB
;\

299 (
__by‹s
)->
ä“
 = 
çl£
;\

300 (
__by‹s
)->
ÿ·c™y
 = (
__ÿ·c™y
);\

301 (
__by‹s
)->
size
 = 0;\

302 (
__by‹s
)->
v®ue
 = (
ušt8_t
*è
	`®loÿ
((ušt8_tè* (
__ÿ·c™y
));

	)

325 
as_by‹s
 * 
as_by‹s_š™
×s_by‹ * 
by‹s
, 
ušt32_t
 
ÿ·c™y
);

346 
as_by‹s
 * 
as_by‹s_š™_w¿p
×s_by‹ * 
by‹s
, 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

362 
as_by‹s
 * 
as_by‹s_Ãw
(
ušt32_t
 
ÿ·c™y
);

381 
as_by‹s
 * 
as_by‹s_Ãw_w¿p
(
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

394 
šlše
 
as_by‹s_de¡roy
(
as_by‹s
 * 
by‹s
)

396 
as_v®_de¡roy
((
as_v®
 *è
by‹s
);

412 
šlše
 
ušt32_t
 
as_by‹s_size
(cÚ¡ 
as_by‹s
 * 
by‹s
)

414 iàĞ!
by‹s
 )  0;

415  
by‹s
->
size
;

427 
šlše
 
ušt32_t
 
as_by‹s_ÿ·c™y
(cÚ¡ 
as_by‹s
 * 
by‹s
)

429 iàĞ!
by‹s
 )  0;

430  
by‹s
->
ÿ·c™y
;

442 
šlše
 
as_by‹s_ty³
 
as_by‹s_g‘_ty³
(cÚ¡ 
as_by‹s
 * 
by‹s
)

444 iàĞ!
by‹s
 )  
AS_BYTES_UNDEF
;

445  
by‹s
->
ty³
;

456 
šlše
 
as_by‹s_£t_ty³
(
as_by‹s
 * 
by‹s
, 
as_by‹s_ty³
 
ty³
)

458 iàĞ!
by‹s
 ) ;

459 
by‹s
->
ty³
 =ype;

478 
šlše
 
ušt8_t
 * 
as_by‹s_g‘Ü–£
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt8_ˆ* 
çÎback
)

480  
by‹s
 ? by‹s->
v®ue
 : 
çÎback
;

496 
šlše
 
ušt8_t
 * 
as_by‹s_g‘
(cÚ¡ 
as_by‹s
 * 
by‹s
)

498  
as_by‹s_g‘Ü–£
(
by‹s
, 
NULL
);

530 
ušt32_t
 
as_by‹s_cİy
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, 
ušt8_t
 * 
v®ue
, ušt32_ˆ
size
);

548 
šlše
 
ušt32_t
 
as_by‹s_g‘_by‹
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, 
ušt8_t
 * 
v®ue
)

550  
as_by‹s_cİy
(
by‹s
, 
šdex
, (
ušt8_t
 *è
v®ue
, 1);

569 
šlše
 
ušt32_t
 
as_by‹s_g‘_št16
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, 
št16_t
 * 
v®ue
)

571  
as_by‹s_cİy
(
by‹s
, 
šdex
, (
ušt8_t
 *è
v®ue
, 2);

590 
šlše
 
ušt32_t
 
as_by‹s_g‘_št32
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, 
št32_t
 * 
v®ue
)

592  
as_by‹s_cİy
(
by‹s
, 
šdex
, (
ušt8_t
 *è
v®ue
, 4);

611 
šlše
 
ušt32_t
 
as_by‹s_g‘_št64
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, 
št64_t
 * 
v®ue
)

613  
as_by‹s_cİy
(
by‹s
, 
šdex
, (
ušt8_t
 *è
v®ue
, 8);

632 
šlše
 
ušt32_t
 
as_by‹s_g‘_doubË
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, * 
v®ue
)

634  
as_by‹s_cİy
(
by‹s
, 
šdex
, (
ušt8_t
 *è
v®ue
, 8);

653 
ušt32_t
 
as_by‹s_g‘_v¬_št
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, ušt32_ˆ* 
v®ue
);

676 
boŞ
 
as_by‹s_£t
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
šdex
, cÚ¡ 
ušt8_t
 * 
v®ue
, ušt32_ˆ
size
);

689 
šlše
 
boŞ
 
as_by‹s_£t_by‹
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
šdex
, 
ušt8_t
 
v®ue
)

691  
as_by‹s_£t
(
by‹s
, 
šdex
, (
ušt8_t
 *è&
v®ue
, 1);

705 
šlše
 
boŞ
 
as_by‹s_£t_št16
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
šdex
, 
št16_t
 
v®ue
)

707  
as_by‹s_£t
(
by‹s
, 
šdex
, (
ušt8_t
 *è&
v®ue
, 2);

721 
šlše
 
boŞ
 
as_by‹s_£t_št32
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
šdex
, 
št32_t
 
v®ue
)

723  
as_by‹s_£t
(
by‹s
, 
šdex
, (
ušt8_t
 *è&
v®ue
, 4);

737 
šlše
 
boŞ
 
as_by‹s_£t_št64
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
šdex
, 
št64_t
 
v®ue
)

739  
as_by‹s_£t
(
by‹s
, 
šdex
, (
ušt8_t
 *è&
v®ue
, 8);

753 
šlše
 
boŞ
 
as_by‹s_£t_doubË
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
šdex
, 
v®ue
)

755  
as_by‹s_£t
(
by‹s
, 
šdex
, (
ušt8_t
 *è&
v®ue
, 8);

774 
ušt32_t
 
as_by‹s_£t_v¬_št
(cÚ¡ 
as_by‹s
 * 
by‹s
, ušt32_ˆ
šdex
, ušt32_ˆ
v®ue
);

797 
boŞ
 
as_by‹s_­³nd
(
as_by‹s
 * 
by‹s
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
);

810 
šlše
 
boŞ
 
as_by‹s_­³nd_by‹
(
as_by‹s
 * 
by‹s
, 
ušt8_t
 
v®ue
)

812  
as_by‹s_­³nd
(
by‹s
, (
ušt8_t
 *è&
v®ue
, 1);

826 
šlše
 
boŞ
 
as_by‹s_­³nd_št16
(
as_by‹s
 * 
by‹s
, 
št16_t
 
v®ue
)

828  
as_by‹s_­³nd
(
by‹s
, (
ušt8_t
 *è&
v®ue
, 2);

842 
šlše
 
boŞ
 
as_by‹s_­³nd_št32
(
as_by‹s
 * 
by‹s
, 
št32_t
 
v®ue
)

844  
as_by‹s_­³nd
(
by‹s
, (
ušt8_t
 *è&
v®ue
, 4);

858 
šlše
 
boŞ
 
as_by‹s_­³nd_št64
(
as_by‹s
 * 
by‹s
, 
št64_t
 
v®ue
)

860  
as_by‹s_­³nd
(
by‹s
, (
ušt8_t
 *è&
v®ue
, 8);

874 
šlše
 
boŞ
 
as_by‹s_­³nd_doubË
(
as_by‹s
 * 
by‹s
, 
v®ue
)

876  
as_by‹s_­³nd
(
by‹s
, (
ušt8_t
 *è&
v®ue
, 8);

903 
boŞ
 
as_by‹s_Œunÿ‹
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
n
);

930 
boŞ
 
as_by‹s_’su»
(
as_by‹s
 * 
by‹s
, 
ušt32_t
 
ÿ·c™y
, boŞ 
»size
);

940 
šlše
 
ušt8_t
 * 
as_by‹s_toby‹s
(cÚ¡ 
as_by‹s
 * 
by‹s
, 
ušt32_t
 * 
size
)

942 iàĞ!
by‹s
 )  
NULL
;

944 iàĞ
size
 ) {

945 *
size
 = 
by‹s
->size;

948  
by‹s
->
v®ue
;

960 
šlše
 
as_v®
 * 
as_by‹s_tov®
(cÚ¡ 
as_by‹s
 * 
b
)

962  (
as_v®
 *è
b
;

970 
šlše
 
as_by‹s
 * 
as_by‹s_äomv®
(cÚ¡ 
as_v®
 * 
v
)

972  
as_ut_äomv®
(
v
, 
AS_BYTES
, 
as_by‹s
);

983 
as_by‹s_v®_de¡roy
(
as_v®
 * 
v
);

989 
ušt32_t
 
as_by‹s_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

995 * 
as_by‹s_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

997 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_cluster.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_cÚfig.h
>

20 
	~<«ro¥ike/as_node.h
>

21 
	~<«ro¥ike/as_·¹™iÚ.h
>

22 
	~<«ro¥ike/as_pŞicy.h
>

23 
	~<«ro¥ike/as_th»ad_poŞ.h
>

25 #ifdeà
__ılu¥lus


30 
	~<«ro¥ike/ck/ck_´.h
>

40 
	sas_nodes_s
 {

45 
ušt32_t
 
»f_couÁ
;

51 
ušt32_t
 
size
;

57 
as_node
* 
¬¿y
[];

58 } 
	tas_nodes
;

64 (*
as_»Ëa£_â
è(* 
	tv®ue
);

70 
	sas_gc_™em_s
 {

75 * 
d©a
;

81 
as_»Ëa£_â
 
»Ëa£_â
;

82 } 
	tas_gc_™em
;

87 
	sas_şu¡”_s
 {

92 
as_nodes
* 
nodes
;

98 
as_·¹™iÚ_bËs
* 
·¹™iÚ_bËs
;

104 
as_veùÜ
* 
gc
;

110 
as_shm_šfo_s
* 
shm_šfo
;

116 * 
u£r
;

122 * 
·sswÜd
;

128 * 
şu¡”_Çme
;

133 
as_şu¡”_ev’t_ÿÎback
 
ev’t_ÿÎback
;

138 * 
ev’t_ÿÎback_ud©a
;

143 * 
³ndšg
;

149 
as_veùÜ
* 
£eds
;

160 
as_veùÜ
* 
_m­
;

166 
as_s_cÚ‹xt
 
s_ùx
;

172 
as_th»ad_poŞ
 
th»ad_poŞ
;

178 
±h»ad_t
 
‹nd_th»ad
;

184 
±h»ad_mu‹x_t
 
£ed_lock
;

193 
±h»ad_mu‹x_t
 
‹nd_lock
;

199 
±h»ad_cÚd_t
 
‹nd_cÚd
;

205 
ušt32_t
 
‹nd_š‹rv®
;

211 
ušt32_t
 
max_cÚns_³r_node
;

219 
ušt32_t
 
async_max_cÚns_³r_node
;

227 
ušt32_t
 
pe_max_cÚns_³r_node
;

233 
ušt32_t
 
cÚn_poŞs_³r_node
;

239 
ušt32_t
 
cÚn_timeout_ms
;

245 
ušt32_t
 
max_sock‘_idË
;

251 
ušt32_t
 
node_šdex
;

257 
ušt16_t
 
n_·¹™iÚs
;

263 
boŞ
 
u£_£rviûs_®‹º©e
;

269 vŞ©
boŞ
 
v®id
;

270 } 
	tas_şu¡”
;

279 
as_¡©us


280 
as_şu¡”_ü—‹
(
as_cÚfig
* 
cÚfig
, 
as_”rÜ
* 
”r
, 
as_şu¡”
** 
şu¡”
);

286 
as_şu¡”_de¡roy
(
as_şu¡”
* 
şu¡”
);

291 
boŞ


292 
as_şu¡”_is_cÚÃùed
(
as_şu¡”
* 
şu¡”
);

298 
as_şu¡”_g‘_node_Çmes
(
as_şu¡”
* 
şu¡”
, * 
n_nodes
, ** 
node_Çmes
);

303 
šlše
 
as_nodes
*

304 
as_nodes_»£rve
(
as_şu¡”
* 
şu¡”
)

306 
as_nodes
* 
nodes
 = (as_node *)
ck_´_lßd_±r
(&
şu¡”
->nodes);

308 
ck_´_šc_32
(&
nodes
->
»f_couÁ
);

309  
nodes
;

315 
šlše
 

316 
as_nodes_»Ëa£
(
as_nodes
* 
nodes
)

320 
boŞ
 
de¡roy
;

321 
ck_´_dec_32_z”o
(&
nodes
->
»f_couÁ
, &
de¡roy
);

323 ià(
de¡roy
) {

324 
cf_ä“
(
nodes
);

332 
as_şu¡”_add_£ed
(
as_şu¡”
* 
şu¡”
, cÚ¡ * 
ho¡Çme
, cÚ¡ * 
s_Çme
, 
ušt16_t
 
pÜt
);

338 
as_şu¡”_»move_£ed
(
as_şu¡”
* 
şu¡”
, cÚ¡ * 
ho¡Çme
, 
ušt16_t
 
pÜt
);

345 
as_şu¡”_chªge_·sswÜd
(
as_şu¡”
* 
şu¡”
, cÚ¡ * 
u£r
, cÚ¡ * 
·sswÜd
);

352 
as_node
*

353 
as_node_g‘_¿ndom
(
as_şu¡”
* 
şu¡”
);

360 
as_node
*

361 
as_node_g‘_by_Çme
(
as_şu¡”
* 
şu¡”
, cÚ¡ * 
Çme
);

368 
šlše
 
as_·¹™iÚ_bËs
*

369 
as_·¹™iÚ_bËs_»£rve
(
as_şu¡”
* 
şu¡”
)

371 
as_·¹™iÚ_bËs
* 
bËs
 = (as_·¹™iÚ_bË *)
ck_´_lßd_±r
(&
şu¡”
->
·¹™iÚ_bËs
);

372 
ck_´_šc_32
(&
bËs
->
»f_couÁ
);

373  
bËs
;

380 
šlše
 

381 
as_·¹™iÚ_bËs_»Ëa£
(
as_·¹™iÚ_bËs
* 
bËs
)

383 
boŞ
 
de¡roy
;

384 
ck_´_dec_32_z”o
(&
bËs
->
»f_couÁ
, &
de¡roy
);

386 ià(
de¡roy
) {

387 
cf_ä“
(
bËs
);

395 
šlše
 
as_·¹™iÚ_bË
*

396 
as_şu¡”_g‘_·¹™iÚ_bË
(
as_şu¡”
* 
şu¡”
, cÚ¡ * 
ns
)

402 
as_·¹™iÚ_bËs
* 
bËs
 = 
as_·¹™iÚ_bËs_»£rve
(
şu¡”
);

403 
as_·¹™iÚ_bË
* 
bË
 = 
as_·¹™iÚ_bËs_g‘
(
bËs
, 
ns
);

404 
as_·¹™iÚ_bËs_»Ëa£
(
bËs
);

405  
bË
;

413 
as_node
*

414 
as_·¹™iÚ_g‘_node
(
as_şu¡”
* 
şu¡”
, 
as_·¹™iÚ
* 
p
, 
as_pŞicy_»¶iÿ
 
»¶iÿ
, 
boŞ
 
u£_ma¡”
, boŞ 
ı_mode
);

421 
as_¡©us


422 
as_şu¡”_g‘_node
(

423 
as_şu¡”_s
* 
şu¡”
, 
as_”rÜ
* 
”r
, cÚ¡ * 
ns
, cÚ¡ 
ušt8_t
* 
dige¡
,

424 
as_pŞicy_»¶iÿ
 
»¶iÿ
, 
boŞ
 
ma¡”
, 
as_node
** 
node


427 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_command.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_bš.h
>

20 
	~<«ro¥ike/as_bufãr.h
>

21 
	~<«ro¥ike/as_şu¡”.h
>

22 
	~<«ro¥ike/as_key.h
>

23 
	~<«ro¥ike/as_İ”©iÚs.h
>

24 
	~<«ro¥ike/as_´Ùo.h
>

25 
	~<«ro¥ike/as_»cÜd.h
>

26 
	~<c™ru¦—f/cf_by‹_Üd”.h
>

27 
	~<c™ru¦—f/cf_dige¡.h
>

29 #ifdeà
__ılu¥lus


38 
	#AS_FIELD_NAMESPACE
 0

	)

39 
	#AS_FIELD_SETNAME
 1

	)

40 
	#AS_FIELD_KEY
 2

	)

41 
	#AS_FIELD_DIGEST
 4

	)

42 
	#AS_FIELD_DIGEST_ARRAY
 6

	)

43 
	#AS_FIELD_TASK_ID
 7

	)

44 
	#AS_FIELD_SCAN_OPTIONS
 8

	)

45 
	#AS_FIELD_SCAN_TIMEOUT
 9

	)

46 
	#AS_FIELD_INDEX_RANGE
 22

	)

47 
	#AS_FIELD_INDEX_FILTER
 23

	)

48 
	#AS_FIELD_INDEX_LIMIT
 24

	)

49 
	#AS_FIELD_INDEX_ORDER
 25

	)

50 
	#AS_FIELD_INDEX_TYPE
 26

	)

51 
	#AS_FIELD_UDF_PACKAGE_NAME
 30

	)

52 
	#AS_FIELD_UDF_FUNCTION
 31

	)

53 
	#AS_FIELD_UDF_ARGLIST
 32

	)

54 
	#AS_FIELD_UDF_OP
 33

	)

55 
	#AS_FIELD_QUERY_BINS
 40

	)

56 
	#AS_FIELD_BATCH_INDEX
 41

	)

57 
	#AS_FIELD_BATCH_INDEX_WITH_SET
 42

	)

58 
	#AS_FIELD_PREDEXP
 43

	)

61 
	#AS_MSG_INFO1_READ
 (1 << 0)

62 
	#AS_MSG_INFO1_GET_ALL
 (1 << 1)

64 
	#AS_MSG_INFO1_BATCH_INDEX
 (1 << 3)

65 
	#AS_MSG_INFO1_XDR
 (1 << 4)

66 
	#AS_MSG_INFO1_GET_NOBINDATA
 (1 << 5)

67 
	#AS_MSG_INFO1_CONSISTENCY_ALL
 (1 << 6)

69 

	)

71 
	#AS_MSG_INFO2_WRITE
 (1 << 0)

72 
	#AS_MSG_INFO2_DELETE
 (1 << 1)

73 
	#AS_MSG_INFO2_GENERATION
 (1 << 2)

74 
	#AS_MSG_INFO2_GENERATION_GT
 (1 << 3)

75 
	#AS_MSG_INFO2_DURABLE_DELETE
 (1 << 4)

76 
	#AS_MSG_INFO2_CREATE_ONLY
 (1 << 5)

78 
	#AS_MSG_INFO2_RESPOND_ALL_OPS
 (1 << 7)

79 

	)

81 
	#AS_MSG_INFO3_LAST
 (1 << 0)

82 
	#AS_MSG_INFO3_COMMIT_MASTER
 (1 << 1)

84 
	#AS_MSG_INFO3_UPDATE_ONLY
 (1 << 3)

85 
	#AS_MSG_INFO3_CREATE_OR_REPLACE
 (1 << 4)

86 
	#AS_MSG_INFO3_REPLACE_ONLY
 (1 << 5)

89 

	)

91 
	#AS_MESSAGE_VERSION
 2L

	)

92 
	#AS_MESSAGE_TYPE
 3L

	)

93 
	#AS_COMPRESSED_MESSAGE_TYPE
 4L

	)

96 
	#AS_INFO_MESSAGE_VERSION
 2L

	)

97 
	#AS_INFO_MESSAGE_TYPE
 1L

	)

100 
	#AS_HEADER_SIZE
 30

	)

101 
	#AS_FIELD_HEADER_SIZE
 5

	)

102 
	#AS_OPERATION_HEADER_SIZE
 8

	)

104 
	#AS_STACK_BUF_SIZE
 (1024 * 16)

	)

112 
šlše
 *

113 
loÿl_m®loc
(
size_t
 
size
)

115  
cf_m®loc
(
size
);

118 
šlše
 

119 
loÿl_ä“
(* 
memÜy
)

121  
cf_ä“
(
memÜy
);

128 
	#as_commªd_š™
(
_sz
è(_sz > 
AS_STACK_BUF_SIZE
è? (
ušt8_t
*)
	`loÿl_m®loc
(_szè: (ušt8_t*)
	`®loÿ
(_sz)

	)

134 
	#as_commªd_ä“
(
_buf
, 
_sz
èià(_sz > 
AS_STACK_BUF_SIZE
è{
	`loÿl_ä“
(_buf);}

	)

144 
	sas_commªd_node_s
 {

145 
as_node
* 
node
;

146 cÚ¡ * 
ns
;

147 cÚ¡ 
ušt8_t
* 
dige¡
;

148 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

149 } 
	tas_commªd_node
;

155 
	sas_commªd_·r£_»suÉ_d©a_s
 {

156 
as_»cÜd
** 
»cÜd
;

157 
boŞ
 
de£rŸlize
;

158 } 
	tas_commªd_·r£_»suÉ_d©a
;

164 
as_¡©us
 (*
	tas_·r£_»suÉs_â
è(
	tas_”rÜ
* 
	t”r
, 
	tas_sock‘
* 
	tsock
, 
	tas_node
* 
	tnode
, 
	tušt32_t
 
	tsock‘_timeout
, 
	tušt64_t
 
	td—dlše_ms
, * 
	tu£r_d©a
);

174 
size_t


175 
as_commªd_key_size
(
as_pŞicy_key
 
pŞicy
, cÚ¡ 
as_key
* 
key
, 
ušt16_t
* 
n_f›lds
);

181 
šlše
 
size_t


182 
as_commªd_¡ršg_f›ld_size
(cÚ¡ * 
v®ue
)

184  
¡¾’
(
v®ue
è+ 
AS_FIELD_HEADER_SIZE
;

191 
šlše
 
size_t


192 
as_commªd_f›ld_size
(
size_t
 
size
)

194  
size
 + 
AS_FIELD_HEADER_SIZE
;

201 
size_t


202 
as_commªd_v®ue_size
(
as_v®
* 
v®
, 
as_bufãr
* 
bufãr
);

208 
šlše
 
size_t


209 
as_commªd_bš_size
(cÚ¡ 
as_bš
* 
bš
, 
as_bufãr
* 
bufãr
)

211  
¡¾’
(
bš
->
Çme
è+ 
as_commªd_v®ue_size
((
as_v®
*)bš->
v®u•
, 
bufãr
) + 8;

218 
šlše
 
as_¡©us


219 
as_commªd_bš_Çme_size
(
as_”rÜ
* 
”r
, cÚ¡ * 
Çme
, 
size_t
* 
size
)

221 
size_t
 
s
 = 
¡¾’
(
Çme
);

223 ià(
s
 > 
AS_BIN_NAME_MAX_LEN
) {

224  
as_”rÜ_upd©e
(
”r
, 
AEROSPIKE_ERR_PARAM
, "Bš‚amtoØlÚg: %s", 
Çme
);

226 (*
size
è+ğ
s
 + 
AS_OPERATION_HEADER_SIZE
;

227  
AEROSPIKE_OK
;

234 
šlše
 
size_t


235 
as_commªd_¡ršg_İ”©iÚ_size
(cÚ¡ * 
v®ue
)

237  
¡¾’
(
v®ue
è+ 
AS_OPERATION_HEADER_SIZE
;

244 
ušt8_t
*

245 
as_commªd_wr™e_h—d”
(
ušt8_t
* 
cmd
, ušt8_ˆ
»ad_©Œ
, ušt8_ˆ
wr™e_©Œ
,

246 
as_pŞicy_comm™_Ëv–
 
comm™_Ëv–
, 
as_pŞicy_cÚsi¡’cy_Ëv–
 
cÚsi¡’cy
,

247 
as_pŞicy_exi¡s
 
exi¡s
, 
as_pŞicy_g’
 
g’_pŞicy
, 
ušt32_t
 
g’
, ušt32_ˆ
‰l
,

248 
ušt32_t
 
timeout_ms
, 
ušt16_t
 
n_f›lds
, ušt16_ˆ
n_bšs
, 
boŞ
 
du¿bË_d–‘e
);

254 
šlše
 
ušt8_t
*

255 
as_commªd_wr™e_h—d”_»ad
(
ušt8_t
* 
cmd
, ušt8_ˆ
»ad_©Œ
, 
as_pŞicy_cÚsi¡’cy_Ëv–
 
cÚsi¡’cy
,

256 
ušt32_t
 
timeout_ms
, 
ušt16_t
 
n_f›lds
, ušt16_ˆ
n_bšs
)

258 ià(
cÚsi¡’cy
 =ğ
AS_POLICY_CONSISTENCY_LEVEL_ALL
) {

259 
»ad_©Œ
 |ğ
AS_MSG_INFO1_CONSISTENCY_ALL
;

262 
cmd
[8] = 22;

263 
cmd
[9] = 
»ad_©Œ
;

264 
mem£t
(&
cmd
[10], 0, 12);

265 *(
ušt32_t
*)&
cmd
[22] = 
cf_sw­_to_be32
(
timeout_ms
);

266 *(
ušt16_t
*)&
cmd
[26] = 
cf_sw­_to_be16
(
n_f›lds
);

267 *(
ušt16_t
*)&
cmd
[28] = 
cf_sw­_to_be16
(
n_bšs
);

268  
cmd
 + 
AS_HEADER_SIZE
;

275 
šlše
 
ušt8_t
*

276 
as_commªd_wr™e_f›ld_h—d”
(
ušt8_t
* 
p
, ušt8_ˆ
id
, 
ušt32_t
 
size
)

278 *(
ušt32_t
*)
p
 = 
cf_sw­_to_be32
(
size
+1);

279 
p
 += 4;

280 *
p
++ = 
id
;

281  
p
;

288 
šlše
 
ušt8_t
*

289 
as_commªd_wr™e_f›ld_¡ršg
(
ušt8_t
* 
begš
, ušt8_ˆ
id
, cÚ¡ * 
v®
)

291 
ušt8_t
* 
p
 = 
begš
 + 
AS_FIELD_HEADER_SIZE
;

294 *
v®
) {

295 *
p
++ = *
v®
++;

297 
as_commªd_wr™e_f›ld_h—d”
(
begš
, 
id
, (
ušt32_t
)(
p
 - begš - 
AS_FIELD_HEADER_SIZE
));

298  
p
;

305 
šlše
 
ušt8_t
*

306 
as_commªd_wr™e_f›ld_ušt64
(
ušt8_t
* 
p
, ušt8_ˆ
id
, 
ušt64_t
 
v®
)

308 
p
 = 
as_commªd_wr™e_f›ld_h—d”
Õ, 
id
, (
ušt64_t
));

309 *(
ušt64_t
*)
p
 = 
cf_sw­_to_be64
(
v®
);

310  
p
 + (
ušt64_t
);

317 
šlše
 
ušt8_t
*

318 
as_commªd_wr™e_f›ld_bufãr
(
ušt8_t
* 
p
, ušt8_ˆ
id
, 
as_bufãr
* 
bufãr
)

320 
p
 = 
as_commªd_wr™e_f›ld_h—d”
Õ, 
id
, 
bufãr
->
size
);

321 
memıy
(
p
, 
bufãr
->
d©a
, bufãr->
size
);

322  
p
 + 
bufãr
->
size
;

329 
šlše
 
ušt8_t
*

330 
as_commªd_wr™e_f›ld_dige¡
(
ušt8_t
* 
p
, cÚ¡ 
as_dige¡
* 
v®
)

332 
p
 = 
as_commªd_wr™e_f›ld_h—d”
Õ, 
AS_FIELD_DIGEST
, 
AS_DIGEST_VALUE_SIZE
);

333 
memıy
(
p
, 
v®
->
v®ue
, 
AS_DIGEST_VALUE_SIZE
);

334  
p
 + 
AS_DIGEST_VALUE_SIZE
;

341 
ušt8_t
*

342 
as_commªd_wr™e_key
(
ušt8_t
* 
p
, 
as_pŞicy_key
 
pŞicy
, cÚ¡ 
as_key
* 
key
);

348 
šlše
 
ušt8_t
*

349 
as_commªd_wr™e_bš_Çme
(
ušt8_t
* 
cmd
, cÚ¡ * 
Çme
)

351 
ušt8_t
* 
p
 = 
cmd
 + 
AS_OPERATION_HEADER_SIZE
;

354 *
Çme
) {

355 *
p
++ = *
Çme
++;

357 
ušt8_t
 
Çme_Ën
 = 
p
 - 
cmd
 - 
AS_OPERATION_HEADER_SIZE
;

358 *(
ušt32_t
*)
cmd
 = 
cf_sw­_to_be32
((ušt32_t)
Çme_Ën
 + 4);

359 
cmd
 += 4;

360 *
cmd
++ = 
AS_OPERATOR_READ
;

361 *
cmd
++ = 0;

362 *
cmd
++ = 0;

363 *
cmd
++ = 
Çme_Ën
;

364  
p
;

371 
ušt8_t
*

372 
as_commªd_wr™e_bš
(
ušt8_t
* 
begš
, ušt8_ˆ
İ”©iÚ_ty³
, cÚ¡ 
as_bš
* 
bš
, 
as_bufãr
* 
bufãr
);

378 
šlše
 
size_t


379 
as_commªd_wr™e_’d
(
ušt8_t
* 
begš
, ušt8_t* 
’d
)

381 
ušt64_t
 
Ën
 = 
’d
 - 
begš
;

382 
ušt64_t
 
´Ùo
 = (
Ën
 - 8è| (
AS_MESSAGE_VERSION
 << 56è| (
AS_MESSAGE_TYPE
 << 48);

383 *(
ušt64_t
*)
begš
 = 
cf_sw­_to_be64
(
´Ùo
);

384  
Ën
;

391 
šlše
 
size_t


392 
as_commªd_com´ess_wr™e_’d
(
ušt8_t
* 
begš
, ušt8_t* 
’d
, 
ušt64_t
 
uncom´es£d_sz
)

394 
ušt64_t
 
Ën
 = 
’d
 - 
begš
;

395 
ušt64_t
 
´Ùo
 = (
Ën
 - 8è| (
AS_MESSAGE_VERSION
 << 56è| (
AS_COMPRESSED_MESSAGE_TYPE
 << 48);

396 *(
ušt64_t
*)
begš
 = 
cf_sw­_to_be64
(
´Ùo
);

400 ((
as_com´es£d_´Ùo
 *)
begš
)->
uncom´es£d_sz
 = uncompressed_sz;

402  
Ën
;

409 
size_t


410 
as_commªd_com´ess_max_size
(
size_t
 
cmd_sz
);

416 
as_¡©us


417 
as_commªd_com´ess
(
as_”rÜ
* 
”r
, 
ušt8_t
* 
cmd
, 
size_t
 
cmd_sz
, ušt8_t* 
com´es£d_cmd
, size_t* 
com´es£d_size
);

423 
as_¡©us


424 
as_commªd_execu‹
(

425 
as_şu¡”
* 
şu¡”
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_ba£
* 
pŞicy
, 
as_commªd_node
* 
ú
,

426 
ušt8_t
* 
commªd
, 
size_t
 
commªd_Ën
, 
as_·r£_»suÉs_â
 
·r£_»suÉs_â
, * 
·r£_»suÉs_d©a
,

427 
boŞ
 
is_»ad


434 
as_¡©us


435 
as_commªd_·r£_h—d”
(
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node
* 
node
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše_ms
, * 
u£r_d©a
);

441 
as_¡©us


442 
as_commªd_·r£_»suÉ
(
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node
* 
node
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše_ms
, * 
u£r_d©a
);

448 
as_¡©us


449 
as_commªd_·r£_sucûss_çu»
(
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node
* 
node
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše_ms
, * 
u£r_d©a
);

455 
as_¡©us


456 
as_commªd_·r£_sucûss_çu»_bšs
(
ušt8_t
** 
µ
, 
as_”rÜ
* 
”r
, 
as_msg
* 
msg
, 
as_v®
** 
v®ue
);

462 
as_¡©us


463 
as_commªd_·r£_bšs
(
ušt8_t
** 
µ
, 
as_”rÜ
* 
”r
, 
as_»cÜd
* 
»c
, 
ušt32_t
 
n_bšs
, 
boŞ
 
de£rŸlize
);

469 
as_¡©us


470 
as_commªd_·r£_udf_çu»
(
ušt8_t
* 
p
, 
as_”rÜ
* 
”r
, 
as_msg
* 
msg
, 
as_¡©us
 
¡©us
);

476 
ušt8_t
*

477 
as_commªd_ignÜe_f›lds
(
ušt8_t
* 
p
, 
ušt32_t
 
n_f›lds
);

483 
ušt8_t
*

484 
as_commªd_ignÜe_bšs
(
ušt8_t
* 
p
, 
ušt32_t
 
n_bšs
);

490 
ušt8_t
*

491 
as_commªd_·r£_key
(
ušt8_t
* 
p
, 
ušt32_t
 
n_f›lds
, 
as_key
* 
key
);

493 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_config.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_”rÜ.h
>

20 
	~<«ro¥ike/as_ho¡.h
>

21 
	~<«ro¥ike/as_pŞicy.h
>

22 
	~<«ro¥ike/as_·sswÜd.h
>

23 
	~<«ro¥ike/as_veùÜ.h
>

25 #ifdeà
__ılu¥lus


33 #ifdeà
__lšux__


37 
	#AS_CONFIG_LUA_SYSTEM_PATH
 "/İt/«ro¥ike/ş›Á/sys/udf/lua"

	)

42 
	#AS_CONFIG_LUA_USER_PATH
 "/İt/«ro¥ike/ş›Á/u¤/udf/lua"

	)

45 #ifdeà
__APPLE__


49 
	#AS_CONFIG_LUA_SYSTEM_PATH
 "/u¤/loÿl/«ro¥ike/ş›Á/sys/udf/lua"

	)

54 
	#AS_CONFIG_LUA_USER_PATH
 "/u¤/loÿl/«ro¥ike/ş›Á/u¤/udf/lua"

	)

60 
	#AS_CONFIG_PATH_MAX_SIZE
 256

	)

65 
	#AS_CONFIG_PATH_MAX_LEN
 (
AS_CONFIG_PATH_MAX_SIZE
 - 1)

	)

76 
	sas_addr_m­_s
 {

81 * 
Üig
;

86 * 
®t
;

88 } 
	tas_addr_m­
;

95 
	eas_şu¡”_ev’t_ty³_e
 {

99 
AS_CLUSTER_ADD_NODE
 = 0,

104 
AS_CLUSTER_REMOVE_NODE
 = 1,

109 
AS_CLUSTER_DISCONNECTED
 = 2

110 } 
	tas_şu¡”_ev’t_ty³
;

117 
	sas_şu¡”_ev’t_s
 {

121 cÚ¡ * 
node_Çme
;

126 cÚ¡ * 
node_add»ss
;

131 * 
ud©a
;

136 
as_şu¡”_ev’t_ty³
 
ty³
;

137 } 
	tas_şu¡”_ev’t
;

146 (*
as_şu¡”_ev’t_ÿÎback
è(
	tas_şu¡”_ev’t
* 
	tev’t
);

153 
	sas_cÚfig_lua_s
 {

159 
boŞ
 
ÿche_’abËd
;

166 
sy¡em_·th
[
AS_CONFIG_PATH_MAX_SIZE
];

172 
u£r_·th
[
AS_CONFIG_PATH_MAX_SIZE
];

174 } 
	tas_cÚfig_lua
;

181 
	sas_cÚfig_s_s
 {

187 
boŞ
 
’abË
;

193 
boŞ
 
’üy±_Úly
;

200 * 
ÿfe
;

208 * 
ÿ·th
;

223 * 
´ÙocŞs
;

239 * 
ch”_su™e
;

246 
boŞ
 
ül_check
;

253 
boŞ
 
ül_check_®l
;

267 * 
û¹_bÏckli¡
;

272 
boŞ
 
log_£ssiÚ_šfo
;

280 * 
keyfe
;

288 * 
û¹fe
;

290 } 
	tas_cÚfig_s
;

396 
	sas_cÚfig_s
 {

401 
as_veùÜ
* 
ho¡s
;

406 
u£r
[
AS_USER_SIZE
];

412 
·sswÜd
[
AS_PASSWORD_HASH_SIZE
];

420 * 
şu¡”_Çme
;

427 
as_şu¡”_ev’t_ÿÎback
 
ev’t_ÿÎback
;

434 * 
ev’t_ÿÎback_ud©a
;

447 
as_addr_m­
* 
_m­
;

453 
ušt32_t
 
_m­_size
;

466 
ušt32_t
 
max_cÚns_³r_node
;

476 
ušt32_t
 
async_max_cÚns_³r_node
;

486 
ušt32_t
 
pe_max_cÚns_³r_node
;

497 
ušt32_t
 
cÚn_poŞs_³r_node
;

504 
ušt32_t
 
cÚn_timeout_ms
;

516 
ušt32_t
 
max_sock‘_idË
;

522 
ušt32_t
 
‹nd”_š‹rv®
;

535 
ušt32_t
 
th»ad_poŞ_size
;

540 
as_pŞic›s
 
pŞic›s
;

564 
as_cÚfig_lua
 
lua
;

569 
as_cÚfig_s
 
s
;

580 
boŞ
 
ç_if_nÙ_cÚÃùed
;

586 
boŞ
 
u£_£rviûs_®‹º©e
;

598 
boŞ
 
u£_shm
;

607 
shm_key
;

615 
ušt32_t
 
shm_max_nodes
;

623 
ušt32_t
 
shm_max_Çme¥aûs
;

630 
ušt32_t
 
shm_keov”_th»shŞd_£c
;

631 } 
	tas_cÚfig
;

651 
as_cÚfig
*

652 
as_cÚfig_š™
(
as_cÚfig
* 
cÚfig
);

675 
boŞ


676 
as_cÚfig_add_ho¡s
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
¡ršg
, 
ušt16_t
 
deçuÉ_pÜt
);

692 
as_cÚfig_add_ho¡
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
add»ss
, 
ušt16_t
 
pÜt
);

700 
as_cÚfig_ş—r_ho¡s
(
as_cÚfig
* 
cÚfig
);

714 
boŞ


715 
as_cÚfig_£t_u£r
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
u£r
, cÚ¡ * 
·sswÜd
);

721 
as_cÚfig_£t_¡ršg
(** 
¡r
, cÚ¡ * 
v®ue
);

728 
šlše
 

729 
as_cÚfig_£t_şu¡”_Çme
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
şu¡”_Çme
)

731 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
şu¡”_Çme
, cluster_name);

739 
šlše
 

740 
as_cÚfig_£t_şu¡”_ev’t_ÿÎback
(
as_cÚfig
* 
cÚfig
, 
as_şu¡”_ev’t_ÿÎback
 
ÿÎback
, * 
ud©a
)

742 
cÚfig
->
ev’t_ÿÎback
 = 
ÿÎback
;

743 
cÚfig
->
ev’t_ÿÎback_ud©a
 = 
ud©a
;

751 
šlše
 

752 
as_cÚfig_lua_š™
(
as_cÚfig_lua
* 
lua
)

754 
lua
->
ÿche_’abËd
 = 
çl£
;

755 
¡rıy
(
lua
->
sy¡em_·th
, 
AS_CONFIG_LUA_SYSTEM_PATH
);

756 
¡rıy
(
lua
->
u£r_·th
, 
AS_CONFIG_LUA_USER_PATH
);

764 
šlše
 

765 
as_cÚfig_s_£t_ÿfe
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
ÿfe
)

767 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
ÿfe
, cafile);

775 
šlše
 

776 
as_cÚfig_s_£t_ÿ·th
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
ÿ·th
)

778 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
ÿ·th
, capath);

786 
šlše
 

787 
as_cÚfig_s_£t_´ÙocŞs
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
´ÙocŞs
)

789 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
´ÙocŞs
,…rotocols);

797 
šlše
 

798 
as_cÚfig_s_£t_ch”_su™e
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
ch”_su™e
)

800 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
ch”_su™e
, cipher_suite);

808 
šlše
 

809 
as_cÚfig_s_£t_û¹_bÏckli¡
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
û¹_bÏckli¡
)

811 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
û¹_bÏckli¡
, cert_blacklist);

819 
šlše
 

820 
as_cÚfig_s_£t_keyfe
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
keyfe
)

822 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
keyfe
, keyfile);

830 
šlše
 

831 
as_cÚfig_s_£t_û¹fe
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
û¹fe
)

833 
as_cÚfig_£t_¡ršg
(&
cÚfig
->
s
.
û¹fe
, certfile);

850 
as_cÚfig_s_add_ho¡
(
as_cÚfig
* 
cÚfig
, cÚ¡ * 
add»ss
, cÚ¡ * 
s_Çme
, 
ušt16_t
 
pÜt
);

852 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_double.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_ut.h
>

20 
	~<«ro¥ike/as_v®.h
>

22 #ifdeà
__ılu¥lus


98 
	sas_doubË_s
 {

104 
as_v®
 
_
;

109 
v®ue
;

111 } 
	tas_doubË
;

139 
as_doubË
*

140 
as_doubË_š™
(
as_doubË
* 
v®ue_±r
, 
v®ue
);

162 
as_doubË
*

163 
as_doubË_Ãw
(
v®ue
);

176 
šlše
 

177 
as_doubË_de¡roy
(
as_doubË
* 
v®ue
)

179 
as_v®_de¡roy
((
as_v®
*)
v®ue
);

191 
šlše
 

192 
as_doubË_g‘Ü–£
(cÚ¡ 
as_doubË
* 
v®ue
, 
çÎback
)

194  
v®ue
 ? v®ue->v®u: 
çÎback
;

202 
šlše
 

203 
as_doubË_g‘
(cÚ¡ 
as_doubË
* 
v®ue
)

205  
as_doubË_g‘Ü–£
(
v®ue
, 0.0);

217 
šlše
 
as_v®
*

218 
as_doubË_tov®
(cÚ¡ 
as_doubË
* 
v®ue
)

220  (
as_v®
*)
v®ue
;

228 
šlše
 
as_doubË
*

229 
as_doubË_äomv®
(cÚ¡ 
as_v®
* 
v®ue
)

231  
as_ut_äomv®
(
v®ue
, 
AS_DOUBLE
, 
as_doubË
);

243 
as_doubË_v®_de¡roy
(
as_v®
* 
v®ue
);

249 
ušt32_t


250 
as_doubË_v®_hashcode
(cÚ¡ 
as_v®
* 
v®ue
);

257 
as_doubË_v®_to¡ršg
(cÚ¡ 
as_v®
* 
v®ue
);

259 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_error.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_¡©us.h
>

20 
	~<«ro¥ike/as_¡ršg.h
>

22 
	~<¡d¬g.h
>

23 
	~<¡dšt.h
>

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

27 #ifdeà
__ılu¥lus


40 
	#AS_ERROR_MESSAGE_MAX_SIZE
 1024

	)

47 
	#AS_ERROR_MESSAGE_MAX_LEN
 (
AS_ERROR_MESSAGE_MAX_SIZE
 - 1)

	)

97 
	sas_”rÜ_s
 {

102 
as_¡©us
 
code
;

107 
mes§ge
[
AS_ERROR_MESSAGE_MAX_SIZE
];

112 cÚ¡ * 
func
;

117 cÚ¡ * 
fe
;

122 
ušt32_t
 
lše
;

124 } 
	tas_”rÜ
;

135 
	#as_”rÜ_upd©e
(
__”r
, 
__code
, 
__fmt
, ...) \

136 
	`as_”rÜ_£Îv
Ğ
__”r
, 
__code
, 
__func__
, 
__FILE__
, 
__LINE__
, 
__fmt
, ##
__VA_ARGS__
 );

	)

143 
	#as_”rÜ_£t_mes§ge
(
__”r
, 
__code
, 
__msg
) \

144 
	`as_”rÜ_£Î
Ğ
__”r
, 
__code
, 
__msg
, 
__func__
, 
__FILE__
, 
__LINE__
 );

	)

160 
šlše
 
as_”rÜ
 * 
as_”rÜ_š™
×s_”rÜ * 
”r
) {

161 
”r
->
code
 = 
AEROSPIKE_OK
;

162 
”r
->
mes§ge
[0] = '\0';

163 
”r
->
func
 = 
NULL
;

164 
”r
->
fe
 = 
NULL
;

165 
”r
->
lše
 = 0;

166  
”r
;

179 
šlše
 
as_¡©us
 
as_”rÜ_»£t
(
as_”rÜ
 * 
”r
) {

180 
”r
->
code
 = 
AEROSPIKE_OK
;

181 
”r
->
mes§ge
[0] = '\0';

182 
”r
->
func
 = 
NULL
;

183 
”r
->
fe
 = 
NULL
;

184 
”r
->
lše
 = 0;

185  
”r
->
code
;

195 
šlše
 
as_¡©us
 
as_”rÜ_£Î
(
as_”rÜ
 * 
”r
,‡s_¡©u 
code
, cÚ¡ * 
mes§ge
, cÚ¡ * 
func
, cÚ¡ * 
fe
, 
ušt32_t
 
lše
) {

196 
”r
->
code
 = code;

197 
as_¡ºıy
(
”r
->
mes§ge
, mes§ge, 
AS_ERROR_MESSAGE_MAX_SIZE
);

198 
”r
->
func
 = func;

199 
”r
->
fe
 = file;

200 
”r
->
lše
 =†ine;

201  
”r
->
code
;

211 
šlše
 
as_¡©us
 
as_”rÜ_£Îv
(
as_”rÜ
 * 
”r
,‡s_¡©u 
code
, cÚ¡ * 
func
, cÚ¡ * 
fe
, 
ušt32_t
 
lše
, cÚ¡ * 
fmt
, ...) {

212 iàĞ
fmt
 !ğ
NULL
 ) {

213 
va_li¡
 
­
;

214 
va_¡¬t
(
­
, 
fmt
);

215 
v¢´štf
(
”r
->
mes§ge
, 
AS_ERROR_MESSAGE_MAX_LEN
, 
fmt
, 
­
);

216 
”r
->
mes§ge
[
AS_ERROR_MESSAGE_MAX_LEN
] = '\0';

217 
va_’d
(
­
);

219 
”r
->
code
 = code;

220 
”r
->
func
 = func;

221 
”r
->
fe
 = file;

222 
”r
->
lše
 =†ine;

223  
”r
->
code
;

231 
šlše
 
as_¡©us
 
as_”rÜ_£t
(
as_”rÜ
 * 
”r
,‡s_¡©u 
code
, cÚ¡ * 
fmt
, ...) {

232 iàĞ
fmt
 !ğ
NULL
 ) {

233 
va_li¡
 
­
;

234 
va_¡¬t
(
­
, 
fmt
);

235 
v¢´štf
(
”r
->
mes§ge
, 
AS_ERROR_MESSAGE_MAX_LEN
, 
fmt
, 
­
);

236 
”r
->
mes§ge
[
AS_ERROR_MESSAGE_MAX_LEN
] = '\0';

237 
va_’d
(
­
);

239 
”r
->
code
 = code;

240  
”r
->
code
;

248 
šlše
 
as_”rÜ_cİy
(
as_”rÜ
 * 
Œg
, cÚ¡‡s_”rÜ * 
¤c
) {

249 
Œg
->
code
 = 
¤c
->code;

250 
¡rıy
(
Œg
->
mes§ge
, 
¤c
->message);

251 
Œg
->
func
 = 
¤c
->func;

252 
Œg
->
fe
 = 
¤c
->file;

253 
Œg
->
lše
 = 
¤c
->line;

262 
as_”rÜ_¡ršg
(
as_¡©us
 
¡©us
);

264 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_event.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_queue.h
>

20 
	~<±h»ad.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dboŞ.h
>

23 
	~<uni¡d.h
>

31 
	#AS_EVENT_LIB_DEFINED
 (
	`defšed
(
AS_USE_LIBEV
è|| defšed(
AS_USE_LIBUV
è|| defšed(
AS_USE_LIBEVENT
))

	)

33 #ià
defšed
(
AS_USE_LIBEV
)

34 
	~<ev.h
>

35 #–ià
defšed
(
AS_USE_LIBUV
)

36 
	~<uv.h
>

37 #–ià
defšed
(
AS_USE_LIBEVENT
)

38 
	~<ev’t2/ev’t_¡ruù.h
>

42 #ifdeà
__ılu¥lus


56 
	sas_ev’t_loİ
 {

57 #ià
defšed
(
AS_USE_LIBEV
)

58 
ev_loİ
* 
loİ
;

59 
ev_async
 
wakeup
;

60 #–ià
defšed
(
AS_USE_LIBUV
)

61 
uv_loİ_t
* 
loİ
;

62 
uv_async_t
* 
wakeup
;

63 #–ià
defšed
(
AS_USE_LIBEVENT
)

64 
ev’t_ba£
* 
loİ
;

65 
ev’t
 
wakeup
;

67 * 
loİ
;

70 
as_ev’t_loİ
* 
Ãxt
;

71 
±h»ad_mu‹x_t
 
lock
;

72 
as_queue
 
queue
;

73 
as_queue
 
pe_cb_queue
;

74 
±h»ad_t
 
th»ad
;

75 
ušt32_t
 
šdex
;

78 
ušt32_t
 
”rÜs
;

79 
boŞ
 
pe_cb_ÿÎšg
;

80 } 
	tas_ev’t_loİ
;

86 
as_ev’t_loİ
* 
as_ev’t_loİs
;

87 
as_ev’t_loİ
* 
as_ev’t_loİ_cu¼’t
;

88 
ušt32_t
 
as_ev’t_loİ_size
;

104 
as_ev’t_loİ
*

105 
as_ev’t_ü—‹_loİs
(
ušt32_t
 
ÿ·c™y
);

146 
boŞ


147 
as_ev’t_£t_ex‹º®_loİ_ÿ·c™y
(
ušt32_t
 
ÿ·c™y
);

191 
as_ev’t_loİ
*

192 
as_ev’t_£t_ex‹º®_loİ
(* 
loİ
);

203 
as_ev’t_loİ
*

204 
as_ev’t_loİ_fšd
(* 
loİ
);

214 
šlše
 
as_ev’t_loİ
*

215 
as_ev’t_loİ_g‘_by_šdex
(
ušt32_t
 
šdex
)

217  
	gšdex
 < 
	gas_ev’t_loİ_size
 ? &
	gas_ev’t_loİs
[
šdex
] : 
NULL
;

227 
šlše
 
as_ev’t_loİ
*

228 
as_ev’t_loİ_g‘
()

232 
as_ev’t_loİ
* 
	gev’t_loİ
 = 
as_ev’t_loİ_cu¼’t
;

233 
	gas_ev’t_loİ_cu¼’t
 = 
ev’t_loİ
->
Ãxt
;

234  
	gev’t_loİ
;

263 
boŞ


264 
as_ev’t_şo£_loİs
();

273 
as_ev’t_de¡roy_loİs
();

275 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_event_internal.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_admš.h
>

20 
	~<«ro¥ike/as_şu¡”.h
>

21 
	~<«ro¥ike/as_li¡’”.h
>

22 
	~<«ro¥ike/as_queue.h
>

23 
	~<«ro¥ike/as_´Ùo.h
>

24 
	~<«ro¥ike/as_sock‘.h
>

25 
	~<c™ru¦—f/cf_Î.h
>

26 
	~<±h»ad.h
>

27 
	~<¡dšt.h
>

28 
	~<¡dboŞ.h
>

29 
	~<uni¡d.h
>

31 #ià
defšed
(
AS_USE_LIBEV
)

32 
	~<ev.h
>

33 #–ià
defšed
(
AS_USE_LIBUV
)

34 
	~<uv.h
>

35 #–ià
defšed
(
AS_USE_LIBEVENT
)

36 
	~<ev’t2/ev’t.h
>

40 #ifdeà
__ılu¥lus


48 
	#AS_ASYNC_STATE_UNREGISTERED
 0

	)

49 
	#AS_ASYNC_STATE_REGISTERED
 1

	)

50 
	#AS_ASYNC_STATE_TLS_CONNECT
 2

	)

51 
	#AS_ASYNC_STATE_AUTH_WRITE
 3

	)

52 
	#AS_ASYNC_STATE_AUTH_READ_HEADER
 4

	)

53 
	#AS_ASYNC_STATE_AUTH_READ_BODY
 5

	)

54 
	#AS_ASYNC_STATE_COMMAND_WRITE
 6

	)

55 
	#AS_ASYNC_STATE_COMMAND_READ_HEADER
 7

	)

56 
	#AS_ASYNC_STATE_COMMAND_READ_BODY
 8

	)

57 
	#AS_ASYNC_STATE_COMPLETE
 9

	)

59 
	#AS_ASYNC_FLAGS_MASTER
 1

	)

60 
	#AS_ASYNC_FLAGS_READ
 2

	)

61 
	#AS_ASYNC_FLAGS_HAS_TIMER
 4

	)

62 
	#AS_ASYNC_FLAGS_USING_SOCKET_TIMER
 8

	)

63 
	#AS_ASYNC_FLAGS_EVENT_RECEIVED
 16

	)

64 
	#AS_ASYNC_FLAGS_FREE_BUF
 32

	)

65 
	#AS_ASYNC_FLAGS_CP_MODE
 64

	)

67 
	#AS_ASYNC_AUTH_RETURN_CODE
 1

	)

69 
	#AS_EVENT_CONNECTION_COMPLETE
 0

	)

70 
	#AS_EVENT_CONNECTION_PENDING
 1

	)

71 
	#AS_EVENT_CONNECTION_ERROR
 2

	)

73 
	#AS_EVENT_QUEUE_INITIAL_CAPACITY
 256

	)

75 
as_ev’t_commªd
;

76 
as_ev’t_executÜ
;

79 #ià
defšed
(
AS_USE_LIBEV
)

80 
ev_io
 
w©ch”
;

81 
as_sock‘
 
sock‘
;

82 #–ià
defšed
(
AS_USE_LIBUV
)

83 
uv_tı_t
 
sock‘
;

86 
uv_cÚÃù_t
 
cÚÃù
;

87 
uv_wr™e_t
 
wr™e
;

88 } 
»q
;

89 #–ià
defšed
(
AS_USE_LIBEVENT
)

90 
ev’t
 
w©ch”
;

91 
as_sock‘
 
sock‘
;

94 
w©chšg
;

95 
boŞ
 
p–še
;

96 } 
	tas_ev’t_cÚÃùiÚ
;

99 
as_ev’t_cÚÃùiÚ
 
ba£
;

100 
as_ev’t_commªd
* 
cmd
;

101 } 
	tas_async_cÚÃùiÚ
;

104 
as_pe_li¡’”
 
li¡’”
;

105 * 
ud©a
;

106 } 
	tas_queued_pe_cb
;

108 (*
as_ev’t_execubË
è(* 
	tud©a
);

109 
boŞ
 (*
	tas_ev’t_·r£_»suÉs_â
è(
	tas_ev’t_commªd
* 
	tcmd
);

110 (*
as_ev’t_executÜ_com¶‘e_â
è(
	tas_ev’t_executÜ
* 
	texecutÜ
);

111 (*
as_ev’t_executÜ_de¡roy_â
è(
	tas_ev’t_executÜ
* 
	texecutÜ
);

113 
	sas_ev’t_commªd
 {

114 #ià
defšed
(
AS_USE_LIBEV
)

115 
ev_tim”
 
tim”
;

116 #–ià
defšed
(
AS_USE_LIBUV
)

117 
uv_tim”_t
 
tim”
;

118 #–ià
defšed
(
AS_USE_LIBEVENT
)

119 
ev’t
 
tim”
;

122 
ušt64_t
 
tÙ®_d—dlše
;

123 
ušt32_t
 
sock‘_timeout
;

124 
ušt32_t
 
max_»Œ›s
;

125 
ušt32_t
 
™”©iÚ
;

126 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

127 
as_ev’t_loİ
* 
ev’t_loİ
;

128 
as_ev’t_cÚÃùiÚ
* 
cÚn
;

129 
as_şu¡”
* 
şu¡”
;

130 
as_node
* 
node
;

131 * 
·¹™iÚ
;

132 * 
ud©a
;

133 
as_ev’t_·r£_»suÉs_â
 
·r£_»suÉs
;

134 
as_pe_li¡’”
 
pe_li¡’”
;

135 
cf_Î_–em’t
 
pe_lšk
;

137 
ušt8_t
* 
buf
;

138 
ušt32_t
 
wr™e_off£t
;

139 
ušt32_t
 
wr™e_Ën
;

140 
ušt32_t
 
»ad_ÿ·c™y
;

141 
ušt32_t
 
Ën
;

142 
ušt32_t
 
pos
;

144 
ušt8_t
 
ty³
;

145 
ušt8_t
 
¡©e
;

146 
ušt8_t
 
æags
;

147 
boŞ
 
de£rŸlize
;

148 } 
	tas_ev’t_commªd
;

151 
as_ev’t_execubË
 
execubË
;

152 * 
ud©a
;

153 } 
	tas_ev’t_commªd”
;

155 
	sas_ev’t_executÜ
 {

156 
±h»ad_mu‹x_t
 
lock
;

157 
as_ev’t_commªd
** 
commªds
;

158 
as_ev’t_loİ
* 
ev’t_loİ
;

159 
as_ev’t_executÜ_com¶‘e_â
 
com¶‘e_â
;

160 * 
ud©a
;

161 
as_”rÜ
* 
”r
;

162 
ušt32_t
 
max_cÚcu¼’t
;

163 
ušt32_t
 
max
;

164 
ušt32_t
 
couÁ
;

165 
boŞ
 
nÙify
;

166 
boŞ
 
v®id
;

167 } 
	tas_ev’t_executÜ
;

173 
as_¡©us


174 
as_ev’t_commªd_execu‹
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
);

177 
as_ev’t_sock‘_timeout
(
as_ev’t_commªd
* 
cmd
);

180 
as_ev’t_tÙ®_timeout
(
as_ev’t_commªd
* 
cmd
);

182 
boŞ


183 
as_ev’t_commªd_»Œy
(
as_ev’t_commªd
* 
cmd
, 
boŞ
 
®‹º©e
);

186 
as_ev’t_executÜ_com¶‘e
(
as_ev’t_commªd
* 
cmd
);

189 
as_ev’t_executÜ_ÿnûl
(
as_ev’t_executÜ
* 
executÜ
, 
queued_couÁ
);

192 
as_ev’t_”rÜ_ÿÎback
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
);

195 
as_ev’t_·r£_”rÜ
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
);

198 
as_ev’t_sock‘_”rÜ
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
);

201 
as_ev’t_»¥Ú£_”rÜ
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
);

203 
boŞ


204 
as_ev’t_commªd_·r£_»suÉ
(
as_ev’t_commªd
* 
cmd
);

206 
boŞ


207 
as_ev’t_commªd_·r£_h—d”
(
as_ev’t_commªd
* 
cmd
);

209 
boŞ


210 
as_ev’t_commªd_·r£_sucûss_çu»
(
as_ev’t_commªd
* 
cmd
);

213 
as_ev’t_commªd_ä“
(
as_ev’t_commªd
* 
cmd
);

216 
as_ev’t_şo£_şu¡”
(
as_şu¡”
* 
şu¡”
);

222 
boŞ


223 
as_ev’t_ü—‹_loİ
(
as_ev’t_loİ
* 
ev’t_loİ
);

226 
as_ev’t_»gi¡”_ex‹º®_loİ
(
as_ev’t_loİ
* 
ev’t_loİ
);

232 
boŞ


233 
as_ev’t_execu‹
(
as_ev’t_loİ
* 
ev’t_loİ
, 
as_ev’t_execubË
 
execubË
, * 
ud©a
);

236 
as_ev’t_commªd_wr™e_¡¬t
(
as_ev’t_commªd
* 
cmd
);

239 
as_ev’t_cÚÃù
(
as_ev’t_commªd
* 
cmd
);

242 
as_ev’t_şo£_cÚÃùiÚ
(
as_ev’t_cÚÃùiÚ
* 
cÚn
);

245 
as_ev’t_node_de¡roy
(
as_node
* 
node
);

251 #ià
defšed
(
AS_USE_LIBEV
)

253 
as_ev_sock‘_timeout
(
ev_loİ
* 
loİ
, 
ev_tim”
* 
tim”
, 
»v’ts
);

254 
as_ev_tÙ®_timeout
(
ev_loİ
* 
loİ
, 
ev_tim”
* 
tim”
, 
»v’ts
);

256 
šlše
 

257 
as_ev’t_v®id©e_cÚÃùiÚ
(
as_ev’t_cÚÃùiÚ
* 
cÚn
)

259  
as_sock‘_v®id©e
(&
cÚn
->
sock‘
);

262 
šlše
 

263 
as_ev’t_£t_cÚn_Ï¡_u£d
(
as_ev’t_cÚÃùiÚ
* 
cÚn
, 
ušt32_t
 
max_sock‘_idË
)

266 ià(
max_sock‘_idË
 =ğ0 && 
cÚn
->
sock‘
.
ùx
) {

267 
max_sock‘_idË
 = 55;

270 ià(
max_sock‘_idË
 > 0) {

271 
cÚn
->
sock‘
.
idË_check
.
max_sock‘_idË
 = max_socket_idle;

272 
cÚn
->
sock‘
.
idË_check
.
Ï¡_u£d
 = (
ušt32_t
)
cf_g‘_£cÚds
();

275 
cÚn
->
sock‘
.
idË_check
.
max_sock‘_idË
 = cÚn->sock‘.idË_check.
Ï¡_u£d
 = 0;

279 
šlše
 

280 
as_ev’t_š™_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

282 
ev_tim”_š™
(&
cmd
->
tim”
, 
as_ev_tÙ®_timeout
, ()
timeout
 / 1000.0, 0.0);

283 
cmd
->
tim”
.
d©a
 = cmd;

284 
ev_tim”_¡¬t
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

287 
šlše
 

288 
as_ev’t_£t_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

290 
ev_tim”_¡¬t
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

293 
šlše
 

294 
as_ev’t_š™_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

296 
ev_š™
(&
cmd
->
tim”
, 
as_ev_sock‘_timeout
);

297 
cmd
->
tim”
.
»³©
 = (()cmd->
sock‘_timeout
) / 1000.0;

298 
cmd
->
tim”
.
d©a
 = cmd;

299 
ev_tim”_agaš
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

302 
šlše
 

303 
as_ev’t_»³©_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

305 
cmd
->
tim”
.
»³©
 = ()cmd->
sock‘_timeout
/ 1000.0;

306 
ev_tim”_agaš
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

309 
šlše
 

310 
as_ev’t_¡İ_tim”
(
as_ev’t_commªd
* 
cmd
)

312 
ev_tim”_¡İ
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

315 
šlše
 

316 
as_ev’t_¡İ_w©ch”
(
as_ev’t_commªd
* 
cmd
, 
as_ev’t_cÚÃùiÚ
* 
cÚn
)

318 
ev_io_¡İ
(
cmd
->
ev’t_loİ
->
loİ
, &
cÚn
->
w©ch”
);

321 
šlše
 

322 
as_ev’t_commªd_»Ëa£
(
as_ev’t_commªd
* 
cmd
)

324 
as_ev’t_commªd_ä“
(
cmd
);

331 #–ià
defšed
(
AS_USE_LIBUV
)

333 
as_uv_tÙ®_timeout
(
uv_tim”_t
* 
tim”
);

334 
as_uv_sock‘_timeout
(
uv_tim”_t
* 
tim”
);

336 
šlše
 

337 
as_ev’t_v®id©e_cÚÃùiÚ
(
as_ev’t_cÚÃùiÚ
* 
cÚn
)

340 
uv_os_fd_t
 
fd
;

342 ià(
uv_f’o
((
uv_hªdË_t
*)&
cÚn
->
sock‘
, &
fd
) == 0) {

343  
as_sock‘_v®id©e_fd
(
fd
);

345  
çl£
;

348 
šlše
 

349 
as_ev’t_£t_cÚn_Ï¡_u£d
(
as_ev’t_cÚÃùiÚ
* 
cÚn
, 
ušt32_t
 
max_sock‘_idË
)

353 
šlše
 

354 
as_ev’t_š™_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

356 
uv_tim”_š™
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

357 
cmd
->
tim”
.
d©a
 = cmd;

358 
uv_tim”_¡¬t
(&
cmd
->
tim”
, 
as_uv_tÙ®_timeout
, 
timeout
, 0);

361 
šlše
 

362 
as_ev’t_£t_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

364 
uv_tim”_¡¬t
(&
cmd
->
tim”
, 
as_uv_tÙ®_timeout
, 
timeout
, 0);

367 
šlše
 

368 
as_ev’t_š™_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

370 
uv_tim”_š™
(
cmd
->
ev’t_loİ
->
loİ
, &cmd->
tim”
);

371 
cmd
->
tim”
.
d©a
 = cmd;

372 
uv_tim”_¡¬t
(&
cmd
->
tim”
, 
as_uv_sock‘_timeout
, cmd->
sock‘_timeout
, cmd->socket_timeout);

375 
šlše
 

376 
as_ev’t_»³©_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

378 
uv_tim”_agaš
(&
cmd
->
tim”
);

381 
šlše
 

382 
as_ev’t_¡İ_tim”
(
as_ev’t_commªd
* 
cmd
)

384 
uv_tim”_¡İ
(&
cmd
->
tim”
);

387 
šlše
 

388 
as_ev’t_¡İ_w©ch”
(
as_ev’t_commªd
* 
cmd
, 
as_ev’t_cÚÃùiÚ
* 
cÚn
)

394 
as_uv_tim”_şo£d
(
uv_hªdË_t
* 
hªdË
);

396 
šlše
 

397 
as_ev’t_commªd_»Ëa£
(
as_ev’t_commªd
* 
cmd
)

399 ià(
cmd
->
æags
 & 
AS_ASYNC_FLAGS_HAS_TIMER
) {

401 
uv_şo£
((
uv_hªdË_t
*)&
cmd
->
tim”
, 
as_uv_tim”_şo£d
);

404 
as_ev’t_commªd_ä“
(
cmd
);

412 #–ià
defšed
(
AS_USE_LIBEVENT
)

414 
as_libev’t_sock‘_timeout
(
evut_sock‘_t
 
sock
, 
ev’ts
, * 
ud©a
);

415 
as_libev’t_tÙ®_timeout
(
evut_sock‘_t
 
sock
, 
ev’ts
, * 
ud©a
);

417 
šlše
 

418 
as_ev’t_v®id©e_cÚÃùiÚ
(
as_ev’t_cÚÃùiÚ
* 
cÚn
)

420  
as_sock‘_v®id©e
(&
cÚn
->
sock‘
);

423 
šlše
 

424 
as_ev’t_£t_cÚn_Ï¡_u£d
(
as_ev’t_cÚÃùiÚ
* 
cÚn
, 
ušt32_t
 
max_sock‘_idË
)

427 ià(
max_sock‘_idË
 =ğ0 && 
cÚn
->
sock‘
.
ùx
) {

428 
max_sock‘_idË
 = 55;

431 ià(
max_sock‘_idË
 > 0) {

432 
cÚn
->
sock‘
.
idË_check
.
max_sock‘_idË
 = max_socket_idle;

433 
cÚn
->
sock‘
.
idË_check
.
Ï¡_u£d
 = (
ušt32_t
)
cf_g‘_£cÚds
();

436 
cÚn
->
sock‘
.
idË_check
.
max_sock‘_idË
 = cÚn->sock‘.idË_check.
Ï¡_u£d
 = 0;

440 
šlše
 

441 
as_ev’t_š™_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

443 
evtim”_assign
(&
cmd
->
tim”
, cmd->
ev’t_loİ
->
loİ
, 
as_libev’t_tÙ®_timeout
, cmd);

445 
timev®
 
tv
;

446 
tv
.
tv_£c
 = 
timeout
 / 1000;

447 
tv
.
tv_u£c
 = (
timeout
 % 1000) * 1000;

449 
evtim”_add
(&
cmd
->
tim”
, &
tv
);

452 
šlše
 

453 
as_ev’t_£t_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

455 
timev®
 
tv
;

456 
tv
.
tv_£c
 = 
timeout
 / 1000;

457 
tv
.
tv_u£c
 = (
timeout
 % 1000) * 1000;

459 
evtim”_add
(&
cmd
->
tim”
, &
tv
);

462 
šlše
 

463 
as_ev’t_š™_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

465 
ev’t_assign
(&
cmd
->
tim”
, cmd->
ev’t_loİ
->
loİ
, -1, 
EV_PERSIST
, 
as_libev’t_sock‘_timeout
, cmd);

467 
timev®
 
tv
;

468 
tv
.
tv_£c
 = 
cmd
->
sock‘_timeout
 / 1000;

469 
tv
.
tv_u£c
 = (
cmd
->
sock‘_timeout
 % 1000) * 1000;

471 
evtim”_add
(&
cmd
->
tim”
, &
tv
);

474 
šlše
 

475 
as_ev’t_»³©_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

480 
šlše
 

481 
as_ev’t_¡İ_tim”
(
as_ev’t_commªd
* 
cmd
)

483 
evtim”_d–
(&
cmd
->
tim”
);

486 
šlše
 

487 
as_ev’t_¡İ_w©ch”
(
as_ev’t_commªd
* 
cmd
, 
as_ev’t_cÚÃùiÚ
* 
cÚn
)

489 
ev’t_d–
(&
cÚn
->
w©ch”
);

492 
šlše
 

493 
as_ev’t_commªd_»Ëa£
(
as_ev’t_commªd
* 
cmd
)

495 
as_ev’t_commªd_ä“
(
cmd
);

504 
šlše
 

505 
as_ev’t_v®id©e_cÚÃùiÚ
(
as_ev’t_cÚÃùiÚ
* 
cÚn
)

510 
šlše
 

511 
as_ev’t_£t_cÚn_Ï¡_u£d
(
as_ev’t_cÚÃùiÚ
* 
cÚn
, 
ušt32_t
 
max_sock‘_idË
)

515 
šlše
 

516 
as_ev’t_š™_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

520 
šlše
 

521 
as_ev’t_£t_tÙ®_tim”
(
as_ev’t_commªd
* 
cmd
, 
ušt64_t
 
timeout
)

525 
šlše
 

526 
as_ev’t_š™_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

530 
šlše
 

531 
as_ev’t_»³©_sock‘_tim”
(
as_ev’t_commªd
* 
cmd
)

535 
šlše
 

536 
as_ev’t_¡İ_tim”
(
as_ev’t_commªd
* 
cmd
)

540 
šlše
 

541 
as_ev’t_¡İ_w©ch”
(
as_ev’t_commªd
* 
cmd
, 
as_ev’t_cÚÃùiÚ
* 
cÚn
)

545 
šlše
 

546 
as_ev’t_commªd_»Ëa£
(
as_ev’t_commªd
* 
cmd
)

556 
šlše
 
as_ev’t_loİ
*

557 
as_ev’t_assign
(
as_ev’t_loİ
* 
ev’t_loİ
)

560  
ev’t_loİ
 ?ƒv’t_loİ : 
as_ev’t_loİ_g‘
();

563 
šlše
 

564 
as_ev’t_£t_auth_wr™e
(
as_ev’t_commªd
* 
cmd
)

567 
ušt8_t
* 
buf
 = (ušt8_t*)
cmd
 + cmd->
wr™e_off£t
 + cmd->
wr™e_Ën
;

568 
ušt32_t
 
Ën
 = 
as_auth’tiÿ‹_£t
(
cmd
->
şu¡”
->
u£r
, cmd->şu¡”->
·sswÜd
, 
buf
);

569 
cmd
->
Ën
 = cmd->
wr™e_Ën
 +†en;

570 
cmd
->
pos
 = cmd->
wr™e_Ën
;

573 
šlše
 

574 
as_ev’t_£t_auth_»ad_h—d”
(
as_ev’t_commªd
* 
cmd
)

577 
cmd
->
Ën
 = (
as_´Ùo
);

578 
cmd
->
pos
 = 0;

579 
cmd
->
¡©e
 = 
AS_ASYNC_STATE_AUTH_READ_HEADER
;

582 
šlše
 

583 
as_ev’t_£t_auth_·r£_h—d”
(
as_ev’t_commªd
* 
cmd
)

586 
as_´Ùo
* 
´Ùo
 = (as_´Ùo*)
cmd
->
buf
;

587 
as_´Ùo_sw­_äom_be
(
´Ùo
);

588 
cmd
->
Ën
 = (
ušt32_t
)
´Ùo
->
sz
;

589 
cmd
->
pos
 = 0;

590 
cmd
->
¡©e
 = 
AS_ASYNC_STATE_AUTH_READ_BODY
;

593 
šlše
 

594 
as_ev’t_£t_wr™e
(
as_ev’t_commªd
* 
cmd
)

596 
cmd
->
Ën
 = cmd->
wr™e_Ën
;

597 
cmd
->
pos
 = 0;

600 
šlše
 

601 
as_ev’t_»Ëa£_cÚÃùiÚ
(
as_ev’t_cÚÃùiÚ
* 
cÚn
, 
as_cÚn_poŞ
* 
poŞ
)

603 
as_ev’t_şo£_cÚÃùiÚ
(
cÚn
);

604 
as_cÚn_poŞ_dec
(
poŞ
);

607 
šlše
 

608 
as_ev’t_»Ëa£_async_cÚÃùiÚ
(
as_ev’t_commªd
* 
cmd
)

610 
as_cÚn_poŞ
* 
poŞ
 = &
cmd
->
node
->
async_cÚn_poŞs
[cmd->
ev’t_loİ
->
šdex
];

611 
as_ev’t_»Ëa£_cÚÃùiÚ
(
cmd
->
cÚn
, 
poŞ
);

614 
šlše
 

615 
as_ev’t_deü_cÚn
(
as_ev’t_commªd
* 
cmd
)

617 
as_cÚn_poŞ
* 
poŞ
 = 
cmd
->
pe_li¡’”
 !ğ
NULL
 ?

618 &
cmd
->
node
->
pe_cÚn_poŞs
[cmd->
ev’t_loİ
->
šdex
] :

619 &
cmd
->
node
->
async_cÚn_poŞs
[cmd->
ev’t_loİ
->
šdex
];

621 
as_cÚn_poŞ_dec
(
poŞ
);

624 
šlše
 

625 
as_ev’t_cÚÃùiÚ_timeout
(
as_ev’t_commªd
* 
cmd
, 
as_cÚn_poŞ
* 
poŞ
)

627 
as_ev’t_cÚÃùiÚ
* 
cÚn
 = 
cmd
->conn;

629 ià(
cÚn
->
w©chšg
 > 0) {

630 
as_ev’t_¡İ_w©ch”
(
cmd
, 
cÚn
);

631 
as_ev’t_»Ëa£_cÚÃùiÚ
(
cÚn
, 
poŞ
);

634 
cf_ä“
(
cÚn
);

635 
as_cÚn_poŞ_dec
(
poŞ
);

639 
šlše
 
boŞ


640 
as_ev’t_sock‘_»Œy
(
as_ev’t_commªd
* 
cmd
)

642 ià(
cmd
->
pe_li¡’”
) {

643  
çl£
;

646 
as_ev’t_¡İ_w©ch”
(
cmd
, cmd->
cÚn
);

647 
as_ev’t_»Ëa£_async_cÚÃùiÚ
(
cmd
);

648  
as_ev’t_commªd_»Œy
(
cmd
, 
Œue
);

651 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_geojson.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dboŞ.h
>

24 
	~<¡dšt.h
>

25 
	~<¡ršg.h
>

27 #ifdeà
__ılu¥lus


106 
	sas_geojsÚ_s
 {

113 
as_v®
 
_
;

118 
boŞ
 
ä“
;

123 * 
v®ue
;

128 
size_t
 
Ën
;

130 } 
	tas_geojsÚ
;

149 
as_geojsÚ
 * 
as_geojsÚ_š™
×s_geojsÚ * 
¡ršg
, * 
v®ue
, 
boŞ
 
ä“
);

165 
as_geojsÚ
 * 
as_geojsÚ_š™_wËn
×s_geojsÚ * 
¡ršg
, * 
v®ue
, 
size_t
 
Ën
, 
boŞ
 
ä“
);

179 
as_geojsÚ
 * 
as_geojsÚ_Ãw
(* 
v®ue
, 
boŞ
 
ä“
);

194 
as_geojsÚ
 * 
as_geojsÚ_Ãw_wËn
(* 
v®ue
, 
size_t
 
Ën
, 
boŞ
 
ä“
);

205 
as_geojsÚ
 * 
as_geojsÚ_Ãw_¡rdup
(cÚ¡ * 
v®ue
);

212 
šlše
 
as_geojsÚ_de¡roy
(
as_geojsÚ
 * 
¡ršg
)

214 
as_v®_de¡roy
((
as_v®
 *è
¡ršg
);

230 
size_t
 
as_geojsÚ_Ën
(
as_geojsÚ
 * 
¡ršg
);

237 
šlše
 * 
as_geojsÚ_g‘Ü–£
(cÚ¡ 
as_geojsÚ
 * 
¡ršg
, * 
çÎback
)

239  
¡ršg
 ? sŒšg->
v®ue
 : 
çÎback
;

247 
šlše
 * 
as_geojsÚ_g‘
(cÚ¡ 
as_geojsÚ
 * 
¡ršg
)

249  
as_geojsÚ_g‘Ü–£
(
¡ršg
, 
NULL
);

261 
šlše
 
as_v®
 * 
as_geojsÚ_tov®
(cÚ¡ 
as_geojsÚ
 * 
s
)

263  (
as_v®
 *è
s
;

271 
šlše
 
as_geojsÚ
 * 
as_geojsÚ_äomv®
(cÚ¡ 
as_v®
 * 
v
)

273  
as_ut_äomv®
(
v
, 
AS_GEOJSON
, 
as_geojsÚ
);

284 
as_geojsÚ_v®_de¡roy
(
as_v®
 * 
v
);

290 
ušt32_t
 
as_geojsÚ_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

296 * 
as_geojsÚ_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

298 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_hashmap.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_m­.h
>

22 
	~<¡dboŞ.h
>

23 
	~<¡dšt.h
>

25 #ifdeà
__ılu¥lus


36 
	sas_hashm­_–em’t_s
 {

37 
as_v®
 * 
p_key
;

38 
as_v®
 * 
p_v®
;

39 
ušt32_t
 
Ãxt
;

40 } 
	tas_hashm­_–em’t
;

105 
	sas_hashm­_s
 {

112 
as_m­
 
_
;

117 
ušt32_t
 
couÁ
;

123 
ušt32_t
 
bË_ÿ·c™y
;

124 
as_hashm­_–em’t
 * 
bË
;

130 
ušt32_t
 
ÿ·c™y_¡•
;

131 
ušt32_t
 
exŒa_ÿ·c™y
;

132 
as_hashm­_–em’t
 * 
exŒas
;

133 
ušt32_t
 
š£¹_©
;

134 
ušt32_t
 
ä“_q
;

136 } 
	tas_hashm­
;

152 
as_hashm­
 * 
as_hashm­_š™
×s_hashm­ * 
m­
, 
ušt32_t
 
buck‘s
);

163 
as_hashm­
 * 
as_hashm­_Ãw
(
ušt32_t
 
buck‘s
);

172 
as_hashm­_de¡roy
(
as_hashm­
 * 
m­
);

187 
ušt32_t
 
as_hashm­_hashcode
(cÚ¡ 
as_hashm­
 * 
m­
);

198 
ušt32_t
 
as_hashm­_size
(cÚ¡ 
as_hashm­
 * 
m­
);

214 
as_v®
 * 
as_hashm­_g‘
(cÚ¡ 
as_hashm­
 * 
m­
, cÚ¡‡s_v® * 
key
);

227 
as_hashm­_£t
(
as_hashm­
 * 
m­
, cÚ¡ 
as_v®
 * 
key
, cÚ¡‡s_v® * 
v®
);

238 
as_hashm­_ş—r
(
as_hashm­
 * 
m­
);

250 
as_hashm­_»move
(
as_hashm­
 * 
m­
, cÚ¡ 
as_v®
 * 
key
);

267 
boŞ
 
as_hashm­_fÜ—ch
(cÚ¡ 
as_hashm­
 * 
m­
, 
as_m­_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
);

269 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_hashmap_iterator.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_hashm­.h
>

21 
	~<«ro¥ike/as_™”©Ü.h
>

22 
	~<«ro¥ike/as_·œ.h
>

24 
	~<¡dboŞ.h
>

25 
	~<¡dšt.h
>

27 #ifdeà
__ılu¥lus


98 
	sas_hashm­_™”©Ü_s
 {

100 
as_™”©Ü
 
_
;

105 cÚ¡ 
as_hashm­
 * 
m­
;

110 
as_hashm­_–em’t
 * 
cu¼
;

115 
ušt32_t
 
couÁ
;

116 
ušt32_t
 
bË_pos
;

117 
ušt32_t
 
exŒas_pos
;

122 
as_·œ
 
·œ
;

124 } 
	tas_hashm­_™”©Ü
;

140 
as_hashm­_™”©Ü
 * 
as_hashm­_™”©Ü_š™
×s_hashm­_™”©Ü * 
™”©Ü
, cÚ¡ 
as_hashm­
 * 
m­
);

151 
as_hashm­_™”©Ü
 * 
as_hashm­_™”©Ü_Ãw
(cÚ¡ 
as_hashm­
 * 
m­
);

160 
as_hashm­_™”©Ü_de¡roy
(
as_hashm­_™”©Ü
 * 
™”©Ü
);

176 
boŞ
 
as_hashm­_™”©Ü_has_Ãxt
(cÚ¡ 
as_hashm­_™”©Ü
 * 
™”©Ü
);

188 cÚ¡ 
as_v®
 * 
as_hashm­_™”©Ü_Ãxt
(
as_hashm­_™”©Ü
 * 
™”©Ü
);

190 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_host.h

17 #´agm¨
Úû


19 
	~<c™ru¦—f/®loc.h
>

20 
	~<¡dšt.h
>

22 #ifdeà
__ılu¥lus


33 
	sas_ho¡_s
 {

37 * 
Çme
;

42 * 
s_Çme
;

47 
ušt16_t
 
pÜt
;

48 } 
	tas_ho¡
;

57 
šlše
 

58 
as_ho¡_cİy
(cÚ¡ 
as_ho¡
* 
¤c
,‡s_ho¡* 
Œg
)

60 
Œg
->
Çme
 = (*)
cf_¡rdup
(
¤c
->name);

61 
Œg
->
s_Çme
 = 
¤c
->s_Çm? (*)
cf_¡rdup
(¤c->s_Çmeè: 
NULL
;

62 
Œg
->
pÜt
 = 
¤c
->port;

68 
šlše
 

69 
as_ho¡_cİy_f›lds
(
as_ho¡
* 
Œg
, cÚ¡ * 
ho¡Çme
, cÚ¡ * 
s_Çme
, 
ušt16_t
 
pÜt
)

71 
Œg
->
Çme
 = (*)
cf_¡rdup
(
ho¡Çme
);

72 
Œg
->
s_Çme
 =ls_Çm? (*)
cf_¡rdup
Ñls_Çmeè: 
NULL
;

73 
Œg
->
pÜt
 =…ort;

79 
šlše
 

80 
as_ho¡_de¡roy
(
as_ho¡
* 
ho¡
)

82 
cf_ä“
(
ho¡
->
Çme
);

83 
cf_ä“
(
ho¡
->
s_Çme
);

86 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_info.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/«ro¥ike.h
>

20 
	~<«ro¥ike/as_şu¡”.h
>

22 #ifdeà
__ılu¥lus


34 
	sas_Çme_v®ue_s
 {

35 * 
Çme
;

36 * 
v®ue
;

37 } 
	tas_Çme_v®ue
;

47 
as_¡©us


48 
as_šfo_commªd_node
(

49 
as_”rÜ
* 
”r
, 
as_node
* 
node
, * 
commªd
, 
boŞ
 
£nd_asis
, 
ušt64_t
 
d—dlše_ms
,

50 ** 
»¥Ú£


57 
as_¡©us


58 
as_šfo_commªd_¿ndom_node
(
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, 
as_pŞicy_šfo
* 
pŞicy
, * 
commªd
);

64 
as_¡©us


65 
as_šfo_commªd_ho¡
(

66 
as_şu¡”
* 
şu¡”
, 
as_”rÜ
* 
”r
, 
sockaddr
* 
addr
, * 
commªd
,

67 
boŞ
 
£nd_asis
, 
ušt64_t
 
d—dlše_ms
, ** 
»¥Ú£
, cÚ¡ * 
s_Çme


75 
as_¡©us


76 
as_šfo_commªd
(

77 
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node
* 
node
, * 
Çmes
, 
boŞ
 
£nd_asis
, 
ušt64_t
 
d—dlše_ms
,

78 
ušt64_t
 
max_»¥Ú£_Ëngth
, ** 
v®ues


85 
as_¡©us


86 
as_šfo_ü—‹_sock‘
(

87 
as_şu¡”
* 
şu¡”
, 
as_”rÜ
* 
”r
, 
sockaddr
* 
addr
, 
ušt64_t
 
d—dlše_ms
,

88 cÚ¡ * 
s_Çme
, 
as_sock‘
* 
sock


96 
as_¡©us


97 
as_šfo_·r£_sšgË_»¥Ú£
(*
v®ues
, **
v®ue
);

106 
as_šfo_·r£_muÉi_»¥Ú£
(* 
buf
, 
as_veùÜ
* 
v®ues
);

108 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_integer.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dšt.h
>

25 #ifdeà
__ılu¥lus


103 
	sas_š‹g”_s
 {

110 
as_v®
 
_
;

115 
št64_t
 
v®ue
;

117 } 
	tas_š‹g”
;

145 
as_š‹g”
 * 
as_š‹g”_š™
×s_š‹g” * 
š‹g”
, 
št64_t
 
v®ue
);

167 
as_š‹g”
 * 
as_š‹g”_Ãw
(
št64_t
 
v®ue
);

180 
šlše
 
as_š‹g”_de¡roy
(
as_š‹g”
 * 
š‹g”
) {

181 
as_v®_de¡roy
((
as_v®
 *è
š‹g”
);

193 
šlše
 
št64_t
 
as_š‹g”_g‘Ü–£
(cÚ¡ 
as_š‹g”
 * 
š‹g”
, iÁ64_ˆ
çÎback
) {

194  
š‹g”
 ? iÁeg”->
v®ue
 : 
çÎback
;

202 
šlše
 
št64_t
 
as_š‹g”_g‘
(cÚ¡ 
as_š‹g”
 * 
š‹g”
) {

203  
as_š‹g”_g‘Ü–£
(
š‹g”
, 0);

212 
šlše
 
št64_t
 
as_š‹g”_tošt
(cÚ¡ 
as_š‹g”
 * 
š‹g”
) {

213  
as_š‹g”_g‘Ü–£
(
š‹g”
, 0);

225 
šlše
 
as_v®
 * 
as_š‹g”_tov®
(cÚ¡ 
as_š‹g”
 * 
i
) {

226  (
as_v®
 *è
i
;

234 
šlše
 
as_š‹g”
 * 
as_š‹g”_äomv®
(cÚ¡ 
as_v®
 * 
v
) {

235  
as_ut_äomv®
(
v
, 
AS_INTEGER
, 
as_š‹g”
);

246 
as_š‹g”_v®_de¡roy
(
as_v®
 * 
v
);

252 
ušt32_t
 
as_š‹g”_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

258 * 
as_š‹g”_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

260 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_iterator.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dboŞ.h
>

25 #ifdeà
__ılu¥lus


33 
as_™”©Ü_hooks_s
;

38 
	sas_™”©Ü_s
 {

44 
boŞ
 
ä“
;

49 * 
d©a
;

54 cÚ¡ 
as_™”©Ü_hooks_s
 * 
hooks
;

56 } 
	tas_™”©Ü
;

61 
	sas_™”©Ü_hooks_s
 {

66 
boŞ
 (* 
de¡roy
)(
as_™”©Ü
 *);

71 
boŞ
 (* 
has_Ãxt
)(cÚ¡ 
as_™”©Ü
 *);

76 cÚ¡ 
as_v®
 * (* 
Ãxt
)(
as_™”©Ü
 *);

78 } 
	tas_™”©Ü_hooks
;

87 
as_™”©Ü
 * 
as_™”©Ü_š™
×s_™”©Ü * 
™”©Ü
, 
boŞ
 
ä“
, * 
d©a
, cÚ¡ 
as_™”©Ü_hooks
 * 
hooks
);

92 
as_™”©Ü_de¡roy
(
as_™”©Ü
 * 
™”©Ü
);

105 
šlše
 
boŞ
 
as_™”©Ü_has_Ãxt
(cÚ¡ 
as_™”©Ü
 * 
™”©Ü
)

107  
as_ut_hook
(
has_Ãxt
, 
çl£
, 
™”©Ü
);

118 
šlše
 cÚ¡ 
as_v®
 * 
as_™”©Ü_Ãxt
(
as_™”©Ü
 * 
™”©Ü
)

120  
as_ut_hook
(
Ãxt
, 
NULL
, 
™”©Ü
);

123 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_job.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/«ro¥ike.h
>

21 #ifdeà
__ılu¥lus


32 
	eas_job_¡©us_e
 {

37 
AS_JOB_STATUS_UNDEF
,

42 
AS_JOB_STATUS_INPROGRESS
,

47 
AS_JOB_STATUS_COMPLETED
,

48 } 
	tas_job_¡©us
;

53 
	sas_job_šfo_s
 {

57 
as_job_¡©us
 
¡©us
;

62 
ušt32_t
 
´og»ss_pù
;

67 
ušt32_t
 
»cÜds_»ad
;

68 } 
	tas_job_šfo
;

91 
as_¡©us


92 
«ro¥ike_job_wa™
(

93 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, cÚ¡ * 
moduË
, 
ušt64_t
 
job_id
,

94 
ušt32_t
 
š‹rv®_ms


123 
as_¡©us


124 
«ro¥ike_job_šfo
(

125 
«ro¥ike
* 
as
, 
as_”rÜ
* 
”r
, cÚ¡ 
as_pŞicy_šfo
* 
pŞicy
, cÚ¡ * 
moduË
, 
ušt64_t
 
job_id
,

126 
boŞ
 
¡İ_if_š_´og»ss
, 
as_job_šfo
 * 
šfo


129 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_key.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_by‹s.h
>

20 
	~<«ro¥ike/as_š‹g”.h
>

21 
	~<«ro¥ike/as_”rÜ.h
>

22 
	~<«ro¥ike/as_¡ršg.h
>

23 
	~<«ro¥ike/as_¡©us.h
>

25 
	~<¡dboŞ.h
>

26 
	~<¡dšt.h
>

28 #ifdeà
__ılu¥lus


41 
	#AS_DIGEST_VALUE_SIZE
 20

	)

48 
	#AS_NAMESPACE_MAX_SIZE
 32

	)

55 
	#AS_SET_MAX_SIZE
 64

	)

66 
	tas_Çme¥aû
[
AS_NAMESPACE_MAX_SIZE
];

73 
	tas_£t
[
AS_SET_MAX_SIZE
];

80 
ušt8_t
 
	tas_dige¡_v®ue
[
AS_DIGEST_VALUE_SIZE
];

89 
	sas_dige¡_s
 {

94 
boŞ
 
š™
;

99 
as_dige¡_v®ue
 
v®ue
;

101 } 
	tas_dige¡
;

108 
	uas_key_v®ue_u
 {

113 
as_š‹g”
 
š‹g”
;

118 
as_¡ršg
 
¡ršg
;

123 
as_by‹s
 
by‹s
;

125 } 
	tas_key_v®ue
;

199 
	sas_key_s
 {

205 
boŞ
 
_ä“
;

210 
as_Çme¥aû
 
ns
;

215 
as_£t
 
£t
;

220 
as_key_v®ue
 
v®ue
;

227 
as_key_v®ue
 * 
v®u•
;

232 
as_dige¡
 
dige¡
;

234 } 
	tas_key
;

261 
as_key
 * 
as_key_š™
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ * 
v®ue
);

283 
as_key
 * 
as_key_š™_št64
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, 
št64_t
 
v®ue
);

306 
as_key
 * 
as_key_š™_¡½
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ * 
v®ue
, 
boŞ
 
ä“
);

328 
šlše
 
as_key
 * 
as_key_š™_¡r
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ * 
v®ue
)

330  
as_key_š™_¡½
(
key
, 
ns
, 
£t
, 
v®ue
, 
çl£
);

360 
as_key
 * 
as_key_š™_¿wp
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

385 
šlše
 
as_key
 * 
as_key_š™_¿w
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
)

387  
as_key_š™_¿wp
(
key
, 
ns
, 
£t
, 
v®ue
, 
size
, 
çl£
);

412 
as_key
 * 
as_key_š™_dige¡
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_dige¡_v®ue
 
dige¡
);

437 
as_key
 * 
as_key_š™_v®ue
×s_key * 
key
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_key_v®ue
 * 
v®ue
);

459 
as_key
 * 
as_key_Ãw
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ * 
v®ue
);

480 
as_key
 * 
as_key_Ãw_št64
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, 
št64_t
 
v®ue
);

502 
as_key
 * 
as_key_Ãw_¡½
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ * 
v®ue
, 
boŞ
 
ä“
);

523 
šlše
 
as_key
 * 
as_key_Ãw_¡r
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ * 
v®ue
)

525  
as_key_Ãw_¡½
(
ns
, 
£t
, 
v®ue
, 
çl£
);

554 
as_key
 * 
as_key_Ãw_¿wp
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

578 
šlše
 
as_key
 * 
as_key_Ãw_¿w
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
)

580  
as_key_Ãw_¿wp
(
ns
, 
£t
, 
v®ue
, 
size
, 
çl£
);

604 
as_key
 * 
as_key_Ãw_dige¡
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_dige¡_v®ue
 
dige¡
);

628 
as_key
 * 
as_key_Ãw_v®ue
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
, cÚ¡ 
as_key_v®ue
 * 
v®ue
);

642 
as_key_de¡roy
(
as_key
 * 
key
);

661 
as_dige¡
 * 
as_key_dige¡
(
as_key
 * 
key
);

675 
as_¡©us


676 
as_key_£t_dige¡
(
as_”rÜ
* 
”r
, 
as_key
* 
key
);

678 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_list.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_by‹s.h
>

20 
	~<«ro¥ike/as_doubË.h
>

21 
	~<«ro¥ike/as_š‹g”.h
>

22 
	~<«ro¥ike/as_™”©Ü.h
>

23 
	~<«ro¥ike/as_¡ršg.h
>

24 
	~<«ro¥ike/as_ut.h
>

25 
	~<«ro¥ike/as_v®.h
>

27 
	~<¡dboŞ.h
>

28 
	~<¡dšt.h
>

30 #ifdeà
__ılu¥lus


38 
as_li¡_™”©Ü_u
;

40 
as_li¡_hooks_s
;

52 
boŞ
 (* 
	tas_li¡_fÜ—ch_ÿÎback
è(
	tas_v®
 * 
	tv®ue
, * 
	tud©a
);

63 
	sas_li¡_s
 {

70 
as_v®
 
_
;

75 cÚ¡ 
as_li¡_hooks_s
 * 
hooks
;

77 } 
	tas_li¡
;

82 
	sas_li¡_hooks_s
 {

95 
boŞ
 (* 
de¡roy
)(
as_li¡
 * 
li¡
);

108 
ušt32_t
 (* 
hashcode
)(cÚ¡ 
as_li¡
 * 
li¡
);

117 
ušt32_t
 (* 
size
)(cÚ¡ 
as_li¡
 * 
li¡
);

131 
as_v®
 * (* 
g‘
)(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
);

141 
št64_t
 (* 
g‘_št64
)(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
);

151 (* 
g‘_doubË
)(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
);

161 * (* 
g‘_¡r
)(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
);

176 (* 
£t
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_v®
 * 
v®ue
);

187 (* 
£t_št64
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
št64_t
 
v®ue
);

198 (* 
£t_doubË
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
v®ue
);

209 (* 
£t_¡r
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, cÚ¡ * 
v®ue
);

224 (* 
š£¹
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
as_v®
 * 
v®ue
);

235 (* 
š£¹_št64
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
št64_t
 
v®ue
);

246 (* 
š£¹_doubË
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, 
v®ue
);

257 (* 
š£¹_¡r
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
, cÚ¡ * 
v®ue
);

271 (* 
­³nd
)(
as_li¡
 * 
li¡
, 
as_v®
 * 
v®ue
);

281 (* 
­³nd_št64
)(
as_li¡
 * 
li¡
, 
št64_t
 
v®ue
);

291 (* 
­³nd_doubË
)(
as_li¡
 * 
li¡
, 
v®ue
);

301 (* 
­³nd_¡r
)(
as_li¡
 * 
li¡
, cÚ¡ * 
v®ue
);

315 (* 
´•’d
)(
as_li¡
 * 
li¡
, 
as_v®
 * 
v®ue
);

325 (* 
´•’d_št64
)(
as_li¡
 * 
li¡
, 
št64_t
 
v®ue
);

335 (* 
´•’d_doubË
)(
as_li¡
 * 
li¡
, 
v®ue
);

345 (* 
´•’d_¡r
)(
as_li¡
 * 
li¡
, cÚ¡ * 
v®ue
);

362 (* 
»move
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
);

377 (* 
cÚÿt
)(
as_li¡
 * 
li¡
, cÚ¡‡s_li¡ * 
li¡2
);

388 (* 
Œim
)(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
);

397 
as_v®
 * (* 
h—d
)(cÚ¡ 
as_li¡
 * 
li¡
);

406 
as_li¡
 * (* 

)(cÚ¡‡s_li¡ * 
li¡
);

416 
as_li¡
 * (* 
drİ
)(cÚ¡‡s_li¡ * 
li¡
, 
ušt32_t
 
n
);

426 
as_li¡
 * (* 
ke
)(cÚ¡‡s_li¡ * 
li¡
, 
ušt32_t
 
n
);

441 
boŞ
 (* 
fÜ—ch
)(cÚ¡ 
as_li¡
 * 
li¡
, 
as_li¡_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
);

450 
as_li¡_™”©Ü_u
 * (* 
™”©Ü_Ãw
)(cÚ¡ 
as_li¡
 * 
li¡
);

459 
as_li¡_™”©Ü_u
 * (* 
™”©Ü_š™
)(cÚ¡ 
as_li¡
 * 
li¡
, as_li¡_™”©Ü_u * 
™
);

461 } 
	tas_li¡_hooks
;

478 
as_li¡
 * 
as_li¡_cÚs
×s_li¡ * 
li¡
, 
boŞ
 
ä“
, cÚ¡ 
as_li¡_hooks
 * 
hooks
);

489 
as_li¡
 * 
as_li¡_š™
×s_li¡ * 
li¡
, cÚ¡ 
as_li¡_hooks
 * 
hooks
);

499 
as_li¡
 * 
as_li¡_Ãw
(cÚ¡ 
as_li¡_hooks
 * 
hooks
);

507 
šlše
 
as_li¡_de¡roy
(
as_li¡
 * 
li¡
)

509 
as_v®_de¡roy
((
as_v®
 *è
li¡
);

524 
šlše
 
ušt32_t
 
as_li¡_hashcode
(
as_li¡
 * 
li¡
)

526  
as_ut_hook
(
hashcode
, 0, 
li¡
);

537 
šlše
 
ušt32_t
 
as_li¡_size
(
as_li¡
 * 
li¡
)

539  
as_ut_hook
(
size
, 0, 
li¡
);

556 
šlše
 
as_li¡_cÚÿt
(
as_li¡
 * 
li¡
, cÚ¡‡s_li¡ * 
li¡2
)

558  
as_ut_hook
(
cÚÿt
, 1, 
li¡
, 
li¡2
);

571 
šlše
 
as_li¡_Œim
(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
)

573  
as_ut_hook
(
Œim
, 1, 
li¡
, 
šdex
);

584 
šlše
 
as_v®
 * 
as_li¡_h—d
(cÚ¡ 
as_li¡
 * 
li¡
)

586  
as_ut_hook
(
h—d
, 
NULL
, 
li¡
);

597 
šlše
 
as_li¡
 * 
as_li¡_
(cÚ¡‡s_li¡ * 
li¡
)

599  
as_ut_hook
(

, 
NULL
, 
li¡
);

611 
šlše
 
as_li¡
 * 
as_li¡_drİ
(cÚ¡‡s_li¡ * 
li¡
, 
ušt32_t
 
n
)

613  
as_ut_hook
(
drİ
, 
NULL
, 
li¡
, 
n
);

625 
šlše
 
as_li¡
 * 
as_li¡_ke
(cÚ¡‡s_li¡ * 
li¡
, 
ušt32_t
 
n
)

627  
as_ut_hook
(
ke
, 
NULL
, 
li¡
, 
n
);

643 
šlše
 
as_v®
 * 
as_li¡_g‘
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

645  
as_ut_hook
(
g‘
, 
NULL
, 
li¡
, 
i
);

657 
šlše
 
št64_t
 
as_li¡_g‘_št64
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

659  
as_ut_hook
(
g‘_št64
, 0, 
li¡
, 
i
);

671 
šlše
 
as_li¡_g‘_doubË
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

673  
as_ut_hook
(
g‘_doubË
, 0.0, 
li¡
, 
i
);

685 
šlše
 * 
as_li¡_g‘_¡r
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

687  
as_ut_hook
(
g‘_¡r
, 
NULL
, 
li¡
, 
i
);

699 
šlše
 
as_š‹g”
 * 
as_li¡_g‘_š‹g”
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

701  
as_š‹g”_äomv®
(
as_li¡_g‘
(
li¡
, 
i
));

713 
šlše
 
as_doubË
 * 
as_li¡_g‘_as_doubË
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

715  
as_doubË_äomv®
(
as_li¡_g‘
(
li¡
, 
i
));

727 
šlše
 
as_¡ršg
 * 
as_li¡_g‘_¡ršg
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

729  
as_¡ršg_äomv®
(
as_li¡_g‘
(
li¡
, 
i
));

741 
šlše
 
as_by‹s
 * 
as_li¡_g‘_by‹s
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

743  
as_by‹s_äomv®
(
as_li¡_g‘
(
li¡
, 
i
));

755 
šlše
 
as_li¡
 * 
as_li¡_g‘_li¡
(cÚ¡‡s_li¡ * 
li¡
, 
ušt32_t
 
i
)

757 
as_v®
 * 
v
 = 
as_li¡_g‘
(
li¡
, 
i
);

758  (
as_li¡
 *è(
v
 && v->
ty³
 =ğ
AS_LIST
 ? v : 
NULL
);

770 
šlše
 
as_m­_s
 * 
as_li¡_g‘_m­
(cÚ¡ 
as_li¡
 * 
li¡
, 
ušt32_t
 
i
)

772 
as_v®
 * 
v
 = 
as_li¡_g‘
(
li¡
, 
i
);

773  (
as_m­_s
 *è(
v
 && v->
ty³
 =ğ
AS_MAP
 ? v : 
NULL
);

790 
šlše
 
as_li¡_£t
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_v®
 * 
v®ue
)

792  
as_ut_hook
(
£t
, 1, 
li¡
, 
i
, 
v®ue
);

805 
šlše
 
as_li¡_£t_št64
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
št64_t
 
v®ue
)

807  
as_ut_hook
(
£t_št64
, 1, 
li¡
, 
i
, 
v®ue
);

820 
šlše
 
as_li¡_£t_doubË
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
v®ue
)

822  
as_ut_hook
(
£t_doubË
, 1, 
li¡
, 
i
, 
v®ue
);

835 
šlše
 
as_li¡_£t_¡r
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, cÚ¡ * 
v®ue
)

837  
as_ut_hook
(
£t_¡r
, 1, 
li¡
, 
i
, 
v®ue
);

850 
šlše
 
as_li¡_£t_š‹g”
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_š‹g”
 * 
v®ue
)

852  
as_li¡_£t
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

865 
šlše
 
as_li¡_£t_as_doubË
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_doubË
 * 
v®ue
)

867  
as_li¡_£t
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

880 
šlše
 
as_li¡_£t_¡ršg
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_¡ršg
 * 
v®ue
)

882  
as_li¡_£t
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

895 
šlše
 
as_li¡_£t_by‹s
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_by‹s
 * 
v®ue
)

897  
as_li¡_£t
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

910 
šlše
 
as_li¡_£t_li¡
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
,‡s_li¡ * 
v®ue
)

912  
as_li¡_£t
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

925 
šlše
 
as_li¡_£t_m­
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_m­_s
 * 
v®ue
)

927  
as_li¡_£t
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

947 
šlše
 
as_li¡_š£¹
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_v®
 * 
v®ue
)

949  
as_ut_hook
(
š£¹
, 1, 
li¡
, 
i
, 
v®ue
);

962 
šlše
 
as_li¡_š£¹_št64
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
št64_t
 
v®ue
)

964  
as_ut_hook
(
š£¹_št64
, 1, 
li¡
, 
i
, 
v®ue
);

977 
šlše
 
as_li¡_š£¹_doubË
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
v®ue
)

979  
as_ut_hook
(
š£¹_doubË
, 1, 
li¡
, 
i
, 
v®ue
);

992 
šlše
 
as_li¡_š£¹_¡r
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, cÚ¡ * 
v®ue
)

994  
as_ut_hook
(
š£¹_¡r
, 1, 
li¡
, 
i
, 
v®ue
);

1007 
šlše
 
as_li¡_š£¹_š‹g”
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_š‹g”
 * 
v®ue
)

1009  
as_li¡_š£¹
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

1022 
šlše
 
as_li¡_š£¹_as_doubË
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_doubË
 * 
v®ue
)

1024  
as_li¡_š£¹
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

1037 
šlše
 
as_li¡_š£¹_¡ršg
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_¡ršg
 * 
v®ue
)

1039  
as_li¡_š£¹
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

1052 
šlše
 
as_li¡_š£¹_by‹s
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_by‹s
 * 
v®ue
)

1054  
as_li¡_š£¹
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

1067 
šlše
 
as_li¡_š£¹_li¡
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
,‡s_li¡ * 
v®ue
)

1069  
as_li¡_š£¹
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

1082 
šlše
 
as_li¡_š£¹_m­
(
as_li¡
 * 
li¡
, 
ušt32_t
 
i
, 
as_m­_s
 * 
v®ue
)

1084  
as_li¡_š£¹
(
li¡
, 
i
, (
as_v®
 *è
v®ue
);

1100 
šlše
 
as_li¡_­³nd
(
as_li¡
 * 
li¡
, 
as_v®
 * 
v®ue
)

1102  
as_ut_hook
(
­³nd
, 1, 
li¡
, 
v®ue
);

1114 
šlše
 
as_li¡_­³nd_št64
(
as_li¡
 * 
li¡
, 
št64_t
 
v®ue
)

1116  
as_ut_hook
(
­³nd_št64
, 1, 
li¡
, 
v®ue
);

1128 
šlše
 
as_li¡_­³nd_doubË
(
as_li¡
 * 
li¡
, 
v®ue
)

1130  
as_ut_hook
(
­³nd_doubË
, 1, 
li¡
, 
v®ue
);

1142 
šlše
 
as_li¡_­³nd_¡r
(
as_li¡
 * 
li¡
, cÚ¡ * 
v®ue
)

1144  
as_ut_hook
(
­³nd_¡r
, 1, 
li¡
, 
v®ue
);

1156 
šlše
 
as_li¡_­³nd_š‹g”
(
as_li¡
 * 
li¡
, 
as_š‹g”
 * 
v®ue
)

1158  
as_li¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

1170 
šlše
 
as_li¡_­³nd_as_doubË
(
as_li¡
 * 
li¡
, 
as_doubË
 * 
v®ue
)

1172  
as_li¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

1184 
šlše
 
as_li¡_­³nd_¡ršg
(
as_li¡
 * 
li¡
, 
as_¡ršg
 * 
v®ue
)

1186  
as_li¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

1198 
šlše
 
as_li¡_­³nd_by‹s
(
as_li¡
 * 
li¡
, 
as_by‹s
 * 
v®ue
)

1200  
as_li¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

1212 
šlše
 
as_li¡_­³nd_li¡
(
as_li¡
 * 
li¡
,‡s_li¡ * 
v®ue
)

1214  
as_li¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

1226 
šlše
 
as_li¡_­³nd_m­
(
as_li¡
 * 
li¡
, 
as_m­_s
 * 
v®ue
)

1228  
as_li¡_­³nd
(
li¡
, (
as_v®
 *è
v®ue
);

1244 
šlše
 
as_li¡_´•’d
(
as_li¡
 * 
li¡
, 
as_v®
 * 
v®ue
)

1246  
as_ut_hook
(
´•’d
, 1, 
li¡
, 
v®ue
);

1258 
šlše
 
as_li¡_´•’d_št64
(
as_li¡
 * 
li¡
, 
št64_t
 
v®ue
)

1260  
as_ut_hook
(
´•’d_št64
, 1, 
li¡
, 
v®ue
);

1272 
šlše
 
as_li¡_´•’d_doubË
(
as_li¡
 * 
li¡
, 
v®ue
)

1274  
as_ut_hook
(
´•’d_doubË
, 1, 
li¡
, 
v®ue
);

1286 
šlše
 
as_li¡_´•’d_¡r
(
as_li¡
 * 
li¡
, cÚ¡ * 
v®ue
)

1288  
as_ut_hook
(
´•’d_¡r
, 1, 
li¡
, 
v®ue
);

1300 
šlše
 
as_li¡_´•’d_š‹g”
(
as_li¡
 * 
li¡
, 
as_š‹g”
 * 
v®ue
)

1302  
as_li¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1314 
šlše
 
as_li¡_´•’d_as_doubË
(
as_li¡
 * 
li¡
, 
as_doubË
 * 
v®ue
)

1316  
as_li¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1328 
šlše
 
as_li¡_´•’d_¡ršg
(
as_li¡
 * 
li¡
, 
as_¡ršg
 * 
v®ue
)

1330  
as_li¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1342 
šlše
 
as_li¡_´•’d_by‹s
(
as_li¡
 * 
li¡
, 
as_by‹s
 * 
v®ue
)

1344  
as_li¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1356 
šlše
 
as_li¡_´•’d_li¡
(
as_li¡
 * 
li¡
,‡s_li¡ * 
v®ue
)

1358  
as_li¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1370 
šlše
 
as_li¡_´•’d_m­
(
as_li¡
 * 
li¡
, 
as_m­_s
 * 
v®ue
)

1372  
as_li¡_´•’d
(
li¡
, (
as_v®
 *è
v®ue
);

1391 
šlše
 
as_li¡_»move
(
as_li¡
 * 
li¡
, 
ušt32_t
 
šdex
)

1393  
as_ut_hook
(
»move
, 1, 
li¡
, 
šdex
);

1411 
šlše
 
boŞ
 
as_li¡_fÜ—ch
(cÚ¡ 
as_li¡
 * 
li¡
, 
as_li¡_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
)

1413  
as_ut_hook
(
fÜ—ch
, 
çl£
, 
li¡
, 
ÿÎback
, 
ud©a
);

1424 
šlše
 
as_li¡_™”©Ü_u
 * 
as_li¡_™”©Ü_Ãw
(cÚ¡ 
as_li¡
 * 
li¡
)

1426  
as_ut_hook
(
™”©Ü_Ãw
, 
NULL
, 
li¡
);

1439 
šlše
 
as_li¡_™”©Ü_u
 * 
as_li¡_™”©Ü_š™
(as_li¡_™”©Ü_u * 
™
, cÚ¡ 
as_li¡
 * 
li¡
)

1441  
as_ut_hook
(
™”©Ü_š™
, 
NULL
, 
li¡
, 
™
);

1452 
šlše
 
as_v®
 * 
as_li¡_tov®
(
as_li¡
 * 
li¡
)

1454  (
as_v®
 *è
li¡
;

1461 
šlše
 
as_li¡
 * 
as_li¡_äomv®
(
as_v®
 * 
v
)

1463  
as_ut_äomv®
(
v
, 
AS_LIST
, 
as_li¡
);

1474 
as_li¡_v®_de¡roy
(
as_v®
 * 
v
);

1480 
ušt32_t
 
as_li¡_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

1486 * 
as_li¡_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

1488 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_list_iterator.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_¬¿yli¡_™”©Ü.h
>

22 #ifdeà
__ılu¥lus


33 
	uas_li¡_™”©Ü_u
 {

35 
as_¬¿yli¡_™”©Ü
 
¬¿yli¡
;

37 } 
	tas_li¡_™”©Ü
;

39 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_list_operations.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_İ”©iÚs.h
>

21 #ifdeà
__ılu¥lus


41 
boŞ


42 
as_İ”©iÚs_add_li¡_­³nd
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
v®
);

56 
boŞ


57 
as_İ”©iÚs_add_li¡_­³nd_št64
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
v®ue
);

71 
boŞ


72 
as_İ”©iÚs_add_li¡_­³nd_doubË
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
v®ue
);

87 
boŞ


88 
as_İ”©iÚs_add_li¡_­³nd_¡½
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, 
boŞ
 
ä“
);

102 
šlše
 
boŞ


103 
as_İ”©iÚs_add_li¡_­³nd_¡r
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

105  
as_İ”©iÚs_add_li¡_­³nd_¡½
(
İs
, 
Çme
, 
v®ue
, 
çl£
);

122 
boŞ


123 
as_İ”©iÚs_add_li¡_­³nd_¿wp
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
* 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

138 
šlše
 
boŞ


139 
as_İ”©iÚs_add_li¡_­³nd_¿w
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
* 
v®ue
, 
ušt32_t
 
size
)

141  
as_İ”©iÚs_add_li¡_­³nd_¿wp
(
İs
, 
Çme
, 
v®ue
, 
size
, 
çl£
);

156 
boŞ


157 
as_İ”©iÚs_add_li¡_­³nd_™ems
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_li¡
 *
li¡
);

172 
boŞ


173 
as_İ”©iÚs_add_li¡_š£¹
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_v®
* 
v®
);

188 
boŞ


189 
as_İ”©iÚs_add_li¡_š£¹_št64
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, iÁ64_ˆ
v®ue
);

204 
boŞ


205 
as_İ”©iÚs_add_li¡_š£¹_doubË
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
v®ue
);

221 
boŞ


222 
as_İ”©iÚs_add_li¡_š£¹_¡½
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ * 
v®ue
, 
boŞ
 
ä“
);

237 
šlše
 
boŞ


238 
as_İ”©iÚs_add_li¡_š£¹_¡r
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ * 
v®ue
)

240  
as_İ”©iÚs_add_li¡_š£¹_¡½
(
İs
, 
Çme
, 
šdex
, 
v®ue
, 
çl£
);

258 
boŞ


259 
as_İ”©iÚs_add_li¡_š£¹_¿wp
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ 
ušt8_t
* 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

275 
šlše
 
boŞ


276 
as_İ”©iÚs_add_li¡_š£¹_¿w
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ 
ušt8_t
* 
v®ue
, 
ušt32_t
 
size
)

278  
as_İ”©iÚs_add_li¡_š£¹_¿wp
(
İs
, 
Çme
, 
šdex
, 
v®ue
, 
size
, 
çl£
);

294 
boŞ


295 
as_İ”©iÚs_add_li¡_š£¹_™ems
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_li¡
 *
li¡
);

309 
boŞ


310 
as_İ”©iÚs_add_li¡_pİ
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
);

325 
boŞ


326 
as_İ”©iÚs_add_li¡_pİ_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
ušt64_t
 
couÁ
);

340 
boŞ


341 
as_İ”©iÚs_add_li¡_pİ_¿nge_äom
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
);

355 
boŞ


356 
as_İ”©iÚs_add_li¡_»move
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
);

371 
boŞ


372 
as_İ”©iÚs_add_li¡_»move_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
ušt64_t
 
couÁ
);

386 
boŞ


387 
as_İ”©iÚs_add_li¡_»move_¿nge_äom
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
);

403 
boŞ


404 
as_İ”©iÚs_add_li¡_ş—r
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
);

419 
boŞ


420 
as_İ”©iÚs_add_li¡_£t
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_v®
* 
v®
);

435 
boŞ


436 
as_İ”©iÚs_add_li¡_£t_št64
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, iÁ64_ˆ
v®ue
);

451 
boŞ


452 
as_İ”©iÚs_add_li¡_£t_doubË
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
v®ue
);

468 
boŞ


469 
as_İ”©iÚs_add_li¡_£t_¡½
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ * 
v®ue
, 
boŞ
 
ä“
);

484 
šlše
 
boŞ


485 
as_İ”©iÚs_add_li¡_£t_¡r
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ * 
v®ue
)

487  
as_İ”©iÚs_add_li¡_£t_¡½
(
İs
, 
Çme
, 
šdex
, 
v®ue
, 
çl£
);

505 
boŞ


506 
as_İ”©iÚs_add_li¡_£t_¿wp
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ 
ušt8_t
* 
v®ue
, 
ušt32_t
 
size
, 
boŞ
 
ä“
);

522 
šlše
 
boŞ


523 
as_İ”©iÚs_add_li¡_£t_¿w
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, cÚ¡ 
ušt8_t
* 
v®ue
, 
ušt32_t
 
size
)

525  
as_İ”©iÚs_add_li¡_£t_¿wp
(
İs
, 
Çme
, 
šdex
, 
v®ue
, 
size
, 
çl£
);

541 
boŞ


542 
as_İ”©iÚs_add_li¡_Œim
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
ušt64_t
 
couÁ
);

552 
boŞ


553 
as_İ”©iÚs_add_li¡_šüem’t
(
as_İ”©iÚs
 *
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_v®
 *
šü
);

570 
boŞ


571 
as_İ”©iÚs_add_li¡_g‘
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
);

586 
boŞ


587 
as_İ”©iÚs_add_li¡_g‘_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
ušt64_t
 
couÁ
);

601 
boŞ


602 
as_İ”©iÚs_add_li¡_g‘_¿nge_äom
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
);

615 
boŞ


616 
as_İ”©iÚs_add_li¡_size
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
);

618 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_listener.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_”rÜ.h
>

20 
	~<«ro¥ike/as_ev’t.h
>

21 
	~<«ro¥ike/as_»cÜd.h
>

23 #ifdeà
__ılu¥lus


36 (*
as_async_wr™e_li¡’”
è(
	tas_”rÜ
* 
	t”r
, * 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

49 (*
as_async_»cÜd_li¡’”
è(
	tas_”rÜ
* 
	t”r
, 
	tas_»cÜd
* 
	t»cÜd
, * 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

62 (*
as_async_v®ue_li¡’”
è(
	tas_”rÜ
* 
	t”r
, 
	tas_v®
* 
	tv®
, * 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

73 (*
as_pe_li¡’”
è(* 
	tud©a
, 
	tas_ev’t_loİ
* 
	tev’t_loİ
);

75 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_log.h

17 #´agm¨
Úû


19 
	~<¡d¬g.h
>

20 
	~<¡dboŞ.h
>

21 
	~<¡dio.h
>

22 
	~<¡dšt.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

26 #ifdeà
__ılu¥lus


37 
	eas_log_Ëv–_e
 {

38 
AS_LOG_LEVEL_ERROR
 = 0,

39 
AS_LOG_LEVEL_WARN
 = 1,

40 
AS_LOG_LEVEL_INFO
 = 2,

41 
AS_LOG_LEVEL_DEBUG
 = 3,

42 
AS_LOG_LEVEL_TRACE
 = 4

43 } 
	tas_log_Ëv–
;

82 
boŞ
 (* 
	tas_log_ÿÎback
)(

83 
	tas_log_Ëv–
 
	tËv–
, cÚ¡ * 
	tfunc
, cÚ¡ * 
	tfe
, 
	tušt32_t
 
	tlše
,

84 cÚ¡ * 
	tfmt
, ...);

131 
	sas_log_s
 {

136 
as_log_Ëv–
 
Ëv–
;

141 
as_log_ÿÎback
 
ÿÎback
;

143 } 
	tas_log
;

149 
as_log
 
g_as_log
;

150 cÚ¡ * 
as_log_Ëv–_¡ršgs
[];

163 
šlše
 

164 
as_log_£t_Ëv–
(
as_log_Ëv–
 
Ëv–
)

166 
	gg_as_log
.
	gËv–
 = 
Ëv–
;

176 
šlše
 

177 
as_log_£t_ÿÎback
(
as_log_ÿÎback
 
ÿÎback
)

179 
	gg_as_log
.
	gÿÎback
 = 
ÿÎback
;

189 
šlše
 const *

190 
as_log_Ëv–_to¡ršg
(
as_log_Ëv–
 
Ëv–
)

192  
	gas_log_Ëv–_¡ršgs
[
Ëv–
];

195 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_log_macros.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_log.h
>

21 #ifdeà
__ılu¥lus


29 
	#as_log_”rÜ_’abËd
(è(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_ERROR
 <ğg_as_log.
Ëv–
)

	)

30 
	#as_log_w¬n_’abËd
(è(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_WARN
 <ğg_as_log.
Ëv–
)

	)

31 
	#as_log_šfo_’abËd
(è(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_INFO
 <ğg_as_log.
Ëv–
)

	)

32 
	#as_log_debug_’abËd
(è(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_DEBUG
 <ğg_as_log.
Ëv–
)

	)

33 
	#as_log_Œaû_’abËd
(è(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_TRACE
 <ğg_as_log.
Ëv–
)

	)

35 
	#as_log_”rÜ
(
__fmt
, ... ) \

36 ià(
g_as_log
.
ÿÎback
) {\

37 (
g_as_log
.
ÿÎback
è(
AS_LOG_LEVEL_ERROR
, 
__func__
, 
__FILE__
, 
__LINE__
, 
__fmt
, ##
__VA_ARGS__
);\

38 }

	)

40 
	#as_log_w¬n
(
__fmt
, ... ) \

41 ià(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_WARN
 <ğg_as_log.
Ëv–
) {\

42 (
g_as_log
.
ÿÎback
è(
AS_LOG_LEVEL_WARN
, 
__func__
, 
__FILE__
, 
__LINE__
, 
__fmt
, ##
__VA_ARGS__
);\

43 }

	)

45 
	#as_log_šfo
(
__fmt
, ... ) \

46 ià(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_INFO
 <ğg_as_log.
Ëv–
) {\

47 (
g_as_log
.
ÿÎback
è(
AS_LOG_LEVEL_INFO
, 
__func__
, 
__FILE__
, 
__LINE__
, 
__fmt
, ##
__VA_ARGS__
);\

48 }

	)

50 
	#as_log_debug
(
__fmt
, ... ) \

51 ià(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_DEBUG
 <ğg_as_log.
Ëv–
) {\

52 (
g_as_log
.
ÿÎback
è(
AS_LOG_LEVEL_DEBUG
, 
__func__
, 
__FILE__
, 
__LINE__
, 
__fmt
, ##
__VA_ARGS__
);\

53 }

	)

55 
	#as_log_Œaû
(
__fmt
, ... ) \

56 ià(
g_as_log
.
ÿÎback
 && 
AS_LOG_LEVEL_TRACE
 <ğg_as_log.
Ëv–
) {\

57 (
g_as_log
.
ÿÎback
è(
AS_LOG_LEVEL_TRACE
, 
__func__
, 
__FILE__
, 
__LINE__
, 
__fmt
, ##
__VA_ARGS__
);\

58 }

	)

60 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_lookup.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_şu¡”.h
>

20 
	~<Ãtdb.h
>

22 #ifdeà
__ılu¥lus


34 
	sas_sockaddr_™”©Ü_s
 {

35 
addršfo
* 
add»s£s
;

36 
addršfo
* 
cu¼’t
;

37 
š_pÜt_t
 
pÜt_be
;

38 
boŞ
 
ho¡Çme_is_®Ÿs
;

39 } 
	tas_add»ss_™”©Ü
;

49 
as_¡©us


50 
as_lookup_ho¡
(
as_add»ss_™”©Ü
* 
™”
, 
as_”rÜ
* 
”r
, cÚ¡ * 
ho¡Çme
, 
š_pÜt_t
 
pÜt
);

56 
šlše
 
boŞ


57 
as_lookup_Ãxt
(
as_add»ss_™”©Ü
* 
™”
, 
sockaddr
** 
addr
)

59 ià(! 
™”
->
cu¼’t
) {

60  
çl£
;

63 
sockaddr
* 
§
 = 
™”
->
cu¼’t
->
ai_addr
;

64 
™”
->
cu¼’t
 = i‹r->cu¼’t->
ai_Ãxt
;

66 ià(
§
->
§_çmy
 =ğ
AF_INET
) {

67 ((
sockaddr_š
*)
§
)->
sš_pÜt
 = 
™”
->
pÜt_be
;

70 ((
sockaddr_š6
*)
§
)->
sš6_pÜt
 = 
™”
->
pÜt_be
;

72 *
addr
 = 
§
;

73  
Œue
;

80 
šlše
 

81 
as_lookup_’d
(
as_add»ss_™”©Ü
* 
™”
)

83 
ä“addršfo
(
™”
->
add»s£s
);

90 
as_¡©us


91 
as_lookup_node
(
as_şu¡”
* 
şu¡”
, 
as_”rÜ
* 
”r
, cÚ¡ * 
s_Çme
, 
sockaddr
* 
addr
, 
as_node_šfo
* 
node_šfo
);

93 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_map.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_™”©Ü.h
>

21 
	~<«ro¥ike/as_ut.h
>

22 
	~<«ro¥ike/as_v®.h
>

24 
	~<¡dboŞ.h
>

25 
	~<¡dšt.h
>

27 #ifdeà
__ılu¥lus


35 
as_m­_™”©Ü_u
;

37 
as_m­_hooks_s
;

50 
boŞ
 (* 
	tas_m­_fÜ—ch_ÿÎback
è(cÚ¡ 
	tas_v®
 * 
	tkey
, cÚ¡‡s_v® * 
	tv®ue
, * 
	tud©a
);

61 
	sas_m­_s
 {

68 
as_v®
 
_
;

73 
ušt32_t
 
æags
;

78 cÚ¡ 
as_m­_hooks_s
 * 
hooks
;

80 } 
	tas_m­
;

85 
	sas_m­_hooks_s
 {

98 
boŞ
 (* 
de¡roy
)(
as_m­
 * 
m­
);

111 
ušt32_t
 (* 
hashcode
)(cÚ¡ 
as_m­
 * 
m­
);

120 
ušt32_t
 (* 
size
)(cÚ¡ 
as_m­
 * 
m­
);

135 (* 
£t
)(
as_m­
 * 
m­
, cÚ¡ 
as_v®
 * 
key
, cÚ¡‡s_v® * 
v®
);

145 
as_v®
 * (* 
g‘
)(cÚ¡ 
as_m­
 * 
m­
, cÚ¡‡s_v® * 
key
);

154 (* 
ş—r
)(
as_m­
 * 
m­
);

164 (* 
»move
)(
as_m­
 * 
m­
, cÚ¡ 
as_v®
 * 
key
);

179 
boŞ
 (* 
fÜ—ch
)(cÚ¡ 
as_m­
 * 
m­
, 
as_m­_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
);

188 
as_m­_™”©Ü_u
 * (* 
™”©Ü_Ãw
)(cÚ¡ 
as_m­
 * 
m­
);

197 
as_m­_™”©Ü_u
 * (* 
™”©Ü_š™
)(cÚ¡ 
as_m­
 * 
m­
, as_m­_™”©Ü_u * 
™
);

199 } 
	tas_m­_hooks
;

217 
as_m­
 * 
as_m­_cÚs
×s_m­ * 
m­
, 
boŞ
 
ä“
, 
ušt32_t
 
æags
, cÚ¡ 
as_m­_hooks
 * 
hooks
);

228 
as_m­
 * 
as_m­_š™
×s_m­ * 
m­
, cÚ¡ 
as_m­_hooks
 * 
hooks
);

238 
as_m­
 * 
as_m­_Ãw
(cÚ¡ 
as_m­_hooks
 * 
hooks
);

244 
šlše
 
as_m­_de¡roy
(
as_m­
 * 
m­
)

246 
as_v®_de¡roy
((
as_v®
 *è
m­
);

261 
šlše
 
ušt32_t
 
as_m­_hashcode
(cÚ¡ 
as_m­
 * 
m­
)

263  
as_ut_hook
(
hashcode
, 0, 
m­
);

274 
šlše
 
ušt32_t
 
as_m­_size
(cÚ¡ 
as_m­
 * 
m­
)

276  
as_ut_hook
(
size
, 0, 
m­
);

292 
šlše
 
as_v®
 * 
as_m­_g‘
(cÚ¡ 
as_m­
 * 
m­
, cÚ¡‡s_v® * 
key
)

294  
as_ut_hook
(
g‘
, 
NULL
, 
m­
, 
key
);

307 
šlše
 
as_m­_£t
(
as_m­
 * 
m­
, cÚ¡ 
as_v®
 * 
key
, cÚ¡‡s_v® * 
v®
)

309  
as_ut_hook
(
£t
, 1, 
m­
, 
key
, 
v®
);

320 
šlše
 
as_m­_ş—r
(
as_m­
 * 
m­
)

322  
as_ut_hook
(
ş—r
, 1, 
m­
);

335 
šlše
 
as_m­_»move
(
as_m­
 * 
m­
, cÚ¡ 
as_v®
 * 
key
)

337  
as_ut_hook
(
»move
, 1, 
m­
, 
key
);

355 
šlše
 
boŞ
 
as_m­_fÜ—ch
(cÚ¡ 
as_m­
 * 
m­
, 
as_m­_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
)

357  
as_ut_hook
(
fÜ—ch
, 
çl£
, 
m­
, 
ÿÎback
, 
ud©a
);

368 
šlše
 
as_m­_™”©Ü_u
 * 
as_m­_™”©Ü_Ãw
(cÚ¡ 
as_m­
 * 
m­
)

370  
as_ut_hook
(
™”©Ü_Ãw
, 
NULL
, 
m­
);

382 
šlše
 
as_m­_™”©Ü_u
 * 
as_m­_™”©Ü_š™
(as_m­_™”©Ü_u * 
™
, cÚ¡ 
as_m­
 * 
m­
)

384  
as_ut_hook
(
™”©Ü_š™
, 
NULL
, 
m­
, 
™
);

395 
šlše
 
as_v®
 * 
as_m­_tov®
(cÚ¡ 
as_m­
 * 
m­
)

397  (
as_v®
 *è
m­
;

404 
šlše
 
as_m­
 * 
as_m­_äomv®
(cÚ¡ 
as_v®
 * 
v®
)

406  
as_ut_äomv®
(
v®
, 
AS_MAP
, 
as_m­
);

417 
as_m­_v®_de¡roy
(
as_v®
 * 
v®
);

423 
ušt32_t
 
as_m­_v®_hashcode
(cÚ¡ 
as_v®
 * 
v®
);

429 * 
as_m­_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v®
);

431 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_map_iterator.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_hashm­_™”©Ü.h
>

22 #ifdeà
__ılu¥lus


33 
	uas_m­_™”©Ü_u
 {

35 
as_hashm­_™”©Ü
 
hashm­
;

37 } 
	tas_m­_™”©Ü
;

39 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_map_operations.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_İ”©iÚs.h
>

21 #ifdeà
__ılu¥lus


35 
	eas_m­_Üd”_e
 {

39 
AS_MAP_UNORDERED
 = 0,

44 
AS_MAP_KEY_ORDERED
 = 1,

49 
AS_MAP_KEY_VALUE_ORDERED
 = 3

50 } 
	tas_m­_Üd”
;

58 
	eas_m­_wr™e_mode_e
 {

63 
AS_MAP_UPDATE
,

69 
AS_MAP_UPDATE_ONLY
,

75 
AS_MAP_CREATE_ONLY


76 } 
	tas_m­_wr™e_mode
;

84 
	sas_m­_pŞicy_s
 {

85 
ušt64_t
 
©Œibu‹s
;

86 
™em_commªd
;

87 
™ems_commªd
;

88 } 
	tas_m­_pŞicy
;

96 
	eas_m­_»tuº_ty³_e
 {

100 
AS_MAP_RETURN_NONE
 = 0,

105 
AS_MAP_RETURN_INDEX
 = 1,

110 
AS_MAP_RETURN_REVERSE_INDEX
 = 2,

115 
AS_MAP_RETURN_RANK
 = 3,

120 
AS_MAP_RETURN_REVERSE_RANK
 = 4,

125 
AS_MAP_RETURN_COUNT
 = 5,

130 
AS_MAP_RETURN_KEY
 = 6,

135 
AS_MAP_RETURN_VALUE
 = 7,

140 
AS_MAP_RETURN_KEY_VALUE
 = 8

141 } 
	tas_m­_»tuº_ty³
;

154 
as_m­_pŞicy_š™
(
as_m­_pŞicy
* 
pŞicy
);

163 
as_m­_pŞicy_£t
(
as_m­_pŞicy
* 
pŞicy
, 
as_m­_Üd”
 
Üd”
, 
as_m­_wr™e_mode
 
mode
);

172 
boŞ


173 
as_İ”©iÚs_add_m­_£t_pŞicy
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_m­_pŞicy
* 
pŞicy
);

186 
boŞ


187 
as_İ”©iÚs_add_m­_put
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_m­_pŞicy
* 
pŞicy
, 
as_v®
* 
key
,‡s_v®* 
v®ue
);

200 
boŞ


201 
as_İ”©iÚs_add_m­_put_™ems
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_m­_pŞicy
* 
pŞicy
, 
as_m­
 *
™ems
);

215 
boŞ


216 
as_İ”©iÚs_add_m­_šüem’t
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_m­_pŞicy
* 
pŞicy
, 
as_v®
* 
key
,‡s_v®* 
v®ue
);

230 
boŞ


231 
as_İ”©iÚs_add_m­_deüem’t
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_m­_pŞicy
* 
pŞicy
, 
as_v®
* 
key
,‡s_v®* 
v®ue
);

240 
boŞ


241 
as_İ”©iÚs_add_m­_ş—r
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
);

250 
boŞ


251 
as_İ”©iÚs_add_m­_»move_by_key
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
key
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

260 
boŞ


261 
as_İ”©iÚs_add_m­_»move_by_key_li¡
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_li¡
* 
keys
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

274 
boŞ


275 
as_İ”©iÚs_add_m­_»move_by_key_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
begš
,‡s_v®* 
’d
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

284 
boŞ


285 
as_İ”©iÚs_add_m­_»move_by_v®ue
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
v®ue
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

294 
boŞ


295 
as_İ”©iÚs_add_m­_»move_by_v®ue_li¡
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_li¡
 *
™ems
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

308 
boŞ


309 
as_İ”©iÚs_add_m­_»move_by_v®ue_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
begš
,‡s_v®* 
’d
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

318 
boŞ


319 
as_İ”©iÚs_add_m­_»move_by_šdex
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

329 
boŞ


330 
as_İ”©iÚs_add_m­_»move_by_šdex_¿nge_to_’d
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

339 
boŞ


340 
as_İ”©iÚs_add_m­_»move_by_šdex_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
ušt64_t
 
couÁ
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

349 
boŞ


350 
as_İ”©iÚs_add_m­_»move_by_¿nk
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
¿nk
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

360 
boŞ


361 
as_İ”©iÚs_add_m­_»move_by_¿nk_¿nge_to_’d
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
¿nk
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

370 
boŞ


371 
as_İ”©iÚs_add_m­_»move_by_¿nk_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
¿nk
, 
ušt64_t
 
couÁ
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

381 
boŞ


382 
as_İ”©iÚs_add_m­_size
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
);

391 
boŞ


392 
as_İ”©iÚs_add_m­_g‘_by_key
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
key
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

405 
boŞ


406 
as_İ”©iÚs_add_m­_g‘_by_key_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
begš
,‡s_v®* 
’d
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

415 
boŞ


416 
as_İ”©iÚs_add_m­_g‘_by_v®ue
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
v®ue
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

429 
boŞ


430 
as_İ”©iÚs_add_m­_g‘_by_v®ue_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_v®
* 
begš
,‡s_v®* 
’d
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

439 
boŞ


440 
as_İ”©iÚs_add_m­_g‘_by_šdex
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

450 
boŞ


451 
as_İ”©iÚs_add_m­_g‘_by_šdex_¿nge_to_’d
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

460 
boŞ


461 
as_İ”©iÚs_add_m­_g‘_by_šdex_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
šdex
, 
ušt64_t
 
couÁ
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

470 
boŞ


471 
as_İ”©iÚs_add_m­_g‘_by_¿nk
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
¿nk
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

481 
boŞ


482 
as_İ”©iÚs_add_m­_g‘_by_¿nk_¿nge_to_’d
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
¿nk
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

491 
boŞ


492 
as_İ”©iÚs_add_m­_g‘_by_¿nk_¿nge
(
as_İ”©iÚs
* 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
¿nk
, 
ušt64_t
 
couÁ
, 
as_m­_»tuº_ty³
 
»tuº_ty³
);

494 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_memtracker.h

17 #´agm¨
Úû


19 
	~<¡dlib.h
>

20 
	~<¡d¬g.h
>

21 
	~<¡dboŞ.h
>

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


32 
as_memŒack”_hooks_s
;

33 
as_memŒack”_hooks_s
 
	tas_memŒack”_hooks
;

35 
as_memŒack”_s
;

36 
as_memŒack”_s
 
	tas_memŒack”
;

41 
	sas_memŒack”_hooks_s
 {

46 (* 
de¡roy
)(
as_memŒack”
 *);

48 
boŞ
 (* 
»£rve
)(cÚ¡ 
as_memŒack”
 *, cÚ¡ 
ušt32_t
);

49 
boŞ
 (* 
»Ëa£
)(cÚ¡ 
as_memŒack”
 *, cÚ¡ 
ušt32_t
);

50 
boŞ
 (* 
»£t
)(cÚ¡ 
as_memŒack”
 *);

56 
	sas_memŒack”_s
 {

57 
boŞ
 
is_m®loc
;

58 * 
sourû
;

59 cÚ¡ 
as_memŒack”_hooks
 * 
hooks
;

69 
as_memŒack”
 * 
as_memŒack”_š™
×s_memŒack” * 
memŒack”
, * 
sourû
, cÚ¡ 
as_memŒack”_hooks
 * 
hooks
);

74 
as_memŒack”
 * 
as_memŒack”_Ãw
(* 
sourû
, cÚ¡ 
as_memŒack”_hooks
 * 
hooks
);

77 
šlše
 * 
as_memŒack”_sourû
(cÚ¡ 
as_memŒack”
 * 
mt
) {

78  (
mt
 ? mt->
sourû
 : 
NULL
);

86 
as_memŒack”_de¡roy
(
as_memŒack”
 * 
memŒack”
);

91 
boŞ
 
as_memŒack”_»£rve
(cÚ¡ 
as_memŒack”
 * 
memŒack”
, cÚ¡ 
ušt32_t
 
num_by‹s
);

96 
boŞ
 
as_memŒack”_»Ëa£
(cÚ¡ 
as_memŒack”
 * 
memŒack”
, cÚ¡ 
ušt32_t
 
num_by‹s
);

101 
boŞ
 
as_memŒack”_»£t
(cÚ¡ 
as_memŒack”
 * 
memŒack”
);

103 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_module.h

17 #´agm¨
Úû


19 
	~<¡dlib.h
>

21 
	~<«ro¥ike/as_«ro¥ike.h
>

22 
	~<«ro¥ike/as_¡»am.h
>

23 
	~<«ro¥ike/as_»suÉ.h
>

24 
	~<«ro¥ike/as_ty³s.h
>

25 
	~<«ro¥ike/as_udf_cÚ‹xt.h
>

27 #ifdeà
__ılu¥lus


35 
as_moduË_s
;

45 
	eas_moduË_ev’t_ty³_e
 {

46 
AS_MODULE_EVENT_CONFIGURE
 = 0,

47 
AS_MODULE_EVENT_FILE_SCAN
 = 1,

48 
AS_MODULE_EVENT_FILE_ADD
 = 2,

49 
AS_MODULE_EVENT_FILE_REMOVE
 = 3,

50 
AS_MODULE_EVENT_CLEAR_CACHE
 = 4

51 } 
	tas_moduË_ev’t_ty³
;

53 
	sas_moduË_ev’t_d©a_s
 {

54 * 
cÚfig
;

55 cÚ¡ * 
f’ame
;

56 } 
	tas_moduË_ev’t_d©a
;

58 
	sas_moduË_ev’t_s
 {

59 
as_moduË_ev’t_ty³
 
ty³
;

60 
as_moduË_ev’t_d©a
 
d©a
;

61 } 
	tas_moduË_ev’t
;

63 
	sas_moduË_”rÜ_s
 {

64 
ušt8_t
 
scİe
;

65 
ušt32_t
 
code
;

66 
mes§ge
[1024];

67 
fe
[256];

68 
ušt32_t
 
lše
;

69 
func
[256];

70 } 
	tas_moduË_”rÜ
;

76 
	sas_moduË_hooks_s
 {

81 (* 
de¡roy
)(
as_moduË_s
 * 
m
);

86 (* 
upd©e
)(
as_moduË_s
 * 
m
, 
as_moduË_ev’t
 * 
e
);

91 (* 
v®id©e
)(
as_moduË_s
 * 
m
, 
as_«ro¥ike
 * 
as
, cÚ¡ * 
f’ame
, cÚ¡ * 
cÚ‹Á
, 
ušt32_t
 
size
, 
as_moduË_”rÜ
 * 
”r
);

96 (* 
­¶y_»cÜd
)(
as_moduË_s
 * 
m
, 
as_udf_cÚ‹xt
 *
ùx
, cÚ¡ * 
f’ame
, cÚ¡ * 
funùiÚ
, 
as_»c
 * 
»c
, 
as_li¡
 * 
¬gs
, 
as_»suÉ
 * 
»s
);

101 (* 
­¶y_¡»am
)(
as_moduË_s
 * 
m
, 
as_udf_cÚ‹xt
 *
ùx
, cÚ¡ * 
f’ame
, cÚ¡ * 
funùiÚ
, 
as_¡»am
 * 
i¡»am
, 
as_li¡
 * 
¬gs
,‡s_¡»am * 
o¡»am
, 
as_»suÉ
 *
»s
);

103 } 
	tas_moduË_hooks
;

113 
	sas_moduË_s
 {

114 cÚ¡ * 
sourû
;

115 cÚ¡ 
as_moduË_hooks
 * 
hooks
;

116 } 
	tas_moduË
;

128 * 
as_moduË_sourû
(
as_moduË
 * 
m
);

139 
as_moduË_de¡roy
(
as_moduË
 * 
m
);

151 
as_moduË_cÚfigu»
(
as_moduË
 * 
m
, * 
c
);

161 
as_moduË_upd©e
(
as_moduË
 * 
m
, 
as_moduË_ev’t
 * 
e
);

174 
as_moduË_v®id©e
(
as_moduË
 * 
m
, 
as_«ro¥ike
 * 
as
, cÚ¡ * 
f’ame
, cÚ¡ * 
cÚ‹Á
, 
ušt32_t
 
size
, 
as_moduË_”rÜ
 * 
”rÜ
);

189 
as_moduË_­¶y_»cÜd
(
as_moduË
 * 
m
, 
as_udf_cÚ‹xt
 * 
ùx
, cÚ¡ * 
f’ame
, cÚ¡ * 
funùiÚ
, 
as_»c
 * 
r
, 
as_li¡
 * 
¬gs
, 
as_»suÉ
 * 
»s
);

207 
as_moduË_­¶y_¡»am
(
as_moduË
 * 
m
, 
as_udf_cÚ‹xt
 * 
ùx
, cÚ¡ * 
f’ame
, cÚ¡ * 
funùiÚ
, 
as_¡»am
 * 
i¡»am
, 
as_li¡
 * 
¬gs
,‡s_¡»am * 
o¡»am
, 
as_»suÉ
 *
»s
);

214 *
as_moduË_”r_¡ršg
();

216 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_monitor.h

17 #´agm¨
Úû


19 
	~<±h»ad.h
>

20 
	~<¡dboŞ.h
>

23 
±h»ad_mu‹x_t
 
	mlock
;

24 
±h»ad_cÚd_t
 
	mcÚd
;

25 
boŞ
 
	mcom¶‘e
;

26 } 
	tas_mÚ™Ü
;

28 
šlše
 

29 
	$as_mÚ™Ü_š™
(
as_mÚ™Ü
* 
mÚ™Ü
)

31 
	`±h»ad_mu‹x_š™
(&
mÚ™Ü
->
lock
, 
NULL
);

32 
	`±h»ad_cÚd_š™
(&
mÚ™Ü
->
cÚd
, 
NULL
);

33 
mÚ™Ü
->
com¶‘e
 = 
çl£
;

34 
	}
}

36 
šlše
 

37 
	$as_mÚ™Ü_de¡roy
(
as_mÚ™Ü
* 
mÚ™Ü
)

39 
	`±h»ad_mu‹x_de¡roy
(&
mÚ™Ü
->
lock
);

40 
	`±h»ad_cÚd_de¡roy
(&
mÚ™Ü
->
cÚd
);

41 
	}
}

43 
šlše
 

44 
	$as_mÚ™Ü_begš
(
as_mÚ™Ü
* 
mÚ™Ü
)

46 
mÚ™Ü
->
com¶‘e
 = 
çl£
;

47 
	}
}

49 
šlše
 

50 
	$as_mÚ™Ü_nÙify
(
as_mÚ™Ü
* 
mÚ™Ü
)

52 
	`±h»ad_mu‹x_lock
(&
mÚ™Ü
->
lock
);

53 
mÚ™Ü
->
com¶‘e
 = 
Œue
;

54 
	`±h»ad_cÚd_sigÇl
(&
mÚ™Ü
->
cÚd
);

55 
	`±h»ad_mu‹x_uÆock
(&
mÚ™Ü
->
lock
);

56 
	}
}

58 
šlše
 

59 
	$as_mÚ™Ü_wa™
(
as_mÚ™Ü
* 
mÚ™Ü
)

61 
	`±h»ad_mu‹x_lock
(&
mÚ™Ü
->
lock
);

62 ! 
mÚ™Ü
->
com¶‘e
) {

63 
	`±h»ad_cÚd_wa™
(&
mÚ™Ü
->
cÚd
, &mÚ™Ü->
lock
);

65 
	`±h»ad_mu‹x_uÆock
(&
mÚ™Ü
->
lock
);

66 
	}
}

	@application/kvbench/include/aerospike/as_msgpack.h

17 #´agm¨
Úû


19 
	~<¡dboŞ.h
>

21 
	~<«ro¥ike/as_£rŸliz”.h
>

23 #ifdeà
__ılu¥lus


27 
	#AS_PACKER_BUFFER_SIZE
 8192

	)

29 
	#AS_PACKED_MAP_FLAG_NONE
 0x00

	)

30 
	#AS_PACKED_MAP_FLAG_K_ORDERED
 0x01

	)

31 
	#AS_PACKED_MAP_FLAG_V_ORDERED
 0x02

32 
	#AS_PACKED_MAP_FLAG_PRESERVE_ORDER
 0x08

	)

33 
	#AS_PACKED_MAP_FLAG_KV_ORDERED
 (
AS_PACKED_MAP_FLAG_K_ORDERED
 | 
AS_PACKED_MAP_FLAG_V_ORDERED
)

	)

35 
	sas_·ck”_bufãr
 {

36 
as_·ck”_bufãr
 *
Ãxt
;

37 *
bufãr
;

38 
Ëngth
;

39 } 
	tas_·ck”_bufãr
;

41 
	sas_·ck”
 {

42 
as_·ck”_bufãr
 *
h—d
;

43 
as_·ck”_bufãr
 *

;

44 *
bufãr
;

45 
off£t
;

46 
ÿ·c™y
;

47 } 
	tas_·ck”
;

49 
	sas_uÅack”
 {

50 cÚ¡ *
bufãr
;

51 
off£t
;

52 
Ëngth
;

53 } 
	tas_uÅack”
;

55 
	sas_msg·ck_ext_s
 {

56 cÚ¡ 
ušt8_t
 *
d©a
;

57 
ušt32_t
 
size
;

58 
ušt32_t
 
ty³_off£t
;

59 
ušt8_t
 
ty³
;

60 } 
	tas_msg·ck_ext
;

62 
	emsg·ck_com·»_e
 {

63 
MSGPACK_COMPARE_ERROR
 = -2,

64 
MSGPACK_COMPARE_END
 = -1,

65 
MSGPACK_COMPARE_LESS
 = 0,

66 
MSGPACK_COMPARE_EQUAL
 = 1,

67 
MSGPACK_COMPARE_GREATER
 = 2,

68 } 
	tmsg·ck_com·»_t
;

74 
as_£rŸliz”
 *
as_msg·ck_Ãw
();

75 
as_£rŸliz”
 *
as_msg·ck_š™
(as_serializer *);

80 
as_·ck_v®
(
as_·ck”
 *
pk
, cÚ¡ 
as_v®
 *
v®
);

84 
as_uÅack_v®
(
as_uÅack”
 *
pk
, 
as_v®
 **
v®
);

90 
šlše
 
ušt32_t
 
as_·ck_n_size
()

94 
šlše
 
ušt32_t
 
as_·ck_boŞ_size
()

98 
as_·ck_n
(
as_·ck”
 *
pk
);

99 
as_·ck_boŞ
(
as_·ck”
 *
pk
, 
boŞ
 
v®
);

101 
ušt32_t
 
as_·ck_ušt64_size
(
ušt64_t
 
v®
);

102 
ušt32_t
 
as_·ck_št64_size
(
št64_t
 
v®
);

103 
as_·ck_ušt64
(
as_·ck”
 *
pk
, 
ušt64_t
 
v®
);

104 
as_·ck_št64
(
as_·ck”
 *
pk
, 
št64_t
 
v®
);

106 
šlše
 
ušt32_t
 
as_·ck_æßt_size
()

110 
šlše
 
ušt32_t
 
as_·ck_doubË_size
()

118 
as_·ck_æßt
(
as_·ck”
 *
pk
, 
v®
);

119 
as_·ck_doubË
(
as_·ck”
 *
pk
, 
v®
);

121 
ušt32_t
 
as_·ck_¡r_size
(ušt32_ˆ
¡r_sz
);

122 
ušt32_t
 
as_·ck_bš_size
(ušt32_ˆ
buf_sz
);

127 
as_·ck_¡r
(
as_·ck”
 *
pk
, cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 
sz
);

128 
as_·ck_bš
(
as_·ck”
 *
pk
, cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 
sz
);

133 
as_·ck_li¡_h—d”
(
as_·ck”
 *
pk
, 
ušt32_t
 
–e_couÁ
);

138 
ušt32_t
 
as_·ck_li¡_h—d”_g‘_size
(ušt32_ˆ
–e_couÁ
);

143 
as_·ck_m­_h—d”
(
as_·ck”
 *
pk
, 
ušt32_t
 
–e_couÁ
);

148 
šlše
 
ušt32_t
 
as_·ck_m­_h—d”_g‘_size
(ušt32_ˆ
–e_couÁ
)

150  
as_·ck_li¡_h—d”_g‘_size
(
–e_couÁ
);

157 
ušt32_t
 
as_·ck_ext_h—d”_g‘_size
(ušt32_ˆ
cÚ‹Á_size
);

162 
as_·ck_ext_h—d”
(
as_·ck”
 *
pk
, 
ušt32_t
 
cÚ‹Á_size
, 
ušt8_t
 
ty³
);

163 
as_·ck_buf_ext_h—d”
(
ušt8_t
 *
buf
, 
ušt32_t
 
size
, ušt32_ˆ
cÚ‹Á_size
, ušt8_ˆ
ty³
);

165 
as_·ck_­³nd
(
as_·ck”
 *
pk
, cÚ¡ *
buf
, 
ušt32_t
 
sz
);

175 
as_v®_t
 
as_uÅack_³ek_ty³
(cÚ¡ 
as_uÅack”
 *
pk
);

176 
as_v®_t
 
as_uÅack_buf_³ek_ty³
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 
size
);

181 
boŞ
 
as_uÅack_³ek_is_ext
(cÚ¡ 
as_uÅack”
 *
pk
);

186 
št64_t
 
as_uÅack_size
(
as_uÅack”
 *
pk
);

191 
št64_t
 
as_uÅack_blob_size
(
as_uÅack”
 *
pk
);

196 
as_uÅack_št64
(
as_uÅack”
 *
pk
, 
št64_t
 *
i
);

197 
as_uÅack_ušt64
(
as_uÅack”
 *
pk
, 
ušt64_t
 *
i
);

202 
as_uÅack_doubË
(
as_uÅack”
 *
pk
, *
x
);

207 cÚ¡ 
ušt8_t
 *
as_uÅack_¡r
(
as_uÅack”
 *
pk
, 
ušt32_t
 *
sz_r
);

212 cÚ¡ 
ušt8_t
 *
as_uÅack_bš
(
as_uÅack”
 *
pk
, 
ušt32_t
 *
sz_r
);

217 
as_uÅack_ext
(
as_uÅack”
 *
pk
, 
as_msg·ck_ext
 *
ext
);

221 
št64_t
 
as_uÅack_buf_li¡_–em’t_couÁ
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 
size
);

226 
št64_t
 
as_uÅack_li¡_h—d”_–em’t_couÁ
(
as_uÅack”
 *
pk
);

230 
št64_t
 
as_uÅack_buf_m­_–em’t_couÁ
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 
size
);

235 
št64_t
 
as_uÅack_m­_h—d”_–em’t_couÁ
(
as_uÅack”
 *
pk
);

240 
msg·ck_com·»_t
 
as_uÅack_buf_com·»
(cÚ¡ 
ušt8_t
 *
buf1
, 
ušt32_t
 
size1
, cÚ¡ ušt8_ˆ*
buf2
, ušt32_ˆ
size2
);

241 
msg·ck_com·»_t
 
as_uÅack_com·»
(
as_uÅack”
 *
pk1
,‡s_uÅack” *
pk2
);

246 
šlše
 
boŞ
 
as_uÅack_buf_is_Ëss
(cÚ¡ 
ušt8_t
 *
buf1
, 
ušt32_t
 
size1
, cÚ¡ ušt8_ˆ*
buf2
, ušt32_ˆ
size2
)

248  
as_uÅack_buf_com·»
(
buf1
, 
size1
, 
buf2
, 
size2
è=ğ
MSGPACK_COMPARE_LESS
;

251 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_msgpack_serializer.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_msg·ck.h
>

20 
	~<«ro¥ike/as_£rŸliz”.h
>

22 #ifdeà
__ılu¥lus


33 
as_£rŸliz”
 *
as_msg·ck_Ãw
();

38 
as_£rŸliz”
 *
as_msg·ck_š™
(as_serializer *);

40 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_nil.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_v®.h
>

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


36 cÚ¡ 
as_v®
 
as_n
;

46 
as_n_v®_de¡roy
(
as_v®
 * 
v
);

52 
ušt32_t
 
as_n_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

58 * 
as_n_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

60 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_node.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_”rÜ.h
>

20 
	~<«ro¥ike/as_ev’t.h
>

21 
	~<«ro¥ike/as_sock‘.h
>

22 
	~<«ro¥ike/as_queue.h
>

23 
	~<«ro¥ike/as_veùÜ.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<sys/uio.h
>

27 #ifdeà
__ılu¥lus


32 
	~<«ro¥ike/ck/ck_´.h
>

41 
	#AS_HOSTNAME_SIZE
 256

	)

46 
	#AS_NODE_NAME_SIZE
 20

	)

49 
	#AS_NODE_NAME_MAX_SIZE
 
AS_NODE_NAME_SIZE


	)

51 
	#AS_FEATURES_GEO
 (1 << 0)

	)

52 
	#AS_FEATURES_DOUBLE
 (1 << 1)

	)

53 
	#AS_FEATURES_BATCH_INDEX
 (1 << 2)

	)

54 
	#AS_FEATURES_REPLICAS_ALL
 (1 << 3)

	)

55 
	#AS_FEATURES_PIPELINING
 (1 << 4)

	)

56 
	#AS_FEATURES_PEERS
 (1 << 5)

	)

57 
	#AS_FEATURES_REPLICAS
 (1 << 6)

	)

59 
	#AS_ADDRESS4_MAX
 4

	)

60 
	#AS_ADDRESS6_MAX
 8

	)

69 
	sas_add»ss_s
 {

73 
sockaddr_¡Üage
 
addr
;

78 
Çme
[
AS_IP_ADDRESS_SIZE
];

80 } 
	tas_add»ss
;

86 
	sas_®Ÿs_s
 {

91 
Çme
[
AS_HOSTNAME_SIZE
];

97 
š_pÜt_t
 
pÜt
;

99 } 
	tas_®Ÿs
;

105 
	sas_cÚn_poŞ_s
 {

110 
as_queue
 
queue
;

117 
ušt32_t
 
tÙ®
;

123 
ušt32_t
 
lim™
;

125 } 
	tas_cÚn_poŞ
;

131 
	sas_cÚn_poŞ_lock_s
 {

136 
±h»ad_mu‹x_t
 
lock
;

142 
as_cÚn_poŞ
 
poŞ
;

144 } 
	tas_cÚn_poŞ_lock
;

146 
as_şu¡”_s
;

151 
	sas_node_s
 {

156 
ušt32_t
 
»f_couÁ
;

162 
ušt32_t
 
·¹™iÚ_g’”©iÚ
;

168 * 
s_Çme
;

173 
Çme
[
AS_NODE_NAME_SIZE
];

179 
ušt32_t
 
add»ss_šdex
;

185 
ušt32_t
 
add»ss4_size
;

191 
ušt32_t
 
add»ss6_size
;

197 
as_add»ss
* 
add»s£s
;

203 
as_veùÜ
 
®Ÿ£s
;

205 
as_şu¡”_s
* 
şu¡”
;

211 
as_cÚn_poŞ_lock
* 
cÚn_poŞ_locks
;

218 
as_cÚn_poŞ
* 
async_cÚn_poŞs
;

224 
as_cÚn_poŞ
* 
pe_cÚn_poŞs
;

230 
as_sock‘
 
šfo_sock‘
;

236 
ušt32_t
 
ã©u»s
;

242 
ušt32_t
 
cÚn_™”
;

248 
ušt32_t
 
³”s_g’”©iÚ
;

254 
ušt32_t
 
³”s_couÁ
;

260 
ušt32_t
 
ä›nds
;

266 
ušt32_t
 
çu»s
;

272 
ušt32_t
 
šdex
;

278 
ušt8_t
 
aùive
;

284 
boŞ
 
·¹™iÚ_chªged
;

286 } 
	tas_node
;

292 
	sas_node_šfo_s
 {

297 
Çme
[
AS_NODE_NAME_SIZE
];

303 
ušt32_t
 
ã©u»s
;

309 
as_sock‘
 
sock‘
;

311 } 
	tas_node_šfo
;

322 
šlše
 

323 
as_cÚn_poŞ_š™
(
as_cÚn_poŞ
* 
poŞ
, 
ušt32_t
 
size
, ušt32_ˆ
lim™
)

325 
poŞ
->
lim™
 =†imit;

326 
poŞ
->
tÙ®
 = 0;

328 
as_queue_š™
(&
poŞ
->
queue
, 
size
, 
lim™
);

335 
šlše
 

336 
as_cÚn_poŞ_de¡roy
(
as_cÚn_poŞ
* 
poŞ
)

338 
as_queue_de¡roy
(&
poŞ
->
queue
);

345 
šlše
 

346 
as_cÚn_poŞ_dec
(
as_cÚn_poŞ
* 
poŞ
)

348 
poŞ
->
tÙ®
--;

355 
šlše
 
boŞ


356 
as_cÚn_poŞ_šc
(
as_cÚn_poŞ
* 
poŞ
)

358 ià(
poŞ
->
tÙ®
 >ğpoŞ->
lim™
) {

359  
çl£
;

362 
poŞ
->
tÙ®
++;

363  
Œue
;

370 
šlše
 
boŞ


371 
as_cÚn_poŞ_g‘
(
as_cÚn_poŞ
* 
poŞ
, * 
cÚn
)

373  
as_queue_pİ
(&
poŞ
->
queue
, 
cÚn
);

380 
šlše
 
boŞ


381 
as_cÚn_poŞ_put
(
as_cÚn_poŞ
* 
poŞ
, * 
cÚn
)

383 ià(
poŞ
->
tÙ®
 >…oŞ->
lim™
) {

384  
çl£
;

387  
as_queue_push
(&
poŞ
->
queue
, 
cÚn
);

394 
as_node
*

395 
as_node_ü—‹
(

396 
as_şu¡”_s
* 
şu¡”
, cÚ¡ * 
ho¡Çme
, cÚ¡ * 
s_Çme
,

397 
š_pÜt_t
 
pÜt
, 
boŞ
 
is_®Ÿs
, 
sockaddr
* 
addr
, 
as_node_šfo
* 
node_šfo


405 
as_node_de¡roy
(
as_node
* 
node
);

411 
šlše
 

412 
as_node_d—ùiv©e
(
as_node
* 
node
)

415 
ck_´_¡Üe_8
(&
node
->
aùive
, 
çl£
);

422 
šlše
 

423 
as_node_»£rve
(
as_node
* 
node
)

426 
ck_´_šc_32
(&
node
->
»f_couÁ
);

433 
šlše
 

434 
as_node_»Ëa£
(
as_node
* 
node
)

438 
boŞ
 
de¡roy
;

439 
ck_´_dec_32_z”o
(&
node
->
»f_couÁ
, &
de¡roy
);

441 ià(
de¡roy
) {

442 
as_node_de¡roy
(
node
);

451 
as_node_add_add»ss
(
as_node
* 
node
, 
sockaddr
* 
addr
);

458 
as_node_add_®Ÿs
(
as_node
* 
node
, cÚ¡ * 
ho¡Çme
, 
š_pÜt_t
 
pÜt
);

463 
šlše
 
as_add»ss
*

464 
as_node_g‘_add»ss
(
as_node
* 
node
)

466  &
node
->
add»s£s
[node->
add»ss_šdex
];

472 
šlše
 const *

473 
as_node_g‘_add»ss_¡ršg
(
as_node
* 
node
)

475  
node
->
add»s£s
[node->
add»ss_šdex
].
Çme
;

482 
as_¡©us


483 
as_node_auth’tiÿ‹_cÚÃùiÚ
(
as_şu¡”_s
* 
şu¡”
, cÚ¡ * 
u£r
, cÚ¡ * 
·sswÜd
);

489 
as_¡©us


490 
as_node_g‘_cÚÃùiÚ
(
as_”rÜ
* 
”r
, 
as_node
* 
node
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše_ms
, 
as_sock‘
* 
sock
);

496 
šlše
 

497 
as_node_şo£_cÚÃùiÚ
(
as_sock‘
* 
sock
) {

498 
as_cÚn_poŞ_lock
* 
poŞ_lock
 = 
sock
->pool_lock;

499 
as_sock‘_şo£
(
sock
);

500 
±h»ad_mu‹x_lock
(&
poŞ_lock
->
lock
);

501 
as_cÚn_poŞ_dec
(&
poŞ_lock
->
poŞ
);

502 
±h»ad_mu‹x_uÆock
(&
poŞ_lock
->
lock
);

509 
šlše
 

510 
as_node_put_cÚÃùiÚ
(
as_sock‘
* 
sock
, 
ušt32_t
 
max_sock‘_idË
)

513 
as_cÚn_poŞ_lock
* 
poŞ_lock
 = 
sock
->pool_lock;

516 ià(
max_sock‘_idË
 =ğ0 && 
sock
->
ùx
) {

517 
max_sock‘_idË
 = 55;

520 ià(
max_sock‘_idË
 > 0) {

521 
sock
->
idË_check
.
max_sock‘_idË
 = max_socket_idle;

522 
sock
->
idË_check
.
Ï¡_u£d
 = (
ušt32_t
)
cf_g‘_£cÚds
();

525 
sock
->
idË_check
.
max_sock‘_idË
 = sock->idË_check.
Ï¡_u£d
 = 0;

529 
±h»ad_mu‹x_lock
(&
poŞ_lock
->
lock
);

530 
boŞ
 
¡©us
 = 
as_cÚn_poŞ_put
(&
poŞ_lock
->
poŞ
, 
sock
);

531 
±h»ad_mu‹x_uÆock
(&
poŞ_lock
->
lock
);

533 ià(! 
¡©us
) {

534 
as_sock‘_şo£
(
sock
);

535 
±h»ad_mu‹x_lock
(&
poŞ_lock
->
lock
);

536 
as_cÚn_poŞ_dec
(&
poŞ_lock
->
poŞ
);

537 
±h»ad_mu‹x_uÆock
(&
poŞ_lock
->
lock
);

545 
šlše
 
boŞ


546 
as_ho¡_equ®s
(
as_ho¡
* 
h1
,‡s_ho¡* 
h2
)

548  
¡rcmp
(
h1
->
Çme
, 
h2
->Çmeè=ğ0 && h1->
pÜt
 == h2->port;

551 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_operations.h

17 #´agm¨
Úû


19 
	~<¡dboŞ.h
>

20 
	~<¡dšt.h
>

21 
	~<«ro¥ike/as_bš.h
>

23 #ifdeà
__ılu¥lus


34 
	eas_İ”©Ü_e
 {

39 
AS_OPERATOR_READ
 = 1,

44 
AS_OPERATOR_WRITE
 = 2,

46 
AS_OPERATOR_CDT_READ
 = 3,

47 
AS_OPERATOR_CDT_MODIFY
 = 4,

49 
AS_OPERATOR_MAP_READ
 = 6,

50 
AS_OPERATOR_MAP_MODIFY
 = 7,

56 
AS_OPERATOR_INCR
 = 5,

62 
AS_OPERATOR_APPEND
 = 9,

68 
AS_OPERATOR_PREPEND
 = 10,

73 
AS_OPERATOR_TOUCH
 = 11

75 } 
	tas_İ”©Ü
;

81 
	sas_bšİ_s
 {

86 
as_İ”©Ü
 
İ
;

91 
as_bš
 
bš
;

93 } 
	tas_bšİ
;

108 
	sas_bšİs_s
 {

114 
boŞ
 
_ä“
;

119 
ušt16_t
 
ÿ·c™y
;

124 
ušt16_t
 
size
;

129 
as_bšİ
 * 
’Œ›s
;

131 } 
	tas_bšİs
;

281 
	sas_İ”©iÚs_s
 {

287 
boŞ
 
_ä“
;

292 
ušt16_t
 
g’
;

297 
ušt32_t
 
‰l
;

302 
as_bšİs
 
bšİs
;

304 } 
	tas_İ”©iÚs
;

328 
	#as_İ”©iÚs_š™a
(
__İs
, 
__nİs
) \

329 (
__İs
)->
_ä“
 = 
çl£
;\

330 (
__İs
)->
g’
 = 0;\

331 (
__İs
)->
‰l
 = 0;\

332 (
__İs
)->
bšİs
.
_ä“
 = 
çl£
;\

333 (
__İs
)->
bšİs
.
ÿ·c™y
 = (
__nİs
);\

334 (
__İs
)->
bšİs
.
size
 = 0;\

335 (
__İs
)->
bšİs
.
’Œ›s
 = (
as_bšİ
*è
	`®loÿ
(×s_bšİè* (
__nİs
));

	)

362 
as_İ”©iÚs
 * 
as_İ”©iÚs_š™
×s_İ”©iÚ * 
İs
, 
ušt16_t
 
nİs
);

383 
as_İ”©iÚs
 * 
as_İ”©iÚs_Ãw
(
ušt16_t
 
nİs
);

397 
as_İ”©iÚs_de¡roy
(
as_İ”©iÚs
 * 
İs
);

411 
boŞ
 
as_İ”©iÚs_add_wr™e
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_bš_v®ue
 * 
v®ue
);

425 
boŞ
 
as_İ”©iÚs_add_wr™e_št64
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
v®ue
);

439 
boŞ
 
as_İ”©iÚs_add_wr™e_doubË
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
v®ue
);

454 
boŞ
 
as_İ”©iÚs_add_wr™e_¡½
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, boŞ 
ä“
);

468 
šlše
 
boŞ
 
as_İ”©iÚs_add_wr™e_¡r
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

470  
as_İ”©iÚs_add_wr™e_¡½
(
İs
, 
Çme
, 
v®ue
, 
çl£
);

486 
boŞ
 
as_İ”©iÚs_add_wr™e_geojsÚ_¡½
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, boŞ 
ä“
);

500 
šlše
 
boŞ
 
as_İ”©iÚs_add_wr™e_geojsÚ_¡r
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

502  
as_İ”©iÚs_add_wr™e_geojsÚ_¡½
(
İs
, 
Çme
, 
v®ue
, 
çl£
);

519 
boŞ
 
as_İ”©iÚs_add_wr™e_¿wp
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, boŞ 
ä“
);

534 
šlše
 
boŞ
 
as_İ”©iÚs_add_wr™e_¿w
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
)

536  
as_İ”©iÚs_add_wr™e_¿wp
(
İs
, 
Çme
, 
v®ue
, 
size
, 
çl£
);

550 
boŞ
 
as_İ”©iÚs_add_»ad
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
);

564 
boŞ
 
as_İ”©iÚs_add_šü
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
v®ue
);

578 
boŞ
 
as_İ”©iÚs_add_šü_doubË
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, 
v®ue
);

593 
boŞ
 
as_İ”©iÚs_add_´•’d_¡½
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, boŞ 
ä“
);

607 
šlše
 
boŞ
 
as_İ”©iÚs_add_´•’d_¡r
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

609  
as_İ”©iÚs_add_´•’d_¡½
(
İs
, 
Çme
, 
v®ue
, 
çl£
);

626 
boŞ
 
as_İ”©iÚs_add_´•’d_¿wp
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, boŞ 
ä“
);

641 
šlše
 
boŞ
 
as_İ”©iÚs_add_´•’d_¿w
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
)

643  
as_İ”©iÚs_add_´•’d_¿wp
(
İs
, 
Çme
, 
v®ue
, 
size
, 
çl£
);

659 
boŞ
 
as_İ”©iÚs_add_­³nd_¡½
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, boŞ 
ä“
);

673 
šlše
 
boŞ
 
as_İ”©iÚs_add_­³nd_¡r
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

675  
as_İ”©iÚs_add_­³nd_¡½
(
İs
, 
Çme
, 
v®ue
, 
çl£
);

692 
boŞ
 
as_İ”©iÚs_add_­³nd_¿wp
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, boŞ 
ä“
);

707 
šlše
 
boŞ
 
as_İ”©iÚs_add_­³nd_¿w
(
as_İ”©iÚs
 * 
İs
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
)

709  
as_İ”©iÚs_add_­³nd_¿wp
(
İs
, 
Çme
, 
v®ue
, 
size
, 
çl£
);

722 
boŞ
 
as_İ”©iÚs_add_touch
(
as_İ”©iÚs
 * 
İs
);

730 
	~<«ro¥ike/as_li¡_İ”©iÚs.h
>

732 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_pair.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dšt.h
>

25 #ifdeà
__ılu¥lus


33 
	#·œ_Ãw
(
a
,
b
è
	`as_·œ_Ãw
((
as_v®
 *èa, (as_v® *èb)

	)

43 
	sas_·œ_s
 {

50 
as_v®
 
_
;

55 
as_v®
 * 
_1
;

60 
as_v®
 * 
_2
;

62 } 
	tas_·œ
;

78 
as_·œ
 * 
as_·œ_Ãw
(
as_v®
 * 
_1
,‡s_v® * 
_2
);

91 
as_·œ
 * 
as_·œ_š™
×s_·œ * 
·œ
, 
as_v®
 * 
_1
,‡s_v® * 
_2
);

98 
šlše
 
as_·œ_de¡roy
(
as_·œ
 * 
·œ
)

100 
as_v®_de¡roy
((
as_v®
 *è
·œ
);

112 
šlše
 
as_v®
 * 
as_·œ_1
(
as_·œ
 * 
·œ
)

114  
·œ
 ?…aœ->
_1
 : 
NULL
;

120 
šlše
 
as_v®
 * 
as_·œ_2
(
as_·œ
 * 
·œ
)

122  
·œ
 ?…aœ->
_2
 : 
NULL
;

134 
šlše
 
as_v®
 * 
as_·œ_tov®
(cÚ¡ 
as_·œ
 * 
·œ
)

136  (
as_v®
 *è
·œ
;

144 
šlše
 
as_·œ
 * 
as_·œ_äomv®
(cÚ¡ 
as_v®
 * 
v
)

146  
as_ut_äomv®
(
v
, 
AS_PAIR
, 
as_·œ
);

157 
as_·œ_v®_de¡roy
(
as_v®
 *);

163 
ušt32_t
 
as_·œ_v®_hashcode
(cÚ¡ 
as_v®
 *);

169 * 
as_·œ_v®_to¡ršg
(cÚ¡ 
as_v®
 *);

171 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_partition.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_node.h
>

21 #ifdeà
__ılu¥lus


32 
	#AS_MAX_NAMESPACE_SIZE
 32

	)

42 
	sas_·¹™iÚ_s
 {

47 
as_node
* 
ma¡”
;

54 
as_node
* 
´Şe
;

60 
ušt32_t
 
»gime
;

61 } 
	tas_·¹™iÚ
;

67 
	sas_·¹™iÚ_bË_s
 {

72 
ns
[
AS_MAX_NAMESPACE_SIZE
];

78 
boŞ
 
ı_mode
;

79 
·d
[3];

85 
ušt32_t
 
size
;

91 
as_·¹™iÚ
 
·¹™iÚs
[];

92 } 
	tas_·¹™iÚ_bË
;

98 
	sas_·¹™iÚ_bËs_s
 {

103 
ušt32_t
 
»f_couÁ
;

109 
ušt32_t
 
size
;

115 
as_·¹™iÚ_bË
* 
¬¿y
[];

116 } 
	tas_·¹™iÚ_bËs
;

126 
as_·¹™iÚ_bËs
*

127 
as_·¹™iÚ_bËs_ü—‹
(
ušt32_t
 
ÿ·c™y
);

134 
as_·¹™iÚ_bË_de¡roy
(
as_·¹™iÚ_bË
* 
bË
);

140 
as_·¹™iÚ_bË
*

141 
as_·¹™iÚ_bËs_g‘
(
as_·¹™iÚ_bËs
* 
bËs
, cÚ¡ * 
ns
);

147 
boŞ


148 
as_·¹™iÚ_bËs_fšd_node
(
as_·¹™iÚ_bËs
* 
bËs
, 
as_node
* 
node
);

154 
šlše
 
ušt32_t


155 
as_·¹™iÚ_g‘id
(cÚ¡ 
ušt8_t
* 
dige¡
, 
ušt32_t
 
n_·¹™iÚs
)

157  (*(
ušt16_t
*)
dige¡
è& (
n_·¹™iÚs
 - 1);

160 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_password.h

17 #´agm¨
Úû


19 
	~<¡ršg.h
>

20 
	~"c™ru¦—f/cf_ty³s.h
"

22 #ifdeà
__ılu¥lus


29 
	#AS_USER_SIZE
 64

	)

34 
	#AS_PASSWORD_HASH_SIZE
 64

	)

40 
boŞ


41 
as_·sswÜd_g’_§É
(* 
§É
);

47 
boŞ


48 
as_·sswÜd_g’_hash
(cÚ¡ * 
·sswÜd
, cÚ¡ * 
§É
, * 
hash
);

54 
boŞ


55 
as_·sswÜd_g’_cÚ¡ªt_hash
(cÚ¡ * 
·sswÜd
, * 
hash
);

61 
boŞ


62 
as_·sswÜd_g‘_cÚ¡ªt_hash
(cÚ¡ * 
·sswÜd
, * 
hash
);

69 
boŞ


70 
as_·sswÜd_´om±_hash
(cÚ¡ * 
·sswÜd
, * 
hash
);

76 
šlše
 
boŞ


77 
as_·sswÜd_v”ify
(cÚ¡ * 
hash1
, cÚ¡ * 
hash2
) {

78  ! 
memcmp
(
hash1
, 
hash2
, 60);

81 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_peers.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_şu¡”.h
>

25 
	sas_³”s_s
 {

26 
as_veùÜ
 
	mho¡s
;

27 
as_veùÜ
 
	mnodes
;

28 
boŞ
 
	mu£_³”s
;

29 
boŞ
 
	mg’_chªged
;

30 } 
	tas_³”s
;

36 
as_node
*

37 
as_³”s_fšd_loÿl_node
(
as_veùÜ
* 
nodes
, cÚ¡ * 
Çme
);

40 
as_³”s_·r£_£rviûs
(
as_³”s
* 
³”s
, 
as_şu¡”
* 
şu¡”
, 
as_node
* 
node
, * 
buf
);

42 
as_¡©us


43 
as_³”s_·r£_³”s
(
as_³”s
* 
³”s
, 
as_”rÜ
* 
”r
, 
as_şu¡”
* 
şu¡”
, 
as_node
* 
node
, * 
buf
);

	@application/kvbench/include/aerospike/as_pipe.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_async.h
>

21 
	~<«ro¥ike/as_log.h
>

22 
	~<«ro¥ike/as_log_maüos.h
>

23 
	~<«ro¥ike/as_node.h
>

24 
	~<«ro¥ike/as_sock‘.h
>

26 
	~<c™ru¦—f/®loc.h
>

27 
	~<c™ru¦—f/cf_Î.h
>

29 
	~<as£¹.h
>

30 
	~<”ºo.h
>

31 
	~<fú.h
>

32 
	~<š‰y³s.h
>

33 
	~<¡dboŞ.h
>

34 
	~<¡ddef.h
>

35 
	~<¡dšt.h
>

36 
	~<uni¡d.h
>

38 
	~<Ãtš‘/š.h
>

39 
	~<Ãtš‘/tı.h
>

41 
	~<sys/sock‘.h
>

42 
	~<sys/¡©.h
>

43 
	~<sys/ty³s.h
>

45 
	sas_pe_cÚÃùiÚ
 {

46 
as_ev’t_cÚÃùiÚ
 
	mba£
;

47 
as_ev’t_commªd
* 
	mwr™”
;

48 
cf_Î
 
	m»ad”s
;

49 
boŞ
 
	mÿnûlšg
;

50 
boŞ
 
	mÿnûËd
;

51 
boŞ
 
	mš_poŞ
;

52 } 
	tas_pe_cÚÃùiÚ
;

55 
as_pe_g‘_£nd_bufãr_size
();

58 
as_pe_g‘_»cv_bufãr_size
();

61 
as_pe_g‘_cÚÃùiÚ
(
as_ev’t_commªd
* 
cmd
);

63 
boŞ


64 
as_pe_modify_fd
(
fd
);

67 
as_pe_sock‘_”rÜ
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
, 
boŞ
 
»Œy
);

70 
as_pe_timeout
(
as_ev’t_commªd
* 
cmd
, 
boŞ
 
»Œy
);

73 
as_pe_»¥Ú£_”rÜ
(
as_ev’t_commªd
* 
cmd
, 
as_”rÜ
* 
”r
);

76 
as_pe_»¥Ú£_com¶‘e
(
as_ev’t_commªd
* 
cmd
);

79 
as_pe_wr™e_¡¬t
(
as_ev’t_commªd
* 
cmd
);

82 
as_pe_»ad_¡¬t
(
as_ev’t_commªd
* 
cmd
);

84 
šlše
 
as_ev’t_commªd
*

85 
	$as_pe_lšk_to_commªd
(
cf_Î_–em’t
* 
lšk
)

87  (
as_ev’t_commªd
*)((
ušt8_t
*)
lšk
 - 
	`off£tof
×s_ev’t_commªd, 
pe_lšk
));

88 
	}
}

	@application/kvbench/include/aerospike/as_policy.h

17 #´agm¨
Úû


55 
	~<¡dboŞ.h
>

56 
	~<¡dšt.h
>

58 #ifdeà
__ılu¥lus


71 
	#AS_POLICY_SOCKET_TIMEOUT_DEFAULT
 0

	)

78 
	#AS_POLICY_TOTAL_TIMEOUT_DEFAULT
 1000

	)

85 
	#AS_POLICY_MAX_RETRIES_DEFAULT
 2

	)

92 
	#AS_POLICY_SLEEP_BETWEEN_RETRIES_DEFAULT
 0

	)

99 
	#AS_POLICY_COMPRESSION_THRESHOLD_DEFAULT
 0

	)

106 
	#AS_POLICY_GEN_DEFAULT
 
AS_POLICY_GEN_IGNORE


	)

113 
	#AS_POLICY_KEY_DEFAULT
 
AS_POLICY_KEY_DIGEST


	)

120 
	#AS_POLICY_EXISTS_DEFAULT
 
AS_POLICY_EXISTS_IGNORE


	)

127 
	#AS_POLICY_REPLICA_DEFAULT
 
AS_POLICY_REPLICA_SEQUENCE


	)

134 
	#AS_POLICY_CONSISTENCY_LEVEL_DEFAULT
 
AS_POLICY_CONSISTENCY_LEVEL_ONE


	)

141 
	#AS_POLICY_COMMIT_LEVEL_DEFAULT
 
AS_POLICY_COMMIT_LEVEL_ALL


	)

154 
	eas_pŞicy_»Œy_e
 {

159 
AS_POLICY_RETRY_NONE
,

165 
AS_POLICY_RETRY_ONCE
,

167 } 
	tas_pŞicy_»Œy
;

177 
	eas_pŞicy_g’_e
 {

182 
AS_POLICY_GEN_IGNORE
,

187 
AS_POLICY_GEN_EQ
,

193 
AS_POLICY_GEN_GT


195 } 
	tas_pŞicy_g’
;

205 
	eas_pŞicy_key_e
 {

214 
AS_POLICY_KEY_DIGEST
,

229 
AS_POLICY_KEY_SEND
,

231 } 
	tas_pŞicy_key
;

241 
	eas_pŞicy_exi¡s_e
 {

246 
AS_POLICY_EXISTS_IGNORE
,

251 
AS_POLICY_EXISTS_CREATE
,

256 
AS_POLICY_EXISTS_UPDATE
,

261 
AS_POLICY_EXISTS_REPLACE
,

266 
AS_POLICY_EXISTS_CREATE_OR_REPLACE


268 } 
	tas_pŞicy_exi¡s
;

277 
	eas_pŞicy_»¶iÿ_e
 {

282 
AS_POLICY_REPLICA_MASTER
,

288 
AS_POLICY_REPLICA_ANY
,

295 
AS_POLICY_REPLICA_SEQUENCE


297 } 
	tas_pŞicy_»¶iÿ
;

308 
	eas_pŞicy_cÚsi¡’cy_Ëv–_e
 {

313 
AS_POLICY_CONSISTENCY_LEVEL_ONE
,

318 
AS_POLICY_CONSISTENCY_LEVEL_ALL
,

320 } 
	tas_pŞicy_cÚsi¡’cy_Ëv–
;

331 
	eas_pŞicy_comm™_Ëv–_e
 {

336 
AS_POLICY_COMMIT_LEVEL_ALL
,

341 
AS_POLICY_COMMIT_LEVEL_MASTER
,

343 } 
	tas_pŞicy_comm™_Ëv–
;

350 
	sas_pŞicy_ba£_s
 {

365 
ušt32_t
 
sock‘_timeout
;

380 
ušt32_t
 
tÙ®_timeout
;

396 
ušt32_t
 
max_»Œ›s
;

410 
ušt32_t
 
¦“p_b‘w“n_»Œ›s
;

412 } 
	tas_pŞicy_ba£
;

419 
	sas_pŞicy_»ad_s
 {

424 
as_pŞicy_ba£
 
ba£
;

429 
as_pŞicy_key
 
key
;

434 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

439 
as_pŞicy_cÚsi¡’cy_Ëv–
 
cÚsi¡’cy_Ëv–
;

446 
boŞ
 
de£rŸlize
;

448 } 
	tas_pŞicy_»ad
;

455 
	sas_pŞicy_wr™e_s
 {

460 
as_pŞicy_ba£
 
ba£
;

465 
as_pŞicy_key
 
key
;

470 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

476 
as_pŞicy_comm™_Ëv–
 
comm™_Ëv–
;

481 
as_pŞicy_g’
 
g’
;

486 
as_pŞicy_exi¡s
 
exi¡s
;

491 
ušt32_t
 
com´essiÚ_th»shŞd
;

500 
boŞ
 
du¿bË_d–‘e
;

502 } 
	tas_pŞicy_wr™e
;

509 
	sas_pŞicy_­¶y_s
 {

514 
as_pŞicy_ba£
 
ba£
;

519 
as_pŞicy_key
 
key
;

524 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

530 
as_pŞicy_comm™_Ëv–
 
comm™_Ëv–
;

546 
ušt32_t
 
‰l
;

551 
as_pŞicy_g’
 
g’
;

556 
ušt16_t
 
g’_v®ue
;

565 
boŞ
 
du¿bË_d–‘e
;

567 } 
	tas_pŞicy_­¶y
;

574 
	sas_pŞicy_İ”©e_s
 {

579 
as_pŞicy_ba£
 
ba£
;

584 
as_pŞicy_key
 
key
;

589 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

594 
as_pŞicy_cÚsi¡’cy_Ëv–
 
cÚsi¡’cy_Ëv–
;

600 
as_pŞicy_comm™_Ëv–
 
comm™_Ëv–
;

605 
as_pŞicy_g’
 
g’
;

612 
boŞ
 
de£rŸlize
;

621 
boŞ
 
du¿bË_d–‘e
;

623 } 
	tas_pŞicy_İ”©e
;

630 
	sas_pŞicy_»move_s
 {

635 
as_pŞicy_ba£
 
ba£
;

640 
as_pŞicy_key
 
key
;

645 
as_pŞicy_»¶iÿ
 
»¶iÿ
;

651 
as_pŞicy_comm™_Ëv–
 
comm™_Ëv–
;

656 
as_pŞicy_g’
 
g’
;

661 
ušt16_t
 
g’”©iÚ
;

670 
boŞ
 
du¿bË_d–‘e
;

672 } 
	tas_pŞicy_»move
;

679 
	sas_pŞicy_b©ch_s
 {

684 
as_pŞicy_ba£
 
ba£
;

689 
as_pŞicy_cÚsi¡’cy_Ëv–
 
cÚsi¡’cy_Ëv–
;

709 
boŞ
 
cÚcu¼’t
;

724 
boŞ
 
u£_b©ch_dœeù
;

739 
boŞ
 
®low_šlše
;

747 
boŞ
 
£nd_£t_Çme
;

754 
boŞ
 
de£rŸlize
;

756 } 
	tas_pŞicy_b©ch
;

763 
	sas_pŞicy_qu”y_s
 {

768 
as_pŞicy_ba£
 
ba£
;

775 
boŞ
 
de£rŸlize
;

777 } 
	tas_pŞicy_qu”y
;

784 
	sas_pŞicy_sÿn_s
 {

789 
as_pŞicy_ba£
 
ba£
;

794 
boŞ
 
ç_Ú_şu¡”_chªge
;

803 
boŞ
 
du¿bË_d–‘e
;

805 } 
	tas_pŞicy_sÿn
;

812 
	sas_pŞicy_šfo_s
 {

817 
ušt32_t
 
timeout
;

822 
boŞ
 
£nd_as_is
;

827 
boŞ
 
check_bounds
;

829 } 
	tas_pŞicy_šfo
;

836 
	sas_pŞicy_admš_s
 {

841 
ušt32_t
 
timeout
;

843 } 
	tas_pŞicy_admš
;

852 
	sas_pŞic›s_s
 {

857 
as_pŞicy_»ad
 
»ad
;

862 
as_pŞicy_wr™e
 
wr™e
;

867 
as_pŞicy_İ”©e
 
İ”©e
;

872 
as_pŞicy_»move
 
»move
;

877 
as_pŞicy_­¶y
 
­¶y
;

882 
as_pŞicy_b©ch
 
b©ch
;

887 
as_pŞicy_sÿn
 
sÿn
;

892 
as_pŞicy_qu”y
 
qu”y
;

897 
as_pŞicy_šfo
 
šfo
;

902 
as_pŞicy_admš
 
admš
;

904 } 
	tas_pŞic›s
;

918 
šlše
 
as_pŞicy_»ad
*

919 
as_pŞicy_»ad_š™
(
as_pŞicy_»ad
* 
p
)

921 
p
->
ba£
.
sock‘_timeout
 = 
AS_POLICY_SOCKET_TIMEOUT_DEFAULT
;

922 
p
->
ba£
.
tÙ®_timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

923 
p
->
ba£
.
max_»Œ›s
 = 
AS_POLICY_MAX_RETRIES_DEFAULT
;

924 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 
AS_POLICY_SLEEP_BETWEEN_RETRIES_DEFAULT
;

925 
p
->
key
 = 
AS_POLICY_KEY_DEFAULT
;

926 
p
->
»¶iÿ
 = 
AS_POLICY_REPLICA_DEFAULT
;

927 
p
->
cÚsi¡’cy_Ëv–
 = 
AS_POLICY_CONSISTENCY_LEVEL_DEFAULT
;

928 
p
->
de£rŸlize
 = 
Œue
;

929  
p
;

940 
šlše
 

941 
as_pŞicy_»ad_cİy
(
as_pŞicy_»ad
* 
¤c
,‡s_pŞicy_»ad* 
Œg
)

943 *
Œg
 = *
¤c
;

954 
šlše
 
as_pŞicy_wr™e
*

955 
as_pŞicy_wr™e_š™
(
as_pŞicy_wr™e
* 
p
)

957 
p
->
ba£
.
sock‘_timeout
 = 
AS_POLICY_SOCKET_TIMEOUT_DEFAULT
;

958 
p
->
ba£
.
tÙ®_timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

959 
p
->
ba£
.
max_»Œ›s
 = 
AS_POLICY_MAX_RETRIES_DEFAULT
;

960 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 500;

961 
p
->
key
 = 
AS_POLICY_KEY_DEFAULT
;

962 
p
->
»¶iÿ
 = 
AS_POLICY_REPLICA_DEFAULT
;

963 
p
->
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_DEFAULT
;

964 
p
->
g’
 = 
AS_POLICY_GEN_DEFAULT
;

965 
p
->
exi¡s
 = 
AS_POLICY_EXISTS_DEFAULT
;

966 
p
->
com´essiÚ_th»shŞd
 = 
AS_POLICY_COMPRESSION_THRESHOLD_DEFAULT
;

967 
p
->
du¿bË_d–‘e
 = 
çl£
;

968  
p
;

979 
šlše
 

980 
as_pŞicy_wr™e_cİy
(
as_pŞicy_wr™e
* 
¤c
,‡s_pŞicy_wr™e* 
Œg
)

982 *
Œg
 = *
¤c
;

993 
šlše
 
as_pŞicy_İ”©e
*

994 
as_pŞicy_İ”©e_š™
(
as_pŞicy_İ”©e
* 
p
)

996 
p
->
ba£
.
sock‘_timeout
 = 
AS_POLICY_SOCKET_TIMEOUT_DEFAULT
;

997 
p
->
ba£
.
tÙ®_timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

998 
p
->
ba£
.
max_»Œ›s
 = 
AS_POLICY_MAX_RETRIES_DEFAULT
;

999 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 500;

1000 
p
->
key
 = 
AS_POLICY_KEY_DEFAULT
;

1001 
p
->
»¶iÿ
 = 
AS_POLICY_REPLICA_DEFAULT
;

1002 
p
->
cÚsi¡’cy_Ëv–
 = 
AS_POLICY_CONSISTENCY_LEVEL_DEFAULT
;

1003 
p
->
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_DEFAULT
;

1004 
p
->
g’
 = 
AS_POLICY_GEN_DEFAULT
;

1005 
p
->
de£rŸlize
 = 
Œue
;

1006 
p
->
du¿bË_d–‘e
 = 
çl£
;

1007  
p
;

1018 
šlše
 

1019 
as_pŞicy_İ”©e_cİy
(
as_pŞicy_İ”©e
* 
¤c
,‡s_pŞicy_İ”©e* 
Œg
)

1021 *
Œg
 = *
¤c
;

1032 
šlše
 
as_pŞicy_»move
*

1033 
as_pŞicy_»move_š™
(
as_pŞicy_»move
* 
p
)

1035 
p
->
ba£
.
sock‘_timeout
 = 
AS_POLICY_SOCKET_TIMEOUT_DEFAULT
;

1036 
p
->
ba£
.
tÙ®_timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

1037 
p
->
ba£
.
max_»Œ›s
 = 
AS_POLICY_MAX_RETRIES_DEFAULT
;

1038 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 500;

1039 
p
->
key
 = 
AS_POLICY_KEY_DEFAULT
;

1040 
p
->
»¶iÿ
 = 
AS_POLICY_REPLICA_DEFAULT
;

1041 
p
->
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_DEFAULT
;

1042 
p
->
g’
 = 
AS_POLICY_GEN_DEFAULT
;

1043 
p
->
g’”©iÚ
 = 0;

1044 
p
->
du¿bË_d–‘e
 = 
çl£
;

1045  
p
;

1056 
šlše
 

1057 
as_pŞicy_»move_cİy
(
as_pŞicy_»move
* 
¤c
,‡s_pŞicy_»move* 
Œg
)

1059 *
Œg
 = *
¤c
;

1070 
šlše
 
as_pŞicy_­¶y
*

1071 
as_pŞicy_­¶y_š™
(
as_pŞicy_­¶y
* 
p
)

1073 
p
->
ba£
.
sock‘_timeout
 = 
AS_POLICY_SOCKET_TIMEOUT_DEFAULT
;

1074 
p
->
ba£
.
tÙ®_timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

1075 
p
->
ba£
.
max_»Œ›s
 = 
AS_POLICY_MAX_RETRIES_DEFAULT
;

1076 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 500;

1077 
p
->
key
 = 
AS_POLICY_KEY_DEFAULT
;

1078 
p
->
»¶iÿ
 = 
AS_POLICY_REPLICA_DEFAULT
;

1079 
p
->
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_DEFAULT
;

1080 
p
->
‰l
 = 0;

1081 
p
->
g’
 = 
AS_POLICY_GEN_DEFAULT
;

1082 
p
->
g’_v®ue
 = 0;

1083 
p
->
du¿bË_d–‘e
 = 
çl£
;

1084  
p
;

1095 
šlše
 

1096 
as_pŞicy_­¶y_cİy
(
as_pŞicy_­¶y
* 
¤c
,‡s_pŞicy_­¶y* 
Œg
)

1098 *
Œg
 = *
¤c
;

1109 
šlše
 
as_pŞicy_b©ch
*

1110 
as_pŞicy_b©ch_š™
(
as_pŞicy_b©ch
* 
p
)

1112 
p
->
ba£
.
sock‘_timeout
 = 
AS_POLICY_SOCKET_TIMEOUT_DEFAULT
;

1113 
p
->
ba£
.
tÙ®_timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

1114 
p
->
ba£
.
max_»Œ›s
 = 
AS_POLICY_MAX_RETRIES_DEFAULT
;

1115 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 
AS_POLICY_SLEEP_BETWEEN_RETRIES_DEFAULT
;

1116 
p
->
cÚsi¡’cy_Ëv–
 = 
AS_POLICY_CONSISTENCY_LEVEL_ONE
;

1117 
p
->
cÚcu¼’t
 = 
çl£
;

1118 
p
->
u£_b©ch_dœeù
 = 
çl£
;

1119 
p
->
®low_šlše
 = 
Œue
;

1120 
p
->
£nd_£t_Çme
 = 
çl£
;

1121 
p
->
de£rŸlize
 = 
Œue
;

1122  
p
;

1133 
šlše
 

1134 
as_pŞicy_b©ch_cİy
(
as_pŞicy_b©ch
* 
¤c
,‡s_pŞicy_b©ch* 
Œg
)

1136 *
Œg
 = *
¤c
;

1147 
šlše
 
as_pŞicy_sÿn
*

1148 
as_pŞicy_sÿn_š™
(
as_pŞicy_sÿn
* 
p
)

1150 
p
->
ba£
.
sock‘_timeout
 = 10000;

1151 
p
->
ba£
.
tÙ®_timeout
 = 0;

1152 
p
->
ba£
.
max_»Œ›s
 = 0;

1153 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 0;

1154 
p
->
ç_Ú_şu¡”_chªge
 = 
çl£
;

1155 
p
->
du¿bË_d–‘e
 = 
çl£
;

1156  
p
;

1167 
šlše
 

1168 
as_pŞicy_sÿn_cİy
(
as_pŞicy_sÿn
* 
¤c
,‡s_pŞicy_sÿn* 
Œg
)

1170 *
Œg
 = *
¤c
;

1181 
šlše
 
as_pŞicy_qu”y
*

1182 
as_pŞicy_qu”y_š™
(
as_pŞicy_qu”y
* 
p
)

1184 
p
->
ba£
.
sock‘_timeout
 = 10000;

1185 
p
->
ba£
.
tÙ®_timeout
 = 0;

1186 
p
->
ba£
.
max_»Œ›s
 = 0;

1187 
p
->
ba£
.
¦“p_b‘w“n_»Œ›s
 = 0;

1188 
p
->
de£rŸlize
 = 
Œue
;

1189  
p
;

1200 
šlše
 

1201 
as_pŞicy_qu”y_cİy
(
as_pŞicy_qu”y
* 
¤c
,‡s_pŞicy_qu”y* 
Œg
)

1203 *
Œg
 = *
¤c
;

1214 
šlše
 
as_pŞicy_šfo
*

1215 
as_pŞicy_šfo_š™
(
as_pŞicy_šfo
* 
p
)

1217 
p
->
timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

1218 
p
->
£nd_as_is
 = 
Œue
;

1219 
p
->
check_bounds
 = 
Œue
;

1220  
p
;

1231 
šlše
 

1232 
as_pŞicy_šfo_cİy
(
as_pŞicy_šfo
* 
¤c
,‡s_pŞicy_šfo* 
Œg
)

1234 *
Œg
 = *
¤c
;

1245 
šlše
 
as_pŞicy_admš
*

1246 
as_pŞicy_admš_š™
(
as_pŞicy_admš
* 
p
)

1248 
p
->
timeout
 = 
AS_POLICY_TOTAL_TIMEOUT_DEFAULT
;

1249  
p
;

1260 
šlše
 

1261 
as_pŞicy_admš_cİy
(
as_pŞicy_admš
* 
¤c
,‡s_pŞicy_admš* 
Œg
)

1263 *
Œg
 = *
¤c
;

1271 
as_pŞic›s
*

1272 
as_pŞic›s_š™
(
as_pŞic›s
* 
p
);

1274 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_predexp.h

17 #´agm¨
Úû


19 #ifdeà
__ılu¥lus


23 
as_´edexp_ba£_s
;

25 (*
as_´edexp_ba£_dtÜ_â
è(
	tas_´edexp_ba£_s
 *);

26 
size_t
 (*
	tas_´edexp_ba£_size_â
è(
	tas_´edexp_ba£_s
 *);

27 
ušt8_t
 * (*
	tas_´edexp_ba£_wr™e_â
è(
	tas_´edexp_ba£_s
 *, 
	tušt8_t
 *
	tp
);

32 
	sas_´edexp_ba£_s
 {

37 
as_´edexp_ba£_dtÜ_â
 
dtÜ_â
;

42 
as_´edexp_ba£_size_â
 
size_â
;

47 
as_´edexp_ba£_wr™e_â
 
wr™e_â
;

49 } 
	tas_´edexp_ba£
;

81 
as_´edexp_ba£
*

82 
as_´edexp_ªd
(
ušt16_t
 
Ãx´
);

113 
as_´edexp_ba£
*

114 
as_´edexp_Ü
(
ušt16_t
 
Ãx´
);

139 
as_´edexp_ba£
*

140 
as_´edexp_nÙ
();

168 
as_´edexp_ba£
*

169 
as_´edexp_š‹g”_v®ue
(
št64_t
 
v®ue
);

196 
as_´edexp_ba£
*

197 
as_´edexp_¡ršg_v®ue
(cÚ¡ * 
v®ue
);

231 
as_´edexp_ba£
*

232 
as_´edexp_geojsÚ_v®ue
(cÚ¡ * 
v®ue
);

260 
as_´edexp_ba£
*

261 
as_´edexp_š‹g”_bš
(cÚ¡ * 
bšÇme
);

288 
as_´edexp_ba£
*

289 
as_´edexp_¡ršg_bš
(cÚ¡ * 
bšÇme
);

323 
as_´edexp_ba£
*

324 
as_´edexp_geojsÚ_bš
(cÚ¡ * 
bšÇme
);

351 
as_´edexp_ba£
*

352 
as_´edexp_li¡_bš
(cÚ¡ * 
bšÇme
);

379 
as_´edexp_ba£
*

380 
as_´edexp_m­_bš
(cÚ¡ * 
bšÇme
);

406 
as_´edexp_ba£
*

407 
as_´edexp_š‹g”_v¬
(cÚ¡ * 
v¬Çme
);

433 
as_´edexp_ba£
*

434 
as_´edexp_¡ršg_v¬
(cÚ¡ * 
v¬Çme
);

448 
as_´edexp_ba£
*

449 
as_´edexp_geojsÚ_v¬
(cÚ¡ * 
v¬Çme
);

471 
as_´edexp_ba£
*

472 
as_´edexp_»c_deviû_size
();

494 
as_´edexp_ba£
*

495 
as_´edexp_»c_Ï¡_upd©e
();

517 
as_´edexp_ba£
*

518 
as_´edexp_»c_void_time
();

541 
as_´edexp_ba£
*

542 
as_´edexp_»c_dige¡_modulo
(
št32_t
 
mod
);

572 
as_´edexp_ba£
*

573 
as_´edexp_š‹g”_equ®
();

575 
as_´edexp_ba£
*

576 
as_´edexp_š‹g”_uÃqu®
();

578 
as_´edexp_ba£
*

579 
as_´edexp_š‹g”_g»©”
();

581 
as_´edexp_ba£
*

582 
as_´edexp_š‹g”_g»©”eq
();

584 
as_´edexp_ba£
*

585 
as_´edexp_š‹g”_Ëss
();

587 
as_´edexp_ba£
*

588 
as_´edexp_š‹g”_Ës£q
();

618 
as_´edexp_ba£
*

619 
as_´edexp_¡ršg_equ®
();

621 
as_´edexp_ba£
*

622 
as_´edexp_¡ršg_uÃqu®
();

656 
as_´edexp_ba£
*

657 
as_´edexp_¡ršg_»gex
(
ušt32_t
 
cæags
);

697 
as_´edexp_ba£
*

698 
as_´edexp_geojsÚ_w™hš
();

734 
as_´edexp_ba£
*

735 
as_´edexp_geojsÚ_cÚšs
();

770 
as_´edexp_ba£
*

771 
as_´edexp_li¡_™”©e_Ü
(cÚ¡ * 
v¬Çme
);

808 
as_´edexp_ba£
*

809 
as_´edexp_li¡_™”©e_ªd
(cÚ¡ * 
v¬Çme
);

844 
as_´edexp_ba£
*

845 
as_´edexp_m­key_™”©e_Ü
(cÚ¡ * 
v¬Çme
);

882 
as_´edexp_ba£
*

883 
as_´edexp_m­key_™”©e_ªd
(cÚ¡ * 
v¬Çme
);

918 
as_´edexp_ba£
*

919 
as_´edexp_m­v®_™”©e_Ü
(cÚ¡ * 
v¬Çme
);

956 
as_´edexp_ba£
*

957 
as_´edexp_m­v®_™”©e_ªd
(cÚ¡ * 
v¬Çme
);

959 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_proto.h

17 #´agm¨
Úû


19 
	~<¡ddef.h
>

20 
	~<¡dšt.h
>

22 #ifdeà
__ılu¥lus


30 #ià
defšed
(
__APPLE__
è|| defšed(
CF_WINDOWS
)

32 #´agm¨
·ck
(
push
, 1)

33 
	sas_´Ùo_s
 {

34 
ušt64_t
 
v”siÚ
 :8;

35 
ušt64_t
 
ty³
 :8;

36 
ušt64_t
 
sz
 :48;

37 } 
	tas_´Ùo
;

38 #´agm¨
·ck
(
pİ
)

40 #´agm¨
·ck
(
push
, 1)

41 
	sas_com´es£d_´Ùo_s
 {

42 
as_´Ùo
 
´Ùo
;

43 
ušt64_t
 
uncom´es£d_sz
;

44 } 
	tas_com´es£d_´Ùo
;

45 #´agm¨
·ck
(
pİ
)

47 #´agm¨
·ck
(
push
, 1)

48 
	sas_msg_s
 {

49  
ušt8_t
 
h—d”_sz
;

50  
ušt8_t
 
šfo1
;

51  
ušt8_t
 
šfo2
;

52  
ušt8_t
 
šfo3
;

53  
ušt8_t
 
unu£d
;

54  
ušt8_t
 
»suÉ_code
;

55  
ušt32_t
 
g’”©iÚ
;

56  
ušt32_t
 
»cÜd_‰l
;

57  
ušt32_t
 
Œª§ùiÚ_‰l
;

58  
ušt16_t
 
n_f›lds
;

59  
ušt16_t
 
n_İs
;

60  
ušt8_t
 
d©a
[0];

61 } 
	tas_msg
;

62 #´agm¨
·ck
(
pİ
)

64 #´agm¨
·ck
(
push
, 1)

65 
	sas_´Ùo_msg_s
 {

66 
as_´Ùo
 
´Ùo
;

67 
as_msg
 
m
;

68 } 
	tas_´Ùo_msg
;

69 #´agm¨
·ck
(
pİ
)

73 
	sas_´Ùo_s
 {

74 
ušt8_t
 
v”siÚ
;

75 
ušt8_t
 
ty³
;

76 
ušt64_t
 
sz
:48;

77 
ušt8_t
 
d©a
[];

78 } 
	t__©Œibu‹__
 ((
	t__·cked__
)è
	tas_´Ùo
;

80 
	sas_com´es£d_´Ùo_s
 {

81 
as_´Ùo
 
´Ùo
;

82 
ušt64_t
 
uncom´es£d_sz
;

83 
ušt8_t
 
d©a
[];

84 } 
	t__©Œibu‹__
((
	t__·cked__
)è
	tas_com´es£d_´Ùo
;

86 
	sas_msg_s
 {

87  
ušt8_t
 
h—d”_sz
;

88  
ušt8_t
 
šfo1
;

89  
ušt8_t
 
šfo2
;

90  
ušt8_t
 
šfo3
;

91  
ušt8_t
 
unu£d
;

92  
ušt8_t
 
»suÉ_code
;

93  
ušt32_t
 
g’”©iÚ
;

94  
ušt32_t
 
»cÜd_‰l
;

95  
ušt32_t
 
Œª§ùiÚ_‰l
;

96  
ušt16_t
 
n_f›lds
;

97  
ušt16_t
 
n_İs
;

98  
ušt8_t
 
d©a
[];

99 } 
	t__©Œibu‹__
((
	t__·cked__
)è
	tas_msg
;

101 
	sas_´Ùo_msg_s
 {

102 
as_´Ùo
 
´Ùo
;

103 
as_msg
 
m
;

104 } 
	t__©Œibu‹__
((
	t__·cked__
)è
	tas_´Ùo_msg
;

112 
as_´Ùo_sw­_to_be
(
as_´Ùo
 *
m
);

113 
as_´Ùo_sw­_äom_be
(
as_´Ùo
 *
m
);

114 
as_msg_sw­_h—d”_äom_be
(
as_msg
 *
m
);

116 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_query.h

17 #´agm¨
Úû


18 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Waddress"

20 
	~<«ro¥ike/«ro¥ike_šdex.h
>

21 
	~<«ro¥ike/as_bš.h
>

22 
	~<«ro¥ike/as_key.h
>

23 
	~<«ro¥ike/as_li¡.h
>

24 
	~<«ro¥ike/as_´edexp.h
>

25 
	~<«ro¥ike/as_udf.h
>

27 
	~<¡d¬g.h
>

29 #ifdeà
__ılu¥lus


46 
	#as_¡ršg_equ®s
(
__v®
è
AS_PREDICATE_EQUAL
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_STRING
, 
	)
__val

57 
	#as_š‹g”_equ®s
(
__v®
è
AS_PREDICATE_EQUAL
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_NUMERIC
, (
št64_t
)
	)
__val

69 
	#as_š‹g”_¿nge
(
__mš
, 
__max
è
AS_PREDICATE_RANGE
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_NUMERIC
, (
št64_t
)__mš, (št64_t)
	)
__max

81 
	#as_¿nge
(
šdexty³
, 
d©©y³
, 
__mš
, 
__max
è
AS_PREDICATE_RANGE
, 
AS_INDEX_TYPE_
 ##šdexty³, 
AS_INDEX_
 ##d©©y³, __mš, 
	)
__max

93 
	#as_cÚšs
(
šdexty³
, 
d©©y³
, 
__v®
è
AS_PREDICATE_EQUAL
, 
AS_INDEX_TYPE_
 ##šdexty³, 
AS_INDEX_
 ##d©©y³, 
	)
__val

105 
	#as_equ®s
(
d©©y³
, 
__v®
è
AS_PREDICATE_EQUAL
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_
 ##d©©y³, 
	)
__val

107 
	#as_geo_w™hš
(
__v®
è
AS_PREDICATE_RANGE
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_GEO2DSPHERE
, 
	)
__val

109 
	#as_geo_cÚšs
(
__v®
è
AS_PREDICATE_RANGE
, 
AS_INDEX_TYPE_DEFAULT
, 
AS_INDEX_GEO2DSPHERE
, 
	)
__val

119 
	uas_´ediÿ‹_v®ue_u
 {

124 * 
¡ršg
;

129 
št64_t
 
š‹g”
;

139 
št64_t
 
mš
;

144 
št64_t
 
max
;

146 } 
š‹g”_¿nge
;

148 } 
	tas_´ediÿ‹_v®ue
;

153 
	eas_´ediÿ‹_ty³_e
 {

159 
AS_PREDICATE_EQUAL
,

161 
AS_PREDICATE_RANGE


162 } 
	tas_´ediÿ‹_ty³
;

168 
	sas_´ediÿ‹_s
 {

173 
as_bš_Çme
 
bš
;

178 
as_´ediÿ‹_ty³
 
ty³
;

183 
as_´ediÿ‹_v®ue
 
v®ue
;

189 
as_šdex_d©©y³
 
dty³
;

194 
as_šdex_ty³
 
™y³
;

195 } 
	tas_´ediÿ‹
;

200 
	eas_Üd”_e
 {

205 
AS_ORDER_ASCENDING
 = 0,

210 
AS_ORDER_DESCENDING
 = 1

212 } 
	tas_Üd”
;

218 
	sas_Üd”šg_s
 {

223 
as_bš_Çme
 
bš
;

228 
as_Üd”
 
Üd”
;

230 } 
	tas_Üd”šg
;

241 
	sas_qu”y_bšs_s
 {

247 
boŞ
 
_ä“
;

252 
ušt16_t
 
ÿ·c™y
;

257 
ušt16_t
 
size
;

262 
as_bš_Çme
 * 
’Œ›s
;

264 } 
	tas_qu”y_bšs
;

275 
	sas_qu”y_´ediÿ‹s_s
 {

281 
boŞ
 
_ä“
;

286 
ušt16_t
 
ÿ·c™y
;

291 
ušt16_t
 
size
;

296 
as_´ediÿ‹
 * 
’Œ›s
;

298 } 
	tas_qu”y_´ediÿ‹s
;

309 
	sas_qu”y_´edexp_s
 {

315 
boŞ
 
_ä“
;

320 
ušt16_t
 
ÿ·c™y
;

325 
ušt16_t
 
size
;

330 
as_´edexp_ba£
 ** 
’Œ›s
;

332 } 
	tas_qu”y_´edexp
;

343 
	sas_qu”y_sÜt_s
 {

349 
boŞ
 
_ä“
;

354 
ušt16_t
 
ÿ·c™y
;

359 
ušt16_t
 
size
;

364 
as_Üd”šg
 * 
’Œ›s
;

366 } 
	tas_qu”y_Üd”šg
;

505 
	sas_qu”y_s
 {

511 
boŞ
 
_ä“
;

520 
as_Çme¥aû
 
ns
;

529 
as_£t
 
£t
;

540 
as_qu”y_bšs
 
£Ëù
;

551 
as_qu”y_´ediÿ‹s
 
wh”e
;

562 
as_qu”y_´edexp
 
´edexp
;

569 
as_udf_ÿÎ
 
­¶y
;

576 
boŞ
 
no_bšs
;

578 } 
	tas_qu”y
;

600 
as_qu”y
 * 
as_qu”y_š™
×s_qu”y * 
qu”y
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
);

617 
as_qu”y
 * 
as_qu”y_Ãw
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
);

630 
as_qu”y_de¡roy
(
as_qu”y
 * 
qu”y
);

653 
	#as_qu”y_£Ëù_š™a
(
__qu”y
, 
__n
) \

655 iàĞ(
__qu”y
è!ğ
NULL
 && (__qu”y)->
£Ëù
.
’Œ›s
 == NULL ) {\

656 (
__qu”y
)->
£Ëù
.
’Œ›s
 = (
as_bš_Çme
*è
	`®loÿ
(×s_bš_Çmeè* (
__n
));\

657 iàĞ(
__qu”y
)->
£Ëù
.
’Œ›s
 ) { \

658 (
__qu”y
)->
£Ëù
.
_ä“
 = 
çl£
;\

659 (
__qu”y
)->
£Ëù
.
ÿ·c™y
 = (
__n
);\

660 (
__qu”y
)->
£Ëù
.
size
 = 0;\

663 } 0)

	)

684 
boŞ
 
as_qu”y_£Ëù_š™
(
as_qu”y
 * 
qu”y
, 
ušt16_t
 
n
);

706 
boŞ
 
as_qu”y_£Ëù
(
as_qu”y
 * 
qu”y
, cÚ¡ * 
bš
);

731 
	#as_qu”y_wh”e_š™a
(
__qu”y
, 
__n
) \

733 iàĞ(
__qu”y
è!ğ
NULL
 && (__qu”y)->
wh”e
.
’Œ›s
 == NULL ) {\

734 (
__qu”y
)->
wh”e
.
’Œ›s
 = (
as_´ediÿ‹
*è
	`®loÿ
(×s_´ediÿ‹è* (
__n
));\

735 iàĞ(
__qu”y
)->
wh”e
.
’Œ›s
 ) { \

736 (
__qu”y
)->
wh”e
.
_ä“
 = 
çl£
;\

737 (
__qu”y
)->
wh”e
.
ÿ·c™y
 = (
__n
);\

738 (
__qu”y
)->
wh”e
.
size
 = 0;\

741 } 0)

	)

762 
boŞ
 
as_qu”y_wh”e_š™
(
as_qu”y
 * 
qu”y
, 
ušt16_t
 
n
);

792 
boŞ
 
as_qu”y_wh”e
(
as_qu”y
 * 
qu”y
, cÚ¡ * 
bš
, 
as_´ediÿ‹_ty³
 
ty³
, 
as_šdex_ty³
 
™y³
, 
as_šdex_d©©y³
 
dty³
, ... );

816 
	#as_qu”y_´edexp_š™a
(
__qu”y
, 
__n
) \

817 iàĞ(
__qu”y
è!ğ
NULL
 && (__qu”y)->
´edexp
.
’Œ›s
 == NULL ) { \

818 (
__qu”y
)->
´edexp
.
’Œ›s
 = \

819 (
as_´edexp_ba£
 **) \

820 
	`®loÿ
(
__n
 * (
as_´edexp_ba£
 *)); \

821 iàĞ(
__qu”y
)->
´edexp
.
’Œ›s
 ) { \

822 (
__qu”y
)->
´edexp
.
_ä“
 = 
çl£
; \

823 (
__qu”y
)->
´edexp
.
ÿ·c™y
 = 
__n
; \

824 (
__qu”y
)->
´edexp
.
size
 = 0; \

826 }

	)

848 
boŞ
 
as_qu”y_´edexp_š™
(
as_qu”y
 * 
qu”y
, 
ušt16_t
 
n
);

871 
boŞ
 
as_qu”y_´edexp_add
(
as_qu”y
 * 
qu”y
, 
as_´edexp_ba£
 * 
´edexp
);

893 
boŞ
 
as_qu”y_­¶y
(
as_qu”y
 * 
qu”y
, cÚ¡ * 
moduË
, cÚ¡ * 
funùiÚ
, cÚ¡ 
as_li¡
 * 
¬gli¡
);

895 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_queue.h

17 #´agm¨
Úû


19 
	~<¡dšt.h
>

20 
	~<¡ddef.h
>

21 
	~<¡dboŞ.h
>

23 #ifdeà
__ılu¥lus


35 
	sas_queue_s
 {

39 
ušt8_t
* 
d©a
;

44 
ušt32_t
 
ÿ·c™y
;

49 
ušt32_t
 
h—d
;

54 
ušt32_t
 

;

59 
ušt32_t
 
™em_size
;

64 
ušt32_t
 
tÙ®
;

69 
ušt32_t
 
æags
;

70 } 
	tas_queue
;

81 
	#as_queue_š™a
(
__q
, 
__™em_size
, 
__ÿ·c™y
)\

82 (
__q
)->
d©a
 = 
	`®loÿ
((
__ÿ·c™y
è* (
__™em_size
));\

83 (
__q
)->
ÿ·c™y
 = 
__ÿ·c™y
;\

84 (
__q
)->
h—d
 = (__q)->

 = 0;\

85 (
__q
)->
™em_size
 = 
__™em_size
;\

86 (
__q
)->
tÙ®
 = 0;\

87 (
__q
)->
æags
 = 0;

	)

96 
boŞ


97 
as_queue_š™
(
as_queue
* 
queue
, 
ušt32_t
 
™em_size
, ušt32_ˆ
ÿ·c™y
);

102 
as_queue
*

103 
as_queue_ü—‹
(
ušt32_t
 
™em_size
, ušt32_ˆ
ÿ·c™y
);

109 
as_queue_de¡roy
(
as_queue
* 
queue
);

114 
šlše
 
ušt32_t


115 
as_queue_size
(
as_queue
* 
queue
)

117  
queue
->

 - queue->
h—d
;

123 
šlše
 
boŞ


124 
as_queue_em±y
(
as_queue
* 
queue
)

126  
queue
->

 =ğqueue->
h—d
;

132 
boŞ


133 
as_queue_push
(
as_queue
* 
queue
, cÚ¡ * 
±r
);

138 
boŞ


139 
as_queue_push_lim™
(
as_queue
* 
queue
, cÚ¡ * 
±r
);

144 
boŞ


145 
as_queue_push_h—d
(
as_queue
* 
queue
, cÚ¡ * 
±r
);

150 
boŞ


151 
as_queue_pİ
(
as_queue
* 
queue
, * 
±r
);

156 
šlše
 
boŞ


157 
as_queue_šü_tÙ®
(
as_queue
* 
queue
)

159 ià(
queue
->
tÙ®
 < queue->
ÿ·c™y
) {

160 
queue
->
tÙ®
++;

161  
Œue
;

163  
çl£
;

169 
šlše
 

170 
as_queue_deü_tÙ®
(
as_queue
* 
queue
)

172 
queue
->
tÙ®
--;

175 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_random.h

17 #´agm¨
Úû


19 
	~<¡dšt.h
>

20 
	~<¡dboŞ.h
>

22 #ifdeà
__ılu¥lus


34 
	sas_¿ndom_s
 {

35 
ušt64_t
 
£ed0
;

36 
ušt64_t
 
£ed1
;

37 
boŞ
 
š™Ÿlized
;

38 } 
	tas_¿ndom
;

43 
__th»ad
 
as_¿ndom
 
as_¿nd
;

53 
as_¿ndom_š™
(
as_¿ndom
* 
¿ndom
);

58 
šlše
 
as_¿ndom
*

59 
as_¿ndom_š¡ªû
()

61 
as_¿ndom
* 
	g¿ndom
 = &
as_¿nd
;

63 ià(! 
	g¿ndom
->
	gš™Ÿlized
) {

64 
as_¿ndom_š™
(
¿ndom
);

66  
	g¿ndom
;

73 
šlše
 
ušt64_t


74 
as_¿ndom_Ãxt_ušt64
(
as_¿ndom
* 
¿ndom
)

77 
ušt64_t
 
	gs1
 = 
¿ndom
->
£ed0
;

78 cÚ¡ 
ušt64_t
 
	gs0
 = 
¿ndom
->
£ed1
;

79 
	g¿ndom
->
	g£ed0
 = 
s0
;

80 
	gs1
 ^ğ
s1
 << 23;

81 
	g¿ndom
->
	g£ed1
 = (
s1
 ^ 
s0
 ^ (s1 >> 18) ^ (s0 >> 5));

82  
	g¿ndom
->
	g£ed1
 + 
	gs0
;

88 
šlše
 
ušt32_t


89 
as_¿ndom_Ãxt_ušt32
(
as_¿ndom
* 
¿ndom
)

91  (
	gušt32_t
)
as_¿ndom_Ãxt_ušt64
(
¿ndom
);

98 
as_¿ndom_Ãxt_by‹s
(
as_¿ndom
* 
¿ndom
, 
ušt8_t
* 
by‹s
, 
ušt32_t
 
Ën
);

103 
ušt64_t


104 
as_¿ndom_g‘_ušt64
();

109 
šlše
 
ušt32_t


110 
as_¿ndom_g‘_ušt32
()

112  (
	gušt32_t
)
as_¿ndom_g‘_ušt64
();

118 
šlše
 

119 
as_¿ndom_g‘_by‹s
(
ušt8_t
* 
by‹s
, 
ušt32_t
 
Ën
)

121 
as_¿ndom
* 
	g¿ndom
 = 
as_¿ndom_š¡ªû
();

122 
as_¿ndom_Ãxt_by‹s
(
¿ndom
, 
by‹s
, 
Ën
);

125 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_rec.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_š‹g”.h
>

21 
	~<«ro¥ike/as_by‹s.h
>

22 
	~<«ro¥ike/as_geojsÚ.h
>

23 
	~<«ro¥ike/as_li¡.h
>

24 
	~<«ro¥ike/as_m­.h
>

25 
	~<«ro¥ike/as_¡ršg.h
>

26 
	~<«ro¥ike/as_ut.h
>

27 
	~<«ro¥ike/as_v®.h
>

29 
	~<¡dboŞ.h
>

30 
	~<¡dšt.h
>

32 #ifdeà
__ılu¥lus


40 
as_»c_hooks_s
;

51 (* 
as_»c_bš_Çmes_ÿÎback
è(* 
	tbš_Çmes
, 
	tušt32_t
 
	tnbšs
, 
	tušt16_t
 
	tmax_Çme_size
, * 
	tud©a
);

64 
boŞ
 (* 
	tas_»c_fÜ—ch_ÿÎback
è(cÚ¡ * 
	tÇme
, cÚ¡ 
	tas_v®
 * 
	tv®ue
, * 
	tud©a
);

76 
	sas_»c_s
 {

83 
as_v®
 
_
;

88 * 
d©a
;

93 cÚ¡ 
as_»c_hooks_s
 * 
hooks
;

95 } 
	tas_»c
;

103 
	sas_»c_hooks_s
 {

108 
boŞ
 (* 
de¡roy
)(
as_»c
 * 
»c
);

113 
ušt32_t
 (* 
hashcode
)(cÚ¡ 
as_»c
 * 
»c
);

118 
as_v®
 * (* 
g‘
)(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
);

123 (* 
£t
)(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_v®
 * 
v®ue
);

128 (* 
»move
)(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
bš
);

133 
ušt32_t
 (* 
‰l
)(cÚ¡ 
as_»c
 * 
»c
);

138 
ušt64_t
 (* 
Ï¡_upd©e_time
)(cÚ¡ 
as_»c
 * 
»c
);

143 
ušt16_t
 (* 
g’
)(cÚ¡ 
as_»c
 * 
»c
);

148 
as_v®
 * (* 
key
)(cÚ¡ 
as_»c
 * 
»c
);

153 cÚ¡ * (* 
£Šame
)(cÚ¡ 
as_»c
 * 
»c
);

158 
ušt16_t
 (* 
numbšs
)(cÚ¡ 
as_»c
 * 
»c
);

163 (* 
bš_Çmes
)(cÚ¡ 
as_»c
 * 
»c
, 
as_»c_bš_Çmes_ÿÎback
 
ÿÎback
, * 
ud©a
);

168 
as_by‹s
 * (* 
dige¡
)(cÚ¡ 
as_»c
 * 
»c
);

173 (* 
£t_‰l
)(cÚ¡ 
as_»c
 * 
»c
, 
ušt32_t
 
‰l
);

178 (* 
drİ_key
)(cÚ¡ 
as_»c
 * 
»c
);

183 
boŞ
 (* 
fÜ—ch
)(cÚ¡ 
as_»c
 * 
»c
, 
as_»c_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
);

185 } 
	tas_»c_hooks
;

204 
as_»c
 * 
as_»c_cÚs
×s_»ø* 
»c
, 
boŞ
 
ä“
, * 
d©a
, cÚ¡ 
as_»c_hooks
 * 
hooks
);

217 
as_»c
 * 
as_»c_š™
×s_»ø* 
»c
, * 
d©a
, cÚ¡ 
as_»c_hooks
 * 
hooks
);

229 
as_»c
 * 
as_»c_Ãw
(* 
d©a
, cÚ¡ 
as_»c_hooks
 * 
hooks
);

236 
šlše
 
as_»c_de¡roy
(
as_»c
 * 
»c
)

238 
as_v®_de¡roy
((
as_v®
 *è
»c
);

250 
šlše
 * 
as_»c_sourû
(cÚ¡ 
as_»c
 * 
»c
)

252  
»c
 ?„ec->
d©a
 : 
NULL
;

266 
šlše
 
as_»c_»move
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

268  
as_ut_hook
(
»move
, 1, 
»c
, 
Çme
);

276 
šlše
 
ušt32_t
 
as_»c_‰l
(cÚ¡ 
as_»c
 * 
»c
)

278  
as_ut_hook
(
‰l
, 0, 
»c
);

286 
šlše
 
ušt64_t
 
as_»c_Ï¡_upd©e_time
(cÚ¡ 
as_»c
 * 
»c
)

288  
as_ut_hook
(
Ï¡_upd©e_time
, 0, 
»c
);

296 
šlše
 
ušt16_t
 
as_»c_g’
(cÚ¡ 
as_»c
 * 
»c
)

298  
as_ut_hook
(
g’
, 0, 
»c
);

306 
šlše
 
as_v®
 * 
as_»c_key
(cÚ¡ 
as_»c
 * 
»c
)

308  
as_ut_hook
(
key
, 0, 
»c
);

316 
šlše
 cÚ¡ * 
as_»c_£Šame
(cÚ¡ 
as_»c
 * 
»c
)

318  
as_ut_hook
(
£Šame
, 0, 
»c
);

326 
šlše
 
ušt16_t
 
as_»c_numbšs
(cÚ¡ 
as_»c
 * 
»c
)

328  
as_ut_hook
(
numbšs
, 0, 
»c
);

336 
šlše
 
as_»c_bš_Çmes
(cÚ¡ 
as_»c
 * 
»c
, 
as_»c_bš_Çmes_ÿÎback
 
ÿÎback
, * 
ud©a
)

338  
as_ut_hook
(
bš_Çmes
, 0, 
»c
, 
ÿÎback
, 
ud©a
);

346 
šlše
 
as_by‹s
 * 
as_»c_dige¡
(cÚ¡ 
as_»c
 * 
»c
)

348  
as_ut_hook
(
dige¡
, 0, 
»c
);

356 
šlše
 
as_»c_£t_‰l
(cÚ¡ 
as_»c
 * 
»c
, 
ušt32_t
 
‰l
)

358  
as_ut_hook
(
£t_‰l
, 0, 
»c
, 
‰l
);

366 
šlše
 
as_»c_drİ_key
(cÚ¡ 
as_»c
 * 
»c
)

368  
as_ut_hook
(
drİ_key
, 0, 
»c
);

385 
šlše
 
as_v®
 * 
as_»c_g‘
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

387  
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

400 
šlše
 
št64_t
 
as_»c_g‘_št64
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

402 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

403 
as_š‹g”
 * 
i
 = 
as_š‹g”_äomv®
(
v
);

404  
i
 ? 
as_š‹g”_tošt
(i) : 0;

417 
šlše
 
as_»c_g‘_doubË
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

419 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

420 
as_doubË
 * 
±r
 = 
as_doubË_äomv®
(
v
);

421  
±r
 ?…Œ->
v®ue
 : 0.0;

434 
šlše
 * 
as_»c_g‘_¡r
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

436 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

437 
as_¡ršg
 * 
s
 = 
as_¡ršg_äomv®
(
v
);

438  
s
 ? 
as_¡ršg_to¡ršg
(s) : 0;

451 
šlše
 * 
as_»c_g‘_geojsÚ_¡r
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

453 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

454 
as_geojsÚ
 * 
s
 = 
as_geojsÚ_äomv®
(
v
);

455  
as_geojsÚ_g‘
(
s
);

468 
šlše
 
as_š‹g”
 * 
as_»c_g‘_š‹g”
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

470 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

471  
as_š‹g”_äomv®
(
v
);

484 
šlše
 
as_doubË
 * 
as_»c_g‘_as_doubË
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

486 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

487  
as_doubË_äomv®
(
v
);

500 
šlše
 
as_¡ršg
 * 
as_»c_g‘_¡ršg
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

502 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

503  
as_¡ršg_äomv®
(
v
);

516 
šlše
 
as_geojsÚ
 * 
as_»c_g‘_geojsÚ
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

518 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

519  
as_geojsÚ_äomv®
(
v
);

532 
šlše
 
as_by‹s
 * 
as_»c_g‘_by‹s
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

534 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

535  
as_by‹s_äomv®
(
v
);

548 
šlše
 
as_li¡
 * 
as_»c_g‘_li¡
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

550 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

551  
as_li¡_äomv®
(
v
);

564 
šlše
 
as_m­
 * 
as_»c_g‘_m­
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
)

566 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
»c
, 
Çme
);

567  
as_m­_äomv®
(
v
);

585 
šlše
 
as_»c_£t
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_v®
 * 
v®ue
)

587  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, 
v®ue
);

601 
šlše
 
as_»c_£t_št64
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, 
št64_t
 
v®ue
)

603  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
as_š‹g”_Ãw
(
v®ue
));

617 
šlše
 
as_»c_£t_doubË
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, 
v®ue
)

619  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
as_doubË_Ãw
(
v®ue
));

633 
šlše
 
as_»c_£t_¡r
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ * 
v®ue
)

635  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
v®ue
));

649 
šlše
 
as_»c_£t_š‹g”
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_š‹g”
 * 
v®ue
)

651  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

665 
šlše
 
as_»c_£t_as_doubË
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_doubË
 * 
v®ue
)

667  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

681 
šlše
 
as_»c_£t_¡ršg
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_¡ršg
 * 
v®ue
)

683  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

697 
šlše
 
as_»c_£t_geojsÚ
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_geojsÚ
 * 
v®ue
)

699  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

713 
šlše
 
as_»c_£t_by‹s
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_by‹s
 * 
v®ue
)

715  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

729 
šlše
 
as_»c_£t_li¡
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_li¡
 * 
v®ue
)

731  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

745 
šlše
 
as_»c_£t_m­
(cÚ¡ 
as_»c
 * 
»c
, cÚ¡ * 
Çme
, cÚ¡ 
as_m­
 * 
v®ue
)

747  
as_ut_hook
(
£t
, 1, 
»c
, 
Çme
, (
as_v®
 *è
v®ue
);

765 
šlše
 
boŞ
 
as_»c_fÜ—ch
(cÚ¡ 
as_»c
 * 
»c
, 
as_»c_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
)

767  
as_ut_hook
(
fÜ—ch
, 
çl£
, 
»c
, 
ÿÎback
, 
ud©a
);

779 
šlše
 
as_v®
 * 
as_»c_tov®
(cÚ¡ 
as_»c
 * 
»c
)

781  (
as_v®
 *è
»c
;

789 
šlše
 
as_»c
 * 
as_»c_äomv®
(cÚ¡ 
as_v®
 * 
v
)

791  
as_ut_äomv®
(
v
, 
AS_REC
, 
as_»c
);

802 
as_»c_v®_de¡roy
(
as_v®
 *);

808 
ušt32_t
 
as_»c_v®_hashcode
(cÚ¡ 
as_v®
 *
v
);

814 * 
as_»c_v®_to¡ršg
(cÚ¡ 
as_v®
 *
v
);

816 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_record.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_bš.h
>

20 
	~<«ro¥ike/as_by‹s.h
>

21 
	~<«ro¥ike/as_š‹g”.h
>

22 
	~<«ro¥ike/as_key.h
>

23 
	~<«ro¥ike/as_li¡.h
>

24 
	~<«ro¥ike/as_m­.h
>

25 
	~<«ro¥ike/as_»c.h
>

26 
	~<«ro¥ike/as_¡ršg.h
>

27 
	~<«ro¥ike/as_geojsÚ.h
>

28 
	~<«ro¥ike/as_ut.h
>

29 
	~<«ro¥ike/as_v®.h
>

31 
	~<¡dboŞ.h
>

32 
	~<¡dšt.h
>

34 #ifdeà
__ılu¥lus


169 
	sas_»cÜd_s
 {

176 
as_»c
 
_
;

183 
as_key
 
key
;

188 
ušt16_t
 
g’
;

204 
ušt32_t
 
‰l
;

209 
as_bšs
 
bšs
;

211 } 
	tas_»cÜd
;

217 
	#AS_RECORD_DEFAULT_TTL
 0

	)

224 
	#AS_RECORD_NO_EXPIRE_TTL
 0xFFFFFFFF

	)

230 
	#AS_RECORD_NO_CHANGE_TTL
 0xFFFFFFFE

	)

256 
	#as_»cÜd_š™a
(
__»c
, 
__nbšs
) \

257 
	`as_»cÜd_š™
(
__»c
, 0);\

258 (
__»c
)->
bšs
.
_ä“
 = 
çl£
;\

259 (
__»c
)->
bšs
.
ÿ·c™y
 = (
__nbšs
);\

260 (
__»c
)->
bšs
.
size
 = 0;\

261 (
__»c
)->
bšs
.
’Œ›s
 = (
as_bš
*è
	`®loÿ
(×s_bšè* (
__nbšs
));

	)

285 
as_»cÜd
 * 
as_»cÜd_Ãw
(
ušt16_t
 
nbšs
);

307 
as_»cÜd
 * 
as_»cÜd_š™
×s_»cÜd * 
»c
, 
ušt16_t
 
nbšs
);

316 
as_»cÜd_de¡roy
(
as_»cÜd
 * 
»c
);

325 
ušt16_t
 
as_»cÜd_numbšs
(cÚ¡ 
as_»cÜd
 * 
»c
);

338 
boŞ
 
as_»cÜd_£t
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_bš_v®ue
 * 
v®ue
);

355 
boŞ
 
as_»cÜd_£t_št64
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
št64_t
 
v®ue
);

372 
boŞ
 
as_»cÜd_£t_doubË
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
v®ue
);

390 
boŞ
 
as_»cÜd_£t_¡½
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, boŞ 
ä“
);

407 
šlše
 
boŞ
 
as_»cÜd_£t_¡r
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

409  
as_»cÜd_£t_¡½
(
»c
, 
Çme
, 
v®ue
, 
çl£
);

428 
boŞ
 
as_»cÜd_£t_geojsÚ_¡½
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
, boŞ 
ä“
);

445 
šlše
 
boŞ
 
as_»cÜd_£t_geojsÚ_¡r
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ * 
v®ue
)

447  
as_»cÜd_£t_geojsÚ_¡½
(
»c
, 
Çme
, 
v®ue
, 
çl£
);

472 
boŞ
 
as_»cÜd_£t_¿wp
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, boŞ 
ä“
);

497 
boŞ
 
as_»cÜd_£t_¿w_ty³p
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
, 
as_by‹s_ty³
 
ty³
, boŞ 
ä“
);

516 
šlše
 
boŞ
 
as_»cÜd_£t_¿w
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, cÚ¡ 
ušt8_t
 * 
v®ue
, 
ušt32_t
 
size
)

518  
as_»cÜd_£t_¿wp
(
»c
, 
Çme
, 
v®ue
, 
size
, 
çl£
);

536 
boŞ
 
as_»cÜd_£t_š‹g”
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_š‹g”
 * 
v®ue
);

553 
boŞ
 
as_»cÜd_£t_as_doubË
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_doubË
 * 
v®ue
);

570 
boŞ
 
as_»cÜd_£t_¡ršg
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_¡ršg
 * 
v®ue
);

587 
boŞ
 
as_»cÜd_£t_geojsÚ
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_geojsÚ
 * 
v®ue
);

604 
boŞ
 
as_»cÜd_£t_by‹s
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_by‹s
 * 
v®ue
);

627 
boŞ
 
as_»cÜd_£t_li¡
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_li¡
 * 
v®ue
);

650 
boŞ
 
as_»cÜd_£t_m­
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
as_m­
 * 
v®ue
);

666 
boŞ
 
as_»cÜd_£t_n
(
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

682 
as_bš_v®ue
 * 
as_»cÜd_g‘
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

699 
št64_t
 
as_»cÜd_g‘_št64
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, iÁ64_ˆ
çÎback
);

716 
as_»cÜd_g‘_doubË
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
, 
çÎback
);

732 * 
as_»cÜd_g‘_¡r
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

748 * 
as_»cÜd_g‘_geojsÚ_¡r
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

764 
as_š‹g”
 * 
as_»cÜd_g‘_š‹g”
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

780 
as_doubË
 * 
as_»cÜd_g‘_as_doubË
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

796 
as_¡ršg
 * 
as_»cÜd_g‘_¡ršg
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

812 
as_geojsÚ
 * 
as_»cÜd_g‘_geojsÚ
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

828 
as_by‹s
 * 
as_»cÜd_g‘_by‹s
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

844 
as_li¡
 * 
as_»cÜd_g‘_li¡
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

860 
as_m­
 * 
as_»cÜd_g‘_m­
(cÚ¡ 
as_»cÜd
 * 
»c
, cÚ¡ 
as_bš_Çme
 
Çme
);

892 
boŞ
 
as_»cÜd_fÜ—ch
(cÚ¡ 
as_»cÜd
 * 
»c
, 
as_»c_fÜ—ch_ÿÎback
 
ÿÎback
, * 
ud©a
);

903 
šlše
 
as_v®
 * 
as_»cÜd_tov®
(cÚ¡ 
as_»cÜd
 * 
»c
)

905  (
as_v®
 *è
»c
;

913 
šlše
 
as_»cÜd
 * 
as_»cÜd_äomv®
(cÚ¡ 
as_v®
 * 
v
)

915  (
as_»cÜd
 *è
as_ut_äomv®
(
v
, 
AS_REC
, 
as_»c
);

918 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_record_iterator.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_bš.h
>

20 
	~<«ro¥ike/as_by‹s.h
>

21 
	~<«ro¥ike/as_š‹g”.h
>

22 
	~<«ro¥ike/as_key.h
>

23 
	~<«ro¥ike/as_li¡.h
>

24 
	~<«ro¥ike/as_m­.h
>

25 
	~<«ro¥ike/as_»c.h
>

26 
	~<«ro¥ike/as_»cÜd.h
>

27 
	~<«ro¥ike/as_¡ršg.h
>

28 
	~<«ro¥ike/as_ut.h
>

29 
	~<«ro¥ike/as_v®.h
>

31 
	~<¡dboŞ.h
>

32 
	~<¡dšt.h
>

34 #ifdeà
__ılu¥lus


120 
	sas_»cÜd_™”©Ü_s
 {

126 
boŞ
 
_ä“
;

131 cÚ¡ 
as_»cÜd
 * 
»cÜd
;

136 
ušt32_t
 
pos
;

138 } 
	tas_»cÜd_™”©Ü
;

165 
as_»cÜd_™”©Ü
 * 
as_»cÜd_™”©Ü_Ãw
(cÚ¡ 
as_»cÜd
 * 
»cÜd
);

192 
as_»cÜd_™”©Ü
 * 
as_»cÜd_™”©Ü_š™
×s_»cÜd_™”©Ü * 
™”©Ü
, cÚ¡ 
as_»cÜd
 * 
»cÜd
);

202 
as_»cÜd_™”©Ü_de¡roy
(
as_»cÜd_™”©Ü
 * 
™”©Ü
);

214 
boŞ
 
as_»cÜd_™”©Ü_has_Ãxt
(cÚ¡ 
as_»cÜd_™”©Ü
 * 
™”©Ü
);

226 
as_bš
 * 
as_»cÜd_™”©Ü_Ãxt
(
as_»cÜd_™”©Ü
 * 
™”©Ü
);

229 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_result.h

17 #´agm¨
Úû


19 
	~<¡dboŞ.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 #ifdeà
__ılu¥lus


31 
	sas_»suÉ_s
 {

32 
boŞ
 
is_m®loc
;

33 
cf_©omic32
 
couÁ
;

34 
boŞ
 
is_sucûss
;

35 
as_v®
 * 
v®ue
;

36 } 
	tas_»suÉ
;

42 
as_»suÉ
 * 
as_»suÉ_š™
×s_»suÉ *
r
);

43 
as_»suÉ
 * 
as_»suÉ_Ãw
();

45 
as_»suÉ
 * 
as_»suÉ_»£rve
×s_»suÉ *
r
);

47 
as_»suÉ_de¡roy
(
as_»suÉ
 *);

50 
as_»suÉ
 * 
as_sucûss_Ãw
(
as_v®
 *);

51 
as_»suÉ
 * 
as_çu»_Ãw
(
as_v®
 *);

54 
as_»suÉ
 * 
as_sucûss_š™
×s_»suÉ *, 
as_v®
 *);

55 
as_»suÉ
 * 
as_çu»_š™
×s_»suÉ *, 
as_v®
 *);

58 
as_v®
 * 
as_»suÉ_v®ue
(
as_»suÉ
 *);

60 
as_»suÉ
 * 
as_»suÉ_£tsucûss
×s_»suÉ * 
r
, 
as_v®
 * 
v
);

61 
as_»suÉ
 * 
as_»suÉ_£tçu»
×s_»suÉ * 
r
, 
as_v®
 * 
v
);

63 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_scan.h

17 #´agm¨
Úû


18 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Waddress"

20 
	~<«ro¥ike/as_bš.h
>

21 
	~<«ro¥ike/as_key.h
>

22 
	~<«ro¥ike/as_´edexp.h
>

23 
	~<«ro¥ike/as_udf.h
>

25 #ifdeà
__ılu¥lus


36 
	#AS_SCAN_PRIORITY_DEFAULT
 
AS_SCAN_PRIORITY_AUTO


	)

41 
	#AS_SCAN_PERCENT_DEFAULT
 100

	)

46 
	#AS_SCAN_NOBINS_DEFAULT
 
çl£


	)

51 
	#AS_SCAN_CONCURRENT_DEFAULT
 
çl£


	)

56 
	#AS_SCAN_DESERIALIZE_DEFAULT
 
Œue


	)

65 
	eas_sÿn_´iÜ™y_e
 {

70 
AS_SCAN_PRIORITY_AUTO
,

75 
AS_SCAN_PRIORITY_LOW
,

80 
AS_SCAN_PRIORITY_MEDIUM
,

85 
AS_SCAN_PRIORITY_HIGH


87 } 
	tas_sÿn_´iÜ™y
;

92 
	eas_sÿn_¡©us_e
 {

98 
AS_SCAN_STATUS_UNDEF
,

103 
AS_SCAN_STATUS_INPROGRESS
,

108 
AS_SCAN_STATUS_ABORTED
,

113 
AS_SCAN_STATUS_COMPLETED
,

115 } 
	tas_sÿn_¡©us
;

122 
	sas_sÿn_šfo_s
 {

127 
as_sÿn_¡©us
 
¡©us
;

132 
ušt32_t
 
´og»ss_pù
;

137 
ušt32_t
 
»cÜds_sÿÂed
;

139 } 
	tas_sÿn_šfo
;

150 
	sas_sÿn_bšs_s
 {

156 
boŞ
 
_ä“
;

161 
ušt16_t
 
ÿ·c™y
;

166 
ušt16_t
 
size
;

171 
as_bš_Çme
 * 
’Œ›s
;

173 } 
	tas_sÿn_bšs
;

184 
	sas_sÿn_´edexp_s
 {

190 
boŞ
 
_ä“
;

195 
ušt16_t
 
ÿ·c™y
;

200 
ušt16_t
 
size
;

205 
as_´edexp_ba£
 ** 
’Œ›s
;

207 } 
	tas_sÿn_´edexp
;

327 
	sas_sÿn_s
 {

333 
boŞ
 
_ä“
;

340 
as_sÿn_´iÜ™y
 
´iÜ™y
;

347 
ušt8_t
 
³rûÁ
;

354 
boŞ
 
no_bšs
;

361 
boŞ
 
cÚcu¼’t
;

369 
boŞ
 
de£rŸlize_li¡_m­
;

380 
as_Çme¥aû
 
ns
;

390 
as_£t
 
£t
;

401 
as_sÿn_bšs
 
£Ëù
;

412 
as_sÿn_´edexp
 
´edexp
;

419 
as_udf_ÿÎ
 
­¶y_—ch
;

421 } 
	tas_sÿn
;

447 
as_sÿn
 * 
as_sÿn_š™
×s_sÿÀ* 
sÿn
, cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
);

467 
as_sÿn
 * 
as_sÿn_Ãw
(cÚ¡ 
as_Çme¥aû
 
ns
, cÚ¡ 
as_£t
 
£t
);

479 
as_sÿn_de¡roy
(
as_sÿn
 * 
sÿn
);

501 
	#as_sÿn_£Ëù_š™a
(
__sÿn
, 
__n
) \

503 iàĞ(
__sÿn
è!ğ
NULL
 && (__sÿn)->
£Ëù
.
’Œ›s
 == NULL ) {\

504 (
__sÿn
)->
£Ëù
.
’Œ›s
 = (
as_bš_Çme
*è
	`®loÿ
(×s_bš_Çmeè* (
__n
));\

505 iàĞ(
__sÿn
)->
£Ëù
.
’Œ›s
 ) { \

506 (
__sÿn
)->
£Ëù
.
_ä“
 = 
çl£
;\

507 (
__sÿn
)->
£Ëù
.
ÿ·c™y
 = (
__n
);\

508 (
__sÿn
)->
£Ëù
.
size
 = 0;\

511 } 0)

	)

532 
boŞ
 
as_sÿn_£Ëù_š™
(
as_sÿn
 * 
sÿn
, 
ušt16_t
 
n
);

554 
boŞ
 
as_sÿn_£Ëù
(
as_sÿn
 * 
sÿn
, cÚ¡ * 
bš
);

579 
	#as_sÿn_´edexp_š™a
(
__sÿn
, 
__n
) \

580 iàĞ(
__sÿn
è!ğ
NULL
 && (__sÿn)->
´edexp
.
’Œ›s
 == NULL ) { \

581 (
__sÿn
)->
´edexp
.
’Œ›s
 = \

582 (
as_´edexp_ba£
 **) \

583 
	`®loÿ
(
__n
 * (
as_´edexp_ba£
 *)); \

584 iàĞ(
__sÿn
)->
´edexp
.
’Œ›s
 ) { \

585 (
__sÿn
)->
´edexp
.
_ä“
 = 
çl£
; \

586 (
__sÿn
)->
´edexp
.
ÿ·c™y
 = 
__n
; \

587 (
__sÿn
)->
´edexp
.
size
 = 0; \

589 }

	)

611 
boŞ
 
as_sÿn_´edexp_š™
(
as_sÿn
 * 
sÿn
, 
ušt16_t
 
n
);

634 
boŞ
 
as_sÿn_´edexp_add
(
as_sÿn
 * 
sÿn
, 
as_´edexp_ba£
 * 
´edexp
);

655 
boŞ
 
as_sÿn_£t_³rûÁ
(
as_sÿn
 * 
sÿn
, 
ušt8_t
 
³rûÁ
);

672 
boŞ
 
as_sÿn_£t_´iÜ™y
(
as_sÿn
 * 
sÿn
, 
as_sÿn_´iÜ™y
 
´iÜ™y
);

689 
boŞ
 
as_sÿn_£t_nobšs
(
as_sÿn
 * 
sÿn
, boŞ 
nobšs
);

703 
boŞ
 
as_sÿn_£t_cÚcu¼’t
(
as_sÿn
 * 
sÿn
, boŞ 
cÚcu¼’t
);

729 
boŞ
 
as_sÿn_­¶y_—ch
(
as_sÿn
 * 
sÿn
, cÚ¡ * 
moduË
, cÚ¡ * 
funùiÚ
, 
as_li¡
 * 
¬gli¡
);

731 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_serializer.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_ut.h
>

20 
	~<«ro¥ike/as_ty³s.h
>

21 
	~<«ro¥ike/as_bufãr.h
>

23 
	~<¡dšt.h
>

25 #ifdeà
__ılu¥lus


33 
as_£rŸliz”_hooks_s
;

38 
	sas_£rŸliz”_s
 {

43 
boŞ
 
ä“
;

48 cÚ¡ 
as_£rŸliz”_hooks_s
 *
hooks
;

49 } 
	tas_£rŸliz”
;

54 
	sas_£rŸliz”_hooks_s
 {

55 (*
de¡roy
)(
as_£rŸliz”
 *);

56 (*
£rŸlize
)(
as_£rŸliz”
 *, cÚ¡ 
as_v®
 *, 
as_bufãr
 *);

57 
št32_t
 (*
£rŸlize_´esized
)(
as_£rŸliz”
 *, cÚ¡ 
as_v®
 *, 
ušt8_t
 *);

58 (*
de£rŸlize
)(
as_£rŸliz”
 *, 
as_bufãr
 *, 
as_v®
 **);

59 
ušt32_t
 (*
£rŸlize_g‘size
)(
as_£rŸliz”
 *, cÚ¡ 
as_v®
 *);

60 } 
	tas_£rŸliz”_hooks
;

66 
as_£rŸliz”
 *
as_£rŸliz”_cÚs
×s_£rŸliz” *
£rŸliz”
, 
boŞ
 
ä“
, cÚ¡ 
as_£rŸliz”_hooks
 *
hooks
);

68 
as_£rŸliz”
 *
as_£rŸliz”_š™
×s_£rŸliz” *
£rŸliz”
, cÚ¡ 
as_£rŸliz”_hooks
 *
hooks
);

70 
as_£rŸliz”
 *
as_£rŸliz”_Ãw
(cÚ¡ 
as_£rŸliz”_hooks
 *);

72 
as_£rŸliz”_de¡roy
(
as_£rŸliz”
 *);

78 
šlše
 
as_£rŸliz”_£rŸlize
(
as_£rŸliz”
 *
£rŸliz”
, 
as_v®
 *
v®
, 
as_bufãr
 *
bufãr
)

80  
as_ut_hook
(
£rŸlize
, 1, 
£rŸliz”
, 
v®
, 
bufãr
);

88 
šlše
 
št32_t
 
as_£rŸliz”_£rŸlize_´esized
(
as_£rŸliz”
 *
£rŸliz”
, cÚ¡ 
as_v®
 *
v®
, 
ušt8_t
 *
buf
)

90  
as_ut_hook
(
£rŸlize_´esized
, 1, 
£rŸliz”
, 
v®
, 
buf
);

93 
šlše
 
as_£rŸliz”_de£rŸlize
(
as_£rŸliz”
 *
£rŸliz”
, 
as_bufãr
 *
bufãr
, 
as_v®
 **
v®
)

95  
as_ut_hook
(
de£rŸlize
, 1, 
£rŸliz”
, 
bufãr
, 
v®
);

98 
šlše
 
ušt32_t
 
as_£rŸliz”_£rŸlize_g‘size
(
as_£rŸliz”
 *
£rŸliz”
, 
as_v®
 *
v®
)

100  
as_ut_hook
(
£rŸlize_g‘size
, 1, 
£rŸliz”
, 
v®
);

103 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_shm_cluster.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_cÚfig.h
>

20 
	~<«ro¥ike/as_·¹™iÚ.h
>

21 
	~<c™ru¦—f/cf_queue.h
>

23 #ifdeà
__ılu¥lus


28 
	~<«ro¥ike/ck/ck_¥šlock.h
>

29 
	~<«ro¥ike/ck/ck_swlock.h
>

39 
	sas_node_shm_s
 {

44 
Çme
[
AS_NODE_NAME_SIZE
];

50 
ck_swlock_t
 
lock
;

56 
sockaddr_¡Üage
 
addr
;

62 
s_Çme
[
AS_HOSTNAME_SIZE
];

68 
ušt32_t
 
ã©u»s
;

74 
ušt8_t
 
aùive
;

80 
·d
[3];

81 } 
	tas_node_shm
;

87 
	sas_·¹™iÚ_shm_s
 {

92 
ušt32_t
 
ma¡”
;

98 
ušt32_t
 
´Şe
;

104 
ušt32_t
 
»gime
;

110 
ušt32_t
 
·d
;

111 } 
	tas_·¹™iÚ_shm
;

117 
	sas_·¹™iÚ_bË_shm_s
 {

122 
ns
[
AS_MAX_NAMESPACE_SIZE
];

128 
ušt8_t
 
ı_mode
;

134 
·d
[7];

140 
as_·¹™iÚ_shm
 
·¹™iÚs
[];

141 } 
	tas_·¹™iÚ_bË_shm
;

151 
	sas_şu¡”_shm_s
 {

156 
ušt64_t
 
time¡amp
;

162 
ušt32_t
 
owÃr_pid
;

168 
ušt32_t
 
nodes_size
;

174 
ušt32_t
 
nodes_ÿ·c™y
;

180 
ušt32_t
 
nodes_g’
;

186 
ušt32_t
 
n_·¹™iÚs
;

192 
ušt32_t
 
·¹™iÚ_bËs_size
;

198 
ušt32_t
 
·¹™iÚ_bËs_ÿ·c™y
;

204 
ušt32_t
 
·¹™iÚ_bËs_off£t
;

210 
ušt32_t
 
·¹™iÚ_bË_by‹_size
;

216 
ck_¥šlock_t
 
ke_ov”_lock
;

222 
ušt8_t
 
lock
;

228 
ušt8_t
 
»ady
;

234 
·d
[6];

240 
as_node_shm
 
nodes
[];

243 } 
	tas_şu¡”_shm
;

249 
	sas_shm_šfo_s
 {

254 
as_şu¡”_shm
* 
şu¡”_shm
;

261 
as_node
** 
loÿl_nodes
;

267 
shm_id
;

274 
ušt32_t
 
keov”_th»shŞd_ms
;

280 vŞ©
boŞ
 
is_‹nd_ma¡”
;

281 } 
	tas_shm_šfo
;

291 
as_¡©us


292 
as_shm_ü—‹
(
as_şu¡”_s
* 
şu¡”
, 
as_”rÜ
* 
”r
, 
as_cÚfig
* 
cÚfig
);

299 
as_shm_de¡roy
(
as_şu¡”_s
* 
şu¡”
);

306 
as_shm_add_nodes
(
as_şu¡”_s
* 
şu¡”
, 
as_veùÜ
* 
nodes_to_add
);

313 
as_shm_»move_nodes
(
as_şu¡”_s
* 
şu¡”
, 
as_veùÜ
* 
nodes_to_»move
);

319 
boŞ


320 
as_shm_·¹™iÚ_bËs_fšd_node
(
as_şu¡”_shm
* 
şu¡”_shm
, 
as_node
* 
node
);

326 
as_·¹™iÚ_bË_shm
*

327 
as_shm_fšd_·¹™iÚ_bË
(
as_şu¡”_shm
* 
şu¡”_shm
, cÚ¡ * 
ns
);

334 
as_shm_upd©e_·¹™iÚs
(
as_shm_šfo
* 
shm_šfo
, cÚ¡ * 
ns
, * 
b™m­_b64
, 
št64_t
 
Ën
, 
as_node
* 
node
, 
boŞ
 
ma¡”
, 
ušt32_t
 
»gime
);

341 
as_¡©us


342 
as_shm_şu¡”_g‘_node
(
as_şu¡”_s
* 
şu¡”
, 
as_”rÜ
* 
”r
, cÚ¡ * 
ns
, cÚ¡ 
ušt8_t
* 
dige¡
, 
as_pŞicy_»¶iÿ
 
»¶iÿ
, 
boŞ
 
u£_ma¡”
, 
as_node
** 
node_µ
);

349 
as_node
*

350 
as_·¹™iÚ_shm_g‘_node
(
as_şu¡”_s
* 
şu¡”
, 
as_·¹™iÚ_shm
* 
p
, 
as_pŞicy_»¶iÿ
 
»¶iÿ
, 
boŞ
 
u£_ma¡”
, boŞ 
ı_mode
);

356 
šlše
 
as_·¹™iÚ_bË_shm
*

357 
as_shm_g‘_·¹™iÚ_bËs
(
as_şu¡”_shm
* 
şu¡”_shm
)

359  (
as_·¹™iÚ_bË_shm
*è((*)
şu¡”_shm
 + clu¡”_shm->
·¹™iÚ_bËs_off£t
);

366 
šlše
 
as_·¹™iÚ_bË_shm
*

367 
as_shm_g‘_·¹™iÚ_bË
(
as_şu¡”_shm
* 
şu¡”_shm
, 
as_·¹™iÚ_bË_shm
* 
bËs
, 
ušt32_t
 
šdex
)

369  (
as_·¹™iÚ_bË_shm
*è((*)
bËs
 + (
şu¡”_shm
->
·¹™iÚ_bË_by‹_size
 * 
šdex
));

376 
šlše
 
as_·¹™iÚ_bË_shm
*

377 
as_shm_Ãxt_·¹™iÚ_bË
(
as_şu¡”_shm
* 
şu¡”_shm
, 
as_·¹™iÚ_bË_shm
* 
bË
)

379  (
as_·¹™iÚ_bË_shm
*è((*)
bË
 + 
şu¡”_shm
->
·¹™iÚ_bË_by‹_size
);

382 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_socket.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_”rÜ.h
>

20 
	~<c™ru¦—f/cf_şock.h
>

21 
	~<±h»ad.h
>

22 
	~<¡ddef.h
>

23 
	~<¡dšt.h
>

25 
	~<İ’s¦/s¦.h
>

27 
	~<«ro¥ike/as_cÚfig.h
>

29 
	~<uni¡d.h
>

30 
	~<¬·/š‘.h
>

31 
	~<Ãtš‘/š.h
>

32 
	~<sys/sock‘.h
>

34 
	#as_sock‘_d©a_t
 

	)

35 
	#as_sock‘_size_t
 
size_t


	)

36 
	#as_şo£
(
fd
è(
	`şo£
(fd))

	)

38 #ià
defšed
(
__APPLE__
)

39 
	#SOL_TCP
 
IPPROTO_TCP


	)

40 
	#MSG_NOSIGNAL
 0

	)

43 
	#AS_IP_ADDRESS_SIZE
 64

	)

45 #ifdeà
__ılu¥lus


53 
	sas_s_cÚ‹xt_s
 {

54 
±h»ad_mu‹x_t
 
lock
;

55 
SSL_CTX
* 
s¦_ùx
;

56 * 
û¹_bÏckli¡
;

57 
boŞ
 
log_£ssiÚ_šfo
;

58 } 
	tas_s_cÚ‹xt
;

60 
as_cÚn_poŞ_lock_s
;

61 
as_node_s
;

66 
	sas_sock‘_s
 {

67 
fd
;

68 
çmy
;

70 
as_cÚn_poŞ_lock_s
* 
poŞ_lock
;

72 
ušt32_t
 
max_sock‘_idË
;

73 
ušt32_t
 
Ï¡_u£d
;

74 } 
idË_check
;

76 
as_s_cÚ‹xt
* 
ùx
;

77 cÚ¡ * 
s_Çme
;

78 
SSL
* 
s¦
;

79 } 
	tas_sock‘
;

86 
as_sock‘_š™
(
as_sock‘
* 
sock
);

94 
as_sock‘_ü—‹_fd
(
çmy
);

102 
as_sock‘_ü—‹
(
as_sock‘
* 
sock
, 
çmy
, 
as_s_cÚ‹xt
* 
ùx
, cÚ¡ * 
s_Çme
);

109 
boŞ


110 
as_sock‘_w¿p
(
as_sock‘
* 
sock
, 
çmy
, 
fd
, 
as_s_cÚ‹xt
* 
ùx
, cÚ¡ * 
s_Çme
);

116 
boŞ


117 
as_sock‘_¡¬t_cÚÃù
(
as_sock‘
* 
sock
, 
sockaddr
* 
addr
);

123 
as_¡©us


124 
as_sock‘_ü—‹_ªd_cÚÃù
(
as_sock‘
* 
sock
, 
as_”rÜ
* 
”r
, 
sockaddr
* 
addr
, 
as_s_cÚ‹xt
* 
ùx
, cÚ¡ * 
s_Çme
);

131 
as_sock‘_şo£
(
as_sock‘
* 
sock
);

137 
as_¡©us


138 
as_sock‘_”rÜ
(
fd
, 
as_node_s
* 
node
, 
as_”rÜ
* 
”r
, 
as_¡©us
 
¡©us
, cÚ¡ * 
msg
, 
code
);

145 
as_sock‘_”rÜ_­³nd
(
as_”rÜ
* 
”r
, 
sockaddr
* 
addr
);

157 
as_sock‘_v®id©e_fd
(
fd
);

168 
as_sock‘_v®id©e
(
as_sock‘
* 
sock
);

170 #ià
defšed
(
__lšux__
è|| defšed(
__APPLE__
)

176 
šlše
 
ušt64_t


177 
as_sock‘_d—dlše
(
ušt32_t
 
timeout_ms
)

179  (
timeout_ms
 &&imeout_m <ğ
INT32_MAX
)? 
cf_g‘ms
() +imeout_ms : 0;

187 
as_¡©us


188 
as_sock‘_wr™e_d—dlše
(

189 
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node_s
* 
node
, 
ušt8_t
 *
buf
, 
size_t
 
buf_Ën
,

190 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše


198 
as_¡©us


199 
as_sock‘_»ad_d—dlše
(

200 
as_”rÜ
* 
”r
, 
as_sock‘
* 
sock
, 
as_node_s
* 
node
, 
ušt8_t
 *
buf
, 
size_t
 
buf_Ën
,

201 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše


206 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_status.h

17 #´agm¨
Úû


19 #ifdeà
__ılu¥lus


30 
	eas_¡©us_e
 {

38 
AEROSPIKE_ERR_CONNECTION
 = -10,

43 
AEROSPIKE_ERR_TLS_ERROR
 = -9,

48 
AEROSPIKE_ERR_INVALID_NODE
 = -8,

53 
AEROSPIKE_ERR_NO_MORE_CONNECTIONS
 = -7,

58 
AEROSPIKE_ERR_ASYNC_CONNECTION
 = -6,

63 
AEROSPIKE_ERR_CLIENT_ABORT
 = -5,

68 
AEROSPIKE_ERR_INVALID_HOST
 = -4,

73 
AEROSPIKE_NO_MORE_RECORDS
 = -3,

78 
AEROSPIKE_ERR_PARAM
 = -2,

83 
AEROSPIKE_ERR_CLIENT
 = -1,

88 
AEROSPIKE_ERR
 = -1,

97 
AEROSPIKE_OK
 = 0,

106 
AEROSPIKE_ERR_SERVER
 = 1,

112 
AEROSPIKE_ERR_RECORD_NOT_FOUND
 = 2,

117 
AEROSPIKE_ERR_RECORD_GENERATION
 = 3,

122 
AEROSPIKE_ERR_REQUEST_INVALID
 = 4,

128 
AEROSPIKE_ERR_RECORD_EXISTS
 = 5,

133 
AEROSPIKE_ERR_BIN_EXISTS
 = 6,

139 
AEROSPIKE_ERR_CLUSTER_CHANGE
 = 7,

145 
AEROSPIKE_ERR_SERVER_FULL
 = 8,

150 
AEROSPIKE_ERR_TIMEOUT
 = 9,

155 
AEROSPIKE_ERR_NO_XDR
 = 10,

160 
AEROSPIKE_ERR_CLUSTER
 = 11,

166 
AEROSPIKE_ERR_BIN_INCOMPATIBLE_TYPE
 = 12,

171 
AEROSPIKE_ERR_RECORD_TOO_BIG
 = 13,

176 
AEROSPIKE_ERR_RECORD_BUSY
 = 14,

181 
AEROSPIKE_ERR_SCAN_ABORTED
 = 15,

187 
AEROSPIKE_ERR_UNSUPPORTED_FEATURE
 = 16,

192 
AEROSPIKE_ERR_BIN_NOT_FOUND
 = 17,

197 
AEROSPIKE_ERR_DEVICE_OVERLOAD
 = 18,

202 
AEROSPIKE_ERR_RECORD_KEY_MISMATCH
 = 19,

207 
AEROSPIKE_ERR_NAMESPACE_NOT_FOUND
 = 20,

213 
AEROSPIKE_ERR_BIN_NAME
 = 21,

218 
AEROSPIKE_ERR_FAIL_FORBIDDEN
 = 22,

220 
AEROSPIKE_ERR_FAIL_ELEMENT_NOT_FOUND
 = 23,

222 
AEROSPIKE_ERR_FAIL_ELEMENT_EXISTS
 = 24,

227 
AEROSPIKE_QUERY_END
 = 50,

232 
AEROSPIKE_SECURITY_NOT_SUPPORTED
 = 51,

237 
AEROSPIKE_SECURITY_NOT_ENABLED
 = 52,

242 
AEROSPIKE_SECURITY_SCHEME_NOT_SUPPORTED
 = 53,

247 
AEROSPIKE_INVALID_COMMAND
 = 54,

252 
AEROSPIKE_INVALID_FIELD
 = 55,

257 
AEROSPIKE_ILLEGAL_STATE
 = 56,

262 
AEROSPIKE_INVALID_USER
 = 60,

267 
AEROSPIKE_USER_ALREADY_EXISTS
 = 61,

272 
AEROSPIKE_INVALID_PASSWORD
 = 62,

277 
AEROSPIKE_EXPIRED_PASSWORD
 = 63,

282 
AEROSPIKE_FORBIDDEN_PASSWORD
 = 64,

287 
AEROSPIKE_INVALID_CREDENTIAL
 = 65,

292 
AEROSPIKE_INVALID_ROLE
 = 70,

297 
AEROSPIKE_ROLE_ALREADY_EXISTS
 = 71,

302 
AEROSPIKE_INVALID_PRIVILEGE
 = 72,

307 
AEROSPIKE_NOT_AUTHENTICATED
 = 80,

312 
AEROSPIKE_ROLE_VIOLATION
 = 81,

317 
AEROSPIKE_ERR_UDF
 = 100,

322 
AEROSPIKE_ERR_LARGE_ITEM_NOT_FOUND
 = 125,

327 
AEROSPIKE_ERR_BATCH_DISABLED
 = 150,

332 
AEROSPIKE_ERR_BATCH_MAX_REQUESTS_EXCEEDED
 = 151,

337 
AEROSPIKE_ERR_BATCH_QUEUES_FULL
 = 152,

342 
AEROSPIKE_ERR_GEO_INVALID_GEOJSON
 = 160,

347 
AEROSPIKE_ERR_INDEX_FOUND
 = 200,

352 
AEROSPIKE_ERR_INDEX_NOT_FOUND
 = 201,

357 
AEROSPIKE_ERR_INDEX_OOM
 = 202,

362 
AEROSPIKE_ERR_INDEX_NOT_READABLE
 = 203,

367 
AEROSPIKE_ERR_INDEX
 = 204,

372 
AEROSPIKE_ERR_INDEX_NAME_MAXLEN
 = 205,

377 
AEROSPIKE_ERR_INDEX_MAXCOUNT
 = 206,

382 
AEROSPIKE_ERR_QUERY_ABORTED
 = 210,

387 
AEROSPIKE_ERR_QUERY_QUEUE_FULL
 = 211,

392 
AEROSPIKE_ERR_QUERY_TIMEOUT
 = 212,

397 
AEROSPIKE_ERR_QUERY
 = 213,

406 
AEROSPIKE_ERR_UDF_NOT_FOUND
 = 1301,

410 
AEROSPIKE_ERR_LUA_FILE_NOT_FOUND
 = 1302,

417 
AEROSPIKE_ERR_LDT_INTERNAL
 = 1400,

420 
AEROSPIKE_ERR_LDT_NOT_FOUND
 = 1401,

423 
AEROSPIKE_ERR_LDT_UNIQUE_KEY
 = 1402,

426 
AEROSPIKE_ERR_LDT_INSERT
 = 1403,

429 
AEROSPIKE_ERR_LDT_SEARCH
 = 1404,

432 
AEROSPIKE_ERR_LDT_DELETE
 = 1405,

436 
AEROSPIKE_ERR_LDT_INPUT_PARM
 = 1409,

441 
AEROSPIKE_ERR_LDT_TYPE_MISMATCH
 = 1410,

444 
AEROSPIKE_ERR_LDT_NULL_BIN_NAME
 = 1411,

447 
AEROSPIKE_ERR_LDT_BIN_NAME_NOT_STRING
 = 1412,

450 
AEROSPIKE_ERR_LDT_BIN_NAME_TOO_LONG
 = 1413,

453 
AEROSPIKE_ERR_LDT_TOO_MANY_OPEN_SUBRECS
 = 1414,

456 
AEROSPIKE_ERR_LDT_TOP_REC_NOT_FOUND
 = 1415,

459 
AEROSPIKE_ERR_LDT_SUB_REC_NOT_FOUND
 = 1416,

462 
AEROSPIKE_ERR_LDT_BIN_DOES_NOT_EXIST
 = 1417,

465 
AEROSPIKE_ERR_LDT_BIN_ALREADY_EXISTS
 = 1418,

468 
AEROSPIKE_ERR_LDT_BIN_DAMAGED
 = 1419,

473 
AEROSPIKE_ERR_LDT_SUBREC_POOL_DAMAGED
 = 1420,

476 
AEROSPIKE_ERR_LDT_SUBREC_DAMAGED
 = 1421,

479 
AEROSPIKE_ERR_LDT_SUBREC_OPEN
 = 1422,

482 
AEROSPIKE_ERR_LDT_SUBREC_UPDATE
 = 1423,

485 
AEROSPIKE_ERR_LDT_SUBREC_CREATE
 = 1424,

488 
AEROSPIKE_ERR_LDT_SUBREC_DELETE
 = 1425,

491 
AEROSPIKE_ERR_LDT_SUBREC_CLOSE
 = 1426,

494 
AEROSPIKE_ERR_LDT_TOPREC_UPDATE
 = 1427,

497 
AEROSPIKE_ERR_LDT_TOPREC_CREATE
 = 1428,

502 
AEROSPIKE_ERR_LDT_FILTER_FUNCTION_BAD
 = 1430,

505 
AEROSPIKE_ERR_LDT_FILTER_FUNCTION_NOT_FOUND
 = 1431,

508 
AEROSPIKE_ERR_LDT_KEY_FUNCTION_BAD
 = 1432,

511 
AEROSPIKE_ERR_LDT_KEY_FUNCTION_NOT_FOUND
 = 1433,

514 
AEROSPIKE_ERR_LDT_TRANS_FUNCTION_BAD
 = 1434,

517 
AEROSPIKE_ERR_LDT_TRANS_FUNCTION_NOT_FOUND
 = 1435,

520 
AEROSPIKE_ERR_LDT_UNTRANS_FUNCTION_BAD
 = 1436,

523 
AEROSPIKE_ERR_LDT_UNTRANS_FUNCTION_NOT_FOUND
 = 1437,

526 
AEROSPIKE_ERR_LDT_USER_MODULE_BAD
 = 1438,

529 
AEROSPIKE_ERR_LDT_USER_MODULE_NOT_FOUND
 = 1439

531 } 
	tas_¡©us
;

533 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_stream.h

18 #´agm¨
Úû


20 
	~<¡dlib.h
>

22 
	~<«ro¥ike/as_v®.h
>

23 
	~<«ro¥ike/as_ut.h
>

25 
	~<c™ru¦—f/®loc.h
>

27 #ifdeà
__ılu¥lus


35 
	#AS_STREAM_END
 ((*è0)

	)

41 
as_¡»am_hooks_s
;

46 
	eas_¡»am_¡©us_e
 {

47 
AS_STREAM_OK
 = 0,

48 
AS_STREAM_ERR
 = 1

49 } 
	tas_¡»am_¡©us
;

59 
	sas_¡»am_s
 {

65 
boŞ
 
ä“
;

70 * 
d©a
;

75 cÚ¡ 
as_¡»am_hooks_s
 * 
hooks
;

77 } 
	tas_¡»am
;

85 
	sas_¡»am_hooks_s
 {

90 (* 
de¡roy
)(
as_¡»am
 * 
¡»am
);

95 
as_v®
 * (* 
»ad
)(cÚ¡ 
as_¡»am
 * 
¡»am
);

100 
as_¡»am_¡©us
 (* 
wr™e
)(cÚ¡ 
as_¡»am
 * 
¡»am
, 
as_v®
 * 
v®ue
);

102 } 
	tas_¡»am_hooks
;

107 *
as_¡»am_m®loc
(
size_t
 
size
);

108 
as_¡»am_ä“
(*
±r
);

125 
šlše
 
as_¡»am
 * 
as_¡»am_š™
×s_¡»am * 
¡»am
, * 
d©a
, cÚ¡ 
as_¡»am_hooks
 * 
hooks
)

127 iàĞ!
¡»am
 )  stream;

129 
¡»am
->
ä“
 = 
çl£
;

130 
¡»am
->
d©a
 = data;

131 
¡»am
->
hooks
 = hooks;

132  
¡»am
;

145 
šlše
 
as_¡»am
 * 
as_¡»am_Ãw
(* 
d©a
, cÚ¡ 
as_¡»am_hooks
 * 
hooks
)

147 
as_¡»am
 * 
¡»am
 = (as_¡»am *è
as_¡»am_m®loc
((as_stream));

148 iàĞ!
¡»am
 )  stream;

150 
¡»am
->
ä“
 = 
Œue
;

151 
¡»am
->
d©a
 = data;

152 
¡»am
->
hooks
 = hooks;

153  
¡»am
;

165 
šlše
 
as_¡»am_de¡roy
(
as_¡»am
 * 
¡»am
)

167 
as_ut_hook
(
de¡roy
, 1, 
¡»am
);

168 iàĞ
¡»am
 && sŒ—m->
ä“
 ) {

169 
as_¡»am_ä“
(
¡»am
);

186 
šlše
 * 
as_¡»am_sourû
(cÚ¡ 
as_¡»am
 * 
¡»am
)

188  (
¡»am
 ? sŒ—m->
d©a
 : 
NULL
);

200 
šlše
 
as_v®
 * 
as_¡»am_»ad
(cÚ¡ 
as_¡»am
 * 
¡»am
)

202  
as_ut_hook
(
»ad
, 
NULL
, 
¡»am
);

214 
šlše
 
boŞ
 
as_¡»am_»adabË
(cÚ¡ 
as_¡»am
 * 
¡»am
)

216  
¡»am
 !ğ
NULL
 && sŒ—m->
hooks
 !ğNULL && sŒ—m->hooks->
»ad
;

229 
šlše
 
as_¡»am_¡©us
 
as_¡»am_wr™e
(cÚ¡ 
as_¡»am
 * 
¡»am
, 
as_v®
 * 
v®ue
)

231  
as_ut_hook
(
wr™e
, 
AS_STREAM_ERR
, 
¡»am
, 
v®ue
);

244 
šlše
 
boŞ
 
as_¡»am_wr™abË
(cÚ¡ 
as_¡»am
 * 
¡»am
)

246  
¡»am
 !ğ
NULL
 && sŒ—m->
hooks
 !ğNULL && sŒ—m->hooks->
wr™e
;

249 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_string.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_ut.h
>

21 
	~<«ro¥ike/as_v®.h
>

23 
	~<¡dboŞ.h
>

24 
	~<¡dšt.h
>

25 
	~<¡ršg.h
>

27 #ifdeà
__ılu¥lus


106 
	sas_¡ršg_s
 {

113 
as_v®
 
_
;

118 
boŞ
 
ä“
;

123 * 
v®ue
;

128 
size_t
 
Ën
;

130 } 
	tas_¡ršg
;

149 
as_¡ršg
 * 
as_¡ršg_š™
×s_¡ršg * 
¡ršg
, * 
v®ue
, 
boŞ
 
ä“
);

165 
as_¡ršg
 * 
as_¡ršg_š™_wËn
×s_¡ršg * 
¡ršg
, * 
v®ue
, 
size_t
 
Ën
, 
boŞ
 
ä“
);

179 
as_¡ršg
 * 
as_¡ršg_Ãw
(* 
v®ue
, 
boŞ
 
ä“
);

194 
as_¡ršg
 * 
as_¡ršg_Ãw_wËn
(* 
v®ue
, 
size_t
 
Ën
, 
boŞ
 
ä“
);

205 
as_¡ršg
 * 
as_¡ršg_Ãw_¡rdup
(cÚ¡ * 
v®ue
);

212 
šlše
 
as_¡ršg_de¡roy
(
as_¡ršg
 * 
¡ršg
)

214 
as_v®_de¡roy
((
as_v®
 *è
¡ršg
);

230 
size_t
 
as_¡ršg_Ën
(
as_¡ršg
 * 
¡ršg
);

237 
šlše
 * 
as_¡ršg_g‘Ü–£
(cÚ¡ 
as_¡ršg
 * 
¡ršg
, * 
çÎback
)

239  
¡ršg
 ? sŒšg->
v®ue
 : 
çÎback
;

247 
šlše
 * 
as_¡ršg_g‘
(cÚ¡ 
as_¡ršg
 * 
¡ršg
)

249  
as_¡ršg_g‘Ü–£
(
¡ršg
, 
NULL
);

258 
šlše
 * 
as_¡ršg_to¡ršg
(cÚ¡ 
as_¡ršg
 * 
¡ršg
)

260  
as_¡ršg_g‘Ü–£
(
¡ršg
, 
NULL
);

273 cÚ¡ * 
as_ba£Çme
(
as_¡ršg
 * 
f’ame
, cÚ¡ * 
·th
);

284 
šlše
 
as_v®
 * 
as_¡ršg_tov®
(cÚ¡ 
as_¡ršg
 * 
s
)

286  (
as_v®
 *è
s
;

294 
šlše
 
as_¡ršg
 * 
as_¡ršg_äomv®
(cÚ¡ 
as_v®
 * 
v
)

296  
as_ut_äomv®
(
v
, 
AS_STRING
, 
as_¡ršg
);

307 
as_¡ršg_v®_de¡roy
(
as_v®
 * 
v
);

313 
ušt32_t
 
as_¡ršg_v®_hashcode
(cÚ¡ 
as_v®
 * 
v
);

319 * 
as_¡ršg_v®_to¡ršg
(cÚ¡ 
as_v®
 * 
v
);

341 
boŞ
 
as_¡ºıy
(* 
Œg
, cÚ¡ * 
¤c
, 
size
);

343 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_string_builder.h

17 #´agm¨
Úû


19 
	~<¡dšt.h
>

20 
	~<¡dboŞ.h
>

22 #ifdeà
__ılu¥lus


33 
	sas_¡ršg_bud”_s
 {

37 * 
d©a
;

42 
ušt32_t
 
ÿ·c™y
;

47 
ušt32_t
 
Ëngth
;

52 
boŞ
 
»size
;

57 
boŞ
 
ä“
;

58 } 
	tas_¡ršg_bud”
;

67 
	#as_¡ršg_bud”_š™a
(
__sb
, 
__ÿ·c™y
, 
__»size
)\

68 (
__sb
)->
d©a
 = 
	`®loÿ
(
__ÿ·c™y
);\

69 (
__sb
)->
d©a
[0] = 0;\

70 (
__sb
)->
ÿ·c™y
 = (
__ÿ·c™y
);\

71 (
__sb
)->
Ëngth
 = 0;\

72 (
__sb
)->
»size
 = (
__»size
);\

73 (
__sb
)->
ä“
 = 
çl£
;

	)

83 
as_¡ršg_bud”_š™
(
as_¡ršg_bud”
* 
sb
, 
ušt32_t
 
ÿ·c™y
, 
boŞ
 
»size
);

89 
as_¡ršg_bud”_de¡roy
(
as_¡ršg_bud”
* 
sb
);

95 
šlše
 

96 
as_¡ršg_bud”_»£t
(
as_¡ršg_bud”
* 
sb
)

98 
sb
->
d©a
[0] = 0;

99 
sb
->
Ëngth
 = 0;

106 
boŞ


107 
as_¡ršg_bud”_­³nd
(
as_¡ršg_bud”
* 
sb
, cÚ¡ * 
v®ue
);

113 
boŞ


114 
as_¡ršg_bud”_­³nd_ch¬
(
as_¡ršg_bud”
* 
sb
, 
v®ue
);

116 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_stringmap.h

26 #´agm¨
Úû


28 
	~<«ro¥ike/as_ut.h
>

29 
	~<«ro¥ike/as_v®.h
>

30 
	~<«ro¥ike/as_š‹g”.h
>

31 
	~<«ro¥ike/as_¡ršg.h
>

32 
	~<«ro¥ike/as_by‹s.h
>

33 
	~<«ro¥ike/as_li¡.h
>

34 
	~<«ro¥ike/as_m­.h
>

36 
	~<¡dboŞ.h
>

37 
	~<¡dšt.h
>

38 
	~<¡ršg.h
>

40 #ifdeà
__ılu¥lus


51 
šlše
 
as_¡ršgm­_£t
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
as_v®
 * 
v
)

53  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), 
v
);

59 
šlše
 
as_¡ršgm­_£t_št64
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
št64_t
 
v
)

61  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
as_š‹g”_Ãw
(
v
));

67 
šlše
 
as_¡ršgm­_£t_doubË
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
v
)

69  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
as_doubË_Ãw
(
v
));

75 
šlše
 
as_¡ršgm­_£t_¡r
(
as_m­
 * 
m
, cÚ¡ * 
k
, cÚ¡ * 
v
)

77  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *èas_¡ršg_Ãw_¡rdup(
v
));

83 
šlše
 
as_¡ršgm­_£t_š‹g”
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
as_š‹g”
 * 
v
)

85  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
v
);

91 
šlše
 
as_¡ršgm­_£t_as_doubË
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
as_doubË
 * 
v
)

93  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
v
);

99 
šlše
 
as_¡ršgm­_£t_¡ršg
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
as_¡ršg
 * 
v
)

101  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
v
);

107 
šlše
 
as_¡ršgm­_£t_by‹s
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
as_by‹s
 * 
v
)

109  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
v
);

115 
šlše
 
as_¡ršgm­_£t_li¡
(
as_m­
 * 
m
, cÚ¡ * 
k
, 
as_li¡
 * 
v
)

117  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
v
);

123 
šlše
 
as_¡ršgm­_£t_m­
(
as_m­
 * 
m
, cÚ¡ * 
k
,‡s_m­ * 
v
)

125  
as_ut_hook
(
£t
, 1, 
m
, (
as_v®
 *è
as_¡ršg_Ãw_¡rdup
(
k
), (as_v® *è
v
);

135 
šlše
 
as_v®
 * 
as_¡ršgm­_g‘
(
as_m­
 * 
m
, cÚ¡ * 
k
)

137 
as_¡ršg
 
key
;

138 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

139  
v
;

145 
šlše
 
št64_t
 
as_¡ršgm­_g‘_št64
(
as_m­
 * 
m
, cÚ¡ * 
k
)

147 
as_¡ršg
 
key
;

148 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

149 
as_š‹g”
 * 
i
 = 
as_š‹g”_äomv®
(
v
);

150  
i
 ? 
as_š‹g”_tošt
(i) : 0;

156 
šlše
 
as_¡ršgm­_g‘_doubË
(
as_m­
 * 
m
, cÚ¡ * 
k
)

158 
as_¡ršg
 
key
;

159 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

160 
as_doubË
 * 
±r
 = 
as_doubË_äomv®
(
v
);

161  
±r
 ?…Œ->
v®ue
 : 0.0;

167 
šlše
 * 
as_¡ršgm­_g‘_¡r
(
as_m­
 * 
m
, cÚ¡ * 
k
)

169 
as_¡ršg
 
key
;

170 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

171 
as_¡ršg
 * 
s
 = 
as_¡ršg_äomv®
(
v
);

172  
s
 ? 
as_¡ršg_to¡ršg
(sè: 
NULL
;

178 
šlše
 
as_š‹g”
 * 
as_¡ršgm­_g‘_š‹g”
(
as_m­
 * 
m
, cÚ¡ * 
k
)

180 
as_¡ršg
 
key
;

181 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

182  
as_š‹g”_äomv®
(
v
);

188 
šlše
 
as_doubË
 * 
as_¡ršgm­_g‘_as_doubË
(
as_m­
 * 
m
, cÚ¡ * 
k
)

190 
as_¡ršg
 
key
;

191 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

192  
as_doubË_äomv®
(
v
);

198 
šlše
 
as_¡ršg
 * 
as_¡ršgm­_g‘_¡ršg
(
as_m­
 * 
m
, cÚ¡ * 
k
)

200 
as_¡ršg
 
key
;

201 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

202  
as_¡ršg_äomv®
(
v
);

208 
šlše
 
as_by‹s
 * 
as_¡ršgm­_g‘_by‹s
(
as_m­
 * 
m
, cÚ¡ * 
k
)

210 
as_¡ršg
 
key
;

211 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

212  
as_by‹s_äomv®
(
v
);

218 
šlše
 
as_li¡
 * 
as_¡ršgm­_g‘_li¡
(
as_m­
 * 
m
, cÚ¡ * 
k
)

220 
as_¡ršg
 
key
;

221 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

222  
as_li¡_äomv®
(
v
);

228 
šlše
 
as_m­
 * 
as_¡ršgm­_g‘_m­
×s_m­ * 
m
, cÚ¡ * 
k
)

230 
as_¡ršg
 
key
;

231 
as_v®
 * 
v
 = 
as_ut_hook
(
g‘
, 
NULL
, 
m
, (as_v® *è
as_¡ršg_š™
(&
key
, (*è
k
, 
çl£
));

232  
as_m­_äomv®
(
v
);

239 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_thread_pool.h

17 #´agm¨
Úû


19 
	~<c™ru¦—f/cf_queue.h
>

20 
	~<±h»ad.h
>

22 #ifdeà
__ılu¥lus


34 (*
as_sk_â
)(* 
	tu£r_d©a
);

40 (*
as_fši_â
)();

46 
	sas_th»ad_poŞ_s
 {

47 
±h»ad_mu‹x_t
 
lock
;

48 
cf_queue
* 
di¥©ch_queue
;

49 
cf_queue
* 
com¶‘e_queue
;

50 
as_sk_â
 
sk_â
;

51 
as_fši_â
 
fši_â
;

52 
ušt32_t
 
sk_size
;

53 
ušt32_t
 
sk_com¶‘e_off£t
;

54 
ušt32_t
 
th»ad_size
;

55 
ušt32_t
 
š™Ÿlized
;

56 } 
	tas_th»ad_poŞ
;

74 
as_th»ad_poŞ_š™
(
as_th»ad_poŞ
* 
poŞ
, 
ušt32_t
 
th»ad_size
);

90 
as_th»ad_poŞ_š™_fixed
(
as_th»ad_poŞ
* 
poŞ
, 
ušt32_t
 
th»ad_size
, 
as_sk_â
 
sk_â
,

91 
ušt32_t
 
sk_size
, ušt32_ˆ
sk_com¶‘e_off£t
);

104 
as_th»ad_poŞ_»size
(
as_th»ad_poŞ
* 
poŞ
, 
ušt32_t
 
th»ad_size
);

116 
as_th»ad_poŞ_queue_sk
(
as_th»ad_poŞ
* 
poŞ
, 
as_sk_â
 
sk_â
, * 
sk
);

128 
as_th»ad_poŞ_queue_sk_fixed
(
as_th»ad_poŞ
* 
poŞ
, * 
sk
);

140 
as_th»ad_poŞ_de¡roy
(
as_th»ad_poŞ
* 
poŞ
);

142 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_timer.h

17 #´agm¨
Úû


19 
	~<¡dlib.h
>

20 
	~<¡d¬g.h
>

21 
	~<¡dboŞ.h
>

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


32 
as_tim”_s
;

36 
	sas_tim”_hooks_s
 {

41 (* 
de¡roy
)(
as_tim”_s
 *);

42 
boŞ
 (* 
timedout
)(cÚ¡ 
as_tim”_s
 *);

43 
ušt64_t
 (* 
time¦iû
)(cÚ¡ 
as_tim”_s
 *);

44 } 
	tas_tim”_hooks
;

49 
	sas_tim”_s
 {

50 
boŞ
 
is_m®loc
;

51 * 
sourû
;

52 cÚ¡ 
as_tim”_hooks
 * 
hooks
;

53 } 
	tas_tim”
;

62 
as_tim”
 * 
as_tim”_š™
×s_tim” * 
tim”
, * 
sourû
, cÚ¡ 
as_tim”_hooks
 * 
hooks
);

67 
as_tim”
 * 
as_tim”_Ãw
(* 
sourû
, cÚ¡ 
as_tim”_hooks
 * 
hooks
);

70 
šlše
 * 
as_tim”_sourû
(cÚ¡ 
as_tim”
 * 
‰
) {

71  (
‰
 ?t->
sourû
 : 
NULL
);

79 
as_tim”_de¡roy
(
as_tim”
 * 
tim”
);

84 
boŞ
 
as_tim”_timedout
(cÚ¡ 
as_tim”
 * 
tim”
);

89 
ušt64_t
 
as_tim”_time¦iû
(cÚ¡ 
as_tim”
 * 
tim”
);

91 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_tls.h

17 #´agm¨
Úû


19 
	~<İ’s¦/s¦.h
>

21 
	~<«ro¥ike/as_cÚfig.h
>

22 
	~<«ro¥ike/as_¡©us.h
>

23 
	~<«ro¥ike/as_sock‘.h
>

26 
as_s_check_š™
();

28 
as_s_ş—nup
();

30 
as_s_th»ad_ş—nup
();

32 
as_¡©us
 
as_s_cÚ‹xt_£tup
(
as_cÚfig_s
* 
scfg
,

33 
as_s_cÚ‹xt
* 
oùx
,

34 
as_”rÜ
* 
”r
);

36 
as_s_cÚ‹xt_de¡roy
(
as_s_cÚ‹xt
* 
ùx
);

38 
as_¡©us
 
as_s_cÚfig_»lßd
(
as_cÚfig_s
* 
scfg
, 
as_s_cÚ‹xt
* 
ùx
, 
as_”rÜ
 *
”r
);

40 
as_s_w¿p
(
as_s_cÚ‹xt
* 
ùx
, 
as_sock‘
* 
sock
, cÚ¡ * 
s_Çme
);

42 
as_s_£t_Çme
(
as_sock‘
* 
sock
, cÚ¡ * 
s_Çme
);

44 
as_s_cÚÃù_Úû
(
as_sock‘
* 
sock
);

46 
as_s_cÚÃù
(
as_sock‘
* 
sock
);

50 
as_s_»ad_³ndšg
(
as_sock‘
* 
sock
);

52 
as_s_»ad_Úû
(
as_sock‘
* 
sock
, * 
buf
, 
size_t
 
num
);

54 
as_s_»ad
(
as_sock‘
* 
sock
, * 
buf
, 
size_t
 
num
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše
);

56 
as_s_wr™e_Úû
(
as_sock‘
* 
sock
, * 
buf
, 
size_t
 
num
);

58 
as_s_wr™e
(
as_sock‘
* 
sock
, * 
buf
, 
size_t
 
num
, 
ušt32_t
 
sock‘_timeout
, 
ušt64_t
 
d—dlše
);

	@application/kvbench/include/aerospike/as_types.h

18 #´agm¨
Úû


20 
	~<«ro¥ike/as_boŞ—n.h
>

21 
	~<«ro¥ike/as_š‹g”.h
>

22 
	~<«ro¥ike/as_geojsÚ.h
>

23 
	~<«ro¥ike/as_¡ršg.h
>

24 
	~<«ro¥ike/as_by‹s.h
>

25 
	~<«ro¥ike/as_·œ.h
>

26 
	~<«ro¥ike/as_n.h
>

27 
	~<«ro¥ike/as_v®.h
>

29 
	~<«ro¥ike/as_»c.h
>

30 
	~<«ro¥ike/as_™”©Ü.h
>

31 
	~<«ro¥ike/as_¡»am.h
>

33 
	~<«ro¥ike/as_li¡.h
>

34 
	~<«ro¥ike/as_¬¿yli¡.h
>

35 
	~<«ro¥ike/as_¬¿yli¡_™”©Ü.h
>

37 
	~<«ro¥ike/as_m­.h
>

38 
	~<«ro¥ike/as_hashm­.h
>

39 
	~<«ro¥ike/as_hashm­_™”©Ü.h
>

41 
	~<«ro¥ike/as_»suÉ.h
>

	@application/kvbench/include/aerospike/as_udf.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_by‹s.h
>

20 
	~<«ro¥ike/as_li¡.h
>

22 #ifdeà
__ılu¥lus


33 
	#AS_UDF_MODULE_MAX_SIZE
 64

	)

38 
	#AS_UDF_MODULE_MAX_LEN
 (
AS_UDF_MODULE_MAX_SIZE
 - 1)

	)

43 
	#AS_UDF_FUNCTION_MAX_SIZE
 64

	)

48 
	#AS_UDF_FUNCTION_MAX_LEN
 (
AS_UDF_FUNCTION_MAX_SIZE
 - 1)

	)

53 
	#AS_UDF_FILE_NAME_SIZE
 128

	)

58 
	#AS_UDF_FILE_NAME_SIZE
 128

	)

63 
	#AS_UDF_FILE_NAME_LEN
 
AS_UDF_FILE_NAME_SIZE
 - 1

	)

68 
	#AS_UDF_FILE_HASH_SIZE
 (20 * 2)

	)

77 
	tas_udf_moduË_Çme
[
AS_UDF_MODULE_MAX_SIZE
];

82 
	tas_udf_funùiÚ_Çme
[
AS_UDF_FUNCTION_MAX_SIZE
];

87 
	sas_udf_ÿÎ_s
 {

93 
boŞ
 
_ä“
;

98 
as_udf_moduË_Çme
 
moduË
;

103 
as_udf_funùiÚ_Çme
 
funùiÚ
;

108 
as_li¡
 * 
¬gli¡
;

110 } 
	tas_udf_ÿÎ
;

115 
	eas_udf_ty³_e
 {

120 
AS_UDF_TYPE_LUA


122 } 
	tas_udf_ty³
;

127 
	sas_udf_fe_s
 {

133 
boŞ
 
_ä“
;

138 
Çme
[
AS_UDF_FILE_NAME_SIZE
];

143 
ušt8_t
 
hash
[
AS_UDF_FILE_HASH_SIZE
+1];

148 
as_udf_ty³
 
ty³
;

159 
boŞ
 
_ä“
;

164 
ušt32_t
 
ÿ·c™y
;

169 
ušt32_t
 
size
;

174 
ušt8_t
 * 
by‹s
;

176 } 
cÚ‹Á
;

178 } 
	tas_udf_fe
;

183 
	sas_udf_fes_s
 {

189 
boŞ
 
_ä“
;

194 
ušt32_t
 
ÿ·c™y
;

199 
ušt32_t
 
size
;

204 
as_udf_fe
 * 
’Œ›s
;

206 } 
	tas_udf_fes
;

222 
as_udf_ÿÎ
 * 
as_udf_ÿÎ_š™
×s_udf_ÿÎ * 
ÿÎ
, cÚ¡ 
as_udf_moduË_Çme
 
moduË
, cÚ¡ 
as_udf_funùiÚ_Çme
 
funùiÚ
, 
as_li¡
 * 
¬gli¡
);

232 
as_udf_ÿÎ
 * 
as_udf_ÿÎ_Ãw
(cÚ¡ 
as_udf_moduË_Çme
 
moduË
, cÚ¡ 
as_udf_funùiÚ_Çme
 
funùiÚ
, 
as_li¡
 * 
¬gli¡
);

237 
as_udf_ÿÎ_de¡roy
(
as_udf_ÿÎ
 * 
ÿÎ
);

248 
as_udf_fe
 * 
as_udf_fe_š™
×s_udf_f* 
fe
);

255 
as_udf_fe
 * 
as_udf_fe_Ãw
();

260 
as_udf_fe_de¡roy
(
as_udf_fe
 * 
fe
);

271 
as_udf_fes
 * 
as_udf_fes_š™
×s_udf_fe * 
fes
, 
ušt32_t
 
ÿ·c™y
);

278 
as_udf_fes
 * 
as_udf_fes_Ãw
(
ušt32_t
 
ÿ·c™y
);

283 
as_udf_fes_de¡roy
(
as_udf_fes
 * 
fes
);

285 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_udf_context.h

17 #´agm¨
Úû


19 
	~<«ro¥ike/as_memŒack”.h
>

20 
	~<«ro¥ike/as_tim”.h
>

21 
	~<«ro¥ike/as_«ro¥ike.h
>

23 #ifdeà
__ılu¥lus


31 
	sas_udf_cÚ‹xt_s
 {

32 
as_«ro¥ike
 * 
as
;

33 
as_tim”
 * 
tim”
;

34 
as_memŒack”
 * 
memŒack”
;

35 } 
	tas_udf_cÚ‹xt
;

37 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_util.h

18 #´agm¨
Úû


20 
	~<¡ddef.h
>

22 
	~<c™ru¦—f/®loc.h
>

24 #ifdeà
__ılu¥lus


36 
	#as_ut_hook
(
hook
,,
objeù
,
¬gs
...) \

37 (
objeù
 && objeù->
hooks
 && objeù->hooks->
hook
 ? objeù->hooks->
	`hook
(objeù, ## 
¬gs
è: )

	)

42 
	#as_ut_äomv®
(
objeù
,
ty³_id
,
ty³
) \

43 (
objeù
 && 
	`as_v®_ty³
(objeùè=ğ
ty³_id
 ? (
ty³
 *èobjeù : 
NULL
)

	)

45 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_val.h

18 #´agm¨
Úû


20 
	~<c™ru¦—f/cf_©omic.h
>

22 
	~<¡dboŞ.h
>

23 
	~<¡dšt.h
>

25 #ifdeà
__ılu¥lus


36 
	eas_v®_t
 {

37 
AS_UNDEF
 = 0,

38 
AS_UNKNOWN
 = 0,

39 
AS_NIL
 = 1,

40 
AS_BOOLEAN
 = 2,

41 
AS_INTEGER
 = 3,

42 
AS_STRING
 = 4,

43 
AS_LIST
 = 5,

44 
AS_MAP
 = 6,

45 
AS_REC
 = 7,

46 
AS_PAIR
 = 8,

47 
AS_BYTES
 = 9,

48 
AS_DOUBLE
 = 10,

49 
AS_GEOJSON
 = 11,

50 
AS_VAL_T_MAX


51 } 
	t__©Œibu‹__
((
	t·cked
)è
	tas_v®_t
;

57 
	sas_v®_s
 {

62 
as_v®_t
 
ty³
;

68 
boŞ
 
ä“
;

75 
cf_©omic32
 
couÁ
;

77 } 
	tas_v®
;

91 
	#as_v®_ty³
(
__v
è(__v ? ((
as_v®
 *)__v)->
ty³
 : 
AS_UNDEF
)

	)

100 
	#as_v®_»£rve
(
__v
èĞ
	`as_v®_v®_»£rve
((
as_v®
 *)__vè)

	)

110 
	#as_v®_de¡roy
(
__v
èĞ
	`as_v®_v®_de¡roy
((
as_v®
 *)__vè)

	)

119 
	#as_v®_hashcode
(
__v
èĞ
	`as_v®_v®_hashcode
((
as_v®
 *)__vè)

	)

128 
	#as_v®_to¡ršg
(
__v
èĞ
	`as_v®_v®_to¡ršg
((
as_v®
 *)__vè)

	)

138 
as_v®
 * 
as_v®_v®_»£rve
(as_val *);

145 
as_v®
 * 
as_v®_v®_de¡roy
(as_val *);

151 
ušt32_t
 
as_v®_v®_hashcode
(cÚ¡ 
as_v®
 *);

157 * 
as_v®_v®_to¡ršg
(cÚ¡ 
as_v®
 *);

169 
šlše
 
as_v®_š™
(
as_v®
 * 
v
, 
as_v®_t
 
ty³
, 
boŞ
 
ä“
)

171 
v
->
ty³
 =ype;

172 
v
->
ä“
 = free;

173 
v
->
couÁ
 = 1;

182 
šlše
 
as_v®
 * 
as_v®_cÚs
×s_v® * 
v®
, 
as_v®_t
 
ty³
, 
boŞ
 
ä“
)

184 iàĞ!
v®
 )  val;

186 
v®
->
ty³
 =ype;

187 
v®
->
ä“
 = free;

188 
v®
->
couÁ
 = 1;

189  
v®
;

192 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/as_vector.h

17 #´agm¨
Úû


19 
	~<c™ru¦—f/®loc.h
>

20 
	~<c™ru¦—f/cf_ty³s.h
>

21 
	~<¡ršg.h
>

23 #ifdeà
__ılu¥lus


35 
	sas_veùÜ_s
 {

39 * 
li¡
;

44 
ušt32_t
 
ÿ·c™y
;

49 
ušt32_t
 
size
;

54 
ušt32_t
 
™em_size
;

59 
ušt32_t
 
æags
;

60 } 
	tas_veùÜ
;

71 
	#as_veùÜ_š™a
(
__veùÜ
, 
__™em_size
, 
__ÿ·c™y
)\

72 (
__veùÜ
)->
li¡
 = 
	`®loÿ
((
__ÿ·c™y
è* (
__™em_size
));\

73 (
__veùÜ
)->
ÿ·c™y
 = 
__ÿ·c™y
;\

74 (
__veùÜ
)->
™em_size
 = 
__™em_size
;\

75 (
__veùÜ
)->
size
 = 0;\

76 (
__veùÜ
)->
æags
 = 0;

	)

86 
as_veùÜ_š™
(
as_veùÜ
* 
veùÜ
, 
ušt32_t
 
™em_size
, ušt32_ˆ
ÿ·c™y
);

91 
as_veùÜ
*

92 
as_veùÜ_ü—‹
(
ušt32_t
 
™em_size
, ušt32_ˆ
ÿ·c™y
);

98 
as_veùÜ_de¡roy
(
as_veùÜ
* 
veùÜ
);

103 
šlše
 

104 
as_veùÜ_ş—r
(
as_veùÜ
* 
veùÜ
)

106 
veùÜ
->
size
 = 0;

112 
šlše
 *

113 
as_veùÜ_g‘
(
as_veùÜ
* 
veùÜ
, 
ušt32_t
 
šdex
)

115  (*è((
ušt8_t
 *)
veùÜ
->
li¡
 + (veùÜ->
™em_size
 * 
šdex
));

121 
šlše
 *

122 
as_veùÜ_g‘_±r
(
as_veùÜ
* 
veùÜ
, 
ušt32_t
 
šdex
)

124  *(**è((
ušt8_t
 *)
veùÜ
->
li¡
 + (veùÜ->
™em_size
 * 
šdex
));

131 
as_veùÜ_šü—£_ÿ·c™y
(
as_veùÜ
* 
veùÜ
);

136 
šlše
 

137 
as_veùÜ_£t
(
as_veùÜ
* 
veùÜ
, 
ušt32_t
 
šdex
, * 
v®ue
)

139 
memıy
((
ušt8_t
 *)
veùÜ
->
li¡
 + (
šdex
 * veùÜ->
™em_size
), 
v®ue
, vector->item_size);

145 
šlše
 

146 
as_veùÜ_­³nd
(
as_veùÜ
* 
veùÜ
, * 
v®ue
)

148 ià(
veùÜ
->
size
 >ğveùÜ->
ÿ·c™y
) {

149 
as_veùÜ_šü—£_ÿ·c™y
(
veùÜ
);

151 
memıy
((
ušt8_t
 *)
veùÜ
->
li¡
 + (veùÜ->
size
 * veùÜ->
™em_size
), 
v®ue
, vector->item_size);

152 
veùÜ
->
size
++;

158 
boŞ


159 
as_veùÜ_­³nd_unique
(
as_veùÜ
* 
veùÜ
, * 
v®ue
);

165 
as_veùÜ_to_¬¿y
(
as_veùÜ
* 
veùÜ
, 
ušt32_t
* 
size
);

171 
šlše
 *

172 
as_veùÜ_»£rve
(
as_veùÜ
* 
veùÜ
)

174 ià(
veùÜ
->
size
 >ğveùÜ->
ÿ·c™y
) {

175 
as_veùÜ_šü—£_ÿ·c™y
(
veùÜ
);

177 * 
™em
 = (
ušt8_t
 *)
veùÜ
->
li¡
 + (veùÜ->
size
 * veùÜ->
™em_size
);

178 
mem£t
(
™em
, 0, 
veùÜ
->
™em_size
);

179 
veùÜ
->
size
++;

180  
™em
;

186 
boŞ


187 
as_veùÜ_»move
(
as_veùÜ
* 
veùÜ
, 
ušt32_t
 
šdex
);

189 #ifdeà
__ılu¥lus


	@application/kvbench/include/aerospike/ck/ck_backoff.h

27 #iâdeà
CK_BACKOFF_H


28 
	#CK_BACKOFF_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_´.h
>

33 #iâdeà
CK_BACKOFF_CEILING


34 
	#CK_BACKOFF_CEILING
 ((1 << 20è- 1)

	)

37 
	#CK_BACKOFF_INITIALIZER
 (1 << 9)

	)

39 
	tck_backoff_t
;

44 
CK_CC_INLINE
 

45 
	$ck_backoff_eb
(*
c
)

47 
i
, 
ûšg
;

49 
ûšg
 = *
c
;

50 
i
 = 0; i < 
ûšg
; i++)

51 
	`ck_´_b¬r›r
();

53 *
c
 = 
ûšg
 <<ğûšg < 
CK_BACKOFF_CEILING
;

55 
	}
}

	@application/kvbench/include/aerospike/ck/ck_bitmap.h

29 #iâdeà
CK_BITMAP_H


30 
	#CK_BITMAP_H


	)

32 
	~<«ro¥ike/ck/ck_cc.h
>

33 
	~<«ro¥ike/ck/ck_lim™s.h
>

34 
	~<«ro¥ike/ck/ck_´.h
>

35 
	~<«ro¥ike/ck/ck_¡dšt.h
>

36 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

37 
	~<«ro¥ike/ck/ck_¡ddef.h
>

38 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

39 
	~<«ro¥ike/ck/ck_¡ddef.h
>

40 
	~<«ro¥ike/ck/ck_¡ršg.h
>

42 #ià!
defšed
(
CK_F_PR_LOAD_UINT
è|| !defšed(
CK_F_PR_STORE_UINT
) || \

43 !
defšed
(
CK_F_PR_AND_UINT
è|| !defšed(
CK_F_PR_OR_UINT
) || \

44 !
	$defšed
(
CK_F_CC_CTZ
)

48 
	#CK_BITMAP_BLOCK
 ((è* 
CHAR_BIT
)

	)

49 
	#CK_BITMAP_OFFSET
(
i
è((iè% 
CK_BITMAP_BLOCK
)

	)

50 
	#CK_BITMAP_BIT
(
i
è(1U << 
	`CK_BITMAP_OFFSET
(i))

	)

51 
	#CK_BITMAP_PTR
(
x
, 
i
è((xè+ ((iè/ 
CK_BITMAP_BLOCK
))

	)

52 
	#CK_BITMAP_BLOCKS
(
n
è((Òè+ 
CK_BITMAP_BLOCK
 - 1è/ CK_BITMAP_BLOCK)

	)

54 
	#CK_BITMAP_INSTANCE
(
n_’Œ›s
) \

57 
n_b™s
; \

58 
m­
[
	`CK_BITMAP_BLOCKS
(
n_’Œ›s
)]; \

59 } 
cÚ‹Á
; \

60 
ck_b™m­
 
b™m­
; \

61 }

	)

63 
	#CK_BITMAP_ITERATOR_INIT
(
a
, 
b
) \

64 
	`ck_b™m­_™”©Ü_š™
((
a
), &(
b
)->
b™m­
)

	)

66 
	#CK_BITMAP_INIT
(
a
, 
b
, 
c
) \

67 
	`ck_b™m­_š™
(&(
a
)->
b™m­
, (
b
), (
c
))

	)

69 
	#CK_BITMAP_NEXT
(
a
, 
b
, 
c
) \

70 
	`ck_b™m­_Ãxt
(&(
a
)->
b™m­
, (
b
), (
c
))

	)

72 
	#CK_BITMAP_SET
(
a
, 
b
) \

73 
	`ck_b™m­_£t
(&(
a
)->
b™m­
, (
b
))

	)

75 
	#CK_BITMAP_BTS
(
a
, 
b
) \

76 
	`ck_b™m­_bts
(&(
a
)->
b™m­
, (
b
))

	)

78 
	#CK_BITMAP_RESET
(
a
, 
b
) \

79 
	`ck_b™m­_»£t
(&(
a
)->
b™m­
, (
b
))

	)

81 
	#CK_BITMAP_TEST
(
a
, 
b
) \

82 
	`ck_b™m­_‹¡
(&(
a
)->
b™m­
, (
b
))

	)

84 
	#CK_BITMAP_UNION
(
a
, 
b
) \

85 
	`ck_b™m­_uniÚ
(&(
a
)->
b™m­
, &(
b
)->b™m­)

	)

87 
	#CK_BITMAP_INTERSECTION
(
a
, 
b
) \

88 
	`ck_b™m­_š‹r£ùiÚ
(&(
a
)->
b™m­
, &(
b
)->b™m­)

	)

90 
	#CK_BITMAP_INTERSECTION_NEGATE
(
a
, 
b
) \

91 
	`ck_b™m­_š‹r£ùiÚ_Ãg©e
(&(
a
)->
b™m­
, &(
b
)->b™m­)

	)

93 
	#CK_BITMAP_CLEAR
(
a
) \

94 
	`ck_b™m­_ş—r
(&(
a
)->
b™m­
)

	)

96 
	#CK_BITMAP_EMPTY
(
a
, 
b
) \

97 
	`ck_b™m­_em±y
(&(
a
)->
b™m­
, 
b
)

	)

99 
	#CK_BITMAP_FULL
(
a
, 
b
) \

100 
	`ck_b™m­_fuÎ
(&(
a
)->
b™m­
, 
b
)

	)

102 
	#CK_BITMAP_COUNT
(
a
, 
b
) \

103 
	`ck_b™m­_couÁ
(&(
a
)->
b™m­
, 
b
)

	)

105 
	#CK_BITMAP_COUNT_INTERSECT
(
a
, 
b
, 
c
) \

106 
	`ck_b™m­_couÁ_š‹r£ù
(&(
a
)->
b™m­
, 
b
, 
c
)

	)

108 
	#CK_BITMAP_BITS
(
a
) \

109 
	`ck_b™m­_b™s
(&(
a
)->
b™m­
)

	)

111 
	#CK_BITMAP_BUFFER
(
a
) \

112 
	`ck_b™m­_bufãr
(&(
a
)->
b™m­
)

	)

114 
	#CK_BITMAP
(
a
) \

115 (&(
a
)->
b™m­
)

	)

117 
	sck_b™m­
 {

118 
n_b™s
;

119 
m­
[];

121 
ck_b™m­
 
	tck_b™m­_t
;

123 
	sck_b™m­_™”©Ü
 {

124 
ÿche
;

125 
n_block
;

126 
n_lim™
;

128 
ck_b™m­_™”©Ü
 
	tck_b™m­_™”©Ü_t
;

130 
CK_CC_INLINE
 

131 
	$ck_b™m­_ba£
(
n_b™s
)

134  
	`CK_BITMAP_BLOCKS
(
n_b™s
) * ();

135 
	}
}

141 
CK_CC_INLINE
 

142 
	$ck_b™m­_size
(
n_b™s
)

145  
	`ck_b™m­_ba£
(
n_b™s
è+ (
ck_b™m­
);

146 
	}
}

151 
CK_CC_INLINE
 

152 
	$ck_b™m­_b™s
(cÚ¡ 
ck_b™m­
 *
b™m­
)

155  
b™m­
->
n_b™s
;

156 
	}
}

162 
CK_CC_INLINE
 *

163 
	$ck_b™m­_bufãr
(
ck_b™m­
 *
b™m­
)

166  
b™m­
->
m­
;

167 
	}
}

172 
CK_CC_INLINE
 

173 
	$ck_b™m­_£t
(
ck_b™m­
 *
b™m­
, 
n
)

176 
	`ck_´_Ü_ušt
(
	`CK_BITMAP_PTR
(
b™m­
->
m­
, 
n
), 
	`CK_BITMAP_BIT
(n));

178 
	}
}

186 
CK_CC_INLINE
 
boŞ


187 
	$ck_b™m­_bts
(
ck_b™m­
 *
b™m­
, 
n
)

190  
	`ck_´_bts_ušt
(
	`CK_BITMAP_PTR
(
b™m­
->
m­
, 
n
),

191 
	`CK_BITMAP_OFFSET
(
n
));

192 
	}
}

197 
CK_CC_INLINE
 

198 
	$ck_b™m­_»£t
(
ck_b™m­
 *
b™m­
, 
n
)

201 
	`ck_´_ªd_ušt
(
	`CK_BITMAP_PTR
(
b™m­
->
m­
, 
n
), ~
	`CK_BITMAP_BIT
(n));

203 
	}
}

209 
CK_CC_INLINE
 
boŞ


210 
	$ck_b™m­_‹¡
(cÚ¡ 
ck_b™m­
 *
b™m­
, 
n
)

212 
block
;

214 
block
 = 
	`ck_´_lßd_ušt
(
	`CK_BITMAP_PTR
(
b™m­
->
m­
, 
n
));

215  
block
 & 
	`CK_BITMAP_BIT
(
n
);

216 
	}
}

222 
CK_CC_INLINE
 

223 
	$ck_b™m­_uniÚ
(
ck_b™m­
 *
d¡
, cÚ¡ ck_b™m­ *
¤c
)

225 
n
;

226 
n_buck‘s
 = 
d¡
->
n_b™s
;

228 ià(
¤c
->
n_b™s
 < 
d¡
->n_bits)

229 
n_buck‘s
 = 
¤c
->
n_b™s
;

231 
n_buck‘s
 = 
	`CK_BITMAP_BLOCKS
(n_buckets);

232 
n
 = 0;‚ < 
n_buck‘s
;‚++) {

233 
	`ck_´_Ü_ušt
(&
d¡
->
m­
[
n
],

234 
	`ck_´_lßd_ušt
(&
¤c
->
m­
[
n
]));

238 
	}
}

245 
CK_CC_INLINE
 

246 
	$ck_b™m­_š‹r£ùiÚ
(
ck_b™m­
 *
d¡
, cÚ¡ ck_b™m­ *
¤c
)

248 
n
;

249 
n_buck‘s
 = 
d¡
->
n_b™s
;

250 
n_š‹r£ù
 = 
n_buck‘s
;

252 ià(
¤c
->
n_b™s
 < 
n_š‹r£ù
)

253 
n_š‹r£ù
 = 
¤c
->
n_b™s
;

255 
n_buck‘s
 = 
	`CK_BITMAP_BLOCKS
(n_buckets);

256 
n_š‹r£ù
 = 
	`CK_BITMAP_BLOCKS
(n_intersect);

257 
n
 = 0;‚ < 
n_š‹r£ù
;‚++) {

258 
	`ck_´_ªd_ušt
(&
d¡
->
m­
[
n
],

259 
	`ck_´_lßd_ušt
(&
¤c
->
m­
[
n
]));

262 ; 
n
 < 
n_buck‘s
;‚++)

263 
	`ck_´_¡Üe_ušt
(&
d¡
->
m­
[
n
], 0);

266 
	}
}

273 
CK_CC_INLINE
 

274 
	$ck_b™m­_š‹r£ùiÚ_Ãg©e
(
ck_b™m­
 *
d¡
,

275 cÚ¡ 
ck_b™m­
 *
¤c
)

277 
n
;

278 
n_š‹r£ù
 = 
d¡
->
n_b™s
;

280 ià(
¤c
->
n_b™s
 < 
n_š‹r£ù
)

281 
n_š‹r£ù
 = 
¤c
->
n_b™s
;

283 
n_š‹r£ù
 = 
	`CK_BITMAP_BLOCKS
(n_intersect);

284 
n
 = 0;‚ < 
n_š‹r£ù
;‚++) {

285 
	`ck_´_ªd_ušt
(&
d¡
->
m­
[
n
],

286 (~
	`ck_´_lßd_ušt
(&
¤c
->
m­
[
n
])));

290 
	}
}

296 
CK_CC_INLINE
 

297 
	$ck_b™m­_ş—r
(
ck_b™m­
 *
b™m­
)

299 
i
;

300 
n_buck‘s
 = 
	`ck_b™m­_ba£
(
b™m­
->
n_b™s
) /

303 
i
 = 0; i < 
n_buck‘s
; i++)

304 
	`ck_´_¡Üe_ušt
(&
b™m­
->
m­
[
i
], 0);

307 
	}
}

314 
CK_CC_INLINE
 
boŞ


315 
	$ck_b™m­_em±y
(cÚ¡ 
ck_b™m­_t
 *
b™m­
, 
lim™
)

317 
i
, 
wÜds
, 
¦İ
;

319 ià(
lim™
 > 
b™m­
->
n_b™s
)

320 
lim™
 = 
b™m­
->
n_b™s
;

322 
wÜds
 = 
lim™
 / 
CK_BITMAP_BLOCK
;

323 
¦İ
 = 
lim™
 % 
CK_BITMAP_BLOCK
;

324 
i
 = 0; i < 
wÜds
; i++) {

325 ià(
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
i
]) != 0) {

326  
çl£
;

330 ià(
¦İ
 > 0) {

331 
wÜd
;

333 
wÜd
 = 
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
i
]);

334 ià((
wÜd
 & ((1U << 
¦İ
) - 1)) != 0)

335  
çl£
;

338  
Œue
;

339 
	}
}

345 
CK_CC_UNUSED
 
boŞ


346 
	$ck_b™m­_fuÎ
(cÚ¡ 
ck_b™m­_t
 *
b™m­
, 
lim™
)

348 
i
, 
¦İ
, 
wÜds
;

350 ià(
lim™
 > 
b™m­
->
n_b™s
) {

351 
lim™
 = 
b™m­
->
n_b™s
;

354 
wÜds
 = 
lim™
 / 
CK_BITMAP_BLOCK
;

355 
¦İ
 = 
lim™
 % 
CK_BITMAP_BLOCK
;

356 
i
 = 0; i < 
wÜds
; i++) {

357 ià(
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
i
]) != -1U)

358  
çl£
;

361 ià(
¦İ
 > 0) {

362 
wÜd
;

364 
wÜd
 = ~
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
i
]);

365 ià((
wÜd
 & ((1U << 
¦İ
) - 1)) != 0)

366  
çl£
;

368  
Œue
;

369 
	}
}

376 
CK_CC_INLINE
 

377 
	$ck_b™m­_couÁ
(cÚ¡ 
ck_b™m­_t
 *
b™m­
, 
lim™
)

379 
couÁ
, 
i
, 
¦İ
, 
wÜds
;

381 ià(
lim™
 > 
b™m­
->
n_b™s
)

382 
lim™
 = 
b™m­
->
n_b™s
;

384 
wÜds
 = 
lim™
 / 
CK_BITMAP_BLOCK
;

385 
¦İ
 = 
lim™
 % 
CK_BITMAP_BLOCK
;

386 
i
 = 0, 
couÁ
 = 0; i < 
wÜds
; i++)

387 
couÁ
 +ğ
	`ck_cc_pİcouÁ
(
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
i
]));

389 ià(
¦İ
 > 0) {

390 
wÜd
;

392 
wÜd
 = 
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
i
]);

393 
couÁ
 +ğ
	`ck_cc_pİcouÁ
(
wÜd
 & ((1U << 
¦İ
) - 1));

395  
couÁ
;

396 
	}
}

403 
CK_CC_INLINE
 

404 
	$ck_b™m­_couÁ_š‹r£ù
(cÚ¡ 
ck_b™m­_t
 *
x
, cÚ¡ ck_b™m­_ˆ*
y
,

405 
lim™
)

407 
couÁ
, 
i
, 
¦İ
, 
wÜds
;

409 ià(
lim™
 > 
x
->
n_b™s
)

410 
lim™
 = 
x
->
n_b™s
;

412 ià(
lim™
 > 
y
->
n_b™s
)

413 
lim™
 = 
y
->
n_b™s
;

415 
wÜds
 = 
lim™
 / 
CK_BITMAP_BLOCK
;

416 
¦İ
 = 
lim™
 % 
CK_BITMAP_BLOCK
;

417 
i
 = 0, 
couÁ
 = 0; i < 
wÜds
; i++) {

418 
xi
, 
yi
;

420 
xi
 = 
	`ck_´_lßd_ušt
(&
x
->
m­
[
i
]);

421 
yi
 = 
	`ck_´_lßd_ušt
(&
y
->
m­
[
i
]);

422 
couÁ
 +ğ
	`ck_cc_pİcouÁ
(
xi
 & 
yi
);

425 ià(
¦İ
 > 0) {

426 
wÜd
, 
xi
, 
yi
;

428 
xi
 = 
	`ck_´_lßd_ušt
(&
x
->
m­
[
i
]);

429 
yi
 = 
	`ck_´_lßd_ušt
(&
y
->
m­
[
i
]);

430 
wÜd
 = 
xi
 & 
yi
;

431 
couÁ
 +ğ
	`ck_cc_pİcouÁ
(
wÜd
 & ((1U << 
¦İ
) - 1));

433  
couÁ
;

434 
	}
}

441 
CK_CC_INLINE
 

442 
	$ck_b™m­_š™
(
ck_b™m­
 *
b™m­
,

443 
n_b™s
,

444 
boŞ
 
£t
)

446 
ba£
 = 
	`ck_b™m­_ba£
(
n_b™s
);

448 
b™m­
->
n_b™s
 =‚_bits;

449 
	`mem£t
(
b™m­
->
m­
, -()
£t
, 
ba£
);

451 ià(
£t
 =ğ
Œue
) {

452 
b
 = 
n_b™s
 % 
CK_BITMAP_BLOCK
;

454 ià(
b
 == 0)

457 *
	`CK_BITMAP_PTR
(
b™m­
->
m­
, 
n_b™s
 - 1è&ğ(1U << 
b
) - 1U;

461 
	}
}

466 
CK_CC_INLINE
 

467 
	$ck_b™m­_™”©Ü_š™
(
ck_b™m­_™”©Ü
 *
i
,

468 cÚ¡ 
ck_b™m­
 *
b™m­
)

471 
i
->
n_block
 = 0;

472 
i
->
n_lim™
 = 
	`CK_BITMAP_BLOCKS
(
b™m­
->
n_b™s
);

473 ià(
i
->
n_lim™
 > 0) {

474 
i
->
ÿche
 = 
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[0]);

476 
i
->
ÿche
 = 0;

479 
	}
}

484 
CK_CC_INLINE
 
boŞ


485 
	$ck_b™m­_Ãxt
(cÚ¡ 
ck_b™m­
 *
b™m­
,

486 
ck_b™m­_™”©Ü
 *
i
,

487 *
b™
)

489 
ÿche
 = 
i
->cache;

490 
n_block
 = 
i
->n_block;

491 
n_lim™
 = 
i
->n_limit;

493 ià(
ÿche
 == 0) {

494 ià(
n_block
 >ğ
n_lim™
)

495  
çl£
;

497 
n_block
++;‚_block < 
n_lim™
;‚_block++) {

498 
ÿche
 = 
	`ck_´_lßd_ušt
(&
b™m­
->
m­
[
n_block
]);

499 ià(
ÿche
 != 0)

500 
nÚ_z”o
;

503 
i
->
ÿche
 = 0;

504 
i
->
n_block
 =‚_block;

505  
çl£
;

508 
nÚ_z”o
:

509 *
b™
 = 
CK_BITMAP_BLOCK
 * 
n_block
 + 
	`ck_cc_ùz
(
ÿche
);

510 
i
->
ÿche
 = cache & (cache - 1);

511 
i
->
n_block
 =‚_block;

512  
Œue
;

513 
	}
}

	@application/kvbench/include/aerospike/ck/ck_brlock.h

27 #iâdeà
CK_BRLOCK_H


28 
	#CK_BRLOCK_H


	)

43 
	~<«ro¥ike/ck/ck_´.h
>

44 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

45 
	~<«ro¥ike/ck/ck_¡ddef.h
>

47 
	sck_b¾ock_»ad”
 {

48 
	mn_»ad”s
;

49 
ck_b¾ock_»ad”
 *
	m´evious
;

50 
ck_b¾ock_»ad”
 *
	mÃxt
;

52 
ck_b¾ock_»ad”
 
	tck_b¾ock_»ad”_t
;

54 
	#CK_BRLOCK_READER_INITIALIZER
 {0}

	)

56 
	sck_b¾ock
 {

57 
ck_b¾ock_»ad”
 *
	m»ad”s
;

58 
	mwr™”
;

60 
ck_b¾ock
 
	tck_b¾ock_t
;

62 
	#CK_BRLOCK_INITIALIZER
 {
NULL
, 
çl£
}

	)

64 
CK_CC_INLINE
 

65 
	$ck_b¾ock_š™
(
ck_b¾ock
 *
br
)

68 
br
->
»ad”s
 = 
NULL
;

69 
br
->
wr™”
 = 
çl£
;

70 
	`ck_´_b¬r›r
();

72 
	}
}

74 
CK_CC_INLINE
 

75 
	$ck_b¾ock_wr™e_lock
(
ck_b¾ock
 *
br
)

77 
ck_b¾ock_»ad”
 *
cursÜ
;

83 
	`ck_´_çs_ušt
(&
br
->
wr™”
, 
Œue
) ==rue)

84 
	`ck_´_¡®l
();

86 
	`ck_´_ãnû_©omic_lßd
();

89 
cursÜ
 = 
br
->
»ad”s
; cursÜ !ğ
NULL
; cursÜ = cursÜ->
Ãxt
) {

90 
	`ck_´_lßd_ušt
(&
cursÜ
->
n_»ad”s
) != 0)

91 
	`ck_´_¡®l
();

94 
	`ck_´_ãnû_lock
();

96 
	}
}

98 
CK_CC_INLINE
 

99 
	$ck_b¾ock_wr™e_uÆock
(
ck_b¾ock
 *
br
)

102 
	`ck_´_ãnû_uÆock
();

103 
	`ck_´_¡Üe_ušt
(&
br
->
wr™”
, 
çl£
);

105 
	}
}

107 
CK_CC_INLINE
 
boŞ


108 
	$ck_b¾ock_wr™e_Œylock
(
ck_b¾ock
 *
br
, 
çùÜ
)

110 
ck_b¾ock_»ad”
 *
cursÜ
;

111 
¡•s
 = 0;

113 
	`ck_´_çs_ušt
(&
br
->
wr™”
, 
Œue
) ==rue) {

114 ià(++
¡•s
 >ğ
çùÜ
)

115  
çl£
;

117 
	`ck_´_¡®l
();

124 
	`ck_´_ãnû_©omic_lßd
();

126 
cursÜ
 = 
br
->
»ad”s
; cursÜ !ğ
NULL
; cursÜ = cursÜ->
Ãxt
) {

127 
	`ck_´_lßd_ušt
(&
cursÜ
->
n_»ad”s
) != 0) {

128 ià(++
¡•s
 >ğ
çùÜ
) {

129 
	`ck_b¾ock_wr™e_uÆock
(
br
);

130  
çl£
;

133 
	`ck_´_¡®l
();

137 
	`ck_´_ãnû_lock
();

138  
Œue
;

139 
	}
}

141 
CK_CC_INLINE
 

142 
	$ck_b¾ock_»ad_»gi¡”
(
ck_b¾ock
 *
br
, 
ck_b¾ock_»ad”
 *
»ad”
)

145 
»ad”
->
n_»ad”s
 = 0;

146 
»ad”
->
´evious
 = 
NULL
;

149 
	`ck_b¾ock_wr™e_lock
(
br
);

151 
»ad”
->
Ãxt
 = 
	`ck_´_lßd_±r
(&
br
->
»ad”s
);

152 ià(
»ad”
->
Ãxt
 !ğ
NULL
)

153 
»ad”
->
Ãxt
->
´evious
 =„eader;

154 
	`ck_´_¡Üe_±r
(&
br
->
»ad”s
, 
»ad”
);

156 
	`ck_b¾ock_wr™e_uÆock
(
br
);

158 
	}
}

160 
CK_CC_INLINE
 

161 
	$ck_b¾ock_»ad_uÄegi¡”
(
ck_b¾ock
 *
br
, 
ck_b¾ock_»ad”
 *
»ad”
)

164 
	`ck_b¾ock_wr™e_lock
(
br
);

166 ià(
»ad”
->
Ãxt
 !ğ
NULL
)

167 
»ad”
->
Ãxt
->
´evious
 =„eader->previous;

169 ià(
»ad”
->
´evious
 !ğ
NULL
)

170 
»ad”
->
´evious
->
Ãxt
 =„eader->next;

172 
br
->
»ad”s
 = 
»ad”
->
Ãxt
;

174 
	`ck_b¾ock_wr™e_uÆock
(
br
);

176 
	}
}

178 
CK_CC_INLINE
 

179 
	$ck_b¾ock_»ad_lock
(
ck_b¾ock
 *
br
, 
ck_b¾ock_»ad”
 *
»ad”
)

182 ià(
»ad”
->
n_»ad”s
 >= 1) {

183 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
,„eader->n_readers + 1);

188 
	`ck_´_lßd_ušt
(&
br
->
wr™”
è=ğ
Œue
)

189 
	`ck_´_¡®l
();

191 #ià
	`defšed
(
__x86__
è|| defšed(
__x86_64__
)

192 
	`ck_´_çs_ušt
(&
»ad”
->
n_»ad”s
, 1);

198 
	`ck_´_ãnû_©omic_lßd
();

200 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
, 1);

206 
	`ck_´_ãnû_¡Üe_lßd
();

209 ià(
	`ck_´_lßd_ušt
(&
br
->
wr™”
è=ğ
çl£
)

212 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
, 0);

215 
	`ck_´_ãnû_lock
();

217 
	}
}

219 
CK_CC_INLINE
 
boŞ


220 
	$ck_b¾ock_»ad_Œylock
(
ck_b¾ock
 *
br
,

221 
ck_b¾ock_»ad”
 *
»ad”
,

222 
çùÜ
)

224 
¡•s
 = 0;

226 ià(
»ad”
->
n_»ad”s
 >= 1) {

227 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
,„eader->n_readers + 1);

228  
Œue
;

232 
	`ck_´_lßd_ušt
(&
br
->
wr™”
è=ğ
Œue
) {

233 ià(++
¡•s
 >ğ
çùÜ
)

234  
çl£
;

236 
	`ck_´_¡®l
();

239 #ià
	`defšed
(
__x86__
è|| defšed(
__x86_64__
)

240 
	`ck_´_çs_ušt
(&
»ad”
->
n_»ad”s
, 1);

246 
	`ck_´_ãnû_©omic_lßd
();

248 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
, 1);

254 
	`ck_´_ãnû_¡Üe_lßd
();

257 ià(
	`ck_´_lßd_ušt
(&
br
->
wr™”
è=ğ
çl£
)

260 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
, 0);

262 ià(++
¡•s
 >ğ
çùÜ
)

263  
çl£
;

266 
	`ck_´_ãnû_lock
();

267  
Œue
;

268 
	}
}

270 
CK_CC_INLINE
 

271 
	$ck_b¾ock_»ad_uÆock
(
ck_b¾ock_»ad”
 *
»ad”
)

274 
	`ck_´_ãnû_uÆock
();

275 
	`ck_´_¡Üe_ušt
(&
»ad”
->
n_»ad”s
,„eader->n_readers - 1);

277 
	}
}

	@application/kvbench/include/aerospike/ck/ck_bytelock.h

27 #iâdeà
CK_BYTELOCK_H


28 
	#CK_BYTELOCK_H


	)

38 
	~<«ro¥ike/ck/ck_cc.h
>

39 
	~<«ro¥ike/ck/ck_md.h
>

40 
	~<«ro¥ike/ck/ck_´.h
>

41 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

42 
	~<«ro¥ike/ck/ck_¡ddef.h
>

43 
	~<«ro¥ike/ck/ck_lim™s.h
>

45 
	sck_by‹lock
 {

46 
	mowÃr
;

47 
	mn_»ad”s
;

48 
ušt8_t
 
	m»ad”s
[
CK_MD_CACHELINE
 - (è* 2] 
CK_CC_ALIGN
(8);

50 
ck_by‹lock
 
	tck_by‹lock_t
;

52 
	#CK_BYTELOCK_INITIALIZER
 { 0, 0, {0} }

	)

53 
	#CK_BYTELOCK_UNSLOTTED
 
UINT_MAX


	)

55 
CK_CC_INLINE
 

56 
	$ck_by‹lock_š™
(
ck_by‹lock
 *
by‹lock
)

58 
i
;

60 
by‹lock
->
owÃr
 = 0;

61 
by‹lock
->
n_»ad”s
 = 0;

62 
i
 = 0; i <  
by‹lock
->
»ad”s
; i++)

63 
by‹lock
->
»ad”s
[
i
] = 
çl£
;

65 
	`ck_´_b¬r›r
();

67 
	}
}

69 #ifdeà
CK_F_PR_LOAD_64


70 
	#CK_BYTELOCK_LENGTH
 (
ušt64_t
)

	)

71 
	#CK_BYTELOCK_LOAD
 
ck_´_lßd_64


	)

72 
	#CK_BYTELOCK_TYPE
 
ušt64_t


	)

73 #–ià
defšed
(
CK_F_PR_LOAD_32
)

74 
	#CK_BYTELOCK_LENGTH
 (
ušt32_t
)

	)

75 
	#CK_BYTELOCK_LOAD
 
ck_´_lßd_32


	)

76 
	#CK_BYTELOCK_TYPE
 
ušt32_t


	)

78 #”rÜ 
UnsuµÜ‹d
 
¶©fÜm
.

81 
CK_CC_INLINE
 

82 
	$ck_by‹lock_wr™e_lock
(
ck_by‹lock
 *
by‹lock
, 
¦Ù
)

84 
CK_BYTELOCK_TYPE
 *
»ad”s
 = (*)
by‹lock
->readers;

85 
i
;

88 
	`ck_´_ÿs_ušt
(&
by‹lock
->
owÃr
, 0, 
¦Ù
è=ğ
çl£
)

89 
	`ck_´_¡®l
();

92 ià(
¦Ù
 <ğ 
by‹lock
->
»ad”s
)

93 
	`ck_´_¡Üe_8
(&
by‹lock
->
»ad”s
[
¦Ù
 - 1], 
çl£
);

99 
	`ck_´_ãnû_©omic_lßd
();

101 
i
 = 0; i < (
by‹lock
->
»ad”s
è/ 
CK_BYTELOCK_LENGTH
; i++) {

102 
	`CK_BYTELOCK_LOAD
(&
»ad”s
[
i
]è!ğ
çl£
)

103 
	`ck_´_¡®l
();

107 
	`ck_´_lßd_ušt
(&
by‹lock
->
n_»ad”s
) != 0)

108 
	`ck_´_¡®l
();

110 
	`ck_´_ãnû_lock
();

112 
	}
}

114 #undeà
CK_BYTELOCK_LENGTH


115 #undeà
CK_BYTELOCK_LOAD


116 #undeà
CK_BYTELOCK_TYPE


118 
CK_CC_INLINE
 

119 
	$ck_by‹lock_wr™e_uÆock
(
ck_by‹lock
 *
by‹lock
)

122 
	`ck_´_ãnû_uÆock
();

123 
	`ck_´_¡Üe_ušt
(&
by‹lock
->
owÃr
, 0);

125 
	}
}

127 
CK_CC_INLINE
 

128 
	$ck_by‹lock_»ad_lock
(
ck_by‹lock
 *
by‹lock
, 
¦Ù
)

131 ià(
	`ck_´_lßd_ušt
(&
by‹lock
->
owÃr
è=ğ
¦Ù
) {

132 
	`ck_´_¡Üe_8
(&
by‹lock
->
»ad”s
[
¦Ù
 - 1], 
Œue
);

133 
	`ck_´_ãnû_¡riù_¡Üe
();

134 
	`ck_´_¡Üe_ušt
(&
by‹lock
->
owÃr
, 0);

139 ià(
¦Ù
 >  
by‹lock
->
»ad”s
) {

141 
	`ck_´_šc_ušt
(&
by‹lock
->
n_»ad”s
);

142 
	`ck_´_ãnû_©omic_lßd
();

143 ià(
	`ck_´_lßd_ušt
(&
by‹lock
->
owÃr
) == 0)

145 
	`ck_´_dec_ušt
(&
by‹lock
->
n_»ad”s
);

147 
	`ck_´_lßd_ušt
(&
by‹lock
->
owÃr
) != 0)

148 
	`ck_´_¡®l
();

151 
	`ck_´_ãnû_lock
();

155 
¦Ù
 -= 1;

157 #ifdeà
CK_F_PR_FAA_8


158 
	`ck_´_çs_8
(&
by‹lock
->
»ad”s
[
¦Ù
], 
Œue
);

159 
	`ck_´_ãnû_©omic_lßd
();

161 
	`ck_´_¡Üe_8
(&
by‹lock
->
»ad”s
[
¦Ù
], 
Œue
);

162 
	`ck_´_ãnû_¡Üe_lßd
();

170 ià(
	`ck_´_lßd_ušt
(&
by‹lock
->
owÃr
) == 0)

173 
	`ck_´_¡Üe_8
(&
by‹lock
->
»ad”s
[
¦Ù
], 
çl£
);

174 
	`ck_´_lßd_ušt
(&
by‹lock
->
owÃr
) != 0)

175 
	`ck_´_¡®l
();

178 
	`ck_´_ãnû_lock
();

180 
	}
}

182 
CK_CC_INLINE
 

183 
	$ck_by‹lock_»ad_uÆock
(
ck_by‹lock
 *
by‹lock
, 
¦Ù
)

186 
	`ck_´_ãnû_uÆock
();

188 ià(
¦Ù
 >  
by‹lock
->
»ad”s
)

189 
	`ck_´_dec_ušt
(&
by‹lock
->
n_»ad”s
);

191 
	`ck_´_¡Üe_8
(&
by‹lock
->
»ad”s
[
¦Ù
 - 1], 
çl£
);

194 
	}
}

	@application/kvbench/include/aerospike/ck/ck_cc.h

28 #iâdeà
CK_CC_H


29 
	#CK_CC_H


	)

31 #ià
defšed
(
__GNUC__
è|| defšed(
__SUNPRO_C
)

32 
	~"«ro¥ike/ck/gcc/ck_cc.h
"

35 #iâdeà
CK_CC_RESTRICT


36 
	#CK_CC_RESTRICT


	)

39 #iâdeà
CK_CC_INLINE


40 
	#CK_CC_INLINE
 
šlše


	)

43 #iâdeà
CK_CC_FORCE_INLINE


44 
	#CK_CC_FORCE_INLINE
 
šlše


	)

47 
	#CK_CC_DECONST_PTR
(
X
è((*)(
ušŒ_t
)(X))

	)

53 
	#CK_CC_CONTAINER
(
F
, 
T
, 
M
, 
N
) \

54 
CK_CC_INLINE
 
T
 * \

55 
	`N
(
F
 *
p
) \

57 
F
 *
n
 = 
p
; \

58  (
T
 *)(*)(((*)
n
è- ((
size_t
)&((T *)0)->
M
)); \

59 }

	)

61 
	#CK_CC_PAD
(
x
èuniÚ { 
·d
[x]; }

	)

63 #iâdeà
CK_CC_ALIASED


64 
	#CK_CC_ALIASED


	)

67 #iâdeà
CK_CC_UNUSED


68 
	#CK_CC_UNUSED


	)

71 #iâdeà
CK_CC_USED


72 
	#CK_CC_USED


	)

75 #iâdeà
CK_CC_IMM


76 
	#CK_CC_IMM


	)

79 #iâdeà
CK_CC_PACKED


80 
	#CK_CC_PACKED


	)

83 #iâdeà
CK_CC_WEAKREF


84 
	#CK_CC_WEAKREF


	)

87 #iâdeà
CK_CC_ALIGN


88 
	#CK_CC_ALIGN
(
X
)

	)

91 #iâdeà
CK_CC_CACHELINE


92 
	#CK_CC_CACHELINE


	)

95 #iâdeà
CK_CC_LIKELY


96 
	#CK_CC_LIKELY
(
x
è
	)
x

99 #iâdeà
CK_CC_UNLIKELY


100 
	#CK_CC_UNLIKELY
(
x
è
	)
x

103 #iâdeà
CK_CC_TYPEOF


104 
	#CK_CC_TYPEOF
(
X
, 
DEFAULT
è(DEFAULT)

	)

107 #iâdeà
CK_F_CC_FFS


108 
	#CK_F_CC_FFS


	)

109 
CK_CC_INLINE
 

110 
	$ck_cc_ffs
(
x
)

112 
i
;

114 ià(
x
 == 0)

117 
i
 = 1; (
x
 & 1) == 0; i++, x >>= 1);

119  
i
;

120 
	}
}

123 #iâdeà
CK_F_CC_CLZ


124 
	#CK_F_CC_CLZ


	)

125 
	~<«ro¥ike/ck/ck_lim™s.h
>

127 
CK_CC_INLINE
 

128 
	$ck_cc_şz
(
x
)

130 
couÁ
, 
i
;

132 
couÁ
 = 0, 
i
 = (è* 
CHAR_BIT
; i > 0; count++) {

133 
b™
 = 1U << --
i
;

135 ià(
x
 & 
b™
)

139  
couÁ
;

140 
	}
}

143 #iâdeà
CK_F_CC_CTZ


144 
	#CK_F_CC_CTZ


	)

145 
CK_CC_INLINE
 

146 
	$ck_cc_ùz
(
x
)

148 
i
;

150 ià(
x
 == 0)

153 
i
 = 0; (
x
 & 1) == 0; i++, x >>= 1);

155  
i
;

156 
	}
}

159 #iâdeà
CK_F_CC_POPCOUNT


160 
	#CK_F_CC_POPCOUNT


	)

161 
CK_CC_INLINE
 

162 
	$ck_cc_pİcouÁ
(
x
)

164 
acc
;

166 
acc
 = 0; 
x
 != 0; x >>= 1)

167 
acc
 +ğ
x
 & 1;

169  
acc
;

170 
	}
}

174 #ifdeà
__ılu¥lus


175 
	#CK_CPP_CAST
(
ty³
, 
¬g
è
¡©ic_ÿ¡
<ty³>×rg)

	)

177 
	#CK_CPP_CAST
(
ty³
, 
¬g
è
	)
arg

	@application/kvbench/include/aerospike/ck/ck_cohort.h

28 #iâdeà
CK_COHORT_H


29 
	#CK_COHORT_H


	)

37 
	~<«ro¥ike/ck/ck_cc.h
>

38 
	~<«ro¥ike/ck/ck_´.h
>

39 
	~<«ro¥ike/ck/ck_¡ddef.h
>

41 
	eck_cohÜt_¡©e
 {

42 
	mCK_COHORT_STATE_GLOBAL
 = 0,

43 
	mCK_COHORT_STATE_LOCAL
 = 1

46 
	#CK_COHORT_DEFAULT_LOCAL_PASS_LIMIT
 10

	)

48 
	#CK_COHORT_NAME
(
N
è
ck_cohÜt_
##
	)
N

49 
	#CK_COHORT_INSTANCE
(
N
è
	`CK_COHORT_NAME
(N)

	)

50 
	#CK_COHORT_INIT
(
N
, 
C
, 
GL
, 
LL
, 
P
è
ck_cohÜt_
##N##
	`_š™
(C, GL, LL, P)

	)

51 
	#CK_COHORT_LOCK
(
N
, 
C
, 
GC
, 
LC
è
ck_cohÜt_
##N##
	`_lock
(C, GC, LC)

	)

52 
	#CK_COHORT_UNLOCK
(
N
, 
C
, 
GC
, 
LC
è
ck_cohÜt_
##N##
	`_uÆock
(C, GC, LC)

	)

53 
	#CK_COHORT_TRYLOCK
(
N
, 
C
, 
GLC
, 
LLC
, 
LUC
è
ck_cohÜt_
##N##
	`_Œylock
(C, GLC, LLC, LUC)

	)

54 
	#CK_COHORT_LOCKED
(
N
, 
C
, 
GC
, 
LC
è
ck_cohÜt_
##N##
	`_locked
(C, GC, LC)

	)

56 
	#CK_COHORT_PROTOTYPE
(
N
, 
GL
, 
GU
, 
GI
, 
LL
, 
LU
, 
LI
) \

57 
	`CK_COHORT_INSTANCE
(
N
) { \

58 *
glob®_lock
; \

59 *
loÿl_lock
; \

60 
ck_cohÜt_¡©e
 
»Ëa£_¡©e
; \

61 
wa™šg_th»ads
; \

62 
acquœe_couÁ
; \

63 
loÿl_·ss_lim™
; \

66 
CK_CC_INLINE
 \

67 
ck_cohÜt_
##
N
##
	`_š™
(ck_cohÜt_##N *
cohÜt
, \

68 *
glob®_lock
, *
loÿl_lock
, 
·ss_lim™
) \

70 
cohÜt
->
glob®_lock
 = global_lock; \

71 
cohÜt
->
loÿl_lock
 =†ocal_lock; \

72 
cohÜt
->
»Ëa£_¡©e
 = 
CK_COHORT_STATE_GLOBAL
; \

73 
cohÜt
->
wa™šg_th»ads
 = 0; \

74 
cohÜt
->
acquœe_couÁ
 = 0; \

75 
cohÜt
->
loÿl_·ss_lim™
 = 
·ss_lim™
; \

76 
	`ck_´_b¬r›r
(); \

80 
CK_CC_INLINE
 \

81 
ck_cohÜt_
##
N
##
	`_lock
(
	`CK_COHORT_INSTANCE
(Nè*
cohÜt
, \

82 *
glob®_cÚ‹xt
, *
loÿl_cÚ‹xt
) \

85 
	`ck_´_šc_ušt
(&
cohÜt
->
wa™šg_th»ads
); \

86 
	`LL
(
cohÜt
->
loÿl_lock
, 
loÿl_cÚ‹xt
); \

87 
	`ck_´_dec_ušt
(&
cohÜt
->
wa™šg_th»ads
); \

89 ià(
cohÜt
->
»Ëa£_¡©e
 =ğ
CK_COHORT_STATE_GLOBAL
) { \

90 
	`GL
(
cohÜt
->
glob®_lock
, 
glob®_cÚ‹xt
); \

93 ++
cohÜt
->
acquœe_couÁ
; \

97 
CK_CC_INLINE
 \

98 
ck_cohÜt_
##
N
##
	`_uÆock
(
	`CK_COHORT_INSTANCE
(Nè*
cohÜt
, \

99 *
glob®_cÚ‹xt
, *
loÿl_cÚ‹xt
) \

102 ià(
	`ck_´_lßd_ušt
(&
cohÜt
->
wa™šg_th»ads
) > 0 \

103 && 
cohÜt
->
acquœe_couÁ
 < cohÜt->
loÿl_·ss_lim™
) { \

104 
cohÜt
->
»Ëa£_¡©e
 = 
CK_COHORT_STATE_LOCAL
; \

106 
	`GU
(
cohÜt
->
glob®_lock
, 
glob®_cÚ‹xt
); \

107 
cohÜt
->
»Ëa£_¡©e
 = 
CK_COHORT_STATE_GLOBAL
; \

108 
cohÜt
->
acquœe_couÁ
 = 0; \

111 
	`ck_´_ãnû_»Ëa£
(); \

112 
	`LU
(
cohÜt
->
loÿl_lock
, 
loÿl_cÚ‹xt
); \

117 
CK_CC_INLINE
 
boŞ
 \

118 
ck_cohÜt_
##
N
##
	`_locked
(
	`CK_COHORT_INSTANCE
(Nè*
cohÜt
, \

119 *
glob®_cÚ‹xt
, *
loÿl_cÚ‹xt
) \

121  
	`GI
(
cohÜt
->
loÿl_lock
, 
loÿl_cÚ‹xt
) || \

122 
	`LI
(
cohÜt
->
glob®_lock
, 
glob®_cÚ‹xt
); \

123 }

	)

125 
	#CK_COHORT_TRYLOCK_PROTOTYPE
(
N
, 
GL
, 
GU
, 
GI
, 
GTL
, 
LL
, 
LU
, 
LI
, 
LTL
) \

126 
	`CK_COHORT_PROTOTYPE
(
N
, 
GL
, 
GU
, 
GI
, 
LL
, 
LU
, 
LI
) \

127 
CK_CC_INLINE
 
boŞ
 \

128 
ck_cohÜt_
##
N
##
	`_Œylock
(
	`CK_COHORT_INSTANCE
(Nè*
cohÜt
, \

129 *
glob®_cÚ‹xt
, *
loÿl_cÚ‹xt
, \

130 *
loÿl_uÆock_cÚ‹xt
) \

133 
boŞ
 
Œylock_»suÉ
; \

135 
	`ck_´_šc_ušt
(&
cohÜt
->
wa™šg_th»ads
); \

136 
Œylock_»suÉ
 = 
	`LTL
(
cohÜt
->
loÿl_lock
, 
loÿl_cÚ‹xt
); \

137 
	`ck_´_dec_ušt
(&
cohÜt
->
wa™šg_th»ads
); \

138 ià(
Œylock_»suÉ
 =ğ
çl£
) { \

139  
çl£
; \

142 ià(
cohÜt
->
»Ëa£_¡©e
 =ğ
CK_COHORT_STATE_GLOBAL
 && \

143 
	`GTL
(
cohÜt
->
glob®_lock
, 
glob®_cÚ‹xt
è=ğ
çl£
) { \

144 
	`LU
(
cohÜt
->
loÿl_lock
, 
loÿl_uÆock_cÚ‹xt
); \

145  
çl£
; \

148 ++
cohÜt
->
acquœe_couÁ
; \

149  
Œue
; \

150 }

	)

152 
	#CK_COHORT_INITIALIZER
 { \

153 .
glob®_lock
 = 
NULL
, \

154 .
loÿl_lock
 = 
NULL
, \

155 .
»Ëa£_¡©e
 = 
CK_COHORT_STATE_GLOBAL
, \

156 .
wa™šg_th»ads
 = 0, \

157 .
acquœe_couÁ
 = 0, \

158 .
loÿl_·ss_lim™
 = 
CK_COHORT_DEFAULT_LOCAL_PASS_LIMIT
 \

159 }

	)

	@application/kvbench/include/aerospike/ck/ck_elide.h

27 #iâdeà
CK_ELIDE_H


28 
	#CK_ELIDE_H


	)

36 
	~<«ro¥ike/ck/ck_cc.h
>

37 
	~<«ro¥ike/ck/ck_´.h
>

38 
	~<«ro¥ike/ck/ck_¡ršg.h
>

49 
	sck_–ide_cÚfig
 {

50 
	msk_busy
;

51 
	m»Œy_busy
;

52 
	msk_Ùh”
;

53 
	m»Œy_Ùh”
;

54 
	msk_cÚæiù
;

55 
	m»Œy_cÚæiù
;

58 
	#CK_ELIDE_CONFIG_DEFAULT_INITIALIZER
 { \

59 .
sk_busy
 = 5, \

60 .
»Œy_busy
 = 256, \

61 .
sk_Ùh”
 = 3, \

62 .
»Œy_Ùh”
 = 3, \

63 .
sk_cÚæiù
 = 2, \

64 .
»Œy_cÚæiù
 = 5 \

65 }

	)

67 
	sck_–ide_¡©
 {

68 
	mn_çÎback
;

69 
	mn_–ide
;

70 
	msk
;

72 
ck_–ide_¡©
 
	tck_–ide_¡©_t
;

74 
	#CK_ELIDE_STAT_INITIALIZER
 { 0, 0, 0 }

	)

76 
CK_CC_INLINE
 

77 
	$ck_–ide_¡©_š™
(
ck_–ide_¡©_t
 *
¡
)

80 
	`mem£t
(
¡
, 0, (*st));

82 
	}
}

84 #ifdeà
CK_F_PR_RTM


85 
	e_ck_–ide_hšt
 {

86 
	mCK_ELIDE_HINT_RETRY
 = 0,

87 
	mCK_ELIDE_HINT_SPIN
,

88 
	mCK_ELIDE_HINT_STOP


91 
	#CK_ELIDE_LOCK_BUSY
 0xFF

	)

93 
_ck_–ide_hšt


94 
	$_ck_–ide_çÎback
(*
»Œy
,

95 
ck_–ide_¡©
 *
¡
,

96 
ck_–ide_cÚfig
 *
c
,

97 
¡©us
)

100 
¡
->
n_çÎback
++;

101 ià(*
»Œy
 > 0)

102  
CK_ELIDE_HINT_RETRY
;

104 ià(
¡
->
sk
 != 0)

105  
CK_ELIDE_HINT_STOP
;

107 ià(
¡©us
 & 
CK_PR_RTM_EXPLICIT
) {

108 ià(
	`CK_PR_RTM_CODE
(
¡©us
è=ğ
CK_ELIDE_LOCK_BUSY
) {

109 
¡
->
sk
 = 
c
->
sk_busy
;

110 *
»Œy
 = 
c
->
»Œy_busy
;

111  
CK_ELIDE_HINT_SPIN
;

114 
¡
->
sk
 = 
c
->
sk_Ùh”
;

115  
CK_ELIDE_HINT_STOP
;

118 ià((
¡©us
 & 
CK_PR_RTM_RETRY
) &&

119 (
¡©us
 & 
CK_PR_RTM_CONFLICT
)) {

120 
¡
->
sk
 = 
c
->
sk_cÚæiù
;

121 *
»Œy
 = 
c
->
»Œy_cÚæiù
;

122  
CK_ELIDE_HINT_RETRY
;

130 
¡
->
sk
 = 
USHRT_MAX
;

131  
CK_ELIDE_HINT_STOP
;

132 
	}
}

143 
	#CK_ELIDE_PROTOTYPE
(
N
, 
T
, 
L_P
, 
L
, 
U_P
, 
U
) \

144 
CK_CC_INLINE
 \

145 
ck_–ide_
##
N
##
	`_lock_ad­tive
(
T
 *
lock
, \

146 
ck_–ide_¡©
 *
¡
, \

147 
ck_–ide_cÚfig
 *
c
) \

149 
_ck_–ide_hšt
 
hšt
; \

150 
»Œy
; \

152 ià(
	`CK_CC_UNLIKELY
(
¡
->
sk
 != 0)) { \

153 
¡
->
sk
--; \

154 
acquœe
; \

157 
»Œy
 = 
c
->
»Œy_cÚæiù
; \

159 
¡©us
 = 
	`ck_´_¹m_begš
(); \

160 ià(
¡©us
 =ğ
CK_PR_RTM_STARTED
) { \

161 ià(
	`L_P
(
lock
è=ğ
Œue
) \

162 
	`ck_´_¹m_abÜt
(
CK_ELIDE_LOCK_BUSY
); \

167 
hšt
 = 
	`_ck_–ide_çÎback
(&
»Œy
, 
¡
, 
c
, 
¡©us
); \

168 ià(
hšt
 =ğ
CK_ELIDE_HINT_RETRY
) \

171 ià(
hšt
 =ğ
CK_ELIDE_HINT_SPIN
) { \

172 --
»Œy
 != 0) { \

173 ià(
	`L_P
(
lock
è=ğ
çl£
) \

176 
	`ck_´_¡®l
(); \

182 ià(
hšt
 =ğ
CK_ELIDE_HINT_STOP
) \

184 } 
	`CK_CC_LIKELY
(--
»Œy
 > 0)); \

186 
acquœe
: \

187 
	`L
(
lock
); \

190 
CK_CC_INLINE
 \

191 
ck_–ide_
##
N
##
	`_uÆock_ad­tive
(
ck_–ide_¡©
 *
¡
, 
T
 *
lock
) \

194 ià(
	`U_P
(
lock
è=ğ
çl£
) { \

195 
	`ck_´_¹m_’d
(); \

196 
¡
->
sk
 = 0; \

197 
¡
->
n_–ide
++; \

199 
	`U
(
lock
); \

204 
CK_CC_INLINE
 \

205 
ck_–ide_
##
N
##
	`_lock
(
T
 *
lock
) \

208 ià(
	`ck_´_¹m_begš
(è!ğ
CK_PR_RTM_STARTED
) { \

209 
	`L
(
lock
); \

213 ià(
	`L_P
(
lock
è=ğ
Œue
) \

214 
	`ck_´_¹m_abÜt
(
CK_ELIDE_LOCK_BUSY
); \

218 
CK_CC_INLINE
 \

219 
ck_–ide_
##
N
##
	`_uÆock
(
T
 *
lock
) \

222 ià(
	`U_P
(
lock
è=ğ
çl£
) { \

223 
	`ck_´_¹m_’d
(); \

225 
	`U
(
lock
); \

229 }

	)

231 
	#CK_ELIDE_TRYLOCK_PROTOTYPE
(
N
, 
T
, 
TL_P
, 
TL
) \

232 
CK_CC_INLINE
 
boŞ
 \

233 
ck_–ide_
##
N
##
	`_Œylock
(
T
 *
lock
) \

236 ià(
	`ck_´_¹m_begš
(è!ğ
CK_PR_RTM_STARTED
) \

237  
çl£
; \

239 ià(
	`TL_P
(
lock
è=ğ
Œue
) \

240 
	`ck_´_¹m_abÜt
(
CK_ELIDE_LOCK_BUSY
); \

242  
Œue
; \

243 }

	)

252 
	#CK_ELIDE_PROTOTYPE
(
N
, 
T
, 
L_P
, 
L
, 
U_P
, 
U
) \

253 
CK_CC_INLINE
 \

254 
ck_–ide_
##
N
##
	`_lock_ad­tive
(
T
 *
lock
, \

255 
ck_–ide_¡©
 *
¡
, \

256 
ck_–ide_cÚfig
 *
c
) \

259 ()
¡
; \

260 ()
c
; \

261 
	`L
(
lock
); \

264 
CK_CC_INLINE
 \

265 
ck_–ide_
##
N
##
	`_uÆock_ad­tive
(
ck_–ide_¡©
 *
¡
, \

266 
T
 *
lock
) \

269 ()
¡
; \

270 
	`U
(
lock
); \

273 
CK_CC_INLINE
 \

274 
ck_–ide_
##
N
##
	`_lock
(
T
 *
lock
) \

277 
	`L
(
lock
); \

280 
CK_CC_INLINE
 \

281 
ck_–ide_
##
N
##
	`_uÆock
(
T
 *
lock
) \

284 
	`U
(
lock
); \

286 }

	)

288 
	#CK_ELIDE_TRYLOCK_PROTOTYPE
(
N
, 
T
, 
TL_P
, 
TL
) \

289 
CK_CC_INLINE
 
boŞ
 \

290 
ck_–ide_
##
N
##
	`_Œylock
(
T
 *
lock
) \

293  
	`TL_P
(
lock
); \

294 }

	)

306 
	#CK_ELIDE_LOCK
(
NAME
, 
LOCK
è
ck_–ide_
##NAME##
	`_lock
(LOCK)

	)

307 
	#CK_ELIDE_UNLOCK
(
NAME
, 
LOCK
è
ck_–ide_
##NAME##
	`_uÆock
(LOCK)

	)

308 
	#CK_ELIDE_TRYLOCK
(
NAME
, 
LOCK
è
ck_–ide_
##NAME##
	`_Œylock
(LOCK)

	)

315 
	#CK_ELIDE_LOCK_ADAPTIVE
(
NAME
, 
STAT
, 
CONFIG
, 
LOCK
) \

316 
ck_–ide_
##
NAME
##
	`_lock_ad­tive
(
LOCK
, 
STAT
, 
CONFIG
)

	)

318 
	#CK_ELIDE_UNLOCK_ADAPTIVE
(
NAME
, 
STAT
, 
LOCK
) \

319 
ck_–ide_
##
NAME
##
	`_uÆock_ad­tive
(
STAT
, 
LOCK
)

	)

	@application/kvbench/include/aerospike/ck/ck_fifo.h

28 #iâdeà
CK_FIFO_H


29 
	#CK_FIFO_H


	)

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_md.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¥šlock.h
>

35 
	~<«ro¥ike/ck/ck_¡ddef.h
>

37 #iâdeà
CK_F_FIFO_SPSC


38 
	#CK_F_FIFO_SPSC


	)

39 
	sck_fifo_¥sc_’Œy
 {

40 *
	mv®ue
;

41 
ck_fifo_¥sc_’Œy
 *
	mÃxt
;

43 
ck_fifo_¥sc_’Œy
 
	tck_fifo_¥sc_’Œy_t
;

45 
	sck_fifo_¥sc
 {

46 
ck_¥šlock_t
 
	mm_h—d
;

47 
ck_fifo_¥sc_’Œy
 *
	mh—d
;

48 
	m·d
[
CK_MD_CACHELINE
 - (
ck_fifo_¥sc_’Œy
 *è- (
ck_¥šlock_t
)];

49 
ck_¥šlock_t
 
	mm_
;

50 
ck_fifo_¥sc_’Œy
 *
	m
;

51 
ck_fifo_¥sc_’Œy
 *
	mh—d_¢­shÙ
;

52 
ck_fifo_¥sc_’Œy
 *
	mg¬bage
;

54 
ck_fifo_¥sc
 
	tck_fifo_¥sc_t
;

56 
CK_CC_INLINE
 
boŞ


57 
	$ck_fifo_¥sc_’queue_Œylock
(
ck_fifo_¥sc
 *
fifo
)

60  
	`ck_¥šlock_Œylock
(&
fifo
->
m_
);

61 
	}
}

63 
CK_CC_INLINE
 

64 
	$ck_fifo_¥sc_’queue_lock
(
ck_fifo_¥sc
 *
fifo
)

67 
	`ck_¥šlock_lock
(&
fifo
->
m_
);

69 
	}
}

71 
CK_CC_INLINE
 

72 
	$ck_fifo_¥sc_’queue_uÆock
(
ck_fifo_¥sc
 *
fifo
)

75 
	`ck_¥šlock_uÆock
(&
fifo
->
m_
);

77 
	}
}

79 
CK_CC_INLINE
 
boŞ


80 
	$ck_fifo_¥sc_dequeue_Œylock
(
ck_fifo_¥sc
 *
fifo
)

83  
	`ck_¥šlock_Œylock
(&
fifo
->
m_h—d
);

84 
	}
}

86 
CK_CC_INLINE
 

87 
	$ck_fifo_¥sc_dequeue_lock
(
ck_fifo_¥sc
 *
fifo
)

90 
	`ck_¥šlock_lock
(&
fifo
->
m_h—d
);

92 
	}
}

94 
CK_CC_INLINE
 

95 
	$ck_fifo_¥sc_dequeue_uÆock
(
ck_fifo_¥sc
 *
fifo
)

98 
	`ck_¥šlock_uÆock
(&
fifo
->
m_h—d
);

100 
	}
}

102 
CK_CC_INLINE
 

103 
	$ck_fifo_¥sc_š™
(
ck_fifo_¥sc
 *
fifo
, 
ck_fifo_¥sc_’Œy
 *
¡ub
)

106 
	`ck_¥šlock_š™
(&
fifo
->
m_h—d
);

107 
	`ck_¥šlock_š™
(&
fifo
->
m_
);

109 
¡ub
->
Ãxt
 = 
NULL
;

110 
fifo
->
h—d
 = fifo->

 = fifo->
h—d_¢­shÙ
 = fifo->
g¬bage
 = 
¡ub
;

112 
	}
}

114 
CK_CC_INLINE
 

115 
	$ck_fifo_¥sc_deš™
(
ck_fifo_¥sc
 *
fifo
, 
ck_fifo_¥sc_’Œy
 **
g¬bage
)

118 *
g¬bage
 = 
fifo
->
h—d
;

119 
fifo
->
h—d
 = fifo->

 = 
NULL
;

121 
	}
}

123 
CK_CC_INLINE
 

124 
	$ck_fifo_¥sc_’queue
(
ck_fifo_¥sc
 *
fifo
,

125 
ck_fifo_¥sc_’Œy
 *
’Œy
,

126 *
v®ue
)

129 
’Œy
->
v®ue
 = value;

130 
’Œy
->
Ãxt
 = 
NULL
;

133 
	`ck_´_ãnû_¡Üe
();

134 
	`ck_´_¡Üe_±r
(&
fifo
->

->
Ãxt
, 
’Œy
);

135 
fifo
->

 = 
’Œy
;

137 
	}
}

139 
CK_CC_INLINE
 
boŞ


140 
	$ck_fifo_¥sc_dequeue
(
ck_fifo_¥sc
 *
fifo
, *
v®ue
)

142 
ck_fifo_¥sc_’Œy
 *
’Œy
;

149 
’Œy
 = 
	`ck_´_lßd_±r
(&
fifo
->
h—d
->
Ãxt
);

150 ià(
’Œy
 =ğ
NULL
)

151  
çl£
;

154 
	`ck_´_¡Üe_±r_un§ã
(
v®ue
, 
’Œy
->value);

155 
	`ck_´_ãnû_¡Üe
();

156 
	`ck_´_¡Üe_±r
(&
fifo
->
h—d
, 
’Œy
);

157  
Œue
;

158 
	}
}

164 
CK_CC_INLINE
 
ck_fifo_¥sc_’Œy
 *

165 
	$ck_fifo_¥sc_»cyşe
(
ck_fifo_¥sc
 *
fifo
)

167 
ck_fifo_¥sc_’Œy
 *
g¬bage
;

169 ià(
fifo
->
h—d_¢­shÙ
 =ğfifo->
g¬bage
) {

170 
fifo
->
h—d_¢­shÙ
 = 
	`ck_´_lßd_±r
(&fifo->
h—d
);

171 ià(
fifo
->
h—d_¢­shÙ
 =ğfifo->
g¬bage
)

172  
NULL
;

175 
g¬bage
 = 
fifo
->garbage;

176 
fifo
->
g¬bage
 = g¬bage->
Ãxt
;

177  
g¬bage
;

178 
	}
}

180 
CK_CC_INLINE
 
boŞ


181 
	$ck_fifo_¥sc_i£m±y
(
ck_fifo_¥sc
 *
fifo
)

183 
ck_fifo_¥sc_’Œy
 *
h—d
 = 
	`ck_´_lßd_±r
(&
fifo
->head);

184  
	`ck_´_lßd_±r
(&
h—d
->
Ãxt
è=ğ
NULL
;

185 
	}
}

187 
	#CK_FIFO_SPSC_ISEMPTY
(
f
è((f)->
h—d
->
Ãxt
 =ğ
NULL
)

	)

188 
	#CK_FIFO_SPSC_FIRST
(
f
è((f)->
h—d
->
Ãxt
)

	)

189 
	#CK_FIFO_SPSC_NEXT
(
m
è((m)->
Ãxt
)

	)

190 
	#CK_FIFO_SPSC_SPARE
(
f
è((f)->
h—d
)

	)

191 
	#CK_FIFO_SPSC_FOREACH
(
fifo
, 
’Œy
) \

192 (
’Œy
èğ
	`CK_FIFO_SPSC_FIRST
(
fifo
); \

193 (
’Œy
è!ğ
NULL
; \

194 (
’Œy
èğ
	`CK_FIFO_SPSC_NEXT
ÓÁry))

	)

195 
	#CK_FIFO_SPSC_FOREACH_SAFE
(
fifo
, 
’Œy
, 
T
) \

196 (
’Œy
èğ
	`CK_FIFO_SPSC_FIRST
(
fifo
); \

197 (
’Œy
è!ğ
NULL
 && ((
T
èğÓÁry)->
Ãxt
, 1); \

198 (
’Œy
èğ(
T
))

	)

202 #ifdeà
CK_F_PR_CAS_PTR_2


203 #iâdeà
CK_F_FIFO_MPMC


204 
	#CK_F_FIFO_MPMC


	)

205 
	gck_fifo_mpmc_’Œy
;

206 
	sck_fifo_mpmc_poš‹r
 {

207 
ck_fifo_mpmc_’Œy
 *
	mpoš‹r
;

208 *
g’”©iÚ
 
	mCK_CC_PACKED
;

209 } 
CK_CC_ALIGN
(16);

211 
	sck_fifo_mpmc_’Œy
 {

212 *
	mv®ue
;

213 
ck_fifo_mpmc_poš‹r
 
	mÃxt
;

215 
ck_fifo_mpmc_’Œy
 
	tck_fifo_mpmc_’Œy_t
;

217 
	sck_fifo_mpmc
 {

218 
ck_fifo_mpmc_poš‹r
 
	mh—d
;

219 
	m·d
[
CK_MD_CACHELINE
 - (
ck_fifo_mpmc_poš‹r
)];

220 
ck_fifo_mpmc_poš‹r
 
	m
;

222 
ck_fifo_mpmc
 
	tck_fifo_mpmc_t
;

224 
CK_CC_INLINE
 

225 
	$ck_fifo_mpmc_š™
(
ck_fifo_mpmc
 *
fifo
, 
ck_fifo_mpmc_’Œy
 *
¡ub
)

228 
¡ub
->
Ãxt
.
poš‹r
 = 
NULL
;

229 
¡ub
->
Ãxt
.
g’”©iÚ
 = 
NULL
;

230 
fifo
->
h—d
.
poš‹r
 = fifo->

.poš‹¸ğ
¡ub
;

231 
fifo
->
h—d
.
g’”©iÚ
 = fifo->

.g’”©iÚ = 
NULL
;

233 
	}
}

235 
CK_CC_INLINE
 

236 
	$ck_fifo_mpmc_deš™
(
ck_fifo_mpmc
 *
fifo
, 
ck_fifo_mpmc_’Œy
 **
g¬bage
)

239 *
g¬bage
 = 
fifo
->
h—d
.
poš‹r
;

240 
fifo
->
h—d
.
poš‹r
 = fifo->

.poš‹¸ğ
NULL
;

242 
	}
}

244 
CK_CC_INLINE
 

245 
	$ck_fifo_mpmc_’queue
(
ck_fifo_mpmc
 *
fifo
,

246 
ck_fifo_mpmc_’Œy
 *
’Œy
,

247 *
v®ue
)

249 
ck_fifo_mpmc_poš‹r
 

, 
Ãxt
, 
upd©e
;

255 
’Œy
->
v®ue
 = value;

256 
’Œy
->
Ãxt
.
poš‹r
 = 
NULL
;

257 
’Œy
->
Ãxt
.
g’”©iÚ
 = 0;

258 
	`ck_´_ãnû_¡Üe_©omic
();

261 

.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.generation);

262 
	`ck_´_ãnû_lßd
();

263 

.
poš‹r
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.pointer);

264 
Ãxt
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&

.
poš‹r
->next.generation);

265 
	`ck_´_ãnû_lßd
();

266 
Ãxt
.
poš‹r
 = 
	`ck_´_lßd_±r
(&

.pointer->next.pointer);

268 ià(
	`ck_´_lßd_±r
(&
fifo
->

.
g’”©iÚ
) !=ail.generation)

271 ià(
Ãxt
.
poš‹r
 !ğ
NULL
) {

278 
upd©e
.
poš‹r
 = 
Ãxt
.pointer;

279 
upd©e
.
g’”©iÚ
 = 

.generation + 1;

280 
	`ck_´_ÿs_±r_2
(&
fifo
->

, &, &
upd©e
);

286 
upd©e
.
poš‹r
 = 
’Œy
;

287 
upd©e
.
g’”©iÚ
 = 
Ãxt
.generation + 1;

288 ià(
	`ck_´_ÿs_±r_2
(&

.
poš‹r
->
Ãxt
, &Ãxt, &
upd©e
è=ğ
Œue
)

293 
	`ck_´_ãnû_©omic
();

296 
upd©e
.
g’”©iÚ
 = 

.generation + 1;

297 
	`ck_´_ÿs_±r_2
(&
fifo
->

, &, &
upd©e
);

299 
	}
}

301 
CK_CC_INLINE
 
boŞ


302 
	$ck_fifo_mpmc_Œy’queue
(
ck_fifo_mpmc
 *
fifo
,

303 
ck_fifo_mpmc_’Œy
 *
’Œy
,

304 *
v®ue
)

306 
ck_fifo_mpmc_poš‹r
 

, 
Ãxt
, 
upd©e
;

308 
’Œy
->
v®ue
 = value;

309 
’Œy
->
Ãxt
.
poš‹r
 = 
NULL
;

310 
’Œy
->
Ãxt
.
g’”©iÚ
 = 0;

312 
	`ck_´_ãnû_¡Üe_©omic
();

314 

.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.generation);

315 
	`ck_´_ãnû_lßd
();

316 

.
poš‹r
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.pointer);

317 
Ãxt
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&

.
poš‹r
->next.generation);

318 
	`ck_´_ãnû_lßd
();

319 
Ãxt
.
poš‹r
 = 
	`ck_´_lßd_±r
(&

.pointer->next.pointer);

321 ià(
	`ck_´_lßd_±r
(&
fifo
->

.
g’”©iÚ
) !=ail.generation)

322  
çl£
;

324 ià(
Ãxt
.
poš‹r
 !ğ
NULL
) {

331 
upd©e
.
poš‹r
 = 
Ãxt
.pointer;

332 
upd©e
.
g’”©iÚ
 = 

.generation + 1;

333 
	`ck_´_ÿs_±r_2
(&
fifo
->

, &, &
upd©e
);

334  
çl£
;

340 
upd©e
.
poš‹r
 = 
’Œy
;

341 
upd©e
.
g’”©iÚ
 = 
Ãxt
.generation + 1;

342 ià(
	`ck_´_ÿs_±r_2
(&

.
poš‹r
->
Ãxt
, &Ãxt, &
upd©e
è=ğ
çl£
)

343  
çl£
;

346 
	`ck_´_ãnû_©omic
();

349 
upd©e
.
g’”©iÚ
 = 

.generation + 1;

350 
	`ck_´_ÿs_±r_2
(&
fifo
->

, &, &
upd©e
);

351  
Œue
;

352 
	}
}

354 
CK_CC_INLINE
 
boŞ


355 
	$ck_fifo_mpmc_dequeue
(
ck_fifo_mpmc
 *
fifo
,

356 *
v®ue
,

357 
ck_fifo_mpmc_’Œy
 **
g¬bage
)

359 
ck_fifo_mpmc_poš‹r
 
h—d
, 

, 
Ãxt
, 
upd©e
;

362 
h—d
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
fifo
->head.generation);

363 
	`ck_´_ãnû_lßd
();

364 
h—d
.
poš‹r
 = 
	`ck_´_lßd_±r
(&
fifo
->head.pointer);

365 

.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.generation);

366 
	`ck_´_ãnû_lßd
();

367 

.
poš‹r
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.pointer);

369 
Ãxt
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
h—d
.
poš‹r
->next.generation);

370 
	`ck_´_ãnû_lßd
();

371 
Ãxt
.
poš‹r
 = 
	`ck_´_lßd_±r
(&
h—d
.pointer->next.pointer);

373 
upd©e
.
poš‹r
 = 
Ãxt
.pointer;

374 ià(
h—d
.
poš‹r
 =ğ

.pointer) {

380 ià(
Ãxt
.
poš‹r
 =ğ
NULL
)

381  
çl£
;

384 
upd©e
.
g’”©iÚ
 = 

.generation + 1;

385 
	`ck_´_ÿs_±r_2
(&
fifo
->

, &, &
upd©e
);

392 ià(
Ãxt
.
poš‹r
 =ğ
NULL
)

396 *(**)
v®ue
 = 
	`ck_´_lßd_±r
(&
Ãxt
.
poš‹r
->value);

399 
upd©e
.
g’”©iÚ
 = 
h—d
.generation + 1;

400 ià(
	`ck_´_ÿs_±r_2
(&
fifo
->
h—d
, &h—d, &
upd©e
è=ğ
Œue
)

405 *
g¬bage
 = 
h—d
.
poš‹r
;

406  
Œue
;

407 
	}
}

409 
CK_CC_INLINE
 
boŞ


410 
	$ck_fifo_mpmc_Œydequeue
(
ck_fifo_mpmc
 *
fifo
,

411 *
v®ue
,

412 
ck_fifo_mpmc_’Œy
 **
g¬bage
)

414 
ck_fifo_mpmc_poš‹r
 
h—d
, 

, 
Ãxt
, 
upd©e
;

416 
h—d
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
fifo
->head.generation);

417 
	`ck_´_ãnû_lßd
();

418 
h—d
.
poš‹r
 = 
	`ck_´_lßd_±r
(&
fifo
->head.pointer);

420 

.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.generation);

421 
	`ck_´_ãnû_lßd
();

422 

.
poš‹r
 = 
	`ck_´_lßd_±r
(&
fifo
->tail.pointer);

424 
Ãxt
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
h—d
.
poš‹r
->next.generation);

425 
	`ck_´_ãnû_lßd
();

426 
Ãxt
.
poš‹r
 = 
	`ck_´_lßd_±r
(&
h—d
.pointer->next.pointer);

428 
upd©e
.
poš‹r
 = 
Ãxt
.pointer;

429 ià(
h—d
.
poš‹r
 =ğ

.pointer) {

435 ià(
Ãxt
.
poš‹r
 =ğ
NULL
)

436  
çl£
;

439 
upd©e
.
g’”©iÚ
 = 

.generation + 1;

440 
	`ck_´_ÿs_±r_2
(&
fifo
->

, &, &
upd©e
);

441  
çl£
;

447 ià(
Ãxt
.
poš‹r
 =ğ
NULL
)

448  
çl£
;

451 *(**)
v®ue
 = 
	`ck_´_lßd_±r
(&
Ãxt
.
poš‹r
->value);

454 
upd©e
.
g’”©iÚ
 = 
h—d
.generation + 1;

455 ià(
	`ck_´_ÿs_±r_2
(&
fifo
->
h—d
, &h—d, &
upd©e
è=ğ
çl£
)

456  
çl£
;

459 *
g¬bage
 = 
h—d
.
poš‹r
;

460  
Œue
;

461 
	}
}

463 
	#CK_FIFO_MPMC_ISEMPTY
(
f
è((f)->
h—d
.
poš‹r
->
Ãxt
.poš‹¸=ğ
NULL
)

	)

464 
	#CK_FIFO_MPMC_FIRST
(
f
è((f)->
h—d
.
poš‹r
->
Ãxt
.poš‹r)

	)

465 
	#CK_FIFO_MPMC_NEXT
(
m
è((m)->
Ãxt
.
poš‹r
)

	)

466 
	#CK_FIFO_MPMC_FOREACH
(
fifo
, 
’Œy
) \

467 (
’Œy
èğ
	`CK_FIFO_MPMC_FIRST
(
fifo
); \

468 (
’Œy
è!ğ
NULL
; \

469 (
’Œy
èğ
	`CK_FIFO_MPMC_NEXT
ÓÁry))

	)

470 
	#CK_FIFO_MPMC_FOREACH_SAFE
(
fifo
, 
’Œy
, 
T
) \

471 (
’Œy
èğ
	`CK_FIFO_MPMC_FIRST
(
fifo
); \

472 (
’Œy
è!ğ
NULL
 && ((
T
èğÓÁry)->
Ãxt
.
poš‹r
, 1); \

473 (
’Œy
èğ(
T
))

	)

	@application/kvbench/include/aerospike/ck/ck_hp_fifo.h

28 #iâdeà
CK_HP_FIFO_H


29 
	#CK_HP_FIFO_H


	)

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_hp.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¡ddef.h
>

36 
	#CK_HP_FIFO_SLOTS_COUNT
 (2)

	)

37 
	#CK_HP_FIFO_SLOTS_SIZE
 ((*è* 
CK_HP_FIFO_SLOTS_COUNT
)

	)

46 
	sck_hp_fifo_’Œy
 {

47 *
	mv®ue
;

48 
ck_hp_haz¬d_t
 
	mhaz¬d
;

49 
ck_hp_fifo_’Œy
 *
	mÃxt
;

51 
ck_hp_fifo_’Œy
 
	tck_hp_fifo_’Œy_t
;

53 
	sck_hp_fifo
 {

54 
ck_hp_fifo_’Œy
 *
	mh—d
;

55 
ck_hp_fifo_’Œy
 *
	m
;

57 
ck_hp_fifo
 
	tck_hp_fifo_t
;

59 
CK_CC_INLINE
 

60 
	$ck_hp_fifo_š™
(
ck_hp_fifo
 *
fifo
, 
ck_hp_fifo_’Œy
 *
¡ub
)

63 
fifo
->
h—d
 = fifo->

 = 
¡ub
;

64 
¡ub
->
Ãxt
 = 
NULL
;

66 
	}
}

68 
CK_CC_INLINE
 

69 
	$ck_hp_fifo_deš™
(
ck_hp_fifo
 *
fifo
, 
ck_hp_fifo_’Œy
 **
¡ub
)

72 *
¡ub
 = 
fifo
->
h—d
;

73 
fifo
->
h—d
 = fifo->

 = 
NULL
;

75 
	}
}

77 
CK_CC_INLINE
 

78 
	$ck_hp_fifo_’queue_mpmc
(
ck_hp_»cÜd_t
 *
»cÜd
,

79 
ck_hp_fifo
 *
fifo
,

80 
ck_hp_fifo_’Œy
 *
’Œy
,

81 *
v®ue
)

83 
ck_hp_fifo_’Œy
 *

, *
Ãxt
;

85 
’Œy
->
v®ue
 = value;

86 
’Œy
->
Ãxt
 = 
NULL
;

87 
	`ck_´_ãnû_¡Üe_©omic
();

90 

 = 
	`ck_´_lßd_±r
(&
fifo
->tail);

91 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 

);

92 ià(

 !ğ
	`ck_´_lßd_±r
(&
fifo
->tail))

95 
Ãxt
 = 
	`ck_´_lßd_±r
(&

->next);

96 ià(
Ãxt
 !ğ
NULL
) {

97 
	`ck_´_ÿs_±r
(&
fifo
->

,a, 
Ãxt
);

99 } ià(
	`ck_´_ÿs_±r
(&
fifo
->

->
Ãxt
,‚ext, 
’Œy
è=ğ
Œue
)

103 
	`ck_´_ãnû_©omic
();

104 
	`ck_´_ÿs_±r
(&
fifo
->

,a, 
’Œy
);

106 
	}
}

108 
CK_CC_INLINE
 
boŞ


109 
	$ck_hp_fifo_Œy’queue_mpmc
(
ck_hp_»cÜd_t
 *
»cÜd
,

110 
ck_hp_fifo
 *
fifo
,

111 
ck_hp_fifo_’Œy
 *
’Œy
,

112 *
v®ue
)

114 
ck_hp_fifo_’Œy
 *

, *
Ãxt
;

116 
’Œy
->
v®ue
 = value;

117 
’Œy
->
Ãxt
 = 
NULL
;

118 
	`ck_´_ãnû_¡Üe_©omic
();

120 

 = 
	`ck_´_lßd_±r
(&
fifo
->tail);

121 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 

);

122 ià(

 !ğ
	`ck_´_lßd_±r
(&
fifo
->tail))

123  
çl£
;

125 
Ãxt
 = 
	`ck_´_lßd_±r
(&

->next);

126 ià(
Ãxt
 !ğ
NULL
) {

127 
	`ck_´_ÿs_±r
(&
fifo
->

,a, 
Ãxt
);

128  
çl£
;

129 } ià(
	`ck_´_ÿs_±r
(&
fifo
->

->
Ãxt
,‚ext, 
’Œy
è=ğ
çl£
)

130  
çl£
;

132 
	`ck_´_ãnû_©omic
();

133 
	`ck_´_ÿs_±r
(&
fifo
->

,a, 
’Œy
);

134  
Œue
;

135 
	}
}

137 
CK_CC_INLINE
 
ck_hp_fifo_’Œy
 *

138 
	$ck_hp_fifo_dequeue_mpmc
(
ck_hp_»cÜd_t
 *
»cÜd
,

139 
ck_hp_fifo
 *
fifo
,

140 *
v®ue
)

142 
ck_hp_fifo_’Œy
 *
h—d
, *

, *
Ãxt
;

145 
h—d
 = 
	`ck_´_lßd_±r
(&
fifo
->head);

146 
	`ck_´_ãnû_lßd
();

147 

 = 
	`ck_´_lßd_±r
(&
fifo
->tail);

148 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 
h—d
);

149 ià(
h—d
 !ğ
	`ck_´_lßd_±r
(&
fifo
->head))

152 
Ãxt
 = 
	`ck_´_lßd_±r
(&
h—d
->next);

153 
	`ck_hp_£t_ãnû
(
»cÜd
, 1, 
Ãxt
);

154 ià(
h—d
 !ğ
	`ck_´_lßd_±r
(&
fifo
->head))

157 ià(
h—d
 =ğ

) {

158 ià(
Ãxt
 =ğ
NULL
)

159  
NULL
;

161 
	`ck_´_ÿs_±r
(&
fifo
->

,a, 
Ãxt
);

163 } ià(
	`ck_´_ÿs_±r
(&
fifo
->
h—d
, h—d, 
Ãxt
è=ğ
Œue
)

167 
	`ck_´_¡Üe_±r_un§ã
(
v®ue
, 
Ãxt
->value);

168  
h—d
;

169 
	}
}

171 
CK_CC_INLINE
 
ck_hp_fifo_’Œy
 *

172 
	$ck_hp_fifo_Œydequeue_mpmc
(
ck_hp_»cÜd_t
 *
»cÜd
,

173 
ck_hp_fifo
 *
fifo
,

174 *
v®ue
)

176 
ck_hp_fifo_’Œy
 *
h—d
, *

, *
Ãxt
;

178 
h—d
 = 
	`ck_´_lßd_±r
(&
fifo
->head);

179 
	`ck_´_ãnû_lßd
();

180 

 = 
	`ck_´_lßd_±r
(&
fifo
->tail);

181 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 
h—d
);

182 ià(
h—d
 !ğ
	`ck_´_lßd_±r
(&
fifo
->head))

183  
NULL
;

185 
Ãxt
 = 
	`ck_´_lßd_±r
(&
h—d
->next);

186 
	`ck_hp_£t_ãnû
(
»cÜd
, 1, 
Ãxt
);

187 ià(
h—d
 !ğ
	`ck_´_lßd_±r
(&
fifo
->head))

188  
NULL
;

190 ià(
h—d
 =ğ

) {

191 ià(
Ãxt
 =ğ
NULL
)

192  
NULL
;

194 
	`ck_´_ÿs_±r
(&
fifo
->

,a, 
Ãxt
);

195  
NULL
;

196 } ià(
	`ck_´_ÿs_±r
(&
fifo
->
h—d
, h—d, 
Ãxt
è=ğ
çl£
)

197  
NULL
;

199 
	`ck_´_¡Üe_±r_un§ã
(
v®ue
, 
Ãxt
->value);

200  
h—d
;

201 
	}
}

203 
	#CK_HP_FIFO_ISEMPTY
(
f
è((f)->
h—d
->
Ãxt
 =ğ
NULL
)

	)

204 
	#CK_HP_FIFO_FIRST
(
f
è((f)->
h—d
->
Ãxt
)

	)

205 
	#CK_HP_FIFO_NEXT
(
m
è((m)->
Ãxt
)

	)

206 
	#CK_HP_FIFO_FOREACH
(
fifo
, 
’Œy
) \

207 (
’Œy
èğ
	`CK_HP_FIFO_FIRST
(
fifo
); \

208 (
’Œy
è!ğ
NULL
; \

209 (
’Œy
èğ
	`CK_HP_FIFO_NEXT
ÓÁry))

	)

210 
	#CK_HP_FIFO_FOREACH_SAFE
(
fifo
, 
’Œy
, 
T
) \

211 (
’Œy
èğ
	`CK_HP_FIFO_FIRST
(
fifo
); \

212 (
’Œy
è!ğ
NULL
 && ((
T
èğÓÁry)->
Ãxt
, 1); \

213 (
’Œy
èğ(
T
))

	)

	@application/kvbench/include/aerospike/ck/ck_hp_stack.h

27 #iâdeà
CK_HP_STACK_H


28 
	#CK_HP_STACK_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_hp.h
>

32 
	~<«ro¥ike/ck/ck_´.h
>

33 
	~<«ro¥ike/ck/ck_¡ack.h
>

34 
	~<«ro¥ike/ck/ck_¡ddef.h
>

36 
	#CK_HP_STACK_SLOTS_COUNT
 1

	)

37 
	#CK_HP_STACK_SLOTS_SIZE
 (*)

	)

39 
CK_CC_INLINE
 

40 
	$ck_hp_¡ack_push_mpmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

43 
	`ck_¡ack_push_upmc
(
rg‘
, 
’Œy
);

45 
	}
}

47 
CK_CC_INLINE
 
boŞ


48 
	$ck_hp_¡ack_Œypush_mpmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

51  
	`ck_¡ack_Œypush_upmc
(
rg‘
, 
’Œy
);

52 
	}
}

54 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

55 
	$ck_hp_¡ack_pİ_mpmc
(
ck_hp_»cÜd_t
 *
»cÜd
, 
ck_¡ack
 *
rg‘
)

57 
ck_¡ack_’Œy
 *
’Œy
, *
upd©e
;

60 
’Œy
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

61 ià(
’Œy
 =ğ
NULL
)

62  
NULL
;

64 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 
’Œy
);

65 } 
’Œy
 !ğ
	`ck_´_lßd_±r
(&
rg‘
->
h—d
));

67 
	`ck_´_ÿs_±r_v®ue
(&
rg‘
->
h—d
, 
’Œy
,ƒÁry->
Ãxt
, &’Œyè=ğ
çl£
) {

68 ià(
’Œy
 =ğ
NULL
)

69  
NULL
;

71 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 
’Œy
);

73 
upd©e
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

74 
’Œy
 !ğ
upd©e
) {

75 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 
upd©e
);

76 
’Œy
 = 
upd©e
;

77 
upd©e
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

78 ià(
upd©e
 =ğ
NULL
)

79  
NULL
;

83  
’Œy
;

84 
	}
}

86 
CK_CC_INLINE
 
boŞ


87 
	$ck_hp_¡ack_Œypİ_mpmc
(
ck_hp_»cÜd_t
 *
»cÜd
, 
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 **
r
)

89 
ck_¡ack_’Œy
 *
’Œy
;

91 
’Œy
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

92 ià(
’Œy
 =ğ
NULL
)

93  
çl£
;

95 
	`ck_hp_£t_ãnû
(
»cÜd
, 0, 
’Œy
);

96 ià(
’Œy
 !ğ
	`ck_´_lßd_±r
(&
rg‘
->
h—d
))

97 
Ëave
;

99 ià(
	`ck_´_ÿs_±r_v®ue
(&
rg‘
->
h—d
, 
’Œy
,ƒÁry->
Ãxt
, &’Œyè=ğ
çl£
)

100 
Ëave
;

102 *
r
 = 
’Œy
;

103  
Œue
;

105 
Ëave
:

106 
	`ck_hp_£t
(
»cÜd
, 0, 
NULL
);

107  
çl£
;

108 
	}
}

	@application/kvbench/include/aerospike/ck/ck_limits.h

27 #ià
defšed
(
__lšux__
è&& defšed(
__KERNEL__
)

28 
	~<lšux/k”Ãl.h
>

30 #iâdeà
UINT8_MAX


31 
	#UINT8_MAX
 ((
u8
)(~0U))

	)

33 #iâdeà
UINT16_MAX


34 
	#UINT16_MAX
 
USHRT_MAX


	)

36 #iâdeà
UINT32_MAX


37 
	#UINT32_MAX
 
UINT_MAX


	)

39 #iâdeà
UINT64_MAX


40 
	#UINT64_MAX
 
ULLONG_MAX


	)

43 #–ià
defšed
(
__F»eBSD__
è&& defšed(
_KERNEL
)

44 
	~<sys/¡dšt.h
>

45 
	~<sys/lim™s.h
>

47 
	~<lim™s.h
>

	@application/kvbench/include/aerospike/ck/ck_malloc.h

27 #iâdeà
CK_MALLOC_H


28 
	#CK_MALLOC_H


	)

30 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

31 
	~<sys/ty³s.h
>

33 
	sck_m®loc
 {

34 *(*
	mm®loc
)(
	msize_t
);

35 *(*
	m»®loc
)(*, 
	msize_t
, size_t, 
	mboŞ
);

36 (*
	mä“
)(*, 
	msize_t
, 
	mboŞ
);

	@application/kvbench/include/aerospike/ck/ck_md.h

27 #iâdeà
CK_MD_H


28 
	#CK_MD_H


	)

30 #iâdeà
CK_MD_CACHELINE


31 
	#CK_MD_CACHELINE
 (64)

	)

34 #iâdeà
CK_MD_PAGESIZE


35 
	#CK_MD_PAGESIZE
 (4096)

	)

38 #iâdeà
CK_MD_RTM_DISABLE


39 
	#CK_MD_RTM_DISABLE


	)

42 #iâdeà
CK_MD_POINTER_PACK_DISABLE


43 
	#CK_MD_POINTER_PACK_DISABLE


	)

46 #iâdeà
CK_MD_VMA_BITS


47 
	#CK_MD_VMA_BITS
 48ULL

	)

50 #iâdeà
CK_MD_TSO


51 
	#CK_MD_TSO


	)

54 
	#CK_VERSION
 "0.5.1"

	)

55 
	#CK_GIT_SHA
 "3183bbe"

	)

	@application/kvbench/include/aerospike/ck/ck_pflock.h

28 #iâdeà
CK_PFLOCK_H


29 
	#CK_PFLOCK_H


	)

38 
	~<«ro¥ike/ck/ck_cc.h
>

39 
	~<«ro¥ike/ck/ck_´.h
>

41 
	sck_pæock
 {

42 
ušt32_t
 
	mrš
;

43 
ušt32_t
 
	mrout
;

44 
ušt32_t
 
	mwš
;

45 
ušt32_t
 
	mwout
;

47 
ck_pæock
 
	tck_pæock_t
;

49 
	#CK_PFLOCK_LSB
 0xFFFFFFF0

	)

50 
	#CK_PFLOCK_RINC
 0x100

	)

51 
	#CK_PFLOCK_WBITS
 0x3

	)

52 
	#CK_PFLOCK_PRES
 0x2

	)

53 
	#CK_PFLOCK_PHID
 0x1

	)

55 
	#CK_PFLOCK_INITIALIZER
 {0, 0, 0, 0}

	)

57 
CK_CC_INLINE
 

58 
	$ck_pæock_š™
(
ck_pæock
 *
pf
)

61 
pf
->
rš
 = 0;

62 
pf
->
rout
 = 0;

63 
pf
->
wš
 = 0;

64 
pf
->
wout
 = 0;

65 
	`ck_´_b¬r›r
();

68 
	}
}

70 
CK_CC_INLINE
 

71 
	$ck_pæock_wr™e_uÆock
(
ck_pæock_t
 *
pf
)

74 
	`ck_´_ãnû_uÆock
();

77 
	`ck_´_ªd_32
(&
pf
->
rš
, 
CK_PFLOCK_LSB
);

80 
	`ck_´_ça_32
(&
pf
->
wout
, 1);

82 
	}
}

84 
CK_CC_INLINE
 

85 
	$ck_pæock_wr™e_lock
(
ck_pæock_t
 *
pf
)

87 
ušt32_t
 
tick‘
;

90 
tick‘
 = 
	`ck_´_ça_32
(&
pf
->
wš
, 1);

91 
	`ck_´_lßd_32
(&
pf
->
wout
è!ğ
tick‘
)

92 
	`ck_´_¡®l
();

99 
tick‘
 = 
	`ck_´_ça_32
(&
pf
->
rš
,

100 (
tick‘
 & 
CK_PFLOCK_PHID
è| 
CK_PFLOCK_PRES
);

103 
	`ck_´_lßd_32
(&
pf
->
rout
è!ğ
tick‘
)

104 
	`ck_´_¡®l
();

106 
	`ck_´_ãnû_lock
();

108 
	}
}

110 
CK_CC_INLINE
 

111 
	$ck_pæock_»ad_uÆock
(
ck_pæock_t
 *
pf
)

114 
	`ck_´_ãnû_uÆock
();

115 
	`ck_´_ça_32
(&
pf
->
rout
, 
CK_PFLOCK_RINC
);

117 
	}
}

119 
CK_CC_INLINE
 

120 
	$ck_pæock_»ad_lock
(
ck_pæock_t
 *
pf
)

122 
ušt32_t
 
w
;

128 
w
 = 
	`ck_´_ça_32
(&
pf
->
rš
, 
CK_PFLOCK_RINC
è& 
CK_PFLOCK_WBITS
;

129 ià(
w
 == 0)

130 
Ëave
;

133 (
	`ck_´_lßd_32
(&
pf
->
rš
è& 
CK_PFLOCK_WBITS
è=ğ
w
)

134 
	`ck_´_¡®l
();

136 
Ëave
:

138 
	`ck_´_ãnû_lock
();

140 
	}
}

	@application/kvbench/include/aerospike/ck/ck_pr.h

28 #iâdeà
CK_PR_H


29 
	#CK_PR_H


	)

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_lim™s.h
>

33 
	~<«ro¥ike/ck/ck_md.h
>

34 
	~<«ro¥ike/ck/ck_¡dšt.h
>

35 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

37 #iâdeà
CK_USE_CC_BUILTINS


38 #ià
defšed
(
__x86_64__
)

39 
	~"«ro¥ike/ck/gcc/x86_64/ck_´.h
"

40 #–ià
defšed
(
__x86__
)

41 
	~"«ro¥ike/ck/gcc/x86/ck_´.h
"

42 #–ià
defšed
(
__¥¬cv9__
)

43 
	~"«ro¥ike/ck/gcc/¥¬cv9/ck_´.h
"

44 #–ià
defšed
(
__µc64__
)

45 
	~"«ro¥ike/ck/gcc/µc64/ck_´.h
"

46 #–ià
defšed
(
__µc__
)

47 
	~"«ro¥ike/ck/gcc/µc/ck_´.h
"

48 #–ià
defšed
(
__¬m__
)

49 
	~"«ro¥ike/ck/gcc/¬m/ck_´.h
"

50 #–ià!
defšed
(
__GNUC__
)

51 #”rÜ 
Your
 
¶©fÜm
 
is
 
unsuµÜ‹d


55 #ià
defšed
(
__GNUC__
)

56 
	~"«ro¥ike/ck/gcc/ck_´.h
"

59 
	#CK_PR_FENCE_EMIT
(
T
) \

60 
CK_CC_INLINE
 \

61 
ck_´_ãnû_
##
	`T
() \

63 
ck_´_ãnû_¡riù_
##
	`T
(); \

65 }

	)

66 
	#CK_PR_FENCE_NOOP
(
T
) \

67 
CK_CC_INLINE
 \

68 
ck_´_ãnû_
##
	`T
() \

70 
	`ck_´_b¬r›r
(); \

72 }

	)

78 
	$CK_PR_FENCE_NOOP
(
lßd_d•’ds
)

79 
	#ck_´_ãnû_¡riù_lßd_d•’ds
 
ck_´_ãnû_lßd_d•’ds


	)

85 #ià
	`defšed
(
CK_MD_RMO
)

90 
	$CK_PR_FENCE_EMIT
(
©omic
)

91 
	$CK_PR_FENCE_EMIT
(
©omic_lßd
)

92 
	$CK_PR_FENCE_EMIT
(
©omic_¡Üe
)

93 
	$CK_PR_FENCE_EMIT
(
¡Üe_©omic
)

94 
	$CK_PR_FENCE_EMIT
(
lßd_©omic
)

95 
	$CK_PR_FENCE_EMIT
(
lßd_¡Üe
)

96 
	$CK_PR_FENCE_EMIT
(
¡Üe_lßd
)

97 
	$CK_PR_FENCE_EMIT
(
lßd
)

98 
	$CK_PR_FENCE_EMIT
(
¡Üe
)

99 
	$CK_PR_FENCE_EMIT
(
memÜy
)

100 
	$CK_PR_FENCE_EMIT
(
acquœe
)

101 
	$CK_PR_FENCE_EMIT
(
»Ëa£
)

102 
	$CK_PR_FENCE_EMIT
(
acq»l
)

103 
	$CK_PR_FENCE_EMIT
(
lock
)

104 
	$CK_PR_FENCE_EMIT
(
uÆock
)

105 #–ià
	`defšed
(
CK_MD_PSO
)

110 
	$CK_PR_FENCE_EMIT
(
©omic
)

111 
	$CK_PR_FENCE_NOOP
(
©omic_lßd
)

112 
	$CK_PR_FENCE_EMIT
(
©omic_¡Üe
)

113 
	$CK_PR_FENCE_EMIT
(
¡Üe_©omic
)

114 
	$CK_PR_FENCE_NOOP
(
lßd_©omic
)

115 
	$CK_PR_FENCE_EMIT
(
lßd_¡Üe
)

116 
	$CK_PR_FENCE_EMIT
(
¡Üe_lßd
)

117 
	$CK_PR_FENCE_NOOP
(
lßd
)

118 
	$CK_PR_FENCE_EMIT
(
¡Üe
)

119 
	$CK_PR_FENCE_EMIT
(
memÜy
)

120 
	$CK_PR_FENCE_EMIT
(
acquœe
)

121 
	$CK_PR_FENCE_EMIT
(
»Ëa£
)

122 
	$CK_PR_FENCE_EMIT
(
acq»l
)

123 
	$CK_PR_FENCE_EMIT
(
lock
)

124 
	$CK_PR_FENCE_EMIT
(
uÆock
)

125 #–ià
	`defšed
(
CK_MD_TSO
)

130 
	$CK_PR_FENCE_NOOP
(
©omic
)

131 
	$CK_PR_FENCE_NOOP
(
©omic_lßd
)

132 
	$CK_PR_FENCE_NOOP
(
©omic_¡Üe
)

133 
	$CK_PR_FENCE_NOOP
(
¡Üe_©omic
)

134 
	$CK_PR_FENCE_NOOP
(
lßd_©omic
)

135 
	$CK_PR_FENCE_NOOP
(
lßd_¡Üe
)

136 
	$CK_PR_FENCE_EMIT
(
¡Üe_lßd
)

137 
	$CK_PR_FENCE_NOOP
(
lßd
)

138 
	$CK_PR_FENCE_NOOP
(
¡Üe
)

139 
	$CK_PR_FENCE_EMIT
(
memÜy
)

140 
	$CK_PR_FENCE_NOOP
(
acquœe
)

141 
	$CK_PR_FENCE_NOOP
(
»Ëa£
)

142 
	$CK_PR_FENCE_NOOP
(
acq»l
)

143 
	$CK_PR_FENCE_NOOP
(
lock
)

144 
	$CK_PR_FENCE_NOOP
(
uÆock
)

149 #undeà
CK_PR_FENCE_EMIT


150 #undeà
CK_PR_FENCE_NOOP


152 #iâdeà
CK_F_PR_RFO


153 
	#CK_F_PR_RFO


	)

154 
CK_CC_INLINE
 

155 
	$ck_´_rfo
(cÚ¡ *
m
)

158 ()
m
;

160 
	}
}

163 
	#CK_PR_STORE_SAFE
(
DST
, 
VAL
, 
TYPE
) \

164 
ck_´_md_¡Üe_
##
	`TYPE
( \

165 (()(*(
DST
èğ(
VAL
)), (DST)), \

166 (
VAL
))

	)

168 
	#ck_´_¡Üe_±r
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), 
±r
)

	)

169 
	#ck_´_¡Üe_ch¬
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), )

	)

170 
	#ck_´_¡Üe_doubË
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), )

	)

171 
	#ck_´_¡Üe_ušt
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), 
ušt
)

	)

172 
	#ck_´_¡Üe_št
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), )

	)

173 
	#ck_´_¡Üe_32
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), 32)

	)

174 
	#ck_´_¡Üe_16
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), 16)

	)

175 
	#ck_´_¡Üe_8
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), 8)

	)

177 
	#ck_´_¡Üe_±r_un§ã
(
DST
, 
VAL
è
	`ck_´_md_¡Üe_±r
((DST), (VAL))

	)

179 #ifdeà
CK_F_PR_LOAD_64


180 
	#ck_´_¡Üe_64
(
DST
, 
VAL
è
	`CK_PR_STORE_SAFE
((DST), (VAL), 64)

	)

183 
	#CK_PR_LOAD_PTR_SAFE
(
SRC
è(
	`CK_CC_TYPEOF
(*(SRC), (*)))
	`ck_´_md_lßd_±r
((SRC))

	)

184 
	#ck_´_lßd_±r
(
SRC
è
	`CK_PR_LOAD_PTR_SAFE
((SRC))

	)

186 
	#CK_PR_LOAD_SAFE
(
SRC
, 
TYPE
è
ck_´_md_lßd_
##
	`TYPE
((SRC))

	)

187 
	#ck_´_lßd_ch¬
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), )

	)

188 
	#ck_´_lßd_doubË
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), )

	)

189 
	#ck_´_lßd_ušt
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), 
ušt
)

	)

190 
	#ck_´_lßd_št
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), )

	)

191 
	#ck_´_lßd_32
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), 32)

	)

192 
	#ck_´_lßd_16
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), 16)

	)

193 
	#ck_´_lßd_8
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), 8)

	)

195 #ifdeà
CK_F_PR_LOAD_64


196 
	#ck_´_lßd_64
(
SRC
è
	`CK_PR_LOAD_SAFE
((SRC), 64)

	)

199 
	#CK_PR_BIN
(
K
, 
S
, 
M
, 
T
, 
P
, 
C
) \

200 
CK_CC_INLINE
 \

201 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
, 
T
 
v®ue
) \

203 
T
 
´evious
; \

204 
C
 
puÁ
; \

205 
puÁ
 = 
ck_´_md_lßd_
##
	`S
(
rg‘
); \

206 
´evious
 = (
T
)
puÁ
; \

207 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, \

208 (
C
)
´evious
, \

209 (
C
)(
´evious
 
P
 
v®ue
), \

210 &
´evious
è=ğ
çl£
) \

211 
	`ck_´_¡®l
(); \

214 }

	)

216 
	#CK_PR_BIN_S
(
K
, 
S
, 
T
, 
P
è
	`CK_PR_BIN
(K, S, T, T, P, T)

	)

218 #ià
defšed
(
CK_F_PR_LOAD_CHAR
è&& defšed(
CK_F_PR_CAS_CHAR_VALUE
)

220 #iâdeà
CK_F_PR_ADD_CHAR


221 
	#CK_F_PR_ADD_CHAR


	)

222 
CK_PR_BIN_S
(
add
, , , +)

225 #iâdeà
CK_F_PR_SUB_CHAR


226 
	#CK_F_PR_SUB_CHAR


	)

227 
CK_PR_BIN_S
(
sub
, , , -)

230 #iâdeà
CK_F_PR_AND_CHAR


231 
	#CK_F_PR_AND_CHAR


	)

232 
	$CK_PR_BIN_S
(
ªd
, , , &)

235 #iâdeà
CK_F_PR_XOR_CHAR


236 
	#CK_F_PR_XOR_CHAR


	)

237 
	`CK_PR_BIN_S
(
xÜ
, , , ^)

240 #iâdeà
CK_F_PR_OR_CHAR


241 
	#CK_F_PR_OR_CHAR


	)

242 
	`CK_PR_BIN_S
(
Ü
, , , |)

247 #ià
	`defšed
(
CK_F_PR_LOAD_INT
è&& defšed(
CK_F_PR_CAS_INT_VALUE
)

249 #iâdeà
CK_F_PR_ADD_INT


250 
	#CK_F_PR_ADD_INT


	)

251 
	`CK_PR_BIN_S
(
add
, , , +)

254 #iâdeà
CK_F_PR_SUB_INT


255 
	#CK_F_PR_SUB_INT


	)

256 
	`CK_PR_BIN_S
(
sub
, , , -)

259 #iâdeà
CK_F_PR_AND_INT


260 
	#CK_F_PR_AND_INT


	)

261 
	$CK_PR_BIN_S
(
ªd
, , , &)

264 #iâdeà
CK_F_PR_XOR_INT


265 
	#CK_F_PR_XOR_INT


	)

266 
	`CK_PR_BIN_S
(
xÜ
, , , ^)

269 #iâdeà
CK_F_PR_OR_INT


270 
	#CK_F_PR_OR_INT


	)

271 
	`CK_PR_BIN_S
(
Ü
, , , |)

276 #ià
	`defšed
(
CK_F_PR_LOAD_DOUBLE
è&& defšed(
CK_F_PR_CAS_DOUBLE_VALUE
)

278 #iâdeà
CK_F_PR_ADD_DOUBLE


279 
	#CK_F_PR_ADD_DOUBLE


	)

280 
	`CK_PR_BIN_S
(
add
, , , +)

283 #iâdeà
CK_F_PR_SUB_DOUBLE


284 
	#CK_F_PR_SUB_DOUBLE


	)

285 
	`CK_PR_BIN_S
(
sub
, , , -)

290 #ià
	`defšed
(
CK_F_PR_LOAD_UINT
è&& defšed(
CK_F_PR_CAS_UINT_VALUE
)

292 #iâdeà
CK_F_PR_ADD_UINT


293 
	#CK_F_PR_ADD_UINT


	)

294 
	`CK_PR_BIN_S
(
add
, 
ušt
, , +)

297 #iâdeà
CK_F_PR_SUB_UINT


298 
	#CK_F_PR_SUB_UINT


	)

299 
	`CK_PR_BIN_S
(
sub
, 
ušt
, , -)

302 #iâdeà
CK_F_PR_AND_UINT


303 
	#CK_F_PR_AND_UINT


	)

304 
	$CK_PR_BIN_S
(
ªd
, 
ušt
, , &)

307 #iâdeà
CK_F_PR_XOR_UINT


308 
	#CK_F_PR_XOR_UINT


	)

309 
	`CK_PR_BIN_S
(
xÜ
, 
ušt
, , ^)

312 #iâdeà
CK_F_PR_OR_UINT


313 
	#CK_F_PR_OR_UINT


	)

314 
	`CK_PR_BIN_S
(
Ü
, 
ušt
, , |)

319 #ià
	`defšed
(
CK_F_PR_LOAD_PTR
è&& defšed(
CK_F_PR_CAS_PTR_VALUE
)

321 #iâdeà
CK_F_PR_ADD_PTR


322 
	#CK_F_PR_ADD_PTR


	)

323 
	`CK_PR_BIN
(
add
, 
±r
, , 
ušŒ_t
, +, *)

326 #iâdeà
CK_F_PR_SUB_PTR


327 
	#CK_F_PR_SUB_PTR


	)

328 
	`CK_PR_BIN
(
sub
, 
±r
, , 
ušŒ_t
, -, *)

331 #iâdeà
CK_F_PR_AND_PTR


332 
	#CK_F_PR_AND_PTR


	)

333 
	$CK_PR_BIN
(
ªd
, 
±r
, , 
ušŒ_t
, &, *)

336 #iâdeà
CK_F_PR_XOR_PTR


337 
	#CK_F_PR_XOR_PTR


	)

338 
	`CK_PR_BIN
(
xÜ
, 
±r
, , 
ušŒ_t
, ^, *)

341 #iâdeà
CK_F_PR_OR_PTR


342 
	#CK_F_PR_OR_PTR


	)

343 
	`CK_PR_BIN
(
Ü
, 
±r
, , 
ušŒ_t
, |, *)

348 #ià
	`defšed
(
CK_F_PR_LOAD_64
è&& defšed(
CK_F_PR_CAS_64_VALUE
)

350 #iâdeà
CK_F_PR_ADD_64


351 
	#CK_F_PR_ADD_64


	)

352 
	`CK_PR_BIN_S
(
add
, 64, 
ušt64_t
, +)

355 #iâdeà
CK_F_PR_SUB_64


356 
	#CK_F_PR_SUB_64


	)

357 
	`CK_PR_BIN_S
(
sub
, 64, 
ušt64_t
, -)

360 #iâdeà
CK_F_PR_AND_64


361 
	#CK_F_PR_AND_64


	)

362 
	$CK_PR_BIN_S
(
ªd
, 64, 
ušt64_t
, &)

365 #iâdeà
CK_F_PR_XOR_64


366 
	#CK_F_PR_XOR_64


	)

367 
	`CK_PR_BIN_S
(
xÜ
, 64, 
ušt64_t
, ^)

370 #iâdeà
CK_F_PR_OR_64


371 
	#CK_F_PR_OR_64


	)

372 
	`CK_PR_BIN_S
(
Ü
, 64, 
ušt64_t
, |)

377 #ià
	`defšed
(
CK_F_PR_LOAD_32
è&& defšed(
CK_F_PR_CAS_32_VALUE
)

379 #iâdeà
CK_F_PR_ADD_32


380 
	#CK_F_PR_ADD_32


	)

381 
	`CK_PR_BIN_S
(
add
, 32, 
ušt32_t
, +)

384 #iâdeà
CK_F_PR_SUB_32


385 
	#CK_F_PR_SUB_32


	)

386 
	`CK_PR_BIN_S
(
sub
, 32, 
ušt32_t
, -)

389 #iâdeà
CK_F_PR_AND_32


390 
	#CK_F_PR_AND_32


	)

391 
	$CK_PR_BIN_S
(
ªd
, 32, 
ušt32_t
, &)

394 #iâdeà
CK_F_PR_XOR_32


395 
	#CK_F_PR_XOR_32


	)

396 
	`CK_PR_BIN_S
(
xÜ
, 32, 
ušt32_t
, ^)

399 #iâdeà
CK_F_PR_OR_32


400 
	#CK_F_PR_OR_32


	)

401 
	`CK_PR_BIN_S
(
Ü
, 32, 
ušt32_t
, |)

406 #ià
	`defšed
(
CK_F_PR_LOAD_16
è&& defšed(
CK_F_PR_CAS_16_VALUE
)

408 #iâdeà
CK_F_PR_ADD_16


409 
	#CK_F_PR_ADD_16


	)

410 
	`CK_PR_BIN_S
(
add
, 16, 
ušt16_t
, +)

413 #iâdeà
CK_F_PR_SUB_16


414 
	#CK_F_PR_SUB_16


	)

415 
	`CK_PR_BIN_S
(
sub
, 16, 
ušt16_t
, -)

418 #iâdeà
CK_F_PR_AND_16


419 
	#CK_F_PR_AND_16


	)

420 
	$CK_PR_BIN_S
(
ªd
, 16, 
ušt16_t
, &)

423 #iâdeà
CK_F_PR_XOR_16


424 
	#CK_F_PR_XOR_16


	)

425 
	`CK_PR_BIN_S
(
xÜ
, 16, 
ušt16_t
, ^)

428 #iâdeà
CK_F_PR_OR_16


429 
	#CK_F_PR_OR_16


	)

430 
	`CK_PR_BIN_S
(
Ü
, 16, 
ušt16_t
, |)

435 #ià
	`defšed
(
CK_F_PR_LOAD_8
è&& defšed(
CK_F_PR_CAS_8_VALUE
)

437 #iâdeà
CK_F_PR_ADD_8


438 
	#CK_F_PR_ADD_8


	)

439 
	`CK_PR_BIN_S
(
add
, 8, 
ušt8_t
, +)

442 #iâdeà
CK_F_PR_SUB_8


443 
	#CK_F_PR_SUB_8


	)

444 
	`CK_PR_BIN_S
(
sub
, 8, 
ušt8_t
, -)

447 #iâdeà
CK_F_PR_AND_8


448 
	#CK_F_PR_AND_8


	)

449 
	$CK_PR_BIN_S
(
ªd
, 8, 
ušt8_t
, &)

452 #iâdeà
CK_F_PR_XOR_8


453 
	#CK_F_PR_XOR_8


	)

454 
	`CK_PR_BIN_S
(
xÜ
, 8, 
ušt8_t
, ^)

457 #iâdeà
CK_F_PR_OR_8


458 
	#CK_F_PR_OR_8


	)

459 
	`CK_PR_BIN_S
(
Ü
, 8, 
ušt8_t
, |)

464 #undeà
CK_PR_BIN_S


465 #undeà
CK_PR_BIN


467 
	#CK_PR_BTX
(
K
, 
S
, 
M
, 
T
, 
P
, 
C
, 
R
) \

468 
CK_CC_INLINE
 
boŞ
 \

469 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
, 
off£t
) \

471 
T
 
´evious
; \

472 
C
 
puÁ
; \

473 
puÁ
 = 
ck_´_md_lßd_
##
	`S
(
rg‘
); \

474 
´evious
 = (
T
)
puÁ
; \

475 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, (
C
)
´evious
, \

476 (
C
)(
´evious
 
	`P
 (
	`R
 ((
T
)1 << 
off£t
))), &´eviousè=ğ
çl£
) \

477 
	`ck_´_¡®l
(); \

478  ((
´evious
 >> 
off£t
) & 1); \

479 
	}

	)
}

481 
	#CK_PR_BTX_S
(
K
, 
S
, 
T
, 
P
, 
R
è
	`CK_PR_BTX
(K, S, T, T, P, T, R)

	)

483 #ià
defšed
(
CK_F_PR_LOAD_INT
è&& defšed(
CK_F_PR_CAS_INT_VALUE
)

485 #iâdeà
CK_F_PR_BTC_INT


486 
	#CK_F_PR_BTC_INT


	)

487 
CK_PR_BTX_S
(
btc
, , , ^,)

490 #iâdeà
CK_F_PR_BTR_INT


491 
	#CK_F_PR_BTR_INT


	)

492 
CK_PR_BTX_S
(
bŒ
, , , &, ~)

495 #iâdeà
CK_F_PR_BTS_INT


496 
	#CK_F_PR_BTS_INT


	)

497 
CK_PR_BTX_S
(
bts
, , , |,)

502 #ià
defšed
(
CK_F_PR_LOAD_UINT
è&& defšed(
CK_F_PR_CAS_UINT_VALUE
)

504 #iâdeà
CK_F_PR_BTC_UINT


505 
	#CK_F_PR_BTC_UINT


	)

506 
CK_PR_BTX_S
(
btc
, 
ušt
, , ^,)

509 #iâdeà
CK_F_PR_BTR_UINT


510 
	#CK_F_PR_BTR_UINT


	)

511 
CK_PR_BTX_S
(
bŒ
, 
ušt
, , &, ~)

514 #iâdeà
CK_F_PR_BTS_UINT


515 
	#CK_F_PR_BTS_UINT


	)

516 
CK_PR_BTX_S
(
bts
, 
ušt
, , |,)

521 #ià
defšed
(
CK_F_PR_LOAD_PTR
è&& defšed(
CK_F_PR_CAS_PTR_VALUE
)

523 #iâdeà
CK_F_PR_BTC_PTR


524 
	#CK_F_PR_BTC_PTR


	)

525 
CK_PR_BTX
(
btc
, 
±r
, , 
ušŒ_t
, ^, *,)

528 #iâdeà
CK_F_PR_BTR_PTR


529 
	#CK_F_PR_BTR_PTR


	)

530 
CK_PR_BTX
(
bŒ
, 
±r
, , 
ušŒ_t
, &, *, ~)

533 #iâdeà
CK_F_PR_BTS_PTR


534 
	#CK_F_PR_BTS_PTR


	)

535 
CK_PR_BTX
(
bts
, 
±r
, , 
ušŒ_t
, |, *,)

540 #ià
defšed
(
CK_F_PR_LOAD_64
è&& defšed(
CK_F_PR_CAS_64_VALUE
)

542 #iâdeà
CK_F_PR_BTC_64


543 
	#CK_F_PR_BTC_64


	)

544 
CK_PR_BTX_S
(
btc
, 64, 
ušt64_t
, ^,)

547 #iâdeà
CK_F_PR_BTR_64


548 
	#CK_F_PR_BTR_64


	)

549 
CK_PR_BTX_S
(
bŒ
, 64, 
ušt64_t
, &, ~)

552 #iâdeà
CK_F_PR_BTS_64


553 
	#CK_F_PR_BTS_64


	)

554 
CK_PR_BTX_S
(
bts
, 64, 
ušt64_t
, |,)

559 #ià
defšed
(
CK_F_PR_LOAD_32
è&& defšed(
CK_F_PR_CAS_32_VALUE
)

561 #iâdeà
CK_F_PR_BTC_32


562 
	#CK_F_PR_BTC_32


	)

563 
CK_PR_BTX_S
(
btc
, 32, 
ušt32_t
, ^,)

566 #iâdeà
CK_F_PR_BTR_32


567 
	#CK_F_PR_BTR_32


	)

568 
CK_PR_BTX_S
(
bŒ
, 32, 
ušt32_t
, &, ~)

571 #iâdeà
CK_F_PR_BTS_32


572 
	#CK_F_PR_BTS_32


	)

573 
CK_PR_BTX_S
(
bts
, 32, 
ušt32_t
, |,)

578 #ià
defšed
(
CK_F_PR_LOAD_16
è&& defšed(
CK_F_PR_CAS_16_VALUE
)

580 #iâdeà
CK_F_PR_BTC_16


581 
	#CK_F_PR_BTC_16


	)

582 
CK_PR_BTX_S
(
btc
, 16, 
ušt16_t
, ^,)

585 #iâdeà
CK_F_PR_BTR_16


586 
	#CK_F_PR_BTR_16


	)

587 
CK_PR_BTX_S
(
bŒ
, 16, 
ušt16_t
, &, ~)

590 #iâdeà
CK_F_PR_BTS_16


591 
	#CK_F_PR_BTS_16


	)

592 
CK_PR_BTX_S
(
bts
, 16, 
ušt16_t
, |,)

597 #undeà
CK_PR_BTX_S


598 #undeà
CK_PR_BTX


600 
	#CK_PR_UNARY
(
K
, 
X
, 
S
, 
M
, 
T
) \

601 
CK_CC_INLINE
 \

602 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
) \

604 
ck_´_
##
X
##
_
##
	`S
(
rg‘
, (
T
)1); \

606 }

	)

608 
	#CK_PR_UNARY_Z
(
K
, 
S
, 
M
, 
T
, 
P
, 
C
, 
Z
) \

609 
CK_CC_INLINE
 \

610 
ck_´_
##
K
##
_
##
S
##
	`_z”o
(
M
 *
rg‘
, 
boŞ
 *
z”o
) \

612 
T
 
´evious
; \

613 
C
 
puÁ
; \

614 
puÁ
 = (
C
)
ck_´_md_lßd_
##
	`S
(
rg‘
); \

615 
´evious
 = (
T
)
puÁ
; \

616 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, \

617 (
C
)
´evious
, \

618 (
C
)(
´evious
 
P
 1), \

619 &
´evious
è=ğ
çl£
) \

620 
	`ck_´_¡®l
(); \

621 *
z”o
 = 
´evious
 =ğ(
T
)
Z
; \

623 }

	)

625 
	#CK_PR_UNARY_S
(
K
, 
X
, 
S
, 
M
è
	`CK_PR_UNARY
(K, X, S, M, M)

	)

626 
	#CK_PR_UNARY_Z_S
(
K
, 
S
, 
M
, 
P
, 
Z
è
	`CK_PR_UNARY_Z
(K, S, M, M, P, M, Z)

	)

628 #ià
defšed
(
CK_F_PR_LOAD_CHAR
è&& defšed(
CK_F_PR_CAS_CHAR_VALUE
)

630 #iâdeà
CK_F_PR_INC_CHAR


631 
	#CK_F_PR_INC_CHAR


	)

632 
	$CK_PR_UNARY_S
(
šc
, 
add
, , )

635 #iâdeà
CK_F_PR_INC_CHAR_ZERO


636 
	#CK_F_PR_INC_CHAR_ZERO


	)

637 
	`CK_PR_UNARY_Z_S
(
šc
, , , +, -1)

640 #iâdeà
CK_F_PR_DEC_CHAR


641 
	#CK_F_PR_DEC_CHAR


	)

642 
	$CK_PR_UNARY_S
(
dec
, 
sub
, , )

645 #iâdeà
CK_F_PR_DEC_CHAR_ZERO


646 
	#CK_F_PR_DEC_CHAR_ZERO


	)

647 
	`CK_PR_UNARY_Z_S
(
dec
, , , -, 1)

652 #ià
	`defšed
(
CK_F_PR_LOAD_INT
è&& defšed(
CK_F_PR_CAS_INT_VALUE
)

654 #iâdeà
CK_F_PR_INC_INT


655 
	#CK_F_PR_INC_INT


	)

656 
	$CK_PR_UNARY_S
(
šc
, 
add
, , )

659 #iâdeà
CK_F_PR_INC_INT_ZERO


660 
	#CK_F_PR_INC_INT_ZERO


	)

661 
	`CK_PR_UNARY_Z_S
(
šc
, , , +, -1)

664 #iâdeà
CK_F_PR_DEC_INT


665 
	#CK_F_PR_DEC_INT


	)

666 
	$CK_PR_UNARY_S
(
dec
, 
sub
, , )

669 #iâdeà
CK_F_PR_DEC_INT_ZERO


670 
	#CK_F_PR_DEC_INT_ZERO


	)

671 
	`CK_PR_UNARY_Z_S
(
dec
, , , -, 1)

676 #ià
	`defšed
(
CK_F_PR_LOAD_DOUBLE
è&& defšed(
CK_F_PR_CAS_DOUBLE_VALUE
)

678 #iâdeà
CK_F_PR_INC_DOUBLE


679 
	#CK_F_PR_INC_DOUBLE


	)

680 
	$CK_PR_UNARY_S
(
šc
, 
add
, , )

683 #iâdeà
CK_F_PR_DEC_DOUBLE


684 
	#CK_F_PR_DEC_DOUBLE


	)

685 
	$CK_PR_UNARY_S
(
dec
, 
sub
, , )

690 #ià
	`defšed
(
CK_F_PR_LOAD_UINT
è&& defšed(
CK_F_PR_CAS_UINT_VALUE
)

692 #iâdeà
CK_F_PR_INC_UINT


693 
	#CK_F_PR_INC_UINT


	)

694 
	$CK_PR_UNARY_S
(
šc
, 
add
, 
ušt
, )

697 #iâdeà
CK_F_PR_INC_UINT_ZERO


698 
	#CK_F_PR_INC_UINT_ZERO


	)

699 
	`CK_PR_UNARY_Z_S
(
šc
, 
ušt
, , +, 
UINT_MAX
)

702 #iâdeà
CK_F_PR_DEC_UINT


703 
	#CK_F_PR_DEC_UINT


	)

704 
	$CK_PR_UNARY_S
(
dec
, 
sub
, 
ušt
, )

707 #iâdeà
CK_F_PR_DEC_UINT_ZERO


708 
	#CK_F_PR_DEC_UINT_ZERO


	)

709 
	`CK_PR_UNARY_Z_S
(
dec
, 
ušt
, , -, 1)

714 #ià
	`defšed
(
CK_F_PR_LOAD_PTR
è&& defšed(
CK_F_PR_CAS_PTR_VALUE
)

716 #iâdeà
CK_F_PR_INC_PTR


717 
	#CK_F_PR_INC_PTR


	)

718 
	$CK_PR_UNARY
(
šc
, 
add
, 
±r
, , 
ušŒ_t
)

721 #iâdeà
CK_F_PR_INC_PTR_ZERO


722 
	#CK_F_PR_INC_PTR_ZERO


	)

723 
	`CK_PR_UNARY_Z
(
šc
, 
±r
, , 
ušŒ_t
, +, *, 
UINT_MAX
)

726 #iâdeà
CK_F_PR_DEC_PTR


727 
	#CK_F_PR_DEC_PTR


	)

728 
	$CK_PR_UNARY
(
dec
, 
sub
, 
±r
, , 
ušŒ_t
)

731 #iâdeà
CK_F_PR_DEC_PTR_ZERO


732 
	#CK_F_PR_DEC_PTR_ZERO


	)

733 
	`CK_PR_UNARY_Z
(
dec
, 
±r
, , 
ušŒ_t
, -, *, 1)

738 #ià
	`defšed
(
CK_F_PR_LOAD_64
è&& defšed(
CK_F_PR_CAS_64_VALUE
)

740 #iâdeà
CK_F_PR_INC_64


741 
	#CK_F_PR_INC_64


	)

742 
	$CK_PR_UNARY_S
(
šc
, 
add
, 64, 
ušt64_t
)

745 #iâdeà
CK_F_PR_INC_64_ZERO


746 
	#CK_F_PR_INC_64_ZERO


	)

747 
	`CK_PR_UNARY_Z_S
(
šc
, 64, 
ušt64_t
, +, 
UINT64_MAX
)

750 #iâdeà
CK_F_PR_DEC_64


751 
	#CK_F_PR_DEC_64


	)

752 
	$CK_PR_UNARY_S
(
dec
, 
sub
, 64, 
ušt64_t
)

755 #iâdeà
CK_F_PR_DEC_64_ZERO


756 
	#CK_F_PR_DEC_64_ZERO


	)

757 
	`CK_PR_UNARY_Z_S
(
dec
, 64, 
ušt64_t
, -, 1)

762 #ià
	`defšed
(
CK_F_PR_LOAD_32
è&& defšed(
CK_F_PR_CAS_32_VALUE
)

764 #iâdeà
CK_F_PR_INC_32


765 
	#CK_F_PR_INC_32


	)

766 
	$CK_PR_UNARY_S
(
šc
, 
add
, 32, 
ušt32_t
)

769 #iâdeà
CK_F_PR_INC_32_ZERO


770 
	#CK_F_PR_INC_32_ZERO


	)

771 
	`CK_PR_UNARY_Z_S
(
šc
, 32, 
ušt32_t
, +, 
UINT32_MAX
)

774 #iâdeà
CK_F_PR_DEC_32


775 
	#CK_F_PR_DEC_32


	)

776 
	$CK_PR_UNARY_S
(
dec
, 
sub
, 32, 
ušt32_t
)

779 #iâdeà
CK_F_PR_DEC_32_ZERO


780 
	#CK_F_PR_DEC_32_ZERO


	)

781 
	`CK_PR_UNARY_Z_S
(
dec
, 32, 
ušt32_t
, -, 1)

786 #ià
	`defšed
(
CK_F_PR_LOAD_16
è&& defšed(
CK_F_PR_CAS_16_VALUE
)

788 #iâdeà
CK_F_PR_INC_16


789 
	#CK_F_PR_INC_16


	)

790 
	$CK_PR_UNARY_S
(
šc
, 
add
, 16, 
ušt16_t
)

793 #iâdeà
CK_F_PR_INC_16_ZERO


794 
	#CK_F_PR_INC_16_ZERO


	)

795 
	`CK_PR_UNARY_Z_S
(
šc
, 16, 
ušt16_t
, +, 
UINT16_MAX
)

798 #iâdeà
CK_F_PR_DEC_16


799 
	#CK_F_PR_DEC_16


	)

800 
	$CK_PR_UNARY_S
(
dec
, 
sub
, 16, 
ušt16_t
)

803 #iâdeà
CK_F_PR_DEC_16_ZERO


804 
	#CK_F_PR_DEC_16_ZERO


	)

805 
	`CK_PR_UNARY_Z_S
(
dec
, 16, 
ušt16_t
, -, 1)

810 #ià
	`defšed
(
CK_F_PR_LOAD_8
è&& defšed(
CK_F_PR_CAS_8_VALUE
)

812 #iâdeà
CK_F_PR_INC_8


813 
	#CK_F_PR_INC_8


	)

814 
	$CK_PR_UNARY_S
(
šc
, 
add
, 8, 
ušt8_t
)

817 #iâdeà
CK_F_PR_INC_8_ZERO


818 
	#CK_F_PR_INC_8_ZERO


	)

819 
	`CK_PR_UNARY_Z_S
(
šc
, 8, 
ušt8_t
, +, 
UINT8_MAX
)

822 #iâdeà
CK_F_PR_DEC_8


823 
	#CK_F_PR_DEC_8


	)

824 
	$CK_PR_UNARY_S
(
dec
, 
sub
, 8, 
ušt8_t
)

827 #iâdeà
CK_F_PR_DEC_8_ZERO


828 
	#CK_F_PR_DEC_8_ZERO


	)

829 
	`CK_PR_UNARY_Z_S
(
dec
, 8, 
ušt8_t
, -, 1)

834 #undeà
CK_PR_UNARY_Z_S


835 #undeà
CK_PR_UNARY_S


836 #undeà
CK_PR_UNARY_Z


837 #undeà
CK_PR_UNARY


839 
	#CK_PR_N
(
K
, 
S
, 
M
, 
T
, 
P
, 
C
) \

840 
CK_CC_INLINE
 \

841 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
) \

843 
T
 
´evious
; \

844 
C
 
puÁ
; \

845 
puÁ
 = (
C
)
ck_´_md_lßd_
##
	`S
(
rg‘
); \

846 
´evious
 = (
T
)
puÁ
; \

847 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, \

848 (
C
)
´evious
, \

849 (
C
)(
P
 
´evious
), \

850 &
´evious
è=ğ
çl£
) \

851 
	`ck_´_¡®l
(); \

854 
	}

	)
}

856 
	#CK_PR_N_Z
(
S
, 
M
, 
T
, 
C
) \

857 
CK_CC_INLINE
 \

858 
ck_´_Ãg_
##
S
##
	`_z”o
(
M
 *
rg‘
, 
boŞ
 *
z”o
) \

860 
T
 
´evious
; \

861 
C
 
puÁ
; \

862 
puÁ
 = (
C
)
ck_´_md_lßd_
##
	`S
(
rg‘
); \

863 
´evious
 = (
T
)
puÁ
; \

864 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, \

865 (
C
)
´evious
, \

866 (
C
)(-
´evious
), \

867 &
´evious
è=ğ
çl£
) \

868 
	`ck_´_¡®l
(); \

870 *
z”o
 = 
´evious
 == 0; \

872 }

	)

874 
	#CK_PR_N_S
(
K
, 
S
, 
M
, 
P
è
	`CK_PR_N
(K, S, M, M, P, M)

	)

875 
	#CK_PR_N_Z_S
(
S
, 
M
è
	`CK_PR_N_Z
(S, M, M, M)

	)

877 #ià
defšed
(
CK_F_PR_LOAD_CHAR
è&& defšed(
CK_F_PR_CAS_CHAR_VALUE
)

879 #iâdeà
CK_F_PR_NOT_CHAR


880 
	#CK_F_PR_NOT_CHAR


	)

881 
CK_PR_N_S
(
nÙ
, , , ~)

884 #iâdeà
CK_F_PR_NEG_CHAR


885 
	#CK_F_PR_NEG_CHAR


	)

886 
CK_PR_N_S
(
Ãg
, , , -)

889 #iâdeà
CK_F_PR_NEG_CHAR_ZERO


890 
	#CK_F_PR_NEG_CHAR_ZERO


	)

891 
	$CK_PR_N_Z_S
(, )

896 #ià
	`defšed
(
CK_F_PR_LOAD_INT
è&& defšed(
CK_F_PR_CAS_INT_VALUE
)

898 #iâdeà
CK_F_PR_NOT_INT


899 
	#CK_F_PR_NOT_INT


	)

900 
	`CK_PR_N_S
(
nÙ
, , , ~)

903 #iâdeà
CK_F_PR_NEG_INT


904 
	#CK_F_PR_NEG_INT


	)

905 
	`CK_PR_N_S
(
Ãg
, , , -)

908 #iâdeà
CK_F_PR_NEG_INT_ZERO


909 
	#CK_F_PR_NEG_INT_ZERO


	)

910 
	$CK_PR_N_Z_S
(, )

915 #ià
	`defšed
(
CK_F_PR_LOAD_DOUBLE
è&& defšed(
CK_F_PR_CAS_DOUBLE_VALUE
)

917 #iâdeà
CK_F_PR_NEG_DOUBLE


918 
	#CK_F_PR_NEG_DOUBLE


	)

919 
	`CK_PR_N_S
(
Ãg
, , , -)

924 #ià
	`defšed
(
CK_F_PR_LOAD_UINT
è&& defšed(
CK_F_PR_CAS_UINT_VALUE
)

926 #iâdeà
CK_F_PR_NOT_UINT


927 
	#CK_F_PR_NOT_UINT


	)

928 
	`CK_PR_N_S
(
nÙ
, 
ušt
, , ~)

931 #iâdeà
CK_F_PR_NEG_UINT


932 
	#CK_F_PR_NEG_UINT


	)

933 
	`CK_PR_N_S
(
Ãg
, 
ušt
, , -)

936 #iâdeà
CK_F_PR_NEG_UINT_ZERO


937 
	#CK_F_PR_NEG_UINT_ZERO


	)

938 
	$CK_PR_N_Z_S
(
ušt
, )

943 #ià
	`defšed
(
CK_F_PR_LOAD_PTR
è&& defšed(
CK_F_PR_CAS_PTR_VALUE
)

945 #iâdeà
CK_F_PR_NOT_PTR


946 
	#CK_F_PR_NOT_PTR


	)

947 
	`CK_PR_N
(
nÙ
, 
±r
, , 
ušŒ_t
, ~, *)

950 #iâdeà
CK_F_PR_NEG_PTR


951 
	#CK_F_PR_NEG_PTR


	)

952 
	`CK_PR_N
(
Ãg
, 
±r
, , 
ušŒ_t
, -, *)

955 #iâdeà
CK_F_PR_NEG_PTR_ZERO


956 
	#CK_F_PR_NEG_PTR_ZERO


	)

957 
	$CK_PR_N_Z
(
±r
, , 
ušŒ_t
, *)

962 #ià
	`defšed
(
CK_F_PR_LOAD_64
è&& defšed(
CK_F_PR_CAS_64_VALUE
)

964 #iâdeà
CK_F_PR_NOT_64


965 
	#CK_F_PR_NOT_64


	)

966 
	`CK_PR_N_S
(
nÙ
, 64, 
ušt64_t
, ~)

969 #iâdeà
CK_F_PR_NEG_64


970 
	#CK_F_PR_NEG_64


	)

971 
	`CK_PR_N_S
(
Ãg
, 64, 
ušt64_t
, -)

974 #iâdeà
CK_F_PR_NEG_64_ZERO


975 
	#CK_F_PR_NEG_64_ZERO


	)

976 
	$CK_PR_N_Z_S
(64, 
ušt64_t
)

981 #ià
	`defšed
(
CK_F_PR_LOAD_32
è&& defšed(
CK_F_PR_CAS_32_VALUE
)

983 #iâdeà
CK_F_PR_NOT_32


984 
	#CK_F_PR_NOT_32


	)

985 
	`CK_PR_N_S
(
nÙ
, 32, 
ušt32_t
, ~)

988 #iâdeà
CK_F_PR_NEG_32


989 
	#CK_F_PR_NEG_32


	)

990 
	`CK_PR_N_S
(
Ãg
, 32, 
ušt32_t
, -)

993 #iâdeà
CK_F_PR_NEG_32_ZERO


994 
	#CK_F_PR_NEG_32_ZERO


	)

995 
	$CK_PR_N_Z_S
(32, 
ušt32_t
)

1000 #ià
	`defšed
(
CK_F_PR_LOAD_16
è&& defšed(
CK_F_PR_CAS_16_VALUE
)

1002 #iâdeà
CK_F_PR_NOT_16


1003 
	#CK_F_PR_NOT_16


	)

1004 
	`CK_PR_N_S
(
nÙ
, 16, 
ušt16_t
, ~)

1007 #iâdeà
CK_F_PR_NEG_16


1008 
	#CK_F_PR_NEG_16


	)

1009 
	`CK_PR_N_S
(
Ãg
, 16, 
ušt16_t
, -)

1012 #iâdeà
CK_F_PR_NEG_16_ZERO


1013 
	#CK_F_PR_NEG_16_ZERO


	)

1014 
	$CK_PR_N_Z_S
(16, 
ušt16_t
)

1019 #ià
	`defšed
(
CK_F_PR_LOAD_8
è&& defšed(
CK_F_PR_CAS_8_VALUE
)

1021 #iâdeà
CK_F_PR_NOT_8


1022 
	#CK_F_PR_NOT_8


	)

1023 
	`CK_PR_N_S
(
nÙ
, 8, 
ušt8_t
, ~)

1026 #iâdeà
CK_F_PR_NEG_8


1027 
	#CK_F_PR_NEG_8


	)

1028 
	`CK_PR_N_S
(
Ãg
, 8, 
ušt8_t
, -)

1031 #iâdeà
CK_F_PR_NEG_8_ZERO


1032 
	#CK_F_PR_NEG_8_ZERO


	)

1033 
	$CK_PR_N_Z_S
(8, 
ušt8_t
)

1038 #undeà
CK_PR_N_Z_S


1039 #undeà
CK_PR_N_S


1040 #undeà
CK_PR_N_Z


1041 #undeà
CK_PR_N


1043 
	#CK_PR_FAA
(
S
, 
M
, 
T
, 
C
) \

1044 
CK_CC_INLINE
 
C
 \

1045 
ck_´_ça_
##
	`S
(
M
 *
rg‘
, 
T
 
d–
) \

1047 
T
 
´evious
; \

1048 
C
 
puÁ
; \

1049 
puÁ
 = (
C
)
ck_´_md_lßd_
##
	`S
(
rg‘
); \

1050 
´evious
 = (
T
)
puÁ
; \

1051 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, \

1052 (
C
)
´evious
, \

1053 (
C
)(
´evious
 + 
d–
), \

1054 &
´evious
è=ğ
çl£
) \

1055 
	`ck_´_¡®l
(); \

1057  ((
C
)
´evious
); \

1058 
	}

	)
}

1060 
	#CK_PR_FAS
(
S
, 
M
, 
C
) \

1061 
CK_CC_INLINE
 
C
 \

1062 
ck_´_çs_
##
	`S
(
M
 *
rg‘
, 
C
 
upd©e
) \

1064 
C
 
´evious
; \

1065 
´evious
 = 
ck_´_md_lßd_
##
	`S
(
rg‘
); \

1066 
ck_´_ÿs_
##
S
##
	`_v®ue
(
rg‘
, \

1067 
´evious
, \

1068 
upd©e
, \

1069 &
´evious
è=ğ
çl£
) \

1070 
	`ck_´_¡®l
(); \

1072  (
´evious
); \

1073 }

	)

1075 
	#CK_PR_FAA_S
(
S
, 
M
è
	`CK_PR_FAA
(S, M, M, M)

	)

1076 
	#CK_PR_FAS_S
(
S
, 
M
è
	`CK_PR_FAS
(S, M, M)

	)

1078 #ià
defšed
(
CK_F_PR_LOAD_CHAR
è&& defšed(
CK_F_PR_CAS_CHAR_VALUE
)

1080 #iâdeà
CK_F_PR_FAA_CHAR


1081 
	#CK_F_PR_FAA_CHAR


	)

1082 
	$CK_PR_FAA_S
(, )

1085 #iâdeà
CK_F_PR_FAS_CHAR


1086 
	#CK_F_PR_FAS_CHAR


	)

1087 
	$CK_PR_FAS_S
(, )

1092 #ià
	`defšed
(
CK_F_PR_LOAD_INT
è&& defšed(
CK_F_PR_CAS_INT_VALUE
)

1094 #iâdeà
CK_F_PR_FAA_INT


1095 
	#CK_F_PR_FAA_INT


	)

1096 
	$CK_PR_FAA_S
(, )

1099 #iâdeà
CK_F_PR_FAS_INT


1100 
	#CK_F_PR_FAS_INT


	)

1101 
	$CK_PR_FAS_S
(, )

1106 #ià
	`defšed
(
CK_F_PR_LOAD_DOUBLE
è&& defšed(
CK_F_PR_CAS_DOUBLE_VALUE
)

1108 #iâdeà
CK_F_PR_FAA_DOUBLE


1109 
	#CK_F_PR_FAA_DOUBLE


	)

1110 
	$CK_PR_FAA_S
(, )

1113 #iâdeà
CK_F_PR_FAS_DOUBLE


1114 
	#CK_F_PR_FAS_DOUBLE


	)

1115 
	$CK_PR_FAS_S
(, )

1120 #ià
	`defšed
(
CK_F_PR_LOAD_UINT
è&& defšed(
CK_F_PR_CAS_UINT_VALUE
)

1122 #iâdeà
CK_F_PR_FAA_UINT


1123 
	#CK_F_PR_FAA_UINT


	)

1124 
	$CK_PR_FAA_S
(
ušt
, )

1127 #iâdeà
CK_F_PR_FAS_UINT


1128 
	#CK_F_PR_FAS_UINT


	)

1129 
	$CK_PR_FAS_S
(
ušt
, )

1134 #ià
	`defšed
(
CK_F_PR_LOAD_PTR
è&& defšed(
CK_F_PR_CAS_PTR_VALUE
)

1136 #iâdeà
CK_F_PR_FAA_PTR


1137 
	#CK_F_PR_FAA_PTR


	)

1138 
	$CK_PR_FAA
(
±r
, , 
ušŒ_t
, *)

1141 #iâdeà
CK_F_PR_FAS_PTR


1142 
	#CK_F_PR_FAS_PTR


	)

1143 
	$CK_PR_FAS
(
±r
, , *)

1148 #ià
	`defšed
(
CK_F_PR_LOAD_64
è&& defšed(
CK_F_PR_CAS_64_VALUE
)

1150 #iâdeà
CK_F_PR_FAA_64


1151 
	#CK_F_PR_FAA_64


	)

1152 
	$CK_PR_FAA_S
(64, 
ušt64_t
)

1155 #iâdeà
CK_F_PR_FAS_64


1156 
	#CK_F_PR_FAS_64


	)

1157 
	$CK_PR_FAS_S
(64, 
ušt64_t
)

1162 #ià
	`defšed
(
CK_F_PR_LOAD_32
è&& defšed(
CK_F_PR_CAS_32_VALUE
)

1164 #iâdeà
CK_F_PR_FAA_32


1165 
	#CK_F_PR_FAA_32


	)

1166 
	$CK_PR_FAA_S
(32, 
ušt32_t
)

1169 #iâdeà
CK_F_PR_FAS_32


1170 
	#CK_F_PR_FAS_32


	)

1171 
	$CK_PR_FAS_S
(32, 
ušt32_t
)

1176 #ià
	`defšed
(
CK_F_PR_LOAD_16
è&& defšed(
CK_F_PR_CAS_16_VALUE
)

1178 #iâdeà
CK_F_PR_FAA_16


1179 
	#CK_F_PR_FAA_16


	)

1180 
	$CK_PR_FAA_S
(16, 
ušt16_t
)

1183 #iâdeà
CK_F_PR_FAS_16


1184 
	#CK_F_PR_FAS_16


	)

1185 
	$CK_PR_FAS_S
(16, 
ušt16_t
)

1190 #ià
	`defšed
(
CK_F_PR_LOAD_8
è&& defšed(
CK_F_PR_CAS_8_VALUE
)

1192 #iâdeà
CK_F_PR_FAA_8


1193 
	#CK_F_PR_FAA_8


	)

1194 
	$CK_PR_FAA_S
(8, 
ušt8_t
)

1197 #iâdeà
CK_F_PR_FAS_8


1198 
	#CK_F_PR_FAS_8


	)

1199 
	$CK_PR_FAS_S
(8, 
ušt8_t
)

1204 #undeà
CK_PR_FAA_S


1205 #undeà
CK_PR_FAS_S


1206 #undeà
CK_PR_FAA


1207 #undeà
CK_PR_FAS


	@application/kvbench/include/aerospike/ck/ck_queue.h

59 #iâdeà
CK_QUEUE_H


60 
	#CK_QUEUE_H


	)

62 
	~<«ro¥ike/ck/ck_´.h
>

126 
	#CK_SLIST_HEAD
(
Çme
, 
ty³
) \

127 
	sÇme
 { \

128 
ty³
 *
¦h_fœ¡
; \

129 }

	)

131 
	#CK_SLIST_HEAD_INITIALIZER
(
h—d
) \

132 { 
NULL
 }

	)

134 
	#CK_SLIST_ENTRY
(
ty³
) \

136 
ty³
 *
¦e_Ãxt
; \

137 }

	)

142 
	#CK_SLIST_EMPTY
(
h—d
) \

143 (
	`ck_´_lßd_±r
(&(
h—d
)->
¦h_fœ¡
è=ğ
NULL
)

	)

145 
	#CK_SLIST_FIRST
(
h—d
) \

146 (
	`ck_´_lßd_±r
(&(
h—d
)->
¦h_fœ¡
))

	)

148 
	#CK_SLIST_NEXT
(
–m
, 
f›ld
) \

149 
	`ck_´_lßd_±r
(&((
–m
)->
f›ld
.
¦e_Ãxt
))

	)

151 
	#CK_SLIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

152 (
v¬
èğ
	`CK_SLIST_FIRST
((
h—d
)); \

153 (
v¬
è&& (
	`ck_´_ãnû_lßd
(), 1); \

154 (
v¬
èğ
	`CK_SLIST_NEXT
((v¬), 
f›ld
))

	)

156 
	#CK_SLIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

157 (
v¬
èğ
	`CK_SLIST_FIRST
(
h—d
); \

158 (
v¬
è&& (
	`ck_´_ãnû_lßd
(), (
tv¬
èğ
	`CK_SLIST_NEXT
(v¬, 
f›ld
), 1);\

159 (
v¬
èğ(
tv¬
))

	)

161 
	#CK_SLIST_FOREACH_PREVPTR
(
v¬
, 
v¬p
, 
h—d
, 
f›ld
) \

162 (
v¬p
èğ&(
h—d
)->
¦h_fœ¡
; \

163 ((
v¬
èğ
	`ck_´_lßd_±r
(
v¬p
)è!ğ
NULL
 && (
	`ck_´_ãnû_lßd
(), 1); \

164 (
v¬p
èğ&(
v¬
)->
f›ld
.
¦e_Ãxt
)

	)

166 
	#CK_SLIST_INIT
(
h—d
) do { \

167 
	`ck_´_¡Üe_±r
(&(
h—d
)->
¦h_fœ¡
, 
NULL
); \

168 
	`ck_´_ãnû_¡Üe
(); \

169 } 0)

	)

171 
	#CK_SLIST_INSERT_AFTER
(
a
, 
b
, 
f›ld
) do { \

172 (
b
)->
f›ld
.
¦e_Ãxt
 = (
a
)->field.sle_next; \

173 
	`ck_´_ãnû_¡Üe
(); \

174 
	`ck_´_¡Üe_±r
(&(
a
)->
f›ld
.
¦e_Ãxt
, 
b
); \

175 } 0)

	)

177 
	#CK_SLIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

178 (
–m
)->
f›ld
.
¦e_Ãxt
 = (
h—d
)->
¦h_fœ¡
; \

179 
	`ck_´_ãnû_¡Üe
(); \

180 
	`ck_´_¡Üe_±r
(&(
h—d
)->
¦h_fœ¡
, 
–m
); \

181 } 0)

	)

183 
	#CK_SLIST_REMOVE_AFTER
(
–m
, 
f›ld
) do { \

184 
	`ck_´_¡Üe_±r
(&(
–m
)->
f›ld
.
¦e_Ãxt
, \

185 (
–m
)->
f›ld
.
¦e_Ãxt
->field.sle_next); \

186 } 0)

	)

188 
	#CK_SLIST_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

189 ià((
h—d
)->
¦h_fœ¡
 =ğ(
–m
)) { \

190 
	`CK_SLIST_REMOVE_HEAD
((
h—d
), 
f›ld
); \

192 
ty³
 *
cu»lm
 = (
h—d
)->
¦h_fœ¡
; \

193 
cu»lm
->
f›ld
.
¦e_Ãxt
 !ğ(
–m
)) \

194 
cu»lm
 = cu»lm->
f›ld
.
¦e_Ãxt
; \

195 
	`CK_SLIST_REMOVE_AFTER
(
cu»lm
, 
f›ld
); \

197 } 0)

	)

199 
	#CK_SLIST_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

200 
	`ck_´_¡Üe_±r
(&(
h—d
)->
¦h_fœ¡
, \

201 (
h—d
)->
¦h_fœ¡
->
f›ld
.
¦e_Ãxt
); \

202 } 0)

	)

204 
	#CK_SLIST_MOVE
(
h—d1
, 
h—d2
, 
f›ld
) do { \

205 
	`ck_´_¡Üe_±r
(&(
h—d1
)->
¦h_fœ¡
, (
h—d2
)->slh_first); \

206 } 0)

	)

211 
	#CK_SLIST_SWAP
(
a
, 
b
, 
ty³
) do { \

212 
ty³
 *
sw­_fœ¡
 = (
a
)->
¦h_fœ¡
; \

213 (
a
)->
¦h_fœ¡
 = (
b
)->slh_first; \

214 (
b
)->
¦h_fœ¡
 = 
sw­_fœ¡
; \

215 } 0)

	)

220 
	#CK_STAILQ_HEAD
(
Çme
, 
ty³
) \

221 
	sÇme
 { \

222 
ty³
 *
¡qh_fœ¡
; \

223 
ty³
 **
¡qh_Ï¡
; \

224 }

	)

226 
	#CK_STAILQ_HEAD_INITIALIZER
(
h—d
) \

227 { 
NULL
, &(
h—d
).
¡qh_fœ¡
 }

	)

229 
	#CK_STAILQ_ENTRY
(
ty³
) \

231 
ty³
 *
¡qe_Ãxt
; \

232 }

	)

237 
	#CK_STAILQ_CONCAT
(
h—d1
, 
h—d2
) do { \

238 ià((
h—d2
)->
¡qh_fœ¡
 =ğ
NULL
) { \

239 
	`ck_´_¡Üe_±r
((
h—d1
)->
¡qh_Ï¡
, (
h—d2
)->
¡qh_fœ¡
); \

240 
	`ck_´_ãnû_¡Üe
(); \

241 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

242 
	`CK_STAILQ_INIT
((
h—d2
)); \

244 } 0)

	)

246 
	#CK_STAILQ_EMPTY
(
h—d
è(
	`ck_´_lßd_±r
(&(h—d)->
¡qh_fœ¡
è=ğ
NULL
)

	)

248 
	#CK_STAILQ_FIRST
(
h—d
è(
	`ck_´_lßd_±r
(&(h—d)->
¡qh_fœ¡
))

	)

250 
	#CK_STAILQ_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

251 (
v¬
èğ
	`CK_STAILQ_FIRST
((
h—d
)); \

252 (
v¬
è&& (
	`ck_´_ãnû_lßd
(), 1); \

253 (
v¬
èğ
	`CK_STAILQ_NEXT
((v¬), 
f›ld
))

	)

255 
	#CK_STAILQ_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

256 (
v¬
èğ
	`CK_STAILQ_FIRST
((
h—d
)); \

257 (
v¬
è&& (
	`ck_´_ãnû_lßd
(), (
tv¬
) = \

258 
	`CK_STAILQ_NEXT
((
v¬
), 
f›ld
), 1); \

259 (
v¬
èğ(
tv¬
))

	)

261 
	#CK_STAILQ_INIT
(
h—d
) do { \

262 
	`ck_´_¡Üe_±r
(&(
h—d
)->
¡qh_fœ¡
, 
NULL
); \

263 
	`ck_´_ãnû_¡Üe
(); \

264 (
h—d
)->
¡qh_Ï¡
 = &(h—d)->
¡qh_fœ¡
; \

265 } 0)

	)

267 
	#CK_STAILQ_INSERT_AFTER
(
h—d
, 
tq–m
, 
–m
, 
f›ld
) do { \

268 (
–m
)->
f›ld
.
¡qe_Ãxt
 = (
tq–m
)->field.stqe_next; \

269 
	`ck_´_ãnû_¡Üe
(); \

270 
	`ck_´_¡Üe_±r
(&(
tq–m
)->
f›ld
.
¡qe_Ãxt
, 
–m
); \

271 ià((
–m
)->
f›ld
.
¡qe_Ãxt
 =ğ
NULL
) \

272 (
h—d
)->
¡qh_Ï¡
 = &(
–m
)->
f›ld
.
¡qe_Ãxt
; \

273 } 0)

	)

275 
	#CK_STAILQ_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

276 (
–m
)->
f›ld
.
¡qe_Ãxt
 = (
h—d
)->
¡qh_fœ¡
; \

277 
	`ck_´_ãnû_¡Üe
(); \

278 
	`ck_´_¡Üe_±r
(&(
h—d
)->
¡qh_fœ¡
, 
–m
); \

279 ià((
–m
)->
f›ld
.
¡qe_Ãxt
 =ğ
NULL
) \

280 (
h—d
)->
¡qh_Ï¡
 = &(
–m
)->
f›ld
.
¡qe_Ãxt
; \

281 } 0)

	)

283 
	#CK_STAILQ_INSERT_TAIL
(
h—d
, 
–m
, 
f›ld
) do { \

284 (
–m
)->
f›ld
.
¡qe_Ãxt
 = 
NULL
; \

285 
	`ck_´_ãnû_¡Üe
(); \

286 
	`ck_´_¡Üe_±r
((
h—d
)->
¡qh_Ï¡
, (
–m
)); \

287 (
h—d
)->
¡qh_Ï¡
 = &(
–m
)->
f›ld
.
¡qe_Ãxt
; \

288 } 0)

	)

290 
	#CK_STAILQ_NEXT
(
–m
, 
f›ld
) \

291 (
	`ck_´_lßd_±r
(&(
–m
)->
f›ld
.
¡qe_Ãxt
))

	)

293 
	#CK_STAILQ_REMOVE
(
h—d
, 
–m
, 
ty³
, 
f›ld
) do { \

294 ià((
h—d
)->
¡qh_fœ¡
 =ğ(
–m
)) { \

295 
	`CK_STAILQ_REMOVE_HEAD
((
h—d
), 
f›ld
); \

297 
ty³
 *
cu»lm
 = (
h—d
)->
¡qh_fœ¡
; \

298 
cu»lm
->
f›ld
.
¡qe_Ãxt
 !ğ(
–m
)) \

299 
cu»lm
 = cu»lm->
f›ld
.
¡qe_Ãxt
; \

300 
	`CK_STAILQ_REMOVE_AFTER
(
h—d
, 
cu»lm
, 
f›ld
); \

302 } 0)

	)

304 
	#CK_STAILQ_REMOVE_AFTER
(
h—d
, 
–m
, 
f›ld
) do { \

305 
	`ck_´_¡Üe_±r
(&(
–m
)->
f›ld
.
¡qe_Ãxt
, \

306 (
–m
)->
f›ld
.
¡qe_Ãxt
->field.stqe_next); \

307 ià((
–m
)->
f›ld
.
¡qe_Ãxt
 =ğ
NULL
) \

308 (
h—d
)->
¡qh_Ï¡
 = &(
–m
)->
f›ld
.
¡qe_Ãxt
; \

309 } 0)

	)

311 
	#CK_STAILQ_REMOVE_HEAD
(
h—d
, 
f›ld
) do { \

312 
	`ck_´_¡Üe_±r
(&(
h—d
)->
¡qh_fœ¡
, \

313 (
h—d
)->
¡qh_fœ¡
->
f›ld
.
¡qe_Ãxt
); \

314 ià((
h—d
)->
¡qh_fœ¡
 =ğ
NULL
) \

315 (
h—d
)->
¡qh_Ï¡
 = &(h—d)->
¡qh_fœ¡
; \

316 } 0)

	)

318 
	#CK_STAILQ_MOVE
(
h—d1
, 
h—d2
, 
f›ld
) do { \

319 
	`ck_´_¡Üe_±r
(&(
h—d1
)->
¡qh_fœ¡
, (
h—d2
)->stqh_first); \

320 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

321 ià((
h—d2
)->
¡qh_Ï¡
 =ğ&(h—d2)->
¡qh_fœ¡
) \

322 (
h—d1
)->
¡qh_Ï¡
 = &(h—d1)->
¡qh_fœ¡
; \

323 } 0)

	)

328 
	#CK_STAILQ_SWAP
(
h—d1
, 
h—d2
, 
ty³
) do { \

329 
ty³
 *
sw­_fœ¡
 = 
	`CK_STAILQ_FIRST
(
h—d1
); \

330 
ty³
 **
sw­_Ï¡
 = (
h—d1
)->
¡qh_Ï¡
; \

331 
	`CK_STAILQ_FIRST
(
h—d1
èğCK_STAILQ_FIRST(
h—d2
); \

332 (
h—d1
)->
¡qh_Ï¡
 = (
h—d2
)->stqh_last; \

333 
	`CK_STAILQ_FIRST
(
h—d2
èğ
sw­_fœ¡
; \

334 (
h—d2
)->
¡qh_Ï¡
 = 
sw­_Ï¡
; \

335 ià(
	`CK_STAILQ_EMPTY
(
h—d1
)) \

336 (
h—d1
)->
¡qh_Ï¡
 = &(h—d1)->
¡qh_fœ¡
; \

337 ià(
	`CK_STAILQ_EMPTY
(
h—d2
)) \

338 (
h—d2
)->
¡qh_Ï¡
 = &(h—d2)->
¡qh_fœ¡
; \

339 } 0)

	)

344 
	#CK_LIST_HEAD
(
Çme
, 
ty³
) \

345 
	sÇme
 { \

346 
ty³
 *
lh_fœ¡
; \

347 }

	)

349 
	#CK_LIST_HEAD_INITIALIZER
(
h—d
) \

350 { 
NULL
 }

	)

352 
	#CK_LIST_ENTRY
(
ty³
) \

354 
ty³
 *
Ë_Ãxt
; \

355 
ty³
 **
Ë_´ev
; \

356 }

	)

358 
	#CK_LIST_FIRST
(
h—d
è
	`ck_´_lßd_±r
(&(h—d)->
lh_fœ¡
)

	)

359 
	#CK_LIST_EMPTY
(
h—d
è(
	`CK_LIST_FIRST
(h—dè=ğ
NULL
)

	)

360 
	#CK_LIST_NEXT
(
–m
, 
f›ld
è
	`ck_´_lßd_±r
(&Ólm)->f›ld.
Ë_Ãxt
)

	)

362 
	#CK_LIST_FOREACH
(
v¬
, 
h—d
, 
f›ld
) \

363 (
v¬
èğ
	`CK_LIST_FIRST
((
h—d
)); \

364 (
v¬
è&& (
	`ck_´_ãnû_lßd
(), 1); \

365 (
v¬
èğ
	`CK_LIST_NEXT
((v¬), 
f›ld
))

	)

367 
	#CK_LIST_FOREACH_SAFE
(
v¬
, 
h—d
, 
f›ld
, 
tv¬
) \

368 (
v¬
èğ
	`CK_LIST_FIRST
((
h—d
)); \

369 (
v¬
è&& (
	`ck_´_ãnû_lßd
(), (
tv¬
èğ
	`CK_LIST_NEXT
((v¬), 
f›ld
), 1);\

370 (
v¬
èğ(
tv¬
))

	)

372 
	#CK_LIST_INIT
(
h—d
) do { \

373 
	`ck_´_¡Üe_±r
(&(
h—d
)->
lh_fœ¡
, 
NULL
); \

374 
	`ck_´_ãnû_¡Üe
(); \

375 } 0)

	)

377 
	#CK_LIST_INSERT_AFTER
(
li¡–m
, 
–m
, 
f›ld
) do { \

378 (
–m
)->
f›ld
.
Ë_Ãxt
 = (
li¡–m
)->field.le_next; \

379 (
–m
)->
f›ld
.
Ë_´ev
 = &(
li¡–m
)->f›ld.
Ë_Ãxt
; \

380 
	`ck_´_ãnû_¡Üe
(); \

381 ià((
li¡–m
)->
f›ld
.
Ë_Ãxt
 !ğ
NULL
) \

382 (
li¡–m
)->
f›ld
.
Ë_Ãxt
->f›ld.
Ë_´ev
 = &(
–m
)->field.le_next;\

383 
	`ck_´_¡Üe_±r
(&(
li¡–m
)->
f›ld
.
Ë_Ãxt
, 
–m
); \

384 } 0)

	)

386 
	#CK_LIST_INSERT_BEFORE
(
li¡–m
, 
–m
, 
f›ld
) do { \

387 (
–m
)->
f›ld
.
Ë_´ev
 = (
li¡–m
)->field.le_prev; \

388 (
–m
)->
f›ld
.
Ë_Ãxt
 = (
li¡–m
); \

389 
	`ck_´_ãnû_¡Üe
(); \

390 
	`ck_´_¡Üe_±r
((
li¡–m
)->
f›ld
.
Ë_´ev
, (
–m
)); \

391 (
li¡–m
)->
f›ld
.
Ë_´ev
 = &(
–m
)->f›ld.
Ë_Ãxt
; \

392 } 0)

	)

394 
	#CK_LIST_INSERT_HEAD
(
h—d
, 
–m
, 
f›ld
) do { \

395 (
–m
)->
f›ld
.
Ë_Ãxt
 = (
h—d
)->
lh_fœ¡
; \

396 
	`ck_´_ãnû_¡Üe
(); \

397 ià((
–m
)->
f›ld
.
Ë_Ãxt
 !ğ
NULL
) \

398 (
h—d
)->
lh_fœ¡
->
f›ld
.
Ë_´ev
 = &(
–m
)->f›ld.
Ë_Ãxt
; \

399 
	`ck_´_¡Üe_±r
(&(
h—d
)->
lh_fœ¡
, 
–m
); \

400 (
–m
)->
f›ld
.
Ë_´ev
 = &(
h—d
)->
lh_fœ¡
; \

401 } 0)

	)

403 
	#CK_LIST_REMOVE
(
–m
, 
f›ld
) do { \

404 
	`ck_´_¡Üe_±r
((
–m
)->
f›ld
.
Ë_´ev
, (–m)->f›ld.
Ë_Ãxt
); \

405 ià((
–m
)->
f›ld
.
Ë_Ãxt
 !ğ
NULL
) \

406 (
–m
)->
f›ld
.
Ë_Ãxt
->f›ld.
Ë_´ev
 = (elm)->field.le_prev; \

407 } 0)

	)

409 
	#CK_LIST_MOVE
(
h—d1
, 
h—d2
, 
f›ld
) do { \

410 
	`ck_´_¡Üe_±r
(&(
h—d1
)->
lh_fœ¡
, (
h—d2
)->lh_first); \

411 ià((
h—d1
)->
lh_fœ¡
 !ğ
NULL
) \

412 (
h—d1
)->
lh_fœ¡
->
f›ld
.
Ë_´ev
 = &(head1)->lh_first; \

413 } 0)

	)

418 
	#CK_LIST_SWAP
(
h—d1
, 
h—d2
, 
ty³
, 
f›ld
) do { \

419 
ty³
 *
sw­_tmp
 = (
h—d1
)->
lh_fœ¡
; \

420 (
h—d1
)->
lh_fœ¡
 = (
h—d2
)->lh_first; \

421 (
h—d2
)->
lh_fœ¡
 = 
sw­_tmp
; \

422 ià((
sw­_tmp
 = (
h—d1
)->
lh_fœ¡
è!ğ
NULL
) \

423 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &(
h—d1
)->
lh_fœ¡
; \

424 ià((
sw­_tmp
 = (
h—d2
)->
lh_fœ¡
è!ğ
NULL
) \

425 
sw­_tmp
->
f›ld
.
Ë_´ev
 = &(
h—d2
)->
lh_fœ¡
; \

426 } 0)

	)

	@application/kvbench/include/aerospike/ck/ck_ring.h

27 #iâdeà
CK_RING_H


28 
	#CK_RING_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_md.h
>

32 
	~<«ro¥ike/ck/ck_´.h
>

33 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

34 
	~<«ro¥ike/ck/ck_¡ršg.h
>

40 
	sck_ršg
 {

41 
	mc_h—d
;

42 
	m·d
[
CK_MD_CACHELINE
 - ()];

43 
	mp_
;

44 
	mp_h—d
;

45 
	m_·d
[
CK_MD_CACHELINE
 - () * 2];

46 
	msize
;

47 
	mmask
;

49 
ck_ršg
 
	tck_ršg_t
;

51 
	sck_ršg_bufãr
 {

52 *
	mv®ue
;

54 
ck_ršg_bufãr
 
	tck_ršg_bufãr_t
;

56 
CK_CC_INLINE
 

57 
	$ck_ršg_size
(cÚ¡ 
ck_ršg
 *
ršg
)

59 
c
, 
p
;

61 
c
 = 
	`ck_´_lßd_ušt
(&
ršg
->
c_h—d
);

62 
p
 = 
	`ck_´_lßd_ušt
(&
ršg
->
p_
);

63  (
p
 - 
c
è& 
ršg
->
mask
;

64 
	}
}

66 
CK_CC_INLINE
 

67 
	$ck_ršg_ÿ·c™y
(cÚ¡ 
ck_ršg
 *
ršg
)

69  
ršg
->
size
;

70 
	}
}

72 
CK_CC_INLINE
 

73 
	$ck_ršg_š™
(
ck_ršg
 *
ršg
, 
size
)

76 
ršg
->
size
 = size;

77 
ršg
->
mask
 = 
size
 - 1;

78 
ršg
->
p_
 = 0;

79 
ršg
->
p_h—d
 = 0;

80 
ršg
->
c_h—d
 = 0;

82 
	}
}

87 
CK_CC_FORCE_INLINE
 
boŞ


88 
	$_ck_ršg_’queue_¥
(
ck_ršg
 *
ršg
,

89 *
CK_CC_RESTRICT
 
bufãr
,

90 cÚ¡ *
CK_CC_RESTRICT
 
’Œy
,

91 
ts
,

92 *
size
)

94 cÚ¡ 
mask
 = 
ršg
->mask;

95 
cÚsum”
, 
´oduûr
, 
d–
;

97 
cÚsum”
 = 
	`ck_´_lßd_ušt
(&
ršg
->
c_h—d
);

98 
´oduûr
 = 
ršg
->
p_
;

99 
d–
 = 
´oduûr
 + 1;

100 ià(
size
 !ğ
NULL
)

101 *
size
 = (
´oduûr
 - 
cÚsum”
è& 
mask
;

103 ià(
	`CK_CC_UNLIKELY
((
d–
 & 
mask
è=ğ(
cÚsum”
 & mask)))

104  
çl£
;

106 
bufãr
 = (*)bufã¸+ 
ts
 * (
´oduûr
 & 
mask
);

107 
	`memıy
(
bufãr
, 
’Œy
, 
ts
);

113 
	`ck_´_ãnû_¡Üe
();

114 
	`ck_´_¡Üe_ušt
(&
ršg
->
p_
, 
d–
);

115  
Œue
;

116 
	}
}

118 
CK_CC_FORCE_INLINE
 
boŞ


119 
	$_ck_ršg_’queue_¥_size
(
ck_ršg
 *
ršg
,

120 *
CK_CC_RESTRICT
 
bufãr
,

121 cÚ¡ *
CK_CC_RESTRICT
 
’Œy
,

122 
ts
,

123 *
size
)

125 
sz
;

126 
boŞ
 
r
;

128 
r
 = 
	`_ck_ršg_’queue_¥
(
ršg
, 
bufãr
, 
’Œy
, 
ts
, &
sz
);

129 *
size
 = 
sz
;

130  
r
;

131 
	}
}

133 
CK_CC_FORCE_INLINE
 
boŞ


134 
	$_ck_ršg_dequeue_sc
(
ck_ršg
 *
ršg
,

135 cÚ¡ *
CK_CC_RESTRICT
 
bufãr
,

136 *
CK_CC_RESTRICT
 
rg‘
,

137 
size
)

139 cÚ¡ 
mask
 = 
ršg
->mask;

140 
cÚsum”
, 
´oduûr
;

142 
cÚsum”
 = 
ršg
->
c_h—d
;

143 
´oduûr
 = 
	`ck_´_lßd_ušt
(&
ršg
->
p_
);

145 ià(
	`CK_CC_UNLIKELY
(
cÚsum”
 =ğ
´oduûr
))

146  
çl£
;

152 
	`ck_´_ãnû_lßd
();

154 
bufãr
 = (cÚ¡ *)bufã¸+ 
size
 * (
cÚsum”
 & 
mask
);

155 
	`memıy
(
rg‘
, 
bufãr
, 
size
);

161 
	`ck_´_ãnû_¡Üe
();

162 
	`ck_´_¡Üe_ušt
(&
ršg
->
c_h—d
, 
cÚsum”
 + 1);

163  
Œue
;

164 
	}
}

166 
CK_CC_FORCE_INLINE
 
boŞ


167 
	$_ck_ršg_’queue_mp
(
ck_ršg
 *
ršg
,

168 *
bufãr
,

169 cÚ¡ *
’Œy
,

170 
ts
,

171 *
size
)

173 cÚ¡ 
mask
 = 
ršg
->mask;

174 
´oduûr
, 
cÚsum”
, 
d–
;

175 
boŞ
 
r
 = 
Œue
;

177 
´oduûr
 = 
	`ck_´_lßd_ušt
(&
ršg
->
p_h—d
);

184 
	`ck_´_ãnû_lßd
();

185 
cÚsum”
 = 
	`ck_´_lßd_ušt
(&
ršg
->
c_h—d
);

187 
d–
 = 
´oduûr
 + 1;

188 ià(
	`CK_CC_UNLIKELY
((
d–
 & 
mask
è=ğ(
cÚsum”
 & mask))) {

189 
r
 = 
çl£
;

190 
Ëave
;

192 } 
	`ck_´_ÿs_ušt_v®ue
(&
ršg
->
p_h—d
,

193 
´oduûr
,

194 
d–
,

195 &
´oduûr
è=ğ
çl£
);

197 
bufãr
 = (*)bufã¸+ 
ts
 * (
´oduûr
 & 
mask
);

198 
	`memıy
(
bufãr
, 
’Œy
, 
ts
);

204 
	`ck_´_lßd_ušt
(&
ršg
->
p_
è!ğ
´oduûr
)

205 
	`ck_´_¡®l
();

211 
	`ck_´_ãnû_¡Üe
();

212 
	`ck_´_¡Üe_ušt
(&
ršg
->
p_
, 
d–
);

214 
Ëave
:

215 ià(
size
 !ğ
NULL
)

216 *
size
 = (
´oduûr
 - 
cÚsum”
è& 
mask
;

218  
r
;

219 
	}
}

221 
CK_CC_FORCE_INLINE
 
boŞ


222 
	$_ck_ršg_’queue_mp_size
(
ck_ršg
 *
ršg
,

223 *
bufãr
,

224 cÚ¡ *
’Œy
,

225 
ts
,

226 *
size
)

228 
sz
;

229 
boŞ
 
r
;

231 
r
 = 
	`_ck_ršg_’queue_mp
(
ršg
, 
bufãr
, 
’Œy
, 
ts
, &
sz
);

232 *
size
 = 
sz
;

233  
r
;

234 
	}
}

236 
CK_CC_FORCE_INLINE
 
boŞ


237 
	$_ck_ršg_Œydequeue_mc
(
ck_ršg
 *
ršg
,

238 cÚ¡ *
bufãr
,

239 *
d©a
,

240 
size
)

242 cÚ¡ 
mask
 = 
ršg
->mask;

243 
cÚsum”
, 
´oduûr
;

245 
cÚsum”
 = 
	`ck_´_lßd_ušt
(&
ršg
->
c_h—d
);

246 
	`ck_´_ãnû_lßd
();

247 
´oduûr
 = 
	`ck_´_lßd_ušt
(&
ršg
->
p_
);

249 ià(
	`CK_CC_UNLIKELY
(
cÚsum”
 =ğ
´oduûr
))

250  
çl£
;

252 
	`ck_´_ãnû_lßd
();

254 
bufãr
 = (cÚ¡ *)bufã¸+ 
size
 * (
cÚsum”
 & 
mask
);

255 
	`memıy
(
d©a
, 
bufãr
, 
size
);

257 
	`ck_´_ãnû_¡Üe_©omic
();

258  
	`ck_´_ÿs_ušt
(&
ršg
->
c_h—d
, 
cÚsum”
, consumer + 1);

259 
	}
}

261 
CK_CC_FORCE_INLINE
 
boŞ


262 
	$_ck_ršg_dequeue_mc
(
ck_ršg
 *
ršg
,

263 cÚ¡ *
bufãr
,

264 *
d©a
,

265 
ts
)

267 cÚ¡ 
mask
 = 
ršg
->mask;

268 
cÚsum”
, 
´oduûr
;

270 
cÚsum”
 = 
	`ck_´_lßd_ušt
(&
ršg
->
c_h—d
);

273 cÚ¡ *
rg‘
;

279 
	`ck_´_ãnû_lßd
();

280 
´oduûr
 = 
	`ck_´_lßd_ušt
(&
ršg
->
p_
);

282 ià(
	`CK_CC_UNLIKELY
(
cÚsum”
 =ğ
´oduûr
))

283  
çl£
;

285 
	`ck_´_ãnû_lßd
();

287 
rg‘
 = (cÚ¡ *)
bufãr
 + 
ts
 * (
cÚsum”
 & 
mask
);

288 
	`memıy
(
d©a
, 
rg‘
, 
ts
);

291 
	`ck_´_ãnû_¡Üe_©omic
();

292 } 
	`ck_´_ÿs_ušt_v®ue
(&
ršg
->
c_h—d
,

293 
cÚsum”
,

294 
cÚsum”
 + 1,

295 &
cÚsum”
è=ğ
çl£
);

297  
Œue
;

298 
	}
}

305 
CK_CC_INLINE
 
boŞ


306 
	$ck_ršg_’queue_¥sc_size
(
ck_ršg
 *
ršg
,

307 
ck_ršg_bufãr
 *
bufãr
,

308 cÚ¡ *
’Œy
,

309 *
size
)

312  
	`_ck_ršg_’queue_¥_size
(
ršg
, 
bufãr
, &
’Œy
,

313 (
’Œy
), 
size
);

314 
	}
}

316 
CK_CC_INLINE
 
boŞ


317 
	$ck_ršg_’queue_¥sc
(
ck_ršg
 *
ršg
,

318 
ck_ršg_bufãr
 *
bufãr
,

319 cÚ¡ *
’Œy
)

322  
	`_ck_ršg_’queue_¥
(
ršg
, 
bufãr
,

323 &
’Œy
, ÓÁry), 
NULL
);

324 
	}
}

326 
CK_CC_INLINE
 
boŞ


327 
	$ck_ršg_dequeue_¥sc
(
ck_ršg
 *
ršg
,

328 cÚ¡ 
ck_ršg_bufãr
 *
bufãr
,

329 *
d©a
)

332  
	`_ck_ršg_dequeue_sc
(
ršg
, 
bufãr
,

333 (**)
d©a
, (*));

334 
	}
}

341 
CK_CC_INLINE
 
boŞ


342 
	$ck_ršg_’queue_mpmc
(
ck_ršg
 *
ršg
,

343 
ck_ršg_bufãr
 *
bufãr
,

344 cÚ¡ *
’Œy
)

347  
	`_ck_ršg_’queue_mp
(
ršg
, 
bufãr
, &
’Œy
,

348 (
’Œy
), 
NULL
);

349 
	}
}

351 
CK_CC_INLINE
 
boŞ


352 
	$ck_ršg_’queue_mpmc_size
(
ck_ršg
 *
ršg
,

353 
ck_ršg_bufãr
 *
bufãr
,

354 cÚ¡ *
’Œy
,

355 *
size
)

358  
	`_ck_ršg_’queue_mp_size
(
ršg
, 
bufãr
, &
’Œy
,

359 (
’Œy
), 
size
);

360 
	}
}

362 
CK_CC_INLINE
 
boŞ


363 
	$ck_ršg_Œydequeue_mpmc
(
ck_ršg
 *
ršg
,

364 cÚ¡ 
ck_ršg_bufãr
 *
bufãr
,

365 *
d©a
)

368  
	`_ck_ršg_Œydequeue_mc
(
ršg
,

369 
bufãr
, (**)
d©a
, (*));

370 
	}
}

372 
CK_CC_INLINE
 
boŞ


373 
	$ck_ršg_dequeue_mpmc
(
ck_ršg
 *
ršg
,

374 cÚ¡ 
ck_ršg_bufãr
 *
bufãr
,

375 *
d©a
)

378  
	`_ck_ršg_dequeue_mc
(
ršg
, 
bufãr
, (**)
d©a
,

380 
	}
}

387 
CK_CC_INLINE
 
boŞ


388 
	$ck_ršg_’queue_¥mc_size
(
ck_ršg
 *
ršg
,

389 
ck_ršg_bufãr
 *
bufãr
,

390 cÚ¡ *
’Œy
,

391 *
size
)

394  
	`_ck_ršg_’queue_¥_size
(
ršg
, 
bufãr
, &
’Œy
,

395 (
’Œy
), 
size
);

396 
	}
}

398 
CK_CC_INLINE
 
boŞ


399 
	$ck_ršg_’queue_¥mc
(
ck_ršg
 *
ršg
,

400 
ck_ršg_bufãr
 *
bufãr
,

401 cÚ¡ *
’Œy
)

404  
	`_ck_ršg_’queue_¥
(
ršg
, 
bufãr
, &
’Œy
,

405 (
’Œy
), 
NULL
);

406 
	}
}

408 
CK_CC_INLINE
 
boŞ


409 
	$ck_ršg_Œydequeue_¥mc
(
ck_ršg
 *
ršg
,

410 cÚ¡ 
ck_ršg_bufãr
 *
bufãr
,

411 *
d©a
)

414  
	`_ck_ršg_Œydequeue_mc
(
ršg
, 
bufãr
, (**)
d©a
, (*));

415 
	}
}

417 
CK_CC_INLINE
 
boŞ


418 
	$ck_ršg_dequeue_¥mc
(
ck_ršg
 *
ršg
,

419 cÚ¡ 
ck_ršg_bufãr
 *
bufãr
,

420 *
d©a
)

423  
	`_ck_ršg_dequeue_mc
(
ršg
, 
bufãr
, (**)
d©a
, (*));

424 
	}
}

431 
CK_CC_INLINE
 
boŞ


432 
	$ck_ršg_’queue_mpsc
(
ck_ršg
 *
ršg
,

433 
ck_ršg_bufãr
 *
bufãr
,

434 cÚ¡ *
’Œy
)

437  
	`_ck_ršg_’queue_mp
(
ršg
, 
bufãr
, 
’Œy
,

438 (
’Œy
), 
NULL
);

439 
	}
}

441 
CK_CC_INLINE
 
boŞ


442 
	$ck_ršg_’queue_mpsc_size
(
ck_ršg
 *
ršg
,

443 
ck_ršg_bufãr
 *
bufãr
,

444 cÚ¡ *
’Œy
,

445 *
size
)

448  
	`_ck_ršg_’queue_mp_size
(
ršg
, 
bufãr
, &
’Œy
,

449 (
’Œy
), 
size
);

450 
	}
}

452 
CK_CC_INLINE
 
boŞ


453 
	$ck_ršg_dequeue_mpsc
(
ck_ršg
 *
ršg
,

454 cÚ¡ 
ck_ršg_bufãr
 *
bufãr
,

455 *
d©a
)

458  
	`_ck_ršg_dequeue_sc
(
ršg
, 
bufãr
, (**)
d©a
,

460 
	}
}

466 
	#CK_RING_PROTOTYPE
(
Çme
, 
ty³
) \

467 
CK_CC_INLINE
 
boŞ
 \

468 
ck_ršg_’queue_¥sc_size_
##
	`Çme
(
ck_ršg
 *
a
, \

469 
ty³
 *
b
, \

470 
ty³
 *
c
, \

471 *
d
) \

474  
	`_ck_ršg_’queue_¥_size
(
a
, 
b
, 
c
, \

475 (
ty³
), 
d
); \

478 
CK_CC_INLINE
 
boŞ
 \

479 
ck_ršg_’queue_¥sc_
##
	`Çme
(
ck_ršg
 *
a
, \

480 
ty³
 *
b
, \

481 
ty³
 *
c
) \

484  
	`_ck_ršg_’queue_¥
(
a
, 
b
, 
c
, \

485 (
ty³
), 
NULL
); \

488 
CK_CC_INLINE
 
boŞ
 \

489 
ck_ršg_dequeue_¥sc_
##
	`Çme
(
ck_ršg
 *
a
, \

490 
ty³
 *
b
, \

491 
ty³
 *
c
) \

494  
	`_ck_ršg_dequeue_sc
(
a
, 
b
, 
c
, \

495 (
ty³
)); \

498 
CK_CC_INLINE
 
boŞ
 \

499 
ck_ršg_’queue_¥mc_size_
##
	`Çme
(
ck_ršg
 *
a
, \

500 
ty³
 *
b
, \

501 
ty³
 *
c
, \

502 *
d
) \

505  
	`_ck_ršg_’queue_¥_size
(
a
, 
b
, 
c
, \

506 (
ty³
), 
d
); \

509 
CK_CC_INLINE
 
boŞ
 \

510 
ck_ršg_’queue_¥mc_
##
	`Çme
(
ck_ršg
 *
a
, \

511 
ty³
 *
b
, \

512 
ty³
 *
c
) \

515  
	`_ck_ršg_’queue_¥
(
a
, 
b
, 
c
, \

516 (
ty³
), 
NULL
); \

519 
CK_CC_INLINE
 
boŞ
 \

520 
ck_ršg_Œydequeue_¥mc_
##
	`Çme
(
ck_ršg
 *
a
, \

521 
ty³
 *
b
, \

522 
ty³
 *
c
) \

525  
	`_ck_ršg_Œydequeue_mc
(
a
, \

526 
b
, 
c
, (
ty³
)); \

529 
CK_CC_INLINE
 
boŞ
 \

530 
ck_ršg_dequeue_¥mc_
##
	`Çme
(
ck_ršg
 *
a
, \

531 
ty³
 *
b
, \

532 
ty³
 *
c
) \

535  
	`_ck_ršg_dequeue_mc
(
a
, 
b
, 
c
, \

536 (
ty³
)); \

539 
CK_CC_INLINE
 
boŞ
 \

540 
ck_ršg_’queue_mpsc_
##
	`Çme
(
ck_ršg
 *
a
, \

541 
ty³
 *
b
, \

542 
ty³
 *
c
) \

545  
	`_ck_ršg_’queue_mp
(
a
, 
b
, 
c
, \

546 (
ty³
), 
NULL
); \

549 
CK_CC_INLINE
 
boŞ
 \

550 
ck_ršg_’queue_mpsc_size_
##
	`Çme
(
ck_ršg
 *
a
, \

551 
ty³
 *
b
, \

552 
ty³
 *
c
, \

553 *
d
) \

556  
	`_ck_ršg_’queue_mp_size
(
a
, 
b
, 
c
, \

557 (
ty³
), 
d
); \

560 
CK_CC_INLINE
 
boŞ
 \

561 
ck_ršg_dequeue_mpsc_
##
	`Çme
(
ck_ršg
 *
a
, \

562 
ty³
 *
b
, \

563 
ty³
 *
c
) \

566  
	`_ck_ršg_dequeue_sc
(
a
, 
b
, 
c
, \

567 (
ty³
)); \

570 
CK_CC_INLINE
 
boŞ
 \

571 
ck_ršg_’queue_mpmc_size_
##
	`Çme
(
ck_ršg
 *
a
, \

572 
ty³
 *
b
, \

573 
ty³
 *
c
, \

574 *
d
) \

577  
	`_ck_ršg_’queue_mp_size
(
a
, 
b
, 
c
, \

578 (
ty³
), 
d
); \

581 
CK_CC_INLINE
 
boŞ
 \

582 
ck_ršg_’queue_mpmc_
##
	`Çme
(
ck_ršg
 *
a
, \

583 
ty³
 *
b
, \

584 
ty³
 *
c
) \

587  
	`_ck_ršg_’queue_mp
(
a
, 
b
, 
c
, \

588 (
ty³
), 
NULL
); \

591 
CK_CC_INLINE
 
boŞ
 \

592 
ck_ršg_Œydequeue_mpmc_
##
	`Çme
(
ck_ršg
 *
a
, \

593 
ty³
 *
b
, \

594 
ty³
 *
c
) \

597  
	`_ck_ršg_Œydequeue_mc
(
a
, \

598 
b
, 
c
, (
ty³
)); \

601 
CK_CC_INLINE
 
boŞ
 \

602 
ck_ršg_dequeue_mpmc_
##
	`Çme
(
ck_ršg
 *
a
, \

603 
ty³
 *
b
, \

604 
ty³
 *
c
) \

607  
	`_ck_ršg_dequeue_mc
(
a
, 
b
, 
c
, \

608 (
ty³
)); \

609 }

	)

614 
	#CK_RING_ENQUEUE_SPSC
(
Çme
, 
a
, 
b
, 
c
) \

615 
ck_ršg_’queue_¥sc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

616 
	#CK_RING_ENQUEUE_SPSC_SIZE
(
Çme
, 
a
, 
b
, 
c
, 
d
) \

617 
ck_ršg_’queue_¥sc_size_
##
	`Çme
(
a
, 
b
, 
c
, 
d
)

	)

618 
	#CK_RING_DEQUEUE_SPSC
(
Çme
, 
a
, 
b
, 
c
) \

619 
ck_ršg_dequeue_¥sc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

624 
	#CK_RING_ENQUEUE_SPMC
(
Çme
, 
a
, 
b
, 
c
) \

625 
ck_ršg_’queue_¥mc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

626 
	#CK_RING_ENQUEUE_SPMC_SIZE
(
Çme
, 
a
, 
b
, 
c
, 
d
) \

627 
ck_ršg_’queue_¥mc_size_
##
	`Çme
(
a
, 
b
, 
c
, 
d
)

	)

628 
	#CK_RING_TRYDEQUEUE_SPMC
(
Çme
, 
a
, 
b
, 
c
) \

629 
ck_ršg_Œydequeue_¥mc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

630 
	#CK_RING_DEQUEUE_SPMC
(
Çme
, 
a
, 
b
, 
c
) \

631 
ck_ršg_dequeue_¥mc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

637 
	#CK_RING_ENQUEUE_MPSC
(
Çme
, 
a
, 
b
, 
c
) \

638 
ck_ršg_’queue_mpsc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

639 
	#CK_RING_ENQUEUE_MPSC_SIZE
(
Çme
, 
a
, 
b
, 
c
, 
d
) \

640 
ck_ršg_’queue_mpsc_size_
##
	`Çme
(
a
, 
b
, 
c
, 
d
)

	)

641 
	#CK_RING_DEQUEUE_MPSC
(
Çme
, 
a
, 
b
, 
c
) \

642 
ck_ršg_dequeue_mpsc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

647 
	#CK_RING_ENQUEUE_MPMC
(
Çme
, 
a
, 
b
, 
c
) \

648 
ck_ršg_’queue_mpmc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

649 
	#CK_RING_ENQUEUE_MPMC_SIZE
(
Çme
, 
a
, 
b
, 
c
, 
d
) \

650 
ck_ršg_’queue_mpmc_size_
##
	`Çme
(
a
, 
b
, 
c
, 
d
)

	)

651 
	#CK_RING_TRYDEQUEUE_MPMC
(
Çme
, 
a
, 
b
, 
c
) \

652 
ck_ršg_Œydequeue_mpmc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

653 
	#CK_RING_DEQUEUE_MPMC
(
Çme
, 
a
, 
b
, 
c
) \

654 
ck_ršg_dequeue_mpmc_
##
	`Çme
(
a
, 
b
, 
c
)

	)

	@application/kvbench/include/aerospike/ck/ck_rwcohort.h

28 #iâdeà
CK_RWCOHORT_H


29 
	#CK_RWCOHORT_H


	)

37 
	~<«ro¥ike/ck/ck_cc.h
>

38 
	~<«ro¥ike/ck/ck_´.h
>

39 
	~<«ro¥ike/ck/ck_¡ddef.h
>

40 
	~<«ro¥ike/ck/ck_cohÜt.h
>

42 
	#CK_RWCOHORT_WP_NAME
(
N
è
ck_rwcohÜt_wp_
##
	)
N

43 
	#CK_RWCOHORT_WP_INSTANCE
(
N
è
	`CK_RWCOHORT_WP_NAME
(N)

	)

44 
	#CK_RWCOHORT_WP_INIT
(
N
, 
RW
, 
WL
è
ck_rwcohÜt_wp_
##N##
	`_š™
(RW, WL)

	)

45 
	#CK_RWCOHORT_WP_READ_LOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

46 
ck_rwcohÜt_wp_
##
N
##
	`_»ad_lock
(
RW
, 
C
, 
GC
, 
LC
)

	)

47 
	#CK_RWCOHORT_WP_READ_UNLOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

48 
ck_rwcohÜt_wp_
##
N
##
	`_»ad_uÆock
(
RW
)

	)

49 
	#CK_RWCOHORT_WP_WRITE_LOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

50 
ck_rwcohÜt_wp_
##
N
##
	`_wr™e_lock
(
RW
, 
C
, 
GC
, 
LC
)

	)

51 
	#CK_RWCOHORT_WP_WRITE_UNLOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

52 
ck_rwcohÜt_wp_
##
N
##
	`_wr™e_uÆock
(
RW
, 
C
, 
GC
, 
LC
)

	)

53 
	#CK_RWCOHORT_WP_DEFAULT_WAIT_LIMIT
 1000

	)

55 
	#CK_RWCOHORT_WP_PROTOTYPE
(
N
) \

56 
	`CK_RWCOHORT_WP_INSTANCE
(
N
) { \

57 
»ad_couÁ”
; \

58 
wr™e_b¬r›r
; \

59 
wa™_lim™
; \

61 
CK_CC_INLINE
 \

62 
ck_rwcohÜt_wp_
##
N
##
	`_š™
(
	`CK_RWCOHORT_WP_INSTANCE
(Nè*
rw_cohÜt
, \

63 
wa™_lim™
) \

66 
rw_cohÜt
->
»ad_couÁ”
 = 0; \

67 
rw_cohÜt
->
wr™e_b¬r›r
 = 0; \

68 
rw_cohÜt
->
wa™_lim™
 = wait_limit; \

69 
	`ck_´_b¬r›r
(); \

72 
CK_CC_INLINE
 \

73 
ck_rwcohÜt_wp_
##
N
##
	`_wr™e_lock
(
	`CK_RWCOHORT_WP_INSTANCE
(Nè*
rw_cohÜt
, \

74 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

75 *
loÿl_cÚ‹xt
) \

78 
	`ck_´_lßd_ušt
(&
rw_cohÜt
->
wr™e_b¬r›r
) > 0) \

79 
	`ck_´_¡®l
(); \

81 
	`CK_COHORT_LOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

83 
	`ck_´_lßd_ušt
(&
rw_cohÜt
->
»ad_couÁ”
) > 0) \

84 
	`ck_´_¡®l
(); \

88 
CK_CC_INLINE
 \

89 
ck_rwcohÜt_wp_
##
N
##
	`_wr™e_uÆock
(
	`CK_RWCOHORT_WP_INSTANCE
(Nè*
rw_cohÜt
, \

90 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

91 *
loÿl_cÚ‹xt
) \

94 ()
rw_cohÜt
; \

95 
	`CK_COHORT_UNLOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

98 
CK_CC_INLINE
 \

99 
ck_rwcohÜt_wp_
##
N
##
	`_»ad_lock
(
	`CK_RWCOHORT_WP_INSTANCE
(Nè*
rw_cohÜt
, \

100 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

101 *
loÿl_cÚ‹xt
) \

103 
wa™_couÁ
 = 0; \

104 
boŞ
 
¿i£d
 = 
çl£
; \

107 
	`ck_´_šc_ušt
(&
rw_cohÜt
->
»ad_couÁ”
); \

108 
	`ck_´_ãnû_©omic_lßd
(); \

109 ià(
	`CK_COHORT_LOCKED
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, \

110 
loÿl_cÚ‹xt
è=ğ
çl£
) \

113 
	`ck_´_dec_ušt
(&
rw_cohÜt
->
»ad_couÁ”
); \

114 
	`CK_COHORT_LOCKED
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, \

115 
loÿl_cÚ‹xt
è=ğ
Œue
) { \

116 
	`ck_´_¡®l
(); \

117 ià(++
wa™_couÁ
 > 
rw_cohÜt
->
wa™_lim™
 && \

118 
¿i£d
 =ğ
çl£
) { \

119 
	`ck_´_šc_ušt
(&
rw_cohÜt
->
wr™e_b¬r›r
); \

120 
¿i£d
 = 
Œue
; \

125 ià(
¿i£d
 =ğ
Œue
) \

126 
	`ck_´_dec_ušt
(&
rw_cohÜt
->
wr™e_b¬r›r
); \

128 
	`ck_´_ãnû_lßd
(); \

131 
CK_CC_INLINE
 \

132 
ck_rwcohÜt_wp_
##
N
##
	`_»ad_uÆock
(
	`CK_RWCOHORT_WP_INSTANCE
(Nè*
cohÜt
) \

135 
	`ck_´_ãnû_lßd_©omic
(); \

136 
	`ck_´_dec_ušt
(&
cohÜt
->
»ad_couÁ”
); \

138 }

	)

140 
	#CK_RWCOHORT_WP_INITIALIZER
 { \

141 .
»ad_couÁ”
 = 0, \

142 .
wr™e_b¬r›r
 = 0, \

143 .
wa™_lim™
 = 0 \

144 }

	)

146 
	#CK_RWCOHORT_RP_NAME
(
N
è
ck_rwcohÜt_½_
##
	)
N

147 
	#CK_RWCOHORT_RP_INSTANCE
(
N
è
	`CK_RWCOHORT_RP_NAME
(N)

	)

148 
	#CK_RWCOHORT_RP_INIT
(
N
, 
RW
, 
WL
è
ck_rwcohÜt_½_
##N##
	`_š™
(RW, WL)

	)

149 
	#CK_RWCOHORT_RP_READ_LOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

150 
ck_rwcohÜt_½_
##
N
##
	`_»ad_lock
(
RW
, 
C
, 
GC
, 
LC
)

	)

151 
	#CK_RWCOHORT_RP_READ_UNLOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

152 
ck_rwcohÜt_½_
##
N
##
	`_»ad_uÆock
(
RW
)

	)

153 
	#CK_RWCOHORT_RP_WRITE_LOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

154 
ck_rwcohÜt_½_
##
N
##
	`_wr™e_lock
(
RW
, 
C
, 
GC
, 
LC
)

	)

155 
	#CK_RWCOHORT_RP_WRITE_UNLOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

156 
ck_rwcohÜt_½_
##
N
##
	`_wr™e_uÆock
(
RW
, 
C
, 
GC
, 
LC
)

	)

157 
	#CK_RWCOHORT_RP_DEFAULT_WAIT_LIMIT
 1000

	)

159 
	#CK_RWCOHORT_RP_PROTOTYPE
(
N
) \

160 
	`CK_RWCOHORT_RP_INSTANCE
(
N
) { \

161 
»ad_couÁ”
; \

162 
»ad_b¬r›r
; \

163 
wa™_lim™
; \

165 
CK_CC_INLINE
 \

166 
ck_rwcohÜt_½_
##
N
##
	`_š™
(
	`CK_RWCOHORT_RP_INSTANCE
(Nè*
rw_cohÜt
, \

167 
wa™_lim™
) \

170 
rw_cohÜt
->
»ad_couÁ”
 = 0; \

171 
rw_cohÜt
->
»ad_b¬r›r
 = 0; \

172 
rw_cohÜt
->
wa™_lim™
 = wait_limit; \

173 
	`ck_´_b¬r›r
(); \

176 
CK_CC_INLINE
 \

177 
ck_rwcohÜt_½_
##
N
##
	`_wr™e_lock
(
	`CK_RWCOHORT_RP_INSTANCE
(Nè*
rw_cohÜt
, \

178 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

179 *
loÿl_cÚ‹xt
) \

181 
wa™_couÁ
 = 0; \

182 
boŞ
 
¿i£d
 = 
çl£
; \

185 
	`CK_COHORT_LOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

186 ià(
	`ck_´_lßd_ušt
(&
rw_cohÜt
->
»ad_couÁ”
) == 0) \

189 
	`CK_COHORT_UNLOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

190 
	`ck_´_lßd_ušt
(&
rw_cohÜt
->
»ad_couÁ”
) > 0) { \

191 
	`ck_´_¡®l
(); \

192 ià(++
wa™_couÁ
 > 
rw_cohÜt
->
wa™_lim™
 && \

193 
¿i£d
 =ğ
çl£
) { \

194 
	`ck_´_šc_ušt
(&
rw_cohÜt
->
»ad_b¬r›r
); \

195 
¿i£d
 = 
Œue
; \

200 ià(
¿i£d
 =ğ
Œue
) \

201 
	`ck_´_dec_ušt
(&
rw_cohÜt
->
»ad_b¬r›r
); \

205 
CK_CC_INLINE
 \

206 
ck_rwcohÜt_½_
##
N
##
	`_wr™e_uÆock
(
	`CK_RWCOHORT_RP_INSTANCE
(Nè*
rw_cohÜt
, \

207 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, *
loÿl_cÚ‹xt
) \

210 ()
rw_cohÜt
; \

211 
	`CK_COHORT_UNLOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

214 
CK_CC_INLINE
 \

215 
ck_rwcohÜt_½_
##
N
##
	`_»ad_lock
(
	`CK_RWCOHORT_RP_INSTANCE
(Nè*
rw_cohÜt
, \

216 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

217 *
loÿl_cÚ‹xt
) \

220 
	`ck_´_lßd_ušt
(&
rw_cohÜt
->
»ad_b¬r›r
) > 0) \

221 
	`ck_´_¡®l
(); \

223 
	`ck_´_šc_ušt
(&
rw_cohÜt
->
»ad_couÁ”
); \

224 
	`ck_´_ãnû_©omic_lßd
(); \

226 
	`CK_COHORT_LOCKED
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, \

227 
loÿl_cÚ‹xt
è=ğ
Œue
) \

228 
	`ck_´_¡®l
(); \

232 
CK_CC_INLINE
 \

233 
ck_rwcohÜt_½_
##
N
##
	`_»ad_uÆock
(
	`CK_RWCOHORT_RP_INSTANCE
(Nè*
cohÜt
) \

236 
	`ck_´_ãnû_lßd_©omic
(); \

237 
	`ck_´_dec_ušt
(&
cohÜt
->
»ad_couÁ”
); \

239 }

	)

241 
	#CK_RWCOHORT_RP_INITIALIZER
 { \

242 .
»ad_couÁ”
 = 0, \

243 .
»ad_b¬r›r
 = 0, \

244 .
wa™_lim™
 = 0 \

245 }

	)

247 
	#CK_RWCOHORT_NEUTRAL_NAME
(
N
è
ck_rwcohÜt_ÃuŒ®_
##
	)
N

248 
	#CK_RWCOHORT_NEUTRAL_INSTANCE
(
N
è
	`CK_RWCOHORT_NEUTRAL_NAME
(N)

	)

249 
	#CK_RWCOHORT_NEUTRAL_INIT
(
N
, 
RW
è
ck_rwcohÜt_ÃuŒ®_
##N##
	`_š™
(RW)

	)

250 
	#CK_RWCOHORT_NEUTRAL_READ_LOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

251 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_»ad_lock
(
RW
, 
C
, 
GC
, 
LC
)

	)

252 
	#CK_RWCOHORT_NEUTRAL_READ_UNLOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

253 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_»ad_uÆock
(
RW
)

	)

254 
	#CK_RWCOHORT_NEUTRAL_WRITE_LOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

255 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_wr™e_lock
(
RW
, 
C
, 
GC
, 
LC
)

	)

256 
	#CK_RWCOHORT_NEUTRAL_WRITE_UNLOCK
(
N
, 
RW
, 
C
, 
GC
, 
LC
) \

257 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_wr™e_uÆock
(
RW
, 
C
, 
GC
, 
LC
)

	)

258 
	#CK_RWCOHORT_NEUTRAL_DEFAULT_WAIT_LIMIT
 1000

	)

260 
	#CK_RWCOHORT_NEUTRAL_PROTOTYPE
(
N
) \

261 
	`CK_RWCOHORT_NEUTRAL_INSTANCE
(
N
) { \

262 
»ad_couÁ”
; \

264 
CK_CC_INLINE
 \

265 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_š™
(
	`CK_RWCOHORT_NEUTRAL_INSTANCE
(Nè*
rw_cohÜt
) \

268 
rw_cohÜt
->
»ad_couÁ”
 = 0; \

269 
	`ck_´_b¬r›r
(); \

272 
CK_CC_INLINE
 \

273 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_wr™e_lock
(
	`CK_RWCOHORT_NEUTRAL_INSTANCE
(Nè*
rw_cohÜt
,\

274 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

275 *
loÿl_cÚ‹xt
) \

278 
	`CK_COHORT_LOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

279 
	`ck_´_lßd_ušt
(&
rw_cohÜt
->
»ad_couÁ”
) > 0) { \

280 
	`ck_´_¡®l
(); \

284 
CK_CC_INLINE
 \

285 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_wr™e_uÆock
(
	`CK_RWCOHORT_NEUTRAL_INSTANCE
(Nè*
rw_cohÜt
,\

286 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, *
loÿl_cÚ‹xt
) \

289 ()
rw_cohÜt
; \

290 
	`CK_COHORT_UNLOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

293 
CK_CC_INLINE
 \

294 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_»ad_lock
(
	`CK_RWCOHORT_NEUTRAL_INSTANCE
(Nè*
rw_cohÜt
, \

295 
	`CK_COHORT_INSTANCE
(
N
è*
cohÜt
, *
glob®_cÚ‹xt
, \

296 *
loÿl_cÚ‹xt
) \

299 
	`CK_COHORT_LOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

300 
	`ck_´_šc_ušt
(&
rw_cohÜt
->
»ad_couÁ”
); \

301 
	`CK_COHORT_UNLOCK
(
N
, 
cohÜt
, 
glob®_cÚ‹xt
, 
loÿl_cÚ‹xt
); \

304 
CK_CC_INLINE
 \

305 
ck_rwcohÜt_ÃuŒ®_
##
N
##
	`_»ad_uÆock
(
	`CK_RWCOHORT_NEUTRAL_INSTANCE
(Nè*
cohÜt
) \

308 
	`ck_´_ãnû_lßd_©omic
(); \

309 
	`ck_´_dec_ušt
(&
cohÜt
->
»ad_couÁ”
); \

311 }

	)

313 
	#CK_RWCOHORT_NEUTRAL_INITIALIZER
 { \

314 .
»ad_couÁ”
 = 0, \

315 }

	)

	@application/kvbench/include/aerospike/ck/ck_rwlock.h

27 #iâdeà
CK_RWLOCK_H


28 
	#CK_RWLOCK_H


	)

30 
	~<«ro¥ike/ck/ck_–ide.h
>

31 
	~<«ro¥ike/ck/ck_´.h
>

32 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

33 
	~<«ro¥ike/ck/ck_¡ddef.h
>

35 
	sck_rwlock
 {

36 
	mwr™”
;

37 
	mn_»ad”s
;

39 
ck_rwlock
 
	tck_rwlock_t
;

41 
	#CK_RWLOCK_INITIALIZER
 {0, 0}

	)

43 
CK_CC_INLINE
 

44 
	$ck_rwlock_š™
(
ck_rwlock
 *
rw
)

47 
rw
->
wr™”
 = 0;

48 
rw
->
n_»ad”s
 = 0;

49 
	`ck_´_b¬r›r
();

51 
	}
}

53 
CK_CC_INLINE
 

54 
	$ck_rwlock_wr™e_uÆock
(
ck_rwlock_t
 *
rw
)

57 
	`ck_´_ãnû_uÆock
();

58 
	`ck_´_¡Üe_ušt
(&
rw
->
wr™”
, 0);

60 
	}
}

62 
CK_CC_INLINE
 
boŞ


63 
	$ck_rwlock_locked_wr™”
(
ck_rwlock_t
 *
rw
)

65 
boŞ
 
r
;

67 
r
 = 
	`ck_´_lßd_ušt
(&
rw
->
wr™”
);

68 
	`ck_´_ãnû_acquœe
();

69  
r
;

70 
	}
}

72 
CK_CC_INLINE
 

73 
	$ck_rwlock_wr™e_downg¿de
(
ck_rwlock_t
 *
rw
)

76 
	`ck_´_šc_ušt
(&
rw
->
n_»ad”s
);

77 
	`ck_rwlock_wr™e_uÆock
(
rw
);

79 
	}
}

81 
CK_CC_INLINE
 
boŞ


82 
	$ck_rwlock_locked
(
ck_rwlock_t
 *
rw
)

84 
boŞ
 
l
;

86 
l
 = 
	`ck_´_lßd_ušt
(&
rw
->
n_»ad”s
) |

87 
	`ck_´_lßd_ušt
(&
rw
->
wr™”
);

88 
	`ck_´_ãnû_acquœe
();

89  
l
;

90 
	}
}

92 
CK_CC_INLINE
 
boŞ


93 
	$ck_rwlock_wr™e_Œylock
(
ck_rwlock_t
 *
rw
)

96 ià(
	`ck_´_çs_ušt
(&
rw
->
wr™”
, 1) != 0)

97  
çl£
;

99 
	`ck_´_ãnû_©omic_lßd
();

101 ià(
	`ck_´_lßd_ušt
(&
rw
->
n_»ad”s
) != 0) {

102 
	`ck_rwlock_wr™e_uÆock
(
rw
);

103  
çl£
;

106 
	`ck_´_ãnû_lock
();

107  
Œue
;

108 
	}
}

110 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_rwlock_wr™e
, 
ck_rwlock_t
,

111 
ck_rwlock_locked
, 
ck_rwlock_wr™e_Œylock
)

113 
CK_CC_INLINE
 

114 
	$ck_rwlock_wr™e_lock
(
ck_rwlock_t
 *
rw
)

117 
	`ck_´_çs_ušt
(&
rw
->
wr™”
, 1) != 0)

118 
	`ck_´_¡®l
();

120 
	`ck_´_ãnû_©omic_lßd
();

122 
	`ck_´_lßd_ušt
(&
rw
->
n_»ad”s
) != 0)

123 
	`ck_´_¡®l
();

125 
	`ck_´_ãnû_lock
();

127 
	}
}

129 
	$CK_ELIDE_PROTOTYPE
(
ck_rwlock_wr™e
, 
ck_rwlock_t
,

130 
ck_rwlock_locked
, 
ck_rwlock_wr™e_lock
,

131 
ck_rwlock_locked_wr™”
, 
ck_rwlock_wr™e_uÆock
)

133 
CK_CC_INLINE
 
boŞ


134 
	$ck_rwlock_»ad_Œylock
(
ck_rwlock_t
 *
rw
)

137 ià(
	`ck_´_lßd_ušt
(&
rw
->
wr™”
) != 0)

138  
çl£
;

140 
	`ck_´_šc_ušt
(&
rw
->
n_»ad”s
);

146 
	`ck_´_ãnû_©omic_lßd
();

148 ià(
	`ck_´_lßd_ušt
(&
rw
->
wr™”
) == 0) {

149 
	`ck_´_ãnû_lock
();

150  
Œue
;

153 
	`ck_´_dec_ušt
(&
rw
->
n_»ad”s
);

154  
çl£
;

155 
	}
}

157 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_rwlock_»ad
, 
ck_rwlock_t
,

158 
ck_rwlock_locked_wr™”
, 
ck_rwlock_»ad_Œylock
)

160 
CK_CC_INLINE
 

161 
	$ck_rwlock_»ad_lock
(
ck_rwlock_t
 *
rw
)

165 
	`ck_´_lßd_ušt
(&
rw
->
wr™”
) != 0)

166 
	`ck_´_¡®l
();

168 
	`ck_´_šc_ušt
(&
rw
->
n_»ad”s
);

174 
	`ck_´_ãnû_©omic_lßd
();

176 ià(
	`ck_´_lßd_ušt
(&
rw
->
wr™”
) == 0)

179 
	`ck_´_dec_ušt
(&
rw
->
n_»ad”s
);

183 
	`ck_´_ãnû_lßd
();

185 
	}
}

187 
CK_CC_INLINE
 
boŞ


188 
	$ck_rwlock_locked_»ad”
(
ck_rwlock_t
 *
rw
)

191 
	`ck_´_ãnû_lßd
();

192  
	`ck_´_lßd_ušt
(&
rw
->
n_»ad”s
);

193 
	}
}

195 
CK_CC_INLINE
 

196 
	$ck_rwlock_»ad_uÆock
(
ck_rwlock_t
 *
rw
)

199 
	`ck_´_ãnû_lßd_©omic
();

200 
	`ck_´_dec_ušt
(&
rw
->
n_»ad”s
);

202 
	}
}

204 
	$CK_ELIDE_PROTOTYPE
(
ck_rwlock_»ad
, 
ck_rwlock_t
,

205 
ck_rwlock_locked_wr™”
, 
ck_rwlock_»ad_lock
,

206 
ck_rwlock_locked_»ad”
, 
ck_rwlock_»ad_uÆock
)

211 
	sck_rwlock_»cursive
 {

212 
ck_rwlock
 
rw
;

213 
wc
;

215 
ck_rwlock_»cursive
 
	tck_rwlock_»cursive_t
;

217 
	#CK_RWLOCK_RECURSIVE_INITIALIZER
 {
CK_RWLOCK_INITIALIZER
, 0
	}

	)
}

219 
CK_CC_INLINE
 

220 
	$ck_rwlock_»cursive_wr™e_lock
(
ck_rwlock_»cursive_t
 *
rw
, 
tid
)

222 
o
;

224 
o
 = 
	`ck_´_lßd_ušt
(&
rw
->rw.
wr™”
);

225 ià(
o
 =ğ
tid
)

226 
Ëave
;

228 
	`ck_´_ÿs_ušt
(&
rw
->rw.
wr™”
, 0, 
tid
è=ğ
çl£
)

229 
	`ck_´_¡®l
();

231 
	`ck_´_ãnû_©omic_lßd
();

233 
	`ck_´_lßd_ušt
(&
rw
->rw.
n_»ad”s
) != 0)

234 
	`ck_´_¡®l
();

236 
	`ck_´_ãnû_lock
();

237 
Ëave
:

238 
rw
->
wc
++;

240 
	}
}

242 
CK_CC_INLINE
 
boŞ


243 
	$ck_rwlock_»cursive_wr™e_Œylock
(
ck_rwlock_»cursive_t
 *
rw
, 
tid
)

245 
o
;

247 
o
 = 
	`ck_´_lßd_ušt
(&
rw
->rw.
wr™”
);

248 ià(
o
 =ğ
tid
)

249 
Ëave
;

251 ià(
	`ck_´_ÿs_ušt
(&
rw
->rw.
wr™”
, 0, 
tid
è=ğ
çl£
)

252  
çl£
;

254 
	`ck_´_ãnû_©omic_lßd
();

256 ià(
	`ck_´_lßd_ušt
(&
rw
->rw.
n_»ad”s
) != 0) {

257 
	`ck_´_¡Üe_ušt
(&
rw
->rw.
wr™”
, 0);

258  
çl£
;

261 
	`ck_´_ãnû_lock
();

262 
Ëave
:

263 
rw
->
wc
++;

264  
Œue
;

265 
	}
}

267 
CK_CC_INLINE
 

268 
	$ck_rwlock_»cursive_wr™e_uÆock
(
ck_rwlock_»cursive_t
 *
rw
)

271 ià(--
rw
->
wc
 == 0) {

272 
	`ck_´_ãnû_uÆock
();

273 
	`ck_´_¡Üe_ušt
(&
rw
->rw.
wr™”
, 0);

277 
	}
}

279 
CK_CC_INLINE
 

280 
	$ck_rwlock_»cursive_»ad_lock
(
ck_rwlock_»cursive_t
 *
rw
)

283 
	`ck_rwlock_»ad_lock
(&
rw
->rw);

285 
	}
}

287 
CK_CC_INLINE
 
boŞ


288 
	$ck_rwlock_»cursive_»ad_Œylock
(
ck_rwlock_»cursive_t
 *
rw
)

291  
	`ck_rwlock_»ad_Œylock
(&
rw
->rw);

292 
	}
}

294 
CK_CC_INLINE
 

295 
	$ck_rwlock_»cursive_»ad_uÆock
(
ck_rwlock_»cursive_t
 *
rw
)

298 
	`ck_rwlock_»ad_uÆock
(&
rw
->rw);

300 
	}
}

	@application/kvbench/include/aerospike/ck/ck_sequence.h

27 #iâdeà
CK_SEQUENCE_H


28 
	#CK_SEQUENCE_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_´.h
>

32 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

34 
	sck_£qu’û
 {

35 
	m£qu’û
;

37 
ck_£qu’û
 
	tck_£qu’û_t
;

39 
	#CK_SEQUENCE_INITIALIZER
 { .
£qu’û
 = 0 }

	)

41 
CK_CC_INLINE
 

42 
	$ck_£qu’û_š™
(
ck_£qu’û
 *
sq
)

45 
	`ck_´_¡Üe_ušt
(&
sq
->
£qu’û
, 0);

47 
	}
}

49 
CK_CC_INLINE
 

50 
	$ck_£qu’û_»ad_begš
(cÚ¡ 
ck_£qu’û
 *
sq
)

52 
v”siÚ
;

55 
v”siÚ
 = 
	`ck_´_lßd_ušt
(&
sq
->
£qu’û
);

61 ià(
	`CK_CC_LIKELY
((
v”siÚ
 & 1) == 0))

69 
	`ck_´_¡®l
();

72 
	`ck_´_ãnû_lßd
();

73  
v”siÚ
;

74 
	}
}

76 
CK_CC_INLINE
 
boŞ


77 
	$ck_£qu’û_»ad_»Œy
(cÚ¡ 
ck_£qu’û
 *
sq
, 
v”siÚ
)

84 
	`ck_´_ãnû_lßd
();

85  
	`ck_´_lßd_ušt
(&
sq
->
£qu’û
è!ğ
v”siÚ
;

86 
	}
}

88 
	#CK_SEQUENCE_READ
(
£qlock
, 
v”siÚ
) \

89 *(
v”siÚ
) = 1; \

90 (*(
v”siÚ
è!ğ0è&& (*(v”siÚèğ
	`ck_£qu’û_»ad_begš
(
£qlock
), 1); \

91 *(
v”siÚ
èğ
	`ck_£qu’û_»ad_»Œy
(
£qlock
, *(v”siÚ)))

	)

96 
CK_CC_INLINE
 

97 
	$ck_£qu’û_wr™e_begš
(
ck_£qu’û
 *
sq
)

104 
	`ck_´_¡Üe_ušt
(&
sq
->
£qu’û
, sq->sequence + 1);

105 
	`ck_´_ãnû_¡Üe
();

107 
	}
}

112 
CK_CC_INLINE
 

113 
	$ck_£qu’û_wr™e_’d
(
ck_£qu’û
 *
sq
)

120 
	`ck_´_ãnû_¡Üe
();

121 
	`ck_´_¡Üe_ušt
(&
sq
->
£qu’û
, sq->sequence + 1);

123 
	}
}

	@application/kvbench/include/aerospike/ck/ck_spinlock.h

27 #iâdeà
CK_SPINLOCK_H


28 
	#CK_SPINLOCK_H


	)

30 
	~"«ro¥ike/ck/¥šlock/ªd”sÚ.h
"

31 
	~"«ro¥ike/ck/¥šlock/ÿs.h
"

32 
	~"«ro¥ike/ck/¥šlock/şh.h
"

33 
	~"«ro¥ike/ck/¥šlock/dec.h
"

34 
	~"«ro¥ike/ck/¥šlock/çs.h
"

35 
	~"«ro¥ike/ck/¥šlock/hşh.h
"

36 
	~"«ro¥ike/ck/¥šlock/mcs.h
"

37 
	~"«ro¥ike/ck/¥šlock/tick‘.h
"

45 
	#CK_SPINLOCK_INITIALIZER
 
CK_SPINLOCK_FAS_INITIALIZER


	)

46 
	#ck_¥šlock_t
 
ck_¥šlock_çs_t


	)

47 
	#ck_¥šlock_š™
(
x
è
	`ck_¥šlock_çs_š™
(x)

	)

48 
	#ck_¥šlock_lock
(
x
è
	`ck_¥šlock_çs_lock
(x)

	)

49 
	#ck_¥šlock_lock_eb
(
x
è
	`ck_¥šlock_çs_lock_eb
(x)

	)

50 
	#ck_¥šlock_uÆock
(
x
è
	`ck_¥šlock_çs_uÆock
(x)

	)

51 
	#ck_¥šlock_locked
(
x
è
	`ck_¥šlock_çs_locked
(x)

	)

52 
	#ck_¥šlock_Œylock
(
x
è
	`ck_¥šlock_çs_Œylock
(x)

	)

54 
	$CK_ELIDE_PROTOTYPE
(
ck_¥šlock
, 
ck_¥šlock_t
,

55 
ck_¥šlock_locked
, 
ck_¥šlock_lock
,

56 
ck_¥šlock_locked
, 
ck_¥šlock_uÆock
)

58 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_¥šlock
, 
ck_¥šlock_t
,

59 
ck_¥šlock_locked
, 
ck_¥šlock_Œylock
)

	@application/kvbench/include/aerospike/ck/ck_stack.h

27 #iâdeà
CK_STACK_H


28 
	#CK_STACK_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_´.h
>

32 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

33 
	~<«ro¥ike/ck/ck_¡ddef.h
>

35 
	sck_¡ack_’Œy
 {

36 
ck_¡ack_’Œy
 *
	mÃxt
;

38 
ck_¡ack_’Œy
 
	tck_¡ack_’Œy_t
;

40 
	sck_¡ack
 {

41 
ck_¡ack_’Œy
 *
	mh—d
;

42 *
g’”©iÚ
 
	mCK_CC_PACKED
;

43 } 
	gCK_CC_ALIASED
;

44 
ck_¡ack
 
	tck_¡ack_t
;

46 
	#CK_STACK_INITIALIZER
 { 
NULL
, NULL }

	)

48 #iâdeà
CK_F_STACK_PUSH_UPMC


49 
	#CK_F_STACK_PUSH_UPMC


	)

53 
CK_CC_INLINE
 

54 
	$ck_¡ack_push_upmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

56 
ck_¡ack_’Œy
 *
¡ack
;

58 
¡ack
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

59 
’Œy
->
Ãxt
 = 
¡ack
;

60 
	`ck_´_ãnû_¡Üe
();

62 
	`ck_´_ÿs_±r_v®ue
(&
rg‘
->
h—d
, 
¡ack
, 
’Œy
, &¡ackè=ğ
çl£
) {

63 
’Œy
->
Ãxt
 = 
¡ack
;

64 
	`ck_´_ãnû_¡Üe
();

68 
	}
}

71 #iâdeà
CK_F_STACK_TRYPUSH_UPMC


72 
	#CK_F_STACK_TRYPUSH_UPMC


	)

77 
CK_CC_INLINE
 
boŞ


78 
	$ck_¡ack_Œypush_upmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

80 
ck_¡ack_’Œy
 *
¡ack
;

82 
¡ack
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

83 
’Œy
->
Ãxt
 = 
¡ack
;

84 
	`ck_´_ãnû_¡Üe
();

86  
	`ck_´_ÿs_±r
(&
rg‘
->
h—d
, 
¡ack
, 
’Œy
);

87 
	}
}

90 #iâdeà
CK_F_STACK_POP_UPMC


91 
	#CK_F_STACK_POP_UPMC


	)

95 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

96 
	$ck_¡ack_pİ_upmc
(
ck_¡ack
 *
rg‘
)

98 
ck_¡ack_’Œy
 *
’Œy
, *
Ãxt
;

100 
’Œy
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

101 ià(
’Œy
 =ğ
NULL
)

102  
NULL
;

104 
	`ck_´_ãnû_lßd
();

105 
Ãxt
 = 
’Œy
->next;

106 
	`ck_´_ÿs_±r_v®ue
(&
rg‘
->
h—d
, 
’Œy
, 
Ãxt
, &’Œyè=ğ
çl£
) {

107 ià(
’Œy
 =ğ
NULL
)

110 
	`ck_´_ãnû_lßd
();

111 
Ãxt
 = 
’Œy
->next;

114  
’Œy
;

115 
	}
}

118 #iâdeà
CK_F_STACK_TRYPOP_UPMC


119 
	#CK_F_STACK_TRYPOP_UPMC


	)

126 
CK_CC_INLINE
 
boŞ


127 
	$ck_¡ack_Œypİ_upmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 **
r
)

129 
ck_¡ack_’Œy
 *
’Œy
;

131 
’Œy
 = 
	`ck_´_lßd_±r
(&
rg‘
->
h—d
);

132 ià(
’Œy
 =ğ
NULL
)

133  
çl£
;

135 
	`ck_´_ãnû_lßd
();

136 ià(
	`ck_´_ÿs_±r
(&
rg‘
->
h—d
, 
’Œy
,ƒÁry->
Ãxt
è=ğ
Œue
) {

137 *
r
 = 
’Œy
;

138  
Œue
;

141  
çl£
;

142 
	}
}

145 #iâdeà
CK_F_STACK_BATCH_POP_UPMC


146 
	#CK_F_STACK_BATCH_POP_UPMC


	)

150 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

151 
	$ck_¡ack_b©ch_pİ_upmc
(
ck_¡ack
 *
rg‘
)

153 
ck_¡ack_’Œy
 *
’Œy
;

155 
’Œy
 = 
	`ck_´_çs_±r
(&
rg‘
->
h—d
, 
NULL
);

156 
	`ck_´_ãnû_lßd
();

157  
’Œy
;

158 
	}
}

161 #iâdeà
CK_F_STACK_PUSH_MPMC


162 
	#CK_F_STACK_PUSH_MPMC


	)

166 
CK_CC_INLINE
 

167 
	$ck_¡ack_push_mpmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

170 
	`ck_¡ack_push_upmc
(
rg‘
, 
’Œy
);

172 
	}
}

175 #iâdeà
CK_F_STACK_TRYPUSH_MPMC


176 
	#CK_F_STACK_TRYPUSH_MPMC


	)

180 
CK_CC_INLINE
 
boŞ


181 
	$ck_¡ack_Œypush_mpmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

184  
	`ck_¡ack_Œypush_upmc
(
rg‘
, 
’Œy
);

185 
	}
}

188 #ifdeà
CK_F_PR_CAS_PTR_2_VALUE


189 #iâdeà
CK_F_STACK_POP_MPMC


190 
	#CK_F_STACK_POP_MPMC


	)

194 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

195 
	$ck_¡ack_pİ_mpmc
(
ck_¡ack
 *
rg‘
)

197 
ck_¡ack
 
Üigš®
, 
upd©e
;

199 
Üigš®
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
rg‘
->generation);

200 
	`ck_´_ãnû_lßd
();

201 
Üigš®
.
h—d
 = 
	`ck_´_lßd_±r
(&
rg‘
->head);

202 ià(
Üigš®
.
h—d
 =ğ
NULL
)

203  
NULL
;

206 
	`ck_´_ãnû_lßd
();

208 
upd©e
.
g’”©iÚ
 = 
Üigš®
.generation + 1;

209 
upd©e
.
h—d
 = 
Üigš®
.h—d->
Ãxt
;

211 
	`ck_´_ÿs_±r_2_v®ue
(
rg‘
, &
Üigš®
, &
upd©e
, &Üigš®è=ğ
çl£
) {

212 ià(
Üigš®
.
h—d
 =ğ
NULL
)

213  
NULL
;

215 
upd©e
.
g’”©iÚ
 = 
Üigš®
.generation + 1;

218 
	`ck_´_ãnû_lßd
();

219 
upd©e
.
h—d
 = 
Üigš®
.h—d->
Ãxt
;

222  
Üigš®
.
h—d
;

223 
	}
}

226 #iâdeà
CK_F_STACK_TRYPOP_MPMC


227 
	#CK_F_STACK_TRYPOP_MPMC


	)

228 
CK_CC_INLINE
 
boŞ


229 
	$ck_¡ack_Œypİ_mpmc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 **
r
)

231 
ck_¡ack
 
Üigš®
, 
upd©e
;

233 
Üigš®
.
g’”©iÚ
 = 
	`ck_´_lßd_±r
(&
rg‘
->generation);

234 
	`ck_´_ãnû_lßd
();

235 
Üigš®
.
h—d
 = 
	`ck_´_lßd_±r
(&
rg‘
->head);

236 ià(
Üigš®
.
h—d
 =ğ
NULL
)

237  
çl£
;

239 
upd©e
.
g’”©iÚ
 = 
Üigš®
.generation + 1;

240 
	`ck_´_ãnû_lßd
();

241 
upd©e
.
h—d
 = 
Üigš®
.h—d->
Ãxt
;

243 ià(
	`ck_´_ÿs_±r_2_v®ue
(
rg‘
, &
Üigš®
, &
upd©e
, &Üigš®è=ğ
Œue
) {

244 *
r
 = 
Üigš®
.
h—d
;

245  
Œue
;

248  
çl£
;

249 
	}
}

253 #iâdeà
CK_F_STACK_BATCH_POP_MPMC


254 
	#CK_F_STACK_BATCH_POP_MPMC


	)

259 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

260 
	$ck_¡ack_b©ch_pİ_mpmc
(
ck_¡ack
 *
rg‘
)

263  
	`ck_¡ack_b©ch_pİ_upmc
(
rg‘
);

264 
	}
}

267 #iâdeà
CK_F_STACK_PUSH_MPNC


268 
	#CK_F_STACK_PUSH_MPNC


	)

272 
CK_CC_INLINE
 

273 
	$ck_¡ack_push_m²c
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

275 
ck_¡ack_’Œy
 *
¡ack
;

277 
’Œy
->
Ãxt
 = 
NULL
;

278 
	`ck_´_ãnû_¡Üe_©omic
();

279 
¡ack
 = 
	`ck_´_çs_±r
(&
rg‘
->
h—d
, 
’Œy
);

280 
	`ck_´_¡Üe_±r
(&
’Œy
->
Ãxt
, 
¡ack
);

281 
	`ck_´_ãnû_¡Üe
();

284 
	}
}

290 
CK_CC_INLINE
 

291 
	$ck_¡ack_push_¥nc
(
ck_¡ack
 *
rg‘
, 
ck_¡ack_’Œy
 *
’Œy
)

294 
’Œy
->
Ãxt
 = 
rg‘
->
h—d
;

295 
rg‘
->
h—d
 = 
’Œy
;

297 
	}
}

302 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

303 
	$ck_¡ack_pİ_Åsc
(
ck_¡ack
 *
rg‘
)

305 
ck_¡ack_’Œy
 *
n
;

307 ià(
rg‘
->
h—d
 =ğ
NULL
)

308  
NULL
;

310 
n
 = 
rg‘
->
h—d
;

311 
rg‘
->
h—d
 = 
n
->
Ãxt
;

313  
n
;

314 
	}
}

319 
CK_CC_INLINE
 
ck_¡ack_’Œy
 *

320 
	$ck_¡ack_b©ch_pİ_Åsc
(
ck_¡ack
 *
rg‘
)

322 
ck_¡ack_’Œy
 *
n
;

324 
n
 = 
rg‘
->
h—d
;

325 
rg‘
->
h—d
 = 
NULL
;

327  
n
;

328 
	}
}

333 
CK_CC_INLINE
 

334 
	$ck_¡ack_š™
(
ck_¡ack
 *
¡ack
)

337 
¡ack
->
h—d
 = 
NULL
;

338 
¡ack
->
g’”©iÚ
 = 
NULL
;

340 
	}
}

343 
	#CK_STACK_CONTAINER
(
T
, 
M
, 
N
è
	`CK_CC_CONTAINER
(
ck_¡ack_’Œy_t
, T, M, N)

	)

345 
	#CK_STACK_ISEMPTY
(
m
è((m)->
h—d
 =ğ
NULL
)

	)

346 
	#CK_STACK_FIRST
(
s
è((s)->
h—d
)

	)

347 
	#CK_STACK_NEXT
(
m
è((m)->
Ãxt
)

	)

348 
	#CK_STACK_FOREACH
(
¡ack
, 
’Œy
) \

349 (
’Œy
èğ
	`CK_STACK_FIRST
(
¡ack
); \

350 (
’Œy
è!ğ
NULL
; \

351 (
’Œy
èğ
	`CK_STACK_NEXT
ÓÁry))

	)

352 
	#CK_STACK_FOREACH_SAFE
(
¡ack
, 
’Œy
, 
T
) \

353 (
’Œy
èğ
	`CK_STACK_FIRST
(
¡ack
); \

354 (
’Œy
è!ğ
NULL
 && ((
T
èğÓÁry)->
Ãxt
, 1); \

355 (
’Œy
èğ(
T
))

	)

	@application/kvbench/include/aerospike/ck/ck_stdbool.h

27 #ià
defšed
(
__F»eBSD__
è&& defšed(
_KERNEL
)

28 
	~<sys/ty³s.h
>

30 
	~<¡dboŞ.h
>

	@application/kvbench/include/aerospike/ck/ck_stddef.h

27 #ià
defšed
(
__F»eBSD__
è&& defšed(
_KERNEL
)

28 
	~<sys/¡ddef.h
>

30 
	~<¡ddef.h
>

	@application/kvbench/include/aerospike/ck/ck_stdint.h

27 #ià
defšed
(
__lšux__
è&& defšed(
__KERNEL__
)

28 
	~<lšux/k”Ãl.h
>

29 
	~<lšux/ty³s.h
>

30 #–ià
defšed
(
__F»eBSD__
è&& defšed(
_KERNEL
)

31 
	~<sys/¡dšt.h
>

33 
	~<¡dšt.h
>

	@application/kvbench/include/aerospike/ck/ck_stdlib.h

27 #ià
defšed
(
__F»eBSD__
è&& defšed(
_KERNEL
)

28 
	~<sys/sy¡m.h
>

30 
	~<¡dlib.h
>

	@application/kvbench/include/aerospike/ck/ck_string.h

27 #ià
defšed
(
__F»eBSD__
è&& defšed(
_KERNEL
)

28 
	~<sys/sy¡m.h
>

30 
	~<¡ršg.h
>

	@application/kvbench/include/aerospike/ck/ck_swlock.h

28 #iâdeà
CK_SWLOCK_H


29 
	#CK_SWLOCK_H


	)

31 
	~<«ro¥ike/ck/ck_–ide.h
>

32 
	~<«ro¥ike/ck/ck_lim™s.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

35 
	~<«ro¥ike/ck/ck_¡ddef.h
>

37 
	sck_swlock
 {

38 
ušt32_t
 
	mv®ue
;

40 
ck_swlock
 
	tck_swlock_t
;

42 
	#CK_SWLOCK_INITIALIZER
 {0}

	)

43 
	#CK_SWLOCK_WRITER_BIT
 (1UL << 31)

	)

44 
	#CK_SWLOCK_LATCH_BIT
 (1UL << 30)

	)

45 
	#CK_SWLOCK_WRITER_MASK
 (
CK_SWLOCK_LATCH_BIT
 | 
CK_SWLOCK_WRITER_BIT
)

	)

46 
	#CK_SWLOCK_READER_MASK
 (
UINT32_MAX
 ^ 
CK_SWLOCK_WRITER_MASK
)

	)

48 
CK_CC_INLINE
 

49 
	$ck_swlock_š™
(
ck_swlock
 *
rw
)

52 
rw
->
v®ue
 = 0;

53 
	`ck_´_b¬r›r
();

55 
	}
}

57 
CK_CC_INLINE
 

58 
	$ck_swlock_wr™e_uÆock
(
ck_swlock_t
 *
rw
)

61 
	`ck_´_ãnû_uÆock
();

62 
	`ck_´_ªd_32
(&
rw
->
v®ue
, 
CK_SWLOCK_READER_MASK
);

64 
	}
}

66 
CK_CC_INLINE
 
boŞ


67 
	$ck_swlock_locked_wr™”
(
ck_swlock_t
 *
rw
)

69 
boŞ
 
r
;

71 
r
 = 
	`ck_´_lßd_32
(&
rw
->
v®ue
è& 
CK_SWLOCK_WRITER_BIT
;

72 
	`ck_´_ãnû_acquœe
();

73  
r
;

74 
	}
}

76 
CK_CC_INLINE
 

77 
	$ck_swlock_wr™e_downg¿de
(
ck_swlock_t
 *
rw
)

80 
	`ck_´_šc_32
(&
rw
->
v®ue
);

81 
	`ck_swlock_wr™e_uÆock
(
rw
);

83 
	}
}

85 
CK_CC_INLINE
 
boŞ


86 
	$ck_swlock_locked
(
ck_swlock_t
 *
rw
)

88 
boŞ
 
r
;

90 
r
 = 
	`ck_´_lßd_32
(&
rw
->
v®ue
);

91 
	`ck_´_ãnû_acquœe
();

92  
r
;

93 
	}
}

95 
CK_CC_INLINE
 
boŞ


96 
	$ck_swlock_wr™e_Œylock
(
ck_swlock_t
 *
rw
)

98 
boŞ
 
r
;

100 
r
 = 
	`ck_´_ÿs_32
(&
rw
->
v®ue
, 0, 
CK_SWLOCK_WRITER_BIT
);

101 
	`ck_´_ãnû_lock
();

102  
r
;

103 
	}
}

105 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_swlock_wr™e
, 
ck_swlock_t
,

106 
ck_swlock_locked
, 
ck_swlock_wr™e_Œylock
)

108 
CK_CC_INLINE
 

109 
	$ck_swlock_wr™e_lock
(
ck_swlock_t
 *
rw
)

112 
	`ck_´_Ü_32
(&
rw
->
v®ue
, 
CK_SWLOCK_WRITER_BIT
);

113 
	`ck_´_lßd_32
(&
rw
->
v®ue
è& 
CK_SWLOCK_READER_MASK
)

114 
	`ck_´_¡®l
();

116 
	`ck_´_ãnû_lock
();

118 
	}
}

120 
CK_CC_INLINE
 

121 
	$ck_swlock_wr™e_Ïtch
(
ck_swlock_t
 *
rw
)

125 
	`ck_´_Ü_32
(&
rw
->
v®ue
, 
CK_SWLOCK_WRITER_BIT
);

128 
	`ck_´_ÿs_32
(&
rw
->
v®ue
, 
CK_SWLOCK_WRITER_BIT
,

129 
CK_SWLOCK_WRITER_MASK
è=ğ
çl£
) {

131 
	`ck_´_¡®l
();

132 } 
	`ck_´_lßd_32
(&
rw
->
v®ue
è!ğ
CK_SWLOCK_WRITER_BIT
);

135 
	`ck_´_ãnû_lock
();

137 
	}
}

139 
CK_CC_INLINE
 

140 
	$ck_swlock_wr™e_uÆ©ch
(
ck_swlock_t
 *
rw
)

143 
	`ck_´_ãnû_uÆock
();

144 
	`ck_´_¡Üe_32
(&
rw
->
v®ue
, 0);

146 
	}
}

148 
	$CK_ELIDE_PROTOTYPE
(
ck_swlock_wr™e
, 
ck_swlock_t
,

149 
ck_swlock_locked
, 
ck_swlock_wr™e_lock
,

150 
ck_swlock_locked_wr™”
, 
ck_swlock_wr™e_uÆock
)

152 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_swlock_»ad
, 
ck_swlock_t
,

153 
ck_swlock_locked_wr™”
, 
ck_swlock_»ad_Œylock
)

155 
CK_CC_INLINE
 
boŞ


156 
	$ck_swlock_»ad_Œylock
(
ck_swlock_t
 *
rw
)

158 
ušt32_t
 
l
 = 
	`ck_´_lßd_32
(&
rw
->
v®ue
);

160 ià(
l
 & 
CK_SWLOCK_WRITER_BIT
)

161  
çl£
;

163 
l
 = 
	`ck_´_ça_32
(&
rw
->
v®ue
, 1è& 
CK_SWLOCK_WRITER_MASK
;

164 ià(
l
 =ğ
CK_SWLOCK_WRITER_BIT
)

165 
	`ck_´_dec_32
(&
rw
->
v®ue
);

167 
	`ck_´_ãnû_lock
();

168  
l
 == 0;

169 
	}
}

171 
CK_CC_INLINE
 

172 
	$ck_swlock_»ad_lock
(
ck_swlock_t
 *
rw
)

174 
ušt32_t
 
l
;

177 
	`ck_´_lßd_32
(&
rw
->
v®ue
è& 
CK_SWLOCK_WRITER_BIT
)

178 
	`ck_´_¡®l
();

180 
l
 = 
	`ck_´_ça_32
(&
rw
->
v®ue
, 1è& 
CK_SWLOCK_WRITER_MASK
;

181 ià(
l
 == 0)

189 ià(
l
 =ğ
CK_SWLOCK_WRITER_BIT
)

190 
	`ck_´_dec_32
(&
rw
->
v®ue
);

193 
	`ck_´_ãnû_lock
();

195 
	}
}

197 
CK_CC_INLINE
 
boŞ


198 
	$ck_swlock_locked_»ad”
(
ck_swlock_t
 *
rw
)

201 
	`ck_´_ãnû_lßd
();

202  
	`ck_´_lßd_32
(&
rw
->
v®ue
è& 
CK_SWLOCK_READER_MASK
;

203 
	}
}

205 
CK_CC_INLINE
 

206 
	$ck_swlock_»ad_uÆock
(
ck_swlock_t
 *
rw
)

209 
	`ck_´_ãnû_uÆock
();

210 
	`ck_´_dec_32
(&
rw
->
v®ue
);

212 
	}
}

214 
	$CK_ELIDE_PROTOTYPE
(
ck_swlock_»ad
, 
ck_swlock_t
,

215 
ck_swlock_locked_wr™”
, 
ck_swlock_»ad_lock
,

216 
ck_swlock_locked_»ad”
, 
ck_swlock_»ad_uÆock
)

	@application/kvbench/include/aerospike/ck/ck_tflock.h

27 #iâdeà
CK_TFLOCK_TICKET_H


28 
	#CK_TFLOCK_TICKET_H


	)

38 
	~<«ro¥ike/ck/ck_cc.h
>

39 
	~<«ro¥ike/ck/ck_´.h
>

41 
	sck_tæock_tick‘
 {

42 
ušt32_t
 
	m»que¡
;

43 
ušt32_t
 
	mcom¶‘iÚ
;

45 
ck_tæock_tick‘
 
	tck_tæock_tick‘_t
;

47 
	#CK_TFLOCK_TICKET_INITIALIZER
 { 0, 0 }

	)

49 
	#CK_TFLOCK_TICKET_RC_INCR
 0x10000U

	)

50 
	#CK_TFLOCK_TICKET_WC_INCR
 0x1U

	)

51 
	#CK_TFLOCK_TICKET_W_MASK
 0xffffU

	)

52 
	#CK_TFLOCK_TICKET_WC_TOPMSK
 0x8000U

	)

53 
	#CK_TFLOCK_TICKET_RC_TOPMSK
 0x80000000U

	)

55 
CK_CC_INLINE
 
ušt32_t


56 
	$ck_tæock_tick‘_fÿ_32
(
ušt32_t
 *
rg‘
, ušt32_ˆ
mask
, ušt32_ˆ
d–
)

58 
ušt32_t
 
¢­shÙ
 = 
	`ck_´_lßd_32
(
rg‘
);

59 
ušt32_t
 
gßl
;

62 
gßl
 = (
¢­shÙ
 & ~
mask
è+ 
d–
;

63 ià(
	`ck_´_ÿs_32_v®ue
(
rg‘
, 
¢­shÙ
, 
gßl
, &¢­shÙè=ğ
Œue
)

66 
	`ck_´_¡®l
();

69  
¢­shÙ
;

70 
	}
}

72 
CK_CC_INLINE
 

73 
	$ck_tæock_tick‘_š™
(
ck_tæock_tick‘
 *
pf
)

76 
pf
->
»que¡
 =…f->
com¶‘iÚ
 = 0;

77 
	`ck_´_b¬r›r
();

79 
	}
}

81 
CK_CC_INLINE
 

82 
	$ck_tæock_tick‘_wr™e_lock
(
ck_tæock_tick‘
 *
lock
)

84 
ušt32_t
 
´evious
;

86 
´evious
 = 
	`ck_tæock_tick‘_fÿ_32
(&
lock
->
»que¡
, 
CK_TFLOCK_TICKET_WC_TOPMSK
,

87 
CK_TFLOCK_TICKET_WC_INCR
);

88 
	`ck_´_ãnû_©omic_lßd
();

89 
	`ck_´_lßd_32
(&
lock
->
com¶‘iÚ
è!ğ
´evious
)

90 
	`ck_´_¡®l
();

92 
	`ck_´_ãnû_lock
();

94 
	}
}

96 
CK_CC_INLINE
 

97 
	$ck_tæock_tick‘_wr™e_uÆock
(
ck_tæock_tick‘
 *
lock
)

100 
	`ck_´_ãnû_uÆock
();

101 
	`ck_tæock_tick‘_fÿ_32
(&
lock
->
com¶‘iÚ
, 
CK_TFLOCK_TICKET_WC_TOPMSK
,

102 
CK_TFLOCK_TICKET_WC_INCR
);

104 
	}
}

106 
CK_CC_INLINE
 

107 
	$ck_tæock_tick‘_»ad_lock
(
ck_tæock_tick‘
 *
lock
)

109 
ušt32_t
 
´evious
;

111 
´evious
 = 
	`ck_tæock_tick‘_fÿ_32
(&
lock
->
»que¡
,

112 
CK_TFLOCK_TICKET_RC_TOPMSK
, 
CK_TFLOCK_TICKET_RC_INCR
) &

113 
CK_TFLOCK_TICKET_W_MASK
;

115 
	`ck_´_ãnû_©omic_lßd
();

117 (
	`ck_´_lßd_32
(&
lock
->
com¶‘iÚ
) &

118 
CK_TFLOCK_TICKET_W_MASK
è!ğ
´evious
) {

119 
	`ck_´_¡®l
();

122 
	`ck_´_ãnû_lock
();

124 
	}
}

126 
CK_CC_INLINE
 

127 
	$ck_tæock_tick‘_»ad_uÆock
(
ck_tæock_tick‘
 *
lock
)

130 
	`ck_´_ãnû_uÆock
();

131 
	`ck_tæock_tick‘_fÿ_32
(&
lock
->
com¶‘iÚ
, 
CK_TFLOCK_TICKET_RC_TOPMSK
,

132 
CK_TFLOCK_TICKET_RC_INCR
);

134 
	}
}

	@application/kvbench/include/aerospike/ck/gcc/arm/ck_f_pr.h

2 
	#CK_F_PR_ADD_16


	)

3 
	#CK_F_PR_ADD_32


	)

4 
	#CK_F_PR_ADD_8


	)

5 
	#CK_F_PR_ADD_CHAR


	)

6 
	#CK_F_PR_ADD_INT


	)

7 
	#CK_F_PR_ADD_PTR


	)

8 
	#CK_F_PR_ADD_SHORT


	)

9 
	#CK_F_PR_ADD_UINT


	)

10 
	#CK_F_PR_AND_16


	)

11 
	#CK_F_PR_AND_32


	)

12 
	#CK_F_PR_AND_8


	)

13 
	#CK_F_PR_AND_CHAR


	)

14 
	#CK_F_PR_AND_INT


	)

15 
	#CK_F_PR_AND_PTR


	)

16 
	#CK_F_PR_AND_SHORT


	)

17 
	#CK_F_PR_AND_UINT


	)

18 
	#CK_F_PR_BARRIER


	)

19 
	#CK_F_PR_CAS_16


	)

20 
	#CK_F_PR_CAS_16_VALUE


	)

21 
	#CK_F_PR_CAS_32


	)

22 
	#CK_F_PR_CAS_32_VALUE


	)

23 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

24 
	#CK_F_PR_CAS_64


	)

25 
	#CK_F_PR_CAS_64_VALUE


	)

26 
	#CK_F_PR_CAS_DOUBLE


	)

27 
	#CK_F_PR_CAS_DOUBLE_VALUE


	)

29 
	#CK_F_PR_CAS_8


	)

30 
	#CK_F_PR_CAS_8_VALUE


	)

31 
	#CK_F_PR_CAS_CHAR


	)

32 
	#CK_F_PR_CAS_CHAR_VALUE


	)

33 
	#CK_F_PR_CAS_INT


	)

34 
	#CK_F_PR_CAS_INT_VALUE


	)

35 
	#CK_F_PR_CAS_PTR


	)

36 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

37 
	#CK_F_PR_CAS_PTR_2


	)

38 
	#CK_F_PR_CAS_PTR_2_VALUE


	)

40 
	#CK_F_PR_CAS_PTR_VALUE


	)

41 
	#CK_F_PR_CAS_SHORT


	)

42 
	#CK_F_PR_CAS_SHORT_VALUE


	)

43 
	#CK_F_PR_CAS_UINT


	)

44 
	#CK_F_PR_CAS_UINT_VALUE


	)

45 
	#CK_F_PR_DEC_16


	)

46 
	#CK_F_PR_DEC_32


	)

47 
	#CK_F_PR_DEC_8


	)

48 
	#CK_F_PR_DEC_CHAR


	)

49 
	#CK_F_PR_DEC_INT


	)

50 
	#CK_F_PR_DEC_PTR


	)

51 
	#CK_F_PR_DEC_SHORT


	)

52 
	#CK_F_PR_DEC_UINT


	)

53 
	#CK_F_PR_FAA_16


	)

54 
	#CK_F_PR_FAA_32


	)

55 
	#CK_F_PR_FAA_8


	)

56 
	#CK_F_PR_FAA_CHAR


	)

57 
	#CK_F_PR_FAA_INT


	)

58 
	#CK_F_PR_FAA_PTR


	)

59 
	#CK_F_PR_FAA_SHORT


	)

60 
	#CK_F_PR_FAA_UINT


	)

61 
	#CK_F_PR_FAS_16


	)

62 
	#CK_F_PR_FAS_32


	)

63 
	#CK_F_PR_FAS_8


	)

64 
	#CK_F_PR_FAS_CHAR


	)

65 
	#CK_F_PR_FAS_INT


	)

66 
	#CK_F_PR_FAS_PTR


	)

67 
	#CK_F_PR_FAS_SHORT


	)

68 
	#CK_F_PR_FAS_UINT


	)

69 
	#CK_F_PR_FENCE_ATOMIC


	)

70 
	#CK_F_PR_FENCE_ATOMIC_LOAD


	)

71 
	#CK_F_PR_FENCE_ATOMIC_STORE


	)

72 
	#CK_F_PR_FENCE_LOAD


	)

73 
	#CK_F_PR_FENCE_LOAD_ATOMIC


	)

74 
	#CK_F_PR_FENCE_LOAD_DEPENDS


	)

75 
	#CK_F_PR_FENCE_LOAD_STORE


	)

76 
	#CK_F_PR_FENCE_MEMORY


	)

77 
	#CK_F_PR_FENCE_STORE


	)

78 
	#CK_F_PR_FENCE_STORE_ATOMIC


	)

79 
	#CK_F_PR_FENCE_STORE_LOAD


	)

80 
	#CK_F_PR_FENCE_STRICT_ATOMIC


	)

81 
	#CK_F_PR_FENCE_STRICT_ATOMIC_LOAD


	)

82 
	#CK_F_PR_FENCE_STRICT_ATOMIC_STORE


	)

83 
	#CK_F_PR_FENCE_STRICT_LOAD


	)

84 
	#CK_F_PR_FENCE_STRICT_LOAD_ATOMIC


	)

85 
	#CK_F_PR_FENCE_STRICT_LOAD_STORE


	)

86 
	#CK_F_PR_FENCE_STRICT_MEMORY


	)

87 
	#CK_F_PR_FENCE_STRICT_STORE


	)

88 
	#CK_F_PR_FENCE_STRICT_STORE_ATOMIC


	)

89 
	#CK_F_PR_FENCE_STRICT_STORE_LOAD


	)

90 
	#CK_F_PR_INC_16


	)

91 
	#CK_F_PR_INC_32


	)

92 
	#CK_F_PR_INC_8


	)

93 
	#CK_F_PR_INC_CHAR


	)

94 
	#CK_F_PR_INC_INT


	)

95 
	#CK_F_PR_INC_PTR


	)

96 
	#CK_F_PR_INC_SHORT


	)

97 
	#CK_F_PR_INC_UINT


	)

98 
	#CK_F_PR_LOAD_16


	)

99 
	#CK_F_PR_LOAD_32


	)

100 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

101 
	#CK_F_PR_LOAD_64


	)

102 
	#CK_F_PR_LOAD_DOUBLE


	)

104 
	#CK_F_PR_LOAD_8


	)

105 
	#CK_F_PR_LOAD_CHAR


	)

106 
	#CK_F_PR_LOAD_INT


	)

107 
	#CK_F_PR_LOAD_PTR


	)

108 
	#CK_F_PR_LOAD_SHORT


	)

109 
	#CK_F_PR_LOAD_UINT


	)

110 
	#CK_F_PR_NEG_16


	)

111 
	#CK_F_PR_NEG_32


	)

112 
	#CK_F_PR_NEG_8


	)

113 
	#CK_F_PR_NEG_CHAR


	)

114 
	#CK_F_PR_NEG_INT


	)

115 
	#CK_F_PR_NEG_PTR


	)

116 
	#CK_F_PR_NEG_SHORT


	)

117 
	#CK_F_PR_NEG_UINT


	)

118 
	#CK_F_PR_NOT_16


	)

119 
	#CK_F_PR_NOT_32


	)

120 
	#CK_F_PR_NOT_8


	)

121 
	#CK_F_PR_NOT_CHAR


	)

122 
	#CK_F_PR_NOT_INT


	)

123 
	#CK_F_PR_NOT_PTR


	)

124 
	#CK_F_PR_NOT_SHORT


	)

125 
	#CK_F_PR_NOT_UINT


	)

126 
	#CK_F_PR_OR_16


	)

127 
	#CK_F_PR_OR_32


	)

128 
	#CK_F_PR_OR_8


	)

129 
	#CK_F_PR_OR_CHAR


	)

130 
	#CK_F_PR_OR_INT


	)

131 
	#CK_F_PR_OR_PTR


	)

132 
	#CK_F_PR_OR_SHORT


	)

133 
	#CK_F_PR_OR_UINT


	)

134 
	#CK_F_PR_STALL


	)

135 
	#CK_F_PR_STORE_16


	)

136 
	#CK_F_PR_STORE_32


	)

137 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

138 
	#CK_F_PR_STORE_64


	)

139 
	#CK_F_PR_STORE_DOUBLE


	)

141 
	#CK_F_PR_STORE_8


	)

142 
	#CK_F_PR_STORE_CHAR


	)

143 
	#CK_F_PR_STORE_INT


	)

144 
	#CK_F_PR_STORE_PTR


	)

145 
	#CK_F_PR_STORE_SHORT


	)

146 
	#CK_F_PR_STORE_UINT


	)

147 
	#CK_F_PR_SUB_16


	)

148 
	#CK_F_PR_SUB_32


	)

149 
	#CK_F_PR_SUB_8


	)

150 
	#CK_F_PR_SUB_CHAR


	)

151 
	#CK_F_PR_SUB_INT


	)

152 
	#CK_F_PR_SUB_PTR


	)

153 
	#CK_F_PR_SUB_SHORT


	)

154 
	#CK_F_PR_SUB_UINT


	)

155 
	#CK_F_PR_XOR_16


	)

156 
	#CK_F_PR_XOR_32


	)

157 
	#CK_F_PR_XOR_8


	)

158 
	#CK_F_PR_XOR_CHAR


	)

159 
	#CK_F_PR_XOR_INT


	)

160 
	#CK_F_PR_XOR_PTR


	)

161 
	#CK_F_PR_XOR_SHORT


	)

162 
	#CK_F_PR_XOR_UINT


	)

	@application/kvbench/include/aerospike/ck/gcc/arm/ck_pr.h

28 #iâdeà
CK_PR_ARM_H


29 
	#CK_PR_ARM_H


	)

31 #iâdeà
CK_PR_H


32 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


35 
	~<«ro¥ike/ck/ck_cc.h
>

36 
	~<«ro¥ike/ck/ck_md.h
>

42 
	~"ck_f_´.h
"

47 
	#CK_F_PR


	)

49 
CK_CC_INLINE
 

50 
	$ck_´_¡®l
()

53 
__asm__
 
	`__vŞ©e__
("" ::: "memory");

55 
	}
}

57 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

58 
	#CK_ISB
 
__asm
 
	`__vŞ©e
("isb" : : "r" (0è: "memÜy")

	)

59 
	#CK_DMB
 
__asm
 
	`__vŞ©e
("dmb" : : "r" (0è: "memÜy")

	)

60 
	#CK_DSB
 
__asm
 
	`__vŞ©e
("dsb" : : "r" (0è: "memÜy")

	)

62 #ifdeà
__F»eBSD__


63 
	#CK_DMB_ST
 
__asm
 
	`__vŞ©e
(".wÜd 0xf57ff05e" : : "r" (0è: "memÜy")

	)

65 
	#CK_DMB_ST
 
__asm
 
	`__vŞ©e
("dmb st" : : "r" (0è: "memÜy")

	)

69 
	#CK_ISB
 \

70 
__asm
 
	`__vŞ©e
("mü…15, 0, %0, c7, c5, 4" : : "r" (0è: "memÜy")

	)

71 
	#CK_DSB
 \

72 
__asm
 
	`__vŞ©e
("mü…15, 0, %0, c7, c10, 4" : : "r" (0è: "memÜy")

	)

73 
	#CK_DMB
 \

74 
__asm
 
	`__vŞ©e
("mü…15, 0, %0, c7, c10, 5" : : "r" (0è: "memÜy")

	)

75 
	#CK_DMB_ST
 
CK_DMB


	)

78 
	#CK_PR_FENCE
(
T
, 
I
) \

79 
CK_CC_INLINE
 \

80 
ck_´_ãnû_¡riù_
##
	`T
() \

82 
I
; \

83 }

	)

85 
	$CK_PR_FENCE
(
©omic
, 
CK_DMB_ST
)

86 
	$CK_PR_FENCE
(
©omic_¡Üe
, 
CK_DMB_ST
)

87 
	$CK_PR_FENCE
(
©omic_lßd
, 
CK_DMB_ST
)

88 
	$CK_PR_FENCE
(
¡Üe_©omic
, 
CK_DMB_ST
)

89 
	$CK_PR_FENCE
(
lßd_©omic
, 
CK_DMB
)

90 
	$CK_PR_FENCE
(
¡Üe
, 
CK_DMB_ST
)

91 
	$CK_PR_FENCE
(
¡Üe_lßd
, 
CK_DMB
)

92 
	$CK_PR_FENCE
(
lßd
, 
CK_DMB
)

93 
	$CK_PR_FENCE
(
lßd_¡Üe
, 
CK_DMB
)

94 
	$CK_PR_FENCE
(
memÜy
, 
CK_DMB
)

95 
	$CK_PR_FENCE
(
acquœe
, 
CK_DMB
)

96 
	$CK_PR_FENCE
(
»Ëa£
, 
CK_DMB
)

97 
	$CK_PR_FENCE
(
acq»l
, 
CK_DMB
)

98 
	$CK_PR_FENCE
(
lock
, 
CK_DMB
)

99 
	$CK_PR_FENCE
(
uÆock
, 
CK_DMB
)

101 #undeà
CK_PR_FENCE


103 #undeà
CK_ISB


104 #undeà
CK_DSB


105 #undeà
CK_DMB


106 #undeà
CK_DMB_ST


108 
	#CK_PR_LOAD
(
S
, 
M
, 
T
, 
C
, 
I
) \

109 
CK_CC_INLINE
 
T
 \

110 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

112 
r
 = 0; \

113 
__asm__
 
	`__vŞ©e__
(
I
 " %0, [%1];" \

114 : "ô" (
r
) \

115 : "r" (
rg‘
) \

117  ((
T
)
r
); \

118 
	}

	)
}

120 
CK_PR_LOAD
(
±r
, , *, 
ušt32_t
, "ldr")

122 
	#CK_PR_LOAD_S
(
S
, 
T
, 
I
è
	`CK_PR_LOAD
(S, T, T, T, I)

	)

124 
CK_PR_LOAD_S
(32, 
ušt32_t
, "ldr")

125 
CK_PR_LOAD_S
(16, 
ušt16_t
, "ldrh")

126 
CK_PR_LOAD_S
(8, 
ušt8_t
, "ldrb")

127 
CK_PR_LOAD_S
(
ušt
, , "ldr")

128 
CK_PR_LOAD_S
(, , "ldr")

129 
CK_PR_LOAD_S
(, , "ldrh")

130 
CK_PR_LOAD_S
(, , "ldrb")

132 #undeà
CK_PR_LOAD_S


133 #undeà
CK_PR_LOAD


135 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

137 
	#CK_PR_DOUBLE_LOAD
(
T
, 
N
) \

138 
CK_CC_INLINE
 
T
 \

139 
ck_´_md_lßd_
##
	`N
(cÚ¡ 
T
 *
rg‘
) \

141 
T
 
»t
; \

143 
__asm
 
	`__vŞ©e
("ldrexd %0, [%1]" \

144 : "=&r" (
»t
) \

145 : "r" (
rg‘
) \

147  (
»t
); \

148 }

	)

150 
	$CK_PR_DOUBLE_LOAD
(
ušt64_t
, 64)

151 
	$CK_PR_DOUBLE_LOAD
(, )

152 #undeà
CK_PR_DOUBLE_LOAD


155 
	#CK_PR_STORE
(
S
, 
M
, 
T
, 
C
, 
I
) \

156 
CK_CC_INLINE
 \

157 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

159 
__asm__
 
	`__vŞ©e__
(
I
 " %1, [%0]" \

161 : "r" (
rg‘
), \

162 "r" (
v
) \

165 
	}

	)
}

167 
CK_PR_STORE
(
±r
, , cÚ¡ *, 
ušt32_t
, "str")

169 
	#CK_PR_STORE_S
(
S
, 
T
, 
I
è
	`CK_PR_STORE
(S, T, T, T, I)

	)

171 
CK_PR_STORE_S
(32, 
ušt32_t
, "str")

172 
CK_PR_STORE_S
(16, 
ušt16_t
, "strh")

173 
CK_PR_STORE_S
(8, 
ušt8_t
, "strb")

174 
CK_PR_STORE_S
(
ušt
, , "str")

175 
CK_PR_STORE_S
(, , "str")

176 
CK_PR_STORE_S
(, , "strh")

177 
CK_PR_STORE_S
(, , "strb")

179 #undeà
CK_PR_STORE_S


180 #undeà
CK_PR_STORE


182 #ià
defšed
(
__ARM_ARCH_7__
è|| defšed(
__ARM_ARCH_7A__
)

184 
	#CK_PR_DOUBLE_STORE
(
T
, 
N
) \

185 
CK_CC_INLINE
 \

186 
ck_´_md_¡Üe_
##
	`N
(cÚ¡ 
T
 *
rg‘
, T 
v®ue
) \

188 
T
 
tmp
; \

189 
ušt32_t
 
æag
; \

190 
__asm
 
	`__vŞ©e
("1: \n" \

196 : "=&r" (
tmp
), "=&r" (
æag
) \

197 : "r" (
rg‘
), "r" (
v®ue
) \

199 }

	)

201 
	$CK_PR_DOUBLE_STORE
(
ušt64_t
, 64)

202 
	$CK_PR_DOUBLE_STORE
(, )

204 #undeà
CK_PR_DOUBLE_STORE


206 
	#CK_PR_DOUBLE_CAS_VALUE
(
T
, 
N
) \

207 
CK_CC_INLINE
 
boŞ
 \

208 
ck_´_ÿs_
##
N
##
	`_v®ue
(
T
 *
rg‘
, T 
com·»
, T 
£t
, T *
v®ue
) \

210 
T
 
´evious
; \

211 
tmp
; \

213 
__asm__
 
	`__vŞ©e__
("1:" \

221 :"=&r" (
´evious
), "=&r" (
tmp
) \

222 : "r" (
com·»
), "r" (
£t
) , \

223 "r"(
rg‘
) \

225 *
v®ue
 = 
´evious
; \

226  (*
v®ue
 =ğ
com·»
); \

227 
	}

	)
}

229 
	$CK_PR_DOUBLE_CAS_VALUE
(
ušt64_t
, 64)

230 
	$CK_PR_DOUBLE_CAS_VALUE
(, )

232 #undeà
CK_PR_DOUBLE_CAS_VALUE


234 
CK_CC_INLINE
 
boŞ


235 
	$ck_´_ÿs_±r_2_v®ue
(*
rg‘
, *
com·»
, *
£t
, *
v®ue
)

237 
ušt32_t
 *
_com·»
 = 
	`CK_CPP_CAST
(ušt32_ˆ*, 
com·»
);

238 
ušt32_t
 *
_£t
 = 
	`CK_CPP_CAST
(ušt32_ˆ*, 
£t
);

239 
ušt64_t
 
__com·»
 = ((ušt64_t)
_com·»
[0]) | ((uint64_t)_compare[1] << 32);

240 
ušt64_t
 
__£t
 = ((ušt64_t)
_£t
[0]) | ((uint64_t)_set[1] << 32);

242  (
	`ck_´_ÿs_64_v®ue
(
	`CK_CPP_CAST
(
ušt64_t
 *, 
rg‘
),

243 
__com·»
,

244 
__£t
,

245 
	`CK_CPP_CAST
(
ušt64_t
 *, 
v®ue
)));

246 
	}
}

248 
	#CK_PR_DOUBLE_CAS
(
T
, 
N
) \

249 
CK_CC_INLINE
 
boŞ
 \

250 
ck_´_ÿs_
##
	`N
(
T
 *
rg‘
, T 
com·»
, T 
£t
) \

252 
»t
; \

253 
T
 
tmp
; \

255 
__asm__
 
	`__vŞ©e__
("1:" \

265 : "=&r" (
»t
), "=&r" (
tmp
) \

266 : "r" (
com·»
), "r" (
£t
) , \

267 "r"(
rg‘
) \

270  (
»t
); \

271 }

	)

273 
	$CK_PR_DOUBLE_CAS
(
ušt64_t
, 64)

274 
	$CK_PR_DOUBLE_CAS
(, )

275 
CK_CC_INLINE
 
boŞ


276 
	$ck_´_ÿs_±r_2
(*
rg‘
, *
com·»
, *
£t
)

278 
ušt32_t
 *
_com·»
 = 
	`CK_CPP_CAST
(ušt32_ˆ*, 
com·»
);

279 
ušt32_t
 *
_£t
 = 
	`CK_CPP_CAST
(ušt32_ˆ*, 
£t
);

280 
ušt64_t
 
__com·»
 = ((ušt64_t)
_com·»
[0]) | ((uint64_t)_compare[1] << 32);

281 
ušt64_t
 
__£t
 = ((ušt64_t)
_£t
[0]) | ((uint64_t)_set[1] << 32);

282  (
	`ck_´_ÿs_64
(
	`CK_CPP_CAST
(
ušt64_t
 *, 
rg‘
),

283 
__com·»
,

284 
__£t
));

285 
	}
}

289 
CK_CC_INLINE
 
boŞ


290 
	$ck_´_ÿs_±r_v®ue
(*
rg‘
, *
com·»
, *
£t
, *
v®ue
)

292 *
´evious
, *
tmp
;

293 
__asm__
 
	`__vŞ©e__
("1:"

300 : "=&r" (
´evious
),

301 "=&r" (
tmp
)

302 : "r" (
rg‘
),

303 "r" (
£t
),

304 "r" (
com·»
)

306 *(**)
v®ue
 = 
´evious
;

307  (
´evious
 =ğ
com·»
);

308 
	}
}

310 
CK_CC_INLINE
 
boŞ


311 
	$ck_´_ÿs_±r
(*
rg‘
, *
com·»
, *
£t
)

313 *
´evious
, *
tmp
;

314 
__asm__
 
	`__vŞ©e__
("1:"

321 : "=&r" (
´evious
),

322 "=&r" (
tmp
)

323 : "r" (
rg‘
),

324 "r" (
£t
),

325 "r" (
com·»
)

327  (
´evious
 =ğ
com·»
);

328 
	}
}

330 
	#CK_PR_CAS
(
N
, 
T
, 
W
) \

331 
CK_CC_INLINE
 
boŞ
 \

332 
ck_´_ÿs_
##
N
##
	`_v®ue
(
T
 *
rg‘
, T 
com·»
, T 
£t
, T *
v®ue
) \

334 
T
 
´evious
 = 0, 
tmp
 = 0; \

335 
__asm__
 
	`__vŞ©e__
("1:" \

336 "ld»x" 
W
 " %0, [%2];" \

339 "¡»x" 
W
 "eq %1, %3, [%2];" \

346 : "+&r" (
´evious
), \

347 "+&r" (
tmp
) \

348 : "r" (
rg‘
), \

349 "r" (
£t
), \

350 "r" (
com·»
) \

352 *
v®ue
 = 
´evious
; \

353  (
´evious
 =ğ
com·»
); \

355 
CK_CC_INLINE
 
boŞ
 \

356 
ck_´_ÿs_
##
	`N
(
T
 *
rg‘
, T 
com·»
, T 
£t
) \

358 
T
 
´evious
 = 0, 
tmp
 = 0; \

359 
__asm__
 
	`__vŞ©e__
("1:" \

360 "ld»x" 
W
 " %0, [%2];" \

363 "¡»x" 
W
 "eq %1, %3, [%2];" \

366 : "+&r" (
´evious
), \

367 "+&r" (
tmp
) \

368 : "r" (
rg‘
), \

369 "r" (
£t
), \

370 "r" (
com·»
) \

372  (
´evious
 =ğ
com·»
); \

373 }

	)

375 
CK_PR_CAS
(32, 
ušt32_t
, "")

376 
CK_PR_CAS
(
ušt
, , "")

377 
CK_PR_CAS
(, , "")

378 
CK_PR_CAS
(16, 
ušt16_t
, "h")

379 
CK_PR_CAS
(8, 
ušt8_t
, "b")

380 
CK_PR_CAS
(, , "h")

381 
CK_PR_CAS
(, , "b")

384 #undeà
CK_PR_CAS_S


385 #undeà
CK_PR_CAS


387 
	#CK_PR_FAS
(
N
, 
M
, 
T
, 
W
) \

388 
CK_CC_INLINE
 
T
 \

389 
ck_´_çs_
##
	`N
(
M
 *
rg‘
, 
T
 
v
) \

391 
T
 
´evious
 = 0; \

392 
T
 
tmp
 = 0; \

393 
__asm__
 
	`__vŞ©e__
("1:" \

394 "ld»x" 
W
 " %0, [%2];" \

395 "¡»x" 
W
 " %1, %3, [%2];" \

398 : "+&r" (
´evious
), \

399 "+&r" (
tmp
) \

400 : "r" (
rg‘
), \

401 "r" (
v
) \

403  (
´evious
); \

404 }

	)

406 
CK_PR_FAS
(32, 
ušt32_t
, uint32_t, "")

407 
CK_PR_FAS
(
±r
, , *, "")

408 
CK_PR_FAS
(, , , "")

409 
CK_PR_FAS
(
ušt
, , , "")

410 
CK_PR_FAS
(16, 
ušt16_t
, uint16_t, "h")

411 
CK_PR_FAS
(8, 
ušt8_t
, uint8_t, "b")

412 
CK_PR_FAS
(, , , "h")

413 
CK_PR_FAS
(, , , "b")

416 #undeà
CK_PR_FAS


418 
	#CK_PR_UNARY
(
O
, 
N
, 
M
, 
T
, 
I
, 
W
) \

419 
CK_CC_INLINE
 \

420 
ck_´_
##
O
##
_
##
	`N
(
M
 *
rg‘
) \

422 
T
 
´evious
 = 0; \

423 
T
 
tmp
 = 0; \

424 
__asm__
 
	`__vŞ©e__
("1:" \

425 "ld»x" 
W
 " %0, [%2];" \

426 
I
 ";" \

427 "¡»x" 
W
 " %1, %0, [%2];" \

430 : "+&r" (
´evious
), \

431 "+&r" (
tmp
) \

432 : "r" (
rg‘
) \

435 }

	)

437 
CK_PR_UNARY
(
šc
, 
±r
, , *, "add %0, %0, #1", "")

438 
CK_PR_UNARY
(
dec
, 
±r
, , *, "sub %0, %0, #1", "")

439 
CK_PR_UNARY
(
nÙ
, 
±r
, , *, "mvn %0, %0", "")

440 
CK_PR_UNARY
(
Ãg
, 
±r
, , *, "neg %0, %0", "")

442 
	#CK_PR_UNARY_S
(
S
, 
T
, 
W
) \

443 
	`CK_PR_UNARY
(
šc
, 
S
, 
T
, T, "add %0, %0, #1", 
W
) \

444 
	`CK_PR_UNARY
(
dec
, 
S
, 
T
, T, "sub %0, %0, #1", 
W
) \

445 
	`CK_PR_UNARY
(
nÙ
, 
S
, 
T
, T, "mvÀ%0, %0", 
W
) \

446 
	`CK_PR_UNARY
(
Ãg
, 
S
, 
T
, T, "Ãg %0, %0", 
W
) \

447 

	)

448 
CK_PR_UNARY_S
(32, 
ušt32_t
, "")

449 
CK_PR_UNARY_S
(
ušt
, , "")

450 
CK_PR_UNARY_S
(, , "")

451 
CK_PR_UNARY_S
(16, 
ušt16_t
, "h")

452 
CK_PR_UNARY_S
(8, 
ušt8_t
, "b")

453 
CK_PR_UNARY_S
(, , "h")

454 
CK_PR_UNARY_S
(, , "b")

456 #undeà
CK_PR_UNARY_S


457 #undeà
CK_PR_UNARY


459 
	#CK_PR_BINARY
(
O
, 
N
, 
M
, 
T
, 
I
, 
W
) \

460 
CK_CC_INLINE
 \

461 
ck_´_
##
O
##
_
##
	`N
(
M
 *
rg‘
, 
T
 
d–
) \

463 
T
 
´evious
 = 0; \

464 
T
 
tmp
 = 0; \

465 
__asm__
 
	`__vŞ©e__
("1:" \

466 "ld»x" 
W
 " %0, [%2];" \

467 
I
 " %0, %0, %3;" \

468 "¡»x" 
W
 " %1, %0, [%2];" \

471 : "+&r" (
´evious
), \

472 "+&r" (
tmp
) \

473 : "r" (
rg‘
), \

474 "r" (
d–
) \

477 }

	)

479 
CK_PR_BINARY
(
ªd
, 
±r
, , 
ušŒ_t
, "and", "")

480 
CK_PR_BINARY
(
add
, 
±r
, , 
ušŒ_t
, "add", "")

481 
CK_PR_BINARY
(
Ü
, 
±r
, , 
ušŒ_t
, "orr", "")

482 
CK_PR_BINARY
(
sub
, 
±r
, , 
ušŒ_t
, "sub", "")

483 
CK_PR_BINARY
(
xÜ
, 
±r
, , 
ušŒ_t
, "eor", "")

485 
	#CK_PR_BINARY_S
(
S
, 
T
, 
W
) \

486 
	`CK_PR_BINARY
(
ªd
, 
S
, 
T
, T, "ªd", 
W
) \

487 
	`CK_PR_BINARY
(
add
, 
S
, 
T
, T, "add", 
W
) \

488 
	`CK_PR_BINARY
(
Ü
, 
S
, 
T
, T, "Ür", 
W
) \

489 
	`CK_PR_BINARY
(
sub
, 
S
, 
T
, T, "sub", 
W
) \

490 
	`CK_PR_BINARY
(
xÜ
, 
S
, 
T
, T, "eÜ", 
W
)

	)

492 
CK_PR_BINARY_S
(32, 
ušt32_t
, "")

493 
CK_PR_BINARY_S
(
ušt
, , "")

494 
CK_PR_BINARY_S
(, , "")

495 
CK_PR_BINARY_S
(16, 
ušt16_t
, "h")

496 
CK_PR_BINARY_S
(8, 
ušt8_t
, "b")

497 
CK_PR_BINARY_S
(, , "h")

498 
CK_PR_BINARY_S
(, , "b")

500 #undeà
CK_PR_BINARY_S


501 #undeà
CK_PR_BINARY


503 
CK_CC_INLINE
 *

504 
	$ck_´_ça_±r
(*
rg‘
, 
ušŒ_t
 
d–
)

506 
ušŒ_t
 
´evious
, 
r
, 
tmp
;

508 
__asm__
 
	`__vŞ©e__
("1:"

514 : "=&r" (
´evious
),

515 "=&r" (
r
),

516 "=&r" (
tmp
)

517 : "r" (
rg‘
),

518 "r" (
d–
)

521  (*)(
´evious
);

522 
	}
}

524 
	#CK_PR_FAA
(
S
, 
T
, 
W
) \

525 
CK_CC_INLINE
 
T
 \

526 
ck_´_ça_
##
	`S
(
T
 *
rg‘
, T 
d–
) \

528 
T
 
´evious
 = 0, 
r
 = 0, 
tmp
 = 0; \

529 
__asm__
 
	`__vŞ©e__
("1:" \

530 "ld»x" 
W
 " %0, [%3];" \

532 "¡»x" 
W
 " %2, %1, [%3];" \

535 : "+&r" (
´evious
), \

536 "+&r" (
r
), \

537 "+&r" (
tmp
) \

538 : "r" (
rg‘
), \

539 "r" (
d–
) \

541  (
´evious
); \

542 }

	)

544 
CK_PR_FAA
(32, 
ušt32_t
, "")

545 
CK_PR_FAA
(
ušt
, , "")

546 
CK_PR_FAA
(, , "")

547 
CK_PR_FAA
(16, 
ušt16_t
, "h")

548 
CK_PR_FAA
(8, 
ušt8_t
, "b")

549 
CK_PR_FAA
(, , "h")

550 
CK_PR_FAA
(, , "b")

552 #undeà
CK_PR_FAA


	@application/kvbench/include/aerospike/ck/gcc/ck_cc.h

28 #iâdeà
CK_GCC_CC_H


29 
	#CK_GCC_CC_H


	)

31 
	~<«ro¥ike/ck/ck_md.h
>

33 #ifdeà
__SUNPRO_C


34 
	#CK_CC_UNUSED


	)

35 
	#CK_CC_USED


	)

36 
	#CK_CC_IMM


	)

37 
	#CK_CC_IMM_U32


	)

39 
	#CK_CC_UNUSED
 
	`__©Œibu‹__
((
unu£d
))

	)

40 
	#CK_CC_USED
 
	`__©Œibu‹__
((
u£d
))

	)

41 
	#CK_CC_IMM
 "i"

	)

42 #ià
defšed
(
__x86_64__
è|| defšed(
__x86__
)

43 
	#CK_CC_IMM_U32
 "Z"

	)

44 
	#CK_CC_IMM_S32
 "e"

	)

46 
	#CK_CC_IMM_U32
 
CK_CC_IMM


	)

47 
	#CK_CC_IMM_S32
 
CK_CC_IMM


	)

51 #ifdeà
__OPTIMIZE__


52 
	#CK_CC_INLINE
 
CK_CC_UNUSED
 
šlše


	)

54 
	#CK_CC_INLINE
 
CK_CC_UNUSED


	)

57 
	#CK_CC_FORCE_INLINE
 
CK_CC_UNUSED
 
	`__©Œibu‹__
((
®ways_šlše
)è
šlše


	)

58 
	#CK_CC_RESTRICT
 
»¡riù


	)

63 
	#CK_CC_PACKED
 
	`__©Œibu‹__
((
·cked
))

	)

68 
	#CK_CC_WEAKREF
 
	`__©Œibu‹__
((
w—k»f
))

	)

73 
	#CK_CC_ALIGN
(
B
è
	`__©Œibu‹__
((
	`®igÃd
(B)))

	)

78 
	#CK_CC_CACHELINE
 
	`CK_CC_ALIGN
(
CK_MD_CACHELINE
)

	)

83 #ifdeà
__ä“¡ªdšg__


84 #´agm¨
GCC
 
poisÚ
 
m®loc
 
ä“


90 
	#CK_CC_LIKELY
(
x
è(
	`__butš_ex³ù
(!!(x), 1))

	)

91 
	#CK_CC_UNLIKELY
(
x
è(
	`__butš_ex³ù
(!!(x), 0))

	)

98 
	#CK_CC_ALIASED
 
	`__©Œibu‹__
((
__may_®Ÿs__
))

	)

103 
	#CK_CC_TYPEOF
(
X
, 
DEFAULT
è
	`__ty³of__
(X)

	)

109 
	#CK_F_CC_FFS


	)

110 
	#CK_F_CC_CLZ


	)

111 
	#CK_F_CC_CTZ


	)

112 
	#CK_F_CC_POPCOUNT


	)

114 
CK_CC_INLINE
 

115 
	$ck_cc_ffs
(
x
)

118  
	`__butš_ffs
(
x
);

119 
	}
}

121 
CK_CC_INLINE
 

122 
	$ck_cc_şz
(
x
)

125  
	`__butš_şz
(
x
);

126 
	}
}

128 
CK_CC_INLINE
 

129 
	$ck_cc_ùz
(
x
)

132  
	`__butš_ùz
(
x
);

133 
	}
}

135 
CK_CC_INLINE
 

136 
	$ck_cc_pİcouÁ
(
x
)

139  
	`__butš_pİcouÁ
(
x
);

140 
	}
}

	@application/kvbench/include/aerospike/ck/gcc/ck_f_pr.h

2 
	#CK_F_PR_ADD_16


	)

3 
	#CK_F_PR_ADD_32


	)

4 
	#CK_F_PR_ADD_64


	)

5 
	#CK_F_PR_ADD_8


	)

6 
	#CK_F_PR_ADD_CHAR


	)

7 
	#CK_F_PR_ADD_INT


	)

8 
	#CK_F_PR_ADD_PTR


	)

9 
	#CK_F_PR_ADD_UINT


	)

10 
	#CK_F_PR_AND_16


	)

11 
	#CK_F_PR_AND_32


	)

12 
	#CK_F_PR_AND_64


	)

13 
	#CK_F_PR_AND_8


	)

14 
	#CK_F_PR_AND_CHAR


	)

15 
	#CK_F_PR_AND_INT


	)

16 
	#CK_F_PR_AND_PTR


	)

17 
	#CK_F_PR_AND_UINT


	)

18 
	#CK_F_PR_CAS_16


	)

19 
	#CK_F_PR_CAS_16_VALUE


	)

20 
	#CK_F_PR_CAS_32


	)

21 
	#CK_F_PR_CAS_32_VALUE


	)

22 
	#CK_F_PR_CAS_64


	)

23 
	#CK_F_PR_CAS_64_VALUE


	)

24 
	#CK_F_PR_CAS_8


	)

25 
	#CK_F_PR_CAS_8_VALUE


	)

26 
	#CK_F_PR_CAS_CHAR


	)

27 
	#CK_F_PR_CAS_CHAR_VALUE


	)

28 
	#CK_F_PR_CAS_INT


	)

29 
	#CK_F_PR_CAS_INT_VALUE


	)

30 
	#CK_F_PR_CAS_PTR


	)

31 
	#CK_F_PR_CAS_PTR_VALUE


	)

32 
	#CK_F_PR_CAS_UINT


	)

33 
	#CK_F_PR_CAS_UINT_VALUE


	)

34 
	#CK_F_PR_DEC_16


	)

35 
	#CK_F_PR_DEC_32


	)

36 
	#CK_F_PR_DEC_64


	)

37 
	#CK_F_PR_DEC_8


	)

38 
	#CK_F_PR_DEC_CHAR


	)

39 
	#CK_F_PR_DEC_INT


	)

40 
	#CK_F_PR_DEC_PTR


	)

41 
	#CK_F_PR_DEC_UINT


	)

42 
	#CK_F_PR_FAA_16


	)

43 
	#CK_F_PR_FAA_32


	)

44 
	#CK_F_PR_FAA_64


	)

45 
	#CK_F_PR_FAA_8


	)

46 
	#CK_F_PR_FAA_CHAR


	)

47 
	#CK_F_PR_FAA_INT


	)

48 
	#CK_F_PR_FAA_PTR


	)

49 
	#CK_F_PR_FAA_UINT


	)

50 
	#CK_F_PR_FENCE_LOAD


	)

51 
	#CK_F_PR_FENCE_LOAD_DEPENDS


	)

52 
	#CK_F_PR_FENCE_MEMORY


	)

53 
	#CK_F_PR_FENCE_STORE


	)

54 
	#CK_F_PR_FENCE_STRICT_LOAD


	)

55 
	#CK_F_PR_FENCE_STRICT_MEMORY


	)

56 
	#CK_F_PR_FENCE_STRICT_STORE


	)

57 
	#CK_F_PR_INC_16


	)

58 
	#CK_F_PR_INC_32


	)

59 
	#CK_F_PR_INC_64


	)

60 
	#CK_F_PR_INC_8


	)

61 
	#CK_F_PR_INC_CHAR


	)

62 
	#CK_F_PR_INC_INT


	)

63 
	#CK_F_PR_INC_PTR


	)

64 
	#CK_F_PR_INC_UINT


	)

65 
	#CK_F_PR_LOAD_16


	)

66 
	#CK_F_PR_LOAD_32


	)

67 
	#CK_F_PR_LOAD_64


	)

68 
	#CK_F_PR_LOAD_8


	)

69 
	#CK_F_PR_LOAD_CHAR


	)

70 
	#CK_F_PR_LOAD_INT


	)

71 
	#CK_F_PR_LOAD_PTR


	)

72 
	#CK_F_PR_LOAD_UINT


	)

73 
	#CK_F_PR_OR_16


	)

74 
	#CK_F_PR_OR_32


	)

75 
	#CK_F_PR_OR_64


	)

76 
	#CK_F_PR_OR_8


	)

77 
	#CK_F_PR_OR_CHAR


	)

78 
	#CK_F_PR_OR_INT


	)

79 
	#CK_F_PR_OR_PTR


	)

80 
	#CK_F_PR_OR_UINT


	)

81 
	#CK_F_PR_STALL


	)

82 
	#CK_F_PR_STORE_16


	)

83 
	#CK_F_PR_STORE_32


	)

84 
	#CK_F_PR_STORE_64


	)

85 
	#CK_F_PR_STORE_8


	)

86 
	#CK_F_PR_STORE_CHAR


	)

87 
	#CK_F_PR_STORE_INT


	)

88 
	#CK_F_PR_STORE_PTR


	)

89 
	#CK_F_PR_STORE_UINT


	)

90 
	#CK_F_PR_SUB_16


	)

91 
	#CK_F_PR_SUB_32


	)

92 
	#CK_F_PR_SUB_64


	)

93 
	#CK_F_PR_SUB_8


	)

94 
	#CK_F_PR_SUB_CHAR


	)

95 
	#CK_F_PR_SUB_INT


	)

96 
	#CK_F_PR_SUB_PTR


	)

97 
	#CK_F_PR_SUB_UINT


	)

98 
	#CK_F_PR_XOR_16


	)

99 
	#CK_F_PR_XOR_32


	)

100 
	#CK_F_PR_XOR_64


	)

101 
	#CK_F_PR_XOR_8


	)

102 
	#CK_F_PR_XOR_CHAR


	)

103 
	#CK_F_PR_XOR_INT


	)

104 
	#CK_F_PR_XOR_PTR


	)

105 
	#CK_F_PR_XOR_UINT


	)

	@application/kvbench/include/aerospike/ck/gcc/ck_pr.h

27 #iâdeà
CK_PR_GCC_H


28 
	#CK_PR_GCC_H


	)

30 #iâdeà
CK_PR_H


31 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


34 
	~<«ro¥ike/ck/ck_cc.h
>

36 
CK_CC_INLINE
 

37 
	$ck_´_b¬r›r
()

40 
__asm__
 
	`__vŞ©e__
("" ::: "memory");

42 
	}
}

44 #iâdeà
CK_F_PR


45 
	#CK_F_PR


	)

47 
	~<¡dboŞ.h
>

48 
	~<«ro¥ike/ck/ck_¡dšt.h
>

54 
	~"ck_f_´.h
"

56 
	#CK_PR_ACCESS
(
x
è(*(vŞ©
	`__ty³of__
(xè*)&(x))

	)

58 
	#CK_PR_LOAD
(
S
, 
M
, 
T
) \

59 
CK_CC_INLINE
 
T
 \

60 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

62 
T
 
r
; \

63 
	`ck_´_b¬r›r
(); \

64 
r
 = 
	`CK_PR_ACCESS
(*(
T
 *)
rg‘
); \

65 
	`ck_´_b¬r›r
(); \

66  (
r
); \

68 
CK_CC_INLINE
 \

69 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

71 
	`ck_´_b¬r›r
(); \

72 
	`CK_PR_ACCESS
(*(
T
 *)
rg‘
èğ
v
; \

73 
	`ck_´_b¬r›r
(); \

75 }

	)

77 
CK_CC_INLINE
 *

78 
	$ck_´_md_lßd_±r
(cÚ¡ *
rg‘
)

80 *
r
;

82 
	`ck_´_b¬r›r
();

83 
r
 = 
	`CK_PR_ACCESS
(*(**)
rg‘
);

84 
	`ck_´_b¬r›r
();

86  
r
;

87 
	}
}

89 
CK_CC_INLINE
 

90 
	$ck_´_md_¡Üe_±r
(*
rg‘
, cÚ¡ *
v
)

93 
	`ck_´_b¬r›r
();

94 
	`CK_PR_ACCESS
(*(**)
rg‘
èğ(*)
v
;

95 
	`ck_´_b¬r›r
();

97 
	}
}

99 
	#CK_PR_LOAD_S
(
S
, 
T
è
	`CK_PR_LOAD
(S, T, T)

	)

101 
	$CK_PR_LOAD_S
(, )

102 
	$CK_PR_LOAD_S
(
ušt
, )

103 
	$CK_PR_LOAD_S
(, )

104 
	$CK_PR_LOAD_S
(, )

105 
	$CK_PR_LOAD_S
(64, 
ušt64_t
)

106 
	$CK_PR_LOAD_S
(32, 
ušt32_t
)

107 
	$CK_PR_LOAD_S
(16, 
ušt16_t
)

108 
	$CK_PR_LOAD_S
(8, 
ušt8_t
)

110 #undeà
CK_PR_LOAD_S


111 #undeà
CK_PR_LOAD


113 
CK_CC_INLINE
 

114 
	$ck_´_¡®l
()

117 
	`ck_´_b¬r›r
();

118 
	}
}

123 
	#CK_PR_FENCE
(
T
) \

124 
CK_CC_INLINE
 \

125 
ck_´_ãnû_¡riù_
##
	`T
() \

127 
	`__sync_synchrÚize
(); \

128 }

	)

130 
	$CK_PR_FENCE
(
©omic
)

131 
	$CK_PR_FENCE
(
©omic_©omic
)

132 
	$CK_PR_FENCE
(
©omic_lßd
)

133 
	$CK_PR_FENCE
(
©omic_¡Üe
)

134 
	$CK_PR_FENCE
(
¡Üe_©omic
)

135 
	$CK_PR_FENCE
(
lßd_©omic
)

136 
	$CK_PR_FENCE
(
lßd
)

137 
	$CK_PR_FENCE
(
lßd_lßd
)

138 
	$CK_PR_FENCE
(
lßd_¡Üe
)

139 
	$CK_PR_FENCE
(
¡Üe
)

140 
	$CK_PR_FENCE
(
¡Üe_¡Üe
)

141 
	$CK_PR_FENCE
(
¡Üe_lßd
)

142 
	$CK_PR_FENCE
(
memÜy
)

143 
	$CK_PR_FENCE
(
acquœe
)

144 
	$CK_PR_FENCE
(
»Ëa£
)

145 
	$CK_PR_FENCE
(
acq»l
)

146 
	$CK_PR_FENCE
(
lock
)

147 
	$CK_PR_FENCE
(
uÆock
)

149 #undeà
CK_PR_FENCE


154 
	#CK_PR_CAS
(
S
, 
M
, 
T
) \

155 
CK_CC_INLINE
 
boŞ
 \

156 
ck_´_ÿs_
##
	`S
(
M
 *
rg‘
, 
T
 
com·»
, T 
£t
) \

158 
boŞ
 
z
; \

159 
z
 = 
	`__sync_boŞ_com·»_ªd_sw­
((
T
 *)
rg‘
, 
com·»
, 
£t
); \

160  
z
; \

161 
	}

	)
}

163 
	$CK_PR_CAS
(
±r
, , *)

165 
	#CK_PR_CAS_S
(
S
, 
T
è
	`CK_PR_CAS
(S, T, T)

	)

167 
	$CK_PR_CAS_S
(, )

168 
	$CK_PR_CAS_S
(, )

169 
	$CK_PR_CAS_S
(
ušt
, )

170 
	$CK_PR_CAS_S
(64, 
ušt64_t
)

171 
	$CK_PR_CAS_S
(32, 
ušt32_t
)

172 
	$CK_PR_CAS_S
(16, 
ušt16_t
)

173 
	$CK_PR_CAS_S
(8, 
ušt8_t
)

175 #undeà
CK_PR_CAS_S


176 #undeà
CK_PR_CAS


181 
CK_CC_INLINE
 
boŞ


182 
	$ck_´_ÿs_±r_v®ue
(*
rg‘
, *
com·»
, *
£t
, *
v
)

184 
£t
 = 
	`__sync_v®_com·»_ªd_sw­
((**)
rg‘
, 
com·»
, set);

185 *(**)
v
 = 
£t
;

186  (
£t
 =ğ
com·»
);

187 
	}
}

189 
	#CK_PR_CAS_O
(
S
, 
T
) \

190 
CK_CC_INLINE
 
boŞ
 \

191 
ck_´_ÿs_
##
S
##
	`_v®ue
(
T
 *
rg‘
, T 
com·»
, T 
£t
, T *
v
) \

193 
£t
 = 
	`__sync_v®_com·»_ªd_sw­
(
rg‘
, 
com·»
, set);\

194 *
v
 = 
£t
; \

195  (
£t
 =ğ
com·»
); \

196 }

	)

198 
	$CK_PR_CAS_O
(, )

199 
	$CK_PR_CAS_O
(, )

200 
	$CK_PR_CAS_O
(
ušt
, )

201 
	$CK_PR_CAS_O
(64, 
ušt64_t
)

202 
	$CK_PR_CAS_O
(32, 
ušt32_t
)

203 
	$CK_PR_CAS_O
(16, 
ušt16_t
)

204 
	$CK_PR_CAS_O
(8, 
ušt8_t
)

206 #undeà
CK_PR_CAS_O


211 
	#CK_PR_FAA
(
S
, 
M
, 
T
) \

212 
CK_CC_INLINE
 
T
 \

213 
ck_´_ça_
##
	`S
(
M
 *
rg‘
, 
T
 
d
) \

215 
d
 = 
	`__sync_ãtch_ªd_add
((
T
 *)
rg‘
, d); \

216  (
d
); \

217 
	}

	)
}

219 
	$CK_PR_FAA
(
±r
, , *)

221 
	#CK_PR_FAA_S
(
S
, 
T
è
	`CK_PR_FAA
(S, T, T)

	)

223 
	$CK_PR_FAA_S
(, )

224 
	$CK_PR_FAA_S
(
ušt
, )

225 
	$CK_PR_FAA_S
(, )

226 
	$CK_PR_FAA_S
(64, 
ušt64_t
)

227 
	$CK_PR_FAA_S
(32, 
ušt32_t
)

228 
	$CK_PR_FAA_S
(16, 
ušt16_t
)

229 
	$CK_PR_FAA_S
(8, 
ušt8_t
)

231 #undeà
CK_PR_FAA_S


232 #undeà
CK_PR_FAA


237 
	#CK_PR_BINARY
(
K
, 
S
, 
M
, 
T
) \

238 
CK_CC_INLINE
 \

239 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
, 
T
 
d
) \

241 
d
 = 
__sync_ãtch_ªd_
##
	`K
((
T
 *)
rg‘
, d); \

243 
	}

	)
}

245 
	#CK_PR_BINARY_S
(
K
, 
S
, 
T
è
	`CK_PR_BINARY
(K, S, T, T)

	)

247 
	#CK_PR_GENERATE
(
K
) \

248 
	`CK_PR_BINARY
(
K
, 
±r
, , *) \

249 
	`CK_PR_BINARY_S
(
K
, , ) \

250 
	`CK_PR_BINARY_S
(
K
, , ) \

251 
	`CK_PR_BINARY_S
(
K
, 
ušt
, ) \

252 
	`CK_PR_BINARY_S
(
K
, 64, 
ušt64_t
) \

253 
	`CK_PR_BINARY_S
(
K
, 32, 
ušt32_t
) \

254 
	`CK_PR_BINARY_S
(
K
, 16, 
ušt16_t
) \

255 
	`CK_PR_BINARY_S
(
K
, 8, 
ušt8_t
)

	)

257 
	$CK_PR_GENERATE
(
add
)

258 
	$CK_PR_GENERATE
(
sub
)

259 
	$CK_PR_GENERATE
(
ªd
)

260 
	$CK_PR_GENERATE
(
Ü
)

261 
	$CK_PR_GENERATE
(
xÜ
)

263 #undeà
CK_PR_GENERATE


264 #undeà
CK_PR_BINARY_S


265 #undeà
CK_PR_BINARY


267 
	#CK_PR_UNARY
(
S
, 
M
, 
T
) \

268 
CK_CC_INLINE
 \

269 
ck_´_šc_
##
	`S
(
M
 *
rg‘
) \

271 
ck_´_add_
##
	`S
(
rg‘
, (
T
)1); \

273 
	}
} \

274 
CK_CC_INLINE
 \

275 
ck_´_dec_
##
	`S
(
M
 *
rg‘
) \

277 
ck_´_sub_
##
	`S
(
rg‘
, (
T
)1); \

279 }

	)

281 
	#CK_PR_UNARY_S
(
S
, 
M
è
	`CK_PR_UNARY
(S, M, M)

	)

283 
	$CK_PR_UNARY
(
±r
, , *)

284 
	$CK_PR_UNARY_S
(, )

285 
	$CK_PR_UNARY_S
(, )

286 
	$CK_PR_UNARY_S
(
ušt
, )

287 
	$CK_PR_UNARY_S
(64, 
ušt64_t
)

288 
	$CK_PR_UNARY_S
(32, 
ušt32_t
)

289 
	$CK_PR_UNARY_S
(16, 
ušt16_t
)

290 
	$CK_PR_UNARY_S
(8, 
ušt8_t
)

292 #undeà
CK_PR_UNARY_S


293 #undeà
CK_PR_UNARY


	@application/kvbench/include/aerospike/ck/gcc/ppc/ck_f_pr.h

2 
	#CK_F_PR_ADD_32


	)

3 
	#CK_F_PR_ADD_INT


	)

4 
	#CK_F_PR_ADD_PTR


	)

5 
	#CK_F_PR_ADD_UINT


	)

6 
	#CK_F_PR_AND_32


	)

7 
	#CK_F_PR_AND_INT


	)

8 
	#CK_F_PR_AND_PTR


	)

9 
	#CK_F_PR_AND_UINT


	)

10 
	#CK_F_PR_CAS_32


	)

11 
	#CK_F_PR_CAS_32_VALUE


	)

12 
	#CK_F_PR_CAS_INT


	)

13 
	#CK_F_PR_CAS_INT_VALUE


	)

14 
	#CK_F_PR_CAS_PTR


	)

15 
	#CK_F_PR_CAS_PTR_VALUE


	)

16 
	#CK_F_PR_CAS_UINT


	)

17 
	#CK_F_PR_CAS_UINT_VALUE


	)

18 
	#CK_F_PR_DEC_32


	)

19 
	#CK_F_PR_DEC_INT


	)

20 
	#CK_F_PR_DEC_PTR


	)

21 
	#CK_F_PR_DEC_UINT


	)

22 
	#CK_F_PR_FAA_32


	)

23 
	#CK_F_PR_FAA_INT


	)

24 
	#CK_F_PR_FAA_PTR


	)

25 
	#CK_F_PR_FAA_UINT


	)

26 
	#CK_F_PR_FAS_32


	)

27 
	#CK_F_PR_FAS_INT


	)

28 
	#CK_F_PR_FAS_PTR


	)

29 
	#CK_F_PR_FAS_UINT


	)

30 
	#CK_F_PR_FENCE_LOAD


	)

31 
	#CK_F_PR_FENCE_LOAD_DEPENDS


	)

32 
	#CK_F_PR_FENCE_MEMORY


	)

33 
	#CK_F_PR_FENCE_STORE


	)

34 
	#CK_F_PR_FENCE_STRICT_LOAD


	)

35 
	#CK_F_PR_FENCE_STRICT_LOAD_DEPENDS


	)

36 
	#CK_F_PR_FENCE_STRICT_MEMORY


	)

37 
	#CK_F_PR_FENCE_STRICT_STORE


	)

38 
	#CK_F_PR_INC_32


	)

39 
	#CK_F_PR_INC_INT


	)

40 
	#CK_F_PR_INC_PTR


	)

41 
	#CK_F_PR_INC_UINT


	)

42 
	#CK_F_PR_LOAD_16


	)

43 
	#CK_F_PR_LOAD_32


	)

44 
	#CK_F_PR_LOAD_8


	)

45 
	#CK_F_PR_LOAD_CHAR


	)

46 
	#CK_F_PR_LOAD_INT


	)

47 
	#CK_F_PR_LOAD_PTR


	)

48 
	#CK_F_PR_LOAD_SHORT


	)

49 
	#CK_F_PR_LOAD_UINT


	)

50 
	#CK_F_PR_NEG_32


	)

51 
	#CK_F_PR_NEG_INT


	)

52 
	#CK_F_PR_NEG_PTR


	)

53 
	#CK_F_PR_NEG_UINT


	)

54 
	#CK_F_PR_NOT_32


	)

55 
	#CK_F_PR_NOT_INT


	)

56 
	#CK_F_PR_NOT_PTR


	)

57 
	#CK_F_PR_NOT_UINT


	)

58 
	#CK_F_PR_OR_32


	)

59 
	#CK_F_PR_OR_INT


	)

60 
	#CK_F_PR_OR_PTR


	)

61 
	#CK_F_PR_OR_UINT


	)

62 
	#CK_F_PR_STALL


	)

63 
	#CK_F_PR_STORE_16


	)

64 
	#CK_F_PR_STORE_32


	)

65 
	#CK_F_PR_STORE_8


	)

66 
	#CK_F_PR_STORE_CHAR


	)

67 
	#CK_F_PR_STORE_INT


	)

68 
	#CK_F_PR_STORE_PTR


	)

69 
	#CK_F_PR_STORE_SHORT


	)

70 
	#CK_F_PR_STORE_UINT


	)

71 
	#CK_F_PR_SUB_32


	)

72 
	#CK_F_PR_SUB_INT


	)

73 
	#CK_F_PR_SUB_PTR


	)

74 
	#CK_F_PR_SUB_UINT


	)

75 
	#CK_F_PR_XOR_32


	)

76 
	#CK_F_PR_XOR_INT


	)

77 
	#CK_F_PR_XOR_PTR


	)

78 
	#CK_F_PR_XOR_UINT


	)

	@application/kvbench/include/aerospike/ck/gcc/ppc/ck_pr.h

28 #iâdeà
CK_PR_PPC_H


29 
	#CK_PR_PPC_H


	)

31 #iâdeà
CK_PR_H


32 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


35 
	~<«ro¥ike/ck/ck_cc.h
>

36 
	~<«ro¥ike/ck/ck_md.h
>

42 
	~"ck_f_´.h
"

47 
	#CK_F_PR


	)

54 
CK_CC_INLINE
 

55 
	$ck_´_¡®l
()

58 
__asm__
 
	`__vŞ©e__
("or 1, 1, 1;"

61 
	}
}

63 
	#CK_PR_FENCE
(
T
, 
I
) \

64 
CK_CC_INLINE
 \

65 
ck_´_ãnû_¡riù_
##
	`T
() \

67 
__asm__
 
	`__vŞ©e__
(
I
 ::: "memory"); \

68 }

	)

70 
CK_PR_FENCE
(
©omic
, "lwsync")

71 
CK_PR_FENCE
(
©omic_¡Üe
, "lwsync")

72 
CK_PR_FENCE
(
©omic_lßd
, "sync")

73 
CK_PR_FENCE
(
¡Üe_©omic
, "lwsync")

74 
CK_PR_FENCE
(
lßd_©omic
, "lwsync")

75 
CK_PR_FENCE
(
¡Üe
, "lwsync")

76 
CK_PR_FENCE
(
¡Üe_lßd
, "sync")

77 
CK_PR_FENCE
(
lßd
, "lwsync")

78 
CK_PR_FENCE
(
lßd_¡Üe
, "lwsync")

79 
CK_PR_FENCE
(
memÜy
, "sync")

80 
CK_PR_FENCE
(
acquœe
, "lwsync")

81 
CK_PR_FENCE
(
»Ëa£
, "lwsync")

82 
CK_PR_FENCE
(
acq»l
, "lwsync")

83 
CK_PR_FENCE
(
lock
, "lwsync")

84 
CK_PR_FENCE
(
uÆock
, "lwsync")

86 #undeà
CK_PR_FENCE


88 
	#CK_PR_LOAD
(
S
, 
M
, 
T
, 
C
, 
I
) \

89 
CK_CC_INLINE
 
T
 \

90 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

92 
T
 
r
; \

93 
__asm__
 
	`__vŞ©e__
(
I
 "%U1%X1 %0, %1" \

94 : "ô" (
r
) \

95 : "m" (*(cÚ¡ 
C
 *)
rg‘
) \

97  (
r
); \

98 }

	)

100 
CK_PR_LOAD
(
±r
, , *, 
ušt32_t
, "lwz")

102 
	#CK_PR_LOAD_S
(
S
, 
T
, 
I
è
	`CK_PR_LOAD
(S, T, T, T, I)

	)

104 
CK_PR_LOAD_S
(32, 
ušt32_t
, "lwz")

105 
CK_PR_LOAD_S
(16, 
ušt16_t
, "lhz")

106 
CK_PR_LOAD_S
(8, 
ušt8_t
, "lbz")

107 
CK_PR_LOAD_S
(
ušt
, , "lwz")

108 
CK_PR_LOAD_S
(, , "lwz")

109 
CK_PR_LOAD_S
(, , "lhz")

110 
CK_PR_LOAD_S
(, , "lbz")

112 #undeà
CK_PR_LOAD_S


113 #undeà
CK_PR_LOAD


115 
	#CK_PR_STORE
(
S
, 
M
, 
T
, 
C
, 
I
) \

116 
CK_CC_INLINE
 \

117 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

119 
__asm__
 
	`__vŞ©e__
(
I
 "%U0%X0 %1, %0" \

120 : "=m" (*(
C
 *)
rg‘
) \

121 : "r" (
v
) \

124 }

	)

126 
CK_PR_STORE
(
±r
, , cÚ¡ *, 
ušt32_t
, "stw")

128 
	#CK_PR_STORE_S
(
S
, 
T
, 
I
è
	`CK_PR_STORE
(S, T, T, T, I)

	)

130 
CK_PR_STORE_S
(32, 
ušt32_t
, "stw")

131 
CK_PR_STORE_S
(16, 
ušt16_t
, "sth")

132 
CK_PR_STORE_S
(8, 
ušt8_t
, "stb")

133 
CK_PR_STORE_S
(
ušt
, , "stw")

134 
CK_PR_STORE_S
(, , "stw")

135 
CK_PR_STORE_S
(, , "sth")

136 
CK_PR_STORE_S
(, , "stb")

138 #undeà
CK_PR_STORE_S


139 #undeà
CK_PR_STORE


141 
	#CK_PR_CAS
(
N
, 
T
) \

142 
CK_CC_INLINE
 
boŞ
 \

143 
ck_´_ÿs_
##
N
##
	`_v®ue
(
T
 *
rg‘
, T 
com·»
, T 
£t
, T *
v®ue
) \

145 
T
 
´evious
; \

146 
__asm__
 
	`__vŞ©e__
("1:" \

153 : "=&r" (
´evious
) \

154 : "r" (
rg‘
), \

155 "r" (
£t
), \

156 "r" (
com·»
) \

158 *
v®ue
 = 
´evious
; \

159  (
´evious
 =ğ
com·»
); \

161 
CK_CC_INLINE
 
boŞ
 \

162 
ck_´_ÿs_
##
	`N
(
T
 *
rg‘
, T 
com·»
, T 
£t
) \

164 
T
 
´evious
; \

165 
__asm__
 
	`__vŞ©e__
("1:" \

172 : "=&r" (
´evious
) \

173 : "r" (
rg‘
), \

174 "r" (
£t
), \

175 "r" (
com·»
) \

177  (
´evious
 =ğ
com·»
); \

178 }

	)

180 
	$CK_PR_CAS
(
±r
, *)

181 
	$CK_PR_CAS
(32, 
ušt32_t
)

182 
	$CK_PR_CAS
(
ušt
, )

183 
	$CK_PR_CAS
(, )

185 #undeà
CK_PR_CAS


187 
	#CK_PR_FAS
(
N
, 
M
, 
T
, 
W
) \

188 
CK_CC_INLINE
 
T
 \

189 
ck_´_çs_
##
	`N
(
M
 *
rg‘
, 
T
 
v
) \

191 
T
 
´evious
; \

192 
__asm__
 
	`__vŞ©e__
("1:" \

193 "l" 
W
 "arx %0, 0, %1;" \

194 "¡" 
W
 "cx. %2, 0, %1;" \

196 : "=&r" (
´evious
) \

197 : "r" (
rg‘
), \

198 "r" (
v
) \

200  (
´evious
); \

201 
	}

	)
}

203 
CK_PR_FAS
(32, 
ušt32_t
, uint32_t, "w")

204 
CK_PR_FAS
(
±r
, , *, "w")

205 
CK_PR_FAS
(, , , "w")

206 
CK_PR_FAS
(
ušt
, , , "w")

208 #undeà
CK_PR_FAS


210 
	#CK_PR_UNARY
(
O
, 
N
, 
M
, 
T
, 
I
, 
W
) \

211 
CK_CC_INLINE
 \

212 
ck_´_
##
O
##
_
##
	`N
(
M
 *
rg‘
) \

214 
T
 
´evious
; \

215 
__asm__
 
	`__vŞ©e__
("1:" \

216 "l" 
W
 "arx %0, 0, %1;" \

217 
I
 ";" \

218 "¡" 
W
 "cx. %0, 0, %1;" \

220 : "=&r" (
´evious
) \

221 : "r" (
rg‘
) \

224 }

	)

226 
CK_PR_UNARY
(
šc
, 
±r
, , *, "addic %0, %0, 1", "w")

227 
CK_PR_UNARY
(
dec
, 
±r
, , *, "addic %0, %0, -1", "w")

228 
CK_PR_UNARY
(
nÙ
, 
±r
, , *, "not %0, %0", "w")

229 
CK_PR_UNARY
(
Ãg
, 
±r
, , *, "neg %0, %0", "w")

231 
	#CK_PR_UNARY_S
(
S
, 
T
, 
W
) \

232 
	`CK_PR_UNARY
(
šc
, 
S
, 
T
, T, "addiø%0, %0, 1", 
W
) \

233 
	`CK_PR_UNARY
(
dec
, 
S
, 
T
, T, "addiø%0, %0, -1", 
W
) \

234 
	`CK_PR_UNARY
(
nÙ
, 
S
, 
T
, T, "nÙ %0, %0", 
W
) \

235 
	`CK_PR_UNARY
(
Ãg
, 
S
, 
T
, T, "Ãg %0, %0", 
W
)

	)

237 
CK_PR_UNARY_S
(32, 
ušt32_t
, "w")

238 
CK_PR_UNARY_S
(
ušt
, , "w")

239 
CK_PR_UNARY_S
(, , "w")

241 #undeà
CK_PR_UNARY_S


242 #undeà
CK_PR_UNARY


244 
	#CK_PR_BINARY
(
O
, 
N
, 
M
, 
T
, 
I
, 
W
) \

245 
CK_CC_INLINE
 \

246 
ck_´_
##
O
##
_
##
	`N
(
M
 *
rg‘
, 
T
 
d–
) \

248 
T
 
´evious
; \

249 
__asm__
 
	`__vŞ©e__
("1:" \

250 "l" 
W
 "arx %0, 0, %1;" \

251 
I
 " %0, %2, %0;" \

252 "¡" 
W
 "cx. %0, 0, %1;" \

254 : "=&r" (
´evious
) \

255 : "r" (
rg‘
), \

256 "r" (
d–
) \

259 }

	)

261 
CK_PR_BINARY
(
ªd
, 
±r
, , 
ušŒ_t
, "and", "w")

262 
CK_PR_BINARY
(
add
, 
±r
, , 
ušŒ_t
, "add", "w")

263 
CK_PR_BINARY
(
Ü
, 
±r
, , 
ušŒ_t
, "or", "w")

264 
CK_PR_BINARY
(
sub
, 
±r
, , 
ušŒ_t
, "sub", "w")

265 
CK_PR_BINARY
(
xÜ
, 
±r
, , 
ušŒ_t
, "xor", "w")

267 
	#CK_PR_BINARY_S
(
S
, 
T
, 
W
) \

268 
	`CK_PR_BINARY
(
ªd
, 
S
, 
T
, T, "ªd", 
W
) \

269 
	`CK_PR_BINARY
(
add
, 
S
, 
T
, T, "add", 
W
) \

270 
	`CK_PR_BINARY
(
Ü
, 
S
, 
T
, T, "Ü", 
W
) \

271 
	`CK_PR_BINARY
(
sub
, 
S
, 
T
, T, "subf", 
W
) \

272 
	`CK_PR_BINARY
(
xÜ
, 
S
, 
T
, T, "xÜ", 
W
)

	)

274 
CK_PR_BINARY_S
(32, 
ušt32_t
, "w")

275 
CK_PR_BINARY_S
(
ušt
, , "w")

276 
CK_PR_BINARY_S
(, , "w")

278 #undeà
CK_PR_BINARY_S


279 #undeà
CK_PR_BINARY


281 
CK_CC_INLINE
 *

282 
	$ck_´_ça_±r
(*
rg‘
, 
ušŒ_t
 
d–
)

284 
ušŒ_t
 
´evious
, 
r
;

286 
__asm__
 
	`__vŞ©e__
("1:"

291 : "=&r" (
´evious
),

292 "=&r" (
r
)

293 : "r" (
rg‘
),

294 "r" (
d–
)

297  (*)(
´evious
);

298 
	}
}

300 
	#CK_PR_FAA
(
S
, 
T
, 
W
) \

301 
CK_CC_INLINE
 
T
 \

302 
ck_´_ça_
##
	`S
(
T
 *
rg‘
, T 
d–
) \

304 
T
 
´evious
, 
r
; \

305 
__asm__
 
	`__vŞ©e__
("1:" \

306 "l" 
W
 "arx %0, 0, %2;" \

308 "¡" 
W
 "cx. %1, 0, %2;" \

310 : "=&r" (
´evious
), \

311 "=&r" (
r
) \

312 : "r" (
rg‘
), \

313 "r" (
d–
) \

315  (
´evious
); \

316 }

	)

318 
CK_PR_FAA
(32, 
ušt32_t
, "w")

319 
CK_PR_FAA
(
ušt
, , "w")

320 
CK_PR_FAA
(, , "w")

322 #undeà
CK_PR_FAA


	@application/kvbench/include/aerospike/ck/gcc/ppc64/ck_f_pr.h

2 
	#CK_F_PR_ADD_32


	)

3 
	#CK_F_PR_ADD_64


	)

4 
	#CK_F_PR_ADD_INT


	)

5 
	#CK_F_PR_ADD_PTR


	)

6 
	#CK_F_PR_ADD_UINT


	)

7 
	#CK_F_PR_AND_32


	)

8 
	#CK_F_PR_AND_64


	)

9 
	#CK_F_PR_AND_INT


	)

10 
	#CK_F_PR_AND_PTR


	)

11 
	#CK_F_PR_AND_UINT


	)

12 
	#CK_F_PR_CAS_32


	)

13 
	#CK_F_PR_CAS_32_VALUE


	)

14 
	#CK_F_PR_CAS_64


	)

15 
	#CK_F_PR_CAS_64_VALUE


	)

16 
	#CK_F_PR_CAS_INT


	)

17 
	#CK_F_PR_CAS_INT_VALUE


	)

18 
	#CK_F_PR_CAS_PTR


	)

19 
	#CK_F_PR_CAS_PTR_VALUE


	)

20 
	#CK_F_PR_CAS_UINT


	)

21 
	#CK_F_PR_CAS_UINT_VALUE


	)

22 
	#CK_F_PR_DEC_32


	)

23 
	#CK_F_PR_DEC_64


	)

24 
	#CK_F_PR_DEC_INT


	)

25 
	#CK_F_PR_DEC_PTR


	)

26 
	#CK_F_PR_DEC_UINT


	)

27 
	#CK_F_PR_FAA_32


	)

28 
	#CK_F_PR_FAA_64


	)

29 
	#CK_F_PR_FAA_INT


	)

30 
	#CK_F_PR_FAA_PTR


	)

31 
	#CK_F_PR_FAA_UINT


	)

32 
	#CK_F_PR_FAS_32


	)

33 
	#CK_F_PR_FAS_64


	)

34 
	#CK_F_PR_FAS_INT


	)

35 
	#CK_F_PR_FAS_PTR


	)

36 
	#CK_F_PR_FAS_UINT


	)

37 
	#CK_F_PR_FAS_DOUBLE


	)

38 
	#CK_F_PR_FENCE_LOAD


	)

39 
	#CK_F_PR_FENCE_LOAD_DEPENDS


	)

40 
	#CK_F_PR_FENCE_MEMORY


	)

41 
	#CK_F_PR_FENCE_STORE


	)

42 
	#CK_F_PR_FENCE_STRICT_LOAD


	)

43 
	#CK_F_PR_FENCE_STRICT_LOAD_DEPENDS


	)

44 
	#CK_F_PR_FENCE_STRICT_MEMORY


	)

45 
	#CK_F_PR_FENCE_STRICT_STORE


	)

46 
	#CK_F_PR_INC_32


	)

47 
	#CK_F_PR_INC_64


	)

48 
	#CK_F_PR_INC_INT


	)

49 
	#CK_F_PR_INC_PTR


	)

50 
	#CK_F_PR_INC_UINT


	)

51 
	#CK_F_PR_LOAD_16


	)

52 
	#CK_F_PR_LOAD_32


	)

53 
	#CK_F_PR_LOAD_64


	)

54 
	#CK_F_PR_LOAD_8


	)

55 
	#CK_F_PR_LOAD_CHAR


	)

56 
	#CK_F_PR_LOAD_DOUBLE


	)

57 
	#CK_F_PR_LOAD_INT


	)

58 
	#CK_F_PR_LOAD_PTR


	)

59 
	#CK_F_PR_LOAD_SHORT


	)

60 
	#CK_F_PR_LOAD_UINT


	)

61 
	#CK_F_PR_NEG_32


	)

62 
	#CK_F_PR_NEG_64


	)

63 
	#CK_F_PR_NEG_INT


	)

64 
	#CK_F_PR_NEG_PTR


	)

65 
	#CK_F_PR_NEG_UINT


	)

66 
	#CK_F_PR_NOT_32


	)

67 
	#CK_F_PR_NOT_64


	)

68 
	#CK_F_PR_NOT_INT


	)

69 
	#CK_F_PR_NOT_PTR


	)

70 
	#CK_F_PR_NOT_UINT


	)

71 
	#CK_F_PR_OR_32


	)

72 
	#CK_F_PR_OR_64


	)

73 
	#CK_F_PR_OR_INT


	)

74 
	#CK_F_PR_OR_PTR


	)

75 
	#CK_F_PR_OR_UINT


	)

76 
	#CK_F_PR_STALL


	)

77 
	#CK_F_PR_STORE_16


	)

78 
	#CK_F_PR_STORE_32


	)

79 
	#CK_F_PR_STORE_64


	)

80 
	#CK_F_PR_STORE_8


	)

81 
	#CK_F_PR_STORE_CHAR


	)

82 
	#CK_F_PR_STORE_DOUBLE


	)

83 
	#CK_F_PR_STORE_INT


	)

84 
	#CK_F_PR_STORE_PTR


	)

85 
	#CK_F_PR_STORE_SHORT


	)

86 
	#CK_F_PR_STORE_UINT


	)

87 
	#CK_F_PR_SUB_32


	)

88 
	#CK_F_PR_SUB_64


	)

89 
	#CK_F_PR_SUB_INT


	)

90 
	#CK_F_PR_SUB_PTR


	)

91 
	#CK_F_PR_SUB_UINT


	)

92 
	#CK_F_PR_XOR_32


	)

93 
	#CK_F_PR_XOR_64


	)

94 
	#CK_F_PR_XOR_INT


	)

95 
	#CK_F_PR_XOR_PTR


	)

96 
	#CK_F_PR_XOR_UINT


	)

	@application/kvbench/include/aerospike/ck/gcc/ppc64/ck_pr.h

27 #iâdeà
CK_PR_PPC64_H


28 
	#CK_PR_PPC64_H


	)

30 #iâdeà
CK_PR_H


31 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


34 
	~<«ro¥ike/ck/ck_cc.h
>

35 
	~<«ro¥ike/ck/ck_md.h
>

41 
	~"ck_f_´.h
"

46 
	#CK_F_PR


	)

53 
CK_CC_INLINE
 

54 
	$ck_´_¡®l
()

57 
__asm__
 
	`__vŞ©e__
("or 1, 1, 1;"

60 
	}
}

62 
	#CK_PR_FENCE
(
T
, 
I
) \

63 
CK_CC_INLINE
 \

64 
ck_´_ãnû_¡riù_
##
	`T
() \

66 
__asm__
 
	`__vŞ©e__
(
I
 ::: "memory"); \

67 }

	)

73 
CK_PR_FENCE
(
©omic
, "lwsync")

74 
CK_PR_FENCE
(
©omic_¡Üe
, "lwsync")

75 
CK_PR_FENCE
(
©omic_lßd
, "sync")

76 
CK_PR_FENCE
(
¡Üe_©omic
, "lwsync")

77 
CK_PR_FENCE
(
lßd_©omic
, "lwsync")

78 
CK_PR_FENCE
(
¡Üe
, "lwsync")

79 
CK_PR_FENCE
(
¡Üe_lßd
, "sync")

80 
CK_PR_FENCE
(
lßd
, "lwsync")

81 
CK_PR_FENCE
(
lßd_¡Üe
, "lwsync")

82 
CK_PR_FENCE
(
memÜy
, "sync")

83 
CK_PR_FENCE
(
acquœe
, "lwsync")

84 
CK_PR_FENCE
(
»Ëa£
, "lwsync")

85 
CK_PR_FENCE
(
acq»l
, "lwsync")

86 
CK_PR_FENCE
(
lock
, "lwsync")

87 
CK_PR_FENCE
(
uÆock
, "lwsync")

89 #undeà
CK_PR_FENCE


91 
	#CK_PR_LOAD
(
S
, 
M
, 
T
, 
C
, 
I
) \

92 
CK_CC_INLINE
 
T
 \

93 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

95 
T
 
r
; \

96 
__asm__
 
	`__vŞ©e__
(
I
 "%U1%X1 %0, %1" \

97 : "ô" (
r
) \

98 : "m" (*(cÚ¡ 
C
 *)
rg‘
) \

100  (
r
); \

101 }

	)

103 
CK_PR_LOAD
(
±r
, , *, 
ušt64_t
, "ld")

105 
	#CK_PR_LOAD_S
(
S
, 
T
, 
I
è
	`CK_PR_LOAD
(S, T, T, T, I)

	)

107 
CK_PR_LOAD_S
(64, 
ušt64_t
, "ld")

108 
CK_PR_LOAD_S
(32, 
ušt32_t
, "lwz")

109 
CK_PR_LOAD_S
(16, 
ušt16_t
, "lhz")

110 
CK_PR_LOAD_S
(8, 
ušt8_t
, "lbz")

111 
CK_PR_LOAD_S
(
ušt
, , "lwz")

112 
CK_PR_LOAD_S
(, , "lwz")

113 
CK_PR_LOAD_S
(, , "lhz")

114 
CK_PR_LOAD_S
(, , "lbz")

115 
CK_PR_LOAD_S
(, , "ld")

117 #undeà
CK_PR_LOAD_S


118 #undeà
CK_PR_LOAD


120 
	#CK_PR_STORE
(
S
, 
M
, 
T
, 
C
, 
I
) \

121 
CK_CC_INLINE
 \

122 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

124 
__asm__
 
	`__vŞ©e__
(
I
 "%U0%X0 %1, %0" \

125 : "=m" (*(
C
 *)
rg‘
) \

126 : "r" (
v
) \

129 }

	)

131 
CK_PR_STORE
(
±r
, , cÚ¡ *, 
ušt64_t
, "std")

133 
	#CK_PR_STORE_S
(
S
, 
T
, 
I
è
	`CK_PR_STORE
(S, T, T, T, I)

	)

135 
CK_PR_STORE_S
(64, 
ušt64_t
, "std")

136 
CK_PR_STORE_S
(32, 
ušt32_t
, "stw")

137 
CK_PR_STORE_S
(16, 
ušt16_t
, "sth")

138 
CK_PR_STORE_S
(8, 
ušt8_t
, "stb")

139 
CK_PR_STORE_S
(
ušt
, , "stw")

140 
CK_PR_STORE_S
(, , "stw")

141 
CK_PR_STORE_S
(, , "sth")

142 
CK_PR_STORE_S
(, , "stb")

143 
CK_PR_STORE_S
(, , "std")

145 #undeà
CK_PR_STORE_S


146 #undeà
CK_PR_STORE


148 
CK_CC_INLINE
 
boŞ


149 
	$ck_´_ÿs_64_v®ue
(
ušt64_t
 *
rg‘
, ušt64_ˆ
com·»
, ušt64_ˆ
£t
, ušt64_ˆ*
v®ue
)

151 
ušt64_t
 
´evious
;

153 
__asm__
 
	`__vŞ©e__
("1:"

160 : "=&r" (
´evious
)

161 : "r" (
rg‘
),

162 "r" (
£t
),

163 "r" (
com·»
)

166 *
v®ue
 = 
´evious
;

167  (
´evious
 =ğ
com·»
);

168 
	}
}

170 
CK_CC_INLINE
 
boŞ


171 
	$ck_´_ÿs_±r_v®ue
(*
rg‘
, *
com·»
, *
£t
, *
v®ue
)

173 *
´evious
;

175 
__asm__
 
	`__vŞ©e__
("1:"

182 : "=&r" (
´evious
)

183 : "r" (
rg‘
),

184 "r" (
£t
),

185 "r" (
com·»
)

188 
	`ck_´_md_¡Üe_±r
(
v®ue
, 
´evious
);

189  (
´evious
 =ğ
com·»
);

190 
	}
}

192 
CK_CC_INLINE
 
boŞ


193 
	$ck_´_ÿs_64
(
ušt64_t
 *
rg‘
, ušt64_ˆ
com·»
, ušt64_ˆ
£t
)

195 
ušt64_t
 
´evious
;

197 
__asm__
 
	`__vŞ©e__
("1:"

204 : "=&r" (
´evious
)

205 : "r" (
rg‘
),

206 "r" (
£t
),

207 "r" (
com·»
)

210  (
´evious
 =ğ
com·»
);

211 
	}
}

213 
CK_CC_INLINE
 
boŞ


214 
	$ck_´_ÿs_±r
(*
rg‘
, *
com·»
, *
£t
)

216 *
´evious
;

218 
__asm__
 
	`__vŞ©e__
("1:"

225 : "=&r" (
´evious
)

226 : "r" (
rg‘
),

227 "r" (
£t
),

228 "r" (
com·»
)

231  (
´evious
 =ğ
com·»
);

232 
	}
}

234 
	#CK_PR_CAS
(
N
, 
T
) \

235 
CK_CC_INLINE
 
boŞ
 \

236 
ck_´_ÿs_
##
N
##
	`_v®ue
(
T
 *
rg‘
, T 
com·»
, T 
£t
, T *
v®ue
) \

238 
T
 
´evious
; \

239 
__asm__
 
	`__vŞ©e__
("1:" \

246 : "=&r" (
´evious
) \

247 : "r" (
rg‘
), \

248 "r" (
£t
), \

249 "r" (
com·»
) \

251 *
v®ue
 = 
´evious
; \

252  (
´evious
 =ğ
com·»
); \

254 
CK_CC_INLINE
 
boŞ
 \

255 
ck_´_ÿs_
##
	`N
(
T
 *
rg‘
, T 
com·»
, T 
£t
) \

257 
T
 
´evious
; \

258 
__asm__
 
	`__vŞ©e__
("1:" \

265 : "=&r" (
´evious
) \

266 : "r" (
rg‘
), \

267 "r" (
£t
), \

268 "r" (
com·»
) \

270  (
´evious
 =ğ
com·»
); \

271 }

	)

273 
	$CK_PR_CAS
(32, 
ušt32_t
)

274 
	$CK_PR_CAS
(
ušt
, )

275 
	$CK_PR_CAS
(, )

277 #undeà
CK_PR_CAS


279 
	#CK_PR_FAS
(
N
, 
M
, 
T
, 
W
) \

280 
CK_CC_INLINE
 
T
 \

281 
ck_´_çs_
##
	`N
(
M
 *
rg‘
, 
T
 
v
) \

283 
T
 
´evious
; \

284 
__asm__
 
	`__vŞ©e__
("1:" \

285 "l" 
W
 "arx %0, 0, %1;" \

286 "¡" 
W
 "cx. %2, 0, %1;" \

288 : "=&r" (
´evious
) \

289 : "r" (
rg‘
), \

290 "r" (
v
) \

292  (
´evious
); \

293 
	}

	)
}

295 
CK_PR_FAS
(64, 
ušt64_t
, uint64_t, "d")

296 
CK_PR_FAS
(32, 
ušt32_t
, uint32_t, "w")

297 
CK_PR_FAS
(, , , "d")

298 
CK_PR_FAS
(
±r
, , *, "d")

299 
CK_PR_FAS
(, , , "w")

300 
CK_PR_FAS
(
ušt
, , , "w")

302 #undeà
CK_PR_FAS


304 
	#CK_PR_UNARY
(
O
, 
N
, 
M
, 
T
, 
I
, 
W
) \

305 
CK_CC_INLINE
 \

306 
ck_´_
##
O
##
_
##
	`N
(
M
 *
rg‘
) \

308 
T
 
´evious
; \

309 
__asm__
 
	`__vŞ©e__
("1:" \

310 "l" 
W
 "arx %0, 0, %1;" \

311 
I
 ";" \

312 "¡" 
W
 "cx. %0, 0, %1;" \

314 : "=&r" (
´evious
) \

315 : "r" (
rg‘
) \

318 }

	)

320 
CK_PR_UNARY
(
šc
, 
±r
, , *, "addic %0, %0, 1", "d")

321 
CK_PR_UNARY
(
dec
, 
±r
, , *, "addic %0, %0, -1", "d")

322 
CK_PR_UNARY
(
nÙ
, 
±r
, , *, "not %0, %0", "d")

323 
CK_PR_UNARY
(
Ãg
, 
±r
, , *, "neg %0, %0", "d")

325 
	#CK_PR_UNARY_S
(
S
, 
T
, 
W
) \

326 
	`CK_PR_UNARY
(
šc
, 
S
, 
T
, T, "addiø%0, %0, 1", 
W
) \

327 
	`CK_PR_UNARY
(
dec
, 
S
, 
T
, T, "addiø%0, %0, -1", 
W
) \

328 
	`CK_PR_UNARY
(
nÙ
, 
S
, 
T
, T, "nÙ %0, %0", 
W
) \

329 
	`CK_PR_UNARY
(
Ãg
, 
S
, 
T
, T, "Ãg %0, %0", 
W
)

	)

331 
CK_PR_UNARY_S
(64, 
ušt64_t
, "d")

332 
CK_PR_UNARY_S
(32, 
ušt32_t
, "w")

333 
CK_PR_UNARY_S
(
ušt
, , "w")

334 
CK_PR_UNARY_S
(, , "w")

336 #undeà
CK_PR_UNARY_S


337 #undeà
CK_PR_UNARY


339 
	#CK_PR_BINARY
(
O
, 
N
, 
M
, 
T
, 
I
, 
W
) \

340 
CK_CC_INLINE
 \

341 
ck_´_
##
O
##
_
##
	`N
(
M
 *
rg‘
, 
T
 
d–
) \

343 
T
 
´evious
; \

344 
__asm__
 
	`__vŞ©e__
("1:" \

345 "l" 
W
 "arx %0, 0, %1;" \

346 
I
 " %0, %2, %0;" \

347 "¡" 
W
 "cx. %0, 0, %1;" \

349 : "=&r" (
´evious
) \

350 : "r" (
rg‘
), \

351 "r" (
d–
) \

354 }

	)

356 
CK_PR_BINARY
(
ªd
, 
±r
, , 
ušŒ_t
, "and", "d")

357 
CK_PR_BINARY
(
add
, 
±r
, , 
ušŒ_t
, "add", "d")

358 
CK_PR_BINARY
(
Ü
, 
±r
, , 
ušŒ_t
, "or", "d")

359 
CK_PR_BINARY
(
sub
, 
±r
, , 
ušŒ_t
, "sub", "d")

360 
CK_PR_BINARY
(
xÜ
, 
±r
, , 
ušŒ_t
, "xor", "d")

362 
	#CK_PR_BINARY_S
(
S
, 
T
, 
W
) \

363 
	`CK_PR_BINARY
(
ªd
, 
S
, 
T
, T, "ªd", 
W
) \

364 
	`CK_PR_BINARY
(
add
, 
S
, 
T
, T, "add", 
W
) \

365 
	`CK_PR_BINARY
(
Ü
, 
S
, 
T
, T, "Ü", 
W
) \

366 
	`CK_PR_BINARY
(
sub
, 
S
, 
T
, T, "subf", 
W
) \

367 
	`CK_PR_BINARY
(
xÜ
, 
S
, 
T
, T, "xÜ", 
W
)

	)

369 
CK_PR_BINARY_S
(64, 
ušt64_t
, "d")

370 
CK_PR_BINARY_S
(32, 
ušt32_t
, "w")

371 
CK_PR_BINARY_S
(
ušt
, , "w")

372 
CK_PR_BINARY_S
(, , "w")

374 #undeà
CK_PR_BINARY_S


375 #undeà
CK_PR_BINARY


377 
CK_CC_INLINE
 *

378 
	$ck_´_ça_±r
(*
rg‘
, 
ušŒ_t
 
d–
)

380 
ušŒ_t
 
´evious
, 
r
;

382 
__asm__
 
	`__vŞ©e__
("1:"

387 : "=&r" (
´evious
),

388 "=&r" (
r
)

389 : "r" (
rg‘
),

390 "r" (
d–
)

393  (*)(
´evious
);

394 
	}
}

396 
	#CK_PR_FAA
(
S
, 
T
, 
W
) \

397 
CK_CC_INLINE
 
T
 \

398 
ck_´_ça_
##
	`S
(
T
 *
rg‘
, T 
d–
) \

400 
T
 
´evious
, 
r
; \

401 
__asm__
 
	`__vŞ©e__
("1:" \

402 "l" 
W
 "arx %0, 0, %2;" \

404 "¡" 
W
 "cx. %1, 0, %2;" \

406 : "=&r" (
´evious
), \

407 "=&r" (
r
) \

408 : "r" (
rg‘
), \

409 "r" (
d–
) \

411  (
´evious
); \

412 }

	)

414 
CK_PR_FAA
(64, 
ušt64_t
, "d")

415 
CK_PR_FAA
(32, 
ušt32_t
, "w")

416 
CK_PR_FAA
(
ušt
, , "w")

417 
CK_PR_FAA
(, , "w")

419 #undeà
CK_PR_FAA


	@application/kvbench/include/aerospike/ck/gcc/sparcv9/ck_f_pr.h

1 
	#CK_F_PR_CAS_64


	)

2 
	#CK_F_PR_CAS_64_VALUE


	)

3 
	#CK_F_PR_CAS_PTR


	)

4 
	#CK_F_PR_CAS_PTR_VALUE


	)

5 
	#CK_F_PR_FAS_32


	)

6 
	#CK_F_PR_FAS_UINT


	)

7 
	#CK_F_PR_FAS_INT


	)

8 
	#CK_F_PR_CAS_32


	)

9 
	#CK_F_PR_CAS_32_VALUE


	)

10 
	#CK_F_PR_CAS_UINT


	)

11 
	#CK_F_PR_CAS_INT


	)

12 
	#CK_F_PR_CAS_UINT_VALUE


	)

13 
	#CK_F_PR_CAS_INT_VALUE


	)

14 
	#CK_F_PR_STORE_64


	)

15 
	#CK_F_PR_STORE_32


	)

16 
	#CK_F_PR_STORE_DOUBLE


	)

17 
	#CK_F_PR_STORE_UINT


	)

18 
	#CK_F_PR_STORE_INT


	)

19 
	#CK_F_PR_STORE_PTR


	)

20 
	#CK_F_PR_LOAD_64


	)

21 
	#CK_F_PR_LOAD_32


	)

22 
	#CK_F_PR_LOAD_DOUBLE


	)

23 
	#CK_F_PR_LOAD_UINT


	)

24 
	#CK_F_PR_LOAD_INT


	)

25 
	#CK_F_PR_LOAD_PTR


	)

	@application/kvbench/include/aerospike/ck/gcc/sparcv9/ck_pr.h

27 #iâdeà
CK_PR_SPARCV9_H


28 
	#CK_PR_SPARCV9_H


	)

30 #iâdeà
CK_PR_H


31 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


34 
	~<«ro¥ike/ck/ck_cc.h
>

35 
	~<«ro¥ike/ck/ck_md.h
>

41 
	~"ck_f_´.h
"

46 
	#CK_F_PR


	)

51 
CK_CC_INLINE
 

52 
	$ck_´_¡®l
()

55 
__asm__
 
	`__vŞ©e__
("membar #LoadLoad" ::: "memory");

57 
	}
}

59 
	#CK_PR_FENCE
(
T
, 
I
) \

60 
CK_CC_INLINE
 \

61 
ck_´_ãnû_¡riù_
##
	`T
() \

63 
__asm__
 
	`__vŞ©e__
(
I
 ::: "memory"); \

64 }

	)

70 
CK_PR_FENCE
(
©omic
, "membar #StoreStore")

71 
CK_PR_FENCE
(
©omic_¡Üe
, "membar #StoreStore")

72 
CK_PR_FENCE
(
©omic_lßd
, "membar #StoreLoad")

73 
CK_PR_FENCE
(
¡Üe_©omic
, "membar #StoreStore")

74 
CK_PR_FENCE
(
lßd_©omic
, "membar #LoadStore")

75 
CK_PR_FENCE
(
¡Üe
, "membar #StoreStore")

76 
CK_PR_FENCE
(
¡Üe_lßd
, "membar #StoreLoad")

77 
CK_PR_FENCE
(
lßd
, "membar #LoadLoad")

78 
CK_PR_FENCE
(
lßd_¡Üe
, "membar #LoadStore")

79 
CK_PR_FENCE
(
memÜy
, "membar #LoadLoad | #LoadStore | #StoreStore | #StoreLoad")

80 
CK_PR_FENCE
(
acquœe
, "membar #LoadLoad | #LoadStore")

81 
CK_PR_FENCE
(
»Ëa£
, "membar #LoadStore | #StoreStore")

82 
CK_PR_FENCE
(
acq»l
, "membar #LoadLoad | #LoadStore | #StoreStore")

83 
CK_PR_FENCE
(
lock
, "membar #LoadLoad | #LoadStore | #StoreStore | #StoreLoad")

84 
CK_PR_FENCE
(
uÆock
, "membar #LoadStore | #StoreStore")

86 #undeà
CK_PR_FENCE


88 
	#CK_PR_LOAD
(
S
, 
M
, 
T
, 
C
, 
I
) \

89 
CK_CC_INLINE
 
T
 \

90 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

92 
T
 
r
; \

93 
__asm__
 
	`__vŞ©e__
(
I
 " [%1], %0" \

94 : "=&r" (
r
) \

95 : "r" (
rg‘
) \

97  (
r
); \

98 }

	)

100 
CK_PR_LOAD
(
±r
, , *, 
ušt64_t
, "ldx")

102 
	#CK_PR_LOAD_S
(
S
, 
T
, 
I
è
	`CK_PR_LOAD
(S, T, T, T, I)

	)

104 
CK_PR_LOAD_S
(64, 
ušt64_t
, "ldx")

105 
CK_PR_LOAD_S
(32, 
ušt32_t
, "lduw")

106 
CK_PR_LOAD_S
(
ušt
, , "lduw")

107 
CK_PR_LOAD_S
(, , "ldx")

108 
CK_PR_LOAD_S
(, , "ldsw")

110 #undeà
CK_PR_LOAD_S


111 #undeà
CK_PR_LOAD


113 
	#CK_PR_STORE
(
S
, 
M
, 
T
, 
C
, 
I
) \

114 
CK_CC_INLINE
 \

115 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

117 
__asm__
 
	`__vŞ©e__
(
I
 " %0, [%1]" \

119 : "r" (
v
), \

120 "r" (
rg‘
) \

123 }

	)

125 
CK_PR_STORE
(
±r
, , cÚ¡ *, 
ušt64_t
, "stx")

127 
	#CK_PR_STORE_S
(
S
, 
T
, 
I
è
	`CK_PR_STORE
(S, T, T, T, I)

	)

129 
CK_PR_STORE_S
(8, 
ušt8_t
, "stub")

130 
CK_PR_STORE_S
(64, 
ušt64_t
, "stx")

131 
CK_PR_STORE_S
(32, 
ušt32_t
, "stuw")

132 
CK_PR_STORE_S
(
ušt
, , "stuw")

133 
CK_PR_STORE_S
(, , "stx")

134 
CK_PR_STORE_S
(, , "stsw")

136 #undeà
CK_PR_STORE_S


137 #undeà
CK_PR_STORE


139 
CK_CC_INLINE
 
boŞ


140 
	$ck_´_ÿs_64_v®ue
(
ušt64_t
 *
rg‘
, ušt64_ˆ
com·»
, ušt64_ˆ
£t
, ušt64_ˆ*
v®ue
)

143 
__asm__
 
	`__vŞ©e__
("casx [%1], %2, %0"

144 : "+&r" (
£t
)

145 : "r" (
rg‘
),

146 "r" (
com·»
)

149 *
v®ue
 = 
£t
;

150  (
com·»
 =ğ
£t
);

151 
	}
}

153 
CK_CC_INLINE
 
boŞ


154 
	$ck_´_ÿs_64
(
ušt64_t
 *
rg‘
, ušt64_ˆ
com·»
, ušt64_ˆ
£t
)

157 
__asm__
 
	`__vŞ©e__
("casx [%1], %2, %0"

158 : "+&r" (
£t
)

159 : "r" (
rg‘
),

160 "r" (
com·»
)

163  (
com·»
 =ğ
£t
);

164 
	}
}

166 
CK_CC_INLINE
 
boŞ


167 
	$ck_´_ÿs_±r
(*
rg‘
, *
com·»
, *
£t
)

170  
	`ck_´_ÿs_64
(
rg‘
, (
ušt64_t
)
com·»
, (ušt64_t)
£t
);

171 
	}
}

173 
CK_CC_INLINE
 
boŞ


174 
	$ck_´_ÿs_±r_v®ue
(*
rg‘
, *
com·»
, *
£t
, *
´evious
)

177  
	`ck_´_ÿs_64_v®ue
(
rg‘
, (
ušt64_t
)
com·»
, (ušt64_t)
£t
, 
´evious
);

178 
	}
}

180 
	#CK_PR_CAS
(
N
, 
T
) \

181 
CK_CC_INLINE
 
boŞ
 \

182 
ck_´_ÿs_
##
N
##
	`_v®ue
(
T
 *
rg‘
, T 
com·»
, T 
£t
, T *
v®ue
) \

184 
__asm__
 
	`__vŞ©e__
("cas [%1], %2, %0" \

185 : "+&r" (
£t
) \

186 : "r" (
rg‘
), \

187 "r" (
com·»
) \

189 *
v®ue
 = 
£t
; \

190  (
com·»
 =ğ
£t
); \

192 
CK_CC_INLINE
 
boŞ
 \

193 
ck_´_ÿs_
##
	`N
(
T
 *
rg‘
, T 
com·»
, T 
£t
) \

195 
__asm__
 
	`__vŞ©e__
("cas [%1], %2, %0" \

196 : "+&r" (
£t
) \

197 : "r" (
rg‘
), \

198 "r" (
com·»
) \

200  (
com·»
 =ğ
£t
); \

201 }

	)

203 
	$CK_PR_CAS
(32, 
ušt32_t
)

204 
	$CK_PR_CAS
(
ušt
, )

205 
	$CK_PR_CAS
(, )

207 #undeà
CK_PR_CAS


209 
	#CK_PR_FAS
(
N
, 
T
) \

210 
CK_CC_INLINE
 
T
 \

211 
ck_´_çs_
##
	`N
(
T
 *
rg‘
, T 
upd©e
) \

214 
__asm__
 
	`__vŞ©e__
("swap [%1], %0" \

215 : "+&r" (
upd©e
) \

216 : "r" (
rg‘
) \

218  (
upd©e
); \

219 
	}

	)
}

221 
	$CK_PR_FAS
(, )

222 
	$CK_PR_FAS
(
ušt
, )

223 
	$CK_PR_FAS
(32, 
ušt32_t
)

225 #undeà
CK_PR_FAS


	@application/kvbench/include/aerospike/ck/gcc/x86/ck_f_pr.h

2 
	#CK_F_PR_ADD_16


	)

3 
	#CK_F_PR_ADD_32


	)

4 
	#CK_F_PR_ADD_8


	)

5 
	#CK_F_PR_ADD_CHAR


	)

6 
	#CK_F_PR_ADD_INT


	)

7 
	#CK_F_PR_ADD_PTR


	)

8 
	#CK_F_PR_ADD_UINT


	)

9 
	#CK_F_PR_AND_16


	)

10 
	#CK_F_PR_AND_32


	)

11 
	#CK_F_PR_AND_8


	)

12 
	#CK_F_PR_AND_CHAR


	)

13 
	#CK_F_PR_AND_INT


	)

14 
	#CK_F_PR_AND_PTR


	)

15 
	#CK_F_PR_AND_UINT


	)

16 
	#CK_F_PR_BTC_16


	)

17 
	#CK_F_PR_BTC_32


	)

18 
	#CK_F_PR_BTC_INT


	)

19 
	#CK_F_PR_BTC_PTR


	)

20 
	#CK_F_PR_BTC_UINT


	)

21 
	#CK_F_PR_BTR_16


	)

22 
	#CK_F_PR_BTR_32


	)

23 
	#CK_F_PR_BTR_INT


	)

24 
	#CK_F_PR_BTR_PTR


	)

25 
	#CK_F_PR_BTR_UINT


	)

26 
	#CK_F_PR_BTS_16


	)

27 
	#CK_F_PR_BTS_32


	)

28 
	#CK_F_PR_BTS_INT


	)

29 
	#CK_F_PR_BTS_PTR


	)

30 
	#CK_F_PR_BTS_UINT


	)

31 
	#CK_F_PR_CAS_16


	)

32 
	#CK_F_PR_CAS_16_VALUE


	)

33 
	#CK_F_PR_CAS_32


	)

34 
	#CK_F_PR_CAS_32_VALUE


	)

35 
	#CK_F_PR_CAS_8


	)

36 
	#CK_F_PR_CAS_8_VALUE


	)

37 
	#CK_F_PR_CAS_CHAR


	)

38 
	#CK_F_PR_CAS_CHAR_VALUE


	)

39 
	#CK_F_PR_CAS_INT


	)

40 
	#CK_F_PR_CAS_INT_VALUE


	)

41 
	#CK_F_PR_CAS_PTR


	)

42 
	#CK_F_PR_CAS_PTR_VALUE


	)

43 
	#CK_F_PR_CAS_UINT


	)

44 
	#CK_F_PR_CAS_UINT_VALUE


	)

45 
	#CK_F_PR_DEC_16


	)

46 
	#CK_F_PR_DEC_16_ZERO


	)

47 
	#CK_F_PR_DEC_32


	)

48 
	#CK_F_PR_DEC_32_ZERO


	)

49 
	#CK_F_PR_DEC_8


	)

50 
	#CK_F_PR_DEC_8_ZERO


	)

51 
	#CK_F_PR_DEC_CHAR


	)

52 
	#CK_F_PR_DEC_CHAR_ZERO


	)

53 
	#CK_F_PR_DEC_INT


	)

54 
	#CK_F_PR_DEC_INT_ZERO


	)

55 
	#CK_F_PR_DEC_PTR


	)

56 
	#CK_F_PR_DEC_PTR_ZERO


	)

57 
	#CK_F_PR_DEC_UINT


	)

58 
	#CK_F_PR_DEC_UINT_ZERO


	)

59 
	#CK_F_PR_FAA_16


	)

60 
	#CK_F_PR_FAA_32


	)

61 
	#CK_F_PR_FAA_8


	)

62 
	#CK_F_PR_FAA_CHAR


	)

63 
	#CK_F_PR_FAA_INT


	)

64 
	#CK_F_PR_FAA_PTR


	)

65 
	#CK_F_PR_FAA_UINT


	)

66 
	#CK_F_PR_FAS_16


	)

67 
	#CK_F_PR_FAS_32


	)

68 
	#CK_F_PR_FAS_8


	)

69 
	#CK_F_PR_FAS_CHAR


	)

70 
	#CK_F_PR_FAS_INT


	)

71 
	#CK_F_PR_FAS_PTR


	)

72 
	#CK_F_PR_FAS_UINT


	)

73 
	#CK_F_PR_FENCE_LOAD


	)

74 
	#CK_F_PR_FENCE_LOAD_DEPENDS


	)

75 
	#CK_F_PR_FENCE_MEMORY


	)

76 
	#CK_F_PR_FENCE_STORE


	)

77 
	#CK_F_PR_FENCE_STRICT_LOAD


	)

78 
	#CK_F_PR_FENCE_STRICT_LOAD_DEPENDS


	)

79 
	#CK_F_PR_FENCE_STRICT_MEMORY


	)

80 
	#CK_F_PR_FENCE_STRICT_STORE


	)

81 
	#CK_F_PR_INC_16


	)

82 
	#CK_F_PR_INC_16_ZERO


	)

83 
	#CK_F_PR_INC_32


	)

84 
	#CK_F_PR_INC_32_ZERO


	)

85 
	#CK_F_PR_INC_8


	)

86 
	#CK_F_PR_INC_8_ZERO


	)

87 
	#CK_F_PR_INC_CHAR


	)

88 
	#CK_F_PR_INC_CHAR_ZERO


	)

89 
	#CK_F_PR_INC_INT


	)

90 
	#CK_F_PR_INC_INT_ZERO


	)

91 
	#CK_F_PR_INC_PTR


	)

92 
	#CK_F_PR_INC_PTR_ZERO


	)

93 
	#CK_F_PR_INC_UINT


	)

94 
	#CK_F_PR_INC_UINT_ZERO


	)

95 
	#CK_F_PR_LOAD_16


	)

96 
	#CK_F_PR_LOAD_32


	)

97 
	#CK_F_PR_LOAD_8


	)

98 
	#CK_F_PR_LOAD_CHAR


	)

99 
	#CK_F_PR_LOAD_INT


	)

100 
	#CK_F_PR_LOAD_PTR


	)

101 
	#CK_F_PR_LOAD_UINT


	)

102 
	#CK_F_PR_NEG_16


	)

103 
	#CK_F_PR_NEG_16_ZERO


	)

104 
	#CK_F_PR_NEG_32


	)

105 
	#CK_F_PR_NEG_32_ZERO


	)

106 
	#CK_F_PR_NEG_8


	)

107 
	#CK_F_PR_NEG_8_ZERO


	)

108 
	#CK_F_PR_NEG_CHAR


	)

109 
	#CK_F_PR_NEG_CHAR_ZERO


	)

110 
	#CK_F_PR_NEG_INT


	)

111 
	#CK_F_PR_NEG_INT_ZERO


	)

112 
	#CK_F_PR_NEG_PTR


	)

113 
	#CK_F_PR_NEG_PTR_ZERO


	)

114 
	#CK_F_PR_NEG_UINT


	)

115 
	#CK_F_PR_NEG_UINT_ZERO


	)

116 
	#CK_F_PR_NOT_16


	)

117 
	#CK_F_PR_NOT_32


	)

118 
	#CK_F_PR_NOT_8


	)

119 
	#CK_F_PR_NOT_CHAR


	)

120 
	#CK_F_PR_NOT_INT


	)

121 
	#CK_F_PR_NOT_PTR


	)

122 
	#CK_F_PR_NOT_UINT


	)

123 
	#CK_F_PR_OR_16


	)

124 
	#CK_F_PR_OR_32


	)

125 
	#CK_F_PR_OR_8


	)

126 
	#CK_F_PR_OR_CHAR


	)

127 
	#CK_F_PR_OR_INT


	)

128 
	#CK_F_PR_OR_PTR


	)

129 
	#CK_F_PR_OR_UINT


	)

130 
	#CK_F_PR_STALL


	)

131 
	#CK_F_PR_STORE_16


	)

132 
	#CK_F_PR_STORE_32


	)

133 
	#CK_F_PR_STORE_8


	)

134 
	#CK_F_PR_STORE_CHAR


	)

135 
	#CK_F_PR_STORE_INT


	)

136 
	#CK_F_PR_STORE_PTR


	)

137 
	#CK_F_PR_STORE_UINT


	)

138 
	#CK_F_PR_SUB_16


	)

139 
	#CK_F_PR_SUB_32


	)

140 
	#CK_F_PR_SUB_8


	)

141 
	#CK_F_PR_SUB_CHAR


	)

142 
	#CK_F_PR_SUB_INT


	)

143 
	#CK_F_PR_SUB_PTR


	)

144 
	#CK_F_PR_SUB_UINT


	)

145 
	#CK_F_PR_XOR_16


	)

146 
	#CK_F_PR_XOR_32


	)

147 
	#CK_F_PR_XOR_8


	)

148 
	#CK_F_PR_XOR_CHAR


	)

149 
	#CK_F_PR_XOR_INT


	)

150 
	#CK_F_PR_XOR_PTR


	)

151 
	#CK_F_PR_XOR_UINT


	)

	@application/kvbench/include/aerospike/ck/gcc/x86/ck_pr.h

28 #iâdeà
CK_PR_X86_H


29 
	#CK_PR_X86_H


	)

31 #iâdeà
CK_PR_H


32 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


35 
	~<«ro¥ike/ck/ck_cc.h
>

36 
	~<«ro¥ike/ck/ck_md.h
>

37 
	~<«ro¥ike/ck/ck_¡dšt.h
>

43 
	~"ck_f_´.h
"

46 
	#CK_F_PR


	)

48 #ifdeà
CK_MD_UMP


49 
	#CK_PR_LOCK_PREFIX


	)

51 
	#CK_PR_LOCK_PREFIX
 "lock "

	)

58 
CK_CC_INLINE
 

59 
	$ck_´_¡®l
()

61 
__asm__
 
	`__vŞ©e__
("pause" ::: "memory");

63 
	}
}

65 
	#CK_PR_FENCE
(
T
, 
I
) \

66 
CK_CC_INLINE
 \

67 
ck_´_ãnû_¡riù_
##
	`T
() \

69 
__asm__
 
	`__vŞ©e__
(
I
 ::: "memory"); \

70 }

	)

72 
CK_PR_FENCE
(
©omic
, "sfence")

73 
CK_PR_FENCE
(
©omic_¡Üe
, "sfence")

74 
CK_PR_FENCE
(
©omic_lßd
, "mfence")

75 
CK_PR_FENCE
(
¡Üe_©omic
, "sfence")

76 
CK_PR_FENCE
(
lßd_©omic
, "mfence")

77 
CK_PR_FENCE
(
lßd
, "lfence")

78 
CK_PR_FENCE
(
lßd_¡Üe
, "mfence")

79 
CK_PR_FENCE
(
¡Üe
, "sfence")

80 
CK_PR_FENCE
(
¡Üe_lßd
, "mfence")

81 
CK_PR_FENCE
(
memÜy
, "mfence")

82 
CK_PR_FENCE
(
»Ëa£
, "mfence")

83 
CK_PR_FENCE
(
acquœe
, "mfence")

84 
CK_PR_FENCE
(
acq»l
, "mfence")

85 
CK_PR_FENCE
(
lock
, "mfence")

86 
CK_PR_FENCE
(
uÆock
, "mfence")

88 #undeà
CK_PR_FENCE


93 
	#CK_PR_FAS
(
S
, 
M
, 
T
, 
C
, 
I
) \

94 
CK_CC_INLINE
 
T
 \

95 
ck_´_çs_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

97 
__asm__
 
	`__vŞ©e__
(
I
 " %0, %1" \

98 : "+m" (*(
C
 *)
rg‘
), \

99 "+q" (
v
) \

102  
v
; \

103 }

	)

105 
CK_PR_FAS
(
±r
, , *, , "xchgl")

107 
	#CK_PR_FAS_S
(
S
, 
T
, 
I
è
	`CK_PR_FAS
(S, T, T, T, I)

	)

109 
CK_PR_FAS_S
(, , "xchgb")

110 
CK_PR_FAS_S
(
ušt
, , "xchgl")

111 
CK_PR_FAS_S
(, , "xchgl")

112 
CK_PR_FAS_S
(32, 
ušt32_t
, "xchgl")

113 
CK_PR_FAS_S
(16, 
ušt16_t
, "xchgw")

114 
CK_PR_FAS_S
(8, 
ušt8_t
, "xchgb")

116 #undeà
CK_PR_FAS_S


117 #undeà
CK_PR_FAS


119 
	#CK_PR_LOAD
(
S
, 
M
, 
T
, 
C
, 
I
) \

120 
CK_CC_INLINE
 
T
 \

121 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

123 
T
 
r
; \

124 
__asm__
 
	`__vŞ©e__
(
I
 " %1, %0" \

125 : "=q" (
r
) \

126 : "m" (*(cÚ¡ 
C
 *)
rg‘
) \

128  (
r
); \

129 }

	)

131 
CK_PR_LOAD
(
±r
, , *, , "movl")

133 
	#CK_PR_LOAD_S
(
S
, 
T
, 
I
è
	`CK_PR_LOAD
(S, T, T, T, I)

	)

135 
CK_PR_LOAD_S
(, , "movb")

136 
CK_PR_LOAD_S
(
ušt
, , "movl")

137 
CK_PR_LOAD_S
(, , "movl")

138 
CK_PR_LOAD_S
(32, 
ušt32_t
, "movl")

139 
CK_PR_LOAD_S
(16, 
ušt16_t
, "movw")

140 
CK_PR_LOAD_S
(8, 
ušt8_t
, "movb")

142 #undeà
CK_PR_LOAD_S


143 #undeà
CK_PR_LOAD


145 
	#CK_PR_STORE
(
S
, 
M
, 
T
, 
C
, 
I
) \

146 
CK_CC_INLINE
 \

147 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

149 
__asm__
 
	`__vŞ©e__
(
I
 " %1, %0" \

150 : "=m" (*(
C
 *)
rg‘
) \

151 : 
CK_CC_IMM
 "q" (
v
) \

154 }

	)

156 
CK_PR_STORE
(
±r
, , const *, , "movl")

158 
	#CK_PR_STORE_S
(
S
, 
T
, 
I
è
	`CK_PR_STORE
(S, T, T, T, I)

	)

160 
CK_PR_STORE_S
(, , "movb")

161 
CK_PR_STORE_S
(
ušt
, , "movl")

162 
CK_PR_STORE_S
(, , "movl")

163 
CK_PR_STORE_S
(32, 
ušt32_t
, "movl")

164 
CK_PR_STORE_S
(16, 
ušt16_t
, "movw")

165 
CK_PR_STORE_S
(8, 
ušt8_t
, "movb")

167 #undeà
CK_PR_STORE_S


168 #undeà
CK_PR_STORE


173 
	#CK_PR_FAA
(
S
, 
M
, 
T
, 
C
, 
I
) \

174 
CK_CC_INLINE
 
T
 \

175 
ck_´_ça_
##
	`S
(
M
 *
rg‘
, 
T
 
d
) \

177 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %1, %0" \

178 : "+m" (*(
C
 *)
rg‘
), \

179 "+q" (
d
) \

182  (
d
); \

183 }

	)

185 
CK_PR_FAA
(
±r
, , 
ušŒ_t
, , "xaddl")

187 
	#CK_PR_FAA_S
(
S
, 
T
, 
I
è
	`CK_PR_FAA
(S, T, T, T, I)

	)

189 
CK_PR_FAA_S
(, , "xaddb")

190 
CK_PR_FAA_S
(
ušt
, , "xaddl")

191 
CK_PR_FAA_S
(, , "xaddl")

192 
CK_PR_FAA_S
(32, 
ušt32_t
, "xaddl")

193 
CK_PR_FAA_S
(16, 
ušt16_t
, "xaddw")

194 
CK_PR_FAA_S
(8, 
ušt8_t
, "xaddb")

196 #undeà
CK_PR_FAA_S


197 #undeà
CK_PR_FAA


202 
	#CK_PR_UNARY
(
K
, 
S
, 
T
, 
C
, 
I
) \

203 
	`CK_PR_UNARY_R
(
K
, 
S
, 
T
, 
C
, 
I
) \

204 
	`CK_PR_UNARY_V
(
K
, 
S
, 
T
, 
C
, 
I
)

	)

206 
	#CK_PR_UNARY_R
(
K
, 
S
, 
T
, 
C
, 
I
) \

207 
CK_CC_INLINE
 \

208 
ck_´_
##
K
##
_
##
	`S
(
T
 *
rg‘
) \

210 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %0" \

211 : "+m" (*(
C
 *)
rg‘
) \

215 }

	)

217 
	#CK_PR_UNARY_V
(
K
, 
S
, 
T
, 
C
, 
I
) \

218 
CK_CC_INLINE
 \

219 
ck_´_
##
K
##
_
##
S
##
	`_z”o
(
T
 *
rg‘
, 
boŞ
 *
r
) \

221 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %0; setz %1" \

222 : "+m" (*(
C
 *)
rg‘
), \

223 "=m" (*
r
) \

227 }

	)

230 
	#CK_PR_UNARY_S
(
K
, 
S
, 
T
, 
I
è
	`CK_PR_UNARY
(K, S, T, T, I)

	)

232 
	#CK_PR_GENERATE
(
K
) \

233 
	`CK_PR_UNARY
(
K
, 
±r
, , , #K "l") \

234 
	`CK_PR_UNARY_S
(
K
, , , #K "b") \

235 
	`CK_PR_UNARY_S
(
K
, , , #K "l") \

236 
	`CK_PR_UNARY_S
(
K
, 
ušt
, , #K "l") \

237 
	`CK_PR_UNARY_S
(
K
, 32, 
ušt32_t
, #K "l") \

238 
	`CK_PR_UNARY_S
(
K
, 16, 
ušt16_t
, #K "w") \

239 
	`CK_PR_UNARY_S
(
K
, 8, 
ušt8_t
, #K "b")

	)

241 
	$CK_PR_GENERATE
(
šc
)

242 
	$CK_PR_GENERATE
(
dec
)

243 
	$CK_PR_GENERATE
(
Ãg
)

246 #undeà
CK_PR_UNARY_V


247 
	#CK_PR_UNARY_V
(
a
, 
b
, 
c
, 
d
, 
e
)

	)

248 
	$CK_PR_GENERATE
(
nÙ
)

250 #undeà
CK_PR_GENERATE


251 #undeà
CK_PR_UNARY_S


252 #undeà
CK_PR_UNARY_V


253 #undeà
CK_PR_UNARY_R


254 #undeà
CK_PR_UNARY


259 
	#CK_PR_BINARY
(
K
, 
S
, 
M
, 
T
, 
C
, 
I
) \

260 
CK_CC_INLINE
 \

261 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
, 
T
 
d
) \

263 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %1, %0" \

264 : "+m" (*(
C
 *)
rg‘
) \

265 : 
CK_CC_IMM
 "q" (
d
) \

268 
	}

	)
}

270 
	#CK_PR_BINARY_S
(
K
, 
S
, 
T
, 
I
è
	`CK_PR_BINARY
(K, S, T, T, T, I)

	)

272 
	#CK_PR_GENERATE
(
K
) \

273 
	`CK_PR_BINARY
(
K
, 
±r
, , 
ušŒ_t
, , #K "l") \

274 
	`CK_PR_BINARY_S
(
K
, , , #K "b") \

275 
	`CK_PR_BINARY_S
(
K
, , , #K "l") \

276 
	`CK_PR_BINARY_S
(
K
, 
ušt
, , #K "l") \

277 
	`CK_PR_BINARY_S
(
K
, 32, 
ušt32_t
, #K "l") \

278 
	`CK_PR_BINARY_S
(
K
, 16, 
ušt16_t
, #K "w") \

279 
	`CK_PR_BINARY_S
(
K
, 8, 
ušt8_t
, #K "b")

	)

281 
	$CK_PR_GENERATE
(
add
)

282 
	$CK_PR_GENERATE
(
sub
)

283 
	$CK_PR_GENERATE
(
ªd
)

284 
	$CK_PR_GENERATE
(
Ü
)

285 
	$CK_PR_GENERATE
(
xÜ
)

287 #undeà
CK_PR_GENERATE


288 #undeà
CK_PR_BINARY_S


289 #undeà
CK_PR_BINARY


294 
	#CK_PR_CAS
(
S
, 
M
, 
T
, 
C
, 
I
) \

295 
CK_CC_INLINE
 
boŞ
 \

296 
ck_´_ÿs_
##
	`S
(
M
 *
rg‘
, 
T
 
com·»
, T 
£t
) \

298 
boŞ
 
z
; \

299 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %2, %0; setz %1" \

300 : "+m" (*(
C
 *)
rg‘
), \

301 "÷" (
z
) \

302 : "q" (
£t
), \

303 "a" (
com·»
) \

305  
z
; \

306 
	}

	)
}

308 
CK_PR_CAS
(
±r
, , *, , "cmpxchgl")

310 
	#CK_PR_CAS_S
(
S
, 
T
, 
I
è
	`CK_PR_CAS
(S, T, T, T, I)

	)

312 
CK_PR_CAS_S
(, , "cmpxchgb")

313 
CK_PR_CAS_S
(, , "cmpxchgl")

314 
CK_PR_CAS_S
(
ušt
, , "cmpxchgl")

315 
CK_PR_CAS_S
(32, 
ušt32_t
, "cmpxchgl")

316 
CK_PR_CAS_S
(16, 
ušt16_t
, "cmpxchgw")

317 
CK_PR_CAS_S
(8, 
ušt8_t
, "cmpxchgb")

319 #undeà
CK_PR_CAS_S


320 #undeà
CK_PR_CAS


325 
	#CK_PR_CAS_O
(
S
, 
M
, 
T
, 
C
, 
I
, 
R
) \

326 
CK_CC_INLINE
 
boŞ
 \

327 
ck_´_ÿs_
##
S
##
	`_v®ue
(
M
 *
rg‘
, 
T
 
com·»
, T 
£t
, M *
v
) \

329 
boŞ
 
z
; \

330 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 "cmpxchg" 
I
 " %3, %0;" \

331 "mov %% " 
R
 ", %2;" \

333 : "+m" (*(
C
 *)
rg‘
), \

334 "÷" (
z
), \

335 "=m" (*(
C
 *)
v
) \

336 : "q" (
£t
), \

337 "a" (
com·»
) \

339  (
boŞ
)
z
; \

340 }

	)

342 
CK_PR_CAS_O
(
±r
, , *, , "l", "eax")

344 
	#CK_PR_CAS_O_S
(
S
, 
T
, 
I
, 
R
) \

345 
	`CK_PR_CAS_O
(
S
, 
T
, T, T, 
I
, 
R
)

	)

347 
CK_PR_CAS_O_S
(, , "b", "al")

348 
CK_PR_CAS_O_S
(, , "l", "eax")

349 
CK_PR_CAS_O_S
(
ušt
, , "l", "eax")

350 
CK_PR_CAS_O_S
(32, 
ušt32_t
, "l", "eax")

351 
CK_PR_CAS_O_S
(16, 
ušt16_t
, "w", "ax")

352 
CK_PR_CAS_O_S
(8, 
ušt8_t
, "b", "al")

354 #undeà
CK_PR_CAS_O_S


355 #undeà
CK_PR_CAS_O


360 
	#CK_PR_BT
(
K
, 
S
, 
T
, 
P
, 
C
, 
I
) \

361 
CK_CC_INLINE
 
boŞ
 \

362 
ck_´_
##
K
##
_
##
	`S
(
T
 *
rg‘
, 
b
) \

364 
boŞ
 
c
; \

365 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 "; setc %1" \

366 : "+m" (*(
C
 *)
rg‘
), \

367 "=q" (
c
) \

368 : "q" ((
P
)
b
) \

370  (
boŞ
)
c
; \

371 }

	)

373 
	#CK_PR_BT_S
(
K
, 
S
, 
T
, 
I
è
	`CK_PR_BT
(K, S, T, T, T, I)

	)

375 
	#CK_PR_GENERATE
(
K
) \

376 
	`CK_PR_BT
(
K
, 
±r
, , 
ušt32_t
, , #K "l %2, %0") \

377 
	`CK_PR_BT_S
(
K
, 
ušt
, , #K "l %2, %0") \

378 
	`CK_PR_BT_S
(
K
, , , #K "l %2, %0") \

379 
	`CK_PR_BT_S
(
K
, 32, 
ušt32_t
, #K "l %2, %0") \

380 
	`CK_PR_BT_S
(
K
, 16, 
ušt16_t
, #K "w %w2, %0")

	)

382 
	$CK_PR_GENERATE
(
btc
)

383 
	$CK_PR_GENERATE
(
bts
)

384 
	$CK_PR_GENERATE
(
bŒ
)

386 #undeà
CK_PR_GENERATE


387 #undeà
CK_PR_BT


	@application/kvbench/include/aerospike/ck/gcc/x86_64/ck_f_pr.h

2 
	#CK_F_PR_ADD_16


	)

3 
	#CK_F_PR_ADD_32


	)

4 
	#CK_F_PR_ADD_64


	)

5 
	#CK_F_PR_ADD_8


	)

6 
	#CK_F_PR_ADD_CHAR


	)

7 
	#CK_F_PR_ADD_INT


	)

8 
	#CK_F_PR_ADD_PTR


	)

9 
	#CK_F_PR_ADD_UINT


	)

10 
	#CK_F_PR_AND_16


	)

11 
	#CK_F_PR_AND_32


	)

12 
	#CK_F_PR_AND_64


	)

13 
	#CK_F_PR_AND_8


	)

14 
	#CK_F_PR_AND_CHAR


	)

15 
	#CK_F_PR_AND_INT


	)

16 
	#CK_F_PR_AND_PTR


	)

17 
	#CK_F_PR_AND_UINT


	)

18 
	#CK_F_PR_BTC_16


	)

19 
	#CK_F_PR_BTC_32


	)

20 
	#CK_F_PR_BTC_64


	)

21 
	#CK_F_PR_BTC_INT


	)

22 
	#CK_F_PR_BTC_PTR


	)

23 
	#CK_F_PR_BTC_UINT


	)

24 
	#CK_F_PR_BTR_16


	)

25 
	#CK_F_PR_BTR_32


	)

26 
	#CK_F_PR_BTR_64


	)

27 
	#CK_F_PR_BTR_INT


	)

28 
	#CK_F_PR_BTR_PTR


	)

29 
	#CK_F_PR_BTR_UINT


	)

30 
	#CK_F_PR_BTS_16


	)

31 
	#CK_F_PR_BTS_32


	)

32 
	#CK_F_PR_BTS_64


	)

33 
	#CK_F_PR_BTS_INT


	)

34 
	#CK_F_PR_BTS_PTR


	)

35 
	#CK_F_PR_BTS_UINT


	)

36 
	#CK_F_PR_CAS_16


	)

37 
	#CK_F_PR_CAS_16_8


	)

38 
	#CK_F_PR_CAS_16_8_VALUE


	)

39 
	#CK_F_PR_CAS_16_VALUE


	)

40 
	#CK_F_PR_CAS_32


	)

41 
	#CK_F_PR_CAS_32_4


	)

42 
	#CK_F_PR_CAS_32_4_VALUE


	)

43 
	#CK_F_PR_CAS_32_VALUE


	)

44 
	#CK_F_PR_CAS_64


	)

45 
	#CK_F_PR_CAS_64_2


	)

46 
	#CK_F_PR_CAS_64_2_VALUE


	)

47 
	#CK_F_PR_CAS_64_VALUE


	)

48 
	#CK_F_PR_CAS_8


	)

49 
	#CK_F_PR_CAS_8_16


	)

50 
	#CK_F_PR_CAS_8_16_VALUE


	)

51 
	#CK_F_PR_CAS_8_VALUE


	)

52 
	#CK_F_PR_CAS_CHAR


	)

53 
	#CK_F_PR_CAS_CHAR_16


	)

54 
	#CK_F_PR_CAS_CHAR_16_VALUE


	)

55 
	#CK_F_PR_CAS_CHAR_VALUE


	)

56 
	#CK_F_PR_CAS_INT


	)

57 
	#CK_F_PR_CAS_INT_4


	)

58 
	#CK_F_PR_CAS_INT_4_VALUE


	)

59 
	#CK_F_PR_CAS_INT_VALUE


	)

60 
	#CK_F_PR_CAS_PTR


	)

61 
	#CK_F_PR_CAS_PTR_2


	)

62 
	#CK_F_PR_CAS_PTR_2_VALUE


	)

63 
	#CK_F_PR_CAS_PTR_VALUE


	)

64 
	#CK_F_PR_CAS_DOUBLE


	)

65 
	#CK_F_PR_CAS_DOUBLE_2


	)

66 
	#CK_F_PR_CAS_DOUBLE_VALUE


	)

67 
	#CK_F_PR_CAS_UINT


	)

68 
	#CK_F_PR_CAS_UINT_4


	)

69 
	#CK_F_PR_CAS_UINT_4_VALUE


	)

70 
	#CK_F_PR_CAS_UINT_VALUE


	)

71 
	#CK_F_PR_DEC_16


	)

72 
	#CK_F_PR_DEC_16_ZERO


	)

73 
	#CK_F_PR_DEC_32


	)

74 
	#CK_F_PR_DEC_32_ZERO


	)

75 
	#CK_F_PR_DEC_64


	)

76 
	#CK_F_PR_DEC_64_ZERO


	)

77 
	#CK_F_PR_DEC_8


	)

78 
	#CK_F_PR_DEC_8_ZERO


	)

79 
	#CK_F_PR_DEC_CHAR


	)

80 
	#CK_F_PR_DEC_CHAR_ZERO


	)

81 
	#CK_F_PR_DEC_INT


	)

82 
	#CK_F_PR_DEC_INT_ZERO


	)

83 
	#CK_F_PR_DEC_PTR


	)

84 
	#CK_F_PR_DEC_PTR_ZERO


	)

85 
	#CK_F_PR_DEC_UINT


	)

86 
	#CK_F_PR_DEC_UINT_ZERO


	)

87 
	#CK_F_PR_FAA_16


	)

88 
	#CK_F_PR_FAA_32


	)

89 
	#CK_F_PR_FAA_64


	)

90 
	#CK_F_PR_FAA_8


	)

91 
	#CK_F_PR_FAA_CHAR


	)

92 
	#CK_F_PR_FAA_INT


	)

93 
	#CK_F_PR_FAA_PTR


	)

94 
	#CK_F_PR_FAA_UINT


	)

95 
	#CK_F_PR_FAS_16


	)

96 
	#CK_F_PR_FAS_32


	)

97 
	#CK_F_PR_FAS_64


	)

98 
	#CK_F_PR_FAS_8


	)

99 
	#CK_F_PR_FAS_CHAR


	)

100 
	#CK_F_PR_FAS_INT


	)

101 
	#CK_F_PR_FAS_PTR


	)

102 
	#CK_F_PR_FAS_UINT


	)

103 
	#CK_F_PR_FAS_DOUBLE


	)

104 
	#CK_F_PR_FENCE_LOAD


	)

105 
	#CK_F_PR_FENCE_LOAD_DEPENDS


	)

106 
	#CK_F_PR_FENCE_MEMORY


	)

107 
	#CK_F_PR_FENCE_STORE


	)

108 
	#CK_F_PR_FENCE_STRICT_LOAD


	)

109 
	#CK_F_PR_FENCE_STRICT_LOAD_DEPENDS


	)

110 
	#CK_F_PR_FENCE_STRICT_MEMORY


	)

111 
	#CK_F_PR_FENCE_STRICT_STORE


	)

112 
	#CK_F_PR_INC_16


	)

113 
	#CK_F_PR_INC_16_ZERO


	)

114 
	#CK_F_PR_INC_32


	)

115 
	#CK_F_PR_INC_32_ZERO


	)

116 
	#CK_F_PR_INC_64


	)

117 
	#CK_F_PR_INC_64_ZERO


	)

118 
	#CK_F_PR_INC_8


	)

119 
	#CK_F_PR_INC_8_ZERO


	)

120 
	#CK_F_PR_INC_CHAR


	)

121 
	#CK_F_PR_INC_CHAR_ZERO


	)

122 
	#CK_F_PR_INC_INT


	)

123 
	#CK_F_PR_INC_INT_ZERO


	)

124 
	#CK_F_PR_INC_PTR


	)

125 
	#CK_F_PR_INC_PTR_ZERO


	)

126 
	#CK_F_PR_INC_UINT


	)

127 
	#CK_F_PR_INC_UINT_ZERO


	)

128 
	#CK_F_PR_LOAD_16


	)

129 
	#CK_F_PR_LOAD_16_8


	)

130 
	#CK_F_PR_LOAD_32


	)

131 
	#CK_F_PR_LOAD_32_4


	)

132 
	#CK_F_PR_LOAD_64


	)

133 
	#CK_F_PR_LOAD_64_2


	)

134 
	#CK_F_PR_LOAD_8


	)

135 
	#CK_F_PR_LOAD_8_16


	)

136 
	#CK_F_PR_LOAD_CHAR


	)

137 
	#CK_F_PR_LOAD_CHAR_16


	)

138 
	#CK_F_PR_LOAD_INT


	)

139 
	#CK_F_PR_LOAD_INT_4


	)

140 
	#CK_F_PR_LOAD_PTR


	)

141 
	#CK_F_PR_LOAD_PTR_2


	)

142 
	#CK_F_PR_LOAD_DOUBLE


	)

143 
	#CK_F_PR_LOAD_UINT


	)

144 
	#CK_F_PR_LOAD_UINT_4


	)

145 
	#CK_F_PR_NEG_16


	)

146 
	#CK_F_PR_NEG_16_ZERO


	)

147 
	#CK_F_PR_NEG_32


	)

148 
	#CK_F_PR_NEG_32_ZERO


	)

149 
	#CK_F_PR_NEG_64


	)

150 
	#CK_F_PR_NEG_64_ZERO


	)

151 
	#CK_F_PR_NEG_8


	)

152 
	#CK_F_PR_NEG_8_ZERO


	)

153 
	#CK_F_PR_NEG_CHAR


	)

154 
	#CK_F_PR_NEG_CHAR_ZERO


	)

155 
	#CK_F_PR_NEG_INT


	)

156 
	#CK_F_PR_NEG_INT_ZERO


	)

157 
	#CK_F_PR_NEG_PTR


	)

158 
	#CK_F_PR_NEG_PTR_ZERO


	)

159 
	#CK_F_PR_NEG_UINT


	)

160 
	#CK_F_PR_NEG_UINT_ZERO


	)

161 
	#CK_F_PR_NOT_16


	)

162 
	#CK_F_PR_NOT_32


	)

163 
	#CK_F_PR_NOT_64


	)

164 
	#CK_F_PR_NOT_8


	)

165 
	#CK_F_PR_NOT_CHAR


	)

166 
	#CK_F_PR_NOT_INT


	)

167 
	#CK_F_PR_NOT_PTR


	)

168 
	#CK_F_PR_NOT_UINT


	)

169 
	#CK_F_PR_OR_16


	)

170 
	#CK_F_PR_OR_32


	)

171 
	#CK_F_PR_OR_64


	)

172 
	#CK_F_PR_OR_8


	)

173 
	#CK_F_PR_OR_CHAR


	)

174 
	#CK_F_PR_OR_INT


	)

175 
	#CK_F_PR_OR_PTR


	)

176 
	#CK_F_PR_OR_UINT


	)

177 
	#CK_F_PR_STORE_16


	)

178 
	#CK_F_PR_STORE_32


	)

179 
	#CK_F_PR_STORE_64


	)

180 
	#CK_F_PR_STORE_8


	)

181 
	#CK_F_PR_STORE_CHAR


	)

182 
	#CK_F_PR_STORE_INT


	)

183 
	#CK_F_PR_STORE_DOUBLE


	)

184 
	#CK_F_PR_STORE_PTR


	)

185 
	#CK_F_PR_STORE_UINT


	)

186 
	#CK_F_PR_SUB_16


	)

187 
	#CK_F_PR_SUB_32


	)

188 
	#CK_F_PR_SUB_64


	)

189 
	#CK_F_PR_SUB_8


	)

190 
	#CK_F_PR_SUB_CHAR


	)

191 
	#CK_F_PR_SUB_INT


	)

192 
	#CK_F_PR_SUB_PTR


	)

193 
	#CK_F_PR_SUB_UINT


	)

194 
	#CK_F_PR_XOR_16


	)

195 
	#CK_F_PR_XOR_32


	)

196 
	#CK_F_PR_XOR_64


	)

197 
	#CK_F_PR_XOR_8


	)

198 
	#CK_F_PR_XOR_CHAR


	)

199 
	#CK_F_PR_XOR_INT


	)

200 
	#CK_F_PR_XOR_PTR


	)

201 
	#CK_F_PR_XOR_UINT


	)

	@application/kvbench/include/aerospike/ck/gcc/x86_64/ck_pr.h

27 #iâdeà
CK_PR_X86_64_H


28 
	#CK_PR_X86_64_H


	)

30 #iâdeà
CK_PR_H


31 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


34 
	~<«ro¥ike/ck/ck_cc.h
>

35 
	~<«ro¥ike/ck/ck_md.h
>

36 
	~<«ro¥ike/ck/ck_¡dšt.h
>

42 
	~"ck_f_´.h
"

47 #ifdeà
CK_MD_RTM_ENABLE


48 
	~"ck_´_¹m.h
"

52 
	#CK_F_PR


	)

54 #ifdeà
CK_MD_UMP


55 
	#CK_PR_LOCK_PREFIX


	)

57 
	#CK_PR_LOCK_PREFIX
 "lock "

	)

64 
CK_CC_INLINE
 

65 
	$ck_´_¡®l
()

67 
__asm__
 
	`__vŞ©e__
("pause" ::: "memory");

69 
	}
}

71 
	#CK_PR_FENCE
(
T
, 
I
) \

72 
CK_CC_INLINE
 \

73 
ck_´_ãnû_¡riù_
##
	`T
() \

75 
__asm__
 
	`__vŞ©e__
(
I
 ::: "memory"); \

76 }

	)

78 
CK_PR_FENCE
(
©omic
, "sfence")

79 
CK_PR_FENCE
(
©omic_¡Üe
, "sfence")

80 
CK_PR_FENCE
(
©omic_lßd
, "mfence")

81 
CK_PR_FENCE
(
¡Üe_©omic
, "sfence")

82 
CK_PR_FENCE
(
lßd_©omic
, "mfence")

83 
CK_PR_FENCE
(
lßd
, "lfence")

84 
CK_PR_FENCE
(
lßd_¡Üe
, "mfence")

85 
CK_PR_FENCE
(
¡Üe
, "sfence")

86 
CK_PR_FENCE
(
¡Üe_lßd
, "mfence")

87 
CK_PR_FENCE
(
memÜy
, "mfence")

88 
CK_PR_FENCE
(
»Ëa£
, "mfence")

89 
CK_PR_FENCE
(
acquœe
, "mfence")

90 
CK_PR_FENCE
(
acq»l
, "mfence")

91 
CK_PR_FENCE
(
lock
, "mfence")

92 
CK_PR_FENCE
(
uÆock
, "mfence")

94 #undeà
CK_PR_FENCE


101 #iâdeà
CK_F_PR_RFO


102 
	#CK_F_PR_RFO


	)

103 
CK_CC_INLINE
 

104 
	$ck_´_rfo
(cÚ¡ *
m
)

107 
__asm__
 
	`__vŞ©e__
("prefetchw (%0)"

109 : "r" (
m
)

113 
	}
}

119 
	#CK_PR_FAS
(
S
, 
M
, 
T
, 
C
, 
I
) \

120 
CK_CC_INLINE
 
T
 \

121 
ck_´_çs_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

123 
__asm__
 
	`__vŞ©e__
(
I
 " %0, %1" \

124 : "+m" (*(
C
 *)
rg‘
), \

125 "+q" (
v
) \

128  
v
; \

129 }

	)

131 
CK_PR_FAS
(
±r
, , *, , "xchgq")

133 
	#CK_PR_FAS_S
(
S
, 
T
, 
I
è
	`CK_PR_FAS
(S, T, T, T, I)

	)

135 
CK_PR_FAS_S
(, , "xchgq")

136 
CK_PR_FAS_S
(, , "xchgb")

137 
CK_PR_FAS_S
(
ušt
, , "xchgl")

138 
CK_PR_FAS_S
(, , "xchgl")

139 
CK_PR_FAS_S
(64, 
ušt64_t
, "xchgq")

140 
CK_PR_FAS_S
(32, 
ušt32_t
, "xchgl")

141 
CK_PR_FAS_S
(16, 
ušt16_t
, "xchgw")

142 
CK_PR_FAS_S
(8, 
ušt8_t
, "xchgb")

144 #undeà
CK_PR_FAS_S


145 #undeà
CK_PR_FAS


150 
	#CK_PR_LOAD
(
S
, 
M
, 
T
, 
C
, 
I
) \

151 
CK_CC_INLINE
 
T
 \

152 
ck_´_md_lßd_
##
	`S
(cÚ¡ 
M
 *
rg‘
) \

154 
T
 
r
; \

155 
__asm__
 
	`__vŞ©e__
(
I
 " %1, %0" \

156 : "=q" (
r
) \

157 : "m" (*(cÚ¡ 
C
 *)
rg‘
) \

159  (
r
); \

160 }

	)

162 
CK_PR_LOAD
(
±r
, , *, , "movq")

164 
	#CK_PR_LOAD_S
(
S
, 
T
, 
I
è
	`CK_PR_LOAD
(S, T, T, T, I)

	)

166 
CK_PR_LOAD_S
(, , "movb")

167 
CK_PR_LOAD_S
(
ušt
, , "movl")

168 
CK_PR_LOAD_S
(, , "movl")

169 
CK_PR_LOAD_S
(, , "movq")

170 
CK_PR_LOAD_S
(64, 
ušt64_t
, "movq")

171 
CK_PR_LOAD_S
(32, 
ušt32_t
, "movl")

172 
CK_PR_LOAD_S
(16, 
ušt16_t
, "movw")

173 
CK_PR_LOAD_S
(8, 
ušt8_t
, "movb")

175 #undeà
CK_PR_LOAD_S


176 #undeà
CK_PR_LOAD


178 
CK_CC_INLINE
 

179 
	$ck_´_lßd_64_2
(cÚ¡ 
ušt64_t
 
rg‘
[2], ušt64_ˆ
v
[2])

181 
__asm__
 
	`__vŞ©e__
("movq %%rdx, %%rcx;"

183 
CK_PR_LOCK_PREFIX
 "cmpxchg16b %2;"

184 : "÷" (
v
[0]),

185 "=d" (
v
[1])

186 : "m" (*(cÚ¡ 
ušt64_t
 *)
rg‘
)

189 
	}
}

191 
CK_CC_INLINE
 

192 
	$ck_´_lßd_±r_2
(cÚ¡ *
t
, *
v
)

194 
	`ck_´_lßd_64_2
(
	`CK_CPP_CAST
(cÚ¡ 
ušt64_t
 *, 
t
),

195 
	`CK_CPP_CAST
(
ušt64_t
 *, 
v
));

197 
	}
}

199 
	#CK_PR_LOAD_2
(
S
, 
W
, 
T
) \

200 
CK_CC_INLINE
 \

201 
ck_´_md_lßd_
##
S
##
_
##
	`W
(cÚ¡ 
T
 
t
[2], T 
v
[2]) \

203 
	`ck_´_lßd_64_2
((cÚ¡ 
ušt64_t
 *)(cÚ¡ *)
t
, \

204 (
ušt64_t
 *)(*)
v
); \

206 }

	)

208 
	$CK_PR_LOAD_2
(, 16, )

209 
	$CK_PR_LOAD_2
(, 4, )

210 
	$CK_PR_LOAD_2
(
ušt
, 4, )

211 
	$CK_PR_LOAD_2
(32, 4, 
ušt32_t
)

212 
	$CK_PR_LOAD_2
(16, 8, 
ušt16_t
)

213 
	$CK_PR_LOAD_2
(8, 16, 
ušt8_t
)

215 #undeà
CK_PR_LOAD_2


220 
	#CK_PR_STORE_IMM
(
S
, 
M
, 
T
, 
C
, 
I
, 
K
) \

221 
CK_CC_INLINE
 \

222 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

224 
__asm__
 
	`__vŞ©e__
(
I
 " %1, %0" \

225 : "=m" (*(
C
 *)
rg‘
) \

226 : 
K
 "q" (
v
) \

229 
	}

	)
}

231 
	#CK_PR_STORE
(
S
, 
M
, 
T
, 
C
, 
I
) \

232 
CK_CC_INLINE
 \

233 
ck_´_md_¡Üe_
##
	`S
(
M
 *
rg‘
, 
T
 
v
) \

235 
__asm__
 
	`__vŞ©e__
(
I
 " %1, %0" \

236 : "=m" (*(
C
 *)
rg‘
) \

237 : "q" (
v
) \

240 }

	)

242 
CK_PR_STORE_IMM
(
±r
, , cÚ¡ *, , "movq", 
CK_CC_IMM_U32
)

243 
CK_PR_STORE
(, , , , "movq")

245 
	#CK_PR_STORE_S
(
S
, 
T
, 
I
, 
K
è
	`CK_PR_STORE_IMM
(S, T, T, T, I, K)

	)

247 
CK_PR_STORE_S
(, , "movb", 
CK_CC_IMM_S32
)

248 
CK_PR_STORE_S
(, , "movl", 
CK_CC_IMM_S32
)

249 
CK_PR_STORE_S
(
ušt
, , "movl", 
CK_CC_IMM_U32
)

250 
CK_PR_STORE_S
(64, 
ušt64_t
, "movq", 
CK_CC_IMM_U32
)

251 
CK_PR_STORE_S
(32, 
ušt32_t
, "movl", 
CK_CC_IMM_U32
)

252 
CK_PR_STORE_S
(16, 
ušt16_t
, "movw", 
CK_CC_IMM_U32
)

253 
CK_PR_STORE_S
(8, 
ušt8_t
, "movb", 
CK_CC_IMM_U32
)

255 #undeà
CK_PR_STORE_S


256 #undeà
CK_PR_STORE_IMM


257 #undeà
CK_PR_STORE


262 
	#CK_PR_FAA
(
S
, 
M
, 
T
, 
C
, 
I
) \

263 
CK_CC_INLINE
 
T
 \

264 
ck_´_ça_
##
	`S
(
M
 *
rg‘
, 
T
 
d
) \

266 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %1, %0" \

267 : "+m" (*(
C
 *)
rg‘
), \

268 "+q" (
d
) \

271  (
d
); \

272 }

	)

274 
CK_PR_FAA
(
±r
, , 
ušŒ_t
, , "xaddq")

276 
	#CK_PR_FAA_S
(
S
, 
T
, 
I
è
	`CK_PR_FAA
(S, T, T, T, I)

	)

278 
CK_PR_FAA_S
(, , "xaddb")

279 
CK_PR_FAA_S
(
ušt
, , "xaddl")

280 
CK_PR_FAA_S
(, , "xaddl")

281 
CK_PR_FAA_S
(64, 
ušt64_t
, "xaddq")

282 
CK_PR_FAA_S
(32, 
ušt32_t
, "xaddl")

283 
CK_PR_FAA_S
(16, 
ušt16_t
, "xaddw")

284 
CK_PR_FAA_S
(8, 
ušt8_t
, "xaddb")

286 #undeà
CK_PR_FAA_S


287 #undeà
CK_PR_FAA


292 
	#CK_PR_UNARY
(
K
, 
S
, 
T
, 
C
, 
I
) \

293 
	`CK_PR_UNARY_R
(
K
, 
S
, 
T
, 
C
, 
I
) \

294 
	`CK_PR_UNARY_V
(
K
, 
S
, 
T
, 
C
, 
I
)

	)

296 
	#CK_PR_UNARY_R
(
K
, 
S
, 
T
, 
C
, 
I
) \

297 
CK_CC_INLINE
 \

298 
ck_´_
##
K
##
_
##
	`S
(
T
 *
rg‘
) \

300 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %0" \

301 : "+m" (*(
C
 *)
rg‘
) \

305 }

	)

307 
	#CK_PR_UNARY_V
(
K
, 
S
, 
T
, 
C
, 
I
) \

308 
CK_CC_INLINE
 \

309 
ck_´_
##
K
##
_
##
S
##
	`_z”o
(
T
 *
rg‘
, 
boŞ
 *
r
) \

311 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %0; setz %1" \

312 : "+m" (*(
C
 *)
rg‘
), \

313 "=m" (*
r
) \

317 }

	)

320 
	#CK_PR_UNARY_S
(
K
, 
S
, 
T
, 
I
è
	`CK_PR_UNARY
(K, S, T, T, I)

	)

322 
	#CK_PR_GENERATE
(
K
) \

323 
	`CK_PR_UNARY
(
K
, 
±r
, , , #K "q") \

324 
	`CK_PR_UNARY_S
(
K
, , , #K "b") \

325 
	`CK_PR_UNARY_S
(
K
, , , #K "l") \

326 
	`CK_PR_UNARY_S
(
K
, 
ušt
, , #K "l") \

327 
	`CK_PR_UNARY_S
(
K
, 64, 
ušt64_t
, #K "q") \

328 
	`CK_PR_UNARY_S
(
K
, 32, 
ušt32_t
, #K "l") \

329 
	`CK_PR_UNARY_S
(
K
, 16, 
ušt16_t
, #K "w") \

330 
	`CK_PR_UNARY_S
(
K
, 8, 
ušt8_t
, #K "b")

	)

332 
	$CK_PR_GENERATE
(
šc
)

333 
	$CK_PR_GENERATE
(
dec
)

334 
	$CK_PR_GENERATE
(
Ãg
)

337 #undeà
CK_PR_UNARY_V


338 
	#CK_PR_UNARY_V
(
a
, 
b
, 
c
, 
d
, 
e
)

	)

339 
	$CK_PR_GENERATE
(
nÙ
)

341 #undeà
CK_PR_GENERATE


342 #undeà
CK_PR_UNARY_S


343 #undeà
CK_PR_UNARY_V


344 #undeà
CK_PR_UNARY_R


345 #undeà
CK_PR_UNARY


350 
	#CK_PR_BINARY
(
K
, 
S
, 
M
, 
T
, 
C
, 
I
, 
O
) \

351 
CK_CC_INLINE
 \

352 
ck_´_
##
K
##
_
##
	`S
(
M
 *
rg‘
, 
T
 
d
) \

354 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %1, %0" \

355 : "+m" (*(
C
 *)
rg‘
) \

356 : 
O
 "q" (
d
) \

359 
	}

	)
}

361 
	#CK_PR_BINARY_S
(
K
, 
S
, 
T
, 
I
, 
O
è
	`CK_PR_BINARY
(K, S, T, T, T, I, O)

	)

363 
	#CK_PR_GENERATE
(
K
) \

364 
	`CK_PR_BINARY
(
K
, 
±r
, , 
ušŒ_t
, , #K "q", 
CK_CC_IMM_U32
) \

365 
	`CK_PR_BINARY_S
(
K
, , , #K "b", 
CK_CC_IMM_S32
) \

366 
	`CK_PR_BINARY_S
(
K
, , , #K "l", 
CK_CC_IMM_S32
) \

367 
	`CK_PR_BINARY_S
(
K
, 
ušt
, , #K "l", 
CK_CC_IMM_U32
) \

368 
	`CK_PR_BINARY_S
(
K
, 64, 
ušt64_t
, #K "q", 
CK_CC_IMM_U32
) \

369 
	`CK_PR_BINARY_S
(
K
, 32, 
ušt32_t
, #K "l", 
CK_CC_IMM_U32
) \

370 
	`CK_PR_BINARY_S
(
K
, 16, 
ušt16_t
, #K "w", 
CK_CC_IMM_U32
) \

371 
	`CK_PR_BINARY_S
(
K
, 8, 
ušt8_t
, #K "b", 
CK_CC_IMM_U32
)

	)

373 
	$CK_PR_GENERATE
(
add
)

374 
	$CK_PR_GENERATE
(
sub
)

375 
	$CK_PR_GENERATE
(
ªd
)

376 
	$CK_PR_GENERATE
(
Ü
)

377 
	$CK_PR_GENERATE
(
xÜ
)

379 #undeà
CK_PR_GENERATE


380 #undeà
CK_PR_BINARY_S


381 #undeà
CK_PR_BINARY


386 
	#CK_PR_CAS
(
S
, 
M
, 
T
, 
C
, 
I
) \

387 
CK_CC_INLINE
 
boŞ
 \

388 
ck_´_ÿs_
##
	`S
(
M
 *
rg‘
, 
T
 
com·»
, T 
£t
) \

390 
boŞ
 
z
; \

391 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 " %2, %0; setz %1" \

392 : "+m" (*(
C
 *)
rg‘
), \

393 "÷" (
z
) \

394 : "q" (
£t
), \

395 "a" (
com·»
) \

397  
z
; \

398 
	}

	)
}

400 
CK_PR_CAS
(
±r
, , *, , "cmpxchgq")

402 
	#CK_PR_CAS_S
(
S
, 
T
, 
I
è
	`CK_PR_CAS
(S, T, T, T, I)

	)

404 
CK_PR_CAS_S
(, , "cmpxchgb")

405 
CK_PR_CAS_S
(, , "cmpxchgl")

406 
CK_PR_CAS_S
(
ušt
, , "cmpxchgl")

407 
CK_PR_CAS_S
(, , "cmpxchgq")

408 
CK_PR_CAS_S
(64, 
ušt64_t
, "cmpxchgq")

409 
CK_PR_CAS_S
(32, 
ušt32_t
, "cmpxchgl")

410 
CK_PR_CAS_S
(16, 
ušt16_t
, "cmpxchgw")

411 
CK_PR_CAS_S
(8, 
ušt8_t
, "cmpxchgb")

413 #undeà
CK_PR_CAS_S


414 #undeà
CK_PR_CAS


419 
	#CK_PR_CAS_O
(
S
, 
M
, 
T
, 
C
, 
I
, 
R
) \

420 
CK_CC_INLINE
 
boŞ
 \

421 
ck_´_ÿs_
##
S
##
	`_v®ue
(
M
 *
rg‘
, 
T
 
com·»
, T 
£t
, M *
v
) \

423 
boŞ
 
z
; \

424 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 "cmpxchg" 
I
 " %3, %0;" \

425 "mov %% " 
R
 ", %2;" \

427 : "+m" (*(
C
 *)
rg‘
), \

428 "÷" (
z
), \

429 "=m" (*(
C
 *)
v
) \

430 : "q" (
£t
), \

431 "a" (
com·»
) \

433  
z
; \

434 }

	)

436 
CK_PR_CAS_O
(
±r
, , *, , "q", "rax")

438 
	#CK_PR_CAS_O_S
(
S
, 
T
, 
I
, 
R
) \

439 
	`CK_PR_CAS_O
(
S
, 
T
, T, T, 
I
, 
R
)

	)

441 
CK_PR_CAS_O_S
(, , "b", "al")

442 
CK_PR_CAS_O_S
(, , "l", "eax")

443 
CK_PR_CAS_O_S
(
ušt
, , "l", "eax")

444 
CK_PR_CAS_O_S
(, , "q", "rax")

445 
CK_PR_CAS_O_S
(64, 
ušt64_t
, "q", "rax")

446 
CK_PR_CAS_O_S
(32, 
ušt32_t
, "l", "eax")

447 
CK_PR_CAS_O_S
(16, 
ušt16_t
, "w", "ax")

448 
CK_PR_CAS_O_S
(8, 
ušt8_t
, "b", "al")

450 #undeà
CK_PR_CAS_O_S


451 #undeà
CK_PR_CAS_O


456 
CK_CC_INLINE
 
boŞ


457 
	$ck_´_ÿs_64_2
(
ušt64_t
 
rg‘
[2], ušt64_ˆ
com·»
[2], ušt64_ˆ
£t
[2])

459 
boŞ
 
z
;

461 
__asm__
 
	`__vŞ©e__
("movq 0(%4), %%rax;"

463 
CK_PR_LOCK_PREFIX
 "cmpxchg16b %0; setz %1"

464 : "+m" (*
rg‘
),

465 "=q" (
z
)

466 : "b" (
£t
[0]),

467 "c" (
£t
[1]),

468 "q" (
com·»
)

470  
z
;

471 
	}
}

473 
CK_CC_INLINE
 
boŞ


474 
	$ck_´_ÿs_±r_2
(*
t
, *
c
, *
s
)

476  
	`ck_´_ÿs_64_2
(
	`CK_CPP_CAST
(
ušt64_t
 *, 
t
),

477 
	`CK_CPP_CAST
(
ušt64_t
 *, 
c
),

478 
	`CK_CPP_CAST
(
ušt64_t
 *, 
s
));

479 
	}
}

481 
CK_CC_INLINE
 
boŞ


482 
	$ck_´_ÿs_64_2_v®ue
(
ušt64_t
 
rg‘
[2],

483 
ušt64_t
 
com·»
[2],

484 
ušt64_t
 
£t
[2],

485 
ušt64_t
 
v
[2])

487 
boŞ
 
z
;

489 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 "cmpxchg16b %0;"

491 : "+m" (*
rg‘
),

492 "÷" (
v
[0]),

493 "=d" (
v
[1]),

494 "=q" (
z
)

495 : "a" (
com·»
[0]),

496 "d" (
com·»
[1]),

497 "b" (
£t
[0]),

498 "c" (
£t
[1])

500  
z
;

501 
	}
}

503 
CK_CC_INLINE
 
boŞ


504 
	$ck_´_ÿs_±r_2_v®ue
(*
t
, *
c
, *
s
, *
v
)

506  
	`ck_´_ÿs_64_2_v®ue
(
	`CK_CPP_CAST
(
ušt64_t
 *,
t
),

507 
	`CK_CPP_CAST
(
ušt64_t
 *,
c
),

508 
	`CK_CPP_CAST
(
ušt64_t
 *,
s
),

509 
	`CK_CPP_CAST
(
ušt64_t
 *,
v
));

510 
	}
}

512 
	#CK_PR_CAS_V
(
S
, 
W
, 
T
) \

513 
CK_CC_INLINE
 
boŞ
 \

514 
ck_´_ÿs_
##
S
##
_
##
	`W
(
T
 
t
[
W
], T 
c
[W], T 
s
[W]) \

516  
	`ck_´_ÿs_64_2
((
ušt64_t
 *)(*)
t
, \

517 (
ušt64_t
 *)(*)
c
, \

518 (
ušt64_t
 *)(*)
s
); \

520 
CK_CC_INLINE
 
boŞ
 \

521 
ck_´_ÿs_
##
S
##
_
##
W
##
	`_v®ue
(
T
 *
t
, T 
c
[W], T 
s
[W], T *
v
) \

523  
	`ck_´_ÿs_64_2_v®ue
((
ušt64_t
 *)(*)
t
, \

524 (
ušt64_t
 *)(*)
c
, \

525 (
ušt64_t
 *)(*)
s
, \

526 (
ušt64_t
 *)(*)
v
); \

527 }

	)

529 
	$CK_PR_CAS_V
(, 2, )

530 
	$CK_PR_CAS_V
(, 16, )

531 
	$CK_PR_CAS_V
(, 4, )

532 
	$CK_PR_CAS_V
(
ušt
, 4, )

533 
	$CK_PR_CAS_V
(32, 4, 
ušt32_t
)

534 
	$CK_PR_CAS_V
(16, 8, 
ušt16_t
)

535 
	$CK_PR_CAS_V
(8, 16, 
ušt8_t
)

537 #undeà
CK_PR_CAS_V


542 
	#CK_PR_BT
(
K
, 
S
, 
T
, 
P
, 
C
, 
I
) \

543 
CK_CC_INLINE
 
boŞ
 \

544 
ck_´_
##
K
##
_
##
	`S
(
T
 *
rg‘
, 
b
) \

546 
boŞ
 
c
; \

547 
__asm__
 
	`__vŞ©e__
(
CK_PR_LOCK_PREFIX
 
I
 "; setc %1" \

548 : "+m" (*(
C
 *)
rg‘
), \

549 "=q" (
c
) \

550 : "q" ((
P
)
b
) \

552  
c
; \

553 
	}

	)
}

555 
	#CK_PR_BT_S
(
K
, 
S
, 
T
, 
I
è
	`CK_PR_BT
(K, S, T, T, T, I)

	)

557 
	#CK_PR_GENERATE
(
K
) \

558 
	`CK_PR_BT
(
K
, 
±r
, , 
ušt64_t
, , #K "q %2, %0") \

559 
	`CK_PR_BT_S
(
K
, 
ušt
, , #K "l %2, %0") \

560 
	`CK_PR_BT_S
(
K
, , , #K "l %2, %0") \

561 
	`CK_PR_BT_S
(
K
, 64, 
ušt64_t
, #K "q %2, %0") \

562 
	`CK_PR_BT_S
(
K
, 32, 
ušt32_t
, #K "l %2, %0") \

563 
	`CK_PR_BT_S
(
K
, 16, 
ušt16_t
, #K "w %w2, %0")

	)

565 
	$CK_PR_GENERATE
(
btc
)

566 
	$CK_PR_GENERATE
(
bts
)

567 
	$CK_PR_GENERATE
(
bŒ
)

569 #undeà
CK_PR_GENERATE


570 #undeà
CK_PR_BT


	@application/kvbench/include/aerospike/ck/gcc/x86_64/ck_pr_rtm.h

43 #iâdeà
CK_PR_X86_64_RTM_H


44 
	#CK_PR_X86_64_RTM_H


	)

46 #iâdeà
CK_PR_X86_64_H


47 #”rÜ 
Do
 
nÙ
 
šşude
 
this
 
fe
 
dœeùly
, 
u£
 
ck_´
.
h


50 
	#CK_F_PR_RTM


	)

52 
	~<«ro¥ike/ck/ck_cc.h
>

53 
	~<¡dboŞ.h
>

55 
	#CK_PR_RTM_STARTED
 (~0U)

	)

56 
	#CK_PR_RTM_EXPLICIT
 (1 << 0)

	)

57 
	#CK_PR_RTM_RETRY
 (1 << 1)

	)

58 
	#CK_PR_RTM_CONFLICT
 (1 << 2)

	)

59 
	#CK_PR_RTM_CAPACITY
 (1 << 3)

	)

60 
	#CK_PR_RTM_DEBUG
 (1 << 4)

	)

61 
	#CK_PR_RTM_NESTED
 (1 << 5)

	)

62 
	#CK_PR_RTM_CODE
(
x
è(((xè>> 24è& 0xFF)

	)

64 
CK_CC_INLINE
 

65 
	$ck_´_¹m_begš
()

67 
r
 = 
CK_PR_RTM_STARTED
;

69 
__asm__
 
	`__vŞ©e__
(".byte 0xc7,0xf8;"

71 : "+a" (
r
)

75  
r
;

76 
	}
}

78 
CK_CC_INLINE
 

79 
	$ck_´_¹m_’d
()

82 
__asm__
 
	`__vŞ©e__
(".byte 0x0f,0x01,0xd5" ::: "memory");

84 
	}
}

86 
CK_CC_INLINE
 

87 
	$ck_´_¹m_abÜt
(cÚ¡ 
¡©us
)

90 
__asm__
 
	`__vŞ©e__
(".by‹ 0xc6,0xf8,%P0" :: "i" (
¡©us
) : "memory");

92 
	}
}

94 
CK_CC_INLINE
 
boŞ


95 
	$ck_´_¹m_‹¡
()

97 
boŞ
 
r
;

99 
__asm__
 
	`__vŞ©e__
(".byte 0x0f,0x01,0xd6;"

101 : "ô" (
r
)

105  
r
;

106 
	}
}

	@application/kvbench/include/aerospike/ck/spinlock/anderson.h

27 #iâdeà
CK_SPINLOCK_ANDERSON_H


28 
	#CK_SPINLOCK_ANDERSON_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_lim™s.h
>

32 
	~<«ro¥ike/ck/ck_md.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

36 #iâdeà
CK_F_SPINLOCK_ANDERSON


37 
	#CK_F_SPINLOCK_ANDERSON


	)

41 
	sck_¥šlock_ªd”sÚ_th»ad
 {

42 
	mlocked
;

43 
	mpos™iÚ
;

45 
ck_¥šlock_ªd”sÚ_th»ad
 
	tck_¥šlock_ªd”sÚ_th»ad_t
;

47 
	sck_¥šlock_ªd”sÚ
 {

48 
ck_¥šlock_ªd”sÚ_th»ad
 *
	m¦Ùs
;

49 
	mcouÁ
;

50 
	mw¿p
;

51 
	mmask
;

52 
	m·d
[
CK_MD_CACHELINE
 - () * 3 - (*)];

53 
	mÃxt
;

55 
ck_¥šlock_ªd”sÚ
 
	tck_¥šlock_ªd”sÚ_t
;

57 
CK_CC_INLINE
 

58 
	$ck_¥šlock_ªd”sÚ_š™
(
ck_¥šlock_ªd”sÚ
 *
lock
,

59 
ck_¥šlock_ªd”sÚ_th»ad
 *
¦Ùs
,

60 
couÁ
)

62 
i
;

64 
¦Ùs
[0].
locked
 = 
çl£
;

65 
¦Ùs
[0].
pos™iÚ
 = 0;

66 
i
 = 1; i < 
couÁ
; i++) {

67 
¦Ùs
[
i
].
locked
 = 
Œue
;

68 
¦Ùs
[
i
].
pos™iÚ
 = i;

71 
lock
->
¦Ùs
 = slots;

72 
lock
->
couÁ
 = count;

73 
lock
->
mask
 = 
couÁ
 - 1;

74 
lock
->
Ãxt
 = 0;

81 ià(
couÁ
 & (count - 1))

82 
lock
->
w¿p
 = (
UINT_MAX
 % 
couÁ
) + 1;

84 
lock
->
w¿p
 = 0;

86 
	`ck_´_b¬r›r
();

88 
	}
}

90 
CK_CC_INLINE
 
boŞ


91 
	$ck_¥šlock_ªd”sÚ_locked
(
ck_¥šlock_ªd”sÚ
 *
lock
)

93 
pos™iÚ
;

94 
boŞ
 
r
;

96 
pos™iÚ
 = 
	`ck_´_lßd_ušt
(&
lock
->
Ãxt
è&†ock->
mask
;

97 
r
 = 
	`ck_´_lßd_ušt
(&
lock
->
¦Ùs
[
pos™iÚ
].
locked
);

98 
	`ck_´_ãnû_acquœe
();

99  
r
;

100 
	}
}

102 
CK_CC_INLINE
 

103 
	$ck_¥šlock_ªd”sÚ_lock
(
ck_¥šlock_ªd”sÚ
 *
lock
,

104 
ck_¥šlock_ªd”sÚ_th»ad
 **
¦Ù
)

106 
pos™iÚ
, 
Ãxt
;

107 
couÁ
 = 
lock
->count;

114 ià(
lock
->
w¿p
 != 0) {

115 
pos™iÚ
 = 
	`ck_´_lßd_ušt
(&
lock
->
Ãxt
);

118 ià(
pos™iÚ
 =ğ
UINT_MAX
)

119 
Ãxt
 = 
lock
->
w¿p
;

121 
Ãxt
 = 
pos™iÚ
 + 1;

122 } 
	`ck_´_ÿs_ušt_v®ue
(&
lock
->
Ãxt
, 
pos™iÚ
,

123 
Ãxt
, &
pos™iÚ
è=ğ
çl£
);

125 
pos™iÚ
 %ğ
couÁ
;

127 
pos™iÚ
 = 
	`ck_´_ça_ušt
(&
lock
->
Ãxt
, 1);

128 
pos™iÚ
 &ğ
lock
->
mask
;

132 
	`ck_´_ãnû_lßd
();

138 
	`ck_´_lßd_ušt
(&
lock
->
¦Ùs
[
pos™iÚ
].
locked
è=ğ
Œue
)

139 
	`ck_´_¡®l
();

142 
	`ck_´_¡Üe_ušt
(&
lock
->
¦Ùs
[
pos™iÚ
].
locked
, 
Œue
);

143 
	`ck_´_ãnû_lock
();

145 *
¦Ù
 = 
lock
->
¦Ùs
 + 
pos™iÚ
;

147 
	}
}

149 
CK_CC_INLINE
 

150 
	$ck_¥šlock_ªd”sÚ_uÆock
(
ck_¥šlock_ªd”sÚ
 *
lock
,

151 
ck_¥šlock_ªd”sÚ_th»ad
 *
¦Ù
)

153 
pos™iÚ
;

155 
	`ck_´_ãnû_uÆock
();

158 ià(
lock
->
w¿p
 == 0)

159 
pos™iÚ
 = (
¦Ù
->pos™iÚ + 1è& 
lock
->
mask
;

161 
pos™iÚ
 = (
¦Ù
->pos™iÚ + 1è% 
lock
->
couÁ
;

163 
	`ck_´_¡Üe_ušt
(&
lock
->
¦Ùs
[
pos™iÚ
].
locked
, 
çl£
);

165 
	}
}

	@application/kvbench/include/aerospike/ck/spinlock/cas.h

27 #iâdeà
CK_SPINLOCK_CAS_H


28 
	#CK_SPINLOCK_CAS_H


	)

30 
	~<«ro¥ike/ck/ck_backoff.h
>

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_–ide.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

36 #iâdeà
CK_F_SPINLOCK_CAS


37 
	#CK_F_SPINLOCK_CAS


	)

41 
	sck_¥šlock_ÿs
 {

42 
	mv®ue
;

44 
ck_¥šlock_ÿs
 
	tck_¥šlock_ÿs_t
;

46 
	#CK_SPINLOCK_CAS_INITIALIZER
 {
çl£
}

	)

48 
CK_CC_INLINE
 

49 
	$ck_¥šlock_ÿs_š™
(
ck_¥šlock_ÿs
 *
lock
)

52 
lock
->
v®ue
 = 
çl£
;

53 
	`ck_´_b¬r›r
();

55 
	}
}

57 
CK_CC_INLINE
 
boŞ


58 
	$ck_¥šlock_ÿs_Œylock
(
ck_¥šlock_ÿs
 *
lock
)

60 
v®ue
;

62 
v®ue
 = 
	`ck_´_çs_ušt
(&
lock
->v®ue, 
Œue
);

63 
	`ck_´_ãnû_lock
();

64  !
v®ue
;

65 
	}
}

67 
CK_CC_INLINE
 
boŞ


68 
	$ck_¥šlock_ÿs_locked
(
ck_¥šlock_ÿs
 *
lock
)

70 
boŞ
 
r
 = 
	`ck_´_lßd_ušt
(&
lock
->
v®ue
);

72 
	`ck_´_ãnû_acquœe
();

73  
r
;

74 
	}
}

76 
CK_CC_INLINE
 

77 
	$ck_¥šlock_ÿs_lock
(
ck_¥šlock_ÿs
 *
lock
)

80 
	`ck_´_ÿs_ušt
(&
lock
->
v®ue
, 
çl£
, 
Œue
) == false) {

81 
	`ck_´_lßd_ušt
(&
lock
->
v®ue
è=ğ
Œue
)

82 
	`ck_´_¡®l
();

85 
	`ck_´_ãnû_lock
();

87 
	}
}

89 
CK_CC_INLINE
 

90 
	$ck_¥šlock_ÿs_lock_eb
(
ck_¥šlock_ÿs
 *
lock
)

92 
ck_backoff_t
 
backoff
 = 
CK_BACKOFF_INITIALIZER
;

94 
	`ck_´_ÿs_ušt
(&
lock
->
v®ue
, 
çl£
, 
Œue
) == false)

95 
	`ck_backoff_eb
(&
backoff
);

97 
	`ck_´_ãnû_lock
();

99 
	}
}

101 
CK_CC_INLINE
 

102 
	$ck_¥šlock_ÿs_uÆock
(
ck_¥šlock_ÿs
 *
lock
)

106 
	`ck_´_ãnû_uÆock
();

107 
	`ck_´_¡Üe_ušt
(&
lock
->
v®ue
, 
çl£
);

109 
	}
}

111 
	$CK_ELIDE_PROTOTYPE
(
ck_¥šlock_ÿs
, 
ck_¥šlock_ÿs_t
,

112 
ck_¥šlock_ÿs_locked
, 
ck_¥šlock_ÿs_lock
,

113 
ck_¥šlock_ÿs_locked
, 
ck_¥šlock_ÿs_uÆock
)

115 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_¥šlock_ÿs
, 
ck_¥šlock_ÿs_t
,

116 
ck_¥šlock_ÿs_locked
, 
ck_¥šlock_ÿs_Œylock
)

	@application/kvbench/include/aerospike/ck/spinlock/clh.h

27 #iâdeà
CK_SPINLOCK_CLH_H


28 
	#CK_SPINLOCK_CLH_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_lim™s.h
>

32 
	~<«ro¥ike/ck/ck_´.h
>

33 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

34 
	~<«ro¥ike/ck/ck_¡ddef.h
>

36 #iâdeà
CK_F_SPINLOCK_CLH


37 
	#CK_F_SPINLOCK_CLH


	)

39 
	sck_¥šlock_şh
 {

40 
	mwa™
;

41 
ck_¥šlock_şh
 *
	m´evious
;

43 
ck_¥šlock_şh
 
	tck_¥šlock_şh_t
;

45 
CK_CC_INLINE
 

46 
	$ck_¥šlock_şh_š™
(
ck_¥šlock_şh
 **
lock
, ck_¥šlock_şh *
unowÃd
)

49 
unowÃd
->
´evious
 = 
NULL
;

50 
unowÃd
->
wa™
 = 
çl£
;

51 *
lock
 = 
unowÃd
;

52 
	`ck_´_b¬r›r
();

54 
	}
}

56 
CK_CC_INLINE
 
boŞ


57 
	$ck_¥šlock_şh_locked
(
ck_¥šlock_şh
 **
queue
)

59 
ck_¥šlock_şh
 *
h—d
;

60 
boŞ
 
r
;

62 
h—d
 = 
	`ck_´_lßd_±r
(
queue
);

63 
r
 = 
	`ck_´_lßd_ušt
(&
h—d
->
wa™
);

64 
	`ck_´_ãnû_acquœe
();

65  
r
;

66 
	}
}

68 
CK_CC_INLINE
 

69 
	$ck_¥šlock_şh_lock
(
ck_¥šlock_şh
 **
queue
, ck_¥šlock_şh *
th»ad
)

71 
ck_¥šlock_şh
 *
´evious
;

74 
th»ad
->
wa™
 = 
Œue
;

75 
	`ck_´_ãnû_¡Üe_©omic
();

81 
´evious
 = 
	`ck_´_çs_±r
(
queue
, 
th»ad
);

82 
th»ad
->
´evious
 =…revious;

85 
	`ck_´_ãnû_lßd
();

86 
	`ck_´_lßd_ušt
(&
´evious
->
wa™
è=ğ
Œue
)

87 
	`ck_´_¡®l
();

89 
	`ck_´_ãnû_lock
();

91 
	}
}

93 
CK_CC_INLINE
 

94 
	$ck_¥šlock_şh_uÆock
(
ck_¥šlock_şh
 **
th»ad
)

96 
ck_¥šlock_şh
 *
´evious
;

105 
´evious
 = 
th»ad
[0]->previous;

110 
	`ck_´_ãnû_uÆock
();

111 
	`ck_´_¡Üe_ušt
(&(*
th»ad
)->
wa™
, 
çl£
);

118 *
th»ad
 = 
´evious
;

120 
	}
}

	@application/kvbench/include/aerospike/ck/spinlock/dec.h

27 #iâdeà
CK_SPINLOCK_DEC_H


28 
	#CK_SPINLOCK_DEC_H


	)

30 
	~<«ro¥ike/ck/ck_backoff.h
>

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_–ide.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

36 #iâdeà
CK_F_SPINLOCK_DEC


37 
	#CK_F_SPINLOCK_DEC


	)

43 
	sck_¥šlock_dec
 {

44 
	mv®ue
;

46 
ck_¥šlock_dec
 
	tck_¥šlock_dec_t
;

48 
	#CK_SPINLOCK_DEC_INITIALIZER
 {1}

	)

50 
CK_CC_INLINE
 

51 
	$ck_¥šlock_dec_š™
(
ck_¥šlock_dec
 *
lock
)

54 
lock
->
v®ue
 = 1;

55 
	`ck_´_b¬r›r
();

57 
	}
}

59 
CK_CC_INLINE
 
boŞ


60 
	$ck_¥šlock_dec_Œylock
(
ck_¥šlock_dec
 *
lock
)

62 
v®ue
;

64 
v®ue
 = 
	`ck_´_çs_ušt
(&
lock
->value, 0);

65 
	`ck_´_ãnû_lock
();

66  
v®ue
 == 1;

67 
	}
}

69 
CK_CC_INLINE
 
boŞ


70 
	$ck_¥šlock_dec_locked
(
ck_¥šlock_dec
 *
lock
)

72 
boŞ
 
r
;

74 
r
 = 
	`ck_´_lßd_ušt
(&
lock
->
v®ue
) != 1;

75 
	`ck_´_ãnû_acquœe
();

76  
r
;

77 
	}
}

79 
CK_CC_INLINE
 

80 
	$ck_¥šlock_dec_lock
(
ck_¥šlock_dec
 *
lock
)

82 
boŞ
 
r
;

90 
	`ck_´_dec_ušt_z”o
(&
lock
->
v®ue
, &
r
);

91 ià(
r
 =ğ
Œue
)

95 
	`ck_´_lßd_ušt
(&
lock
->
v®ue
) != 1)

96 
	`ck_´_¡®l
();

99 
	`ck_´_ãnû_lock
();

101 
	}
}

103 
CK_CC_INLINE
 

104 
	$ck_¥šlock_dec_lock_eb
(
ck_¥šlock_dec
 *
lock
)

106 
ck_backoff_t
 
backoff
 = 
CK_BACKOFF_INITIALIZER
;

107 
boŞ
 
r
;

110 
	`ck_´_dec_ušt_z”o
(&
lock
->
v®ue
, &
r
);

111 ià(
r
 =ğ
Œue
)

114 
	`ck_backoff_eb
(&
backoff
);

117 
	`ck_´_ãnû_lock
();

119 
	}
}

121 
CK_CC_INLINE
 

122 
	$ck_¥šlock_dec_uÆock
(
ck_¥šlock_dec
 *
lock
)

125 
	`ck_´_ãnû_uÆock
();

131 
	`ck_´_¡Üe_ušt
(&
lock
->
v®ue
, 1);

133 
	}
}

135 
	$CK_ELIDE_PROTOTYPE
(
ck_¥šlock_dec
, 
ck_¥šlock_dec_t
,

136 
ck_¥šlock_dec_locked
, 
ck_¥šlock_dec_lock
,

137 
ck_¥šlock_dec_locked
, 
ck_¥šlock_dec_uÆock
)

139 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_¥šlock_dec
, 
ck_¥šlock_dec_t
,

140 
ck_¥šlock_dec_locked
, 
ck_¥šlock_dec_Œylock
)

	@application/kvbench/include/aerospike/ck/spinlock/fas.h

27 #iâdeà
CK_SPINLOCK_FAS_H


28 
	#CK_SPINLOCK_FAS_H


	)

30 
	~<«ro¥ike/ck/ck_backoff.h
>

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_–ide.h
>

33 
	~<«ro¥ike/ck/ck_´.h
>

34 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

36 #iâdeà
CK_F_SPINLOCK_FAS


37 
	#CK_F_SPINLOCK_FAS


	)

39 
	sck_¥šlock_çs
 {

40 
	mv®ue
;

42 
ck_¥šlock_çs
 
	tck_¥šlock_çs_t
;

44 
	#CK_SPINLOCK_FAS_INITIALIZER
 {
çl£
}

	)

46 
CK_CC_INLINE
 

47 
	$ck_¥šlock_çs_š™
(
ck_¥šlock_çs
 *
lock
)

50 
lock
->
v®ue
 = 
çl£
;

51 
	`ck_´_b¬r›r
();

53 
	}
}

55 
CK_CC_INLINE
 
boŞ


56 
	$ck_¥šlock_çs_Œylock
(
ck_¥šlock_çs
 *
lock
)

58 
boŞ
 
v®ue
;

60 
v®ue
 = 
	`ck_´_çs_ušt
(&
lock
->v®ue, 
Œue
);

61 
	`ck_´_ãnû_lock
();

63  !
v®ue
;

64 
	}
}

66 
CK_CC_INLINE
 
boŞ


67 
	$ck_¥šlock_çs_locked
(
ck_¥šlock_çs
 *
lock
)

69 
boŞ
 
r
;

71 
r
 = 
	`ck_´_lßd_ušt
(&
lock
->
v®ue
);

72 
	`ck_´_ãnû_acquœe
();

73  
r
;

74 
	}
}

76 
CK_CC_INLINE
 

77 
	$ck_¥šlock_çs_lock
(
ck_¥šlock_çs
 *
lock
)

80 
	`ck_´_çs_ušt
(&
lock
->
v®ue
, 
Œue
) ==rue) {

81 
	`ck_´_lßd_ušt
(&
lock
->
v®ue
è=ğ
Œue
)

82 
	`ck_´_¡®l
();

85 
	`ck_´_ãnû_lock
();

87 
	}
}

89 
CK_CC_INLINE
 

90 
	$ck_¥šlock_çs_lock_eb
(
ck_¥šlock_çs
 *
lock
)

92 
ck_backoff_t
 
backoff
 = 
CK_BACKOFF_INITIALIZER
;

94 
	`ck_´_çs_ušt
(&
lock
->
v®ue
, 
Œue
) ==rue)

95 
	`ck_backoff_eb
(&
backoff
);

97 
	`ck_´_ãnû_lock
();

99 
	}
}

101 
CK_CC_INLINE
 

102 
	$ck_¥šlock_çs_uÆock
(
ck_¥šlock_çs
 *
lock
)

105 
	`ck_´_ãnû_uÆock
();

106 
	`ck_´_¡Üe_ušt
(&
lock
->
v®ue
, 
çl£
);

108 
	}
}

110 
	$CK_ELIDE_PROTOTYPE
(
ck_¥šlock_çs
, 
ck_¥šlock_çs_t
,

111 
ck_¥šlock_çs_locked
, 
ck_¥šlock_çs_lock
,

112 
ck_¥šlock_çs_locked
, 
ck_¥šlock_çs_uÆock
)

114 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_¥šlock_çs
, 
ck_¥šlock_çs_t
,

115 
ck_¥šlock_çs_locked
, 
ck_¥šlock_çs_Œylock
)

	@application/kvbench/include/aerospike/ck/spinlock/hclh.h

28 #iâdeà
CK_SPINLOCK_HCLH_H


29 
	#CK_SPINLOCK_HCLH_H


	)

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_´.h
>

33 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

34 
	~<«ro¥ike/ck/ck_¡ddef.h
>

36 #iâdeà
CK_F_SPINLOCK_HCLH


37 
	#CK_F_SPINLOCK_HCLH


	)

38 
	sck_¥šlock_hşh
 {

39 
	mwa™
;

40 
	m¥liû
;

41 
	mşu¡”_id
;

42 
ck_¥šlock_hşh
 *
	m´evious
;

44 
ck_¥šlock_hşh
 
	tck_¥šlock_hşh_t
;

46 
CK_CC_INLINE
 

47 
	$ck_¥šlock_hşh_š™
(
ck_¥šlock_hşh
 **
lock
,

48 
ck_¥šlock_hşh
 *
unowÃd
,

49 
şu¡”_id
)

52 
unowÃd
->
´evious
 = 
NULL
;

53 
unowÃd
->
wa™
 = 
çl£
;

54 
unowÃd
->
¥liû
 = 
çl£
;

55 
unowÃd
->
şu¡”_id
 = cluster_id;

56 *
lock
 = 
unowÃd
;

57 
	`ck_´_b¬r›r
();

59 
	}
}

61 
CK_CC_INLINE
 
boŞ


62 
	$ck_¥šlock_hşh_locked
(
ck_¥šlock_hşh
 **
queue
)

64 
ck_¥šlock_hşh
 *
h—d
;

65 
boŞ
 
r
;

67 
h—d
 = 
	`ck_´_lßd_±r
(
queue
);

68 
r
 = 
	`ck_´_lßd_ušt
(&
h—d
->
wa™
);

69 
	`ck_´_ãnû_acquœe
();

70  
r
;

71 
	}
}

73 
CK_CC_INLINE
 

74 
	$ck_¥šlock_hşh_lock
(
ck_¥šlock_hşh
 **
glob_queue
,

75 
ck_¥šlock_hşh
 **
loÿl_queue
,

76 
ck_¥šlock_hşh
 *
th»ad
)

78 
ck_¥šlock_hşh
 *
´evious
, *
loÿl_
;

81 
th»ad
->
wa™
 = 
Œue
;

82 
th»ad
->
¥liû
 = 
çl£
;

83 
th»ad
->
şu¡”_id
 = (*
loÿl_queue
)->cluster_id;

86 
	`ck_´_ãnû_¡Üe_©omic
();

89 
´evious
 = 
	`ck_´_çs_±r
(
loÿl_queue
, 
th»ad
);

90 
th»ad
->
´evious
 =…revious;

93 
	`ck_´_ãnû_lßd
();

94 ià(
´evious
->´eviou !ğ
NULL
 &&

95 
´evious
->
şu¡”_id
 =ğ
th»ad
->cluster_id) {

96 
	`ck_´_lßd_ušt
(&
´evious
->
wa™
è=ğ
Œue
)

97 
	`ck_´_¡®l
();

100 ià(
	`ck_´_lßd_ušt
(&
´evious
->
¥liû
è=ğ
çl£
)

105 
loÿl_
 = 
	`ck_´_lßd_±r
(
loÿl_queue
);

106 
´evious
 = 
	`ck_´_çs_±r
(
glob_queue
, 
loÿl_
);

108 
	`ck_´_¡Üe_ušt
(&
loÿl_
->
¥liû
, 
Œue
);

111 
	`ck_´_lßd_ušt
(&
´evious
->
wa™
è=ğ
Œue
)

112 
	`ck_´_¡®l
();

114 
	`ck_´_ãnû_lock
();

116 
	}
}

118 
CK_CC_INLINE
 

119 
	$ck_¥šlock_hşh_uÆock
(
ck_¥šlock_hşh
 **
th»ad
)

121 
ck_¥šlock_hşh
 *
´evious
;

130 
´evious
 = 
th»ad
[0]->previous;

133 
	`ck_´_ãnû_uÆock
();

134 
	`ck_´_¡Üe_ušt
(&(*
th»ad
)->
wa™
, 
çl£
);

141 *
th»ad
 = 
´evious
;

143 
	}
}

	@application/kvbench/include/aerospike/ck/spinlock/mcs.h

27 #iâdeà
CK_SPINLOCK_MCS_H


28 
	#CK_SPINLOCK_MCS_H


	)

30 
	~<«ro¥ike/ck/ck_cc.h
>

31 
	~<«ro¥ike/ck/ck_´.h
>

32 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

33 
	~<«ro¥ike/ck/ck_¡ddef.h
>

35 #iâdeà
CK_F_SPINLOCK_MCS


36 
	#CK_F_SPINLOCK_MCS


	)

38 
	sck_¥šlock_mcs
 {

39 
	mlocked
;

40 
ck_¥šlock_mcs
 *
	mÃxt
;

42 
ck_¥šlock_mcs
 * 
	tck_¥šlock_mcs_t
;

43 
ck_¥šlock_mcs
 
	tck_¥šlock_mcs_cÚ‹xt_t
;

45 
	#CK_SPINLOCK_MCS_INITIALIZER
 (
NULL
)

	)

47 
CK_CC_INLINE
 

48 
	$ck_¥šlock_mcs_š™
(
ck_¥šlock_mcs
 **
queue
)

51 *
queue
 = 
NULL
;

52 
	`ck_´_b¬r›r
();

54 
	}
}

56 
CK_CC_INLINE
 
boŞ


57 
	$ck_¥šlock_mcs_Œylock
(
ck_¥šlock_mcs
 **
queue
,

58 
ck_¥šlock_mcs
 *
node
)

60 
boŞ
 
r
;

62 
node
->
locked
 = 
Œue
;

63 
node
->
Ãxt
 = 
NULL
;

64 
	`ck_´_ãnû_¡Üe_©omic
();

66 
r
 = 
	`ck_´_ÿs_±r
(
queue
, 
NULL
, 
node
);

67 
	`ck_´_ãnû_lock
();

68  
r
;

69 
	}
}

71 
CK_CC_INLINE
 
boŞ


72 
	$ck_¥šlock_mcs_locked
(
ck_¥šlock_mcs
 **
queue
)

74 
boŞ
 
r
;

76 
r
 = 
	`ck_´_lßd_±r
(
queue
è!ğ
NULL
;

77 
	`ck_´_ãnû_acquœe
();

78  
r
;

79 
	}
}

81 
CK_CC_INLINE
 

82 
	$ck_¥šlock_mcs_lock
(
ck_¥šlock_mcs
 **
queue
,

83 
ck_¥šlock_mcs
 *
node
)

85 
ck_¥šlock_mcs
 *
´evious
;

91 
node
->
locked
 = 
Œue
;

92 
node
->
Ãxt
 = 
NULL
;

93 
	`ck_´_ãnû_¡Üe_©omic
();

100 
´evious
 = 
	`ck_´_çs_±r
(
queue
, 
node
);

101 ià(
´evious
 !ğ
NULL
) {

106 
	`ck_´_¡Üe_±r
(&
´evious
->
Ãxt
, 
node
);

107 
	`ck_´_lßd_ušt
(&
node
->
locked
è=ğ
Œue
)

108 
	`ck_´_¡®l
();

111 
	`ck_´_ãnû_lock
();

113 
	}
}

115 
CK_CC_INLINE
 

116 
	$ck_¥šlock_mcs_uÆock
(
ck_¥šlock_mcs
 **
queue
,

117 
ck_¥šlock_mcs
 *
node
)

119 
ck_¥šlock_mcs
 *
Ãxt
;

121 
	`ck_´_ãnû_uÆock
();

123 
Ãxt
 = 
	`ck_´_lßd_±r
(&
node
->next);

124 ià(
Ãxt
 =ğ
NULL
) {

130 ià(
	`ck_´_lßd_±r
(
queue
è=ğ
node
 &&

131 
	`ck_´_ÿs_±r
(
queue
, 
node
, 
NULL
è=ğ
Œue
) {

142 
Ãxt
 = 
	`ck_´_lßd_±r
(&
node
->next);

143 ià(
Ãxt
 !ğ
NULL
)

146 
	`ck_´_¡®l
();

151 
	`ck_´_¡Üe_ušt
(&
Ãxt
->
locked
, 
çl£
);

153 
	}
}

	@application/kvbench/include/aerospike/ck/spinlock/ticket.h

27 #iâdeà
CK_SPINLOCK_TICKET_H


28 
	#CK_SPINLOCK_TICKET_H


	)

30 
	~<«ro¥ike/ck/ck_backoff.h
>

31 
	~<«ro¥ike/ck/ck_cc.h
>

32 
	~<«ro¥ike/ck/ck_–ide.h
>

33 
	~<«ro¥ike/ck/ck_md.h
>

34 
	~<«ro¥ike/ck/ck_´.h
>

35 
	~<«ro¥ike/ck/ck_¡dboŞ.h
>

37 #iâdeà
CK_F_SPINLOCK_TICKET


38 
	#CK_F_SPINLOCK_TICKET


	)

44 #ià
defšed
(
CK_MD_TSO
è&& (defšed(
__x86__
è|| defšed(
__x86_64__
))

45 #ià
defšed
(
CK_F_PR_FAA_32
è&& defšed(
CK_F_PR_INC_16
è&& defšed(
CK_F_PR_CAS_32
)

46 
	#CK_SPINLOCK_TICKET_TYPE
 
ušt32_t


	)

47 
	#CK_SPINLOCK_TICKET_TYPE_BASE
 
ušt16_t


	)

48 
	#CK_SPINLOCK_TICKET_INC
(
x
è
	`ck_´_šc_16
(x)

	)

49 
	#CK_SPINLOCK_TICKET_CAS
(
x
, 
y
, 
z
è
	`ck_´_ÿs_32
(x, y, z)

	)

50 
	#CK_SPINLOCK_TICKET_FAA
(
x
, 
y
è
	`ck_´_ça_32
(x, y)

	)

51 
	#CK_SPINLOCK_TICKET_LOAD
(
x
è
	`ck_´_lßd_32
(x)

	)

52 
	#CK_SPINLOCK_TICKET_INCREMENT
 (0x00010000UL)

	)

53 
	#CK_SPINLOCK_TICKET_MASK
 (0xFFFFUL)

	)

54 
	#CK_SPINLOCK_TICKET_SHIFT
 (16)

	)

55 #–ià
defšed
(
CK_F_PR_FAA_64
è&& defšed(
CK_F_PR_INC_32
è&& defšed(
CK_F_PR_CAS_64
)

56 
	#CK_SPINLOCK_TICKET_TYPE
 
ušt64_t


	)

57 
	#CK_SPINLOCK_TICKET_TYPE_BASE
 
ušt32_t


	)

58 
	#CK_SPINLOCK_TICKET_INC
(
x
è
	`ck_´_šc_32
(x)

	)

59 
	#CK_SPINLOCK_TICKET_CAS
(
x
, 
y
, 
z
è
	`ck_´_ÿs_64
(x, y, z)

	)

60 
	#CK_SPINLOCK_TICKET_FAA
(
x
, 
y
è
	`ck_´_ça_64
(x, y)

	)

61 
	#CK_SPINLOCK_TICKET_LOAD
(
x
è
	`ck_´_lßd_64
(x)

	)

62 
	#CK_SPINLOCK_TICKET_INCREMENT
 (0x0000000100000000ULL)

	)

63 
	#CK_SPINLOCK_TICKET_MASK
 (0xFFFFFFFFULL)

	)

64 
	#CK_SPINLOCK_TICKET_SHIFT
 (32)

	)

68 #ià
defšed
(
CK_SPINLOCK_TICKET_TYPE
)

69 
	#CK_F_SPINLOCK_TICKET_TRYLOCK


	)

71 
	sck_¥šlock_tick‘
 {

72 
CK_SPINLOCK_TICKET_TYPE
 
	mv®ue
;

74 
ck_¥šlock_tick‘
 
	tck_¥šlock_tick‘_t
;

75 
	#CK_SPINLOCK_TICKET_INITIALIZER
 { .
v®ue
 = 0 }

	)

77 
CK_CC_INLINE
 

78 
	$ck_¥šlock_tick‘_š™
(
ck_¥šlock_tick‘
 *
tick‘
)

81 
tick‘
->
v®ue
 = 0;

82 
	`ck_´_b¬r›r
();

84 
	}
}

86 
CK_CC_INLINE
 
boŞ


87 
	$ck_¥šlock_tick‘_locked
(
ck_¥šlock_tick‘
 *
tick‘
)

89 
CK_SPINLOCK_TICKET_TYPE
 
»que¡
, 
pos™iÚ
;

91 
»que¡
 = 
	`CK_SPINLOCK_TICKET_LOAD
(&
tick‘
->
v®ue
);

92 
pos™iÚ
 = 
»que¡
 & 
CK_SPINLOCK_TICKET_MASK
;

93 
»que¡
 >>ğ
CK_SPINLOCK_TICKET_SHIFT
;

95 
	`ck_´_ãnû_acquœe
();

96  
»que¡
 !ğ
pos™iÚ
;

97 
	}
}

99 
CK_CC_INLINE
 

100 
	$ck_¥šlock_tick‘_lock
(
ck_¥šlock_tick‘
 *
tick‘
)

102 
CK_SPINLOCK_TICKET_TYPE
 
»que¡
, 
pos™iÚ
;

105 
»que¡
 = 
	`CK_SPINLOCK_TICKET_FAA
(&
tick‘
->
v®ue
,

106 
CK_SPINLOCK_TICKET_INCREMENT
);

108 
pos™iÚ
 = 
»que¡
 & 
CK_SPINLOCK_TICKET_MASK
;

109 
»que¡
 >>ğ
CK_SPINLOCK_TICKET_SHIFT
;

111 
»que¡
 !ğ
pos™iÚ
) {

112 
	`ck_´_¡®l
();

113 
pos™iÚ
 = 
	`CK_SPINLOCK_TICKET_LOAD
(&
tick‘
->
v®ue
) &

114 
CK_SPINLOCK_TICKET_MASK
;

117 
	`ck_´_ãnû_lock
();

119 
	}
}

121 
CK_CC_INLINE
 

122 
	$ck_¥šlock_tick‘_lock_pb
(
ck_¥šlock_tick‘
 *
tick‘
, 
c
)

124 
CK_SPINLOCK_TICKET_TYPE
 
»que¡
, 
pos™iÚ
;

125 
ck_backoff_t
 
backoff
;

128 
»que¡
 = 
	`CK_SPINLOCK_TICKET_FAA
(&
tick‘
->
v®ue
,

129 
CK_SPINLOCK_TICKET_INCREMENT
);

131 
pos™iÚ
 = 
»que¡
 & 
CK_SPINLOCK_TICKET_MASK
;

132 
»que¡
 >>ğ
CK_SPINLOCK_TICKET_SHIFT
;

134 
»que¡
 !ğ
pos™iÚ
) {

135 
	`ck_´_¡®l
();

136 
pos™iÚ
 = 
	`CK_SPINLOCK_TICKET_LOAD
(&
tick‘
->
v®ue
) &

137 
CK_SPINLOCK_TICKET_MASK
;

139 
backoff
 = (
»que¡
 - 
pos™iÚ
è& 
CK_SPINLOCK_TICKET_MASK
;

140 
backoff
 <<ğ
c
;

141 
	`ck_backoff_eb
(&
backoff
);

144 
	`ck_´_ãnû_lock
();

146 
	}
}

148 
CK_CC_INLINE
 
boŞ


149 
	$ck_¥šlock_tick‘_Œylock
(
ck_¥šlock_tick‘
 *
tick‘
)

151 
CK_SPINLOCK_TICKET_TYPE
 
¢­shÙ
, 
»que¡
, 
pos™iÚ
;

153 
¢­shÙ
 = 
	`CK_SPINLOCK_TICKET_LOAD
(&
tick‘
->
v®ue
);

154 
pos™iÚ
 = 
¢­shÙ
 & 
CK_SPINLOCK_TICKET_MASK
;

155 
»que¡
 = 
¢­shÙ
 >> 
CK_SPINLOCK_TICKET_SHIFT
;

157 ià(
pos™iÚ
 !ğ
»que¡
)

158  
çl£
;

160 ià(
	`CK_SPINLOCK_TICKET_CAS
(&
tick‘
->
v®ue
,

161 
¢­shÙ
, sÇpshÙ + 
CK_SPINLOCK_TICKET_INCREMENT
è=ğ
çl£
) {

162  
çl£
;

165 
	`ck_´_ãnû_lock
();

166  
Œue
;

167 
	}
}

169 
CK_CC_INLINE
 

170 
	$ck_¥šlock_tick‘_uÆock
(
ck_¥šlock_tick‘
 *
tick‘
)

173 
	`ck_´_ãnû_uÆock
();

174 
	`CK_SPINLOCK_TICKET_INC
((
CK_SPINLOCK_TICKET_TYPE_BASE
 *)(*)&
tick‘
->
v®ue
);

176 
	}
}

178 #undeà
CK_SPINLOCK_TICKET_TYPE


179 #undeà
CK_SPINLOCK_TICKET_TYPE_BASE


180 #undeà
CK_SPINLOCK_TICKET_INC


181 #undeà
CK_SPINLOCK_TICKET_FAA


182 #undeà
CK_SPINLOCK_TICKET_LOAD


183 #undeà
CK_SPINLOCK_TICKET_INCREMENT


184 #undeà
CK_SPINLOCK_TICKET_MASK


185 #undeà
CK_SPINLOCK_TICKET_SHIFT


191 
	sck_¥šlock_tick‘
 {

192 
	mÃxt
;

193 
	mpos™iÚ
;

195 
ck_¥šlock_tick‘
 
	tck_¥šlock_tick‘_t
;

197 
	#CK_SPINLOCK_TICKET_INITIALIZER
 {.
Ãxt
 = 0, .
pos™iÚ
 = 0}

	)

199 
CK_CC_INLINE
 

200 
	$ck_¥šlock_tick‘_š™
(
ck_¥šlock_tick‘
 *
tick‘
)

203 
tick‘
->
Ãxt
 = 0;

204 
tick‘
->
pos™iÚ
 = 0;

205 
	`ck_´_b¬r›r
();

208 
	}
}

210 
CK_CC_INLINE
 
boŞ


211 
	$ck_¥šlock_tick‘_locked
(
ck_¥šlock_tick‘
 *
tick‘
)

213 
boŞ
 
r
;

215 
r
 = 
	`ck_´_lßd_ušt
(&
tick‘
->
pos™iÚ
) !=

216 
	`ck_´_lßd_ušt
(&
tick‘
->
Ãxt
);

217 
	`ck_´_ãnû_acquœe
();

218  
r
;

219 
	}
}

221 
CK_CC_INLINE
 

222 
	$ck_¥šlock_tick‘_lock
(
ck_¥šlock_tick‘
 *
tick‘
)

224 
»que¡
;

227 
»que¡
 = 
	`ck_´_ça_ušt
(&
tick‘
->
Ãxt
, 1);

234 
	`ck_´_lßd_ušt
(&
tick‘
->
pos™iÚ
è!ğ
»que¡
)

235 
	`ck_´_¡®l
();

237 
	`ck_´_ãnû_lock
();

239 
	}
}

241 
CK_CC_INLINE
 

242 
	$ck_¥šlock_tick‘_lock_pb
(
ck_¥šlock_tick‘
 *
tick‘
, 
c
)

244 
ck_backoff_t
 
backoff
;

245 
»que¡
, 
pos™iÚ
;

247 
»que¡
 = 
	`ck_´_ça_ušt
(&
tick‘
->
Ãxt
, 1);

250 
pos™iÚ
 = 
	`ck_´_lßd_ušt
(&
tick‘
->position);

251 ià(
pos™iÚ
 =ğ
»que¡
)

254 
backoff
 = 
»que¡
 - 
pos™iÚ
;

255 
backoff
 <<ğ
c
;

263 
	`ck_backoff_eb
(&
backoff
);

266 
	`ck_´_ãnû_lock
();

268 
	}
}

270 
CK_CC_INLINE
 

271 
	$ck_¥šlock_tick‘_uÆock
(
ck_¥šlock_tick‘
 *
tick‘
)

273 
upd©e
;

275 
	`ck_´_ãnû_uÆock
();

282 
upd©e
 = 
	`ck_´_lßd_ušt
(&
tick‘
->
pos™iÚ
);

283 
	`ck_´_¡Üe_ušt
(&
tick‘
->
pos™iÚ
, 
upd©e
 + 1);

285 
	}
}

288 
	$CK_ELIDE_PROTOTYPE
(
ck_¥šlock_tick‘
, 
ck_¥šlock_tick‘_t
,

289 
ck_¥šlock_tick‘_locked
, 
ck_¥šlock_tick‘_lock
,

290 
ck_¥šlock_tick‘_locked
, 
ck_¥šlock_tick‘_uÆock
)

292 
	$CK_ELIDE_TRYLOCK_PROTOTYPE
(
ck_¥šlock_tick‘
, 
ck_¥šlock_tick‘_t
,

293 
ck_¥šlock_tick‘_locked
, 
ck_¥šlock_tick‘_Œylock
)

	@application/kvbench/include/aerospike/ssl_util.h

18 #´agm¨
Úû


20 
	~<İ’s¦/x509.h
>

21 
	~<İ’s¦/x509v3.h
>

23 
boŞ


24 
as_s_m©ch_Çme
(
X509
 *
x509
, cÚ¡ *
Çme
, 
boŞ
 
®low_wdÿrd
);

	@application/kvbench/include/aerospike/version.h

6 
	#AEROSPIKE_CLIENT_VERSION
 402000000L

	)

8 * 
«ro¥ike_ş›Á_v”siÚ
;

	@application/kvbench/include/citrusleaf/alloc.h

17 #´agm¨
Úû


19 
	~<¡dlib.h
>

20 
	~<c™ru¦—f/cf_©omic.h
>

22 #ifdeà
__ılu¥lus


26 #ifdeà
MEM_COUNT


28 
	~"mem_couÁ.h
"

35 
šlše
 
ušt32_t
 
±r_hash_â
(cÚ¡ *
key
) {

36  (
ušt32_t
è* (cÚ¡ 
ušt64_t
 *è
key
;

39 #ifdeà
ENHANCED_ALLOC


41 
	~"’hªûd_®loc.h
"

51 *
cf_m®loc
(
size_t
 
sz
);

52 *
cf_ÿÎoc
(
size_t
 
nmemb
, size_ˆ
sz
);

53 *
cf_»®loc
(*
±r
, 
size_t
 
sz
);

54 *
cf_¡rdup
(cÚ¡ *
s
);

55 *
cf_¡ºdup
(cÚ¡ *
s
, 
size_t
 
n
);

56 *
cf_v®loc
(
size_t
 
sz
);

57 
cf_ä“
(*
p
);

76 
cf_©omic32
 
	tcf_rc_couÁ”
;

79 
cf_rc_couÁ”
 
couÁ
;

80 
ušt32_t
 
sz
;

81 } 
	tcf_rc_hdr
;

83 *
cf_rc_®loc
(
size_t
 
sz
);

84 
cf_rc_ä“
(*
addr
);

85 
cf_©omic_št_t
 
cf_rc_couÁ
(*
addr
);

86 
cf_rc_»£rve
(*
addr
);

87 
cf_rc_»Ëa£
(*
addr
);

88 
cf_rc_»Ëa£ªdä“
(*
addr
);

92 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_atomic.h

17 #´agm¨
Úû


28 
	~<¡dboŞ.h
>

29 
	~<¡dšt.h
>

31 #ifdeà
CF_WINDOWS


32 
	~<šŒš.h
>

33 
	~<WšSock2.h
>

36 #ifdeà
__ılu¥lus


41 
	~<«ro¥ike/ck/ck_´.h
>

47 
	#SIZEOF_ATOMIC_INT
 8

	)

48 vŞ©
	tušt64_t
 
	tcf_©omic64
;

49 vŞ©
	tušt32_t
 
	tcf_©omic32
;

50 vŞ©
	tušt64_t
 
	tcf_©omic_p
;

51 vŞ©
	tušt64_t
 
	tcf_©omic_št
;

52 
ušt64_t
 
	tcf_©omic_št_t
;

58 
	#cf_©omic32_g‘
(
a
è×)

	)

59 
	#cf_©omic32_£t
(
a
, 
b
è(*×èğ(b))

	)

60 
	#cf_©omic32_sub
(
a
,
b
è(
	`cf_©omic32_add
(×), (0 - (b))))

	)

61 
	#cf_©omic32_šü
(
a
è(
	`cf_©omic32_add
(×), 1))

	)

62 
	#cf_©omic32_deü
(
a
è(
	`cf_©omic32_add
(×), -1))

	)

64 
	#cf_©omic64_g‘
(
a
è×)

	)

65 
	#cf_©omic64_£t
(
a
, 
b
è(*×èğ(b))

	)

66 
	#cf_©omic64_sub
(
a
,
b
è(
	`cf_©omic64_add
(×), (0 - (b))))

	)

67 
	#cf_©omic64_šü
(
a
è(
	`cf_©omic64_add
(×), 1))

	)

68 
	#cf_©omic64_deü
(
a
è(
	`cf_©omic64_add
(×), -1))

	)

70 
	#cf_©omic_p_g‘
(
_a
è
	`cf_©omic64_g‘
(_a)

	)

71 
	#cf_©omic_p_£t
(
_a
, 
_b
è
	`cf_©omic64_£t
(_a, _b)

	)

72 
	#cf_©omic_p_add
(
_a
, 
_b
è
	`cf_©omic64_add
(_a, _b)

	)

73 
	#cf_©omic_p_šü
(
_a
è
	`cf_©omic64_add
((_a), 1)

	)

74 
	#cf_©omic_p_deü
(
_a
è
	`cf_©omic64_add
((_a), -1)

	)

76 
	#cf_©omic_št_g‘
(
_a
è
	`cf_©omic64_g‘
(_a)

	)

77 
	#cf_©omic_št_£t
(
_a
, 
_b
è
	`cf_©omic64_£t
(_a, _b)

	)

78 
	#cf_©omic_št_add
(
_a
, 
_b
è
	`cf_©omic64_add
(_a, _b)

	)

79 
	#cf_©omic_št_sub
(
_a
, 
_b
è
	`cf_©omic64_sub
(_a, _b)

	)

80 
	#cf_©omic_št_šü
(
_a
è
	`cf_©omic64_add
((_a), 1)

	)

81 
	#cf_©omic_št_deü
(
_a
è
	`cf_©omic64_add
((_a), -1)

	)

87 #ifdeà
CF_WINDOWS


89 
	#smb_mb
(è
	`_R—dWr™eB¬r›r
()

	)

91 
šlše
 
št64_t
 
cf_©omic64_add
(
cf_©omic64
 *
a
, iÁ64_ˆ
b
) {

92 
št64_t
 
i
 = 
b
;

93 
b
 = 
_IÁ”lockedExchªgeAdd64
((
LONGLONG
 *)
a
, b);

94 (
b
 + 
i
);

97 
šlše
 
št32_t
 
cf_©omic32_add
(
cf_©omic32
 *
a
, iÁ32_ˆ
b
){

98 
št32_t
 
i
 = 
b
;

99 
b
 = 
_IÁ”lockedExchªgeAdd
((vŞ©*)
a
, b);

100 (
b
 + 
i
);

109 #iâdeà
CF_WINDOWS


111 
	#cf_©omic_št_£tmax
(
_a
, 
_x
è
	`cf_©omic64_£tmax
(_a, _x)

	)

113 
	#smb_mb
(è
	`ck_´_ãnû_memÜy
()

	)

115 
šlše
 
št64_t
 
cf_©omic64_add
(
cf_©omic64
 *
a
, iÁ64_ˆ
b
) {

116  
ck_´_ça_64
((
ušt64_t
*)
a
, 
b
) + b;

122 
šlše
 
boŞ
 
cf_©omic64_£tmax
(
cf_©omic64
 *
a
, 
št64_t
 
x
) {

123 
ušt64_t
 
´iÜ
;

126 
št64_t
 
cur
 = 
cf_©omic64_g‘
(*
a
);

128 
x
 > 
cur
) {

130 ià(
ck_´_ÿs_64_v®ue
((
ušt64_t
*)
a
, 
cur
, 
x
, &
´iÜ
)) {

132  
Œue
;

136 
cur
 = 
´iÜ
;

140  
çl£
;

143 
šlše
 
št32_t
 
cf_©omic32_add
(
cf_©omic32
 *
a
, iÁ32_ˆ
b
){

144  
ck_´_ça_32
((
ušt32_t
*)
a
, 
b
) + b;

150 
šlše
 
boŞ
 
cf_©omic32_£tmax
(
cf_©omic32
 *
a
, 
št32_t
 
x
) {

151 
ušt32_t
 
´iÜ
;

154 
št32_t
 
cur
 = 
cf_©omic32_g‘
(*
a
);

156 
x
 > 
cur
) {

158 ià(
ck_´_ÿs_32_v®ue
((
ušt32_t
*)
a
, 
cur
, 
x
, &
´iÜ
)) {

159  
Œue
;

163 
cur
 = 
´iÜ
;

167  
çl£
;

171 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_b64.h

17 #´agm¨
Úû


19 
	~<¡dšt.h
>

20 
	~<¡dboŞ.h
>

22 #ifdeà
__ılu¥lus


33 
šlše
 
ušt32_t


34 
cf_b64_’coded_Ën
(
ušt32_t
 
š_size
)

36  ((
š_size
 + 2) / 3) << 2;

39 
cf_b64_’code
(cÚ¡ 
ušt8_t
* 
š
, 
ušt32_t
 
š_size
, * 
out
);

43 
šlše
 
ušt32_t


44 
cf_b64_decoded_buf_size
(
ušt32_t
 
š_Ën
)

46  (
š_Ën
 * 3) >> 2;

49 
cf_b64_decode
(cÚ¡ * 
š
, 
ušt32_t
 
š_Ën
, 
ušt8_t
* 
out
, ušt32_t* 
out_size
);

50 
cf_b64_decode_š_¶aû
(
ušt8_t
* 
š_out
, 
ušt32_t
 
š_Ën
, ušt32_t* 
out_size
);

51 
boŞ
 
cf_b64_v®id©e_ªd_decode
(cÚ¡ * 
š
, 
ušt32_t
 
š_Ën
, 
ušt8_t
* 
out
, ušt32_t* 
out_size
);

52 
boŞ
 
cf_b64_v®id©e_ªd_decode_š_¶aû
(
ušt8_t
* 
š_out
, 
ušt32_t
 
š_Ën
, ušt32_t* 
out_size
);

56 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_byte_order.h

17 #´agm¨
Úû


19 #ià
defšed
(
__lšux__
)

21 
	~<Ãtš‘/š.h
>

22 
	~<asm/by‹Üd”.h
>

24 
	#cf_sw­_to_be16
(
_n
è
	`__ıu_to_be16
(_n)

	)

25 
	#cf_sw­_to_Ë16
(
_n
è
	`__ıu_to_Ë16
(_n)

	)

26 
	#cf_sw­_äom_be16
(
_n
è
	`__be16_to_ıu
(_n)

	)

27 
	#cf_sw­_äom_Ë16
(
_n
è
	`__Ë16_to_ıu
(_n)

	)

29 
	#cf_sw­_to_be32
(
_n
è
	`__ıu_to_be32
(_n)

	)

30 
	#cf_sw­_to_Ë32
(
_n
è
	`__ıu_to_Ë32
(_n)

	)

31 
	#cf_sw­_äom_be32
(
_n
è
	`__be32_to_ıu
(_n)

	)

32 
	#cf_sw­_äom_Ë32
(
_n
è
	`__Ë32_to_ıu
(_n)

	)

34 
	#cf_sw­_to_be64
(
_n
è
	`__ıu_to_be64
(_n)

	)

35 
	#cf_sw­_to_Ë64
(
_n
è
	`__ıu_to_Ë64
(_n)

	)

36 
	#cf_sw­_äom_be64
(
_n
è
	`__be64_to_ıu
(_n)

	)

37 
	#cf_sw­_äom_Ë64
(
_n
è
	`__Ë64_to_ıu
(_n)

	)

41 #ià
defšed
(
__APPLE__
)

42 
	~<libk”n/OSBy‹Ord”.h
>

43 
	~<¬·/š‘.h
>

45 
	#cf_sw­_to_be16
(
_n
è
	`OSSw­Ho¡ToBigIÁ16
(_n)

	)

46 
	#cf_sw­_to_Ë16
(
_n
è
	`OSSw­Ho¡ToL™eIÁ16
(_n)

	)

47 
	#cf_sw­_äom_be16
(
_n
è
	`OSSw­BigToHo¡IÁ16
(_n)

	)

48 
	#cf_sw­_äom_Ë16
(
_n
è
	`OSSw­L™eToHo¡IÁ16
(_n)

	)

50 
	#cf_sw­_to_be32
(
_n
è
	`OSSw­Ho¡ToBigIÁ32
(_n)

	)

51 
	#cf_sw­_to_Ë32
(
_n
è
	`OSSw­Ho¡ToL™eIÁ32
(_n)

	)

52 
	#cf_sw­_äom_be32
(
_n
è
	`OSSw­BigToHo¡IÁ32
(_n)

	)

53 
	#cf_sw­_äom_Ë32
(
_n
è
	`OSSw­L™eToHo¡IÁ32
(_n)

	)

55 
	#cf_sw­_to_be64
(
_n
è
	`OSSw­Ho¡ToBigIÁ64
(_n)

	)

56 
	#cf_sw­_to_Ë64
(
_n
è
	`OSSw­Ho¡ToL™eIÁ64
(_n)

	)

57 
	#cf_sw­_äom_be64
(
_n
è
	`OSSw­BigToHo¡IÁ64
(_n)

	)

58 
	#cf_sw­_äom_Ë64
(
_n
è
	`OSSw­L™eToHo¡IÁ64
(_n)

	)

62 #ià
defšed
(
CF_WINDOWS
)

63 
	~<¡dšt.h
>

64 
	~<¡dlib.h
>

65 
	~<WšSock2.h
>

67 
	#cf_sw­_to_be16
(
_n
è
	`_by‹sw­_ušt16
(_n)

	)

68 
	#cf_sw­_to_Ë16
(
_n
è(_n)

	)

69 
	#cf_sw­_äom_be16
(
_n
è
	`_by‹sw­_ušt16
(_n)

	)

70 
	#cf_sw­_äom_Ë16
(
_n
è(_n)

	)

72 
	#cf_sw­_to_be32
(
_n
è
	`_by‹sw­_ušt32
(_n)

	)

73 
	#cf_sw­_to_Ë32
(
_n
è(_n)

	)

74 
	#cf_sw­_äom_be32
(
_n
è
	`_by‹sw­_ušt32
(_n)

	)

75 
	#cf_sw­_äom_Ë32
(
_n
è(_n)

	)

77 
	#cf_sw­_to_be64
(
_n
è
	`_by‹sw­_ušt64
(_n)

	)

78 
	#cf_sw­_to_Ë64
(
_n
è(_n)

	)

79 
	#cf_sw­_äom_be64
(
_n
è
	`_by‹sw­_ušt64
(_n)

	)

80 
	#cf_sw­_äom_Ë64
(
_n
è(_n)

	)

83 
šlše
 

84 
	$cf_sw­_to_big_æßt64
(
d
)

86 
ušt64_t
 
i
 = 
	`cf_sw­_to_be64
(*(ušt64_t*)&
d
);

87  *(*)&
i
;

88 
	}
}

90 
šlše
 

91 
	$cf_sw­_to_l™e_æßt64
(
d
)

93 
ušt64_t
 
i
 = 
	`cf_sw­_to_Ë64
(*(ušt64_t*)&
d
);

94  *(*)&
i
;

95 
	}
}

97 
šlše
 

98 
	$cf_sw­_äom_big_æßt64
(
d
)

100 
ušt64_t
 
i
 = 
	`cf_sw­_äom_be64
(*(ušt64_t*)&
d
);

101  *(*)&
i
;

102 
	}
}

104 
šlše
 

105 
	$cf_sw­_äom_l™e_æßt64
(
d
)

107 
ušt64_t
 
i
 = 
	`cf_sw­_äom_Ë64
(*(ušt64_t*)&
d
);

108  *(*)&
i
;

109 
	}
}

	@application/kvbench/include/citrusleaf/cf_clock.h

17 #´agm¨
Úû


19 
	~<c™ru¦—f/cf_©omic.h
>

21 #ifdeà
__lšux__


22 
	~<time.h
>

25 #ifdeà
__APPLE__


26 
	~<sys/time.h
>

29 #ifdeà
CF_WINDOWS


30 
	~<c™ru¦—f/cf_şock_wš.h
>

33 #ifdeà
__ılu¥lus


41 
ušt64_t
 
	tcf_şock
;

42 
cf_©omic64
 
	tcf_©omic_şock
;

44 
	#CITRUSLEAF_EPOCH
 1262304000

	)

45 
	#CITRUSLEAF_EPOCH_MS
 (
CITRUSLEAF_EPOCH
 * 1000UL)

	)

46 
	#CITRUSLEAF_EPOCH_US
 (
CITRUSLEAF_EPOCH
 * 1000000UL)

	)

47 
	#CITRUSLEAF_EPOCH_NS
 (
CITRUSLEAF_EPOCH
 * 1000000000UL)

	)

53 
cf_şock
 
cf_g‘ms
();

54 
cf_şock
 
cf_g‘miüos
();

55 
cf_şock
 
cf_g‘us
();

56 
cf_şock
 
cf_g‘ns
();

57 
cf_şock
 
cf_şock_g‘absŞu‹
();

58 
cf_şock
 
cf_g‘_£cÚds
();

59 
cf_şock
 
cf_£cs_sšû_ş•och
();

60 
cf_£t_wa™_time¥ec
(
ms_wa™
, 
time¥ec
* 
out
);

61 
cf_şock_cu¼’t_add
(
time¥ec
* 
d–
, time¥ec* 
out
);

67 
šlše
 
cf_şock_£t_time¥ec_ms
(
ms
, 
time¥ec
* 
out
)

69 
out
->
tv_£c
 = 
ms
 / 1000;

70 
out
->
tv_n£c
 = (
ms
 % 1000) * 1000 * 1000;

73 
šlše
 
cf_şock
 
CF_TIMESPEC_TO_MS_P
Ğ
time¥ec
 *
ts
 ) {

74 
ušt64_t
 
r1
 = 
ts
->
tv_n£c
;

75 
r1
 /= 1000000;

76 
ušt64_t
 
r2
 = 
ts
->
tv_£c
;

77 
r2
 *= 1000;

78 Ğ
r1
 + 
r2
 );

81 
šlše
 
cf_şock
 
CF_TIMESPEC_TO_MS
Ğ
time¥ec
 
ts
 ) {

82 
ušt64_t
 
r1
 = 
ts
.
tv_n£c
;

83 
r1
 /= 1000000;

84 
ušt64_t
 
r2
 = 
ts
.
tv_£c
;

85 
r2
 *= 1000;

86  ( 
r1
 + 
r2
 );

89 
šlše
 
cf_şock
 
CF_TIMESPEC_TO_US
Ğ
time¥ec
 
ts
 ) {

90 
ušt64_t
 
r1
 = 
ts
.
tv_n£c
;

91 
r1
 /= 1000;

92 
ušt64_t
 
r2
 = 
ts
.
tv_£c
;

93 
r2
 *= 1000000;

94  ( 
r1
 + 
r2
 );

97 
šlše
 
cf_şock
 
CF_TIMESPEC_TO_NS
Ğ
time¥ec
 
ts
 ) {

98  (
ušt64_t
)
ts
.
tv_n£c
 + ((ušt64_tés.
tv_£c
 * 1000000000);

101 
šlše
 
CF_TIMESPEC_ADD_MS
(
time¥ec
 *
ts
, 
ušt32_t
 
ms
) {

102 
ts
->
tv_£c
 +ğ
ms
 / 1000;

103 
ts
->
tv_n£c
 +ğ(
ms
 % 1000) * 1000000;

104 ià(
ts
->
tv_n£c
 > 1000000000) {

105 
ts
->
tv_£c
 ++;

106 
ts
->
tv_n£c
 -= 1000000000;

110 
šlše
 
ušt32_t
 
cf_ş•och_£cÚds
() {

111 #ifdeà
__APPLE__


112 
timev®
 
tv
;

113 
g‘timeofday
(&
tv
, 
NULL
);

114  (
ušt32_t
)(
tv
.
tv_£c
 - 
CITRUSLEAF_EPOCH
);

116 
time¥ec
 
ts
;

117 
	`şock_g‘time
(
CLOCK_REALTIME
, &
ts
);

118  (
ušt32_t
)(
ts
.
tv_£c
 - 
CITRUSLEAF_EPOCH
);

122 
šlše
 
ušt64_t
 
	`cf_ş•och_mli£cÚds
() {

123 #ifdeà
__APPLE__


124 
timev®
 
tv
;

125 
	`g‘timeofday
(&
tv
, 
NULL
);

126  (
tv
.
tv_£c
 * 1000è+ (tv.
tv_u£c
 / 1000è- 
CITRUSLEAF_EPOCH_MS
;

128 
time¥ec
 
ts
;

129 
	`şock_g‘time
(
CLOCK_REALTIME
, &
ts
);

130  
	`CF_TIMESPEC_TO_MS
(
ts
è- 
CITRUSLEAF_EPOCH_MS
;

137 
šlše
 
ušt64_t
 
	`cf_ş•och_ns_äom_utc_ns
(ušt64_ˆ
utc_ns
) {

138  
utc_ns
 > 
CITRUSLEAF_EPOCH_NS
 ? utc_ns - CITRUSLEAF_EPOCH_NS : 0;

141 
šlše
 
ušt64_t
 
	`cf_ş•och_us_äom_utc_ns
(ušt64_ˆ
utc_ns
) {

142  
	`cf_ş•och_ns_äom_utc_ns
(
utc_ns
) / 1000;

145 
šlše
 
ušt64_t
 
	`cf_ş•och_ms_äom_utc_ns
(ušt64_ˆ
utc_ns
) {

146  
	`cf_ş•och_ns_äom_utc_ns
(
utc_ns
) / 1000000;

149 
šlše
 
ušt64_t
 
	`cf_ş•och_£c_äom_utc_ns
(ušt64_ˆ
utc_ns
) {

150  
	`cf_ş•och_ns_äom_utc_ns
(
utc_ns
) / 1000000000;

156 
šlše
 
ušt64_t
 
	`cf_utc_ns_äom_ş•och_ns
(ušt64_ˆ
ş•och_ns
) {

157  
CITRUSLEAF_EPOCH_NS
 + 
ş•och_ns
;

160 
šlše
 
ušt64_t
 
	`cf_utc_ns_äom_ş•och_us
(ušt64_ˆ
ş•och_us
) {

161  
CITRUSLEAF_EPOCH_NS
 + (
ş•och_us
 * 1000);

164 
šlše
 
ušt64_t
 
	`cf_utc_ns_äom_ş•och_ms
(ušt64_ˆ
ş•och_ms
) {

165  
CITRUSLEAF_EPOCH_NS
 + (
ş•och_ms
 * 1000000);

168 
šlše
 
ušt64_t
 
	`cf_utc_ns_äom_ş•och_£c
(ušt64_ˆ
ş•och_£c
) {

169  
CITRUSLEAF_EPOCH_NS
 + (
ş•och_£c
 * 1000000000);

173 
šlše
 
ušt32_t
 
	`cf_£rv”_void_time_to_‰l
(ušt32_ˆ
£rv”_void_time
) {

175 ià(
£rv”_void_time
 == 0) {

177  (
ušt32_t
)-1;

180 
ušt32_t
 
now
 = 
	`cf_ş•och_£cÚds
();

186  
£rv”_void_time
 > 
now
 ? server_void_time -‚ow : 1;

191 #ifdeà
__ılu¥lus


192 
	}
}

	@application/kvbench/include/citrusleaf/cf_clock_win.h

17 #´agm¨
Úû


19 
	~<WšSock2.h
>

20 
	~<±h»ad.h
>

22 #ifdeà
__ılu¥lus


26 
	#CLOCK_REALTIME
 0

	)

27 
	#CLOCK_MONOTONIC
 1

	)

28 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

31 
šlše
 
LARGE_INTEGER
 
g‘FILETIMEoff£t
()

33 
SYSTEMTIME
 
s
;

34 
FILETIME
 
f
;

35 
LARGE_INTEGER
 
t
;

37 
s
.
wY—r
 = 1970;

38 
s
.
wMÚth
 = 1;

39 
s
.
wDay
 = 1;

40 
s
.
wHour
 = 0;

41 
s
.
wMšu‹
 = 0;

42 
s
.
wSecÚd
 = 0;

43 
s
.
wMli£cÚds
 = 0;

44 
Sy¡emTimeToFeTime
(&
s
, &
f
);

45 
t
.
QuadP¬t
 = 
f
.
dwHighD©eTime
;

46 
t
.
QuadP¬t
 <<= 32;

47 
t
.
QuadP¬t
 |ğ
f
.
dwLowD©eTime
;

49  (
t
);

52 
šlše
 
şock_g‘time
(
şock_ty³
, 
time¥ec
* 
p_ts
)

54 
LARGE_INTEGER
 
t
;

55 
FILETIME
 
f
;

56 
Çno£cÚds
;

57 
LARGE_INTEGER
 
off£t
;

58 
äequ’cyToNªo£cÚds
;

59 
š™Ÿlized
 = 0;

60 
BOOL
 
u£P”fÜmªûCouÁ”
 = 0;

62 ià(!
š™Ÿlized
) {

63 
LARGE_INTEGER
 
³rfÜmªûF»qu’cy
;

64 
š™Ÿlized
 = 1;

65 
u£P”fÜmªûCouÁ”
 = 
Qu”yP”fÜmªûF»qu’cy
(&
³rfÜmªûF»qu’cy
);

66 ià(
u£P”fÜmªûCouÁ”
) {

67 
Qu”yP”fÜmªûCouÁ”
(&
off£t
);

68 
äequ’cyToNªo£cÚds
 = ()
³rfÜmªûF»qu’cy
.
QuadP¬t
 / 1000000000.;

70 
off£t
 = 
g‘FILETIMEoff£t
();

71 
äequ’cyToNªo£cÚds
 = 10000.;

75 ià(
u£P”fÜmªûCouÁ”
) {

76 
Qu”yP”fÜmªûCouÁ”
(&
t
);

79 
G‘Sy¡emTimeAsFeTime
(&
f
);

80 
t
.
QuadP¬t
 = 
f
.
dwHighD©eTime
;

81 
t
.
QuadP¬t
 <<= 32;

82 
t
.
QuadP¬t
 |ğ
f
.
dwLowD©eTime
;

85 
t
.
QuadP¬t
 -ğ
off£t
.QuadPart;

86 
Çno£cÚds
 = ()
t
.
QuadP¬t
 / 
äequ’cyToNªo£cÚds
;

87 
t
.
QuadP¬t
 = (
LONGLONG
)
Çno£cÚds
;

88 
p_ts
->
tv_£c
 = 
t
.
QuadP¬t
 / 1000000000;

89 
p_ts
->
tv_n£c
 = 
t
.
QuadP¬t
 % 1000000000;

94 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_crypto.h

17 #´agm¨
Úû


19 
	~<¡dšt.h
>

20 
	~<±h»ad.h
>

21 
	~<¡dboŞ.h
>

22 
	~<¡dio.h
>

23 
	~<İ’s¦/sha.h
>

25 #ifdeà
__ılu¥lus


33 
	#CF_SHA_HEX_BUFF_LEN
 (
SHA_DIGEST_LENGTH
*2)

	)

39 
boŞ
 
cf_cÚv”t_sha1_to_hex
(* 
hash
, * 
sha1_hex_buff
);

43 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_digest.h

17 #´agm¨
Úû


19 
	~<¡ddef.h
>

20 
	~<¡dšt.h
>

21 
	~<¡dio.h
>

22 
	~<¡ršg.h
>

23 
	~<İ’s¦/remd.h
>

25 #ifdeà
__APPLE__


29 #´agm¨
GCC
 
dŸgno¡ic
 
push


30 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wdeprecated-declarations"

33 #ifdeà
__ılu¥lus


41 
	#CF_DIGEST_KEY_SZ
 
RIPEMD160_DIGEST_LENGTH


	)

43 
	scf_dige¡_s
 {

44 
ušt8_t
 
dige¡
[
CF_DIGEST_KEY_SZ
];

45 } 
	tcf_dige¡
;

47 cÚ¡ 
cf_dige¡
 
cf_dige¡_z”o
;

53 
šlše
 

54 
cf_dige¡_compu‹
(cÚ¡ *
d©a
, 
size_t
 
Ën
, 
cf_dige¡
 *
d
)

56 
RIPEMD160
((cÚ¡ *)
d©a
, 
Ën
, (*)
d
->
dige¡
);

59 
šlše
 

60 
cf_dige¡_compu‹2
(cÚ¡ *
d©a1
, 
size_t
 
Ën1
, cÚ¡ *
d©a2
, size_ˆ
Ën2
, 
cf_dige¡
 *
d
)

62 ià(
	gËn1
 == 0) {

63 
RIPEMD160
((cÚ¡ *)
d©a2
, 
Ën2
, (*)
d
->
dige¡
);

66 
RIPEMD160_CTX
 
	gc
;

67 
RIPEMD160_In™
(&
c
);

68 
RIPEMD160_Upd©e
(&
c
, 
d©a1
, 
Ën1
);

69 
RIPEMD160_Upd©e
(&
c
, 
d©a2
, 
Ën2
);

70 
RIPEMD160_Fš®
((*)(
d
->
dige¡
), &
c
);

74 
šlše
 

75 
cf_dige¡_com·»
(cÚ¡ 
cf_dige¡
 *
d1
, cÚ¡ cf_dige¡ *
d2
)

77  
memcmp
(
d1
->
dige¡
, 
d2
->dige¡, 
CF_DIGEST_KEY_SZ
);

80 
šlše
 

81 
cf_dige¡_¡ršg
(cÚ¡ 
cf_dige¡
 *
d
, * 
ouut
)

83 * 
	gp
 = 
ouut
;

85 *
	gp
++ = '0';

86 *
	gp
++ = 'x';

88 
	gi
 = 0; i < 
	gCF_DIGEST_KEY_SZ
; i++) {

89 
¥rštf
(
p
, "%02x", 
d
->
dige¡
[
i
]);

90 
	gp
 += 2;

96 #ifdeà
__ılu¥lus


100 #ifdeà
__APPLE__


102 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


	@application/kvbench/include/citrusleaf/cf_hash_math.h

18 #´agm¨
Úû


24 
	~<¡ddef.h
>

25 
	~<¡dšt.h
>

33 
šlše
 
ušt32_t


34 
	$cf_hash_âv32
(cÚ¡ 
ušt8_t
* 
buf
, 
size_t
 
size
)

36 
ušt32_t
 
hash
 = 2166136261;

37 cÚ¡ 
ušt8_t
* 
’d
 = 
buf
 + 
size
;

39 
buf
 < 
’d
) {

40 
hash
 ^ğ(
ušt32_t
)*
buf
++;

41 
hash
 *= 16777619;

44  
hash
;

45 
	}
}

49 
šlše
 
ušt64_t


50 
	$cf_hash_âv64
(cÚ¡ 
ušt8_t
* 
buf
, 
size_t
 
size
)

52 
ušt64_t
 
hash
 = 0xcbf29ce484222325ULL;

53 cÚ¡ 
ušt8_t
* 
’d
 = 
buf
 + 
size
;

55 
buf
 < 
’d
) {

56 
hash
 ^ğ(
ušt64_t
)*
buf
++;

57 
hash
 *= 0x100000001b3ULL;

60  
hash
;

61 
	}
}

65 
šlše
 
ušt32_t


66 
	$cf_hash_j’32
(cÚ¡ 
ušt8_t
* 
buf
, 
size_t
 
size
)

68 
ušt32_t
 
hash
 = 0;

69 cÚ¡ 
ušt8_t
* 
’d
 = 
buf
 + 
size
;

71 
buf
 < 
’d
) {

72 
hash
 +ğ(
ušt32_t
)*
buf
++;

73 
hash
 += hash << 10;

74 
hash
 ^= hash >> 6;

77 
hash
 += hash << 3;

78 
hash
 ^= hash >> 11;

79 
hash
 += hash << 15;

81  
hash
;

82 
	}
}

86 
šlše
 
ušt64_t


87 
	$cf_hash_j’64
(cÚ¡ 
ušt8_t
* 
buf
, 
size_t
 
size
)

89 
ušt64_t
 
hash
 = 0;

90 cÚ¡ 
ušt8_t
* 
’d
 = 
buf
 + 
size
;

92 
buf
 < 
’d
) {

93 
hash
 +ğ(
ušt64_t
)*
buf
++;

94 
hash
 += hash << 10;

95 
hash
 ^= hash >> 6;

98 
hash
 += hash << 3;

99 
hash
 ^= hash >> 11;

100 
hash
 += hash << 15;

102  
hash
;

103 
	}
}

107 
šlše
 
ušt32_t


108 
	$cf_hash_±r32
(cÚ¡ * 
p_±r
)

110  (
ušt32_t
)((*(cÚ¡ 
ušt64_t
*)
p_±r
 * 0xe221f97c30e94e1dULL) >> 32);

111 
	}
}

	@application/kvbench/include/citrusleaf/cf_ll.h

17 #´agm¨
Úû


31 
	~<±h»ad.h
>

32 
	~<š‰y³s.h
>

33 
	~<c™ru¦—f/cf_ty³s.h
>

35 #ifdeà
__ılu¥lus


43 
	#CF_LL_REDUCE_DELETE
 (1)

	)

44 
	#CF_LL_REDUCE_INSERT
 (2)

	)

45 
	#CF_LL_REDUCE_MATCHED
 (3)

	)

46 
	#CF_LL_REDUCE_NOT_MATCHED
 (4)

	)

51 
cf_Î_s
 
	tcf_Î
;

52 
cf_Î_–em’t_s
 
	tcf_Î_–em’t
;

53 
cf_Î_™”©Ü_s
 
	tcf_Î_™”©Ü
;

54 (*
cf_Î_»duû_â
è(
	tcf_Î_–em’t
 * 
	te
, *
	tud©a
);

55 (*
cf_Î_de¡ruùÜ
è(
	tcf_Î_–em’t
 * 
	te
);

62 
	scf_Î_–em’t_s
 {

63 
cf_Î_–em’t
 * 
Ãxt
;

64 
cf_Î_–em’t
 * 
´ev
;

71 
	scf_Î_™”©Ü_s
 {

72 
cf_Î_–em’t
 * 
Ãxt
;

73 
boŞ
 
fÜw¬d
;

79 
	scf_Î_s
 {

80 
cf_Î_–em’t
 * 
h—d
;

81 
cf_Î_–em’t
 * 

;

82 
cf_Î_de¡ruùÜ
 
de¡roy_â
;

83 
ušt32_t
 
sz
;

84 
boŞ
 
u£lock
;

85 
±h»ad_mu‹x_t
 
LOCK
;

92 
šlše
 
cf_Î_–em’t
 *
cf_Î_g‘_h—d
(
cf_Î
 *
Î
) {

93 (
Î
->
h—d
);

96 
šlše
 
cf_Î_–em’t
 *
cf_Î_g‘_
(
cf_Î
 *
Î
) {

97 (
Î
->

);

100 
šlše
 
cf_Î_–em’t
 *
cf_Î_g‘_Ãxt
(cf_Î_–em’ˆ*
e
) {

101 (
e
->
Ãxt
);

104 
šlše
 
cf_Î_–em’t
 *
cf_Î_g‘_´ev
(cf_Î_–em’ˆ*
e
) {

105 (
e
->
´ev
);

115 
cf_Î_´•’d
(
cf_Î
 *
Î
, 
cf_Î_–em’t
 *
e
 );

120 
cf_Î_­³nd
(
cf_Î
 *
Î
, 
cf_Î_–em’t
 *
e
 );

125 
cf_Î_š£¹_aá”
(
cf_Î
 *
Î
, 
cf_Î_–em’t
 *
cur
, cf_Î_–em’ˆ*
šs
);

130 
cf_Î_š£¹_befÜe
(
cf_Î
 *
Î
, 
cf_Î_–em’t
 *
cur
, cf_Î_–em’ˆ*
šs
);

136 
cf_Î_d–‘e
(
cf_Î
 *
Î
, 
cf_Î_–em’t
 *
e
 );

138 
ušt32_t
 
cf_Î_size
(
cf_Î
 *
Î
);

143 
cf_Î_™”©Ü
 * 
cf_Î_g‘I‹¿tÜ
(
cf_Î
 * 
Î
, 
boŞ
 
fÜw¬d
);

148 
cf_Î_–em’t
 * 
cf_Î_g‘Next
(
cf_Î_™”©Ü
 *
™”
);

153 
cf_Î_»Ëa£I‹¿tÜ
(
cf_Î_™”©Ü
 *
™”
);

158 
cf_Î_–em’t
 * 
cf_Î_£¬ch
(
cf_Î
 *
Î
, cf_Î_–em’ˆ*
e
, 
boŞ
 
fÜw¬d
, 
cf_Î_»duû_â
 
â
);

163 
cf_Î_–em’t
 *
cf_Î_šdex
(
cf_Î
 *
Î
, 
šdex
);

173 
cf_Î_»duû
Ğ
cf_Î
 *
Î
, 
boŞ
 
fÜw¬d
, 
cf_Î_»duû_â
 
â
, *
ud©a
);

187 
cf_Î_š£¹_»duû
(
cf_Î
 *
Î
, 
cf_Î_–em’t
 *
e
, 
boŞ
 
fÜw¬d
, 
cf_Î_»duû_â
 
â
, *
ud©a
);

207 
cf_Î_š™
(
cf_Î
 *
Î
, 
cf_Î_de¡ruùÜ
 
de¡roy_â
, 
boŞ
 
u£lock
);

211 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_queue.h

17 #´agm¨
Úû


19 
	~<±h»ad.h
>

20 
	~<c™ru¦—f/cf_ty³s.h
>

22 #ifdeà
__ılu¥lus


30 #iâdeà
CF_QUEUE_ALLOCSZ


31 
	#CF_QUEUE_ALLOCSZ
 64

	)

34 
	#CF_QUEUE_OK
 0

	)

35 
	#CF_QUEUE_ERR
 -1

	)

36 
	#CF_QUEUE_EMPTY
 -2

	)

37 
	#CF_QUEUE_NOMATCH
 -3

38 

	)

42 
	#CF_QUEUE_FOREVER
 -1

	)

43 
	#CF_QUEUE_NOWAIT
 0

	)

44 
	#CF_QUEUE_WAIT_1SEC
 1000

	)

45 
	#CF_QUEUE_WAIT_30SEC
 30000

	)

51 (*
cf_queue_»duû_â
è(*
	tbuf
, *
	tud©a
);

56 
	scf_queue_s
 {

60 
boŞ
 
th»ad§ã
;

61 
boŞ
 
ä“_¡ruù
;

62 
®loc_sz
;

63 
»ad_off£t
;

64 
wr™e_off£t
;

65 
size_t
 
–em’t_sz
;

66 
±h»ad_mu‹x_t
 
LOCK
;

67 
±h»ad_cÚd_t
 
CV
;

68 
ušt8_t
 * 
–em’ts
;

69 } 
	tcf_queue
;

75 
boŞ
 
cf_queue_š™
(
cf_queue
* 
q
, 
size_t
 
–em’t_sz
, 
ušt32_t
 
ÿ·c™y
, boŞ 
th»ad§ã
);

77 
cf_queue
 *
cf_queue_ü—‹
(
size_t
 
–em’t_sz
, 
boŞ
 
th»ad§ã
);

79 
cf_queue_de¡roy
(
cf_queue
 *
q
);

84 
cf_queue_sz
(
cf_queue
 *
q
);

89 
cf_queue_push
(
cf_queue
 *
q
, cÚ¡ *
±r
);

94 
boŞ
 
cf_queue_push_lim™
(
cf_queue
 *
q
, cÚ¡ *
±r
, 
ušt32_t
 
lim™
);

99 
cf_queue_push_unique
(
cf_queue
 *
q
, cÚ¡ *
±r
);

104 
cf_queue_push_h—d
(
cf_queue
 *
q
, cÚ¡ *
±r
);

109 
cf_queue_pİ
(
cf_queue
 *
q
, *
buf
, 
ms_wa™
);

118 
cf_queue_»duû
(
cf_queue
 *
q
, 
cf_queue_»duû_â
 
cb
, *
ud©a
);

128 
cf_queue_»duû_pİ
(
cf_queue
 *
q
, *
buf
, 
ms_wa™
, 
cf_queue_»duû_â
 
cb
, *
ud©a
);

133 
cf_queue_»duû_»v”£
(
cf_queue
 *
q
, 
cf_queue_»duû_â
 
cb
, *
ud©a
);

141 
cf_queue_d–‘e
(
cf_queue
 *
q
, cÚ¡ *
±r
, 
boŞ
 
Úly_Úe
);

146 
cf_queue_d–‘e_®l
(
cf_queue
 *
q
);

148 
cf_queue_d–‘e_off£t
(
cf_queue
 *
q
, 
ušt32_t
 
šdex
);

154 
	#CF_Q_SZ
(
__q
è(__q->
wr™e_off£t
 - __q->
»ad_off£t
)

	)

156 
	#CF_Q_EMPTY
(
__q
è(__q->
wr™e_off£t
 =ğ__q->
»ad_off£t
)

	)

158 
	#CF_Q_ELEM_PTR
(
__q
, 
__i
è(&__q->
–em’ts
[(__˜% __q->
®loc_sz
è* __q->
–em’t_sz
])

	)

162 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_queue_priority.h

17 #´agm¨
Úû


23 
	~"cf_queue.h
"

25 #ifdeà
__ılu¥lus


33 
	#CF_QUEUE_PRIORITY_LOW
 1

	)

34 
	#CF_QUEUE_PRIORITY_MEDIUM
 2

	)

35 
	#CF_QUEUE_PRIORITY_HIGH
 3

	)

41 
	scf_queue_´iÜ™y_s
 {

42 
boŞ
 
th»ad§ã
;

43 
cf_queue
 * 
low_q
;

44 
cf_queue
 * 
medium_q
;

45 
cf_queue
 * 
high_q
;

46 
±h»ad_mu‹x_t
 
LOCK
;

47 
±h»ad_cÚd_t
 
CV
;

48 } 
	tcf_queue_´iÜ™y
;

54 
cf_queue_´iÜ™y
 *
cf_queue_´iÜ™y_ü—‹
(
size_t
 
–em’t_sz
, 
boŞ
 
th»ad§ã
);

55 
cf_queue_´iÜ™y_de¡roy
(
cf_queue_´iÜ™y
 *
q
);

56 
cf_queue_´iÜ™y_sz
(
cf_queue_´iÜ™y
 *
q
);

57 
cf_queue_´iÜ™y_push
(
cf_queue_´iÜ™y
 *
q
, cÚ¡ *
±r
, 
´i
);

58 
cf_queue_´iÜ™y_pİ
(
cf_queue_´iÜ™y
 *
q
, *
buf
, 
mswa™
);

59 
cf_queue_´iÜ™y_»duû_pİ
(
cf_queue_´iÜ™y
 *
´iÜ™y_q
, *
buf
, 
cf_queue_»duû_â
 
cb
, *
ud©a
);

60 
cf_queue_´iÜ™y_chªge
(
cf_queue_´iÜ™y
 *
´iÜ™y_q
, cÚ¡ *
±r
, 
Ãw_´i
);

61 
cf_queue_´iÜ™y_»duû_chªge
(
cf_queue_´iÜ™y
 *
´iÜ™y_q
, 
Ãw_´i
, 
cf_queue_»duû_â
 
cb
, *
ud©a
);

67 
	#CF_Q_PRI_EMPTY
(
__q
è(
	`CF_Q_EMPTY
(__q->
low_q
è&& CF_Q_EMPTY(__q->
medium_q
è&& CF_Q_EMPTY(__q->
high_q
))

	)

71 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_random.h

17 #´agm¨
Úû


19 
	~<š‰y³s.h
>

21 #ifdeà
__ılu¥lus


29 
cf_g‘_¿nd_buf
(
ušt8_t
 *
buf
, 
Ën
);

30 
ušt64_t
 
cf_g‘_¿nd64
();

31 
ušt32_t
 
cf_g‘_¿nd32
();

33 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_rchash.h

18 #´agm¨
Úû


24 
	~<±h»ad.h
>

25 
	~<¡dboŞ.h
>

26 
	~<¡dšt.h
>

28 
	~<c™ru¦—f/cf_©omic.h
>

30 #ifdeà
__ılu¥lus


40 
	#CF_RCHASH_ERR_FOUND
 -4

	)

41 
	#CF_RCHASH_ERR_NOT_FOUND
 -3

	)

42 
	#CF_RCHASH_ERR
 -1

	)

43 
	#CF_RCHASH_OK
 0

	)

44 
	#CF_RCHASH_REDUCE_DELETE
 1

	)

47 
	#CF_RCHASH_BIG_LOCK
 0x01

48 
	#CF_RCHASH_MANY_LOCK
 0x02

49 

	)

51 
ušt32_t
 (*
	tcf_rchash_hash_â
)(cÚ¡ *
	tkey
, 
	tušt32_t
 
	tkey_size
);

59 (*
cf_rchash_»duû_â
)(cÚ¡ *
	tkey
, 
	tušt32_t
 
	tkey_size
, *
	tobjeù
, *
	tud©a
);

67 (*
cf_rchash_de¡ruùÜ_â
)(*
	tobjeù
);

70 
	scf_rchash_s
 {

71 
cf_rchash_hash_â
 
h_â
;

72 
cf_rchash_de¡ruùÜ_â
 
d_â
;

73 
ušt32_t
 
key_size
;

74 
ušt32_t
 
n_buck‘s
;

75 
ušt32_t
 
æags
;

76 
cf_©omic32
 
n_–em’ts
;

77 *
bË
;

78 
±h»ad_mu‹x_t
 *
buck‘_locks
;

79 
±h»ad_mu‹x_t
 
big_lock
;

80 } 
	tcf_rchash
;

87 
ušt32_t
 
cf_rchash_â_u32
(cÚ¡ *
key
, ušt32_ˆ
key_size
);

88 
ušt32_t
 
cf_rchash_â_âv32
(cÚ¡ *
key
, ušt32_ˆ
key_size
);

89 
ušt32_t
 
cf_rchash_â_z¡r
(cÚ¡ *
key
, ušt32_ˆ
key_size
);

96 
cf_rchash_ü—‹
(
cf_rchash
 **
h_r
, 
cf_rchash_hash_â
 
h_â
, 
cf_rchash_de¡ruùÜ_â
 
d_â
, 
ušt32_t
 
key_size
, ušt32_ˆ
n_buck‘s
, ušt32_ˆ
æags
);

97 
cf_rchash_de¡roy
(
cf_rchash
 *
h
);

98 
ušt32_t
 
cf_rchash_g‘_size
(cÚ¡ 
cf_rchash
 *
h
);

100 
cf_rchash_put
(
cf_rchash
 *
h
, cÚ¡ *
key
, 
ušt32_t
 
key_size
, *
objeù
);

101 
cf_rchash_put_unique
(
cf_rchash
 *
h
, cÚ¡ *
key
, 
ušt32_t
 
key_size
, *
objeù
);

103 
cf_rchash_g‘
(
cf_rchash
 *
h
, cÚ¡ *
key
, 
ušt32_t
 
key_size
, **
objeù_r
);

105 
cf_rchash_d–‘e
(
cf_rchash
 *
h
, cÚ¡ *
key
, 
ušt32_t
 
key_size
);

106 
cf_rchash_d–‘e_objeù
(
cf_rchash
 *
h
, cÚ¡ *
key
, 
ušt32_t
 
key_size
, *
objeù
);

108 
cf_rchash_»duû
(
cf_rchash
 *
h
, 
cf_rchash_»duû_â
 
»duû_â
, *
ud©a
);

111 #ifdeà
__ılu¥lus


	@application/kvbench/include/citrusleaf/cf_types.h

17 #´agm¨
Úû


19 
	~<š‰y³s.h
>

21 #iâdeà
CF_WINDOWS


26 
	~<¡dboŞ.h
>

27 
	~<®loÿ.h
>

34 
	~<m®loc.h
>

36 
	#PRIu64
 "I64u"

	)

37 
	#PRId64
 "I64d"

	)

	@application/kvbench/include/citrusleaf/cf_vector.h

17 #´agm¨
Úû


23 
	~<±h»ad.h
>

24 
	~<¡dšt.h
>

26 
	~<c™ru¦—f/cf_ty³s.h
>

28 #ifdeà
__ılu¥lus


38 
	#VECTOR_ELEM_SZ
(
_v
èĞ_v->
–e_sz
 )

	)

41 
	#VECTOR_FLAG_BIGLOCK
 0x01

	)

42 
	#VECTOR_FLAG_INITZERO
 0x02

43 

	)

45 
	#VECTOR_REDUCE_DELETE
 1

	)

48 
	scf_veùÜ_s
 {

49 
ušt8_t
 *
veùÜ
;

50 
ušt32_t
 
–e_sz
;

51 
ušt32_t
 
ÿ·c™y
;

52 
ušt32_t
 
couÁ
;

53 
ušt32_t
 
æags
;

54 
±h»ad_mu‹x_t
 
LOCK
;

55 } 
	tcf_veùÜ
;

62 
cf_veùÜ
 *
cf_veùÜ_ü—‹
(
ušt32_t
 
–e_sz
, ušt32_ˆ
ÿ·c™y
, ušt32_ˆ
æags
);

63 
cf_veùÜ_š™
(
cf_veùÜ
 *
v
, 
ušt32_t
 
–e_sz
, ušt32_ˆ
ÿ·c™y
, ušt32_ˆ
æags
);

64 
cf_veùÜ_š™_w™h_buf
(
cf_veùÜ
 *
v
, 
ušt32_t
 
–e_sz
, ušt32_ˆ
ÿ·c™y
, 
ušt8_t
 *
buf
, ušt32_ˆ
æags
);

67 
cf_veùÜ_š™_sm®loc
(
cf_veùÜ
 *
v
, 
ušt32_t
 
–e_sz
, 
ušt8_t
 *
sbuf
, ušt32_ˆ
sbuf_sz
, ušt32_ˆ
æags
);

69 
cf_veùÜ_g‘
(cÚ¡ 
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
, *
v®
);

70 
boŞ
 
cf_veùÜ_g‘_sized
(cÚ¡ 
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
, *
v®
, ušt32_ˆ
sz
);

71 
cf_veùÜ_£t
(
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
, cÚ¡ *
v®
);

73 *
cf_veùÜ_g‘p
(
cf_veùÜ
 *
v
, 
ušt32_t
 
v®
);

74 *
cf_veùÜ_g‘p_vlock
(
cf_veùÜ
 *
v
, 
ušt32_t
 
v®
, 
±h»ad_mu‹x_t
 **
vlock
);

76 
cf_veùÜ_­³nd
(
cf_veùÜ
 *
v
, cÚ¡ *
v®
);

78 
cf_veùÜ_­³nd_unique
(
cf_veùÜ
 *
v
, cÚ¡ *
v®
);

79 
cf_veùÜ_pİ
(
cf_veùÜ
 *
v
, *
v®
);

81 
cf_veùÜ_d–‘e
(
cf_veùÜ
 *
v
, 
ušt32_t
 
v®
);

83 
cf_veùÜ_d–‘e_¿nge
(
cf_veùÜ
 *
v
, 
ušt32_t
 
¡¬t
, ušt32_ˆ
’d
);

84 
cf_veùÜ_ş—r
(
cf_veùÜ
 *
v
);

87 
cf_veùÜ_com·ù
(
cf_veùÜ
 *
v
);

89 
cf_veùÜ_de¡roy
(
cf_veùÜ
 *
v
);

91 
šlše
 
ušt32_t


92 
cf_veùÜ_size
(cÚ¡ 
cf_veùÜ
 *
v
)

94  
v
->
couÁ
;

97 
šlše
 
ušt32_t


98 
cf_veùÜ_–em’t_size
(cÚ¡ 
cf_veùÜ
 *
v
)

100  
v
->
–e_sz
;

103 
	#cf_veùÜ_š™a
(
_v
, 
_–e_sz
, 
_–e_út
, 
_æags
) \

104 
	`cf_veùÜ_š™_w™h_buf
(
_v
, 
_–e_sz
, 
_–e_út
, 
	`®loÿ
((_–e_szè* (_–e_út)), 
_æags
);

	)

106 
	#cf_veùÜ_defše
(
_v
, 
_–e_sz
, 
_–e_út
, 
_æags
) \

107 
cf_veùÜ
 
_v
; \

108 
ušt8_t
 
_v
 ## 
__mem
[(
_–e_sz
è* (
_–e_út
)]; \

109 
	`cf_veùÜ_š™_w™h_buf
(&
_v
, 
_–e_sz
, 
_–e_út
, _v ## 
__mem
, 
_æags
);

	)

116 
šlše
 
cf_veùÜ
 *

117 
cf_veùÜ_poš‹r_ü—‹
(
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
æags
)

119  
cf_veùÜ_ü—‹
((*), 
ÿ·c™y
, 
æags
);

123 
šlše
 

124 
cf_veùÜ_poš‹r_š™
(
cf_veùÜ
 *
v
, 
ušt32_t
 
ÿ·c™y
, ušt32_ˆ
æags
)

126  
cf_veùÜ_š™
(
v
, (*), 
ÿ·c™y
, 
æags
);

130 
šlše
 

131 
cf_veùÜ_poš‹r_£t
(
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
, cÚ¡ *
v®
)

133  
cf_veùÜ_£t
(
v
, 
idx
, &
v®
);

137 
šlše
 *

138 
cf_veùÜ_poš‹r_g‘
(cÚ¡ 
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
)

140 *
p
;

142 ià(! 
cf_veùÜ_g‘_sized
(
v
, 
idx
, &
p
, (*))) {

143  
NULL
;

146  
p
;

150 
šlše
 

151 
cf_veùÜ_poš‹r_­³nd
(
cf_veùÜ
 *
v
, cÚ¡ *
v®
)

153  
cf_veùÜ_­³nd
(
v
, &
v®
);

160 
šlše
 

161 
cf_veùÜ_£t_±r
(
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
, cÚ¡ *
v®
)

163  
cf_veùÜ_£t
(
v
, 
idx
, &
v®
);

166 
šlše
 *

167 
cf_veùÜ_g‘_±r
(cÚ¡ 
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
)

169 *
p
 = 
NULL
;

171 
cf_veùÜ_g‘_sized
(
v
, 
idx
, &
p
, (*));

173  
p
;

176 
šlše
 

177 
cf_veùÜ_­³nd_±r
(
cf_veùÜ
 *
v
, cÚ¡ *
v®
)

179  
cf_veùÜ_­³nd
(
v
, &
v®
);

186 
šlše
 

187 
cf_veùÜ_£t_ušt32
(
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
, ušt32_ˆ
v®
)

189  
cf_veùÜ_£t
(
v
, 
idx
, &
v®
);

192 
šlše
 
ušt32_t


193 
cf_veùÜ_g‘_ušt32
(cÚ¡ 
cf_veùÜ
 *
v
, 
ušt32_t
 
idx
)

195 
ušt32_t
 
v®
 = 0;

197 
cf_veùÜ_g‘_sized
(
v
, 
idx
, &
v®
, (
ušt32_t
));

199  
v®
;

202 
šlše
 

203 
cf_veùÜ_­³nd_ušt32
(
cf_veùÜ
 *
v
, 
ušt32_t
 
v®
)

205  
cf_veùÜ_­³nd
(
v
, &
v®
);

209 #ifdeà
__ılu¥lus


	@application/kvbench/include/libcouchstore/couch_common.h

2 #iâdeà
COUCH_COMMON_H


3 
	#COUCH_COMMON_H


	)

4 
	~<sys/ty³s.h
>

5 
	~<fú.h
>

6 
	~<¡dšt.h
>

8 
	~<libcouch¡Üe/visib™y.h
>

10 #ifdeà
__ılu¥lus


32 
št64_t
 
	tcs_off_t
;

35 
ušt8_t
 
	tcouch¡Üe_cÚ‹Á_m‘a_æags
;

37 
COUCH_DOC_IS_COMPRESSED
 = 128,

39 
COUCH_DOC_IS_JSON
 = 0,

40 
COUCH_DOC_INVALID_JSON
 = 1,

41 
COUCH_DOC_INVALID_JSON_KEY
 = 2,

43 
COUCH_DOC_NON_JSON_MODE
 = 3

47 #ifdeà
POSIX_FADV_NORMAL


49 
COUCHSTORE_FILE_ADVICE_EVICT
 = 
POSIX_FADV_DONTNEED


52 
COUCHSTORE_FILE_ADVICE_EVICT


54 } 
	tcouch¡Üe_fe_adviû_t
;

57 
	s_sized_buf
 {

58 *
buf
;

59 
size_t
 
size
;

60 } 
	tsized_buf
;

63 
	s_doc
 {

64 
sized_buf
 
id
;

65 
sized_buf
 
d©a
;

66 } 
	tDoc
;

69 
	s_docšfo
 {

70 
sized_buf
 
id
;

71 
ušt64_t
 
db_£q
;

72 
ušt64_t
 
»v_£q
;

73 
sized_buf
 
»v_m‘a
;

75 
d–‘ed
;

76 
couch¡Üe_cÚ‹Á_m‘a_æags
 
cÚ‹Á_m‘a
;

77 
ušt64_t
 
bp
;

78 
size_t
 
size
;

79 } 
	tDocInfo
;

81 
	#DOC_INFO_INITIALIZER
 { {0, 0}, 0, 0, {0, 0}, 0, 0, 0, 0 }

	)

84 
	s_loÿl_doc
 {

85 
sized_buf
 
id
;

86 
sized_buf
 
jsÚ
;

87 
d–‘ed
;

88 } 
	tLoÿlDoc
;

92 cÚ¡ * 
f’ame
;

93 
ušt64_t
 
Ï¡_£qu’û
;

94 
ušt64_t
 
doc_couÁ
;

95 
ušt64_t
 
d–‘ed_couÁ
;

96 
ušt64_t
 
¥aû_u£d
;

97 
ušt64_t
 
fe_size
;

98 
cs_off_t
 
h—d”_pos™iÚ
;

99 
ušt64_t
 
purge_£q
;

100 } 
	tDbInfo
;

104 
_db
 
	tDb
;

106 #ifdeà
__ılu¥lus


	@application/kvbench/include/libcouchstore/couch_db.h

2 #iâdeà
COUCHSTORE_COUCH_DB_H


3 
	#COUCHSTORE_COUCH_DB_H


	)

5 
	~"couch_commÚ.h
"

6 #ià
defšed
 
__BLOBFS_ROCKS_BENCH


7 
	~"rocksdb/’v.h
"

8 
	~"rocksdb/db.h
"

11 
	~<libcouch¡Üe/”rÜ.h
>

12 
	~<libcouch¡Üe/fe_İs.h
>

14 
	~<©omic
>

15 
¡d
::
©omic_ušt_ç¡64_t
 
com¶‘ed
;

17 #ifdeà
__ılu¥lus


29 
ušt64_t
 
	tcouch¡Üe_İ’_æags
;

34 
COUCHSTORE_OPEN_FLAG_CREATE
 = 1,

38 
COUCHSTORE_OPEN_FLAG_RDONLY
 = 2,

46 
COUCHSTORE_OPEN_WITH_LEGACY_CRC
 = 4,

55 
COUCHSTORE_OPEN_FLAG_UNBUFFERED
 = 8,

60 
COUCHSTORE_OPEN_FLAG_KVS
 = 16,

77 
LIBCOUCHSTORE_API


78 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_db
(cÚ¡ *
f’ame
,

79 
couch¡Üe_İ’_æags
 
æags
,

80 
Db
 **
db
);

88 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_db_kvs
(cÚ¡ * 
dev_·th
, 
Db
 **
db
, 
id
);

113 
LIBCOUCHSTORE_API


114 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_db_ex
(cÚ¡ *
f’ame
,

115 
couch¡Üe_İ’_æags
 
æags
,

116 
FeOpsIÁ”çû
* 
İs
,

117 
Db
 **
db
);

128 
LIBCOUCHSTORE_API


129 
couch¡Üe_”rÜ_t
 
couch¡Üe_ä“_db
(
Db
* 
db
);

142 
LIBCOUCHSTORE_API


143 
couch¡Üe_”rÜ_t
 
couch¡Üe_şo£_fe
(
Db
* 
db
);

154 
LIBCOUCHSTORE_API


155 
couch¡Üe_”rÜ_t
 
couch¡Üe_»wšd_db_h—d”
(
Db
 *
db
);

160 
LIBCOUCHSTORE_API


161 
FeOpsIÁ”çû
* 
couch¡Üe_g‘_deçuÉ_fe_İs
();

170 
LIBCOUCHSTORE_API


171 
couch¡Üe_”rÜ_t
 
couch¡Üe_db_šfo
(
Db
 *
db
, 
DbInfo
* 
šfo
);

181 
LIBCOUCHSTORE_API


182 cÚ¡ * 
couch¡Üe_g‘_db_f’ame
(
Db
 *
db
);

188 
LIBCOUCHSTORE_API


189 
ušt64_t
 
couch¡Üe_g‘_h—d”_pos™iÚ
(
Db
 *
db
);

198 
ušt64_t
 
	tcouch¡Üe_§ve_İtiÚs
;

206 
COMPRESS_DOC_BODIES
 = 1,

214 
COUCHSTORE_SEQUENCE_AS_IS
 = 2

234 
LIBCOUCHSTORE_API


235 
couch¡Üe_”rÜ_t
 
couch¡Üe_§ve_docum’t
(
Db
 *
db
,

236 cÚ¡ 
Doc
 *
doc
,

237 
DocInfo
 *
šfo
,

238 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
);

257 
LIBCOUCHSTORE_API


258 
couch¡Üe_”rÜ_t
 
couch¡Üe_§ve_docum’ts
(
Db
 *
db
,

259 
Doc
* cÚ¡ 
docs
[],

260 
DocInfo
 *
šfos
[],

261 
numDocs
,

262 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
);

269 
LIBCOUCHSTORE_API


270 
couch¡Üe_”rÜ_t
 
couch¡Üe_comm™
(
Db
 *
db
);

285 
LIBCOUCHSTORE_API


286 
couch¡Üe_”rÜ_t
 
couch¡Üe_docšfo_by_id
(
Db
 *
db
,

287 cÚ¡ *
id
,

288 
size_t
 
idËn
,

289 
DocInfo
 **
pInfo
);

300 
LIBCOUCHSTORE_API


301 
couch¡Üe_”rÜ_t
 
couch¡Üe_docšfo_by_£qu’û
(
Db
 *
db
,

302 
ušt64_t
 
£qu’û
,

303 
DocInfo
 **
pInfo
);

306 
ušt64_t
 
	tcouch¡Üe_İ’_İtiÚs
;

312 
DECOMPRESS_DOC_BODIES
 = 1

330 
LIBCOUCHSTORE_API


331 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_docum’t
(
Db
 *
db
,

332 cÚ¡ *
id
,

333 
size_t
 
idËn
,

334 
Doc
 **
pDoc
,

335 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
);

337 
LIBCOUCHSTORE_API


338 
couch¡Üe_”rÜ_t
 
couch¡Üe_d–‘e_docum’t
(
Db
 *
db
,

339 cÚ¡ *
id
,

340 
size_t
 
idËn
,

341 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
);

356 
LIBCOUCHSTORE_API


357 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_doc_w™h_docšfo
(
Db
 *
db
,

358 
DocInfo
 *
docšfo
,

359 
Doc
 **
pDoc
,

360 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
);

368 
LIBCOUCHSTORE_API


369 
couch¡Üe_ä“_docum’t
(
Doc
 *
doc
);

383 
LIBCOUCHSTORE_API


384 
DocInfo
* 
couch¡Üe_®loc_docšfo
(cÚ¡ 
sized_buf
 *
id
,

385 cÚ¡ 
sized_buf
 *
»v_m‘a
);

394 
LIBCOUCHSTORE_API


395 
couch¡Üe_ä“_docšfo
(
DocInfo
 *
docšfo
);

415 (*
couch¡Üe_chªges_ÿÎback_â
)(
	tDb
 *
	tdb
,

416 
	tDocInfo
 *
	tdocšfo
,

417 *
	tùx
);

420 
ušt64_t
 
	tcouch¡Üe_docšfos_İtiÚs
;

425 
RANGES
 = 1,

429 
COUCHSTORE_DELETES_ONLY
 = 2,

433 
COUCHSTORE_NO_DELETES
 = 4

446 
LIBCOUCHSTORE_API


447 
couch¡Üe_”rÜ_t
 
couch¡Üe_chªges_sšû
(
Db
 *
db
,

448 
ušt64_t
 
sšû
,

449 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

450 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
,

451 *
ùx
);

463 
LIBCOUCHSTORE_API


464 
couch¡Üe_”rÜ_t
 
couch¡Üe_®l_docs
(
Db
 *
db
,

465 cÚ¡ 
sized_buf
* 
¡¬tKeyPŒ
,

466 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

467 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
,

468 *
ùx
);

491 
LIBCOUCHSTORE_API


492 
couch¡Üe_”rÜ_t
 
couch¡Üe_docšfos_by_£qu’û
(
Db
 *
db
,

493 cÚ¡ 
ušt64_t
 
£qu’û
[],

494 
numDocs
,

495 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

496 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
,

497 *
ùx
);

520 
LIBCOUCHSTORE_API


521 
couch¡Üe_”rÜ_t
 
couch¡Üe_docšfos_by_id
(
Db
 *
db
,

522 cÚ¡ 
sized_buf
 
ids
[],

523 
numDocs
,

524 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

525 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
,

526 *
ùx
);

552 (*
couch¡Üe_w®k_Œ“_ÿÎback_â
)(
	tDb
 *
	tdb
,

553 
	td•th
,

554 cÚ¡ 
	tDocInfo
* 
	tdoc_šfo
,

555 
	tušt64_t
 
	tsubŒ“_size
,

556 cÚ¡ 
	tsized_buf
* 
	t»duû_v®ue
,

557 *
	tùx
);

575 
LIBCOUCHSTORE_API


576 
couch¡Üe_”rÜ_t
 
couch¡Üe_w®k_id_Œ“
(
Db
 *
db
,

577 cÚ¡ 
sized_buf
* 
¡¬tDocID
,

578 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

579 
couch¡Üe_w®k_Œ“_ÿÎback_â
 
ÿÎback
,

580 *
ùx
);

598 
LIBCOUCHSTORE_API


599 
couch¡Üe_”rÜ_t
 
couch¡Üe_w®k_£q_Œ“
(
Db
 *
db
,

600 
ušt64_t
 
¡¬tSequ’û
,

601 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

602 
couch¡Üe_w®k_Œ“_ÿÎback_â
 
ÿÎback
,

603 *
ùx
);

618 
LIBCOUCHSTORE_API


619 
couch¡Üe_”rÜ_t
 
couch¡Üe_İ’_loÿl_docum’t
(
Db
 *
db
,

620 cÚ¡ *
id
,

621 
size_t
 
idËn
,

622 
LoÿlDoc
 **
lDoc
);

633 
LIBCOUCHSTORE_API


634 
couch¡Üe_”rÜ_t
 
couch¡Üe_§ve_loÿl_docum’t
(
Db
 *
db
, 
LoÿlDoc
 *
lDoc
);

642 
LIBCOUCHSTORE_API


643 
couch¡Üe_ä“_loÿl_docum’t
(
LoÿlDoc
 *
lDoc
);

657 
LIBCOUCHSTORE_API


658 
couch¡Üe_”rÜ_t
 
couch¡Üe_com·ù_db
(
Db
* 
sourû
, cÚ¡ * 
rg‘_f’ame
);

664 
ušt64_t
 
	tcouch¡Üe_com·ù_æags
;

669 
COUCHSTORE_COMPACT_FLAG_DROP_DELETES
 = 1,

676 
COUCHSTORE_COMPACT_FLAG_UPGRADE_DB
 = 2,

686 
COUCHSTORE_COMPACT_FLAG_UNBUFFERED
 = 4,

702 
COUCHSTORE_COMPACT_KEEP_ITEM
 = 0,

703 
COUCHSTORE_COMPACT_DROP_ITEM
 = 1

706 (*
couch¡Üe_com·ù_hook
)(
	tDb
* 
	trg‘
,

707 
	tDocInfo
 *
	tdocšfo
,

708 *
	tùx
);

710 (*
couch¡Üe_docšfo_hook
)(
	tDocInfo
 **
	tdocšfo
,

711 cÚ¡ 
	tsized_buf
 *
	t™em
);

721 
LIBCOUCHSTORE_API


722 
couch¡Üe_”rÜ_t
 
couch¡Üe_£t_purge_£q
(
Db
* 
rg‘
, 
ušt64_t
 
purge_£q
);

739 
LIBCOUCHSTORE_API


740 
couch¡Üe_”rÜ_t
 
couch¡Üe_com·ù_db_ex
(
Db
* 
sourû
, cÚ¡ * 
rg‘_f’ame
, 
ušt64_t
 
æags
,

741 
couch¡Üe_com·ù_hook
 
hook
,

742 
couch¡Üe_docšfo_hook
 
dhook
, * 
hook_ùx
,

743 
FeOpsIÁ”çû
* 
İs
);

756 
LIBCOUCHSTORE_API


757 cÚ¡ *
couch¡Üe_¡»¼Ü
(
couch¡Üe_”rÜ_t
 
”rcode
);

766 
LIBCOUCHSTORE_API


767 
couch¡Üe_”rÜ_t
 
couch¡Üe_Ï¡_os_”rÜ
(cÚ¡ 
Db
 *
db
,

768 * 
buf
,

769 
size_t
 
size
);

780 
LIBCOUCHSTORE_API


781 
couch¡Üe_”rÜ_t
 
couch¡Üe_chªges_couÁ
(
Db
* 
db
,

782 
ušt64_t
 
mš_£q
,

783 
ušt64_t
 
max_£q
,

784 
ušt64_t
 *
couÁ
);

786 #ifdeà
__ılu¥lus


	@application/kvbench/include/libcouchstore/couch_index.h

2 #iâdeà
COUCHSTORE_COUCH_INDEX_H


3 
	#COUCHSTORE_COUCH_INDEX_H


	)

5 
	~<libcouch¡Üe/couch_db.h
>

7 #ifdeà
__ılu¥lus


14 
_CouchStÜeIndex
 
	tCouchStÜeIndex
;

19 
ušt64_t
 
	tcouch¡Üe_šdex_ty³
;

21 
COUCHSTORE_VIEW_PRIMARY_INDEX
 = 0,

22 
COUCHSTORE_VIEW_BACK_INDEX
 = 1,

29 
ušt64_t
 
	tcouch¡Üe_jsÚ_»duûr
;

31 
COUCHSTORE_REDUCE_NONE
 = 0,

32 
COUCHSTORE_REDUCE_COUNT
 = 1,

33 
COUCHSTORE_REDUCE_SUM
 = 2,

34 
COUCHSTORE_REDUCE_STATS
 = 3,

49 
LIBCOUCHSTORE_API


50 
couch¡Üe_”rÜ_t
 
couch¡Üe_ü—‹_šdex
(cÚ¡ *
f’ame
,

51 
CouchStÜeIndex
** 
šdex
);

59 
LIBCOUCHSTORE_API


60 
couch¡Üe_”rÜ_t
 
couch¡Üe_şo£_šdex
(
CouchStÜeIndex
* 
šdex
);

82 
LIBCOUCHSTORE_API


83 
couch¡Üe_”rÜ_t
 
couch¡Üe_šdex_add
(cÚ¡ *
šputP©h
,

84 
couch¡Üe_šdex_ty³
 
šdex_ty³
,

85 
couch¡Üe_jsÚ_»duûr
 
»duû_funùiÚ
,

86 
CouchStÜeIndex
* 
šdex
);

88 #ifdeà
__ılu¥lus


	@application/kvbench/include/libcouchstore/error.h

2 #iâdeà
LIBCOUCHSTORE_ERROR_H


3 
	#LIBCOUCHSTORE_ERROR_H
 1

	)

5 #iâdeà
COUCHSTORE_COUCH_DB_H


9 #ifdeà
__ılu¥lus


15 
COUCHSTORE_SUCCESS
 = 0,

16 
COUCHSTORE_ERROR_OPEN_FILE
 = -1,

17 
COUCHSTORE_ERROR_CORRUPT
 = -2,

18 
COUCHSTORE_ERROR_ALLOC_FAIL
 = -3,

19 
COUCHSTORE_ERROR_READ
 = -4,

20 
COUCHSTORE_ERROR_DOC_NOT_FOUND
 = -5,

21 
COUCHSTORE_ERROR_NO_HEADER
 = -6,

22 
COUCHSTORE_ERROR_WRITE
 = -7,

23 
COUCHSTORE_ERROR_HEADER_VERSION
 = -8,

24 
COUCHSTORE_ERROR_CHECKSUM_FAIL
 = -9,

25 
COUCHSTORE_ERROR_INVALID_ARGUMENTS
 = -10,

26 
COUCHSTORE_ERROR_NO_SUCH_FILE
 = -11,

27 
COUCHSTORE_ERROR_CANCEL
 = -12,

28 
COUCHSTORE_ERROR_REDUCTION_TOO_LARGE
 = -13,

29 
COUCHSTORE_ERROR_REDUCER_FAILURE
 = -14,

30 
COUCHSTORE_ERROR_FILE_CLOSED
 = -15,

31 
COUCHSTORE_ERROR_DB_NO_LONGER_VALID
 = -16,

32 
COUCHSTORE_ERROR_FILE_CLOSE
 = -17,

33 } 
	tcouch¡Üe_”rÜ_t
;

35 #ifdeà
__ılu¥lus


	@application/kvbench/include/libcouchstore/file_ops.h

18 #iâdeà
LIBCOUCHSTORE_FILE_OPS_H


19 
	#LIBCOUCHSTORE_FILE_OPS_H


	)

21 
	~<¡dšt.h
>

22 
	~<sys/ty³s.h
>

23 
	~"couch_commÚ.h
"

30 
couch_fe_hªdË_İaque
* 
	tcouch_fe_hªdË
;

33 #ifdeà
WIN32


34 
DWORD
 
	m”rÜ
;

36 
	m”rÜ
;

38 } 
	tcouch¡Üe_”rÜ_šfo_t
;

42 #ifdeà
__ılu¥lus


47 şas 
	cFeOpsIÁ”çû
 {

48 
	mpublic
:

52 
vœtu®
 ~
	$FeOpsIÁ”çû
() {}

64 
vœtu®
 
couch_fe_hªdË
 
	`cÚ¡ruùÜ
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
) = 0;

78 
vœtu®
 
couch¡Üe_”rÜ_t
 
	`İ’
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

79 
couch_fe_hªdË
* 
hªdË
, cÚ¡ * 
·th
,

80 
oæag
) = 0;

89 
vœtu®
 
couch¡Üe_”rÜ_t
 
	`şo£
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

90 
couch_fe_hªdË
 
hªdË
) = 0;

102 
vœtu®
 
ssize_t
 
	`´—d
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

103 
couch_fe_hªdË
 
hªdË
, * 
buf
, 
size_t
 
nby‹s
,

104 
cs_off_t
 
off£t
) = 0;

116 
vœtu®
 
ssize_t
 
	`pwr™e
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

117 
couch_fe_hªdË
 
hªdË
, cÚ¡ * 
buf
,

118 
size_t
 
nby‹s
, 
cs_off_t
 
off£t
) = 0;

127 
vœtu®
 
cs_off_t
 
	`gÙo_eof
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

128 
couch_fe_hªdË
 
hªdË
) = 0;

136 
vœtu®
 
couch¡Üe_”rÜ_t
 
	`sync
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

137 
couch_fe_hªdË
 
hªdË
) = 0;

147 
vœtu®
 
couch¡Üe_”rÜ_t
 
	`advi£
(
couch¡Üe_”rÜ_šfo_t
* 
”ršfo
,

148 
couch_fe_hªdË
 
hªdË
, 
cs_off_t
 
off£t
,

149 
cs_off_t
 
Ën
,

150 
couch¡Üe_fe_adviû_t
 
adviû
) = 0;

158 
vœtu®
 
	`de¡ruùÜ
(
couch_fe_hªdË
 
hªdË
) = 0;

159 
	}
};

165 
couch_fe_İs_İaque
* 
	tFeOpsIÁ”çû
;

	@application/kvbench/include/libcouchstore/visibility.h

2 #iâdeà
LIBCOUCHSTORE_VISIBILITY_H


3 
	#LIBCOUCHSTORE_VISIBILITY_H


	)

5 #ià
defšed
(
LIBCOUCHSTORE_INTERNAL
)

7 #ià
defšed
 (
__SUNPRO_C
) && (__SUNPRO_C >= 0x550)

8 
	#LIBCOUCHSTORE_API
 
__glob®


	)

9 #–ià
defšed
 
__GNUC__


10 
	#LIBCOUCHSTORE_API
 
	`__©Œibu‹__
 ((
	`visib™y
("deçuÉ")))

	)

11 #–ià
defšed
(
_MSC_VER
)

12 
	#LIBCOUCHSTORE_API
 
	`__deş¥ec
(
dÎexpÜt
)

	)

14 
	#LIBCOUCHSTORE_API


	)

19 #ià
defšed
(
_MSC_VER
è&& !defšed(
LIBCOUCHSTORE_NO_VISIBILITY
)

20 
	#LIBCOUCHSTORE_API
 
	`__deş¥ec
(
dÎimpÜt
)

	)

22 
	#LIBCOUCHSTORE_API


	)

28 #ià
defšed
(
TESTAPP
)

29 
	#STATIC


	)

31 
	#STATIC
 

	)

	@application/kvbench/include/thpool.h

7 #iâdeà
_THPOOL_


8 
	#_THPOOL_


	)

10 #ifdeà
__ılu¥lus


17 
thpoŞ_
* 
	tth»adpoŞ
;

37 
th»adpoŞ
 
thpoŞ_š™
(
num_th»ads
);

67 
thpoŞ_add_wÜk
(
th»adpoŞ
, (*
funùiÚ_p
)(*), * 
¬g_p
);

97 
thpoŞ_wa™
(
th»adpoŞ
);

121 
thpoŞ_·u£
(
th»adpoŞ
);

137 
thpoŞ_»sume
(
th»adpoŞ
);

159 
thpoŞ_de¡roy
(
th»adpoŞ
);

180 
thpoŞ_num_th»ads_wÜkšg
(
th»adpoŞ
);

183 #ifdeà
__ılu¥lus


	@application/kvbench/utils/adv_random.h

25 #iâdeà
_JSAHN_ADV_RANDOM_H


26 
	#_JSAHN_ADV_RANDOM_H


	)

28 
	~<¡dšt.h
>

29 
	~<m©h.h
>

31 #ifdeà
__ılu¥lus


35 #iâdeà
UINT64_MAX


36 
	#UINT64_MAX
 ((
ušt64_t
)0xffffffffffffffff)

	)

39 
	#BDR_RNG_VARS
 \

40 
ušt64_t
 
ºgx
=
	`¿nd
(), 
ºgy
=362436069, 
ºgz
=521288629; \

41 
ušt64_t
 
ºgt
, 
ºgz2
; (ìngt; (ìngz2;

	)

43 
	#BDR_RNG_VARS_SET
(
x
) \

44 
ušt64_t
 
ºgx
, 
ºgy
, 
ºgz
; \

45 
ºgx
 = (
x
); \

46 
ºgy
 = 
ºgx
;„ngy ^=„ngy << 16;„ngy ^=„ngy >> 5;„ngy ^=„ngy << 1; \

47 
ºgz
 = 
ºgy
;„ngz ^=„ngz << 16;„ngz ^=„ngz >> 5;„ngz ^=„ngz << 1; \

48 
ušt64_t
 
ºgt
, 
ºgz2
; (ìngt; (ìngz2;

	)

51 
	#BDR_RNG_NEXT
 \

52 
ºgx
 ^=„ngx << 16; \

53 
ºgx
 ^=„ngx >> 5; \

54 
ºgx
 ^=„ngx << 1; \

55 
ºgt
 = 
ºgx
; \

56 
ºgx
 = 
ºgy
; \

57 
ºgy
 = 
ºgz
; \

58 
ºgz
 = 
ºgt
 ^ 
ºgx
 ^ 
ºgy
;

	)

61 
	#BDR_RNG_NEXTPAIR
 \

62 
ºgx
 ^=„ngx << 16; \

63 
ºgx
 ^=„ngx >> 5; \

64 
ºgx
 ^=„ngx << 1; \

65 
ºgt
 = 
ºgx
; \

66 
ºgx
 = 
ºgy
; \

67 
ºgy
 = 
ºgz
; \

68 
ºgz
 = 
ºgt
 ^ 
ºgx
 ^ 
ºgy
; \

69 
ºgz2
 = 
ºgz
; \

70 
ºgx
 ^=„ngx << 16; \

71 
ºgx
 ^=„ngx >> 5; \

72 
ºgx
 ^=„ngx << 1; \

73 
ºgt
 = 
ºgx
; \

74 
ºgx
 = 
ºgy
; \

75 
ºgy
 = 
ºgz
; \

76 
ºgz
 = 
ºgt
 ^ 
ºgx
 ^ 
ºgy
;

	)

78 
	#BDR_RNG_GET_INT
(
numb”
è(
ºgz
 % (numb”))

	)

79 
	#BDR_RNG_GET_INT_PAIR
(
a
, 
b
, 
numb”
) \

80 (
a
èğ(
ºgz
 % (
numb”
)); \

81 (
b
èğ(
ºgz2
 % (
numb”
));

	)

84 
RND_UNIFORM
,

85 
RND_NORMAL
,

86 
RND_ZIPFIAN
,

87 
RND_FIXED
,

88 
RND_RATIO
,

89 } 
	tºdty³_t
;

91 
	sºdšfo
{

92 
ºdty³_t
 
ty³
;

95 
št64_t
 
a
;

98 
št64_t
 
b
;

101 
__PI
 = 3.141592654;

103 
št64_t
 
g‘_¿ndom
(
ºdšfo
* 
ri
, 
ušt64_t
 
rv1
, ušt64_ˆ
rv2
)

105 ià(
ri
->
ty³
 =ğ
RND_UNIFORM
)

107 
ªÜm
 = (()
rv1
è/ 
UINT64_MAX
;

108  (
št64_t
)(
ªÜm
 * (
ri
->
b
 -„i->
a
) +„i->a);

110 ià(
ri
->
ty³
 =ğ
RND_NORMAL
){

111 
r1
, 
r2
;

112 
r1
 = -
log
(1-((()
rv1
è/ 
UINT64_MAX
 ));

113 
r2
 = 2 * 
__PI
 * ((()
rv2
è/ 
UINT64_MAX
 );

114 
r1
 = 
sq¹
(2*r1);

115  (
št64_t
)(
ri
->
b
 * 
r1
 * 
cos
(
r2
è+„i->
a
);

120 #ifdeà
__RAND_GEN_TEST


122 
_¿nd_g’_‹¡
()

124 
n
 = 32, 
m
 = 1<<20;

125 
¬r
[
n
];

126 
i
;

127 
cdf
;

128 
št64_t
 
r
;

129 
ºdšfo
 
ri
;

130 
BDR_RNG_VARS
;

132 
mem£t
(
¬r
, 0, ()*
n
);

133 
cdf
 = 0;

134 
ri
.
ty³
 = 
RND_UNIFORM
;

135 
ri
.
a
 = 0;

136 
ri
.
b
 = 32;

138 
i
=0;i<
m
;++i){

139 
BDR_RNG_NEXTPAIR
;

140 
r
 = 
g‘_¿ndom
(&
ri
, 
ºgz
, 
ºgz2
);

141 
¬r
[
r
]++;

144 
i
=0;i<
n
;++i){

145 
cdf
 +ğ()
¬r
[
i
]/
m
*100;

146 
´štf
("¬r[%d] = %7d (%.2à%% / %.2à%%)\n", 
i
, 
¬r
[i], (ï¼[i]/
m
*100, 
cdf
);

149 
mem£t
(
¬r
, 0, ()*
n
);

150 
cdf
 = 0;

151 
ri
.
ty³
 = 
RND_NORMAL
;

152 
ri
.
a
 = 16;

153 
ri
.
b
 = 2;

155 
i
=0;i<
m
;++i){

156 
BDR_RNG_NEXTPAIR
;

157 
r
 = 
g‘_¿ndom
(&
ri
, 
ºgz
, 
ºgz2
);

158 ià(
r
<0)„=0;

159 ià(
r
>=
n
)„=n-1;

160 
¬r
[
r
]++;

163 
i
=0;i<
n
;++i){

164 
cdf
 +ğ()
¬r
[
i
]/
m
*100;

165 
´štf
("¬r[%d] = %7d (%.2à%% / %.2à%%)\n", 
i
, 
¬r
[i], (ï¼[i]/
m
*100, 
cdf
);

171 #ifdeà
__ılu¥lus


	@application/kvbench/utils/avltree.cc

8 #iâdeà
INLINE


9 #ifdeà
__APPLE__


10 
	#INLINE
 
šlše


	)

11 #–ià
__lšux__


12 
	#INLINE
 
__šlše


	)

14 
	#INLINE


	)

18 
	~"avÉ»e.h
"

20 
	#max
(
a
,
b
è((×è> (b)è? (aè: (b))

	)

22 
INLINE
 
	$_abs
(
n
) {

23 
mask
 = 
n
 >> ((()*8) -1);

24  (
mask
 + 
n
)^mask;

25 
	}
}

27 
INLINE
 
	$avl_£t_·»Á
(
avl_node
 *
node
, avl_nod*
·»Á
)

29 
node
->
·»Á
 = (
avl_node
 *)(

30 (
ušt64_t
)
·»Á
 | ((ušt64_t)
node
->parent & 0x3));

31 
	}
}

33 #ifdeà
__AVL_DEBUG


34 
	~<¡dio.h
>

35 
	~<as£¹.h
>

36 
	~"avÉ»e_debug.h
"

38 
	#__AVL_DEBUG_BF_CHECK
(
bf
)

	)

39 
	#__AVL_DEBUG_LL
(
p
, 
c
, 
pb
, 
cb
)

	)

40 
	#__AVL_DEBUG_RR
(
p
, 
c
, 
pb
, 
cb
)

	)

41 
	#__AVL_DEBUG_BAL_BEGIN
(
node
, 
bf
, 
height_diff
)

	)

42 
	#__AVL_DEBUG_BAL_END
(
node
)

	)

43 
	#__AVL_DEBUG_INSERT
(
node
)

	)

44 
	#__AVL_DEBUG_REMOVE
(
node
)

	)

45 
	#__AVL_DEBUG_DISPLAY
(
Œ“
)

	)

48 
INLINE
 
	$avl_£t_bf
(
avl_node
 *
node
, 
bf
)

50 
	`__AVL_DEBUG_BF_CHECK
(
bf
);

52 #ifdeà
_AVL_SEPARATE_PARENT_BF


53 
node
->
bf
 = bf;

55 
node
->
·»Á
 = (
avl_node
 *)(

56 (
ušt64_t
)
	`avl_·»Á
(
node
è| (ušt64_t)(
bf
+1));

58 
	}
}

60 
INLINE
 
avl_node
* 
	$_rÙ©e_LL
(
avl_node
 *
·»Á
,

61 
·»Á_bf
,

62 *
chd_bf
,

63 *
height_d–
)

66 
p_right
, 
c_Ëá
, 
c_right
;

67 
avl_node
 *
chd
 = 
·»Á
->
Ëá
;

69 
	`__AVL_DEBUG_LL
(
·»Á
, 
chd
, 
·»Á_bf
, *
chd_bf
);

71 
c_Ëá
 = (
chd
->
Ëá
)?(1):(0);

72 
c_right
 = (
chd
->
right
)?(1):(0);

73 ià(*
chd_bf
 < 0) {

75 
c_Ëá
 = 
c_right
 - (*
chd_bf
);

76 
p_right
 = 
c_Ëá
 + 1 + 
·»Á_bf
;

77 ià(
height_d–
)

78 *
height_d–
 = 
	`max
(
c_Ëá
, max(
c_right
, 
p_right
)+1) - (c_left + 1);

82 
c_right
 = 
c_Ëá
 + (*
chd_bf
);

83 
p_right
 = 
c_right
 + 1 + 
·»Á_bf
;

84 ià(
height_d–
)

85 *
height_d–
 = 
	`max
(
c_Ëá
, max(
c_right
, 
p_right
)+1) - (c_right + 1);

87 *
chd_bf
 = (
	`max
(
c_right
, 
p_right
è+ 1è- 
c_Ëá
;

88 
	`avl_£t_bf
(
·»Á
, 
p_right
 - 
c_right
);

90 
·»Á
->
Ëá
 = 
chd
->
right
;

91 ià(
chd
->
right
)

92 
	`avl_£t_·»Á
(
chd
->
right
, 
·»Á
);

93 
chd
->
right
 = 
·»Á
;

94 
	`avl_£t_·»Á
(
chd
, 
	`avl_·»Á
(
·»Á
));

95 
	`avl_£t_·»Á
(
·»Á
, 
chd
);

97  
chd
;

98 
	}
}

100 
INLINE
 
avl_node
* 
	$_rÙ©e_RR
(
avl_node
 *
·»Á
,

101 
·»Á_bf
,

102 *
chd_bf
,

103 *
height_d–
)

106 
p_Ëá
, 
c_Ëá
, 
c_right
;

107 
avl_node
 *
chd
 = 
·»Á
->
right
;

109 
	`__AVL_DEBUG_RR
(
·»Á
, 
chd
, 
·»Á_bf
, *
chd_bf
);

111 
c_Ëá
 = (
chd
->
Ëá
)?(1):(0);

112 
c_right
 = (
chd
->
right
)?(1):(0);

113 ià(*
chd_bf
 < 0) {

115 
c_Ëá
 = 
c_right
 - (*
chd_bf
);

116 
p_Ëá
 = 
c_Ëá
 + 1 - 
·»Á_bf
;

117 ià(
height_d–
)

118 *
height_d–
 = 
	`max
(
c_right
, max(
c_Ëá
, 
p_Ëá
)+1) - (c_left + 1);

122 
c_right
 = 
c_Ëá
 + (*
chd_bf
);

123 
p_Ëá
 = 
c_right
 + 1 - 
·»Á_bf
;

124 ià(
height_d–
)

125 *
height_d–
 = 
	`max
(
c_right
, max(
c_Ëá
, 
p_Ëá
)+1) - (c_right + 1);

128 *
chd_bf
 = 
c_right
 - (
	`max
(
c_Ëá
, 
p_Ëá
) + 1);

129 
	`avl_£t_bf
(
·»Á
, 
c_Ëá
 - 
p_Ëá
);

131 
·»Á
->
right
 = 
chd
->
Ëá
;

132 ià(
chd
->
Ëá
)

133 
	`avl_£t_·»Á
(
chd
->
Ëá
, 
·»Á
);

134 
chd
->
Ëá
 = 
·»Á
;

135 
	`avl_£t_·»Á
(
chd
, 
	`avl_·»Á
(
·»Á
));

136 
	`avl_£t_·»Á
(
·»Á
, 
chd
);

138  
chd
;

139 
	}
}

141 
INLINE
 
avl_node
* 
	$_rÙ©e_LR
(
avl_node
 *
·»Á
, 
·»Á_bf
)

143 
chd_bf
, 
height_d–
 = 0;

144 
avl_node
 *
chd
 = 
·»Á
->
Ëá
;

145 
avl_node
 *
»t
;

147 ià(
chd
->
right
) {

148 
chd_bf
 = 
	`avl_bf
(
chd
->
right
);

149 
·»Á
->
Ëá
 = 
	`_rÙ©e_RR
(
chd
, 
	`avl_bf
(chd), &
chd_bf
, &
height_d–
);

151 
chd_bf
 = 
	`avl_bf
(
chd
);

154 
»t
 = 
	`_rÙ©e_LL
(
·»Á
, 
·»Á_bf
-
height_d–
, &
chd_bf
, 
NULL
);

155 
	`avl_£t_bf
(
»t
, 
chd_bf
);

156  
»t
;

157 
	}
}

159 
INLINE
 
avl_node
* 
	$_rÙ©e_RL
(
avl_node
 *
·»Á
, 
·»Á_bf
)

161 
chd_bf
, 
height_d–
 = 0;

162 
avl_node
 *
chd
 = 
·»Á
->
right
;

163 
avl_node
 *
»t
;

165 ià(
chd
->
Ëá
) {

166 
chd_bf
 = 
	`avl_bf
(
chd
->
Ëá
);

167 
·»Á
->
right
 = 
	`_rÙ©e_LL
(
chd
, 
	`avl_bf
(chd), &
chd_bf
, &
height_d–
);

169 
chd_bf
 = 
	`avl_bf
(
chd
);

172 
»t
 = 
	`_rÙ©e_RR
(
·»Á
, 
·»Á_bf
+
height_d–
, &
chd_bf
, 
NULL
);

173 
	`avl_£t_bf
(
»t
, 
chd_bf
);

174  
»t
;

175 
	}
}

177 
	#_g‘_b®ªû
(
node
è(Òode)?(
	`avl_bf
Òode)):(0))

	)

179 
avl_node
* 
	$_b®ªû_Œ“
(
avl_node
 *
node
, 
bf
)

181 
chd_bf
;

182 
height_diff
ğ
	`_g‘_b®ªû
(
node
è+ 
bf
;

184 ià(
node
) {

185 
	`__AVL_DEBUG_BAL_BEGIN
(
node
, 
bf
, 
height_diff
);

187 if(
height_diff
 < -1 && 
node
->
Ëá
) {

189 if(
	`_g‘_b®ªû
(
node
->
Ëá
) <= 0) {

190 
chd_bf
 = 
	`avl_bf
(
node
->
Ëá
);

191 
node
 = 
	`_rÙ©e_LL
Òode, 
height_diff
, &
chd_bf
, 
NULL
);

192 
	`avl_£t_bf
(
node
, 
chd_bf
);

194 
node
 = 
	`_rÙ©e_LR
Òode, 
height_diff
);

196 } if(
height_diff
 > 1 && 
node
->
right
) {

198 if(
	`_g‘_b®ªû
(
node
->
right
) >= 0) {

199 
chd_bf
 = 
	`avl_bf
(
node
->
right
);

200 
node
 = 
	`_rÙ©e_RR
Òode, 
height_diff
, &
chd_bf
, 
NULL
);

201 
	`avl_£t_bf
(
node
, 
chd_bf
);

203 
node
 = 
	`_rÙ©e_RL
Òode, 
height_diff
);

206 
	`avl_£t_bf
(
node
, 
	`avl_bf
Òodeè+ 
bf
);

209 
	`__AVL_DEBUG_BAL_END
(
node
);

212  
node
;

213 
	}
}

215 
avl_node
* 
	$avl_fœ¡
(
avl_Œ“
 *
Œ“
)

217 
avl_node
 *
p
 = 
NULL
;

218 
avl_node
 *
node
 = 
Œ“
->
roÙ
;

220 
node
) {

221 
p
 = 
node
;

222 
node
 =‚ode->
Ëá
;

224  
p
;

225 
	}
}

227 
avl_node
* 
	$avl_Ï¡
(
avl_Œ“
 *
Œ“
)

229 
avl_node
 *
p
 = 
NULL
;

230 
avl_node
 *
node
 = 
Œ“
->
roÙ
;

232 
node
) {

233 
p
 = 
node
;

234 
node
 =‚ode->
right
;

236  
p
;

237 
	}
}

239 
avl_node
* 
	$avl_Ãxt
(
avl_node
 *
node
)

241 ià(
node
 =ğ
NULL
)  NULL;

243 #ifdeà
_AVL_NEXT_POINTER


244  
node
->
Ãxt
;

247 
avl_node
 *
p
;

250 ià(
node
->
right
) {

251 
p
 = 
node
;

252 
node
 =‚ode->
right
;

253 
node
) {

254 
p
 = 
node
;

255 
node
 =‚ode->
Ëá
;

257  
p
;

261 ià(
	`avl_·»Á
(
node
)) {

263 
p
 = 
node
;

264 
node
 = 
	`avl_·»Á
(node);

265 
node
) {

266 ià(
node
->
Ëá
 =ğ
p
) {

267  
node
;

269 
p
 = 
node
;

270 
node
 = 
	`avl_·»Á
(node);

274  
NULL
;

275 
	}
}

277 
avl_node
* 
	$avl_´ev
(
avl_node
 *
node
)

279 ià(
node
 =ğ
NULL
)  NULL;

281 #ifdeà
_AVL_NEXT_POINTER


282  
node
->
´ev
;

285 
avl_node
 *
p
;

288 ià(
node
->
Ëá
) {

289 
p
 = 
node
;

290 
node
 =‚ode->
Ëá
;

291 
node
) {

292 
p
 = 
node
;

293 
node
 =‚ode->
right
;

295  
p
;

299 ià(
	`avl_·»Á
(
node
)) {

301 
p
 = 
node
;

302 
node
 = 
	`avl_·»Á
(node);

303 
node
) {

304 ià(
node
->
right
 =ğ
p
) {

305  
node
;

307 
p
 = 
node
;

308 
node
 = 
	`avl_·»Á
(node);

312  
NULL
;

313 
	}
}

315 
avl_node
* 
	$avl_£¬ch
(
avl_Œ“
 *
Œ“
,

316 
avl_node
 *
node
,

317 
avl_cmp_func
 *
func
)

320 
avl_node
 *
p
 = 
Œ“
->
roÙ
;

321 
cmp
;

323 
p
)

325 
cmp
 = 
	`func
(
p
, 
node
, 
Œ“
->
aux
);

326 ià(
cmp
 > 0) {

327 
p
 =…->
Ëá
;

328 }ià(
cmp
 < 0){

329 
p
 =…->
right
;

332  
p
;

336  
NULL
;

337 
	}
}

339 
avl_node
* 
	$avl_£¬ch_g»©”
(
avl_Œ“
 *
Œ“
,

340 
avl_node
 *
node
,

341 
avl_cmp_func
 *
func
)

345 
avl_node
 *
p
 = 
Œ“
->
roÙ
;

346 
avl_node
 *
µ
 = 
NULL
;

347 
cmp
;

349 
p
)

351 
cmp
 = 
	`func
(
p
, 
node
, 
Œ“
->
aux
);

352 
µ
 = 
p
;

354 ià(
cmp
 > 0) {

355 
p
 =…->
Ëá
;

356 }ià(
cmp
 < 0){

357 
p
 =…->
right
;

360  
p
;

364 ià(!
µ
) {

365  
µ
;

368 
cmp
 = 
	`func
(
µ
, 
node
, 
Œ“
->
aux
);

369 ià(
cmp
 > 0) {

370  
µ
;

372  
	`avl_Ãxt
(
µ
);

374 
	}
}

376 
avl_node
* 
	$avl_£¬ch_sm®Ër
(
avl_Œ“
 *
Œ“
,

377 
avl_node
 *
node
,

378 
avl_cmp_func
 *
func
)

382 
avl_node
 *
p
 = 
Œ“
->
roÙ
;

383 
avl_node
 *
µ
 = 
NULL
;

384 
cmp
;

386 
p
)

388 
cmp
 = 
	`func
(
p
, 
node
, 
Œ“
->
aux
);

389 
µ
 = 
p
;

391 ià(
cmp
 > 0) {

392 
p
 =…->
Ëá
;

393 }ià(
cmp
 < 0){

394 
p
 =…->
right
;

397  
p
;

401 ià(!
µ
) {

402  
µ
;

405 
cmp
 = 
	`func
(
µ
, 
node
, 
Œ“
->
aux
);

406 ià(
cmp
 < 0) {

407  
µ
;

409  
	`avl_´ev
(
µ
);

411 
	}
}

413 
	$avl_š™
(
avl_Œ“
 *
Œ“
, *
aux
)

415 
Œ“
->
roÙ
 = 
NULL
;

416 
Œ“
->
aux
 =‡ux;

417 
	}
}

419 
avl_node
* 
	$avl_š£¹
(
avl_Œ“
 *
Œ“
,

420 
avl_node
 *
node
,

421 
avl_cmp_func
 *
func
)

423 
	`__AVL_DEBUG_INSERT
(
node
);

425 
avl_node
 *
p
=
NULL
,*
cur
;

426 
cmp
, 
bf
, 
bf_Şd
;

428 
cur
 = 
Œ“
->
roÙ
;

429 
cur
)

431 
cmp
 = 
	`func
(
cur
, 
node
, 
Œ“
->
aux
);

432 
p
 = 
cur
;

434 if(
cmp
 > 0) {

435 
cur
 = cur->
Ëá
;

436 }ià(
cmp
 < 0){

437 
cur
 = cur->
right
;

440  
cur
;

444 
	`avl_£t_·»Á
(
node
, 
p
);

445 
	`avl_£t_bf
(
node
, 0);

446 
node
->
Ëá
 =‚ode->
right
 = 
NULL
;

447 #ifdeà
_AVL_NEXT_POINTER


448 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

452 if(
p
) {

453 if(
	`func
(
p
, 
node
, 
Œ“
->
aux
) > 0) {

454 
p
->
Ëá
 = 
node
;

455 #ifdeà
_AVL_NEXT_POINTER


456 
node
->
Ãxt
 = 
p
;

457 
node
->
´ev
 = 
p
->prev;

458 ià(
p
->
´ev
èp->´ev->
Ãxt
 = 
node
;

459 
p
->
´ev
 = 
node
;

463 
p
->
right
 = 
node
;

464 #ifdeà
_AVL_NEXT_POINTER


465 
node
->
´ev
 = 
p
;

466 
node
->
Ãxt
 = 
p
->next;

467 ià(
p
->
Ãxt
èp->Ãxt->
´ev
 = 
node
;

468 
p
->
Ãxt
 = 
node
;

474 
Œ“
->
roÙ
 = 
node
;

478 
bf
 = 0;

479 
node
) {

480 
p
 = 
	`avl_·»Á
(
node
);

482 ià(
p
) {

484 
bf_Şd
 = 
	`avl_bf
(
node
);

486 ià(
p
->
right
 =ğ
node
) {

487 
node
 = 
	`_b®ªû_Œ“
Òode, 
bf
);

488 
p
->
right
 = 
node
;

490 
node
 = 
	`_b®ªû_Œ“
Òode, 
bf
);

491 
p
->
Ëá
 = 
node
;

495 ià(
node
->
Ëá
 =ğ
NULL
 &&‚ode->
right
 == NULL) {

497 ià(
p
->
Ëá
 =ğ
node
è
bf
 = -1;

498 
bf
 = 1;

501 
bf
 = 0;

502 ià(
	`_abs
(
bf_Şd
è< _abs(
	`avl_bf
(
node
))) {

505 ià(
p
->
Ëá
 =ğ
node
è
bf
 = -1;

506 
bf
 = 1;

510 } if(
node
 =ğ
Œ“
->
roÙ
){

511 
Œ“
->
roÙ
 = 
	`_b®ªû_Œ“
Ñ»e->roÙ, 
bf
);

514 ià(
bf
 == 0) ;

516 
node
 = 
p
;

519 
	`__AVL_DEBUG_DISPLAY
(
Œ“
);

521  
node
;

522 
	}
}

524 
	$avl_»move
(
avl_Œ“
 *
Œ“
,

525 
avl_node
 *
node
)

527 
	`__AVL_DEBUG_REMOVE
(
node
);

530 ià(
node
 =ğ
NULL
) ;

532 
avl_Œ“
 
right_subŒ“
;

533 
avl_node
 *
p
=
NULL
,*
cur
, *
Ãxt
=NULL;

534 
bf
 = 0, 
bf_Şd
;

537 #ifdeà
_AVL_NEXT_POINTER


538 ià(
node
->
´ev
ènode->´ev->
Ãxt
 =‚ode->next;

539 ià(
node
->
Ãxt
ènode->Ãxt->
´ev
 =‚ode->prev;

543 
right_subŒ“
.
roÙ
 = 
node
->
right
;

544 
Ãxt
 = 
	`avl_fœ¡
(&
right_subŒ“
);

546 ià(
Ãxt
) {

548 ià(
	`avl_·»Á
(
Ãxt
)) {

549 ià(
	`avl_·»Á
(
Ãxt
è!ğ
node
) {

553 
	`avl_·»Á
(
Ãxt
)->
Ëá
 =‚ext->
right
;

554 ià(
Ãxt
->
right
)

555 
	`avl_£t_·»Á
(
Ãxt
->
right
, 
	`avl_·»Á
(next));

558 ià(
	`avl_·»Á
(
node
)) {

560 ià(
	`avl_·»Á
(
node
)->
Ëá
 ==‚ode) {

561 
	`avl_·»Á
(
node
)->
Ëá
 = 
Ãxt
;

563 
	`avl_·»Á
(
node
)->
right
 = 
Ãxt
;

568 ià(
node
->
right
 !ğ
Ãxt
) {

569 
Ãxt
->
right
 = 
node
->right;

570 ià(
node
->
right
è
	`avl_£t_·»Á
Òode->right, 
Ãxt
);

571 
cur
 = 
	`avl_·»Á
(
Ãxt
);

572 
bf
 = 1;

574 
cur
 = 
Ãxt
;

575 
bf
 = -1;

578 
Ãxt
->
Ëá
 = 
node
->left;

579 ià(
node
->
Ëá
è
	`avl_£t_·»Á
Òode->Ëá, 
Ãxt
);

580 
	`avl_£t_·»Á
(
Ãxt
, 
	`avl_·»Á
(
node
));

583 
	`avl_£t_bf
(
Ãxt
, 
	`avl_bf
(
node
));

587 
p
 = 
	`avl_·»Á
(
node
);

588 ià(
p
) {

589 ià(
p
->
Ëá
 =ğ
node
) {

590 
p
->
Ëá
 = 
node
->left;

591 
bf
 = 1;

593 
p
->
right
 = 
node
->
Ëá
;

594 
bf
 = -1;

597 ià(
node
->
Ëá
)

598 
	`avl_£t_·»Á
(
node
->
Ëá
, 
p
);

600 
cur
 = 
	`avl_·»Á
(
node
);

604 ià(
Œ“
->
roÙ
 =ğ
node
) {

605 
Œ“
->
roÙ
 = 
Ãxt
;

606 ià(
Ãxt
 =ğ
NULL
) {

607 ià(
node
->
Ëá
è
Œ“
->
roÙ
 =‚ode->left;

612 
cur
) {

613 
p
 = 
	`avl_·»Á
(
cur
);

614 ià(
p
) {

616 
bf_Şd
 = 
	`avl_bf
(
cur
);

618 ià(
p
->
right
 =ğ
cur
) {

619 
cur
 = 
	`_b®ªû_Œ“
(cur, 
bf
);

620 
p
->
right
 = 
cur
;

622 
cur
 = 
	`_b®ªû_Œ“
(cur, 
bf
);

623 
p
->
Ëá
 = 
cur
;

627 ià(
cur
->
Ëá
 =ğ
NULL
 && cur->
right
 == NULL) {

629 ià(
p
->
Ëá
 =ğ
cur
è
bf
 = 1;

630 
bf
 = -1;

633 
bf
 = 0;

634 ià(
	`_abs
(
bf_Şd
è> _abs(
	`avl_bf
(
cur
))) {

637 ià(
p
->
Ëá
 =ğ
cur
è
bf
 = 1;

638 
bf
 = -1;

642 } if(
cur
 =ğ
Œ“
->
roÙ
){

643 
Œ“
->
roÙ
 = 
	`_b®ªû_Œ“
Ñ»e->roÙ, 
bf
);

646 ià(
bf
 == 0) ;

648 
cur
 = 
p
;

651 
	`__AVL_DEBUG_DISPLAY
(
Œ“
);

652 
	}
}

	@application/kvbench/utils/avltree.h

8 #iâdeà
_JSAHN_AVL_TREE_H


9 
	#_JSAHN_AVL_TREE_H


	)

11 
	~"¡ddef.h
"

12 
	~"¡dšt.h
"

14 #ifdeà
__ılu¥lus


18 
	savl_node
 {

19 
avl_node
 *
·»Á
, *
Ëá
, *
right
;

21 #ifdeà
_AVL_SEPARATE_PARENT_BF


22 
bf
;

24 #ifdeà
_AVL_NEXT_POINTER


25 
avl_node
 *
´ev
, *
Ãxt
;

29 
	savl_Œ“
{

30 
avl_node
 *
roÙ
;

31 *
aux
;

34 #iâdeà
_g‘_’Œy


35 
	#_g‘_’Œy
(
ELEM
, 
STRUCT
, 
MEMBER
) \

36 ((
STRUCT
 *è((
ušt8_t
 *è(
ELEM
è- 
	`off£tof
 (STRUCT, 
MEMBER
)))

	)

39 
	#avl_·»Á
(
node
) \

40 ((
avl_node
 *)((
ušt64_t
)(
node
)->
·»Á
 & ~0x3))

	)

42 #ifdeà
_AVL_SEPARATE_PARENT_BF


43 
	#avl_bf
(
node
è(Òode)->
bf
)

	)

45 
	#avl_bf
(
node
è((()((
ušt64_t
)Òode)->
·»Á
 & 0x3)è- 1)

	)

51 
	tavl_cmp_func
 (
	tavl_node
 *
	ta
, avl_nod*
	tb
, *
	taux
);

53 
avl_š™
(
avl_Œ“
 *
Œ“
, *
aux
);

54 
avl_node
* 
avl_š£¹
(
avl_Œ“
 *
Œ“
,

55 
avl_node
 *
node
,

56 
avl_cmp_func
 *
func
);

57 
avl_node
* 
avl_£¬ch
(
avl_Œ“
 *
Œ“
,

58 
avl_node
 *
node
,

59 
avl_cmp_func
 *
func
);

60 
avl_node
* 
avl_£¬ch_g»©”
(
avl_Œ“
 *
Œ“
,

61 
avl_node
 *
node
,

62 
avl_cmp_func
 *
func
);

63 
avl_node
* 
avl_£¬ch_sm®Ër
(
avl_Œ“
 *
Œ“
,

64 
avl_node
 *
node
,

65 
avl_cmp_func
 *
func
);

66 
avl_»move
(
avl_Œ“
 *
Œ“
,

67 
avl_node
 *
node
);

68 
avl_node
* 
avl_fœ¡
(
avl_Œ“
 *
Œ“
);

69 
avl_node
* 
avl_Ï¡
(
avl_Œ“
 *
Œ“
);

70 
avl_node
* 
avl_Ãxt
(avl_nod*
node
);

71 
avl_node
* 
avl_´ev
(avl_nod*
node
);

73 #ifdeà
__ılu¥lus


	@application/kvbench/utils/crc32.cc

11 
	~<¡dlib.h
>

12 
	~<¡dšt.h
>

13 
	~<¡ršg.h
>

15 
	~"üc32.h
"

16 
	~"¬ch.h
"

20 cÚ¡ 
ušt32_t
 
	güc_lookup
[8][256] =

309 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

311 
ušt32_t
 
	$üc32_1
(* 
d©a
, 
size_t
 
Ën
, 
ušt32_t
 
´ev_v®ue
)

313 
ušt32_t
 
üc
 = ~
´ev_v®ue
;

314 cÚ¡ 
ušt8_t
* 
cur
 = (cÚ¡ ušt8_t*è
d©a
;

316 
Ën
-- > 0)

317 
üc
 = (üø>> 8è^ 
üc_lookup
[0][(üø& 0xFFè^ *
cur
++];

319  ~
üc
;

320 
	}
}

322 
ušt32_t
 
	$üc32_8
(* 
d©a
, 
size_t
 
Ën
, 
ušt32_t
 
´ev_v®ue
)

324 
ušt32_t
 *
cur
 = (ušt32_t*è
d©a
;

325 
ušt32_t
 
üc
 = ~
´ev_v®ue
;

327 
Ën
 >= 8) {

328 #ifdeà
_BIG_ENDIAN


329 
ušt32_t
 
Úe
 = *
cur
++ ^ 
	`b™sw­32
(
üc
);

330 
ušt32_t
 
two
 = *
cur
++;

331 
üc
 =

332 
üc_lookup
[7][(
Úe
>>24) & 0xFF] ^

333 
üc_lookup
[6][(
Úe
>>16) & 0xFF] ^

334 
üc_lookup
[5][(
Úe
>> 8) & 0xFF] ^

335 
üc_lookup
[4][(
Úe
 ) & 0xFF] ^

336 
üc_lookup
[3][(
two
>>24) & 0xFF] ^

337 
üc_lookup
[2][(
two
>>16) & 0xFF] ^

338 
üc_lookup
[1][(
two
>> 8) & 0xFF] ^

339 
üc_lookup
[0][(
two
 ) & 0xFF];

341 
ušt32_t
 
Úe
 = *
cur
++ ^ 
üc
;

342 
ušt32_t
 
two
 = *
cur
++;

343 
üc
 =

344 
üc_lookup
[7][(
Úe
 ) & 0xFF] ^

345 
üc_lookup
[6][(
Úe
>> 8) & 0xFF] ^

346 
üc_lookup
[5][(
Úe
>>16) & 0xFF] ^

347 
üc_lookup
[4][(
Úe
>>24) & 0xFF] ^

348 
üc_lookup
[3][(
two
 ) & 0xFF] ^

349 
üc_lookup
[2][(
two
>> 8) & 0xFF] ^

350 
üc_lookup
[1][(
two
>>16) & 0xFF] ^

351 
üc_lookup
[0][(
two
>>24) & 0xFF];

353 
Ën
 -= 8;

356 *
cur_by‹
 = (*è
cur
;

357 
Ën
--)

358 
üc
 = (üø>> 8è^ 
üc_lookup
[0][(üø& 0xFFè^ *
cur_by‹
++];

360  ~
üc
;

361 
	}
}

363 
ušt32_t
 
	$üc32_8_Ï¡8
(*
d©a
, 
size_t
 
Ën
, 
ušt32_t
 
´ev_v®ue
)

365 
size_t
 
mš
 = 
	`MIN
(
Ën
, 8);

366 *
¤c
 = (*)
d©a
 + (
Ën
-
mš
);

367 #ifdeà
_ALIGN_MEM_ACCESS


368 
ušt64_t
 
‹mp
;

369 
	`memıy
(&
‹mp
, 
¤c
, 
mš
);

370 
¤c
 = &
‹mp
;

372  
	`üc32_8
(
¤c
, 
mš
, 
´ev_v®ue
);

373 
	}
}

	@application/kvbench/utils/crc32.h

1 #iâdeà
_JSAHN_CRC32_H


2 
	#_JSAHN_CRC32_H


	)

4 #ifdeà
__ılu¥lus


8 
ušt32_t
 
üc32_1
(* 
d©a
, 
size_t
 
Ën
, ušt32_ˆ
´ev_v®ue
);

9 
ušt32_t
 
üc32_8
(* 
d©a
, 
size_t
 
Ën
, ušt32_ˆ
´ev_v®ue
);

10 
ušt32_t
 
üc32_8_Ï¡8
(*
d©a
, 
size_t
 
Ën
, ušt32_ˆ
´ev_v®ue
);

12 #ifdeà
__ılu¥lus


	@application/kvbench/utils/iniparser.cc

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 #ià!
defšed
(
WIN32
è&& !defšed(
_WIN32
)

35 
	~<uni¡d.h
>

38 
	~"š¬£r.h
"

40 #ifdeà
__ılu¥lus


46 
	#ASCIILINESZ
 1024

	)

60 * 
¡¾wc
(* 
s
)

62 
l
[
ASCIILINESZ
+1];

63 
i
 ;

65 ià(
s
==
NULL
)  NULL ;

66 
mem£t
(
l
, 0, 
ASCIILINESZ
+1);

67 
i
=0 ;

68 
s
[
i
] && i<
ASCIILINESZ
) {

69 
l
[
i
] = ()
tŞow”
(()
s
[i]);

70 
i
++ ;

72 
l
[
ASCIILINESZ
]=()0;

73  
l
 ;

120 * 
¡rskp
(* 
s
)

122 * 
sk
 = 
s
;

123 ià(
s
==
NULL
)  NULL ;

124 
is¥aû
(()*
sk
) && *skip) skip++;

125  
sk
 ;

145 * 
¡rüİ
(* 
s
)

147 
l
[
ASCIILINESZ
+1];

148 * 
Ï¡
 ;

150 ià(
s
==
NULL
)  NULL ;

151 
mem£t
(
l
, 0, 
ASCIILINESZ
+1);

152 
¡rıy
(
l
, 
s
);

153 
Ï¡
 = 
l
 + 
¡¾’
(l);

154 
Ï¡
 > 
l
) {

155 ià(!
is¥aû
(()*(
Ï¡
-1)))

157 
Ï¡
 -- ;

159 *
Ï¡
 = ()0;

160  
l
 ;

206 
	#MAXVALSZ
 1024

	)

209 
	#DICTMINSZ
 128

	)

212 
	#DICT_INVALID_KEY
 ((*)-1)

	)

218 * 
mem_doubË
(* 
±r
, 
size
)

220 *
Ãw±r
;

222 
Ãw±r
 = 
ÿÎoc
(2*
size
, 1);

223 
memıy
(
Ãw±r
, 
±r
, 
size
);

224 
ä“
(
±r
);

225  
Ãw±r
 ;

246 
diùiÚ¬y_hash
(* 
key
)

248 
Ën
 ;

249 
hash
 ;

250 
i
 ;

252 
Ën
 = 
¡¾’
(
key
);

253 
hash
=0, 
i
=0 ; i<
Ën
 ; i++) {

254 
hash
 +ğ()
key
[
i
] ;

255 
hash
 += (hash<<10);

256 
hash
 ^= (hash>>6) ;

258 
hash
 += (hash <<3);

259 
hash
 ^= (hash >>11);

260 
hash
 += (hash <<15);

261  
hash
 ;

277 
diùiÚ¬y
 * 
diùiÚ¬y_Ãw
(
size
)

279 
diùiÚ¬y
 *
d
 ;

282 ià(
size
<
DICTMINSZ
) size=DICTMINSZ ;

284 
d
 = (
diùiÚ¬y
 *)
ÿÎoc
(1, (dictionary));

285 
d
->
size
 = size ;

286 
d
->
v®
 = (**)
ÿÎoc
(
size
, (*));

287 
d
->
key
 = (**)
ÿÎoc
(
size
, (*));

288 
d
->
hash
 = (*)
ÿÎoc
(
size
, ());

290  
d
;

304 
diùiÚ¬y_d–
(
diùiÚ¬y
 * 
d
)

306 
i
 ;

308 ià(
d
==
NULL
)  ;

309 
i
=0 ; i<
d
->
size
 ; i++) {

310 ià(
d
->
key
[
i
]!=
NULL
)

311 
ä“
(
d
->
key
[
i
]);

312 ià(
d
->
v®
[
i
]!=
NULL
)

313 
ä“
(
d
->
v®
[
i
]);

315 
ä“
(
d
->
v®
);

316 
ä“
(
d
->
key
);

317 
ä“
(
d
->
hash
);

318 
ä“
(
d
);

339 * 
diùiÚ¬y_g‘
(
diùiÚ¬y
 * 
d
, * 
key
, * 
def
)

341 
hash
 ;

342 
i
 ;

344 
hash
 = 
diùiÚ¬y_hash
(
key
);

345 
i
=0 ; i<
d
->
size
 ; i++) {

346 ià(
d
->
key
==
NULL
)

349 ià(
hash
==
d
->hash[
i
]) {

351 ià(!
¡rcmp
(
key
, 
d
->key[
i
])) {

352  
d
->
v®
[
i
] ;

356  
def
 ;

385 
diùiÚ¬y_£t
(
diùiÚ¬y
 * 
d
, * 
key
, * 
v®
)

387 
i
 ;

388 
hash
 ;

390 ià(
d
==
NULL
 || 
key
==NULL)  ;

393 
hash
 = 
diùiÚ¬y_hash
(
key
) ;

395 ià(
d
->
n
>0) {

396 
i
=0 ; i<
d
->
size
 ; i++) {

397 ià(
d
->
key
[
i
]==
NULL
)

399 ià(
hash
==
d
->hash[
i
]) {

400 ià(!
¡rcmp
(
key
, 
d
->key[
i
])) {

402 ià(
d
->
v®
[
i
]!=
NULL
)

403 
ä“
(
d
->
v®
[
i
]);

404 
d
->
v®
[
i
] = v® ? 
¡rdup
(v®è: 
NULL
 ;

413 ià(
d
->
n
==d->
size
) {

416 
d
->
v®
 = (**)
mem_doubË
(d->v®, d->
size
 * (*)) ;

417 
d
->
key
 = (**)
mem_doubË
(d->key, d->
size
 * (*)) ;

418 
d
->
hash
 = (*)
mem_doubË
(d->hash, d->
size
 * ()) ;

421 
d
->
size
 *= 2 ;

425 
i
=0 ; i<
d
->
size
 ; i++) {

426 ià(
d
->
key
[
i
]==
NULL
) {

432 
d
->
key
[
i
] = 
¡rdup
(key);

433 
d
->
v®
[
i
] = v® ? 
¡rdup
(v®è: 
NULL
 ;

434 
d
->
hash
[
i
] = hash;

435 
d
->
n
 ++ ;

450 
diùiÚ¬y_un£t
(
diùiÚ¬y
 * 
d
, * 
key
)

452 
hash
 ;

453 
i
 ;

455 
hash
 = 
diùiÚ¬y_hash
(
key
);

456 
i
=0 ; i<
d
->
size
 ; i++) {

457 ià(
d
->
key
[
i
]==
NULL
)

460 ià(
hash
==
d
->hash[
i
]) {

462 ià(!
¡rcmp
(
key
, 
d
->key[
i
])) {

468 ià(
i
>=
d
->
size
)

472 
ä“
(
d
->
key
[
i
]);

473 
d
->
key
[
i
] = 
NULL
 ;

474 ià(
d
->
v®
[
i
]!=
NULL
) {

475 
ä“
(
d
->
v®
[
i
]);

476 
d
->
v®
[
i
] = 
NULL
 ;

478 
d
->
hash
[
i
] = 0 ;

479 
d
->
n
 -- ;

497 
diùiÚ¬y_dump
(
diùiÚ¬y
 *
d
, 
FILE
 *
f
)

499 
i
;

501 ià(
d
==
NULL
 || 
f
==NULL) ;

503 
i
=0; i<
d
->
size
; i++) {

504 ià(
d
->
key
[
i
] =ğ
NULL
)

506 ià(
d
->
v®
[
i
] !ğ
NULL
) {

507 
årštf
(
f
, "[%s]=[%s]\n", 
d
->
key
[
i
], d->
v®
[i]);

509 
årštf
(
f
, "[%s]=UNDEF\n", 
d
->
key
[
i
]);

518 
	#ASCIILINESZ
 1024

	)

519 
	#INI_INVALID_KEY
 ((*)-1)

	)

522 
š¬£r_add_’Œy
(

523 
diùiÚ¬y
 * 
d
,

524 * 
£c
,

525 * 
key
,

526 * 
v®
)

528 
lÚgkey
[2*
ASCIILINESZ
+1];

531 ià(
key
!=
NULL
) {

532 
¥rštf
(
lÚgkey
, "%s:%s", 
£c
, 
key
);

534 
¡rıy
(
lÚgkey
, 
£c
);

538 
diùiÚ¬y_£t
(
d
, 
lÚgkey
, 
v®
);

562 
š¬£r_g‘n£c
(
diùiÚ¬y
 * 
d
)

564 
i
 ;

565 
n£c
 ;

567 ià(
d
==
NULL
)  -1 ;

568 
n£c
=0 ;

569 
i
=0 ; i<
d
->
size
 ; i++) {

570 ià(
d
->
key
[
i
]==
NULL
)

572 ià(
¡rchr
(
d
->
key
[
i
], ':')==
NULL
) {

573 
n£c
 ++ ;

576  
n£c
 ;

595 * 
š¬£r_g‘£úame
(
diùiÚ¬y
 * 
d
, 
n
)

597 
i
 ;

598 
found£c
 ;

600 ià(
d
==
NULL
 || 
n
<0)  NULL ;

601 
found£c
=0 ;

602 
i
=0 ; i<
d
->
size
 ; i++) {

603 ià(
d
->
key
[
i
]==
NULL
)

605 ià(
¡rchr
(
d
->
key
[
i
], ':')==
NULL
) {

606 
found£c
++ ;

607 ià(
found£c
>
n
)

611 ià(
found£c
<=
n
) {

612  
NULL
 ;

614  
d
->
key
[
i
] ;

631 
š¬£r_dump
(
diùiÚ¬y
 * 
d
, 
FILE
 * 
f
)

633 
diùiÚ¬y_dump
(
d
,
f
);

649 
š¬£r_dump_ši
(
diùiÚ¬y
 * 
d
, 
FILE
 * 
f
)

651 
i
, 
j
 ;

652 
keym
[
ASCIILINESZ
+1];

653 
n£c
 ;

654 * 
£úame
 ;

655 
£ş’
 ;

657 ià(
d
==
NULL
 || 
f
==NULL)  ;

659 
n£c
 = 
š¬£r_g‘n£c
(
d
);

660 ià(
n£c
<1) {

662 
i
=0 ; i<
d
->
size
 ; i++) {

663 ià(
d
->
key
[
i
]==
NULL
)

665 
årštf
(
f
, "% ğ%s\n", 
d
->
key
[
i
], d->
v®
[i]);

669 
i
=0 ; i<
n£c
 ; i++) {

670 
£úame
 = 
š¬£r_g‘£úame
(
d
, 
i
) ;

671 
£ş’
 = ()
¡¾’
(
£úame
);

672 
årštf
(
f
, "\n[%s]\n", 
£úame
);

673 
¥rštf
(
keym
, "%s:", 
£úame
);

674 
j
=0 ; j<
d
->
size
 ; j++) {

675 ià(
d
->
key
[
j
]==
NULL
)

677 ià(!
¡ºcmp
(
d
->
key
[
j
], 
keym
, 
£ş’
+1)) {

678 
årštf
(
f
,

680 
d
->
key
[
j
]+
£ş’
+1,

681 
d
->
v®
[
j
] ? d->val[j] : "");

685 
årštf
(
f
, "\n");

707 * 
š¬£r_g‘¡r
(
diùiÚ¬y
 * 
d
, * 
key
)

709  
š¬£r_g‘¡ršg
(
d
, 
key
, 
NULL
);

728 * 
š¬£r_g‘¡ršg
(
diùiÚ¬y
 * 
d
, * 
key
, * 
def
)

730 * 
lc_key
 ;

731 * 
sv®
 ;

733 ià(
d
==
NULL
 || 
key
==NULL)

734  
def
 ;

736 
lc_key
 = 
¡rdup
(
¡¾wc
(
key
));

737 
sv®
 = 
diùiÚ¬y_g‘
(
d
, 
lc_key
, 
def
);

738 
ä“
(
lc_key
);

739  
sv®
 ;

757 
š¬£r_g‘št
(
diùiÚ¬y
 * 
d
, * 
key
, 
nÙfound
)

759 * 
¡r
 ;

761 
¡r
 = 
š¬£r_g‘¡ršg
(
d
, 
key
, 
INI_INVALID_KEY
);

762 ià(
¡r
==
INI_INVALID_KEY
è 
nÙfound
 ;

764  
©Şl
(
¡r
);

781 
š¬£r_g‘doubË
(
diùiÚ¬y
 * 
d
, * 
key
, 
nÙfound
)

783 * 
¡r
 ;

785 
¡r
 = 
š¬£r_g‘¡ršg
(
d
, 
key
, 
INI_INVALID_KEY
);

786 ià(
¡r
==
INI_INVALID_KEY
è 
nÙfound
 ;

787  
©of
(
¡r
);

824 
š¬£r_g‘boŞ—n
(
diùiÚ¬y
 * 
d
, * 
key
, 
nÙfound
)

826 * 
c
 ;

827 
»t
 ;

829 
c
 = 
š¬£r_g‘¡ršg
(
d
, 
key
, 
INI_INVALID_KEY
);

830 ià(
c
==
INI_INVALID_KEY
è 
nÙfound
 ;

831 ià(
c
[0]=='y' || c[0]=='Y' || c[0]=='1' || c[0]=='t' || c[0]=='T') {

832 
»t
 = 1 ;

833 } ià(
c
[0]=='n' || c[0]=='N' || c[0]=='0' || c[0]=='f' || c[0]=='F') {

834 
»t
 = 0 ;

836 
»t
 = 
nÙfound
 ;

838  
»t
;

855 
š¬£r_fšd_’Œy
(

856 
diùiÚ¬y
 * 
ši
,

857 * 
’Œy


860 
found
=0 ;

861 ià(
š¬£r_g‘¡ršg
(
ši
, 
’Œy
, 
INI_INVALID_KEY
)!=INI_INVALID_KEY) {

862 
found
 = 1 ;

864  
found
 ;

883 
š¬£r_£t¡r
(
diùiÚ¬y
 * 
ši
, * 
’Œy
, * 
v®
)

885 
diùiÚ¬y_£t
(
ši
, 
¡¾wc
(
’Œy
), 
v®
);

899 
š¬£r_un£t
(
diùiÚ¬y
 * 
ši
, * 
’Œy
)

901 
diùiÚ¬y_un£t
(
ši
, 
¡¾wc
(
’Œy
));

920 
diùiÚ¬y
 * 
š¬£r_Ãw
(*
ššame
)

922 
diùiÚ¬y
 * 
d
 ;

923 
lš
[
ASCIILINESZ
+1];

924 
£c
[
ASCIILINESZ
+1];

925 
key
[
ASCIILINESZ
+1];

926 
v®
[
ASCIILINESZ
+1];

927 * 
wh”e
 ;

928 
FILE
 * 
ši
 ;

929 
lš’o
 ;

931 ià((
ši
=
fİ’
(
ššame
, "r"))==
NULL
) {

932  
NULL
 ;

935 
£c
[0]=0;

940 
d
 = 
diùiÚ¬y_Ãw
(0);

941 
lš’o
 = 0 ;

942 
fg‘s
(
lš
, 
ASCIILINESZ
, 
ši
)!=
NULL
) {

943 
lš’o
++ ;

944 
wh”e
 = 
¡rskp
(
lš
);

945 ià(*
wh”e
==';' || *where=='#' || *where==0)

948 ià(
ssÿnf
(
wh”e
, "[%[^]]", 
£c
)==1) {

950 
¡rıy
(
£c
, 
¡¾wc
(sec));

951 
š¬£r_add_’Œy
(
d
, 
£c
, 
NULL
, NULL);

952 } ià(
ssÿnf
 (
wh”e
, "%[^=] = \"%[^\"]\"", 
key
, 
v®
) == 2

953 || 
ssÿnf
 (
wh”e
, "%[^=] = '%[^\']'", 
key
, 
v®
) == 2

954 || 
ssÿnf
 (
wh”e
, "%[^=] = %[^;#]", 
key
, 
v®
) == 2) {

955 
¡rıy
(
key
, 
¡¾wc
(
¡rüİ
(key)));

960 ià(!
¡rcmp
(
v®
, "\"\"") || !strcmp(val, "''")) {

961 
v®
[0] = ()0;

963 
¡rıy
(
v®
, 
¡rüİ
(val));

965 
š¬£r_add_’Œy
(
d
, 
£c
, 
key
, 
v®
);

969 
fşo£
(
ši
);

970  
d
 ;

987 
š¬£r_ä“
(
diùiÚ¬y
 * 
d
)

989 
diùiÚ¬y_d–
(
d
);

992 #ifdeà
__ılu¥lus


	@application/kvbench/utils/iniparser.h

31 #iâdeà
_INIPARSER_H_


32 
	#_INIPARSER_H_


	)

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 #ià!
defšed
(
WIN32
è&& !defšed(
_WIN32
)

37 
	~<uni¡d.h
>

39 
	~<ùy³.h
>

41 #ifdeà
__ılu¥lus


46 
	s_diùiÚ¬y_
 {

48 
n
;

50 
size
;

52 **
v®
;

54 **
key
 ;

56 *
hash
;

57 } 
	tdiùiÚ¬y
 ;

62 
diùiÚ¬y
 * 
š¬£r_Ãw
(*
ššame
);

63 
š¬£r_ä“
(
diùiÚ¬y
 * 
d
);

65 
š¬£r_g‘n£c
(
diùiÚ¬y
 * 
d
);

66 * 
š¬£r_g‘£úame
(
diùiÚ¬y
 * 
d
, 
n
);

67 
š¬£r_dump
(
diùiÚ¬y
 * 
d
, 
FILE
 * 
f
);

68 
š¬£r_dump_ši
(
diùiÚ¬y
 * 
d
, 
FILE
 * 
f
);

69 * 
š¬£r_g‘key
(
diùiÚ¬y
 *
d
, *
£ùiÚ
, *
key
);

70 * 
š¬£r_g‘¡r
(
diùiÚ¬y
 * 
d
, * 
key
);

71 * 
š¬£r_g‘¡ršg
(
diùiÚ¬y
 * 
d
, * 
key
, * 
def
);

72 
š¬£r_g‘št
(
diùiÚ¬y
 * 
d
, * 
key
, 
nÙfound
);

73 
š¬£r_g‘doubË
(
diùiÚ¬y
 * 
d
, * 
key
, 
nÙfound
);

74 
š¬£r_g‘boŞ—n
(
diùiÚ¬y
 * 
d
, * 
key
, 
nÙfound
);

75 
š¬£r_fšd_’Œy
(
diùiÚ¬y
 * 
ši
, * 
’Œy
);

76 
š¬£r_£t¡r
(
diùiÚ¬y
 * 
ši
, * 
’Œy
, * 
v®
);

77 
š¬£r_un£t
(
diùiÚ¬y
 * 
ši
, * 
’Œy
);

79 #ifdeà
__ılu¥lus


	@application/kvbench/utils/keygen.cc

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dlib.h
>

4 
	~<¡dšt.h
>

6 
	~"keyg’.h
"

7 
	~"üc32.h
"

9 *
	gabt_¬¿y
 =

13 
	$keyg’_š™
(

14 
keyg’
 *keygen,

15 
size_t
 
Å»fix
,

16 
ºdšfo
 *
´efix_Ën
,

17 
ºdšfo
 *
´efix_di¡
,

18 
keyg’_İtiÚ
 *
İt
)

20 
keyg’
->
Å»fix
 =‚prefix;

21 
keyg’
->
´efix_Ën
 = (
ºdšfo
 *)
	`m®loc
((ºdšfoè* 
Å»fix
);

22 
keyg’
->
´efix_di¡
 = (
ºdšfo
 *)
	`m®loc
((ºdšfoè* 
Å»fix
);

23 
keyg’
->
İt
 = *opt;

24 
keyg’
->
abt_¬¿y_size
 = 
	`¡¾’
(
abt_¬¿y
);

26 
	`memıy
(
keyg’
->
´efix_Ën
,…»fix_Ën, (
ºdšfo
è* 
Å»fix
);

27 
	`memıy
(
keyg’
->
´efix_di¡
,…»fix_di¡, (
ºdšfo
è* 
Å»fix
);

28 
	}
}

30 
	$keyg’_ä“
(
keyg’
 *keygen)

32 
	`ä“
(
keyg’
->
´efix_Ën
);

33 
	`ä“
(
keyg’
->
´efix_di¡
);

34 
	}
}

36 
	$_üc2key
(
keyg’
 *keyg’, 
ušt64_t
 
üc
, *
buf
, 
size_t
 
Ën
, 
ušt8_t
 
abt_Úly
)

38 
size_t
 
i
;

39 
	`BDR_RNG_VARS_SET
(
üc
);

40 
BDR_RNG_NEXTPAIR
;

41 
BDR_RNG_NEXT
;

43 
i
=0;i<
Ën
;i+=1){

44 
BDR_RNG_NEXTPAIR
;

45 ià(
abt_Úly
) {

46 
buf
[
i
] = 
abt_¬¿y
[(
ºgz
%(
keyg’
->
abt_¬¿y_size
))];

49 
buf
[
i
] = 
ºgz
 & 0xff;

52 
	}
}

54 
size_t
 
	$_üc2keyËn
(
ºdšfo
 *
´efix_Ën
, 
ušt64_t
 
üc
)

56 
size_t
 
r
;

57 
	`BDR_RNG_VARS_SET
(
üc
);

58 
BDR_RNG_NEXTPAIR
;

59 
BDR_RNG_NEXT
;

61 
r
 = 
	`g‘_¿ndom
(
´efix_Ën
, 
ºgz
, 
ºgz2
);

62  
r
;

63 
	}
}

65 
ušt32_t
 
	$keyg’_idx2üc
(
ušt64_t
 
idx
, 
ušt32_t
 
£ed
)

67 
ušt32_t
 
üc
;

68 
ušt64_t
 
idx64
 = 
idx
;

69 
üc
 = 
	`üc32_8
(&
idx64
, (idx64), 
£ed
);

70 
üc
 = 
	`üc32_8
(&
idx64
, (idx64), crc);

71  
üc
;

72 
	}
}

74 
ušt64_t
 
	$MurmurHash64A
 ( cÚ¡ * 
key
, 
Ën
, 
£ed
 )

76 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

77 cÚ¡ 
r
 = 47;

79 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

81 cÚ¡ 
ušt64_t
 * 
d©a
 = (cÚ¡ ušt64_ˆ*)
key
;

82 cÚ¡ 
ušt64_t
 * 
’d
 = 
d©a
 + (
Ën
/8);

84 
d©a
 !ğ
’d
)

86 
ušt64_t
 
k
 = *
d©a
++;

88 
k
 *ğ
m
;

89 
k
 ^ğk >> 
r
;

90 
k
 *ğ
m
;

92 
h
 ^ğ
k
;

93 
h
 *ğ
m
;

96 cÚ¡ * 
d©a2
 = (cÚ¡ *)
d©a
;

98 
Ën
 & 7)

100 7: 
h
 ^ğ
	`ušt64_t
(
d©a2
[6]) << 48;

101 6: 
h
 ^ğ
	`ušt64_t
(
d©a2
[5]) << 40;

102 5: 
h
 ^ğ
	`ušt64_t
(
d©a2
[4]) << 32;

103 4: 
h
 ^ğ
	`ušt64_t
(
d©a2
[3]) << 24;

104 3: 
h
 ^ğ
	`ušt64_t
(
d©a2
[2]) << 16;

105 2: 
h
 ^ğ
	`ušt64_t
(
d©a2
[1]) << 8;

106 1: 
h
 ^ğ
	`ušt64_t
(
d©a2
[0]);

107 
h
 *ğ
m
;

110 
h
 ^ğh >> 
r
;

111 
h
 *ğ
m
;

112 
h
 ^ğh >> 
r
;

114  
h
;

115 
	}
}

117 
size_t
 
	$keyg’_£ed2key
(
keyg’
 *keyg’, 
ušt64_t
 
£ed
, *
buf
, 
keyËn
)

119 
ušt64_t
 
i
;

120 
size_t
 
Ën
, 
cursÜ
;

121 
ušt64_t
 
£ed_loÿl
, 
£ed64
, 
ºd_£l
;

123 
£ed64
 = 
	`MurmurHash64A
(&
£ed
, (
ušt64_t
), 0);

124 
	`BDR_RNG_VARS_SET
(
£ed64
);

125 
BDR_RNG_NEXTPAIR
;

126 
BDR_RNG_NEXT
;

128 
cursÜ
 = 0;

130 
i
=0;i<
keyg’
->
Å»fix
;++i){

131 ià(
i
+1 =ğ
keyg’
->
Å»fix
) {

132 if(
keyËn
 > 0)

133 
Ën
 = 
keyËn
 - 1;

135 
Ën
 = 
	`_üc2keyËn
(&
keyg’
->
´efix_Ën
[
i
], 
£ed64
);

140 
	`_üc2key
(
keyg’
, 
£ed64
, 
buf
 + 
cursÜ
, 
Ën
, keyg’->
İt
.
abt_Úly
);

142 
BDR_RNG_NEXTPAIR
;

143 
BDR_RNG_NEXT
;

144 
ºd_£l
 = 
	`g‘_¿ndom
(&
keyg’
->
´efix_di¡
[
i
], 
ºgz
, 
ºgz2
);

145 
£ed_loÿl
 = 
	`MurmurHash64A
(&
ºd_£l
, (rnd_sel), 0);

147 
Ën
 = 
	`_üc2keyËn
(&
keyg’
->
´efix_Ën
[
i
], 
£ed_loÿl
);

148 
	`_üc2key
(
keyg’
, 
£ed_loÿl
, 
buf
 + 
cursÜ
, 
Ën
, keyg’->
İt
.
abt_Úly
);

151 
cursÜ
 +ğ
Ën
;

153 ià(
keyg’
->
İt
.
d–im™”
 && 
i
 !ğkeyg’->
Å»fix
-1) {

154 
buf
[
cursÜ
] = '/';

155 
cursÜ
++;

160 
buf
[
cursÜ
] = 0;

161  
cursÜ
;

162 
	}
}

164 
size_t
 
	$keyg’_£qfl
(
ušt64_t
 
idx
, *
buf
, 
Ën
){

166 
	`¥rštf
(
buf
, "%0*ld", 
Ën
 -1 , 
idx
);

168  
Ën
;

169 
	}
}

	@application/kvbench/utils/keygen.h

1 #iâdeà
_JSAHN_KEYGEN_H


2 
	#_JSAHN_KEYGEN_H


	)

4 
	~"adv_¿ndom.h
"

6 #ifdeà
__ılu¥lus


10 
	skeyg’_İtiÚ
 {

11 
ušt8_t
 
d–im™”
;

12 
ušt8_t
 
abt_Úly
;

15 
	skeyg’
 {

16 
size_t
 
Å»fix
;

17 
size_t
 
abt_¬¿y_size
;

18 
ºdšfo
 *
´efix_Ën
;

19 
ºdšfo
 *
´efix_di¡
;

20 
keyg’_İtiÚ
 
İt
;

23 
keyg’_š™
(

24 
keyg’
 *keygen,

25 
size_t
 
Å»fix
,

26 
ºdšfo
 *
´efix_Ën
,

27 
ºdšfo
 *
´efix_di¡
,

28 
keyg’_İtiÚ
 *
İt
);

30 
ušt64_t
 
MurmurHash64A
ĞcÚ¡ * 
key
, 
Ën
, 
£ed
 );

32 
keyg’_ä“
(
keyg’
 *keygen);

33 
ušt32_t
 
keyg’_idx2üc
(
ušt64_t
 
idx
, ušt32_ˆ
£ed
);

34 
size_t
 
keyg’_£ed2key
(
keyg’
 *keyg’, 
ušt64_t
 
£ed
, *
buf
, 
keyËn
);

35 
size_t
 
keyg’_£qfl
(
ušt64_t
 
idx
, *
buf
, 
Ën
);

37 #ifdeà
__ılu¥lus


	@application/kvbench/utils/keyloader.cc

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dlib.h
>

4 
	~<¡dšt.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

8 
	~"sys/mmª.h
"

9 
	~"keylßd”.h
"

10 
	~"memËak.h
"

12 
	$keylßd”_š™
(
keylßd”
 *
hªdË
,

13 *
f’ame
,

14 
keylßd”_İtiÚ
 *
İtiÚ
)

16 
r_æag
, 
fœ¡_key_found
;

17 
ušt64_t
 
i
, 
begš_pos
, 
Ï¡_pos
;

18 
ušt64_t
 
£gsize
 = 256;

20 
begš_pos
 = 
Ï¡_pos
 = 0;

23 
hªdË
->
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

24 ià(
hªdË
->
fd
 < 0) {

27 
hªdË
->
nkeys
 = 0;

28 
hªdË
->
avg_keysize
 = 0;

29 
hªdË
->
fesize
 = 
	`l£ek
(hªdË->
fd
, 0, 
SEEK_END
);

31 
hªdË
->
m­
 = (*)
	`mm­
(0, hªdË->
fesize
, 
PROT_READ
,

32 
MAP_SHARED
, 
hªdË
->
fd
, 0);

33 ià(
hªdË
->
m­
 =ğ
MAP_FAILED
) {

34 
	`şo£
(
hªdË
->
fd
);

38 
hªdË
->
¬r
 = (
keylßd”_¬¿y
*)

39 
	`m®loc
((
keylßd”_¬¿y
è* 
£gsize
);

41 
r_æag
 = 
fœ¡_key_found
 = 0;

42 
i
=0;i<
hªdË
->
fesize
;++i) {

43 ià(
hªdË
->
m­
[
i
] == 0x0d || handle->map[i] == 0x0a) {

45 ià(!
r_æag
 && 
fœ¡_key_found
) {

47 
hªdË
->
¬r
[hªdË->
nkeys
].
Ën
 = 
Ï¡_pos
 - 
begš_pos
 + 1;

48 
hªdË
->
avg_keysize
 +ğhªdË->
¬r
[hªdË->
nkeys
].
Ën
;

49 
hªdË
->
nkeys
++;

50 ià(
İtiÚ
->
max_nkeys
 &&

51 
hªdË
->
nkeys
 >ğ
İtiÚ
->
max_nkeys
) {

52 
r_æag
 = 1;

56 ià(
hªdË
->
nkeys
 >ğ
£gsize
) {

57 
£gsize
 *= 2;

58 
hªdË
->
¬r
 = (
keylßd”_¬¿y
*)

59 
	`»®loc
(
hªdË
->
¬r
, (
keylßd”_¬¿y
) *

60 
£gsize
);

63 
r_æag
 = 1;

65 ià(!
fœ¡_key_found
) {

67 
hªdË
->
¬r
[0].
off£t
 = 
i
;

68 
begš_pos
 = 
i
;

69 
fœ¡_key_found
 = 1;

70 } ià(
r_æag
) {

71 
hªdË
->
¬r
[hªdË->
nkeys
].
off£t
 = 
i
;

72 
begš_pos
 = 
i
;

74 
Ï¡_pos
 = 
i
;

75 
r_æag
 = 0;

79 ià(!
r_æag
) {

80 
hªdË
->
¬r
[hªdË->
nkeys
].
Ën
 = 
Ï¡_pos
 - 
begš_pos
 + 1;

81 
hªdË
->
avg_keysize
 +ğhªdË->
¬r
[hªdË->
nkeys
].
Ën
;

82 
hªdË
->
nkeys
++;

84 ià(
hªdË
->
nkeys
) {

85 
hªdË
->
avg_keysize
 /ğhªdË->
nkeys
;

89 
	}
}

91 
ušt64_t
 
	$keylßd”_g‘_nkeys
(
keylßd”
 *
hªdË
)

93  
hªdË
->
nkeys
;

94 
	}
}

96 
size_t
 
	$keylßd”_g‘_avg_keyËn
(
keylßd”
 *
hªdË
)

98  
hªdË
->
avg_keysize
;

99 
	}
}

101 
size_t
 
	$keylßd”_g‘_key
(
keylßd”
 *
hªdË
, 
ušt64_t
 
idx
, *
buf
)

103 
size_t
 
Ën
;

105 ià(
idx
 >ğ
hªdË
->
nkeys
) {

109 
Ën
 = 
hªdË
->
¬r
[
idx
].len;

110 
	`memıy
(
buf
, 
hªdË
->
m­
 + hªdË->
¬r
[
idx
].
off£t
, 
Ën
);

111 
buf
[
Ën
] = 0;

113  
Ën
;

114 
	}
}

116 
	$keylßd”_ä“
(
keylßd”
 *
hªdË
)

118 
	`munm­
(
hªdË
->
m­
, hªdË->
fesize
);

119 
	`ä“
(
hªdË
->
¬r
);

120 
	`şo£
(
hªdË
->
fd
);

121 
	}
}

	@application/kvbench/utils/keyloader.h

1 #iâdeà
_FDBBENCH_KEYLOADER_H


2 
	#_FDBBENCH_KEYLOADER_H


	)

4 
	~<¡dšt.h
>

6 #ifdeà
__ılu¥lus


10 
	skeylßd”_İtiÚ
 {

11 
ušt64_t
 
max_nkeys
;

14 
	skeylßd”_¬¿y
 {

15 
ušt64_t
 
off£t
;

16 
ušt32_t
 
Ën
;

19 
	skeylßd”
 {

20 
ušt64_t
 
nkeys
;

21 
ušt64_t
 
fesize
;

22 
fd
;

23 *
m­
;

24 
keylßd”_¬¿y
 *
¬r
;

25 
ušt64_t
 
avg_keysize
;

28 
keylßd”_š™
(
keylßd”
 *
hªdË
,

29 *
f’ame
,

30 
keylßd”_İtiÚ
 *
İtiÚ
);

32 
ušt64_t
 
keylßd”_g‘_nkeys
(
keylßd”
 *
hªdË
);

33 
size_t
 
keylßd”_g‘_avg_keyËn
(
keylßd”
 *
hªdË
);

35 
size_t
 
keylßd”_g‘_key
(
keylßd”
 *
hªdË
, 
ušt64_t
 
idx
, *
buf
);

36 
keylßd”_ä“
(
keylßd”
 *
hªdË
);

38 #ifdeà
__ılu¥lus


	@application/kvbench/utils/memleak.cc

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<¡dlib.h
>

12 
	~<as£¹.h
>

13 #ià!
defšed
(
__APPLE__
)

14 
	~<m®loc.h
>

17 
	~"¬ch.h
"

19 
	#_MALLOC_OVERRIDE


	)

20 
	#INIT_VAL
 (0x77)

	)

21 
	#FREE_VAL
 (0xff)

	)

24 #ià!
defšed
(
_WIN32
è&& !defšed(
WIN32
)

29 
	~"memËak.h
"

31 #ifdeà
_STACK_BACKTRACE


32 
	~<execšfo.h
>

34 #ifdeà
_LIBBFD


35 
	~<dlfú.h
>

36 
	~<sigÇl.h
>

37 
	~<bfd.h
>

38 
	~<uni¡d.h
>

41 
bfd
* 
	gabfd
 = 0;

42 
asymbŞ
 **
	gsyms
 = 0;

43 
a£ùiÚ
 *
	g‹xt
 = 0;

45 
	$»sŞve
(*
add»ss
, **
fe
, **
func
, *
lše
) {

46 ià(!
abfd
) {

47 
’ame
[1024];

48 
l
 = 
	`»adlšk
("/´oc/£lf/exe",
’ame
,(ename));

49 ià(
l
 == -1) {

50 
	`³¼Ü
("failedo findƒxecutable\n");

53 
’ame
[
l
] = 0;

55 
	`bfd_š™
();

57 
abfd
 = 
	`bfd_İ’r
(
’ame
, 0);

58 ià(!
abfd
) {

59 
	`³¼Ü
("bfd_openr failed: ");

63 
	`bfd_check_fÜm©
(
abfd
,
bfd_objeù
);

65 
¡Üage_Ãeded
 = 
	`bfd_g‘_symb_uµ”_bound
(
abfd
);

66 
syms
 = (
asymbŞ
 **è
	`m®loc
(
¡Üage_Ãeded
);

67 
cSymbŞs
 = 
	`bfd_ÿnÚiÿlize_symb
(
abfd
, 
syms
);

69 
‹xt
 = 
	`bfd_g‘_£ùiÚ_by_Çme
(
abfd
, ".text");

72 
off£t
 = (()
add»ss
è- 
‹xt
->
vma
;

73 ià(
off£t
 > 0) {

74 
	`bfd_fšd_Ã¬e¡_lše
(
abfd
, 
‹xt
, 
syms
, 
off£t
,

75 (cÚ¡ **)
fe
, (cÚ¡ **)
func
, 
lše
);

77 
	}
}

84 #ifdeà
_PRINT_DBG


85 
	#DBG
(...è
	`årštf
(
¡d”r
, 
__VA_ARGS__
)

	)

87 
	#DBG
(...)

	)

90 
	~"avÉ»e.h
"

92 
	smemËak_™em
 {

93 
ušt64_t
 
	maddr
;

94 *
	mfe
;

95 
size_t
 
	msize
;

96 
size_t
 
	mlše
;

97 
avl_node
 
	mavl
;

98 #ifdeà
_STACK_BACKTRACE


99 
size_t
 
	mbt_size
;

100 **
	mbŒaû
;

102 #ifdeà
_CHK_MODIFY_AFTER_FREE


103 
ušt8_t
 
	mä“d
;

107 
avl_Œ“
 
	gŒ“_šdex
;

108 
ušt8_t
 
	g¡¬t_sw
 = 0;

109 
¥š_t
 
	glock
;

111 
	$memËak_cmp
(
avl_node
 *
a
, avl_nod*
b
, *
aux
)

113 
memËak_™em
 *
¯
, *
bb
;

114 
¯
 = 
	`_g‘_’Œy
(
a
, 
memËak_™em
, 
avl
);

115 
bb
 = 
	`_g‘_’Œy
(
b
, 
memËak_™em
, 
avl
);

116 ià(
¯
->
addr
 < 
bb
->addr)  -1;

117 ià(
¯
->
addr
 > 
bb
->addr)  1;

119 
	}
}

121 
LIBMEMLEAK_API


122 
	$memËak_¡¬t
()

124 
	`¥š_š™
(&
lock
);

125 
	`avl_š™
(&
Œ“_šdex
, 
NULL
);

126 
¡¬t_sw
 = 1;

127 
	}
}

129 
LIBMEMLEAK_API


130 
	$memËak_’d
()

132 
ušt8_t
 
is_Ëaked
;

133 
size_t
 
couÁ
 = 0;

134 
avl_node
 *
a
;

135 
memËak_™em
 *
™em
;

136 #ifdeà
_STACK_BACKTRACE


137 
i
;

138 **
¡rs
;

139 *
fe
, *
func
;

140 
lše
;

143 
	`¥š_lock
(&
lock
);

145 
¡¬t_sw
 = 0;

147 
a
 = 
	`avl_fœ¡
(&
Œ“_šdex
);

148 
a
){

149 
™em
 = 
	`_g‘_’Œy
(
a
, 
memËak_™em
, 
avl
);

150 
a
 = 
	`avl_Ãxt
(a);

151 
	`avl_»move
(&
Œ“_šdex
, &
™em
->
avl
);

152 
is_Ëaked
 = 1;

154 #ifdeà
_CHK_MODIFY_AFTER_FREE


155 
i
;

156 
ušt8_t
 *
addr
;

157 ià(
™em
->
ä“d
) {

158 
is_Ëaked
 = 0;

159 
addr
 = (
ušt8_t
*)
™em
->addr;

160 
i
=0;i<
™em
->
size
;++i){

161 ià(*(
addr
 + 
i
è!ğ
FREE_VAL
) {

162 
	`årštf
(
¡d”r
,

165 ()
™em
->
addr
, i‹m->
fe
,

166 
™em
->
lše
, i‹m->
size
);

170 
	`ä“
(
addr
);

174 ià(
is_Ëaked
) {

175 
	`årštf
(
¡d”r
, "address 0x%016lx (allocated‡t %s:%lu, size %lu) "

177 ()
™em
->
addr
, i‹m->
fe
,

178 ()
™em
->
lše
, ()™em->
size
);

179 
couÁ
++;

180 #ifdeà
_STACK_BACKTRACE


181 
¡rs
 = 
	`backŒaû_symbŞs
(
™em
->
bŒaû
, i‹m->
bt_size
);

182 
i
=0;i<
™em
->
bt_size
;++i){

183 #ifdeà
_LIBBFD


184 
	`»sŞve
(
™em
->
bŒaû
[
i
], &
fe
, &
func
, &
lše
);

185 
	`årštf
(
¡d”r
, " % [%s:%d]\n", 
func
, 
fe
, 
lše
);

187 
	`årštf
(
¡d”r
, " %s\n", 
¡rs
[
i
]);

190 
	`ä“
(
™em
->
bŒaû
);

193 
	`ä“
(
™em
);

195 ià(
couÁ
 > 0è
	`årštf
(
¡d”r
, "total %d objects\n", ()count);

197 
	`¥š_uÆock
(&
lock
);

198 
	}
}

200 
	$_memËak_add_to_šdex
(*
addr
, 
size_t
 
size
, *
fe
, size_ˆ
lše
, 
ušt8_t
 
š™_v®
)

202 
	`DBG
("m®loø© %s:%ld, siz%ld\n", 
fe
, 
lše
, 
size
);

203 
memËak_™em
 *
™em
 = (memËak_™em *)
	`m®loc
((memleak_item));

204 
™em
->
addr
 = (
ušt64_t
)addr;

205 
™em
->
fe
 = file;

206 
™em
->
lše
 =†ine;

207 
™em
->
size
 = size;

208 #ifdeà
INIT_VAL


209 
	`mem£t
(
addr
, 
š™_v®
, 
size
);

211 #ifdeà
_STACK_BACKTRACE


212 *
‹mp_¡ack
[256];

213 
™em
->
bt_size
 = 
	`backŒaû
(
‹mp_¡ack
, 256);

214 
™em
->
bŒaû
 = (**)
	`m®loc
((*è* i‹m->
bt_size
);

215 
	`memıy
(
™em
->
bŒaû
, 
‹mp_¡ack
, (*è* i‹m->
bt_size
);

217 #ifdeà
_CHK_MODIFY_AFTER_FREE


218 
™em
->
ä“d
 = 0;

220 
	`avl_š£¹
(&
Œ“_šdex
, &
™em
->
avl
, 
memËak_cmp
);

221 
	}
}

223 
LIBMEMLEAK_API


224 * 
	$memËak_®loc
(
size_t
 
size
, *
fe
, size_ˆ
lše
)

226 *
addr
 = (*)
	`m®loc
(
size
);

227 ià(
addr
 && 
¡¬t_sw
) {

228 
	`¥š_lock
(&
lock
);

229 
	`_memËak_add_to_šdex
(
addr
, 
size
, 
fe
, 
lše
, 
INIT_VAL
);

230 
	`¥š_uÆock
(&
lock
);

233  
addr
;

234 
	}
}

236 
LIBMEMLEAK_API


237 * 
	$memËak_ÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, *
fe
, size_ˆ
lše
)

239 *
addr
 = (*)
	`ÿÎoc
(
nmemb
, 
size
);

240 ià(
addr
 && 
¡¬t_sw
) {

241 
	`¥š_lock
(&
lock
);

242 
	`_memËak_add_to_šdex
(
addr
, 
size
, 
fe
, 
lše
, 0x0);

243 
	`¥š_uÆock
(&
lock
);

246  
addr
;

247 
	}
}

249 #iâdeà
WIN32


251 
LIBMEMLEAK_API


252 
	$memËak_posix_mem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
, *
fe
, size_ˆ
lše
)

255 
»t
 = 
	`posix_mem®ign
(
mem±r
, 
®ignm’t
, 
size
);

256 ià(
»t
==0 && 
¡¬t_sw
)

258 
	`¥š_lock
(&
lock
);

259 
	`_memËak_add_to_šdex
(*
mem±r
, 
size
, 
fe
, 
lše
, 
INIT_VAL
);

260 
	`¥š_uÆock
(&
lock
);

263  
»t
;

264 
	}
}

267 
LIBMEMLEAK_API


268 * 
	$memËak_®igÃd_m®loc
(
size_t
 
size
, size_ˆ
®ignm’t
, *
fe
, size_ˆ
lše
)

270 *
addr
 = (*)
	`_®igÃd_m®loc
(
size
, 
®ignm’t
);

271 ià(
addr
 && 
¡¬t_sw
) {

272 
	`¥š_lock
(&
lock
);

273 
	`_memËak_add_to_šdex
(
addr
, 
size
, 
fe
, 
lše
, 
INIT_VAL
);

274 
	`¥š_uÆock
(&
lock
);

276  
addr
;

277 
	}
}

279 
LIBMEMLEAK_API


280 
	$memËak_®igÃd_ä“
(*
addr
, *
fe
, 
size_t
 
lše
)

282 
avl_node
 *
a
;

283 
memËak_™em
 *
™em
, 
qu”y
;

285 ià(
¡¬t_sw
) {

286 
	`¥š_lock
(&
lock
);

288 
qu”y
.
addr
 = (
ušt64_t
)addr;

289 
a
 = 
	`avl_£¬ch
(&
Œ“_šdex
, &
qu”y
.
avl
, 
memËak_cmp
);

290 ià(!
a
) {

291 #ifdeà
_WARN_NOT_ALLOCATED_MEMORY


292 
	`årštf
(
¡d”r
, "tryo free‚ot‡llocated memory‡ddress 0x%016lx‡t %s:%ld\n",

293 ()
addr
, 
fe
, 
lše
);

295 
	`¥š_uÆock
(&
lock
);

299 
™em
 = 
	`_g‘_’Œy
(
a
, 
memËak_™em
, 
avl
);

300 
	`DBG
("free‡ddress 0x%016lx (allocated‡t %s:%ld, size %ld)\n",

301 
™em
->
addr
, i‹m->
fe
, i‹m->
lše
, i‹m->
size
);

302 #ifdeà
FREE_VAL


303 
	`mem£t
(
addr
, 
FREE_VAL
, 
™em
->
size
);

306 
	`avl_»move
(&
Œ“_šdex
, 
a
);

307 #ifdeà
_STACK_BACKTRACE


308 
	`ä“
(
™em
->
bŒaû
);

310 
	`ä“
(
™em
);

311 
	`¥š_uÆock
(&
lock
);

313 
	`_®igÃd_ä“
(
addr
);

314 
	}
}

318 
LIBMEMLEAK_API


319 *
	$memËak_»®loc
(*
±r
, 
size_t
 
size
)

322 *
addr
 = (*)
	`»®loc
(
±r
, 
size
);

323 ià(
addr
 && 
¡¬t_sw
) {

324 
	`¥š_lock
(&
lock
);

325 
avl_node
 *
a
;

326 
memËak_™em
 *
™em
, 
qu”y
;

328 
qu”y
.
addr
 = (
ušt64_t
)
±r
;

329 
a
 = 
	`avl_£¬ch
(&
Œ“_šdex
, &
qu”y
.
avl
, 
memËak_cmp
);

330 ià(
a
) {

331 
™em
 = 
	`_g‘_’Œy
(
a
, 
memËak_™em
, 
avl
);

332 
	`DBG
("realloc from‡ddress 0x%016lx (allocated‡t %s:%ld, size %ld)\n\tto‡ddress 0x%016lx (size %ld)\n",

333 
™em
->
addr
, i‹m->
fe
, i‹m->
lše
, i‹m->
size
, (
ušt64_t
)addr, size);

334 
	`avl_»move
(&
Œ“_šdex
, 
a
);

335 
	`_memËak_add_to_šdex
(
addr
, 
size
, 
™em
->
fe
, i‹m->
lše
, 
INIT_VAL
);

336 #ifdeà
_STACK_BACKTRACE


337 
	`ä“
(
™em
->
bŒaû
);

339 
	`ä“
(
™em
);

341 
	`¥š_uÆock
(&
lock
);

344  
addr
;

345 
	}
}

347 
LIBMEMLEAK_API


348 
	$memËak_ä“
(*
addr
, *
fe
, 
size_t
 
lše
)

350 
avl_node
 *
a
;

351 
memËak_™em
 *
™em
, 
qu”y
;

353 ià(
¡¬t_sw
) {

354 
	`¥š_lock
(&
lock
);

356 
qu”y
.
addr
 = (
ušt64_t
)addr;

357 
a
 = 
	`avl_£¬ch
(&
Œ“_šdex
, &
qu”y
.
avl
, 
memËak_cmp
);

358 ià(!
a
) {

359 #ifdeà
_WARN_NOT_ALLOCATED_MEMORY


360 
	`årštf
(
¡d”r
, "tryo free‚ot‡llocated memory‡ddress 0x%016lx‡t %s:%ld\n",

361 ()
addr
, 
fe
, 
lše
);

363 
	`¥š_uÆock
(&
lock
);

367 
™em
 = 
	`_g‘_’Œy
(
a
, 
memËak_™em
, 
avl
);

368 
	`DBG
("free‡ddress 0x%016lx (allocated‡t %s:%ld, size %ld)\n",

369 
™em
->
addr
, i‹m->
fe
, i‹m->
lše
, i‹m->
size
);

370 #ifdeà
FREE_VAL


371 
	`mem£t
(
addr
, 
FREE_VAL
, 
™em
->
size
);

374 #ifdeà
_STACK_BACKTRACE


375 
	`ä“
(
™em
->
bŒaû
);

378 #iâdeà
_CHK_MODIFY_AFTER_FREE


379 
	`avl_»move
(&
Œ“_šdex
, 
a
);

380 
	`ä“
(
™em
);

382 
™em
->
ä“d
 = 1;

384 
	`¥š_uÆock
(&
lock
);

386 #iâdeà
_CHK_MODIFY_AFTER_FREE


387 
	`ä“
(
addr
);

389 
	}
}

	@application/kvbench/utils/memleak.h

8 #iâdeà
_JSAHN_MEMLEAK_H


9 
	#_JSAHN_MEMLEAK_H


	)

11 
	~<¡dšt.h
>

13 #ifdeà
_MSC_VER


14 #ifdeà
fÜe¡db_EXPORTS


15 
	#LIBMEMLEAK_API
 
	`__deş¥ec
(
dÎexpÜt
)

	)

17 
	#LIBMEMLEAK_API


	)

20 
	#LIBMEMLEAK_API


	)

23 #ifdeà
__ılu¥lus


28 #iâdeà
_MEMLEAK_ENABLE


29 
	#_MALLOC_OVERRIDE


	)

31 #iâdeà
_MALLOC_OVERRIDE


32 
	#_MALLOC_OVERRIDE


	)

33 
	#m®loc
(
size
è
	`memËak_®loc
(size, (*)
__FILE__
, 
__LINE__
)

	)

34 
	#ÿÎoc
(
nmemb
, 
size
è
	`memËak_ÿÎoc
Òmemb, size, (*)
__FILE__
, 
__LINE__
)

	)

35 
	#»®loc
(
±r
, 
size
è
	`memËak_»®loc
ÕŒ, size);

	)

36 
	#ä“
(
addr
è
	`memËak_ä“
×ddr, (*)
__FILE__
, 
__LINE__
)

	)

37 #iâdeà
WIN32


38 
	#posix_mem®ign
(
mem±r
, 
®ignm’t
, 
size
) \

39 
	`memËak_posix_mem®ign
(
mem±r
, 
®ignm’t
, 
size
, (*)
__FILE__
, 
__LINE__
)

	)

41 
	#_®igÃd_m®loc
(
size
, 
®ign
) \

42 
	`memËak_®igÃd_m®loc
(
size
, 
®ign
, (*)
__FILE__
, 
__LINE__
)

	)

43 
	#_®igÃd_ä“
(
addr
) \

44 
	`memËak_®igÃd_ä“
(
addr
, (*)
__FILE__
, 
__LINE__
)

	)

48 
LIBMEMLEAK_API


49 
memËak_¡¬t
();

51 
LIBMEMLEAK_API


52 
memËak_’d
();

54 
LIBMEMLEAK_API


55 * 
memËak_®loc
(
size_t
 
size
, *
fe
, size_ˆ
lše
);

57 
LIBMEMLEAK_API


58 * 
memËak_ÿÎoc
(
size_t
 
nmemb
, size_ˆ
size
, *
fe
, size_ˆ
lše
);

60 
LIBMEMLEAK_API


61 * 
memËak_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
, *
fe
, size_ˆ
lše
);

63 
LIBMEMLEAK_API


64 *
memËak_»®loc
(*
±r
, 
size_t
 
size
);

66 
LIBMEMLEAK_API


67 
memËak_ä“
(*
addr
, *
fe
, 
size_t
 
lše
);

69 #iâdeà
WIN32


70 
LIBMEMLEAK_API


71 
memËak_posix_mem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
, *
fe
, size_ˆ
lše
);

73 
LIBMEMLEAK_API


74 * 
memËak_®igÃd_m®loc
(
size_t
 
size
, size_ˆ
®ignm’t
, *
fe
, size_ˆ
lše
);

75 
LIBMEMLEAK_API


76 
memËak_®igÃd_ä“
(*
addr
, *
fe
, 
size_t
 
lše
);

79 #ifdeà
__ılu¥lus


	@application/kvbench/utils/memory.cc

1 
	~<¡dlib.h
>

2 
	~<¡dio.h
>

4 
	~"memÜy.h
"

5 #ià
defšed
 
__KV_BENCH


6 
	~"kvs_­i.h
"

9 
FILE
 *
	gıu_å
 = 
NULL
;

10 
	g¡d
::
¡ršg
 
	$»ad_sšgËlše_sysfe
(cÚ¡ *
·th
) {

11 
¡d
::
¡ršg
 
v®
;

12 
¡d
::
if¡»am
 
	`sysfe
 (
·th
);

13 ià(
sysfe
.
	`is_İ’
(è&& !sysfe.
	`eof
()) {

14 
sysfe
 >> 
v®
;

15 
sysfe
.
	`şo£
();

16  
v®
;

19 
	}
}

21 
	$·r£_ıuids
(
¡d
::
¡ršg
 &
ıu¡r
, &
fœ¡_ıuid
, &
£cÚd_ıuid
) {

23 
¡d
::
¡ršg
 
™em
;

24 
¡d
::
¡ršg¡»am
 
	`ss
(
ıu¡r
);

25 ià(
¡d
::
	`g‘lše
(
ss
, 
™em
, '-')) {

26 
fœ¡_ıuid
 = 
¡d
::
	`©oi
(
™em
.
	`c_¡r
());

27 ià(
¡d
::
	`g‘lše
(
ss
, 
™em
, '-')) {

28 
£cÚd_ıuid
 = 
¡d
::
	`©oi
(
™em
.
	`c_¡r
());

30 
£cÚd_ıuid
 = 
fœ¡_ıuid
;

36 
	}
}

38 
	$fšd_ıuli¡
(
nodeid
, 
ıu_šfo
 *
ıušfo
, 
cÚfig_Úly
) {

39 
num_ıus
 = 0, 
couÁ”s
 = 0;

40 
·th
[512];

41 
i
;

42 
	`¥rštf
(
·th
, "/sys/deviûs/sy¡em/node/node%d/ıuli¡", 
nodeid
);

44 
¡d
::
¡ršg
 
ıuli¡
 = 
	`»ad_sšgËlše_sysfe
(
·th
);

45 ià(
ıuli¡
.
	`Ëngth
() <= 0)  -1;

48 
¡d
::
¡ršg
 
™em
;

49 
¡d
::
¡ršg¡»am
 
	`ss
(
ıuli¡
);

51 
¡d
::
	`g‘lše
(
ss
, 
™em
, ',')) {

53 
fœ¡_ıuid
, 
£cÚd_ıuid
;

55 
»t
 = 
	`·r£_ıuids
(
™em
, 
fœ¡_ıuid
, 
£cÚd_ıuid
);

56 ià(
»t
 < 0)  -1;

58 
num_ıus
 = 
£cÚd_ıuid
 - 
fœ¡_ıuid
 + 1;

59 
i
 = 0; i < 
num_ıus
; i++) {

60 if(
cÚfig_Úly
 && 
ıu_å
)

61 
	`årštf
(
ıu_å
, "%d,%d,-1,-1\n",
nodeid
,
fœ¡_ıuid
 + 
i
);

62 
couÁ”s
++;

67  
couÁ”s
;

68 
	}
}

70 
	$g‘_ıušfo
(
ıu_šfo
 *
ıušfo
, 
cÚfig_Úly
) {

72 
fœ¡_ıuid
 = 0, 
Ï¡_ıuid
 = 
	`numa_max_node
();

73 
i
, 
j
;

74 
ıušfo
->
num_numªodes
 = 
Ï¡_ıuid
 - 
fœ¡_ıuid
 + 1;

75 if(
cÚfig_Úly
) {

76 
ıu_å
 = 
	`fİ’
("cpu.txt", "w");

77 
	`årštf
(
ıu_å
, "nodeid,coreid,dbid_load,dbid_perf\n");

80 
i
 = 0; i < 
ıušfo
->
num_numªodes
; i++) {

81 
ıušfo
->
num_cÜes_³r_numªodes
 = 
	`fšd_ıuli¡
(
fœ¡_ıuid
 + 
i
, cpušfo, 
cÚfig_Úly
);

82 ià(
ıušfo
->
num_cÜes_³r_numªodes
< 0)  -1;

85 if(
ıu_å
è
	`fşo£
(cpu_fp);

88 
	}
}

90 
	$g‘_curıu
(*
ch
, *
cÜe
)

92 
a
,
d
,
c
;

93 
__asm__
 vŞ©e("rdtsı" : "÷" (
a
), "=d" (
d
), "=c" (
c
));

94 *
ch
 = (
c
 & 0xFFF000)>>12;

95 *
cÜe
 = 
c
 & 0xFFF;

96  (()
a
è| ((()
d
) << 32);;

97 
	}
}

99 
	$š™Ÿlize
(*
memÜy
, cÚ¡ 
poŞ_šfo
 *
šfo
, 
mempoŞ_t
 *
poŞ
)

101 
poŞ
->
ba£
 = (*)
memÜy
;

102 
poŞ
->
block_size
 = 
šfo
->
un™size
;

103 
poŞ
->
num_blocks
 = 
šfo
->
numun™s
;

104 
poŞ
->
num_ä“blocks
 =…oŞ->
num_blocks
;

105 
poŞ
->
Ãxtä“block
 =…oŞ->
ba£
;

106 
poŞ
->
num_š™Ÿlizedblocks
 = 0;

107 
poŞ
->
Ãxt_ä“_idx
 = 0;

109 
	}
}

111 
	$de¡roy
(
®loÿtÜty³
, 
mempoŞ_t
 *
poŞ
) {

113 #ià!
defšed
 
__KV_BENCH


114 if(
®loÿtÜty³
 =ğ
NUMA_ALLOCATOR
){

115 
	`ä“_mem_numa
(
poŞ
->
ba£
);

116 }ià(
®loÿtÜty³
 =ğ
POSIX_ALLOCATOR
){

117 
	`ä“_mem_posix
(
poŞ
->
ba£
);

120 
	`ä“_mem_¥dk
(
poŞ
->
ba£
);

123 
poŞ
->
ba£
 = 
NULL
;

124 
	}
}

126 * 
	$AddrFromIndex
(
ušt32_t
 
i
, 
mempoŞ_t
 *
poŞ
)

128  
poŞ
->
ba£
 + ( 
i
 *…oŞ->
block_size
 );

129 
	}
}

131 
ušt32_t
 
	$IndexFromAddr
(cÚ¡ * 
p
, 
mempoŞ_t
 *
poŞ
)

133  (((
ušt32_t
 )(
p
 - 
poŞ
->
ba£
)è/…oŞ->
block_size
);

134 
	}
}

136 * 
	$AÎoÿ‹
(
mempoŞ_t
 *
poŞ
)

139 ià(
poŞ
->
num_š™Ÿlizedblocks
 <…oŞ->
num_blocks
 )

141 
ušt32_t
 * 
p
 = (ušt32_ˆ*)
	`AddrFromIndex
(
poŞ
->
num_š™Ÿlizedblocks
,…ool);

142 *
p
 = 
poŞ
->
num_š™Ÿlizedblocks
 + 1;

143 
poŞ
->
num_š™Ÿlizedblocks
++;

145 * 
»t
 = 
NULL
;

146 iàĞ
poŞ
->
num_ä“blocks
 > 0 )

148 
»t
 = (*)
poŞ
->
Ãxtä“block
;

150 --(
poŞ
->
num_ä“blocks
);

151 ià(
poŞ
->
num_ä“blocks
!=0)

153 
poŞ
->
Ãxtä“block
 = 
	`AddrFromIndex
(*((
ušt32_t
 *)pool->nextfreeblock),…ool);

157 
poŞ
->
Ãxtä“block
 = 
NULL
;

161  
»t
;

162 
	}
}

164 
	$DeAÎoÿ‹
(* 
p
, 
mempoŞ_t
 *
poŞ
)

166 if(
p
 =ğ
NULL
) ;

168 ià(
poŞ
->
Ãxtä“block
 !ğ
NULL
)

170 (*(
ušt32_t
 *)
p
èğ
	`IndexFromAddr
Ğ
poŞ
->
Ãxtä“block
,…ool );

171 
poŞ
->
Ãxtä“block
 = (*)
p
;

175 *((
ušt32_t
 *)
p
èğ
poŞ
->
num_blocks
;

176 
poŞ
->
Ãxtä“block
 = (*)
p
;

179 ++(
poŞ
->
num_ä“blocks
);

181 
	}
}

183 *
®loÿ‹_mem_numa
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
);

184 *
®loÿ‹_mem_posix
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
);

185 #ià
defšed
 
__KV_BENCH


186 *
®loÿ‹_mem_¥dk
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
);

188 
	$poŞ_£tup
(
poŞ_šfo_t
 *
šfo
, 
mempoŞ_t
 *
poŞ
, 
nodeid
)

190 *
memÜy
;

191 
ušt64_t
 
size
 = 
šfo
->
un™size
 * info->
numun™s
;

193 ià(
size
 > 0) {

195 #ià!
defšed
 
__KV_BENCH


196 ià(
šfo
->
®loÿtÜty³
 =ğ
NUMA_ALLOCATOR
) {

197 
memÜy
 = 
	`®loÿ‹_mem_numa
(
šfo
->
®ignm’t
, 
size
, 
nodeid
);

198 } if(
šfo
->
®loÿtÜty³
 =ğ
POSIX_ALLOCATOR
) {

199 
memÜy
 = 
	`®loÿ‹_mem_posix
(
šfo
->
®ignm’t
, 
size
, 
nodeid
);

201 
	`årštf
(
¡d”r
, "ERR: The‡pplication should use‚uma/posix‡s memory‡llocator\n");

202 
	`ex™
(0);

205 
memÜy
 = 
	`®loÿ‹_mem_¥dk
(
šfo
->
®ignm’t
, 
size
, 
nodeid
);

208 ià(
memÜy
 =ğ
NULL
) {

209 
	`årštf
(
¡d”r
, "NÙƒnough memÜy oÀSock‘ %d :„eque¡ sizğ%ld\n", 
nodeid
, 
size
 );

212 
	`š™Ÿlize
(
memÜy
, 
šfo
, 
poŞ
);

214 
	}
}

216 *
	$numa_®igÃd_®loc
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
)

218 *
ba£
;

219 **
®igÃd
;

220 
ušt64_t
 
tÙ®
 = 
size
 + 
®ignm’t
 - 1 + (*) + (uint64_t);

221 if(
nodeid
 != -1)

222 
ba£
 = 
	`numa_®loc_Únode
(
tÙ®
, 
nodeid
);

224 
ba£
ğ
	`numa_®loc_loÿl
(
tÙ®
);

226 
®igÃd
 = (**)((((
ušt64_t
)
ba£
è+ 
®ignm’t
 - 1 + (*) + (uint64_t)) & ~(alignment - 1));

227 
®igÃd
[-1] = 
ba£
;

228 
®igÃd
[-2] = (*)
tÙ®
;

230  
®igÃd
;

231 
	}
}

233 *
	$®loÿ‹_mem_numa
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
)

235 *
±r
 = 
	`numa_®igÃd_®loc
(
®ignm’t
, 
size
, 
nodeid
);

236  
±r
;

238 
	}
}

239 *
	$®loÿ‹_mem_posix
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
)

241 *
±r
;

242 if(
	`posix_mem®ign
(&
±r
, 
®ignm’t
, 
size
) == 0) {

243  
±r
;

246  
NULL
;

247 
	}
}

249 #ià
defšed
 
__KV_BENCH


250 *
	$®loÿ‹_mem_¥dk
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
){

251 *
±r
 = 
	`kvs_m®loc
(
size
, 
®ignm’t
);

252  
±r
;

253 
	}
}

255 
	$ä“_mem_¥dk
(*
±r
)

257 
	`kvs_ä“
(
±r
);

258 
	}
}

261 
	$ä“_mem_numa
(*
p
)

263 *
±r
 = (((**)
p
)[-1]);

264 
ušt64_t
 
size
 = (ušt64_t)(((**)
p
)[-2]);

266 
	`numa_ä“
(
±r
, 
size
);

268 
	}
}

269 
	$ä“_mem_posix
(*
±r
)

271 
	`ä“
(
±r
);

272 
	}
}

274 
	g‹m¶©e
<
ty³Çme
 
	gT
>

275 
	$g‘_v®ue_äom_sysfe
(*
·th
, 
T
 &
»suÉ
) {

276 
¡d
::
if¡»am
 
	`sysdev_šfo
 (
·th
);

277 ià(
sysdev_šfo
.
	`is_İ’
(è&& !sysdev_šfo.
	`eof
()) {

278 
sysdev_šfo
 >> 
»suÉ
;

282 
	}
}

284 
	$g‘_nvme_numa_node
(*
devÇme
, 
š¡ªû_šfo_t
 *
šfo
) {

285 
sysdev_·th
[1024];

286 
	`¥rštf
(
sysdev_·th
, "/sys/block/%s/deviû/deviû/numa_node", 
devÇme
);

288 
	`g‘_v®ue_äom_sysfe
(
sysdev_·th
, 
šfo
->
nodeid_lßd
);

289 
	`g‘_v®ue_äom_sysfe
(
sysdev_·th
, 
šfo
->
nodeid_³rf
);

292 
	}
}

	@application/kvbench/utils/memory.h

1 #iâdeà
__MEMORY_H


2 
	#__MEMORY_H


	)

4 
	~<numa.h
>

5 
	~<¡dšt.h
>

6 
	~<m­
>

7 
	~<£t
>

8 
	~<s¡»am
>

9 
	~<f¡»am
>

10 
	~<mu‹x
>

12 
	~"wÜklßd.h
"

13 #ifdeà
__ılu¥lus


17 
	sš¡ªû_šfo
 {

18 
nodeid_lßd
;

19 
nodeid_³rf
;

20 *
cÜeids_pİ
;

21 *
cÜeids_b’ch
;

22 }
	tš¡ªû_šfo_t
;

25 
num_numªodes
;

26 
num_cÜes_³r_numªodes
;

27 **
ıuli¡
;

28 } 
	tıu_šfo
;

31 
NO_POOL
 = 0,

32 
NUMA_ALLOCATOR
 = 1,

33 
POSIX_ALLOCATOR
 = 2,

34 
SPDK_ALLOCATOR
 = 3,

35 } 
	t®loÿtÜ_t
;

37 
	spoŞ_šfo
 {

38 
ušt64_t
 
un™size
;

39 
ušt64_t
 
numun™s
;

40 
®ignm’t
;

41 
®loÿtÜty³
;

42 } 
	tpoŞ_šfo_t
;

44 
	smempoŞ
 {

45 
št32_t
 
sock‘id
;

46 
ušt32_t
 
num_blocks
;

47 
ušt32_t
 
block_size
;

48 
ušt32_t
 
num_ä“blocks
;

49 
ušt32_t
 
num_š™Ÿlizedblocks
;

50 *
ba£
;

51 *
Ãxtä“block
;

52 
ušt32_t
 
Ãxt_ä“_idx
;

53 }
	tmempoŞ_t
;

55 
g‘_ıušfo
(
ıu_šfo
 *
ıušfo
, 
cÚfig_Úly
);

56 
g‘_curıu
(*
ch
, *
cÜe
);

60 
de¡roy
(
®loÿtÜty³
, 
mempoŞ_t
 *
poŞ
);

61 *
AÎoÿ‹
(
mempoŞ_t
 *
poŞ
);

62 
DeAÎoÿ‹
(* 
p
, 
mempoŞ_t
 *
poŞ
);

63 
poŞ_£tup
(
poŞ_šfo_t
 *
šfo
, 
mempoŞ_t
 *
poŞ
, 
nodeid
);

65 *
®loÿ‹_mem_numa
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
);

66 *
®loÿ‹_mem_posix
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
);

67 *
®loÿ‹_mem_¥dk
(
®ignm’t
, 
ušt64_t
 
size
, 
nodeid
);

68 
ä“_mem_numa
(*
±r
);

69 
ä“_mem_posix
(*
±r
);

70 
ä“_mem_¥dk
(*
±r
);

71 
g‘_nvme_numa_node
(*
devÇme
, 
š¡ªû_šfo_t
 *
šfo
);

73 
šlše
 
nÙify
(
IoCÚ‹xt
 *
cÚ‹xt
, 
mempoŞ_t
 *
keypoŞ
, mempoŞ_ˆ*
v®u•oŞ
){

76 if(
cÚ‹xt
->
key
è{ 
DeAÎoÿ‹
(cÚ‹xt->key, 
keypoŞ
);}

77 if(
cÚ‹xt
->
v®ue
è{ 
DeAÎoÿ‹
(cÚ‹xt->v®ue, 
v®u•oŞ
);}

80 #ifdeà
__ılu¥lus


	@application/kvbench/utils/stopwatch.cc

18 
	~<¡dlib.h
>

20 
	~"¡İw©ch.h
"

22 
timev®
 
	$_utime_g­
(
timev®
 
a
, timev® 
b
)

24 
timev®
 
»t
;

25 ià(
b
.
tv_u£c
 >ğ
a
.tv_usec) {

26 
»t
.
tv_u£c
 = 
b
.tv_u£ø- 
a
.tv_usec;

27 
»t
.
tv_£c
 = 
b
.tv_£ø- 
a
.tv_sec;

29 
»t
.
tv_u£c
 = 1000000 + 
b
.tv_u£ø- 
a
.tv_usec;

30 
»t
.
tv_£c
 = 
b
.tv_£ø- 
a
.tv_sec - 1;

32  
»t
;

33 
	}
}

35 
ušt64_t
 
	$_timev®_to_us
(
timev®
 
tv
)

37  (
ušt64_t
)
tv
.
tv_£c
 * 1000000 +v.
tv_u£c
;

38 
	}
}

40 
	$¡İw©ch_š™
(
¡İw©ch
 *
sw
)

42 
sw
->
–­£d
.
tv_£c
 = 0;

43 
sw
->
–­£d
.
tv_u£c
 = 0;

44 
	}
}

46 
	$¡İw©ch_¡¬t
(
¡İw©ch
 *
sw
)

48 
	`g‘timeofday
(&
sw
->
¡¬t
, 
NULL
);

49 
	}
}

51 
	$¡İw©ch_š™_¡¬t
(
¡İw©ch
 *
sw
)

53 
	`¡İw©ch_š™
(
sw
);

54 
	`¡İw©ch_¡¬t
(
sw
);

55 
	}
}

57 
	$¡İw©ch_check_ms
(
¡İw©ch
 *
sw
, 
size_t
 
ms
)

59 
timev®
 
cur
, 
g­
;

60 
	`g‘timeofday
(&
cur
, 
NULL
);

61 
g­
 = 
	`_utime_g­
(
sw
->
¡¬t
, 
cur
);

62 ià((
ušt64_t
)
g­
.
tv_£c
 * 1000 + (ušt64_t)g­.
tv_u£c
 / 1000 >ğ
ms
) {

66 
	}
}

68 
	$¡İw©ch_check_us
(
¡İw©ch
 *
sw
, 
size_t
 
us
)

70 
timev®
 
cur
, 
g­
;

71 
	`g‘timeofday
(&
cur
, 
NULL
);

72 
g­
 = 
	`_utime_g­
(
sw
->
¡¬t
, 
cur
);

73 ià((
ušt64_t
)
g­
.
tv_£c
 * 1000000 + (ušt64_t)g­.
tv_u£c
 >ğ
us
) {

77 
	}
}

79 
timev®
 
	$¡İw©ch_g‘_cu¹ime
(
¡İw©ch
 *
sw
)

81 
timev®
 
’d
, 
g­
;

82 
	`g‘timeofday
(&
’d
, 
NULL
);

83 
g­
 = 
	`_utime_g­
(
sw
->
¡¬t
, 
’d
);

84  
g­
;

85 
	}
}

87 
timev®
 
	$¡İw©ch_g‘_–­£d
(
¡İw©ch
 *
sw
)

89  
sw
->
–­£d
;

90 
	}
}

92 
timev®
 
	$¡İw©ch_¡İ
(
¡İw©ch
 *
sw
)

94 
timev®
 
’d
, 
g­
;

95 
	`g‘timeofday
(&
’d
, 
NULL
);

96 
g­
 = 
	`_utime_g­
(
sw
->
¡¬t
, 
’d
);

97 
sw
->
–­£d
.
tv_£c
 +ğ
g­
.tv_sec;

98 
sw
->
–­£d
.
tv_u£c
 +ğ
g­
.tv_usec;

99 ià(
sw
->
–­£d
.
tv_u£c
 >= 1000000) {

100 
sw
->
–­£d
.
tv_u£c
 -= 1000000;

101 
sw
->
–­£d
.
tv_£c
++;

104  
g­
;

105 
	}
}

	@application/kvbench/utils/stopwatch.h

18 #iâdeà
_JSAHN_STOPWATCH_H


19 
	#_JSAHN_STOPWATCH_H


	)

21 
	~<¡dšt.h
>

22 
	~<sys/time.h
>

24 #ifdeà
__ılu¥lus


28 
	s¡İw©ch
 {

29 
timev®
 
–­£d
;

30 
timev®
 
¡¬t
;

33 
ušt64_t
 
_timev®_to_us
(
timev®
 
tv
);

34 
¡İw©ch_š™
(
¡İw©ch
 *
sw
);

35 
¡İw©ch_¡¬t
(
¡İw©ch
 *
sw
);

36 
¡İw©ch_š™_¡¬t
(
¡İw©ch
 *
sw
);

37 
¡İw©ch_check_ms
(
¡İw©ch
 *
sw
, 
size_t
 
ms
);

38 
¡İw©ch_check_us
(
¡İw©ch
 *
sw
, 
size_t
 
us
);

39 
timev®
 
¡İw©ch_g‘_cu¹ime
(
¡İw©ch
 *
sw
);

40 
timev®
 
¡İw©ch_g‘_–­£d
(
¡İw©ch
 *
sw
);

41 
timev®
 
¡İw©ch_¡İ
(
¡İw©ch
 *
sw
);

43 #ifdeà
__ılu¥lus


	@application/kvbench/utils/thpool.cc

11 
	#_POSIX_C_SOURCE
 200809L

	)

12 
	~<uni¡d.h
>

13 
	~<sigÇl.h
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<±h»ad.h
>

17 
	~<”ºo.h
>

18 
	~<time.h
>

19 #ià
defšed
(
__lšux__
)

20 
	~<sys/´ùl.h
>

23 
	~"thpoŞ.h
"

25 #ifdeà
__ılu¥lus


29 #ifdeà
THPOOL_DEBUG


30 
	#THPOOL_DEBUG
 1

	)

32 
	#THPOOL_DEBUG
 0

	)

35 #ià!
defšed
(
DISABLE_PRINT
è|| defšed(
THPOOL_DEBUG
)

36 
	#”r
(
¡r
è
	`årštf
(
¡d”r
, sŒ)

	)

38 
	#”r
(
¡r
)

	)

41 vŞ©
th»ads_k“·live
;

42 vŞ©
th»ads_Ú_hŞd
;

50 
	sb£m
 {

51 
±h»ad_mu‹x_t
 
mu‹x
;

52 
±h»ad_cÚd_t
 
cÚd
;

53 
v
;

54 } 
	tb£m
;

58 
	sjob
{

59 
job
* 
´ev
;

60 (*
funùiÚ
)(* 
¬g
);

61 * 
¬g
;

62 } 
	tjob
;

66 
	sjobqueue
{

67 
±h»ad_mu‹x_t
 
rwmu‹x
;

68 
job
 *
äÚt
;

69 
job
 *
»¬
;

70 
b£m
 *
has_jobs
;

71 
Ën
;

72 } 
	tjobqueue
;

76 
	sth»ad
{

77 
id
;

78 
±h»ad_t
 
±h»ad
;

79 
thpoŞ_
* 
thpoŞ_p
;

80 } 
	tth»ad
;

84 
	sthpoŞ_
{

85 
th»ad
** 
th»ads
;

86 vŞ©
num_th»ads_®ive
;

87 vŞ©
num_th»ads_wÜkšg
;

88 
±h»ad_mu‹x_t
 
thcouÁ_lock
;

89 
±h»ad_cÚd_t
 
th»ads_®l_idË
;

90 
jobqueue
 jobqueue;

91 } 
	tthpoŞ_
;

100 
th»ad_š™
(
thpoŞ_
* 
thpoŞ_p
, 
th»ad
** 
th»ad_p
, 
id
);

101 * 
th»ad_do
(
th»ad
* 
th»ad_p
);

102 
th»ad_hŞd
(
sig_id
);

103 
th»ad_de¡roy
(
th»ad
* 
th»ad_p
);

105 
jobqueue_š™
(
jobqueue
* 
jobqueue_p
);

106 
jobqueue_ş—r
(
jobqueue
* 
jobqueue_p
);

107 
jobqueue_push
(
jobqueue
* 
jobqueue_p
, 
job
* 
Ãwjob_p
);

108 
job
* 
jobqueue_puÎ
(
jobqueue
* 
jobqueue_p
);

109 
jobqueue_de¡roy
(
jobqueue
* 
jobqueue_p
);

111 
b£m_š™
(
b£m
 *
b£m_p
, 
v®ue
);

112 
b£m_»£t
(
b£m
 *
b£m_p
);

113 
b£m_po¡
(
b£m
 *
b£m_p
);

114 
b£m_po¡_®l
(
b£m
 *
b£m_p
);

115 
b£m_wa™
(
b£m
 *
b£m_p
);

125 
thpoŞ_
* 
thpoŞ_š™
(
num_th»ads
){

127 
th»ads_Ú_hŞd
 = 0;

128 
th»ads_k“·live
 = 1;

130 ià(
num_th»ads
 < 0){

131 
num_th»ads
 = 0;

135 
thpoŞ_
* 
thpoŞ_p
;

136 
thpoŞ_p
 = (
thpoŞ_
*)
m®loc
((thpool_));

137 ià(
thpoŞ_p
 =ğ
NULL
){

138 
”r
("thpool_init(): Could‚ot‡llocate memory forhread…ool\n");

139  
NULL
;

141 
thpoŞ_p
->
num_th»ads_®ive
 = 0;

142 
thpoŞ_p
->
num_th»ads_wÜkšg
 = 0;

145 ià(
jobqueue_š™
(&
thpoŞ_p
->
jobqueue
) == -1){

146 
”r
("thpool_init(): Could‚ot‡llocate memory for job queue\n");

147 
ä“
(
thpoŞ_p
);

148  
NULL
;

152 
thpoŞ_p
->
th»ads
 = (
th»ad
**)
m®loc
(
num_th»ads
 * (thread *));

153 ià(
thpoŞ_p
->
th»ads
 =ğ
NULL
){

154 
”r
("thpool_init(): Could‚ot‡llocate memory forhreads\n");

155 
jobqueue_de¡roy
(&
thpoŞ_p
->
jobqueue
);

156 
ä“
(
thpoŞ_p
);

157  
NULL
;

160 
±h»ad_mu‹x_š™
(&(
thpoŞ_p
->
thcouÁ_lock
), 
NULL
);

161 
±h»ad_cÚd_š™
(&
thpoŞ_p
->
th»ads_®l_idË
, 
NULL
);

164 
n
;

165 
n
=0;‚<
num_th»ads
;‚++){

166 
th»ad_š™
(
thpoŞ_p
, &thpoŞ_p->
th»ads
[
n
],‚);

167 #ià
THPOOL_DEBUG


168 
´štf
("THPOOL_DEBUG: C»©edh»ad %d iÀpoŞ \n", 
n
);

173 
thpoŞ_p
->
num_th»ads_®ive
 !ğ
num_th»ads
) {}

175  
thpoŞ_p
;

180 
thpoŞ_add_wÜk
(
thpoŞ_
* 
thpoŞ_p
, (*
funùiÚ_p
)(*), * 
¬g_p
){

181 
job
* 
Ãwjob
;

183 
Ãwjob
=(
job
*)
m®loc
((job));

184 ià(
Ãwjob
==
NULL
){

185 
”r
("thpool_add_work(): Could‚ot‡llocate memory for‚ew job\n");

190 
Ãwjob
->
funùiÚ
=
funùiÚ_p
;

191 
Ãwjob
->
¬g
=
¬g_p
;

194 
jobqueue_push
(&
thpoŞ_p
->
jobqueue
, 
Ãwjob
);

201 
thpoŞ_wa™
(
thpoŞ_
* 
thpoŞ_p
){

202 
±h»ad_mu‹x_lock
(&
thpoŞ_p
->
thcouÁ_lock
);

203 
thpoŞ_p
->
jobqueue
.
Ën
 ||hpoŞ_p->
num_th»ads_wÜkšg
) {

204 
±h»ad_cÚd_wa™
(&
thpoŞ_p
->
th»ads_®l_idË
, &thpoŞ_p->
thcouÁ_lock
);

206 
±h»ad_mu‹x_uÆock
(&
thpoŞ_p
->
thcouÁ_lock
);

211 
thpoŞ_de¡roy
(
thpoŞ_
* 
thpoŞ_p
){

213 ià(
thpoŞ_p
 =ğ
NULL
)  ;

215 vŞ©
th»ads_tÙ®
 = 
thpoŞ_p
->
num_th»ads_®ive
;

218 
th»ads_k“·live
 = 0;

221 
TIMEOUT
 = 1.0;

222 
time_t
 
¡¬t
, 
’d
;

223 
as£d
 = 0.0;

224 
time
 (&
¡¬t
);

225 
as£d
 < 
TIMEOUT
 && 
thpoŞ_p
->
num_th»ads_®ive
){

226 
b£m_po¡_®l
(
thpoŞ_p
->
jobqueue
.
has_jobs
);

227 
time
 (&
’d
);

228 
as£d
 = 
difáime
(
’d
,
¡¬t
);

232 
thpoŞ_p
->
num_th»ads_®ive
){

233 
b£m_po¡_®l
(
thpoŞ_p
->
jobqueue
.
has_jobs
);

234 
¦“p
(1);

238 
jobqueue_de¡roy
(&
thpoŞ_p
->
jobqueue
);

240 
n
;

241 
n
=0;‚ < 
th»ads_tÙ®
;‚++){

242 
th»ad_de¡roy
(
thpoŞ_p
->
th»ads
[
n
]);

244 
ä“
(
thpoŞ_p
->
th»ads
);

245 
ä“
(
thpoŞ_p
);

250 
thpoŞ_·u£
(
thpoŞ_
* 
thpoŞ_p
) {

251 
n
;

252 
n
=0;‚ < 
thpoŞ_p
->
num_th»ads_®ive
;‚++){

253 
±h»ad_kl
(
thpoŞ_p
->
th»ads
[
n
]->
±h»ad
, 
SIGUSR1
);

259 
thpoŞ_»sume
(
thpoŞ_
* 
thpoŞ_p
) {

263 ()
thpoŞ_p
;

265 
th»ads_Ú_hŞd
 = 0;

269 
thpoŞ_num_th»ads_wÜkšg
(
thpoŞ_
* 
thpoŞ_p
){

270  
thpoŞ_p
->
num_th»ads_wÜkšg
;

286 
th»ad_š™
 (
thpoŞ_
* 
thpoŞ_p
, 
th»ad
** 
th»ad_p
, 
id
){

288 *
th»ad_p
 = (
th»ad
*)
m®loc
((thread));

289 ià(
th»ad_p
 =ğ
NULL
){

290 
”r
("thread_init(): Could‚ot‡llocate memory forhread\n");

294 (*
th»ad_p
)->
thpoŞ_p
 =hpool_p;

295 (*
th»ad_p
)->
id
 = id;

298 
±h»ad_ü—‹
(&(*
th»ad_p
)->
±h»ad
, 
NULL
, (* (*)(*))
th»ad_do
, (*thread_p));

299 
±h»ad_d‘ach
((*
th»ad_p
)->
±h»ad
);

305 
th»ad_hŞd
(
sig_id
) {

306 ()
sig_id
;

307 
th»ads_Ú_hŞd
 = 1;

308 
th»ads_Ú_hŞd
){

309 
¦“p
(1);

322 * 
th»ad_do
(
th»ad
* 
th»ad_p
){

325 
th»ad_Çme
[128] = {0};

326 
¥rštf
(
th»ad_Çme
, "th»ad-poŞ-%d", 
th»ad_p
->
id
);

328 #ià
defšed
(
__lšux__
)

330 
´ùl
(
PR_SET_NAME
, 
th»ad_Çme
);

331 #–ià
defšed
(
__APPLE__
è&& defšed(
__MACH__
)

332 
±h»ad_£Šame_Å
(
th»ad_Çme
);

334 
”r
("thread_do():…thread_setname_np is‚ot supported onhis system");

338 
thpoŞ_
* 
thpoŞ_p
 = 
th»ad_p
->thpool_p;

341 
sigaùiÚ
 
aù
;

342 
sigem±y£t
(&
aù
.
§_mask
);

343 
aù
.
§_æags
 = 0;

344 
aù
.
§_hªdËr
 = 
th»ad_hŞd
;

345 ià(
sigaùiÚ
(
SIGUSR1
, &
aù
, 
NULL
) == -1) {

346 
”r
("thread_do(): cannot handle SIGUSR1");

350 
±h»ad_mu‹x_lock
(&
thpoŞ_p
->
thcouÁ_lock
);

351 
thpoŞ_p
->
num_th»ads_®ive
 += 1;

352 
±h»ad_mu‹x_uÆock
(&
thpoŞ_p
->
thcouÁ_lock
);

354 
th»ads_k“·live
){

356 
b£m_wa™
(
thpoŞ_p
->
jobqueue
.
has_jobs
);

358 ià(
th»ads_k“·live
){

360 
±h»ad_mu‹x_lock
(&
thpoŞ_p
->
thcouÁ_lock
);

361 
thpoŞ_p
->
num_th»ads_wÜkšg
++;

362 
±h»ad_mu‹x_uÆock
(&
thpoŞ_p
->
thcouÁ_lock
);

365 (*
func_buff
)(*);

366 * 
¬g_buff
;

367 
job
* 
job_p
 = 
jobqueue_puÎ
(&
thpoŞ_p
->
jobqueue
);

368 ià(
job_p
) {

369 
func_buff
 = 
job_p
->
funùiÚ
;

370 
¬g_buff
 = 
job_p
->
¬g
;

371 
func_buff
(
¬g_buff
);

372 
ä“
(
job_p
);

375 
±h»ad_mu‹x_lock
(&
thpoŞ_p
->
thcouÁ_lock
);

376 
thpoŞ_p
->
num_th»ads_wÜkšg
--;

377 ià(!
thpoŞ_p
->
num_th»ads_wÜkšg
) {

378 
±h»ad_cÚd_sigÇl
(&
thpoŞ_p
->
th»ads_®l_idË
);

380 
±h»ad_mu‹x_uÆock
(&
thpoŞ_p
->
thcouÁ_lock
);

384 
±h»ad_mu‹x_lock
(&
thpoŞ_p
->
thcouÁ_lock
);

385 
thpoŞ_p
->
num_th»ads_®ive
 --;

386 
±h»ad_mu‹x_uÆock
(&
thpoŞ_p
->
thcouÁ_lock
);

388  
NULL
;

393 
th»ad_de¡roy
 (
th»ad
* 
th»ad_p
){

394 
ä“
(
th»ad_p
);

405 
jobqueue_š™
(
jobqueue
* 
jobqueue_p
){

406 
jobqueue_p
->
Ën
 = 0;

407 
jobqueue_p
->
äÚt
 = 
NULL
;

408 
jobqueue_p
->
»¬
 = 
NULL
;

410 
jobqueue_p
->
has_jobs
 = (
b£m
*)
m®loc
((bsem));

411 ià(
jobqueue_p
->
has_jobs
 =ğ
NULL
){

415 
±h»ad_mu‹x_š™
(&(
jobqueue_p
->
rwmu‹x
), 
NULL
);

416 
b£m_š™
(
jobqueue_p
->
has_jobs
, 0);

423 
jobqueue_ş—r
(
jobqueue
* 
jobqueue_p
){

425 
jobqueue_p
->
Ën
){

426 
ä“
(
jobqueue_puÎ
(
jobqueue_p
));

429 
jobqueue_p
->
äÚt
 = 
NULL
;

430 
jobqueue_p
->
»¬
 = 
NULL
;

431 
b£m_»£t
(
jobqueue_p
->
has_jobs
);

432 
jobqueue_p
->
Ën
 = 0;

439 
jobqueue_push
(
jobqueue
* 
jobqueue_p
, 
job
* 
Ãwjob
){

441 
±h»ad_mu‹x_lock
(&
jobqueue_p
->
rwmu‹x
);

442 
Ãwjob
->
´ev
 = 
NULL
;

444 
jobqueue_p
->
Ën
){

447 
jobqueue_p
->
äÚt
 = 
Ãwjob
;

448 
jobqueue_p
->
»¬
 = 
Ãwjob
;

452 
jobqueue_p
->
»¬
->
´ev
 = 
Ãwjob
;

453 
jobqueue_p
->
»¬
 = 
Ãwjob
;

456 
jobqueue_p
->
Ën
++;

458 
b£m_po¡
(
jobqueue_p
->
has_jobs
);

459 
±h»ad_mu‹x_uÆock
(&
jobqueue_p
->
rwmu‹x
);

470 
job
* 
jobqueue_puÎ
(
jobqueue
* 
jobqueue_p
){

472 
±h»ad_mu‹x_lock
(&
jobqueue_p
->
rwmu‹x
);

473 
job
* 
job_p
 = 
jobqueue_p
->
äÚt
;

475 
jobqueue_p
->
Ën
){

481 
jobqueue_p
->
äÚt
 = 
NULL
;

482 
jobqueue_p
->
»¬
 = 
NULL
;

483 
jobqueue_p
->
Ën
 = 0;

487 
jobqueue_p
->
äÚt
 = 
job_p
->
´ev
;

488 
jobqueue_p
->
Ën
--;

490 
b£m_po¡
(
jobqueue_p
->
has_jobs
);

494 
±h»ad_mu‹x_uÆock
(&
jobqueue_p
->
rwmu‹x
);

495  
job_p
;

500 
jobqueue_de¡roy
(
jobqueue
* 
jobqueue_p
){

501 
jobqueue_ş—r
(
jobqueue_p
);

502 
ä“
(
jobqueue_p
->
has_jobs
);

513 
b£m_š™
(
b£m
 *
b£m_p
, 
v®ue
) {

514 ià(
v®ue
 < 0 || value > 1) {

515 
”r
("bsem_init(): Binary semaphore canake only values 1 or 0");

516 
ex™
(1);

518 
±h»ad_mu‹x_š™
(&(
b£m_p
->
mu‹x
), 
NULL
);

519 
±h»ad_cÚd_š™
(&(
b£m_p
->
cÚd
), 
NULL
);

520 
b£m_p
->
v
 = 
v®ue
;

525 
b£m_»£t
(
b£m
 *
b£m_p
) {

526 
b£m_š™
(
b£m_p
, 0);

531 
b£m_po¡
(
b£m
 *
b£m_p
) {

532 
±h»ad_mu‹x_lock
(&
b£m_p
->
mu‹x
);

533 
b£m_p
->
v
 = 1;

534 
±h»ad_cÚd_sigÇl
(&
b£m_p
->
cÚd
);

535 
±h»ad_mu‹x_uÆock
(&
b£m_p
->
mu‹x
);

540 
b£m_po¡_®l
(
b£m
 *
b£m_p
) {

541 
±h»ad_mu‹x_lock
(&
b£m_p
->
mu‹x
);

542 
b£m_p
->
v
 = 1;

543 
±h»ad_cÚd_brßdÿ¡
(&
b£m_p
->
cÚd
);

544 
±h»ad_mu‹x_uÆock
(&
b£m_p
->
mu‹x
);

549 
b£m_wa™
(
b£m
* 
b£m_p
) {

550 
±h»ad_mu‹x_lock
(&
b£m_p
->
mu‹x
);

551 
b£m_p
->
v
 != 1) {

552 
±h»ad_cÚd_wa™
(&
b£m_p
->
cÚd
, &b£m_p->
mu‹x
);

554 
b£m_p
->
v
 = 0;

555 
±h»ad_mu‹x_uÆock
(&
b£m_p
->
mu‹x
);

558 #ifdeà
__ılu¥lus


	@application/kvbench/utils/workload.h

1 #iâdeà
__WORKLOAD_H


2 
	#__WORKLOAD_H


	)

4 #ifdeà
__AS_BENCH


5 
	~"«ro¥ike/as_»cÜd.h
"

8 
	~"../b’ch/¬ch.h
"

10 
	sÏ‹ncy_¡©
 {

11 
ušt64_t
 
	mcursÜ
;

12 
ušt64_t
 
	mn§m¶es
;

13 
ušt32_t
 *
	m§m¶es
;

14 
¥š_t
 
	mlock
;

27 
	sIoCÚ‹xt
 {

28 
	mİ
;

29 *
	mkey
;

30 
ušt8_t
 
	mkeyËngth
;

31 *
	mv®ue
;

32 
ušt32_t
 
	mv®u–’gth
;

34 
	m»suÉ
;

35 
	m¡©us
;

36 *
	m´iv©e1
;

37 *
	m´iv©e2
;

38 
IoCÚ‹xt
 *
	m´ev
;

39 
IoCÚ‹xt
 *
	mÃxt
;

40 #ià
defšed
 
__AS_BENCH


41 
as_key
 
	makey
;

42 
as_»cÜd
 
	m¬ec
;

45 
ušt64_t
 
	m¡¬t
;

46 
	mmÚ™Ü
;

47 
Ï‹ncy_¡©
 *
	ml_¡©
;

49 }
	tIoCÚ‹xt_t
;

	@application/kvbench/utils/zipfian_random.cc

1 
	~<¡ršg.h
>

2 
	~<¡dlib.h
>

3 
	~<m©h.h
>

5 
	~"adv_¿ndom.h
"

6 
	~"zfŸn_¿ndom.h
"

8 
	~"memËak.h
"

10 
	$_g‘_d’_sum
(
zf_ºd
 *
zf
)

12 
ušt64_t
 
i
;

13 
s
, 
sum
;

15 
s
 = 
zf
->s;

16 
sum
 = 0;

18 
i
=0;i<
zf
->
n
;++i){

19 
sum
 +ğ1/
	`pow
((
i
+1), 
s
);

21  
sum
;

22 
	}
}

24 
	$_g‘_z‘a
(
zf_ºd
 *
zf
, 
ušt64_t
 
k
, 
s
, ušt64_ˆ
n
)

26  (1/
	`pow
(
k
,
s
)è/ 
zf
->
sum
;

27 
	}
}

29 
	$zf_ºd_š™
(
zf_ºd
 *
zf
, 
ušt64_t
 
n
, 
s
, 
ušt32_t
 
»sŞutiÚ
)

31 
ušt64_t
 
i
, 
j
, 
‹mp
, 
a
, 
b
;

32 
ušt32_t
 *
bË
;

33 
cum
, 
z‘a
;

34 
BDR_RNG_VARS
;

36 
zf
->
n
 =‚;

37 
zf
->
s
 = s;

38 
zf
->
»sŞutiÚ
 =„esolution;

39 
zf
->
tuº
 = 0;

40 
zf
->
bË
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* zf->
n
);

41 
zf
->
m­
 = (
ušt32_t
*)
	`m®loc
((ušt32_tè* 
»sŞutiÚ
);

42 
zf
->
sum
 = 
	`_g‘_d’_sum
(zipf);

44 
	`mem£t
(
zf
->
m­
, 0, (
ušt32_t
è* 
»sŞutiÚ
);

45 
bË
 = 
zf
->table;

46 
i
=0; i<
zf
->
n
; ++i){

47 
bË
[
i
] = i;

51 
i
=0; i<
zf
->
n
; ++i){

52 
BDR_RNG_NEXTPAIR
;

53 
a
 = 
ºgz
 % 
zf
->
n
;

54 
b
 = 
ºgz2
 % 
zf
->
n
;

56 
‹mp
 = 
bË
[
a
];

57 
bË
[
a
] =abË[
b
];

58 
bË
[
b
] = 
‹mp
;

62 
cum
 = 0;

63 
i
=0;i<
zf
->
n
;++i){

64 
z‘a
 = 
	`_g‘_z‘a
(
zf
, 
i
+1, zf->
s
, zf->
n
);

66 
a
 = (
ušt64_t
)(
cum
 * 
zf
->
»sŞutiÚ
);

67 
b
 = (
ušt64_t
)((
cum
+
z‘a
è* 
zf
->
»sŞutiÚ
);

68 ià(
b
 >ğ
zf
->
»sŞutiÚ
) b = zipf->resolution-1;

69 
cum
 +ğ
z‘a
;

71 
j
 = 
a
; j <ğ
b
; ++j){

72 
zf
->
m­
[
j
] = 
i
;

75 
	}
}

77 
ušt32_t
 
	$zf_ºd_g‘
(
zf_ºd
 *
zf
)

79 
ušt32_t
 
idx
, 
r
;

80 
r
 = 
	`¿nd
(è% 
zf
->
»sŞutiÚ
;

81 
idx
 = (
zf
->
m­
[
r
] + zf->
tuº
è% zf->
n
;

83  
zf
->
bË
[
idx
];

84 
	}
}

86 
	$zf_ºd_shiá
(
zf_ºd
 *
zf
, 
ušt32_t
 
shiá
)

88 
zf
->
tuº
 +ğ
shiá
;

89 
zf
->
tuº
 = zf->tuº % zf->
n
;

90 
	}
}

92 
	$zf_ºd_ä“
(
zf_ºd
 *
zf
)

94 
	`ä“
(
zf
->
bË
);

95 
	`ä“
(
zf
->
m­
);

96 
	}
}

	@application/kvbench/utils/zipfian_random.h

1 #iâdeà
__JSAHN_ZIPFIAN_RANDOM


2 
	#__JSAHN_ZIPFIAN_RANDOM


	)

4 
	~<¡dšt.h
>

6 #ifdeà
__ılu¥lus


10 
	szf_ºd
{

11 
ušt64_t
 
n
;

12 
ušt32_t
 
»sŞutiÚ
;

13 
ušt32_t
 *
bË
;

15 
ušt32_t
 *
m­
;

16 
ušt64_t
 
tuº
;

17 
s
;

18 
sum
;

21 
zf_ºd_š™
(
zf_ºd
 *
zf
, 
ušt64_t
 
n
, 
s
, 
ušt32_t
 
»sŞutiÚ
);

22 
ušt32_t
 
zf_ºd_g‘
(
zf_ºd
 *
zf
);

23 
zf_ºd_shiá
(
zf_ºd
 *
zf
, 
ušt32_t
 
shiá
);

24 
zf_ºd_ä“
(
zf_ºd
 *
zf
);

26 #ifdeà
__ılu¥lus


	@application/kvbench/wrappers/couch_aerospike.cc

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

6 
	~<sys/¡©.h
>

7 
	~<uni¡d.h
>

8 
	~<numa.h
>

9 
	~<queue
>

11 
	~"¡İw©ch.h
"

12 
	~"¬ch.h
"

13 
	~"libcouch¡Üe/couch_db.h
"

14 
	~"memÜy.h
"

15 
	~"wÜklßd.h
"

16 
	~"«ro¥ike/as_ev’t.h
"

17 
	~"«ro¥ike/«ro¥ike_key.h
"

18 
	~"«ro¥ike/«ro¥ike.h
"

19 
	~"«ro¥ike/as_mÚ™Ü.h
"

20 
	~"«ro¥ike/as_ev’t.h
"

22 
	#LATENCY_CHECK


	)

23 
	#MAX_SAMPLES
 1000000

	)

24 
št64_t
 
	gVALUE_MAXLEN
 = 65536;

25 
	g´e_kv_g’
 = 0;

27 
«ro¥ike
 
	gas
;

28 *
	gns
;

30 
	#METABUF_MAXLEN
 (256)

	)

31 
št64_t
 
DATABUF_MAXLEN
;

33 
	s_db
 {

35 
boŞ
 
	masync
;

36 *
	mns
;

37 *
	mho¡s
;

38 *
	mpÜt
;

42 
IoCÚ‹xt
 *
	miocÚ‹xts
;

43 
IoCÚ‹xt
 *
	miodÚe
;

44 
¥š_t
 
	mlock
;

45 
	mout¡ªdšgios
;

46 
Ï‹ncy_¡©
 *
	ml_»ad
;

47 
Ï‹ncy_¡©
 *
	ml_wr™e
;

48 
Ï‹ncy_¡©
 *
	ml_d–‘e
;

51 
as_mÚ™Ü
 
	gmÚ™Ü
;

52 
	gkv_wr™e_mode
 = 0;

54 
	$push_ùx
(
Db
 *
db
, 
IoCÚ‹xt
 *
ùx
, 
is_iodÚe
){

55 if(
ùx
 =ğ
NULL
) ;

56 if(
is_iodÚe
) {

57 
	`±h»ad_¥š_lock
(&
db
->
lock
);

58 ià(
db
->
iodÚe
 =ğ
NULL
) {

59 
db
->
iodÚe
 = 
ùx
;

60 
ùx
->
Ãxt
 = ctx->
´ev
 = 
NULL
;

62 
db
->
iodÚe
->
´ev
 = 
ùx
;

63 
ùx
->
Ãxt
 = 
db
->
iodÚe
;

64 
db
->
iodÚe
 = 
ùx
;

66 
	`±h»ad_¥š_uÆock
(&
db
->
lock
);

68 ià(
db
->
iocÚ‹xts
 =ğ
NULL
) {

69 
db
->
iocÚ‹xts
 = 
ùx
;

70 
ùx
->
Ãxt
 = ctx->
´ev
 = 
NULL
;

72 
db
->
iocÚ‹xts
->
´ev
 = 
ùx
;

73 
ùx
->
Ãxt
 = 
db
->
iocÚ‹xts
;

74 
db
->
iocÚ‹xts
 = 
ùx
;

77 if(
db
->
iocÚ‹xts
 =ğ
NULL
è{
	`´štf
("should‚Ù h­³À\n"); 
	`ex™
(0);}

80 
	}
}

82 
IoCÚ‹xt
 *
	$pİ_ùx
(
Db
 *
db
, 
is_iodÚe
){

83 
IoCÚ‹xt
 *
ùx
 = 
NULL
;

85 if(
is_iodÚe
){

86 
	`±h»ad_¥š_lock
(&
db
->
lock
);

87 if(
db
->
iodÚe
 =ğ
NULL
){

88 
	`±h»ad_¥š_uÆock
(&
db
->
lock
);

89  
NULL
;

91 
ùx
 = 
db
->
iodÚe
;

92 
db
->
iodÚe
 = 
ùx
->
Ãxt
;

93 
	`±h»ad_¥š_uÆock
(&
db
->
lock
);

95 if(
db
->
iocÚ‹xts
 =ğ
NULL
)

97  
NULL
;

99 
ùx
 = 
db
->
iocÚ‹xts
;

100 
db
->
iocÚ‹xts
 = 
ùx
->
Ãxt
;

103 
ùx
->
´ev
 = ctx->
Ãxt
 = 
NULL
;

104  
ùx
;

105 
	}
}

107 
boŞ
 
	$is_em±y
(
IoCÚ‹xt
 *
ùx
) {

109  (
ùx
 =ğ
NULL
);

111 
	}
}

113 
	$·ss_l¡©_to_db
(
Db
 *
db
, 
Ï‹ncy_¡©
 *
l_»ad
,†©’cy_¡© *
l_wr™e
,†©’cy_¡© *
l_d–‘e
)

115 
db
->
l_»ad
 =†_read;

116 
db
->
l_wr™e
 =†_write;

117 
db
->
l_d–‘e
 =†_delete;

118 
	}
}

120 
	$add_ev’t
(
Db
 *
db
, 
IoCÚ‹xt
 *
ùx
) {

122 
	`push_ùx
(
db
, 
ùx
, 1);

124 
	}
}

126 
	$»Ëa£_cÚ‹xt
(
Db
 *
db
, 
IoCÚ‹xt
 **
cÚ‹xt
, 
Ëngth
) {

128 
i
 =0 ;˜< 
Ëngth
 ; i++) {

129 ià(
cÚ‹xt
[
i
]) {

130 
	`push_ùx
(
db
, 
cÚ‹xt
[
i
], 0);

135 
	}
}

137 
	$wr™e_com¶‘e
(
as_”rÜ
 *
”r
, *
ud©a
, 
as_ev’t_loİ
 *
loİ
)

140 
IoCÚ‹xt
 *
ioùx
 = (IoCÚ‹xˆ*)
ud©a
;

142 ià(
”r
) {

143 ià(
”r
->
code
 == 18) {

144 
as_”rÜ
 
”r
;

145 ià(
	`«ro¥ike_key_put_async
(&
as
, &
”r
, 
NULL
, &
ioùx
->
akey
, &ioùx->
¬ec
, 
wr™e_com¶‘e
,ioùx, NULL, NULLè!ğ
AEROSPIKE_OK
) {

146 
	`årštf
(
¡d”r
, "«ro¥ike_key_puˆ(ÿÎback): %d, %s\n", 
”r
.
code
 ,ƒ¼.
mes§ge
 );

152 if(
”r
->
code
 != 2)

153 
	`årštf
(
¡d”r
,"Commªd faed: %d %s, key = %s\n", 
”r
->
code
,ƒ¼->
mes§ge
, (*)
ioùx
->
key
);

159 
ioùx
->
»suÉ
 = (
”r
)? -1:0;

161 
	`add_ev’t
((
Db
*)
ioùx
->
´iv©e1
,ioctx);

163 #ià
defšed
 
LATENCY_CHECK


164 if(
ioùx
->
mÚ™Ü
 == 1){

165 
time¥ec
 
t11
;

166 
¡¬t
, 
’d
;

167 
ušt64_t
 
cur_§m¶e
;

168 
Ï‹ncy_¡©
 *
l_¡©
 = 
ioùx
->l_stat;

170 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

171 
’d
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

172 
’d
 /= 1000L;

173 
¡¬t
 = 
ioùx
->start;

174 ià(
l_¡©
->
cursÜ
 >ğ
MAX_SAMPLES
) {

175 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
MAX_SAMPLES
;

176 
l_¡©
->
n§m¶es
 = 
MAX_SAMPLES
;

178 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
 + 1;

180 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

181 
l_¡©
->
cursÜ
++;

182 
l_¡©
->
§m¶es
[
cur_§m¶e
] = 
’d
 - 
¡¬t
;

187 
	}
}

189 
	$»ad_com¶‘e
(
as_”rÜ
 *
”r
, 
as_»cÜd
 *
»cÜd
, *
ud©a
, 
as_ev’t_loİ
 *)

191 
IoCÚ‹xt
 *
ioùx
 = (IoCÚ‹xˆ*)
ud©a
;

192 ià(
”r
) {

197 
ioùx
->
»suÉ
 = (
”r
)? -1:0;

198 
	`add_ev’t
((
Db
*)
ioùx
->
´iv©e1
, ioctx);

200 #ià
defšed
 
LATENCY_CHECK


201 if(
ioùx
->
mÚ™Ü
 == 1){

202 
time¥ec
 
t11
;

203 
¡¬t
, 
’d
;

204 
ušt64_t
 
cur_§m¶e
;

205 
Ï‹ncy_¡©
 *
l_¡©
 = 
ioùx
->l_stat;

207 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

208 
’d
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

209 
’d
 /= 1000L;

210 
¡¬t
 = 
ioùx
->start;

211 ià(
l_¡©
->
cursÜ
 >ğ
MAX_SAMPLES
) {

212 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
MAX_SAMPLES
;

213 
l_¡©
->
n§m¶es
 = 
MAX_SAMPLES
;

215 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
 + 1;

217 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

218 
l_¡©
->
cursÜ
++;

219 
l_¡©
->
§m¶es
[
cur_§m¶e
] = 
’d
 - 
¡¬t
;

225 
	}
}

226 
	$d–‘e_com¶‘e
(
as_”rÜ
 *
”r
, *
ud©a
, 
as_ev’t_loİ
 *
loİ
)

228 
IoCÚ‹xt
 *
ioùx
 = (IoCÚ‹xˆ*)
ud©a
;

229 ià(
”r
) {

234 
ioùx
->
»suÉ
 = (
”r
)? -1:0;

235 
	`add_ev’t
((
Db
*)
ioùx
->
´iv©e1
, ioctx);

237 #ià
defšed
 
LATENCY_CHECK


238 if(
ioùx
->
mÚ™Ü
 == 1){

239 
time¥ec
 
t11
;

240 
¡¬t
, 
’d
;

241 
ušt64_t
 
cur_§m¶e
;

242 
Ï‹ncy_¡©
 *
l_¡©
 = 
ioùx
->l_stat;

244 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

245 
’d
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

246 
’d
 /= 1000L;

247 
¡¬t
 = 
ioùx
->start;

248 ià(
l_¡©
->
cursÜ
 >ğ
MAX_SAMPLES
) {

249 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
MAX_SAMPLES
;

250 
l_¡©
->
n§m¶es
 = 
MAX_SAMPLES
;

252 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
 + 1;

254 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

255 
l_¡©
->
cursÜ
++;

256 
l_¡©
->
§m¶es
[
cur_§m¶e
] = 
’d
 - 
¡¬t
;

260 
	}
}

262 
	$g‘ev’ts
(
Db
 *
db
, 
mš
, 
max
, 
IoCÚ‹xt
 **
cÚ‹xt
)

264 
i
 = 0;

265 !
	`is_em±y
(
db
->
iodÚe
è&& 
i
 < 
max
) {

267 
cÚ‹xt
[
i
] = 
	`pİ_ùx
(
db
, 1);

269 
db
->
out¡ªdšgios
--;

270 
i
++;

273  
i
;

274 
	}
}

276 
	sfun
 {

277 
	ma
;

278 
	m¡d
::
queue
<
IoCÚ‹xt
*> 
‹¡q
;

279 }
	tfun_t
;

281 
LIBCOUCHSTORE_API


282 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db
(cÚ¡ *
f’ame
,

283 
couch¡Üe_İ’_æags
 
æags
,

284 
Db
 **
pDb
)

286 
Db
 *
µdb
;

287 *
pDb
 = (
Db
*)
	`m®loc
((Db));

288 
µdb
 = *
pDb
;

290 
IoCÚ‹xt
 *
cÚ‹xt
 = 
NULL
;

291 
	`±h»ad_¥š_š™
(&
µdb
->
lock
, 0);

292 
µdb
->
out¡ªdšgios
 = 0;

293 
µdb
->
iocÚ‹xts
 =…pdb->
iodÚe
 = 
NULL
;

294 
i
 =0; i < 36000; i++) {

296 
cÚ‹xt
 = (
IoCÚ‹xt
 *)
	`m®loc
((IoContext));

297 if(
cÚ‹xt
 =ğ
NULL
){

298 
	`årštf
(
¡d”r
, "Can‚ot‡llocate db context\n");

299 
	`ex™
(0);

301 
cÚ‹xt
->
´ev
 = cÚ‹xt->
Ãxt
 = 
NULL
;

302 
	`push_ùx
(
µdb
, 
cÚ‹xt
, 0);

305  
COUCHSTORE_SUCCESS
;

306 
	}
}

308 
LIBCOUCHSTORE_API


309 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db_ex
(cÚ¡ *
f’ame
,

310 
couch¡Üe_İ’_æags
 
æags
,

311 
FeOpsIÁ”çû
 *
İs
,

312 
Db
 **
pDb
)

315  
COUCHSTORE_SUCCESS
;

316 
	}
}

318 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_as_£tup
(cÚ¡ *
ho¡s
,

319 
ušt16_t
 
pÜt
,

320 
ušt32_t
 
loİ_ÿ·c™y
,

321 cÚ¡ *
Çme_¥aû
,

322 
wr™e_mode
)

326 
kv_wr™e_mode
 = 
wr™e_mode
;

329 if(
kv_wr™e_mode
 == 0) {

330 ià(! 
	`as_ev’t_ü—‹_loİs
(
loİ_ÿ·c™y
)) {

331 
	`årštf
(
¡d”r
, " Failedo create‡syncƒvent†oop ");

332 
	`ex™
(1);

336 
as_cÚfig
 
cÚfig
;

337 
	`as_cÚfig_š™
(&
cÚfig
);

338 
	`as_cÚfig_add_ho¡s
(&
cÚfig
, 
ho¡s
, 
pÜt
);

340 if(
kv_wr™e_mode
 == 0) {

341 
	`as_mÚ™Ü_š™
(&
mÚ™Ü
);

342 
	`as_mÚ™Ü_begš
(&
mÚ™Ü
);

345 cÚ¡ 
»ad_timeout
 = 1000000;

346 cÚ¡ 
wr™e_timeout
 = 1000000;

347 cÚ¡ 
max_»Œ›s
 = 10000;

348 cÚ¡‡utØ
num_»¶iÿs
 = 
AS_POLICY_REPLICA_SEQUENCE
;

349 
as_pŞic›s
* 
p
 = &
cÚfig
.
pŞic›s
;

350 
cÚfig
.
async_max_cÚns_³r_node
 = 10000;

351 
cÚfig
.
max_cÚns_³r_node
 = 5000;

352 
cÚfig
.
cÚn_poŞs_³r_node
 = 6;

354 
p
->
»ad
.
ba£
.
tÙ®_timeout
 = 
»ad_timeout
;

355 
p
->
»ad
.
ba£
.
max_»Œ›s
 = max_retries;

356 
p
->
»ad
.
»¶iÿ
 = 
num_»¶iÿs
;

357 
p
->
»ad
.
cÚsi¡’cy_Ëv–
 =
AS_POLICY_CONSISTENCY_LEVEL_ONE
;

359 
p
->
wr™e
.
ba£
.
tÙ®_timeout
 = 
wr™e_timeout
;

360 
p
->
wr™e
.
ba£
.
max_»Œ›s
 = max_retries;

361 
p
->
wr™e
.
»¶iÿ
 = 
num_»¶iÿs
;

362 
p
->
wr™e
.
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_ALL
 ;

363 
p
->
wr™e
.
du¿bË_d–‘e
 = 
çl£
;

365 
p
->
İ”©e
.
ba£
.
tÙ®_timeout
 = 
wr™e_timeout
;

366 
p
->
İ”©e
.
ba£
.
max_»Œ›s
 = max_retries;

367 
p
->
İ”©e
.
»¶iÿ
 = 
num_»¶iÿs
;

368 
p
->
İ”©e
.
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_ALL
;

369 
p
->
İ”©e
.
du¿bË_d–‘e
 = 
çl£
;

371 
p
->
»move
.
ba£
.
tÙ®_timeout
 = 
wr™e_timeout
;

372 
p
->
»move
.
ba£
.
max_»Œ›s
 = max_retries;

373 
p
->
»move
.
»¶iÿ
 = 
num_»¶iÿs
;

374 
p
->
»move
.
comm™_Ëv–
 = 
AS_POLICY_COMMIT_LEVEL_ALL
;

375 
p
->
»move
.
du¿bË_d–‘e
 = 
çl£
;

376 
p
->
šfo
.
timeout
 = 10000;

378 
	`«ro¥ike_š™
(&
as
, &
cÚfig
);

380 
as_”rÜ
 
”r
;

381 ià(
	`«ro¥ike_cÚÃù
(&
as
, &
”r
è!ğ
AEROSPIKE_OK
) {

382 
	`årštf
(
¡d”r
, "A”o¥ikcÚÃù faed : %d, %s\n", 
”r
.
code
 ,ƒ¼.
mes§ge
 );

383 
	`as_ev’t_şo£_loİs
();

384 
	`«ro¥ike_de¡roy
(&
as
);

385 
	`ex™
(1);

388 
ns
 = (*)
	`m®loc
(256);

389 
	`memıy
(
ns
, 
Çme_¥aû
, 256);

391  
COUCHSTORE_SUCCESS
;

392 
	}
}

394 
LIBCOUCHSTORE_API


395 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_db
(
Db
 *
db
)

398 
i
= 0;

399 
IoCÚ‹xt
 *
tmp
;

401 
tmp
 = 
	`pİ_ùx
(
db
, 0);

402 
tmp
){

403 
	`ä“
(
tmp
);

404 
tmp
 = 
	`pİ_ùx
(
db
, 0);

407 
	`±h»ad_¥š_š™
(&
db
->
lock
, 0);

408 
	`ä“
(
db
);

409  
COUCHSTORE_SUCCESS
;

410 
	}
}

412 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_deviû
(
št32_t
 
ndocs
)

414 
as_”rÜ
 
”r
;

415 
i
;

417 
	`«ro¥ike_şo£
(&
as
, &
”r
);

418 
	`«ro¥ike_de¡roy
(&
as
);

420  
COUCHSTORE_SUCCESS
;

422 
	}
}

424 
LIBCOUCHSTORE_API


425 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_db_šfo
(
Db
 *
db
, 
DbInfo
* 
šfo
)

427  
COUCHSTORE_SUCCESS
;

428 
	}
}

430 
LIBCOUCHSTORE_API


431 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’ts
(
Db
 *
db
, 
Doc
* cÚ¡ 
docs
[], 
DocInfo
 *
šfos
[],

432 
numdocs
, 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

435 
i
;

436 
as_”rÜ
 
”r
;

438 
i
 = 0; i < 
numdocs
; i++) {

439 if(
kv_wr™e_mode
 == 0) {

440 
IoCÚ‹xt
 *
ùx
 = 
	`pİ_ùx
(
db
, 0);

441 if(
ùx
 =ğ
NULL
) {

442 
	`årštf
(
¡d”r
, "NÙƒnough cÚ‹xt, out¡ªdšg %ld\n", 
db
->
out¡ªdšgios
);

443 
	`ex™
(1);

446 ià(
	`as_key_š™_¿wp
(&
ùx
->
akey
, 
ns
, "£t", (cÚ¡ 
ušt8_t
 *)
docs
[
i
]->
id
.
buf
, docs[i]->id.
size
, 
çl£
) == 0) {

447 
	`årštf
(
¡d”r
, "failedo initializehe key\n");

448 
	`ex™
(-1);

452 
	`as_»cÜd_š™
(&
ùx
->
¬ec
, 1);

453 ià(
	`as_»cÜd_£t_¿wp
(&
ùx
->
¬ec
, "bš", (cÚ¡ 
ušt8_t
*)
docs
[
i
]->
d©a
.
buf
, docs[i]->d©a.
size
, 
çl£
) == 0) {

454 
	`årštf
(
¡d”r
, "failedo initializehe value\n");

455 
	`ex™
(-1);

458 
ùx
->
key
 = 
docs
[
i
]->
id
.
buf
;

459 
ùx
->
keyËngth
 = 
docs
[
i
]->
id
.
size
;

460 
ùx
->
v®ue
 = 
docs
[
i
]->
d©a
.
buf
;

461 
ùx
->
v®u–’gth
 = 
docs
[
i
]->
d©a
.
size
;

463 
ùx
->
´iv©e1
 = 
db
;

464 
ùx
->
l_¡©
 = 
db
->
l_wr™e
;

466 #ià
defšed
 
LATENCY_CHECK


467 if(
İtiÚs
 == 1) {

468 
time¥ec
 
t11
;

469 
Çno£c
;

470 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

471 
Çno£c
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

472 
Çno£c
 /= 1000L;

473 
ùx
->
¡¬t
 = 
Çno£c
;

474 
ùx
->
mÚ™Ü
 = 
İtiÚs
;

478 ià(
	`«ro¥ike_key_put_async
(&
as
, &
”r
, 
NULL
, &
ùx
->
akey
, &ùx->
¬ec
, 
wr™e_com¶‘e
, ctx, NULL, NULLè!ğ
AEROSPIKE_OK
) {

479 
	`årštf
(
¡d”r
, "«ro¥ike_key_puˆçed: %d, %s\n", 
”r
.
code
,ƒ¼.
mes§ge
);

480 
	`ex™
(-1);

482 
db
->
out¡ªdšgios
++;

484 
as_key
 
akey
;

485 ià(
	`as_key_š™_¿wp
(&
akey
, 
ns
, "£t", (cÚ¡ 
ušt8_t
 *)
docs
[
i
]->
id
.
buf
, docs[i]->id.
size
, 
çl£
) == 0){

486 
	`årštf
(
¡d”r
, "failedo initializehe key\n");

487 
	`ex™
(-1);

490 
as_»cÜd
 
»c
;

491 
	`as_»cÜd_š™
(&
»c
, 1);

492 ià(
	`as_»cÜd_£t_¿wp
(&
»c
, "bš", (cÚ¡ 
ušt8_t
*)
docs
[
i
]->
d©a
.
buf
, docs[i]->d©a.
size
, 
çl£
) == 0) {

493 
	`årštf
(
¡d”r
, "failedo initializehe value\n");

494 
	`ex™
(-1);

497 ià(
	`«ro¥ike_key_put
(&
as
, &
”r
, 
NULL
, &
akey
, &
»c
è!ğ
AEROSPIKE_OK
) {

498 
	`årštf
(
¡d”r
, "«ro¥ike_key_puˆçed: %d, %s\n",
”r
.
code
,ƒ¼.
mes§ge
);

499 
	`ex™
(-1);

502 
	`as_key_de¡roy
(&
akey
);

503 
	`as_»cÜd_de¡roy
(&
»c
);

508  
COUCHSTORE_SUCCESS
;

509 
	}
}

511 
LIBCOUCHSTORE_API


512 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’t
(
Db
 *
db
, cÚ¡ 
Doc
 *
doc
, 
DocInfo
 *
šfo
,

513 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

515  
	`couch¡Üe_§ve_docum’ts
(
db
, (
Doc
**)&
doc
, (
DocInfo
**)&
šfo
, 1, 
İtiÚs
);

516 
	}
}

518 
LIBCOUCHSTORE_API


519 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_docum’t
(
Db
 *
db
,

520 cÚ¡ *
id
,

521 
size_t
 
idËn
,

522 
Doc
 **
pDoc
,

523 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

525 
as_”rÜ
 
”r
;

526 
as_key
 
akey
;

527 
as_»cÜd
 *
»c
 = 0;

528 
ušt64_t
 
cur_§m¶e
 = 0;

529 
time¥ec
 
t11
;

530 
Çno£c
;

532 if(
	`as_key_š™_¿wp
(&
akey
, 
ns
, "£t", (cÚ¡ 
ušt8_t
*)
id
, 
idËn
, 
çl£
) == 0) {

533 
	`årštf
(
¡d”r
, "failedo initializehe key\n");

534 
	`ex™
(-1);

537 if(
kv_wr™e_mode
 == 0) {

538 
IoCÚ‹xt
 *
ùx
 = 
	`pİ_ùx
(
db
, 0);

539 
ùx
->
key
 = (*)
id
;

540 
ùx
->
keyËngth
 = 
idËn
;

541 
ùx
->
v®ue
 = 0;

542 
ùx
->
v®u–’gth
 = 0;

544 
ùx
->
´iv©e1
 = 
db
;

545 
ùx
->
l_¡©
 = 
db
->
l_»ad
;

547 #ià
defšed
 
LATENCY_CHECK


548 if(
İtiÚs
 == 1) {

549 
time¥ec
 
t11
;

550 
Çno£c
;

551 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

552 
Çno£c
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

553 
Çno£c
 /= 1000L;

554 
ùx
->
¡¬t
 = 
Çno£c
;

555 
ùx
->
mÚ™Ü
 = 
İtiÚs
;

559 ià(
	`«ro¥ike_key_g‘_async
(&
as
, &
”r
, 
NULL
, &
akey
, 
»ad_com¶‘e
, 
ùx
, NULL, NULLè!ğ
AEROSPIKE_OK
) {

560 
	`årštf
(
¡d”r
, "«ro¥ike_key_g‘ faed: %d, %s\n", 
”r
.
code
,ƒ¼.
mes§ge
);

561 
	`ex™
(-1);

566 ià(
	`«ro¥ike_key_g‘
(&
as
, &
”r
, 
NULL
, &
akey
, &
»c
è!ğ
AEROSPIKE_OK
) {

567 
	`årštf
(
¡d”r
, "«ro¥ike_key_g‘ faed: %d, %s\n", 
”r
.
code
,ƒ¼.
mes§ge
);

568 
	`ex™
(-1);

571 
	`as_key_de¡roy
(&
akey
);

574  
COUCHSTORE_SUCCESS
;

575 
	}
}

577 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_d–‘e_docum’t_kv
(
Db
 *
db
,
sized_buf
 *
key
,

578 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

581 
as_”rÜ
 
”r
;

582 
as_key
 
akey
;

584 if(
	`as_key_š™_¿wp
(&
akey
, 
ns
, "£t", (cÚ¡ 
ušt8_t
*)
key
->
buf
, key->
size
, 
çl£
) == 0) {

585 
	`årštf
(
¡d”r
, "failedo initializehe key\n");

586 
	`ex™
(-1);

589 if(
kv_wr™e_mode
 == 0) {

590 
IoCÚ‹xt
 *
ùx
 = 
	`pİ_ùx
(
db
, 0);

591 
ùx
->
key
 = key->
buf
;

592 
ùx
->
keyËngth
 = 
key
->
size
;

593 
ùx
->
v®ue
 = 0;

594 
ùx
->
v®u–’gth
 = 0;

596 
ùx
->
´iv©e1
 = 
db
;

597 
ùx
->
l_¡©
 = 
db
->
l_d–‘e
;

599 #ià
defšed
 
LATENCY_CHECK


600 if(
İtiÚs
 == 1) {

601 
time¥ec
 
t11
;

602 
Çno£c
;

603 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

604 
Çno£c
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

605 
Çno£c
 /= 1000L;

606 
ùx
->
¡¬t
 = 
Çno£c
;

607 
ùx
->
mÚ™Ü
 = 
İtiÚs
;

611 ià(
	`«ro¥ike_key_»move_async
(&
as
, &
”r
, 
NULL
, &
akey
, 
d–‘e_com¶‘e
, 
ùx
, NULL, NULLè!ğ
AEROSPIKE_OK
) {

612 
	`årštf
(
¡d”r
, "«ro¥ike_key_»movçed: %d, %s\n", 
”r
.
code
,ƒ¼.
mes§ge
);

613 
	`ex™
(-1);

616 if(
	`«ro¥ike_key_»move
(&
as
, &
”r
, 
NULL
, &
akey
è!ğ
AEROSPIKE_OK
) {

617 
	`årštf
(
¡d”r
, "«ro¥ike_key_»movçed: %d, %s\n", 
”r
.
code
,ƒ¼.
mes§ge
);

618 
	`ex™
(-1);

622  
COUCHSTORE_SUCCESS
;

623 
	}
}

625 
LIBCOUCHSTORE_API


626 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_d–‘e_docum’t
(
Db
 *
db
,

627 cÚ¡ *
id
,

628 
size_t
 
idËn
,

629 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

632  
COUCHSTORE_SUCCESS
;

633 
	}
}

635 
LIBCOUCHSTORE_API


636 
	$couch¡Üe_ä“_docum’t
(
Doc
 *
doc
)

638 ià(
doc
->
id
.
buf
è
	`ä“
(doc->id.buf);

639 ià(
doc
->
d©a
.
buf
è
	`ä“
(doc->data.buf);

640 
	`ä“
(
doc
);

641 
	}
}

644 
LIBCOUCHSTORE_API


645 
	$couch¡Üe_ä“_docšfo
(
DocInfo
 *
docšfo
)

648 
	`ä“
(
docšfo
);

649 
	}
}

651 
LIBCOUCHSTORE_API


652 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_comm™
(
Db
 *
db
)

656  
COUCHSTORE_SUCCESS
;

657 
	}
}

	@application/kvbench/wrappers/couch_kv.cc

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

6 
	~<sys/¡©.h
>

7 
	~<±h»ad.h
>

8 
	~<uni¡d.h
>

9 
	~<mu‹x
>

10 
	~<queue
>

12 
	~"kvs_­i.h
"

13 
	~"libcouch¡Üe/couch_db.h
"

14 
	~"¡İw©ch.h
"

15 
	~"¬ch.h
"

16 
	~"memÜy.h
"

17 
	~"wÜklßd.h
"

19 
	#wÜklßd_check
 (0)

	)

20 
	#LATENCY_CHECK


21 
	#MAX_SAMPLES
 1000000

	)

22 
	gu£_udd
 = 0;

23 
	gkdd_is_pŞlšg
 = 1;

24 
	#GB_SIZE
 (1024*1024*1024)

	)

26 
	s_db
 {

27 
	mid
;

28 
kvs_deviû_hªdË
 
	mdev
;

29 
kvs_cÚš”_hªdË
 
	mcÚt_hd
;

30 
	mcÚ‹xt_idx
;

31 
IoCÚ‹xt
 
	mcÚ‹xts
[256];

33 
	m¡d
::
queue
<
IoCÚ‹xt
*> *
iocÚ‹xts
;

34 
	m¡d
::
queue
<
IoCÚ‹xt
*> *
iodÚe
;

36 
Ï‹ncy_¡©
 *
	ml_»ad
;

37 
Ï‹ncy_¡©
 *
	ml_wr™e
;

38 
Ï‹ncy_¡©
 *
	ml_d–‘e
;

39 
±h»ad_mu‹x_t
 
	mmu‹x
;

41 
	m¡d
::
queue
<
kvs_key
*> *
kvs_key_poŞ
;

42 
	m¡d
::
queue
<
kvs_v®ue
*> *
kvs_v®ue_poŞ
;

43 
	m¡d
::
mu‹x
 
lock_k
;

46 
kvs_™”©Ü_hªdË
 
	m™”_hªdË
;

47 
	mhas_™”_fšish
;

48 
kvs_™”©Ü_li¡
 
	m™”_li¡
;

52 
	gkv_wr™e_mode
 = 0;

53 
	gqueue_d•th
 = 8;

54 
	gaiÙh»ads_³r_deviû
 = 2;

55 
ušt64_t
 
	gcÜemask
 = 0;

56 
št32_t
 
	gaio_couÁ
 = 0;

57 
	gudd_cÜe_masks
[256];

58 
	gudd_cq_th»ad_masks
[256];

59 
ušt32_t
 
	gudd_mem_size_mb
 = 1024;

60 
kvs_™”©Ü_İtiÚ
 
	gg_™”_mode
;

61 
	#™”_»ad_size
 (32 * 1024)

	)

63 
	$´št_™”©Ü_keyv®s
(
kvs_™”©Ü_li¡
 *
™”_li¡
){

64 
ušt8_t
 *
™_bufãr
 = (ušt8_ˆ*è
™”_li¡
->
™_li¡
;

65 
ušt32_t
 
num_’Œ›s
 = 
™”_li¡
->num_entries;

67 if(
g_™”_mode
.
™”_ty³
) {

68 
ušt32_t
 
kËn
 = 16;

69 
ušt32_t
 
vËn
 = (
kvs_v®ue_t
);

70 
ušt32_t
 
vËn_v®ue
 = 0;

72 
i
 = 0;˜< 
™”_li¡
->
num_’Œ›s
; i++) {

73 
	`årštf
(
¡dout
, "I‹¿tÜ g‘ %dth key: %s\n", 
i
, 
™_bufãr
);

74 
™_bufãr
 += 16;

76 
ušt8_t
 *
addr
 = (ušt8_ˆ*)&
vËn_v®ue
;

77 
i
 = 0; i < 
vËn
; i++) {

78 *(
addr
 + 
i
èğ*(
™_bufãr
 + i);

81 
™_bufãr
 +ğ
vËn
;

82 
™_bufãr
 +ğ
vËn_v®ue
;

92 
ušt32_t
 
key_size
 = 0;

93 
key
[256];

95 
i
 = 0;˜< 
™”_li¡
->
num_’Œ›s
; i++) {

97 
key_size
 = *((*)
™_bufãr
);

98 
™_bufãr
 += ();

100 
	`memıy
(
key
, 
™_bufãr
, 
key_size
);

101 
key
[
key_size
] = 0;

102 
	`årštf
(
¡dout
, "%dth key --> %s\n", 
i
, 
key
);

103 
™_bufãr
 +ğ
key_size
;

107 
	}
}

109 
	$»Ëa£_kvskeyv®ue
(
Db
 *
db
, 
kvs_key
 *
key
, 
kvs_v®ue
 *
v®ue
){

111 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

112 if(
key
)

113 
db
->
kvs_key_poŞ
->
	`push
(
key
);

114 if(
v®ue
)

115 
db
->
kvs_v®ue_poŞ
->
	`push
(
v®ue
);

116 
	}
}

118 
	$add_ev’t
(
Db
 *
db
, 
IoCÚ‹xt
 *
ùx
) {

119 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

120 
db
->
iodÚe
->
	`push
(
ùx
);

122 
	}
}

124 
	$´št_cÜemask
(
ušt64_t
 
x
)

126 
z
;

127 
b
[65];

128 
b
[64] = '\0';

129 
z
 = 0; z < 64; z++) {

130 
b
[63-
z
] = ((
x
>>z) & 0x1) + '0';

132 
	`´štf
("cÜemask = %s\n", 
b
);

133 
	}
}

135 
ušt64_t
 
	$cÜeid_to_mask
(*
cÜe_ids
)

137 
i
, 
tmp
 = 0, 
found
 = 0;

138 
ušt64_t
 
cÜemask
 = 0;

140 
i
 = 0; i < 
	`¡¾’
(
cÜe_ids
); i++) {

141 if((
cÜe_ids
[
i
] =ğ',' || cÜe_ids[i] =ğ'}'è&& 
found
 == 1) {

142 cÚ¡ 
cÜeid
 = 
tmp
;

143 
cÜemask
 |ğ(1ULL << 
cÜeid
);

144 
tmp
 = 0;

145 
found
 = 0;

147 ià(
cÜe_ids
[
i
] <= '9' && core_ids[i] >= '0'){

148 
tmp
 =m°* 10 + 
cÜe_ids
[
i
] - '0';

149 
found
 = 1;

152  
cÜemask
;

153 
	}
}

155 
	$ä“_doc
(
Doc
 *
doc
)

157 ià(
doc
->
id
.
buf
è
	`ä“
(doc->id.buf);

158 ià(
doc
->
d©a
.
buf
è
	`ä“
(doc->data.buf);

159 
	}
}

161 
	$Ú_io_com¶‘e
(
kvs_ÿÎback_cÚ‹xt
* 
ioùx
) {

162 if(
ioùx
->
»suÉ
 !ğ
KVS_SUCCESS
 && ioùx->»suÉ !ğ
KVS_ERR_KEY_NOT_EXIST
) {

163 
	`årštf
(
¡dout
, "iØ”rÜ: o°ğ%d, key = %s,„esuÉ = %s\n", 
ioùx
->
İcode
, ioùx->
key
? (*)ioùx->key->key:0, 
	`kvs_”r¡r
(ioùx->
»suÉ
));

164 
	`ex™
(1);

167 autØ
owÃr
 = (
_db
*)
ioùx
->
´iv©e1
;

168 cÚ¡‡utØ
cÚ‹xt_idx
 = 
owÃr
->context_idx;

169 
Ï‹ncy_¡©
 *
l_¡©
;

171 if(
u£_udd
) {

172 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
owÃr
->
lock_k
);

173 
IoCÚ‹xt
 *
ùx
 = 
owÃr
->
iocÚ‹xts
->
	`äÚt
();

174 
owÃr
->
iocÚ‹xts
->
	`pİ
();

175 
lock
.
	`uÆock
();

176 if(
ùx
 =ğ
NULL
) {

177 
	`årštf
(
¡d”r
, "NÙƒnough cÚ‹xt, out¡ªdšg %d\n", 
owÃr
->
iodÚe
->
	`size
());

178 
	`ex™
(1);

181 
ioùx
->
İcode
) {

182 
IOCB_ASYNC_PUT_CMD
:

184 
ùx
->
v®ue
 = 
ioùx
->value->value;

185 
ùx
->
key
 = 
ioùx
->key->key;

186 
l_¡©
 = 
owÃr
->
l_wr™e
;

187 
	`»Ëa£_kvskeyv®ue
(
owÃr
, 
ioùx
->
key
, ioùx->
v®ue
);

189 
IOCB_ASYNC_GET_CMD
:

191 
ùx
->
v®ue
 = 
ioùx
->value->value;

192 
ùx
->
key
 = 
ioùx
->key->key;

193 
l_¡©
 = 
owÃr
->
l_»ad
;

194 
	`»Ëa£_kvskeyv®ue
(
owÃr
, 
ioùx
->
key
, ioùx->
v®ue
);

196 
IOCB_ASYNC_DEL_CMD
:

198 
ùx
->
key
 = 
ioùx
->key->key;

199 
ùx
->
v®ue
 = 
NULL
;

200 
l_¡©
 = 
owÃr
->
l_d–‘e
;

201 
	`»Ëa£_kvskeyv®ue
(
owÃr
, 
ioùx
->
key
, 0);

203 
IOCB_ASYNC_ITER_NEXT_CMD
:

206 
ùx
->
key
 = ctx->
v®ue
 = 
NULL
;

207 
owÃr
->
has_™”_fšish
 = 1;

212 
	`add_ev’t
(
owÃr
, 
ùx
);

214 if(
kdd_is_pŞlšg
) {

215 
ioùx
->
İcode
) {

256 
owÃr
->
cÚ‹xt_idx
++;

260 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
owÃr
->
lock_k
);

261 
IoCÚ‹xt
 *
ùx
 = 
owÃr
->
iocÚ‹xts
->
	`äÚt
();

262 
owÃr
->
iocÚ‹xts
->
	`pİ
();

263 
lock
.
	`uÆock
();

264 if(
ùx
 =ğ
NULL
) {

265 
	`årštf
(
¡d”r
, "NÙƒnough cÚ‹xt, out¡ªdšg %ld\n", 
owÃr
->
iodÚe
->
	`size
());

266 
	`ex™
(1);

269 
ioùx
->
İcode
) {

270 
IOCB_ASYNC_PUT_CMD
:

272 
ùx
->
v®ue
 = 
ioùx
->value->value;

273 
ùx
->
key
 = 
ioùx
->key->key;

274 
l_¡©
 = 
owÃr
->
l_wr™e
;

275 
	`»Ëa£_kvskeyv®ue
(
owÃr
, 
ioùx
->
key
, ioùx->
v®ue
);

277 
IOCB_ASYNC_GET_CMD
:

279 
ùx
->
v®ue
 = 
ioùx
->value->value;

280 
ùx
->
key
 = 
ioùx
->key->key;

281 
l_¡©
 = 
owÃr
->
l_»ad
;

282 
	`»Ëa£_kvskeyv®ue
(
owÃr
, 
ioùx
->
key
, ioùx->
v®ue
);

284 
IOCB_ASYNC_DEL_CMD
:

286 
ùx
->
v®ue
 = 
NULL
;

287 
ùx
->
key
 = 
ioùx
->key->key;

288 
l_¡©
 = 
owÃr
->
l_d–‘e
;

289 
	`»Ëa£_kvskeyv®ue
(
owÃr
, 
ioùx
->
key
, 0);

291 
IOCB_ASYNC_ITER_NEXT_CMD
:

294 
ùx
->
key
 = 
NULL
;

295 
ùx
->
v®ue
 = 
NULL
;

296 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
owÃr
->
lock_k
);

297 
owÃr
->
has_™”_fšish
 = 1;

298 
lock
.
	`uÆock
();

302 
	`add_ev’t
(
owÃr
, 
ùx
);

307 #ià
defšed
 
LATENCY_CHECK


308 if(
ioùx
->
´iv©e2
){

309 
time¥ec
 
t11
;

310 
¡¬t
, 
’d
;

311 
ušt64_t
 
cur_§m¶e
;

313 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

314 
’d
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

315 
’d
 /= 1000L;

316 
¡¬t
 = *((*)
ioùx
->
´iv©e2
);

317 ià(
l_¡©
->
cursÜ
 >ğ
MAX_SAMPLES
) {

318 
l_¡©
->
cursÜ
 =†_¡©->cursÜ % 
MAX_SAMPLES
;

319 
l_¡©
->
n§m¶es
 = 
MAX_SAMPLES
;

321 
l_¡©
->
n§m¶es
 =†_¡©->
cursÜ
 + 1;

323 
cur_§m¶e
 = 
l_¡©
->
cursÜ
;

324 
l_¡©
->
cursÜ
++;

325 
l_¡©
->
§m¶es
[
cur_§m¶e
] = 
’d
 - 
¡¬t
;

326 
	`ä“
(
ioùx
->
´iv©e2
);

330 
	}
}

332 
	$Ú_iÙh»ad_»ady
(
kvs_th»ad_t
 
id
è{
	}
}

334 
	$·ss_l¡©_to_db
(
Db
 *
db
, 
Ï‹ncy_¡©
 *
l_»ad
,†©’cy_¡© *
l_wr™e
,†©’cy_¡© *
l_d–‘e
)

336 
db
->
l_»ad
 =†_read;

337 
db
->
l_wr™e
 =†_write;

338 
db
->
l_d–‘e
 =†_delete;

339 
	}
}

341 
	$»Ëa£_cÚ‹xt
(
Db
 *
db
, 
IoCÚ‹xt
 **
cÚ‹xts
, 
Ä
){

343 if(
u£_udd
 || 
kdd_is_pŞlšg
 == 0) {

344 
i
 =0 ;˜< 
Ä
 ; i++) {

345 ià(
cÚ‹xts
[
i
]) {

346 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

347 
db
->
iocÚ‹xts
->
	`push
(
cÚ‹xts
[
i
]);

354 
	}
}

356 
	$g‘ev’ts
(
Db
 *
db
, 
mš
, 
max
, 
IoCÚ‹xt_t
 **
cÚ‹xt
)

358 if(
u£_udd
 || 
kdd_is_pŞlšg
 == 0) {

359 
i
 = 0;

360 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

361 !
db
->
iodÚe
->
	`em±y
(è&& 
i
 < 
max
) {

362 
cÚ‹xt
[
i
] = 
db
->
iodÚe
->
	`äÚt
();

363 
db
->
iodÚe
->
	`pİ
();

364 
i
++;

366 
lock
.
	`uÆock
();

367  
i
;

370 
db
->
has_™”_fšish
 = 0;

373 
»t
 = 
	`kvs_g‘_iÛv’ts
(
db
->
cÚt_hd
, 
max
);

375 
i
ğ0; i < 
»t
; i ++è
cÚ‹xt
[i] = &(
db
->
cÚ‹xts
[i]);

376 
db
->
cÚ‹xt_idx
 = 0;

378  
»t
;

381 
	}
}

383 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_kvs_£t_aio_İtiÚ
(
kvs_queue_d•th
, *
cÜe_masks
, *
cq_th»ad_masks
, 
ušt32_t
 
mem_size_mb
)

385 
queue_d•th
 = 
kvs_queue_d•th
;

386 
	`¡rıy
(
udd_cÜe_masks
, 
cÜe_masks
);

387 
	`¡rıy
(
udd_cq_th»ad_masks
, 
cq_th»ad_masks
);

388 
udd_mem_size_mb
 = 
mem_size_mb
;

389  
COUCHSTORE_SUCCESS
;

390 
	}
}

392 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_kvs_£t_aiÙh»ads
(
kvs_aio_th»ads
)

394 
aiÙh»ads_³r_deviû
 = 
kvs_aio_th»ads
;

395  
COUCHSTORE_SUCCESS
;

396 
	}
}

398 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_kvs_£t_cÜemask
(*
kvs_cÜe_ids
)

400 
cÜemask
 = 
	`cÜeid_to_mask
(
kvs_cÜe_ids
);

401  
COUCHSTORE_SUCCESS
;

402 
	}
}

404 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_kvs_g‘_aiocom¶‘iÚ
(
št32_t
 *
couÁ
)

406 *
couÁ
 = 
aio_couÁ
;

407  
COUCHSTORE_SUCCESS
;

408 
	}
}

410 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_kvs_»£t_aiocom¶‘iÚ
(){

411 
aio_couÁ
 = 0;

412  
COUCHSTORE_SUCCESS
;

413 
	}
}

415 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£tup_deviû
(cÚ¡ *
dev_·th
,

416 **
dev_Çmes
,

417 *
cÚfig_fe
,

418 
num_deviûs
, 
wr™e_mode
,

419 
is_pŞlšg
)

422 
kvs_š™_İtiÚs
 
İtiÚs
;

423 
	`kvs_š™_’v_İts
(&
İtiÚs
);

425 
sock‘
, 
cÜe
;

426 
	`g‘_curıu
(&
sock‘
, &
cÜe
);

427 
ušt64_t
 
ıumask
 = 0;

429 
ıumask
 |ğ(1ULL << 
cÜe
);

431 
	`årštf
(
¡d”r
, "ma¡” cÜğ%d, mask = %lx\À", 
cÜe
, 
ıumask
);

432 
İtiÚs
.
aio
.
iocÜemask
 = 
ıumask
;

434 
İtiÚs
.
aio
.
queued•th
 = 
queue_d•th
;

436 
İtiÚs
.
emul_cÚfig_fe
 = 
cÚfig_fe
;

437 
kdd_is_pŞlšg
 = 
is_pŞlšg
;

439 if(
dev_·th
[1] == 'd'){

440 
İtiÚs
.
memÜy
.
u£_dpdk
 = 0;

441 
u£_udd
 = 0;

443 
İtiÚs
.
memÜy
.
u£_dpdk
 = 1;

444 
u£_udd
 = 1;

448 
	`¡rıy
(
İtiÚs
.
udd
.
cÜe_mask_¡r
, 
udd_cÜe_masks
);

449 
	`¡rıy
(
İtiÚs
.
udd
.
cq_th»ad_mask
, 
udd_cq_th»ad_masks
);

451 
İtiÚs
.
udd
.
mem_size_mb
 = 
udd_mem_size_mb
;

452 
İtiÚs
.
udd
.
syncio
 = 
wr™e_mode
;

454 
	`kvs_š™_’v
(&
İtiÚs
);

455 
kv_wr™e_mode
 = 
wr™e_mode
;

457 
	`årštf
(
¡dout
, "device init done\n");

459  
COUCHSTORE_SUCCESS
;

460 
	}
}

462 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_deviû
(
št32_t
 
dev_id
)

466 
	}
}

468 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_ex™_’v
(){

470 
	`kvs_ex™_’v
();

472  
COUCHSTORE_SUCCESS
;

473 
	}
}

475 
LIBCOUCHSTORE_API


476 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db_kvs
(cÚ¡ *
dev_·th
,

477 
Db
 **
pDb
, 
id
)

480 
»t
;

481 
Db
 *
µdb
;

482 *
pDb
 = (
Db
*)
	`m®loc
((Db));

483 
µdb
 = *
pDb
;

485 
»t
 = 
	`kvs_İ’_deviû
(
dev_·th
, &
µdb
->
dev
);

486 if(
»t
 !ğ
KVS_SUCCESS
) {

487 
	`årštf
(
¡d”r
, "Deviû o³Àçed %s\n", 
	`kvs_”r¡r
(
»t
));

488 
	`ex™
(1);

491 
µdb
->
id
 = id;

492 
µdb
->
cÚ‹xt_idx
 = 0;

494 
µdb
->
has_™”_fšish
 = 1;

495 
	`mem£t
(
µdb
->
cÚ‹xts
, 0, (ppdb->contexts));

496 
	`±h»ad_mu‹x_š™
(&(
µdb
->
mu‹x
), 
NULL
);

498 if(
u£_udd
 =ğ1 || 
kdd_is_pŞlšg
 == 0) {

499 
IoCÚ‹xt
 *
cÚ‹xt
 = 
NULL
;

500 
µdb
->
iocÚ‹xts
 = 
Ãw
 
¡d
::
queue
<
IoCÚ‹xt
*>;

501 
µdb
->
iodÚe
 = 
Ãw
 
¡d
::
queue
<
IoCÚ‹xt
*>;

503 
µdb
->
kvs_key_poŞ
 = 
Ãw
 
¡d
::
queue
<
kvs_key
*>;

504 
µdb
->
kvs_v®ue_poŞ
 = 
Ãw
 
¡d
::
queue
<
kvs_v®ue
*>;

506 
kvs_key
 *
key
 = 
NULL
;

507 
kvs_v®ue
 *
v®ue
 = 
NULL
;

508 
i
 =0; i < 36000; i++) {

509 
cÚ‹xt
 = (
IoCÚ‹xt
 *)
	`m®loc
((IoContext));

510 if(
cÚ‹xt
 =ğ
NULL
){

511 
	`årštf
(
¡d”r
, "Can‚ot‡llocate db context\n");

512 
	`ex™
(0);

515 
µdb
->
iocÚ‹xts
->
	`push
(
cÚ‹xt
);

517 
key
 = (
kvs_key
*)
	`m®loc
((kvs_key));

518 
µdb
->
kvs_key_poŞ
->
	`push
(
key
);

520 
v®ue
 = (
kvs_v®ue
*)
	`m®loc
((kvs_value));

521 
µdb
->
kvs_v®ue_poŞ
->
	`push
(
v®ue
);

527 
kvs_cÚš”_cÚ‹xt
 
ùx
;

528 
	`kvs_ü—‹_cÚš”
(
µdb
->
dev
, "‹¡", 4, &
ùx
);

529 
	`kvs_İ’_cÚš”
(
µdb
->
dev
, "‹¡", &µdb->
cÚt_hd
);

531 
	`årštf
(
¡dout
, "deviû o³À%s\n", 
dev_·th
);

533  
COUCHSTORE_SUCCESS
;

534 
	}
}

536 
LIBCOUCHSTORE_API


537 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_db
(
Db
 *
db
)

539 if(
u£_udd
 || 
kdd_is_pŞlšg
 == 0) {

540 
IoCÚ‹xt
 *
tmp
;

542 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

544 !
db
->
iocÚ‹xts
->
	`em±y
()) {

545 
tmp
 = 
db
->
iocÚ‹xts
->
	`äÚt
();

546 
db
->
iocÚ‹xts
->
	`pİ
();

547 
	`ä“
(
tmp
);

549 
d–‘e
 
db
->
iocÚ‹xts
;

550 
d–‘e
 
db
->
iodÚe
;

552 
kvs_key
 *
key
;

553 
kvs_v®ue
 *
v®ue
;

554 !
db
->
kvs_key_poŞ
->
	`em±y
()) {

555 
key
 = 
db
->
kvs_key_poŞ
->
	`äÚt
();

556 
db
->
kvs_key_poŞ
->
	`pİ
();

557 
	`ä“
(
key
);

559 
d–‘e
 
db
->
kvs_key_poŞ
;

561 !
db
->
kvs_v®ue_poŞ
->
	`em±y
()) {

562 
v®ue
 = 
db
->
kvs_v®ue_poŞ
->
	`äÚt
();

563 
db
->
kvs_v®ue_poŞ
->
	`pİ
();

564 
	`ä“
(
v®ue
);

566 
d–‘e
 
db
->
kvs_v®ue_poŞ
;

569 
	`kvs_şo£_cÚš”
(
db
->
cÚt_hd
);

570 
	`ä“
(
db
);

572  
COUCHSTORE_SUCCESS
;

573 
	}
}

575 
LIBCOUCHSTORE_API


576 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_db_šfo
(
Db
 *
db
, 
DbInfo
* 
šfo
)

579  
COUCHSTORE_SUCCESS
;

580 
	}
}

582 
couch¡Üe_”rÜ_t
 
	$kvs_¡Üe_sync
(
Db
 *
db
, 
Doc
* cÚ¡ 
docs
[],

583 
numdocs
, 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

585 
i
, 
»t
;

586 
kvs_¡Üe_İtiÚ
 
İtiÚ
;

587 
i
 = 0; i < 
numdocs
; i++){

588 cÚ¡ 
kvs_¡Üe_cÚ‹xt
 
put_ùx
 = {
İtiÚ
, 
db
, 
NULL
};

589 cÚ¡ 
kvs_key
 
kvskey
 = {
docs
[
i
]->
id
.
buf
, (
kvs_key_t
)docs[i]->id.
size
};

590 cÚ¡ 
kvs_v®ue
 
kvsv®ue
 = { 
docs
[
i
]->
d©a
.
buf
, (
ušt32_t
)docs[i]->d©a.
size
 , 0, 0 };

592 
»t
 = 
	`kvs_¡Üe_tu¶e
(
db
->
cÚt_hd
, &
kvskey
, &
kvsv®ue
, &
put_ùx
);

594 if(
»t
 !ğ
KVS_SUCCESS
) {

595 
	`årštf
(
¡d”r
, "KVBENCH: stÜtu¶synøçed % 0x%x\n", (*)
docs
[
i
]->
id
.
buf
, 
»t
);

596 
	`ex™
(1);

600  
COUCHSTORE_SUCCESS
;

601 
	}
}

603 
couch¡Üe_”rÜ_t
 
	$kvs_¡Üe_async
(
Db
 *
db
, 
Doc
* cÚ¡ 
docs
[],

604 
numdocs
, 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

607 
»t
;

609 
	`as£¹
(
numdocs
 == 1);

610 
kvs_¡Üe_İtiÚ
 
İtiÚ
;

611 
kvs_¡Üe_cÚ‹xt
 
put_ùx
;

613 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

614 
kvs_key
 *
kvskey
 = 
db
->
kvs_key_poŞ
->
	`äÚt
();

615 
db
->
kvs_key_poŞ
->
	`pİ
();

616 
kvs_v®ue
 *
kvsv®ue
 = 
db
->
kvs_v®ue_poŞ
->
	`äÚt
();

617 
db
->
kvs_v®ue_poŞ
->
	`pİ
();

618 
lock
.
	`uÆock
();

619 if(
kvskey
 =ğ
NULL
 || 
kvsv®ue
 =ğNULLè{
	`årštf
(
¡dout
, "NØ–em iÀthkv key/v®ue_poŞ\n"); 
	`ex™
(0);}

621 
kvskey
->
key
 = 
docs
[0]->
id
.
buf
;

622 
kvskey
->
Ëngth
ğ(
kvs_key_t
)
docs
[0]->
id
.
size
;

624 
kvsv®ue
->
v®ue
 = 
docs
[0]->
d©a
.
buf
;

625 
kvsv®ue
->
Ëngth
 = (
ušt32_t
)
docs
[0]->
d©a
.
size
;

626 
kvsv®ue
->
aùu®_v®ue_size
 = kvsv®ue->
off£t
 = 0;

628 
put_ùx
.
İtiÚ
 = option;

629 
put_ùx
.
´iv©e1
 = 
db
;

630 
put_ùx
.
´iv©e2
 = 
NULL
;

632 #ià
defšed
 
LATENCY_CHECK


633 if(
İtiÚs
 == 1){

634 
time¥ec
 
t11
;

635 
Çno£c
;

636 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

637 *
p1
 = (*)
	`m®loc
(());

638 
Çno£c
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

639 
Çno£c
 /= 1000L;

640 
put_ùx
.
´iv©e2
 = 
p1
;

641 *
p1
 = 
Çno£c
;

645 
»t
 = 
	`kvs_¡Üe_tu¶e_async
(
db
->
cÚt_hd
, 
kvskey
, 
kvsv®ue
, &
put_ùx
, 
Ú_io_com¶‘e
);

646 
»t
) {

647 
»t
 = 
	`kvs_¡Üe_tu¶e_async
(
db
->
cÚt_hd
, 
kvskey
, 
kvsv®ue
, &
put_ùx
, 
Ú_io_com¶‘e
);

650  
COUCHSTORE_SUCCESS
;

652 
	}
}

654 
LIBCOUCHSTORE_API


655 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’ts
(
Db
 *
db
, 
Doc
* cÚ¡ 
docs
[], 
DocInfo
 *
šfos
[],

656 
numdocs
, 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

658 if(
kv_wr™e_mode
 == 1)

659  
	`kvs_¡Üe_sync
(
db
, 
docs
, 
numdocs
, 
İtiÚs
);

661  
	`kvs_¡Üe_async
(
db
, 
docs
, 
numdocs
, 
İtiÚs
);

662 
	}
}

665 
LIBCOUCHSTORE_API


666 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’t
(
Db
 *
db
, cÚ¡ 
Doc
 *
doc
, 
DocInfo
 *
šfo
,

667 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

670  
	`couch¡Üe_§ve_docum’ts
(
db
, (
Doc
**)&
doc
, (
DocInfo
**)&
šfo
, 1, 
İtiÚs
);;

671 
	}
}

674 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_™”©Ü_İ’
(
Db
 *
db
, 
™”©Ü_mode
) {

676 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx
;

683 
™”_ùx
.
b™mask
 = 0xffff0000;

684 
´efix_¡r
[5] = "0000";

685 
PREFIX_KV
 = 0;

686 
i
 = 0; i < 4; i++){

687 
PREFIX_KV
 |ğ(
´efix_¡r
[
i
] << i*8);

689 
™”_ùx
.
b™_·‰”n
 = 
PREFIX_KV
;

691 
kvs_™”©Ü_İtiÚ
 
İtiÚ
;

692 
	`mem£t
(&
İtiÚ
, 0, (
kvs_™”©Ü_İtiÚ
));

693 if(
™”©Ü_mode
 == 0) {

694 
g_™”_mode
.
™”_ty³
 = 
KVS_ITERATOR_KEY
;

695 
İtiÚ
.
™”_ty³
 = 
KVS_ITERATOR_KEY
;

697 
g_™”_mode
.
™”_ty³
 = 
KVS_ITERATOR_KEY_VALUE
;

698 
İtiÚ
.
™”_ty³
 = 
KVS_ITERATOR_KEY_VALUE
;

700 
™”_ùx
.
İtiÚ
 = option;

701 
™”_ùx
.
´iv©e1
 = 
db
;

702 
™”_ùx
.
´iv©e2
 = 
NULL
;

705 
»t
 = 
	`kvs_İ’_™”©Ü
(
db
->
cÚt_hd
, &
™”_ùx
, &db->
™”_hªdË
);

706 if(
»t
) {

707 
	`årštf
(
¡dout
, "İ’ i‹¸çed w™hƒ¼ %s\n", 
	`kvs_”r¡r
(
»t
));

708 
	`ex™
(1);

710 
db
->
™”_li¡
.
’d
 = 0;

711 
db
->
™”_li¡
.
num_’Œ›s
 = 0;

712 
db
->
™”_li¡
.
size
 = 
™”_»ad_size
;

714 
ušt8_t
 *
bufãr
;

715 
bufãr
 =(
ušt8_t
*è
	`kvs_m®loc
(
™”_»ad_size
, 4096);

716 
db
->
™”_li¡
.
™_li¡
 = (
ušt8_t
*)
bufãr
;

718  
COUCHSTORE_SUCCESS
;

719 
	}
}

721 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_™”©Ü_şo£
(
Db
 *
db
) {

722 
»t
;

724 if(
db
->
™”_hªdË
) {

725 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx
;

726 
™”_ùx
.
´iv©e1
 = 
db
;

727 
™”_ùx
.
´iv©e2
 = 
NULL
;

728 
»t
 = 
	`kvs_şo£_™”©Ü
(
db
->
cÚt_hd
, db->
™”_hªdË
, &
™”_ùx
);

730 if(
db
->
™”_li¡
.
™_li¡
è
	`kvs_ä“
(db->iter_list.it_list);

731 
	`årštf
(
¡dout
, "Iterator closed \n");

733  
COUCHSTORE_SUCCESS
;

734 
	}
}

736 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_™”©Ü_Ãxt
(
Db
 *
db
) {

737 
kvs_™”©Ü_cÚ‹xt
 
™”_ùx
;

738 
kvs_™”©Ü_İtiÚ
 
İtiÚ
;

739 
™”_ùx
.
İtiÚ
 = option;

740 
™”_ùx
.
´iv©e1
 = 
db
;

741 
™”_ùx
.
´iv©e2
 = 
NULL
;

743 
kvs_™”©Ü_li¡
 *
™”_li¡
 = &
db
->iter_list;

744 
™”_li¡
->
size
 = 
™”_»ad_size
;

747 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

748 
db
->
has_™”_fšish
 = 0;

749 
lock
.
	`uÆock
();

752 
	`mem£t
(
™”_li¡
->
™_li¡
, 0, 
™”_»ad_size
);

754 
	`kvs_™”©Ü_Ãxt_async
(
db
->
cÚt_hd
, db->
™”_hªdË
, 
™”_li¡
, &
™”_ùx
, 
Ú_io_com¶‘e
);

756  
COUCHSTORE_SUCCESS
;

757 
	}
}

759 
boŞ
 
	$couch¡Üe_™”©Ü_check_¡©us
(
Db
 *
db
) {

761  
db
->
™”_li¡
.
’d
;

762 
	}
}

764 
	$couch¡Üe_™”©Ü_g‘_num’Œ›s
(
Db
 *
db
) {

766  
db
->
has_™”_fšish
 ? db->
™”_li¡
.
num_’Œ›s
 : 0;

767 
	}
}

769 
	$couch¡Üe_™”©Ü_has_fšish
(
Db
 *
db
) {

770  
db
->
has_™”_fšish
;

771 
	}
}

773 
couch¡Üe_”rÜ_t
 
	$kvs_g‘_async
(
Db
 *
db
, 
sized_buf
 *
key
, sized_buà*
v®ue
,

774 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

777 
»t
;

778 
kvs_»Œ›ve_cÚ‹xt
 
»t_ùx
;

780 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

781 
kvs_key
 *
kvskey
 = 
db
->
kvs_key_poŞ
->
	`äÚt
();

782 
db
->
kvs_key_poŞ
->
	`pİ
();

783 
kvs_v®ue
 *
kvsv®ue
 = 
db
->
kvs_v®ue_poŞ
->
	`äÚt
();

784 
db
->
kvs_v®ue_poŞ
->
	`pİ
();

785 
lock
.
	`uÆock
();

787 if(
kvskey
 =ğ
NULL
 || 
kvsv®ue
 =ğNULLè{
	`årštf
(
¡dout
, "NØ–em iÀthkv key/v®ue_poŞ\n"); 
	`ex™
(0);}

789 
kvskey
->
key
 = key->
buf
;

790 
kvskey
->
Ëngth
 = (
kvs_key_t
)
key
->
size
;

792 
kvsv®ue
->
v®ue
 = v®ue->
buf
;

793 
kvsv®ue
->
Ëngth
 = (
ušt32_t
)
v®ue
->
size
;

794 
kvsv®ue
->
aùu®_v®ue_size
 = kvsv®ue->
off£t
 = 0;

796 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
;

797 
»t_ùx
.
İtiÚ
 = option;

798 
»t_ùx
.
´iv©e1
 = 
db
;

799 
»t_ùx
.
´iv©e2
 = 
NULL
;

801 #ià
defšed
 
LATENCY_CHECK


802 if(
İtiÚs
 == 1){

803 
time¥ec
 
t11
;

804 
Çno£c
;

805 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

806 *
p1
 = (*)
	`m®loc
(());

807 
Çno£c
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

808 
Çno£c
 /= 1000L;

809 
»t_ùx
.
´iv©e2
 = 
p1
;

810 *
p1
 = 
Çno£c
;

814 
»t
 = 
	`kvs_»Œ›ve_tu¶e_async
(
db
->
cÚt_hd
, 
kvskey
, 
kvsv®ue
, &
»t_ùx
, 
Ú_io_com¶‘e
);

815 
»t
) {

816 
»t
 = 
	`kvs_»Œ›ve_tu¶e_async
(
db
->
cÚt_hd
, 
kvskey
, 
kvsv®ue
, &
»t_ùx
, 
Ú_io_com¶‘e
);

819  
COUCHSTORE_SUCCESS
;

820 
	}
}

822 
couch¡Üe_”rÜ_t
 
	$kvs_g‘_sync
(
Db
 *
db
, 
sized_buf
 *
key
, sized_buà*
v®ue
,

823 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

825 
»t
;

826 
kvs_»Œ›ve_İtiÚ
 
İtiÚ
;

827 cÚ¡ 
kvs_»Œ›ve_cÚ‹xt
 
»t_ùx
 = { 
İtiÚ
,
db
, 
NULL
 };

828 cÚ¡ 
kvs_key
 
kvskey
 = { 
key
->
buf
, (
kvs_key_t
)key->
size
 };

829 
kvs_v®ue
 
kvsv®ue
 = { 
v®ue
->
buf
, (
ušt32_t
)v®ue->
size
 , 0, 0 };

831 
»t
 = 
	`kvs_»Œ›ve_tu¶e
(
db
->
cÚt_hd
, &
kvskey
, &
kvsv®ue
, &
»t_ùx
);

833 if(
»t
 !ğ
KVS_SUCCESS
) {

834 
	`årštf
(
¡d”r
, "KVBENCH:„‘r›vtu¶synøçed fÜ %s,ƒ¼ 0x%x\n", (*)
key
->
buf
, 
»t
);

838  
COUCHSTORE_SUCCESS
;

839 
	}
}

841 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_docum’t_kv
 (
Db
 *
db
,

842 
sized_buf
 *
key
,

843 
sized_buf
 *
v®ue
,

844 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

846 if(
kv_wr™e_mode
 == 1)

847  
	`kvs_g‘_sync
(
db
, 
key
, 
v®ue
, 
İtiÚs
);

849  
	`kvs_g‘_async
(
db
, 
key
, 
v®ue
, 
İtiÚs
);

851  
COUCHSTORE_SUCCESS
;

853 
	}
}

855 
LIBCOUCHSTORE_API


856 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_docum’t
(
Db
 *
db
,

857 cÚ¡ *
id
,

858 
size_t
 
idËn
,

859 
Doc
 **
pDoc
,

860 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

863  
COUCHSTORE_SUCCESS
;

864 
	}
}

866 
couch¡Üe_”rÜ_t
 
	$kvs_d–‘e_sync
(
Db
 *
db
,

867 
sized_buf
 *
key
,

868 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

870 
»t
;

871 
kvs_d–‘e_İtiÚ
 
İtiÚ
;

872 
kvs_d–‘e_cÚ‹xt
 
d–_ùx
 = { 
İtiÚ
, 
db
, 0 };

874 cÚ¡ 
kvs_key
 
kvskey
 = { 
key
->
buf
,(
kvs_key_t
èkey->
size
 };

875 
»t
 = 
	`kvs_d–‘e_tu¶e
(
db
->
cÚt_hd
, &
kvskey
, &
d–_ùx
);

877  
COUCHSTORE_SUCCESS
;

878 
	}
}

880 
couch¡Üe_”rÜ_t
 
	$kvs_d–‘e_async
(
Db
 *
db
, 
sized_buf
 *
key
,

881 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

884 
»t
;

885 
kvs_d–‘e_İtiÚ
 
İtiÚ
;

886 
kvs_d–‘e_cÚ‹xt
 
d–_ùx
;

888 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`lock
(
db
->
lock_k
);

889 
kvs_key
 *
kvskey
 = 
db
->
kvs_key_poŞ
->
	`äÚt
();

890 
db
->
kvs_key_poŞ
->
	`pİ
();

891 
lock
.
	`uÆock
();

892 if(
kvskey
 =ğ
NULL
è{
	`årštf
(
¡dout
, "NØ–em iÀthkv key/v®ue_poŞ\n"); 
	`ex™
(0);}

893 
kvskey
->
key
 = key->
buf
;

894 
kvskey
->
Ëngth
ğ(
kvs_key_t
)
key
->
size
;

896 
d–_ùx
.
İtiÚ
 = option;

897 
d–_ùx
.
´iv©e1
 = 
db
;

898 
d–_ùx
.
´iv©e2
 = 
NULL
;

900 #ià
defšed
 
LATENCY_CHECK


901 if(
İtiÚs
 == 1){

902 
time¥ec
 
t11
;

903 
Çno£c
;

904 
	`şock_g‘time
(
CLOCK_REALTIME
, &
t11
);

905 *
p1
 = (*)
	`m®loc
(());

906 
Çno£c
 = 
t11
.
tv_£c
 * 1000000000L +11.
tv_n£c
;

907 
Çno£c
 /= 1000L;

908 
d–_ùx
.
´iv©e2
 = 
p1
;

909 *
p1
 = 
Çno£c
;

913 
»t
 = 
	`kvs_d–‘e_tu¶e_async
(
db
->
cÚt_hd
, 
kvskey
, &
d–_ùx
, 
Ú_io_com¶‘e
);

914 
»t
) {

915 
	`kvs_d–‘e_tu¶e_async
(
db
->
cÚt_hd
, 
kvskey
, &
d–_ùx
, 
Ú_io_com¶‘e
);

918  
COUCHSTORE_SUCCESS
;

920 
	}
}

922 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_d–‘e_docum’t_kv
(
Db
 *
db
,

923 
sized_buf
 *
key
,

924 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

926 if(
kv_wr™e_mode
 == 1)

927  
	`kvs_d–‘e_sync
(
db
, 
key
, 
İtiÚs
);

929  
	`kvs_d–‘e_async
(
db
, 
key
, 
İtiÚs
);

930 
	}
}

932 
LIBCOUCHSTORE_API


933 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_d–‘e_docum’t
(
Db
 *
db
,

934 cÚ¡ *
id
,

935 
size_t
 
idËn
,

936 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

938  
COUCHSTORE_SUCCESS
;

939 
	}
}

941 
LIBCOUCHSTORE_API


942 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_w®k_id_Œ“
(
Db
 *
db
,

943 cÚ¡ 
sized_buf
* 
¡¬tDocID
,

944 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

945 
couch¡Üe_w®k_Œ“_ÿÎback_â
 
ÿÎback
,

946 *
ùx
)

949  
COUCHSTORE_SUCCESS
;

950 
	}
}

952 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_kvs_m®loc
(
size_t
 
size_by‹s
, **
buf
){

953 *
buf
 = 
	`kvs_m®loc
(
size_by‹s
, 4096);

954  
COUCHSTORE_SUCCESS
;

955 
	}
}

957 
LIBCOUCHSTORE_API


958 
	$couch¡Üe_ä“_docum’t
(
Doc
 *
doc
)

960 ià(
doc
->
id
.
buf
è
	`kvs_ä“
(doc->id.buf);

961 ià(
doc
->
d©a
.
buf
è
	`kvs_ä“
(doc->data.buf);

962 
	`ä“
(
doc
);

963 
	}
}

966 
LIBCOUCHSTORE_API


967 
	$couch¡Üe_ä“_docšfo
(
DocInfo
 *
docšfo
)

970 
	`ä“
(
docšfo
);

971 
	}
}

973 
LIBCOUCHSTORE_API


974 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_comm™
(
Db
 *
db
)

977  
COUCHSTORE_SUCCESS
;

978 
	}
}

	@application/kvbench/wrappers/couch_kvdb.cc

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

6 
	~<sys/¡©.h
>

7 
	~<uni¡d.h
>

8 
	~<io¡»am
>

10 
	~"¡İw©ch.h
"

11 
	~"rocksdb/ÿche.h
"

12 
	~"rocksdb/db.h
"

13 
	~"rocksdb/bË.h
"

14 
	~"rocksdb/f‹r_pŞicy.h
"

15 
	~"rocksdb/bË.h
"

16 
	~"libcouch¡Üe/couch_db.h
"

18 
	#wÜklßd_check
 (0)

	)

19 
	#METABUF_MAXLEN
 (256)

	)

20 
št64_t
 
DATABUF_MAXLEN
;

22 
	s_db
 {

23 
	mrocksdb
::
DB
* 
db
;

24 
	mrocksdb
::
O±iÚs
 *
İtiÚs
;

25 
	mrocksdb
::
Wr™eO±iÚs
 *
wr™e_İtiÚs
;

26 
	mrocksdb
::
R—dO±iÚs
 *
»ad_İtiÚs
;

27 
	m¡d
::
¡ršg
 *
f’ame
;

30 
ušt64_t
 
	gÿche_size
 = 0;

31 
ušt64_t
 
	gwbs_size
 = 4*1024*1024;

32 
	gbloom_b™s_³r_key
 = 0;

33 
	gcom·ùiÚ_¡yË
 = 0;

34 
	gcom´essiÚ
 = 0;

36 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_ÿche
(
ušt64_t
 
size
)

38 
ÿche_size
 = 
size
;

39  
COUCHSTORE_SUCCESS
;

40 
	}
}

41 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_wbs_size
(
ušt64_t
 
size
) {

42 
wbs_size
 = 
size
;

43  
COUCHSTORE_SUCCESS
;

44 
	}
}

45 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_bloom
(
b™s_³r_key
) {

46 
bloom_b™s_³r_key
 = 
b™s_³r_key
;

47  
COUCHSTORE_SUCCESS
;

48 
	}
}

49 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_com·ùiÚ_¡yË
(
¡yË
) {

50 
com·ùiÚ_¡yË
 = 
¡yË
;

51  
COUCHSTORE_SUCCESS
;

52 
	}
}

53 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_com´essiÚ
(
İt
) {

54 
com´essiÚ
 = 
İt
;

55  
COUCHSTORE_SUCCESS
;

56 
	}
}

59 
LIBCOUCHSTORE_API


60 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db
(cÚ¡ *
f’ame
,

61 
couch¡Üe_İ’_æags
 
æags
,

62 
Db
 **
pDb
)

64  
	`couch¡Üe_İ’_db_ex
(
f’ame
, 
æags
,

65 
NULL
, 
pDb
);

66 
	}
}

68 
LIBCOUCHSTORE_API


69 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db_ex
(cÚ¡ *
f’ame
,

70 
couch¡Üe_İ’_æags
 
æags
,

71 
FeOpsIÁ”çû
 *
İs
,

72 
Db
 **
pDb
)

74 
Db
 *
µdb
;

76 *
pDb
 = (
Db
*)
	`m®loc
((Db));

77 
µdb
 = *
pDb
;

79 
µdb
->
f’ame
 = 
Ãw
 
¡d
::
	`¡ršg
(filename);

81 
µdb
->
İtiÚs
 = 
Ãw
 
rocksdb
::
	`O±iÚs
();

82 
µdb
->
İtiÚs
->
ü—‹_if_missšg
 = 
Œue
;

83 ià(!
com´essiÚ
) {

84 
µdb
->
İtiÚs
->
com´essiÚ
 = 
rocksdb
::
kNoCom´essiÚ
;

87 
µdb
->
İtiÚs
->
max_background_com·ùiÚs
 = 8;

88 
µdb
->
İtiÚs
->
max_background_æushes
 = 2;

89 
µdb
->
İtiÚs
->
max_wr™e_bufãr_numb”
 = 2;

90 
µdb
->
İtiÚs
->
wr™e_bufãr_size
 = 
wbs_size
;

91 
µdb
->
İtiÚs
->
com·ùiÚ_¡yË
 = 
rocksdb
::
	`Com·ùiÚStyË
(compaction_style);

93 
µdb
->
İtiÚs
->
mš_wr™e_bufãr_numb”_to_m”ge
 = 1;

94 
µdb
->
İtiÚs
->
max_subcom·ùiÚs
 = 1;

95 
µdb
->
İtiÚs
->
¿ndom_acûss_max_bufãr_size
 = 1024 * 1024;

96 
µdb
->
İtiÚs
->
wr™abË_fe_max_bufãr_size
 = 1024 * 1024;

97 
µdb
->
İtiÚs
->
u£_fsync
 = 
çl£
;

98 
µdb
->
İtiÚs
->
rg‘_fe_size_muÉl›r
 = 1;

99 
µdb
->
İtiÚs
->
Ëv–_com·ùiÚ_dyÇmic_Ëv–_by‹s
 = 
çl£
;

100 
µdb
->
İtiÚs
->
max_by‹s_fÜ_Ëv–_muÉl›r
 = 10;

102 
µdb
->
İtiÚs
->
num_Ëv–s
 = 6;

103 
µdb
->
İtiÚs
->
h¬d_¿‹_lim™
 = 2;

104 
µdb
->
İtiÚs
->
Ëv–0_fe_num_com·ùiÚ_Œigg”
 = 8;

105 
µdb
->
İtiÚs
->
rg‘_fe_size_ba£
 = 134217728;

106 
µdb
->
İtiÚs
->
max_by‹s_fÜ_Ëv–_ba£
 = 1073741824;

107 
µdb
->
İtiÚs
->
Ëv–0_¦owdown_wr™es_Œigg”
=16;

108 
µdb
->
İtiÚs
->
Ëv–0_¡İ_wr™es_Œigg”
 = 24;

109 
µdb
->
İtiÚs
->
d–‘e_obsŞ‘e_fes_³riod_miüos
 = 314572800;

110 
µdb
->
İtiÚs
->
bloom_loÿl™y
 = 1;

112 
µdb
->
İtiÚs
->
soá_¿‹_lim™
 = 0;

113 
µdb
->
İtiÚs
->
soá_³ndšg_com·ùiÚ_by‹s_lim™
 = 64ull * 1024 * 1024 * 1024;

114 
µdb
->
İtiÚs
->
h¬d_³ndšg_com·ùiÚ_by‹s_lim™
 = 128ull * 1024 * 1024 * 1024;

115 
µdb
->
İtiÚs
->
d–ayed_wr™e_¿‹
 = 8388608u;

116 
µdb
->
İtiÚs
->
wr™e_th»ad_max_y›ld_u£c
 = 100;

117 
µdb
->
İtiÚs
->
wr™e_th»ad_¦ow_y›ld_u£c
 = 3;

118 
µdb
->
İtiÚs
->
¿‹_lim™_d–ay_max_mli£cÚds
 = 1000;

119 
µdb
->
İtiÚs
->
bË_ÿche_numsh¬db™s
 = 4;

121 ià(
ÿche_size
 || 
bloom_b™s_³r_key
) {

122 
rocksdb
::
BlockBa£dTabËO±iÚs
 
bË_İtiÚs
;

123 ià(
ÿche_size
) {

124 
bË_İtiÚs
.
block_ÿche
 = 
rocksdb
::
	`NewLRUCache
(
ÿche_size
, 6, 
çl£
, 0.0);

127 ià(
bloom_b™s_³r_key
) {

128 
bË_İtiÚs
.
f‹r_pŞicy
.
	`»£t
(

129 
rocksdb
::
	`NewBloomF‹rPŞicy
(
bloom_b™s_³r_key
, 
çl£
));

141 
µdb
->
İtiÚs
->
bË_çùÜy
.
	`»£t
(

142 
rocksdb
::
	`NewBlockBa£dTabËFaùÜy
(
bË_İtiÚs
));

144 
µdb
->
İtiÚs
->
max_İ’_fes
 = 500000;

146 
rocksdb
::
Stus
 
¡©us
 =„ocksdb::
DB
::
	`O³n
(

147 *
µdb
->
İtiÚs
, *µdb->
f’ame
, &µdb->
db
);

148 ià(!
¡©us
.
	`ok
())

150 
	`´štf
("çedØİ’ db %s\n", 
f’ame
);

151  
COUCHSTORE_ERROR_OPEN_FILE
;

154 
µdb
->
»ad_İtiÚs
 = 
Ãw
 
rocksdb
::
	`R—dO±iÚs
();

155 
µdb
->
wr™e_İtiÚs
 = 
Ãw
 
rocksdb
::
	`Wr™eO±iÚs
();

156 
µdb
->
wr™e_İtiÚs
->
sync
 = 
Œue
;

159 
	`as£¹
(
¡©us
.
	`ok
());

160 
	`´štf
("İ’ db %s\n", 
f’ame
);

162  
COUCHSTORE_SUCCESS
;

163 
	}
}

165 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_sync
(
Db
 *
db
, 
sync
)

167 
db
->
wr™e_İtiÚs
->
sync
 = synø? 
Œue
 : 
çl£
;

168  
COUCHSTORE_SUCCESS
;

169 
	}
}

171 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_di§bË_auto_com·ùiÚ
(
Db
 *
db
, 
ıt
)

173 
rocksdb
::
Stus
 
¡©us
;

174 
db
->
İtiÚs
->
di§bË_auto_com·ùiÚs
 = 
ıt
;

175 
d–‘e
 
db
->db;

176 
¡©us
 = 
rocksdb
::
DB
::
	`O³n
(*
db
->
İtiÚs
, *db->
f’ame
, &db->db);

177  
COUCHSTORE_SUCCESS
;

178 
	}
}

180 
LIBCOUCHSTORE_API


181 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_db
(
Db
 *
db
)

183 
d–‘e
 
db
->db;

184 
d–‘e
 
db
->
İtiÚs
;

185 
d–‘e
 
db
->
wr™e_İtiÚs
;

186 
d–‘e
 
db
->
»ad_İtiÚs
;

187 
d–‘e
 
db
->
f’ame
;

188 
	`ä“
(
db
);

190  
COUCHSTORE_SUCCESS
;

191 
	}
}

193 
LIBCOUCHSTORE_API


194 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_db_šfo
(
Db
 *
db
, 
DbInfo
* 
šfo
)

196 
¡©
 
fe¡©
;

198 
šfo
->
f’ame
 = 
db
->f’ame->
	`c_¡r
();

199 
šfo
->
doc_couÁ
 = 0;

200 
šfo
->
d–‘ed_couÁ
 = 0;

201 
šfo
->
h—d”_pos™iÚ
 = 0;

202 
šfo
->
Ï¡_£qu’û
 = 0;

204 
	`¡©
(
db
->
f’ame
->
	`c_¡r
(), &
fe¡©
);

205 
šfo
->
¥aû_u£d
 = 
fe¡©
.
¡_size
;

207  
COUCHSTORE_SUCCESS
;

208 
	}
}

210 
size_t
 
	$_docšfo_to_buf
(
DocInfo
 *
docšfo
, *
buf
)

213 
size_t
 
off£t
 = 0;

215 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
»v_£q
, (docinfo->rev_seq));

216 
off£t
 +ğ(
docšfo
->
»v_£q
);

218 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
d–‘ed
, (docinfo->deleted));

219 
off£t
 +ğ(
docšfo
->
d–‘ed
);

221 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
cÚ‹Á_m‘a
,

222 (
docšfo
->
cÚ‹Á_m‘a
));

223 
off£t
 +ğ(
docšfo
->
cÚ‹Á_m‘a
);

225 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
»v_m‘a
.
size
,

226 (
docšfo
->
»v_m‘a
.
size
));

227 
off£t
 +ğ(
docšfo
->
»v_m‘a
.
size
);

229 ià(
docšfo
->
»v_m‘a
.
size
 > 0) {

230 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, 
docšfo
->
»v_m‘a
.buf, docšfo->»v_m‘a.
size
);

231 
off£t
 +ğ
docšfo
->
»v_m‘a
.
size
;

234  
off£t
;

235 
	}
}

237 
LIBCOUCHSTORE_API


238 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’ts
(
Db
 *
db
, 
Doc
* cÚ¡ 
docs
[], 
DocInfo
 *
šfos
[],

239 
numdocs
, 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

241 
i
;

242 
¡d
::
¡ršg
 
tmp
;

244 #ià!
wÜklßd_check


245 
ušt8_t
 *
buf
;

246 
rocksdb
::
Stus
 
¡©us
;

247 
rocksdb
::
Wr™eB©ch
 
wb
;

248 
buf
 = (
ušt8_t
*)
	`m®loc
(
DATABUF_MAXLEN
);

249 
i
=0;i<
numdocs
;++i){

263 
	`memıy
(
buf
, 
docs
[
i
]->
d©a
.buf, docs[i]->d©a.
size
);

264 
wb
.
	`Put
(
rocksdb
::
	`Sliû
(
docs
[
i
]->
id
.
buf
, docs[i]->id.
size
),

265 
rocksdb
::
	`Sliû
((*)
buf
, 
docs
[
i
]->
d©a
.
size
));

268 
	`ä“
(
buf
);

269 
¡©us
 = 
db
->db->
	`Wr™e
(*db->
wr™e_İtiÚs
, &
wb
);

270 ià(!
¡©us
.
	`ok
()) {

271 
	`´štf
("ERR %s\n", 
¡©us
.
	`ToSŒšg
().
	`c_¡r
());

273 
	`as£¹
(
¡©us
.
	`ok
());

276  
COUCHSTORE_SUCCESS
;

277 
	}
}

279 
LIBCOUCHSTORE_API


280 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’t
(
Db
 *
db
, cÚ¡ 
Doc
 *
doc
, 
DocInfo
 *
šfo
,

281 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

283  
	`couch¡Üe_§ve_docum’ts
(
db
, (
Doc
**)&
doc
, (
DocInfo
**)&
šfo
, 1, 
İtiÚs
);

284 
	}
}

286 
	$_buf_to_docšfo
(*
buf
, 
size_t
 
size
, 
DocInfo
 *
docšfo
)

288 
size_t
 
off£t
 = 0;

290 
	`memıy
(&
docšfo
->
»v_£q
, (
ušt8_t
*)
buf
 + 
off£t
, (docinfo->rev_seq));

291 
off£t
 +ğ(
docšfo
->
»v_£q
);

293 
	`memıy
(&
docšfo
->
d–‘ed
, (
ušt8_t
*)
buf
 + 
off£t
, (docinfo->deleted));

294 
off£t
 +ğ(
docšfo
->
d–‘ed
);

296 
	`memıy
(&
docšfo
->
cÚ‹Á_m‘a
, (
ušt8_t
*)
buf
 + 
off£t
,

297 (
docšfo
->
cÚ‹Á_m‘a
));

298 
off£t
 +ğ(
docšfo
->
cÚ‹Á_m‘a
);

300 
	`memıy
(&
docšfo
->
»v_m‘a
.
size
, (
ušt8_t
*)
buf
 + 
off£t
,

301 (
docšfo
->
»v_m‘a
.
size
));

302 
off£t
 +ğ(
docšfo
->
»v_m‘a
.
size
);

304 ià(
docšfo
->
»v_m‘a
.
size
 > 0) {

306 
docšfo
->
»v_m‘a
.
buf
 = ((*)docšfoè+ (
DocInfo
);

307 
	`memıy
(
docšfo
->
»v_m‘a
.
buf
, (
ušt8_t
*)buà+ 
off£t
, docšfo->»v_m‘a.
size
);

308 
off£t
 +ğ
docšfo
->
»v_m‘a
.
size
;

310 
docšfo
->
»v_m‘a
.
buf
 = 
NULL
;

312 
	}
}

314 
LIBCOUCHSTORE_API


315 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_docšfo_by_id
(
Db
 *
db
, cÚ¡ *
id
, 
size_t
 
idËn
, 
DocInfo
 **
pInfo
)

317 
rocksdb
::
Stus
 
¡©us
;

318 
¡d
::
¡ršg
 *
v®ue
 = 
NULL
;

319 
size_t
 
v®u–’
= 0;

320 
size_t
 
»v_m‘a_size
;

321 
size_t
 
m‘a_off£t
;

323 
¡©us
 = 
db
->db->
	`G‘
(*db->
»ad_İtiÚs
, 
rocksdb
::
	`Sliû
((*)
id
, 
idËn
),

324 
v®ue
);

325 
m‘a_off£t
 = (
ušt64_t
)*1 + () +

326 (
couch¡Üe_cÚ‹Á_m‘a_æags
);

327 
	`memıy
(&
»v_m‘a_size
, (
ušt8_t
*)
v®ue
 + (
ušt16_t
è+ 
m‘a_off£t
,

328 (
size_t
));

330 *
pInfo
 = (
DocInfo
 *)
	`m®loc
((DocInfoè+ 
»v_m‘a_size
);

331 (*
pInfo
)->
id
.
buf
 = (*)id;

332 (*
pInfo
)->
id
.
size
 = 
idËn
;

333 (*
pInfo
)->
size
 = 
idËn
 + 
v®u–’
;

334 (*
pInfo
)->
bp
 = 0;

335 (*
pInfo
)->
db_£q
 = 0;

336 
	`_buf_to_docšfo
((
ušt8_t
*)
v®ue
 + (
ušt16_t
), 
v®u–’
, (*
pInfo
));

338 
	`ä“
(
v®ue
);

340  
COUCHSTORE_SUCCESS
;

341 
	}
}

343 
LIBCOUCHSTORE_API


344 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_docšfos_by_id
(
Db
 *
db
, cÚ¡ 
sized_buf
 
ids
[], 
numDocs
,

345 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
, 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
, *
ùx
)

347 
size_t
 
i
;

348 
DocInfo
 *
docšfo
;

349 
rocksdb
::
Stus
 
¡©us
;

350 
¡d
::
¡ršg
 *
v®ue
 = 
NULL
;

351 
size_t
 
v®u–’
 = 0;

352 
size_t
 
»v_m‘a_size
, 
max_m‘a_size
 = 256;

353 
size_t
 
m‘a_off£t
;

355 
m‘a_off£t
 = (
ušt64_t
)*1 + (è+ (
couch¡Üe_cÚ‹Á_m‘a_æags
);

356 
docšfo
 = (
DocInfo
*)
	`m®loc
((DocInfoè+ 
max_m‘a_size
);

358 
i
=0;i<
numDocs
;++i){

359 
¡©us
 = 
db
->db->
	`G‘
(*db->
»ad_İtiÚs
,

360 
rocksdb
::
	`Sliû
(
ids
[
i
].
buf
, ids[i].
size
), 
v®ue
);

362 
	`memıy
(&
»v_m‘a_size
, (
ušt8_t
*)
v®ue
 + (
ušt16_t
è+ 
m‘a_off£t
,

363 (
size_t
));

364 ià(
»v_m‘a_size
 > 
max_m‘a_size
) {

365 
max_m‘a_size
 = 
»v_m‘a_size
;

366 
docšfo
 = (
DocInfo
*)
	`»®loc
(docšfo, (DocInfoè+ 
max_m‘a_size
);

369 
	`mem£t
(
docšfo
, 0, (
DocInfo
));

370 
docšfo
->
id
.
buf
 = 
ids
[
i
].buf;

371 
docšfo
->
id
.
size
 = 
ids
[
i
].size;

372 
docšfo
->
size
 = 
ids
[
i
].siz+ 
v®u–’
;

373 
docšfo
->
bp
 = 0;

374 
docšfo
->
db_£q
 = 0;

375 
	`_buf_to_docšfo
((
ušt8_t
*)
v®ue
 + (
ušt16_t
), 
v®u–’
, 
docšfo
);

376 
	`ä“
(
v®ue
);

378 
	`ÿÎback
(
db
, 
docšfo
, 
ùx
);

381 
	`ä“
(
docšfo
);

383  
COUCHSTORE_SUCCESS
;

384 
	}
}

386 
LIBCOUCHSTORE_API


387 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_docšfos_by_£qu’û
(
Db
 *
db
,

388 cÚ¡ 
ušt64_t
 
£qu’û
[],

389 
numDocs
,

390 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

391 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
,

392 *
ùx
)

396  
COUCHSTORE_SUCCESS
;

397 
	}
}

399 
LIBCOUCHSTORE_API


400 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_docum’t
(
Db
 *
db
,

401 cÚ¡ *
id
,

402 
size_t
 
idËn
,

403 
Doc
 **
pDoc
,

404 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

407 #ià!
wÜklßd_check


408 
rocksdb
::
Stus
 
¡©us
;

409 
¡d
::
¡ršg
 
tmp
;

410 * 
v®ue
 = 
NULL
;

411 
size_t
 
v®u–’
;

413 
¡©us
 = 
db
->db->
	`G‘
(*db->
»ad_İtiÚs
, 
rocksdb
::
	`Sliû
((*)
id
, 
idËn
),

414 &
tmp
);

416 ià(
¡©us
.
	`ok
()) {

422 
v®u–’
 = 0;

423 ià(!
¡©us
.
	`IsNÙFound
()) {

424 
	`´štf
("ERR %s\n", 
¡©us
.
	`ToSŒšg
().
	`c_¡r
());

426 
	`årštf
(
¡dout
, "nÙ found %s\n", (*)
id
);

429 
	`as£¹
(
¡©us
.
	`ok
());

438  
COUCHSTORE_SUCCESS
;

439 
	}
}

441 
LIBCOUCHSTORE_API


442 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_d–‘e_docum’t
(
Db
 *
db
,

443 cÚ¡ *
id
,

444 
size_t
 
idËn
,

445 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

448 
rocksdb
::
Stus
 
¡©us
;

449 
¡©us
 = 
db
->db->
	`D–‘e
(*db->
wr™e_İtiÚs
, 
rocksdb
::
	`Sliû
((*)
id
, 
idËn
));

450 if(!
¡©us
.
	`ok
()) {

455  
COUCHSTORE_SUCCESS
;

456 
	}
}

458 
LIBCOUCHSTORE_API


459 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_w®k_id_Œ“
(
Db
 *
db
,

460 cÚ¡ 
sized_buf
* 
¡¬tDocID
,

461 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

462 
couch¡Üe_w®k_Œ“_ÿÎback_â
 
ÿÎback
,

463 *
ùx
)

465 
c_»t
 = 0;

466 
rocksdb
::
I‹¿tÜ
* 
r™
 = 
db
->db->
	`NewI‹¿tÜ
Ôocksdb::
	`R—dO±iÚs
());

467 
rocksdb
::
Sliû
 
¡¬tkey
 =„ocksdb::
	`Sliû
(
¡¬tDocID
->
buf
, s¹DocID->
size
);

468 
rocksdb
::
Sliû
 
key±r
, 
v®u•Œ
;

469 
DocInfo
 
doc_šfo
;

470 
Doc
 
doc
;

472 
r™
->
	`S“k
(
¡¬tkey
);

474 
r™
->
	`V®id
()) {

475 
key±r
 = 
r™
->
	`key
();

476 
v®u•Œ
 = 
r™
->
	`v®ue
();

478 
doc_šfo
.
id
.
buf
 = (*)
	`m®loc
(
key±r
.
	`size
());

479 
	`memıy
(
doc_šfo
.
id
.
buf
, 
key±r
.
	`d©a
(), key±r.
	`size
());

480 
doc
.
d©a
.
buf
 = (*)
	`m®loc
(
v®u•Œ
.
	`size
());

481 
	`memıy
(
doc
.
d©a
.
buf
, 
v®u•Œ
.
	`d©a
(), v®u•Œ.
	`size
());

483 
c_»t
 = 
	`ÿÎback
(
db
, 0, &
doc_šfo
, 0, 
NULL
, 
ùx
);

485 
	`ä“
(
doc_šfo
.
id
.
buf
);

486 
	`ä“
(
doc
.
d©a
.
buf
);

488 ià(
c_»t
 != 0) {

492 
r™
->
	`Next
();

495 
d–‘e
 
r™
;

497  
COUCHSTORE_SUCCESS
;

498 
	}
}

500 
LIBCOUCHSTORE_API


501 
	$couch¡Üe_ä“_docum’t
(
Doc
 *
doc
)

503 ià(
doc
->
id
.
buf
è
	`ä“
(doc->id.buf);

504 ià(
doc
->
d©a
.
buf
è
	`ä“
(doc->data.buf);

505 
	`ä“
(
doc
);

506 
	}
}

509 
LIBCOUCHSTORE_API


510 
	$couch¡Üe_ä“_docšfo
(
DocInfo
 *
docšfo
)

513 
	`ä“
(
docšfo
);

514 
	}
}

516 
LIBCOUCHSTORE_API


517 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_comm™
(
Db
 *
db
)

521  
COUCHSTORE_SUCCESS
;

522 
	}
}

524 
LIBCOUCHSTORE_API


525 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_com·ù_db_ex
(
Db
* 
sourû
, cÚ¡ * 
rg‘_f’ame
,

526 
ušt64_t
 
æags
, 
FeOpsIÁ”çû
 *
İs
)

528  
COUCHSTORE_SUCCESS
;

529 
	}
}

531 
LIBCOUCHSTORE_API


532 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_com·ù_db
(
Db
* 
sourû
, cÚ¡ * 
rg‘_f’ame
)

534  
	`couch¡Üe_com·ù_db_ex
(
sourû
, 
rg‘_f’ame
, 0x0, 
NULL
);

535 
	}
}

	@application/kvbench/wrappers/couch_rocksdb.cc

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

6 
	~<sys/¡©.h
>

7 
	~<uni¡d.h
>

8 
	~<io¡»am
>

10 
	~"¡İw©ch.h
"

11 
	~"rocksdb/ÿche.h
"

12 
	~"rocksdb/db.h
"

13 
	~"rocksdb/bË.h
"

14 
	~"rocksdb/f‹r_pŞicy.h
"

15 
	~"rocksdb/bË.h
"

16 
	~"libcouch¡Üe/couch_db.h
"

18 
	#wÜklßd_check
 (0)

	)

19 
	#METABUF_MAXLEN
 (256)

	)

20 
št64_t
 
DATABUF_MAXLEN
;

22 
	s_db
 {

23 
	mrocksdb
::
DB
* 
db
;

24 
	mrocksdb
::
O±iÚs
 *
İtiÚs
;

25 
	mrocksdb
::
Wr™eO±iÚs
 *
wr™e_İtiÚs
;

26 
	mrocksdb
::
R—dO±iÚs
 *
»ad_İtiÚs
;

27 
	m¡d
::
¡ršg
 *
f’ame
;

30 
ušt64_t
 
	gÿche_size
 = 0;

31 
ušt64_t
 
	gwbs_size
 = 4*1024*1024;

32 
	gbloom_b™s_³r_key
 = 0;

33 
	gcom·ùiÚ_¡yË
 = 0;

34 
	gcom´essiÚ
 = 0;

36 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_ÿche
(
ušt64_t
 
size
)

38 
ÿche_size
 = 
size
;

39  
COUCHSTORE_SUCCESS
;

40 
	}
}

41 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_wbs_size
(
ušt64_t
 
size
) {

42 
wbs_size
 = 
size
;

43  
COUCHSTORE_SUCCESS
;

44 
	}
}

45 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_bloom
(
b™s_³r_key
) {

46 
bloom_b™s_³r_key
 = 
b™s_³r_key
;

47  
COUCHSTORE_SUCCESS
;

48 
	}
}

49 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_com·ùiÚ_¡yË
(
¡yË
) {

50 
com·ùiÚ_¡yË
 = 
¡yË
;

51  
COUCHSTORE_SUCCESS
;

52 
	}
}

53 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_com´essiÚ
(
İt
) {

54 
com´essiÚ
 = 
İt
;

55  
COUCHSTORE_SUCCESS
;

56 
	}
}

59 
LIBCOUCHSTORE_API


60 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db
(cÚ¡ *
f’ame
,

61 
couch¡Üe_İ’_æags
 
æags
,

62 
Db
 **
pDb
)

64  
	`couch¡Üe_İ’_db_ex
(
f’ame
, 
æags
,

65 
NULL
, 
pDb
);

66 
	}
}

68 
LIBCOUCHSTORE_API


69 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_db_ex
(cÚ¡ *
f’ame
,

70 
couch¡Üe_İ’_æags
 
æags
,

71 
FeOpsIÁ”çû
 *
İs
,

72 
Db
 **
pDb
)

74 
Db
 *
µdb
;

76 *
pDb
 = (
Db
*)
	`m®loc
((Db));

77 
µdb
 = *
pDb
;

79 
µdb
->
f’ame
 = 
Ãw
 
¡d
::
	`¡ršg
(filename);

81 
µdb
->
İtiÚs
 = 
Ãw
 
rocksdb
::
	`O±iÚs
();

82 
µdb
->
İtiÚs
->
ü—‹_if_missšg
 = 
Œue
;

83 ià(!
com´essiÚ
) {

84 
µdb
->
İtiÚs
->
com´essiÚ
 = 
rocksdb
::
kNoCom´essiÚ
;

87 
µdb
->
İtiÚs
->
max_background_com·ùiÚs
 = 16;

88 
µdb
->
İtiÚs
->
max_background_æushes
 = 1;

89 
µdb
->
İtiÚs
->
max_wr™e_bufãr_numb”
 = 2;

90 
µdb
->
İtiÚs
->
wr™e_bufãr_size
 = 
wbs_size
;

91 
µdb
->
İtiÚs
->
com·ùiÚ_¡yË
 = 
rocksdb
::
	`Com·ùiÚStyË
(compaction_style);

125 ià(
ÿche_size
 || 
bloom_b™s_³r_key
) {

126 
rocksdb
::
BlockBa£dTabËO±iÚs
 
bË_İtiÚs
;

127 ià(
ÿche_size
) {

128 
bË_İtiÚs
.
block_ÿche
 = 
rocksdb
::
	`NewLRUCache
(
ÿche_size
, 6, 
çl£
, 0.0);

130 ià(
bloom_b™s_³r_key
) {

131 
bË_İtiÚs
.
f‹r_pŞicy
.
	`»£t
(

132 
rocksdb
::
	`NewBloomF‹rPŞicy
(
bloom_b™s_³r_key
, 
çl£
));

135 
µdb
->
İtiÚs
->
bË_çùÜy
.
	`»£t
(

136 
rocksdb
::
	`NewBlockBa£dTabËFaùÜy
(
bË_İtiÚs
));

138 
µdb
->
İtiÚs
->
max_İ’_fes
 = 500000;

140 
rocksdb
::
Stus
 
¡©us
 =„ocksdb::
DB
::
	`O³n
(

141 *
µdb
->
İtiÚs
, *µdb->
f’ame
, &µdb->
db
);

143 
µdb
->
»ad_İtiÚs
 = 
Ãw
 
rocksdb
::
	`R—dO±iÚs
();

144 
µdb
->
wr™e_İtiÚs
 = 
Ãw
 
rocksdb
::
	`Wr™eO±iÚs
();

145 
µdb
->
wr™e_İtiÚs
->
sync
 = 
Œue
;

146 
µdb
->
wr™e_İtiÚs
->
di§bËWAL
 = 
çl£
;

148 
	`as£¹
(
¡©us
.
	`ok
());

149 
	`´štf
("İ’ db %s\n", 
f’ame
);

151  
COUCHSTORE_SUCCESS
;

152 
	}
}

154 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_£t_sync
(
Db
 *
db
, 
sync
)

156 
db
->
wr™e_İtiÚs
->
sync
 = synø? 
Œue
 : 
çl£
;

157  
COUCHSTORE_SUCCESS
;

158 
	}
}

160 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_di§bË_auto_com·ùiÚ
(
Db
 *
db
, 
ıt
)

162 
rocksdb
::
Stus
 
¡©us
;

163 
db
->
İtiÚs
->
di§bË_auto_com·ùiÚs
 = 
ıt
;

164 
d–‘e
 
db
->db;

165 
¡©us
 = 
rocksdb
::
DB
::
	`O³n
(*
db
->
İtiÚs
, *db->
f’ame
, &db->db);

166  
COUCHSTORE_SUCCESS
;

167 
	}
}

169 
LIBCOUCHSTORE_API


170 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_şo£_db
(
Db
 *
db
)

172 
d–‘e
 
db
->db;

173 
d–‘e
 
db
->
İtiÚs
;

174 
d–‘e
 
db
->
wr™e_İtiÚs
;

175 
d–‘e
 
db
->
»ad_İtiÚs
;

176 
d–‘e
 
db
->
f’ame
;

177 
	`ä“
(
db
);

179  
COUCHSTORE_SUCCESS
;

180 
	}
}

182 
LIBCOUCHSTORE_API


183 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_db_šfo
(
Db
 *
db
, 
DbInfo
* 
šfo
)

185 
¡©
 
fe¡©
;

187 
šfo
->
f’ame
 = 
db
->f’ame->
	`c_¡r
();

188 
šfo
->
doc_couÁ
 = 0;

189 
šfo
->
d–‘ed_couÁ
 = 0;

190 
šfo
->
h—d”_pos™iÚ
 = 0;

191 
šfo
->
Ï¡_£qu’û
 = 0;

193 
	`¡©
(
db
->
f’ame
->
	`c_¡r
(), &
fe¡©
);

194 
šfo
->
¥aû_u£d
 = 
fe¡©
.
¡_size
;

196  
COUCHSTORE_SUCCESS
;

197 
	}
}

199 
size_t
 
	$_docšfo_to_buf
(
DocInfo
 *
docšfo
, *
buf
)

202 
size_t
 
off£t
 = 0;

204 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
»v_£q
, (docinfo->rev_seq));

205 
off£t
 +ğ(
docšfo
->
»v_£q
);

207 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
d–‘ed
, (docinfo->deleted));

208 
off£t
 +ğ(
docšfo
->
d–‘ed
);

210 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
cÚ‹Á_m‘a
,

211 (
docšfo
->
cÚ‹Á_m‘a
));

212 
off£t
 +ğ(
docšfo
->
cÚ‹Á_m‘a
);

214 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, &
docšfo
->
»v_m‘a
.
size
,

215 (
docšfo
->
»v_m‘a
.
size
));

216 
off£t
 +ğ(
docšfo
->
»v_m‘a
.
size
);

218 ià(
docšfo
->
»v_m‘a
.
size
 > 0) {

219 
	`memıy
((
ušt8_t
*)
buf
 + 
off£t
, 
docšfo
->
»v_m‘a
.buf, docšfo->»v_m‘a.
size
);

220 
off£t
 +ğ
docšfo
->
»v_m‘a
.
size
;

223  
off£t
;

224 
	}
}

226 
LIBCOUCHSTORE_API


227 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’ts
(
Db
 *
db
, 
Doc
* cÚ¡ 
docs
[], 
DocInfo
 *
šfos
[],

228 
numdocs
, 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

230 
i
;

231 
¡d
::
¡ršg
 
tmp
;

233 #ià!
wÜklßd_check


234 
ušt8_t
 *
buf
;

235 
rocksdb
::
Stus
 
¡©us
;

236 
rocksdb
::
Wr™eB©ch
 
wb
;

237 
buf
 = (
ušt8_t
*)
	`m®loc
(
DATABUF_MAXLEN
);

238 
i
=0;i<
numdocs
;++i){

239 
	`memıy
(
buf
, 
docs
[
i
]->
d©a
.buf, docs[i]->d©a.
size
);

240 
wb
.
	`Put
(
rocksdb
::
	`Sliû
(
docs
[
i
]->
id
.
buf
, docs[i]->id.
size
),

241 
rocksdb
::
	`Sliû
((*)
buf
, 
docs
[
i
]->
d©a
.
size
));

244 
	`ä“
(
buf
);

245 
¡©us
 = 
db
->db->
	`Wr™e
(*db->
wr™e_İtiÚs
, &
wb
);

246 ià(!
¡©us
.
	`ok
()) {

247 
	`´štf
("ERR %s\n", 
¡©us
.
	`ToSŒšg
().
	`c_¡r
());

249 
	`as£¹
(
¡©us
.
	`ok
());

252  
COUCHSTORE_SUCCESS
;

253 
	}
}

255 
LIBCOUCHSTORE_API


256 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_§ve_docum’t
(
Db
 *
db
, cÚ¡ 
Doc
 *
doc
, 
DocInfo
 *
šfo
,

257 
couch¡Üe_§ve_İtiÚs
 
İtiÚs
)

259  
	`couch¡Üe_§ve_docum’ts
(
db
, (
Doc
**)&
doc
, (
DocInfo
**)&
šfo
, 1, 
İtiÚs
);

260 
	}
}

262 
	$_buf_to_docšfo
(*
buf
, 
size_t
 
size
, 
DocInfo
 *
docšfo
)

264 
size_t
 
off£t
 = 0;

266 
	`memıy
(&
docšfo
->
»v_£q
, (
ušt8_t
*)
buf
 + 
off£t
, (docinfo->rev_seq));

267 
off£t
 +ğ(
docšfo
->
»v_£q
);

269 
	`memıy
(&
docšfo
->
d–‘ed
, (
ušt8_t
*)
buf
 + 
off£t
, (docinfo->deleted));

270 
off£t
 +ğ(
docšfo
->
d–‘ed
);

272 
	`memıy
(&
docšfo
->
cÚ‹Á_m‘a
, (
ušt8_t
*)
buf
 + 
off£t
,

273 (
docšfo
->
cÚ‹Á_m‘a
));

274 
off£t
 +ğ(
docšfo
->
cÚ‹Á_m‘a
);

276 
	`memıy
(&
docšfo
->
»v_m‘a
.
size
, (
ušt8_t
*)
buf
 + 
off£t
,

277 (
docšfo
->
»v_m‘a
.
size
));

278 
off£t
 +ğ(
docšfo
->
»v_m‘a
.
size
);

280 ià(
docšfo
->
»v_m‘a
.
size
 > 0) {

281 
docšfo
->
»v_m‘a
.
buf
 = ((*)docšfoè+ (
DocInfo
);

282 
	`memıy
(
docšfo
->
»v_m‘a
.
buf
, (
ušt8_t
*)buà+ 
off£t
, docšfo->»v_m‘a.
size
);

283 
off£t
 +ğ
docšfo
->
»v_m‘a
.
size
;

285 
docšfo
->
»v_m‘a
.
buf
 = 
NULL
;

287 
	}
}

289 
LIBCOUCHSTORE_API


290 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_docšfo_by_id
(
Db
 *
db
, cÚ¡ *
id
, 
size_t
 
idËn
, 
DocInfo
 **
pInfo
)

292 
rocksdb
::
Stus
 
¡©us
;

293 
¡d
::
¡ršg
 *
v®ue
 = 
NULL
;

294 
size_t
 
v®u–’
= 0;

295 
size_t
 
»v_m‘a_size
;

296 
size_t
 
m‘a_off£t
;

298 
¡©us
 = 
db
->db->
	`G‘
(*db->
»ad_İtiÚs
, 
rocksdb
::
	`Sliû
((*)
id
, 
idËn
),

299 
v®ue
);

300 
m‘a_off£t
 = (
ušt64_t
)*1 + () +

301 (
couch¡Üe_cÚ‹Á_m‘a_æags
);

302 
	`memıy
(&
»v_m‘a_size
, (
ušt8_t
*)
v®ue
 + (
ušt16_t
è+ 
m‘a_off£t
,

303 (
size_t
));

305 *
pInfo
 = (
DocInfo
 *)
	`m®loc
((DocInfoè+ 
»v_m‘a_size
);

306 (*
pInfo
)->
id
.
buf
 = (*)id;

307 (*
pInfo
)->
id
.
size
 = 
idËn
;

308 (*
pInfo
)->
size
 = 
idËn
 + 
v®u–’
;

309 (*
pInfo
)->
bp
 = 0;

310 (*
pInfo
)->
db_£q
 = 0;

311 
	`_buf_to_docšfo
((
ušt8_t
*)
v®ue
 + (
ušt16_t
), 
v®u–’
, (*
pInfo
));

313 
	`ä“
(
v®ue
);

315  
COUCHSTORE_SUCCESS
;

316 
	}
}

318 
LIBCOUCHSTORE_API


319 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_docšfos_by_id
(
Db
 *
db
, cÚ¡ 
sized_buf
 
ids
[], 
numDocs
,

320 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
, 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
, *
ùx
)

322 
size_t
 
i
;

323 
DocInfo
 *
docšfo
;

324 
rocksdb
::
Stus
 
¡©us
;

325 
¡d
::
¡ršg
 *
v®ue
 = 
NULL
;

326 
size_t
 
v®u–’
 = 0;

327 
size_t
 
»v_m‘a_size
, 
max_m‘a_size
 = 256;

328 
size_t
 
m‘a_off£t
;

330 
m‘a_off£t
 = (
ušt64_t
)*1 + (è+ (
couch¡Üe_cÚ‹Á_m‘a_æags
);

331 
docšfo
 = (
DocInfo
*)
	`m®loc
((DocInfoè+ 
max_m‘a_size
);

333 
i
=0;i<
numDocs
;++i){

334 
¡©us
 = 
db
->db->
	`G‘
(*db->
»ad_İtiÚs
,

335 
rocksdb
::
	`Sliû
(
ids
[
i
].
buf
, ids[i].
size
), 
v®ue
);

337 
	`memıy
(&
»v_m‘a_size
, (
ušt8_t
*)
v®ue
 + (
ušt16_t
è+ 
m‘a_off£t
,

338 (
size_t
));

339 ià(
»v_m‘a_size
 > 
max_m‘a_size
) {

340 
max_m‘a_size
 = 
»v_m‘a_size
;

341 
docšfo
 = (
DocInfo
*)
	`»®loc
(docšfo, (DocInfoè+ 
max_m‘a_size
);

344 
	`mem£t
(
docšfo
, 0, (
DocInfo
));

345 
docšfo
->
id
.
buf
 = 
ids
[
i
].buf;

346 
docšfo
->
id
.
size
 = 
ids
[
i
].size;

347 
docšfo
->
size
 = 
ids
[
i
].siz+ 
v®u–’
;

348 
docšfo
->
bp
 = 0;

349 
docšfo
->
db_£q
 = 0;

350 
	`_buf_to_docšfo
((
ušt8_t
*)
v®ue
 + (
ušt16_t
), 
v®u–’
, 
docšfo
);

351 
	`ä“
(
v®ue
);

353 
	`ÿÎback
(
db
, 
docšfo
, 
ùx
);

356 
	`ä“
(
docšfo
);

358  
COUCHSTORE_SUCCESS
;

359 
	}
}

361 
LIBCOUCHSTORE_API


362 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_docšfos_by_£qu’û
(
Db
 *
db
,

363 cÚ¡ 
ušt64_t
 
£qu’û
[],

364 
numDocs
,

365 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

366 
couch¡Üe_chªges_ÿÎback_â
 
ÿÎback
,

367 *
ùx
)

371  
COUCHSTORE_SUCCESS
;

372 
	}
}

374 
LIBCOUCHSTORE_API


375 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_İ’_docum’t
(
Db
 *
db
,

376 cÚ¡ *
id
,

377 
size_t
 
idËn
,

378 
Doc
 **
pDoc
,

379 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

382 #ià!
wÜklßd_check


383 
rocksdb
::
Stus
 
¡©us
;

384 
¡d
::
¡ršg
 
tmp
;

385 * 
v®ue
 = 
NULL
;

386 
size_t
 
v®u–’
;

388 
¡©us
 = 
db
->db->
	`G‘
(*db->
»ad_İtiÚs
, 
rocksdb
::
	`Sliû
((*)
id
, 
idËn
),

389 &
tmp
);

391 ià(
¡©us
.
	`ok
()) {

397 
v®u–’
 = 0;

398 ià(!
¡©us
.
	`IsNÙFound
()) {

399 
	`´štf
("ERR %s\n", 
¡©us
.
	`ToSŒšg
().
	`c_¡r
());

401 
	`årštf
(
¡dout
, "nÙ found %s\n", (*)
id
);

404 
	`as£¹
(
¡©us
.
	`ok
());

413  
COUCHSTORE_SUCCESS
;

414 
	}
}

416 
LIBCOUCHSTORE_API


417 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_d–‘e_docum’t
(
Db
 *
db
,

418 cÚ¡ *
id
,

419 
size_t
 
idËn
,

420 
couch¡Üe_İ’_İtiÚs
 
İtiÚs
)

423 
rocksdb
::
Stus
 
¡©us
;

424 
¡©us
 = 
db
->db->
	`D–‘e
(*db->
wr™e_İtiÚs
, 
rocksdb
::
	`Sliû
((*)
id
, 
idËn
));

425 if(!
¡©us
.
	`ok
()) {

430  
COUCHSTORE_SUCCESS
;

431 
	}
}

433 
LIBCOUCHSTORE_API


434 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_w®k_id_Œ“
(
Db
 *
db
,

435 cÚ¡ 
sized_buf
* 
¡¬tDocID
,

436 
couch¡Üe_docšfos_İtiÚs
 
İtiÚs
,

437 
couch¡Üe_w®k_Œ“_ÿÎback_â
 
ÿÎback
,

438 *
ùx
)

440 
c_»t
 = 0;

441 
rocksdb
::
I‹¿tÜ
* 
r™
 = 
db
->db->
	`NewI‹¿tÜ
Ôocksdb::
	`R—dO±iÚs
());

442 
rocksdb
::
Sliû
 
¡¬tkey
 =„ocksdb::
	`Sliû
(
¡¬tDocID
->
buf
, s¹DocID->
size
);

443 
rocksdb
::
Sliû
 
key±r
, 
v®u•Œ
;

444 
DocInfo
 
doc_šfo
;

445 
Doc
 
doc
;

447 
r™
->
	`S“k
(
¡¬tkey
);

449 
r™
->
	`V®id
()) {

450 
key±r
 = 
r™
->
	`key
();

451 
v®u•Œ
 = 
r™
->
	`v®ue
();

453 
doc_šfo
.
id
.
buf
 = (*)
	`m®loc
(
key±r
.
	`size
());

454 
	`memıy
(
doc_šfo
.
id
.
buf
, 
key±r
.
	`d©a
(), key±r.
	`size
());

455 
doc
.
d©a
.
buf
 = (*)
	`m®loc
(
v®u•Œ
.
	`size
());

456 
	`memıy
(
doc
.
d©a
.
buf
, 
v®u•Œ
.
	`d©a
(), v®u•Œ.
	`size
());

458 
c_»t
 = 
	`ÿÎback
(
db
, 0, &
doc_šfo
, 0, 
NULL
, 
ùx
);

460 
	`ä“
(
doc_šfo
.
id
.
buf
);

461 
	`ä“
(
doc
.
d©a
.
buf
);

463 ià(
c_»t
 != 0) {

467 
r™
->
	`Next
();

470 
d–‘e
 
r™
;

472  
COUCHSTORE_SUCCESS
;

473 
	}
}

475 
LIBCOUCHSTORE_API


476 
	$couch¡Üe_ä“_docum’t
(
Doc
 *
doc
)

478 ià(
doc
->
id
.
buf
è
	`ä“
(doc->id.buf);

479 ià(
doc
->
d©a
.
buf
è
	`ä“
(doc->data.buf);

480 
	`ä“
(
doc
);

481 
	}
}

484 
LIBCOUCHSTORE_API


485 
	$couch¡Üe_ä“_docšfo
(
DocInfo
 *
docšfo
)

488 
	`ä“
(
docšfo
);

489 
	}
}

491 
LIBCOUCHSTORE_API


492 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_comm™
(
Db
 *
db
)

496  
COUCHSTORE_SUCCESS
;

497 
	}
}

499 
LIBCOUCHSTORE_API


500 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_com·ù_db_ex
(
Db
* 
sourû
, cÚ¡ * 
rg‘_f’ame
,

501 
ušt64_t
 
æags
, 
FeOpsIÁ”çû
 *
İs
)

503  
COUCHSTORE_SUCCESS
;

504 
	}
}

506 
LIBCOUCHSTORE_API


507 
couch¡Üe_”rÜ_t
 
	$couch¡Üe_com·ù_db
(
Db
* 
sourû
, cÚ¡ * 
rg‘_f’ame
)

509  
	`couch¡Üe_com·ù_db_ex
(
sourû
, 
rg‘_f’ame
, 0x0, 
NULL
);

510 
	}
}

	@
1
.
0
347
18455
PDK/core/include/kvs_api.h
PDK/core/include/kvs_const.h
PDK/core/include/kvs_result.h
PDK/core/include/kvs_struct.h
PDK/core/sample_code/test_async.cpp
PDK/core/sample_code/test_sync.cpp
PDK/core/src/api/include/private/kvemul.hpp
PDK/core/src/api/include/private/kvkdd.hpp
PDK/core/src/api/include/private/kvs_utils.h
PDK/core/src/api/include/private/private_types.h
PDK/core/src/api/include/private/udd.hpp
PDK/core/src/api/include/private/uddenv.h
PDK/core/src/api/include/udd/kv_trace.h
PDK/core/src/api/include/udd/kv_types.h
PDK/core/src/api/include/udd/kvnvme.h
PDK/core/src/api/include/udd/spdk/assert.h
PDK/core/src/api/include/udd/spdk/barrier.h
PDK/core/src/api/include/udd/spdk/bdev.h
PDK/core/src/api/include/udd/spdk/bit_array.h
PDK/core/src/api/include/udd/spdk/blob.h
PDK/core/src/api/include/udd/spdk/blob_bdev.h
PDK/core/src/api/include/udd/spdk/blobfs.h
PDK/core/src/api/include/udd/spdk/conf.h
PDK/core/src/api/include/udd/spdk/copy_engine.h
PDK/core/src/api/include/udd/spdk/endian.h
PDK/core/src/api/include/udd/spdk/env.h
PDK/core/src/api/include/udd/spdk/event.h
PDK/core/src/api/include/udd/spdk/fd.h
PDK/core/src/api/include/udd/spdk/gpt_spec.h
PDK/core/src/api/include/udd/spdk/io_channel.h
PDK/core/src/api/include/udd/spdk/ioat.h
PDK/core/src/api/include/udd/spdk/ioat_spec.h
PDK/core/src/api/include/udd/spdk/iscsi_spec.h
PDK/core/src/api/include/udd/spdk/json.h
PDK/core/src/api/include/udd/spdk/jsonrpc.h
PDK/core/src/api/include/udd/spdk/kvnvme_spdk.h
PDK/core/src/api/include/udd/spdk/likely.h
PDK/core/src/api/include/udd/spdk/log.h
PDK/core/src/api/include/udd/spdk/mmio.h
PDK/core/src/api/include/udd/spdk/net.h
PDK/core/src/api/include/udd/spdk/nvme.h
PDK/core/src/api/include/udd/spdk/nvme_intel.h
PDK/core/src/api/include/udd/spdk/nvme_internal.h
PDK/core/src/api/include/udd/spdk/nvme_spec.h
PDK/core/src/api/include/udd/spdk/nvmf.h
PDK/core/src/api/include/udd/spdk/nvmf_spec.h
PDK/core/src/api/include/udd/spdk/pci_ids.h
PDK/core/src/api/include/udd/spdk/queue.h
PDK/core/src/api/include/udd/spdk/queue_extras.h
PDK/core/src/api/include/udd/spdk/rpc.h
PDK/core/src/api/include/udd/spdk/scsi.h
PDK/core/src/api/include/udd/spdk/scsi_spec.h
PDK/core/src/api/include/udd/spdk/stdinc.h
PDK/core/src/api/include/udd/spdk/string.h
PDK/core/src/api/include/udd/spdk/trace.h
PDK/core/src/api/include/udd/spdk/util.h
PDK/core/src/api/include/udd/spdk/vhost.h
PDK/core/src/api/src/cfrontend.cpp
PDK/core/src/api/src/driver_adapter/kvemuldriver.cpp
PDK/core/src/api/src/driver_adapter/kvkdd.cpp
PDK/core/src/api/src/driver_adapter/kvudd.cpp
PDK/core/src/api/src/kvsdevice.cpp
PDK/core/src/api/src/uddenv.cpp
PDK/core/src/device_abstract_layer/emulator/src/io_cmd.cpp
PDK/core/src/device_abstract_layer/emulator/src/kv_config.cpp
PDK/core/src/device_abstract_layer/emulator/src/kv_device.cpp
PDK/core/src/device_abstract_layer/emulator/src/kv_emulator.cpp
PDK/core/src/device_abstract_layer/emulator/src/kv_namespace.cpp
PDK/core/src/device_abstract_layer/emulator/src/kvs_adi.cpp
PDK/core/src/device_abstract_layer/emulator/src/queue.cpp
PDK/core/src/device_abstract_layer/emulator/src/thread_pool.cpp
PDK/core/src/device_abstract_layer/include/kvs_adi.h
PDK/core/src/device_abstract_layer/include/private/history.hpp
PDK/core/src/device_abstract_layer/include/private/io_cmd.hpp
PDK/core/src/device_abstract_layer/include/private/kv_config.hpp
PDK/core/src/device_abstract_layer/include/private/kv_device.hpp
PDK/core/src/device_abstract_layer/include/private/kv_emulator.hpp
PDK/core/src/device_abstract_layer/include/private/kv_namespace.hpp
PDK/core/src/device_abstract_layer/include/private/kvs_adi_internal.h
PDK/core/src/device_abstract_layer/include/private/kvs_utils.h
PDK/core/src/device_abstract_layer/include/private/queue.hpp
PDK/core/src/device_abstract_layer/include/private/thread_pool.hpp
PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi.cpp
PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi.h
PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi_debug.cpp
PDK/core/src/device_abstract_layer/kernel_driver_adapter/kadi_debug.h
PDK/core/src/device_abstract_layer/kernel_driver_adapter/kvs_adi.cpp
PDK/core/src/device_abstract_layer/kernel_driver_adapter/linux_nvme_ioctl.h
PDK/core/tools/pci_ids.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/nvme-core.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/nvme-scsi.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-327-centos-7_2/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/core.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/fabrics.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/fabrics.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/fc.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/linux_nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/pci.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/rdma.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10.0-693-centos-7_4/scsi.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10/nvme-core.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10/nvme-scsi.c
PDK/driver/PCIe/kernel_driver/kernel_v3.10/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10/scsi.h
PDK/driver/PCIe/kernel_driver/kernel_v3.10/sg.h
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/core.c
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/fabrics.c
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/fabrics.h
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/fc.c
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/lightnvm.c
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/linux_nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/pci.c
PDK/driver/PCIe/kernel_driver/kernel_v4.13.15-041315-ubuntu-16_04/rdma.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/core.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/fabrics.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/fabrics.h
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/fc.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/lightnvm.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/linux_nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/multipath.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/pci.c
PDK/driver/PCIe/kernel_driver/kernel_v4.15.18-041518-ubuntu-18_04/rdma.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/core.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/lightnvm.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/linux_nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/pci.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-141-ubuntu-16_04/scsi.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/core.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/lightnvm.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/linux_nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/pci.c
PDK/driver/PCIe/kernel_driver/kernel_v4.4.0-98-ubuntu-16_04/scsi.c
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/core.c
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/fabrics.c
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/fabrics.h
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/lightnvm.c
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/linux_nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/linux_nvme_ioctl.h
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/nvme.h
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/pci.c
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/rdma.c
PDK/driver/PCIe/kernel_driver/kernel_v4.9.5/scsi.c
application/kvbench/bench/arch.h
application/kvbench/bench/couch_bench.cc
application/kvbench/bench/forestdb_endian.h
application/kvbench/include/aerospike/aerospike.h
application/kvbench/include/aerospike/aerospike_batch.h
application/kvbench/include/aerospike/aerospike_index.h
application/kvbench/include/aerospike/aerospike_info.h
application/kvbench/include/aerospike/aerospike_key.h
application/kvbench/include/aerospike/aerospike_query.h
application/kvbench/include/aerospike/aerospike_scan.h
application/kvbench/include/aerospike/aerospike_udf.h
application/kvbench/include/aerospike/as_address.h
application/kvbench/include/aerospike/as_admin.h
application/kvbench/include/aerospike/as_aerospike.h
application/kvbench/include/aerospike/as_arraylist.h
application/kvbench/include/aerospike/as_arraylist_iterator.h
application/kvbench/include/aerospike/as_async.h
application/kvbench/include/aerospike/as_async_proto.h
application/kvbench/include/aerospike/as_batch.h
application/kvbench/include/aerospike/as_bin.h
application/kvbench/include/aerospike/as_boolean.h
application/kvbench/include/aerospike/as_buffer.h
application/kvbench/include/aerospike/as_buffer_pool.h
application/kvbench/include/aerospike/as_bytes.h
application/kvbench/include/aerospike/as_cluster.h
application/kvbench/include/aerospike/as_command.h
application/kvbench/include/aerospike/as_config.h
application/kvbench/include/aerospike/as_double.h
application/kvbench/include/aerospike/as_error.h
application/kvbench/include/aerospike/as_event.h
application/kvbench/include/aerospike/as_event_internal.h
application/kvbench/include/aerospike/as_geojson.h
application/kvbench/include/aerospike/as_hashmap.h
application/kvbench/include/aerospike/as_hashmap_iterator.h
application/kvbench/include/aerospike/as_host.h
application/kvbench/include/aerospike/as_info.h
application/kvbench/include/aerospike/as_integer.h
application/kvbench/include/aerospike/as_iterator.h
application/kvbench/include/aerospike/as_job.h
application/kvbench/include/aerospike/as_key.h
application/kvbench/include/aerospike/as_list.h
application/kvbench/include/aerospike/as_list_iterator.h
application/kvbench/include/aerospike/as_list_operations.h
application/kvbench/include/aerospike/as_listener.h
application/kvbench/include/aerospike/as_log.h
application/kvbench/include/aerospike/as_log_macros.h
application/kvbench/include/aerospike/as_lookup.h
application/kvbench/include/aerospike/as_map.h
application/kvbench/include/aerospike/as_map_iterator.h
application/kvbench/include/aerospike/as_map_operations.h
application/kvbench/include/aerospike/as_memtracker.h
application/kvbench/include/aerospike/as_module.h
application/kvbench/include/aerospike/as_monitor.h
application/kvbench/include/aerospike/as_msgpack.h
application/kvbench/include/aerospike/as_msgpack_serializer.h
application/kvbench/include/aerospike/as_nil.h
application/kvbench/include/aerospike/as_node.h
application/kvbench/include/aerospike/as_operations.h
application/kvbench/include/aerospike/as_pair.h
application/kvbench/include/aerospike/as_partition.h
application/kvbench/include/aerospike/as_password.h
application/kvbench/include/aerospike/as_peers.h
application/kvbench/include/aerospike/as_pipe.h
application/kvbench/include/aerospike/as_policy.h
application/kvbench/include/aerospike/as_predexp.h
application/kvbench/include/aerospike/as_proto.h
application/kvbench/include/aerospike/as_query.h
application/kvbench/include/aerospike/as_queue.h
application/kvbench/include/aerospike/as_random.h
application/kvbench/include/aerospike/as_rec.h
application/kvbench/include/aerospike/as_record.h
application/kvbench/include/aerospike/as_record_iterator.h
application/kvbench/include/aerospike/as_result.h
application/kvbench/include/aerospike/as_scan.h
application/kvbench/include/aerospike/as_serializer.h
application/kvbench/include/aerospike/as_shm_cluster.h
application/kvbench/include/aerospike/as_socket.h
application/kvbench/include/aerospike/as_status.h
application/kvbench/include/aerospike/as_stream.h
application/kvbench/include/aerospike/as_string.h
application/kvbench/include/aerospike/as_string_builder.h
application/kvbench/include/aerospike/as_stringmap.h
application/kvbench/include/aerospike/as_thread_pool.h
application/kvbench/include/aerospike/as_timer.h
application/kvbench/include/aerospike/as_tls.h
application/kvbench/include/aerospike/as_types.h
application/kvbench/include/aerospike/as_udf.h
application/kvbench/include/aerospike/as_udf_context.h
application/kvbench/include/aerospike/as_util.h
application/kvbench/include/aerospike/as_val.h
application/kvbench/include/aerospike/as_vector.h
application/kvbench/include/aerospike/ck/ck_backoff.h
application/kvbench/include/aerospike/ck/ck_bitmap.h
application/kvbench/include/aerospike/ck/ck_brlock.h
application/kvbench/include/aerospike/ck/ck_bytelock.h
application/kvbench/include/aerospike/ck/ck_cc.h
application/kvbench/include/aerospike/ck/ck_cohort.h
application/kvbench/include/aerospike/ck/ck_elide.h
application/kvbench/include/aerospike/ck/ck_fifo.h
application/kvbench/include/aerospike/ck/ck_hp_fifo.h
application/kvbench/include/aerospike/ck/ck_hp_stack.h
application/kvbench/include/aerospike/ck/ck_limits.h
application/kvbench/include/aerospike/ck/ck_malloc.h
application/kvbench/include/aerospike/ck/ck_md.h
application/kvbench/include/aerospike/ck/ck_pflock.h
application/kvbench/include/aerospike/ck/ck_pr.h
application/kvbench/include/aerospike/ck/ck_queue.h
application/kvbench/include/aerospike/ck/ck_ring.h
application/kvbench/include/aerospike/ck/ck_rwcohort.h
application/kvbench/include/aerospike/ck/ck_rwlock.h
application/kvbench/include/aerospike/ck/ck_sequence.h
application/kvbench/include/aerospike/ck/ck_spinlock.h
application/kvbench/include/aerospike/ck/ck_stack.h
application/kvbench/include/aerospike/ck/ck_stdbool.h
application/kvbench/include/aerospike/ck/ck_stddef.h
application/kvbench/include/aerospike/ck/ck_stdint.h
application/kvbench/include/aerospike/ck/ck_stdlib.h
application/kvbench/include/aerospike/ck/ck_string.h
application/kvbench/include/aerospike/ck/ck_swlock.h
application/kvbench/include/aerospike/ck/ck_tflock.h
application/kvbench/include/aerospike/ck/gcc/arm/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/arm/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/ck_cc.h
application/kvbench/include/aerospike/ck/gcc/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/ppc/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/ppc/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/ppc64/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/ppc64/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/sparcv9/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/sparcv9/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/x86/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/x86/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/x86_64/ck_f_pr.h
application/kvbench/include/aerospike/ck/gcc/x86_64/ck_pr.h
application/kvbench/include/aerospike/ck/gcc/x86_64/ck_pr_rtm.h
application/kvbench/include/aerospike/ck/spinlock/anderson.h
application/kvbench/include/aerospike/ck/spinlock/cas.h
application/kvbench/include/aerospike/ck/spinlock/clh.h
application/kvbench/include/aerospike/ck/spinlock/dec.h
application/kvbench/include/aerospike/ck/spinlock/fas.h
application/kvbench/include/aerospike/ck/spinlock/hclh.h
application/kvbench/include/aerospike/ck/spinlock/mcs.h
application/kvbench/include/aerospike/ck/spinlock/ticket.h
application/kvbench/include/aerospike/ssl_util.h
application/kvbench/include/aerospike/version.h
application/kvbench/include/citrusleaf/alloc.h
application/kvbench/include/citrusleaf/cf_atomic.h
application/kvbench/include/citrusleaf/cf_b64.h
application/kvbench/include/citrusleaf/cf_byte_order.h
application/kvbench/include/citrusleaf/cf_clock.h
application/kvbench/include/citrusleaf/cf_clock_win.h
application/kvbench/include/citrusleaf/cf_crypto.h
application/kvbench/include/citrusleaf/cf_digest.h
application/kvbench/include/citrusleaf/cf_hash_math.h
application/kvbench/include/citrusleaf/cf_ll.h
application/kvbench/include/citrusleaf/cf_queue.h
application/kvbench/include/citrusleaf/cf_queue_priority.h
application/kvbench/include/citrusleaf/cf_random.h
application/kvbench/include/citrusleaf/cf_rchash.h
application/kvbench/include/citrusleaf/cf_types.h
application/kvbench/include/citrusleaf/cf_vector.h
application/kvbench/include/libcouchstore/couch_common.h
application/kvbench/include/libcouchstore/couch_db.h
application/kvbench/include/libcouchstore/couch_index.h
application/kvbench/include/libcouchstore/error.h
application/kvbench/include/libcouchstore/file_ops.h
application/kvbench/include/libcouchstore/visibility.h
application/kvbench/include/thpool.h
application/kvbench/utils/adv_random.h
application/kvbench/utils/avltree.cc
application/kvbench/utils/avltree.h
application/kvbench/utils/crc32.cc
application/kvbench/utils/crc32.h
application/kvbench/utils/iniparser.cc
application/kvbench/utils/iniparser.h
application/kvbench/utils/keygen.cc
application/kvbench/utils/keygen.h
application/kvbench/utils/keyloader.cc
application/kvbench/utils/keyloader.h
application/kvbench/utils/memleak.cc
application/kvbench/utils/memleak.h
application/kvbench/utils/memory.cc
application/kvbench/utils/memory.h
application/kvbench/utils/stopwatch.cc
application/kvbench/utils/stopwatch.h
application/kvbench/utils/thpool.cc
application/kvbench/utils/workload.h
application/kvbench/utils/zipfian_random.cc
application/kvbench/utils/zipfian_random.h
application/kvbench/wrappers/couch_aerospike.cc
application/kvbench/wrappers/couch_kv.cc
application/kvbench/wrappers/couch_kvdb.cc
application/kvbench/wrappers/couch_rocksdb.cc
